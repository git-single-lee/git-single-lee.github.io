<!DOCTYPE html><html lang="zh-Hans"><head><meta charset="UTF-8"><meta http-equiv="X-UA-Compatible" content="IE=edge"><meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1"><meta name="description" content="EventBus 第二篇 - Subscribe 注解处理"><meta name="keywords" content="EventBus"><meta name="author" content="Coolqi.Li,undefined"><meta name="copyright" content="Coolqi.Li"><title>EventBus 第二篇 - Subscribe 注解处理 | Coolqi`s Blog</title><link rel="shortcut icon" href="/img/favicon.ico"><link rel="stylesheet" href="/css/index.css?version=1.5.6"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/font-awesome@4.7.0/css/font-awesome.min.css?version=1.5.6"><link rel="dns-prefetch" href="https://cdn.staticfile.org"><link rel="dns-prefetch" href="https://cdn.bootcss.com"><link rel="dns-prefetch" href="https://creativecommons.org"><link rel="dns-prefetch" href="https://hm.baidu.com"><script>var _hmt = _hmt || [];
(function() {
  var hm = document.createElement("script");
  hm.src = "https://hm.baidu.com/hm.js?b7acef5306e54116ad8a99e8b753a92d";
  var s = document.getElementsByTagName("script")[0]; 
  s.parentNode.insertBefore(hm, s);
})();</script><script>var GLOBAL_CONFIG = { 
  root: '/',
  algolia: undefined,
  localSearch: {"path":"search.xml","languages":{"hits_empty":"找不到您查询的内容:${query}"}},
  copy: {
    success: '复制成功',
    error: '复制错误',
    noSupport: '浏览器不支持'
  }
} </script></head><body><i class="fa fa-arrow-right" id="toggle-sidebar" aria-hidden="true"></i><div id="sidebar"><div class="toggle-sidebar-info text-center"><span data-toggle="切换文章详情">切换站点概览</span><hr></div><div class="sidebar-toc"><div class="sidebar-toc__title">目录</div><div class="sidebar-toc__progress"><span class="progress-notice">你已经读了</span><span class="progress-num">0</span><span class="progress-percentage">%</span><div class="sidebar-toc__progress-bar"></div></div><div class="sidebar-toc__content"><ol class="toc"><li class="toc-item toc-level-1"><a class="toc-link" href="#1-回顾"><span class="toc-text">1 回顾</span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#2-EventBusAnnotationProcessor-Subscribe-处理"><span class="toc-text">2 EventBusAnnotationProcessor - Subscribe 处理</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#2-1-成员变量"><span class="toc-text">2.1 成员变量</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#2-2-process"><span class="toc-text">2.2 process</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#2-2-1-collectSubscribers-收集"><span class="toc-text">2.2.1 collectSubscribers - 收集</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#2-2-1-1-checkHasNoErrors"><span class="toc-text">2.2.1.1 checkHasNoErrors</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#2-2-2-checkForSubscribersToSkip"><span class="toc-text">2.2.2 checkForSubscribersToSkip</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#2-2-2-1-isVisible"><span class="toc-text">2.2.2.1 isVisible</span></a><ol class="toc-child"><li class="toc-item toc-level-5"><a class="toc-link" href="#2-2-2-1-1-getPackageElement"><span class="toc-text">2.2.2.1.1 getPackageElement</span></a></li></ol></li><li class="toc-item toc-level-4"><a class="toc-link" href="#2-2-2-2-getParamTypeMirror"><span class="toc-text">2.2.2.2 getParamTypeMirror</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#2-2-2-3-getSuperclass"><span class="toc-text">2.2.2.3 getSuperclass</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#2-2-3-createInfoIndexFile"><span class="toc-text">2.2.3 createInfoIndexFile</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#2-2-3-1-writeIndexLines"><span class="toc-text">2.2.3.1 writeIndexLines</span></a><ol class="toc-child"><li class="toc-item toc-level-5"><a class="toc-link" href="#2-2-3-1-1-getClassString"><span class="toc-text">2.2.3.1.1 getClassString</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#2-2-3-1-2-writeCreateSubscriberMethods"><span class="toc-text">2.2.3.1.2 writeCreateSubscriberMethods</span></a></li></ol></li></ol></li></ol></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#3-动态-Java-类实例"><span class="toc-text">3 动态 Java 类实例</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#3-1-SubscriberInfoIndex"><span class="toc-text">3.1 SubscriberInfoIndex</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#3-2-SubscriberInfo"><span class="toc-text">3.2 SubscriberInfo</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#3-3-AbstractSubscriberInfo"><span class="toc-text">3.3 AbstractSubscriberInfo</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#3-4-SimpleSubscriberInfo"><span class="toc-text">3.4 SimpleSubscriberInfo</span></a></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#4-总结"><span class="toc-text">4 总结</span></a></li></ol></div></div><div class="author-info hide"><div class="author-info__avatar text-center"><img src="/img/avatar.jpg"></div><div class="author-info__name text-center">Coolqi.Li</div><div class="author-info__description text-center">“Hi，我是李帅奇，Android 开发工程师，TeamLeader，熬夜星人，一个努力赚钱，积极向上的好人。”</div><div class="follow-button"><a href="https://github.com/single-li">Follow Me</a></div><hr><div class="author-info-articles"><a class="author-info-articles__archives article-meta" href="/archives"><span class="pull-left">文章</span><span class="pull-right">86</span></a><a class="author-info-articles__tags article-meta" href="/tags"><span class="pull-left">标签</span><span class="pull-right">21</span></a><a class="author-info-articles__categories article-meta" href="/categories"><span class="pull-left">分类</span><span class="pull-right">26</span></a></div><hr><div class="author-info-links"><div class="author-info-links__title text-center">Links</div><a class="author-info-links__name text-center" href="https://developer.android.google.cn/">AndroidDeveloper</a><a class="author-info-links__name text-center" href="http://www.android-studio.org/">AndroidStudio</a><a class="author-info-links__name text-center" href="https://www.jianshu.com/u/123a20a96441">简书</a><a class="author-info-links__name text-center" href="https://weibo.com/coolqiLi">微博</a></div></div></div><div id="content-outer"><div id="top-container" style="background-image: url(https://ws1.sinaimg.cn/large/8700af19ly1fvpabr30o6j22yo1o0q7i.jpg)"><div id="page-header"><span class="pull-left"> <a id="site-name" href="/">Coolqi`s Blog</a></span><i class="fa fa-bars toggle-menu pull-right" aria-hidden="true"></i><span class="pull-right menus"><a class="site-page social-icon search"><i class="fa fa-search"></i><span> 搜索</span></a><a class="site-page" href="/">Home</a><a class="site-page" href="/categories">Categories</a><a class="site-page" href="/tags">Tags</a><a class="site-page" href="/archives">Archives</a><a class="site-page" href="/about">About</a></span></div><div id="post-info"><div id="post-title">EventBus 第二篇 - Subscribe 注解处理</div><div id="post-meta"><time class="post-meta__date"><i class="fa fa-calendar" aria-hidden="true"></i> 2019-08-27</time><span class="post-meta__separator">|</span><i class="fa fa-inbox post-meta__icon" aria-hidden="true"></i><a class="post-meta__categories" href="/categories/开源库源码分析/">开源库源码分析</a><i class="fa fa-angle-right" aria-hidden="true"></i><i class="fa fa-inbox post-meta__icon" aria-hidden="true"></i><a class="post-meta__categories" href="/categories/开源库源码分析/EventBus/">EventBus</a><div class="post-meta-wordcount"><span>字数总计: </span><span class="word-count">4.9k</span><span class="post-meta__separator">|</span><span>阅读时长: 22 分钟</span></div></div></div></div><div class="layout" id="content-inner"><article id="post"><div class="article-container" id="post-content"><p>本系列文章主要分析 EventBus 框架的架构和原理，，基于最新的 <strong>3.1.0</strong> 版本。</p>
<blockquote>
<p>这是 EventBus 开源库的地址，大家可以直接访问<br><a href="https://github.com/greenrobot/EventBus" target="_blank" rel="noopener">https://github.com/greenrobot/EventBus</a></p>
</blockquote>
<p>本篇文章是 EventBus 的第二篇，主要分析 Subscribe 注解的处理；</p>
<p>Eventbus 翻译过来就是事件总线，用于简化组件和组件，线程和线程之间的消息通信，可以捆成是 Handler + Thread 的替代品。</p>
<h1 id="1-回顾"><a href="#1-回顾" class="headerlink" title="1 回顾"></a>1 回顾</h1><p>我们在使用的过程中，需要设置接收消息的方法：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Subscribe</span>(threadMode = ThreadMode.MAIN)</span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onEventMainThread</span><span class="params">(Object object)</span> </span>&#123;</span><br><span class="line">   ... ... ...</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>注解  Subscribe 可以说是 EventBus 的核心了，我们知道，3.x 版本之前，EventBus 使用的是运行时注解，其实就是 Java 的反射机制，但是这带来了性能的损耗！</p>
<p>因此，从 3.x 开始，Eventbus 引入了编译时注解处理的特性，核心类就是 EventBusAnnotationProcessor！ </p>
<p>我们来看看注解的定义：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Documented</span></span><br><span class="line"><span class="meta">@Retention</span>(RetentionPolicy.RUNTIME)</span><br><span class="line"><span class="meta">@Target</span>(&#123;ElementType.METHOD&#125;)</span><br><span class="line"><span class="keyword">public</span> <span class="meta">@interface</span> Subscribe &#123;</span><br><span class="line">    <span class="function">ThreadMode <span class="title">threadMode</span><span class="params">()</span> <span class="keyword">default</span> ThreadMode.POSTING</span>; <span class="comment">// 线程模型：默认 POSTING</span></span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">boolean</span> <span class="title">sticky</span><span class="params">()</span> <span class="keyword">default</span> <span class="keyword">false</span></span>; <span class="comment">// 默认非粘性；</span></span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">int</span> <span class="title">priority</span><span class="params">()</span> <span class="keyword">default</span> 0</span>; <span class="comment">// 优先级为 0；</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>可以看到，Subscribe 用于修饰方法，并且可以保留到运行时，这是因为默认情况下，EventBus 是通过运行时注解，反射加载方法的，除非开启编译时注解处理机制；</p>
<h1 id="2-EventBusAnnotationProcessor-Subscribe-处理"><a href="#2-EventBusAnnotationProcessor-Subscribe-处理" class="headerlink" title="2 EventBusAnnotationProcessor - Subscribe 处理"></a>2 EventBusAnnotationProcessor - Subscribe 处理</h1><p>浏览 EventBus 的源码目录，我们能看到处理 Subscribe 注解的是 EventBusAnnotationProcessor 类，依然是编译时注解，动态生成代码：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@SupportedAnnotationTypes</span>(<span class="string">"org.greenrobot.eventbus.Subscribe"</span>)</span><br><span class="line"><span class="meta">@SupportedOptions</span>(value = &#123;<span class="string">"eventBusIndex"</span>, <span class="string">"verbose"</span>&#125;)</span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">EventBusAnnotationProcessor</span> <span class="keyword">extends</span> <span class="title">AbstractProcessor</span> </span>&#123;</span><br></pre></td></tr></table></figure>
<p>可以看到，它支持的只有一个注解：Subscribe</p>
<p>同时他支持两个配置属性：</p>
<ul>
<li>eventBusIndex：是否开启编译时注解处理，这个特性是 3.x 版本新增的，也就是将运行时的处理放到了编译时注解处理，动态生成 java 代码，用于提升框架的性能；</li>
<li>verbose：用于控制 log，调试使用；</li>
</ul>
<p>这两个属性是在 gradle 中配置的；</p>
<figure class="highlight groovy"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">android &#123;</span><br><span class="line">    defaultConfig &#123;</span><br><span class="line">        javaCompileOptions &#123;</span><br><span class="line">            annotationProcessorOptions &#123;</span><br><span class="line">                arguments = [<span class="string">eventBusIndex:</span><span class="string">'com.monster.android.wild.MyEventBusIndex'</span>, <span class="string">verbose :</span> <span class="string">"true"</span>]</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">dependencies &#123;</span><br><span class="line">    api <span class="string">'org.greenrobot:eventbus:3.1.0'</span></span><br><span class="line">    annotationProcessor <span class="string">'org.greenrobot:eventbus-annotation-processor:3.0.1'</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>我们在下面的分析中就能看到，注解处理器对于这几个参数的处理：</p>
<h2 id="2-1-成员变量"><a href="#2-1-成员变量" class="headerlink" title="2.1 成员变量"></a>2.1 成员变量</h2><p>EventBusAnnotationProcessor 内部如下的变量和常量：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> String OPTION_EVENT_BUS_INDEX = <span class="string">"eventBusIndex"</span>;</span><br><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> String OPTION_VERBOSE = <span class="string">"verbose"</span>;</span><br></pre></td></tr></table></figure>
<p>上面的变量用于获取 gradle 的环境变量；</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 保存订阅者（类）和其订阅方法（注解修饰的方法）的映射关系；</span></span><br><span class="line"><span class="keyword">private</span> <span class="keyword">final</span> ListMap&lt;TypeElement, ExecutableElement&gt; methodsByClass = <span class="keyword">new</span> ListMap&lt;&gt;(); </span><br><span class="line"><span class="comment">// 保存需要跳过的订阅者</span></span><br><span class="line"><span class="keyword">private</span> <span class="keyword">final</span> Set&lt;TypeElement&gt; classesToSkip = <span class="keyword">new</span> HashSet&lt;&gt;();</span><br><span class="line"></span><br><span class="line"><span class="keyword">private</span> <span class="keyword">boolean</span> writerRoundDone;</span><br><span class="line"><span class="keyword">private</span> <span class="keyword">int</span> round;</span><br><span class="line"><span class="keyword">private</span> <span class="keyword">boolean</span> verbose;</span><br></pre></td></tr></table></figure>
<h2 id="2-2-process"><a href="#2-2-process" class="headerlink" title="2.2 process"></a>2.2 process</h2><p>依然是核心方法：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">boolean</span> <span class="title">process</span><span class="params">(Set&lt;? extends TypeElement&gt; annotations, RoundEnvironment env)</span> </span>&#123;</span><br><span class="line">  Messager messager = processingEnv.getMessager();</span><br><span class="line">  <span class="keyword">try</span> &#123;</span><br><span class="line">    <span class="comment">//【1】获取 eventBusIndex 编译属性，并判断是否有设置这个，没有的话就不处理；</span></span><br><span class="line">    String index = processingEnv.getOptions().get(OPTION_EVENT_BUS_INDEX);</span><br><span class="line">    <span class="keyword">if</span> (index == <span class="keyword">null</span>) &#123;</span><br><span class="line">      messager.printMessage(Diagnostic.Kind.ERROR, <span class="string">"No option "</span> + OPTION_EVENT_BUS_INDEX +</span><br><span class="line">                            <span class="string">" passed to annotation processor"</span>);</span><br><span class="line">      <span class="keyword">return</span> <span class="keyword">false</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">//【2】判断是否要输出 log；</span></span><br><span class="line">    verbose = Boolean.parseBoolean(processingEnv.getOptions().get(OPTION_VERBOSE));</span><br><span class="line">    <span class="comment">//【3】获取动态创建的 java 类的类名；</span></span><br><span class="line">    <span class="keyword">int</span> lastPeriod = index.lastIndexOf(<span class="string">'.'</span>);</span><br><span class="line">    String indexPackage = lastPeriod != -<span class="number">1</span> ? index.substring(<span class="number">0</span>, lastPeriod) : <span class="keyword">null</span>;</span><br><span class="line"></span><br><span class="line">    round++;</span><br><span class="line">    <span class="keyword">if</span> (verbose) &#123;</span><br><span class="line">      messager.printMessage(Diagnostic.Kind.NOTE, <span class="string">"Processing round "</span> + round + <span class="string">", new annotations: "</span> +</span><br><span class="line">                            !annotations.isEmpty() + <span class="string">", processingOver: "</span> + env.processingOver());</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span> (env.processingOver()) &#123;</span><br><span class="line">      <span class="keyword">if</span> (!annotations.isEmpty()) &#123;</span><br><span class="line">        messager.printMessage(Diagnostic.Kind.ERROR,</span><br><span class="line">                              <span class="string">"Unexpected processing state: annotations still available after processing over"</span>);</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">false</span>;</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span> (annotations.isEmpty()) &#123;</span><br><span class="line">      <span class="keyword">return</span> <span class="keyword">false</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (writerRoundDone) &#123;</span><br><span class="line">      messager.printMessage(Diagnostic.Kind.ERROR,</span><br><span class="line">                            <span class="string">"Unexpected processing state: annotations still available after writing."</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">//【--&gt;2.2.1】收集注解 Subscribe 修饰的元素；</span></span><br><span class="line">    collectSubscribers(annotations, env, messager);</span><br><span class="line">    <span class="comment">//【--&gt;2.2.2】检查某些注解是否要忽略；</span></span><br><span class="line">    checkForSubscribersToSkip(messager, indexPackage);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (!methodsByClass.isEmpty()) &#123;</span><br><span class="line">      <span class="comment">//【--&gt;2.2.3】如果收集到了被注解修饰的方法，那么就动态创建 java 类；</span></span><br><span class="line">      createInfoIndexFile(index);</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">      messager.printMessage(Diagnostic.Kind.WARNING, <span class="string">"No @Subscribe annotations found"</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    writerRoundDone = <span class="keyword">true</span>;</span><br><span class="line">  &#125; <span class="keyword">catch</span> (RuntimeException e) &#123;</span><br><span class="line">    e.printStackTrace();</span><br><span class="line">    messager.printMessage(Diagnostic.Kind.ERROR, <span class="string">"Unexpected error in EventBusAnnotationProcessor: "</span> + e);</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">return</span> <span class="keyword">true</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>整个流程很简单，不多 say；</p>
<h3 id="2-2-1-collectSubscribers-收集"><a href="#2-2-1-collectSubscribers-收集" class="headerlink" title="2.2.1 collectSubscribers - 收集"></a>2.2.1 collectSubscribers - 收集</h3><p>收集注解 Subscribe 修饰的元素；</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">collectSubscribers</span><span class="params">(Set&lt;? extends TypeElement&gt; annotations, RoundEnvironment env, Messager messager)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">for</span> (TypeElement annotation : annotations) &#123;</span><br><span class="line">        Set&lt;? extends Element&gt; elements = env.getElementsAnnotatedWith(annotation); <span class="comment">// 获得 Subscribe 修饰的所有元素；</span></span><br><span class="line">        <span class="keyword">for</span> (Element element : elements) &#123;</span><br><span class="line">            <span class="keyword">if</span> (element <span class="keyword">instanceof</span> ExecutableElement) &#123;</span><br><span class="line">                ExecutableElement method = (ExecutableElement) element;</span><br><span class="line">                <span class="comment">//【--&gt;2.2.1.1】检查注解修饰的方法是否满足条件；</span></span><br><span class="line">                <span class="keyword">if</span> (checkHasNoErrors(method, messager)) &#123;</span><br><span class="line">                    <span class="comment">//【1】获得方法所属的类元素，加入到 methodsByClass 哈希表中；</span></span><br><span class="line">                    TypeElement classElement = (TypeElement) method.getEnclosingElement();</span><br><span class="line">                    methodsByClass.putElement(classElement, method);</span><br><span class="line">                &#125;</span><br><span class="line">            &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                messager.printMessage(Diagnostic.Kind.ERROR, <span class="string">"@Subscribe is only valid for methods"</span>, element);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h4 id="2-2-1-1-checkHasNoErrors"><a href="#2-2-1-1-checkHasNoErrors" class="headerlink" title="2.2.1.1 checkHasNoErrors"></a>2.2.1.1 checkHasNoErrors</h4><p>检查是否有错误：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">boolean</span> <span class="title">checkHasNoErrors</span><span class="params">(ExecutableElement element, Messager messager)</span> </span>&#123;</span><br><span class="line">    <span class="comment">//【1】方法不能是 static 的；</span></span><br><span class="line">    <span class="keyword">if</span> (element.getModifiers().contains(Modifier.STATIC)) &#123;</span><br><span class="line">        messager.printMessage(Diagnostic.Kind.ERROR, <span class="string">"Subscriber method must not be static"</span>, element);</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">false</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">//【2】方法必须是 public 的；</span></span><br><span class="line">    <span class="keyword">if</span> (!element.getModifiers().contains(Modifier.PUBLIC)) &#123;</span><br><span class="line">        messager.printMessage(Diagnostic.Kind.ERROR, <span class="string">"Subscriber method must be public"</span>, element);</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">false</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">//【3】方法必须至少有一个 param；</span></span><br><span class="line">    List&lt;? extends VariableElement&gt; parameters = ((ExecutableElement) element).getParameters();</span><br><span class="line">    <span class="keyword">if</span> (parameters.size() != <span class="number">1</span>) &#123;</span><br><span class="line">        messager.printMessage(Diagnostic.Kind.ERROR, <span class="string">"Subscriber method must have exactly 1 parameter"</span>, element);</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">false</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">true</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>不多说；</p>
<h3 id="2-2-2-checkForSubscribersToSkip"><a href="#2-2-2-checkForSubscribersToSkip" class="headerlink" title="2.2.2 checkForSubscribersToSkip"></a>2.2.2 checkForSubscribersToSkip</h3><p>跳过一些订阅者：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">checkForSubscribersToSkip</span><span class="params">(Messager messager, String myPackage)</span> </span>&#123;</span><br><span class="line">    <span class="comment">//【1】遍历收集到所有的订阅者；</span></span><br><span class="line">    <span class="keyword">for</span> (TypeElement skipCandidate : methodsByClass.keySet()) &#123;</span><br><span class="line">        TypeElement subscriberClass = skipCandidate;</span><br><span class="line">        <span class="keyword">while</span> (subscriberClass != <span class="keyword">null</span>) &#123;</span><br><span class="line">            <span class="comment">//【--&gt;2.2.2.1】判断下注解方法所属的类是否满足条件，如果不满足，加入到 classesToSkip 跳过；</span></span><br><span class="line">            <span class="keyword">if</span> (!isVisible(myPackage, subscriberClass)) &#123;</span><br><span class="line">                <span class="comment">//【2】将要跳过的 class 加入到 classesToSkip 集合中；</span></span><br><span class="line">                <span class="keyword">boolean</span> added = classesToSkip.add(skipCandidate);</span><br><span class="line">                <span class="keyword">if</span> (added) &#123;</span><br><span class="line">                    String msg;</span><br><span class="line">                    <span class="keyword">if</span> (subscriberClass.equals(skipCandidate)) &#123; <span class="comment">// 是当前类，还是父类呢？</span></span><br><span class="line">                        msg = <span class="string">"Falling back to reflection because class is not public"</span>;</span><br><span class="line">                    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                        msg = <span class="string">"Falling back to reflection because "</span> + skipCandidate +</span><br><span class="line">                                <span class="string">" has a non-public super class"</span>;</span><br><span class="line">                    &#125;</span><br><span class="line">                    messager.printMessage(Diagnostic.Kind.NOTE, msg, subscriberClass);</span><br><span class="line">                &#125;</span><br><span class="line">                <span class="keyword">break</span>;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="comment">//【3】处理类（包括父类）所有的注解方法：</span></span><br><span class="line">            List&lt;ExecutableElement&gt; methods = methodsByClass.get(subscriberClass);</span><br><span class="line">            <span class="keyword">if</span> (methods != <span class="keyword">null</span>) &#123;</span><br><span class="line">                <span class="comment">//【3.1】遍历该类的注解方法，处理方法的参数；</span></span><br><span class="line">                <span class="keyword">for</span> (ExecutableElement method : methods) &#123;</span><br><span class="line">                    String skipReason = <span class="keyword">null</span>;</span><br><span class="line">                    <span class="comment">//【3.2】获取注解方法的第一个参数（意味着第一个参数必须是消息对象）</span></span><br><span class="line">                    VariableElement param = method.getParameters().get(<span class="number">0</span>);</span><br><span class="line">                    <span class="comment">//【--&gt;2.2.2.2】获取被注解方法的参数类型；</span></span><br><span class="line">                    TypeMirror typeMirror = getParamTypeMirror(param, messager);</span><br><span class="line">                    <span class="comment">//【3.3】如果参数的类型不是类/接口，那么就跳过该类；</span></span><br><span class="line">                    <span class="keyword">if</span> (!(typeMirror <span class="keyword">instanceof</span> DeclaredType) ||</span><br><span class="line">                            !(((DeclaredType) typeMirror).asElement() <span class="keyword">instanceof</span> TypeElement)) &#123;</span><br><span class="line">                        skipReason = <span class="string">"event type cannot be processed"</span>;</span><br><span class="line">                    &#125;</span><br><span class="line">                    <span class="comment">//【3.4】如果上面满足条件，那就判断下参数是否可以访问；</span></span><br><span class="line">                    <span class="keyword">if</span> (skipReason == <span class="keyword">null</span>) &#123;</span><br><span class="line">                        TypeElement eventTypeElement = (TypeElement) ((DeclaredType) typeMirror).asElement();</span><br><span class="line">                        <span class="comment">//【--&gt;2.2.2.1】判断下注解方法所属的类是否满足条件，如果不满足，加入到 classesToSkip 跳过；</span></span><br><span class="line">                        <span class="keyword">if</span> (!isVisible(myPackage, eventTypeElement)) &#123;</span><br><span class="line">                            skipReason = <span class="string">"event type is not public"</span>;</span><br><span class="line">                        &#125;</span><br><span class="line">                    &#125;</span><br><span class="line">                    <span class="keyword">if</span> (skipReason != <span class="keyword">null</span>) &#123;</span><br><span class="line">                         <span class="comment">//【3.2】将要跳过的 class 加入到 classesToSkip 集合中；</span></span><br><span class="line">                        <span class="keyword">boolean</span> added = classesToSkip.add(skipCandidate);</span><br><span class="line">                        <span class="keyword">if</span> (added) &#123;</span><br><span class="line">                            String msg = <span class="string">"Falling back to reflection because "</span> + skipReason;</span><br><span class="line">                            <span class="keyword">if</span> (!subscriberClass.equals(skipCandidate)) &#123;</span><br><span class="line">                                msg += <span class="string">" (found in super class for "</span> + skipCandidate + <span class="string">")"</span>;</span><br><span class="line">                            &#125;</span><br><span class="line">                            messager.printMessage(Diagnostic.Kind.NOTE, msg, param);</span><br><span class="line">                        &#125;</span><br><span class="line">                        <span class="keyword">break</span>;</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="comment">//【--&gt;2.2.2.3】获取其父类对应的元素，然后 while 循环继续处理其 super class；</span></span><br><span class="line">            subscriberClass = getSuperclass(subscriberClass); </span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>可以看到，默认我们获得的是注解方法所在的当前类，但是 while 循环还会继续处理其父类；</p>
<ul>
<li>先处理子类，再处理父类；</li>
<li>被注解的方法的第一个参数必须是要处理的消息；</li>
<li>消息类型必须是类/接口的实现；</li>
</ul>
<h4 id="2-2-2-1-isVisible"><a href="#2-2-2-1-isVisible" class="headerlink" title="2.2.2.1 isVisible"></a>2.2.2.1 isVisible</h4><p>用来判断注解方法所属的类是否满足条件：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">boolean</span> <span class="title">isVisible</span><span class="params">(String myPackage, TypeElement typeElement)</span> </span>&#123;</span><br><span class="line">    Set&lt;Modifier&gt; modifiers = typeElement.getModifiers();</span><br><span class="line">    <span class="keyword">boolean</span> visible;</span><br><span class="line">    <span class="comment">//【1】该类必须是 public 的；</span></span><br><span class="line">    <span class="keyword">if</span> (modifiers.contains(Modifier.PUBLIC)) &#123;</span><br><span class="line">        visible = <span class="keyword">true</span>;</span><br><span class="line">    <span class="comment">//【2】该类不能是 private/protected 的；</span></span><br><span class="line">    &#125; <span class="keyword">else</span> <span class="keyword">if</span> (modifiers.contains(Modifier.PRIVATE) || modifiers.contains(Modifier.PROTECTED)) &#123;</span><br><span class="line">        visible = <span class="keyword">false</span>;</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        <span class="comment">//【3】默认访问权限；</span></span><br><span class="line">        <span class="comment">//【--&gt;2.2.2.1.1】获得注解方法所属类的包元素名（包名）；</span></span><br><span class="line">        String subscriberPackage = getPackageElement(typeElement).getQualifiedName().toString();</span><br><span class="line">        <span class="keyword">if</span> (myPackage == <span class="keyword">null</span>) &#123;</span><br><span class="line">            visible = subscriberPackage.length() == <span class="number">0</span>;</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            <span class="comment">// 正常情况进入这里：</span></span><br><span class="line">            <span class="comment">//【3】就是说注解方法所说的类必须和 eventBusIndex 指定的要动态生成的 java 类属于同一个包下；</span></span><br><span class="line">            visible = myPackage.equals(subscriberPackage); </span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> visible;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p><strong>参数 myPackage</strong> 是我们 eventBusIndex 指定的要动态生成的 java 类的 class Name；</p>
<p><strong>参数 TypeElement typeElement</strong> 则是注解方法所在的类元素；</p>
<p>可以看到，注解方法所属的类必须要满足一下的条件：</p>
<ul>
<li>如果是 <strong>public</strong>，那就是可见的 visible 为 true；</li>
<li>如果是 <strong>private/protected</strong>，那就是不可见的；</li>
<li>如果是 <strong>default</strong>，那么 必须和 <strong>eventBusIndex</strong> 指定的要动态生成的 <strong>java</strong> 类属于同一个包下；</li>
</ul>
<h5 id="2-2-2-1-1-getPackageElement"><a href="#2-2-2-1-1-getPackageElement" class="headerlink" title="2.2.2.1.1 getPackageElement"></a>2.2.2.1.1 getPackageElement</h5><p>获得注解方法所属类的包元素：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">private</span> PackageElement <span class="title">getPackageElement</span><span class="params">(TypeElement subscriberClass)</span> </span>&#123;</span><br><span class="line">    Element candidate = subscriberClass.getEnclosingElement();</span><br><span class="line">    <span class="comment">//【1】这里的 while 不断循环处理，直到 candidate 是一个包元素；</span></span><br><span class="line">    <span class="keyword">while</span> (!(candidate <span class="keyword">instanceof</span> PackageElement)) &#123;</span><br><span class="line">        candidate = candidate.getEnclosingElement();</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> (PackageElement) candidate;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>这里用到了 <strong>TypeElement. getenclosingelement()</strong> 的方法：</p>
<blockquote>
<p>返回封装此元素（非严格意义上）的最里层元素。</p>
<p>如果此元素的声明在词法上直接封装在另一个元素的声明中，则返回那个封装元素。<br>如果此元素是顶层类型，则返回它的包。<br>如果此元素是一个包，则返回 null。<br>如果此元素是一个类型参数，则返回 null。</p>
</blockquote>
<h4 id="2-2-2-2-getParamTypeMirror"><a href="#2-2-2-2-getParamTypeMirror" class="headerlink" title="2.2.2.2 getParamTypeMirror"></a>2.2.2.2 getParamTypeMirror</h4><p>获取注解方法的参数的类型：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">private</span> TypeMirror <span class="title">getParamTypeMirror</span><span class="params">(VariableElement param, Messager messager)</span> </span>&#123;</span><br><span class="line">    <span class="comment">//【1】获取参数的类型；</span></span><br><span class="line">    TypeMirror typeMirror = param.asType();</span><br><span class="line">    <span class="comment">// Check for generic type</span></span><br><span class="line">    <span class="keyword">if</span> (typeMirror <span class="keyword">instanceof</span> TypeVariable) &#123;</span><br><span class="line">        <span class="comment">//【1.1】判断参数类型是否有上边界，如果有的话，那就使用上边界为参数类型；</span></span><br><span class="line">        TypeMirror upperBound = ((TypeVariable) typeMirror).getUpperBound();</span><br><span class="line">        <span class="keyword">if</span> (upperBound <span class="keyword">instanceof</span> DeclaredType) &#123; <span class="comment">// 上边界是类或接口类型；</span></span><br><span class="line">            <span class="keyword">if</span> (messager != <span class="keyword">null</span>) &#123;</span><br><span class="line">                messager.printMessage(Diagnostic.Kind.NOTE, <span class="string">"Using upper bound type "</span> + upperBound +</span><br><span class="line">                        <span class="string">" for generic parameter"</span>, param);</span><br><span class="line">            &#125;</span><br><span class="line">            typeMirror = upperBound; <span class="comment">// 就将上边界类型作为参数类型：</span></span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> typeMirror;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>这里我们用到了这个方法 <strong>TypeVariable.getUpperBound()</strong></p>
<blockquote>
<p>返回：此类型变量的上边界</p>
<p>如果此类型变量被声明为没有明确上边界，则结果为 <code>java.lang.object</code>。<br>如果此类型变量被声明为有多个上边界，则结果是一个交集类型（建模为 <code>declaredtype</code>）。<br>通过检查结果的超类型，可以发现个别边界。</p>
</blockquote>
<p>这个是什么意思呢？举个简单的栗子，下面是我们的消息类：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Message</span>&lt;<span class="title">T</span>&gt; <span class="keyword">extends</span> <span class="title">BaseMessage</span> </span>&#123;&#125; <span class="comment">// 返回上边界 BaseMessage，为了使用多态；</span></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Message</span>&lt;<span class="title">T</span>&gt; </span>&#123;&#125;      <span class="comment">// 返回 Message 对应的类型；</span></span><br></pre></td></tr></table></figure>
<p>这样解释就简单了吧！</p>
<h4 id="2-2-2-3-getSuperclass"><a href="#2-2-2-3-getSuperclass" class="headerlink" title="2.2.2.3 getSuperclass"></a>2.2.2.3 getSuperclass</h4><p>获取当前类的父类元素：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">private</span> TypeElement <span class="title">getSuperclass</span><span class="params">(TypeElement type)</span> </span>&#123;</span><br><span class="line">    <span class="comment">//【1】如果当前元素类型是类或者接口，才会获取父类；</span></span><br><span class="line">    <span class="keyword">if</span> (type.getSuperclass().getKind() == TypeKind.DECLARED) &#123;</span><br><span class="line">        <span class="comment">//【1.1】获取其直接父类；</span></span><br><span class="line">        TypeElement superclass = (TypeElement) processingEnv.getTypeUtils().asElement(type.getSuperclass());</span><br><span class="line">        String name = superclass.getQualifiedName().toString();</span><br><span class="line">        <span class="keyword">if</span> (name.startsWith(<span class="string">"java."</span>) || name.startsWith(<span class="string">"javax."</span>) || name.startsWith(<span class="string">"android."</span>)) &#123;</span><br><span class="line">            <span class="comment">//【1.1.1】过滤掉 java/javax/android 系统类；</span></span><br><span class="line">            <span class="keyword">return</span> <span class="keyword">null</span>;</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            <span class="keyword">return</span> superclass;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">null</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>TypeKind 是枚举，保存了 Java 定义的所有的类型数据！</p>
<h3 id="2-2-3-createInfoIndexFile"><a href="#2-2-3-createInfoIndexFile" class="headerlink" title="2.2.3 createInfoIndexFile"></a>2.2.3 createInfoIndexFile</h3><p>动态生成 java 类：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">createInfoIndexFile</span><span class="params">(String index)</span> </span>&#123;</span><br><span class="line">    BufferedWriter writer = <span class="keyword">null</span>;</span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">        <span class="comment">//【1】创建 JavaFileObject 对象，用于生成 java 类；</span></span><br><span class="line">        JavaFileObject sourceFile = processingEnv.getFiler().createSourceFile(index);</span><br><span class="line">        <span class="comment">//【2】生成 java 包名（eventBusIndex 最后一个 . 前面的字符串）和 java 类名（eventBusIndex 最后一个 . 后面的字符串）；</span></span><br><span class="line">        <span class="keyword">int</span> period = index.lastIndexOf(<span class="string">'.'</span>);</span><br><span class="line">        String myPackage = period &gt; <span class="number">0</span> ? index.substring(<span class="number">0</span>, period) : <span class="keyword">null</span>;</span><br><span class="line">        String clazz = index.substring(period + <span class="number">1</span>);</span><br><span class="line">        writer = <span class="keyword">new</span> BufferedWriter(sourceFile.openWriter());</span><br><span class="line">        <span class="keyword">if</span> (myPackage != <span class="keyword">null</span>) &#123;</span><br><span class="line">            writer.write(<span class="string">"package "</span> + myPackage + <span class="string">";\n\n"</span>); <span class="comment">// 动态 java 类的包名；</span></span><br><span class="line">        &#125;</span><br><span class="line">        writer.write(<span class="string">"import org.greenrobot.eventbus.meta.SimpleSubscriberInfo;\n"</span>);</span><br><span class="line">        writer.write(<span class="string">"import org.greenrobot.eventbus.meta.SubscriberMethodInfo;\n"</span>);</span><br><span class="line">        writer.write(<span class="string">"import org.greenrobot.eventbus.meta.SubscriberInfo;\n"</span>);</span><br><span class="line">        writer.write(<span class="string">"import org.greenrobot.eventbus.meta.SubscriberInfoIndex;\n\n"</span>);</span><br><span class="line">        writer.write(<span class="string">"import org.greenrobot.eventbus.ThreadMode;\n\n"</span>);</span><br><span class="line">        writer.write(<span class="string">"import java.util.HashMap;\n"</span>);</span><br><span class="line">        writer.write(<span class="string">"import java.util.Map;\n\n"</span>);</span><br><span class="line">        writer.write(<span class="string">"/** This class is generated by EventBus, do not edit. */\n"</span>);</span><br><span class="line">        writer.write(<span class="string">"public class "</span> + clazz + <span class="string">" implements SubscriberInfoIndex &#123;\n"</span>); <span class="comment">// 动态 java 类的类名</span></span><br><span class="line">        writer.write(<span class="string">"    private static final Map&lt;Class&lt;?&gt;, SubscriberInfo&gt; SUBSCRIBER_INDEX;\n\n"</span>);</span><br><span class="line">        writer.write(<span class="string">"    static &#123;\n"</span>);</span><br><span class="line">        writer.write(<span class="string">"        SUBSCRIBER_INDEX = new HashMap&lt;Class&lt;?&gt;, SubscriberInfo&gt;();\n\n"</span>);</span><br><span class="line">        <span class="comment">//【--&gt;2.2.3.1】写入注解生成的信息；</span></span><br><span class="line">        writeIndexLines(writer, myPackage);</span><br><span class="line">        writer.write(<span class="string">"    &#125;\n\n"</span>);</span><br><span class="line">        writer.write(<span class="string">"    private static void putIndex(SubscriberInfo info) &#123;\n"</span>); <span class="comment">// 写入内部的 putIndex 方法；</span></span><br><span class="line">        writer.write(<span class="string">"        SUBSCRIBER_INDEX.put(info.getSubscriberClass(), info);\n"</span>);</span><br><span class="line">        writer.write(<span class="string">"    &#125;\n\n"</span>);</span><br><span class="line">        writer.write(<span class="string">"    @Override\n"</span>);</span><br><span class="line">        writer.write(<span class="string">"    public SubscriberInfo getSubscriberInfo(Class&lt;?&gt; subscriberClass) &#123;\n"</span>); <span class="comment">// 写入的 getSubscriberInfo 方法；</span></span><br><span class="line">        writer.write(<span class="string">"        SubscriberInfo info = SUBSCRIBER_INDEX.get(subscriberClass);\n"</span>);</span><br><span class="line">        writer.write(<span class="string">"        if (info != null) &#123;\n"</span>);</span><br><span class="line">        writer.write(<span class="string">"            return info;\n"</span>);</span><br><span class="line">        writer.write(<span class="string">"        &#125; else &#123;\n"</span>);</span><br><span class="line">        writer.write(<span class="string">"            return null;\n"</span>);</span><br><span class="line">        writer.write(<span class="string">"        &#125;\n"</span>);</span><br><span class="line">        writer.write(<span class="string">"    &#125;\n"</span>);</span><br><span class="line">        writer.write(<span class="string">"&#125;\n"</span>);</span><br><span class="line">    &#125; <span class="keyword">catch</span> (IOException e) &#123;</span><br><span class="line">        <span class="keyword">throw</span> <span class="keyword">new</span> RuntimeException(<span class="string">"Could not write source for "</span> + index, e);</span><br><span class="line">    &#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">        <span class="keyword">if</span> (writer != <span class="keyword">null</span>) &#123;</span><br><span class="line">            <span class="keyword">try</span> &#123;</span><br><span class="line">                writer.close();</span><br><span class="line">            &#125; <span class="keyword">catch</span> (IOException e) &#123;</span><br><span class="line">                <span class="comment">//Silent</span></span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>这里的代码有些 low，竟然是硬编码写进去的；</p>
<p>生成了的代码会涉及到如下的类：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> org.greenrobot.eventbus.meta.SimpleSubscriberInfo;</span><br><span class="line"><span class="keyword">import</span> org.greenrobot.eventbus.meta.SubscriberMethodInfo;</span><br><span class="line"><span class="keyword">import</span> org.greenrobot.eventbus.meta.SubscriberInfo;</span><br><span class="line"><span class="keyword">import</span> org.greenrobot.eventbus.meta.SubscriberInfoIndex;</span><br><span class="line"><span class="keyword">import</span> org.greenrobot.eventbus.ThreadMode;</span><br></pre></td></tr></table></figure>
<p>可以看到，这几个类定义在 eventbus 模块里，简单的说下：</p>
<ul>
<li><strong>SimpleSubscriberInfo</strong>：表示一个订阅者，就是 Subscribe 注解所在的类；</li>
<li><strong>SubscriberMethodInfo</strong>：表示一个订阅方法，就是 Subscribe 注解的方法；</li>
<li><strong>SubscriberInfo</strong>：接口，SimpleSubscriberInfo 继承了 AbstractSubscriberInfo，而 AbstractSubscriberInfo 实现了  SubscriberInfo 接口，<strong>适配器模式</strong>；</li>
<li><strong>SubscriberInfoIndex</strong>：接口，我们动态生成的 Java 类，实现了该接口；</li>
<li><strong>ThreadMode</strong>：枚举类型，表示线程类型；</li>
</ul>
<p>这里我们不多关注；</p>
<h4 id="2-2-3-1-writeIndexLines"><a href="#2-2-3-1-writeIndexLines" class="headerlink" title="2.2.3.1 writeIndexLines"></a>2.2.3.1 writeIndexLines</h4><p>这里就是将 methodsByClass 中收集到的信息写入到动态 java 类中；</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">writeIndexLines</span><span class="params">(BufferedWriter writer, String myPackage)</span> <span class="keyword">throws</span> IOException </span>&#123;</span><br><span class="line">    <span class="comment">//【1】遍历 methodsByClass 哈希表，跳过 classesToSkip 中的元素；</span></span><br><span class="line">    <span class="keyword">for</span> (TypeElement subscriberTypeElement : methodsByClass.keySet()) &#123;</span><br><span class="line">        <span class="keyword">if</span> (classesToSkip.contains(subscriberTypeElement)) &#123;</span><br><span class="line">            <span class="keyword">continue</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">//【--&gt;2.2.3.1.1】获得注解方法所在的类名；</span></span><br><span class="line">        String subscriberClass = getClassString(subscriberTypeElement, myPackage);</span><br><span class="line">        <span class="comment">//【--&gt;2.2.2.1】判断下动态 java 类所在的包是否可以访问注解所在类，可以的话，才写入！ </span></span><br><span class="line">        <span class="keyword">if</span> (isVisible(myPackage, subscriberTypeElement)) &#123;</span><br><span class="line">            writeLine(writer, <span class="number">2</span>,</span><br><span class="line">                    <span class="string">"putIndex(new SimpleSubscriberInfo("</span> + subscriberClass + <span class="string">".class,"</span>,</span><br><span class="line">                    <span class="string">"true,"</span>, <span class="string">"new SubscriberMethodInfo[] &#123;"</span>); <span class="comment">// 这个我就不分析了，一行一行的写入呗；</span></span><br><span class="line">            <span class="comment">//【2】获取注解的方法；</span></span><br><span class="line">            List&lt;ExecutableElement&gt; methods = methodsByClass.get(subscriberTypeElement);</span><br><span class="line">            <span class="comment">//【--&gt;2.2.3.1.2】将方法信息写入到 java 类中；</span></span><br><span class="line">            writeCreateSubscriberMethods(writer, methods, <span class="string">"new SubscriberMethodInfo"</span>, myPackage);</span><br><span class="line">            writer.write(<span class="string">"        &#125;));\n\n"</span>);</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            writer.write(<span class="string">"        // Subscriber not visible to index: "</span> + subscriberClass + <span class="string">"\n"</span>);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>第二个参数表示的是否检查父类：<strong>shouldCheckSuperclass</strong>，传入的是 true；</p>
<h5 id="2-2-3-1-1-getClassString"><a href="#2-2-3-1-1-getClassString" class="headerlink" title="2.2.3.1.1 getClassString"></a>2.2.3.1.1 getClassString</h5><p>获取类名；</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">private</span> String <span class="title">getClassString</span><span class="params">(TypeElement typeElement, String myPackage)</span> </span>&#123;</span><br><span class="line">    <span class="comment">//【--&gt;2.2.2.1.1】获取注解所在的类的包元素；</span></span><br><span class="line">    PackageElement packageElement = getPackageElement(typeElement);</span><br><span class="line">    <span class="comment">//【1】获取所在包名；</span></span><br><span class="line">    String packageString = packageElement.getQualifiedName().toString();</span><br><span class="line">    <span class="comment">//【2】获取类的全限定名；</span></span><br><span class="line">    String className = typeElement.getQualifiedName().toString();</span><br><span class="line">    <span class="keyword">if</span> (packageString != <span class="keyword">null</span> &amp;&amp; !packageString.isEmpty()) &#123;</span><br><span class="line">        <span class="keyword">if</span> (packageString.equals(myPackage)) &#123;</span><br><span class="line">            <span class="comment">//【3】如果注解所在的类和动态生成的 java 类的包名一样；就截掉全限定名的包名部分（因为在同一个包嘛）</span></span><br><span class="line">            className = cutPackage(myPackage, className);</span><br><span class="line">        &#125; <span class="keyword">else</span> <span class="keyword">if</span> (packageString.equals(<span class="string">"java.lang"</span>)) &#123;</span><br><span class="line">            className = typeElement.getSimpleName().toString();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> className;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>这里调用内部的 cutPackage 去截取类名！</p>
<p>代码简单，就 String 的基本操作。。。</p>
<h5 id="2-2-3-1-2-writeCreateSubscriberMethods"><a href="#2-2-3-1-2-writeCreateSubscriberMethods" class="headerlink" title="2.2.3.1.2 writeCreateSubscriberMethods"></a>2.2.3.1.2 writeCreateSubscriberMethods</h5><p>将方法信息写入到 java 类中，参数 <strong>String callPrefix</strong> 的值：”new SubscriberMethodInfo”</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">writeCreateSubscriberMethods</span><span class="params">(BufferedWriter writer, List&lt;ExecutableElement&gt; methods,</span></span></span><br><span class="line"><span class="function"><span class="params">                                          String callPrefix, String myPackage)</span> <span class="keyword">throws</span> IOException </span>&#123;</span><br><span class="line">    <span class="comment">//【1】遍历方法 list；</span></span><br><span class="line">    <span class="keyword">for</span> (ExecutableElement method : methods) &#123;</span><br><span class="line">        List&lt;? extends VariableElement&gt; parameters = method.getParameters();</span><br><span class="line">        TypeMirror paramType = getParamTypeMirror(parameters.get(<span class="number">0</span>), <span class="keyword">null</span>); <span class="comment">//【--&gt;2.2.2.2】注解方法的参数的类型;</span></span><br><span class="line">        TypeElement paramElement = (TypeElement) processingEnv.getTypeUtils().asElement(paramType);</span><br><span class="line">        <span class="comment">//【1.1】获取方法名；</span></span><br><span class="line">        String methodName = method.getSimpleName().toString();</span><br><span class="line">        <span class="comment">//【--&gt;2.2.3.1.2】获取方法参数（事件）的类名；</span></span><br><span class="line">        String eventClass = getClassString(paramElement, myPackage) + <span class="string">".class"</span>;</span><br><span class="line"></span><br><span class="line">        <span class="comment">//【1.3】获取 Subscribe 注解对象；</span></span><br><span class="line">        Subscribe subscribe = method.getAnnotation(Subscribe.class);</span><br><span class="line">        List&lt;String&gt; parts = <span class="keyword">new</span> ArrayList&lt;&gt;();</span><br><span class="line">        parts.add(callPrefix + <span class="string">"(\""</span> + methodName + <span class="string">"\","</span>); <span class="comment">//【1.4】第一个参数：methodName；</span></span><br><span class="line">        String lineEnd = <span class="string">"),"</span>;</span><br><span class="line">        <span class="comment">//【1.5】处理注解的 priority、sticky、threadMode 属性；</span></span><br><span class="line">        <span class="keyword">if</span> (subscribe.priority() == <span class="number">0</span> &amp;&amp; !subscribe.sticky()) &#123; <span class="comment">// 如果优先级为 0（默认）并且不是 sticky 事件，那么会进入 if；</span></span><br><span class="line">            <span class="comment">// 如果是默认类型的线程池，只要写入事件的类名；</span></span><br><span class="line">            <span class="comment">// 不是默认线程，那么还要写入线程枚举类型；</span></span><br><span class="line">            <span class="keyword">if</span> (subscribe.threadMode() == ThreadMode.POSTING) &#123;</span><br><span class="line">                parts.add(eventClass + lineEnd);</span><br><span class="line">            &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                parts.add(eventClass + <span class="string">","</span>);</span><br><span class="line">                parts.add(<span class="string">"ThreadMode."</span> + subscribe.threadMode().name() + lineEnd); <span class="comment">// 处理线程类型；</span></span><br><span class="line">            &#125;</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123; <span class="comment">// 如果指定了优先级，或者是粘性事件，这里会写入事件的类名，线程枚举类型，优先级，粘性状态；</span></span><br><span class="line">            parts.add(eventClass + <span class="string">","</span>);</span><br><span class="line">            parts.add(<span class="string">"ThreadMode."</span> + subscribe.threadMode().name() + <span class="string">","</span>);</span><br><span class="line">            parts.add(subscribe.priority() + <span class="string">","</span>);</span><br><span class="line">            parts.add(subscribe.sticky() + lineEnd);</span><br><span class="line">        &#125;</span><br><span class="line">        writeLine(writer, <span class="number">3</span>, parts.toArray(<span class="keyword">new</span> String[parts.size()]));</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (verbose) &#123;</span><br><span class="line">            processingEnv.getMessager().printMessage(Diagnostic.Kind.NOTE, <span class="string">"Indexed @Subscribe at "</span> +</span><br><span class="line">                    method.getEnclosingElement().getSimpleName() + <span class="string">"."</span> + methodName +</span><br><span class="line">                    <span class="string">"("</span> + paramElement.getSimpleName() + <span class="string">")"</span>);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>这个过程是处理注解方法和注解参数的过程；</p>
<h1 id="3-动态-Java-类实例"><a href="#3-动态-Java-类实例" class="headerlink" title="3 动态 Java 类实例"></a>3 动态 Java 类实例</h1><p>我们可以看下动态生成的 Java 类实例：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.coolqi.top;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> org.greenrobot.eventbus.meta.SimpleSubscriberInfo;</span><br><span class="line"><span class="keyword">import</span> org.greenrobot.eventbus.meta.SubscriberMethodInfo;</span><br><span class="line"><span class="keyword">import</span> org.greenrobot.eventbus.meta.SubscriberInfo;</span><br><span class="line"><span class="keyword">import</span> org.greenrobot.eventbus.meta.SubscriberInfoIndex;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> org.greenrobot.eventbus.ThreadMode;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> java.util.HashMap;</span><br><span class="line"><span class="keyword">import</span> java.util.Map;</span><br><span class="line"></span><br><span class="line"><span class="comment">/** This class is generated by EventBus, do not edit. */</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">moduleAppIndex</span> <span class="keyword">implements</span> <span class="title">SubscriberInfoIndex</span> </span>&#123;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> Map&lt;Class&lt;?&gt;, SubscriberInfo&gt; SUBSCRIBER_INDEX;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">static</span> &#123;</span><br><span class="line">        SUBSCRIBER_INDEX = <span class="keyword">new</span> HashMap&lt;Class&lt;?&gt;, SubscriberInfo&gt;();</span><br><span class="line">      </span><br><span class="line">        putIndex(<span class="keyword">new</span> SimpleSubscriberInfo(com.coolqi.ui.EditPicActivity.class, <span class="keyword">true</span>, <span class="keyword">new</span> SubscriberMethodInfo[] &#123;</span><br><span class="line">            <span class="keyword">new</span> SubscriberMethodInfo(<span class="string">"onEventMainThread"</span>, com.coolqi.common.beans.MessageEvent.class),</span><br><span class="line">            <span class="keyword">new</span> SubscriberMethodInfo(<span class="string">"onEventMainThread2"</span>, com.coolqi.common.beans.MessageEvent.class,</span><br><span class="line">                    ThreadMode.ASYNC, <span class="number">1</span>, <span class="keyword">true</span>),</span><br><span class="line">        &#125;));</span><br><span class="line"></span><br><span class="line">        putIndex(<span class="keyword">new</span> SimpleSubscriberInfo(com.coolqi.ui.ChangeDateActivity.class, <span class="keyword">true</span>, <span class="keyword">new</span> SubscriberMethodInfo[] &#123;</span><br><span class="line">            <span class="keyword">new</span> SubscriberMethodInfo(<span class="string">"onEventMainThread"</span>, com.coolqi.common.beans.MessageEvent.class),</span><br><span class="line">        &#125;));</span><br><span class="line"></span><br><span class="line">        putIndex(<span class="keyword">new</span> SimpleSubscriberInfo(com.coolqi.ui.normal.ExhibitionWebFragment.class, <span class="keyword">true</span>,</span><br><span class="line">                <span class="keyword">new</span> SubscriberMethodInfo[] &#123;</span><br><span class="line">            <span class="keyword">new</span> SubscriberMethodInfo(<span class="string">"onShowMessageChatNumberEvent"</span>, com.gensee.kzkt_res.bean.MessageChatNumber.class),</span><br><span class="line">            <span class="keyword">new</span> SubscriberMethodInfo(<span class="string">"onEventMainThread"</span>, com.coolqi.common.beans.MessageEvent.class),</span><br><span class="line">        &#125;));</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">putIndex</span><span class="params">(SubscriberInfo info)</span> </span>&#123;</span><br><span class="line">        SUBSCRIBER_INDEX.put(info.getSubscriberClass(), info);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> SubscriberInfo <span class="title">getSubscriberInfo</span><span class="params">(Class&lt;?&gt; subscriberClass)</span> </span>&#123;</span><br><span class="line">        SubscriberInfo info = SUBSCRIBER_INDEX.get(subscriberClass);</span><br><span class="line">        <span class="keyword">if</span> (info != <span class="keyword">null</span>) &#123;</span><br><span class="line">            <span class="keyword">return</span> info;</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="keyword">null</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure>
<p>下面我们简单的看下涉及到的类和接口，这些类都位于 eventbus 模块中！</p>
<p>后面再分析的时候，我们就不再过多关注这些类了！</p>
<h2 id="3-1-SubscriberInfoIndex"><a href="#3-1-SubscriberInfoIndex" class="headerlink" title="3.1 SubscriberInfoIndex"></a>3.1 SubscriberInfoIndex</h2><p>接口，动态生成的类实现该接口：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">interface</span> <span class="title">SubscriberInfoIndex</span> </span>&#123;</span><br><span class="line">    <span class="comment">//【1】用于获取订阅信息；</span></span><br><span class="line">    <span class="function">SubscriberInfo <span class="title">getSubscriberInfo</span><span class="params">(Class&lt;?&gt; subscriberClass)</span></span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h2 id="3-2-SubscriberInfo"><a href="#3-2-SubscriberInfo" class="headerlink" title="3.2 SubscriberInfo"></a>3.2 SubscriberInfo</h2><p>接口，订阅者类实现该接口：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">interface</span> <span class="title">SubscriberInfo</span> </span>&#123;</span><br><span class="line">    Class&lt;?&gt; getSubscriberClass(); <span class="comment">// 获取订阅者对应的类；</span></span><br><span class="line"></span><br><span class="line">    SubscriberMethod[] getSubscriberMethods(); <span class="comment">// 获取订阅方法；</span></span><br><span class="line"></span><br><span class="line">    <span class="function">SubscriberInfo <span class="title">getSuperSubscriberInfo</span><span class="params">()</span></span>; <span class="comment">// 获取父类订阅者；</span></span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">boolean</span> <span class="title">shouldCheckSuperclass</span><span class="params">()</span></span>; <span class="comment">// 是否检查父类，动态生成时，传入的是 true；</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h2 id="3-3-AbstractSubscriberInfo"><a href="#3-3-AbstractSubscriberInfo" class="headerlink" title="3.3 AbstractSubscriberInfo"></a>3.3 AbstractSubscriberInfo</h2><p>抽象类，实现了 <strong>SubscriberInfo</strong> 接口，并实现了其部分接口，<strong>适配器模式</strong>：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">abstract</span> <span class="class"><span class="keyword">class</span> <span class="title">AbstractSubscriberInfo</span> <span class="keyword">implements</span> <span class="title">SubscriberInfo</span> </span>&#123;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> Class subscriberClass;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> Class&lt;? extends SubscriberInfo&gt; superSubscriberInfoClass;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> <span class="keyword">boolean</span> shouldCheckSuperclass;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">protected</span> <span class="title">AbstractSubscriberInfo</span><span class="params">(Class subscriberClass, Class&lt;? extends SubscriberInfo&gt; superSubscriberInfoClass,</span></span></span><br><span class="line"><span class="function"><span class="params">                                     <span class="keyword">boolean</span> shouldCheckSuperclass)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">this</span>.subscriberClass = subscriberClass; <span class="comment">// 订阅者类；</span></span><br><span class="line">        <span class="keyword">this</span>.superSubscriberInfoClass = superSubscriberInfoClass; <span class="comment">// 订阅者的父类订阅者，processor 动态生成时传入的是 null；</span></span><br><span class="line">        <span class="keyword">this</span>.shouldCheckSuperclass = shouldCheckSuperclass; <span class="comment">//  是否检查父类，processor 动态生成时传入的是 true；</span></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> Class <span class="title">getSubscriberClass</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> subscriberClass;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> SubscriberInfo <span class="title">getSuperSubscriberInfo</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">if</span>(superSubscriberInfoClass == <span class="keyword">null</span>) &#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="keyword">null</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            <span class="keyword">return</span> superSubscriberInfoClass.newInstance(); <span class="comment">// 返回父类订阅者的实例；</span></span><br><span class="line">        &#125; <span class="keyword">catch</span> (InstantiationException | IllegalAccessException e) &#123;</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> RuntimeException(e);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">boolean</span> <span class="title">shouldCheckSuperclass</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> shouldCheckSuperclass;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 下面是创建订阅方法；</span></span><br><span class="line">    <span class="function"><span class="keyword">protected</span> SubscriberMethod <span class="title">createSubscriberMethod</span><span class="params">(String methodName, Class&lt;?&gt; eventType)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> createSubscriberMethod(methodName, eventType, ThreadMode.POSTING, <span class="number">0</span>, <span class="keyword">false</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">protected</span> SubscriberMethod <span class="title">createSubscriberMethod</span><span class="params">(String methodName, Class&lt;?&gt; eventType, ThreadMode threadMode)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> createSubscriberMethod(methodName, eventType, threadMode, <span class="number">0</span>, <span class="keyword">false</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">protected</span> SubscriberMethod <span class="title">createSubscriberMethod</span><span class="params">(String methodName, Class&lt;?&gt; eventType, ThreadMode threadMode,</span></span></span><br><span class="line"><span class="function"><span class="params">                                                      <span class="keyword">int</span> priority, <span class="keyword">boolean</span> sticky)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            <span class="comment">// 显然这里是通过反射的方式来创建！</span></span><br><span class="line">            Method method = subscriberClass.getDeclaredMethod(methodName, eventType);</span><br><span class="line">            <span class="keyword">return</span> <span class="keyword">new</span> SubscriberMethod(method, eventType, threadMode, priority, sticky);</span><br><span class="line">        &#125; <span class="keyword">catch</span> (NoSuchMethodException e) &#123;</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> EventBusException(<span class="string">"Could not find subscriber method in "</span> + subscriberClass +</span><br><span class="line">                    <span class="string">". Maybe a missing ProGuard rule?"</span>, e);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h2 id="3-4-SimpleSubscriberInfo"><a href="#3-4-SimpleSubscriberInfo" class="headerlink" title="3.4 SimpleSubscriberInfo"></a>3.4 SimpleSubscriberInfo</h2><p>订阅类，继承了 AbstractSubscriberInfo 类，<strong>适配器模式</strong>：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">SimpleSubscriberInfo</span> <span class="keyword">extends</span> <span class="title">AbstractSubscriberInfo</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> SubscriberMethodInfo[] methodInfos; <span class="comment">// 保存的是订阅方法；</span></span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="title">SimpleSubscriberInfo</span><span class="params">(Class subscriberClass, <span class="keyword">boolean</span> shouldCheckSuperclass, SubscriberMethodInfo[] methodInfos)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">super</span>(subscriberClass, <span class="keyword">null</span>, shouldCheckSuperclass); <span class="comment">//【--&gt;3.3】抽象类的方法；</span></span><br><span class="line">        <span class="keyword">this</span>.methodInfos = methodInfos;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">synchronized</span> SubscriberMethod[] getSubscriberMethods() &#123; <span class="comment">// 返回所有的订阅方法；</span></span><br><span class="line">        <span class="keyword">int</span> length = methodInfos.length;</span><br><span class="line">        SubscriberMethod[] methods = <span class="keyword">new</span> SubscriberMethod[length];</span><br><span class="line">        <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; length; i++) &#123;</span><br><span class="line">            SubscriberMethodInfo info = methodInfos[i];</span><br><span class="line">            <span class="comment">//【--&gt;3.3】注意并不是直接返回，而是返回了一份拷贝，防止修改；</span></span><br><span class="line">            methods[i] = createSubscriberMethod(info.methodName, info.eventType, info.threadMode,</span><br><span class="line">                    info.priority, info.sticky);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> methods;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>不多说了！</p>
<h1 id="4-总结"><a href="#4-总结" class="headerlink" title="4 总结"></a>4 总结</h1><p>本篇文章，分析了 eventbus 的注解是如何处理的，生成了哪些类，类的关系如何（适配器模式）；</p>
<p>下篇文章，分析 register 的过程；</p>
</div></article><script data-ad-client="ca-pub-6845729157331145" async="" src="https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script><div class="post-copyright"><div class="post-copyright__author"><span class="post-copyright-meta">文章作者: </span><span class="post-copyright-info"><a href="mailto:undefined">Coolqi.Li</a></span></div><div class="post-copyright__type"><span class="post-copyright-meta">文章链接: </span><span class="post-copyright-info"><a href="https://lishuaiqi.top/2019/08/27/Eventbus-2-SubscribeProcessor/">https://lishuaiqi.top/2019/08/27/Eventbus-2-SubscribeProcessor/</a></span></div><div class="post-copyright__notice"><span class="post-copyright-meta">版权声明: </span><span class="post-copyright-info">本博客所有文章除特别声明外，均采用 <a href="https://creativecommons.org/licenses/by-nc-sa/4.0/">CC BY-NC-SA 4.0</a> 许可协议。转载请注明来自 <a href="https://lishuaiqi.top">Coolqi`s Blog</a>！</span></div></div><div class="post-meta__tag-list"><a class="post-meta__tags" href="/tags/EventBus/">EventBus</a></div><div class="post-qr-code"><div class="post-qr-code-item"><img class="post-qr-code__img" src="/img/zfb.jpg"><div class="post-qr-code__desc">支付宝打赏</div></div><div class="post-qr-code-item"><img class="post-qr-code__img" src="/img/wechat.jpg"><div class="post-qr-code__desc">微信打赏</div></div></div><div class="social-share"></div><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/social-share.js@1.0.16/dist/css/share.min.css"><script src="https://cdn.jsdelivr.net/npm/social-share.js@1.0.16/dist/js/social-share.min.js"></script><nav id="pagination"><div class="prev-post pull-left"><a href="/2019/09/10/Eventbus-3-getDefaultAndRegister/"><i class="fa fa-chevron-left">  </i><span>EventBus 第三篇 - 初始化、注册和取消注册</span></a></div><div class="next-post pull-right"><a href="/2019/08/19/Eventbus-1-baseUsages/"><span>EventBus 第一篇 - 基本使用</span><i class="fa fa-chevron-right"></i></a></div></nav></div></div><footer><div class="layout" id="footer"><div class="copyright">&copy;2015 - 2020 By Coolqi.Li</div><div class="framework-info"><span>驱动 - </span><a href="http://hexo.io"><span>Hexo</span></a><span class="footer-separator">|</span><span>主题 - </span><a href="https://github.com/Molunerfinn/hexo-theme-melody"><span>Melody</span></a></div><div class="footer_custom_text">Hi, welcome to my <a href="https://lishuaiqi.top/">blog</a>!</div><div class="busuanzi"><script async src="https://busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script><span id="busuanzi_container_page_pv"><i class="fa fa-file-o"></i><span id="busuanzi_value_page_pv"></span><span></span></span></div></div></footer><i class="fa fa-arrow-up" id="go-up" aria-hidden="true"></i><script src="/js/third-party/anime.min.js"></script><script src="/js/third-party/jquery.min.js"></script><script src="/js/third-party/jquery.fancybox.min.js"></script><script src="/js/third-party/velocity.min.js"></script><script src="/js/third-party/velocity.ui.min.js"></script><script src="/js/utils.js?version=1.5.6"></script><script src="/js/fancybox.js?version=1.5.6"></script><script src="/js/sidebar.js?version=1.5.6"></script><script src="/js/copy.js?version=1.5.6"></script><script src="/js/fireworks.js?version=1.5.6"></script><script src="/js/transition.js?version=1.5.6"></script><script src="/js/scroll.js?version=1.5.6"></script><script src="/js/head.js?version=1.5.6"></script><script type="text/x-mathjax-config">MathJax.Hub.Config({
  tex2jax: {
    inlineMath: [ ['$','$'], ["\\(","\\)"]  ],
    processEscapes: true,
    skipTags: ['script', 'noscript', 'style', 'textarea', 'pre', 'code']
  },
  CommonHTML: {
    linebreaks: { automatic: true, width: "90% container" }
  },
  "HTML-CSS": { 
    linebreaks: { automatic: true, width: "90% container" }
  },
  "SVG": { 
    linebreaks: { automatic: true, width: "90% container" }
  }
});
</script><script type="text/x-mathjax-config">MathJax.Hub.Queue(function() {
  var all = MathJax.Hub.getAllJax(), i;
  for (i=0; i < all.length; i += 1) {
    all[i].SourceElement().parentNode.className += ' has-jax';
  }
});
</script><script src="https://cdn.jsdelivr.net/npm/mathjax/MathJax.js?config=TeX-AMS-MML_HTMLorMML"></script><script src="/js/search/local-search.js"></script><div class="search-dialog" id="local-search"><div class="search-dialog__title" id="local-search-title">本地搜索</div><div id="local-input-panel"><div id="local-search-input"><div class="local-search-box"><input class="local-search-box--input" placeholder="搜索文章"></div></div></div><hr><div id="local-search-results"><div id="local-hits"></div><div id="local-stats"><div class="local-search-stats__hr" id="hr"><span>由</span> <a href="https://github.com/wzpan/hexo-generator-search" style="color:#49B1F5;">hexo-generator-search</a>
 <span>提供支持</span></div></div></div><span class="search-close-button"><i class="fa fa-times"></i></span></div><div class="search-mask"></div></body></html>
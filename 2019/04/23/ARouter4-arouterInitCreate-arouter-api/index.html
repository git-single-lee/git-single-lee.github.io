<!DOCTYPE html><html lang="zh-Hans"><head><meta name="generator" content="Hexo 3.9.0"><meta charset="UTF-8"><meta http-equiv="X-UA-Compatible" content="IE=edge"><meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1"><meta name="description" content="ARouter 第四篇 - 路由初始化 (arouter-api)"><meta name="keywords" content="ARouter"><meta name="author" content="Coolqi.Li"><meta name="copyright" content="Coolqi.Li"><title>ARouter 第四篇 - 路由初始化 (arouter-api) | Coolqi`s Blog</title><link rel="shortcut icon" href="/img/favicon.ico"><link rel="stylesheet" href="/css/index.css?version=1.7.0"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/font-awesome@latest/css/font-awesome.min.css?version=1.7.0"><link rel="stylesheet" href="https://use.fontawesome.com/releases/v5.7.2/css/all.css?version=1.7.0"><meta name="format-detection" content="telephone=no"><meta http-equiv="x-dns-prefetch-control" content="on"><link rel="dns-prefetch" href="https://cdn.jsdelivr.net"><link rel="dns-prefetch" href="https://unpkg.com"><link rel="stylesheet" type="text/css" href="https://cdn.jsdelivr.net/npm/gitment/style/default.min.css"><script src="https://cdn.jsdelivr.net/npm/gitment/dist/gitment.browser.min.js"></script><script src="https://cdn.jsdelivr.net/npm/blueimp-md5@2.10.0/js/md5.min.js"></script><link rel="dns-prefetch" href="https://hm.baidu.com"><script>var _hmt = _hmt || [];
(function() {
  var hm = document.createElement("script");
  hm.src = "https://hm.baidu.com/hm.js?b7acef5306e54116ad8a99e8b753a92d";
  var s = document.getElementsByTagName("script")[0]; 
  s.parentNode.insertBefore(hm, s);
})();</script><script>var GLOBAL_CONFIG = { 
  root: '/',
  algolia: undefined,
  localSearch: {"path":"search.xml","languages":{"hits_empty":"找不到您查询的内容:${query}"}},
  copy: {
    success: '复制成功',
    error: '复制错误',
    noSupport: '浏览器不支持'
  }
} </script></head><body><i class="fa fa-arrow-right" id="toggle-sidebar" aria-hidden="true"></i><div id="sidebar" data-display="true"><div class="toggle-sidebar-info text-center"><span data-toggle="切换文章详情">切换站点概览</span><hr></div><div class="sidebar-toc"><div class="sidebar-toc__title">目录</div><div class="sidebar-toc__progress"><span class="progress-notice">你已经读了</span><span class="progress-num">0</span><span class="progress-percentage">%</span><div class="sidebar-toc__progress-bar"></div></div><div class="sidebar-toc__content"><ol class="toc"><li class="toc-item toc-level-1"><a class="toc-link" href="#1-模块结构"><span class="toc-text">1 模块结构</span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#2-初始化方法"><span class="toc-text">2  初始化方法</span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#3-Launcher-包"><span class="toc-text">3 Launcher 包</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#3-1-ARouter"><span class="toc-text">3.1 ARouter</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#3-1-1-成员变量"><span class="toc-text">3.1.1 成员变量</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#3-1-2-init"><span class="toc-text">3.1.2 init</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#3-1-3-getInstance"><span class="toc-text">3.1.3 getInstance</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#3-1-4-build"><span class="toc-text">3.1.4 build</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#3-1-5-navigation"><span class="toc-text">3.1.5 navigation</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#3-2-ARouter"><span class="toc-text">3.2 _ARouter</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#3-2-1-成员变量"><span class="toc-text">3.2.1 成员变量</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#3-2-2-init"><span class="toc-text">3.2.2 init</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#3-2-3-afterInit"><span class="toc-text">3.2.3 afterInit</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#3-2-4-getInstance"><span class="toc-text">3.2.4 getInstance</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#3-2-5-build"><span class="toc-text">3.2.5 build</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#3-2-5-1-extractGroup"><span class="toc-text">3.2.5.1 extractGroup</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#3-2-6-navigation"><span class="toc-text">3.2.6 navigation</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#3-2-7-navigation"><span class="toc-text">3.2.7 _navigation</span></a></li></ol></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#4-core-包"><span class="toc-text">4 core 包</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#4-1-LogisticsCenter-核心一号种子"><span class="toc-text">4.1 LogisticsCenter - 核心一号种子</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#4-1-1-成员变量"><span class="toc-text">4.1.1 成员变量</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#4-1-2-init"><span class="toc-text">4.1.2 init</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#4-2-1-1-loadRouterMap"><span class="toc-text">4.2.1.1 loadRouterMap</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#4-1-3-buildProvider"><span class="toc-text">4.1.3 buildProvider</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#4-1-4-completion"><span class="toc-text">4.1.4 completion</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#4-2-WareHouse-核心二号种子"><span class="toc-text">4.2 WareHouse - 核心二号种子</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#4-2-1-成员变量"><span class="toc-text">4.2.1 成员变量</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#4-2-2-clear"><span class="toc-text">4.2.2 clear</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#4-3-InterceptorServiceImpl"><span class="toc-text">4.3 InterceptorServiceImpl</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#4-3-1-init"><span class="toc-text">4.3.1 init</span></a></li></ol></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#5-base-包"><span class="toc-text">5 base 包</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#5-1-UniqueKeyTreeMap"><span class="toc-text">5.1 UniqueKeyTreeMap</span></a></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#6-facade-包"><span class="toc-text">6 facade 包</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#6-1-PostCard"><span class="toc-text">6.1 PostCard</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#6-1-1-成员变量"><span class="toc-text">6.1.1 成员变量</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#6-1-2-new-Postcard"><span class="toc-text">6.1.2 new Postcard</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#6-1-3-navigation"><span class="toc-text">6.1.3 navigation</span></a></li></ol></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#9-Utils-包"><span class="toc-text">9 Utils 包</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#9-1-ClassUtils"><span class="toc-text">9.1 ClassUtils</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#9-1-1-成员变量"><span class="toc-text">9.1.1 成员变量</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#9-1-2-getFileNameByPackageName"><span class="toc-text">9.1.2 getFileNameByPackageName</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#9-1-3-getSourcePaths"><span class="toc-text">9.1.3 getSourcePaths</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#9-1-3-1-isVMMultidexCapable"><span class="toc-text">9.1.3.1 isVMMultidexCapable</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#9-1-3-2-getMultiDexPreferences"><span class="toc-text">9.1.3.2 getMultiDexPreferences</span></a></li></ol></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#9-2-PackageUtils"><span class="toc-text">9.2 PackageUtils</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#9-2-1-成员变量"><span class="toc-text">9.2.1 成员变量</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#9-2-2-isNewVersion"><span class="toc-text">9.2.2 isNewVersion</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#9-2-3-updateVersion"><span class="toc-text">9.2.3 updateVersion</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#9-x-Consts"><span class="toc-text">9.x Consts</span></a></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#10-总结"><span class="toc-text">10 总结</span></a></li></ol></div></div><div class="author-info hide"><div class="author-info__avatar text-center"><img src="/img/avatar.jpg"></div><div class="author-info__name text-center">Coolqi.Li</div><div class="author-info__description text-center">“Hi，我是李帅奇，Android 开发工程师，熬夜星人，一个努力赚钱，积极向上的好人。微信公众号：CoolOriLans (酷奇源语)”</div><div class="follow-button"><a href="https://github.com/git-single-lee">Follow Me</a></div><hr><div class="author-info-articles"><a class="author-info-articles__archives article-meta" href="/archives"><span class="pull-left">文章</span><span class="pull-right">90</span></a><a class="author-info-articles__tags article-meta" href="/tags"><span class="pull-left">标签</span><span class="pull-right">23</span></a><a class="author-info-articles__categories article-meta" href="/categories"><span class="pull-left">分类</span><span class="pull-right">30</span></a></div><hr><div class="author-info-links"><div class="author-info-links__title text-center">coolqi 和他的朋友们</div><a class="author-info-links__name text-center" href="https://developer.android.google.cn/">AndroidDeveloper</a><a class="author-info-links__name text-center" href="http://www.android-studio.org/">AndroidStudio</a><a class="author-info-links__name text-center" href="https://www.jianshu.com/u/123a20a96441">个人简书</a><a class="author-info-links__name text-center" href="https://weibo.com/coolqiLi">个人微博</a><a class="author-info-links__name text-center" href="https://www.jianshu.com/u/fd0b722ce11f">小二哥的 Android 站</a></div></div></div><div id="content-outer"><div id="top-container" style="background-image: url(/img/blog-bg.jpg)"><div id="page-header"><span class="pull-left"> <a id="site-name" href="/">Coolqi`s Blog</a></span><i class="fa fa-bars toggle-menu pull-right" aria-hidden="true"></i><span class="pull-right menus">   <a class="site-page" href="/">Home</a><a class="site-page" href="/categories">Categories</a><a class="site-page" href="/tags">Tags</a><a class="site-page" href="/archives">Archives</a><a class="site-page" href="/about">About</a></span><span class="pull-right"><a class="site-page social-icon search"><i class="fa fa-search"></i><span> 搜索</span></a></span></div><div id="post-info"><div id="post-title">ARouter 第四篇 - 路由初始化 (arouter-api)</div><div id="post-meta"><time class="post-meta__date"><i class="fa fa-calendar" aria-hidden="true"></i> 2019-04-23</time><span class="post-meta__separator">|</span><i class="fa fa-inbox post-meta__icon" aria-hidden="true"></i><a class="post-meta__categories" href="/categories/开源库源码分析/">开源库源码分析</a><i class="fa fa-angle-right" aria-hidden="true"></i><i class="fa fa-inbox post-meta__icon" aria-hidden="true"></i><a class="post-meta__categories" href="/categories/开源库源码分析/ARouter/">ARouter</a><div class="post-meta-wordcount"><span>字数总计: </span><span class="word-count">7.5k</span><span class="post-meta__separator">|</span><span>阅读时长: 35 分钟</span></div></div></div></div><div class="layout" id="content-inner"><article id="post"><div class="article-container" id="post-content"><p>本系列文章主要分析 ARouter 框架的架构和原理。</p>
<blockquote>
<p>这是阿里 ARouter 开源库的地址，大家可以直接访问</p>
<p><a href="https://github.com/alibaba/ARouter" target="_blank" rel="noopener">https://github.com/alibaba/ARouter</a></p>
</blockquote>
<p>本篇博文主要分析 arouter-api 模块，该模块涉及到 ARouter 一些核心逻辑：初始化，跳转，拦截，服务等，下面的几篇文章就要从这几个方向来分析；</p>
<p>绘图工具：PlantXML</p>
<p>在阅读过程中，涉及到方法跳转的时候，注释上有 <code>--&gt;</code>的标志，这样的好处是，以类为单位，一次性分析其所有的方法：</p>
<h1 id="1-模块结构"><a href="#1-模块结构" class="headerlink" title="1 模块结构"></a>1 模块结构</h1><p>我们先来看看模块结构：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br></pre></td><td class="code"><pre><span class="line">└── com</span><br><span class="line">    └── alibaba</span><br><span class="line">        └── android</span><br><span class="line">            └── arouter</span><br><span class="line">                ├── base</span><br><span class="line">                │   └── UniqueKeyTreeMap.java</span><br><span class="line">                ├── core</span><br><span class="line">                │   ├── AutowiredLifecycleCallback.java</span><br><span class="line">                │   ├── AutowiredServiceImpl.java</span><br><span class="line">                │   ├── InstrumentationHook.java</span><br><span class="line">                │   ├── InterceptorServiceImpl.java</span><br><span class="line">                │   ├── LogisticsCenter.java</span><br><span class="line">                │   └── Warehouse.java</span><br><span class="line">                ├── exception</span><br><span class="line">                │   ├── HandlerException.java</span><br><span class="line">                │   ├── InitException.java</span><br><span class="line">                │   └── NoRouteFoundException.java</span><br><span class="line">                ├── facade</span><br><span class="line">                │   ├── Postcard.java</span><br><span class="line">                │   ├── callback</span><br><span class="line">                │   │   ├── InterceptorCallback.java</span><br><span class="line">                │   │   ├── NavCallback.java</span><br><span class="line">                │   │   └── NavigationCallback.java</span><br><span class="line">                │   ├── service</span><br><span class="line">                │   │   ├── AutowiredService.java</span><br><span class="line">                │   │   ├── ClassLoaderService.java</span><br><span class="line">                │   │   ├── DegradeService.java</span><br><span class="line">                │   │   ├── InterceptorService.java</span><br><span class="line">                │   │   ├── PathReplaceService.java</span><br><span class="line">                │   │   ├── PretreatmentService.java</span><br><span class="line">                │   │   └── SerializationService.java</span><br><span class="line">                │   └── template</span><br><span class="line">                │       ├── IInterceptor.java</span><br><span class="line">                │       ├── IInterceptorGroup.java</span><br><span class="line">                │       ├── ILogger.java</span><br><span class="line">                │       ├── IPolicy.java</span><br><span class="line">                │       ├── IProvider.java</span><br><span class="line">                │       ├── IProviderGroup.java</span><br><span class="line">                │       ├── IRouteGroup.java</span><br><span class="line">                │       ├── IRouteRoot.java</span><br><span class="line">                │       └── ISyringe.java</span><br><span class="line">                ├── launcher</span><br><span class="line">                │   ├── ARouter.java</span><br><span class="line">                │   └── _ARouter.java</span><br><span class="line">                ├── thread</span><br><span class="line">                │   ├── CancelableCountDownLatch.java</span><br><span class="line">                │   ├── DefaultPoolExecutor.java</span><br><span class="line">                │   └── DefaultThreadFactory.java</span><br><span class="line">                └── utils</span><br><span class="line">                    ├── ClassUtils.java</span><br><span class="line">                    ├── Consts.java</span><br><span class="line">                    ├── DefaultLogger.java</span><br><span class="line">                    ├── MapUtils.java</span><br><span class="line">                    ├── PackageUtils.java</span><br><span class="line">                    └── TextUtils.java</span><br></pre></td></tr></table></figure>
<p> 可以看到，有如下的 package：</p>
<ul>
<li><strong>base</strong>：数据缓存类，内部提供了一个 treeMap 实现，用于存储 intercepter；</li>
<li><strong>core</strong>：核心类，ARouter的核心功能都在这里实现；</li>
<li><strong>exception</strong>：异常相关，主要是定义了内部的一些异常；</li>
<li><strong>facade</strong>：通过外观模式对外提供统一的接口，下面有三个子包：<ul>
<li><strong>callback</strong>：提供回调接口，以及默认的回调处理；</li>
<li><strong>service</strong>：ARouter 内部已经实现的一些 Service，对外提供拦截等功能；</li>
<li><strong>template</strong>：包含模版，提供了大量的模版接口，可以通过实现接口，配合注解，实现自定义的功能；</li>
</ul>
</li>
<li><strong>launcher</strong>：ARouter 的入口；</li>
<li><strong>thread</strong>：线程操作类；</li>
<li><strong>utils</strong>：提供多个工具类</li>
</ul>
<h1 id="2-初始化方法"><a href="#2-初始化方法" class="headerlink" title="2  初始化方法"></a>2  初始化方法</h1><p>我们在使用时，必须要做初始化：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//这两行必须写在 init 之前，否则这些配置在 init 过程中将无效；     </span></span><br><span class="line"><span class="comment">//【1】打印日志；</span></span><br><span class="line">ARouter.openLog();</span><br><span class="line"><span class="comment">//【2】开启调试模式（如果在 InstantRun 模式下运行，必须开启调试模式！线上版本需要关闭,否则有安全风险）；</span></span><br><span class="line">ARouter.openDebug();</span><br><span class="line">ARouter.init(mApplication); <span class="comment">// 尽可能早，推荐在 Application 中初始化；</span></span><br></pre></td></tr></table></figure>
<p>接下来，我们来看看 init 的过程：</p>
<h1 id="3-Launcher-包"><a href="#3-Launcher-包" class="headerlink" title="3 Launcher 包"></a>3 Launcher 包</h1><h2 id="3-1-ARouter"><a href="#3-1-ARouter" class="headerlink" title="3.1 ARouter"></a>3.1 ARouter</h2><p>ARouter 是整个库的入口！</p>
<h3 id="3-1-1-成员变量"><a href="#3-1-1-成员变量" class="headerlink" title="3.1.1 成员变量"></a>3.1.1 成员变量</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// Key of raw uri</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> String RAW_URI = <span class="string">"NTeRQWvye18AkPd6G"</span>;</span><br><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> String AUTO_INJECT = <span class="string">"wmHzgD4lOj5o4241"</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">private</span> <span class="keyword">volatile</span> <span class="keyword">static</span> ARouter instance = <span class="keyword">null</span>;</span><br><span class="line"><span class="keyword">private</span> <span class="keyword">volatile</span> <span class="keyword">static</span> <span class="keyword">boolean</span> hasInit = <span class="keyword">false</span>;</span><br><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> ILogger logger;</span><br></pre></td></tr></table></figure>
<h3 id="3-1-2-init"><a href="#3-1-2-init" class="headerlink" title="3.1.2 init"></a>3.1.2 init</h3><p>我们来看看 init 初始化的方法：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">init</span><span class="params">(Application application)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">if</span> (!hasInit) &#123;</span><br><span class="line">        logger = _ARouter.logger;</span><br><span class="line">        _ARouter.logger.info(Consts.TAG, <span class="string">"ARouter init start."</span>);</span><br><span class="line">        <span class="comment">//【--&gt;3.2.2】执行初始化；</span></span><br><span class="line">        hasInit = _ARouter.init(application);</span><br><span class="line">        <span class="keyword">if</span> (hasInit) &#123;</span><br><span class="line">            <span class="comment">//【--&gt;3.2.3】执行初始化后面的操作；</span></span><br><span class="line">            _ARouter.afterInit();</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        _ARouter.logger.info(Consts.TAG, <span class="string">"ARouter init over."</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h3 id="3-1-3-getInstance"><a href="#3-1-3-getInstance" class="headerlink" title="3.1.3 getInstance"></a>3.1.3 getInstance</h3><p>获得 ARouter 的实例（单例模式）：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">static</span> ARouter <span class="title">getInstance</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    <span class="keyword">if</span> (!hasInit) &#123;</span><br><span class="line">        <span class="keyword">throw</span> <span class="keyword">new</span> InitException(<span class="string">"ARouter::Init::Invoke init(context) first!"</span>);</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        <span class="keyword">if</span> (instance == <span class="keyword">null</span>) &#123;</span><br><span class="line">            <span class="keyword">synchronized</span> (ARouter.class) &#123;</span><br><span class="line">                <span class="keyword">if</span> (instance == <span class="keyword">null</span>) &#123;</span><br><span class="line">                    <span class="comment">//【1】ARouter 的构造器方法体是空的；</span></span><br><span class="line">                    instance = <span class="keyword">new</span> ARouter(); </span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> instance;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>这里使用了单例模式创建：ARouter ！</p>
<h3 id="3-1-4-build"><a href="#3-1-4-build" class="headerlink" title="3.1.4 build"></a>3.1.4 build</h3><p>afterInit 方法中传入了 “/arouter/service/interceptor” 参数，创建跳转信息！</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> Postcard <span class="title">build</span><span class="params">(String path)</span> </span>&#123; <span class="comment">// Route.path</span></span><br><span class="line">    <span class="comment">//【--&gt;3.2.4】返回 _ARouter 的实例</span></span><br><span class="line">    <span class="comment">//【--&gt;3.2.5】创建跳转信息；</span></span><br><span class="line">    <span class="keyword">return</span> _ARouter.getInstance().build(path);</span><br><span class="line">&#125;</span><br><span class="line">... ... ...<span class="comment">// 先不关注其他的方法；</span></span><br></pre></td></tr></table></figure>
<p>ARouter 提供了下面的多个方法用于创建跳转信息：</p>
<ul>
<li><p><code>Postcard build(String path)</code>: 指定 Route.path，<strong>跳转/初始化</strong>都会使用到该方法；</p>
</li>
<li><p><code>Postcard build(String path, String group)</code>：指定 Route.path, Route.group，跳转时使用；</p>
</li>
<li><code>Postcard build(Uri url)</code>：指定 uri，uri 需要在说明书中设置；</li>
</ul>
<p>这里我们<strong>先关注 init 过程中调用的</strong>！</p>
<p>可以看到，最后调用的是 _ARouter 的方法，注意这个方法返回的是：</p>
<ul>
<li><strong>Postcard</strong>：继承了 RouteMeta，用于封装跳转信息；</li>
</ul>
<h3 id="3-1-5-navigation"><a href="#3-1-5-navigation" class="headerlink" title="3.1.5 navigation"></a>3.1.5 navigation</h3><p>执行跳转：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> &lt;T&gt; <span class="function">T <span class="title">navigation</span><span class="params">(Class&lt;? extends T&gt; service)</span> </span>&#123;</span><br><span class="line">    <span class="comment">//【--&gt;3.2.6】通过跳转，返回服务对象；</span></span><br><span class="line">    <span class="keyword">return</span> _ARouter.getInstance().navigation(service);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">public</span> Object <span class="title">navigation</span><span class="params">(Context mContext, Postcard postcard, <span class="keyword">int</span> requestCode, NavigationCallback callback)</span> </span>&#123;</span><br><span class="line">    <span class="comment">//【--&gt;3.2.6】执行跳转，这也是真正的跳转接口；</span></span><br><span class="line">    <span class="keyword">return</span> _ARouter.getInstance().navigation(mContext, postcard, requestCode, callback);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>ARouter 提供了 2 个跳转接口：</p>
<ul>
<li><code>navigation(Class&lt;? extends T&gt; service)</code>: 用于<strong>获取泛型指定的 Service</strong>，实际上并不是跳转接口；</li>
<li><code>navigation(Context mContext, Postcard postcard, int requestCode, NavigationCallback callback)</code>：这个才是真正的跳转接口！</li>
</ul>
<p>这篇博文先不讲 <strong>navigation</strong>，我们分析初始化 init 的过程：</p>
<ul>
<li><code>interceptorService = (InterceptorService) ARouter.getInstance().build(&quot;/arouter/service/interceptor&quot;).navigation();</code>    <ul>
<li>在执行 <strong>afterInit</strong> 的时候，<strong>会通过 navigation 方法返回 InterceptorServiceIpml 实例</strong>，这个方法我们跟踪了代码，调的是第二个 <strong>navigation</strong> 方法；</li>
</ul>
</li>
<li><code>PathReplaceService pService = ARouter.getInstance().navigation(PathReplaceService.class);</code><ul>
<li>而在获得  InterceptorService 实例的时候，会<strong>先调用 build 方法</strong>，获得 <strong>PathReplaceService</strong> 实例，这里就是<strong>第一个 navigation 方法</strong>，但是这里我们不分析它；</li>
<li>实际上 <strong>PathReplaceService 和 InterceptorServiceImpl 的获取方式是一样的</strong>！</li>
</ul>
</li>
</ul>
<h2 id="3-2-ARouter"><a href="#3-2-ARouter" class="headerlink" title="3.2 _ARouter"></a>3.2 _ARouter</h2><h3 id="3-2-1-成员变量"><a href="#3-2-1-成员变量" class="headerlink" title="3.2.1 成员变量"></a>3.2.1 成员变量</h3><p>下面是 _ARouter 的成员属性：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">static</span> ILogger logger = <span class="keyword">new</span> DefaultLogger(Consts.TAG); <span class="comment">// Log 系统，位于 utils 包；</span></span><br><span class="line"><span class="keyword">private</span> <span class="keyword">volatile</span> <span class="keyword">static</span> <span class="keyword">boolean</span> monitorMode = <span class="keyword">false</span>;</span><br><span class="line"><span class="keyword">private</span> <span class="keyword">volatile</span> <span class="keyword">static</span> <span class="keyword">boolean</span> debuggable = <span class="keyword">false</span>;</span><br><span class="line"><span class="keyword">private</span> <span class="keyword">volatile</span> <span class="keyword">static</span> <span class="keyword">boolean</span> autoInject = <span class="keyword">false</span>;</span><br><span class="line"><span class="keyword">private</span> <span class="keyword">volatile</span> <span class="keyword">static</span> _ARouter instance = <span class="keyword">null</span>;</span><br><span class="line"><span class="keyword">private</span> <span class="keyword">volatile</span> <span class="keyword">static</span> <span class="keyword">boolean</span> hasInit = <span class="keyword">false</span>;</span><br><span class="line"><span class="keyword">private</span> <span class="keyword">volatile</span> <span class="keyword">static</span> ThreadPoolExecutor executor = DefaultPoolExecutor.getInstance(); <span class="comment">// 线程池对象，由 DefaultPoolExecutor 创建；</span></span><br><span class="line"><span class="keyword">private</span> <span class="keyword">static</span> Handler mHandler;</span><br><span class="line"><span class="keyword">private</span> <span class="keyword">static</span> Context mContext;</span><br><span class="line"></span><br><span class="line"><span class="keyword">private</span> <span class="keyword">static</span> InterceptorService interceptorService; <span class="comment">// 用于执行所有的 Interceptor；</span></span><br></pre></td></tr></table></figure>
<h3 id="3-2-2-init"><a href="#3-2-2-init" class="headerlink" title="3.2.2 init"></a>3.2.2 init</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">protected</span> <span class="keyword">static</span> <span class="keyword">synchronized</span> <span class="keyword">boolean</span> <span class="title">init</span><span class="params">(Application application)</span> </span>&#123;</span><br><span class="line">    mContext = application;</span><br><span class="line">    <span class="comment">//【--&gt;4.1.2】初始化 LogisticsCenter</span></span><br><span class="line">    LogisticsCenter.init(mContext, executor);</span><br><span class="line">    logger.info(Consts.TAG, <span class="string">"ARouter init success!"</span>);</span><br><span class="line">    hasInit = <span class="keyword">true</span>; <span class="comment">// 判断是否 init；</span></span><br><span class="line">    mHandler = <span class="keyword">new</span> Handler(Looper.getMainLooper()); <span class="comment">// 主线程的 handler</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">true</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>在初始化 LogisticsCenter 的时候，传入了一个线程池！</p>
<h3 id="3-2-3-afterInit"><a href="#3-2-3-afterInit" class="headerlink" title="3.2.3 afterInit"></a>3.2.3 afterInit</h3><p> 在 ARouter 执行完成初始化之后，会触发 interceptor 的 init 操作：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">static</span> <span class="keyword">void</span> <span class="title">afterInit</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    <span class="comment">//【--&gt;3.1.3】获取 ARouter 的实例；</span></span><br><span class="line">    <span class="comment">//【--&gt;3.1.4】build 跳转信息，返回一个 PostCard 实例；</span></span><br><span class="line">    <span class="comment">//【--&gt;6.1.3】执行 PostCard 的 nativagation 方法，获得系统服务 InterceptorServiceImpl 实例；</span></span><br><span class="line">    interceptorService = (InterceptorService) ARouter.getInstance().build(<span class="string">"/arouter/service/interceptor"</span>).navigation();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>可以看到，获取 InterceptorServiceImpl 实例，是通过 PostCard.navigation 方法的！</p>
<p><strong>build 的参数传入的是 “/arouter/service/interceptor”</strong>，这里我们要获取一个 InterceptorServiceImpl 实例 ！</p>
<h3 id="3-2-4-getInstance"><a href="#3-2-4-getInstance" class="headerlink" title="3.2.4 getInstance"></a>3.2.4 getInstance</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">protected</span> <span class="keyword">static</span> _ARouter <span class="title">getInstance</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    <span class="keyword">if</span> (!hasInit) &#123;</span><br><span class="line">        <span class="keyword">throw</span> <span class="keyword">new</span> InitException(<span class="string">"ARouterCore::Init::Invoke init(context) first!"</span>);</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        <span class="keyword">if</span> (instance == <span class="keyword">null</span>) &#123;</span><br><span class="line">            <span class="keyword">synchronized</span> (_ARouter.class) &#123;</span><br><span class="line">                <span class="keyword">if</span> (instance == <span class="keyword">null</span>) &#123;</span><br><span class="line">                    <span class="comment">//【1】_ARouter 的构造器是空的，就不再分析了；</span></span><br><span class="line">                    instance = <span class="keyword">new</span> _ARouter();</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> instance;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>通过单例模式创建 _ARouter 对象；</p>
<h3 id="3-2-5-build"><a href="#3-2-5-build" class="headerlink" title="3.2.5 build"></a>3.2.5 build</h3><p>ARouter.build 的方法，最后会掉到 _ARouter 中来；</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">protected</span> Postcard <span class="title">build</span><span class="params">(String path)</span> </span>&#123; <span class="comment">// Route.path；</span></span><br><span class="line">    <span class="keyword">if</span> (TextUtils.isEmpty(path)) &#123;</span><br><span class="line">        <span class="keyword">throw</span> <span class="keyword">new</span> HandlerException(Consts.TAG + <span class="string">"Parameter is invalid!"</span>);</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        <span class="comment">//【--&gt;3.1.5】创建 PathReplaceService，用于在跳转前，拦截 path，并对 path 做处理！</span></span><br><span class="line">        PathReplaceService pService = ARouter.getInstance().navigation(PathReplaceService.class);</span><br><span class="line">        <span class="keyword">if</span> (<span class="keyword">null</span> != pService) &#123;</span><br><span class="line">            <span class="comment">//【---&gt;6.3.1】通过 PathReplaceService 对 path 做预处理！</span></span><br><span class="line">            path = pService.forString(path);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">//【2】调用第三个方法：</span></span><br><span class="line">        <span class="keyword">return</span> build(path, extractGroup(path));</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line">... ... ...<span class="comment">// 先不看其他的 build 方法！</span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">protected</span> Postcard <span class="title">build</span><span class="params">(String path, String group)</span> </span>&#123; <span class="comment">// Route,path, Route.group；</span></span><br><span class="line">    <span class="keyword">if</span> (TextUtils.isEmpty(path) || TextUtils.isEmpty(group)) &#123;</span><br><span class="line">        <span class="keyword">throw</span> <span class="keyword">new</span> HandlerException(Consts.TAG + <span class="string">"Parameter is invalid!"</span>);</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        <span class="comment">//【--&gt;3.1.5】创建 PathReplaceService，用于在跳转前，拦截 uri，并对 uri 做处理！</span></span><br><span class="line">        PathReplaceService pService = ARouter.getInstance().navigation(PathReplaceService.class);</span><br><span class="line">        <span class="keyword">if</span> (<span class="keyword">null</span> != pService) &#123;</span><br><span class="line">            <span class="comment">//【---&gt;6.3.1】通过 PathReplaceService 对 path 做预处理！</span></span><br><span class="line">            path = pService.forString(path);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">//【--&gt;5.1】返回跳转信息；</span></span><br><span class="line">        <span class="comment">//【--&gt;6.1.1】创建跳转实例 Postcard；</span></span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> Postcard(path, group);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>同样，也是有三个重载函数：</p>
<ul>
<li><code>Postcard build(String path)</code>: 指定 Route.path，<strong>跳转/初始化</strong>都会使用到该方法，这个方法会调用第二个；</li>
<li><code>Postcard build(String path, String group)</code>：指定 Route.path, Route.group，跳转时使用；</li>
<li><code>Postcard build(Uri url)</code>：指定 uri，uri 需要在说明书中设置；</li>
</ul>
<p>这里我们<strong>先关注 init 过程中调用的</strong>！</p>
<p>（注意：这里有一个 <strong>PathReplaceService</strong>，用于在跳转前，拦截 path，并对 path 做处理，这个 Service 和路由跳转有关系，初始化这里我们先不过多分析！）</p>
<h4 id="3-2-5-1-extractGroup"><a href="#3-2-5-1-extractGroup" class="headerlink" title="3.2.5.1 extractGroup"></a>3.2.5.1 extractGroup</h4><p>这个方法的作用是对 path 做修正，看 path 是否正确，同时根据 path 生成 group：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">private</span> String <span class="title">extractGroup</span><span class="params">(String path)</span> </span>&#123;</span><br><span class="line">    <span class="comment">//【1】校验 path 是否正确</span></span><br><span class="line">    <span class="keyword">if</span> (TextUtils.isEmpty(path) || !path.startsWith(<span class="string">"/"</span>)) &#123;</span><br><span class="line">        <span class="keyword">throw</span> <span class="keyword">new</span> HandlerException(Consts.TAG + <span class="string">"Extract the default group failed, the path must be start with"</span> </span><br><span class="line">                                   + <span class="string">"'/' and contain more than 2 '/'!"</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">        <span class="comment">//【3】根据 path 生成 group；</span></span><br><span class="line">        String defaultGroup = path.substring(<span class="number">1</span>, path.indexOf(<span class="string">"/"</span>, <span class="number">1</span>));</span><br><span class="line">        <span class="keyword">if</span> (TextUtils.isEmpty(defaultGroup)) &#123;</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> HandlerException(Consts.TAG + <span class="string">"Extract the default group failed! There's nothing between 2 '/'!"</span>);</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            <span class="keyword">return</span> defaultGroup;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">        logger.warning(Consts.TAG, <span class="string">"Failed to extract default group! "</span> + e.getMessage());</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">null</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h3 id="3-2-6-navigation"><a href="#3-2-6-navigation" class="headerlink" title="3.2.6 navigation"></a>3.2.6 navigation</h3><p>最后会进入 _ARouter 的 navigation 方法中，我们看到，该方法的逻辑还是很多的，注意，这里我们传入的 callback 是 null 的！</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">protected</span> Object <span class="title">navigation</span><span class="params">(<span class="keyword">final</span> Context context, <span class="keyword">final</span> Postcard postcard, <span class="keyword">final</span> <span class="keyword">int</span> requestCode, <span class="keyword">final</span> NavigationCallback callback)</span> </span>&#123;</span><br><span class="line">    <span class="comment">//【*important】这里又和 PathReplaceService 一样的，又是通过跳转的方式获取 PretreatmentService 服务，对 Postcard 做预处理；</span></span><br><span class="line">    <span class="comment">// 这个同样的，我们先不看；</span></span><br><span class="line">    PretreatmentService pretreatmentService = ARouter.getInstance().navigation(PretreatmentService.class);</span><br><span class="line">    <span class="keyword">if</span> (<span class="keyword">null</span> != pretreatmentService &amp;&amp; !pretreatmentService.onPretreatment(context, postcard)) &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">null</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">        <span class="comment">//【--&gt;4.1.2】完善跳转信息！</span></span><br><span class="line">        LogisticsCenter.completion(postcard);</span><br><span class="line">    &#125; <span class="keyword">catch</span> (NoRouteFoundException ex) &#123;</span><br><span class="line">        logger.warning(Consts.TAG, ex.getMessage());</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (debuggable()) &#123;</span><br><span class="line">            runInMainThread(<span class="keyword">new</span> Runnable() &#123;</span><br><span class="line">                <span class="meta">@Override</span></span><br><span class="line">                <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">run</span><span class="params">()</span> </span>&#123;</span><br><span class="line">                    Toast.makeText(mContext, <span class="string">"There's no route matched!\n"</span> +</span><br><span class="line">                            <span class="string">" Path = ["</span> + postcard.getPath() + <span class="string">"]\n"</span> +</span><br><span class="line">                            <span class="string">" Group = ["</span> + postcard.getGroup() + <span class="string">"]"</span>, Toast.LENGTH_LONG).show();</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (<span class="keyword">null</span> != callback) &#123;</span><br><span class="line">            <span class="comment">///【1】当完善失败，则通过 callback.onLost 提示用户！</span></span><br><span class="line">            callback.onLost(postcard);</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            <span class="comment">//【*important】如果没有指定 callback，显然通过降级服务处理！</span></span><br><span class="line">            <span class="comment">// 这里又和 PathReplaceService 一样的，又是通过跳转的方式获取 DegradeService 服务，对 Postcard 做预处理；</span></span><br><span class="line">            <span class="comment">// 这个同样的，我们先不看；</span></span><br><span class="line">            DegradeService degradeService = ARouter.getInstance().navigation(DegradeService.class);</span><br><span class="line">            <span class="keyword">if</span> (<span class="keyword">null</span> != degradeService) &#123;</span><br><span class="line">                degradeService.onLost(context, postcard);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">null</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (<span class="keyword">null</span> != callback) &#123;</span><br><span class="line">        <span class="comment">//【2】回调 onFound 方法，表示跳转信息有效；</span></span><br><span class="line">        callback.onFound(postcard);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">//【--&gt;6.1】如果跳转不能避开所有的拦截器，那么就要在这里处理，我们知道 Fragment 和 IProvider 的子类是会避开拦截器的！</span></span><br><span class="line">    <span class="keyword">if</span> (!postcard.isGreenChannel()) &#123;</span><br><span class="line">        <span class="comment">//【*important】这一部分设计拦截器功能，我们在跳转那一篇再分析；</span></span><br><span class="line">        interceptorService.doInterceptions(postcard, <span class="keyword">new</span> InterceptorCallback() &#123;</span><br><span class="line"></span><br><span class="line">            <span class="meta">@Override</span></span><br><span class="line">            <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onContinue</span><span class="params">(Postcard postcard)</span> </span>&#123;</span><br><span class="line">                _navigation(context, postcard, requestCode, callback);</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            <span class="meta">@Override</span></span><br><span class="line">            <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onInterrupt</span><span class="params">(Throwable exception)</span> </span>&#123;</span><br><span class="line">                <span class="keyword">if</span> (<span class="keyword">null</span> != callback) &#123;</span><br><span class="line">                    callback.onInterrupt(postcard);</span><br><span class="line">                &#125;</span><br><span class="line"></span><br><span class="line">                logger.info(Consts.TAG, <span class="string">"Navigation failed, termination by interceptor : "</span> + exception.getMessage());</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;);</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        <span class="comment">//【--&gt;3.2.7】最终的处理；</span></span><br><span class="line">        <span class="keyword">return</span> _navigation(context, postcard, requestCode, callback);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">null</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p><strong>_ARouter 也提供了 2 个跳转接口</strong>：</p>
<ul>
<li><code>navigation(Context mContext, Postcard postcard, int requestCode, NavigationCallback callback)</code>：这个才是真正的跳转接口！</li>
</ul>
<p>同样的，我们也只看 <code>init</code>的过程，也就是获取 <strong>InterceptorServiceImpl</strong> 实例的过程，这个过程调用的是上面的四参方法；</p>
<ul>
<li><p><code>&lt;T&gt; T navigation(Class&lt;? extends T&gt; service)</code>: 用于<strong>获取泛型指定的 Service</strong>！</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">protected</span> &lt;T&gt; <span class="function">T <span class="title">navigation</span><span class="params">(Class&lt;? extends T&gt; service)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">        <span class="comment">//【--&gt;4.1.3】通过 serviceName 找到，对应的 Service 的 RouteMeta 实例，然后创建 Postcard 实例</span></span><br><span class="line">        <span class="comment">// service.getName() 返回的是全限定名；</span></span><br><span class="line">        Postcard postcard = LogisticsCenter.buildProvider(service.getName());</span><br><span class="line">  </span><br><span class="line">        <span class="comment">//【1】如果是 null，说明使用的是旧版本的 compiler sdk，早期的 compiler 不使用全限定名区获取服务；</span></span><br><span class="line">        <span class="keyword">if</span> (<span class="keyword">null</span> == postcard) &#123;</span><br><span class="line">            <span class="comment">//【--&gt;4.1.3】通过 serviceName 找到，对应的 Service 的 RouteMeta 实例，然后创建 Postcard 实例</span></span><br><span class="line">            postcard = LogisticsCenter.buildProvider(service.getSimpleName());</span><br><span class="line">        &#125;</span><br><span class="line">  </span><br><span class="line">        <span class="keyword">if</span> (<span class="keyword">null</span> == postcard) &#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="keyword">null</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">//【--&gt;4.1.4】完成跳转！</span></span><br><span class="line">        LogisticsCenter.completion(postcard);</span><br><span class="line">        <span class="keyword">return</span> (T) postcard.getProvider();</span><br><span class="line">    &#125; <span class="keyword">catch</span> (NoRouteFoundException ex) &#123;</span><br><span class="line">        logger.warning(Consts.TAG, ex.getMessage());</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">null</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
</li>
</ul>
<p>实际上并不是跳转接口，<strong>PathReplaceService</strong>，<strong>PretreatmentService</strong>，<strong>DegradeService</strong> 都是通过这个方法获取！</p>
<p>我们后面统一进行分析！</p>
<h3 id="3-2-7-navigation"><a href="#3-2-7-navigation" class="headerlink" title="3.2.7 _navigation"></a>3.2.7 _navigation</h3><p>最后会调用 _navigation 返回我们的 InterceptorServiceImpl 实例，我们知道 <strong>InterceptorServiceImpl 是 PROVIDER 类型的</strong>：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">private</span> Object <span class="title">_navigation</span><span class="params">(<span class="keyword">final</span> Context context, <span class="keyword">final</span> Postcard postcard, <span class="keyword">final</span> <span class="keyword">int</span> requestCode, <span class="keyword">final</span> NavigationCallback callback)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">final</span> Context currentContext = <span class="keyword">null</span> == context ? mContext : context;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">switch</span> (postcard.getType()) &#123;</span><br><span class="line">        <span class="keyword">case</span> ACTIVITY:</span><br><span class="line">            <span class="comment">// Build intent</span></span><br><span class="line">            <span class="keyword">final</span> Intent intent = <span class="keyword">new</span> Intent(currentContext, postcard.getDestination());</span><br><span class="line">            intent.putExtras(postcard.getExtras());</span><br><span class="line"></span><br><span class="line">            <span class="comment">// Set flags.</span></span><br><span class="line">            <span class="keyword">int</span> flags = postcard.getFlags();</span><br><span class="line">            <span class="keyword">if</span> (-<span class="number">1</span> != flags) &#123;</span><br><span class="line">                intent.setFlags(flags);</span><br><span class="line">            &#125; <span class="keyword">else</span> <span class="keyword">if</span> (!(currentContext <span class="keyword">instanceof</span> Activity)) &#123;    <span class="comment">// Non activity, need less one flag.</span></span><br><span class="line">                intent.setFlags(Intent.FLAG_ACTIVITY_NEW_TASK);</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            <span class="comment">// Set Actions</span></span><br><span class="line">            String action = postcard.getAction();</span><br><span class="line">            <span class="keyword">if</span> (!TextUtils.isEmpty(action)) &#123;</span><br><span class="line">                intent.setAction(action);</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            <span class="comment">// Navigation in main looper.</span></span><br><span class="line">            runInMainThread(<span class="keyword">new</span> Runnable() &#123;</span><br><span class="line">                <span class="meta">@Override</span></span><br><span class="line">                <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">run</span><span class="params">()</span> </span>&#123;</span><br><span class="line">                    startActivity(requestCode, currentContext, intent, postcard, callback);</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;);</span><br><span class="line"></span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line">        <span class="keyword">case</span> PROVIDER:</span><br><span class="line">            <span class="comment">//【over】返回了 iprovider 实例，就是我们的 InterceptorServiceImpl 对象；</span></span><br><span class="line">            <span class="keyword">return</span> postcard.getProvider();</span><br><span class="line">        <span class="keyword">case</span> BOARDCAST:</span><br><span class="line">        <span class="keyword">case</span> CONTENT_PROVIDER:</span><br><span class="line">        <span class="keyword">case</span> FRAGMENT:</span><br><span class="line">            Class fragmentMeta = postcard.getDestination();</span><br><span class="line">            <span class="keyword">try</span> &#123;</span><br><span class="line">                Object instance = fragmentMeta.getConstructor().newInstance();</span><br><span class="line">                <span class="keyword">if</span> (instance <span class="keyword">instanceof</span> Fragment) &#123;</span><br><span class="line">                    ((Fragment) instance).setArguments(postcard.getExtras());</span><br><span class="line">                &#125; <span class="keyword">else</span> <span class="keyword">if</span> (instance <span class="keyword">instanceof</span> android.support.v4.app.Fragment) &#123;</span><br><span class="line">                    ((android.support.v4.app.Fragment) instance).setArguments(postcard.getExtras());</span><br><span class="line">                &#125;</span><br><span class="line"></span><br><span class="line">                <span class="keyword">return</span> instance;</span><br><span class="line">            &#125; <span class="keyword">catch</span> (Exception ex) &#123;</span><br><span class="line">                logger.error(Consts.TAG, <span class="string">"Fetch fragment instance error, "</span> + TextUtils.formatStackTrace(ex.getStackTrace()));</span><br><span class="line">            &#125;</span><br><span class="line">        <span class="keyword">case</span> METHOD:</span><br><span class="line">        <span class="keyword">case</span> SERVICE:</span><br><span class="line">        <span class="keyword">default</span>:</span><br><span class="line">            <span class="keyword">return</span> <span class="keyword">null</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">null</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>这里涉及到其他类型的处理，我们在路由跳转的时候再分析；</p>
<h1 id="4-core-包"><a href="#4-core-包" class="headerlink" title="4 core 包"></a>4 core 包</h1><h2 id="4-1-LogisticsCenter-核心一号种子"><a href="#4-1-LogisticsCenter-核心一号种子" class="headerlink" title="4.1 LogisticsCenter - 核心一号种子"></a>4.1 LogisticsCenter - 核心一号种子</h2><h3 id="4-1-1-成员变量"><a href="#4-1-1-成员变量" class="headerlink" title="4.1.1 成员变量"></a>4.1.1 成员变量</h3> <figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">private</span> <span class="keyword">static</span> Context mContext;</span><br><span class="line"><span class="keyword">static</span> ThreadPoolExecutor executor; <span class="comment">// 线程池；</span></span><br><span class="line"><span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">boolean</span> registerByPlugin; <span class="comment">// 是否通过插件自动注册；</span></span><br></pre></td></tr></table></figure>
<h3 id="4-1-2-init"><a href="#4-1-2-init" class="headerlink" title="4.1.2 init"></a>4.1.2 init</h3><p>执行 init 操作；</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">synchronized</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">init</span><span class="params">(Context context, ThreadPoolExecutor tpe)</span> <span class="keyword">throws</span> HandlerException </span>&#123;</span><br><span class="line">  mContext = context;</span><br><span class="line">  executor = tpe;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">try</span> &#123;</span><br><span class="line">    <span class="keyword">long</span> startInit = System.currentTimeMillis();</span><br><span class="line">    <span class="comment">//【--&gt;5.1.1】是否使用 arouter-auto-register 插件来加载路由表；</span></span><br><span class="line">    loadRouterMap();</span><br><span class="line">    <span class="keyword">if</span> (registerByPlugin) &#123;</span><br><span class="line">      logger.info(TAG, <span class="string">"Load router map by arouter-auto-register plugin."</span>);</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123; <span class="comment">// 默认情况下是进入这里：</span></span><br><span class="line">      Set&lt;String&gt; routerMap;</span><br><span class="line"></span><br><span class="line">      <span class="comment">//【1】如果开启了 debug 模式或者说 Apk 发生了更新，那么 ARouter 会重建路由表；</span></span><br><span class="line">      <span class="comment">//【--&gt;9.2.2】isNewVersion 判断 apk 是否是新的安装；</span></span><br><span class="line">      <span class="keyword">if</span> (ARouter.debuggable() || PackageUtils.isNewVersion(context)) &#123;</span><br><span class="line">        logger.info(TAG, <span class="string">"Run with debug mode or new install, rebuild router map."</span>);</span><br><span class="line"> </span><br><span class="line">        <span class="comment">//【--&gt;9.1.2】这里更新路由表，通过包名 com.alibaba.android.arouter.routes，扫描包下面包含的所有的类的 ClassName</span></span><br><span class="line">        <span class="comment">// 这个包是在 arouter complier 阶段生成的，里面包含解析注解生成的 java 类；</span></span><br><span class="line">        routerMap = ClassUtils.getFileNameByPackageName(mContext, ROUTE_ROOT_PAKCAGE);</span><br><span class="line">        <span class="keyword">if</span> (!routerMap.isEmpty()) &#123;</span><br><span class="line">          <span class="comment">//【1.1】当我们能够扫描到路由信息后，会将这个信息保存到本地 sp 中；</span></span><br><span class="line">          context.getSharedPreferences(AROUTER_SP_CACHE_KEY, Context.MODE_PRIVATE).edit().putStringSet(AROUTER_SP_KEY_MAP, routerMap).apply();</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        PackageUtils.updateVersion(context); <span class="comment">//【--&gt;9.2.3】保存版本号；</span></span><br><span class="line">      &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        logger.info(TAG, <span class="string">"Load router map from cache."</span>);</span><br><span class="line">        <span class="comment">//【2】其他情况，是默认从本地缓存中读取路由表的！</span></span><br><span class="line">        routerMap = <span class="keyword">new</span> HashSet&lt;&gt;(context.getSharedPreferences(AROUTER_SP_CACHE_KEY, Context.MODE_PRIVATE).getStringSet(AROUTER_SP_KEY_MAP, <span class="keyword">new</span> HashSet&lt;String&gt;()));</span><br><span class="line">      &#125;</span><br><span class="line"></span><br><span class="line">      logger.info(TAG, <span class="string">"Find router map finished, map size = "</span> + routerMap.size() + <span class="string">", cost "</span> + (System.currentTimeMillis() - startInit) + <span class="string">" ms."</span>);</span><br><span class="line">      startInit = System.currentTimeMillis();</span><br><span class="line"></span><br><span class="line">      <span class="comment">//【2】处理路由表的信息，在前面，我们将 aouter-compiler 在编译时期生成的 class 都加载到了 routerMap 中了；</span></span><br><span class="line">      <span class="keyword">for</span> (String className : routerMap) &#123;</span><br><span class="line">        <span class="keyword">if</span> (className.startsWith(ROUTE_ROOT_PAKCAGE + DOT + SDK_NAME + SEPARATOR + SUFFIX_ROOT)) &#123;</span><br><span class="line">          <span class="comment">//【2.1】判断前缀：com.alibaba.android.arouter.routes.ARouter&amp;&amp;Root，符合前缀的都是 IRouteRoot 的子类</span></span><br><span class="line">          <span class="comment">// 调用其 loadInto --&gt; Warehouse.groupsIndex；</span></span><br><span class="line">          ((IRouteRoot) (Class.forName(className).getConstructor().newInstance())).loadInto(Warehouse.groupsIndex);</span><br><span class="line">         </span><br><span class="line">        &#125; <span class="keyword">else</span> <span class="keyword">if</span> (className.startsWith(ROUTE_ROOT_PAKCAGE + DOT + SDK_NAME + SEPARATOR + SUFFIX_INTERCEPTORS)) &#123;</span><br><span class="line">          <span class="comment">//【2.2】判断前缀：com.alibaba.android.arouter.routes.ARouter&amp;&amp;Interceptors，符合前缀的都是 IInterceptorGroup 的子类</span></span><br><span class="line">          <span class="comment">// 调用其 loadInto --&gt; Warehouse.interceptorsIndex；</span></span><br><span class="line">          ((IInterceptorGroup) (Class.forName(className).getConstructor().newInstance())).loadInto(Warehouse.interceptorsIndex);</span><br><span class="line"></span><br><span class="line">        &#125; <span class="keyword">else</span> <span class="keyword">if</span> (className.startsWith(ROUTE_ROOT_PAKCAGE + DOT + SDK_NAME + SEPARATOR + SUFFIX_PROVIDERS)) &#123;</span><br><span class="line">          <span class="comment">//【2.3】判断前缀：com.alibaba.android.arouter.routes.ARouter&amp;&amp;Providers，符合前缀的都是 IProviderGroup 的子类</span></span><br><span class="line">          <span class="comment">// 调用其 loadInto --&gt; Warehouse.providersIndex；</span></span><br><span class="line">          ((IProviderGroup) (Class.forName(className).getConstructor().newInstance())).loadInto(Warehouse.providersIndex);</span><br><span class="line"></span><br><span class="line">        &#125;</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    logger.info(TAG, <span class="string">"Load root element finished, cost "</span> + (System.currentTimeMillis() - startInit) + <span class="string">" ms."</span>);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (Warehouse.groupsIndex.size() == <span class="number">0</span>) &#123;</span><br><span class="line">      logger.error(TAG, <span class="string">"No mapping files were found, check your configuration please!"</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (ARouter.debuggable()) &#123;</span><br><span class="line">      logger.debug(TAG, String.format(Locale.getDefault(), <span class="string">"LogisticsCenter has already been loaded, GroupIndex[%d], “ </span></span><br><span class="line"><span class="string">                                      + ”InterceptorIndex[%d], ProviderIndex[%d]"</span>, Warehouse.groupsIndex.size(),“ </span><br><span class="line">                                      + Warehouse.interceptorsIndex.size(), Warehouse.providersIndex.size()));</span><br><span class="line">    &#125;</span><br><span class="line">  &#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">    <span class="keyword">throw</span> <span class="keyword">new</span> HandlerException(TAG + <span class="string">"ARouter init logistics center exception! ["</span> + e.getMessage() + <span class="string">"]"</span>);</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>我们看到，ARouter 会将路由表存储在本地缓存 sp 中，在版本号发生变化的时候会处理，上面的这些常量定义在 Consts 中。</p>
<p>我们还记得 arouter compiler 在动态生成代码的时候，会创建 IRouteRoot，IInterceptorGroup，IProviderGroup 的子类，我们通过 Route，intercepor  注解的元素都会被封装成 RouteMeta 实例，通过 loadInto 方法，加入到 Warehouse 对应的集合中！</p>
<p>下面我们通过之前动态代码来分析：</p>
<ul>
<li>如果前缀是 <code>ARouter$$Root</code>, 那么会触发 <code>ARouter$$Root$$moduleName.loadInto</code>方法：</li>
</ul>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">ARouter</span>$$<span class="title">Root</span>$$<span class="title">app</span> <span class="keyword">implements</span> <span class="title">IRouteRoot</span> </span>&#123;</span><br><span class="line">  <span class="meta">@Override</span></span><br><span class="line">  <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">loadInto</span><span class="params">(Map&lt;String, Class&lt;? extends IRouteGroup&gt;&gt; routes)</span> </span>&#123;</span><br><span class="line">    routes.put(<span class="string">"coolqiActivity"</span>, ARouter$$Group$$coolqiActivity.class);</span><br><span class="line">    routes.put(<span class="string">"coolqiProvider"</span>, ARouter$$Group$$coolqiProvider.class);</span><br><span class="line">    routes.put(<span class="string">"coolqiService"</span>, ARouter$$Group$$coolqiService.class);</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>这部分数据会加载到：<strong>Warehouse.groupsIndex</strong>，这样，我们就可以通过它按组加载了；</p>
<ul>
<li>如果前缀是 <code>ARouter$$Interceptors</code>, 那么会触发 <code>ARouter$$Interceptors$$moduleName.loadInto</code>方法：</li>
</ul>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">ARouter</span>$$<span class="title">Interceptors</span>$$<span class="title">app</span> <span class="keyword">implements</span> <span class="title">IInterceptorGroup</span> </span>&#123;</span><br><span class="line">  <span class="meta">@Override</span></span><br><span class="line">  <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">loadInto</span><span class="params">(Map&lt;Integer, Class&lt;? extends IInterceptor&gt;&gt; interceptors)</span> </span>&#123;</span><br><span class="line">    interceptors.put(<span class="number">8</span>, TestInterceptor.class);</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>这部分数据会加载到：<strong>Warehouse.interceptorsIndex</strong></p>
<ul>
<li>如果前缀是 <code>ARouter$$Providers</code>, 那么会触发 <code>ARouter$$Providers$$moduleName.loadInto</code>方法：</li>
</ul>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">ARouter</span>$$<span class="title">Providers</span>$$<span class="title">app</span> <span class="keyword">implements</span> <span class="title">IProviderGroup</span> </span>&#123;</span><br><span class="line">  <span class="meta">@Override</span></span><br><span class="line">  <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">loadInto</span><span class="params">(Map&lt;String, RouteMeta&gt; providers)</span> </span>&#123;</span><br><span class="line">    providers.put(<span class="string">"com.alibaba.android.arouter.facade.service.SerializationService"</span>, RouteMeta.build(RouteType.PROVIDER, MySerializationService.class, </span><br><span class="line">                            <span class="string">"/coolqiService/MySerializationService"</span>, <span class="string">"coolqiService"</span>, <span class="keyword">null</span>, -<span class="number">1</span>, -<span class="number">2147483648</span>));</span><br><span class="line">    providers.put(<span class="string">"com.pa.sales2.test.MyIProvider"</span>, RouteMeta.build(RouteType.PROVIDER, MyIProvider.class, </span><br><span class="line">                            <span class="string">"/coolqiProvider/MyIProvider"</span>, <span class="string">"coolqiProvider"</span>, <span class="keyword">null</span>, -<span class="number">1</span>, -<span class="number">2147483648</span>));</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>这部分数据会加载到：<strong>Warehouse.providersIndex</strong></p>
<h4 id="4-2-1-1-loadRouterMap"><a href="#4-2-1-1-loadRouterMap" class="headerlink" title="4.2.1.1 loadRouterMap"></a>4.2.1.1 loadRouterMap</h4><p>这个方法用于判断是否通过 arouter-auto-register 插件自动注册路由；</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">loadRouterMap</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    registerByPlugin = <span class="keyword">false</span>;</span><br><span class="line">    <span class="comment">//auto generate register code by gradle plugin: arouter-auto-register</span></span><br><span class="line">    <span class="comment">// looks like below:</span></span><br><span class="line">    <span class="comment">// registerRouteRoot(new ARouter..Root..modulejava());</span></span><br><span class="line">    <span class="comment">// registerRouteRoot(new ARouter..Root..modulekotlin());</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>可以看到，如果使用了 arouter-auto-register 插件，那么会自动执行 registerRouteRoot 相关代码；</p>
<p>这里我们先不看和 arouter-auto-register 相关的代码：</p>
<p>这个方法默认是将 registerByPlugin 设置为 false；</p>
<h3 id="4-1-3-buildProvider"><a href="#4-1-3-buildProvider" class="headerlink" title="4.1.3 buildProvider"></a>4.1.3 buildProvider</h3><p>通过 serviceName 找到，对应的 Service 的 RouteMeta 实例，然后创建 Postcard 实例：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">static</span> Postcard <span class="title">buildProvider</span><span class="params">(String serviceName)</span> </span>&#123;</span><br><span class="line">    <span class="comment">//【--&gt;4.2.1】我们知道 service 实现了 IProvider 实例，所以保存在了 Warehouse.providersIndex 中！</span></span><br><span class="line">    RouteMeta meta = Warehouse.providersIndex.get(serviceName);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (<span class="keyword">null</span> == meta) &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">null</span>;</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        <span class="comment">//【--&gt;6.1.2】创建路由跳转信息；</span></span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> Postcard(meta.getPath(), meta.getGroup());</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h3 id="4-1-4-completion"><a href="#4-1-4-completion" class="headerlink" title="4.1.4 completion"></a>4.1.4 completion</h3><p>完善跳转信息，completion 会通过 Warehouse 的数据，填充 Postcard！</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">synchronized</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">completion</span><span class="params">(Postcard postcard)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">if</span> (<span class="keyword">null</span> == postcard) &#123;</span><br><span class="line">        <span class="keyword">throw</span> <span class="keyword">new</span> NoRouteFoundException(TAG + <span class="string">"No postcard!"</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">//【--&gt;4.2.1】从 Warehouse.routes 中获取 path 对应的 RouteMeta 缓存数据；</span></span><br><span class="line">    RouteMeta routeMeta = Warehouse.routes.get(postcard.getPath());</span><br><span class="line">    <span class="comment">//【1】如果找不到，那么就从 compiler 生成的数据中查找！</span></span><br><span class="line">    <span class="keyword">if</span> (<span class="keyword">null</span> == routeMeta) &#123; </span><br><span class="line">        <span class="comment">//【--&gt;4.2.1】从 Warehouse.routes 中获取 group 对应的 group 类文件；</span></span><br><span class="line">        Class&lt;? extends IRouteGroup&gt; groupMeta = Warehouse.groupsIndex.get(postcard.getGroup());</span><br><span class="line">        <span class="keyword">if</span> (<span class="keyword">null</span> == groupMeta) &#123; <span class="comment">// 【1.1】找不到抛出异常；</span></span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> NoRouteFoundException(TAG + <span class="string">"There is no route match the path ["</span> + postcard.getPath() + <span class="string">"], in group ["</span> + postcard.getGroup() + <span class="string">"]"</span>);</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line"></span><br><span class="line">            <span class="keyword">try</span> &#123;</span><br><span class="line">                <span class="keyword">if</span> (ARouter.debuggable()) &#123;</span><br><span class="line">                    logger.debug(TAG, String.format(Locale.getDefault(), <span class="string">"The group [%s] starts loading, trigger by [%s]"</span>, postcard.getGroup(), postcard.getPath()));</span><br><span class="line">                &#125;</span><br><span class="line">                <span class="comment">//【1.2】创建 groupMeta 对应的实例；</span></span><br><span class="line">                IRouteGroup iGroupInstance = groupMeta.getConstructor().newInstance();</span><br><span class="line">                <span class="comment">//【--&gt;4.2.1】调用其 loadInto 将 group 对应的信息加入到缓存 Warehouse.routes 中！</span></span><br><span class="line">                iGroupInstance.loadInto(Warehouse.routes);</span><br><span class="line">                <span class="comment">//【--&gt;4.2.1】然后从 Warehouse.groupsIndex 删除这个组对应的信息；</span></span><br><span class="line">                Warehouse.groupsIndex.remove(postcard.getGroup());</span><br><span class="line"></span><br><span class="line">                <span class="keyword">if</span> (ARouter.debuggable()) &#123;</span><br><span class="line">                    logger.debug(TAG, String.format(Locale.getDefault(), <span class="string">"The group [%s] has already been loaded, trigger by [%s]"</span>, postcard.getGroup(), postcard.getPath()));</span><br><span class="line">                &#125;</span><br><span class="line">            &#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">                <span class="keyword">throw</span> <span class="keyword">new</span> HandlerException(TAG + <span class="string">"Fatal exception when loading group meta. ["</span> + e.getMessage() + <span class="string">"]"</span>);</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="comment">//【--&gt;4.2.2】重新加载；</span></span><br><span class="line">            completion(postcard);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        <span class="comment">//【2】这里是通过 RouteMeta 来设置 Postcard 对象；</span></span><br><span class="line">        postcard.setDestination(routeMeta.getDestination());</span><br><span class="line">        postcard.setType(routeMeta.getType()); </span><br><span class="line">        postcard.setPriority(routeMeta.getPriority());</span><br><span class="line">        postcard.setExtra(routeMeta.getExtra());</span><br><span class="line">        <span class="comment">//【3】如果指定了 uri 就要从 uri 中设置传递的数据了，显然，这里我们并没有设置 Uri；</span></span><br><span class="line">        <span class="comment">// 我们也没有传递数据，只是为了获取 InterceptorServiceImpl 实例，我们先不看！</span></span><br><span class="line">        Uri rawUri = postcard.getUri();</span><br><span class="line">        <span class="keyword">if</span> (<span class="keyword">null</span> != rawUri) &#123; </span><br><span class="line">            Map&lt;String, String&gt; resultMap = TextUtils.splitQueryParameters(rawUri);</span><br><span class="line">            Map&lt;String, Integer&gt; paramsType = routeMeta.getParamsType(); </span><br><span class="line"></span><br><span class="line">            <span class="keyword">if</span> (MapUtils.isNotEmpty(paramsType)) &#123;</span><br><span class="line">                <span class="keyword">for</span> (Map.Entry&lt;String, Integer&gt; params : paramsType.entrySet()) &#123;</span><br><span class="line">                    setValue(postcard,</span><br><span class="line">                            params.getValue(),</span><br><span class="line">                            params.getKey(),</span><br><span class="line">                            resultMap.get(params.getKey()));</span><br><span class="line">                &#125;</span><br><span class="line">                <span class="comment">// 这里和 AutoInject 有关系，我们先不看！</span></span><br><span class="line">                postcard.getExtras().putStringArray(ARouter.AUTO_INJECT, paramsType.keySet().toArray(<span class="keyword">new</span> String[]&#123;&#125;));</span><br><span class="line">            &#125;</span><br><span class="line">            postcard.withString(ARouter.RAW_URI, rawUri.toString());</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment">//【4】这里是关键点，判断类型，可以看到 activity 这里是不处理的！；</span></span><br><span class="line">        <span class="keyword">switch</span> (routeMeta.getType()) &#123;</span><br><span class="line">            <span class="keyword">case</span> PROVIDER: </span><br><span class="line">                <span class="comment">//【4.1】我们要获取的 InterceptorServiceImpl，类型就是 PROVIDER；</span></span><br><span class="line">                <span class="comment">// routeMeta.getDestination 返回的是要访问的目标类：InterceptorServiceImpl.class;</span></span><br><span class="line">                Class&lt;? extends IProvider&gt; providerMeta = (Class&lt;? extends IProvider&gt;) routeMeta.getDestination();</span><br><span class="line">                <span class="comment">//【--&gt;4.2.1】然后优先从 Warehouse.providers 缓存中获取；</span></span><br><span class="line">                IProvider instance = Warehouse.providers.get(providerMeta);</span><br><span class="line">                <span class="keyword">if</span> (<span class="keyword">null</span> == instance) &#123;</span><br><span class="line">                    IProvider provider;</span><br><span class="line">                    <span class="keyword">try</span> &#123;</span><br><span class="line">                        <span class="comment">//【--&gt;4.3】创建 providerMeta 对应的实例，就是 InterceptorServiceImpl；</span></span><br><span class="line">                        provider = providerMeta.getConstructor().newInstance();</span><br><span class="line">                        <span class="comment">//【--&gt;4.3.1】执行 init 方法；</span></span><br><span class="line">                        provider.init(mContext);</span><br><span class="line">                        <span class="comment">//【--&gt;4.2.1】然后将加入到 Warehouse.providers 中去；</span></span><br><span class="line">                        Warehouse.providers.put(providerMeta, provider);</span><br><span class="line">                        instance = provider;</span><br><span class="line">                    &#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">                        <span class="keyword">throw</span> <span class="keyword">new</span> HandlerException(<span class="string">"Init provider failed! "</span> + e.getMessage());</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;</span><br><span class="line">                <span class="comment">//【--&gt;6.1.1】将 instance 保存到 postcard.provider 中去，因为跳转目标是 IProvider 的子类；</span></span><br><span class="line">                postcard.setProvider(instance);</span><br><span class="line">                postcard.greenChannel();  <span class="comment">//【--&gt;6.1.1】跳过所有的拦截器！</span></span><br><span class="line">                <span class="keyword">break</span>;</span><br><span class="line">            <span class="keyword">case</span> FRAGMENT:</span><br><span class="line">                postcard.greenChannel(); <span class="comment">// 跳过所有的拦截器！</span></span><br><span class="line">            <span class="keyword">default</span>:</span><br><span class="line">                <span class="keyword">break</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p><strong>缓存处理</strong>：</p>
<ul>
<li><strong>Warehouse.groupsIndex —&gt; Warehouse.routes</strong></li>
</ul>
<p>这里优先从 Warehouse.groupsIndex 中读取，Warehouse.groupsIndex 中保存的是类似下面的数据；</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">routes.put(<span class="string">"coolqiActivity"</span>, ARouter$$Group$$coolqiActivity.class);</span><br><span class="line">routes.put(<span class="string">"coolqiProvider"</span>, ARouter$$Group$$coolqiProvider.class);</span><br><span class="line">routes.put(<span class="string">"coolqiService"</span>, ARouter$$Group$$coolqiService.class);</span><br></pre></td></tr></table></figure>
<p>这里会从 Warehouse.groupsIndex 中，获取 group 对应的类，并创建实例，比如 <code>ARouter$$Group$$coolqiService</code>：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">ARouter</span>$$<span class="title">Group</span>$$<span class="title">coolqiService</span> <span class="keyword">implements</span> <span class="title">IRouteGroup</span> </span>&#123;</span><br><span class="line">  <span class="meta">@Override</span></span><br><span class="line">  <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">loadInto</span><span class="params">(Map&lt;String, RouteMeta&gt; atlas)</span> </span>&#123;</span><br><span class="line">    atlas.put(<span class="string">"/coolqiService/MySerializationService"</span>, RouteMeta.build(RouteType.PROVIDER, MySerializationService.class, </span><br><span class="line">                                                                       <span class="string">"/coolqiservice/myserializationservice"</span>, <span class="string">"coolqiservice"</span>, </span><br><span class="line">                                                                       <span class="keyword">null</span>, -<span class="number">1</span>, -<span class="number">2147483648</span>));</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>然后，调用其 loadInto 方法，就会将数据加入到 <code>Warehouse.routes</code> 中；</p>
<ul>
<li><strong>Warehouse.providers</strong></li>
</ul>
<p><strong>上面涉及到了数据处理，我们先不看，后面再分析</strong>；</p>
<h2 id="4-2-WareHouse-核心二号种子"><a href="#4-2-WareHouse-核心二号种子" class="headerlink" title="4.2 WareHouse - 核心二号种子"></a>4.2 WareHouse - 核心二号种子</h2><p>WareHouse 是 ARouter 的数据仓库，存储跳转的信息！</p>
<h3 id="4-2-1-成员变量"><a href="#4-2-1-成员变量" class="headerlink" title="4.2.1 成员变量"></a>4.2.1 成员变量</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//【1】保存动态生成的 ARouter$$Root$$moduleName.loadInto 方法加载的数据；</span></span><br><span class="line"><span class="comment">// 相当于，我们把 compiler 编译生成的数据保存到了这里；</span></span><br><span class="line"><span class="keyword">static</span> Map&lt;String, Class&lt;? extends IRouteGroup&gt;&gt; groupsIndex = <span class="keyword">new</span> HashMap&lt;&gt;();</span><br><span class="line"><span class="keyword">static</span> Map&lt;String, RouteMeta&gt; routes = <span class="keyword">new</span> HashMap&lt;&gt;(); <span class="comment">// 上面数据的缓存；</span></span><br><span class="line"></span><br><span class="line"><span class="comment">//【2】保存动态生成的 ARouter$$Providers$$moduleName.loadInto 方法加载的数据；</span></span><br><span class="line"><span class="comment">// 相当于，我们把 compiler 编译生成的数据保存到了这里；</span></span><br><span class="line"><span class="keyword">static</span> Map&lt;String, RouteMeta&gt; providersIndex = <span class="keyword">new</span> HashMap&lt;&gt;();</span><br><span class="line"><span class="keyword">static</span> Map&lt;Class, IProvider&gt; providers = <span class="keyword">new</span> HashMap&lt;&gt;(); <span class="comment">// 上面数据的缓存，key：类名，value：实例；</span></span><br><span class="line"></span><br><span class="line"><span class="comment">//【3】保存动态生成的 ARouter$$Interceptors$$moduleName.loadInto 方法加载的数据；【--&gt;5.1】对于 interceptor，是通过 UniqueKeyTreeMap 来存放的！</span></span><br><span class="line"><span class="comment">// 相当于，我们把 compiler 编译生成的数据保存到了这里；</span></span><br><span class="line"><span class="keyword">static</span> Map&lt;Integer, Class&lt;? extends IInterceptor&gt;&gt; interceptorsIndex = <span class="keyword">new</span> UniqueKeyTreeMap&lt;&gt;(<span class="string">"More than one interceptors use same priority [%s]"</span>);</span><br><span class="line"><span class="keyword">static</span> List&lt;IInterceptor&gt; interceptors = <span class="keyword">new</span> ArrayList&lt;&gt;(); <span class="comment">// 上面数据的缓存</span></span><br></pre></td></tr></table></figure>
<p>每次都会从 compiler 数据中获取数据保存到缓存数据中，然后删除  compiler 数据；</p>
<h3 id="4-2-2-clear"><a href="#4-2-2-clear" class="headerlink" title="4.2.2 clear"></a>4.2.2 clear</h3><p>清除内部数据：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">static</span> <span class="keyword">void</span> <span class="title">clear</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    routes.clear();</span><br><span class="line">    groupsIndex.clear();</span><br><span class="line">    providers.clear();</span><br><span class="line">    providersIndex.clear();</span><br><span class="line">    interceptors.clear();</span><br><span class="line">    interceptorsIndex.clear();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>WareHouse 只有一个 clear 方法，用来清除数据；</p>
<h2 id="4-3-InterceptorServiceImpl"><a href="#4-3-InterceptorServiceImpl" class="headerlink" title="4.3 InterceptorServiceImpl"></a>4.3 InterceptorServiceImpl</h2><p>InterceptorServiceImpl 他是 ARouter 内部实现的系统服务，是通过：<code>@Route(path = &quot;/arouter/service/interceptor&quot;)</code> 注解处理的，它的作用是<strong>用于处理拦截器</strong></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Route</span>(path = <span class="string">"/arouter/service/interceptor"</span>)</span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">InterceptorServiceImpl</span> <span class="keyword">implements</span> <span class="title">InterceptorService</span> </span>&#123;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">boolean</span> interceptorHasInit;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> Object interceptorInitLock = <span class="keyword">new</span> Object();</span><br><span class="line">    </span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h3 id="4-3-1-init"><a href="#4-3-1-init" class="headerlink" title="4.3.1 init"></a>4.3.1 init</h3><p>初始化所有的 Interceptor：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">init</span><span class="params">(<span class="keyword">final</span> Context context)</span> </span>&#123;</span><br><span class="line">    LogisticsCenter.executor.execute(<span class="keyword">new</span> Runnable() &#123;</span><br><span class="line">        <span class="meta">@Override</span></span><br><span class="line">        <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">run</span><span class="params">()</span> </span>&#123;</span><br><span class="line">            <span class="keyword">if</span> (MapUtils.isNotEmpty(Warehouse.interceptorsIndex)) &#123;</span><br><span class="line">                <span class="comment">//【--&gt;4.2.1】从 Warehouse.interceptorsIndex 获取所有注解生成的拦截器；</span></span><br><span class="line">                <span class="keyword">for</span> (Map.Entry&lt;Integer, Class&lt;? extends IInterceptor&gt;&gt; entry : Warehouse.interceptorsIndex.entrySet()) &#123;</span><br><span class="line">                    Class&lt;? extends IInterceptor&gt; interceptorClass = entry.getValue();</span><br><span class="line">                    <span class="keyword">try</span> &#123;</span><br><span class="line">                        <span class="comment">//【1】创建 interceptors 实例，并执行 init 初始化；</span></span><br><span class="line">                        IInterceptor iInterceptor = interceptorClass.getConstructor().newInstance();</span><br><span class="line">                        iInterceptor.init(context);</span><br><span class="line">                        <span class="comment">//【--&gt;4.2.1】将其加入到缓存 Warehouse.interceptors</span></span><br><span class="line">                        Warehouse.interceptors.add(iInterceptor);</span><br><span class="line">                    &#125; <span class="keyword">catch</span> (Exception ex) &#123;</span><br><span class="line">                        <span class="keyword">throw</span> <span class="keyword">new</span> HandlerException(TAG + <span class="string">"ARouter init interceptor error! name = ["</span> </span><br><span class="line">                                                   + interceptorClass.getName() + <span class="string">"], reason = ["</span> + ex.getMessage() + <span class="string">"]"</span>);</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;</span><br><span class="line"></span><br><span class="line">                interceptorHasInit = <span class="keyword">true</span>;</span><br><span class="line"></span><br><span class="line">                logger.info(TAG, <span class="string">"ARouter interceptors init over."</span>);</span><br><span class="line"></span><br><span class="line">                <span class="keyword">synchronized</span> (interceptorInitLock) &#123;</span><br><span class="line">                    interceptorInitLock.notifyAll();</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>这里又涉及到缓存：<strong>Warehouse.interceptorsIndex —&gt;Warehouse.interceptors</strong>;</p>
<h1 id="5-base-包"><a href="#5-base-包" class="headerlink" title="5 base 包"></a>5 base 包</h1><h2 id="5-1-UniqueKeyTreeMap"><a href="#5-1-UniqueKeyTreeMap" class="headerlink" title="5.1 UniqueKeyTreeMap"></a>5.1 UniqueKeyTreeMap</h2><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">UniqueKeyTreeMap</span>&lt;<span class="title">K</span>, <span class="title">V</span>&gt; <span class="keyword">extends</span> <span class="title">TreeMap</span>&lt;<span class="title">K</span>, <span class="title">V</span>&gt; </span>&#123;</span><br><span class="line">    <span class="keyword">private</span> String tipText;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="title">UniqueKeyTreeMap</span><span class="params">(String exceptionText)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">super</span>();</span><br><span class="line"></span><br><span class="line">        tipText = exceptionText;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> V <span class="title">put</span><span class="params">(K key, V value)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">if</span> (containsKey(key)) &#123;</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> RuntimeException(String.format(tipText, key));</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="keyword">super</span>.put(key, value);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>不多说了！</p>
<h1 id="6-facade-包"><a href="#6-facade-包" class="headerlink" title="6 facade 包"></a>6 facade 包</h1><h2 id="6-1-PostCard"><a href="#6-1-PostCard" class="headerlink" title="6.1 PostCard"></a>6.1 PostCard</h2><p>PostCard 继承了 RouteMeta，用于保存跳转的信息；</p>
<h3 id="6-1-1-成员变量"><a href="#6-1-1-成员变量" class="headerlink" title="6.1.1 成员变量"></a>6.1.1 成员变量</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">private</span> Uri uri;                <span class="comment">// uri</span></span><br><span class="line"><span class="keyword">private</span> Object tag;             <span class="comment">// A tag prepare for some thing wrong.</span></span><br><span class="line"><span class="keyword">private</span> Bundle mBundle;         <span class="comment">// 数据 bundle；</span></span><br><span class="line"><span class="keyword">private</span> <span class="keyword">int</span> flags = -<span class="number">1</span>;         <span class="comment">// 跳转的 flags，用于 activity；</span></span><br><span class="line"><span class="keyword">private</span> <span class="keyword">int</span> timeout = <span class="number">300</span>;      <span class="comment">// Navigation timeout, TimeUnit.Second</span></span><br><span class="line"><span class="keyword">private</span> IProvider provider;     <span class="comment">// 如果跳转的目标实例是 IProvider 的子类，那么该值不为 null；</span></span><br><span class="line"><span class="keyword">private</span> <span class="keyword">boolean</span> greenChannel;   <span class="comment">// 是否跳过所有的拦截器；</span></span><br><span class="line"><span class="keyword">private</span> SerializationService serializationService;</span><br><span class="line"></span><br><span class="line"><span class="keyword">private</span> Bundle optionsCompat;    <span class="comment">// 和动画相关的属性；</span></span><br><span class="line"><span class="keyword">private</span> <span class="keyword">int</span> enterAnim = -<span class="number">1</span>;</span><br><span class="line"><span class="keyword">private</span> <span class="keyword">int</span> exitAnim = -<span class="number">1</span>;</span><br></pre></td></tr></table></figure>
<h3 id="6-1-2-new-Postcard"><a href="#6-1-2-new-Postcard" class="headerlink" title="6.1.2 new Postcard"></a>6.1.2 new Postcard</h3><p>创建了一个 Postcard 实例！</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="title">Postcard</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    <span class="keyword">this</span>(<span class="keyword">null</span>, <span class="keyword">null</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="title">Postcard</span><span class="params">(String path, String group)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">this</span>(path, group, <span class="keyword">null</span>, <span class="keyword">null</span>);</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">//【1】最终会调用这个方法；</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="title">Postcard</span><span class="params">(String path, String group, Uri uri, Bundle bundle)</span> </span>&#123;</span><br><span class="line">    setPath(path); <span class="comment">// 设置 path</span></span><br><span class="line">    setGroup(group); <span class="comment">// 设置 group</span></span><br><span class="line">    setUri(uri); <span class="comment">// 设置 uri</span></span><br><span class="line">    <span class="keyword">this</span>.mBundle = (<span class="keyword">null</span> == bundle ? <span class="keyword">new</span> Bundle() : bundle);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>不多说了！</p>
<p>在初始化过程中，我们传入的 path：”/arouter/service/interceptor”</p>
<h3 id="6-1-3-navigation"><a href="#6-1-3-navigation" class="headerlink" title="6.1.3 navigation"></a>6.1.3 navigation</h3><p>在初始化过程中，执行 navigation 方法，获取系统拦截器：<strong>InterceptorServiceImpl</strong> </p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> Object <span class="title">navigation</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    <span class="keyword">return</span> navigation(<span class="keyword">null</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">public</span> Object <span class="title">navigation</span><span class="params">(Context context)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">return</span> navigation(context, <span class="keyword">null</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">public</span> Object <span class="title">navigation</span><span class="params">(Context context, NavigationCallback callback)</span> </span>&#123;</span><br><span class="line">    <span class="comment">//【--&gt;3.1.5】调用了 ARouter 的 navigation 方法！</span></span><br><span class="line">    <span class="keyword">return</span> ARouter.getInstance().navigation(context, <span class="keyword">this</span>, -<span class="number">1</span>, callback);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>这里涉及到了 <strong>NavigationCallback callback</strong> 的概念：<strong>跳转回调</strong>！ </p>
<h1 id="9-Utils-包"><a href="#9-Utils-包" class="headerlink" title="9 Utils 包"></a>9 Utils 包</h1><h2 id="9-1-ClassUtils"><a href="#9-1-ClassUtils" class="headerlink" title="9.1 ClassUtils"></a>9.1 ClassUtils</h2><h3 id="9-1-1-成员变量"><a href="#9-1-1-成员变量" class="headerlink" title="9.1.1 成员变量"></a>9.1.1 成员变量</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> String EXTRACTED_NAME_EXT = <span class="string">".classes"</span>; <span class="comment">// 文件后缀</span></span><br><span class="line"><span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> String EXTRACTED_SUFFIX = <span class="string">".zip"</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> String SECONDARY_FOLDER_NAME = <span class="string">"code_cache"</span> + File.separator + <span class="string">"secondary-dexes"</span>; <span class="comment">// 文件路径 /code_cache/secondary-dexes；</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> String PREFS_FILE = <span class="string">"multidex.version"</span>; <span class="comment">// 记录 mutilDex 信息的 sp name；</span></span><br><span class="line"><span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> String KEY_DEX_NUMBER = <span class="string">"dex.number"</span>; <span class="comment">// sp key 值，记录 dex 的数量；</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="keyword">int</span> VM_WITH_MULTIDEX_VERSION_MAJOR = <span class="number">2</span>; <span class="comment">// VM 相关，用于判断 vm 是否支持 multiDex；</span></span><br><span class="line"><span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="keyword">int</span> VM_WITH_MULTIDEX_VERSION_MINOR = <span class="number">1</span>;</span><br></pre></td></tr></table></figure>
<h3 id="9-1-2-getFileNameByPackageName"><a href="#9-1-2-getFileNameByPackageName" class="headerlink" title="9.1.2 getFileNameByPackageName"></a>9.1.2 getFileNameByPackageName</h3><p>通过指定包名，扫描 Apk 下面包含的所有类的 ClassName:</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">static</span> Set&lt;String&gt; <span class="title">getFileNameByPackageName</span><span class="params">(Context context, <span class="keyword">final</span> String packageName)</span> </span></span><br><span class="line"><span class="function">  																													<span class="keyword">throws</span> PackageManager.NameNotFoundException, IOException, InterruptedException </span>&#123;</span><br><span class="line">    <span class="keyword">final</span> Set&lt;String&gt; classNames = <span class="keyword">new</span> HashSet&lt;&gt;();</span><br><span class="line">    <span class="comment">//【--&gt;9.1.3】获取 apk 源代码（dex）的路径；</span></span><br><span class="line">    List&lt;String&gt; paths = getSourcePaths(context);</span><br><span class="line">    <span class="keyword">final</span> CountDownLatch parserCtl = <span class="keyword">new</span> CountDownLatch(paths.size());</span><br><span class="line"></span><br><span class="line">    <span class="keyword">for</span> (<span class="keyword">final</span> String path : paths) &#123;</span><br><span class="line">        DefaultPoolExecutor.getInstance().execute(<span class="keyword">new</span> Runnable() &#123;</span><br><span class="line">            <span class="meta">@Override</span></span><br><span class="line">            <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">run</span><span class="params">()</span> </span>&#123;</span><br><span class="line">                DexFile dexfile = <span class="keyword">null</span>;</span><br><span class="line"></span><br><span class="line">                <span class="keyword">try</span> &#123;</span><br><span class="line">                    <span class="comment">//【2】根据文件后缀的不同，会执行不通的操作，如果后缀是 .zip，那么回调用 DexFile.loadDex 方法；</span></span><br><span class="line">                    <span class="keyword">if</span> (path.endsWith(EXTRACTED_SUFFIX)) &#123; </span><br><span class="line">                        dexfile = DexFile.loadDex(path, path + <span class="string">".tmp"</span>, <span class="number">0</span>);</span><br><span class="line">                    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                        dexfile = <span class="keyword">new</span> DexFile(path);</span><br><span class="line">                    &#125;</span><br><span class="line">                    <span class="comment">//【3】遍历 dex 文件，找到该 apk 的所有 class，并返回其 class name；</span></span><br><span class="line">                    Enumeration&lt;String&gt; dexEntries = dexfile.entries();</span><br><span class="line">                    <span class="keyword">while</span> (dexEntries.hasMoreElements()) &#123;</span><br><span class="line">                        String className = dexEntries.nextElement();</span><br><span class="line">                        <span class="keyword">if</span> (className.startsWith(packageName)) &#123;</span><br><span class="line">                            classNames.add(className);</span><br><span class="line">                        &#125;</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125; <span class="keyword">catch</span> (Throwable ignore) &#123;</span><br><span class="line">                    Log.e(<span class="string">"ARouter"</span>, <span class="string">"Scan map file in dex files made error."</span>, ignore);</span><br><span class="line">                &#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">                    <span class="keyword">if</span> (<span class="keyword">null</span> != dexfile) &#123;</span><br><span class="line">                        <span class="keyword">try</span> &#123;</span><br><span class="line">                            dexfile.close();</span><br><span class="line">                        &#125; <span class="keyword">catch</span> (Throwable ignore) &#123;</span><br><span class="line">                        &#125;</span><br><span class="line">                    &#125;</span><br><span class="line">                    parserCtl.countDown();</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    parserCtl.await();</span><br><span class="line"></span><br><span class="line">    Log.d(Consts.TAG, <span class="string">"Filter "</span> + classNames.size() + <span class="string">" classes by packageName &lt;"</span> + packageName + <span class="string">"&gt;"</span>);</span><br><span class="line">    <span class="keyword">return</span> classNames;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h3 id="9-1-3-getSourcePaths"><a href="#9-1-3-getSourcePaths" class="headerlink" title="9.1.3 getSourcePaths"></a>9.1.3 getSourcePaths</h3><p>获取源代码路径：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">static</span> List&lt;String&gt; <span class="title">getSourcePaths</span><span class="params">(Context context)</span> <span class="keyword">throws</span> PackageManager.NameNotFoundException, IOException </span>&#123;</span><br><span class="line">    ApplicationInfo applicationInfo = context.getPackageManager().getApplicationInfo(context.getPackageName(), <span class="number">0</span>);</span><br><span class="line">    File sourceApk = <span class="keyword">new</span> File(applicationInfo.sourceDir);</span><br><span class="line"></span><br><span class="line">    List&lt;String&gt; sourcePaths = <span class="keyword">new</span> ArrayList&lt;&gt;();</span><br><span class="line">    sourcePaths.add(applicationInfo.sourceDir);<span class="comment">//【1】添加默认的 apk 源路径；</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">//【1】文件前缀：name.classes</span></span><br><span class="line">    String extractedFilePrefix = sourceApk.getName() + EXTRACTED_NAME_EXT;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//【--&gt;9.1.3.1】判断 vm 是否支持 multiDex，如何已经支持了 muitiDex，那就不去 Secondary Folder 加载 Classesx.zip</span></span><br><span class="line">    <span class="keyword">if</span> (!isVMMultidexCapable()) &#123;</span><br><span class="line">        <span class="comment">//【2】不支持 multiDex，那就要去加载 Classesx.zip；</span></span><br><span class="line">        <span class="keyword">int</span> totalDexNumber = getMultiDexPreferences(context).getInt(KEY_DEX_NUMBER, <span class="number">1</span>); <span class="comment">//【--&gt;9.1.3.2】获取 dex 的数量；</span></span><br><span class="line">        File dexDir = <span class="keyword">new</span> File(applicationInfo.dataDir, SECONDARY_FOLDER_NAME); <span class="comment">// 获取存放其他 dex 的目录；</span></span><br><span class="line">        <span class="comment">//【3】收集 Secondary Folder 目录下的 dex 的路径；</span></span><br><span class="line">        <span class="keyword">for</span> (<span class="keyword">int</span> secondaryNumber = <span class="number">2</span>; secondaryNumber &lt;= totalDexNumber; secondaryNumber++) &#123;</span><br><span class="line">            <span class="comment">//【3.1】每个 dex file 的文件名都是：name.classes.zip，添加到 sourcePaths 列表中；</span></span><br><span class="line">            String fileName = extractedFilePrefix + secondaryNumber + EXTRACTED_SUFFIX;</span><br><span class="line">            File extractedFile = <span class="keyword">new</span> File(dexDir, fileName);</span><br><span class="line">            <span class="keyword">if</span> (extractedFile.isFile()) &#123;</span><br><span class="line">                sourcePaths.add(extractedFile.getAbsolutePath());</span><br><span class="line">                <span class="comment">//we ignore the verify zip part</span></span><br><span class="line">            &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                <span class="keyword">throw</span> <span class="keyword">new</span> IOException(<span class="string">"Missing extracted secondary dex file '"</span> + extractedFile.getPath() + <span class="string">"'"</span>);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (ARouter.debuggable()) &#123; <span class="comment">// Search instant run support only debuggable</span></span><br><span class="line">        sourcePaths.addAll(tryLoadInstantRunDexFile(applicationInfo));</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">//【4】返回收集的列表</span></span><br><span class="line">    <span class="keyword">return</span> sourcePaths;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>过程还是比较简单的；</p>
<h4 id="9-1-3-1-isVMMultidexCapable"><a href="#9-1-3-1-isVMMultidexCapable" class="headerlink" title="9.1.3.1 isVMMultidexCapable"></a>9.1.3.1 isVMMultidexCapable</h4><p>判断 vm 是否支持 multiDex：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">boolean</span> <span class="title">isVMMultidexCapable</span><span class="params">()</span> </span>&#123;</span><br><span class="line">     <span class="keyword">boolean</span> isMultidexCapable = <span class="keyword">false</span>;</span><br><span class="line">     String vmName = <span class="keyword">null</span>;</span><br><span class="line"></span><br><span class="line">     <span class="keyword">try</span> &#123;</span><br><span class="line">         <span class="keyword">if</span> (isYunOS()) &#123; <span class="comment">//【1】YunOS 需要特殊判断</span></span><br><span class="line">             vmName = <span class="string">"'YunOS'"</span>;</span><br><span class="line">             isMultidexCapable = Integer.valueOf(System.getProperty(<span class="string">"ro.build.version.sdk"</span>)) &gt;= <span class="number">21</span>;</span><br><span class="line">         &#125; <span class="keyword">else</span> &#123; <span class="comment">//【2】非 YunOS 原生 Android</span></span><br><span class="line">             vmName = <span class="string">"'Android'"</span>;</span><br><span class="line">             String versionString = System.getProperty(<span class="string">"java.vm.version"</span>);</span><br><span class="line">             <span class="keyword">if</span> (versionString != <span class="keyword">null</span>) &#123;</span><br><span class="line">                 <span class="comment">//【3】判断 java.vm.version 属性的 major 和 minor 的范围；</span></span><br><span class="line">                 Matcher matcher = Pattern.compile(<span class="string">"(\\d+)\\.(\\d+)(\\.\\d+)?"</span>).matcher(versionString);</span><br><span class="line">                 <span class="keyword">if</span> (matcher.matches()) &#123;</span><br><span class="line">                     <span class="keyword">try</span> &#123;</span><br><span class="line">                         <span class="keyword">int</span> major = Integer.parseInt(matcher.group(<span class="number">1</span>));</span><br><span class="line">                         <span class="keyword">int</span> minor = Integer.parseInt(matcher.group(<span class="number">2</span>));</span><br><span class="line">                         isMultidexCapable = (major &gt; VM_WITH_MULTIDEX_VERSION_MAJOR)</span><br><span class="line">                                 || ((major == VM_WITH_MULTIDEX_VERSION_MAJOR)</span><br><span class="line">                                 &amp;&amp; (minor &gt;= VM_WITH_MULTIDEX_VERSION_MINOR));</span><br><span class="line">                     &#125; <span class="keyword">catch</span> (NumberFormatException ignore) &#123;</span><br><span class="line">                         <span class="comment">// let isMultidexCapable be false</span></span><br><span class="line">                     &#125;</span><br><span class="line">                 &#125;</span><br><span class="line">             &#125;</span><br><span class="line">         &#125;</span><br><span class="line">     &#125; <span class="keyword">catch</span> (Exception ignore) &#123;</span><br><span class="line"></span><br><span class="line">     &#125;</span><br><span class="line"></span><br><span class="line">     Log.i(Consts.TAG, <span class="string">"VM with name "</span> + vmName + (isMultidexCapable ? <span class="string">" has multidex support"</span> : <span class="string">" does not have multidex support"</span>));</span><br><span class="line">     <span class="keyword">return</span> isMultidexCapable;</span><br><span class="line"> &#125;</span><br></pre></td></tr></table></figure>
<p>不多说了 ；</p>
<h4 id="9-1-3-2-getMultiDexPreferences"><a href="#9-1-3-2-getMultiDexPreferences" class="headerlink" title="9.1.3.2 getMultiDexPreferences"></a>9.1.3.2 getMultiDexPreferences</h4><p>获取记录 multi dex 信息 sp，ARouter 将 dex 的数量保存到内部 sp 中，name： “multidex.version”：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">static</span> SharedPreferences <span class="title">getMultiDexPreferences</span><span class="params">(Context context)</span> </span>&#123;</span><br><span class="line">     <span class="keyword">return</span> context.getSharedPreferences(PREFS_FILE, Build.VERSION.SDK_INT &lt; Build.VERSION_CODES.HONEYCOMB </span><br><span class="line">                                         ? Context.MODE_PRIVATE : Context.MODE_PRIVATE | Context.MODE_MULTI_PROCESS);</span><br><span class="line"> &#125;</span><br></pre></td></tr></table></figure>
<h2 id="9-2-PackageUtils"><a href="#9-2-PackageUtils" class="headerlink" title="9.2 PackageUtils"></a>9.2 PackageUtils</h2><h3 id="9-2-1-成员变量"><a href="#9-2-1-成员变量" class="headerlink" title="9.2.1 成员变量"></a>9.2.1 成员变量</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">private</span> <span class="keyword">static</span> String NEW_VERSION_NAME;</span><br><span class="line"><span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">int</span> NEW_VERSION_CODE;</span><br></pre></td></tr></table></figure>
<p>用来缓存 apk 的版本号和版本名；</p>
<h3 id="9-2-2-isNewVersion"><a href="#9-2-2-isNewVersion" class="headerlink" title="9.2.2 isNewVersion"></a>9.2.2 isNewVersion</h3><p>判断 apk 是否是新的版本，包括第一次安装/更新安装；</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">boolean</span> <span class="title">isNewVersion</span><span class="params">(Context context)</span> </span>&#123;</span><br><span class="line">    <span class="comment">//【1】获得 apk 的信息；</span></span><br><span class="line">    PackageInfo packageInfo = getPackageInfo(context);</span><br><span class="line">    <span class="keyword">if</span> (<span class="keyword">null</span> != packageInfo) &#123;</span><br><span class="line">        <span class="comment">//【2】获取 apk 的版本名和版本号；</span></span><br><span class="line">        String versionName = packageInfo.versionName;</span><br><span class="line">        <span class="keyword">int</span> versionCode = packageInfo.versionCode;</span><br><span class="line"></span><br><span class="line">        SharedPreferences sp = context.getSharedPreferences(AROUTER_SP_CACHE_KEY, Context.MODE_PRIVATE);</span><br><span class="line">        <span class="comment">//【3】如何和本地缓存的不一样，那就说明是新版本；</span></span><br><span class="line">        <span class="keyword">if</span> (!versionName.equals(sp.getString(LAST_VERSION_NAME, <span class="keyword">null</span>)) || versionCode != sp.getInt(LAST_VERSION_CODE, -<span class="number">1</span>)) &#123;</span><br><span class="line">            <span class="comment">//【3.1】将新的 versionCode 和 VersionName 缓存下来；</span></span><br><span class="line">            NEW_VERSION_NAME = versionName;</span><br><span class="line">            NEW_VERSION_CODE = versionCode;</span><br><span class="line"></span><br><span class="line">            <span class="keyword">return</span> <span class="keyword">true</span>;</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="keyword">false</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">true</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h3 id="9-2-3-updateVersion"><a href="#9-2-3-updateVersion" class="headerlink" title="9.2.3 updateVersion"></a>9.2.3 updateVersion</h3><p>更新本地缓存：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">updateVersion</span><span class="params">(Context context)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">if</span> (!android.text.TextUtils.isEmpty(NEW_VERSION_NAME) &amp;&amp; NEW_VERSION_CODE != <span class="number">0</span>) &#123;</span><br><span class="line">        SharedPreferences sp = context.getSharedPreferences(AROUTER_SP_CACHE_KEY, Context.MODE_PRIVATE);</span><br><span class="line">        <span class="comment">//【1】写入到本地 sp 中；</span></span><br><span class="line">        sp.edit().putString(LAST_VERSION_NAME, NEW_VERSION_NAME).putInt(LAST_VERSION_CODE, NEW_VERSION_CODE).apply();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>这里的 <strong>LAST_VERSION_NAME</strong>，<strong>LAST_VERSION_CODE</strong> 均定义在 Consts 中；</p>
<h2 id="9-x-Consts"><a href="#9-x-Consts" class="headerlink" title="9.x Consts"></a>9.x Consts</h2><p>常量类，保存了 arouter-api 中的常量关键字；</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">final</span> <span class="class"><span class="keyword">class</span> <span class="title">Consts</span> </span>&#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> String SDK_NAME = <span class="string">"ARouter"</span>; <span class="comment">// 这几个常量在 complier 中有见过，用于生成注解处理后的类的类名和包名；</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> String TAG = SDK_NAME + <span class="string">"::"</span>;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> String SEPARATOR = <span class="string">"$$"</span>;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> String SUFFIX_ROOT = <span class="string">"Root"</span>;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> String SUFFIX_INTERCEPTORS = <span class="string">"Interceptors"</span>;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> String SUFFIX_PROVIDERS = <span class="string">"Providers"</span>;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> String SUFFIX_AUTOWIRED = SEPARATOR + SDK_NAME + SEPARATOR + <span class="string">"Autowired"</span>;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> String DOT = <span class="string">"."</span>;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> String ROUTE_ROOT_PAKCAGE = <span class="string">"com.alibaba.android.arouter.routes"</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> String AROUTER_SP_CACHE_KEY = <span class="string">"SP_AROUTER_CACHE"</span>; <span class="comment">// 本地缓存 sp 的 name</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> String AROUTER_SP_KEY_MAP = <span class="string">"ROUTER_MAP"</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> String LAST_VERSION_NAME = <span class="string">"LAST_VERSION_NAME"</span>; <span class="comment">// 用于保存 apk 的版本号</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> String LAST_VERSION_CODE = <span class="string">"LAST_VERSION_CODE"</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h1 id="10-总结"><a href="#10-总结" class="headerlink" title="10 总结"></a>10 总结</h1><p>我们分析路由初始化的整个过程，设计的 pkg 也很多，但是细心的观察，我们其实已经分析了一些路由跳转的逻辑，哈哈哈。</p>
<p>当然，还有下面的问题遗漏了：</p>
<ul>
<li><code>PathReplaceService，PretreatmentService，DegradeService</code>：是如何获取的，作用又是什么呢？</li>
<li><code>facade.service</code> 下的这些 <code>Service</code> 都是如何工作的呢？</li>
<li><code>core</code>目录下的 <code>AutowiredServiceImpl</code> 和 <code>InterceptorServiceImpl</code>，又是如何工作的呢？</li>
<li>ARouter 如何处理跳转回调的呢？</li>
</ul>
<p>这些问题，我会在下篇：路由跳转中分析；</p>
</div></article><div class="post-copyright"><div class="post-copyright__author"><span class="post-copyright-meta">文章作者: </span><span class="post-copyright-info"><a href="mailto:undefined">Coolqi.Li</a></span></div><div class="post-copyright__type"><span class="post-copyright-meta">文章链接: </span><span class="post-copyright-info"><a href="https://lishuaiqi.top/2019/04/23/ARouter4-arouterInitCreate-arouter-api/">https://lishuaiqi.top/2019/04/23/ARouter4-arouterInitCreate-arouter-api/</a></span></div><div class="post-copyright__notice"><span class="post-copyright-meta">版权声明: </span><span class="post-copyright-info">本博客所有文章除特别声明外，均采用 <a href="https://creativecommons.org/licenses/by-nc-sa/4.0/">CC BY-NC-SA 4.0</a> 许可协议。转载请注明来自 <a href="https://lishuaiqi.top">Coolqi`s Blog</a>！</span></div></div><div class="post-meta__tag-list"><a class="post-meta__tags" href="/tags/ARouter/">ARouter</a></div><div class="post-qr-code"><div class="post-qr-code-item"><img class="post-qr-code__img" src="/img/zfb.jpg"><div class="post-qr-code__desc">支付宝打赏</div></div><div class="post-qr-code-item"><img class="post-qr-code__img" src="/img/wechat.jpg"><div class="post-qr-code__desc">微信打赏</div></div></div><div class="social-share pull-right"></div><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/social-share.js@1.0.16/dist/css/share.min.css"><script src="https://cdn.jsdelivr.net/npm/social-share.js@1.0.16/dist/js/social-share.min.js"></script><nav id="pagination"><div class="prev-post pull-left"><a href="/2019/04/25/ARouter5-ServiceAndIntecerptor-arouter-api/"><i class="fa fa-chevron-left">  </i><span>ARouter 第五篇 - 服务和拦截器 (arouter-api)</span></a></div><div class="next-post pull-right"><a href="/2019/04/19/ARouter3-arouter-compiler/"><span>ARouter 第三篇 - 注解解析 (arouter-compiler)</span><i class="fa fa-chevron-right"></i></a></div></nav><div id="gitment-container"></div><script>var gitment = new Gitment({
  id: md5(decodeURI(location.pathname)),
  owner: '',
  repo: '',
  oauth: {
    client_id: '7b4efbcd7027d15749d6',
    client_secret: '14b5d7e8580ee29f7aeca733a25c000795967448'
  }
})
gitment.render('gitment-container')</script></div></div><footer class="footer-bg" style="background-image: url(/img/blog-bg.jpg)"><div class="layout" id="footer"><div class="copyright">&copy;2015 - 2022 By Coolqi.Li</div><div class="framework-info"><span>驱动 - </span><a href="http://hexo.io"><span>Hexo</span></a><span class="footer-separator">|</span><span>主题 - </span><a href="https://github.com/Molunerfinn/hexo-theme-melody"><span>Melody</span></a></div><div class="footer_custom_text">Hi, welcome to my <a href="https://lishuaiqi.top/">blog</a>!</div><div class="busuanzi"><script async src="//busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script><span id="busuanzi_container_page_pv"><i class="fa fa-file-o"></i><span id="busuanzi_value_page_pv"></span><span></span></span></div></div></footer><i class="fa fa-arrow-up" id="go-up" aria-hidden="true"></i><script src="/js/third-party/anime.min.js"></script><script src="/js/third-party/jquery.min.js"></script><script src="/js/third-party/jquery.fancybox.min.js"></script><script src="/js/third-party/velocity.min.js"></script><script src="/js/third-party/velocity.ui.min.js"></script><script src="/js/utils.js?version=1.7.0"></script><script src="/js/fancybox.js?version=1.7.0"></script><script src="/js/sidebar.js?version=1.7.0"></script><script src="/js/copy.js?version=1.7.0"></script><script src="/js/fireworks.js?version=1.7.0"></script><script src="/js/transition.js?version=1.7.0"></script><script src="/js/scroll.js?version=1.7.0"></script><script src="/js/head.js?version=1.7.0"></script><script type="text/x-mathjax-config">MathJax.Hub.Config({
  tex2jax: {
    inlineMath: [ ['$','$'], ["\\(","\\)"]  ],
    processEscapes: true,
    skipTags: ['script', 'noscript', 'style', 'textarea', 'pre', 'code']
  },
  CommonHTML: {
    linebreaks: { automatic: true, width: "90% container" }
  },
  "HTML-CSS": { 
    linebreaks: { automatic: true, width: "90% container" }
  },
  "SVG": { 
    linebreaks: { automatic: true, width: "90% container" }
  }
});
</script><script type="text/x-mathjax-config">MathJax.Hub.Queue(function() {
  var all = MathJax.Hub.getAllJax(), i;
  for (i=0; i < all.length; i += 1) {
    all[i].SourceElement().parentNode.className += ' has-jax';
  }
});
</script><script src="https://cdn.jsdelivr.net/npm/mathjax/MathJax.js?config=TeX-AMS-MML_HTMLorMML"></script><script src="/js/search/local-search.js"></script><script>if(/Android|webOS|iPhone|iPod|iPad|BlackBerry/i.test(navigator.userAgent)) {
  $('#nav').addClass('is-mobile')
  $('footer').addClass('is-mobile')
  $('#top-container').addClass('is-mobile')
}</script><div class="search-dialog" id="local-search"><div class="search-dialog__title" id="local-search-title">本地搜索</div><div id="local-input-panel"><div id="local-search-input"><div class="local-search-box"><input class="local-search-box--input" placeholder="搜索文章"></div></div></div><hr><div id="local-search-results"><div id="local-hits"></div><div id="local-stats"><div class="local-search-stats__hr" id="hr"><span>由</span> <a href="https://github.com/wzpan/hexo-generator-search" style="color:#49B1F5;">hexo-generator-search</a>
 <span>提供支持</span></div></div></div><span class="search-close-button"><i class="fa fa-times"></i></span></div><div class="search-mask"></div></body></html>
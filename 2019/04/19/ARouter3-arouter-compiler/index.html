<!DOCTYPE html><html lang="zh-Hans"><head><meta charset="UTF-8"><meta http-equiv="X-UA-Compatible" content="IE=edge"><meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1"><meta name="description" content="ARouter 第三篇 - 注解解析 (arouter-compiler)"><meta name="keywords" content="ARouter"><meta name="author" content="Coolqi.Li,undefined"><meta name="copyright" content="Coolqi.Li"><title>ARouter 第三篇 - 注解解析 (arouter-compiler) | Coolqi`s Blog</title><link rel="shortcut icon" href="/img/favicon.ico"><link rel="stylesheet" href="/css/index.css?version=1.5.6"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/font-awesome@4.7.0/css/font-awesome.min.css?version=1.5.6"><link rel="dns-prefetch" href="https://cdn.staticfile.org"><link rel="dns-prefetch" href="https://cdn.bootcss.com"><link rel="dns-prefetch" href="https://creativecommons.org"><script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script><script>(adsbygoogle = window.adsbygoogle || []).push({
  google_ad_client: 'ca-pub-6845729157331145',
  enable_page_level_ads: 'true'
});
</script><link rel="dns-prefetch" href="https://hm.baidu.com"><script>var _hmt = _hmt || [];
(function() {
  var hm = document.createElement("script");
  hm.src = "https://hm.baidu.com/hm.js?b7acef5306e54116ad8a99e8b753a92d";
  var s = document.getElementsByTagName("script")[0]; 
  s.parentNode.insertBefore(hm, s);
})();</script><script>var GLOBAL_CONFIG = { 
  root: '/',
  algolia: undefined,
  localSearch: {"path":"search.xml","languages":{"hits_empty":"找不到您查询的内容:${query}"}},
  copy: {
    success: '复制成功',
    error: '复制错误',
    noSupport: '浏览器不支持'
  }
} </script></head><body><i class="fa fa-arrow-right" id="toggle-sidebar" aria-hidden="true"></i><div id="sidebar"><div class="toggle-sidebar-info text-center"><span data-toggle="切换文章详情">切换站点概览</span><hr></div><div class="sidebar-toc"><div class="sidebar-toc__title">目录</div><div class="sidebar-toc__progress"><span class="progress-notice">你已经读了</span><span class="progress-num">0</span><span class="progress-percentage">%</span><div class="sidebar-toc__progress-bar"></div></div><div class="sidebar-toc__content"><ol class="toc"><li class="toc-item toc-level-1"><a class="toc-link" href="#1-模块结构"><span class="toc-text">1 模块结构</span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#2-源码分析"><span class="toc-text">2 源码分析</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#2-1-entity"><span class="toc-text">2.1 entity</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#2-1-1-RouteDoc"><span class="toc-text">2.1.1 RouteDoc</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#2-2-processor-注解解析"><span class="toc-text">2.2 processor - 注解解析</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#2-2-1-BaseProcessor"><span class="toc-text">2.2.1 BaseProcessor</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#2-2-2-RouteProcessor"><span class="toc-text">2.2.2  RouteProcessor</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#2-2-2-1-Field"><span class="toc-text">2.2.2.1 Field</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#2-2-2-2-Init"><span class="toc-text">2.2.2.2 Init</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#2-2-2-3-Process-处理-Route-注解"><span class="toc-text">2.2.2.3 Process - 处理 Route 注解</span></a><ol class="toc-child"><li class="toc-item toc-level-5"><a class="toc-link" href="#2-2-2-3-1-parseRoutes"><span class="toc-text">2.2.2.3.1 parseRoutes</span></a><ol class="toc-child"><li class="toc-item toc-level-6"><a class="toc-link" href="#2-2-2-3-1-1-categories"><span class="toc-text">2.2.2.3.1.1 categories</span></a></li><li class="toc-item toc-level-6"><a class="toc-link" href="#2-2-2-3-1-2-routeVerify"><span class="toc-text">2.2.2.3.1.2 routeVerify</span></a></li><li class="toc-item toc-level-6"><a class="toc-link" href="#2-2-2-3-1-2-extractDocInfo"><span class="toc-text">2.2.2.3.1.2 extractDocInfo</span></a></li></ol></li></ol></li><li class="toc-item toc-level-4"><a class="toc-link" href="#2-2-5-4-动态生成类"><span class="toc-text">2.2.5.4 动态生成类</span></a><ol class="toc-child"><li class="toc-item toc-level-5"><a class="toc-link" href="#2-2-5-4-1-模版信息"><span class="toc-text">2.2.5.4.1 模版信息</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#2-2-5-4-2-举个栗子"><span class="toc-text">2.2.5.4.2 举个栗子</span></a><ol class="toc-child"><li class="toc-item toc-level-6"><a class="toc-link" href="#2-2-5-4-2-1-实例代码"><span class="toc-text">2.2.5.4.2.1 实例代码</span></a></li><li class="toc-item toc-level-6"><a class="toc-link" href="#2-2-5-4-2-2-动态代码"><span class="toc-text">2.2.5.4.2.2 动态代码</span></a></li></ol></li></ol></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#2-2-3-AutowiredProcessor"><span class="toc-text">2.2.3 AutowiredProcessor</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#2-2-3-1-Field"><span class="toc-text">2.2.3.1 Field</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#2-2-3-2-Init"><span class="toc-text">2.2.3.2 Init</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#2-2-3-3-Process-处理-Autowired-注解"><span class="toc-text">2.2.3.3 Process  - 处理 Autowired 注解</span></a><ol class="toc-child"><li class="toc-item toc-level-5"><a class="toc-link" href="#2-2-3-3-1-categories"><span class="toc-text">2.2.3.3.1 categories</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#2-2-3-3-2-generateHelper"><span class="toc-text">2.2.3.3.2 generateHelper</span></a><ol class="toc-child"><li class="toc-item toc-level-6"><a class="toc-link" href="#2-2-3-3-2-1-buildCastCode"><span class="toc-text">2.2.3.3.2.1 buildCastCode</span></a></li><li class="toc-item toc-level-6"><a class="toc-link" href="#2-2-3-3-2-2-buildStatement"><span class="toc-text">2.2.3.3.2.2 buildStatement</span></a></li></ol></li></ol></li><li class="toc-item toc-level-4"><a class="toc-link" href="#2-2-3-4-动态生成类"><span class="toc-text">2.2.3.4 动态生成类</span></a><ol class="toc-child"><li class="toc-item toc-level-5"><a class="toc-link" href="#2-2-3-4-1-模版信息"><span class="toc-text">2.2.3.4.1 模版信息</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#2-2-3-4-2-举个栗子"><span class="toc-text">2.2.3.4.2 举个栗子</span></a><ol class="toc-child"><li class="toc-item toc-level-6"><a class="toc-link" href="#2-2-3-4-2-1-实例代码"><span class="toc-text">2.2.3.4.2.1 实例代码</span></a></li><li class="toc-item toc-level-6"><a class="toc-link" href="#2-2-3-4-2-2-动态代码"><span class="toc-text">2.2.3.4.2.2 动态代码</span></a></li></ol></li></ol></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#2-2-4-InterceptorProcessor"><span class="toc-text">2.2.4 InterceptorProcessor</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#2-2-4-1-Field"><span class="toc-text">2.2.4.1 Field</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#2-2-4-2-Init"><span class="toc-text">2.2.4.2 Init</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#2-2-4-3-Process-处理-Interceptor-注解"><span class="toc-text">2.2.4.3 Process - 处理 Interceptor 注解</span></a><ol class="toc-child"><li class="toc-item toc-level-5"><a class="toc-link" href="#2-2-4-3-1-parseInterceptors"><span class="toc-text">2.2.4.3.1 parseInterceptors</span></a><ol class="toc-child"><li class="toc-item toc-level-6"><a class="toc-link" href="#2-2-4-3-1-1-verify"><span class="toc-text">2.2.4.3.1.1 verify</span></a></li></ol></li></ol></li><li class="toc-item toc-level-4"><a class="toc-link" href="#2-2-4-4-动态生成类"><span class="toc-text">2.2.4.4 动态生成类</span></a><ol class="toc-child"><li class="toc-item toc-level-5"><a class="toc-link" href="#2-2-4-4-1-模版信息"><span class="toc-text">2.2.4.4.1 模版信息</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#2-2-4-4-2-举个栗子"><span class="toc-text">2.2.4.4.2 举个栗子</span></a><ol class="toc-child"><li class="toc-item toc-level-6"><a class="toc-link" href="#2-2-4-4-2-1-实例代码"><span class="toc-text">2.2.4.4.2.1 实例代码</span></a></li><li class="toc-item toc-level-6"><a class="toc-link" href="#2-2-4-4-2-2-动态代码"><span class="toc-text">2.2.4.4.2.2 动态代码</span></a></li></ol></li></ol></li></ol></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#2-3-utils"><span class="toc-text">2.3 utils</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#2-3-1-Logger"><span class="toc-text">2.3.1 Logger</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#2-3-2-TypeUtils"><span class="toc-text">2.3.2 TypeUtils</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#2-3-3-Consts"><span class="toc-text">2.3.3 Consts</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#2-3-3-1-Log-打印相关"><span class="toc-text">2.3.3.1 Log 打印相关</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#2-3-3-2-Gradle-配置相关"><span class="toc-text">2.3.3.2 Gradle 配置相关</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#2-3-3-3-系统核心类"><span class="toc-text">2.3.3.3 系统核心类</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#2-3-3-4-注解类型"><span class="toc-text">2.3.3.4 注解类型</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#2-3-3-5-核心接口和类"><span class="toc-text">2.3.3.5 核心接口和类</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#2-3-3-6-动态生成类"><span class="toc-text">2.3.3.6 动态生成类</span></a></li></ol></li></ol></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#3-总结"><span class="toc-text">3 总结</span></a></li></ol></div></div><div class="author-info hide"><div class="author-info__avatar text-center"><img src="/img/avatar.png"></div><div class="author-info__name text-center">Coolqi.Li</div><div class="author-info__description text-center">“Hi，我是李帅奇，Android 开发工程师，TeamLeader，熬夜星人，一个努力赚钱，积极向上的好人。”</div><div class="follow-button"><a href="https://github.com/single-li">Follow Me</a></div><hr><div class="author-info-articles"><a class="author-info-articles__archives article-meta" href="/archives"><span class="pull-left">文章</span><span class="pull-right">86</span></a><a class="author-info-articles__tags article-meta" href="/tags"><span class="pull-left">标签</span><span class="pull-right">21</span></a><a class="author-info-articles__categories article-meta" href="/categories"><span class="pull-left">分类</span><span class="pull-right">26</span></a></div><hr><div class="author-info-links"><div class="author-info-links__title text-center">Links</div><a class="author-info-links__name text-center" href="https://developer.android.google.cn/">AndroidDeveloper</a><a class="author-info-links__name text-center" href="http://www.android-studio.org/">AndroidStudio</a><a class="author-info-links__name text-center" href="https://www.jianshu.com/u/123a20a96441">简书</a><a class="author-info-links__name text-center" href="https://weibo.com/coolqiLi">微博</a></div></div></div><div id="content-outer"><div id="top-container" style="background-image: url(https://ws1.sinaimg.cn/large/8700af19ly1fvpabr30o6j22yo1o0q7i.jpg)"><div id="page-header"><span class="pull-left"> <a id="site-name" href="/">Coolqi`s Blog</a></span><i class="fa fa-bars toggle-menu pull-right" aria-hidden="true"></i><span class="pull-right menus"><a class="site-page social-icon search"><i class="fa fa-search"></i><span> 搜索</span></a><a class="site-page" href="/">Home</a><a class="site-page" href="/categories">Categories</a><a class="site-page" href="/tags">Tags</a><a class="site-page" href="/archives">Archives</a><a class="site-page" href="/about">About</a></span></div><div id="post-info"><div id="post-title">ARouter 第三篇 - 注解解析 (arouter-compiler)</div><div id="post-meta"><time class="post-meta__date"><i class="fa fa-calendar" aria-hidden="true"></i> 2019-04-19</time><span class="post-meta__separator">|</span><i class="fa fa-inbox post-meta__icon" aria-hidden="true"></i><a class="post-meta__categories" href="/categories/开源库源码分析/">开源库源码分析</a><i class="fa fa-angle-right" aria-hidden="true"></i><i class="fa fa-inbox post-meta__icon" aria-hidden="true"></i><a class="post-meta__categories" href="/categories/开源库源码分析/ARouter/">ARouter</a><div class="post-meta-wordcount"><span>字数总计: </span><span class="word-count">11k</span><span class="post-meta__separator">|</span><span>阅读时长: 54 分钟</span></div></div></div></div><div class="layout" id="content-inner"><article id="post"><div class="article-container" id="post-content"><p>本系列文章主要分析 ARouter 框架的架构和原理。</p>
<blockquote>
<p>这是阿里 ARouter 开源库的地址，大家可以直接访问<br><a href="https://github.com/alibaba/ARouter" target="_blank" rel="noopener">https://github.com/alibaba/ARouter</a></p>
</blockquote>
<p>本篇博文主要分析 arouter-compiler 模块；</p>
<h1 id="1-模块结构"><a href="#1-模块结构" class="headerlink" title="1 模块结构"></a>1 模块结构</h1><p>下面我们来看看  arouter-compiler  的模块结构：</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">|____com</span><br><span class="line">| |____alibaba</span><br><span class="line">| | |____android</span><br><span class="line">| | | |____arouter</span><br><span class="line">| | | | |____compiler</span><br><span class="line">| | | | | |____entity</span><br><span class="line">| | | | | | |____RouteDoc.java</span><br><span class="line">| | | | | |____processor</span><br><span class="line">| | | | | | |____BaseProcessor.java</span><br><span class="line">| | | | | | |____InterceptorProcessor.java</span><br><span class="line">| | | | | | |____AutowiredProcessor.java</span><br><span class="line">| | | | | | |____RouteProcessor.java</span><br><span class="line">| | | | | |____utils</span><br><span class="line">| | | | | | |____TypeUtils.java</span><br><span class="line">| | | | | | |____Consts.java</span><br><span class="line">| | | | | | |____Logger.java</span><br></pre></td></tr></table></figure>
<p>可以看到，一共有三个 pacakge：</p>
<ul>
<li>entity：包含了实体数据类；</li>
<li>processor：包含了所有的注解解释器类；</li>
<li>utils：包含了一些工具类；</li>
</ul>
<p>我们知道，在 Gradle 对 App 执行编译的时候，arouter-compiler 会对相关的注解进行解析，并动态生成所需的类；</p>
<p>arouter-compiler 模块还依赖了两个三方库：</p>
<figure class="highlight groovy"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">implementation <span class="string">'com.google.auto.service:auto-service:1.0-rc3'</span></span><br><span class="line">implementation <span class="string">'com.squareup:javapoet:1.8.0'</span></span><br></pre></td></tr></table></figure>
<p><em>JavaPoet</em> 是 square 推出的开源 java 代码生成框架，提供 Java Api 生成 .java 源文件；</p>
<p>auto-service 是 google 提供的用于自动注册自定义注解处理器的三方库；</p>
<p>关于这两个库的源码，本系列文章不分析，后面单独分析；</p>
<h1 id="2-源码分析"><a href="#2-源码分析" class="headerlink" title="2 源码分析"></a>2 源码分析</h1><p>我们分别分析下三个 package 目录下的 class 的作用！</p>
<h2 id="2-1-entity"><a href="#2-1-entity" class="headerlink" title="2.1 entity"></a>2.1 entity</h2><p>该 package 下面只包含一个实体数据类：RouteDoc。</p>
<h3 id="2-1-1-RouteDoc"><a href="#2-1-1-RouteDoc" class="headerlink" title="2.1.1 RouteDoc"></a>2.1.1 RouteDoc</h3><p>RouteDoc 用于描述路由跳转的信息，用于生成路由表：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">RouteDoc</span> </span>&#123;</span><br><span class="line">    <span class="meta">@JSONField</span>(ordinal = <span class="number">1</span>)</span><br><span class="line">    <span class="keyword">private</span> String group;</span><br><span class="line">    <span class="meta">@JSONField</span>(ordinal = <span class="number">2</span>)</span><br><span class="line">    <span class="keyword">private</span> String path;</span><br><span class="line">    <span class="meta">@JSONField</span>(ordinal = <span class="number">3</span>)</span><br><span class="line">    <span class="keyword">private</span> String description;</span><br><span class="line">    <span class="meta">@JSONField</span>(ordinal = <span class="number">4</span>)</span><br><span class="line">    <span class="keyword">private</span> String prototype;</span><br><span class="line">    <span class="meta">@JSONField</span>(ordinal = <span class="number">5</span>)</span><br><span class="line">    <span class="keyword">private</span> String className;</span><br><span class="line">    <span class="meta">@JSONField</span>(ordinal = <span class="number">6</span>)</span><br><span class="line">    <span class="keyword">private</span> String type;</span><br><span class="line">    <span class="meta">@JSONField</span>(ordinal = <span class="number">7</span>)</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">int</span> mark;</span><br><span class="line">    <span class="meta">@JSONField</span>(ordinal = <span class="number">8</span>)</span><br><span class="line">    <span class="keyword">private</span> List&lt;Param&gt; params;</span><br><span class="line"></span><br><span class="line">    ... ... ...<span class="comment">// 省略掉 get/set 方法；</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="class"><span class="keyword">class</span> <span class="title">Param</span> </span>&#123;</span><br><span class="line">        <span class="meta">@JSONField</span>(ordinal = <span class="number">1</span>)</span><br><span class="line">        <span class="keyword">private</span> String key;</span><br><span class="line">        <span class="meta">@JSONField</span>(ordinal = <span class="number">2</span>)</span><br><span class="line">        <span class="keyword">private</span> String type;</span><br><span class="line">        <span class="meta">@JSONField</span>(ordinal = <span class="number">3</span>)</span><br><span class="line">        <span class="keyword">private</span> String description;</span><br><span class="line">        <span class="meta">@JSONField</span>(ordinal = <span class="number">4</span>)</span><br><span class="line">        <span class="keyword">private</span> <span class="keyword">boolean</span> required;</span><br><span class="line"></span><br><span class="line">        ... ... ...<span class="comment">// 省略掉 get/set 方法；</span></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>当 processor 对注解进行解析的时候，它会把路由跳转相关的信息记录到 RouteDoc 中！</p>
<p>后面我们分析 processor 的时候就可以看到了！ </p>
<h2 id="2-2-processor-注解解析"><a href="#2-2-processor-注解解析" class="headerlink" title="2.2 processor - 注解解析"></a>2.2 processor - 注解解析</h2><p>该 package 下面包含 ARouter 的核心类：processors，根据前面的注解，一共有三个 processor，我们分别来分析！</p>
<p>重点要关注他们是如何“<strong>解析注解，并动态生成代码</strong>的！</p>
<h3 id="2-2-1-BaseProcessor"><a href="#2-2-1-BaseProcessor" class="headerlink" title="2.2.1 BaseProcessor"></a>2.2.1 BaseProcessor</h3><p>BaseProcessor 是其他三个 processor 的基类，定义了一些共有的属性和操作；</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">abstract</span> <span class="class"><span class="keyword">class</span> <span class="title">BaseProcessor</span> <span class="keyword">extends</span> <span class="title">AbstractProcessor</span> </span>&#123;</span><br><span class="line">    Filer mFiler;</span><br><span class="line">    Logger logger;</span><br><span class="line">    Types types;</span><br><span class="line">    Elements elementUtils; <span class="comment">// 元素工具类对象；</span></span><br><span class="line">    TypeUtils typeUtils;</span><br><span class="line">    <span class="comment">//【1】模块的名称 name；</span></span><br><span class="line">    String moduleName = <span class="keyword">null</span>;</span><br><span class="line">    <span class="comment">//【2】是否要生成 route doc；</span></span><br><span class="line">    <span class="keyword">boolean</span> generateDoc;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">synchronized</span> <span class="keyword">void</span> <span class="title">init</span><span class="params">(ProcessingEnvironment processingEnv)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">super</span>.init(processingEnv);</span><br><span class="line"></span><br><span class="line">        mFiler = processingEnv.getFiler();</span><br><span class="line">        types = processingEnv.getTypeUtils();</span><br><span class="line">        elementUtils = processingEnv.getElementUtils();</span><br><span class="line">        <span class="comment">//【*2.3.2】创建 TypeUtils 对象，用于对类型做处理；</span></span><br><span class="line">        typeUtils = <span class="keyword">new</span> TypeUtils(types, elementUtils);</span><br><span class="line">        <span class="comment">//【*2.3.1】创建 Logger 对象，用于打印过程信息；</span></span><br><span class="line">        logger = <span class="keyword">new</span> Logger(processingEnv.getMessager());</span><br><span class="line"></span><br><span class="line">        <span class="comment">//【3】获取 Processor 当前所在 moudle 的 name，判断是否生成路由文档；</span></span><br><span class="line">        <span class="comment">// 常量第一在 Consts 中；</span></span><br><span class="line">        Map&lt;String, String&gt; options = processingEnv.getOptions();</span><br><span class="line">        <span class="keyword">if</span> (MapUtils.isNotEmpty(options)) &#123;</span><br><span class="line">            moduleName = options.get(KEY_MODULE_NAME);</span><br><span class="line">            generateDoc = VALUE_ENABLE.equals(options.get(KEY_GENERATE_DOC_NAME));</span><br><span class="line">        &#125;</span><br><span class="line">        </span><br><span class="line">        <span class="keyword">if</span> (StringUtils.isNotEmpty(moduleName)) &#123; <span class="comment">// 这部分是对 moduleName 进行检查；</span></span><br><span class="line">            moduleName = moduleName.replaceAll(<span class="string">"[^0-9a-zA-Z_]+"</span>, <span class="string">""</span>);</span><br><span class="line">            logger.info(<span class="string">"The user has configuration the module name, it was ["</span> + moduleName + <span class="string">"]"</span>);</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            logger.error(NO_MODULE_NAME_TIPS);</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> RuntimeException(<span class="string">"ARouter::Compiler &gt;&gt;&gt; No module name, for more information, look at gradle log."</span>);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    ... ... ... <span class="comment">// getSupportedSourceVersion /getSupportedOptions</span></span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>上面省略掉了一些非核心方法，我们不关注它们；</p>
<figure class="highlight groovy"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">android &#123;</span><br><span class="line">    defaultConfig &#123;</span><br><span class="line">        ...</span><br><span class="line">        javaCompileOptions &#123;</span><br><span class="line">            <span class="comment">// 这里是核心配置点；</span></span><br><span class="line">            annotationProcessorOptions &#123;</span><br><span class="line">                arguments = [<span class="string">AROUTER_MODULE_NAME:</span> project.getName(), <span class="string">AROUTER_GENERATE_DOC:</span> <span class="string">"enable"</span>]</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>上面的 KEY_MODULE_NAME，KEY_GENERATE_DOC_NAME，对应的我们在 .gradle 中的配置，这些配置最终都会解析并保存到 ProcessingEnvironment 中；</p>
<p><strong>BaseProcessor</strong> 主要作用就是创建 TypeUtils 对象和 Logger 对象，然后获得当前所在 module 的 gradle 配置！</p>
<h3 id="2-2-2-RouteProcessor"><a href="#2-2-2-RouteProcessor" class="headerlink" title="2.2.2  RouteProcessor"></a>2.2.2  RouteProcessor</h3><p>核心解释器，用于处理 @Route 注解：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@AutoService</span>(Processor.class)</span><br><span class="line"><span class="meta">@SupportedAnnotationTypes</span>(&#123;ANNOTATION_TYPE_ROUTE, ANNOTATION_TYPE_AUTOWIRED&#125;)</span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">RouteProcessor</span> <span class="keyword">extends</span> <span class="title">BaseProcessor</span> </span>&#123;</span><br><span class="line">		... ... ...</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>我们从成员变量，初始化，注解处理三个方面来分析：</p>
<h4 id="2-2-2-1-Field"><a href="#2-2-2-1-Field" class="headerlink" title="2.2.2.1 Field"></a>2.2.2.1 Field</h4><p>内部变量；</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// key 是所属的组 group，value 是该组下的所有跳转信息 RouteMeta 对象；</span></span><br><span class="line"><span class="keyword">private</span> Map&lt;String, Set&lt;RouteMeta&gt;&gt; groupMap = <span class="keyword">new</span> HashMap&lt;&gt;();</span><br><span class="line"><span class="keyword">private</span> Map&lt;String, String&gt; rootMap = <span class="keyword">new</span> TreeMap&lt;&gt;();  <span class="comment">// Map of root metas, used for generate class file in order.</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">private</span> TypeMirror iProvider = <span class="keyword">null</span>; <span class="comment">// .IProvider 的类型；</span></span><br><span class="line"><span class="keyword">private</span> Writer docWriter;       <span class="comment">// 用于生成路由文档；</span></span><br></pre></td></tr></table></figure>
<h4 id="2-2-2-2-Init"><a href="#2-2-2-2-Init" class="headerlink" title="2.2.2.2 Init"></a>2.2.2.2 Init</h4><p>初始化 processor：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">synchronized</span> <span class="keyword">void</span> <span class="title">init</span><span class="params">(ProcessingEnvironment processingEnv)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">super</span>.init(processingEnv);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (generateDoc) &#123;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            docWriter = mFiler.createResource(</span><br><span class="line">                    StandardLocation.SOURCE_OUTPUT,</span><br><span class="line">                    PACKAGE_OF_GENERATE_DOCS,</span><br><span class="line">                    <span class="string">"arouter-map-of-"</span> + moduleName + <span class="string">".json"</span></span><br><span class="line">            ).openWriter();</span><br><span class="line">        &#125; <span class="keyword">catch</span> (IOException e) &#123;</span><br><span class="line">            logger.error(<span class="string">"Create doc writer failed, because "</span> + e.getMessage());</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    iProvider = elementUtils.getTypeElement(Consts.IPROVIDER).asType();</span><br><span class="line"></span><br><span class="line">    logger.info(<span class="string">"&gt;&gt;&gt; RouteProcessor init. &lt;&lt;&lt;"</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h4 id="2-2-2-3-Process-处理-Route-注解"><a href="#2-2-2-3-Process-处理-Route-注解" class="headerlink" title="2.2.2.3 Process - 处理 Route 注解"></a>2.2.2.3 Process - 处理 Route 注解</h4><p>核心逻辑：注意，这里的参数 Set&lt;? extends TypeElement&gt; annotations ，表示的是要处理的注解，根据前面的内容：Route 和 AutoWired ！</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">boolean</span> <span class="title">process</span><span class="params">(Set&lt;? extends TypeElement&gt; annotations, RoundEnvironment roundEnv)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">if</span> (CollectionUtils.isNotEmpty(annotations)) &#123;</span><br><span class="line">        <span class="comment">//【1】这里返回了 @Route 处理的元素；</span></span><br><span class="line">        Set&lt;? extends Element&gt; routeElements = roundEnv.getElementsAnnotatedWith(Route.class);</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            logger.info(<span class="string">"&gt;&gt;&gt; Found routes, start... &lt;&lt;&lt;"</span>);</span><br><span class="line">            <span class="comment">//【*2.2.2.3.1】开始处理注解修饰的元素；</span></span><br><span class="line">            <span class="keyword">this</span>.parseRoutes(routeElements);</span><br><span class="line"></span><br><span class="line">        &#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">            logger.error(e);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">true</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">false</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>我们看到，这里调用了 parseRoutes 方法：</p>
<h5 id="2-2-2-3-1-parseRoutes"><a href="#2-2-2-3-1-parseRoutes" class="headerlink" title="2.2.2.3.1 parseRoutes"></a>2.2.2.3.1 parseRoutes</h5><p>核心的核心：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br><span class="line">212</span><br><span class="line">213</span><br><span class="line">214</span><br><span class="line">215</span><br><span class="line">216</span><br><span class="line">217</span><br><span class="line">218</span><br><span class="line">219</span><br><span class="line">220</span><br><span class="line">221</span><br><span class="line">222</span><br><span class="line">223</span><br><span class="line">224</span><br><span class="line">225</span><br><span class="line">226</span><br><span class="line">227</span><br><span class="line">228</span><br><span class="line">229</span><br><span class="line">230</span><br><span class="line">231</span><br><span class="line">232</span><br><span class="line">233</span><br><span class="line">234</span><br><span class="line">235</span><br><span class="line">236</span><br><span class="line">237</span><br><span class="line">238</span><br><span class="line">239</span><br><span class="line">240</span><br><span class="line">241</span><br><span class="line">242</span><br><span class="line">243</span><br><span class="line">244</span><br><span class="line">245</span><br><span class="line">246</span><br><span class="line">247</span><br><span class="line">248</span><br><span class="line">249</span><br><span class="line">250</span><br><span class="line">251</span><br><span class="line">252</span><br><span class="line">253</span><br><span class="line">254</span><br><span class="line">255</span><br><span class="line">256</span><br><span class="line">257</span><br><span class="line">258</span><br><span class="line">259</span><br><span class="line">260</span><br><span class="line">261</span><br><span class="line">262</span><br><span class="line">263</span><br><span class="line">264</span><br><span class="line">265</span><br><span class="line">266</span><br><span class="line">267</span><br><span class="line">268</span><br><span class="line">269</span><br><span class="line">270</span><br><span class="line">271</span><br><span class="line">272</span><br><span class="line">273</span><br><span class="line">274</span><br><span class="line">275</span><br><span class="line">276</span><br><span class="line">277</span><br><span class="line">278</span><br><span class="line">279</span><br><span class="line">280</span><br><span class="line">281</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">parseRoutes</span><span class="params">(Set&lt;? extends Element&gt; routeElements)</span> <span class="keyword">throws</span> IOException </span>&#123;</span><br><span class="line">    <span class="keyword">if</span> (CollectionUtils.isNotEmpty(routeElements)) &#123;</span><br><span class="line">        logger.info(<span class="string">"&gt;&gt;&gt; Found routes, size is "</span> + routeElements.size() + <span class="string">" &lt;&lt;&lt;"</span>);</span><br><span class="line"></span><br><span class="line">        rootMap.clear();</span><br><span class="line">        <span class="comment">//【1】保存 activity，service，fragment 的元素类型；</span></span><br><span class="line">        TypeMirror type_Activity = elementUtils.getTypeElement(ACTIVITY).asType();</span><br><span class="line">        TypeMirror type_Service = elementUtils.getTypeElement(SERVICE).asType();</span><br><span class="line">        TypeMirror fragmentTm = elementUtils.getTypeElement(FRAGMENT).asType();</span><br><span class="line">        TypeMirror fragmentTmV4 = elementUtils.getTypeElement(Consts.FRAGMENT_V4).asType();</span><br><span class="line"></span><br><span class="line">        <span class="comment">//【2】获得 .IProvider/.IProviderGroup 对应的 TypeElement 对象；</span></span><br><span class="line">        TypeElement type_IRouteGroup = elementUtils.getTypeElement(IROUTE_GROUP);</span><br><span class="line">        TypeElement type_IProviderGroup = elementUtils.getTypeElement(IPROVIDER_GROUP);</span><br><span class="line">      	<span class="comment">//【3】获得 RouteMeta 和 RouteType 的类全限定名；</span></span><br><span class="line">        ClassName routeMetaCn = ClassName.get(RouteMeta.class);</span><br><span class="line">        ClassName routeTypeCn = ClassName.get(RouteType.class);</span><br><span class="line"></span><br><span class="line">        <span class="comment">//【4】准备动态生成 java 代码：</span></span><br><span class="line">        <span class="comment">//【4.1】生成方法参数类型：</span></span><br><span class="line">        <span class="comment">// Map&lt;String, Class&lt;? extends IRouteGroup&gt;&gt;</span></span><br><span class="line">        ParameterizedTypeName inputMapTypeOfRoot = ParameterizedTypeName.get(</span><br><span class="line">                ClassName.get(Map.class),</span><br><span class="line">                ClassName.get(String.class),</span><br><span class="line">                ParameterizedTypeName.get(</span><br><span class="line">                        ClassName.get(Class.class),</span><br><span class="line">                        WildcardTypeName.subtypeOf(ClassName.get(type_IRouteGroup))</span><br><span class="line">                )</span><br><span class="line">        );</span><br><span class="line"></span><br><span class="line">        <span class="comment">//【4.2】生成方法参数类型：Map&lt;String, RouteMeta&gt;</span></span><br><span class="line">        ParameterizedTypeName inputMapTypeOfGroup = ParameterizedTypeName.get(</span><br><span class="line">                ClassName.get(Map.class),</span><br><span class="line">                ClassName.get(String.class),</span><br><span class="line">                ClassName.get(RouteMeta.class)</span><br><span class="line">        );</span><br><span class="line"></span><br><span class="line">        <span class="comment">//【4.4】生成方法参数：</span></span><br><span class="line">        <span class="comment">// Map&lt;String, Class&lt;? extends IRouteGroup&gt;&gt; routes</span></span><br><span class="line">        <span class="comment">// Map&lt;String, RouteMeta&gt; atlas</span></span><br><span class="line">        <span class="comment">// Map&lt;String, RouteMeta&gt; providers</span></span><br><span class="line">        ParameterSpec rootParamSpec = ParameterSpec.builder(inputMapTypeOfRoot, <span class="string">"routes"</span>).build();</span><br><span class="line">        ParameterSpec groupParamSpec = ParameterSpec.builder(inputMapTypeOfGroup, <span class="string">"atlas"</span>).build();</span><br><span class="line">        ParameterSpec providerParamSpec = ParameterSpec.builder(inputMapTypeOfGroup, <span class="string">"providers"</span>).build(); </span><br><span class="line"></span><br><span class="line">        <span class="comment">//【4.5】生成方法签名：</span></span><br><span class="line">        <span class="comment">// @Override</span></span><br><span class="line">        <span class="comment">// public void loadInto(Map&lt;String, Class&lt;? extends IRouteGroup&gt;&gt; routes) </span></span><br><span class="line">        MethodSpec.Builder loadIntoMethodOfRootBuilder = MethodSpec.methodBuilder(METHOD_LOAD_INTO)</span><br><span class="line">                .addAnnotation(Override.class)</span><br><span class="line">                .addModifiers(PUBLIC)</span><br><span class="line">                .addParameter(rootParamSpec);</span><br><span class="line"></span><br><span class="line">        <span class="comment">//【5】处理 @Route 注解修饰的元素</span></span><br><span class="line">        <span class="keyword">for</span> (Element element : routeElements) &#123;</span><br><span class="line">            TypeMirror tm = element.asType(); <span class="comment">// 获得 Route 注解的元素的类型信息；</span></span><br><span class="line">            Route route = element.getAnnotation(Route.class); <span class="comment">// 获得 Route 注解对象；</span></span><br><span class="line">            RouteMeta routeMeta; <span class="comment">// 用于封装跳转信息；</span></span><br><span class="line"></span><br><span class="line">            <span class="keyword">if</span> (types.isSubtype(tm, type_Activity)) &#123;</span><br><span class="line">                <span class="comment">//【5.1】注解的元素是 activity 的子类；</span></span><br><span class="line">                logger.info(<span class="string">"&gt;&gt;&gt; Found activity route: "</span> + tm.toString() + <span class="string">" &lt;&lt;&lt;"</span>);</span><br><span class="line"></span><br><span class="line">                Map&lt;String, Integer&gt; paramsType = <span class="keyword">new</span> HashMap&lt;&gt;(); <span class="comment">// 保存 fieldName/Autowired.name --&gt; 类型枚举序号；</span></span><br><span class="line">                Map&lt;String, Autowired&gt; injectConfig = <span class="keyword">new</span> HashMap&lt;&gt;(); <span class="comment">// 保存 fieldName/Autowired.name --&gt; Autowired 实例</span></span><br><span class="line">              </span><br><span class="line">                <span class="keyword">for</span> (Element field : element.getEnclosedElements()) &#123;</span><br><span class="line">                    <span class="comment">//【5.1.1】返回该元素直接包含的子元素（成员属性），处理内部哪些被 @Autowired 注解的成员属性（避开 IProvider 子类）；</span></span><br><span class="line">                    <span class="keyword">if</span> (field.getKind().isField() &amp;&amp; field.getAnnotation(Autowired.class) != <span class="keyword">null</span> &amp;&amp; !types.isSubtype(field.asType(), iProvider)) &#123;</span><br><span class="line">                        <span class="comment">// 必须是被 @Autowired 注解的属性，但是不能是 IProvider</span></span><br><span class="line">                        Autowired paramConfig = field.getAnnotation(Autowired.class);</span><br><span class="line">                        <span class="comment">//【5.1.1.1】根据是否设置 Autowired.name 对属性进行 byName 或者 byType 处理；</span></span><br><span class="line">                        String injectName = StringUtils.isEmpty(paramConfig.name()) ? field.getSimpleName().toString() : paramConfig.name();</span><br><span class="line">                        <span class="comment">//【5.1.1.2】加入到集合；</span></span><br><span class="line">                        paramsType.put(injectName, typeUtils.typeExchange(field));</span><br><span class="line">                        injectConfig.put(injectName, paramConfig);</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;</span><br><span class="line">                <span class="comment">//【5.1.2】创建跳转对象；</span></span><br><span class="line">                routeMeta = <span class="keyword">new</span> RouteMeta(route, element, RouteType.ACTIVITY, paramsType);</span><br><span class="line">                routeMeta.setInjectConfig(injectConfig);</span><br><span class="line">              </span><br><span class="line">            &#125; <span class="keyword">else</span> <span class="keyword">if</span> (types.isSubtype(tm, iProvider)) &#123;</span><br><span class="line">                <span class="comment">//【5.2】注解的元素实现了 IProvider 接口，创建跳转对象</span></span><br><span class="line">                logger.info(<span class="string">"&gt;&gt;&gt; Found provider route: "</span> + tm.toString() + <span class="string">" &lt;&lt;&lt;"</span>);</span><br><span class="line">                routeMeta = <span class="keyword">new</span> RouteMeta(route, element, RouteType.PROVIDER, <span class="keyword">null</span>);</span><br><span class="line">              </span><br><span class="line">            &#125; <span class="keyword">else</span> <span class="keyword">if</span> (types.isSubtype(tm, type_Service)) &#123;</span><br><span class="line">                <span class="comment">//【5.3】注解的元素是 service 的子类，创建跳转对象</span></span><br><span class="line">                logger.info(<span class="string">"&gt;&gt;&gt; Found service route: "</span> + tm.toString() + <span class="string">" &lt;&lt;&lt;"</span>);</span><br><span class="line">                routeMeta = <span class="keyword">new</span> RouteMeta(route, element, RouteType.parse(SERVICE), <span class="keyword">null</span>);</span><br><span class="line">              </span><br><span class="line">            &#125; <span class="keyword">else</span> <span class="keyword">if</span> (types.isSubtype(tm, fragmentTm) || types.isSubtype(tm, fragmentTmV4)) </span><br><span class="line">                <span class="comment">//【5.4】注解的元素是 fragment 的子类，，创建跳转对象</span></span><br><span class="line">                logger.info(<span class="string">"&gt;&gt;&gt; Found fragment route: "</span> + tm.toString() + <span class="string">" &lt;&lt;&lt;"</span>);</span><br><span class="line">                routeMeta = <span class="keyword">new</span> RouteMeta(route, element, RouteType.parse(FRAGMENT), <span class="keyword">null</span>);</span><br><span class="line">              </span><br><span class="line">            &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                <span class="keyword">throw</span> <span class="keyword">new</span> RuntimeException(<span class="string">"ARouter::Compiler &gt;&gt;&gt; Found unsupported class type, type = ["</span> + types.toString() + <span class="string">"]."</span>);</span><br><span class="line">            &#125;</span><br><span class="line">            </span><br><span class="line">            <span class="comment">//【*2.2.2.3.1.1】对跳转对象进行分类；</span></span><br><span class="line">            categories(routeMeta);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment">//【4.6】生成方法签名：</span></span><br><span class="line">        <span class="comment">// @Override</span></span><br><span class="line">        <span class="comment">// public void loadInto(Map&lt;String, RouteMeta&gt; providers) </span></span><br><span class="line">        MethodSpec.Builder loadIntoMethodOfProviderBuilder = MethodSpec.methodBuilder(METHOD_LOAD_INTO)</span><br><span class="line">                .addAnnotation(Override.class)</span><br><span class="line">                .addModifiers(PUBLIC)</span><br><span class="line">                .addParameter(providerParamSpec);</span><br><span class="line"></span><br><span class="line">        Map&lt;String, List&lt;RouteDoc&gt;&gt; docSource = <span class="keyword">new</span> HashMap&lt;&gt;(); <span class="comment">// key：组名；value：每个组内的路由跳转文档；</span></span><br><span class="line"></span><br><span class="line">        <span class="comment">//【5】按照分组的方式，遍历 RouteMeta；</span></span><br><span class="line">        <span class="keyword">for</span> (Map.Entry&lt;String, Set&lt;RouteMeta&gt;&gt; entry : groupMap.entrySet()) &#123;</span><br><span class="line">            String groupName = entry.getKey();</span><br><span class="line"></span><br><span class="line">            <span class="comment">//【5.1】生成方法签名：</span></span><br><span class="line">            <span class="comment">// @Override</span></span><br><span class="line">            <span class="comment">// public void loadInto(Map&lt;String, RouteMeta&gt; atlas) </span></span><br><span class="line">            MethodSpec.Builder loadIntoMethodOfGroupBuilder = MethodSpec.methodBuilder(METHOD_LOAD_INTO)</span><br><span class="line">                    .addAnnotation(Override.class)</span><br><span class="line">                    .addModifiers(PUBLIC)</span><br><span class="line">                    .addParameter(groupParamSpec);</span><br><span class="line"></span><br><span class="line">            List&lt;RouteDoc&gt; routeDocList = <span class="keyword">new</span> ArrayList&lt;&gt;(); <span class="comment">// 用于保存路由跳转信息；</span></span><br><span class="line"></span><br><span class="line">            <span class="comment">//【5.2】获得属于该 group 下的所有 RouteMeta，并依次处理；</span></span><br><span class="line">            Set&lt;RouteMeta&gt; groupData = entry.getValue();</span><br><span class="line">            <span class="keyword">for</span> (RouteMeta routeMeta : groupData) &#123;</span><br><span class="line">                <span class="comment">//【*2.2.2.3.1.2】根据跳转信息，生成文档对象；</span></span><br><span class="line">                RouteDoc routeDoc = extractDocInfo(routeMeta);</span><br><span class="line"></span><br><span class="line">                ClassName className = ClassName.get((TypeElement) routeMeta.getRawType()); <span class="comment">// 目标类的全限定名</span></span><br><span class="line"></span><br><span class="line">                <span class="keyword">switch</span> (routeMeta.getType()) &#123; <span class="comment">//【5.2.1】针对跳转类型为 PROVIDER 的情况，这里会将其父类的信息缓存下来；</span></span><br><span class="line">                    <span class="keyword">case</span> PROVIDER:</span><br><span class="line">                        <span class="comment">// 返回直接由此类实现或直接由此接口扩展的接口类型（目标类的负类）</span></span><br><span class="line">                        List&lt;? extends TypeMirror&gt; interfaces = ((TypeElement) routeMeta.getRawType()).getInterfaces();</span><br><span class="line">                        <span class="keyword">for</span> (TypeMirror tm : interfaces) &#123;</span><br><span class="line">                            routeDoc.addPrototype(tm.toString());</span><br><span class="line"></span><br><span class="line">                            <span class="keyword">if</span> (types.isSameType(tm, iProvider)) &#123; <span class="comment">// 如果是 .IProvider 类型，说明目标类是直接实现的 .IProvider 接口； </span></span><br><span class="line">                                <span class="comment">//【5.2.2】生成方法体：</span></span><br><span class="line">                                <span class="comment">// providers.put("目标类的全限定名", RouteMeta.build(RouteType.PROVIDER, 目标类的类名.class, </span></span><br><span class="line">                                <span class="comment">//           $&#123;routeMeta.getPath()&#125;, $&#123;routeMeta.getGroup()&#125;, null, $&#123;routeMeta.getPriority()&#125;, $&#123;routeMeta.getExtra()&#125;));</span></span><br><span class="line">                                loadIntoMethodOfProviderBuilder.addStatement(</span><br><span class="line">                                        <span class="string">"providers.put($S, $T.build($T."</span> + routeMeta.getType() + <span class="string">", $T.class, $S, $S, null, "</span> + routeMeta.getPriority() </span><br><span class="line">                                                                         + <span class="string">", "</span> + routeMeta.getExtra() + <span class="string">"))"</span>,</span><br><span class="line">                                        (routeMeta.getRawType()).toString(), <span class="comment">// routeMeta.getRawType() 返回的是 element;</span></span><br><span class="line">                                        routeMetaCn,  <span class="comment">// RouteMeta</span></span><br><span class="line">                                        routeTypeCn,  <span class="comment">// RouteType</span></span><br><span class="line">                                        className,    <span class="comment">// 类名；</span></span><br><span class="line">                                        routeMeta.getPath(),  <span class="comment">// Route 的 path 属性；</span></span><br><span class="line">                                        routeMeta.getGroup()); <span class="comment">// group 属性；</span></span><br><span class="line">                              </span><br><span class="line">                            &#125; <span class="keyword">else</span> <span class="keyword">if</span> (types.isSubtype(tm, iProvider)) &#123; <span class="comment">// 如果是 .IProvider 的字类型，说明目标类是继承了一个实现 .IProvider 的类；</span></span><br><span class="line">                                <span class="comment">//【5.2.3】生成方法体：</span></span><br><span class="line">                                <span class="comment">// providers.put("直接父类的全限定名", RouteMeta.build(RouteType.PROVIDER, 目标类的类名.class, </span></span><br><span class="line">                                <span class="comment">//            $&#123;routeMeta.getPath()&#125;, $&#123;routeMeta.getGroup()&#125;, null, $&#123;routeMeta.getPriority()&#125;, $&#123;routeMeta.getExtra()&#125;));</span></span><br><span class="line">                                loadIntoMethodOfProviderBuilder.addStatement(</span><br><span class="line">                                        <span class="string">"providers.put($S, $T.build($T."</span> + routeMeta.getType() + <span class="string">", $T.class, $S, $S, null, "</span> + routeMeta.getPriority() </span><br><span class="line">                                  																			 + <span class="string">", "</span> + routeMeta.getExtra() + <span class="string">"))"</span>,</span><br><span class="line">                                        tm.toString(),</span><br><span class="line">                                        routeMetaCn,</span><br><span class="line">                                        routeTypeCn,</span><br><span class="line">                                        className,</span><br><span class="line">                                        routeMeta.getPath(),</span><br><span class="line">                                        routeMeta.getGroup());</span><br><span class="line">                            &#125;</span><br><span class="line">                        &#125;</span><br><span class="line">                        <span class="keyword">break</span>;</span><br><span class="line">                    <span class="keyword">default</span>:</span><br><span class="line">                        <span class="keyword">break</span>;</span><br><span class="line">                &#125;</span><br><span class="line"></span><br><span class="line">                <span class="comment">//【5.3】用于继续生成 route doc, 和 Autowired 注解的参数 hashmap</span></span><br><span class="line">                StringBuilder mapBodyBuilder = <span class="keyword">new</span> StringBuilder();</span><br><span class="line">                Map&lt;String, Integer&gt; paramsType = routeMeta.getParamsType();</span><br><span class="line">                Map&lt;String, Autowired&gt; injectConfigs = routeMeta.getInjectConfig();</span><br><span class="line">                <span class="keyword">if</span> (MapUtils.isNotEmpty(paramsType)) &#123;</span><br><span class="line">                    List&lt;RouteDoc.Param&gt; paramList = <span class="keyword">new</span> ArrayList&lt;&gt;();</span><br><span class="line"></span><br><span class="line">                    <span class="keyword">for</span> (Map.Entry&lt;String, Integer&gt; types : paramsType.entrySet()) &#123;</span><br><span class="line">                        <span class="comment">// 创建 Autowired 注解的参数 hashmap；</span></span><br><span class="line">                        mapBodyBuilder.append(<span class="string">"put(\""</span>).append(types.getKey()).append(<span class="string">"\", "</span>).append(types.getValue()).append(<span class="string">"); "</span>);</span><br><span class="line"></span><br><span class="line">                        RouteDoc.Param param = <span class="keyword">new</span> RouteDoc.Param();</span><br><span class="line">                        Autowired injectConfig = injectConfigs.get(types.getKey());</span><br><span class="line">                        param.setKey(types.getKey());</span><br><span class="line">                        param.setType(TypeKind.values()[types.getValue()].name().toLowerCase());</span><br><span class="line">                        param.setDescription(injectConfig.desc());</span><br><span class="line">                        param.setRequired(injectConfig.required());</span><br><span class="line"></span><br><span class="line">                        paramList.add(param);</span><br><span class="line">                    &#125;</span><br><span class="line">                    <span class="comment">// 将 @AutoWeird 修饰的变量信息保存到 routeDoc 中；</span></span><br><span class="line">                    routeDoc.setParams(paramList);</span><br><span class="line">                &#125;</span><br><span class="line">                String mapBody = mapBodyBuilder.toString();</span><br><span class="line"></span><br><span class="line">                <span class="comment">//【5.4】生成方法体：：</span></span><br><span class="line">                <span class="comment">// atlas.put($&#123;path&#125;, RouteMeta.build(RouteType.XXXX, $&#123;className&#125;.class, </span></span><br><span class="line">                <span class="comment">//           $&#123;path&#125;, $&#123;group&#125;, new java.util.HashMap&lt;String, Integer&gt;()&#123;&#123;put($&#123;fieldName&#125;/$&#123;AutoWired.Name&#125;, $&#123;TypeKind&#125;);&#125;&#125;, $&#123;priority&#125;, $&#123;extra&#125;));</span></span><br><span class="line">                loadIntoMethodOfGroupBuilder.addStatement(</span><br><span class="line">                        <span class="string">"atlas.put($S, $T.build($T."</span> + routeMeta.getType() + <span class="string">", $T.class, $S, $S, "</span> </span><br><span class="line">                  						+ (StringUtils.isEmpty(mapBody) ? <span class="keyword">null</span> : (<span class="string">"new java.util.HashMap&lt;String, Integer&gt;()&#123;&#123;"</span> + mapBodyBuilder.toString()</span><br><span class="line">                              + <span class="string">"&#125;&#125;"</span>)) + <span class="string">", "</span> + routeMeta.getPriority() + <span class="string">", "</span> + routeMeta.getExtra() + <span class="string">"))"</span>,</span><br><span class="line">                        routeMeta.getPath(),</span><br><span class="line">                        routeMetaCn,</span><br><span class="line">                        routeTypeCn,</span><br><span class="line">                        className,</span><br><span class="line">                        routeMeta.getPath().toLowerCase(),</span><br><span class="line">                        routeMeta.getGroup().toLowerCase());</span><br><span class="line"></span><br><span class="line">                routeDoc.setClassName(className.toString()); <span class="comment">// 将 className 保存到 routeDoc 中；</span></span><br><span class="line">                routeDocList.add(routeDoc); <span class="comment">// 将这个路由表加入到 routeDocList 中；</span></span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            <span class="comment">//【5.5】动态生成 java 文件：</span></span><br><span class="line">            String groupFileName = NAME_OF_GROUP + groupName;</span><br><span class="line">            JavaFile.builder(PACKAGE_OF_GENERATE_FILE,   <span class="comment">// 包名；com.alibaba.android.arouter.routes</span></span><br><span class="line">                    TypeSpec.classBuilder(groupFileName) <span class="comment">// 类名 ARouter$$Group$$ + $&#123;groupName&#125;</span></span><br><span class="line">                            .addJavadoc(WARNING_TIPS)</span><br><span class="line">                            .addSuperinterface(ClassName.get(type_IRouteGroup)) <span class="comment">// 实现 .IRouteGroup 接口；</span></span><br><span class="line">                            .addModifiers(PUBLIC)</span><br><span class="line">                            .addMethod(loadIntoMethodOfGroupBuilder.build())</span><br><span class="line">                            .build()</span><br><span class="line">            ).build().writeTo(mFiler);</span><br><span class="line"></span><br><span class="line">            logger.info(<span class="string">"&gt;&gt;&gt; Generated group: "</span> + groupName + <span class="string">"&lt;&lt;&lt;"</span>);</span><br><span class="line">            <span class="comment">//【5.6】将 key：groupName ---&gt; value：ARouter$$Group$$ + $&#123;groupName&#125; 保存到 rootMap 表中；</span></span><br><span class="line">            rootMap.put(groupName, groupFileName);</span><br><span class="line">            docSource.put(groupName, routeDocList); <span class="comment">// 将当前组的所有路由表保存到 docSource 中；</span></span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (MapUtils.isNotEmpty(rootMap)) &#123;</span><br><span class="line">            <span class="comment">//【6】生成方法体：：</span></span><br><span class="line">           	<span class="comment">// routes.put("app", ARouter$$Group$$$&#123;$groupName&#125;.class);</span></span><br><span class="line">            <span class="keyword">for</span> (Map.Entry&lt;String, String&gt; entry : rootMap.entrySet()) &#123;</span><br><span class="line">                loadIntoMethodOfRootBuilder.addStatement(<span class="string">"routes.put($S, $T.class)"</span>, </span><br><span class="line">                                                         entry.getKey(), ClassName.get(PACKAGE_OF_GENERATE_FILE, entry.getValue())); <span class="comment">// 当然，这里是全限定名；</span></span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment">//【7】如果 gradle 设置了生成路由表，那就将 docSource 以 json 的形式输出；</span></span><br><span class="line">        <span class="keyword">if</span> (generateDoc) &#123;</span><br><span class="line">            docWriter.append(JSON.toJSONString(docSource, SerializerFeature.PrettyFormat));</span><br><span class="line">            docWriter.flush();</span><br><span class="line">            docWriter.close();</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment">//【8】动态生成 java 文件：</span></span><br><span class="line">        String providerMapFileName = NAME_OF_PROVIDER + SEPARATOR + moduleName;</span><br><span class="line">        JavaFile.builder(PACKAGE_OF_GENERATE_FILE, <span class="comment">// 包名；com.alibaba.android.arouter.routes</span></span><br><span class="line">                TypeSpec.classBuilder(providerMapFileName) <span class="comment">// 类名：ARouter$$Providers$$ + $&#123;moduleName&#125;</span></span><br><span class="line">                        .addJavadoc(WARNING_TIPS)</span><br><span class="line">                        .addSuperinterface(ClassName.get(type_IProviderGroup)) <span class="comment">// 实现 .IProviderGroup 接口；</span></span><br><span class="line">                        .addModifiers(PUBLIC)</span><br><span class="line">                        .addMethod(loadIntoMethodOfProviderBuilder.build())</span><br><span class="line">                        .build()</span><br><span class="line">        ).build().writeTo(mFiler);</span><br><span class="line"></span><br><span class="line">        logger.info(<span class="string">"&gt;&gt;&gt; Generated provider map, name is "</span> + providerMapFileName + <span class="string">" &lt;&lt;&lt;"</span>);</span><br><span class="line"></span><br><span class="line">        <span class="comment">//【9】动态生成 java 文件：</span></span><br><span class="line">        String rootFileName = NAME_OF_ROOT + SEPARATOR + moduleName;</span><br><span class="line">        JavaFile.builder(PACKAGE_OF_GENERATE_FILE,  <span class="comment">// 包名；com.alibaba.android.arouter.routes</span></span><br><span class="line">                TypeSpec.classBuilder(rootFileName) <span class="comment">// 包名；ARouter$$Root$$ + $&#123;moduleName&#125;</span></span><br><span class="line">                        .addJavadoc(WARNING_TIPS)</span><br><span class="line">                        .addSuperinterface(ClassName.get(elementUtils.getTypeElement(ITROUTE_ROOT))) <span class="comment">// 实现 .IRouteRoot 接口；</span></span><br><span class="line">                        .addModifiers(PUBLIC)</span><br><span class="line">                        .addMethod(loadIntoMethodOfRootBuilder.build())</span><br><span class="line">                        .build()</span><br><span class="line">        ).build().writeTo(mFiler);</span><br><span class="line"></span><br><span class="line">        logger.info(<span class="string">"&gt;&gt;&gt; Generated root, name is "</span> + rootFileName + <span class="string">" &lt;&lt;&lt;"</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>整个流程还是很简单清晰的，主要是代码生成过程用很多的占位符，为我们看源码产生了很多的阻碍；</p>
<ul>
<li>RouteProcessor 不仅会解析 @Route，还会解析 @AutoWired；</li>
<li>最终会生成三个 java 文件，具体的模版信息：</li>
</ul>
<h6 id="2-2-2-3-1-1-categories"><a href="#2-2-2-3-1-1-categories" class="headerlink" title="2.2.2.3.1.1 categories"></a>2.2.2.3.1.1 categories</h6><p>对跳转信息进行分类；</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">categories</span><span class="params">(RouteMeta routeMete)</span> </span>&#123;</span><br><span class="line">    <span class="comment">//【*2.2.2.3.1.2】校验路由跳转信息！</span></span><br><span class="line">    <span class="keyword">if</span> (routeVerify(routeMete)) &#123;</span><br><span class="line">        logger.info(<span class="string">"&gt;&gt;&gt; Start categories, group = "</span> + routeMete.getGroup() + <span class="string">", path = "</span> + routeMete.getPath() + <span class="string">" &lt;&lt;&lt;"</span>);</span><br><span class="line">        <span class="comment">//【1】将校验通过的跳转 RouteMeta 加入到 groupMap 中；</span></span><br><span class="line">        Set&lt;RouteMeta&gt; routeMetas = groupMap.get(routeMete.getGroup());</span><br><span class="line">        <span class="keyword">if</span> (CollectionUtils.isEmpty(routeMetas)) &#123;</span><br><span class="line">            <span class="comment">//【2】如果是第一次添加，需要创建一个 Set&lt;RouteMeta&gt;，内部元素以 path 排序；</span></span><br><span class="line">            Set&lt;RouteMeta&gt; routeMetaSet = <span class="keyword">new</span> TreeSet&lt;&gt;(<span class="keyword">new</span> Comparator&lt;RouteMeta&gt;() &#123;</span><br><span class="line">                <span class="meta">@Override</span></span><br><span class="line">                <span class="function"><span class="keyword">public</span> <span class="keyword">int</span> <span class="title">compare</span><span class="params">(RouteMeta r1, RouteMeta r2)</span> </span>&#123;</span><br><span class="line">                    <span class="keyword">try</span> &#123;</span><br><span class="line">                        <span class="keyword">return</span> r1.getPath().compareTo(r2.getPath());</span><br><span class="line">                    &#125; <span class="keyword">catch</span> (NullPointerException npe) &#123;</span><br><span class="line">                        logger.error(npe.getMessage());</span><br><span class="line">                        <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;);</span><br><span class="line">            <span class="comment">//【3】加入到集合中；</span></span><br><span class="line">            routeMetaSet.add(routeMete);</span><br><span class="line">            groupMap.put(routeMete.getGroup(), routeMetaSet);</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            <span class="comment">//【4】已经创建了 set，直接加入；</span></span><br><span class="line">            routeMetas.add(routeMete);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        logger.warning(<span class="string">"&gt;&gt;&gt; Route meta verify error, group is "</span> + routeMete.getGroup() + <span class="string">" &lt;&lt;&lt;"</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>end～</p>
<h6 id="2-2-2-3-1-2-routeVerify"><a href="#2-2-2-3-1-2-routeVerify" class="headerlink" title="2.2.2.3.1.2 routeVerify"></a>2.2.2.3.1.2 routeVerify</h6><p>校验路由跳转信息；</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">boolean</span> <span class="title">routeVerify</span><span class="params">(RouteMeta meta)</span> </span>&#123;</span><br><span class="line">    String path = meta.getPath();</span><br><span class="line">    <span class="comment">//【1】path 必须要指定，并且以 "/" 开头；</span></span><br><span class="line">    <span class="keyword">if</span> (StringUtils.isEmpty(path) || !path.startsWith(<span class="string">"/"</span>)) &#123;   <span class="comment">// The path must be start with '/' and not empty!</span></span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">false</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">//【2】如果 Route 没有指定 group 属性，那么就以 path 的一级目录为</span></span><br><span class="line">    <span class="keyword">if</span> (StringUtils.isEmpty(meta.getGroup())) &#123; <span class="comment">// Use default group(the first word in path)</span></span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            String defaultGroup = path.substring(<span class="number">1</span>, path.indexOf(<span class="string">"/"</span>, <span class="number">1</span>));</span><br><span class="line">            <span class="keyword">if</span> (StringUtils.isEmpty(defaultGroup)) &#123;</span><br><span class="line">                <span class="keyword">return</span> <span class="keyword">false</span>;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="comment">//【2.1】设置组 group</span></span><br><span class="line">            meta.setGroup(defaultGroup);</span><br><span class="line">            <span class="keyword">return</span> <span class="keyword">true</span>;</span><br><span class="line">        &#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">            logger.error(<span class="string">"Failed to extract default group! "</span> + e.getMessage());</span><br><span class="line">            <span class="keyword">return</span> <span class="keyword">false</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">true</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>不多说了～</p>
<h6 id="2-2-2-3-1-2-extractDocInfo"><a href="#2-2-2-3-1-2-extractDocInfo" class="headerlink" title="2.2.2.3.1.2 extractDocInfo"></a>2.2.2.3.1.2 extractDocInfo</h6><p>创建路由信息对象：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">private</span> RouteDoc <span class="title">extractDocInfo</span><span class="params">(RouteMeta routeMeta)</span> </span>&#123;</span><br><span class="line">    <span class="comment">//【1】根据 RouteMeta 创建 RouteDoc 实例；</span></span><br><span class="line">    RouteDoc routeDoc = <span class="keyword">new</span> RouteDoc();</span><br><span class="line">    routeDoc.setGroup(routeMeta.getGroup());</span><br><span class="line">    routeDoc.setPath(routeMeta.getPath());</span><br><span class="line">    routeDoc.setDescription(routeMeta.getName());</span><br><span class="line">    routeDoc.setType(routeMeta.getType().name().toLowerCase());</span><br><span class="line">    routeDoc.setMark(routeMeta.getExtra());</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> routeDoc;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h4 id="2-2-5-4-动态生成类"><a href="#2-2-5-4-动态生成类" class="headerlink" title="2.2.5.4 动态生成类"></a>2.2.5.4 动态生成类</h4><h5 id="2-2-5-4-1-模版信息"><a href="#2-2-5-4-1-模版信息" class="headerlink" title="2.2.5.4.1 模版信息"></a>2.2.5.4.1 模版信息</h5><p>我们来看看生成了哪几种模板类：</p>
<ul>
<li><code>ARouter$$Providers$$${moduleName}.java</code></li>
</ul>
<p>这个模版类继承了 IProviderGroup，其实都可以猜到，用于添加属于同一组的 iprovider：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.alibaba.android.arouter.routes;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> com.alibaba.android.arouter.facade.enums.RouteType;</span><br><span class="line"><span class="keyword">import</span> com.alibaba.android.arouter.facade.model.RouteMeta;</span><br><span class="line"><span class="keyword">import</span> com.alibaba.android.arouter.facade.template.IProviderGroup;</span><br><span class="line"><span class="keyword">import</span> java.lang.Override;</span><br><span class="line"><span class="keyword">import</span> java.lang.String;</span><br><span class="line"><span class="keyword">import</span> java.util.Map;</span><br><span class="line">... ... ...</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">ARouter</span>$$<span class="title">Providers</span>$$$</span>&#123;moduleName&#125; implements IProviderGroup &#123;</span><br><span class="line">  <span class="meta">@Override</span></span><br><span class="line">  <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">loadInto</span><span class="params">(Map&lt;String, RouteMeta&gt; providers)</span> </span>&#123;</span><br><span class="line">      providers.put(<span class="string">"目标类的全限定名"</span>, RouteMeta.build(RouteType.PROVIDER, 目标类的类名.class, </span><br><span class="line">                                     $&#123;routeMeta.getPath()&#125;, $&#123;routeMeta.getGroup()&#125;, <span class="keyword">null</span>, $&#123;routeMeta.getPriority()&#125;, $&#123;routeMeta.getExtra()&#125;));</span><br><span class="line">    </span><br><span class="line">      providers.put(<span class="string">"父类的全限定名"</span>, RouteMeta.build(RouteType.PROVIDER, 目标类的类名.class, </span><br><span class="line">                                                $&#123;routeMeta.getPath()&#125;, $&#123;routeMeta.getGroup()&#125;, <span class="keyword">null</span>, $&#123;routeMeta.getPriority()&#125;, $&#123;routeMeta.getExtra()&#125;));</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>不多说了～</p>
<ul>
<li><code>ARouter$$Group$$${groupName}.java</code></li>
</ul>
<p>这个模版类继承了 IRouteGroup，其实都可以猜到，用于添加属于同一组的所有被 @Route 注解的元素：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.alibaba.android.arouter.routes;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> com.alibaba.android.arouter.facade.enums.RouteType;</span><br><span class="line"><span class="keyword">import</span> com.alibaba.android.arouter.facade.model.RouteMeta;</span><br><span class="line"><span class="keyword">import</span> com.alibaba.android.arouter.facade.template.IRouteGroup;</span><br><span class="line"><span class="keyword">import</span> java.lang.Override;</span><br><span class="line"><span class="keyword">import</span> java.lang.String;</span><br><span class="line"><span class="keyword">import</span> java.util.Map;</span><br><span class="line">... ... ...</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">ARouter</span>$$<span class="title">Group</span>$$$</span>&#123;groupName&#125; implements IRouteGroup &#123;</span><br><span class="line">  <span class="meta">@Override</span></span><br><span class="line">  <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">loadInto</span><span class="params">(Map&lt;String, RouteMeta&gt; atlas)</span> </span>&#123;</span><br><span class="line">    atlas.put($&#123;path&#125;, RouteMeta.build(RouteType.XXXX, $&#123;className&#125;.class, $&#123;path&#125;, $&#123;group&#125;,</span><br><span class="line">                                       <span class="keyword">new</span> java.util.HashMap&lt;String, Integer&gt;()&#123;&#123;put($&#123;fieldName&#125;/$&#123;AutoWired.Name&#125;, $&#123;TypeKind&#125;);&#125;&#125;, $&#123;priority&#125;, $&#123;extra&#125;));</span><br><span class="line">    atlas.put($&#123;path&#125;, RouteMeta.build(RouteType.XXXX, $&#123;className&#125;.class, $&#123;path&#125;, $&#123;group&#125;, <span class="keyword">null</span>, $&#123;priority&#125;, $&#123;extra&#125;));</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>不多说了～</p>
<ul>
<li><code>ARouter$$Root$$${moduleName}.java</code></li>
</ul>
<p>这个模版类继承了 IRouteRoot，最为 root，用于添加和管理 group 和对应的 <code>ARouter$$Group$$${moduleName}.java</code> 的映射关系；</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.alibaba.android.arouter.routes;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> com.alibaba.android.arouter.facade.template.IRouteGroup;</span><br><span class="line"><span class="keyword">import</span> com.alibaba.android.arouter.facade.template.IRouteRoot;</span><br><span class="line"><span class="keyword">import</span> java.lang.Class;</span><br><span class="line"><span class="keyword">import</span> java.lang.Override;</span><br><span class="line"><span class="keyword">import</span> java.lang.String;</span><br><span class="line"><span class="keyword">import</span> java.util.Map;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">ARouter</span>$$<span class="title">Root</span>$$$</span>&#123;moduleName&#125; implements IRouteRoot &#123;</span><br><span class="line">  <span class="meta">@Override</span></span><br><span class="line">  <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">loadInto</span><span class="params">(Map&lt;String, Class&lt;? extends IRouteGroup&gt;&gt; routes)</span> </span>&#123;</span><br><span class="line">    routes.put($&#123;groupName&#125;, ARouter$$Group$$$&#123;groupName&#125;.class);</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>我们可以通过  <code>ARouter$$Root$$${groupName}.java</code> 知道该 module 一共包含多少个 group。每个组中的的元素，可以通过    <code>ARouter$$Group$$${moduleName}.java</code>  这个文档添加；</p>
<h5 id="2-2-5-4-2-举个栗子"><a href="#2-2-5-4-2-举个栗子" class="headerlink" title="2.2.5.4.2 举个栗子"></a>2.2.5.4.2 举个栗子</h5><p>我写了个 Demo 可以让大家更直观的看到模版对应的实际代码：</p>
<h6 id="2-2-5-4-2-1-实例代码"><a href="#2-2-5-4-2-1-实例代码" class="headerlink" title="2.2.5.4.2.1 实例代码"></a>2.2.5.4.2.1 实例代码</h6><p>下面是一个简单的 Demo：</p>
<ul>
<li><strong>MyActivity.java</strong></li>
</ul>
<p>MyActivity 的组是：<strong>coolqiActivity</strong></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.lishuaiqi.test;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> android.app.Activity;</span><br><span class="line"><span class="keyword">import</span> android.os.Bundle;</span><br><span class="line"><span class="keyword">import</span> android.support.annotation.Nullable;</span><br><span class="line"><span class="keyword">import</span> com.alibaba.android.arouter.facade.annotation.Autowired;</span><br><span class="line"><span class="keyword">import</span> com.alibaba.android.arouter.facade.annotation.Route;</span><br><span class="line"><span class="keyword">import</span> com.alibaba.android.arouter.launcher.ARouter;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * Created by lishuaiqi</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="meta">@Route</span>(path = <span class="string">"/coolqiActivity/MyActivity"</span>)</span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">MyActivity</span> <span class="keyword">extends</span> <span class="title">Activity</span> </span>&#123;</span><br><span class="line">    <span class="meta">@Autowired</span>(name = <span class="string">"isOneAuto"</span>)</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">boolean</span> isOne;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Autowired</span>(name = <span class="string">"isTwoAuto"</span>)</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">int</span> isTwo;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title">onCreate</span><span class="params">(@Nullable Bundle savedInstanceState)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">super</span>.onCreate(savedInstanceState);</span><br><span class="line">        ARouter.getInstance().inject(<span class="keyword">this</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<ul>
<li><strong>MyIProvider.java</strong></li>
</ul>
<p>MyIProvider 的组是：<strong>coolqiProvider</strong></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.lishuaiqi.test;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> android.content.Context;</span><br><span class="line"><span class="keyword">import</span> com.alibaba.android.arouter.facade.annotation.Route;</span><br><span class="line"><span class="keyword">import</span> com.alibaba.android.arouter.facade.template.IProvider;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * Created by lishuaiqi</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="meta">@Route</span>(path = <span class="string">"/coolqiProvider/MyIProvider"</span>)</span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">MyProvider</span> <span class="keyword">implements</span> <span class="title">IProvider</span> </span>&#123;</span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">init</span><span class="params">(Context context)</span> </span>&#123;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<ul>
<li><strong>MySerializationService.java</strong></li>
</ul>
<p>MySerializationService 的组是：<strong>coolqiService</strong></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Route</span>(path = <span class="string">"/coolqiService/MySerializationService"</span>)</span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">MySerializationService</span> <span class="keyword">implements</span> <span class="title">SerializationService</span> </span>&#123;</span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> &lt;T&gt; <span class="function">T <span class="title">json2Object</span><span class="params">(String input, Class&lt;T&gt; clazz)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">null</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> String <span class="title">object2Json</span><span class="params">(Object instance)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">null</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> &lt;T&gt; <span class="function">T <span class="title">parseObject</span><span class="params">(String input, Type clazz)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">null</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">init</span><span class="params">(Context context)</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>我是新建了一个 Module，名字叫：<strong>Coolqi</strong></p>
<h6 id="2-2-5-4-2-2-动态代码"><a href="#2-2-5-4-2-2-动态代码" class="headerlink" title="2.2.5.4.2.2 动态代码"></a>2.2.5.4.2.2 动态代码</h6><p>动态的代码如下所示：</p>
<ul>
<li><code>ARouter$$Group$$coolqiActivity.java</code>， <code>ARouter$$Group$$coolqiProvider.java</code>， <code>ARouter$$Group$$coolqiService.java</code></li>
</ul>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.alibaba.android.arouter.routes;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> com.alibaba.android.arouter.facade.enums.RouteType;</span><br><span class="line"><span class="keyword">import</span> com.alibaba.android.arouter.facade.model.RouteMeta;</span><br><span class="line"><span class="keyword">import</span> com.alibaba.android.arouter.facade.template.IRouteGroup;</span><br><span class="line"><span class="keyword">import</span> com.lishuaiqi.test.MyActivity;</span><br><span class="line"><span class="keyword">import</span> com.lishuaiqi.test.MyPathReplaceService;</span><br><span class="line"><span class="keyword">import</span> com.lishuaiqi.test.MyProvider;</span><br><span class="line"><span class="keyword">import</span> com.lishuaiqi.MainActivity;</span><br><span class="line"><span class="keyword">import</span> java.lang.Override;</span><br><span class="line"><span class="keyword">import</span> java.lang.String;</span><br><span class="line"><span class="keyword">import</span> java.util.Map;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">ARouter</span>$$<span class="title">Group</span>$$<span class="title">coolqiActivity</span> <span class="keyword">implements</span> <span class="title">IRouteGroup</span> </span>&#123;</span><br><span class="line">  <span class="meta">@Override</span></span><br><span class="line">  <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">loadInto</span><span class="params">(Map&lt;String, RouteMeta&gt; atlas)</span> </span>&#123;</span><br><span class="line">    atlas.put(<span class="string">"/coolqiActivity/MyActivity"</span>, RouteMeta.build(RouteType.ACTIVITY, MyActivity.class, <span class="string">"/coolqiactivity/myactivity"</span>, <span class="string">"coolqiactivity"</span>, <span class="keyword">null</span>, -<span class="number">1</span>, -<span class="number">2147483648</span>));</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">ARouter</span>$$<span class="title">Group</span>$$<span class="title">coolqiProvider</span> <span class="keyword">implements</span> <span class="title">IRouteGroup</span> </span>&#123;</span><br><span class="line">  <span class="meta">@Override</span></span><br><span class="line">  <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">loadInto</span><span class="params">(Map&lt;String, RouteMeta&gt; atlas)</span> </span>&#123;</span><br><span class="line">    atlas.put(<span class="string">"/coolqiProvider/MyIProvider"</span>, RouteMeta.build(RouteType.PROVIDER, MyIProvider.class, <span class="string">"/coolqiprovider/myiprovider"</span>, <span class="string">"coolqiprovider"</span>, <span class="keyword">null</span>, -<span class="number">1</span>, -<span class="number">2147483648</span>));</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">ARouter</span>$$<span class="title">Group</span>$$<span class="title">coolqiService</span> <span class="keyword">implements</span> <span class="title">IRouteGroup</span> </span>&#123;</span><br><span class="line">  <span class="meta">@Override</span></span><br><span class="line">  <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">loadInto</span><span class="params">(Map&lt;String, RouteMeta&gt; atlas)</span> </span>&#123;</span><br><span class="line">    atlas.put(<span class="string">"/coolqiService/MySerializationService"</span>, RouteMeta.build(RouteType.PROVIDER, MySerializationService.class, <span class="string">"/coolqiservice/myserializationservice"</span>, <span class="string">"coolqiservice"</span>, <span class="keyword">null</span>, -<span class="number">1</span>, -<span class="number">2147483648</span>));</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>其他的就不说了，反正就是看代码！</p>
<ul>
<li><code>ARouter$$Providers$$app.java</code></li>
</ul>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.alibaba.android.arouter.routes;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> com.alibaba.android.arouter.facade.enums.RouteType;</span><br><span class="line"><span class="keyword">import</span> com.alibaba.android.arouter.facade.model.RouteMeta;</span><br><span class="line"><span class="keyword">import</span> com.alibaba.android.arouter.facade.template.IProviderGroup;</span><br><span class="line"><span class="keyword">import</span> com.pa.sales2.test.MyIProvider;</span><br><span class="line"><span class="keyword">import</span> com.pa.sales2.test.MySerializationService;</span><br><span class="line"><span class="keyword">import</span> java.lang.Override;</span><br><span class="line"><span class="keyword">import</span> java.lang.String;</span><br><span class="line"><span class="keyword">import</span> java.util.Map;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">ARouter</span>$$<span class="title">Providers</span>$$<span class="title">Coolqi</span> <span class="keyword">implements</span> <span class="title">IProviderGroup</span> </span>&#123;</span><br><span class="line">  <span class="meta">@Override</span></span><br><span class="line">  <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">loadInto</span><span class="params">(Map&lt;String, RouteMeta&gt; providers)</span> </span>&#123;</span><br><span class="line">    providers.put(<span class="string">"com.alibaba.android.arouter.facade.service.SerializationService"</span>, RouteMeta.build(RouteType.PROVIDER, MySerializationService.class, </span><br><span class="line">                            <span class="string">"/coolqiService/MySerializationService"</span>, <span class="string">"coolqiService"</span>, <span class="keyword">null</span>, -<span class="number">1</span>, -<span class="number">2147483648</span>));</span><br><span class="line">    providers.put(<span class="string">"com.pa.sales2.test.MyIProvider"</span>, RouteMeta.build(RouteType.PROVIDER, MyIProvider.class, </span><br><span class="line">                            <span class="string">"/coolqiProvider/MyIProvider"</span>, <span class="string">"coolqiProvider"</span>, <span class="keyword">null</span>, -<span class="number">1</span>, -<span class="number">2147483648</span>));</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>其他的就不说了，反正就是看代码！</p>
<ul>
<li><code>ARouter$$Root$$app.java</code></li>
</ul>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.alibaba.android.arouter.routes;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> com.alibaba.android.arouter.facade.template.IRouteGroup;</span><br><span class="line"><span class="keyword">import</span> com.alibaba.android.arouter.facade.template.IRouteRoot;</span><br><span class="line"><span class="keyword">import</span> java.lang.Class;</span><br><span class="line"><span class="keyword">import</span> java.lang.Override;</span><br><span class="line"><span class="keyword">import</span> java.lang.String;</span><br><span class="line"><span class="keyword">import</span> java.util.Map;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">ARouter</span>$$<span class="title">Root</span>$$<span class="title">Coolqi</span> <span class="keyword">implements</span> <span class="title">IRouteRoot</span> </span>&#123;</span><br><span class="line">  <span class="meta">@Override</span></span><br><span class="line">  <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">loadInto</span><span class="params">(Map&lt;String, Class&lt;? extends IRouteGroup&gt;&gt; routes)</span> </span>&#123;</span><br><span class="line">    routes.put(<span class="string">"coolqiActivity"</span>, ARouter$$Group$$coolqiActivity.class);</span><br><span class="line">    routes.put(<span class="string">"coolqiProvider"</span>, ARouter$$Group$$coolqiProvider.class);</span><br><span class="line">    routes.put(<span class="string">"coolqiService"</span>, ARouter$$Group$$coolqiService.class);</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>其他的就不说了，反正就是看代码！</p>
<h3 id="2-2-3-AutowiredProcessor"><a href="#2-2-3-AutowiredProcessor" class="headerlink" title="2.2.3 AutowiredProcessor"></a>2.2.3 AutowiredProcessor</h3><p>核心解释器，用于处理 @Autowired 注解：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@AutoService</span>(Processor.class)</span><br><span class="line"><span class="meta">@SupportedAnnotationTypes</span>(&#123;ANNOTATION_TYPE_AUTOWIRED&#125;)</span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">AutowiredProcessor</span> <span class="keyword">extends</span> <span class="title">BaseProcessor</span> </span>&#123;</span><br><span class="line">  	... ... ...</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>我们从成员变量，初始化，注解处理三个方面来分析：</p>
<h4 id="2-2-3-1-Field"><a href="#2-2-3-1-Field" class="headerlink" title="2.2.3.1 Field"></a>2.2.3.1 Field</h4><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//【1】key 表示属性所属的类，value 是一个 list 列表，保存这个类被 Autowired 修饰的所有元素；</span></span><br><span class="line"><span class="keyword">private</span> Map&lt;TypeElement, List&lt;Element&gt;&gt; parentAndChild = <span class="keyword">new</span> HashMap&lt;&gt;(); </span><br><span class="line"><span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> ClassName ARouterClass = ClassName.get(<span class="string">"com.alibaba.android.arouter.launcher"</span>, <span class="string">"ARouter"</span>);</span><br><span class="line"><span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> ClassName AndroidLog = ClassName.get(<span class="string">"android.util"</span>, <span class="string">"Log"</span>);</span><br></pre></td></tr></table></figure>
<h4 id="2-2-3-2-Init"><a href="#2-2-3-2-Init" class="headerlink" title="2.2.3.2 Init"></a>2.2.3.2 Init</h4><p>init 方法很简单，没有太多代码：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">synchronized</span> <span class="keyword">void</span> <span class="title">init</span><span class="params">(ProcessingEnvironment processingEnvironment)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">super</span>.init(processingEnvironment);</span><br><span class="line">    logger.info(<span class="string">"&gt;&gt;&gt; AutowiredProcessor init. &lt;&lt;&lt;"</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h4 id="2-2-3-3-Process-处理-Autowired-注解"><a href="#2-2-3-3-Process-处理-Autowired-注解" class="headerlink" title="2.2.3.3 Process  - 处理 Autowired 注解"></a>2.2.3.3 Process  - 处理 Autowired 注解</h4><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">boolean</span> <span class="title">process</span><span class="params">(Set&lt;? extends TypeElement&gt; set, RoundEnvironment roundEnvironment)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">if</span> (CollectionUtils.isNotEmpty(set)) &#123;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            logger.info(<span class="string">"&gt;&gt;&gt; Found autowired field, start... &lt;&lt;&lt;"</span>);</span><br><span class="line">            <span class="comment">//【*2.2.3.3.1】对变量进行归类，并找到其所属的类；</span></span><br><span class="line">            categories(roundEnvironment.getElementsAnnotatedWith(Autowired.class));</span><br><span class="line">            <span class="comment">//【*2.2.3.3.2】动态生成 java 类！</span></span><br><span class="line">            generateHelper();</span><br><span class="line"></span><br><span class="line">        &#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">            logger.error(e);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">true</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">false</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h5 id="2-2-3-3-1-categories"><a href="#2-2-3-3-1-categories" class="headerlink" title="2.2.3.3.1 categories"></a>2.2.3.3.1 categories</h5><p>对变量进行归类，并找到其所属的类；</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">categories</span><span class="params">(Set&lt;? extends Element&gt; elements)</span> <span class="keyword">throws</span> IllegalAccessException </span>&#123;</span><br><span class="line">    <span class="keyword">if</span> (CollectionUtils.isNotEmpty(elements)) &#123;</span><br><span class="line">        <span class="comment">//【1】遍历所有被 @AutoWired 注解的元素；</span></span><br><span class="line">        <span class="keyword">for</span> (Element element : elements) &#123;</span><br><span class="line">            <span class="comment">//【2】返回封装此元素（非严格意义上）的最里层元素，实际上就是其所属的类；</span></span><br><span class="line">            TypeElement enclosingElement = (TypeElement) element.getEnclosingElement();</span><br><span class="line">            <span class="comment">//【3】如果此成员属性是 private 的，那就抛出异常！</span></span><br><span class="line">            <span class="keyword">if</span> (element.getModifiers().contains(Modifier.PRIVATE)) &#123;</span><br><span class="line">                <span class="keyword">throw</span> <span class="keyword">new</span> IllegalAccessException(<span class="string">"The inject fields CAN NOT BE 'private'!!! please check field ["</span></span><br><span class="line">                        + element.getSimpleName() + <span class="string">"] in class ["</span> + enclosingElement.getQualifiedName() + <span class="string">"]"</span>);</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="comment">//【4】将成员属性 element 和所属类元素 enclosingElement 保存到 parentAndChild 中，分类完毕；</span></span><br><span class="line">            <span class="keyword">if</span> (parentAndChild.containsKey(enclosingElement 保存到 )) &#123;</span><br><span class="line">                parentAndChild.get(enclosingElement).add(element);</span><br><span class="line">            &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                List&lt;Element&gt; childs = <span class="keyword">new</span> ArrayList&lt;&gt;();</span><br><span class="line">                childs.add(element);</span><br><span class="line">                parentAndChild.put(enclosingElement, childs);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        logger.info(<span class="string">"categories finished."</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>可以看到，private 的元素不能用 Autowired 修饰；</p>
<h5 id="2-2-3-3-2-generateHelper"><a href="#2-2-3-3-2-generateHelper" class="headerlink" title="2.2.3.3.2 generateHelper"></a>2.2.3.3.2 generateHelper</h5><p>动态生成 java 类：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">generateHelper</span><span class="params">()</span> <span class="keyword">throws</span> IOException, IllegalAccessException </span>&#123;</span><br><span class="line">    <span class="comment">//【1】获得 .ISyringe/.SerializationService 接口在编译时期的状态信息；</span></span><br><span class="line">    TypeElement type_ISyringe = elementUtils.getTypeElement(ISYRINGE);</span><br><span class="line">    TypeElement type_JsonService = elementUtils.getTypeElement(JSON_SERVICE);</span><br><span class="line">    <span class="comment">//【2】返回类型信息：类/接口</span></span><br><span class="line">    TypeMirror iProvider = elementUtils.getTypeElement(Consts.IPROVIDER).asType();</span><br><span class="line">    TypeMirror activityTm = elementUtils.getTypeElement(Consts.ACTIVITY).asType();</span><br><span class="line">    TypeMirror fragmentTm = elementUtils.getTypeElement(Consts.FRAGMENT).asType();</span><br><span class="line">    TypeMirror fragmentTmV4 = elementUtils.getTypeElement(Consts.FRAGMENT_V4).asType();</span><br><span class="line"></span><br><span class="line">    <span class="comment">//【3】开始动态生成类：</span></span><br><span class="line">    <span class="comment">//【3.1】生成 inject 方法的参数：Object target</span></span><br><span class="line">    ParameterSpec objectParamSpec = ParameterSpec.builder(TypeName.OBJECT, <span class="string">"target"</span>).build();</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (MapUtils.isNotEmpty(parentAndChild)) &#123;</span><br><span class="line">        <span class="comment">// 遍历 parentAndChild 集合；</span></span><br><span class="line">        <span class="keyword">for</span> (Map.Entry&lt;TypeElement, List&lt;Element&gt;&gt; entry : parentAndChild.entrySet()) &#123;</span><br><span class="line">            <span class="comment">//【3.2】生成 inject 方法签名；</span></span><br><span class="line">            <span class="comment">// 		 @Override </span></span><br><span class="line">            <span class="comment">// 		 public void inject(Object target)</span></span><br><span class="line">            MethodSpec.Builder injectMethodBuilder = MethodSpec.methodBuilder(METHOD_INJECT)</span><br><span class="line">                    .addAnnotation(Override.class)</span><br><span class="line">                    .addModifiers(PUBLIC)</span><br><span class="line">                    .addParameter(objectParamSpec);</span><br><span class="line"></span><br><span class="line">            TypeElement parent = entry.getKey();</span><br><span class="line">            List&lt;Element&gt; childs = entry.getValue();</span><br><span class="line">            <span class="comment">//【3.3】获得所属类的全限定名，包名；</span></span><br><span class="line">            String qualifiedName = parent.getQualifiedName().toString();</span><br><span class="line">            String packageName = qualifiedName.substring(<span class="number">0</span>, qualifiedName.lastIndexOf(<span class="string">"."</span>));</span><br><span class="line">            <span class="comment">//【3.4】获得所属类的类名，拼接 "$$ARouter$$Root$$Autowired" 作为动态生成类的类名；</span></span><br><span class="line">            String fileName = parent.getSimpleName() + NAME_OF_AUTOWIRED;</span><br><span class="line"></span><br><span class="line">            logger.info(<span class="string">"&gt;&gt;&gt; Start process "</span> + childs.size() + <span class="string">" field in "</span> + parent.getSimpleName() + <span class="string">" ... &lt;&lt;&lt;"</span>);</span><br><span class="line">            </span><br><span class="line">            <span class="comment">//【3.5】创建生成 java 类 helper 对象：指定类名(fileName)，实现的接口(.ISyringe), 修饰符(public)</span></span><br><span class="line">            TypeSpec.Builder helper = TypeSpec.classBuilder(fileName)</span><br><span class="line">                    .addJavadoc(WARNING_TIPS)</span><br><span class="line">                    .addSuperinterface(ClassName.get(type_ISyringe))</span><br><span class="line">                    .addModifiers(PUBLIC);</span><br><span class="line">            <span class="comment">//【3.6】创建动态类的成员变量：</span></span><br><span class="line">            <span class="comment">//     private com.alibaba.android.arouter.facade.service.SerializationService serializationService;</span></span><br><span class="line">            FieldSpec jsonServiceField = FieldSpec.builder(TypeName.get(type_JsonService.asType()), </span><br><span class="line">                                                           <span class="string">"serializationService"</span>, Modifier.PRIVATE).build();</span><br><span class="line">            helper.addField(jsonServiceField);</span><br><span class="line">            </span><br><span class="line">            <span class="comment">//【3.5】给 inject 增加方法体：</span></span><br><span class="line">            <span class="comment">//      serializationService = com.alibaba.android.arouter.launcher.ARouter.getInstance()</span></span><br><span class="line">            <span class="comment">//                .navigation(com.alibaba.android.arouter.facade.service.SerializationService.class);</span></span><br><span class="line">            <span class="comment">//      parentClass substitute = (parentClass) target</span></span><br><span class="line">            injectMethodBuilder.addStatement(<span class="string">"serializationService = $T.getInstance().navigation($T.class)"</span>, </span><br><span class="line">                                             ARouterClass, ClassName.get(type_JsonService));</span><br><span class="line">            injectMethodBuilder.addStatement(<span class="string">"$T substitute = ($T)target"</span>, ClassName.get(parent), ClassName.get(parent));</span><br><span class="line"></span><br><span class="line">            <span class="comment">//【3.6】继续给 inject 增加方法体：（处理成员变量）</span></span><br><span class="line">            <span class="keyword">for</span> (Element element : childs) &#123;</span><br><span class="line">                Autowired fieldConfig = element.getAnnotation(Autowired.class);</span><br><span class="line">                <span class="comment">//【3.6.1】获取变量的名称；</span></span><br><span class="line">                String fieldName = element.getSimpleName().toString();</span><br><span class="line">                <span class="comment">//【3.6.2】如果实现了 .IProvider 接口，针对于是否设置了 name 属性，进行 byType/ byName 分类处理；</span></span><br><span class="line">                <span class="keyword">if</span> (types.isSubtype(element.asType(), iProvider)) &#123;  <span class="comment">// It's provider</span></span><br><span class="line">                    <span class="keyword">if</span> (<span class="string">""</span>.equals(fieldConfig.name())) &#123; </span><br><span class="line">                        <span class="comment">//【3.6.2.1】如果 Autowired.name 为空，生成如下代码：</span></span><br><span class="line">                        <span class="comment">// substitute.变量名 = com.alibaba.android.arouter.launcher.ARouter.getInstance()</span></span><br><span class="line">                        <span class="comment">//                          .navigation(变量类型的全限定名.class);</span></span><br><span class="line">                        injectMethodBuilder.addStatement(</span><br><span class="line">                                <span class="string">"substitute."</span> + fieldName + <span class="string">" = $T.getInstance().navigation($T.class)"</span>,</span><br><span class="line">                                ARouterClass,</span><br><span class="line">                                ClassName.get(element.asType())</span><br><span class="line">                        );</span><br><span class="line">                    &#125; <span class="keyword">else</span> &#123; </span><br><span class="line">                        <span class="comment">//【3.6.2.2】如果 Autowired.name 不为空，生成如下代码：</span></span><br><span class="line">                        <span class="comment">// substitute.变量名 = (变量类型的全限定名) com.alibaba.android.arouter.launcher.ARouter.getInstance()</span></span><br><span class="line">                        <span class="comment">//                          .build(Autowired().name).navigation();</span></span><br><span class="line">                        injectMethodBuilder.addStatement(</span><br><span class="line">                                <span class="string">"substitute."</span> + fieldName + <span class="string">" = ($T)$T.getInstance().build($S).navigation()"</span>,</span><br><span class="line">                                ClassName.get(element.asType()),</span><br><span class="line">                                ARouterClass,</span><br><span class="line">                                fieldConfig.name()</span><br><span class="line">                        );</span><br><span class="line">                    &#125;</span><br><span class="line"></span><br><span class="line">                    <span class="comment">//【3.6.2.3】判断 Autowired 的 required 是否为 true，如果为 true，那就要禁止 null 的情况！</span></span><br><span class="line">                    <span class="comment">// 其实就是判断 substitute.变量 如果 null，抛出异常；</span></span><br><span class="line">                    <span class="keyword">if</span> (fieldConfig.required()) &#123;</span><br><span class="line">                        injectMethodBuilder.beginControlFlow(<span class="string">"if (substitute."</span> + fieldName + <span class="string">" == null)"</span>);</span><br><span class="line">                        injectMethodBuilder.addStatement(</span><br><span class="line">                                <span class="string">"throw new RuntimeException(\"The field '"</span> + fieldName + <span class="string">"' is null, in class '\" </span></span><br><span class="line"><span class="string">                                                 + $T.class.getName() + \"!\")"</span>, ClassName.get(parent));</span><br><span class="line">                        injectMethodBuilder.endControlFlow();</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                    <span class="comment">//【3.6.3】对于一般的可通过 intent 传递的变量，进入这里；</span></span><br><span class="line">                    String originalValue = <span class="string">"substitute."</span> + fieldName;</span><br><span class="line">                    <span class="comment">// 用于拼接成员变量的生成方式："substitute.变量名 = substitute."；</span></span><br><span class="line">                    <span class="comment">//【*2.2.3.3.2.1】对于实现了 serializable 接口的变量, 则是："substitute.变量名 = (变量类型的全限定名) substitute."</span></span><br><span class="line">                    String statement = <span class="string">"substitute."</span> + fieldName + <span class="string">" = "</span> + buildCastCode(element) + <span class="string">"substitute."</span>;</span><br><span class="line">                    <span class="keyword">boolean</span> isActivity = <span class="keyword">false</span>;</span><br><span class="line">                    <span class="keyword">if</span> (types.isSubtype(parent.asType(), activityTm)) &#123; </span><br><span class="line">                        <span class="comment">//【3.6.4.1】如果是 activity，那么拼接代码：getIntent().</span></span><br><span class="line">                        isActivity = <span class="keyword">true</span>;</span><br><span class="line">                        statement += <span class="string">"getIntent()."</span>;</span><br><span class="line">                    &#125; <span class="keyword">else</span> <span class="keyword">if</span> (types.isSubtype(parent.asType(), fragmentTm) || types.isSubtype(parent.asType(), fragmentTmV4)) &#123; </span><br><span class="line">                        <span class="comment">//【3.6.4.2】如果是 fragment，那么拼接代码：getArguments().</span></span><br><span class="line">                        statement += <span class="string">"getArguments()."</span>; </span><br><span class="line">                    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                        <span class="keyword">throw</span> <span class="keyword">new</span> IllegalAccessException(<span class="string">"The field ["</span> + fieldName + <span class="string">"] need autowired from intent, "</span> </span><br><span class="line">                                                         + <span class="string">"its parent must be activity or fragment!"</span>);</span><br><span class="line">                    &#125;</span><br><span class="line">                    <span class="comment">//【*2.2.3.3.2.2】处理 getIntent()/getArguments() 的数据；</span></span><br><span class="line">                    <span class="comment">// typeUtils.typeExchange(element) 返回的是成员属性的枚举序号！</span></span><br><span class="line">                    statement = buildStatement(originalValue, statement, typeUtils.typeExchange(element), isActivity);</span><br><span class="line">                    <span class="keyword">if</span> (statement.startsWith(<span class="string">"serializationService."</span>)) &#123; </span><br><span class="line">                        <span class="comment">//【3.6.5.1】处理 serializationService（自定义对象）的情况：</span></span><br><span class="line">                        injectMethodBuilder.beginControlFlow(<span class="string">"if (null != serializationService)"</span>);</span><br><span class="line">                        <span class="comment">//【3.6.5.2】生成方法体："substitute.fieldName = " + statement;</span></span><br><span class="line">                        <span class="comment">// $S 被替换为变量名/Autowired.name，$T 被替换为变量类型的全限定名；</span></span><br><span class="line">                        injectMethodBuilder.addStatement(</span><br><span class="line">                                <span class="string">"substitute."</span> + fieldName + <span class="string">" = "</span> + statement,</span><br><span class="line">                                (StringUtils.isEmpty(fieldConfig.name()) ? fieldName : fieldConfig.name()),</span><br><span class="line">                                ClassName.get(element.asType())</span><br><span class="line">                        );</span><br><span class="line">                        injectMethodBuilder.nextControlFlow(<span class="string">"else"</span>);</span><br><span class="line">                        injectMethodBuilder.addStatement(</span><br><span class="line">                                <span class="string">"$T.e(\""</span> + Consts.TAG + <span class="string">"\", \"You want automatic inject the field '"</span> + fieldName </span><br><span class="line">                                          + <span class="string">"' in class '$T' , then you should implement 'SerializationService'"</span></span><br><span class="line">                                          + <span class="string">" to support object auto inject!\")"</span>, AndroidLog, ClassName.get(parent));</span><br><span class="line">                        injectMethodBuilder.endControlFlow();</span><br><span class="line">                    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                        <span class="comment">//【3.6.5.3】处理其他的情况，如果 Autowired.name 不为 null，那么 $S 替换为变量名，否则为 Autowired.name</span></span><br><span class="line">                        <span class="comment">// 将方法体写入 inject；</span></span><br><span class="line">                        injectMethodBuilder.addStatement(statement,</span><br><span class="line">                                       StringUtils.isEmpty(fieldConfig.name()) ? fieldName : fieldConfig.name());</span><br><span class="line">                    &#125;</span><br><span class="line"></span><br><span class="line">                    <span class="comment">// Autowired 的 required 为 true，且不是 private 的，非空判断；</span></span><br><span class="line">                    <span class="keyword">if</span> (fieldConfig.required() &amp;&amp; !element.asType().getKind().isPrimitive()) &#123; </span><br><span class="line">                        injectMethodBuilder.beginControlFlow(<span class="string">"if (null == substitute."</span> + fieldName + <span class="string">")"</span>);</span><br><span class="line">                        injectMethodBuilder.addStatement(</span><br><span class="line">                                <span class="string">"$T.e(\""</span> + Consts.TAG + <span class="string">"\", \"The field '"</span> + fieldName </span><br><span class="line">                                + <span class="string">"' is null, in class '\" + $T.class.getName() + \"!\")"</span>, AndroidLog, ClassName.get(parent));</span><br><span class="line">                        injectMethodBuilder.endControlFlow(); <span class="comment">// 闭合方法体；</span></span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            helper.addMethod(injectMethodBuilder.build()); <span class="comment">// 将方法 builder 加入到类 builder 中；</span></span><br><span class="line"></span><br><span class="line">            <span class="comment">//【4】动态创建 java 文件；</span></span><br><span class="line">            JavaFile.builder(packageName, helper.build()).build().writeTo(mFiler);</span><br><span class="line"></span><br><span class="line">            logger.info(<span class="string">"&gt;&gt;&gt; "</span> + parent.getSimpleName() + <span class="string">" has been processed, "</span> + fileName + <span class="string">" has been generated. &lt;&lt;&lt;"</span>);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        logger.info(<span class="string">"&gt;&gt;&gt; Autowired processor stop. &lt;&lt;&lt;"</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>整个流程我们分析完成了，我们先不关注动态生成的类的作用，在后面分析 arouter-api 模块的时候，就会知道这些类的作用是什么了。</p>
<h6 id="2-2-3-3-2-1-buildCastCode"><a href="#2-2-3-3-2-1-buildCastCode" class="headerlink" title="2.2.3.3.2.1 buildCastCode"></a>2.2.3.3.2.1 buildCastCode</h6><p>判断 element 的类型是否是 SERIALIZABLE 的，这里利用到了前面的枚举类 TypeKind 和工具类 typeUtils：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">private</span> String <span class="title">buildCastCode</span><span class="params">(Element element)</span> </span>&#123;</span><br><span class="line">    <span class="comment">//【1】判断 element 的类型是否是 SERIALIZABLE 的！</span></span><br><span class="line">    <span class="keyword">if</span> (typeUtils.typeExchange(element) == TypeKind.SERIALIZABLE.ordinal()) &#123;</span><br><span class="line">        <span class="comment">//【2】创建代码块：(变量类型的全限定名)</span></span><br><span class="line">        <span class="keyword">return</span> CodeBlock.builder().add(<span class="string">"($T) "</span>, ClassName.get(element.asType())).build().toString();</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> <span class="string">""</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>这个主要是针对于实现了 serializable 接口的变量，比如一些集合等等；</p>
<h6 id="2-2-3-3-2-2-buildStatement"><a href="#2-2-3-3-2-2-buildStatement" class="headerlink" title="2.2.3.3.2.2 buildStatement"></a>2.2.3.3.2.2 buildStatement</h6><p>处理 getIntent()/getArguments() 的数据：</p>
<ul>
<li>参数 originalValue 表示变量: “substitute.fieldName“，用于返回默认值；</li>
<li>参数 type 是成员属性对应的枚举序号：</li>
</ul>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">private</span> String <span class="title">buildStatement</span><span class="params">(String originalValue, String statement, <span class="keyword">int</span> type, <span class="keyword">boolean</span> isActivity)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">switch</span> (TypeKind.values()[type]) &#123;</span><br><span class="line">        <span class="keyword">case</span> BOOLEAN:</span><br><span class="line">            <span class="comment">//【1】如果是 boolean，那么 activty 拼接：getBooleanExtra($S, 变量)，fragment 拼接：getBoolean($S)</span></span><br><span class="line">            statement += (isActivity ? (<span class="string">"getBooleanExtra($S, "</span> + originalValue + <span class="string">")"</span>) : (<span class="string">"getBoolean($S)"</span>));</span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line">        <span class="keyword">case</span> BYTE:</span><br><span class="line">            <span class="comment">//【2】如果是 byte，那么 activty 拼接：getByteExtra($S, 变量)，fragment 拼接：getByte($S)</span></span><br><span class="line">            statement += (isActivity ? (<span class="string">"getByteExtra($S, "</span> + originalValue + <span class="string">")"</span>) : (<span class="string">"getByte($S)"</span>));</span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line">        <span class="keyword">case</span> SHORT:</span><br><span class="line">            <span class="comment">//【3】如果是 short，那么 activty 拼接：getShortExtra($S, 变量)，fragment 拼接：getShort($S)</span></span><br><span class="line">            statement += (isActivity ? (<span class="string">"getShortExtra($S, "</span> + originalValue + <span class="string">")"</span>) : (<span class="string">"getShort($S)"</span>));</span><br><span class="line">            <span class="keyword">break</span>;	</span><br><span class="line">        <span class="keyword">case</span> INT:</span><br><span class="line">            <span class="comment">//【4】如果是 int，那么 activty 拼接：getIntExtra($S, 变量)，fragment 拼接：getInt($S)</span></span><br><span class="line">            statement += (isActivity ? (<span class="string">"getIntExtra($S, "</span> + originalValue + <span class="string">")"</span>) : (<span class="string">"getInt($S)"</span>));</span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line">        <span class="keyword">case</span> LONG:</span><br><span class="line">            <span class="comment">//【5】如果是 long，那么 activty 拼接：getLongExtra($S, 变量)，fragment 拼接：getLong($S)</span></span><br><span class="line">            statement += (isActivity ? (<span class="string">"getLongExtra($S, "</span> + originalValue + <span class="string">")"</span>) : (<span class="string">"getLong($S)"</span>));</span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line">        <span class="keyword">case</span> CHAR:</span><br><span class="line">            <span class="comment">//【6】如果是 char，那么 activty 拼接：getCharExtra($S, 变量)，fragment 拼接：getChar($S)</span></span><br><span class="line">            statement += (isActivity ? (<span class="string">"getCharExtra($S, "</span> + originalValue + <span class="string">")"</span>) : (<span class="string">"getChar($S)"</span>));</span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line">        <span class="keyword">case</span> FLOAT:</span><br><span class="line">            <span class="comment">//【7】如果是 float，那么 activty 拼接：getFloatExtra($S, 变量)，fragment 拼接：getFloat($S)</span></span><br><span class="line">            statement += (isActivity ? (<span class="string">"getFloatExtra($S, "</span> + originalValue + <span class="string">")"</span>) : (<span class="string">"getFloat($S)"</span>));</span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line">        <span class="keyword">case</span> DOUBLE:</span><br><span class="line">            <span class="comment">//【8】如果是 double，那么 activty 拼接：getDoubleExtra($S, 变量)，fragment 拼接：getDouble($S)</span></span><br><span class="line">            statement += (isActivity ? (<span class="string">"getDoubleExtra($S, "</span> + originalValue + <span class="string">")"</span>) : (<span class="string">"getDouble($S)"</span>));</span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line">        <span class="keyword">case</span> STRING:</span><br><span class="line">            <span class="comment">//【9】如果是 string，那么 activty 拼接：getExtras() == null ? 变量 : substitute.getIntent().getExtras().getString($S, 变量)</span></span><br><span class="line">            <span class="comment">// fragment 拼接：getString($S)</span></span><br><span class="line">            statement += (isActivity ? (<span class="string">"getExtras() == null ? "</span> + originalValue + <span class="string">" : substitute.getIntent().getExtras().getString($S, "</span> + originalValue + <span class="string">")"</span>) : (<span class="string">"getString($S)"</span>));</span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line">        <span class="keyword">case</span> SERIALIZABLE:</span><br><span class="line">            <span class="comment">//【10】如果是 serializable，那么 activty 拼接：getSerializableExtra($S)</span></span><br><span class="line">            <span class="comment">// fragment 拼接：getSerializable($S)</span></span><br><span class="line">            statement += (isActivity ? (<span class="string">"getSerializableExtra($S)"</span>) : (<span class="string">"getSerializable($S)"</span>));</span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line">        <span class="keyword">case</span> PARCELABLE:</span><br><span class="line">            <span class="comment">//【11】如果是 parcelable，那么 activty 拼接：getParcelableExtra($S)</span></span><br><span class="line">            <span class="comment">// fragment 拼接：getParcelable($S)</span></span><br><span class="line">            statement += (isActivity ? (<span class="string">"getParcelableExtra($S)"</span>) : (<span class="string">"getParcelable($S)"</span>));</span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line">        <span class="keyword">case</span> OBJECT:</span><br><span class="line">            <span class="comment">//【12】如果是 object，那么 activity 返回：serializationService.parseObject(substitute.getIntent().getStringExtra($S), new com.alibaba.android.arouter.facade.model.TypeWrapper&lt;$T&gt;()&#123;&#125;.getType())</span></span><br><span class="line">            <span class="comment">// fragment 返回：serializationService.parseObject(substitute.getArguments().getString($S), new com.alibaba.android.arouter.facade.model.TypeWrapper&lt;$T&gt;()&#123;&#125;.getType())</span></span><br><span class="line">            statement = <span class="string">"serializationService.parseObject(substitute."</span> + (isActivity ? <span class="string">"getIntent()."</span> : <span class="string">"getArguments()."</span>) + (isActivity ? <span class="string">"getStringExtra($S)"</span> : <span class="string">"getString($S)"</span>) + <span class="string">", new "</span> + TYPE_WRAPPER + <span class="string">"&lt;$T&gt;()&#123;&#125;.getType())"</span>;</span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> statement;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>可以看到，buildStatement 会处理 getIntent()/getArguments() 的数据，在 statement 基础上拼接/修改：</p>
<ul>
<li><strong>Activity</strong> - 生成的 statement</li>
</ul>
<table>
<thead>
<tr>
<th><strong>变量类型</strong></th>
<th><strong>动态生成的代码块</strong></th>
</tr>
</thead>
<tbody>
<tr>
<td><strong>boolean</strong></td>
<td><code>substitute.变量 = substitute.getIntent().getBooleanExtra($S, 变量)</code></td>
</tr>
<tr>
<td><strong>byte</strong></td>
<td><code>substitute.变量 = substitute.getIntent().getByteExtra($S, 变量)</code></td>
</tr>
<tr>
<td><strong>short</strong></td>
<td><code>substitute.变量 = substitute.getIntent().getShortExtra($S, 变量)</code></td>
</tr>
<tr>
<td><strong>int</strong></td>
<td><code>substitute.变量 = substitute.getIntent().getIntExtra($S, 变量)</code></td>
</tr>
<tr>
<td><strong>long</strong></td>
<td><code>substitute.变量 = substitute.getIntent().getLongExtra($S, 变量)</code></td>
</tr>
<tr>
<td><strong>char</strong></td>
<td><code>substitute.变量 = substitute.getIntent().getCharExtra($S, 变量)</code></td>
</tr>
<tr>
<td><strong>float</strong></td>
<td><code>substitute.变量 = substitute.getIntent().getFloatExtra($S, 变量)</code></td>
</tr>
<tr>
<td><strong>double</strong></td>
<td><code>substitute.变量 = substitute.getIntent().getDoubleExtra($S, 变量)</code></td>
</tr>
<tr>
<td><strong>string</strong></td>
<td><code>substitute.变量 = substitute.getIntent().getExtras() == null ? 变量 : substitute.getIntent().getExtras().getString($S, 变量)</code></td>
</tr>
<tr>
<td><strong>serializable</strong></td>
<td><code>substitute.变量 = (变量类型的全限定名) substitute.getIntent().getSerializableExtra($S)</code></td>
</tr>
<tr>
<td><strong>parcelable</strong></td>
<td><code>substitute.变量 = substitute.getIntent().getParcelableExtra($S)</code></td>
</tr>
<tr>
<td><strong>object</strong></td>
<td><code>serializationService.parseObject(substitute.getIntent().getStringExtra($S), new com.alibaba.android.arouter.facade.model.TypeWrapper&lt;$T&gt;(){}.getType())</code></td>
</tr>
</tbody>
</table>
<p>这里的 <code>$S, $T</code>，依然是作为占位符，并没有被替换成实体的类型；</p>
<ul>
<li><strong>Fragment</strong> - 生成的 statement</li>
</ul>
<table>
<thead>
<tr>
<th><strong>变量类型</strong></th>
<th><strong>动态生成的代码块</strong></th>
</tr>
</thead>
<tbody>
<tr>
<td><strong>boolean</strong></td>
<td><code>substitute.变量 = substitute.getArguments().getBoolean($S)</code></td>
</tr>
<tr>
<td><strong>byte</strong></td>
<td><code>substitute.变量 = substitute.getArguments().getByte($S)</code></td>
</tr>
<tr>
<td><strong>short</strong></td>
<td><code>substitute.变量 = substitute.getArguments().getShort($S)</code></td>
</tr>
<tr>
<td><strong>int</strong></td>
<td><code>substitute.变量 = substitute.getArguments().getInt($S)</code></td>
</tr>
<tr>
<td><strong>long</strong></td>
<td><code>substitute.变量 = substitute.getArguments().getLong($S)</code></td>
</tr>
<tr>
<td><strong>char</strong></td>
<td><code>substitute.变量 = substitute.getArguments().getChar($S)</code></td>
</tr>
<tr>
<td><strong>float</strong></td>
<td><code>substitute.变量 = substitute.getArguments().getFloat($S)</code></td>
</tr>
<tr>
<td><strong>double</strong></td>
<td><code>substitute.变量 = substitute.getArguments().getDouble($S)</code></td>
</tr>
<tr>
<td><strong>string</strong></td>
<td><code>substitute.变量 = substitute.getArguments().getString($S)</code></td>
</tr>
<tr>
<td><strong>serializable</strong></td>
<td><code>substitute.变量 = (变量类型的全限定名) substitute.getArguments().getSerializable($S)</code></td>
</tr>
<tr>
<td><strong>parcelable</strong></td>
<td><code>substitute.变量 = substitute.getArguments().getParcelable($S)</code></td>
</tr>
<tr>
<td><strong>object</strong></td>
<td><code>serializationService.parseObject(substitute.getArguments().getString($S), new com.alibaba.android.arouter.facade.model.TypeWrapper&lt;$T&gt;(){}.getType())</code></td>
</tr>
</tbody>
</table>
<p>这里的 <code>$S, $T</code>，依然是作为占位符，并没有被替换成实体的类型；</p>
<p>返回的 statement 会继续被处理！</p>
<h4 id="2-2-3-4-动态生成类"><a href="#2-2-3-4-动态生成类" class="headerlink" title="2.2.3.4 动态生成类"></a>2.2.3.4 动态生成类</h4><h5 id="2-2-3-4-1-模版信息"><a href="#2-2-3-4-1-模版信息" class="headerlink" title="2.2.3.4.1 模版信息"></a>2.2.3.4.1 模版信息</h5><p>我们来看一下，解析 AutoWired 后动态生成的 java 类的模版：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> 所属类所在的包;</span><br><span class="line"><span class="keyword">import</span> com.alibaba.android.arouter.facade.template.ISyringe;</span><br><span class="line"><span class="keyword">import</span> com.alibaba.android.arouter.facade.service.SerializationService;</span><br><span class="line"><span class="keyword">import</span> com.alibaba.android.arouter.launcher.ARouter;</span><br><span class="line"><span class="keyword">import</span> ... ... ...<span class="comment">// 省略掉其他的导入信息（变量类型等等）</span></span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> 所属类的类名$$<span class="title">ARouter</span>$$<span class="title">Root</span>$$<span class="title">Autowired</span> <span class="keyword">implements</span> <span class="title">ISyringe</span> </span>&#123;</span><br><span class="line">    <span class="keyword">private</span> SerializationService serializationService;</span><br><span class="line">  </span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">inject</span><span class="params">(Object target)</span> </span>&#123;</span><br><span class="line">           serializationService = ARouter.getInstance().navigation(SerializationService.class);</span><br><span class="line">           所属类的全限定名 substitute = (所属类的全限定名) target;</span><br><span class="line">           <span class="comment">// 实现了 .IProvider 的成员变量；</span></span><br><span class="line">           substitute.变量 = ARouter.getInstance().navigation(变量类型的全限定名.class);</span><br><span class="line">           substitute.变量 = (变量类型) ARouter.getInstance().build(Autowired.name).navigation();</span><br><span class="line">           <span class="comment">// Autowired 的 required 为 true 才有； </span></span><br><span class="line">           <span class="keyword">if</span> (substitute.变量 == <span class="keyword">null</span>) &#123;</span><br><span class="line">               <span class="keyword">throw</span> <span class="keyword">new</span> RuntimeException(...);</span><br><span class="line">           &#125;</span><br><span class="line">           </span><br><span class="line">           <span class="comment">// activity 的成员；</span></span><br><span class="line">           substitute.变量 = substitute.getIntent().getBooleanExtra(变量名/Autowired.name, substitute.变量);</span><br><span class="line">           substitute.变量 = substitute.getIntent().getByteExtra(变量名/Autowired.name, substitute.变量);</span><br><span class="line">           substitute.变量 = substitute.getIntent().getShortExtra(变量名/Autowired.name, substitute.变量);</span><br><span class="line">           substitute.变量 = substitute.getIntent().getIntExtra(变量名/Autowired.name, substitute.变量);</span><br><span class="line">           substitute.变量 = substitute.getIntent().getCharExtra(变量名/Autowired.name, substitute.变量);</span><br><span class="line">           substitute.变量 = substitute.getIntent().getFloatExtra(变量名/Autowired.name, substitute.变量);</span><br><span class="line">           substitute.变量 = substitute.getIntent().getDoubleExtra(变量名/Autowired.name, substitute.变量);</span><br><span class="line">           substitute.变量 = substitute.getIntent().getExtras() == <span class="keyword">null</span> ? substitute.变量 : substitute.getIntent().getExtras().getString(变量名/Autowired.name, substitute.变量);</span><br><span class="line">           substitute.变量 = (变量类型) substitute.getIntent().getSerializableExtra(变量名/Autowired.name);</span><br><span class="line">           substitute.变量 = substitute.getIntent().getParcelableExtra(变量名/Autowired.name);</span><br><span class="line">           substitute.变量 = serializationService.parseObject(substitute.getIntent().getStringExtra(变量名/Autowired.name), <span class="keyword">new</span> com.alibaba.android.arouter.facade.model.TypeWrapper&lt;变量类型&gt;()&#123;&#125;.getType());   </span><br><span class="line">      </span><br><span class="line">           <span class="comment">// fragment 的成员；</span></span><br><span class="line">           substitute.变量 = substitute.getArguments().getBoolean(变量名/Autowired.name);</span><br><span class="line">           substitute.变量 = substitute.getArguments().getByte(变量名/Autowired.name);</span><br><span class="line">           substitute.变量 = substitute.getArguments().getShort(变量名/Autowired.name);</span><br><span class="line">           substitute.变量 = substitute.getArguments().getInt(变量名/Autowired.name);</span><br><span class="line">           substitute.变量 = substitute.getArguments().getLong(变量名/Autowired.name);</span><br><span class="line">           substitute.变量 = substitute.getArguments().getChar(变量名/Autowired.name);</span><br><span class="line">           substitute.变量 = substitute.getArguments().getFloat(变量名/Autowired.name);</span><br><span class="line">           substitute.变量 = substitute.getArguments().getDouble(变量名/Autowired.name);</span><br><span class="line">           substitute.变量 = substitute.getArguments().getString(变量名/Autowired.name);</span><br><span class="line">           substitute.变量 = (变量类型) substitute.getArguments().getSerializable(变量名/Autowired.name);</span><br><span class="line">           substitute.变量 = substitute.getArguments().getParcelable(变量名/Autowired.name);</span><br><span class="line">           serializationService.parseObject(substitute.getArguments().getString(变量名/Autowired.name), <span class="keyword">new</span> com.alibaba.android.arouter.facade.model.TypeWrapper&lt;变量类型&gt;()&#123;&#125;.getType());</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>其实大家可以看的出来，inject 方法就是用来自动给成员变量赋值的；</p>
<h5 id="2-2-3-4-2-举个栗子"><a href="#2-2-3-4-2-举个栗子" class="headerlink" title="2.2.3.4.2 举个栗子"></a>2.2.3.4.2 举个栗子</h5><h6 id="2-2-3-4-2-1-实例代码"><a href="#2-2-3-4-2-1-实例代码" class="headerlink" title="2.2.3.4.2.1 实例代码"></a>2.2.3.4.2.1 实例代码</h6><p>以 activity 为例子；</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.lishuaiqi.test;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> android.app.Activity;</span><br><span class="line"><span class="keyword">import</span> android.os.Bundle;</span><br><span class="line"><span class="keyword">import</span> android.support.annotation.Nullable;</span><br><span class="line"><span class="keyword">import</span> com.alibaba.android.arouter.facade.annotation.Autowired;</span><br><span class="line"><span class="keyword">import</span> com.alibaba.android.arouter.facade.annotation.Route;</span><br><span class="line"><span class="keyword">import</span> com.alibaba.android.arouter.launcher.ARouter;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * Created by lishuaiqi</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="meta">@Route</span>(path = <span class="string">"/app/MyActivity"</span>)</span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">MyActivity</span> <span class="keyword">extends</span> <span class="title">Activity</span> </span>&#123;</span><br><span class="line">    <span class="meta">@Autowired</span>(name = <span class="string">"isOneAuto"</span>)</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">boolean</span> isOne;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Autowired</span>(name = <span class="string">"isTwoAuto"</span>)</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">int</span> isTwo;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title">onCreate</span><span class="params">(@Nullable Bundle savedInstanceState)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">super</span>.onCreate(savedInstanceState);</span><br><span class="line">        ARouter.getInstance().inject(<span class="keyword">this</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h6 id="2-2-3-4-2-2-动态代码"><a href="#2-2-3-4-2-2-动态代码" class="headerlink" title="2.2.3.4.2.2 动态代码"></a>2.2.3.4.2.2 动态代码</h6><p>如下是动态代码了，不多说了：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.lishuaiqi.test;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> com.alibaba.android.arouter.facade.service.SerializationService;</span><br><span class="line"><span class="keyword">import</span> com.alibaba.android.arouter.facade.template.ISyringe;</span><br><span class="line"><span class="keyword">import</span> com.alibaba.android.arouter.launcher.ARouter;</span><br><span class="line"><span class="keyword">import</span> java.lang.Object;</span><br><span class="line"><span class="keyword">import</span> java.lang.Override;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * DO NOT EDIT THIS FILE!!! IT WAS GENERATED BY AROUTER. */</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">MyActivity</span>$$<span class="title">ARouter</span>$$<span class="title">Autowired</span> <span class="keyword">implements</span> <span class="title">ISyringe</span> </span>&#123;</span><br><span class="line">  <span class="keyword">private</span> SerializationService serializationService;</span><br><span class="line"></span><br><span class="line">  <span class="meta">@Override</span></span><br><span class="line">  <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">inject</span><span class="params">(Object target)</span> </span>&#123;</span><br><span class="line">    serializationService = ARouter.getInstance().navigation(SerializationService.class);</span><br><span class="line">    MyActivity substitute = (MyActivity)target;</span><br><span class="line">    substitute.isOne = substitute.getIntent().getBooleanExtra(<span class="string">"isOneAuto"</span>, substitute.isOne);</span><br><span class="line">    substitute.isTwo = substitute.getIntent().getIntExtra(<span class="string">"isTwoAuto"</span>, substitute.isTwo);</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h3 id="2-2-4-InterceptorProcessor"><a href="#2-2-4-InterceptorProcessor" class="headerlink" title="2.2.4 InterceptorProcessor"></a>2.2.4 InterceptorProcessor</h3><p>核心解释器，用于处理 @Interceptor 注解：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@AutoService</span>(Processor.class)</span><br><span class="line"><span class="meta">@SupportedAnnotationTypes</span>(ANNOTATION_TYPE_INTECEPTOR)</span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">InterceptorProcessor</span> <span class="keyword">extends</span> <span class="title">BaseProcessor</span> </span>&#123;</span><br><span class="line">  	... ... ...</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>我们从成员变量，初始化，注解处理三个方面来分析：</p>
<h4 id="2-2-4-1-Field"><a href="#2-2-4-1-Field" class="headerlink" title="2.2.4.1 Field"></a>2.2.4.1 Field</h4><p>成员变量有两个：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//【1】用于保存 key: [priority 优先级] 和 value：[@Interceptor 修饰的元素 Element] 的映射关系，作为 cache； </span></span><br><span class="line"><span class="keyword">private</span> Map&lt;Integer, Element&gt; interceptors = <span class="keyword">new</span> TreeMap&lt;&gt;();</span><br><span class="line"><span class="comment">//【2】用于保存 [com.alibaba.android.arouter.facade.template.IInterceptor] 的类型信息</span></span><br><span class="line"><span class="keyword">private</span> TypeMirror iInterceptor = <span class="keyword">null</span>;</span><br></pre></td></tr></table></figure>
<h4 id="2-2-4-2-Init"><a href="#2-2-4-2-Init" class="headerlink" title="2.2.4.2 Init"></a>2.2.4.2 Init</h4><p>初始化操作：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">synchronized</span> <span class="keyword">void</span> <span class="title">init</span><span class="params">(ProcessingEnvironment processingEnv)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">super</span>.init(processingEnv);</span><br><span class="line">    <span class="comment">//【1】Elements.getTypeElement 会返回 .IInterceptor 接口对应的 TypeElement</span></span><br><span class="line">    <span class="comment">// TypeElement.sType() 会返回 .IInterceptor 的类型信息：接口</span></span><br><span class="line">    iInterceptor = elementUtils.getTypeElement(Consts.IINTERCEPTOR).asType();</span><br><span class="line">    logger.info(<span class="string">"&gt;&gt;&gt; InterceptorProcessor init. &lt;&lt;&lt;"</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>这里的 Consts.IINTERCEPTOR 是 IInterceptor 接口的全限定名：</p>
<blockquote>
<p><strong>com.alibaba.android.arouter.facade.template.IInterceptor</strong></p>
</blockquote>
<h4 id="2-2-4-3-Process-处理-Interceptor-注解"><a href="#2-2-4-3-Process-处理-Interceptor-注解" class="headerlink" title="2.2.4.3 Process - 处理 Interceptor 注解"></a>2.2.4.3 Process - 处理 Interceptor 注解</h4><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">boolean</span> <span class="title">process</span><span class="params">(Set&lt;? extends TypeElement&gt; annotations, RoundEnvironment roundEnv)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">if</span> (CollectionUtils.isNotEmpty(annotations)) &#123;</span><br><span class="line">        <span class="comment">//【1】获得 @Interceptor 修饰的元素，这里会返回多个 Element 组成的 set！！</span></span><br><span class="line">        Set&lt;? extends Element&gt; elements = roundEnv.getElementsAnnotatedWith(Interceptor.class);</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            <span class="comment">//【*2.2.4.3.1】解析元素：</span></span><br><span class="line">            parseInterceptors(elements);</span><br><span class="line">        &#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">            logger.error(e);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">true</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">false</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>核心逻辑在 parseInterceptors 中；</p>
<h5 id="2-2-4-3-1-parseInterceptors"><a href="#2-2-4-3-1-parseInterceptors" class="headerlink" title="2.2.4.3.1 parseInterceptors"></a>2.2.4.3.1 parseInterceptors</h5><p>我们来看下如何解析元素：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">parseInterceptors</span><span class="params">(Set&lt;? extends Element&gt; elements)</span> <span class="keyword">throws</span> IOException </span>&#123;</span><br><span class="line">    <span class="keyword">if</span> (CollectionUtils.isNotEmpty(elements)) &#123;</span><br><span class="line">        logger.info(<span class="string">"&gt;&gt;&gt; Found interceptors, size is "</span> + elements.size() + <span class="string">" &lt;&lt;&lt;"</span>);</span><br><span class="line"></span><br><span class="line">        <span class="comment">//【1】执行校验，并将元素缓存下来；</span></span><br><span class="line">        <span class="keyword">for</span> (Element element : elements) &#123;</span><br><span class="line">            <span class="comment">//【*2.2.4.3.1.1】执行校验；</span></span><br><span class="line">            <span class="keyword">if</span> (verify(element)) &#123;</span><br><span class="line">                logger.info(<span class="string">"A interceptor verify over, its "</span> + element.asType());</span><br><span class="line">                <span class="comment">//【1.1】获得 Interceptor 对象的优先级，判断是否已经添加到 interceptors 哈希表中，已经添加，抛出异常；</span></span><br><span class="line">                Interceptor interceptor = element.getAnnotation(Interceptor.class);</span><br><span class="line">                Element lastInterceptor = interceptors.get(interceptor.priority());</span><br><span class="line">                <span class="keyword">if</span> (<span class="keyword">null</span> != lastInterceptor) &#123; <span class="comment">// Added, throw exceptions</span></span><br><span class="line">                    <span class="keyword">throw</span> <span class="keyword">new</span> IllegalArgumentException(</span><br><span class="line">                            String.format(Locale.getDefault(), <span class="string">"More than one interceptors use same"</span> +  </span><br><span class="line">                                          <span class="string">"priority [%d], They are [%s] and [%s]."</span>,</span><br><span class="line">                                    interceptor.priority(),</span><br><span class="line">                                    lastInterceptor.getSimpleName(),</span><br><span class="line">                                    element.getSimpleName())</span><br><span class="line">                    );</span><br><span class="line">                &#125;</span><br><span class="line">                <span class="comment">//【1.2】将 priority --&gt; element 关系缓存到 interceptors 中；</span></span><br><span class="line">                interceptors.put(interceptor.priority(), element);</span><br><span class="line">            &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                logger.error(<span class="string">"A interceptor verify failed, its "</span> + element.asType());</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment">//【2】返回 ".IInterceptor/.IInterceptorGroup" 接口对应的 TypeElement，保存了接口在编译时期的状态信息；</span></span><br><span class="line">        TypeElement type_ITollgate = elementUtils.getTypeElement(IINTERCEPTOR);</span><br><span class="line">        TypeElement type_ITollgateGroup = elementUtils.getTypeElement(IINTERCEPTOR_GROUP);</span><br><span class="line"></span><br><span class="line">        <span class="comment">//【3】生成 loadInto 方法的参数类型："Map&lt;Integer, Class&lt;? extends ITollgate&gt;&gt;""</span></span><br><span class="line">        ParameterizedTypeName inputMapTypeOfTollgate = ParameterizedTypeName.get(</span><br><span class="line">                ClassName.get(Map.class),</span><br><span class="line">                ClassName.get(Integer.class),</span><br><span class="line">                ParameterizedTypeName.get(</span><br><span class="line">                        ClassName.get(Class.class),</span><br><span class="line">                        WildcardTypeName.subtypeOf(ClassName.get(type_ITollgate))</span><br><span class="line">                )</span><br><span class="line">        );</span><br><span class="line"></span><br><span class="line">        <span class="comment">//【4】生成 loadInto 方法的方法参数：“Map&lt;Integer, Class&lt;? extends ITollgate&gt;&gt; interceptors”</span></span><br><span class="line">        ParameterSpec tollgateParamSpec = ParameterSpec.builder(inputMapTypeOfTollgate, <span class="string">"interceptors"</span>).build();</span><br><span class="line"></span><br><span class="line">        <span class="comment">//【5】生成 loadInto 方法声明：</span></span><br><span class="line">        <span class="comment">// @Override</span></span><br><span class="line">        <span class="comment">// public void loadInto(Map&lt;Integer, Class&lt;? extends ITollgate&gt;&gt; interceptors)&#123;...&#125;</span></span><br><span class="line">        MethodSpec.Builder loadIntoMethodOfTollgateBuilder = MethodSpec.methodBuilder(METHOD_LOAD_INTO)</span><br><span class="line">                .addAnnotation(Override.class)</span><br><span class="line">                .addModifiers(PUBLIC)</span><br><span class="line">                .addParameter(tollgateParamSpec);</span><br><span class="line"></span><br><span class="line">        <span class="comment">//【6】生成 loadInto 方法体:</span></span><br><span class="line">        <span class="comment">// @Override</span></span><br><span class="line">        <span class="comment">// public void loadInto(Map&lt;Integer, Class&lt;? extends ITollgate&gt;&gt; interceptors)&#123;</span></span><br><span class="line">        <span class="comment">//      interceptors.put(priority, $T.class);</span></span><br><span class="line">        <span class="comment">// &#125;</span></span><br><span class="line">        <span class="keyword">if</span> (<span class="keyword">null</span> != interceptors &amp;&amp; interceptors.size() &gt; <span class="number">0</span>) &#123;</span><br><span class="line">            <span class="comment">// for 循环中 interceptors 是 InterceptorProcessor 的成员变量哦！用来保存所有的 interceptor；</span></span><br><span class="line">            <span class="comment">// $T 最终会被替换为自定义的 interceptor 的类全限定名；</span></span><br><span class="line">            <span class="keyword">for</span> (Map.Entry&lt;Integer, Element&gt; entry : interceptors.entrySet()) &#123;</span><br><span class="line">                loadIntoMethodOfTollgateBuilder.addStatement(<span class="string">"interceptors.put("</span> + entry.getKey() + <span class="string">", $T.class)"</span>,</span><br><span class="line">                                                             ClassName.get((TypeElement) entry.getValue()));</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment">//【7】生成最终的类文件，指定了包名，类名，修饰符，实现的接口等等；</span></span><br><span class="line">        <span class="comment">// 常量均定义在 Consts 中，具体的生成的类见下面……</span></span><br><span class="line">        JavaFile.builder(PACKAGE_OF_GENERATE_FILE,</span><br><span class="line">                TypeSpec.classBuilder(NAME_OF_INTERCEPTOR + SEPARATOR + moduleName)</span><br><span class="line">                        .addModifiers(PUBLIC)</span><br><span class="line">                        .addJavadoc(WARNING_TIPS)</span><br><span class="line">                        .addMethod(loadIntoMethodOfTollgateBuilder.build())</span><br><span class="line">                        .addSuperinterface(ClassName.get(type_ITollgateGroup))</span><br><span class="line">                        .build()</span><br><span class="line">        ).build().writeTo(mFiler);</span><br><span class="line"></span><br><span class="line">        logger.info(<span class="string">"&gt;&gt;&gt; Interceptor group write over. &lt;&lt;&lt;"</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>可以看到其是使用 javapoet 三方库来懂爱生成 .java 文件；</p>
<h6 id="2-2-4-3-1-1-verify"><a href="#2-2-4-3-1-1-verify" class="headerlink" title="2.2.4.3.1.1 verify"></a>2.2.4.3.1.1 verify</h6><p>校验元素和注解的正确性：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">boolean</span> <span class="title">verify</span><span class="params">(Element element)</span> </span>&#123;</span><br><span class="line">    <span class="comment">//【1】获得注解对象；</span></span><br><span class="line">    Interceptor interceptor = element.getAnnotation(Interceptor.class);</span><br><span class="line">    <span class="comment">//【2】元素 Element 必须被 Interceptor 注解修饰，</span></span><br><span class="line">    <span class="comment">// 并且其实现了 com.alibaba.android.arouter.facade.template.IInterceptor 接口；</span></span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">null</span> != interceptor &amp;&amp; ((TypeElement) element).getInterfaces().contains(iInterceptor);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>end～</p>
<h4 id="2-2-4-4-动态生成类"><a href="#2-2-4-4-动态生成类" class="headerlink" title="2.2.4.4 动态生成类"></a>2.2.4.4 <strong>动态生成类</strong></h4><h5 id="2-2-4-4-1-模版信息"><a href="#2-2-4-4-1-模版信息" class="headerlink" title="2.2.4.4.1 模版信息"></a>2.2.4.4.1 模版信息</h5><p>最终生成的 java 文件名为：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">ARouter$$Interceptors$$&#123;moduleName&#125;.java</span><br></pre></td></tr></table></figure>
<p>最终生成的模版类信息为：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.alibaba.android.arouter.routes;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> com.alibaba.android.arouter.facade.template.IInterceptor;</span><br><span class="line"><span class="keyword">import</span> com.alibaba.android.arouter.facade.template.IInterceptorGroup;</span><br><span class="line"><span class="keyword">import</span> java.lang.Class;</span><br><span class="line"><span class="keyword">import</span> java.lang.Integer;</span><br><span class="line"><span class="keyword">import</span> java.lang.Override;</span><br><span class="line"><span class="keyword">import</span> java.util.Map;</span><br><span class="line">... ... ...</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">ARouter</span>$$<span class="title">Interceptors</span>$$$</span>&#123;moduleName&#125; implements IInterceptorGroup &#123;</span><br><span class="line">   <span class="meta">@Override</span></span><br><span class="line">   <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">loadInto</span><span class="params">(Map&lt;Integer, Class&lt;? extends ITollgate&gt;&gt; interceptors)</span></span>&#123;</span><br><span class="line">     		interceptors.put($&#123;priority&#125;, $&#123;InterceptorName&#125;.class);</span><br><span class="line">   &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>可以看到，对于 Interceptor，ARouter 也是采取分组管理的方式：</p>
<ul>
<li>以 module 为组，组名为 <code>ARouter$$Interceptors$${moduleName}</code>；</li>
</ul>
<h5 id="2-2-4-4-2-举个栗子"><a href="#2-2-4-4-2-举个栗子" class="headerlink" title="2.2.4.4.2 举个栗子"></a>2.2.4.4.2 举个栗子</h5><h6 id="2-2-4-4-2-1-实例代码"><a href="#2-2-4-4-2-1-实例代码" class="headerlink" title="2.2.4.4.2.1 实例代码"></a>2.2.4.4.2.1 实例代码</h6><p>我们自定义了一个拦截器：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.lishuaiqi.test;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> android.content.Context;</span><br><span class="line"><span class="keyword">import</span> com.alibaba.android.arouter.facade.Postcard;</span><br><span class="line"><span class="keyword">import</span> com.alibaba.android.arouter.facade.annotation.Interceptor;</span><br><span class="line"><span class="keyword">import</span> com.alibaba.android.arouter.facade.callback.InterceptorCallback;</span><br><span class="line"><span class="keyword">import</span> com.alibaba.android.arouter.facade.template.IInterceptor;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * Created by lishuaiqi</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="meta">@Interceptor</span>(priority = <span class="number">8</span>, name = <span class="string">"测试用拦截器"</span>)</span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">TestInterceptor</span> <span class="keyword">implements</span> <span class="title">IInterceptor</span> </span>&#123;</span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">process</span><span class="params">(Postcard postcard, InterceptorCallback callback)</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">init</span><span class="params">(Context context)</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h6 id="2-2-4-4-2-2-动态代码"><a href="#2-2-4-4-2-2-动态代码" class="headerlink" title="2.2.4.4.2.2 动态代码"></a>2.2.4.4.2.2 动态代码</h6><p>看看最终的代码：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.alibaba.android.arouter.routes;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> com.alibaba.android.arouter.facade.template.IInterceptor;</span><br><span class="line"><span class="keyword">import</span> com.alibaba.android.arouter.facade.template.IInterceptorGroup;</span><br><span class="line"><span class="keyword">import</span> com.lishuaiqi.test.TestInterceptor;</span><br><span class="line"><span class="keyword">import</span> java.lang.Class;</span><br><span class="line"><span class="keyword">import</span> java.lang.Integer;</span><br><span class="line"><span class="keyword">import</span> java.lang.Override;</span><br><span class="line"><span class="keyword">import</span> java.util.Map;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * DO NOT EDIT THIS FILE!!! IT WAS GENERATED BY AROUTER. */</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">ARouter</span>$$<span class="title">Interceptors</span>$$<span class="title">Coolqi</span> <span class="keyword">implements</span> <span class="title">IInterceptorGroup</span> </span>&#123;</span><br><span class="line">  <span class="meta">@Override</span></span><br><span class="line">  <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">loadInto</span><span class="params">(Map&lt;Integer, Class&lt;? extends IInterceptor&gt;&gt; interceptors)</span> </span>&#123;</span><br><span class="line">    interceptors.put(<span class="number">8</span>, TestInterceptor.class);</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h2 id="2-3-utils"><a href="#2-3-utils" class="headerlink" title="2.3 utils"></a>2.3 utils</h2><p>该 package 下包含了一些工具类：</p>
<h3 id="2-3-1-Logger"><a href="#2-3-1-Logger" class="headerlink" title="2.3.1 Logger"></a>2.3.1 Logger</h3><p>用于打印 log 信息，调试使用；</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">Logger</span> </span>&#123;</span><br><span class="line">    <span class="keyword">private</span> Messager msg;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="title">Logger</span><span class="params">(Messager messager)</span> </span>&#123;</span><br><span class="line">        msg = messager;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">info</span><span class="params">(CharSequence info)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">if</span> (StringUtils.isNotEmpty(info)) &#123;</span><br><span class="line">            msg.printMessage(Diagnostic.Kind.NOTE, Consts.PREFIX_OF_LOGGER + info);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">error</span><span class="params">(CharSequence error)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">if</span> (StringUtils.isNotEmpty(error)) &#123;</span><br><span class="line">            msg.printMessage(Diagnostic.Kind.ERROR, Consts.PREFIX_OF_LOGGER + </span><br><span class="line">                             <span class="string">"An exception is encountered, ["</span> + error + <span class="string">"]"</span>);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">error</span><span class="params">(Throwable error)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">if</span> (<span class="keyword">null</span> != error) &#123;</span><br><span class="line">            msg.printMessage(Diagnostic.Kind.ERROR, Consts.PREFIX_OF_LOGGER + </span><br><span class="line">                             <span class="string">"An exception is encountered, ["</span> + error.getMessage() + <span class="string">"]"</span> + </span><br><span class="line">                             <span class="string">"\n"</span> + formatStackTrace(error.getStackTrace()));</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">warning</span><span class="params">(CharSequence warning)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">if</span> (StringUtils.isNotEmpty(warning)) &#123;</span><br><span class="line">            msg.printMessage(Diagnostic.Kind.WARNING, Consts.PREFIX_OF_LOGGER + warning);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">private</span> String <span class="title">formatStackTrace</span><span class="params">(StackTraceElement[] stackTrace)</span> </span>&#123;</span><br><span class="line">        StringBuilder sb = <span class="keyword">new</span> StringBuilder();</span><br><span class="line">        <span class="keyword">for</span> (StackTraceElement element : stackTrace) &#123;</span><br><span class="line">            sb.append(<span class="string">"    at "</span>).append(element.toString());</span><br><span class="line">            sb.append(<span class="string">"\n"</span>);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> sb.toString();</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure>
<p>方法都比较简单，就不多说了。</p>
<h3 id="2-3-2-TypeUtils"><a href="#2-3-2-TypeUtils" class="headerlink" title="2.3.2 TypeUtils"></a>2.3.2 TypeUtils</h3><p>该类是一个类型工具类，主要用于获取元素的类型，并对类型做一个转换；</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">TypeUtils</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> Types types;</span><br><span class="line">    <span class="keyword">private</span> TypeMirror parcelableType;</span><br><span class="line">    <span class="keyword">private</span> TypeMirror serializableType;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="title">TypeUtils</span><span class="params">(Types types, Elements elements)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">this</span>.types = types;</span><br><span class="line">        parcelableType = elements.getTypeElement(PARCELABLE).asType();</span><br><span class="line">        serializableType = elements.getTypeElement(SERIALIZABLE).asType();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//【1】可以看到，这个方法用于返回枚举常量的序数。这里的枚举常量是前面分析的 TypeKind.XXX</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">int</span> <span class="title">typeExchange</span><span class="params">(Element element)</span> </span>&#123;</span><br><span class="line">        TypeMirror typeMirror = element.asType();</span><br><span class="line"></span><br><span class="line">        <span class="comment">//【1】对于 private，类型这里直接处理；</span></span><br><span class="line">        <span class="keyword">if</span> (typeMirror.getKind().isPrimitive()) &#123;</span><br><span class="line">            <span class="keyword">return</span> element.asType().getKind().ordinal();</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">//【2】对于 no private 的类型，返回变量的类型，通过 TypeKind 找到类型对应的序数（0，1，2...）</span></span><br><span class="line">        <span class="keyword">switch</span> (typeMirror.toString()) &#123;</span><br><span class="line">            <span class="keyword">case</span> BYTE:</span><br><span class="line">                <span class="keyword">return</span> TypeKind.BYTE.ordinal();</span><br><span class="line">            <span class="keyword">case</span> SHORT:</span><br><span class="line">                <span class="keyword">return</span> TypeKind.SHORT.ordinal();</span><br><span class="line">            <span class="keyword">case</span> INTEGER:</span><br><span class="line">                <span class="keyword">return</span> TypeKind.INT.ordinal();</span><br><span class="line">            <span class="keyword">case</span> LONG:</span><br><span class="line">                <span class="keyword">return</span> TypeKind.LONG.ordinal();</span><br><span class="line">            <span class="keyword">case</span> FLOAT:</span><br><span class="line">                <span class="keyword">return</span> TypeKind.FLOAT.ordinal();</span><br><span class="line">            <span class="keyword">case</span> DOUBEL:</span><br><span class="line">                <span class="keyword">return</span> TypeKind.DOUBLE.ordinal();</span><br><span class="line">            <span class="keyword">case</span> BOOLEAN:</span><br><span class="line">                <span class="keyword">return</span> TypeKind.BOOLEAN.ordinal();</span><br><span class="line">            <span class="keyword">case</span> CHAR:</span><br><span class="line">                <span class="keyword">return</span> TypeKind.CHAR.ordinal();</span><br><span class="line">            <span class="keyword">case</span> STRING:</span><br><span class="line">                <span class="keyword">return</span> TypeKind.STRING.ordinal();</span><br><span class="line">            <span class="keyword">default</span>:</span><br><span class="line">                <span class="comment">//【3】处理 PARCELABLE，SERIALIZABLE 和 OBJECT 的情况；</span></span><br><span class="line">                <span class="keyword">if</span> (types.isSubtype(typeMirror, parcelableType)) &#123;</span><br><span class="line">                    <span class="comment">// PARCELABLE</span></span><br><span class="line">                    <span class="keyword">return</span> TypeKind.PARCELABLE.ordinal();</span><br><span class="line">                &#125; <span class="keyword">else</span> <span class="keyword">if</span> (types.isSubtype(typeMirror, serializableType)) &#123;</span><br><span class="line">                    <span class="comment">// SERIALIZABLE</span></span><br><span class="line">                    <span class="keyword">return</span> TypeKind.SERIALIZABLE.ordinal();</span><br><span class="line">                &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                    <span class="keyword">return</span> TypeKind.OBJECT.ordinal();</span><br><span class="line">                &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure>
<p>TypeKind 前面有分析过，其是一个枚举类！</p>
<h3 id="2-3-3-Consts"><a href="#2-3-3-Consts" class="headerlink" title="2.3.3 Consts"></a>2.3.3 Consts</h3><p>用于保存一些核心的常量，下面来看看核心的常量。</p>
<h4 id="2-3-3-1-Log-打印相关"><a href="#2-3-3-1-Log-打印相关" class="headerlink" title="2.3.3.1 Log 打印相关"></a>2.3.3.1 Log 打印相关</h4><p>这些是和 log 打印相关的，比较简单：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> String PROJECT = <span class="string">"ARouter"</span>; <span class="comment">// 这个常量其他常量也会用到；</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> String TAG = PROJECT + <span class="string">"::"</span>;</span><br><span class="line"><span class="keyword">static</span> <span class="keyword">final</span> String PREFIX_OF_LOGGER = PROJECT + <span class="string">"::Compiler "</span>;</span><br><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> String NO_MODULE_NAME_TIPS = <span class="string">"These no module name, at 'build.gradle', like :\n"</span> +</span><br><span class="line">  <span class="string">"android &#123;\n"</span> +</span><br><span class="line">  <span class="string">"    defaultConfig &#123;\n"</span> +</span><br><span class="line">  <span class="string">"        ...\n"</span> +</span><br><span class="line">  <span class="string">"        javaCompileOptions &#123;\n"</span> +</span><br><span class="line">  <span class="string">"            annotationProcessorOptions &#123;\n"</span> +</span><br><span class="line">  <span class="string">"                arguments = [AROUTER_MODULE_NAME: project.getName()]\n"</span> +</span><br><span class="line">  <span class="string">"            &#125;\n"</span> +</span><br><span class="line">  <span class="string">"        &#125;\n"</span> +</span><br><span class="line">  <span class="string">"    &#125;\n"</span> +</span><br><span class="line">  <span class="string">"&#125;\n"</span>;</span><br></pre></td></tr></table></figure>
<p>不多说！</p>
<h4 id="2-3-3-2-Gradle-配置相关"><a href="#2-3-3-2-Gradle-配置相关" class="headerlink" title="2.3.3.2 Gradle 配置相关"></a>2.3.3.2 Gradle 配置相关</h4><p>这些是和 gradle 配置相关的机制：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> String KEY_MODULE_NAME = <span class="string">"AROUTER_MODULE_NAME"</span>;</span><br><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> String KEY_GENERATE_DOC_NAME = <span class="string">"AROUTER_GENERATE_DOC"</span>;</span><br><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> String VALUE_ENABLE = <span class="string">"enable"</span>;</span><br></pre></td></tr></table></figure>
<p>这个前面有说过，通过 gradle 配置；</p>
<h4 id="2-3-3-3-系统核心类"><a href="#2-3-3-3-系统核心类" class="headerlink" title="2.3.3.3 系统核心类"></a>2.3.3.3 系统核心类</h4><p>这些是和 Android 系统的一些核心类有关，也是 ARouter 能够注解处理的类：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> String ACTIVITY = <span class="string">"android.app.Activity"</span>;</span><br><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> String FRAGMENT = <span class="string">"android.app.Fragment"</span>;</span><br><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> String FRAGMENT_V4 = <span class="string">"android.support.v4.app.Fragment"</span>;</span><br><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> String SERVICE = <span class="string">"android.app.Service"</span>;</span><br><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> String PARCELABLE = <span class="string">"android.os.Parcelable"</span>;</span><br></pre></td></tr></table></figure>
<p>可以看到，都是系统类的全限定名；</p>
<h4 id="2-3-3-4-注解类型"><a href="#2-3-3-4-注解类型" class="headerlink" title="2.3.3.4 注解类型"></a>2.3.3.4 注解类型</h4><p>这些是和 ARouter 的注解相关的常量：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> String FACADE_PACKAGE = <span class="string">"com.alibaba.android.arouter.facade"</span>;  <span class="comment">// 这个常量其他常量也会用到；</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> String ANNOTATION_TYPE_INTECEPTOR = FACADE_PACKAGE + <span class="string">".annotation.Interceptor"</span>;</span><br><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> String ANNOTATION_TYPE_ROUTE = FACADE_PACKAGE + <span class="string">".annotation.Route"</span>;</span><br><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> String ANNOTATION_TYPE_AUTOWIRED = FACADE_PACKAGE + <span class="string">".annotation.Autowired"</span>;</span><br></pre></td></tr></table></figure>
<p>可以看到，都是注解的全限定名；</p>
<h4 id="2-3-3-5-核心接口和类"><a href="#2-3-3-5-核心接口和类" class="headerlink" title="2.3.3.5 核心接口和类"></a>2.3.3.5 核心接口和类</h4><p>这些是和 ARouter 提供的一些核心接口：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//【1】用于指定不同的 package 目录，属于 arouter-api 模块；</span></span><br><span class="line"><span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> String FACADE_PACKAGE = <span class="string">"com.alibaba.android.arouter.facade"</span>;</span><br><span class="line"><span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> String TEMPLATE_PACKAGE = <span class="string">".template"</span>;</span><br><span class="line"><span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> String SERVICE_PACKAGE = <span class="string">".service"</span>;</span><br><span class="line"><span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> String MODEL_PACKAGE = <span class="string">".model"</span>;</span><br><span class="line"><span class="comment">//【2】下面是 arouter-api 模块的 template 包下的接口的全限定名；</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> String IPROVIDER = FACADE_PACKAGE + TEMPLATE_PACKAGE + <span class="string">".IProvider"</span>;</span><br><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> String IPROVIDER_GROUP = FACADE_PACKAGE + TEMPLATE_PACKAGE + <span class="string">".IProviderGroup"</span>;</span><br><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> String IINTERCEPTOR = FACADE_PACKAGE + TEMPLATE_PACKAGE + <span class="string">".IInterceptor"</span>;</span><br><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> String IINTERCEPTOR_GROUP = FACADE_PACKAGE + TEMPLATE_PACKAGE + <span class="string">".IInterceptorGroup"</span>;</span><br><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> String ITROUTE_ROOT = FACADE_PACKAGE + TEMPLATE_PACKAGE + <span class="string">".IRouteRoot"</span>;</span><br><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> String IROUTE_GROUP = FACADE_PACKAGE + TEMPLATE_PACKAGE + <span class="string">".IRouteGroup"</span>;</span><br><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> String ISYRINGE = FACADE_PACKAGE + TEMPLATE_PACKAGE + <span class="string">".ISyringe"</span>;</span><br><span class="line"><span class="comment">//【3】下面是 arouter-api 模块的 service 包下的服务的全限定名；</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> String JSON_SERVICE = FACADE_PACKAGE + SERVICE_PACKAGE + <span class="string">".SerializationService"</span>;</span><br><span class="line"><span class="comment">//【4】下面是 arouter-annotation 模块的 model 包下的服务的全限定名；</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> String TYPE_WRAPPER = FACADE_PACKAGE + MODEL_PACKAGE + <span class="string">".TypeWrapper"</span>;</span><br></pre></td></tr></table></figure>
<p>同样的，也是一些全限定名；</p>
<p>ARouter 的拦截器需要实现 IInterceptor 接口，服务需要实现 IProvider 接口；</p>
<p>同时，由于 ARouter 是分组管理的，所以拦截器和服务又会属于不同的组：拦截器组需要实现 IInterceptorGroup 接口，服务组需要实现 IProviderGroup 组；</p>
<p>对于跳转来说，也会有分组，跳转组需要实现 IRouteGroup，而所有的跳转组属于一个 root：IRouteRoot</p>
<h4 id="2-3-3-6-动态生成类"><a href="#2-3-3-6-动态生成类" class="headerlink" title="2.3.3.6 动态生成类"></a>2.3.3.6 动态生成类</h4><p>下面 这些是和动态生成的类相关的：</p>
<ul>
<li>动态生成类的类名；</li>
</ul>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> String SEPARATOR = <span class="string">"$$"</span>;</span><br><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> String PROJECT = <span class="string">"ARouter"</span>;</span><br><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> String METHOD_LOAD_INTO = <span class="string">"loadInto"</span>;</span><br><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> String METHOD_INJECT = <span class="string">"inject"</span>;</span><br><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> String NAME_OF_ROOT = PROJECT + SEPARATOR + <span class="string">"Root"</span>; <span class="comment">// ARouter$$Root</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> String NAME_OF_PROVIDER = PROJECT + SEPARATOR + <span class="string">"Providers"</span>; <span class="comment">// ARouter$$Providers</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> String NAME_OF_GROUP = PROJECT + SEPARATOR + <span class="string">"Group"</span> + SEPARATOR; <span class="comment">// ARouter$$Group$$</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> String NAME_OF_INTERCEPTOR = PROJECT + SEPARATOR + <span class="string">"Interceptors"</span>; <span class="comment">// ARouter$$Interceptors</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> String NAME_OF_AUTOWIRED = SEPARATOR + PROJECT + SEPARATOR + <span class="string">"Autowired"</span>; <span class="comment">//$$ARouter$$Root$$Autowired</span></span><br></pre></td></tr></table></figure>
<p>动态生成类的类名是通过 “$$” 将关键字拼接起来！</p>
<ul>
<li>动态生成类的所属包名；</li>
</ul>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> String PACKAGE_OF_GENERATE_FILE = <span class="string">"com.alibaba.android.arouter.routes"</span>;</span><br><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> String PACKAGE_OF_GENERATE_DOCS = <span class="string">"com.alibaba.android.arouter.docs"</span>;</span><br></pre></td></tr></table></figure>
<p>ARouter 会通过 javapoet 来动态生成对应的类，我们在分析 processor 的过程中就会看到。</p>
<h1 id="3-总结"><a href="#3-总结" class="headerlink" title="3 总结"></a>3 总结</h1><p>本篇文章分析了 arouter-compiler 模块的架构，arouter 内置的三种注解处理器，以及 arouter 注解的处理，动态类的生成。</p>
<p>好累～</p>
<p>后续上流程图吧～～对于个人收获也是很大的～～至少会自定义注解～～至少会动态生成代码了～～</p>
</div></article><div class="post-copyright"><div class="post-copyright__author"><span class="post-copyright-meta">文章作者: </span><span class="post-copyright-info"><a href="mailto:undefined">Coolqi.Li</a></span></div><div class="post-copyright__type"><span class="post-copyright-meta">文章链接: </span><span class="post-copyright-info"><a href="https://lishuaiqi.top/2019/04/19/ARouter3-arouter-compiler/">https://lishuaiqi.top/2019/04/19/ARouter3-arouter-compiler/</a></span></div><div class="post-copyright__notice"><span class="post-copyright-meta">版权声明: </span><span class="post-copyright-info">本博客所有文章除特别声明外，均采用 <a href="https://creativecommons.org/licenses/by-nc-sa/4.0/">CC BY-NC-SA 4.0</a> 许可协议。转载请注明来自 <a href="https://lishuaiqi.top">Coolqi`s Blog</a>！</span></div></div><div class="post-meta__tag-list"><a class="post-meta__tags" href="/tags/ARouter/">ARouter</a></div><div class="post-qr-code"><div class="post-qr-code-item"><img class="post-qr-code__img" src="/img/zfb.jpg"><div class="post-qr-code__desc">支付宝打赏</div></div><div class="post-qr-code-item"><img class="post-qr-code__img" src="/img/wechat.jpg"><div class="post-qr-code__desc">微信打赏</div></div></div><div class="social-share"></div><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/social-share.js@1.0.16/dist/css/share.min.css"><script src="https://cdn.jsdelivr.net/npm/social-share.js@1.0.16/dist/js/social-share.min.js"></script><nav id="pagination"><div class="prev-post pull-left"><a href="/2019/04/23/ARouter4-arouterInitCreate-arouter-api/"><i class="fa fa-chevron-left">  </i><span>ARouter 第四篇 - 路由初始化 (arouter-api)</span></a></div><div class="next-post pull-right"><a href="/2019/04/17/ARouter2-arouter-annotations/"><span>ARouter 第二篇 - 注解定义 (arouter-annotation)</span><i class="fa fa-chevron-right"></i></a></div></nav></div></div><footer><div class="layout" id="footer"><div class="copyright">&copy;2015 - 2020 By Coolqi.Li</div><div class="framework-info"><span>驱动 - </span><a href="http://hexo.io"><span>Hexo</span></a><span class="footer-separator">|</span><span>主题 - </span><a href="https://github.com/Molunerfinn/hexo-theme-melody"><span>Melody</span></a></div><div class="footer_custom_text">Hi, welcome to my <a href="https://lishuaiqi.top/">blog</a>!</div><div class="busuanzi"><script async src="https://busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script><span id="busuanzi_container_page_pv"><i class="fa fa-file-o"></i><span id="busuanzi_value_page_pv"></span><span></span></span></div></div></footer><i class="fa fa-arrow-up" id="go-up" aria-hidden="true"></i><script src="/js/third-party/anime.min.js"></script><script src="/js/third-party/jquery.min.js"></script><script src="/js/third-party/jquery.fancybox.min.js"></script><script src="/js/third-party/velocity.min.js"></script><script src="/js/third-party/velocity.ui.min.js"></script><script src="/js/utils.js?version=1.5.6"></script><script src="/js/fancybox.js?version=1.5.6"></script><script src="/js/sidebar.js?version=1.5.6"></script><script src="/js/copy.js?version=1.5.6"></script><script src="/js/fireworks.js?version=1.5.6"></script><script src="/js/transition.js?version=1.5.6"></script><script src="/js/scroll.js?version=1.5.6"></script><script src="/js/head.js?version=1.5.6"></script><script type="text/x-mathjax-config">MathJax.Hub.Config({
  tex2jax: {
    inlineMath: [ ['$','$'], ["\\(","\\)"]  ],
    processEscapes: true,
    skipTags: ['script', 'noscript', 'style', 'textarea', 'pre', 'code']
  },
  CommonHTML: {
    linebreaks: { automatic: true, width: "90% container" }
  },
  "HTML-CSS": { 
    linebreaks: { automatic: true, width: "90% container" }
  },
  "SVG": { 
    linebreaks: { automatic: true, width: "90% container" }
  }
});
</script><script type="text/x-mathjax-config">MathJax.Hub.Queue(function() {
  var all = MathJax.Hub.getAllJax(), i;
  for (i=0; i < all.length; i += 1) {
    all[i].SourceElement().parentNode.className += ' has-jax';
  }
});
</script><script src="https://cdn.jsdelivr.net/npm/mathjax/MathJax.js?config=TeX-AMS-MML_HTMLorMML"></script><script src="/js/search/local-search.js"></script><div class="search-dialog" id="local-search"><div class="search-dialog__title" id="local-search-title">本地搜索</div><div id="local-input-panel"><div id="local-search-input"><div class="local-search-box"><input class="local-search-box--input" placeholder="搜索文章"></div></div></div><hr><div id="local-search-results"><div id="local-hits"></div><div id="local-stats"><div class="local-search-stats__hr" id="hr"><span>由</span> <a href="https://github.com/wzpan/hexo-generator-search" style="color:#49B1F5;">hexo-generator-search</a>
 <span>提供支持</span></div></div></div><span class="search-close-button"><i class="fa fa-times"></i></span></div><div class="search-mask"></div></body></html>
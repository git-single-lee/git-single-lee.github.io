<!DOCTYPE html><html lang="zh-Hans"><head><meta name="generator" content="Hexo 3.9.0"><meta charset="UTF-8"><meta http-equiv="X-UA-Compatible" content="IE=edge"><meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1"><meta name="description" content="ViewDraw 第四篇 measure 流程分析"><meta name="keywords" content="ViewDraw"><meta name="author" content="Coolqi.Li"><meta name="copyright" content="Coolqi.Li"><title>ViewDraw 第四篇 measure 流程分析 | Coolqi`s Blog</title><link rel="shortcut icon" href="/img/favicon.ico"><link rel="stylesheet" href="/css/index.css?version=1.7.0"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/font-awesome@latest/css/font-awesome.min.css?version=1.7.0"><link rel="stylesheet" href="https://use.fontawesome.com/releases/v5.7.2/css/all.css?version=1.7.0"><meta name="format-detection" content="telephone=no"><meta http-equiv="x-dns-prefetch-control" content="on"><link rel="dns-prefetch" href="https://cdn.jsdelivr.net"><script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script><script>(adsbygoogle = window.adsbygoogle || []).push({
  google_ad_client: 'ca-pub-6845729157331145',
  enable_page_level_ads: 'true'
});
</script><link rel="dns-prefetch" href="https://hm.baidu.com"><script>var _hmt = _hmt || [];
(function() {
  var hm = document.createElement("script");
  hm.src = "https://hm.baidu.com/hm.js?b7acef5306e54116ad8a99e8b753a92d";
  var s = document.getElementsByTagName("script")[0]; 
  s.parentNode.insertBefore(hm, s);
})();</script><script>var GLOBAL_CONFIG = { 
  root: '/',
  algolia: undefined,
  localSearch: {"path":"search.xml","languages":{"hits_empty":"找不到您查询的内容:${query}"}},
  copy: {
    success: '复制成功',
    error: '复制错误',
    noSupport: '浏览器不支持'
  }
} </script></head><body><i class="fa fa-arrow-right" id="toggle-sidebar" aria-hidden="true"></i><div id="sidebar" data-display="true"><div class="toggle-sidebar-info text-center"><span data-toggle="切换文章详情">切换站点概览</span><hr></div><div class="sidebar-toc"><div class="sidebar-toc__title">目录</div><div class="sidebar-toc__progress"><span class="progress-notice">你已经读了</span><span class="progress-num">0</span><span class="progress-percentage">%</span><div class="sidebar-toc__progress-bar"></div></div><div class="sidebar-toc__content"><ol class="toc"><li class="toc-item toc-level-1"><a class="toc-link" href="#1-回顾"><span class="toc-text">1 回顾</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#1-1-MeasureSpec-测量规格"><span class="toc-text">1.1 MeasureSpec - 测量规格</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#1-1-1-测量模式"><span class="toc-text">1.1.1 测量模式</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#1-1-2-makeMeasureSpec"><span class="toc-text">1.1.2 makeMeasureSpec</span></a></li></ol></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#2-View"><span class="toc-text">2 View</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#2-1-measure-核心"><span class="toc-text">2.1 measure - 核心</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#2-2-onMeasure-核心"><span class="toc-text">2.2 onMeasure - 核心</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#2-2-1-setMeasuredDimension"><span class="toc-text">2.2.1 setMeasuredDimension</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#2-2-2-setMeasuredDimensionRaw"><span class="toc-text">2.2.2 setMeasuredDimensionRaw</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#2-2-3-getDefaultSize"><span class="toc-text">2.2.3 getDefaultSize</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#2-3-combineMeasuredStates"><span class="toc-text">2.3 combineMeasuredStates</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#2-4-getMeasuredState"><span class="toc-text">2.4 getMeasuredState</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#2-5-resolveSizeAndState"><span class="toc-text">2.5 resolveSizeAndState</span></a></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#3-DecorView"><span class="toc-text">3 DecorView</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#3-1-onMeasure-核心"><span class="toc-text">3.1 onMeasure - 核心</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#3-1-1-getMeasuredWidth"><span class="toc-text">3.1.1 getMeasuredWidth</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#3-1-2-getMode"><span class="toc-text">3.1.2 getMode</span></a></li></ol></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#4-FrameLayout"><span class="toc-text">4 FrameLayout</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#4-1-onMeasure-核心"><span class="toc-text">4.1 onMeasure - 核心</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#4-1-1-getChildCount"><span class="toc-text">4.1.1 getChildCount</span></a></li></ol></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#5-ViewGroup"><span class="toc-text">5 ViewGroup</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#5-1-measureChildWithMargins"><span class="toc-text">5.1 measureChildWithMargins</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#5-2-1-getChildMeasureSpec-核心"><span class="toc-text">5.2.1 getChildMeasureSpec - 核心</span></a></li></ol></li></ol></li></ol></div></div><div class="author-info hide"><div class="author-info__avatar text-center"><img src="/img/avatar.jpg"></div><div class="author-info__name text-center">Coolqi.Li</div><div class="author-info__description text-center">“Hi，我是李帅奇，Android 开发工程师，TeamLeader，熬夜星人，一个努力赚钱，积极向上的好人。”</div><div class="follow-button"><a href="https://github.com/single-li">Follow Me</a></div><hr><div class="author-info-articles"><a class="author-info-articles__archives article-meta" href="/archives"><span class="pull-left">文章</span><span class="pull-right">86</span></a><a class="author-info-articles__tags article-meta" href="/tags"><span class="pull-left">标签</span><span class="pull-right">21</span></a><a class="author-info-articles__categories article-meta" href="/categories"><span class="pull-left">分类</span><span class="pull-right">26</span></a></div><hr><div class="author-info-links"><div class="author-info-links__title text-center">Links</div><a class="author-info-links__name text-center" href="https://developer.android.google.cn/">AndroidDeveloper</a><a class="author-info-links__name text-center" href="http://www.android-studio.org/">AndroidStudio</a><a class="author-info-links__name text-center" href="https://www.jianshu.com/u/123a20a96441">简书</a><a class="author-info-links__name text-center" href="https://weibo.com/coolqiLi">微博</a></div></div></div><div id="content-outer"><div id="top-container" style="background-image: url(/img/blog-bg.jpg)"><div id="page-header"><span class="pull-left"> <a id="site-name" href="/">Coolqi`s Blog</a></span><i class="fa fa-bars toggle-menu pull-right" aria-hidden="true"></i><span class="pull-right menus">   <a class="site-page" href="/">Home</a><a class="site-page" href="/categories">Categories</a><a class="site-page" href="/tags">Tags</a><a class="site-page" href="/archives">Archives</a><a class="site-page" href="/about">About</a></span><span class="pull-right"><a class="site-page social-icon search"><i class="fa fa-search"></i><span> 搜索</span></a></span></div><div id="post-info"><div id="post-title">ViewDraw 第四篇 measure 流程分析</div><div id="post-meta"><time class="post-meta__date"><i class="fa fa-calendar" aria-hidden="true"></i> 2020-04-15</time><span class="post-meta__separator">|</span><i class="fa fa-inbox post-meta__icon" aria-hidden="true"></i><a class="post-meta__categories" href="/categories/View-视图/">View 视图</a><i class="fa fa-angle-right" aria-hidden="true"></i><i class="fa fa-inbox post-meta__icon" aria-hidden="true"></i><a class="post-meta__categories" href="/categories/View-视图/View-的加载和绘制/">View 的加载和绘制</a><div class="post-meta-wordcount"><span>字数总计: </span><span class="word-count">4.9k</span><span class="post-meta__separator">|</span><span>阅读时长: 21 分钟</span></div></div></div></div><div class="layout" id="content-inner"><article id="post"><div class="article-container" id="post-content"><p>本篇文章基于 Android N - 7.1.1 主要分析下 measure 方法的执行流程；</p>
<h1 id="1-回顾"><a href="#1-回顾" class="headerlink" title="1 回顾"></a>1 回顾</h1><p>我们来回顾下，performMeasure 请求测量的地方：</p>
<p>这里的参数：childWidthMeasureSpec 和 childHeightMeasureSpec 是 root view 也就是 DecorView 的测量标准！</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">performMeasure</span><span class="params">(<span class="keyword">int</span> childWidthMeasureSpec, <span class="keyword">int</span> childHeightMeasureSpec)</span> </span>&#123;</span><br><span class="line">    Trace.traceBegin(Trace.TRACE_TAG_VIEW, <span class="string">"measure"</span>);</span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">        <span class="comment">//【--&gt;2.1】最终调用了 DecorView（ViewGroup）的 measure 方法，并讲自身的测量规范传递下去；</span></span><br><span class="line">        mView.measure(childWidthMeasureSpec, childHeightMeasureSpec);</span><br><span class="line">    &#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">        Trace.traceEnd(Trace.TRACE_TAG_VIEW);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>mView 就是我们 DecorView，然而 DecorView 有如下的继承实现关系：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">DecorView</span> <span class="keyword">extends</span> <span class="title">FrameLayout</span> <span class="keyword">implements</span> <span class="title">RootViewSurfaceTaker</span>, <span class="title">WindowCallbacks</span> </span>&#123;</span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">FrameLayout</span> <span class="keyword">extends</span> <span class="title">ViewGroup</span> </span>&#123;</span><br><span class="line"><span class="keyword">public</span> <span class="keyword">abstract</span> <span class="class"><span class="keyword">class</span> <span class="title">ViewGroup</span> <span class="keyword">extends</span> <span class="title">View</span> <span class="keyword">implements</span> <span class="title">ViewParent</span>, <span class="title">ViewManager</span> </span>&#123;</span><br></pre></td></tr></table></figure>
<p>实际上 measure 是 view 的方法！</p>
<h2 id="1-1-MeasureSpec-测量规格"><a href="#1-1-MeasureSpec-测量规格" class="headerlink" title="1.1 MeasureSpec - 测量规格"></a>1.1 MeasureSpec - 测量规格</h2><p>MeasureSpec 是 View 的内部类。他表示一种测量规格，是<strong>父布局传递给子布局的布局要求</strong>。</p>
<h3 id="1-1-1-测量模式"><a href="#1-1-1-测量模式" class="headerlink" title="1.1.1 测量模式"></a>1.1.1 测量模式</h3><ul>
<li><strong>UNSPECIFIED</strong>：不对 View 大小做限制，例如：ListView，ScrollView</li>
</ul>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment">   父视图没有对 child 施加任何约束。它可以是任何大小；</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="keyword">int</span> UNSPECIFIED = <span class="number">0</span> &lt;&lt; MODE_SHIFT;</span><br></pre></td></tr></table></figure>
<ul>
<li><strong>EXACTLY</strong>：确切的大小，例如：100dp 或者 march_parent</li>
</ul>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment">   父视图已经确定了孩子的确切尺寸。不管孩子想要多大，都会给孩子以这些界限；</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="keyword">int</span> EXACTLY     = <span class="number">1</span> &lt;&lt; MODE_SHIFT;</span><br></pre></td></tr></table></figure>
<ul>
<li><strong>AT_MOST</strong>：大小不可超过某数值，例如：wrap_content</li>
</ul>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment">   child 可以根据自身需要的大小而确定大小，但是存在上限，上限一般为父视图大小。</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="keyword">int</span> AT_MOST     = <span class="number">2</span> &lt;&lt; MODE_SHIFT;</span><br></pre></td></tr></table></figure>
<h3 id="1-1-2-makeMeasureSpec"><a href="#1-1-2-makeMeasureSpec" class="headerlink" title="1.1.2 makeMeasureSpec"></a>1.1.2 makeMeasureSpec</h3><p>根据提供的大小和模式创建度量规范：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">int</span> <span class="title">makeMeasureSpec</span><span class="params">(@IntRange(from = <span class="number">0</span>, to = (<span class="number">1</span> &lt;&lt; MeasureSpec.MODE_SHIFT)</span> - 1) <span class="keyword">int</span> size,</span></span><br><span class="line"><span class="function">                                  @MeasureSpecMode <span class="keyword">int</span> mode) </span>&#123;</span><br><span class="line">    <span class="comment">//【1】使用旧的（破碎的）方式建立 MeasureSpecs，sUseBrokenMakeMeasureSpec 值为 false。</span></span><br><span class="line">    <span class="keyword">if</span> (sUseBrokenMakeMeasureSpec) &#123; </span><br><span class="line">        <span class="keyword">return</span> size + mode;</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        <span class="comment">//【2】模式占高 2 位，大小占低 30 位，合成 MeasureSpec</span></span><br><span class="line">        <span class="keyword">return</span> (size &amp; ~MODE_MASK) | (mode &amp; MODE_MASK);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>我们知道，MeasureSpec 是 32 位的  Int 型，高两位表示 mode，低 30 位表示 size，这里的 MODE_MASK 的作用实际上就是做位操作！</p>
<p>MODE_MASK 取如下的值：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="keyword">int</span> MODE_SHIFT = <span class="number">30</span>;</span><br><span class="line"><span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="keyword">int</span> MODE_MASK  = <span class="number">0x3</span> &lt;&lt; MODE_SHIFT;</span><br></pre></td></tr></table></figure>
<p>其中 0x3 是十六进制，转为二进制是 11，向左移位30，结果是 11000…..0000（一共 30 个 0）！</p>
<ul>
<li>size &amp; ~MODE_MASK：获取 size 的低 30 位；</li>
<li>mode &amp; MODE_MASK：获取 mode 的高两位；</li>
</ul>
<p>最终合成度量规格；</p>
<h1 id="2-View"><a href="#2-View" class="headerlink" title="2 View"></a>2 View</h1><h2 id="2-1-measure-核心"><a href="#2-1-measure-核心" class="headerlink" title="2.1 measure - 核心"></a>2.1 measure - 核心</h2><p>我们看看 measure 方法，参数 childWidthMeasureSpec 和 childHeightMeasureSpec 是 root view 也就是 DecorView 的设置的子 view 的测量标准！</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br></pre></td><td class="code"><pre><span class="line">  <span class="function"><span class="keyword">public</span> <span class="keyword">final</span> <span class="keyword">void</span> <span class="title">measure</span><span class="params">(<span class="keyword">int</span> widthMeasureSpec, <span class="keyword">int</span> heightMeasureSpec)</span> </span>&#123;</span><br><span class="line">      <span class="keyword">boolean</span> optical = isLayoutModeOptical(<span class="keyword">this</span>);</span><br><span class="line">      <span class="keyword">if</span> (optical != isLayoutModeOptical(mParent)) &#123; <span class="comment">// 这里是对其做一个调整，我们先不看；</span></span><br><span class="line">          Insets insets = getOpticalInsets();</span><br><span class="line">          <span class="keyword">int</span> oWidth  = insets.left + insets.right;</span><br><span class="line">          <span class="keyword">int</span> oHeight = insets.top  + insets.bottom;</span><br><span class="line">          widthMeasureSpec  = MeasureSpec.adjust(widthMeasureSpec,  optical ? -oWidth  : oWidth);</span><br><span class="line">          heightMeasureSpec = MeasureSpec.adjust(heightMeasureSpec, optical ? -oHeight : oHeight);</span><br><span class="line">      &#125;</span><br><span class="line"></span><br><span class="line">      <span class="comment">//【1】计算缓存的 key，高 32 低 32 位交错取值；</span></span><br><span class="line">      <span class="keyword">long</span> key = (<span class="keyword">long</span>) widthMeasureSpec &lt;&lt; <span class="number">32</span> | (<span class="keyword">long</span>) heightMeasureSpec &amp; <span class="number">0xffffffffL</span>;</span><br><span class="line">      <span class="keyword">if</span> (mMeasureCache == <span class="keyword">null</span>) mMeasureCache = <span class="keyword">new</span> LongSparseLongArray(<span class="number">2</span>);</span><br><span class="line">      <span class="comment">//【2】判断是否强制布局；</span></span><br><span class="line">      <span class="keyword">final</span> <span class="keyword">boolean</span> forceLayout = (mPrivateFlags &amp; PFLAG_FORCE_LAYOUT) == PFLAG_FORCE_LAYOUT;</span><br><span class="line"></span><br><span class="line">      <span class="comment">// Optimize layout by avoiding an extra EXACTLY pass when the view is</span></span><br><span class="line">      <span class="comment">// already measured as the correct size. In API 23 and below, this</span></span><br><span class="line">      <span class="comment">// extra pass is required to make LinearLayout re-distribute weight.</span></span><br><span class="line">      <span class="comment">// 如果视图已经被测量获得了正确的尺寸，那么这里会判断下测量模式是否是 EXACTLY 如果是的话，那么就可能不会重新测量；</span></span><br><span class="line">      <span class="comment">// 在 API 23 及以下版本中，需要这样的额外遍历才能使 LinearLayout 重新分配权重。</span></span><br><span class="line">      <span class="keyword">final</span> <span class="keyword">boolean</span> specChanged = widthMeasureSpec != mOldWidthMeasureSpec</span><br><span class="line">              || heightMeasureSpec != mOldHeightMeasureSpec; <span class="comment">// 测量标准是否变化</span></span><br><span class="line">      <span class="keyword">final</span> <span class="keyword">boolean</span> isSpecExactly = MeasureSpec.getMode(widthMeasureSpec) == MeasureSpec.EXACTLY</span><br><span class="line">              &amp;&amp; MeasureSpec.getMode(heightMeasureSpec) == MeasureSpec.EXACTLY; <span class="comment">// 是否是精确布局</span></span><br><span class="line">      <span class="keyword">final</span> <span class="keyword">boolean</span> matchesSpecSize = getMeasuredWidth() == MeasureSpec.getSize(widthMeasureSpec)</span><br><span class="line">              &amp;&amp; getMeasuredHeight() == MeasureSpec.getSize(heightMeasureSpec); <span class="comment">// 尺寸是否变化</span></span><br><span class="line">      <span class="keyword">final</span> <span class="keyword">boolean</span> needsLayout = specChanged <span class="comment">// 判断是否需要布局；</span></span><br><span class="line">              &amp;&amp; (sAlwaysRemeasureExactly || !isSpecExactly || !matchesSpecSize);</span><br><span class="line"></span><br><span class="line">      <span class="keyword">if</span> (forceLayout || needsLayout) &#123;</span><br><span class="line">          <span class="comment">// 这里会清除掉测量的标志位 measured dimension flag；</span></span><br><span class="line">          mPrivateFlags &amp;= ~PFLAG_MEASURED_DIMENSION_SET;</span><br><span class="line"></span><br><span class="line">          resolveRtlPropertiesIfNeeded(); <span class="comment">// 处理 RTL 左右翻转属性；</span></span><br><span class="line">          </span><br><span class="line">          <span class="comment">//【3】判断是否需要使用缓存，forceLayout 的话，或者忽视缓存的话，那就会使用本次新的测量模式；</span></span><br><span class="line">          <span class="keyword">int</span> cacheIndex = forceLayout ? -<span class="number">1</span> : mMeasureCache.indexOfKey(key);</span><br><span class="line">          <span class="keyword">if</span> (cacheIndex &lt; <span class="number">0</span> || sIgnoreMeasureCache) &#123;</span><br><span class="line">              <span class="comment">//【--&gt;3.1】开始测量自身，这里会把清除掉测量的标志位 measured dimension flag 设置回去；</span></span><br><span class="line">              <span class="comment">// 这里会先调用 DecorView 的 onMeasure 方法；</span></span><br><span class="line">              onMeasure(widthMeasureSpec, heightMeasureSpec);</span><br><span class="line">              mPrivateFlags3 &amp;= ~PFLAG3_MEASURE_NEEDED_BEFORE_LAYOUT;</span><br><span class="line">          &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">              <span class="keyword">long</span> value = mMeasureCache.valueAt(cacheIndex);</span><br><span class="line">              <span class="comment">// Casting a long to int drops the high 32 bits, no mask needed</span></span><br><span class="line">              setMeasuredDimensionRaw((<span class="keyword">int</span>) (value &gt;&gt; <span class="number">32</span>), (<span class="keyword">int</span>) value);</span><br><span class="line">              mPrivateFlags3 |= PFLAG3_MEASURE_NEEDED_BEFORE_LAYOUT;</span><br><span class="line">          &#125;</span><br><span class="line"></span><br><span class="line">          <span class="comment">// 如果 measured dimension flag 没有设置或者 setMeasuredDimension 方法咩有执行，抛出异常；</span></span><br><span class="line">          <span class="keyword">if</span> ((mPrivateFlags &amp; PFLAG_MEASURED_DIMENSION_SET) != PFLAG_MEASURED_DIMENSION_SET) &#123;</span><br><span class="line">              <span class="keyword">throw</span> <span class="keyword">new</span> IllegalStateException(<span class="string">"View with id "</span> + getId() + <span class="string">": "</span></span><br><span class="line">                      + getClass().getName() + <span class="string">"#onMeasure() did not set the"</span></span><br><span class="line">                      + <span class="string">" measured dimension by calling"</span></span><br><span class="line">                      + <span class="string">" setMeasuredDimension()"</span>);</span><br><span class="line">          &#125;</span><br><span class="line"></span><br><span class="line">          mPrivateFlags |= PFLAG_LAYOUT_REQUIRED; <span class="comment">// 设置需要布局的标志</span></span><br><span class="line">      &#125;</span><br><span class="line"><span class="comment">// 保存本次的测量模式；</span></span><br><span class="line">      mOldWidthMeasureSpec = widthMeasureSpec;</span><br><span class="line">      mOldHeightMeasureSpec = heightMeasureSpec;</span><br><span class="line"></span><br><span class="line">      <span class="comment">// 将其保存到布局缓存中；</span></span><br><span class="line">      mMeasureCache.put(key, ((<span class="keyword">long</span>) mMeasuredWidth) &lt;&lt; <span class="number">32</span> |</span><br><span class="line">              (<span class="keyword">long</span>) mMeasuredHeight &amp; <span class="number">0xffffffffL</span>); <span class="comment">// suppress sign extension</span></span><br><span class="line">  &#125;</span><br></pre></td></tr></table></figure>
<p>执行测量！</p>
<h2 id="2-2-onMeasure-核心"><a href="#2-2-onMeasure-核心" class="headerlink" title="2.2 onMeasure - 核心"></a>2.2 onMeasure - 核心</h2><p>view 的 onMeasure 实际上很简单：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title">onMeasure</span><span class="params">(<span class="keyword">int</span> widthMeasureSpec, <span class="keyword">int</span> heightMeasureSpec)</span> </span>&#123;</span><br><span class="line">    <span class="comment">//【--&gt;2.2.1】设置测量后的宽高像素值；</span></span><br><span class="line">    <span class="comment">//【--&gt;2.2.3】获取默认的宽/高；</span></span><br><span class="line">    setMeasuredDimension(getDefaultSize(getSuggestedMinimumWidth(), widthMeasureSpec),</span><br><span class="line">            getDefaultSize(getSuggestedMinimumHeight(), heightMeasureSpec));</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>该方法用于测量视图及其内容，以确定测量的宽度和测量的高度。 </p>
<p>measure 方法会调用此方法，并且子类必须重写此方法，同时提供对其自身的准确测量。</p>
<p>复写此方法时， 必须调用 setMeasuredDimension 来存储此视图的测量宽度和高度。否则，将抛出 IllegalStateException 的异常。</p>
<p>调用超类的 onMeasure 是有效的用法。</p>
<p>子类应重写 onMeasure，以提供对其内容更好的度量。</p>
<p>如果重写此方法，则子类必须要确保测量的高度和宽度至少为视图的最小高度和宽度 getSuggestedMinimumHeight  getSuggestedMinimumWidth</p>
<h3 id="2-2-1-setMeasuredDimension"><a href="#2-2-1-setMeasuredDimension" class="headerlink" title="2.2.1 setMeasuredDimension"></a>2.2.1 setMeasuredDimension</h3><p>存储测量的宽度和测量的高度：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">protected</span> <span class="keyword">final</span> <span class="keyword">void</span> <span class="title">setMeasuredDimension</span><span class="params">(<span class="keyword">int</span> measuredWidth, <span class="keyword">int</span> measuredHeight)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">boolean</span> optical = isLayoutModeOptical(<span class="keyword">this</span>);</span><br><span class="line">    <span class="keyword">if</span> (optical != isLayoutModeOptical(mParent)) &#123; <span class="comment">// 这部份是根据 outInsert 调整；</span></span><br><span class="line">        Insets insets = getOpticalInsets();</span><br><span class="line">        <span class="keyword">int</span> opticalWidth  = insets.left + insets.right;</span><br><span class="line">        <span class="keyword">int</span> opticalHeight = insets.top  + insets.bottom;</span><br><span class="line"></span><br><span class="line">        measuredWidth  += optical ? opticalWidth  : -opticalWidth;</span><br><span class="line">        measuredHeight += optical ? opticalHeight : -opticalHeight;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">//【--&gt;2.2.2】继续设置；</span></span><br><span class="line">    setMeasuredDimensionRaw(measuredWidth, measuredHeight);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>这个方法必须要被 onMeasure(int, int) 调用，不然的话会抛出异常；</p>
<h3 id="2-2-2-setMeasuredDimensionRaw"><a href="#2-2-2-setMeasuredDimensionRaw" class="headerlink" title="2.2.2 setMeasuredDimensionRaw"></a>2.2.2 setMeasuredDimensionRaw</h3><p>存储测量的宽度和测量的高度：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">setMeasuredDimensionRaw</span><span class="params">(<span class="keyword">int</span> measuredWidth, <span class="keyword">int</span> measuredHeight)</span> </span>&#123;</span><br><span class="line">    mMeasuredWidth = measuredWidth;</span><br><span class="line">    mMeasuredHeight = measuredHeight;</span><br><span class="line">    <span class="comment">//【1】更新标志位，不然上面会抛异常的；</span></span><br><span class="line">    mPrivateFlags |= PFLAG_MEASURED_DIMENSION_SET;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h3 id="2-2-3-getDefaultSize"><a href="#2-2-3-getDefaultSize" class="headerlink" title="2.2.3 getDefaultSize"></a>2.2.3 getDefaultSize</h3><p>参数 size 表示的是这个 view 想显示的大小，measureSpec 则是 parent view 指定的测量约束，返回值表示这个 view 实际的大小: </p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">int</span> <span class="title">getDefaultSize</span><span class="params">(<span class="keyword">int</span> size, <span class="keyword">int</span> measureSpec)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">int</span> result = size;</span><br><span class="line">    <span class="comment">//【1】获取测量约束指定的模式和距离；</span></span><br><span class="line">    <span class="keyword">int</span> specMode = MeasureSpec.getMode(measureSpec);</span><br><span class="line">    <span class="keyword">int</span> specSize = MeasureSpec.getSize(measureSpec);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">switch</span> (specMode) &#123;</span><br><span class="line">    <span class="comment">//【2】如果是 UNSPECIFIED 数值取自己的最小值；</span></span><br><span class="line">    <span class="keyword">case</span> MeasureSpec.UNSPECIFIED:</span><br><span class="line">        result = size;</span><br><span class="line">        <span class="keyword">break</span>;</span><br><span class="line">    <span class="comment">//【3】如果是其他的两种情况，取测量约束指定的大小；       </span></span><br><span class="line">    <span class="keyword">case</span> MeasureSpec.AT_MOST:</span><br><span class="line">    <span class="keyword">case</span> MeasureSpec.EXACTLY:</span><br><span class="line">        result = specSize;</span><br><span class="line">        <span class="keyword">break</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> result;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h2 id="2-3-combineMeasuredStates"><a href="#2-3-combineMeasuredStates" class="headerlink" title="2.3 combineMeasuredStates"></a>2.3 combineMeasuredStates</h2><p>合并测量状态，</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">int</span> <span class="title">combineMeasuredStates</span><span class="params">(<span class="keyword">int</span> curState, <span class="keyword">int</span> newState)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">return</span> curState | newState;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h2 id="2-4-getMeasuredState"><a href="#2-4-getMeasuredState" class="headerlink" title="2.4 getMeasuredState"></a>2.4 getMeasuredState</h2><p>返回测量状态（宽和高），返回值是一个复合整数：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">final</span> <span class="keyword">int</span> <span class="title">getMeasuredState</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    <span class="comment">// MEASURED_STATE_MASK 为 0xff000000，高 8 位都是 1；</span></span><br><span class="line">    <span class="keyword">return</span> (mMeasuredWidth&amp;MEASURED_STATE_MASK)</span><br><span class="line">            | ((mMeasuredHeight&gt;&gt;MEASURED_HEIGHT_STATE_SHIFT)</span><br><span class="line">                    &amp; (MEASURED_STATE_MASK&gt;&gt;MEASURED_HEIGHT_STATE_SHIFT));</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>int 是 32 位，可以看到，这里用左起高 8 位存储宽的测量状态，将 mMeasuredHeight 右移了 16 位，左起第三个 8 位存储高的测量状态</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * Bit shift of &#123;<span class="doctag">@link</span> #MEASURED_STATE_MASK&#125; to get to the height bits</span></span><br><span class="line"><span class="comment"> * for functions that combine both width and height into a single int,</span></span><br><span class="line"><span class="comment"> * such as &#123;<span class="doctag">@link</span> #getMeasuredState()&#125; and the childState argument of</span></span><br><span class="line"><span class="comment"> * &#123;<span class="doctag">@link</span> #resolveSizeAndState(int, int, int)&#125;.</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="keyword">int</span> MEASURED_HEIGHT_STATE_SHIFT = <span class="number">16</span>; <span class="comment">// 用于将高的测量值右移 16 位；</span></span><br></pre></td></tr></table></figure>
<h2 id="2-5-resolveSizeAndState"><a href="#2-5-resolveSizeAndState" class="headerlink" title="2.5 resolveSizeAndState"></a>2.5 resolveSizeAndState</h2><p>参数 size 表示的是这个 view 想显示的大小；measureSpec 则是 parent view 指定的测量约束；childMeasur；edState 为 child view 的测量状态</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">int</span> <span class="title">resolveSizeAndState</span><span class="params">(<span class="keyword">int</span> size, <span class="keyword">int</span> measureSpec, <span class="keyword">int</span> childMeasuredState)</span> </span>&#123;</span><br><span class="line">    <span class="comment">//【1】获取测量约束指定的测量模式和测量大小；</span></span><br><span class="line">    <span class="keyword">final</span> <span class="keyword">int</span> specMode = MeasureSpec.getMode(measureSpec);</span><br><span class="line">    <span class="keyword">final</span> <span class="keyword">int</span> specSize = MeasureSpec.getSize(measureSpec);</span><br><span class="line">    <span class="keyword">final</span> <span class="keyword">int</span> result;</span><br><span class="line">    <span class="keyword">switch</span> (specMode) &#123;</span><br><span class="line">        <span class="comment">//【2】这里是确定具体的测量距离，会根据测量模式调整实际的大小</span></span><br><span class="line">        <span class="keyword">case</span> MeasureSpec.AT_MOST:</span><br><span class="line">            <span class="keyword">if</span> (specSize &lt; size) &#123;</span><br><span class="line">                <span class="comment">//【2.1】测量约束指定的 size 小于 view 想要的 size，那么为 specSize，同时设置 too small 标志位</span></span><br><span class="line">                result = specSize | MEASURED_STATE_TOO_SMALL;</span><br><span class="line">            &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                <span class="comment">// 否则为 size</span></span><br><span class="line">                result = size;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line">        <span class="keyword">case</span> MeasureSpec.EXACTLY:</span><br><span class="line">            <span class="comment">//【2.2】测量模式为 EXACTLY，那么位</span></span><br><span class="line">            result = specSize;</span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line">            <span class="comment">//【2.3】未指定为 size</span></span><br><span class="line">        <span class="keyword">case</span> MeasureSpec.UNSPECIFIED:</span><br><span class="line">        <span class="keyword">default</span>:</span><br><span class="line">            result = size;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// 最后的结果是一个复合整数，这里会 | 上 child 的状态；</span></span><br><span class="line">    <span class="keyword">return</span> result | (childMeasuredState &amp; MEASURED_STATE_MASK);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>返回值是一个复合整数，实际的大小在 MEASURED_SIZE_MASK 位中，可以看到 32 位，24 位用来存储实际的大小，剩下的 8 位是存储状态的；</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * Bits of &#123;<span class="doctag">@link</span> #getMeasuredWidthAndState()&#125; and</span></span><br><span class="line"><span class="comment"> * &#123;<span class="doctag">@link</span> #getMeasuredWidthAndState()&#125; that provide the actual measured size.</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="keyword">int</span> MEASURED_SIZE_MASK = <span class="number">0x00ffffff</span>; <span class="comment">// 低 24 位；</span></span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * Bits of &#123;<span class="doctag">@link</span> #getMeasuredWidthAndState()&#125; and</span></span><br><span class="line"><span class="comment"> * &#123;<span class="doctag">@link</span> #getMeasuredWidthAndState()&#125; that provide the additional state bits.</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="keyword">int</span> MEASURED_STATE_MASK = <span class="number">0xff000000</span>; <span class="comment">// 高 8 位；</span></span><br></pre></td></tr></table></figure>
<p>那么这个状态是什么呢，如下：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * Bit of &#123;<span class="doctag">@link</span> #getMeasuredWidthAndState()&#125; and</span></span><br><span class="line"><span class="comment"> * &#123;<span class="doctag">@link</span> #getMeasuredWidthAndState()&#125; that indicates the measured size</span></span><br><span class="line"><span class="comment"> * is smaller that the space the view would like to have.</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="keyword">int</span> MEASURED_STATE_TOO_SMALL = <span class="number">0x01000000</span>; <span class="comment">// 表示测量值小于 view 想显示的大小；</span></span><br></pre></td></tr></table></figure>
<p>如果如果测量约束指定的 size 小于 view 想要的 size ，那么会设置 MEASURED_STATE_TOO_SMALL 标志位</p>
<h1 id="3-DecorView"><a href="#3-DecorView" class="headerlink" title="3 DecorView"></a>3 DecorView</h1><h2 id="3-1-onMeasure-核心"><a href="#3-1-onMeasure-核心" class="headerlink" title="3.1 onMeasure - 核心"></a>3.1 onMeasure - 核心</h2><p>参数是 parent 指定的测量约束：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="function"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title">onMeasure</span><span class="params">(<span class="keyword">int</span> widthMeasureSpec, <span class="keyword">int</span> heightMeasureSpec)</span> </span>&#123;</span><br><span class="line">    <span class="comment">// 获得屏幕的信息；</span></span><br><span class="line">    <span class="keyword">final</span> DisplayMetrics metrics = getContext().getResources().getDisplayMetrics();</span><br><span class="line">    <span class="keyword">final</span> <span class="keyword">boolean</span> isPortrait = <span class="comment">// 判断下横屏竖屏；</span></span><br><span class="line">            getResources().getConfiguration().orientation == ORIENTATION_PORTRAIT;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//【1】获得宽高的测量模式</span></span><br><span class="line">    <span class="keyword">final</span> <span class="keyword">int</span> widthMode = getMode(widthMeasureSpec);</span><br><span class="line">    <span class="keyword">final</span> <span class="keyword">int</span> heightMode = getMode(heightMeasureSpec);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">boolean</span> fixedWidth = <span class="keyword">false</span>;</span><br><span class="line">    mApplyFloatingHorizontalInsets = <span class="keyword">false</span>;</span><br><span class="line">    <span class="comment">//【2】如果宽的测量模式是 MOST，表示不能超过具体的值；</span></span><br><span class="line">    <span class="keyword">if</span> (widthMode == AT_MOST) &#123;</span><br><span class="line">        <span class="comment">//【2.1】这会根据横竖屏，判断宽度的最大值，调整宽度；</span></span><br><span class="line">        <span class="keyword">final</span> TypedValue tvw = isPortrait ? mWindow.mFixedWidthMinor : mWindow.mFixedWidthMajor;</span><br><span class="line">        <span class="keyword">if</span> (tvw != <span class="keyword">null</span> &amp;&amp; tvw.type != TypedValue.TYPE_NULL) &#123;</span><br><span class="line">            <span class="keyword">final</span> <span class="keyword">int</span> w;</span><br><span class="line">            <span class="keyword">if</span> (tvw.type == TypedValue.TYPE_DIMENSION) &#123; <span class="comment">// 具体像素值；</span></span><br><span class="line">                w = (<span class="keyword">int</span>) tvw.getDimension(metrics);</span><br><span class="line">            &#125; <span class="keyword">else</span> <span class="keyword">if</span> (tvw.type == TypedValue.TYPE_FRACTION) &#123; <span class="comment">// 百分比因子；</span></span><br><span class="line">                w = (<span class="keyword">int</span>) tvw.getFraction(metrics.widthPixels, metrics.widthPixels);</span><br><span class="line">            &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                w = <span class="number">0</span>;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">if</span> (DEBUG_MEASURE) Log.d(mLogTag, <span class="string">"Fixed width: "</span> + w);</span><br><span class="line">            <span class="comment">//【2.2】获取测量约束的指定的宽度，然后计算新的测量模式；</span></span><br><span class="line">            <span class="keyword">final</span> <span class="keyword">int</span> widthSize = MeasureSpec.getSize(widthMeasureSpec);</span><br><span class="line">            <span class="keyword">if</span> (w &gt; <span class="number">0</span>) &#123;</span><br><span class="line">                widthMeasureSpec = MeasureSpec.makeMeasureSpec(</span><br><span class="line">                        Math.min(w, widthSize), EXACTLY);</span><br><span class="line">                <span class="comment">// 标示已经修复了宽度；</span></span><br><span class="line">                fixedWidth = <span class="keyword">true</span>;</span><br><span class="line">            &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                <span class="comment">// 特殊情况，w 为 0，这里会用 DecorView 的宽度减去 mFloatingInsets 和 AT_MOST</span></span><br><span class="line">                <span class="comment">// 计算新的测量模式，child 会以此为标准；</span></span><br><span class="line">                widthMeasureSpec = MeasureSpec.makeMeasureSpec(</span><br><span class="line">                        widthSize - mFloatingInsets.left - mFloatingInsets.right,</span><br><span class="line">                        AT_MOST);</span><br><span class="line">                mApplyFloatingHorizontalInsets = <span class="keyword">true</span>;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    mApplyFloatingVerticalInsets = <span class="keyword">false</span>;</span><br><span class="line">    <span class="comment">//【3】如果高的测量模式是 MOST，同样不能超过具体的值</span></span><br><span class="line">    <span class="keyword">if</span> (heightMode == AT_MOST) &#123;</span><br><span class="line">        <span class="comment">//【3.1】这会根据横竖屏，判断宽度的最大值，调整组件的宽度；</span></span><br><span class="line">        <span class="keyword">final</span> TypedValue tvh = isPortrait ? mWindow.mFixedHeightMajor</span><br><span class="line">                : mWindow.mFixedHeightMinor;</span><br><span class="line">        <span class="keyword">if</span> (tvh != <span class="keyword">null</span> &amp;&amp; tvh.type != TypedValue.TYPE_NULL) &#123;</span><br><span class="line">            <span class="keyword">final</span> <span class="keyword">int</span> h;</span><br><span class="line">            <span class="keyword">if</span> (tvh.type == TypedValue.TYPE_DIMENSION) &#123;</span><br><span class="line">                h = (<span class="keyword">int</span>) tvh.getDimension(metrics);</span><br><span class="line">            &#125; <span class="keyword">else</span> <span class="keyword">if</span> (tvh.type == TypedValue.TYPE_FRACTION) &#123;</span><br><span class="line">                h = (<span class="keyword">int</span>) tvh.getFraction(metrics.heightPixels, metrics.heightPixels);</span><br><span class="line">            &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                h = <span class="number">0</span>;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">if</span> (DEBUG_MEASURE) Log.d(mLogTag, <span class="string">"Fixed height: "</span> + h);</span><br><span class="line">            <span class="comment">//【3.2】获取设置的高度，然后计算孩子的测量模式；</span></span><br><span class="line">            <span class="keyword">final</span> <span class="keyword">int</span> heightSize = MeasureSpec.getSize(heightMeasureSpec);</span><br><span class="line">            <span class="keyword">if</span> (h &gt; <span class="number">0</span>) &#123;</span><br><span class="line">                heightMeasureSpec = MeasureSpec.makeMeasureSpec(</span><br><span class="line">                        Math.min(h, heightSize), EXACTLY);</span><br><span class="line">            &#125; <span class="keyword">else</span> <span class="keyword">if</span> ((mWindow.getAttributes().flags &amp; FLAG_LAYOUT_IN_SCREEN) == <span class="number">0</span>) &#123;</span><br><span class="line">                heightMeasureSpec = MeasureSpec.makeMeasureSpec(</span><br><span class="line">                        heightSize - mFloatingInsets.top - mFloatingInsets.bottom, AT_MOST);</span><br><span class="line">                mApplyFloatingVerticalInsets = <span class="keyword">true</span>;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//【4】如果设置了 outset 区域，那么要对测量模式再次进行调整；</span></span><br><span class="line">    getOutsets(mOutsets);</span><br><span class="line">    <span class="keyword">if</span> (mOutsets.top &gt; <span class="number">0</span> || mOutsets.bottom &gt; <span class="number">0</span>) &#123;</span><br><span class="line">        <span class="keyword">int</span> mode = MeasureSpec.getMode(heightMeasureSpec);</span><br><span class="line">        <span class="keyword">if</span> (mode != MeasureSpec.UNSPECIFIED) &#123;</span><br><span class="line">            <span class="keyword">int</span> height = MeasureSpec.getSize(heightMeasureSpec);</span><br><span class="line">            heightMeasureSpec = MeasureSpec.makeMeasureSpec(</span><br><span class="line">                    height + mOutsets.top + mOutsets.bottom, mode);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span> (mOutsets.left &gt; <span class="number">0</span> || mOutsets.right &gt; <span class="number">0</span>) &#123;</span><br><span class="line">        <span class="keyword">int</span> mode = MeasureSpec.getMode(widthMeasureSpec);</span><br><span class="line">        <span class="keyword">if</span> (mode != MeasureSpec.UNSPECIFIED) &#123;</span><br><span class="line">            <span class="keyword">int</span> width = MeasureSpec.getSize(widthMeasureSpec);</span><br><span class="line">            widthMeasureSpec = MeasureSpec.makeMeasureSpec(</span><br><span class="line">                    width + mOutsets.left + mOutsets.right, mode);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//【--&gt;4.1】进入父类的 onMeasure 方法，传入新的测量模式；</span></span><br><span class="line">    <span class="keyword">super</span>.onMeasure(widthMeasureSpec, heightMeasureSpec);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">int</span> width = getMeasuredWidth();</span><br><span class="line">    <span class="keyword">boolean</span> measure = <span class="keyword">false</span>;</span><br><span class="line">    <span class="comment">// 这里会获取测量的宽度，然后测试模式使用 EXACTLY 定义新的测量标准，进行第二次调整；</span></span><br><span class="line">    widthMeasureSpec = MeasureSpec.makeMeasureSpec(width, EXACTLY);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (!fixedWidth &amp;&amp; widthMode == AT_MOST) &#123;</span><br><span class="line">        <span class="keyword">final</span> TypedValue tv = isPortrait ? mWindow.mMinWidthMinor : mWindow.mMinWidthMajor;</span><br><span class="line">        <span class="keyword">if</span> (tv.type != TypedValue.TYPE_NULL) &#123;</span><br><span class="line">            <span class="keyword">final</span> <span class="keyword">int</span> min;</span><br><span class="line">            <span class="keyword">if</span> (tv.type == TypedValue.TYPE_DIMENSION) &#123;</span><br><span class="line">                min = (<span class="keyword">int</span>)tv.getDimension(metrics);</span><br><span class="line">            &#125; <span class="keyword">else</span> <span class="keyword">if</span> (tv.type == TypedValue.TYPE_FRACTION) &#123;</span><br><span class="line">                min = (<span class="keyword">int</span>)tv.getFraction(mAvailableWidth, mAvailableWidth);</span><br><span class="line">            &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                min = <span class="number">0</span>;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">if</span> (DEBUG_MEASURE) Log.d(mLogTag, <span class="string">"Adjust for min width: "</span> + min + <span class="string">", value::"</span></span><br><span class="line">                    + tv.coerceToString() + <span class="string">", mAvailableWidth="</span> + mAvailableWidth);</span><br><span class="line"></span><br><span class="line">            <span class="keyword">if</span> (width &lt; min) &#123;</span><br><span class="line">                widthMeasureSpec = MeasureSpec.makeMeasureSpec(min, EXACTLY);</span><br><span class="line">                measure = <span class="keyword">true</span>;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//【--&gt;4.1】进入父类的 onMeasure 方法；</span></span><br><span class="line">    <span class="keyword">if</span> (measure) &#123;</span><br><span class="line">        <span class="keyword">super</span>.onMeasure(widthMeasureSpec, heightMeasureSpec);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>代码逻辑很简单，就不多说了；</p>
<h3 id="3-1-1-getMeasuredWidth"><a href="#3-1-1-getMeasuredWidth" class="headerlink" title="3.1.1 getMeasuredWidth"></a>3.1.1 getMeasuredWidth</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * Like &#123;<span class="doctag">@link</span> #getMeasuredWidthAndState()&#125;, but only returns the</span></span><br><span class="line"><span class="comment"> * raw width component (that is the result is masked by</span></span><br><span class="line"><span class="comment"> * &#123;<span class="doctag">@link</span> #MEASURED_SIZE_MASK&#125;).</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@return</span> The raw measured width of this view.</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">final</span> <span class="keyword">int</span> <span class="title">getMeasuredWidth</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    <span class="keyword">return</span> mMeasuredWidth &amp; MEASURED_SIZE_MASK;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h3 id="3-1-2-getMode"><a href="#3-1-2-getMode" class="headerlink" title="3.1.2 getMode"></a>3.1.2 getMode</h3><p>获取测量模式：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@MeasureSpecMode</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">int</span> <span class="title">getMode</span><span class="params">(<span class="keyword">int</span> measureSpec)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">return</span> (measureSpec &amp; MODE_MASK);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h1 id="4-FrameLayout"><a href="#4-FrameLayout" class="headerlink" title="4 FrameLayout"></a>4 FrameLayout</h1><h2 id="4-1-onMeasure-核心"><a href="#4-1-onMeasure-核心" class="headerlink" title="4.1 onMeasure - 核心"></a>4.1 onMeasure - 核心</h2><p>DecorView.onMeasure 回调 FrameLayout.onMeasure 方法：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="function"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title">onMeasure</span><span class="params">(<span class="keyword">int</span> widthMeasureSpec, <span class="keyword">int</span> heightMeasureSpec)</span> </span>&#123;</span><br><span class="line">    <span class="comment">//【--&gt;4.1.1】获取所有的 child view；</span></span><br><span class="line">    <span class="keyword">int</span> count = getChildCount();</span><br><span class="line">    <span class="comment">//【1】EXACTLY 表示父视图已经确定了孩子的确切尺寸。不管孩子想要多大，都会给孩子这些值；</span></span><br><span class="line">    <span class="comment">// 比如具体数值，或者 match_parent；</span></span><br><span class="line">    <span class="comment">// 但是如果不是 EXACTLY 那就要每个 child 都要测量；</span></span><br><span class="line">    <span class="keyword">final</span> <span class="keyword">boolean</span> measureMatchParentChildren =</span><br><span class="line">            MeasureSpec.getMode(widthMeasureSpec) != MeasureSpec.EXACTLY ||</span><br><span class="line">            MeasureSpec.getMode(heightMeasureSpec) != MeasureSpec.EXACTLY;</span><br><span class="line">    mMatchParentChildren.clear();</span><br><span class="line">    <span class="comment">// 这里的 maxHeight 和 maxWidth 用来保存当前 view 的最大宽/高；</span></span><br><span class="line">    <span class="keyword">int</span> maxHeight = <span class="number">0</span>;</span><br><span class="line">    <span class="keyword">int</span> maxWidth = <span class="number">0</span>;</span><br><span class="line">    <span class="keyword">int</span> childState = <span class="number">0</span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//【2】遍历每个 child view；</span></span><br><span class="line">    <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; count; i++) &#123;</span><br><span class="line">        <span class="keyword">final</span> View child = getChildAt(i);</span><br><span class="line">        <span class="keyword">if</span> (mMeasureAllChildren || child.getVisibility() != GONE) &#123;</span><br><span class="line">            <span class="comment">//【--&gt;5.1】测量 child view</span></span><br><span class="line">            measureChildWithMargins(child, widthMeasureSpec, <span class="number">0</span>, heightMeasureSpec, <span class="number">0</span>);</span><br><span class="line">            <span class="comment">//【2.1】获取到 child view 的布局参数；</span></span><br><span class="line">            <span class="keyword">final</span> LayoutParams lp = (LayoutParams) child.getLayoutParams();</span><br><span class="line">            maxWidth = Math.max(maxWidth,</span><br><span class="line">                    child.getMeasuredWidth() + lp.leftMargin + lp.rightMargin);</span><br><span class="line">            maxHeight = Math.max(maxHeight,</span><br><span class="line">                    child.getMeasuredHeight() + lp.topMargin + lp.bottomMargin);</span><br><span class="line">            <span class="comment">//【--&gt;2.4】获取每个 child view 的测量状态，同时【--&gt;2.3】合并 child 的测量状态；</span></span><br><span class="line">            childState = combineMeasuredStates(childState, child.getMeasuredState());</span><br><span class="line">            <span class="comment">//【2.2】如果需要对 child view 进行重新测量的话，同时 child view 的 lp 的 width/height</span></span><br><span class="line">            <span class="comment">// 至少有一个为 MATCH_PARENT，那么这个 view 就会被添加到 mMatchParentChildren 中；</span></span><br><span class="line">            <span class="keyword">if</span> (measureMatchParentChildren) &#123;</span><br><span class="line">                <span class="keyword">if</span> (lp.width == LayoutParams.MATCH_PARENT ||</span><br><span class="line">                        lp.height == LayoutParams.MATCH_PARENT) &#123;</span><br><span class="line">                    mMatchParentChildren.add(child);</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//【3】累加 padding 区域，这个是 FlameLayout 独有的；</span></span><br><span class="line">    maxWidth += getPaddingLeftWithForeground() + getPaddingRightWithForeground();</span><br><span class="line">    maxHeight += getPaddingTopWithForeground() + getPaddingBottomWithForeground();</span><br><span class="line"></span><br><span class="line">    <span class="comment">//【4】检查下最小的宽/高；</span></span><br><span class="line">    maxHeight = Math.max(maxHeight, getSuggestedMinimumHeight());</span><br><span class="line">    maxWidth = Math.max(maxWidth, getSuggestedMinimumWidth());</span><br><span class="line"></span><br><span class="line">    <span class="comment">//【5】检查下前景的宽/高；</span></span><br><span class="line">    <span class="keyword">final</span> Drawable drawable = getForeground();</span><br><span class="line">    <span class="keyword">if</span> (drawable != <span class="keyword">null</span>) &#123;</span><br><span class="line">        maxHeight = Math.max(maxHeight, drawable.getMinimumHeight());</span><br><span class="line">        maxWidth = Math.max(maxWidth, drawable.getMinimumWidth());</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//【--&gt;2.2.1】设置 DecorView/FlameLayout 自身的宽高值；</span></span><br><span class="line">    <span class="comment">//【--&gt;2.5】这里会根据 child 的测量状态，调整 FlameLayout 的测量状态（原因未知=。 =）</span></span><br><span class="line">    setMeasuredDimension(resolveSizeAndState(maxWidth, widthMeasureSpec, childState),</span><br><span class="line">            resolveSizeAndState(maxHeight, heightMeasureSpec,</span><br><span class="line">                    childState &lt;&lt; MEASURED_HEIGHT_STATE_SHIFT));</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 下面是正式处理 child view；</span></span><br><span class="line">    count = mMatchParentChildren.size();</span><br><span class="line">    <span class="keyword">if</span> (count &gt; <span class="number">1</span>) &#123;</span><br><span class="line">        <span class="comment">// 【3】count 大于 0，说明部分 child 也需要测量调整！</span></span><br><span class="line">        <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; count; i++) &#123;</span><br><span class="line">            <span class="keyword">final</span> View child = mMatchParentChildren.get(i);</span><br><span class="line">            <span class="keyword">final</span> MarginLayoutParams lp = (MarginLayoutParams) child.getLayoutParams();</span><br><span class="line">            <span class="comment">//【3.1】重新计算 child view 的宽/高测量约束；</span></span><br><span class="line">            <span class="keyword">final</span> <span class="keyword">int</span> childWidthMeasureSpec;</span><br><span class="line">            <span class="keyword">if</span> (lp.width == LayoutParams.MATCH_PARENT) &#123;</span><br><span class="line">                <span class="comment">// 如果 child view 的布局参数是 match parent 的话，那么 child 的测量模式为 EXACTLY；</span></span><br><span class="line">                <span class="comment">// 同时会计算新的测量宽度 width（在父 view 的距离基础上 - 父 view 的 padding - child 的 margin）</span></span><br><span class="line">                <span class="keyword">final</span> <span class="keyword">int</span> width = Math.max(<span class="number">0</span>, getMeasuredWidth()</span><br><span class="line">                        - getPaddingLeftWithForeground() - getPaddingRightWithForeground()</span><br><span class="line">                        - lp.leftMargin - lp.rightMargin);</span><br><span class="line">                <span class="comment">// 计算新的测量规格；</span></span><br><span class="line">                childWidthMeasureSpec = MeasureSpec.makeMeasureSpec(</span><br><span class="line">                        width, MeasureSpec.EXACTLY);</span><br><span class="line">            &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                <span class="comment">//【--&gt;5.2】如果 child view 的布局参数不是 match parent 的话，这里会调用</span></span><br><span class="line">                <span class="comment">// 新的方法计算测量规格；</span></span><br><span class="line">                childWidthMeasureSpec = getChildMeasureSpec(widthMeasureSpec,</span><br><span class="line">                        getPaddingLeftWithForeground() + getPaddingRightWithForeground() +</span><br><span class="line">                        lp.leftMargin + lp.rightMargin,</span><br><span class="line">                        lp.width);</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            <span class="keyword">final</span> <span class="keyword">int</span> childHeightMeasureSpec;</span><br><span class="line">            <span class="keyword">if</span> (lp.height == LayoutParams.MATCH_PARENT) &#123;</span><br><span class="line">                <span class="keyword">final</span> <span class="keyword">int</span> height = Math.max(<span class="number">0</span>, getMeasuredHeight()</span><br><span class="line">                        - getPaddingTopWithForeground() - getPaddingBottomWithForeground()</span><br><span class="line">                        - lp.topMargin - lp.bottomMargin);</span><br><span class="line">                childHeightMeasureSpec = MeasureSpec.makeMeasureSpec(</span><br><span class="line">                        height, MeasureSpec.EXACTLY);</span><br><span class="line">            &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                childHeightMeasureSpec = getChildMeasureSpec(heightMeasureSpec,</span><br><span class="line">                        getPaddingTopWithForeground() + getPaddingBottomWithForeground() +</span><br><span class="line">                        lp.topMargin + lp.bottomMargin,</span><br><span class="line">                        lp.height);</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            <span class="comment">//【--&gt;2.1】child view 处理，如果是 ViewGroup 的话，流程和 DecorView 类似；</span></span><br><span class="line">            child.measure(childWidthMeasureSpec, childHeightMeasureSpec);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>我们看到了，对于 ViewGroup u </p>
<h3 id="4-1-1-getChildCount"><a href="#4-1-1-getChildCount" class="headerlink" title="4.1.1 getChildCount"></a>4.1.1 getChildCount</h3><p>返回内部的 child view 的个数：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">int</span> <span class="title">getChildCount</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    <span class="keyword">return</span> mChildrenCount;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h1 id="5-ViewGroup"><a href="#5-ViewGroup" class="headerlink" title="5 ViewGroup"></a>5 ViewGroup</h1><h2 id="5-1-measureChildWithMargins"><a href="#5-1-measureChildWithMargins" class="headerlink" title="5.1 measureChildWithMargins"></a>5.1 measureChildWithMargins</h2><p>同志 child view 测量自身，但是要考虑到 child 的 Margin 距离和 parent 的 padding 距离；</p>
<ul>
<li>参数 View child：要测量的 child view；</li>
<li>参数 int parentWidthMeasureSpec：父布局指定的 width 测量约束；</li>
<li>参数 int widthUsed：parent view 在水平空间使用的额外空间（这个空间可能由其他子 view 使用）</li>
</ul>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title">measureChildWithMargins</span><span class="params">(View child,</span></span></span><br><span class="line"><span class="function"><span class="params">        <span class="keyword">int</span> parentWidthMeasureSpec, <span class="keyword">int</span> widthUsed,</span></span></span><br><span class="line"><span class="function"><span class="params">        <span class="keyword">int</span> parentHeightMeasureSpec, <span class="keyword">int</span> heightUsed)</span> </span>&#123;</span><br><span class="line">    <span class="comment">//【1】获取到其布局参数；</span></span><br><span class="line">    <span class="keyword">final</span> MarginLayoutParams lp = (MarginLayoutParams) child.getLayoutParams();</span><br><span class="line">    <span class="comment">//【--&gt;5.2.1】计算 child view 的测量标准，child view 需要根据该标准测量自身；</span></span><br><span class="line">    <span class="keyword">final</span> <span class="keyword">int</span> childWidthMeasureSpec = getChildMeasureSpec(parentWidthMeasureSpec,</span><br><span class="line">            mPaddingLeft + mPaddingRight + lp.leftMargin + lp.rightMargin</span><br><span class="line">                    + widthUsed, lp.width);</span><br><span class="line">    <span class="keyword">final</span> <span class="keyword">int</span> childHeightMeasureSpec = getChildMeasureSpec(parentHeightMeasureSpec,</span><br><span class="line">            mPaddingTop + mPaddingBottom + lp.topMargin + lp.bottomMargin</span><br><span class="line">                    + heightUsed, lp.height);</span><br><span class="line">    <span class="comment">//【--&gt;2.1】每个 view 进行自身的测量；</span></span><br><span class="line">    child.measure(childWidthMeasureSpec, childHeightMeasureSpec);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>ViewGroup 继承了 View，他没有 measure 方法呀，调用的依然是 View 的 measure 方法；</p>
<h3 id="5-2-1-getChildMeasureSpec-核心"><a href="#5-2-1-getChildMeasureSpec-核心" class="headerlink" title="5.2.1 getChildMeasureSpec - 核心"></a>5.2.1 getChildMeasureSpec - 核心</h3><p>measureChildren 的难点是：确定合适的 MeasureSpec 并传递给特定的孩子。</p>
<p>getChildMeasureSpec 为一个 child 视图的高度或宽度，找出正确的 MeasureSpec，然后将 MeasureSpec 的信息与 child 的 LayoutParams 结合起来，来获得最佳结果。</p>
<p>例如，如果此视图知道其大小（因为其 MeasureSpec 的模式为 EXACTLY），并且 child 在其 LayoutParams 中设置与 parent 大小相同，则 parent 应满足 child 的大小请求；</p>
<ul>
<li><p>参数 int spec：child view 的测量约束，parent 指定，child 需要根据他来计算自身实际的测量约束；</p>
</li>
<li><p>参数 int padding：child view 的边距；</p>
</li>
<li><p>参数 int childDimension：child view 想要显示的大小；</p>
</li>
</ul>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">int</span> <span class="title">getChildMeasureSpec</span><span class="params">(<span class="keyword">int</span> spec, <span class="keyword">int</span> padding, <span class="keyword">int</span> childDimension)</span> </span>&#123;</span><br><span class="line">    <span class="comment">//【1】根据测量约束返回测量模式和测量距离；</span></span><br><span class="line">    <span class="keyword">int</span> specMode = MeasureSpec.getMode(spec);</span><br><span class="line">    <span class="keyword">int</span> specSize = MeasureSpec.getSize(spec);</span><br><span class="line">    <span class="comment">//【2】由于 specSize 是 parent 指定的测量距离，换要减去 padding 的距离，才是 child 的测量距离；</span></span><br><span class="line">    <span class="keyword">int</span> size = Math.max(<span class="number">0</span>, specSize - padding);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">int</span> resultSize = <span class="number">0</span>;</span><br><span class="line">    <span class="keyword">int</span> resultMode = <span class="number">0</span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//【3】处理测量模式；</span></span><br><span class="line">    <span class="keyword">switch</span> (specMode) &#123;</span><br><span class="line">    <span class="comment">//【3.1】如果是 EXACTLY，表示确切的大小；</span></span><br><span class="line">    <span class="keyword">case</span> MeasureSpec.EXACTLY:</span><br><span class="line">        <span class="keyword">if</span> (childDimension &gt;= <span class="number">0</span>) &#123;</span><br><span class="line">            <span class="comment">//【3.1.1】如果 child 指定了大小，那么实际的大小就是 child 想要的，模式为 EXACTLY；</span></span><br><span class="line">            resultSize = childDimension;</span><br><span class="line">            resultMode = MeasureSpec.EXACTLY;</span><br><span class="line">        &#125; <span class="keyword">else</span> <span class="keyword">if</span> (childDimension == LayoutParams.MATCH_PARENT) &#123;</span><br><span class="line">            <span class="comment">//【3.1.2】如果 child 没有指定具体的大小，而是 MATCH_PARENT，那么 child 实际的大小就是 size，模式为 EXACTLY；</span></span><br><span class="line">            resultSize = size;</span><br><span class="line">            resultMode = MeasureSpec.EXACTLY;</span><br><span class="line">        &#125; <span class="keyword">else</span> <span class="keyword">if</span> (childDimension == LayoutParams.WRAP_CONTENT) &#123;</span><br><span class="line">            <span class="comment">//【3.1.3】如果 child 没有指定具体的大小，而是 WRAP_CONTENT，</span></span><br><span class="line">            <span class="comment">// 那么 child 想要自适应，自己调整大小，大小不能超过 size，模式为 AT_MOST；</span></span><br><span class="line">            resultSize = size;</span><br><span class="line">            resultMode = MeasureSpec.AT_MOST;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">break</span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//【3.2】如果是 AT_MOST，表示 parent 通过测量模式指定了 child 的 size 最大值；child 不能超过这个值；</span></span><br><span class="line">    <span class="keyword">case</span> MeasureSpec.AT_MOST:</span><br><span class="line">        <span class="keyword">if</span> (childDimension &gt;= <span class="number">0</span>) &#123;</span><br><span class="line">            <span class="comment">//【3.2.1】如果 child 指定了大小，那么实际的大小就是 child 想要的，模式为 EXACTLY；</span></span><br><span class="line">            resultSize = childDimension;</span><br><span class="line">            resultMode = MeasureSpec.EXACTLY;</span><br><span class="line">        &#125; <span class="keyword">else</span> <span class="keyword">if</span> (childDimension == LayoutParams.MATCH_PARENT) &#123;</span><br><span class="line">            <span class="comment">//【3.2.2】如果 child 没有指定具体的大小，而是 MATCH_PARENT，但是实际测试模式的大小并不是固定的；</span></span><br><span class="line">            <span class="comment">// 那么 child 的大小不能超过 size，模式为 AT_MOST；</span></span><br><span class="line">            resultSize = size;</span><br><span class="line">            resultMode = MeasureSpec.AT_MOST;</span><br><span class="line">        &#125; <span class="keyword">else</span> <span class="keyword">if</span> (childDimension == LayoutParams.WRAP_CONTENT) &#123;</span><br><span class="line">            <span class="comment">//【3.2.3】如果 child 没有指定具体的大小，而是 WRAP_CONTENT，</span></span><br><span class="line">            <span class="comment">// 那么 child 想要自适应，自己调整大小，大小不能超过 size，模式为 AT_MOST；</span></span><br><span class="line">            resultSize = size;</span><br><span class="line">            resultMode = MeasureSpec.AT_MOST;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">break</span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//【3.3】如果是 UNSPECIFIED，表示 parent 没有限制 child 的大小；</span></span><br><span class="line">    <span class="keyword">case</span> MeasureSpec.UNSPECIFIED:</span><br><span class="line">        <span class="keyword">if</span> (childDimension &gt;= <span class="number">0</span>) &#123;</span><br><span class="line">            <span class="comment">//【3.3.1】如果 child 指定了大小，那么实际的大小就是 child 想要的，模式为 EXACTLY；</span></span><br><span class="line">            resultSize = childDimension;</span><br><span class="line">            resultMode = MeasureSpec.EXACTLY;</span><br><span class="line">        &#125; <span class="keyword">else</span> <span class="keyword">if</span> (childDimension == LayoutParams.MATCH_PARENT) &#123;</span><br><span class="line">            <span class="comment">//【3.3.2】如果 child 没有指定具体的大小，而是 MATCH_PARENT，这里会计算出它实际的大小；</span></span><br><span class="line">            <span class="comment">// 模式为 UNSPECIFIED</span></span><br><span class="line">            resultSize = View.sUseZeroUnspecifiedMeasureSpec ? <span class="number">0</span> : size;</span><br><span class="line">            resultMode = MeasureSpec.UNSPECIFIED;</span><br><span class="line">        &#125; <span class="keyword">else</span> <span class="keyword">if</span> (childDimension == LayoutParams.WRAP_CONTENT) &#123;</span><br><span class="line">            <span class="comment">//【3.3.3】如果 child 没有指定具体的大小，而是 WRAP_CONTENT，</span></span><br><span class="line">            <span class="comment">// 那么 child 想要自适应，自己调整大小，大小不能超过 size，模式为 AT_MOST；</span></span><br><span class="line">            resultSize = View.sUseZeroUnspecifiedMeasureSpec ? <span class="number">0</span> : size;</span><br><span class="line">            resultMode = MeasureSpec.UNSPECIFIED;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">break</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">//【4】生成 child 的测量约束；</span></span><br><span class="line">    <span class="keyword">return</span> MeasureSpec.makeMeasureSpec(resultSize, resultMode);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>这个方法实际上就是 ViewGroup 的核心之一，他会根据 parent 传入的测量模式，计算每个  child 的测量模式；</p>
</div></article><div class="post-copyright"><div class="post-copyright__author"><span class="post-copyright-meta">文章作者: </span><span class="post-copyright-info"><a href="mailto:undefined">Coolqi.Li</a></span></div><div class="post-copyright__type"><span class="post-copyright-meta">文章链接: </span><span class="post-copyright-info"><a href="https://lishuaiqi.top/2020/04/15/ViewDraw-4-measure/">https://lishuaiqi.top/2020/04/15/ViewDraw-4-measure/</a></span></div><div class="post-copyright__notice"><span class="post-copyright-meta">版权声明: </span><span class="post-copyright-info">本博客所有文章除特别声明外，均采用 <a href="https://creativecommons.org/licenses/by-nc-sa/4.0/">CC BY-NC-SA 4.0</a> 许可协议。转载请注明来自 <a href="https://lishuaiqi.top">Coolqi`s Blog</a>！</span></div></div><div class="post-meta__tag-list"><a class="post-meta__tags" href="/tags/ViewDraw/">ViewDraw</a></div><div class="post-qr-code"><div class="post-qr-code-item"><img class="post-qr-code__img" src="/img/zfb.jpg"><div class="post-qr-code__desc">支付宝打赏</div></div><div class="post-qr-code-item"><img class="post-qr-code__img" src="/img/wechat.jpg"><div class="post-qr-code__desc">微信打赏</div></div></div><div class="social-share pull-right"></div><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/social-share.js@1.0.16/dist/css/share.min.css"><script src="https://cdn.jsdelivr.net/npm/social-share.js@1.0.16/dist/js/social-share.min.js"></script><nav id="pagination"><div class="next-post pull-right"><a href="/2019/09/13/Eventbus-4-postMessage/"><span>EventBus 第四篇 - 发送消息</span><i class="fa fa-chevron-right"></i></a></div></nav><div id="vcomment"></div><script src="https://cdn1.lncld.net/static/js/3.0.4/av-min.js"></script><script src="https://cdn.jsdelivr.net/npm/valine/dist/Valine.min.js"></script><script>var notify = 'false' == 'true';
var verify = 'false' == 'true';
var record_ip = '' == 'true';
var GUEST_INFO = ['nick','mail','link'];
var guest_info = ''.split(',').filter(function(item){
  return GUEST_INFO.indexOf(item) > -1
});
guest_info = guest_info.length == 0 ? GUEST_INFO :guest_info;
window.valine = new Valine({
  el:'#vcomment',
  notify:notify,
  verify:verify,
  recordIP:record_ip,
  appId:'eedJikU7JeDetXjbjw27DWBz-gzGzoHsz',
  appKey:'woFTBOpMKS9EASNUpbaA9Jvc',
  placeholder:'Just go go',
  avatar:'mm',
  guest_info:guest_info,
  pageSize:'10',
  lang: 'zh-cn'
})</script></div></div><footer class="footer-bg" style="background-image: url(/img/blog-bg.jpg)"><div class="layout" id="footer"><div class="copyright">&copy;2015 - 2020 By Coolqi.Li</div><div class="framework-info"><span>驱动 - </span><a href="http://hexo.io"><span>Hexo</span></a><span class="footer-separator">|</span><span>主题 - </span><a href="https://github.com/Molunerfinn/hexo-theme-melody"><span>Melody</span></a></div><div class="footer_custom_text">Hi, welcome to my <a href="https://lishuaiqi.top/">blog</a>!</div><div class="busuanzi"><script async src="//busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script><span id="busuanzi_container_page_pv"><i class="fa fa-file-o"></i><span id="busuanzi_value_page_pv"></span><span></span></span></div></div></footer><i class="fa fa-arrow-up" id="go-up" aria-hidden="true"></i><script src="/js/third-party/anime.min.js"></script><script src="/js/third-party/jquery.min.js"></script><script src="/js/third-party/jquery.fancybox.min.js"></script><script src="/js/third-party/velocity.min.js"></script><script src="/js/third-party/velocity.ui.min.js"></script><script src="/js/utils.js?version=1.7.0"></script><script src="/js/fancybox.js?version=1.7.0"></script><script src="/js/sidebar.js?version=1.7.0"></script><script src="/js/copy.js?version=1.7.0"></script><script src="/js/fireworks.js?version=1.7.0"></script><script src="/js/transition.js?version=1.7.0"></script><script src="/js/scroll.js?version=1.7.0"></script><script src="/js/head.js?version=1.7.0"></script><script type="text/x-mathjax-config">MathJax.Hub.Config({
  tex2jax: {
    inlineMath: [ ['$','$'], ["\\(","\\)"]  ],
    processEscapes: true,
    skipTags: ['script', 'noscript', 'style', 'textarea', 'pre', 'code']
  },
  CommonHTML: {
    linebreaks: { automatic: true, width: "90% container" }
  },
  "HTML-CSS": { 
    linebreaks: { automatic: true, width: "90% container" }
  },
  "SVG": { 
    linebreaks: { automatic: true, width: "90% container" }
  }
});
</script><script type="text/x-mathjax-config">MathJax.Hub.Queue(function() {
  var all = MathJax.Hub.getAllJax(), i;
  for (i=0; i < all.length; i += 1) {
    all[i].SourceElement().parentNode.className += ' has-jax';
  }
});
</script><script src="https://cdn.jsdelivr.net/npm/mathjax/MathJax.js?config=TeX-AMS-MML_HTMLorMML"></script><script src="/js/search/local-search.js"></script><script>if(/Android|webOS|iPhone|iPod|iPad|BlackBerry/i.test(navigator.userAgent)) {
  $('#nav').addClass('is-mobile')
  $('footer').addClass('is-mobile')
  $('#top-container').addClass('is-mobile')
}</script><div class="search-dialog" id="local-search"><div class="search-dialog__title" id="local-search-title">本地搜索</div><div id="local-input-panel"><div id="local-search-input"><div class="local-search-box"><input class="local-search-box--input" placeholder="搜索文章"></div></div></div><hr><div id="local-search-results"><div id="local-hits"></div><div id="local-stats"><div class="local-search-stats__hr" id="hr"><span>由</span> <a href="https://github.com/wzpan/hexo-generator-search" style="color:#49B1F5;">hexo-generator-search</a>
 <span>提供支持</span></div></div></div><span class="search-close-button"><i class="fa fa-times"></i></span></div><div class="search-mask"></div></body></html>
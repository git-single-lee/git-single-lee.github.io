<!DOCTYPE html><html lang="zh-Hans"><head><meta name="generator" content="Hexo 3.9.0"><meta charset="UTF-8"><meta http-equiv="X-UA-Compatible" content="IE=edge"><meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1"><meta name="description" content="Serivce 篇 7 - Service restart 流程分析"><meta name="keywords" content="Service服务"><meta name="author" content="Coolqi.Li"><meta name="copyright" content="Coolqi.Li"><title>Serivce 篇 7 - Service restart 流程分析 | Coolqi`s Blog</title><link rel="shortcut icon" href="/img/favicon.ico"><link rel="stylesheet" href="/css/index.css?version=1.7.0"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/font-awesome@latest/css/font-awesome.min.css?version=1.7.0"><link rel="stylesheet" href="https://use.fontawesome.com/releases/v5.7.2/css/all.css?version=1.7.0"><meta name="format-detection" content="telephone=no"><meta http-equiv="x-dns-prefetch-control" content="on"><link rel="dns-prefetch" href="https://cdn.jsdelivr.net"><script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script><script>(adsbygoogle = window.adsbygoogle || []).push({
  google_ad_client: 'ca-pub-6845729157331145',
  enable_page_level_ads: 'true'
});
</script><link rel="dns-prefetch" href="https://hm.baidu.com"><script>var _hmt = _hmt || [];
(function() {
  var hm = document.createElement("script");
  hm.src = "https://hm.baidu.com/hm.js?b7acef5306e54116ad8a99e8b753a92d";
  var s = document.getElementsByTagName("script")[0]; 
  s.parentNode.insertBefore(hm, s);
})();</script><script>var GLOBAL_CONFIG = { 
  root: '/',
  algolia: undefined,
  localSearch: {"path":"search.xml","languages":{"hits_empty":"找不到您查询的内容:${query}"}},
  copy: {
    success: '复制成功',
    error: '复制错误',
    noSupport: '浏览器不支持'
  }
} </script></head><body><i class="fa fa-arrow-right" id="toggle-sidebar" aria-hidden="true"></i><div id="sidebar" data-display="true"><div class="toggle-sidebar-info text-center"><span data-toggle="切换文章详情">切换站点概览</span><hr></div><div class="sidebar-toc"><div class="sidebar-toc__title">目录</div><div class="sidebar-toc__progress"><span class="progress-notice">你已经读了</span><span class="progress-num">0</span><span class="progress-percentage">%</span><div class="sidebar-toc__progress-bar"></div></div><div class="sidebar-toc__content"><ol class="toc"><li class="toc-item toc-level-1"><a class="toc-link" href="#0-综述"><span class="toc-text">0 综述</span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#1-第一种情况"><span class="toc-text">1 第一种情况</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#1-1-ActiveServices-realStartServiceLocked"><span class="toc-text">1.1 ActiveServices.realStartServiceLocked</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#1-2-ActiveServices-scheduleServiceRestartLocked"><span class="toc-text">1.2 ActiveServices.scheduleServiceRestartLocked</span></a></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#3-ServiceRestarter-run"><span class="toc-text">3 ServiceRestarter.run</span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#4-ActiveServices-performServiceRestartLocked"><span class="toc-text">4 ActiveServices.performServiceRestartLocked</span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#5-onStartCommand-返回值的不同处理"><span class="toc-text">5 onStartCommand 返回值的不同处理</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#5-1-START-STICKY（默认返回值）"><span class="toc-text">5.1 START_STICKY（默认返回值）</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#5-2-START-NOT-STICKY"><span class="toc-text">5.2 START_NOT_STICKY</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#5-2-START-REDELIVER-INTENT"><span class="toc-text">5.2 START_REDELIVER_INTENT</span></a></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#1-ActiveServices-killServicesLocked"><span class="toc-text">1 ActiveServices.killServicesLocked</span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#10-总结"><span class="toc-text">10 总结</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#10-1-相关-Log"><span class="toc-text">10.1 相关 Log</span></a></li></ol></li></ol></div></div><div class="author-info hide"><div class="author-info__avatar text-center"><img src="/img/avatar.jpg"></div><div class="author-info__name text-center">Coolqi.Li</div><div class="author-info__description text-center">“Hi，我是李帅奇，Android 开发工程师，TeamLeader，熬夜星人，一个努力赚钱，积极向上的好人。”</div><div class="follow-button"><a href="https://github.com/single-li">Follow Me</a></div><hr><div class="author-info-articles"><a class="author-info-articles__archives article-meta" href="/archives"><span class="pull-left">文章</span><span class="pull-right">86</span></a><a class="author-info-articles__tags article-meta" href="/tags"><span class="pull-left">标签</span><span class="pull-right">21</span></a><a class="author-info-articles__categories article-meta" href="/categories"><span class="pull-left">分类</span><span class="pull-right">26</span></a></div><hr><div class="author-info-links"><div class="author-info-links__title text-center">Links</div><a class="author-info-links__name text-center" href="https://developer.android.google.cn/">AndroidDeveloper</a><a class="author-info-links__name text-center" href="http://www.android-studio.org/">AndroidStudio</a><a class="author-info-links__name text-center" href="https://www.jianshu.com/u/123a20a96441">简书</a><a class="author-info-links__name text-center" href="https://weibo.com/coolqiLi">微博</a></div></div></div><div id="content-outer"><div id="top-container" style="background-image: url(/img/blog-bg.jpg)"><div id="page-header"><span class="pull-left"> <a id="site-name" href="/">Coolqi`s Blog</a></span><i class="fa fa-bars toggle-menu pull-right" aria-hidden="true"></i><span class="pull-right menus">   <a class="site-page" href="/">Home</a><a class="site-page" href="/categories">Categories</a><a class="site-page" href="/tags">Tags</a><a class="site-page" href="/archives">Archives</a><a class="site-page" href="/about">About</a></span><span class="pull-right"><a class="site-page social-icon search"><i class="fa fa-search"></i><span> 搜索</span></a></span></div><div id="post-info"><div id="post-title">Serivce 篇 7 - Service restart 流程分析</div><div id="post-meta"><time class="post-meta__date"><i class="fa fa-calendar" aria-hidden="true"></i> 2016-09-21</time><span class="post-meta__separator">|</span><i class="fa fa-inbox post-meta__icon" aria-hidden="true"></i><a class="post-meta__categories" href="/categories/AndroidFramework源码分析/">AndroidFramework源码分析</a><i class="fa fa-angle-right" aria-hidden="true"></i><i class="fa fa-inbox post-meta__icon" aria-hidden="true"></i><a class="post-meta__categories" href="/categories/AndroidFramework源码分析/Service服务/">Service服务</a><div class="post-meta-wordcount"><span>字数总计: </span><span class="word-count">5k</span><span class="post-meta__separator">|</span><span>阅读时长: 22 分钟</span></div></div></div></div><div class="layout" id="content-inner"><article id="post"><div class="article-container" id="post-content"><p>本文基于 Android 7.1.1 源码分析，转载请说明出处！</p>
<h1 id="0-综述"><a href="#0-综述" class="headerlink" title="0 综述"></a>0 综述</h1><p>当服务被 kill 掉后，会根据 onStartCommand 方法的返回值，来决定是否对服务进行重启，我们先来回顾下返回值类型：</p>
<ul>
<li><strong>START_STICKY</strong>：</li>
<li><strong>START_STICKY_COMPATIBILITY</strong>：<ul>
<li>删除本次启动的 startId 对应的启动项；</li>
<li>设置服务的 stopIfKilled 为 false；</li>
</ul>
</li>
<li><strong>START_NOT_STICKY</strong>： <ul>
<li>删除本次启动的服务的 startId 对应的启动项；</li>
<li>如果最后一次启动的启动项的 id(lastStartId) 等于本次启动的启动项的 id；<ul>
<li>设置服务的 stopIfKilled 为 true；</li>
</ul>
</li>
</ul>
</li>
<li><strong>START_REDELIVER_INTENT</strong>： <ul>
<li>不删除本次启动的 startId 对应的启动项；</li>
<li>如果本次启动的启动项不为 null；<ul>
<li>设置启动项的 deliveryCount 为 0；</li>
<li>设置启动项的 doneExecutingCount 加 1；</li>
<li>设置服务的 stopIfKilled 为 true；</li>
</ul>
</li>
</ul>
</li>
</ul>
<p>下面，我们来分析下服务的重启过程，有两种情况会出现服务的重启：</p>
<p>第一种是，在拉起 Service 的 onCreate 方法时出现异常，这时如果服务没有被 destroy 掉，那就会尝试重新启动服务！</p>
<p>第二种是，服务所在的进程被 kill 掉了，这是会尝试重启服务！</p>
<h1 id="1-第一种情况"><a href="#1-第一种情况" class="headerlink" title="1 第一种情况"></a>1 第一种情况</h1><h2 id="1-1-ActiveServices-realStartServiceLocked"><a href="#1-1-ActiveServices-realStartServiceLocked" class="headerlink" title="1.1 ActiveServices.realStartServiceLocked"></a>1.1 ActiveServices.realStartServiceLocked</h2><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">final</span> <span class="keyword">void</span> <span class="title">realStartServiceLocked</span><span class="params">(ServiceRecord r,</span></span></span><br><span class="line"><span class="function"><span class="params">        ProcessRecord app, <span class="keyword">boolean</span> execInFg)</span> <span class="keyword">throws</span> RemoteException </span>&#123;</span><br><span class="line"></span><br><span class="line">    ... ... ... ...</span><br><span class="line"></span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">synchronized</span> (r.stats.getBatteryStats()) &#123;</span><br><span class="line">            r.stats.startLaunchedLocked();</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        mAm.notifyPackageUse(r.serviceInfo.packageName,</span><br><span class="line">                             PackageManager.NOTIFY_PACKAGE_USE_SERVICE);</span><br><span class="line">        <span class="comment">// 更新服务的 state！</span></span><br><span class="line">        app.forceProcessStateUpTo(ActivityManager.PROCESS_STATE_SERVICE);</span><br><span class="line">        <span class="comment">// 拉起服务的 onCreate 方法</span></span><br><span class="line">        app.thread.scheduleCreateService(r, r.serviceInfo,</span><br><span class="line">                mAm.compatibilityInfoForPackageLocked(r.serviceInfo.applicationInfo),</span><br><span class="line">                app.repProcState);</span><br><span class="line">                </span><br><span class="line">        r.postNotification();</span><br><span class="line">        created = <span class="keyword">true</span>;</span><br><span class="line">    &#125; <span class="keyword">catch</span> (DeadObjectException e) &#123;</span><br><span class="line">        Slog.w(TAG, <span class="string">"Application dead when creating service "</span> + r);</span><br><span class="line">        mAm.appDiedLocked(app);</span><br><span class="line">        <span class="keyword">throw</span> e;</span><br><span class="line">    &#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">        <span class="keyword">if</span> (!created) &#123; <span class="comment">// created 为 false，表示拉起失败！</span></span><br><span class="line">            <span class="keyword">final</span> <span class="keyword">boolean</span> inDestroying = mDestroyingServices.contains(r);</span><br><span class="line">            serviceDoneExecutingLocked(r, inDestroying, inDestroying);</span><br><span class="line"></span><br><span class="line">            <span class="keyword">if</span> (newService) &#123;</span><br><span class="line">                app.services.remove(r);</span><br><span class="line">                r.app = <span class="keyword">null</span>;</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            <span class="comment">//【1】如果服务没有被销毁掉，那就尝试重新启动服务！</span></span><br><span class="line">            <span class="keyword">if</span> (!inDestroying) &#123;</span><br><span class="line">                scheduleServiceRestartLocked(r, <span class="keyword">false</span>);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    ... ... ... ...</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>我们继续来看！</p>
<h2 id="1-2-ActiveServices-scheduleServiceRestartLocked"><a href="#1-2-ActiveServices-scheduleServiceRestartLocked" class="headerlink" title="1.2 ActiveServices.scheduleServiceRestartLocked"></a>1.2 ActiveServices.scheduleServiceRestartLocked</h2><p>参数传递：</p>
<ul>
<li><code>ServiceRecord r</code>：要被重启的服务；</li>
<li><code>boolean allowCancel</code>：这里传入 <code>false</code>；</li>
</ul>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">final</span> <span class="keyword">boolean</span> <span class="title">scheduleServiceRestartLocked</span><span class="params">(ServiceRecord r,</span></span></span><br><span class="line"><span class="function"><span class="params">            <span class="keyword">boolean</span> allowCancel)</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 变量 cancel 用于表示是否放弃重启服务！</span></span><br><span class="line">        <span class="keyword">boolean</span> canceled = <span class="keyword">false</span>;</span><br><span class="line">        </span><br><span class="line">        <span class="comment">//【1】如果系统在关机，那就不重启！</span></span><br><span class="line">        <span class="keyword">if</span> (mAm.isShuttingDownLocked()) &#123;</span><br><span class="line"></span><br><span class="line">            Slog.w(TAG, <span class="string">"Not scheduling restart of crashed service "</span> + r.shortName</span><br><span class="line">                    + <span class="string">" - system is shutting down"</span>);</span><br><span class="line"></span><br><span class="line">            <span class="keyword">return</span> <span class="keyword">false</span>;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        ServiceMap smap = getServiceMap(r.userId);</span><br><span class="line">        </span><br><span class="line">        <span class="comment">//【1】再次和服务集合中的服务匹配校验，如果不是同一个，那就停止重启！</span></span><br><span class="line">        <span class="keyword">if</span> (smap.mServicesByName.get(r.name) != r) &#123;</span><br><span class="line">            ServiceRecord cur = smap.mServicesByName.get(r.name);</span><br><span class="line"></span><br><span class="line">            Slog.wtf(TAG, <span class="string">"Attempting to schedule restart of "</span> + r</span><br><span class="line">                    + <span class="string">" when found in map: "</span> + cur);</span><br><span class="line"></span><br><span class="line">            <span class="keyword">return</span> <span class="keyword">false</span>;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">final</span> <span class="keyword">long</span> now = SystemClock.uptimeMillis();</span><br><span class="line">        </span><br><span class="line">        <span class="comment">//【1.1】对于非常驻类型的服务，进入这个分支！    </span></span><br><span class="line">        <span class="keyword">if</span> ((r.serviceInfo.applicationInfo.flags</span><br><span class="line">                &amp;ApplicationInfo.FLAG_PERSISTENT) == <span class="number">0</span>) &#123;</span><br><span class="line"></span><br><span class="line">            <span class="comment">// minDuration 是被系统重启的时间间隔</span></span><br><span class="line">            <span class="keyword">long</span> minDuration = SERVICE_RESTART_DURATION;</span><br><span class="line">            <span class="comment">// resetTime 是重置这个重启时间的间隔</span></span><br><span class="line">            <span class="keyword">long</span> resetTime = SERVICE_RESET_RUN_DURATION;</span><br><span class="line"></span><br><span class="line">            <span class="comment">// 便利该服务的 deliveredStarts 集合，获得所有已经被分发的启动项！！</span></span><br><span class="line">            <span class="comment">// 对于那些之前已经分发但是没有完成的启动项，要重新加入到 pendingStarts 队列中！</span></span><br><span class="line">            <span class="keyword">final</span> <span class="keyword">int</span> N = r.deliveredStarts.size();</span><br><span class="line">            <span class="keyword">if</span> (N &gt; <span class="number">0</span>) &#123;</span><br><span class="line">                <span class="keyword">for</span> (<span class="keyword">int</span> i=N-<span class="number">1</span>; i&gt;=<span class="number">0</span>; i--) &#123;</span><br><span class="line">                    ServiceRecord.StartItem si = r.deliveredStarts.get(i);</span><br><span class="line">                    si.removeUriPermissionsLocked();</span><br><span class="line"></span><br><span class="line">                    <span class="keyword">if</span> (si.intent == <span class="keyword">null</span>) &#123;</span><br><span class="line"></span><br><span class="line">                    &#125; <span class="keyword">else</span> <span class="keyword">if</span> (!allowCancel || (si.deliveryCount &lt; ServiceRecord.MAX_DELIVERY_COUNT</span><br><span class="line">                            &amp;&amp; si.doneExecutingCount &lt; ServiceRecord.MAX_DONE_EXECUTING_COUNT)) &#123;</span><br><span class="line"></span><br><span class="line">                        <span class="comment">// 如果不允许取消，显然这里 allowCancel 为 false；</span></span><br><span class="line">                        <span class="comment">// 或者该启动项的分发次数小于最大值 3 次，且处理次数小于最大值 6 次</span></span><br><span class="line">                        <span class="comment">// 才会把该启动项重新添加到 pendingStarts 列表中！</span></span><br><span class="line">                        r.pendingStarts.add(<span class="number">0</span>, si);</span><br><span class="line">                        </span><br><span class="line">                        <span class="keyword">long</span> dur = SystemClock.uptimeMillis() - si.deliveredTime;</span><br><span class="line">                        dur *= <span class="number">2</span>;</span><br><span class="line"></span><br><span class="line">                        <span class="keyword">if</span> (minDuration &lt; dur) minDuration = dur;</span><br><span class="line">                        <span class="keyword">if</span> (resetTime &lt; dur) resetTime = dur;</span><br><span class="line"></span><br><span class="line">                    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line"></span><br><span class="line">                        Slog.w(TAG, <span class="string">"Canceling start item "</span> + si.intent + <span class="string">" in service "</span></span><br><span class="line">                                + r.name);</span><br><span class="line">                        </span><br><span class="line">                        <span class="comment">// 置 canceled 为 true，表示放弃重启服务！</span></span><br><span class="line">                        canceled = <span class="keyword">true</span>;</span><br><span class="line"></span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;</span><br><span class="line"></span><br><span class="line">                r.deliveredStarts.clear();</span><br><span class="line">            &#125;</span><br><span class="line">            </span><br><span class="line">            <span class="comment">// 服务的重启次数加一；</span></span><br><span class="line">            r.totalRestartCount++;</span><br><span class="line"> </span><br><span class="line">            <span class="comment">// 计算服务的重启延迟时间；</span></span><br><span class="line">            <span class="keyword">if</span> (r.restartDelay == <span class="number">0</span>) &#123;</span><br><span class="line"></span><br><span class="line">                <span class="comment">// 如果没有重启过，restartDelay 为 0；</span></span><br><span class="line">                <span class="comment">// 那么重启延迟时间为 minDuration；</span></span><br><span class="line">                r.restartCount++;</span><br><span class="line">                r.restartDelay = minDuration;</span><br><span class="line"></span><br><span class="line">            &#125; <span class="keyword">else</span> &#123;</span><br><span class="line"></span><br><span class="line">                <span class="comment">// 如果已经重启过了，进入以下分支；</span></span><br><span class="line">                <span class="comment">// restartTime 是上一次重启的时间；</span></span><br><span class="line">                <span class="keyword">if</span> (now &gt; (r.restartTime+resetTime)) &#123;</span><br><span class="line"></span><br><span class="line">                    <span class="comment">// 并且当前时间距离上次重启时间超过了 resetTime，</span></span><br><span class="line">                    <span class="comment">// 则把 restartCount 重置为 1，restartDelay 设为 minDuration！</span></span><br><span class="line">                    r.restartCount = <span class="number">1</span>;</span><br><span class="line">                    r.restartDelay = minDuration;</span><br><span class="line"></span><br><span class="line">                &#125; <span class="keyword">else</span> &#123;</span><br><span class="line"></span><br><span class="line">                    <span class="comment">// 并且当前时间距离上次重启时间没有超过 resetTime，则调大 restartDelay！</span></span><br><span class="line">                    r.restartDelay *= SERVICE_RESTART_DURATION_FACTOR;</span><br><span class="line">                    <span class="keyword">if</span> (r.restartDelay &lt; minDuration) &#123;</span><br><span class="line">                        r.restartDelay = minDuration;</span><br><span class="line">                    &#125;</span><br><span class="line"></span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            <span class="comment">// 计算服务的下一次重启时间</span></span><br><span class="line">            r.nextRestartTime = now + r.restartDelay;</span><br><span class="line"></span><br><span class="line">            <span class="comment">// 设置所有服务的重启时间差最小为 10 秒！</span></span><br><span class="line">            <span class="comment">// 一个服务重启后，下一个服务至少 10 后才能被重启！</span></span><br><span class="line">            <span class="keyword">boolean</span> repeat;</span><br><span class="line">            <span class="keyword">do</span> &#123;</span><br><span class="line">                repeat = <span class="keyword">false</span>;</span><br><span class="line">                <span class="keyword">for</span> (<span class="keyword">int</span> i=mRestartingServices.size()-<span class="number">1</span>; i&gt;=<span class="number">0</span>; i--) &#123;</span><br><span class="line">                    ServiceRecord r2 = mRestartingServices.get(i);</span><br><span class="line">                    </span><br><span class="line">                    <span class="keyword">if</span> (r2 != r &amp;&amp; r.nextRestartTime</span><br><span class="line">                            &gt;= (r2.nextRestartTime-SERVICE_MIN_RESTART_TIME_BETWEEN)</span><br><span class="line">                            &amp;&amp; r.nextRestartTime</span><br><span class="line">                            &lt; (r2.nextRestartTime+SERVICE_MIN_RESTART_TIME_BETWEEN)) &#123;</span><br><span class="line"></span><br><span class="line">                        r.nextRestartTime = r2.nextRestartTime + SERVICE_MIN_RESTART_TIME_BETWEEN;</span><br><span class="line">                        r.restartDelay = r.nextRestartTime - now;</span><br><span class="line">                        repeat = <span class="keyword">true</span>;</span><br><span class="line">                        <span class="keyword">break</span>;</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125; <span class="keyword">while</span> (repeat);</span><br><span class="line"></span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line"></span><br><span class="line">            <span class="comment">//【1.2】常驻进程的服务要被立刻重启！</span></span><br><span class="line">            r.totalRestartCount++;</span><br><span class="line">            r.restartCount = <span class="number">0</span>;</span><br><span class="line">            r.restartDelay = <span class="number">0</span>;</span><br><span class="line">            r.nextRestartTime = now;</span><br><span class="line">        &#125;</span><br><span class="line">        </span><br><span class="line">        <span class="comment">//【2】如果 mRestartingServices 列表中服务该服务，将该服务添加进去！</span></span><br><span class="line">        <span class="keyword">if</span> (!mRestartingServices.contains(r)) &#123;</span><br><span class="line">            r.createdFromFg = <span class="keyword">false</span>;</span><br><span class="line">            mRestartingServices.add(r);</span><br><span class="line">            r.makeRestarting(mAm.mProcessStats.getMemFactorLocked(), now);</span><br><span class="line">        &#125;</span><br><span class="line">        </span><br><span class="line">        <span class="comment">//【3】取消前台的 notification，这个是通过 startForegroud 的方式设置的！</span></span><br><span class="line">        cancelForegroudNotificationLocked(r);</span><br><span class="line"></span><br><span class="line">        <span class="comment">//【4】这里是最关键的地方，执行重启服务的操作！！</span></span><br><span class="line">        <span class="comment">// 这里会使用 AMS.MainHandler 来执行重启任务</span></span><br><span class="line">        mAm.mHandler.removeCallbacks(r.restarter);</span><br><span class="line">        mAm.mHandler.postAtTime(r.restarter, r.nextRestartTime);</span><br><span class="line">        </span><br><span class="line">        <span class="comment">// 计算下次重启时间！</span></span><br><span class="line">        r.nextRestartTime = SystemClock.uptimeMillis() + r.restartDelay;</span><br><span class="line"></span><br><span class="line">        Slog.w(TAG, <span class="string">"Scheduling restart of crashed service "</span></span><br><span class="line">                + r.shortName + <span class="string">" in "</span> + r.restartDelay + <span class="string">"ms"</span>);</span><br><span class="line">        EventLog.writeEvent(EventLogTags.AM_SCHEDULE_SERVICE_RESTART,</span><br><span class="line">                r.userId, r.shortName, r.restartDelay);</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> canceled;</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure>
<p>这里涉及了几个常量：</p>
<ul>
<li><p>ActiveServices </p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 两个服务的重启间隔的最小值！</span></span><br><span class="line"><span class="keyword">static</span> <span class="keyword">final</span> <span class="keyword">int</span> SERVICE_MIN_RESTART_TIME_BETWEEN = <span class="number">10</span>*<span class="number">1000</span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 服务延迟重启的时间间隔</span></span><br><span class="line"><span class="keyword">static</span> <span class="keyword">final</span> <span class="keyword">int</span> SERVICE_RESTART_DURATION = <span class="number">1</span>*<span class="number">1000</span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 重置服务的重启时间的时间间隔</span></span><br><span class="line"><span class="keyword">static</span> <span class="keyword">final</span> <span class="keyword">int</span> SERVICE_RESET_RUN_DURATION = <span class="number">60</span>*<span class="number">1000</span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 用于扩大服务重启的时间间隔的乘法因子</span></span><br><span class="line"><span class="keyword">static</span> <span class="keyword">final</span> <span class="keyword">int</span> SERVICE_RESTART_DURATION_FACTOR = <span class="number">4</span>;</span><br></pre></td></tr></table></figure>
</li>
<li><p>ServiceRecord</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 放弃重启操作前，启动项分发的最大次数</span></span><br><span class="line"><span class="keyword">static</span> <span class="keyword">final</span> <span class="keyword">int</span> MAX_DELIVERY_COUNT = <span class="number">3</span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 放弃重启操作前，启动项执行的最大次数</span></span><br><span class="line"><span class="keyword">static</span> <span class="keyword">final</span> <span class="keyword">int</span> MAX_DONE_EXECUTING_COUNT = <span class="number">6</span>;</span><br></pre></td></tr></table></figure>
</li>
</ul>
<p>还记得 ServiceRestarter，在启动服务前，会创建一个 ServiceRestarter 对象，用于重启服务！</p>
<p>我们看到，如果服务之前重启过，并且当前时间距离上次重启时间没有超过 resetTime，则调大 restartDelay！</p>
<p>这是为了防止 service 被在内存不足的情况下被频繁重启，第一次内存不足时杀掉 service，1s 后重启该 service，重启后又消耗了一部分内存造成内存再次不足再次杀掉 service，这时1s后就不应该重启了，要往后推迟一段时间再尝试重启。</p>
<h1 id="3-ServiceRestarter-run"><a href="#3-ServiceRestarter-run" class="headerlink" title="3 ServiceRestarter.run"></a>3 ServiceRestarter.run</h1><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">private</span> <span class="class"><span class="keyword">class</span> <span class="title">ServiceRestarter</span> <span class="keyword">implements</span> <span class="title">Runnable</span> </span>&#123;</span><br><span class="line">    <span class="keyword">private</span> ServiceRecord mService;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">void</span> <span class="title">setService</span><span class="params">(ServiceRecord service)</span> </span>&#123;</span><br><span class="line">        mService = service;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">run</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">synchronized</span>(mAm) &#123;</span><br><span class="line">            </span><br><span class="line">            <span class="comment">//【1】重启服务！</span></span><br><span class="line">            performServiceRestartLocked(mService);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>继续看！</p>
<h1 id="4-ActiveServices-performServiceRestartLocked"><a href="#4-ActiveServices-performServiceRestartLocked" class="headerlink" title="4 ActiveServices.performServiceRestartLocked"></a>4 ActiveServices.performServiceRestartLocked</h1><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">final</span> <span class="keyword">void</span> <span class="title">performServiceRestartLocked</span><span class="params">(ServiceRecord r)</span> </span>&#123;</span><br><span class="line">    <span class="comment">// 如果服务没有在重启列表中，就不重启！</span></span><br><span class="line">    <span class="keyword">if</span> (!mRestartingServices.contains(r)) &#123;</span><br><span class="line">        <span class="keyword">return</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// 如果服务不再需要，就不重启！</span></span><br><span class="line">    <span class="keyword">if</span> (!isServiceNeeded(r, <span class="keyword">false</span>, <span class="keyword">false</span>)) &#123;</span><br><span class="line">        Slog.wtf(TAG, <span class="string">"Restarting service that is not needed: "</span> + r);</span><br><span class="line">        <span class="keyword">return</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">        </span><br><span class="line">        <span class="comment">//【1】进入 bringUpServiceLocked 方法，执行重启服务操作！</span></span><br><span class="line">        bringUpServiceLocked(r, r.intent.getIntent().getFlags(), r.createdFromFg, <span class="keyword">true</span>, <span class="keyword">false</span>);</span><br><span class="line">    &#125; <span class="keyword">catch</span> (TransactionTooLargeException e) &#123;</span><br><span class="line">        <span class="comment">// Ignore, it's been logged and nothing upstack cares.</span></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>这里和前面的 startService 的逻辑是一样的！但是我们重点要看的是，对于 onStartCommand 方法的返回值，在重启的时候，系统是如何处理的！！</p>
<h1 id="5-onStartCommand-返回值的不同处理"><a href="#5-onStartCommand-返回值的不同处理" class="headerlink" title="5 onStartCommand 返回值的不同处理"></a>5 onStartCommand 返回值的不同处理</h1><h2 id="5-1-START-STICKY（默认返回值）"><a href="#5-1-START-STICKY（默认返回值）" class="headerlink" title="5.1 START_STICKY（默认返回值）"></a>5.1 START_STICKY（默认返回值）</h2><p>对于 Service.START_STICKY 的返回值，服务所在进程被 kill 后，系统会重新启动该服务以及所在进程！</p>
<p>onStartCommand 方法在返回 Service.START_STICKY 后，系统会做如下处理：</p>
<ul>
<li>从 r.deliveredStarts 中删除 startId 对应的启动项</li>
<li>设置 r.stopIfKilled = false</li>
<li>设置 r.callStart = true</li>
</ul>
<p>对于这种返回值，服务的 r.deliveredStarts 和 r.pendingStarts 中的启动项都为空，所以在 scheduleServiceRestartLocked 方法中，不会遍历 deliveredStarts 集合，所以 scheduleServiceRestartLocked 的返回值 canceled 为 false；</p>
<p>sr.startRequested 在开始启动时就被设置成了 true！这样，scheduleServiceRestartLocked 方法返回后，就不会进入这个分支：<br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// sr.startRequested: true sr.stopIfKilled: false canceled: false，不进入该分支！</span></span><br><span class="line"><span class="keyword">if</span> (sr.startRequested &amp;&amp; (sr.stopIfKilled || canceled)) &#123;</span><br><span class="line"></span><br><span class="line">    ... ... ... </span><br><span class="line"></span><br><span class="line">    bringDownServiceLocked(sr);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>接下来，就是服务的重启了，这时就进入 bringUpServiceLocked 方法，因为对于 Service.START_STICKY 的返回值：<br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">if</span>(r.startRequested &amp;&amp; r.callStart &amp;&amp; r.pendingStarts.size() == <span class="number">0</span>) &#123;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>这个的条件是满足的，那就会创建一个 Intent 为 null 启动项，添加到 r.pendingStarts 中，如果你在 onStartCommand 方法中，对参数 Intent 做一个非空判断，你会发现，这个 Intent 为 null！！<br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">int</span> <span class="title">onStartCommand</span><span class="params">(Intent intent, <span class="keyword">int</span> flags, <span class="keyword">int</span> startId)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">if</span> (intent == <span class="keyword">null</span>) &#123;</span><br><span class="line">        Log.d(TAG, <span class="string">"the intent is null!"</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> Service.START_STICKY;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<h2 id="5-2-START-NOT-STICKY"><a href="#5-2-START-NOT-STICKY" class="headerlink" title="5.2 START_NOT_STICKY"></a>5.2 START_NOT_STICKY</h2><p>对于 Service.START_NOT_STICKY 的返回值，服务所在进程被 kill 后，系统不会重新启动该服务以及所在进程！</p>
<p>onStartCommand 方法在返回 Service.START_NOT_STICKY 后，系统会做如下处理：</p>
<ul>
<li>从 r.deliveredStarts 中删除 startId 对应的启动项；</li>
<li>如果 r.getLastStartId() == startId，设置 r.stopIfKilled = true；（<strong>和 START_STICKY 的不同之处</strong>）</li>
<li>r.callStart = true；</li>
</ul>
<p>对于这种返回值，服务的 r.deliveredStarts 和 r.pendingStarts 中的启动项也都为空，所以在 scheduleServiceRestartLocked 方法中，不会遍历 deliveredStarts 集合，所以 scheduleServiceRestartLocked 的返回值 canceled 同样也为 false；</p>
<p>而 sr.startRequested 在开始启动时就被设置成了 true！这样，scheduleServiceRestartLocked 返回后，根据结果，就会进入这个分支：<br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// sr.startRequested: true sr.stopIfKilled: true canceled: false</span></span><br><span class="line"><span class="keyword">if</span>(r.startRequested &amp;&amp; r.callStart &amp;&amp; r.pendingStarts.size() == <span class="number">0</span>) &#123;</span><br><span class="line">   </span><br><span class="line">    <span class="comment">// 同样的 sr.pendingStarts.size() == 0 满足条件，进入该分支！</span></span><br><span class="line">    <span class="keyword">if</span> (sr.pendingStarts.size() == <span class="number">0</span>) &#123;</span><br><span class="line">        sr.startRequested = <span class="keyword">false</span>;</span><br><span class="line">        <span class="keyword">if</span> (sr.tracker != <span class="keyword">null</span>) &#123;</span><br><span class="line">            sr.tracker.setStarted(<span class="keyword">false</span>, mAm.mProcessStats.getMemFactorLocked(),</span><br><span class="line">                    SystemClock.uptimeMillis());</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">// 如果之前服务没有自动创建的连接，就停止服务！</span></span><br><span class="line">        <span class="keyword">if</span> (!sr.hasAutoCreateConnections()) &#123;</span><br><span class="line">             bringDownServiceLocked(sr);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>如果我们之前只是通过 startService 的方式，启动了服务，那么，这里就会调用 bringDownServiceLocked 停止服务，所以，<strong>单纯的 startService，如果 onStartCommand 返回值为 Service.START_NOT_STICKY，那么服务是不会重启的</strong>！</p>
<p>但是如果还通过 bindSerivce（Service.BIND_AUTO_CREATE）的方式创建了连接，那么还是会重启服务！</p>
<h2 id="5-2-START-REDELIVER-INTENT"><a href="#5-2-START-REDELIVER-INTENT" class="headerlink" title="5.2 START_REDELIVER_INTENT"></a>5.2 START_REDELIVER_INTENT</h2><p>对于 Service.START_REDELIVER_INTENT 的返回值，服务所在进程被 kill 后，系统会重新启动该服务以及所在进程，并且会将最后启动（startService）分发过的 Intent 再次通过 onStartCommand 方法传递给服务！</p>
<p>onStartCommand 方法在返回 START_REDELIVER_INTENT 后，系统会做如下处理:</p>
<ul>
<li>从 r.deliveredStarts 中获得 startId 对应的启动项 StartItem si ，【不删除】；</li>
<li>如果 si != null：<ul>
<li>si.deliveryCount = 0;</li>
<li>si.doneExecutingCount++;（这样设置，在 7.2.3 的时候，flags 就会被设置 START_FLAG_REDELIVER 的标签）</li>
<li>r.stopIfKilled = true;</li>
</ul>
</li>
<li>r.callStart = true;</li>
</ul>
<p>因为没有删除 r.deliveredStarts 中已经被分发的启动项，所以也就意味着，如果是多次 startSerivce，那么 r.deliveredStarts 会将所有的启动项都保留下来！</p>
<p>对于这种返回值，服务的 r.deliveredStarts 保存了所有的被分发的启动项，而 r.pendingStarts 中的启动项为空，我们先到 scheduleServiceRestartLocked 方法中去！</p>
<p>在 scheduleServiceRestartLocked 方法中，会将服务的 r.deliveredStarts 中所有的启动项，添加到 r.pendingStarts 中，用于重启后分发！</p>
<p>scheduleServiceRestartLocked 方法返回后，由于 sr.startRequested 为 true，sr.stopIfKilled 为 true， 且 canceled 为 false 满足条件，则会进入以下分支：<br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// sr.startRequested: true sr.stopIfKilled: true canceled: false</span></span><br><span class="line"><span class="keyword">if</span>(r.startRequested &amp;&amp; r.callStart &amp;&amp; r.pendingStarts.size() == <span class="number">0</span>) &#123;</span><br><span class="line">   </span><br><span class="line">    <span class="comment">// 然而 sr.pendingStarts.size() ！= 0 ，不进入分支！</span></span><br><span class="line">    <span class="keyword">if</span> (sr.pendingStarts.size() == <span class="number">0</span>) &#123;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>但是由于此时，sr.pendingStarts.size() 是不为 0 的，所以就不会停止服务，而是重启服务！因为所有的启动项 si.doneExecutingCount 都大于 0，所以 onStartCommand 方法的参数 flags 会设置 Service.START_FLAG_REDELIVERY 标志位！</p>
<p>当 onStartCommand 方法被拉起后，传入的 Intent 就是之前 startService 时传入的 Intent，如果之前多次调用了 startService 方法，那么当服务被重启后，onStartCommand 方法会被拉起多次，传入的 Intent 则是按照之前多次调用 startService 的 startId 顺序进行传入！</p>
<p>第二种是，当服务所在的进程因内存不足而被 <code>kill</code> 掉，会触发 <code>AMS.cleanUpApplicationRecordLocked</code> 方法，用于清理进程的资源：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">final</span> <span class="keyword">boolean</span> <span class="title">cleanUpApplicationRecordLocked</span><span class="params">(ProcessRecord app,</span></span></span><br><span class="line"><span class="function"><span class="params">        <span class="keyword">boolean</span> restarting, <span class="keyword">boolean</span> allowRestart, <span class="keyword">int</span> index, <span class="keyword">boolean</span> replacingPid)</span> </span>&#123;</span><br><span class="line">    Slog.d(TAG, <span class="string">"cleanUpApplicationRecord -- "</span> + app.pid);</span><br><span class="line"></span><br><span class="line">    ... ... ... ...</span><br><span class="line">    </span><br><span class="line">    <span class="comment">//【1】这里会杀掉该进程中的所有服务，allownRestart 方式是否允许服务重启！</span></span><br><span class="line">    mServices.killServicesLocked(app, allowRestart);</span><br><span class="line">    </span><br><span class="line">    ... ... ... ...</span><br><span class="line">    </span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h1 id="1-ActiveServices-killServicesLocked"><a href="#1-ActiveServices-killServicesLocked" class="headerlink" title="1 ActiveServices.killServicesLocked"></a>1 ActiveServices.killServicesLocked</h1><p>参数传递：</p>
<ul>
<li><code>ProcessRecord app</code>：被 <code>kill</code> 掉的进程！</li>
<li><code>boolean allowRestart</code>：表示是否重启服务，当进程被杀掉后，传入 <code>true</code>！</li>
</ul>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">final</span> <span class="keyword">void</span> <span class="title">killServicesLocked</span><span class="params">(ProcessRecord app, <span class="keyword">boolean</span> allowRestart)</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 默认不进入该分支，我们不看！</span></span><br><span class="line">    <span class="keyword">if</span> (<span class="keyword">false</span>) &#123;</span><br><span class="line">        ... ... ...</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 清楚这个进程持有的所有的连接对象 ConnectionRecord！</span></span><br><span class="line">    <span class="keyword">for</span> (<span class="keyword">int</span> i = app.connections.size() - <span class="number">1</span>; i &gt;= <span class="number">0</span>; i--) &#123;</span><br><span class="line">        ConnectionRecord r = app.connections.valueAt(i);</span><br><span class="line">        </span><br><span class="line">        <span class="comment">// 这里和调用 unbindService 方法很类似，主要是解除该进程对其他服务的绑定！</span></span><br><span class="line">        removeConnectionLocked(r, app, <span class="keyword">null</span>);</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line">    updateServiceConnectionActivitiesLocked(app);</span><br><span class="line">    app.connections.clear();</span><br><span class="line"></span><br><span class="line">    app.whitelistManager = <span class="keyword">false</span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//【1】遍历被 kill 掉的进程中的所有服务!</span></span><br><span class="line">    <span class="keyword">for</span> (<span class="keyword">int</span> i = app.services.size() - <span class="number">1</span>; i &gt;= <span class="number">0</span>; i--) &#123;</span><br><span class="line">        ServiceRecord sr = app.services.valueAt(i);</span><br><span class="line">        <span class="keyword">synchronized</span> (sr.stats.getBatteryStats()) &#123;</span><br><span class="line">            sr.stats.stopLaunchedLocked();</span><br><span class="line">        &#125;</span><br><span class="line">        </span><br><span class="line">        <span class="comment">// 如果该服务所在进程不是当前进程，并且进程仍在运行，且不是常驻进程</span></span><br><span class="line">        <span class="comment">// 那就从服务所在进程中移除该服务！</span></span><br><span class="line">        <span class="keyword">if</span> (sr.app != app &amp;&amp; sr.app != <span class="keyword">null</span> &amp;&amp; !sr.app.persistent) &#123;</span><br><span class="line">            sr.app.services.remove(sr);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        sr.app = <span class="keyword">null</span>;</span><br><span class="line">        sr.isolatedProc = <span class="keyword">null</span>;</span><br><span class="line">        sr.executeNesting = <span class="number">0</span>;</span><br><span class="line">        sr.forceClearTracker();</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (mDestroyingServices.remove(sr)) &#123;</span><br><span class="line">            <span class="keyword">if</span> (DEBUG_SERVICE) Slog.v(TAG_SERVICE, <span class="string">"killServices remove destroying "</span> + sr);</span><br><span class="line">        &#125;</span><br><span class="line"> </span><br><span class="line">        <span class="comment">// 在 ServiceRecord.bindings 中保存了绑定该服务的所有 intent 和 IntentBindRecord 的映射关系！</span></span><br><span class="line">        <span class="keyword">final</span> <span class="keyword">int</span> numClients = sr.bindings.size();</span><br><span class="line">        </span><br><span class="line">        <span class="keyword">for</span> (<span class="keyword">int</span> bindingi=numClients-<span class="number">1</span>; bindingi&gt;=<span class="number">0</span>; bindingi--) &#123;</span><br><span class="line">            IntentBindRecord b = sr.bindings.valueAt(bindingi);</span><br><span class="line">            </span><br><span class="line">            <span class="keyword">if</span> (DEBUG_SERVICE) Slog.v(TAG_SERVICE, <span class="string">"Killing binding "</span> + b</span><br><span class="line">                    + <span class="string">": shouldUnbind="</span> + b.hasBound);</span><br><span class="line">                </span><br><span class="line">            <span class="comment">// 初始化 IntentBindRecord 一切属性！  </span></span><br><span class="line">            b.binder = <span class="keyword">null</span>;</span><br><span class="line">            b.requested = b.received = b.hasBound = <span class="keyword">false</span>;</span><br><span class="line"></span><br><span class="line">            <span class="comment">// If this binding is coming from a cached process and is asking to keep</span></span><br><span class="line">            <span class="comment">// the service created, then we'll kill the cached process as well -- we</span></span><br><span class="line">            <span class="comment">// don't want to be thrashing around restarting processes that are only</span></span><br><span class="line">            <span class="comment">// there to be cached.</span></span><br><span class="line">            <span class="comment">// 遍历 IntentBindRecord 对象的 apps 哈希表，该哈希表保存了使用该 Intent 绑定该服务的所有进程</span></span><br><span class="line">            <span class="comment">// ProcessRecord 和进程绑定信息 AppBindRecord 的映射关系！</span></span><br><span class="line">            <span class="keyword">for</span> (<span class="keyword">int</span> appi=b.apps.size()-<span class="number">1</span>; appi&gt;=<span class="number">0</span>; appi--) &#123;</span><br><span class="line">                <span class="keyword">final</span> ProcessRecord proc = b.apps.keyAt(appi);</span><br><span class="line"></span><br><span class="line">                <span class="comment">// 如果进程被杀了或者没有启动，就跳过处理！</span></span><br><span class="line">                <span class="keyword">if</span> (proc.killedByAm || proc.thread == <span class="keyword">null</span>) &#123;</span><br><span class="line">                    <span class="keyword">continue</span>;</span><br><span class="line">                &#125;</span><br><span class="line"></span><br><span class="line">                <span class="comment">// Only do this for processes that have an auto-create binding;</span></span><br><span class="line">                <span class="comment">// otherwise the binding can be left, because it won't cause the</span></span><br><span class="line">                <span class="comment">// service to restart.</span></span><br><span class="line">                <span class="comment">// 判断该进程持有的所有连接对象 ConnectionRecord 是否是通过 BIND_FLAG_AUTO 方式创建的！</span></span><br><span class="line">                <span class="keyword">final</span> AppBindRecord abind = b.apps.valueAt(appi);</span><br><span class="line">                <span class="keyword">boolean</span> hasCreate = <span class="keyword">false</span>;</span><br><span class="line"></span><br><span class="line">                <span class="keyword">for</span> (<span class="keyword">int</span> conni=abind.connections.size()-<span class="number">1</span>; conni&gt;=<span class="number">0</span>; conni--) &#123;</span><br><span class="line">                    ConnectionRecord conn = abind.connections.valueAt(conni);</span><br><span class="line"></span><br><span class="line">                    <span class="keyword">if</span> ((conn.flags&amp;(Context.BIND_AUTO_CREATE|Context.BIND_ALLOW_OOM_MANAGEMENT</span><br><span class="line">                            |Context.BIND_WAIVE_PRIORITY)) == Context.BIND_AUTO_CREATE) &#123;</span><br><span class="line">                            </span><br><span class="line">                        <span class="comment">// 设 hasCreate 为 true，表示存在自动创建的绑定！</span></span><br><span class="line">                        hasCreate = <span class="keyword">true</span>;</span><br><span class="line">                        <span class="keyword">break</span>;</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;</span><br><span class="line"></span><br><span class="line">                <span class="keyword">if</span> (!hasCreate) &#123;</span><br><span class="line"></span><br><span class="line">                    <span class="comment">// 不存在自动创建的连接，就跳过这个服务！</span></span><br><span class="line">                    <span class="keyword">continue</span>;</span><br><span class="line">                &#125;</span><br><span class="line"></span><br><span class="line">                <span class="comment">// 如果存在自动创建的连接，如果该进程不是常驻进程，并且该进程在运行中，</span></span><br><span class="line">                <span class="comment">// 该进程的 pid 不等于 0，也不等于系统进程 pid，且进程的状态不低于 PROCESS_STATE_LAST_ACTIVITY</span></span><br><span class="line">                <span class="comment">// 那就要尝试杀掉进程，解除绑定！</span></span><br><span class="line">                <span class="keyword">if</span> (<span class="keyword">false</span> &amp;&amp; proc != <span class="keyword">null</span> &amp;&amp; !proc.persistent &amp;&amp; proc.thread != <span class="keyword">null</span></span><br><span class="line">                        &amp;&amp; proc.pid != <span class="number">0</span> &amp;&amp; proc.pid != ActivityManagerService.MY_PID</span><br><span class="line">                        &amp;&amp; proc.setProcState &gt;= ActivityManager.PROCESS_STATE_LAST_ACTIVITY) &#123;</span><br><span class="line"></span><br><span class="line">                    proc.kill(<span class="string">"bound to service "</span> + sr.name.flattenToShortString()</span><br><span class="line">                            + <span class="string">" in dying proc "</span> + (app != <span class="keyword">null</span> ? app.processName : <span class="string">"??"</span>), <span class="keyword">true</span>);</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    ServiceMap smap = getServiceMap(app.userId);</span><br><span class="line"></span><br><span class="line">    <span class="comment">//【2】开始处理被 kill 的进程中的服务！</span></span><br><span class="line">    <span class="keyword">for</span> (<span class="keyword">int</span> i=app.services.size()-<span class="number">1</span>; i&gt;=<span class="number">0</span>; i--) &#123;</span><br><span class="line">        ServiceRecord sr = app.services.valueAt(i);</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 如果该进程不是常驻进程，就要从进程的 services 中移除该服务！</span></span><br><span class="line">        <span class="keyword">if</span> (!app.persistent) &#123;</span><br><span class="line">            app.services.removeAt(i);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 如果当前的服务和服务集合中的服务无法匹配，就跳过不处理！</span></span><br><span class="line">        <span class="keyword">final</span> ServiceRecord curRec = smap.mServicesByName.get(sr.name);</span><br><span class="line">        <span class="keyword">if</span> (curRec != sr) &#123;</span><br><span class="line">            <span class="keyword">if</span> (curRec != <span class="keyword">null</span>) &#123;</span><br><span class="line">                Slog.wtf(TAG, <span class="string">"Service "</span> + sr + <span class="string">" in process "</span> + app</span><br><span class="line">                        + <span class="string">" not same as in map: "</span> + curRec);</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">continue</span>;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (allowRestart &amp;&amp; sr.crashCount &gt;= <span class="number">2</span> &amp;&amp; (sr.serviceInfo.applicationInfo.flags</span><br><span class="line">                &amp;ApplicationInfo.FLAG_PERSISTENT) == <span class="number">0</span>) &#123;</span><br><span class="line">            <span class="comment">// 如果允许重启，且服务的 crash 次数大于 2，并且服务不是常驻服务，停止服务！</span></span><br><span class="line">                </span><br><span class="line">            Slog.w(TAG, <span class="string">"Service crashed "</span> + sr.crashCount</span><br><span class="line">                    + <span class="string">" times, stopping: "</span> + sr);</span><br><span class="line"></span><br><span class="line">            EventLog.writeEvent(EventLogTags.AM_SERVICE_CRASHED_TOO_MUCH,</span><br><span class="line">                    sr.userId, sr.crashCount, sr.shortName, app.pid);</span><br><span class="line"></span><br><span class="line">            bringDownServiceLocked(sr);</span><br><span class="line"></span><br><span class="line">        &#125; <span class="keyword">else</span> <span class="keyword">if</span> (!allowRestart</span><br><span class="line">                || !mAm.mUserController.isUserRunningLocked(sr.userId, <span class="number">0</span>)) &#123;</span><br><span class="line">            </span><br><span class="line">            <span class="comment">// 如果不允许重启或者服务所在的设备用户不再运行状态，就停止服务！</span></span><br><span class="line">            bringDownServiceLocked(sr);</span><br><span class="line"></span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line"></span><br><span class="line">            <span class="comment">//【2.1】尝试重启服务！</span></span><br><span class="line">            <span class="keyword">boolean</span> canceled = scheduleServiceRestartLocked(sr, <span class="keyword">true</span>);</span><br><span class="line"></span><br><span class="line">            <span class="comment">// 根据尝试重启的结果，看是否需要停止服务！</span></span><br><span class="line">            <span class="keyword">if</span> (sr.startRequested &amp;&amp; (sr.stopIfKilled || canceled)) &#123;</span><br><span class="line">                <span class="keyword">if</span> (sr.pendingStarts.size() == <span class="number">0</span>) &#123;</span><br><span class="line">                    sr.startRequested = <span class="keyword">false</span>;</span><br><span class="line">                    <span class="keyword">if</span> (sr.tracker != <span class="keyword">null</span>) &#123;</span><br><span class="line">                        sr.tracker.setStarted(<span class="keyword">false</span>, mAm.mProcessStats.getMemFactorLocked(),</span><br><span class="line">                                SystemClock.uptimeMillis());</span><br><span class="line">                    &#125;</span><br><span class="line">                    </span><br><span class="line">                    <span class="comment">// 如果之前服务没有自动创建的连接，就停止服务！</span></span><br><span class="line">                    <span class="keyword">if</span> (!sr.hasAutoCreateConnections()) &#123;</span><br><span class="line">                        bringDownServiceLocked(sr);</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// 清理完成后！</span></span><br><span class="line">    <span class="comment">// 如果不允许重启，就把服务从 ServiceRecord 从 mRestartingServices 和 mPendingServices 中删除！</span></span><br><span class="line">    <span class="keyword">if</span> (!allowRestart) &#123;</span><br><span class="line">        app.services.clear();</span><br><span class="line"></span><br><span class="line">        <span class="keyword">for</span> (<span class="keyword">int</span> i=mRestartingServices.size()-<span class="number">1</span>; i&gt;=<span class="number">0</span>; i--) &#123;</span><br><span class="line"></span><br><span class="line">            ServiceRecord r = mRestartingServices.get(i);</span><br><span class="line">            <span class="keyword">if</span> (r.processName.equals(app.processName) &amp;&amp;</span><br><span class="line">                    r.serviceInfo.applicationInfo.uid == app.info.uid) &#123;</span><br><span class="line"></span><br><span class="line">                mRestartingServices.remove(i);</span><br><span class="line">                clearRestartingIfNeededLocked(r);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">for</span> (<span class="keyword">int</span> i=mPendingServices.size()-<span class="number">1</span>; i&gt;=<span class="number">0</span>; i--) &#123;</span><br><span class="line">            ServiceRecord r = mPendingServices.get(i);</span><br><span class="line">            <span class="keyword">if</span> (r.processName.equals(app.processName) &amp;&amp;</span><br><span class="line">                    r.serviceInfo.applicationInfo.uid == app.info.uid) &#123;</span><br><span class="line"></span><br><span class="line">                mPendingServices.remove(i);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 从 mDestroyingServices 中删除该服务！</span></span><br><span class="line">    <span class="keyword">int</span> i = mDestroyingServices.size();</span><br><span class="line">    <span class="keyword">while</span> (i &gt; <span class="number">0</span>) &#123;</span><br><span class="line">        i--;</span><br><span class="line">        ServiceRecord sr = mDestroyingServices.get(i);</span><br><span class="line">        <span class="keyword">if</span> (sr.app == app) &#123;</span><br><span class="line"></span><br><span class="line">            sr.forceClearTracker();</span><br><span class="line">            mDestroyingServices.remove(i);</span><br><span class="line">            <span class="keyword">if</span> (DEBUG_SERVICE) Slog.v(TAG_SERVICE, <span class="string">"killServices remove destroying "</span> + sr);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    app.executingServices.clear();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>这里会调用 <code>scheduleServiceRestartLocked</code> 方法来重启服务，我们继续看！</p>
<h1 id="10-总结"><a href="#10-总结" class="headerlink" title="10 总结"></a>10 总结</h1><h2 id="10-1-相关-Log"><a href="#10-1-相关-Log" class="headerlink" title="10.1 相关 Log"></a>10.1 相关 Log</h2><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line"><span class="number">01</span>-<span class="number">04</span> <span class="number">19</span>:<span class="number">28</span>:<span class="number">23.824</span>  <span class="number">1765</span>  <span class="number">3962</span> W ActiveServices:  scheduleServiceRestartLocked  N <span class="number">0</span> now <span class="number">7648574</span> r ServiceRecord&#123;<span class="number">9463951</span> u0 com.cooqi.servicedemo/.service.AService&#125;</span><br><span class="line"><span class="number">01</span>-<span class="number">04</span> <span class="number">19</span>:<span class="number">28</span>:<span class="number">23.824</span>  <span class="number">1765</span>  <span class="number">3962</span> W ActiveServices:  scheduleServiceRestartLocked  r.totalRestartCount <span class="number">2</span> r ServiceRecord&#123;<span class="number">9463951</span> u0 com.cooqi.servicedemo/.service.AService&#125;</span><br><span class="line"><span class="number">01</span>-<span class="number">04</span> <span class="number">19</span>:<span class="number">28</span>:<span class="number">23.824</span>  <span class="number">1765</span>  <span class="number">3962</span> W ActiveServices: r.name ComponentInfo&#123;com.cooqi.servicedemo/com.cooqi.servicedemo.service.AService&#125; N <span class="number">0</span> minDuration <span class="number">1000</span> resetTime <span class="number">60000</span> now <span class="number">7648574</span> r.restartDelay <span class="number">0</span> r.restartTime+resetTime <span class="number">7605288</span> allowCancel <span class="keyword">true</span></span><br><span class="line"><span class="number">01</span>-<span class="number">04</span> <span class="number">19</span>:<span class="number">28</span>:<span class="number">23.825</span>  <span class="number">1765</span>  <span class="number">3962</span> W ActiveServices: r.name ComponentInfo&#123;com.cooqi.servicedemo/com.cooqi.servicedemo.service.AService&#125; N <span class="number">0</span> minDuration <span class="number">1000</span> resetTime <span class="number">60000</span> now <span class="number">7648574</span> r.restartDelay <span class="number">1000</span> r.restartTime+resetTime <span class="number">7605288</span> r.nextRestartTime <span class="number">7649574</span> allowCancel <span class="keyword">true</span></span><br><span class="line"><span class="number">01</span>-<span class="number">04</span> <span class="number">19</span>:<span class="number">28</span>:<span class="number">23.825</span>  <span class="number">1765</span>  <span class="number">3962</span> W ActiveServices: r ServiceRecord&#123;<span class="number">9463951</span> u0 com.cooqi.servicedemo/.service.AService&#125; r.restartDelay <span class="number">1000</span> r.nextRestartTime <span class="number">7649574</span></span><br><span class="line"><span class="number">01</span>-<span class="number">04</span> <span class="number">19</span>:<span class="number">28</span>:<span class="number">23.825</span>  <span class="number">1765</span>  <span class="number">3962</span> W ActiveServices: r ServiceRecord&#123;<span class="number">9463951</span> u0 com.cooqi.servicedemo/.service.AService&#125; r.restartDelay <span class="number">1000</span> r.nextRestartTime <span class="number">7649575</span></span><br><span class="line"><span class="number">01</span>-<span class="number">04</span> <span class="number">19</span>:<span class="number">28</span>:<span class="number">23.825</span>  <span class="number">1765</span>  <span class="number">3962</span> W ActiveServices: Scheduling restart of crashed service com.cooqi.servicedemo/.service.AService in <span class="number">1000</span>ms</span><br><span class="line"><span class="number">01</span>-<span class="number">04</span> <span class="number">19</span>:<span class="number">28</span>:<span class="number">23.825</span>  <span class="number">1765</span>  <span class="number">3962</span> W ActiveServices: Restarting list - i <span class="number">0</span> r2.nextRestartTime <span class="number">7649575</span> r2.name ComponentInfo&#123;com.cooqi.servicedemo/com.cooqi.servicedemo.service.AService&#125;</span><br><span class="line"><span class="number">01</span>-<span class="number">04</span> <span class="number">19</span>:<span class="number">28</span>:<span class="number">23.826</span>  <span class="number">1765</span>  <span class="number">3962</span> V ActiveServices: scheduleServiceRestartLocked r ServiceRecord&#123;<span class="number">9463951</span> u0 com.cooqi.servicedemo/.service.AService&#125; call by com.android.server.am.ActiveServices.killServicesLocked:<span class="number">3066</span> com.android.server.am.ActivityManagerService.cleanUpApplicationRecordLocked:<span class="number">19081</span> com.android.server.am.ActivityManagerService.handleAppDiedLocked:<span class="number">5813</span> com.android.server.am.ActivityManagerService.appDiedLocked:<span class="number">5988</span> com.android.server.am.ActivityManagerService$AppDeathRecipient.binderDied:<span class="number">1656</span> android.os.BinderProxy.sendDeathNotice:<span class="number">688</span> &lt;bottom of call stack&gt; &lt;bottom of call stack&gt;</span><br><span class="line"><span class="number">01</span>-<span class="number">04</span> <span class="number">19</span>:<span class="number">28</span>:<span class="number">24.827</span>  <span class="number">1765</span>  <span class="number">1788</span> V ActiveServices: Bringing up ServiceRecord&#123;<span class="number">9463951</span> u0 com.cooqi.servicedemo/.service.AService&#125; android.content.Intent$FilterComparison@<span class="number">7</span>df9497b</span><br><span class="line"><span class="number">01</span>-<span class="number">04</span> <span class="number">19</span>:<span class="number">28</span>:<span class="number">24.828</span>  <span class="number">1765</span>  <span class="number">1788</span> V ActiveServices_MU: bringUpServiceLocked: appInfo.uid=<span class="number">10106</span> app=<span class="keyword">null</span></span><br><span class="line"><span class="number">01</span>-<span class="number">04</span> <span class="number">19</span>:<span class="number">28</span>:<span class="number">24.943</span>  <span class="number">1765</span>  <span class="number">1804</span> V ActiveServices_MU: realStartServiceLocked, ServiceRecord.uid = <span class="number">10106</span>, ProcessRecord.uid = <span class="number">10106</span></span><br><span class="line"><span class="number">01</span>-<span class="number">04</span> <span class="number">19</span>:<span class="number">28</span>:<span class="number">24.943</span>  <span class="number">1765</span>  <span class="number">1804</span> V ActiveServices: &gt;&gt;&gt; EXECUTING create of ServiceRecord&#123;<span class="number">9463951</span> u0 com.cooqi.servicedemo/.service.AService&#125; in app ProcessRecord&#123;ea46ad6 <span class="number">9319</span>:com.cooqi.servicedemo/u0a106&#125;</span><br><span class="line"><span class="number">01</span>-<span class="number">04</span> <span class="number">19</span>:<span class="number">28</span>:<span class="number">24.943</span>  <span class="number">1765</span>  <span class="number">1804</span> V ActiveServices: bumpServiceExecutingLocked r.executeNesting <span class="number">0</span></span><br><span class="line"><span class="number">01</span>-<span class="number">04</span> <span class="number">19</span>:<span class="number">28</span>:<span class="number">24.943</span>  <span class="number">1765</span>  <span class="number">1804</span> V ActiveServices: bumpServiceExecutingLocked r.app.executingServices.size() <span class="number">1</span></span><br><span class="line"><span class="number">01</span>-<span class="number">04</span> <span class="number">19</span>:<span class="number">28</span>:<span class="number">24.962</span>  <span class="number">1765</span>  <span class="number">1804</span> V ActiveServices: Sending arguments to: ServiceRecord&#123;<span class="number">9463951</span> u0 com.cooqi.servicedemo/.service.AService&#125; android.content.Intent$FilterComparison@<span class="number">7</span>df9497b args=<span class="keyword">null</span></span><br><span class="line"><span class="number">01</span>-<span class="number">04</span> <span class="number">19</span>:<span class="number">28</span>:<span class="number">24.962</span>  <span class="number">1765</span>  <span class="number">1804</span> V ActiveServices: &gt;&gt;&gt; EXECUTING start of ServiceRecord&#123;<span class="number">9463951</span> u0 com.cooqi.servicedemo/.service.AService&#125; in app ProcessRecord&#123;ea46ad6 <span class="number">9319</span>:com.cooqi.servicedemo/u0a106&#125;</span><br><span class="line"><span class="number">01</span>-<span class="number">04</span> <span class="number">19</span>:<span class="number">28</span>:<span class="number">24.962</span>  <span class="number">1765</span>  <span class="number">1804</span> V ActiveServices: bumpServiceExecutingLocked r.executeNesting <span class="number">1</span></span><br><span class="line"><span class="number">01</span>-<span class="number">04</span> <span class="number">19</span>:<span class="number">28</span>:<span class="number">25.112</span>  <span class="number">9319</span>  <span class="number">9319</span> D ServiceTest: AService: onCreate</span><br><span class="line"><span class="number">01</span>-<span class="number">04</span> <span class="number">19</span>:<span class="number">28</span>:<span class="number">25.112</span>  <span class="number">1765</span>  <span class="number">3964</span> V ActiveServices: serviceDoneExecutingLocked ServiceRecord= ServiceRecord&#123;<span class="number">9463951</span> u0 com.cooqi.servicedemo/.service.AService&#125; type= <span class="number">0</span> startId= <span class="number">0</span> res= <span class="number">0</span></span><br><span class="line"><span class="number">01</span>-<span class="number">04</span> <span class="number">19</span>:<span class="number">28</span>:<span class="number">25.112</span>  <span class="number">9319</span>  <span class="number">9319</span> D ServiceTest: AService: onStartCommand</span><br><span class="line"><span class="number">01</span>-<span class="number">04</span> <span class="number">19</span>:<span class="number">28</span>:<span class="number">25.113</span>  <span class="number">1765</span>  <span class="number">3964</span> V ActiveServices: &lt;&lt;&lt; DONE EXECUTING ServiceRecord&#123;<span class="number">9463951</span> u0 com.cooqi.servicedemo/.service.AService&#125;: nesting=<span class="number">2</span>, inDestroying=<span class="keyword">false</span>, app=ProcessRecord&#123;ea46ad6 <span class="number">9319</span>:com.cooqi.servicedemo/u0a106&#125;</span><br><span class="line"><span class="number">01</span>-<span class="number">04</span> <span class="number">19</span>:<span class="number">28</span>:<span class="number">25.113</span>  <span class="number">1765</span>  <span class="number">3964</span> V ActiveServices: serviceDoneExecutingLocked ServiceRecord= ServiceRecord&#123;<span class="number">9463951</span> u0 com.cooqi.servicedemo/.service.AService&#125; type= <span class="number">1</span> startId= <span class="number">6</span> res= <span class="number">1</span></span><br><span class="line"><span class="number">01</span>-<span class="number">04</span> <span class="number">19</span>:<span class="number">28</span>:<span class="number">25.113</span>  <span class="number">1765</span>  <span class="number">3964</span> V ActiveServices: &lt;&lt;&lt; DONE EXECUTING ServiceRecord&#123;<span class="number">9463951</span> u0 com.cooqi.servicedemo/.service.AService&#125;: nesting=<span class="number">1</span>, inDestroying=<span class="keyword">false</span>, app=ProcessRecord&#123;ea46ad6 <span class="number">9319</span>:com.cooqi.servicedemo/u0a106&#125;</span><br><span class="line"><span class="number">01</span>-<span class="number">04</span> <span class="number">19</span>:<span class="number">28</span>:<span class="number">25.113</span>  <span class="number">1765</span>  <span class="number">3964</span> V ActiveServices: Nesting at <span class="number">0</span> of com.cooqi.servicedemo/.service.AService</span><br><span class="line"><span class="number">01</span>-<span class="number">04</span> <span class="number">19</span>:<span class="number">28</span>:<span class="number">25.113</span>  <span class="number">1765</span>  <span class="number">3964</span> V ActiveServices: r.app.executingServices.size(): <span class="number">0</span></span><br><span class="line"><span class="number">01</span>-<span class="number">04</span> <span class="number">19</span>:<span class="number">28</span>:<span class="number">25.113</span>  <span class="number">1765</span>  <span class="number">3964</span> V ActiveServices: No more executingServices of com.cooqi.servicedemo/.service.AService</span><br></pre></td></tr></table></figure>
</div></article><script data-ad-client="ca-pub-6845729157331145" async src="https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script><div class="post-copyright"><div class="post-copyright__author"><span class="post-copyright-meta">文章作者: </span><span class="post-copyright-info"><a href="mailto:undefined">Coolqi.Li</a></span></div><div class="post-copyright__type"><span class="post-copyright-meta">文章链接: </span><span class="post-copyright-info"><a href="https://lishuaiqi.top/2016/09/21/Serivce7-serviceRestart/">https://lishuaiqi.top/2016/09/21/Serivce7-serviceRestart/</a></span></div><div class="post-copyright__notice"><span class="post-copyright-meta">版权声明: </span><span class="post-copyright-info">本博客所有文章除特别声明外，均采用 <a href="https://creativecommons.org/licenses/by-nc-sa/4.0/">CC BY-NC-SA 4.0</a> 许可协议。转载请注明来自 <a href="https://lishuaiqi.top">Coolqi`s Blog</a>！</span></div></div><div class="post-meta__tag-list"><a class="post-meta__tags" href="/tags/Service服务/">Service服务</a></div><div class="post-qr-code"><div class="post-qr-code-item"><img class="post-qr-code__img" src="/img/zfb.jpg"><div class="post-qr-code__desc">支付宝打赏</div></div><div class="post-qr-code-item"><img class="post-qr-code__img" src="/img/wechat.jpg"><div class="post-qr-code__desc">微信打赏</div></div></div><div class="social-share pull-right"></div><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/social-share.js@1.0.16/dist/css/share.min.css"><script src="https://cdn.jsdelivr.net/npm/social-share.js@1.0.16/dist/js/social-share.min.js"></script><nav id="pagination"><div class="prev-post pull-left"><a href="/2016/10/29/Serivce8-serviceStopSelf/"><i class="fa fa-chevron-left">  </i><span>Serivce 篇 8 - Service stopSelf 流程分析</span></a></div><div class="next-post pull-right"><a href="/2016/08/13/BroadcastReceiver7-broadcastReceiverSummary/"><span>BroadcastReceiver篇 7 - BroadcastReceiver 广播机制总结</span><i class="fa fa-chevron-right"></i></a></div></nav><div id="vcomment"></div><script src="https://cdn1.lncld.net/static/js/3.0.4/av-min.js"></script><script src="https://cdn.jsdelivr.net/npm/valine/dist/Valine.min.js"></script><script>var notify = 'false' == 'true';
var verify = 'false' == 'true';
var record_ip = '' == 'true';
var GUEST_INFO = ['nick','mail','link'];
var guest_info = ''.split(',').filter(function(item){
  return GUEST_INFO.indexOf(item) > -1
});
guest_info = guest_info.length == 0 ? GUEST_INFO :guest_info;
window.valine = new Valine({
  el:'#vcomment',
  notify:notify,
  verify:verify,
  recordIP:record_ip,
  appId:'eedJikU7JeDetXjbjw27DWBz-gzGzoHsz',
  appKey:'woFTBOpMKS9EASNUpbaA9Jvc',
  placeholder:'Just go go',
  avatar:'mm',
  guest_info:guest_info,
  pageSize:'10',
  lang: 'zh-cn'
})</script></div></div><footer class="footer-bg" style="background-image: url(/img/blog-bg.jpg)"><div class="layout" id="footer"><div class="copyright">&copy;2015 - 2020 By Coolqi.Li</div><div class="framework-info"><span>驱动 - </span><a href="http://hexo.io"><span>Hexo</span></a><span class="footer-separator">|</span><span>主题 - </span><a href="https://github.com/Molunerfinn/hexo-theme-melody"><span>Melody</span></a></div><div class="footer_custom_text">Hi, welcome to my <a href="https://lishuaiqi.top/">blog</a>!</div><div class="busuanzi"><script async src="//busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script><span id="busuanzi_container_page_pv"><i class="fa fa-file-o"></i><span id="busuanzi_value_page_pv"></span><span></span></span></div></div></footer><i class="fa fa-arrow-up" id="go-up" aria-hidden="true"></i><script src="/js/third-party/anime.min.js"></script><script src="/js/third-party/jquery.min.js"></script><script src="/js/third-party/jquery.fancybox.min.js"></script><script src="/js/third-party/velocity.min.js"></script><script src="/js/third-party/velocity.ui.min.js"></script><script src="/js/utils.js?version=1.7.0"></script><script src="/js/fancybox.js?version=1.7.0"></script><script src="/js/sidebar.js?version=1.7.0"></script><script src="/js/copy.js?version=1.7.0"></script><script src="/js/fireworks.js?version=1.7.0"></script><script src="/js/transition.js?version=1.7.0"></script><script src="/js/scroll.js?version=1.7.0"></script><script src="/js/head.js?version=1.7.0"></script><script type="text/x-mathjax-config">MathJax.Hub.Config({
  tex2jax: {
    inlineMath: [ ['$','$'], ["\\(","\\)"]  ],
    processEscapes: true,
    skipTags: ['script', 'noscript', 'style', 'textarea', 'pre', 'code']
  },
  CommonHTML: {
    linebreaks: { automatic: true, width: "90% container" }
  },
  "HTML-CSS": { 
    linebreaks: { automatic: true, width: "90% container" }
  },
  "SVG": { 
    linebreaks: { automatic: true, width: "90% container" }
  }
});
</script><script type="text/x-mathjax-config">MathJax.Hub.Queue(function() {
  var all = MathJax.Hub.getAllJax(), i;
  for (i=0; i < all.length; i += 1) {
    all[i].SourceElement().parentNode.className += ' has-jax';
  }
});
</script><script src="https://cdn.jsdelivr.net/npm/mathjax/MathJax.js?config=TeX-AMS-MML_HTMLorMML"></script><script src="/js/search/local-search.js"></script><script>if(/Android|webOS|iPhone|iPod|iPad|BlackBerry/i.test(navigator.userAgent)) {
  $('#nav').addClass('is-mobile')
  $('footer').addClass('is-mobile')
  $('#top-container').addClass('is-mobile')
}</script><div class="search-dialog" id="local-search"><div class="search-dialog__title" id="local-search-title">本地搜索</div><div id="local-input-panel"><div id="local-search-input"><div class="local-search-box"><input class="local-search-box--input" placeholder="搜索文章"></div></div></div><hr><div id="local-search-results"><div id="local-hits"></div><div id="local-stats"><div class="local-search-stats__hr" id="hr"><span>由</span> <a href="https://github.com/wzpan/hexo-generator-search" style="color:#49B1F5;">hexo-generator-search</a>
 <span>提供支持</span></div></div></div><span class="search-close-button"><i class="fa fa-times"></i></span></div><div class="search-mask"></div></body></html>
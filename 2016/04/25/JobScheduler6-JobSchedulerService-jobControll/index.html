<!DOCTYPE html><html lang="zh-Hans"><head><meta charset="UTF-8"><meta http-equiv="X-UA-Compatible" content="IE=edge"><meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1"><meta name="description" content="JobScheduler第 6 篇 - JobSchedulerService - job controll"><meta name="keywords" content="JobScheduler任务调度"><meta name="author" content="Coolqi.Li,undefined"><meta name="copyright" content="Coolqi.Li"><title>JobScheduler第 6 篇 - JobSchedulerService - job controll | Coolqi`s Blog</title><link rel="shortcut icon" href="/img/favicon.ico"><link rel="stylesheet" href="/css/index.css?version=1.5.6"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/font-awesome@4.7.0/css/font-awesome.min.css?version=1.5.6"><link rel="dns-prefetch" href="https://cdn.staticfile.org"><link rel="dns-prefetch" href="https://cdn.bootcss.com"><link rel="dns-prefetch" href="https://creativecommons.org"><link rel="stylesheet" type="text/css" href="https://cdn.jsdelivr.net/npm/gitalk/dist/gitalk.min.css"><script src="https://cdn.jsdelivr.net/gh/upupming/gitalk@36368e5dffd049e956cdbbd751ff96c28d8255cf/dist/gitalk.min.js"></script><script src="https://cdn.jsdelivr.net/npm/blueimp-md5@2.10.0/js/md5.min.js"></script><link rel="dns-prefetch" href="https://hm.baidu.com"><script>var _hmt = _hmt || [];
(function() {
  var hm = document.createElement("script");
  hm.src = "https://hm.baidu.com/hm.js?b7acef5306e54116ad8a99e8b753a92d";
  var s = document.getElementsByTagName("script")[0]; 
  s.parentNode.insertBefore(hm, s);
})();</script><script>var GLOBAL_CONFIG = { 
  root: '/',
  algolia: undefined,
  localSearch: {"path":"search.xml","languages":{"hits_empty":"找不到您查询的内容:${query}"}},
  copy: {
    success: '复制成功',
    error: '复制错误',
    noSupport: '浏览器不支持'
  }
} </script></head><body><i class="fa fa-arrow-right" id="toggle-sidebar" aria-hidden="true"></i><div id="sidebar"><div class="toggle-sidebar-info text-center"><span data-toggle="切换文章详情">切换站点概览</span><hr></div><div class="sidebar-toc"><div class="sidebar-toc__title">目录</div><div class="sidebar-toc__progress"><span class="progress-notice">你已经读了</span><span class="progress-num">0</span><span class="progress-percentage">%</span><div class="sidebar-toc__progress-bar"></div></div><div class="sidebar-toc__content"><ol class="toc"><li class="toc-item toc-level-1"><a class="toc-link" href="#前言"><span class="toc-text">前言</span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#1-ConnectivityController"><span class="toc-text">1 ConnectivityController</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#1-1-CC-ConnectivityReceiver"><span class="toc-text">1.1 CC.ConnectivityReceiver</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#1-2-CC-NetPolicyListener"><span class="toc-text">1.2 CC.NetPolicyListener</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#1-3-CC-updateTrackedJobs"><span class="toc-text">1.3 CC.updateTrackedJobs</span></a></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#2-TimeController"><span class="toc-text">2 TimeController</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#2-1-maybeStartTrackingJobLocked"><span class="toc-text">2.1 maybeStartTrackingJobLocked</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#2-2-maybeUpdateAlarmsLocked"><span class="toc-text">2.2 maybeUpdateAlarmsLocked</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#2-3-setXXXXExpiredAlarmLocked"><span class="toc-text">2.3 setXXXXExpiredAlarmLocked</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#2-3-1-maybeAdjustAlarmTime"><span class="toc-text">2.3.1 maybeAdjustAlarmTime</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#2-3-2-updateAlarmWithListenerLocked"><span class="toc-text">2.3.2 updateAlarmWithListenerLocked</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#2-3-2-1-mNextDelayExpiredListener"><span class="toc-text">2.3.2.1 mNextDelayExpiredListener</span></a><ol class="toc-child"><li class="toc-item toc-level-5"><a class="toc-link" href="#2-3-2-1-1-checkExpiredDelaysAndResetAlarm"><span class="toc-text">2.3.2.1.1 checkExpiredDelaysAndResetAlarm</span></a></li></ol></li><li class="toc-item toc-level-4"><a class="toc-link" href="#2-3-2-2-mDeadlineExpiredListener"><span class="toc-text">2.3.2.2 mDeadlineExpiredListener</span></a><ol class="toc-child"><li class="toc-item toc-level-5"><a class="toc-link" href="#2-3-2-2-1-checkExpiredDeadlinesAndResetAlarm"><span class="toc-text">2.3.2.2.1 checkExpiredDeadlinesAndResetAlarm</span></a></li></ol></li></ol></li></ol></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#3-IdleController"><span class="toc-text">3 IdleController</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#3-1-IdlenessTracker"><span class="toc-text">3.1 IdlenessTracker</span></a></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#4-BatteryController"><span class="toc-text">4 BatteryController</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#4-1-ChargingTracker"><span class="toc-text">4.1 ChargingTracker</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#4-1-1-maybeReportNewChargingState"><span class="toc-text">4.1.1 maybeReportNewChargingState</span></a></li></ol></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#5-AppIdleController"><span class="toc-text">5 AppIdleController</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#5-1-AppIdleStateChangeListener"><span class="toc-text">5.1 AppIdleStateChangeListener</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#5-1-1-PackageUpdateFunc"><span class="toc-text">5.1.1 PackageUpdateFunc</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#5-1-2-setAppIdleParoleOn"><span class="toc-text">5.1.2 setAppIdleParoleOn</span></a></li></ol></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#6-ContentObserverController"><span class="toc-text">6 ContentObserverController</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#6-1-maybeStartTrackingJobLocked"><span class="toc-text">6.1 maybeStartTrackingJobLocked</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#6-1-1-JobInstance"><span class="toc-text">6.1.1 JobInstance</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#6-1-2-ObserverInstance"><span class="toc-text">6.1.2 ObserverInstance</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#6-1-2-1-JI-scheduleLocked"><span class="toc-text">6.1.2.1 JI.scheduleLocked</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#6-1-2-2-JI-trigger"><span class="toc-text">6.1.2.2 JI.trigger</span></a></li></ol></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#6-2-maybeStopTrackingJobLocked"><span class="toc-text">6.2 maybeStopTrackingJobLocked</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#6-2-1-JI-detachLocked"><span class="toc-text">6.2.1 JI.detachLocked</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#6-3-prepareForExecutionLocked"><span class="toc-text">6.3 prepareForExecutionLocked</span></a></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#7-DeviceIdleJobsController"><span class="toc-text">7 DeviceIdleJobsController</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#7-1-BroadcastReceiver"><span class="toc-text">7.1 BroadcastReceiver</span></a></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#8-附录"><span class="toc-text">8 附录</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#8-1-JobStatus-setConstraintSatisfied"><span class="toc-text">8.1 JobStatus.setConstraintSatisfied</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#8-1-JobStatus-isConstraintSatisfied"><span class="toc-text">8.1 JobStatus.isConstraintSatisfied</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#8-3-JobSchedulerService"><span class="toc-text">8.3 JobSchedulerService</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#8-3-Controller-和对应的条件"><span class="toc-text">8.3 Controller 和对应的条件</span></a></li></ol></li></ol></div></div><div class="author-info hide"><div class="author-info__avatar text-center"><img src="/img/avatar.png"></div><div class="author-info__name text-center">Coolqi.Li</div><div class="author-info__description text-center">“你好，我是李帅奇，Android 系统工程师，MineCraft 忠实玩家，设计和绘画爱好者，缺妹纸晚期患者，熬夜星人。”</div><hr><div class="author-info-articles"><a class="author-info-articles__archives article-meta" href="/archives"><span class="pull-left">文章</span><span class="pull-right">70</span></a><a class="author-info-articles__tags article-meta" href="/tags"><span class="pull-left">标签</span><span class="pull-right">15</span></a><a class="author-info-articles__categories article-meta" href="/categories"><span class="pull-left">分类</span><span class="pull-right">17</span></a></div><hr><div class="author-info-links"><div class="author-info-links__title text-center">Links</div><a class="author-info-links__name text-center" href="https://developer.android.google.cn/">AndroidDeveloper</a><a class="author-info-links__name text-center" href="http://www.android-studio.org/">AndroidStudio</a><a class="author-info-links__name text-center" href="https://www.jianshu.com/u/123a20a96441">简书</a><a class="author-info-links__name text-center" href="https://weibo.com/coolqiLi">微博</a></div></div></div><div id="content-outer"><div id="top-container" style="background-image: url(https://ws1.sinaimg.cn/large/8700af19ly1fvpabr30o6j22yo1o0q7i.jpg)"><div id="page-header"><span class="pull-left"> <a id="site-name" href="/">Coolqi`s Blog</a></span><i class="fa fa-bars toggle-menu pull-right" aria-hidden="true"></i><span class="pull-right menus"><a class="site-page social-icon search"><i class="fa fa-search"></i><span> 搜索</span></a><a class="site-page" href="/">Home</a><a class="site-page" href="/categories">Categories</a><a class="site-page" href="/tags">Tags</a><a class="site-page" href="/archives">Archives</a><a class="site-page" href="/about">About</a></span></div><div id="post-info"><div id="post-title">JobScheduler第 6 篇 - JobSchedulerService - job controll</div><div id="post-meta"><time class="post-meta__date"><i class="fa fa-calendar" aria-hidden="true"></i> 2016-04-25</time><span class="post-meta__separator">|</span><i class="fa fa-inbox post-meta__icon" aria-hidden="true"></i><a class="post-meta__categories" href="/categories/AndroidFramework源码分析/">AndroidFramework源码分析</a><i class="fa fa-angle-right" aria-hidden="true"></i><i class="fa fa-inbox post-meta__icon" aria-hidden="true"></i><a class="post-meta__categories" href="/categories/AndroidFramework源码分析/JobScheduler任务调度/">JobScheduler任务调度</a><div class="post-meta-wordcount"><span>字数总计: </span><span class="word-count">8.3k</span><span class="post-meta__separator">|</span><span>阅读时长: 37 分钟</span></div></div></div></div><div class="layout" id="content-inner"><article id="post"><div class="article-container" id="post-content"><p>基于 Android 7.1.1 源码分析，分析 job controller 的实现机制！</p>
<h1 id="前言"><a href="#前言" class="headerlink" title="前言"></a>前言</h1><p>我们知道，当我们把 job schedule 进入 JobSchedulerService 中后，JobSchdulerService 会拉起它，之前我们分析了用户主动 cancel 和 jobFinished job 时，具体的函数调用，而对于 job 除了受的到用户的主动操作之外，还有 controller 的控制，接下来，我们来看看那这部分代码！</p>
<p>Job 的 controll 都是在 controller 中，controller 的初始化是在 JobSchedulerService 中：<br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="title">JobSchedulerService</span><span class="params">(Context context)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">super</span>(context);</span><br><span class="line">    mHandler = <span class="keyword">new</span> JobHandler(context.getMainLooper());</span><br><span class="line">    mConstants = <span class="keyword">new</span> Constants(mHandler);</span><br><span class="line">    mJobSchedulerStub = <span class="keyword">new</span> JobSchedulerStub();</span><br><span class="line">    mJobs = JobStore.initAndGet(<span class="keyword">this</span>);</span><br><span class="line"></span><br><span class="line">    <span class="comment">// Create the controllers.</span></span><br><span class="line">    mControllers = <span class="keyword">new</span> ArrayList&lt;StateController&gt;();</span><br><span class="line">    mControllers.add(ConnectivityController.get(<span class="keyword">this</span>));</span><br><span class="line">    mControllers.add(TimeController.get(<span class="keyword">this</span>));</span><br><span class="line">    mControllers.add(IdleController.get(<span class="keyword">this</span>));</span><br><span class="line">    mControllers.add(BatteryController.get(<span class="keyword">this</span>));</span><br><span class="line">    mControllers.add(AppIdleController.get(<span class="keyword">this</span>));</span><br><span class="line">    mControllers.add(ContentObserverController.get(<span class="keyword">this</span>));</span><br><span class="line">    mControllers.add(DeviceIdleJobsController.get(<span class="keyword">this</span>));</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>每一个 Controller 都采用了单例模式，保证了有且仅有一个 Controller，每个 Controller 内部都有一个集合用来管理其所控制的左右 job！</p>
<p>接下来，我们一个一个看：</p>
<h1 id="1-ConnectivityController"><a href="#1-ConnectivityController" class="headerlink" title="1 ConnectivityController"></a>1 ConnectivityController</h1><p>ConnectivityController 主要是用来根据网络条件来控制 job！<br>我们先来看构造器：<br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">private</span> <span class="title">ConnectivityController</span><span class="params">(StateChangedListener stateChangedListener, Context context,</span></span></span><br><span class="line"><span class="function"><span class="params">        Object lock)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">super</span>(stateChangedListener, context, lock);</span><br><span class="line"></span><br><span class="line">    mConnManager = mContext.getSystemService(ConnectivityManager.class);</span><br><span class="line">    mNetPolicyManager = mContext.getSystemService(NetworkPolicyManager.class);</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 这里很简单，注册了一个广播接收者，监听 ConnectivityManager.CONNECTIVITY_ACTION 广播!</span></span><br><span class="line">    <span class="keyword">final</span> IntentFilter intentFilter = <span class="keyword">new</span> IntentFilter(ConnectivityManager.CONNECTIVITY_ACTION);</span><br><span class="line">    mContext.registerReceiverAsUser(</span><br><span class="line">            mConnectivityReceiver, UserHandle.SYSTEM, intentFilter, <span class="keyword">null</span>, <span class="keyword">null</span>);</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 向网络策略管理服务注册监听器！</span></span><br><span class="line">    mNetPolicyManager.registerListener(mNetPolicyListener);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>ConnectivityController 对 job 的控制主要依靠这两个监听器：</p>
<h2 id="1-1-CC-ConnectivityReceiver"><a href="#1-1-CC-ConnectivityReceiver" class="headerlink" title="1.1 CC.ConnectivityReceiver"></a>1.1 CC.ConnectivityReceiver</h2><p>我们先来看看第一个：<br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">private</span> BroadcastReceiver mConnectivityReceiver = <span class="keyword">new</span> BroadcastReceiver() &#123;</span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onReceive</span><span class="params">(Context context, Intent intent)</span> </span>&#123;</span><br><span class="line">        updateTrackedJobs(-<span class="number">1</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure></p>
<p>这个很简单，当网络断开或连接，会调用 updateTrackedJobs 方法！ </p>
<h2 id="1-2-CC-NetPolicyListener"><a href="#1-2-CC-NetPolicyListener" class="headerlink" title="1.2 CC.NetPolicyListener"></a>1.2 CC.NetPolicyListener</h2><p>接着看看网络策略监听器，当网络策略发生变化后，会回调接口：<br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">private</span> INetworkPolicyListener mNetPolicyListener = <span class="keyword">new</span> INetworkPolicyListener.Stub() &#123;</span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onUidRulesChanged</span><span class="params">(<span class="keyword">int</span> uid, <span class="keyword">int</span> uidRules)</span> </span>&#123;</span><br><span class="line">        updateTrackedJobs(uid);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onMeteredIfacesChanged</span><span class="params">(String[] meteredIfaces)</span> </span>&#123;</span><br><span class="line">        updateTrackedJobs(-<span class="number">1</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onRestrictBackgroundChanged</span><span class="params">(<span class="keyword">boolean</span> restrictBackground)</span> </span>&#123;</span><br><span class="line">        updateTrackedJobs(-<span class="number">1</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onRestrictBackgroundWhitelistChanged</span><span class="params">(<span class="keyword">int</span> uid, <span class="keyword">boolean</span> whitelisted)</span> </span>&#123;</span><br><span class="line">        updateTrackedJobs(uid);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onRestrictBackgroundBlacklistChanged</span><span class="params">(<span class="keyword">int</span> uid, <span class="keyword">boolean</span> blacklisted)</span> </span>&#123;</span><br><span class="line">        updateTrackedJobs(uid);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure></p>
<p>可以发现，最终都调用了 updateTrackedJobs 方法：</p>
<h2 id="1-3-CC-updateTrackedJobs"><a href="#1-3-CC-updateTrackedJobs" class="headerlink" title="1.3 CC.updateTrackedJobs"></a>1.3 CC.updateTrackedJobs</h2><p>通过传入的 uid 的值，来更新具体的 job 状态！<br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">updateTrackedJobs</span><span class="params">(<span class="keyword">int</span> uid)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">synchronized</span> (mLock) &#123;</span><br><span class="line">        <span class="keyword">boolean</span> changed = <span class="keyword">false</span>;</span><br><span class="line">        <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; mTrackedJobs.size(); i++) &#123;</span><br><span class="line"></span><br><span class="line">            <span class="comment">// 遍历 job 监控列表</span></span><br><span class="line">            <span class="keyword">final</span> JobStatus js = mTrackedJobs.get(i);</span><br><span class="line"></span><br><span class="line">            <span class="comment">// 关键点！</span></span><br><span class="line">            <span class="keyword">if</span> (uid == -<span class="number">1</span> || uid == js.getSourceUid()) &#123;</span><br><span class="line">                changed |= updateConstraintsSatisfied(js);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (changed) &#123; <span class="comment">// changed 为 ture 表示约束条件改变！</span></span><br><span class="line">            mStateChangedListener.onControllerStateChanged();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>更新策略分析：</p>
<ul>
<li>如果 uid 的值为 -1，那就更新这个控制器监视的所有 job；</li>
<li>如果 uid 的值为指定的 uid，那就更新属于这个 uid 的所有 job；</li>
</ul>
<p>这里调用了 updateConstraintsSatisfied 方法判断是否有 job 需要更新：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">boolean</span> <span class="title">updateConstraintsSatisfied</span><span class="params">(JobStatus jobStatus)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">final</span> <span class="keyword">boolean</span> ignoreBlocked = (jobStatus.getFlags() &amp; JobInfo.FLAG_WILL_BE_FOREGROUND) != <span class="number">0</span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 获得这个 job 所属 uid （应用程序）的网络信息对象：NetworkInfo！</span></span><br><span class="line">    <span class="keyword">final</span> NetworkInfo info = mConnManager.getActiveNetworkInfoForUid(jobStatus.getSourceUid(),</span><br><span class="line">            ignoreBlocked);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">final</span> <span class="keyword">boolean</span> connected = (info != <span class="keyword">null</span>) &amp;&amp; info.isConnected();</span><br><span class="line">    <span class="keyword">final</span> <span class="keyword">boolean</span> unmetered = connected &amp;&amp; !info.isMetered();</span><br><span class="line">    <span class="keyword">final</span> <span class="keyword">boolean</span> notRoaming = connected &amp;&amp; !info.isRoaming();</span><br><span class="line">    <span class="keyword">boolean</span> changed = <span class="keyword">false</span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 根据网络信息来更新 job 的状态，动态更新 satisfiedConstraints 的对应二进制位！</span></span><br><span class="line">    changed |= jobStatus.setConnectivityConstraintSatisfied(connected);</span><br><span class="line">    changed |= jobStatus.setUnmeteredConstraintSatisfied(unmetered);</span><br><span class="line">    changed |= jobStatus.setNotRoamingConstraintSatisfied(notRoaming);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> changed;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>这个方法获得这个 job 所属 uid （应用程序）的网络信息对象， 根据网络信息来更新 job！利用 |= 方法，只要有一个约束条件发生了变化，即发生了变化！<br>最后，调用 mStateChangedListener 的 onControllerStateChanged 方法来通知有 job 变化了！</p>
<p>ConnectivityController 的 startTrack 和 stopTrack 也很简单：<br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">maybeStartTrackingJobLocked</span><span class="params">(JobStatus jobStatus, JobStatus lastJob)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">if</span> (jobStatus.hasConnectivityConstraint() || jobStatus.hasUnmeteredConstraint()</span><br><span class="line">            || jobStatus.hasNotRoamingConstraint()) &#123;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 在监控 job 之前，检查一下约束条件，并更新 job 的状态！</span></span><br><span class="line">        updateConstraintsSatisfied(jobStatus); </span><br><span class="line">        </span><br><span class="line">        <span class="comment">// 添加到监控列表！</span></span><br><span class="line">        mTrackedJobs.add(jobStatus);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">maybeStopTrackingJobLocked</span><span class="params">(JobStatus jobStatus, JobStatus incomingJob,</span></span></span><br><span class="line"><span class="function"><span class="params">        <span class="keyword">boolean</span> forUpdate)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">if</span> (jobStatus.hasConnectivityConstraint() || jobStatus.hasUnmeteredConstraint()</span><br><span class="line">            || jobStatus.hasNotRoamingConstraint()) &#123;</span><br><span class="line">       </span><br><span class="line">        <span class="comment">// 从监控列表中移除！</span></span><br><span class="line">        mTrackedJobs.remove(jobStatus);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>先到这里，不多说了！</p>
<h1 id="2-TimeController"><a href="#2-TimeController" class="headerlink" title="2 TimeController"></a>2 TimeController</h1><p>接下来，看看时间控制器，一个 job 的超时和延迟处理，都是由这个控制器处理的：<br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">private</span> <span class="title">TimeController</span><span class="params">(StateChangedListener stateChangedListener, Context context, Object lock)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">super</span>(stateChangedListener, context, lock);</span><br><span class="line">    <span class="comment">// 初始化为无限大！</span></span><br><span class="line">    mNextJobExpiredElapsedMillis = Long.MAX_VALUE;</span><br><span class="line">    mNextDelayExpiredElapsedMillis = Long.MAX_VALUE;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>可以看到，构造器中的代码很简单，重点不在这里啦！</p>
<h2 id="2-1-maybeStartTrackingJobLocked"><a href="#2-1-maybeStartTrackingJobLocked" class="headerlink" title="2.1 maybeStartTrackingJobLocked"></a>2.1 maybeStartTrackingJobLocked</h2><p>在  maybeStartTrackingJobLocked，参数传递：</p>
<ul>
<li>JobStatus job：这次要执行的 job</li>
<li>JobStatus lastJob：被取代的 job，可以为 null！<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">maybeStartTrackingJobLocked</span><span class="params">(JobStatus job, JobStatus lastJob)</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 判断 job 是否设置了延迟时间和超时时间！</span></span><br><span class="line">    <span class="keyword">if</span> (job.hasTimingDelayConstraint() || job.hasDeadlineConstraint()) &#123;</span><br><span class="line">        maybeStopTrackingJobLocked(job, <span class="keyword">null</span>, <span class="keyword">false</span>);</span><br><span class="line"></span><br><span class="line">        <span class="keyword">boolean</span> isInsert = <span class="keyword">false</span>;</span><br><span class="line">        ListIterator&lt;JobStatus&gt; it = mTrackedJobs.listIterator(mTrackedJobs.size());</span><br><span class="line">        </span><br><span class="line">        <span class="comment">// 遍历 track 集合，根据超时处理的时间升序排列，插入新的 job！</span></span><br><span class="line">        <span class="keyword">while</span> (it.hasPrevious()) &#123;</span><br><span class="line">            JobStatus ts = it.previous();</span><br><span class="line">            <span class="keyword">if</span> (ts.getLatestRunTimeElapsed() &lt; job.getLatestRunTimeElapsed()) &#123;</span><br><span class="line">                <span class="comment">// Insert</span></span><br><span class="line">                isInsert = <span class="keyword">true</span>;</span><br><span class="line">                <span class="keyword">break</span>;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (isInsert) &#123;</span><br><span class="line">            it.next();</span><br><span class="line">        &#125;</span><br><span class="line">        it.add(job);</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 设置延时处理和超时处理的 alarm！</span></span><br><span class="line">        maybeUpdateAlarmsLocked(</span><br><span class="line">                job.hasTimingDelayConstraint() ? job.getEarliestRunTime() : Long.MAX_VALUE,</span><br><span class="line">                job.hasDeadlineConstraint() ? job.getLatestRunTimeElapsed() : Long.MAX_VALUE,</span><br><span class="line">                job.getSourceUid());</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
</li>
</ul>
<p>可以看到：</p>
<ul>
<li>如果 job 设置了延时触发条件，那么需要传入一个延迟时间值，这个时间值在这里通过 job.getEarliestRunTime() 获取！</li>
<li>如果 job 设置了超时处理触发条件，那么需要传入一个超时时间值，这个时间值在这里通过 job.getLatestRunTimeElapsed() 获取！</li>
<li>如果没有设置，默认为 Long.MAX_VALUE！</li>
</ul>
<p>注意：TimeController 的监控集合是以每个 job 的超时时间点排序的！</p>
<h2 id="2-2-maybeUpdateAlarmsLocked"><a href="#2-2-maybeUpdateAlarmsLocked" class="headerlink" title="2.2 maybeUpdateAlarmsLocked"></a>2.2 maybeUpdateAlarmsLocked</h2><p>接着进入 maybeUpdateAlarmsLocked 方法中，参数传递：</p>
<ul>
<li>long delayExpiredElapsed：延迟触发时间！</li>
<li>long deadlineExpiredElapsed：超时处理时间！</li>
</ul>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">maybeUpdateAlarmsLocked</span><span class="params">(<span class="keyword">long</span> delayExpiredElapsed, <span class="keyword">long</span> deadlineExpiredElapsed,</span></span></span><br><span class="line"><span class="function"><span class="params">        <span class="keyword">int</span> uid)</span> </span>&#123;</span><br><span class="line">        </span><br><span class="line">    <span class="comment">// mNextDelayExpiredElapsedMillis 的值为 Long.MAX_VALUE</span></span><br><span class="line">    <span class="keyword">if</span> (delayExpiredElapsed &lt; mNextDelayExpiredElapsedMillis) &#123;</span><br><span class="line">        setDelayExpiredAlarmLocked(delayExpiredElapsed, uid);</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// mNextJobExpiredElapsedMillis 的值为 Long.MAX_VALUE</span></span><br><span class="line">    <span class="keyword">if</span> (deadlineExpiredElapsed &lt; mNextJobExpiredElapsedMillis) &#123;</span><br><span class="line">        setDeadlineExpiredAlarmLocked(deadlineExpiredElapsed, uid);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>这里调用了两个方法，来设定 alarm：</p>
<h2 id="2-3-setXXXXExpiredAlarmLocked"><a href="#2-3-setXXXXExpiredAlarmLocked" class="headerlink" title="2.3 setXXXXExpiredAlarmLocked"></a>2.3 setXXXXExpiredAlarmLocked</h2><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 延时处理闹钟设置！</span></span><br><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">setDelayExpiredAlarmLocked</span><span class="params">(<span class="keyword">long</span> alarmTimeElapsedMillis, <span class="keyword">int</span> uid)</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 校验时间，最小等于从开机到现在的时间！</span></span><br><span class="line">    alarmTimeElapsedMillis = maybeAdjustAlarmTime(alarmTimeElapsedMillis);</span><br><span class="line"></span><br><span class="line">    mNextDelayExpiredElapsedMillis = alarmTimeElapsedMillis;</span><br><span class="line">    updateAlarmWithListenerLocked(DELAY_TAG, mNextDelayExpiredListener,</span><br><span class="line">            mNextDelayExpiredElapsedMillis, uid);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 超时处理闹钟设置！</span></span><br><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">setDeadlineExpiredAlarmLocked</span><span class="params">(<span class="keyword">long</span> alarmTimeElapsedMillis, <span class="keyword">int</span> uid)</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 校验时间，最小等于从开机到现在的时间！</span></span><br><span class="line">    alarmTimeElapsedMillis = maybeAdjustAlarmTime(alarmTimeElapsedMillis);</span><br><span class="line">    mNextJobExpiredElapsedMillis = alarmTimeElapsedMillis;</span><br><span class="line"></span><br><span class="line">    updateAlarmWithListenerLocked(DEADLINE_TAG, mDeadlineExpiredListener,</span><br><span class="line">            mNextJobExpiredElapsedMillis, uid);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>这里的代码很有意思：<br>首先返回一个正确的延迟或者超时处理时间点，然后根据这个时间点设置一个 alarm，时间点到了，会触发这个 alarm，linster  的回调会被执行！<br>我们继续看：</p>
<h3 id="2-3-1-maybeAdjustAlarmTime"><a href="#2-3-1-maybeAdjustAlarmTime" class="headerlink" title="2.3.1 maybeAdjustAlarmTime"></a>2.3.1 maybeAdjustAlarmTime</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">long</span> <span class="title">maybeAdjustAlarmTime</span><span class="params">(<span class="keyword">long</span> proposedAlarmTimeElapsedMillis)</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">     <span class="comment">// 获得从开机到现在的时间！</span></span><br><span class="line">     <span class="keyword">final</span> <span class="keyword">long</span> earliestWakeupTimeElapsed = SystemClock.elapsedRealtime();</span><br><span class="line">     </span><br><span class="line">     <span class="comment">// 取 job 的时间和开机时间的最大值！ </span></span><br><span class="line">     <span class="keyword">if</span> (proposedAlarmTimeElapsedMillis &lt; earliestWakeupTimeElapsed) &#123;</span><br><span class="line">         <span class="keyword">return</span> earliestWakeupTimeElapsed;</span><br><span class="line">     &#125;</span><br><span class="line">     <span class="keyword">return</span> proposedAlarmTimeElapsedMillis;</span><br><span class="line"> &#125;</span><br></pre></td></tr></table></figure>
<p>这个方法是用来和开机时间比较的，返回一个最大值，确保时间正确性！</p>
<h3 id="2-3-2-updateAlarmWithListenerLocked"><a href="#2-3-2-updateAlarmWithListenerLocked" class="headerlink" title="2.3.2 updateAlarmWithListenerLocked"></a>2.3.2 updateAlarmWithListenerLocked</h3><p>这里是设置一个 alarm，在指定时间触发 alarm，执行 job，参数传递：</p>
<ul>
<li>String tag：表示 alarm 的 tag，可取值为 DELAY_TAG 或者 DEADLINE_TAG；</li>
<li>OnAlarmListener listener：OnAlarmListener 对象！</li>
<li>long alarmTimeElapsed：触发时间！</li>
<li>int uid： job 的 uid </li>
</ul>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">updateAlarmWithListenerLocked</span><span class="params">(String tag, OnAlarmListener listener,</span></span></span><br><span class="line"><span class="function"><span class="params">        <span class="keyword">long</span> alarmTimeElapsed, <span class="keyword">int</span> uid)</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 获得 alarmService 代理对象！    </span></span><br><span class="line">    ensureAlarmServiceLocked();</span><br><span class="line">    <span class="keyword">if</span> (alarmTimeElapsed == Long.MAX_VALUE) &#123;</span><br><span class="line">        mAlarmService.cancel(listener);</span><br><span class="line"></span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        <span class="keyword">if</span> (DEBUG) &#123;</span><br><span class="line">            Slog.d(TAG, <span class="string">"Setting "</span> + tag + <span class="string">" for: "</span> + alarmTimeElapsed);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// important point！</span></span><br><span class="line">        mAlarmService.set(AlarmManager.ELAPSED_REALTIME_WAKEUP, alarmTimeElapsed,</span><br><span class="line">                AlarmManager.WINDOW_HEURISTIC, <span class="number">0</span>, tag, listener, <span class="keyword">null</span>, <span class="keyword">new</span> WorkSource(uid));</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>这里会在时间点 alarmTimeElapsed 到达时，触发 alarm，执行监听器 OnAlarmListener listener 的 onAlarm 方法：</p>
<h4 id="2-3-2-1-mNextDelayExpiredListener"><a href="#2-3-2-1-mNextDelayExpiredListener" class="headerlink" title="2.3.2.1 mNextDelayExpiredListener"></a>2.3.2.1 mNextDelayExpiredListener</h4><p>我们先来看看延迟处理的 Listener：<br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">private</span> <span class="keyword">final</span> OnAlarmListener mNextDelayExpiredListener = <span class="keyword">new</span> OnAlarmListener() &#123;</span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onAlarm</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">if</span> (DEBUG) &#123;</span><br><span class="line">            Slog.d(TAG, <span class="string">"Delay-expired alarm fired"</span>);</span><br><span class="line">        &#125;</span><br><span class="line">        </span><br><span class="line">        <span class="comment">// 时间点到后会触发 checkExpiredDelaysAndResetAlarm 方法！</span></span><br><span class="line">        checkExpiredDelaysAndResetAlarm();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure></p>
<h5 id="2-3-2-1-1-checkExpiredDelaysAndResetAlarm"><a href="#2-3-2-1-1-checkExpiredDelaysAndResetAlarm" class="headerlink" title="2.3.2.1.1 checkExpiredDelaysAndResetAlarm"></a>2.3.2.1.1 checkExpiredDelaysAndResetAlarm</h5><p>这里调用了 checkExpiredDelaysAndResetAlarm 方法：<br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">checkExpiredDelaysAndResetAlarm</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    <span class="keyword">synchronized</span> (mLock) &#123;</span><br><span class="line">    </span><br><span class="line">        <span class="comment">// 获得从开机到现在的时间</span></span><br><span class="line">        <span class="keyword">final</span> <span class="keyword">long</span> nowElapsedMillis = SystemClock.elapsedRealtime();</span><br><span class="line">        <span class="keyword">long</span> nextDelayTime = Long.MAX_VALUE;</span><br><span class="line">        <span class="keyword">int</span> nextDelayUid = <span class="number">0</span>;</span><br><span class="line">        <span class="keyword">boolean</span> ready = <span class="keyword">false</span>; <span class="comment">// 默认为 false，表示是否有 job 准备执行！</span></span><br><span class="line"></span><br><span class="line">        Iterator&lt;JobStatus&gt; it = mTrackedJobs.iterator(); <span class="comment">// 遍历 track 集合！</span></span><br><span class="line">        <span class="keyword">while</span> (it.hasNext()) &#123;</span><br><span class="line">            <span class="keyword">final</span> JobStatus job = it.next();</span><br><span class="line"></span><br><span class="line">            <span class="keyword">if</span> (!job.hasTimingDelayConstraint()) &#123; </span><br><span class="line">                <span class="keyword">continue</span>;</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            <span class="comment">// 获得每个 job 的延迟处理时间；</span></span><br><span class="line">            <span class="keyword">final</span> <span class="keyword">long</span> jobDelayTime = job.getEarliestRunTime();</span><br><span class="line"></span><br><span class="line">            <span class="keyword">if</span> (jobDelayTime &lt;= nowElapsedMillis) &#123; <span class="comment">// 说明延时触发时间点到了！</span></span><br><span class="line">               </span><br><span class="line">                <span class="comment">// 设置该 job 的对应 TimingDelay 二进制位为 1，表示满足条件！</span></span><br><span class="line">                job.setTimingDelayConstraintSatisfied(<span class="keyword">true</span>); </span><br><span class="line">                </span><br><span class="line">                <span class="keyword">if</span> (canStopTrackingJobLocked(job)) &#123;</span><br><span class="line">                    it.remove();</span><br><span class="line">                &#125;</span><br><span class="line">                </span><br><span class="line">                <span class="keyword">if</span> (job.isReady()) &#123; <span class="comment">// 如果 job 准备好了，就准备执行 job！</span></span><br><span class="line">                    ready = <span class="keyword">true</span>;</span><br><span class="line">                &#125;</span><br><span class="line">                </span><br><span class="line">            &#125; <span class="keyword">else</span> <span class="keyword">if</span> (!job.isConstraintSatisfied(JobStatus.CONSTRAINT_TIMING_DELAY)) &#123;</span><br><span class="line"></span><br><span class="line">                <span class="comment">// 这里是为了在剩余的，本次未触发的 job 里，找到延时触发时间最短的 job，并以它的延迟触发时间，</span></span><br><span class="line">                <span class="comment">// 作为下次 alarm 的触发时间点！</span></span><br><span class="line">                <span class="keyword">if</span> (nextDelayTime &gt; jobDelayTime) &#123;</span><br><span class="line">                    nextDelayTime = jobDelayTime;</span><br><span class="line">                    nextDelayUid = job.getSourceUid();</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (ready) &#123; <span class="comment">// 如果是 true，通知 jobScheduler！</span></span><br><span class="line">            mStateChangedListener.onControllerStateChanged();</span><br><span class="line">        &#125;</span><br><span class="line">        </span><br><span class="line">        <span class="comment">// 设置下一轮的 alarm!</span></span><br><span class="line">        setDelayExpiredAlarmLocked(nextDelayTime, nextDelayUid);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>当 lisener 的回调被执行时，这个时候，job 的延时处理时间会小于等于系统从开机到现在的时间，所以会进入第一个 if 分支！</p>
<p>对于本次没有触发，且没有被取消的 job，找到延时处理时间最短的 job，并以它的延迟触发时间，作为下次 alarm 的触发时间点！</p>
<p>这里调用了 <code>job.isReady()</code>，判断一个 job 是否准备好：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">public boolean isReady() &#123;</span><br><span class="line"></span><br><span class="line">    // 判断 job 的 deadline 条件是否满足，只对非周期 job 才会有；</span><br><span class="line">    final boolean deadlineSatisfied = (!job.isPeriodic() &amp;&amp; hasDeadlineConstraint()</span><br><span class="line">            &amp;&amp; (satisfiedConstraints &amp; CONSTRAINT_DEADLINE) != 0);</span><br><span class="line">    </span><br><span class="line">    // 判断应用处于非空闲状态的条件是否满足！</span><br><span class="line">    final boolean notIdle = (satisfiedConstraints &amp; CONSTRAINT_APP_NOT_IDLE) != 0;</span><br><span class="line">    </span><br><span class="line">    // 判断处于非 dozing 模式的是否满足！</span><br><span class="line">    final boolean notDozing = (satisfiedConstraints &amp; CONSTRAINT_DEVICE_NOT_DOZING) != 0</span><br><span class="line">            || (job.getFlags() &amp; JobInfo.FLAG_WILL_BE_FOREGROUND) != 0;</span><br><span class="line">            </span><br><span class="line">    // 最后判断这个 job 是否 ready！</span><br><span class="line">    return (isConstraintsSatisfied() || deadlineSatisfied) &amp;&amp; notIdle &amp;&amp; notDozing;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>可以看到，一个 job 处于 ready 状态，需要同时满足如下的几个条件：</p>
<ul>
<li>job 的所有约束条件都满足，或者对于非周期 job，deadline 已经满足了！</li>
<li>job 设置的应用处于非空闲状态的条件满足；</li>
<li>job 设置的设备处于非doze的条件满足；</li>
</ul>
<h4 id="2-3-2-2-mDeadlineExpiredListener"><a href="#2-3-2-2-mDeadlineExpiredListener" class="headerlink" title="2.3.2.2 mDeadlineExpiredListener"></a>2.3.2.2 mDeadlineExpiredListener</h4><p>我们先来看看超时处理的 Listener：<br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">private</span> <span class="keyword">final</span> OnAlarmListener mDeadlineExpiredListener = <span class="keyword">new</span> OnAlarmListener() &#123;</span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onAlarm</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">if</span> (DEBUG) &#123;</span><br><span class="line">            Slog.d(TAG, <span class="string">"Deadline-expired alarm fired"</span>);</span><br><span class="line">        &#125;</span><br><span class="line">        </span><br><span class="line">        <span class="comment">// 时间点到后会触发 checkExpiredDeadlinesAndResetAlarm 方法！</span></span><br><span class="line">        checkExpiredDeadlinesAndResetAlarm();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure></p>
<p>这里调用了 checkExpiredDeadlinesAndResetAlarm：</p>
<h5 id="2-3-2-2-1-checkExpiredDeadlinesAndResetAlarm"><a href="#2-3-2-2-1-checkExpiredDeadlinesAndResetAlarm" class="headerlink" title="2.3.2.2.1 checkExpiredDeadlinesAndResetAlarm"></a>2.3.2.2.1 checkExpiredDeadlinesAndResetAlarm</h5><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">checkExpiredDeadlinesAndResetAlarm</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    <span class="keyword">synchronized</span> (mLock) &#123;</span><br><span class="line">        <span class="keyword">long</span> nextExpiryTime = Long.MAX_VALUE;</span><br><span class="line">        <span class="keyword">int</span> nextExpiryUid = <span class="number">0</span>;</span><br><span class="line">        <span class="keyword">final</span> <span class="keyword">long</span> nowElapsedMillis = SystemClock.elapsedRealtime();</span><br><span class="line">        Iterator&lt;JobStatus&gt; it = mTrackedJobs.iterator();</span><br><span class="line"></span><br><span class="line">        <span class="keyword">while</span> (it.hasNext()) &#123; <span class="comment">// 遍历集合</span></span><br><span class="line">            JobStatus job = it.next();</span><br><span class="line">            <span class="keyword">if</span> (!job.hasDeadlineConstraint()) &#123;</span><br><span class="line">                <span class="keyword">continue</span>;</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            <span class="keyword">final</span> <span class="keyword">long</span> jobDeadline = job.getLatestRunTimeElapsed(); <span class="comment">// 获得每个 job 的超时触发时间点！</span></span><br><span class="line"></span><br><span class="line">            <span class="keyword">if</span> (jobDeadline &lt;= nowElapsedMillis) &#123; <span class="comment">// 超时时间触发点到了！</span></span><br><span class="line">                <span class="keyword">if</span> (job.hasTimingDelayConstraint()) &#123; <span class="comment">// 如果 job 还有设置了延迟时间触发条件，将相应的 TimingDelay 二进制位为 1！</span></span><br><span class="line">                    job.setTimingDelayConstraintSatisfied(<span class="keyword">true</span>);</span><br><span class="line">                &#125;</span><br><span class="line">                job.setDeadlineConstraintSatisfied(<span class="keyword">true</span>); <span class="comment">// 设置相应的 Deadline 二进制位为 1！</span></span><br><span class="line">                </span><br><span class="line">                mStateChangedListener.onRunJobNow(job); <span class="comment">// 立刻执行 Job！</span></span><br><span class="line">                </span><br><span class="line">                it.remove(); <span class="comment">// 移除，不再监控！</span></span><br><span class="line">                </span><br><span class="line">            &#125; <span class="keyword">else</span> &#123; </span><br><span class="line">                <span class="comment">// 找到下一个没有满足的 job ，以它的超时处理时间点作为下次 alarm 的触发点，退出循环！</span></span><br><span class="line">                nextExpiryTime = jobDeadline;</span><br><span class="line">                nextExpiryUid = job.getSourceUid();</span><br><span class="line">                <span class="keyword">break</span>;</span><br><span class="line">                </span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 设置下一次的 alarm！</span></span><br><span class="line">        setDeadlineExpiredAlarmLocked(nextExpiryTime, nextExpiryUid);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>最后，调用了 JSS 的 onRunJobNow 方法，这里我们后面再看！</p>
<h1 id="3-IdleController"><a href="#3-IdleController" class="headerlink" title="3 IdleController"></a>3 IdleController</h1><p>我们来看看 IdleController 这个空闲状态控制器的构造器：<br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">private</span> <span class="title">IdleController</span><span class="params">(StateChangedListener stateChangedListener, Context context,</span></span></span><br><span class="line"><span class="function"><span class="params">            Object lock)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">super</span>(stateChangedListener, context, lock);</span><br><span class="line">    initIdleStateTracking();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>调用了这个方法，initIdleStateTracking：<br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * Idle state tracking, and messaging with the task manager when</span></span><br><span class="line"><span class="comment"> * significant state changes occur</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">initIdleStateTracking</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    <span class="comment">// 设备真正进入空闲的时间间隔：4260000 毫秒</span></span><br><span class="line">    mInactivityIdleThreshold = mContext.getResources().getInteger(</span><br><span class="line">            com.android.internal.R.integer.config_jobSchedulerInactivityIdleThreshold);</span><br><span class="line">    mIdleWindowSlop = mContext.getResources().getInteger(</span><br><span class="line">            com.android.internal.R.integer.config_jobSchedulerIdleWindowSlop);</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// 创建了一个设备空闲监控器，并启动监控！        </span></span><br><span class="line">    mIdleTracker = <span class="keyword">new</span> IdlenessTracker();</span><br><span class="line">    mIdleTracker.startTracking();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>这里创建了一个 IdlenessTracker。</p>
<h2 id="3-1-IdlenessTracker"><a href="#3-1-IdlenessTracker" class="headerlink" title="3.1 IdlenessTracker"></a>3.1 IdlenessTracker</h2><p>这个 Tracker 是一个广播接收者！<br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">IdlenessTracker</span> <span class="keyword">extends</span> <span class="title">BroadcastReceiver</span> </span>&#123;</span><br><span class="line">    <span class="keyword">private</span> AlarmManager mAlarm;</span><br><span class="line">    <span class="keyword">private</span> PendingIntent mIdleTriggerIntent;</span><br><span class="line">    <span class="keyword">boolean</span> mIdle;</span><br><span class="line">    <span class="keyword">boolean</span> mScreenOn;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="title">IdlenessTracker</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    </span><br><span class="line">        <span class="comment">// 设置一个 alarm，用来发送 ActivityManagerService.ACTION_TRIGGER_IDLE 广播！</span></span><br><span class="line">        mAlarm = (AlarmManager) mContext.getSystemService(Context.ALARM_SERVICE);</span><br><span class="line"></span><br><span class="line">        Intent intent = <span class="keyword">new</span> Intent(ActivityManagerService.ACTION_TRIGGER_IDLE)</span><br><span class="line">                .setPackage(<span class="string">"android"</span>)</span><br><span class="line">                .setFlags(Intent.FLAG_RECEIVER_REGISTERED_ONLY);</span><br><span class="line">                </span><br><span class="line">        mIdleTriggerIntent = PendingIntent.getBroadcast(mContext, <span class="number">0</span>, intent, <span class="number">0</span>);</span><br><span class="line">        <span class="comment">// At boot we presume that the user has just "interacted" with the</span></span><br><span class="line">        <span class="comment">// device in some meaningful way.</span></span><br><span class="line">        mIdle = <span class="keyword">false</span>;</span><br><span class="line">        mScreenOn = <span class="keyword">true</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 设备是否处于空闲的标志！</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">boolean</span> <span class="title">isIdle</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> mIdle;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">startTracking</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        IntentFilter filter = <span class="keyword">new</span> IntentFilter();</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 监听屏幕的亮暗状态！</span></span><br><span class="line">        filter.addAction(Intent.ACTION_SCREEN_ON);</span><br><span class="line">        filter.addAction(Intent.ACTION_SCREEN_OFF);</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 监听设备的睡眠状态</span></span><br><span class="line">        filter.addAction(Intent.ACTION_DREAMING_STARTED);</span><br><span class="line">        filter.addAction(Intent.ACTION_DREAMING_STOPPED);</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 监听设备进入空闲状态</span></span><br><span class="line">        filter.addAction(ActivityManagerService.ACTION_TRIGGER_IDLE);</span><br><span class="line">        mContext.registerReceiver(<span class="keyword">this</span>, filter);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onReceive</span><span class="params">(Context context, Intent intent)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">final</span> String action = intent.getAction();</span><br><span class="line">        </span><br><span class="line">        <span class="comment">// 监听亮屏广播 或者 退出休眠的广播。</span></span><br><span class="line">        <span class="keyword">if</span> (action.equals(Intent.ACTION_SCREEN_ON) </span><br><span class="line">                || action.equals(Intent.ACTION_DREAMING_STOPPED)) &#123;</span><br><span class="line">            <span class="keyword">if</span> (DEBUG) &#123;</span><br><span class="line">                Slog.v(TAG,<span class="string">"exiting idle : "</span> + action);</span><br><span class="line">            &#125;</span><br><span class="line">            mScreenOn = <span class="keyword">true</span>; <span class="comment">// 表示亮屏</span></span><br><span class="line">            </span><br><span class="line">            <span class="comment">//cancel the alarm</span></span><br><span class="line">            mAlarm.cancel(mIdleTriggerIntent); <span class="comment">// 取消闹钟！</span></span><br><span class="line">            <span class="keyword">if</span> (mIdle) &#123;</span><br><span class="line">                mIdle = <span class="keyword">false</span>; <span class="comment">// 表示设备进入了非空闲！</span></span><br><span class="line">                reportNewIdleState(mIdle);</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">        &#125; <span class="keyword">else</span> <span class="keyword">if</span> (action.equals(Intent.ACTION_SCREEN_OFF) <span class="comment">// 熄屏广播 和 进入休眠的广播。</span></span><br><span class="line">                || action.equals(Intent.ACTION_DREAMING_STARTED)) &#123;</span><br><span class="line"></span><br><span class="line">            <span class="comment">// 因为接到广播和设备真正处于空闲是有一定时间间隔的，所以这里设置了一个闹钟，</span></span><br><span class="line">            <span class="comment">// 用于在指定时间后发送广播：ActivityManagerService.ACTION_TRIGGER_IDLE</span></span><br><span class="line"></span><br><span class="line">            <span class="keyword">final</span> <span class="keyword">long</span> nowElapsed = SystemClock.elapsedRealtime();</span><br><span class="line">            <span class="keyword">final</span> <span class="keyword">long</span> when = nowElapsed + mInactivityIdleThreshold;</span><br><span class="line">            <span class="keyword">if</span> (DEBUG) &#123;</span><br><span class="line">                Slog.v(TAG, <span class="string">"Scheduling idle : "</span> + action + <span class="string">" now:"</span> + nowElapsed + <span class="string">" when="</span></span><br><span class="line">                        + when);</span><br><span class="line">            &#125;</span><br><span class="line">            mScreenOn = <span class="keyword">false</span>; <span class="comment">// 表示灭屏！</span></span><br><span class="line">            mAlarm.setWindow(AlarmManager.ELAPSED_REALTIME_WAKEUP,</span><br><span class="line">                    when, mIdleWindowSlop, mIdleTriggerIntent);</span><br><span class="line"></span><br><span class="line">            </span><br><span class="line">        &#125; <span class="keyword">else</span> <span class="keyword">if</span> (action.equals(ActivityManagerService.ACTION_TRIGGER_IDLE)) &#123; <span class="comment">// 表示设备真正进入了空闲！</span></span><br><span class="line">            <span class="comment">// idle time starts now. Do not set mIdle if screen is on.</span></span><br><span class="line">            <span class="keyword">if</span> (!mIdle &amp;&amp; !mScreenOn) &#123;</span><br><span class="line">                <span class="keyword">if</span> (DEBUG) &#123;</span><br><span class="line">                    Slog.v(TAG, <span class="string">"Idle trigger fired @ "</span> + SystemClock.elapsedRealtime());</span><br><span class="line">                &#125;</span><br><span class="line">                mIdle = <span class="keyword">true</span>; <span class="comment">// 表示设备进入了空闲状态</span></span><br><span class="line">                reportNewIdleState(mIdle);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>总结下：<br>收到亮屏广播或者退出休眠的广播，设备处于非空闲，取消 alarm，如果设备之前是空闲的，那就通知 jobScheduler！<br>收到熄屏广播或者进入出休眠的广播，设备可能进入空闲状态，设置 alarm，在一定时间后发送广播；接受这个广播，如果设备之前是非空闲的，那就通知 jobScheduler！</p>
<p>接下来，进入 reportNewIdleState 方法中来看看：<br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">reportNewIdleState</span><span class="params">(<span class="keyword">boolean</span> isIdle)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">synchronized</span> (mLock) &#123;</span><br><span class="line">        <span class="keyword">for</span> (JobStatus task : mTrackedTasks) &#123;</span><br><span class="line">            <span class="comment">// 设置 job 的设备空闲状态条件！</span></span><br><span class="line">            task.setIdleConstraintSatisfied(isIdle);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// 通知 JSS，设备的空闲状态发生了变化！</span></span><br><span class="line">    mStateChangedListener.onControllerStateChanged();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>这个方法很简单，修改自己所监控的 Job 的 JobStatus 的 Idle 二进制位，并通知 JobSchedulerService ，JobSchdulerService 会根据这个状态来动态控制 jobServcie！</p>
<p>IdleController 的 StartTrackingJob 和 StopTrackingJob 都很简单，请看下面：<br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * StateController interface</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">maybeStartTrackingJobLocked</span><span class="params">(JobStatus taskStatus, JobStatus lastJob)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">if</span> (taskStatus.hasIdleConstraint()) &#123; <span class="comment">// 判断 job 是否设置空闲约束！</span></span><br><span class="line">        mTrackedTasks.add(taskStatus);</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 监控之前，进行 job 的设备状态初始化！</span></span><br><span class="line">        taskStatus.setIdleConstraintSatisfied(mIdleTracker.isIdle()); </span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">maybeStopTrackingJobLocked</span><span class="params">(JobStatus taskStatus, JobStatus incomingJob, <span class="keyword">boolean</span> forUpdate)</span> </span>&#123;</span><br><span class="line">    </span><br><span class="line">    mTrackedTasks.remove(taskStatus);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>不多说了！</p>
<h1 id="4-BatteryController"><a href="#4-BatteryController" class="headerlink" title="4 BatteryController"></a>4 BatteryController</h1><p>我们来看看电量控制器：<br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">private</span> <span class="title">BatteryController</span><span class="params">(StateChangedListener stateChangedListener, Context context,</span></span></span><br><span class="line"><span class="function"><span class="params">        Object lock)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">super</span>(stateChangedListener, context, lock);</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 这里创建了一个充电监视器</span></span><br><span class="line">    mChargeTracker = <span class="keyword">new</span> ChargingTracker();</span><br><span class="line">    mChargeTracker.startTracking();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<h2 id="4-1-ChargingTracker"><a href="#4-1-ChargingTracker" class="headerlink" title="4.1 ChargingTracker"></a>4.1 ChargingTracker</h2><p>我们去看看：<br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">ChargingTracker</span> <span class="keyword">extends</span> <span class="title">BroadcastReceiver</span> </span>&#123;</span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * Track whether we're "charging", where charging means that we're ready to commit to</span></span><br><span class="line"><span class="comment">     * doing work.</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">boolean</span> mCharging;</span><br><span class="line">    <span class="comment">/** Keep track of whether the battery is charged enough that we want to do work. */</span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">boolean</span> mBatteryHealthy;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="title">ChargingTracker</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">startTracking</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        IntentFilter filter = <span class="keyword">new</span> IntentFilter();</span><br><span class="line">        <span class="comment">// Battery health.</span></span><br><span class="line"></span><br><span class="line">        <span class="comment">// 监听电量</span></span><br><span class="line">        filter.addAction(Intent.ACTION_BATTERY_LOW);</span><br><span class="line">        filter.addAction(Intent.ACTION_BATTERY_OKAY);</span><br><span class="line">        <span class="comment">// Charging/not charging.</span></span><br><span class="line"></span><br><span class="line">        <span class="comment">// 监听充电的广播</span></span><br><span class="line">        filter.addAction(BatteryManager.ACTION_CHARGING);</span><br><span class="line">        filter.addAction(BatteryManager.ACTION_DISCHARGING);</span><br><span class="line">        mContext.registerReceiver(<span class="keyword">this</span>, filter);</span><br><span class="line"></span><br><span class="line">        <span class="comment">// Initialise tracker state.</span></span><br><span class="line">        BatteryManagerInternal batteryManagerInternal =</span><br><span class="line">                LocalServices.getService(BatteryManagerInternal.class);</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 初始化电量的状态</span></span><br><span class="line">        mBatteryHealthy = !batteryManagerInternal.getBatteryLevelLow();</span><br><span class="line">        mCharging = batteryManagerInternal.isPowered(BatteryManager.BATTERY_PLUGGED_ANY);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 判断当前的电池环境是否稳定</span></span><br><span class="line">    <span class="function"><span class="keyword">boolean</span> <span class="title">isOnStablePower</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> mCharging &amp;&amp; mBatteryHealthy;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onReceive</span><span class="params">(Context context, Intent intent)</span> </span>&#123;</span><br><span class="line">        <span class="comment">// 处理广播！</span></span><br><span class="line">        onReceiveInternal(intent);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@VisibleForTesting</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onReceiveInternal</span><span class="params">(Intent intent)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">final</span> String action = intent.getAction();</span><br><span class="line">        <span class="keyword">if</span> (Intent.ACTION_BATTERY_LOW.equals(action)) &#123;</span><br><span class="line">            <span class="keyword">if</span> (DEBUG) &#123;</span><br><span class="line">                Slog.d(TAG, <span class="string">"Battery life too low to do work. @ "</span></span><br><span class="line">                        + SystemClock.elapsedRealtime());</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="comment">// If we get this action, the battery is discharging =&gt; it isn't plugged in so</span></span><br><span class="line">            <span class="comment">// there's no work to cancel. We track this variable for the case where it is</span></span><br><span class="line">            <span class="comment">// charging, but hasn't been for long enough to be healthy.</span></span><br><span class="line">            <span class="comment">// 电量太低，mBatteryHealthy 置为 false！</span></span><br><span class="line">            mBatteryHealthy = <span class="keyword">false</span>;</span><br><span class="line"></span><br><span class="line">        &#125; <span class="keyword">else</span> <span class="keyword">if</span> (Intent.ACTION_BATTERY_OKAY.equals(action)) &#123;</span><br><span class="line">            <span class="keyword">if</span> (DEBUG) &#123;</span><br><span class="line">                Slog.d(TAG, <span class="string">"Battery life healthy enough to do work. @ "</span></span><br><span class="line">                        + SystemClock.elapsedRealtime());</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="comment">// 电量充足，mBatteryHealthy 置为 true，通知 job 状态需要改变！</span></span><br><span class="line">            mBatteryHealthy = <span class="keyword">true</span>;</span><br><span class="line">            maybeReportNewChargingState();</span><br><span class="line"></span><br><span class="line">        &#125; <span class="keyword">else</span> <span class="keyword">if</span> (BatteryManager.ACTION_CHARGING.equals(action)) &#123;</span><br><span class="line">            <span class="keyword">if</span> (DEBUG) &#123;</span><br><span class="line">                Slog.d(TAG, <span class="string">"Received charging intent, fired @ "</span></span><br><span class="line">                        + SystemClock.elapsedRealtime());</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="comment">// 正在充电，mCharging 置为 true，通知 job 状态需要改变！</span></span><br><span class="line">            mCharging = <span class="keyword">true</span>;</span><br><span class="line">            maybeReportNewChargingState();</span><br><span class="line"></span><br><span class="line">        &#125; <span class="keyword">else</span> <span class="keyword">if</span> (BatteryManager.ACTION_DISCHARGING.equals(action)) &#123;</span><br><span class="line">            <span class="keyword">if</span> (DEBUG) &#123;</span><br><span class="line">                Slog.d(TAG, <span class="string">"Disconnected from power."</span>);</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="comment">// 充电断开，mCharging 置为 false，通知 job 状态需要改变！</span></span><br><span class="line">            mCharging = <span class="keyword">false</span>;</span><br><span class="line">            maybeReportNewChargingState();</span><br><span class="line"></span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<h3 id="4-1-1-maybeReportNewChargingState"><a href="#4-1-1-maybeReportNewChargingState" class="headerlink" title="4.1.1 maybeReportNewChargingState"></a>4.1.1 maybeReportNewChargingState</h3><p>最后调用了 maybeReportNewChargingState 方法：<br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">maybeReportNewChargingState</span><span class="params">()</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 获得本次电池的状态</span></span><br><span class="line">    <span class="keyword">final</span> <span class="keyword">boolean</span> stablePower = mChargeTracker.isOnStablePower();</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (DEBUG) &#123;</span><br><span class="line">        Slog.d(TAG, <span class="string">"maybeReportNewChargingState: "</span> + stablePower);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">boolean</span> reportChange = <span class="keyword">false</span>;</span><br><span class="line">    <span class="keyword">synchronized</span> (mLock) &#123;</span><br><span class="line">        <span class="keyword">for</span> (JobStatus ts : mTrackedTasks) &#123;</span><br><span class="line">            <span class="comment">// 对于这个 controller 监视的所有 JobStatus，判断这次是否满足约束条件！</span></span><br><span class="line">            <span class="keyword">boolean</span> previous = ts.setChargingConstraintSatisfied(stablePower);</span><br><span class="line">            <span class="keyword">if</span> (previous != stablePower) &#123;</span><br><span class="line">                <span class="comment">// 这里一次和上一次不一样，需要通知 JobSchedulerService，发生变化</span></span><br><span class="line">                reportChange = <span class="keyword">true</span>;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// Let the scheduler know that state has changed. This may or may not result in an</span></span><br><span class="line">    <span class="comment">// execution.</span></span><br><span class="line">    <span class="keyword">if</span> (reportChange) &#123; <span class="comment">// 通知 jobScheduler，发生变化</span></span><br><span class="line">        mStateChangedListener.onControllerStateChanged();</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// Also tell the scheduler that any ready jobs should be flushed.</span></span><br><span class="line">    <span class="keyword">if</span> (stablePower) &#123; <span class="comment">// 通知 jobScheduler，如果电池状态满足，执行任务</span></span><br><span class="line">        mStateChangedListener.onRunJobNow(<span class="keyword">null</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>这里很简单，就不说了！</p>
<h1 id="5-AppIdleController"><a href="#5-AppIdleController" class="headerlink" title="5 AppIdleController"></a>5 AppIdleController</h1><p>这个控制器的主要作用是，判断 app 是否是闲置的，如果是闲置的，那么他的 job 将会被执行，如何判断闲置呢？没有被启动，或者数小时或者数天之前在启动过！<br>我们先来看看 AppIdleController 的构造器：<br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">private</span> <span class="title">AppIdleController</span><span class="params">(JobSchedulerService service, Context context, Object lock)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">super</span>(service, context, lock);</span><br><span class="line">    mJobSchedulerService = service;</span><br><span class="line">    mUsageStatsInternal = LocalServices.getService(UsageStatsManagerInternal.class);</span><br><span class="line">    mAppIdleParoleOn = <span class="keyword">true</span>;</span><br><span class="line">    <span class="comment">// 将 AppIdleStateChangeListener 注册进入 UsageStatsManagerInternal 服务中</span></span><br><span class="line">    mUsageStatsInternal.addAppIdleStateChangeListener(<span class="keyword">new</span> AppIdleStateChangeListener());</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>我们继续看：</p>
<h2 id="5-1-AppIdleStateChangeListener"><a href="#5-1-AppIdleStateChangeListener" class="headerlink" title="5.1 AppIdleStateChangeListener"></a>5.1 AppIdleStateChangeListener</h2><p>这里有一个监听器： AppIdleStateChangeListener：<br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">private</span> <span class="class"><span class="keyword">class</span> <span class="title">AppIdleStateChangeListener</span></span></span><br><span class="line"><span class="class">        <span class="keyword">extends</span> <span class="title">UsageStatsManagerInternal</span>.<span class="title">AppIdleStateChangeListener</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onAppIdleStateChanged</span><span class="params">(String packageName, <span class="keyword">int</span> userId, <span class="keyword">boolean</span> idle)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">boolean</span> changed = <span class="keyword">false</span>;</span><br><span class="line">        <span class="keyword">synchronized</span> (mLock) &#123;</span><br><span class="line">            <span class="keyword">if</span> (mAppIdleParoleOn) &#123;</span><br><span class="line">                <span class="keyword">return</span>;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="comment">// 创建 PackageUpdateFunc，对 userId 下的包名为 pacakgeName 的应用的所有 job，进行状态检查和更新</span></span><br><span class="line">            PackageUpdateFunc update = <span class="keyword">new</span> PackageUpdateFunc(userId, packageName, idle);</span><br><span class="line">            mJobSchedulerService.getJobStore().forEachJob(update);</span><br><span class="line">            <span class="keyword">if</span> (update.mChanged) &#123;</span><br><span class="line">                changed = <span class="keyword">true</span>;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">if</span> (changed) &#123; <span class="comment">// 通知 jobScheduler，发生变化</span></span><br><span class="line">            mStateChangedListener.onControllerStateChanged();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onParoleStateChanged</span><span class="params">(<span class="keyword">boolean</span> isParoleOn)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">if</span> (DEBUG) &#123;</span><br><span class="line">            Slog.d(LOG_TAG, <span class="string">"Parole on: "</span> + isParoleOn);</span><br><span class="line">        &#125;</span><br><span class="line">        setAppIdleParoleOn(isParoleOn);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>这里的监听器本质上只是一个回调接口，具体的 controll 策略是在 UsageStatsManagerInternal 服务中，这里不多讲（因为特么我还没看）</p>
<h3 id="5-1-1-PackageUpdateFunc"><a href="#5-1-1-PackageUpdateFunc" class="headerlink" title="5.1.1 PackageUpdateFunc"></a>5.1.1 PackageUpdateFunc</h3><p>首先来看看这个函数类：<br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">final</span> <span class="keyword">static</span> <span class="class"><span class="keyword">class</span> <span class="title">PackageUpdateFunc</span> <span class="keyword">implements</span> <span class="title">JobStore</span>.<span class="title">JobStatusFunctor</span> </span>&#123;</span><br><span class="line">    <span class="keyword">final</span> <span class="keyword">int</span> mUserId;</span><br><span class="line">    <span class="keyword">final</span> String mPackage;</span><br><span class="line">    <span class="keyword">final</span> <span class="keyword">boolean</span> mIdle;</span><br><span class="line">    <span class="keyword">boolean</span> mChanged; <span class="comment">// 用来保存 app 状态是否发生变化</span></span><br><span class="line">    </span><br><span class="line">    PackageUpdateFunc(<span class="keyword">int</span> userId, String pkg, <span class="keyword">boolean</span> idle) &#123;</span><br><span class="line">        mUserId = userId;</span><br><span class="line">        mPackage = pkg;</span><br><span class="line">        mIdle = idle;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="meta">@Override</span> <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">process</span><span class="params">(JobStatus jobStatus)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">if</span> (jobStatus.getSourcePackageName().equals(mPackage) <span class="comment">// 判断当前的 job 是否属于这个应用程序</span></span><br><span class="line">                &amp;&amp; jobStatus.getSourceUserId() == mUserId) &#123;</span><br><span class="line">            <span class="keyword">if</span> (jobStatus.setAppNotIdleConstraintSatisfied(!mIdle)) &#123;</span><br><span class="line">                <span class="keyword">if</span> (DEBUG) &#123;</span><br><span class="line">                    Slog.d(LOG_TAG, <span class="string">"App Idle state changed, setting idle state of "</span></span><br><span class="line">                            + mPackage + <span class="string">" to "</span> + mIdle);</span><br><span class="line">                &#125;</span><br><span class="line">                mChanged = <span class="keyword">true</span>;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure></p>
<p>PackageUpdateFunc 会遍历 JobStore，查找指定 app 的 Job，改变 job 的属性值！</p>
<h3 id="5-1-2-setAppIdleParoleOn"><a href="#5-1-2-setAppIdleParoleOn" class="headerlink" title="5.1.2 setAppIdleParoleOn"></a>5.1.2 setAppIdleParoleOn</h3><p>这个方法的作用是（特么我没看懂，这里的解释空下）<br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">setAppIdleParoleOn</span><span class="params">(<span class="keyword">boolean</span> isAppIdleParoleOn)</span> </span>&#123;</span><br><span class="line">    <span class="comment">// Flag if any app's idle state has changed</span></span><br><span class="line">    <span class="keyword">boolean</span> changed = <span class="keyword">false</span>;</span><br><span class="line">    <span class="keyword">synchronized</span> (mLock) &#123;</span><br><span class="line">        <span class="keyword">if</span> (mAppIdleParoleOn == isAppIdleParoleOn) &#123; <span class="comment">// 如果状态没有变化，不处理！</span></span><br><span class="line">            <span class="keyword">return</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        mAppIdleParoleOn = isAppIdleParoleOn;</span><br><span class="line">        <span class="comment">// 创建 GlobalUpdateFunc 来更新 Job 状态！</span></span><br><span class="line">        GlobalUpdateFunc update = <span class="keyword">new</span> GlobalUpdateFunc();</span><br><span class="line">        mJobSchedulerService.getJobStore().forEachJob(update);</span><br><span class="line">        <span class="keyword">if</span> (update.mChanged) &#123;</span><br><span class="line">            changed = <span class="keyword">true</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span> (changed) &#123;</span><br><span class="line">        mStateChangedListener.onControllerStateChanged();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>我们再去看看  GlobalUpdateFunc：<br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">final</span> <span class="class"><span class="keyword">class</span> <span class="title">GlobalUpdateFunc</span> <span class="keyword">implements</span> <span class="title">JobStore</span>.<span class="title">JobStatusFunctor</span> </span>&#123;</span><br><span class="line">    <span class="keyword">boolean</span> mChanged;</span><br><span class="line">    <span class="meta">@Override</span> <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">process</span><span class="params">(JobStatus jobStatus)</span> </span>&#123;</span><br><span class="line">        String packageName = jobStatus.getSourcePackageName();</span><br><span class="line">        <span class="keyword">final</span> <span class="keyword">boolean</span> appIdle = !mAppIdleParoleOn &amp;&amp; mUsageStatsInternal.isAppIdle(packageName,</span><br><span class="line">                jobStatus.getSourceUid(), jobStatus.getSourceUserId());</span><br><span class="line">        <span class="keyword">if</span> (DEBUG) &#123;</span><br><span class="line">            Slog.d(LOG_TAG, <span class="string">"Setting idle state of "</span> + packageName + <span class="string">" to "</span> + appIdle);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">// 改变 job 状态！如果改变成功了，该方法返回的是 true！</span></span><br><span class="line">        <span class="keyword">if</span> (jobStatus.setAppNotIdleConstraintSatisfied(!appIdle)) &#123; </span><br><span class="line">            mChanged = <span class="keyword">true</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure></p>
<p>如果，有 job 的状态发生了变化，那么 GlobalUpdateFunc 的 mChanged 的值为 true，然后通知 JobScheduler 即可！</p>
<h1 id="6-ContentObserverController"><a href="#6-ContentObserverController" class="headerlink" title="6 ContentObserverController"></a>6 ContentObserverController</h1><p>通过监听数据库的变化来 controll job：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">private ContentObserverController(StateChangedListener stateChangedListener, Context context,</span><br><span class="line">            Object lock) &#123;</span><br><span class="line">    super(stateChangedListener, context, lock);</span><br><span class="line">    mHandler = new Handler(context.getMainLooper());</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>可以看到 ，构造器很简单，那真正的 controll 在哪里呢，首先我们来一个内部变量：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">final private List&lt;JobStatus&gt; mTrackedTasks = new ArrayList&lt;JobStatus&gt;();</span><br><span class="line">/**</span><br><span class="line"> * Per-userid &#123;@link JobInfo.TriggerContentUri&#125; keyed ContentObserver cache.</span><br><span class="line"> */</span><br><span class="line">SparseArray&lt;ArrayMap&lt;JobInfo.TriggerContentUri, ObserverInstance&gt;&gt; mObservers = new SparseArray&lt;&gt;();</span><br></pre></td></tr></table></figure></p>
<p>mTrackedTasks：表示这个 controller 监视的所有的 job：<br>mObservers：key 值为 userId，表示的是设备用户，value 值为 ArrayMap&lt;JobInfo.TriggerContentUri, ObserverInstance&gt;，数据库uri和它的观察者！</p>
<p>还记得，在 JobScheduler 中我们开始  track 每一个 job 吗？我们去这个方法里面去看看：</p>
<h2 id="6-1-maybeStartTrackingJobLocked"><a href="#6-1-maybeStartTrackingJobLocked" class="headerlink" title="6.1 maybeStartTrackingJobLocked"></a>6.1 maybeStartTrackingJobLocked</h2><p>参数传递：</p>
<ul>
<li>JobStatus taskStatus：即将要执行的 job</li>
<li>JobStatus lastJob：被取代的旧的 job<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">maybeStartTrackingJobLocked</span><span class="params">(JobStatus taskStatus, JobStatus lastJob)</span> </span>&#123;</span><br><span class="line">    <span class="comment">// 判断新的 job  hasContentTriggerConstraint 是否为 true！</span></span><br><span class="line">    <span class="keyword">if</span> (taskStatus.hasContentTriggerConstraint()) &#123;</span><br><span class="line">        <span class="keyword">if</span> (taskStatus.contentObserverJobInstance == <span class="keyword">null</span>) &#123;</span><br><span class="line">            <span class="comment">// 给 jobStatus 创建一个 JobInstance 对象！</span></span><br><span class="line">            taskStatus.contentObserverJobInstance = <span class="keyword">new</span> JobInstance(taskStatus);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">if</span> (DEBUG) &#123;</span><br><span class="line">            Slog.i(TAG, <span class="string">"Tracking content-trigger job "</span> + taskStatus);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">// 添加到追踪列表中！</span></span><br><span class="line">        mTrackedTasks.add(taskStatus);</span><br><span class="line">        <span class="keyword">boolean</span> havePendingUris = <span class="keyword">false</span>;</span><br><span class="line">        <span class="comment">// If there is a previous job associated with the new job, propagate over</span></span><br><span class="line">        <span class="comment">// any pending content URI trigger reports.</span></span><br><span class="line">        <span class="keyword">if</span> (taskStatus.contentObserverJobInstance.mChangedAuthorities != <span class="keyword">null</span>) &#123;</span><br><span class="line">            havePendingUris = <span class="keyword">true</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">// If we have previously reported changed authorities/uris, then we failed</span></span><br><span class="line">        <span class="comment">// to complete the job with them so will re-record them to report again.</span></span><br><span class="line">        <span class="comment">// 对于有些 job ，我们之前有监视过其依赖的数据库的变化；但是，我们并没有完成这个 job，</span></span><br><span class="line">        <span class="comment">// 如果这个 job 被 reschedule，那么之前的 uris/authorities 仍然要被监控！</span></span><br><span class="line">        <span class="keyword">if</span> (taskStatus.changedAuthorities != <span class="keyword">null</span>) &#123;</span><br><span class="line">            havePendingUris = <span class="keyword">true</span>; <span class="comment">// 用户标记是否有正在处理的 uris</span></span><br><span class="line">            <span class="keyword">if</span> (taskStatus.contentObserverJobInstance.mChangedAuthorities == <span class="keyword">null</span>) &#123;</span><br><span class="line">                taskStatus.contentObserverJobInstance.mChangedAuthorities</span><br><span class="line">                        = <span class="keyword">new</span> ArraySet&lt;&gt;();</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">for</span> (String auth : taskStatus.changedAuthorities) &#123;</span><br><span class="line">                taskStatus.contentObserverJobInstance.mChangedAuthorities.add(auth);</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">if</span> (taskStatus.changedUris != <span class="keyword">null</span>) &#123;</span><br><span class="line">                <span class="keyword">if</span> (taskStatus.contentObserverJobInstance.mChangedUris == <span class="keyword">null</span>) &#123;</span><br><span class="line">                    taskStatus.contentObserverJobInstance.mChangedUris = <span class="keyword">new</span> ArraySet&lt;&gt;();</span><br><span class="line">                &#125;</span><br><span class="line">                <span class="keyword">for</span> (Uri uri : taskStatus.changedUris) &#123;</span><br><span class="line">                    taskStatus.contentObserverJobInstance.mChangedUris.add(uri);</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">            taskStatus.changedAuthorities = <span class="keyword">null</span>;</span><br><span class="line">            taskStatus.changedUris = <span class="keyword">null</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        taskStatus.changedAuthorities = <span class="keyword">null</span>;</span><br><span class="line">        taskStatus.changedUris = <span class="keyword">null</span>;</span><br><span class="line">        taskStatus.setContentTriggerConstraintSatisfied(havePendingUris);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// 如果当前的这个 job 有相同 jobId 的被取消的上一次 job !</span></span><br><span class="line">    <span class="keyword">if</span> (lastJob != <span class="keyword">null</span> &amp;&amp; lastJob.contentObserverJobInstance != <span class="keyword">null</span>) &#123;</span><br><span class="line">        <span class="comment">// And now we can detach the instance state from the last job.</span></span><br><span class="line">        lastJob.contentObserverJobInstance.detachLocked();</span><br><span class="line">        lastJob.contentObserverJobInstance = <span class="keyword">null</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
</li>
</ul>
<p>对于有被替代的相同uid和jobId的旧的 job，会调用 jobInstance 的 detachLocked 方法来做一些释放资源的操作，这个我们在后面来看！</p>
<p>可以看到，每一个 JobStatus 都会有一个 ContentObserverController.JobInstance 类型的对象：</p>
<h3 id="6-1-1-JobInstance"><a href="#6-1-1-JobInstance" class="headerlink" title="6.1.1 JobInstance"></a>6.1.1 JobInstance</h3><p>参数传递：</p>
<ul>
<li>JobStatus jobStatus<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">final</span> <span class="class"><span class="keyword">class</span> <span class="title">JobInstance</span> </span>&#123;</span><br><span class="line">    <span class="keyword">final</span> ArrayList&lt;ObserverInstance&gt; mMyObservers = <span class="keyword">new</span> ArrayList&lt;&gt;(); <span class="comment">// 这个 job 所拥有的观察者实例集合</span></span><br><span class="line">    <span class="keyword">final</span> JobStatus mJobStatus; <span class="comment">// 所属的 jobStatus</span></span><br><span class="line">    <span class="keyword">final</span> Runnable mExecuteRunner;</span><br><span class="line">    <span class="keyword">final</span> Runnable mTimeoutRunner;</span><br><span class="line">    <span class="comment">// 表示哪些数据库发生了变化，最大等于 build 时传入的 uris 个数！</span></span><br><span class="line">    ArraySet&lt;Uri&gt; mChangedUris;</span><br><span class="line">    ArraySet&lt;String&gt; mChangedAuthorities;</span><br><span class="line">    <span class="keyword">boolean</span> mTriggerPending;</span><br><span class="line">    <span class="comment">// This constructor must be called with the master job scheduler lock held.</span></span><br><span class="line">    JobInstance(JobStatus jobStatus) &#123;</span><br><span class="line">        mJobStatus = jobStatus;</span><br><span class="line">        mExecuteRunner = <span class="keyword">new</span> TriggerRunnable(<span class="keyword">this</span>);</span><br><span class="line">        mTimeoutRunner = <span class="keyword">new</span> TriggerRunnable(<span class="keyword">this</span>);</span><br><span class="line">        <span class="comment">// 获得这个 job 所依赖的所有的数据库 uri，在 JobInfo.mTriggerContentUris 中！</span></span><br><span class="line">        <span class="comment">// 以及这个 job 所属的 userId！</span></span><br><span class="line">        <span class="keyword">final</span> JobInfo.TriggerContentUri[] uris = jobStatus.getJob().getTriggerContentUris();</span><br><span class="line">        <span class="keyword">final</span> <span class="keyword">int</span> sourceUserId = jobStatus.getSourceUserId();</span><br><span class="line">         </span><br><span class="line">        <span class="comment">// 创建 useId 下的观察者缓存，用来提高查询效率！</span></span><br><span class="line">        ArrayMap&lt;JobInfo.TriggerContentUri, ObserverInstance&gt; observersOfUser =</span><br><span class="line">                mObservers.get(sourceUserId);</span><br><span class="line">        <span class="keyword">if</span> (observersOfUser == <span class="keyword">null</span>) &#123;</span><br><span class="line">            observersOfUser = <span class="keyword">new</span> ArrayMap&lt;&gt;();</span><br><span class="line">            mObservers.put(sourceUserId, observersOfUser);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (uris != <span class="keyword">null</span>) &#123;</span><br><span class="line">            <span class="keyword">for</span> (JobInfo.TriggerContentUri uri : uris) &#123;</span><br><span class="line">                ObserverInstance obs = observersOfUser.get(uri);</span><br><span class="line">                <span class="keyword">if</span> (obs == <span class="keyword">null</span>) &#123;</span><br><span class="line">                    <span class="comment">// 为每一个 uri 都创建一个观察者实例！</span></span><br><span class="line">                    obs = <span class="keyword">new</span> ObserverInstance(mHandler, uri, jobStatus.getSourceUserId());</span><br><span class="line">                    <span class="comment">// 添加到 ContentObserverController 的缓存集合里</span></span><br><span class="line">                    observersOfUser.put(uri, obs);</span><br><span class="line">                    <span class="keyword">final</span> <span class="keyword">boolean</span> andDescendants = (uri.getFlags() &amp;</span><br><span class="line">                            JobInfo.TriggerContentUri.FLAG_NOTIFY_FOR_DESCENDANTS) != <span class="number">0</span>;</span><br><span class="line"></span><br><span class="line">                    <span class="keyword">if</span> (DEBUG) &#123;</span><br><span class="line">                        Slog.v(TAG, <span class="string">"New observer "</span> + obs + <span class="string">" for "</span> + uri.getUri()</span><br><span class="line">                                + <span class="string">" andDescendants="</span> + andDescendants</span><br><span class="line">                                + <span class="string">" sourceUserId="</span> + sourceUserId);</span><br><span class="line">                    &#125;</span><br><span class="line">                    <span class="comment">// 注册这个内容观察者，当内容发生变化后，会触发回调！</span></span><br><span class="line">                    mContext.getContentResolver().registerContentObserver(</span><br><span class="line">                            uri.getUri(),</span><br><span class="line">                            andDescendants,</span><br><span class="line">                            obs,</span><br><span class="line">                            sourceUserId</span><br><span class="line">                    );</span><br><span class="line">                &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                    <span class="keyword">if</span> (DEBUG) &#123;</span><br><span class="line">                        <span class="keyword">final</span> <span class="keyword">boolean</span> andDescendants = (uri.getFlags() &amp;</span><br><span class="line">                                JobInfo.TriggerContentUri.FLAG_NOTIFY_FOR_DESCENDANTS) != <span class="number">0</span>;</span><br><span class="line">                        Slog.v(TAG, <span class="string">"Reusing existing observer "</span> + obs + <span class="string">" for "</span> + uri.getUri()</span><br><span class="line">                                + <span class="string">" andDescendants="</span> + andDescendants);</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;</span><br><span class="line">                <span class="comment">// 将这个 JobInstance 添加到这个 ContextObsercer 中！</span></span><br><span class="line">                obs.mJobs.add(<span class="keyword">this</span>);</span><br><span class="line">                <span class="comment">// 添加到 jobInstance 的 mMyObservers 中！</span></span><br><span class="line">                mMyObservers.add(obs);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    ... ... ... ...</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
</li>
</ul>
<p>这里创建了一个 ObserverInstance 对象，用来监听数据库的变动，当 uri 所指向的数据库发生变化后，他会通知所有的和他关联的 job Instance：</p>
<h3 id="6-1-2-ObserverInstance"><a href="#6-1-2-ObserverInstance" class="headerlink" title="6.1.2 ObserverInstance"></a>6.1.2 ObserverInstance</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">final</span> <span class="class"><span class="keyword">class</span> <span class="title">ObserverInstance</span> <span class="keyword">extends</span> <span class="title">ContentObserver</span> </span>&#123;</span><br><span class="line">    <span class="keyword">final</span> JobInfo.TriggerContentUri mUri;</span><br><span class="line">    <span class="keyword">final</span> <span class="meta">@UserIdInt</span> <span class="keyword">int</span> mUserId;</span><br><span class="line">    <span class="comment">// 表示的是这个数据库关联的所有的 job 实例！</span></span><br><span class="line">    <span class="keyword">final</span> ArraySet&lt;JobInstance&gt; mJobs = <span class="keyword">new</span> ArraySet&lt;&gt;();</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="title">ObserverInstance</span><span class="params">(Handler handler, JobInfo.TriggerContentUri uri,</span></span></span><br><span class="line"><span class="function"><span class="params">            @UserIdInt <span class="keyword">int</span> userId)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">super</span>(handler);</span><br><span class="line">        mUri = uri;</span><br><span class="line">        mUserId = userId;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onChange</span><span class="params">(<span class="keyword">boolean</span> selfChange, Uri uri)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">if</span> (DEBUG) &#123;</span><br><span class="line">            Slog.i(TAG,<span class="string">"onChange(self="</span> + selfChange + <span class="string">") for "</span>  + uri</span><br><span class="line">                    + <span class="string">" when mUri="</span> + mUri + <span class="string">" mUserId="</span> + mUserId);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">synchronized</span> (mLock) &#123;</span><br><span class="line">            <span class="keyword">final</span> <span class="keyword">int</span> N = mJobs.size();</span><br><span class="line">            <span class="comment">// 当 uri 所指向的数据库发生变化后，他会通知所有的和他关联的 job Instance！</span></span><br><span class="line">            <span class="comment">// 将改变的数据库的 uri 和 authority 保存到对应的 JobInstance 中！</span></span><br><span class="line">            <span class="keyword">for</span> (<span class="keyword">int</span> i=<span class="number">0</span>; i&lt;N; i++) &#123;</span><br><span class="line">                JobInstance inst = mJobs.valueAt(i);</span><br><span class="line">                <span class="keyword">if</span> (inst.mChangedUris == <span class="keyword">null</span>) &#123;</span><br><span class="line">                    inst.mChangedUris = <span class="keyword">new</span> ArraySet&lt;&gt;();</span><br><span class="line">                &#125;</span><br><span class="line">                <span class="keyword">if</span> (inst.mChangedUris.size() &lt; MAX_URIS_REPORTED) &#123;</span><br><span class="line">                    inst.mChangedUris.add(uri);</span><br><span class="line">                &#125;</span><br><span class="line">                <span class="keyword">if</span> (inst.mChangedAuthorities == <span class="keyword">null</span>) &#123;</span><br><span class="line">                    inst.mChangedAuthorities = <span class="keyword">new</span> ArraySet&lt;&gt;();</span><br><span class="line">                &#125;</span><br><span class="line">                inst.mChangedAuthorities.add(uri.getAuthority());</span><br><span class="line">                <span class="comment">// 调用 JobStance 的 scheduleLocked 方法！</span></span><br><span class="line">                inst.scheduleLocked();</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>接下来，进入到 JobInstance 中，当观察者发现数据库改变了，他最终会调用相关联的所有的 JobInstance 的 scheduleLocked 方法：</p>
<h4 id="6-1-2-1-JI-scheduleLocked"><a href="#6-1-2-1-JI-scheduleLocked" class="headerlink" title="6.1.2.1 JI.scheduleLocked"></a>6.1.2.1 JI.scheduleLocked</h4><p>开始执行触发任务：<br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">scheduleLocked</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    <span class="keyword">if</span> (!mTriggerPending) &#123;</span><br><span class="line">        mTriggerPending = <span class="keyword">true</span>;</span><br><span class="line">        mHandler.postDelayed(mTimeoutRunner, mJobStatus.getTriggerContentMaxDelay());</span><br><span class="line">    &#125;</span><br><span class="line">    mHandler.removeCallbacks(mExecuteRunner);</span><br><span class="line">    <span class="comment">// URIS_URGENT_THRESHOLD 表示一个 job 最大可以依赖的数据库个数！</span></span><br><span class="line">    <span class="keyword">if</span> (mChangedUris.size() &gt;= URIS_URGENT_THRESHOLD) &#123;</span><br><span class="line">        <span class="comment">// If we start getting near the limit, GO NOW!</span></span><br><span class="line">        mHandler.post(mExecuteRunner);</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        mHandler.postDelayed(mExecuteRunner, mJobStatus.getTriggerContentUpdateDelay());</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>mTriggerPending 默认为 fasle。用来标记：Job 触发是否正在进行！<br>可以看出：<br>第一次数据库改变，执行触发时，会延迟处理，延迟时间是：JobStatus.getTriggerContentMaxDelay()；<br>如果在第一次触发还未结束，又进行了多次触发，延时处理，延时时间是：JobStatus.getTriggerContentUpdateDelay()；<br>如果这个 job 依赖的数据库 uri 的个数到达的最大限制，就立刻触发，优先处理资源紧缺的 job 触发！</p>
<p>这里会在主线程执行 mTimeoutRunner 和  mExecuteRunner，mExecuteRunner  是 TriggerRunnable 对象：<br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">static</span> <span class="keyword">final</span> <span class="class"><span class="keyword">class</span> <span class="title">TriggerRunnable</span> <span class="keyword">implements</span> <span class="title">Runnable</span> </span>&#123;</span><br><span class="line">    <span class="keyword">final</span> JobInstance mInstance;</span><br><span class="line">    TriggerRunnable(JobInstance instance) &#123;</span><br><span class="line">        mInstance = instance;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="meta">@Override</span> <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">run</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="comment">// 执行 JobInstance 的 trigger 方法！</span></span><br><span class="line">        mInstance.trigger();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>我们进入到 trigger 方法中，去看看：</p>
<h4 id="6-1-2-2-JI-trigger"><a href="#6-1-2-2-JI-trigger" class="headerlink" title="6.1.2.2 JI.trigger"></a>6.1.2.2 JI.trigger</h4><p>这个方法就是最终的通知改变的方法：<br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">trigger</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    <span class="keyword">boolean</span> reportChange = <span class="keyword">false</span>;</span><br><span class="line">    <span class="keyword">synchronized</span> (mLock) &#123;</span><br><span class="line">        <span class="keyword">if</span> (mTriggerPending) &#123;</span><br><span class="line">            <span class="comment">// 判断是否需要改变 job 状态</span></span><br><span class="line">            <span class="keyword">if</span> (mJobStatus.setContentTriggerConstraintSatisfied(<span class="keyword">true</span>)) &#123;</span><br><span class="line">                reportChange = <span class="keyword">true</span>;</span><br><span class="line">            &#125;</span><br><span class="line">            unscheduleLocked(); <span class="comment">// 结束本次执行操作！</span></span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// Let the scheduler know that state has changed. This may or may not result in an</span></span><br><span class="line">    <span class="comment">// execution.</span></span><br><span class="line">    <span class="keyword">if</span> (reportChange) &#123; <span class="comment">// 当 reportChange 为 true 后，就通知 JobScheduler！</span></span><br><span class="line">        mStateChangedListener.onControllerStateChanged();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>再来看看 unscheduleLocked 方法，本次执行结束，取消任务，标记位置 mTriggerPending 置为 false！<br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">unscheduleLocked</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    <span class="keyword">if</span> (mTriggerPending) &#123;</span><br><span class="line">        mHandler.removeCallbacks(mExecuteRunner);</span><br><span class="line">        mHandler.removeCallbacks(mTimeoutRunner);</span><br><span class="line">        mTriggerPending = <span class="keyword">false</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>这里逻辑已经很清楚了，就不多说了！</p>
<h2 id="6-2-maybeStopTrackingJobLocked"><a href="#6-2-maybeStopTrackingJobLocked" class="headerlink" title="6.2 maybeStopTrackingJobLocked"></a>6.2 maybeStopTrackingJobLocked</h2><p>接下来，我们来看看停止监视相关的代码：<br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">maybeStopTrackingJobLocked</span><span class="params">(JobStatus taskStatus, JobStatus incomingJob,</span></span></span><br><span class="line"><span class="function"><span class="params">        <span class="keyword">boolean</span> forUpdate)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">if</span> (taskStatus.hasContentTriggerConstraint()) &#123;</span><br><span class="line">        <span class="keyword">if</span> (taskStatus.contentObserverJobInstance != <span class="keyword">null</span>) &#123;</span><br><span class="line">            <span class="comment">// 停止相应的 jobInstance 的执行</span></span><br><span class="line">            taskStatus.contentObserverJobInstance.unscheduleLocked();</span><br><span class="line">            <span class="keyword">if</span> (incomingJob != <span class="keyword">null</span>) &#123; <span class="comment">// 如果是有相同 userId 和 jobId 的新 job。即 incomingJob 不为 null！</span></span><br><span class="line">                <span class="keyword">if</span> (taskStatus.contentObserverJobInstance != <span class="keyword">null</span></span><br><span class="line">                        &amp;&amp; taskStatus.contentObserverJobInstance.mChangedAuthorities != <span class="keyword">null</span>) &#123;</span><br><span class="line">                    <span class="comment">// We are stopping this job, but it is going to be replaced by this given</span></span><br><span class="line">                    <span class="comment">// incoming job.  We want to propagate our state over to it, so we don't</span></span><br><span class="line">                    <span class="comment">// lose any content changes that had happend since the last one started.</span></span><br><span class="line">                    <span class="comment">// If there is a previous job associated with the new job, propagate over</span></span><br><span class="line">                    <span class="comment">// any pending content URI trigger reports.</span></span><br><span class="line">                    <span class="keyword">if</span> (incomingJob.contentObserverJobInstance == <span class="keyword">null</span>) &#123;</span><br><span class="line">                        <span class="comment">// 给新 job 创建对应的 jobInstance</span></span><br><span class="line">                        incomingJob.contentObserverJobInstance = <span class="keyword">new</span> JobInstance(incomingJob);</span><br><span class="line">                    &#125;</span><br><span class="line">                    <span class="comment">// 用旧的 jobInstance 来初始化新的 JobInstance 的 uris/authorities</span></span><br><span class="line">                    incomingJob.contentObserverJobInstance.mChangedAuthorities</span><br><span class="line">                            = taskStatus.contentObserverJobInstance.mChangedAuthorities;</span><br><span class="line">                    incomingJob.contentObserverJobInstance.mChangedUris</span><br><span class="line">                            = taskStatus.contentObserverJobInstance.mChangedUris;</span><br><span class="line">                    <span class="comment">// 清空旧得 jobInstance 的 uris/authorities</span></span><br><span class="line">                    taskStatus.contentObserverJobInstance.mChangedAuthorities = <span class="keyword">null</span>;</span><br><span class="line">                    taskStatus.contentObserverJobInstance.mChangedUris = <span class="keyword">null</span>;</span><br><span class="line">                &#125;</span><br><span class="line">                <span class="comment">// We won't detach the content observers here, because we want to</span></span><br><span class="line">                <span class="comment">// allow them to continue monitoring so we don't miss anything...  and</span></span><br><span class="line">                <span class="comment">// since we are giving an incomingJob here, we know this will be</span></span><br><span class="line">                <span class="comment">// immediately followed by a start tracking of that job.</span></span><br><span class="line">            &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                <span class="comment">// But here there is no incomingJob, so nothing coming up, so time to detach.</span></span><br><span class="line">                taskStatus.contentObserverJobInstance.detachLocked();</span><br><span class="line">                taskStatus.contentObserverJobInstance = <span class="keyword">null</span>;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">if</span> (DEBUG) &#123;</span><br><span class="line">            Slog.i(TAG, <span class="string">"No longer tracking job "</span> + taskStatus);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">// 从监视队列中删除这个 job！</span></span><br><span class="line">        mTrackedTasks.remove(taskStatus);</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure></p>
<p>这段代码的逻辑很简单：</p>
<ul>
<li>如果 incomingJob 不为 null，说明有新任务会取代旧任务！</li>
<li>如果 incomingJob 为 null，说明是取消当前的这个任务！</li>
</ul>
<p>这里调用了 JobInstance 的 detachLocked 方法：</p>
<h3 id="6-2-1-JI-detachLocked"><a href="#6-2-1-JI-detachLocked" class="headerlink" title="6.2.1 JI.detachLocked"></a>6.2.1 JI.detachLocked</h3><p>遍历 JobInstance 所依赖的所有观察者，解除依赖；取消依赖为 0 的观察者的注册；从 ContentObserverController 的缓存中删除这个观察者！<br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">detachLocked</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    <span class="keyword">final</span> <span class="keyword">int</span> N = mMyObservers.size();</span><br><span class="line">    <span class="keyword">for</span> (<span class="keyword">int</span> i=<span class="number">0</span>; i&lt;N; i++) &#123;</span><br><span class="line">        <span class="comment">// 从这个 jobInstance 相关联的所有 ObserverInstance 移除对自身的关联！</span></span><br><span class="line">        <span class="keyword">final</span> ObserverInstance obs = mMyObservers.get(i);</span><br><span class="line">        obs.mJobs.remove(<span class="keyword">this</span>);</span><br><span class="line">         </span><br><span class="line">        <span class="comment">// 如果这个观察者依赖的 JobInstance 为 0！</span></span><br><span class="line">        <span class="keyword">if</span> (obs.mJobs.size() == <span class="number">0</span>) &#123;</span><br><span class="line">            <span class="keyword">if</span> (DEBUG) &#123;</span><br><span class="line">                Slog.i(TAG, <span class="string">"Unregistering observer "</span> + obs + <span class="string">" for "</span> + obs.mUri.getUri());</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="comment">// 取消这个观察者的注册</span></span><br><span class="line">            mContext.getContentResolver().unregisterContentObserver(obs);</span><br><span class="line">            ArrayMap&lt;JobInfo.TriggerContentUri, ObserverInstance&gt; observerOfUser =</span><br><span class="line">                    mObservers.get(obs.mUserId);</span><br><span class="line"></span><br><span class="line">            <span class="keyword">if</span> (observerOfUser !=  <span class="keyword">null</span>) &#123;</span><br><span class="line">                <span class="comment">// 并将这个观测者从 ContentObserverController 的缓存中删除！</span></span><br><span class="line">                observerOfUser.remove(obs.mUri);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>不多说了！</p>
<h2 id="6-3-prepareForExecutionLocked"><a href="#6-3-prepareForExecutionLocked" class="headerlink" title="6.3 prepareForExecutionLocked"></a>6.3 prepareForExecutionLocked</h2><p>这个是执行 job 前的准备操作！<br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">prepareForExecutionLocked</span><span class="params">(JobStatus taskStatus)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">if</span> (taskStatus.hasContentTriggerConstraint()) &#123;</span><br><span class="line">        <span class="keyword">if</span> (taskStatus.contentObserverJobInstance != <span class="keyword">null</span>) &#123;</span><br><span class="line">            taskStatus.changedUris = taskStatus.contentObserverJobInstance.mChangedUris;</span><br><span class="line">            taskStatus.changedAuthorities = taskStatus.contentObserverJobInstance.mChangedAuthorities;</span><br><span class="line"></span><br><span class="line">            taskStatus.contentObserverJobInstance.mChangedUris = <span class="keyword">null</span>;</span><br><span class="line">            taskStatus.contentObserverJobInstance.mChangedAuthorities = <span class="keyword">null</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>这个很简单吧，不说了！</p>
<h1 id="7-DeviceIdleJobsController"><a href="#7-DeviceIdleJobsController" class="headerlink" title="7 DeviceIdleJobsController"></a>7 DeviceIdleJobsController</h1><p>这个是 Doze 模式的控制器，我们先来看看构造器：<br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">private</span> <span class="title">DeviceIdleJobsController</span><span class="params">(JobSchedulerService jobSchedulerService, Context context,</span></span></span><br><span class="line"><span class="function"><span class="params">        Object lock)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">super</span>(jobSchedulerService, context, lock);</span><br><span class="line">    mJobSchedulerService = jobSchedulerService;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 获得 PowerManagerService 对象！</span></span><br><span class="line">    mPowerManager = (PowerManager) mContext.getSystemService(Context.POWER_SERVICE);</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 获得 DOZE 模式的 DeviceIdleController 服务对象！</span></span><br><span class="line">    mLocalDeviceIdleController =</span><br><span class="line">            LocalServices.getService(DeviceIdleController.LocalService.class);</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 这里注册了一个广播接收者！</span></span><br><span class="line">    <span class="keyword">final</span> IntentFilter filter = <span class="keyword">new</span> IntentFilter();</span><br><span class="line">    filter.addAction(PowerManager.ACTION_DEVICE_IDLE_MODE_CHANGED);</span><br><span class="line">    filter.addAction(PowerManager.ACTION_LIGHT_DEVICE_IDLE_MODE_CHANGED);</span><br><span class="line">    filter.addAction(PowerManager.ACTION_POWER_SAVE_WHITELIST_CHANGED);</span><br><span class="line">    mContext.registerReceiverAsUser(</span><br><span class="line">            mBroadcastReceiver, UserHandle.ALL, filter, <span class="keyword">null</span>, <span class="keyword">null</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>注册了一个广播接收者，来接受这三个广播：</p>
<ul>
<li>PowerManager.ACTION_DEVICE_IDLE_MODE_CHANGED；</li>
<li>PowerManager.ACTION_LIGHT_DEVICE_IDLE_MODE_CHANGED；</li>
<li>PowerManager.ACTION_POWER_SAVE_WHITELIST_CHANGED；</li>
</ul>
<h2 id="7-1-BroadcastReceiver"><a href="#7-1-BroadcastReceiver" class="headerlink" title="7.1 BroadcastReceiver"></a>7.1 BroadcastReceiver</h2><p>我们来看看这里注册的这个广播接收者：<br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">private</span> <span class="keyword">final</span> BroadcastReceiver mBroadcastReceiver = <span class="keyword">new</span> BroadcastReceiver() &#123;</span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onReceive</span><span class="params">(Context context, Intent intent)</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">final</span> String action = intent.getAction();</span><br><span class="line">        <span class="comment">// 设备 idle 状态改变的广播</span></span><br><span class="line">        <span class="keyword">if</span> (PowerManager.ACTION_LIGHT_DEVICE_IDLE_MODE_CHANGED.equals(action)</span><br><span class="line">                || PowerManager.ACTION_DEVICE_IDLE_MODE_CHANGED.equals(action)) &#123;</span><br><span class="line">                </span><br><span class="line">            updateIdleMode(mPowerManager != <span class="keyword">null</span></span><br><span class="line">                    ? (mPowerManager.isDeviceIdleMode()</span><br><span class="line">                            || mPowerManager.isLightDeviceIdleMode())</span><br><span class="line">                    : <span class="keyword">false</span>);</span><br><span class="line">        <span class="comment">// doze 模式白名单改变的广播</span></span><br><span class="line">        &#125; <span class="keyword">else</span> <span class="keyword">if</span> (PowerManager.ACTION_POWER_SAVE_WHITELIST_CHANGED.equals(action)) &#123;</span><br><span class="line">            updateWhitelist();</span><br><span class="line"></span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure></p>
<p>这里在接收到指定的广播后，会调用指定的方法，我们一个一个看：<br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 更新 doze 模式的白名单！</span></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">updateWhitelist</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    <span class="keyword">synchronized</span> (mLock) &#123;</span><br><span class="line">        <span class="keyword">if</span> (mLocalDeviceIdleController != <span class="keyword">null</span>) &#123;</span><br><span class="line">        </span><br><span class="line">            <span class="comment">// 将最新的白名单保存到 mDeviceIdleWhitelistAppIds 数组中！</span></span><br><span class="line">            mDeviceIdleWhitelistAppIds =</span><br><span class="line">                    mLocalDeviceIdleController.getPowerSaveWhitelistUserAppIds();</span><br><span class="line">            <span class="keyword">if</span> (LOG_DEBUG) &#123;</span><br><span class="line">                Slog.d(LOG_TAG, <span class="string">"Got whitelist "</span> + Arrays.toString(mDeviceIdleWhitelistAppIds));</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>这个方法很简单，更新 mDeviceIdleWhitelistAppIds 白名单数组！</p>
<p>接着来看 updateIdleMode 方法，当受到设备状态改变的广播后，需要通知 JSS：<br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">updateIdleMode</span><span class="params">(<span class="keyword">boolean</span> enabled)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">boolean</span> changed = <span class="keyword">false</span>;</span><br><span class="line">    <span class="comment">// Need the whitelist to be ready when going into idle</span></span><br><span class="line">    <span class="keyword">if</span> (mDeviceIdleWhitelistAppIds == <span class="keyword">null</span>) &#123;</span><br><span class="line">    </span><br><span class="line">        <span class="comment">// 如果白名单为 null，就先去更新 doze 白名单！</span></span><br><span class="line">        updateWhitelist();</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">synchronized</span> (mLock) &#123;</span><br><span class="line">        <span class="keyword">if</span> (mDeviceIdleMode != enabled) &#123; <span class="comment">// 如果这次的状态和上一次不一样，那就要触发 job！</span></span><br><span class="line">            changed = <span class="keyword">true</span>; <span class="comment">// changed 置为 true</span></span><br><span class="line">        &#125;</span><br><span class="line">        mDeviceIdleMode = enabled;</span><br><span class="line">        <span class="keyword">if</span> (LOG_DEBUG) Slog.d(LOG_TAG, <span class="string">"mDeviceIdleMode="</span> + mDeviceIdleMode);</span><br><span class="line">        </span><br><span class="line">        mJobSchedulerService.getJobStore().forEachJob(mUpdateFunctor); <span class="comment">//　更新 job 的状态！</span></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// Inform the job scheduler service about idle mode changes</span></span><br><span class="line">    <span class="keyword">if</span> (changed) &#123;</span><br><span class="line">        mStateChangedListener.onDeviceIdleStateChanged(enabled); <span class="comment">// 回调通知 jobScheduler，设备状态改变了！</span></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>这里会执行一个 JobStatusFunctor 的操作：<br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">final</span> JobStore.JobStatusFunctor mUpdateFunctor = <span class="keyword">new</span> JobStore.JobStatusFunctor() &#123;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// 对 JobStore 中的每个 job 执行 process 操作！</span></span><br><span class="line">    <span class="meta">@Override</span> <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">process</span><span class="params">(JobStatus jobStatus)</span> </span>&#123;</span><br><span class="line">        updateTaskStateLocked(jobStatus);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure></p>
<p>接着来看：<br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">updateTaskStateLocked</span><span class="params">(JobStatus task)</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 判断这个 job 的 uid 是否在 doze 模式的白名单中！</span></span><br><span class="line">    <span class="keyword">final</span> <span class="keyword">boolean</span> whitelisted = isWhitelistedLocked(task);</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// 是否满足 doze 模式的约束条件</span></span><br><span class="line">    <span class="keyword">final</span> <span class="keyword">boolean</span> enableTask = !mDeviceIdleMode || whitelisted;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// 更新 job 的状态！</span></span><br><span class="line">    task.setDeviceNotDozingConstraintSatisfied(enableTask, whitelisted);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>这里最后会调用：setDeviceNotDozingConstraintSatisfied 方法！</p>
<h1 id="8-附录"><a href="#8-附录" class="headerlink" title="8 附录"></a>8 附录</h1><h2 id="8-1-JobStatus-setConstraintSatisfied"><a href="#8-1-JobStatus-setConstraintSatisfied" class="headerlink" title="8.1 JobStatus.setConstraintSatisfied"></a>8.1 JobStatus.setConstraintSatisfied</h2><p>在 JobStatus 中，有着两个变量：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// Constraints.</span></span><br><span class="line"><span class="keyword">final</span> <span class="keyword">int</span> requiredConstraints;</span><br><span class="line"><span class="keyword">int</span> satisfiedConstraints = <span class="number">0</span>;</span><br></pre></td></tr></table></figure>
<p>这里解释一下：</p>
<ul>
<li>requiredConstraints：这是一个 final 类型的变量，是在 JobInfo 创建的时候，设置的所有的约束条件，一旦设置，就不可变了！</li>
<li>satisfiedConstraints：它的每个二进制位是可变的，用来动态记录 job 的约束条件是否发生了变化！</li>
</ul>
<p>在上面，我们看到，每个控制器都有调用这样的方法，这个方法，很有意思，我们看一下，参数传递：</p>
<ul>
<li>int constraint：某一个约束条件！</li>
<li>boolean state：这一次是否满足条件！</li>
</ul>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">boolean</span> <span class="title">setConstraintSatisfied</span><span class="params">(<span class="keyword">int</span> constraint, <span class="keyword">boolean</span> state)</span> </span>&#123;</span><br><span class="line">    <span class="comment">// 判断上一次是否满足约束条件！</span></span><br><span class="line">    <span class="keyword">boolean</span> old = (satisfiedConstraints&amp;constraint) != <span class="number">0</span>;</span><br><span class="line">    <span class="comment">// 如果相等，说明约束条件没有变化，无需改变 job 的状态，返回 false！</span></span><br><span class="line">    <span class="keyword">if</span> (old == state) &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">false</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// 如果不相等，说明约束条件变化了，那就要返回 true！</span></span><br><span class="line">    <span class="comment">// 并根据 state 的值来修改 satisfiedConstraints 的 constraint 位！</span></span><br><span class="line">    satisfiedConstraints = (satisfiedConstraints&amp;~constraint) | (state ? constraint : <span class="number">0</span>);</span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">true</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>返回值说明：</p>
<ul>
<li>返回 false：说明约束条件保持不变，无需修改  satisfiedConstraints 的指定二进制位！</li>
<li>返回 true：说明约束条件发生了变化，可能是从满足变为不满足，也可能是从不满足变为满足，最终的状态动态记录在 satisfiedConstraints 中！</li>
</ul>
<p>注意：<br>satisfiedConstraints&amp;~constraint 的作用是：将 constraint 位置为 0！<br>(satisfiedConstraints&amp;~constraint) | (state ? constraint : 0) 的作用是：根据 state 的值，将 satisfiedConstraints 的二进制位 constraint 置为 1/0；</p>
<h2 id="8-1-JobStatus-isConstraintSatisfied"><a href="#8-1-JobStatus-isConstraintSatisfied" class="headerlink" title="8.1 JobStatus.isConstraintSatisfied"></a>8.1 JobStatus.isConstraintSatisfied</h2><p>这个方法的作用很简单，判断此时 jobStatus 是否满足指定条件：<br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">boolean</span> <span class="title">isConstraintSatisfied</span><span class="params">(<span class="keyword">int</span> constraint)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">return</span> (satisfiedConstraints&amp;constraint) != <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<h2 id="8-3-JobSchedulerService"><a href="#8-3-JobSchedulerService" class="headerlink" title="8.3 JobSchedulerService"></a>8.3 JobSchedulerService</h2><p>前面可以看到，每个控制器，最后都调用了 JSS 的如下方法：</p>
<ul>
<li>ConnectivityController：                  onControllerStateChanged、onRunJobNow</li>
<li>TimeController：                          onControllerStateChanged、onRunJobNow</li>
<li>IdleController：                          onControllerStateChanged</li>
<li>BatteryController：                       onControllerStateChanged、onRunJobNow</li>
<li>AppIdleController：                       onControllerStateChanged</li>
<li>ContentObserverController：               onControllerStateChanged</li>
<li>DeviceIdleJobsController：                onDeviceIdleStateChanged</li>
</ul>
<p>接下来，我们看下这几个方法：<br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onControllerStateChanged</span><span class="params">()</span> </span>&#123;<span class="comment">// 控制器状态变化，</span></span><br><span class="line">    mHandler.obtainMessage(MSG_CHECK_JOB).sendToTarget();</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onRunJobNow</span><span class="params">(JobStatus jobStatus)</span> </span>&#123;</span><br><span class="line">    mHandler.obtainMessage(MSG_JOB_EXPIRED, jobStatus).sendToTarget();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>这两个方法很简单，区别在于：</p>
<ul>
<li>MSG_CHECK_JOB：让 JobSchedulerService 去，遍历 JobStore 执行相应的 job！</li>
<li>MSG_JOB_EXPIRED：立刻执行这个 job！</li>
</ul>
<p>接着：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onDeviceIdleStateChanged</span><span class="params">(<span class="keyword">boolean</span> deviceIdle)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">synchronized</span> (mLock) &#123;</span><br><span class="line">        <span class="keyword">if</span> (deviceIdle) &#123;</span><br><span class="line">            <span class="comment">// When becoming idle, make sure no jobs are actively running,</span></span><br><span class="line">            <span class="comment">// except those using the idle exemption flag.</span></span><br><span class="line"></span><br><span class="line">            <span class="keyword">for</span> (<span class="keyword">int</span> i=<span class="number">0</span>; i&lt;mActiveServices.size(); i++) &#123;</span><br><span class="line">                JobServiceContext jsc = mActiveServices.get(i);</span><br><span class="line">                <span class="keyword">final</span> JobStatus executing = jsc.getRunningJob();</span><br><span class="line">                <span class="keyword">if</span> (executing != <span class="keyword">null</span></span><br><span class="line">                        &amp;&amp; (executing.getFlags() &amp; JobInfo.FLAG_WILL_BE_FOREGROUND) == <span class="number">0</span>) &#123;</span><br><span class="line">                    jsc.cancelExecutingJob(JobParameters.REASON_DEVICE_IDLE); <span class="comment">// 取消执行 job</span></span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line"></span><br><span class="line">            <span class="comment">// When coming out of idle, allow thing to start back up.</span></span><br><span class="line">            <span class="keyword">if</span> (mReadyToRock) &#123;</span><br><span class="line">                <span class="keyword">if</span> (mLocalDeviceIdleController != <span class="keyword">null</span>) &#123;</span><br><span class="line">                    <span class="keyword">if</span> (!mReportedActive) &#123;</span><br><span class="line">                        mReportedActive = <span class="keyword">true</span>;</span><br><span class="line">                        mLocalDeviceIdleController.setJobsActive(<span class="keyword">true</span>);</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">            mHandler.obtainMessage(MSG_CHECK_JOB).sendToTarget();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>先到这里吧！</p>
<h2 id="8-3-Controller-和对应的条件"><a href="#8-3-Controller-和对应的条件" class="headerlink" title="8.3 Controller 和对应的条件"></a>8.3 Controller 和对应的条件</h2><p>我们来总结一下，Controller 和其对应的约束条件：</p>
</div></article><div class="post-copyright"><div class="post-copyright__author"><span class="post-copyright-meta">文章作者: </span><span class="post-copyright-info"><a href="mailto:undefined">Coolqi.Li</a></span></div><div class="post-copyright__type"><span class="post-copyright-meta">文章链接: </span><span class="post-copyright-info"><a href="https://coolqi.top/2016/04/25/JobScheduler6-JobSchedulerService-jobControll/">https://coolqi.top/2016/04/25/JobScheduler6-JobSchedulerService-jobControll/</a></span></div><div class="post-copyright__notice"><span class="post-copyright-meta">版权声明: </span><span class="post-copyright-info">本博客所有文章除特别声明外，均采用 <a href="https://creativecommons.org/licenses/by-nc-sa/4.0/">CC BY-NC-SA 4.0</a> 许可协议。转载请注明来自 <a href="https://coolqi.top">Coolqi`s Blog</a>！</span></div></div><div class="post-meta__tag-list"><a class="post-meta__tags" href="/tags/JobScheduler任务调度/">JobScheduler任务调度</a></div><div class="post-qr-code"><div class="post-qr-code-item"><img class="post-qr-code__img" src="/img/zfb.jpg"><div class="post-qr-code__desc">支付宝打赏</div></div><div class="post-qr-code-item"><img class="post-qr-code__img" src="/img/wechat.jpg"><div class="post-qr-code__desc">微信打赏</div></div></div><div class="social-share"></div><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/social-share.js@1.0.16/dist/css/share.min.css"><script src="https://cdn.jsdelivr.net/npm/social-share.js@1.0.16/dist/js/social-share.min.js"></script><nav id="pagination"><div class="prev-post pull-left"><a href="/2016/04/27/JobScheduler7-JobSchedulerService-packageAndUidChange/"><i class="fa fa-chevron-left">  </i><span>JobScheduler第 7 篇 - JobSchedulerService - package and uid change</span></a></div><div class="next-post pull-right"><a href="/2016/04/23/JobScheduler5-JobSchedulerService-jobFinished/"><span>JobScheduler第 5 篇 - JobSchedulerService - jobFinished</span><i class="fa fa-chevron-right"></i></a></div></nav><div class="post-adv"><a href="https://www.vultr.com/?ref=7231808"><img src="https://www.vultr.com/media/banner_1.png" width="728" height="90"></a></div><div id="gitalk-container"></div><script>var gitalk = new Gitalk({
  clientID: '4ddbf07faadeded6a7f0',
  clientSecret: '70a7a67c1e13762c3d1a00030ee92a69d21a1b28',
  repo: 'git-single-lee.github.io',
  owner: 'git-single-lee',
  admin: 'git-single-lee',
  id: md5(location.pathname),
  language: 'zh-CN'
})
gitalk.render('gitalk-container')</script></div></div><footer><div class="layout" id="footer"><div class="copyright">&copy;2015 - 2019 By Coolqi.Li</div><div class="framework-info"><span>驱动 - </span><a href="http://hexo.io"><span>Hexo</span></a><span class="footer-separator">|</span><span>主题 - </span><a href="https://github.com/Molunerfinn/hexo-theme-melody"><span>Melody</span></a></div><div class="footer_custom_text">Hi, welcome to my <a href="https://coolqi.top/">blog</a>!</div><div class="busuanzi"><script async src="https://busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script><span id="busuanzi_container_page_pv"><i class="fa fa-file-o"></i><span id="busuanzi_value_page_pv"></span><span></span></span></div></div></footer><i class="fa fa-arrow-up" id="go-up" aria-hidden="true"></i><script src="/js/third-party/anime.min.js"></script><script src="/js/third-party/jquery.min.js"></script><script src="/js/third-party/jquery.fancybox.min.js"></script><script src="/js/third-party/velocity.min.js"></script><script src="/js/third-party/velocity.ui.min.js"></script><script src="/js/utils.js?version=1.5.6"></script><script src="/js/fancybox.js?version=1.5.6"></script><script src="/js/sidebar.js?version=1.5.6"></script><script src="/js/copy.js?version=1.5.6"></script><script src="/js/fireworks.js?version=1.5.6"></script><script src="/js/transition.js?version=1.5.6"></script><script src="/js/scroll.js?version=1.5.6"></script><script src="/js/head.js?version=1.5.6"></script><script type="text/x-mathjax-config">MathJax.Hub.Config({
  tex2jax: {
    inlineMath: [ ['$','$'], ["\\(","\\)"]  ],
    processEscapes: true,
    skipTags: ['script', 'noscript', 'style', 'textarea', 'pre', 'code']
  },
  CommonHTML: {
    linebreaks: { automatic: true, width: "90% container" }
  },
  "HTML-CSS": { 
    linebreaks: { automatic: true, width: "90% container" }
  },
  "SVG": { 
    linebreaks: { automatic: true, width: "90% container" }
  }
});
</script><script type="text/x-mathjax-config">MathJax.Hub.Queue(function() {
  var all = MathJax.Hub.getAllJax(), i;
  for (i=0; i < all.length; i += 1) {
    all[i].SourceElement().parentNode.className += ' has-jax';
  }
});
</script><script src="https://cdn.jsdelivr.net/npm/mathjax/MathJax.js?config=TeX-AMS-MML_HTMLorMML"></script><script src="/js/search/local-search.js"></script><div class="search-dialog" id="local-search"><div class="search-dialog__title" id="local-search-title">本地搜索</div><div id="local-input-panel"><div id="local-search-input"><div class="local-search-box"><input class="local-search-box--input" placeholder="搜索文章"></div></div></div><hr><div id="local-search-results"><div id="local-hits"></div><div id="local-stats"><div class="local-search-stats__hr" id="hr"><span>由</span> <a href="https://github.com/wzpan/hexo-generator-search" style="color:#49B1F5;">hexo-generator-search</a>
 <span>提供支持</span></div></div></div><span class="search-close-button"><i class="fa fa-times"></i></span></div><div class="search-mask"></div><script src="/live2dw/lib/L2Dwidget.min.js?0c58a1486de42ac6cc1c59c7d98ae887"></script><script>L2Dwidget.init({"pluginRootPath":"live2dw/","pluginJsPath":"lib/","pluginModelPath":"assets/","tagMode":false,"debug":false,"model":{"jsonPath":"live2d-widget-model-hijiki"},"display":{"position":"right","width":110,"height":220},"mobile":{"show":false},"log":false});</script></body></html>
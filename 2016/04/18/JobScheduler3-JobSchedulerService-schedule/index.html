<!DOCTYPE html><html lang="zh-Hans"><head><meta name="generator" content="Hexo 3.9.0"><meta charset="UTF-8"><meta http-equiv="X-UA-Compatible" content="IE=edge"><meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1"><meta name="description" content="JobScheduler第 3 篇 - JobSchedulerService - schedule"><meta name="keywords" content="JobScheduler任务调度"><meta name="author" content="Coolqi.Li"><meta name="copyright" content="Coolqi.Li"><title>JobScheduler第 3 篇 - JobSchedulerService - schedule | Coolqi`s Blog</title><link rel="shortcut icon" href="/img/favicon.ico"><link rel="stylesheet" href="/css/index.css?version=1.7.0"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/font-awesome@4.7.0/css/font-awesome.min.css?version=1.7.0"><meta name="format-detection" content="telephone=no"><meta http-equiv="x-dns-prefetch-control" content="on"><link rel="dns-prefetch" href="https://cdn.jsdelivr.net"><script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script><script>(adsbygoogle = window.adsbygoogle || []).push({
  google_ad_client: 'ca-pub-6845729157331145',
  enable_page_level_ads: 'true'
});
</script><link rel="dns-prefetch" href="https://hm.baidu.com"><script>var _hmt = _hmt || [];
(function() {
  var hm = document.createElement("script");
  hm.src = "https://hm.baidu.com/hm.js?b7acef5306e54116ad8a99e8b753a92d";
  var s = document.getElementsByTagName("script")[0]; 
  s.parentNode.insertBefore(hm, s);
})();</script><script>var GLOBAL_CONFIG = { 
  root: '/',
  algolia: undefined,
  localSearch: {"path":"search.xml","languages":{"hits_empty":"找不到您查询的内容:${query}"}},
  copy: {
    success: '复制成功',
    error: '复制错误',
    noSupport: '浏览器不支持'
  }
} </script></head><body><i class="fa fa-arrow-right" id="toggle-sidebar" aria-hidden="true"></i><div id="sidebar" data-display="true"><div class="toggle-sidebar-info text-center"><span data-toggle="切换文章详情">切换站点概览</span><hr></div><div class="sidebar-toc"><div class="sidebar-toc__title">目录</div><div class="sidebar-toc__progress"><span class="progress-notice">你已经读了</span><span class="progress-num">0</span><span class="progress-percentage">%</span><div class="sidebar-toc__progress-bar"></div></div><div class="sidebar-toc__content"><ol class="toc"><li class="toc-item toc-level-1"><a class="toc-link" href="#前言"><span class="toc-text">前言</span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#1-JobStatus-createFromJobInfo"><span class="toc-text">1 JobStatus.createFromJobInfo</span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#2-JobStore-countJobsForUid"><span class="toc-text">2 JobStore.countJobsForUid</span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#3-JobStore-getJobByUidAndJobId"><span class="toc-text">3 JobStore.getJobByUidAndJobId</span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#4-JSS-cancelJobImpl"><span class="toc-text">4 JSS.cancelJobImpl</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#4-1-JSS-stopTrackingJob"><span class="toc-text">4.1 JSS.stopTrackingJob</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#4-1-1-JobStore-remove"><span class="toc-text">4.1.1 JobStore.remove</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#4-1-2-SC-maybeStopTrackingJobLocked"><span class="toc-text">4.1.2 SC.maybeStopTrackingJobLocked</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#4-1-2-1-ConnectivityController"><span class="toc-text">4.1.2.1 ConnectivityController</span></a></li></ol></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#4-2-JobPackageTracker-noteNonpending"><span class="toc-text">4.2 JobPackageTracker.noteNonpending</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#4-3-JSS-stopJobOnServiceContextLocked"><span class="toc-text">4.3 JSS.stopJobOnServiceContextLocked</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#4-3-1-JobServiceContext-cancelExecutingJob"><span class="toc-text">4.3.1 JobServiceContext.cancelExecutingJob</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#4-4-JSS-reportActive"><span class="toc-text">4.4 JSS.reportActive</span></a></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#5-JSS-startTrackingJob"><span class="toc-text">5 JSS.startTrackingJob</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#5-1-JobStore-add"><span class="toc-text">5.1 JobStore.add</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#5-2-SC-maybeStopTrackingJobLocked"><span class="toc-text">5.2 SC.maybeStopTrackingJobLocked</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#5-2-1-ConnectivityController"><span class="toc-text">5.2.1 ConnectivityController</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#5-3-SC-maybeStartTrackingJobLocked"><span class="toc-text">5.3 SC.maybeStartTrackingJobLocked</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#5-3-1-ConnectivityController"><span class="toc-text">5.3.1 ConnectivityController</span></a></li></ol></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#6-JSS-JobHandler-MSG-CHECK-JOB"><span class="toc-text">6 [JSS.JobHandler].MSG_CHECK_JOB</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#6-1-queueReadyJobsForExecutionLockedH"><span class="toc-text">6.1 queueReadyJobsForExecutionLockedH</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#6-2-maybeQueueReadyJobsForExecutionLockedH"><span class="toc-text">6.2 maybeQueueReadyJobsForExecutionLockedH</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#6-2-1-mPendingJobs-clear"><span class="toc-text">6.2.1 mPendingJobs.clear</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#6-2-2-MaybeReadyJobQueueFunctor-process"><span class="toc-text">6.2.2 MaybeReadyJobQueueFunctor.process</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#6-2-3-MaybeReadyJobQueueFunctor-postProcess"><span class="toc-text">6.2.3 MaybeReadyJobQueueFunctor.postProcess</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#6-3-maybeRunPendingJobsH"><span class="toc-text">6.3 maybeRunPendingJobsH</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#6-3-1-JSS-assignJobsToContextsLocked"><span class="toc-text">6.3.1 JSS.assignJobsToContextsLocked</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#6-3-1-1-JSS-findJobContextIdFromMap"><span class="toc-text">6.3.1.1 JSS.findJobContextIdFromMap</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#6-3-1-2-JSS-evaluateJobPriorityLocked"><span class="toc-text">6.3.1.2 JSS.evaluateJobPriorityLocked</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#6-3-1-3-JSC-preemptExecutingJob"><span class="toc-text">6.3.1.3 JSC.preemptExecutingJob</span></a><ol class="toc-child"><li class="toc-item toc-level-5"><a class="toc-link" href="#JobServiceHandler-MSG-CANCEL"><span class="toc-text">JobServiceHandler.MSG_CANCEL</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#JobService-stopJob"><span class="toc-text">JobService.stopJob</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#JobHandler-MSG-STOP-JOB"><span class="toc-text">JobHandler.MSG_STOP_JOB</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#JobServiceContext-acknowledgeStopMessage"><span class="toc-text">JobServiceContext.acknowledgeStopMessage</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#JobServiceHandler-MSG-CALLBACK"><span class="toc-text">JobServiceHandler.MSG_CALLBACK</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#JobServiceContext-handleFinishedH"><span class="toc-text">JobServiceContext.handleFinishedH</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#JobSchedulerService-onJobCompleted"><span class="toc-text">JobSchedulerService.onJobCompleted</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#JobHandler-MSG-CHECK-JOB-GREEDY"><span class="toc-text">JobHandler.MSG_CHECK_JOB_GREEDY</span></a></li></ol></li><li class="toc-item toc-level-4"><a class="toc-link" href="#6-3-1-4-JSC-prepareForExecutionLocked"><span class="toc-text">6.3.1.4 JSC.prepareForExecutionLocked</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#6-3-1-5-JSC-executeRunnableJob"><span class="toc-text">6.3.1.5 JSC.executeRunnableJob</span></a><ol class="toc-child"><li class="toc-item toc-level-5"><a class="toc-link" href="#6-3-1-5-1-JSC-onServiceConnected"><span class="toc-text">6.3.1.5.1 JSC.onServiceConnected</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#6-3-1-5-2-JSC-JobServiceHandler"><span class="toc-text">6.3.1.5.2 JSC.JobServiceHandler</span></a><ol class="toc-child"><li class="toc-item toc-level-6"><a class="toc-link" href="#6-3-1-5-2-1-JSS-handleServiceBoundH"><span class="toc-text">6.3.1.5.2.1 JSS.handleServiceBoundH</span></a></li></ol></li></ol></li></ol></li></ol></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#7-总结"><span class="toc-text">7 总结</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#7-1-schedule-流程"><span class="toc-text">7.1 schedule 流程</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#7-2-JSC-和-JS-的关系"><span class="toc-text">7.2 JSC 和 JS 的关系</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#7-3-JSC-的-Job-分配算法"><span class="toc-text">7.3 JSC 的 Job 分配算法</span></a></li></ol></li></ol></div></div><div class="author-info hide"><div class="author-info__avatar text-center"><img src="/img/avatar.jpg"></div><div class="author-info__name text-center">Coolqi.Li</div><div class="author-info__description text-center">“Hi，我是李帅奇，Android 开发工程师，TeamLeader，熬夜星人，一个努力赚钱，积极向上的好人。”</div><div class="follow-button"><a href="https://github.com/single-li">Follow Me</a></div><hr><div class="author-info-articles"><a class="author-info-articles__archives article-meta" href="/archives"><span class="pull-left">文章</span><span class="pull-right">86</span></a><a class="author-info-articles__tags article-meta" href="/tags"><span class="pull-left">标签</span><span class="pull-right">21</span></a><a class="author-info-articles__categories article-meta" href="/categories"><span class="pull-left">分类</span><span class="pull-right">26</span></a></div><hr><div class="author-info-links"><div class="author-info-links__title text-center">Links</div><a class="author-info-links__name text-center" href="https://developer.android.google.cn/">AndroidDeveloper</a><a class="author-info-links__name text-center" href="http://www.android-studio.org/">AndroidStudio</a><a class="author-info-links__name text-center" href="https://www.jianshu.com/u/123a20a96441">简书</a><a class="author-info-links__name text-center" href="https://weibo.com/coolqiLi">微博</a></div></div></div><div id="content-outer"><div id="top-container" style="background-image: url(/img/blog-bg.jpg)"><div id="page-header"><span class="pull-left"> <a id="site-name" href="/">Coolqi`s Blog</a></span><i class="fa fa-bars toggle-menu pull-right" aria-hidden="true"></i><span class="pull-right menus">   <a class="site-page" href="/">Home</a><a class="site-page" href="/categories">Categories</a><a class="site-page" href="/tags">Tags</a><a class="site-page" href="/archives">Archives</a><a class="site-page" href="/about">About</a></span><span class="pull-right"><a class="site-page social-icon search"><i class="fa fa-search"></i><span> 搜索</span></a></span></div><div id="post-info"><div id="post-title">JobScheduler第 3 篇 - JobSchedulerService - schedule</div><div id="post-meta"><time class="post-meta__date"><i class="fa fa-calendar" aria-hidden="true"></i> 2016-04-18</time><span class="post-meta__separator">|</span><i class="fa fa-inbox post-meta__icon" aria-hidden="true"></i><a class="post-meta__categories" href="/categories/AndroidFramework源码分析/">AndroidFramework源码分析</a><i class="fa fa-angle-right" aria-hidden="true"></i><i class="fa fa-inbox post-meta__icon" aria-hidden="true"></i><a class="post-meta__categories" href="/categories/AndroidFramework源码分析/JobScheduler任务调度/">JobScheduler任务调度</a><div class="post-meta-wordcount"><span>字数总计: </span><span class="word-count">9.3k</span><span class="post-meta__separator">|</span><span>阅读时长: 43 分钟</span></div></div></div></div><div class="layout" id="content-inner"><article id="post"><div class="article-container" id="post-content"><p>基于 Android 7.1.1 源码分析，本文为作者原创，转载请说明出处，谢谢。</p>
<h1 id="前言"><a href="#前言" class="headerlink" title="前言"></a>前言</h1><p>我们先从基本的方法开始，也就是 schedule 方法，方法参数传递：</p>
<ul>
<li>JobInfo job：需要 schedule 的任务！</li>
<li>int uId：调用方的 uid！</li>
</ul>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">int</span> <span class="title">schedule</span><span class="params">(JobInfo job, <span class="keyword">int</span> uId)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">return</span> scheduleAsPackage(job, uId, <span class="keyword">null</span>, -<span class="number">1</span>, <span class="keyword">null</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">int</span> <span class="title">scheduleAsPackage</span><span class="params">(JobInfo job, <span class="keyword">int</span> uId, String packageName, <span class="keyword">int</span> userId, String tag)</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 创建新的 jobStatus</span></span><br><span class="line">    JobStatus jobStatus = JobStatus.createFromJobInfo(job, uId, packageName, userId, tag);</span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">        <span class="keyword">if</span> (ActivityManagerNative.getDefault().getAppStartMode(uId,</span><br><span class="line">                job.getService().getPackageName()) == ActivityManager.APP_START_MODE_DISABLED) &#123;</span><br><span class="line">            Slog.w(TAG, <span class="string">"Not scheduling job "</span> + uId + <span class="string">":"</span> + job.toString()</span><br><span class="line">                    + <span class="string">" -- package not allowed to start"</span>);</span><br><span class="line">            <span class="keyword">return</span> JobScheduler.RESULT_FAILURE;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125; <span class="keyword">catch</span> (RemoteException e) &#123;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (DEBUG) Slog.d(TAG, <span class="string">"SCHEDULE: "</span> + jobStatus.toShortString());</span><br><span class="line">    JobStatus toCancel;</span><br><span class="line">    <span class="keyword">synchronized</span> (mLock) &#123;</span><br><span class="line">        <span class="comment">// 判断应用设置的任务数量是否超过上限：100</span></span><br><span class="line">        <span class="keyword">if</span> (ENFORCE_MAX_JOBS &amp;&amp; packageName == <span class="keyword">null</span>) &#123;</span><br><span class="line">            <span class="keyword">if</span> (mJobs.countJobsForUid(uId) &gt; MAX_JOBS_PER_APP) &#123;</span><br><span class="line">                Slog.w(TAG, <span class="string">"Too many jobs for uid "</span> + uId);</span><br><span class="line">                <span class="keyword">throw</span> <span class="keyword">new</span> IllegalStateException(<span class="string">"Apps may not schedule more than "</span></span><br><span class="line">                            + MAX_JOBS_PER_APP + <span class="string">" distinct jobs"</span>);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 如果同一个id，之前已经注册了一个任务，取消上一个任务</span></span><br><span class="line">        toCancel = mJobs.getJobByUidAndJobId(uId, job.getId());</span><br><span class="line">        <span class="keyword">if</span> (toCancel != <span class="keyword">null</span>) &#123;</span><br><span class="line">            cancelJobImpl(toCancel, jobStatus);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 开始追踪该任务</span></span><br><span class="line">        startTrackingJob(jobStatus, toCancel);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 向 system_server 进程的主线程发送 message：MSG_CHECK_JOB</span></span><br><span class="line">    mHandler.obtainMessage(MSG_CHECK_JOB).sendToTarget();</span><br><span class="line">    <span class="keyword">return</span> JobScheduler.RESULT_SUCCESS;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>这里的 ENFORCE_MAX_JOBS 是一个 boolean 值，表示是否限制每个应用的 job 数！</p>
<blockquote>
<p>   private static final int MAX_JOBS_PER_APP = 100;</p>
</blockquote>
<p>这里 MAX_JOBS_PER_APP 表示每个应用最大的 Job 数！</p>
<p>这里总结一下 schedule 方法的主要流程：</p>
<ul>
<li>根据传入的 JobInfo，创建 JobStatus；</li>
<li>如果已经注册过一个相同 uid，相同 jobId 的 job，就取消之前注册过的；</li>
<li>将新 job 加入到 JobStore 中，并通知 controller 开始监控新 schedule 的 job！</li>
<li>发送 MSG_CHECK_JOB 消息给 JobHandler，执行 job！</li>
</ul>
<p>我们是使用 schedule 方法将我们需要的任务注册到系统中的，传入的参数主要是：</p>
<ul>
<li>JobInfo：封装任务的基本信息！</li>
<li>uId：调用者的 uid！</li>
</ul>
<p>我们接着来看，先调用 JobStatus 的 createFromJobInfo ，创建 JobStatus：</p>
<h1 id="1-JobStatus-createFromJobInfo"><a href="#1-JobStatus-createFromJobInfo" class="headerlink" title="1 JobStatus.createFromJobInfo"></a>1 JobStatus.createFromJobInfo</h1><p>参数传递：job, uId, null, -1, null：<br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">static</span> JobStatus <span class="title">createFromJobInfo</span><span class="params">(JobInfo job, <span class="keyword">int</span> callingUid, String sourcePackageName, <span class="keyword">int</span> sourceUserId, String tag)</span> </span>&#123;</span><br><span class="line">    <span class="comment">// 从开机到现在的时间</span></span><br><span class="line">    <span class="keyword">final</span> <span class="keyword">long</span> elapsedNow = SystemClock.elapsedRealtime();</span><br><span class="line">    <span class="keyword">final</span> <span class="keyword">long</span> earliestRunTimeElapsedMillis, latestRunTimeElapsedMillis;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 判断这个任务是否是周期性的</span></span><br><span class="line">    <span class="keyword">if</span> (job.isPeriodic()) &#123;</span><br><span class="line">        latestRunTimeElapsedMillis = elapsedNow + job.getIntervalMillis();</span><br><span class="line">        earliestRunTimeElapsedMillis = latestRunTimeElapsedMillis - job.getFlexMillis();</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        earliestRunTimeElapsedMillis = job.hasEarlyConstraint() ?</span><br><span class="line">                elapsedNow + job.getMinLatencyMillis() : NO_EARLIEST_RUNTIME;</span><br><span class="line">        latestRunTimeElapsedMillis = job.hasLateConstraint() ?</span><br><span class="line">                elapsedNow + job.getMaxExecutionDelayMillis() : NO_LATEST_RUNTIME;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// 创建对应的 JobStatus 对象！</span></span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">new</span> JobStatus(job, callingUid, sourcePackageName, sourceUserId, tag, <span class="number">0</span>,</span><br><span class="line">            earliestRunTimeElapsedMillis, latestRunTimeElapsedMillis);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>这里通过 JobInfo 创建了对应的 JobStatus 对象，参数传递：<br>job, uId, null, -1, null，0，earliestRunTimeElapsedMillis，latestRunTimeElapsedMillis。<br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">private</span> <span class="title">JobStatus</span><span class="params">(JobInfo job, <span class="keyword">int</span> callingUid, String sourcePackageName,</span></span></span><br><span class="line"><span class="function"><span class="params">        <span class="keyword">int</span> sourceUserId, String tag, <span class="keyword">int</span> numFailures, <span class="keyword">long</span> earliestRunTimeElapsedMillis,</span></span></span><br><span class="line"><span class="function"><span class="params">        <span class="keyword">long</span> latestRunTimeElapsedMillis)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">this</span>.job = job;</span><br><span class="line">    <span class="keyword">this</span>.callingUid = callingUid;</span><br><span class="line">    <span class="keyword">int</span> tempSourceUid = -<span class="number">1</span>;</span><br><span class="line">    <span class="keyword">if</span> (sourceUserId != -<span class="number">1</span> &amp;&amp; sourcePackageName != <span class="keyword">null</span>) &#123;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            tempSourceUid = AppGlobals.getPackageManager().getPackageUid(sourcePackageName, <span class="number">0</span>,</span><br><span class="line">                    sourceUserId);</span><br><span class="line">        &#125; <span class="keyword">catch</span> (RemoteException ex) &#123;</span><br><span class="line">            <span class="comment">// Can't happen, PackageManager runs in the same process.</span></span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (tempSourceUid == -<span class="number">1</span>) &#123;</span><br><span class="line">        <span class="keyword">this</span>.sourceUid = callingUid;</span><br><span class="line">        <span class="keyword">this</span>.sourceUserId = UserHandle.getUserId(callingUid);</span><br><span class="line">        <span class="keyword">this</span>.sourcePackageName = job.getService().getPackageName();</span><br><span class="line">        <span class="keyword">this</span>.sourceTag = <span class="keyword">null</span>;</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        <span class="keyword">this</span>.sourceUid = tempSourceUid;</span><br><span class="line">        <span class="keyword">this</span>.sourceUserId = sourceUserId;</span><br><span class="line">        <span class="keyword">this</span>.sourcePackageName = sourcePackageName;</span><br><span class="line">        <span class="keyword">this</span>.sourceTag = tag;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">this</span>.batteryName = <span class="keyword">this</span>.sourceTag != <span class="keyword">null</span></span><br><span class="line">            ? <span class="keyword">this</span>.sourceTag + <span class="string">":"</span> + job.getService().getPackageName()</span><br><span class="line">            : job.getService().flattenToShortString();</span><br><span class="line">    <span class="keyword">this</span>.tag = <span class="string">"*job*/"</span> + <span class="keyword">this</span>.batteryName;</span><br><span class="line">    <span class="keyword">this</span>.earliestRunTimeElapsedMillis = earliestRunTimeElapsedMillis;</span><br><span class="line">    <span class="keyword">this</span>.latestRunTimeElapsedMillis = latestRunTimeElapsedMillis;</span><br><span class="line">    <span class="keyword">this</span>.numFailures = numFailures;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">int</span> requiredConstraints = <span class="number">0</span>;</span><br><span class="line">    <span class="keyword">if</span> (job.getNetworkType() == JobInfo.NETWORK_TYPE_ANY) &#123;</span><br><span class="line">        requiredConstraints |= CONSTRAINT_CONNECTIVITY;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span> (job.getNetworkType() == JobInfo.NETWORK_TYPE_UNMETERED) &#123;</span><br><span class="line">        requiredConstraints |= CONSTRAINT_UNMETERED;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span> (job.getNetworkType() == JobInfo.NETWORK_TYPE_NOT_ROAMING) &#123;</span><br><span class="line">        requiredConstraints |= CONSTRAINT_NOT_ROAMING;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span> (job.isRequireCharging()) &#123;</span><br><span class="line">        requiredConstraints |= CONSTRAINT_CHARGING;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span> (earliestRunTimeElapsedMillis != NO_EARLIEST_RUNTIME) &#123;</span><br><span class="line">        requiredConstraints |= CONSTRAINT_TIMING_DELAY;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span> (latestRunTimeElapsedMillis != NO_LATEST_RUNTIME) &#123;</span><br><span class="line">        requiredConstraints |= CONSTRAINT_DEADLINE;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span> (job.isRequireDeviceIdle()) &#123;</span><br><span class="line">        requiredConstraints |= CONSTRAINT_IDLE;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span> (job.getTriggerContentUris() != <span class="keyword">null</span>) &#123;</span><br><span class="line">        requiredConstraints |= CONSTRAINT_CONTENT_TRIGGER;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">this</span>.requiredConstraints = requiredConstraints;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>我们后面会详细的开一篇，来讲讲这些参数的，这里先不看！</p>
<h1 id="2-JobStore-countJobsForUid"><a href="#2-JobStore-countJobsForUid" class="headerlink" title="2 JobStore.countJobsForUid"></a>2 JobStore.countJobsForUid</h1><p>这里是统计 uid 对用的应用有多少个任务：<br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">int</span> <span class="title">countJobsForUid</span><span class="params">(<span class="keyword">int</span> uid)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">return</span> mJobSet.countJobsForUid(uid);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>JobStore 有一个集合，用来存放所有的 Job！</p>
<blockquote>
<p>final JobSet mJobSet;</p>
</blockquote>
<p>我们来看看这个 JobSet<br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">static</span> <span class="class"><span class="keyword">class</span> <span class="title">JobSet</span> </span>&#123;</span><br><span class="line">    <span class="comment">// Key is the getUid() originator of the jobs in each sheaf</span></span><br><span class="line">    <span class="comment">// mJobs 的 key 是应用的 uid！</span></span><br><span class="line">    <span class="keyword">private</span> SparseArray&lt;ArraySet&lt;JobStatus&gt;&gt; mJobs;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="title">JobSet</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        mJobs = <span class="keyword">new</span> SparseArray&lt;ArraySet&lt;JobStatus&gt;&gt;();</span><br><span class="line">    &#125;</span><br><span class="line">    ... ... ... ...</span><br><span class="line">    <span class="comment">// We only want to count the jobs that this uid has scheduled on its own</span></span><br><span class="line">    <span class="comment">// behalf, not those that the app has scheduled on someone else's behalf.</span></span><br><span class="line">    <span class="comment">// 统计 uid 对应的应用注册的任务数！</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">int</span> <span class="title">countJobsForUid</span><span class="params">(<span class="keyword">int</span> uid)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">int</span> total = <span class="number">0</span>;</span><br><span class="line">        ArraySet&lt;JobStatus&gt; jobs = mJobs.get(uid);</span><br><span class="line">        <span class="keyword">if</span> (jobs != <span class="keyword">null</span>) &#123;</span><br><span class="line">            <span class="keyword">for</span> (<span class="keyword">int</span> i = jobs.size() - <span class="number">1</span>; i &gt;= <span class="number">0</span>; i--) &#123;</span><br><span class="line">                JobStatus job = jobs.valueAt(i);</span><br><span class="line">                <span class="keyword">if</span> (job.getUid() == job.getSourceUid()) &#123;</span><br><span class="line">                    total++;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> total;</span><br><span class="line">    &#125;</span><br><span class="line">    ... ... ... ...</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>JobSet 有很多的其他方法：getJobsByXXX，add，remove，getXXX，等等的方法，这里我们先不看！</p>
<h1 id="3-JobStore-getJobByUidAndJobId"><a href="#3-JobStore-getJobByUidAndJobId" class="headerlink" title="3 JobStore.getJobByUidAndJobId"></a>3 JobStore.getJobByUidAndJobId</h1><p>接着是根据 uid 和 jobId，来获得一个任务，这里的目的是判断是否之前已经注册过了一个相同的任务：<br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> JobStatus <span class="title">getJobByUidAndJobId</span><span class="params">(<span class="keyword">int</span> uid, <span class="keyword">int</span> jobId)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">return</span> mJobSet.get(uid, jobId);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>还是调用的是 JobSet.get 方法：<br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> JobStatus <span class="title">get</span><span class="params">(<span class="keyword">int</span> uid, <span class="keyword">int</span> jobId)</span> </span>&#123;</span><br><span class="line">    ArraySet&lt;JobStatus&gt; jobs = mJobs.get(uid);</span><br><span class="line">    <span class="keyword">if</span> (jobs != <span class="keyword">null</span>) &#123;</span><br><span class="line">        <span class="keyword">for</span> (<span class="keyword">int</span> i = jobs.size() - <span class="number">1</span>; i &gt;= <span class="number">0</span>; i--) &#123;</span><br><span class="line">            JobStatus job = jobs.valueAt(i);</span><br><span class="line">            <span class="keyword">if</span> (job.getJobId() == jobId) &#123;</span><br><span class="line">                <span class="keyword">return</span> job;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">null</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>这个很简单，不详细说了！</p>
<h1 id="4-JSS-cancelJobImpl"><a href="#4-JSS-cancelJobImpl" class="headerlink" title="4 JSS.cancelJobImpl"></a>4 JSS.cancelJobImpl</h1><p>如果之前已经注册过一个任务了，需要先取消掉之前的任务！<br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">cancelJobImpl</span><span class="params">(JobStatus cancelled, JobStatus incomingJob)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">if</span> (DEBUG) Slog.d(TAG, <span class="string">"CANCEL: "</span> + cancelled.toShortString());</span><br><span class="line">    <span class="comment">// 停止追踪任务!</span></span><br><span class="line">    stopTrackingJob(cancelled, incomingJob, <span class="keyword">true</span> <span class="comment">/* writeBack */</span>);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">synchronized</span> (mLock) &#123;</span><br><span class="line">        </span><br><span class="line">        <span class="comment">// 如果这个任务在等待队列中，移除它。</span></span><br><span class="line">        <span class="keyword">if</span> (mPendingJobs.remove(cancelled)) &#123;</span><br><span class="line">            mJobPackageTracker.noteNonpending(cancelled);</span><br><span class="line">        &#125;</span><br><span class="line">        </span><br><span class="line">        <span class="comment">// 如果正在运行，取消这个任务！</span></span><br><span class="line">        stopJobOnServiceContextLocked(cancelled, JobParameters.REASON_CANCELED);</span><br><span class="line">        </span><br><span class="line">        <span class="comment">// 更新 jss 的状态！</span></span><br><span class="line">        reportActive();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>这里主要做的是：停止对这个任务的监视，同时，将这个任务移除等待队列，如果这个任务正在运行，那么就要取消它，我们一个一个来看！</p>
<h2 id="4-1-JSS-stopTrackingJob"><a href="#4-1-JSS-stopTrackingJob" class="headerlink" title="4.1 JSS.stopTrackingJob"></a>4.1 JSS.stopTrackingJob</h2><p>我们先来看第一个方法，参数传递：</p>
<ul>
<li>JobStatus jobStatus：要被取消的任务；</li>
<li>JobStatus incomingJob：本次要注册的任务；</li>
<li>boolean writeBack：true；</li>
</ul>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">boolean</span> <span class="title">stopTrackingJob</span><span class="params">(JobStatus jobStatus, JobStatus incomingJob,</span></span></span><br><span class="line"><span class="function"><span class="params">        <span class="keyword">boolean</span> writeBack)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">synchronized</span> (mLock) &#123;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 从 JobStore 和 controller 的监控队列中移除这个 job！</span></span><br><span class="line">        <span class="keyword">final</span> <span class="keyword">boolean</span> removed = mJobs.remove(jobStatus, writeBack);</span><br><span class="line">        <span class="keyword">if</span> (removed &amp;&amp; mReadyToRock) &#123;</span><br><span class="line">            <span class="keyword">for</span> (<span class="keyword">int</span> i=<span class="number">0</span>; i&lt;mControllers.size(); i++) &#123;</span><br><span class="line">                StateController controller = mControllers.get(i);</span><br><span class="line">                <span class="comment">// 停止 job 监控！</span></span><br><span class="line">                controller.maybeStopTrackingJobLocked(jobStatus, incomingJob, <span class="keyword">false</span>);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> removed;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>这里的 mJobs 是 JobStore 对象！</p>
<h3 id="4-1-1-JobStore-remove"><a href="#4-1-1-JobStore-remove" class="headerlink" title="4.1.1 JobStore.remove"></a>4.1.1 JobStore.remove</h3><p>我们来看看这个移除操作：<br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">boolean</span> <span class="title">remove</span><span class="params">(JobStatus jobStatus, <span class="keyword">boolean</span> writeBack)</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 先从 mJobSet 中移除要删除的 JobStatus！</span></span><br><span class="line">    <span class="keyword">boolean</span> removed = mJobSet.remove(jobStatus);</span><br><span class="line">    <span class="keyword">if</span> (!removed) &#123;</span><br><span class="line">        <span class="keyword">if</span> (DEBUG) &#123;</span><br><span class="line">            Slog.d(TAG, <span class="string">"Couldn't remove job: didn't exist: "</span> + jobStatus);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">false</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// 如果 writeBack 是 true，并且 jobStatus 是 isPersisted 的，那就要更新 Jobs.xml 文件！</span></span><br><span class="line">    <span class="keyword">if</span> (writeBack &amp;&amp; jobStatus.isPersisted()) &#123;</span><br><span class="line">        maybeWriteStatusToDiskAsync();</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> removed;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>从 JobSet 集合中移除 Job，并且，如果需要写入操作，并且这个 Job 是设备重启后仍然需要保留的，那就要调用 remove 方法，将更新后的 JobSet 写入到 system/job/jobs.xml，因为所有 Persisted 为 true 的 Job ，都是会被写入到这个文件中去的，用于重启恢复！！</p>
<p>我们来看 maybeWriteStatusToDiskAsync 方法：<br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">maybeWriteStatusToDiskAsync</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    mDirtyOperations++;</span><br><span class="line">    <span class="keyword">if</span> (mDirtyOperations &gt;= MAX_OPS_BEFORE_WRITE) &#123;</span><br><span class="line">        <span class="keyword">if</span> (DEBUG) &#123;</span><br><span class="line">            Slog.v(TAG, <span class="string">"Writing jobs to disk."</span>);</span><br><span class="line">        &#125;</span><br><span class="line">        mIoHandler.post(<span class="keyword">new</span> WriteJobsMapToDiskRunnable());</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line">... ... ... ... ... ...</span><br><span class="line"> </span><br><span class="line"><span class="keyword">private</span> <span class="class"><span class="keyword">class</span> <span class="title">WriteJobsMapToDiskRunnable</span> <span class="keyword">implements</span> <span class="title">Runnable</span> </span>&#123;</span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">run</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">final</span> <span class="keyword">long</span> startElapsed = SystemClock.elapsedRealtime();</span><br><span class="line">        <span class="keyword">final</span> List&lt;JobStatus&gt; storeCopy = <span class="keyword">new</span> ArrayList&lt;JobStatus&gt;();</span><br><span class="line">        <span class="keyword">synchronized</span> (mLock) &#123;</span><br><span class="line">            <span class="comment">// Clone the jobs so we can release the lock before writing.</span></span><br><span class="line">            <span class="comment">// 这里是将 mJobSet 拷贝一份到 storeCopy 中。</span></span><br><span class="line">            mJobSet.forEachJob(<span class="keyword">new</span> JobStatusFunctor() &#123;</span><br><span class="line">                <span class="meta">@Override</span></span><br><span class="line">                <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">process</span><span class="params">(JobStatus job)</span> </span>&#123;</span><br><span class="line">                    <span class="keyword">if</span> (job.isPersisted()) &#123;</span><br><span class="line">                        storeCopy.add(<span class="keyword">new</span> JobStatus(job));</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">// 将更新后的拷贝写入 jobs.xml。</span></span><br><span class="line">        writeJobsMapImpl(storeCopy);</span><br><span class="line">        <span class="keyword">if</span> (JobSchedulerService.DEBUG) &#123;</span><br><span class="line">            Slog.v(TAG, <span class="string">"Finished writing, took "</span> + (SystemClock.elapsedRealtime()</span><br><span class="line">                    - startElapsed) + <span class="string">"ms"</span>);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    ... ... ... ... </span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>我们接着看！</p>
<h3 id="4-1-2-SC-maybeStopTrackingJobLocked"><a href="#4-1-2-SC-maybeStopTrackingJobLocked" class="headerlink" title="4.1.2 SC.maybeStopTrackingJobLocked"></a>4.1.2 SC.maybeStopTrackingJobLocked</h3><p>接着，就是遍历控制器集合，让控制器停止对该任务的监视，参数传递：</p>
<ul>
<li>JobStatus jobStatus：要被删除的 Job！</li>
<li>JobStatus incomingJob：同一个 uid，同一个 jobId 的要被注册执行的 Job！</li>
<li>boolean forUpdate：false</li>
</ul>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * Remove task - this will happen if the task is cancelled, completed, etc.</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">abstract</span> <span class="keyword">void</span> <span class="title">maybeStopTrackingJobLocked</span><span class="params">(JobStatus jobStatus, JobStatus incomingJob,</span></span></span><br><span class="line"><span class="function"><span class="params">        <span class="keyword">boolean</span> forUpdate)</span></span>;</span><br></pre></td></tr></table></figure>
<p>StateController 是一个抽象类，具体的实现，我们在 JobSchedulerService 的构造器中有看到：<br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">mControllers.add(ConnectivityController.get(<span class="keyword">this</span>));</span><br><span class="line">mControllers.add(TimeController.get(<span class="keyword">this</span>));</span><br><span class="line">mControllers.add(IdleController.get(<span class="keyword">this</span>));</span><br><span class="line">mControllers.add(BatteryController.get(<span class="keyword">this</span>));</span><br><span class="line">mControllers.add(AppIdleController.get(<span class="keyword">this</span>));</span><br><span class="line">mControllers.add(ContentObserverController.get(<span class="keyword">this</span>));</span><br><span class="line">mControllers.add(DeviceIdleJobsController.get(<span class="keyword">this</span>));</span><br></pre></td></tr></table></figure></p>
<p>这里有很多的控制器：</p>
<h4 id="4-1-2-1-ConnectivityController"><a href="#4-1-2-1-ConnectivityController" class="headerlink" title="4.1.2.1 ConnectivityController"></a>4.1.2.1 ConnectivityController</h4><p>我们先来看看 ConnectivityController 类的方法：<br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">maybeStopTrackingJobLocked</span><span class="params">(JobStatus jobStatus, JobStatus incomingJob,</span></span></span><br><span class="line"><span class="function"><span class="params">        <span class="keyword">boolean</span> forUpdate)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">if</span> (jobStatus.hasConnectivityConstraint() || jobStatus.hasUnmeteredConstraint()</span><br><span class="line">            || jobStatus.hasNotRoamingConstraint()) &#123;</span><br><span class="line">        mTrackedJobs.remove(jobStatus);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>其他控制器的方法很类似的哦！</p>
<h2 id="4-2-JobPackageTracker-noteNonpending"><a href="#4-2-JobPackageTracker-noteNonpending" class="headerlink" title="4.2 JobPackageTracker.noteNonpending"></a>4.2 JobPackageTracker.noteNonpending</h2><p>这个就是这样的<br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">noteNonpending</span><span class="params">(JobStatus job)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">final</span> <span class="keyword">long</span> now = SystemClock.uptimeMillis();</span><br><span class="line">    mCurDataSet.decPending(job.getSourceUid(), job.getSourcePackageName(), now);</span><br><span class="line">    rebatchIfNeeded(now);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>这里我们先不看！</p>
<h2 id="4-3-JSS-stopJobOnServiceContextLocked"><a href="#4-3-JSS-stopJobOnServiceContextLocked" class="headerlink" title="4.3 JSS.stopJobOnServiceContextLocked"></a>4.3 JSS.stopJobOnServiceContextLocked</h2><p>如果 Job 有在运行，那就停止它，参数传递：cancelled, JobParameters.REASON_CANCELED<br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">boolean</span> <span class="title">stopJobOnServiceContextLocked</span><span class="params">(JobStatus job, <span class="keyword">int</span> reason)</span> </span>&#123;</span><br><span class="line">    <span class="comment">// 遍历 mActiveServices 集合；</span></span><br><span class="line">    <span class="keyword">for</span> (<span class="keyword">int</span> i=<span class="number">0</span>; i&lt;mActiveServices.size(); i++) &#123;</span><br><span class="line">        JobServiceContext jsc = mActiveServices.get(i);</span><br><span class="line">        <span class="keyword">final</span> JobStatus executing = jsc.getRunningJob();</span><br><span class="line">        <span class="comment">// 找到匹配的 jobStatus 对象；</span></span><br><span class="line">        <span class="keyword">if</span> (executing != <span class="keyword">null</span> &amp;&amp; executing.matches(job.getUid(), job.getJobId())) &#123;</span><br><span class="line">            jsc.cancelExecutingJob(reason);</span><br><span class="line">            <span class="keyword">return</span> <span class="keyword">true</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">false</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>这里调用了 JobServiceContext 的 cancelExecutingJob 这个方法，取消正在运行中的 job！</p>
<h3 id="4-3-1-JobServiceContext-cancelExecutingJob"><a href="#4-3-1-JobServiceContext-cancelExecutingJob" class="headerlink" title="4.3.1 JobServiceContext.cancelExecutingJob"></a>4.3.1 JobServiceContext.cancelExecutingJob</h3><p>我们进入 JobServiceContext 文件中来看看：<br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/** Called externally when a job that was scheduled for execution should be cancelled. */</span></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">cancelExecutingJob</span><span class="params">(<span class="keyword">int</span> reason)</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 发送一个 MSG_CANCEL 消息给 JobServiceHandler！</span></span><br><span class="line">    mCallbackHandler.obtainMessage(MSG_CANCEL, reason, <span class="number">0</span> <span class="comment">/* unused */</span>).sendToTarget();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>其中：mCallbackHandler = new JobServiceHandler(looper)，这里的 looper 是 system_server 的主线程的 looper，这个在第二篇初始化和启动就可以看到！</p>
<p>这里我们向 JobServiceHandler 发送了一个 MSG_CANCEL 的消息，我们去看看：<br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br></pre></td><td class="code"><pre><span class="line"> <span class="keyword">private</span> <span class="class"><span class="keyword">class</span> <span class="title">JobServiceHandler</span>！ <span class="keyword">extends</span> <span class="title">Handler</span> </span>&#123;</span><br><span class="line">      <span class="meta">@Override</span></span><br><span class="line">      <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">handleMessage</span><span class="params">(Message message)</span> </span>&#123;</span><br><span class="line">          <span class="keyword">switch</span> (message.what) &#123;</span><br><span class="line"></span><br><span class="line">              ... ... ... ...</span><br><span class="line"></span><br><span class="line">              <span class="comment">// 收到 MSG_CANCEL 的消息！</span></span><br><span class="line">              <span class="keyword">case</span> MSG_CANCEL:</span><br><span class="line">                  <span class="comment">// 如果这个 Job，已经完成了，就不处理！</span></span><br><span class="line">                  <span class="keyword">if</span> (mVerb == VERB_FINISHED) &#123;</span><br><span class="line">                      <span class="keyword">if</span> (DEBUG) &#123;</span><br><span class="line">                          Slog.d(TAG, <span class="string">"Trying to process cancel for torn-down context, ignoring."</span>);</span><br><span class="line">                      &#125;</span><br><span class="line">                      <span class="keyword">return</span>;</span><br><span class="line">                  &#125;</span><br><span class="line"></span><br><span class="line">                  <span class="comment">// 保存停止的原因！</span></span><br><span class="line">                  mParams.setStopReason(message.arg1);</span><br><span class="line">                  <span class="keyword">if</span> (message.arg1 == JobParameters.REASON_PREEMPT) &#123;</span><br><span class="line">                      <span class="comment">// 如果原因是因为优先级取代，就用 mPreferredUid 保存被取代的 job 的 uid！</span></span><br><span class="line">                      mPreferredUid = mRunningJob != <span class="keyword">null</span> ? mRunningJob.getUid() :</span><br><span class="line">                              NO_PREFERRED_UID;</span><br><span class="line">                  &#125;</span><br><span class="line">                  </span><br><span class="line">                  <span class="comment">// 执行取消任务～</span></span><br><span class="line">                  handleCancelH();</span><br><span class="line">                  <span class="keyword">break</span>;</span><br><span class="line"></span><br><span class="line">              <span class="keyword">case</span> MSG_TIMEOUT:</span><br><span class="line">                  handleOpTimeoutH();</span><br><span class="line">                  <span class="keyword">break</span>;</span><br><span class="line"></span><br><span class="line">              <span class="keyword">case</span> MSG_SHUTDOWN_EXECUTION:</span><br><span class="line">                  closeAndCleanupJobH(<span class="keyword">true</span> <span class="comment">/* needsReschedule */</span>);</span><br><span class="line">                  <span class="keyword">break</span>;</span><br><span class="line"></span><br><span class="line">              <span class="keyword">default</span>:</span><br><span class="line">                  Slog.e(TAG, <span class="string">"Unrecognised message: "</span> + message);</span><br><span class="line">          &#125;</span><br><span class="line">      &#125;</span><br><span class="line"></span><br><span class="line">  ... ... ... ...</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>我们进入到 handleCancelH 方法中来看看：<br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">handleCancelH</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    <span class="keyword">if</span> (JobSchedulerService.DEBUG) &#123;</span><br><span class="line">        Slog.d(TAG, <span class="string">"Handling cancel for: "</span> + mRunningJob.getJobId() + <span class="string">" "</span></span><br><span class="line">                + VERB_STRINGS[mVerb]);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">switch</span> (mVerb) &#123; <span class="comment">// 判断当前的 job 的状态！</span></span><br><span class="line">        <span class="keyword">case</span> VERB_BINDING:</span><br><span class="line">        <span class="keyword">case</span> VERB_STARTING:</span><br><span class="line">            <span class="comment">// 将变量 mCancelled 置为 true；</span></span><br><span class="line">            mCancelled.set(<span class="keyword">true</span>);</span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line">            </span><br><span class="line">        <span class="keyword">case</span> VERB_EXECUTING:</span><br><span class="line">            <span class="comment">// 如果当前的 job 是正在执行状态，就先判断应用是否调用过 jobFinished 主动结束任务</span></span><br><span class="line">            <span class="comment">// 如果有，就取消这次 cancel！</span></span><br><span class="line">            <span class="keyword">if</span> (hasMessages(MSG_CALLBACK)) &#123;</span><br><span class="line">                <span class="comment">// If the client has called jobFinished, ignore this cancel.</span></span><br><span class="line">                <span class="keyword">return</span>;</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            <span class="comment">// 发送停止的消息！</span></span><br><span class="line">            sendStopMessageH();</span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line">            </span><br><span class="line">        <span class="keyword">case</span> VERB_STOPPING:</span><br><span class="line">            <span class="comment">// Nada.</span></span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line">        <span class="keyword">default</span>:</span><br><span class="line">            Slog.e(TAG, <span class="string">"Cancelling a job without a valid verb: "</span> + mVerb);</span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>mVerb 使用来保存 Job 的状态的，一个 Job 在 JobServiceContext 中会有如下的几种状态：</p>
<pre><code>static final int VERB_BINDING = 0;
static final int VERB_STARTING = 1;
static final int VERB_EXECUTING = 2;
static final int VERB_STOPPING = 3;
static final int VERB_FINISHED = 4;
</code></pre><p>这里我先不看！</p>
<h2 id="4-4-JSS-reportActive"><a href="#4-4-JSS-reportActive" class="headerlink" title="4.4 JSS.reportActive"></a>4.4 JSS.reportActive</h2><p>最后，调用 reportActive 方法，通知 JSS 的状态！<br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">reportActive</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    <span class="comment">// active is true if pending queue contains jobs OR some job is running.</span></span><br><span class="line">    <span class="keyword">boolean</span> active = mPendingJobs.size() &gt; <span class="number">0</span>;</span><br><span class="line">    <span class="keyword">if</span> (mPendingJobs.size() &lt;= <span class="number">0</span>) &#123;</span><br><span class="line">        <span class="keyword">for</span> (<span class="keyword">int</span> i=<span class="number">0</span>; i&lt;mActiveServices.size(); i++) &#123;</span><br><span class="line">            <span class="keyword">final</span> JobServiceContext jsc = mActiveServices.get(i);</span><br><span class="line">            <span class="keyword">final</span> JobStatus job = jsc.getRunningJob();</span><br><span class="line">            <span class="keyword">if</span> (job != <span class="keyword">null</span></span><br><span class="line">                    &amp;&amp; (job.getJob().getFlags() &amp; JobInfo.FLAG_WILL_BE_FOREGROUND) == <span class="number">0</span></span><br><span class="line">                    &amp;&amp; !job.dozeWhitelisted) &#123;</span><br><span class="line">                <span class="comment">// We will report active if we have a job running and it is not an exception</span></span><br><span class="line">                <span class="comment">// due to being in the foreground or whitelisted.</span></span><br><span class="line">                active = <span class="keyword">true</span>;</span><br><span class="line">                <span class="keyword">break</span>;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 当状态发生改变时，通知 DeviceIdleController 当前 JSS 的状态！</span></span><br><span class="line">    <span class="keyword">if</span> (mReportedActive != active) &#123;</span><br><span class="line">        mReportedActive = active;</span><br><span class="line">        <span class="keyword">if</span> (mLocalDeviceIdleController != <span class="keyword">null</span>) &#123;</span><br><span class="line">            mLocalDeviceIdleController.setJobsActive(active);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>这个 reportActive 是将 JSS 的状态通知给 DeviceIdleController，用于 DOZE 模式，这里简单介绍下 DOZE 模式：</p>
<p>当用户在连续的一段时间内没有使用手机，就延缓终端中 APP 后台的CPU和网络活动，以达到减少电量消耗的目的，这时就进入 DOZE 模式，进入 DOZE 模式后的系统有如下约束：</p>
<ul>
<li>暂停网络访问。 </li>
<li>系统忽略所有的 WakeLock。 </li>
<li>标准的 AlarmManager alarms 被延缓到下一个 maintenance window。 <ul>
<li>但使用 AlarmManager 的 setAndAllowWhileIdle、setExactAndAllowWhileIdle 和 setAlarmClock 时，alarms 定义的事件仍会启动，在这些 alarms 启动前，系统会短暂地退出Doze模式。 </li>
</ul>
</li>
<li>系统不再进行 WiFi 扫描。 </li>
<li>系统不允许 sync adapters 运行。 </li>
<li><strong>系统不允许 JobScheduler 运行</strong>。</li>
</ul>
<p>注意到最后一条了吧，这个就是 reportActive 的意义，我们继续看：</p>
<h1 id="5-JSS-startTrackingJob"><a href="#5-JSS-startTrackingJob" class="headerlink" title="5 JSS.startTrackingJob"></a>5 JSS.startTrackingJob</h1><p>接下来，就是开始 track 任务，参数传递：</p>
<ul>
<li>JobStatus jobStatus：本次注册的 job！</li>
<li>JobStatus lastJob：同一个 uid，同一个 jobId，上次注册的已经被取消的任务，可以为 null！</li>
</ul>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">startTrackingJob</span><span class="params">(JobStatus jobStatus, JobStatus lastJob)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">synchronized</span> (mLock) &#123;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 添加到 JobStore 中!</span></span><br><span class="line">        <span class="keyword">final</span> <span class="keyword">boolean</span> update = mJobs.add(jobStatus);</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (mReadyToRock) &#123;</span><br><span class="line">            <span class="comment">// 遍历控制器，执行监控操作！</span></span><br><span class="line">            <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; mControllers.size(); i++) &#123;</span><br><span class="line">                StateController controller = mControllers.get(i);</span><br><span class="line">                </span><br><span class="line">                <span class="keyword">if</span> (update) &#123; <span class="comment">// 发生了相同 uid 和 jobId 的取代操作，先停止对旧的 job 的监控！</span></span><br><span class="line">                    controller.maybeStopTrackingJobLocked(jobStatus, <span class="keyword">null</span>, <span class="keyword">true</span>);</span><br><span class="line">                &#125;</span><br><span class="line">                </span><br><span class="line">                <span class="comment">// 监控新的 jobStatus！</span></span><br><span class="line">                controller.maybeStartTrackingJobLocked(jobStatus, lastJob);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>第一步，可以看到，先将这一次要注册执行的任务，加入到 JobStore 中：</p>
<h2 id="5-1-JobStore-add"><a href="#5-1-JobStore-add" class="headerlink" title="5.1 JobStore.add"></a>5.1 JobStore.add</h2><p>这里是将要好注册执行的 Job 添加到 JobStore 中，这里和上面有些类似：<br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">boolean</span> <span class="title">add</span><span class="params">(JobStatus jobStatus)</span> </span>&#123;</span><br><span class="line">    <span class="comment">// 取代之前已经被添加过相同 uid 和 jobId 的 jobStatus！</span></span><br><span class="line">    <span class="keyword">boolean</span> replaced = mJobSet.remove(jobStatus);</span><br><span class="line">    <span class="comment">// 将新的 job 添加到 JobSets 集合中！</span></span><br><span class="line">    mJobSet.add(jobStatus);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (jobStatus.isPersisted()) &#123; <span class="comment">// 如果是 persist 类型的 job，还需要写到 Job.xml 文件中去！</span></span><br><span class="line">        maybeWriteStatusToDiskAsync();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (DEBUG) &#123;</span><br><span class="line">        Slog.d(TAG, <span class="string">"Added job status to store: "</span> + jobStatus);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> replaced; <span class="comment">// 返回是否有取代发生！</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>返回值表示是否有取代发生，在 add 的过程中，会判断是否有相同 uid 和 jobId 的 jobStatus 存在，如果有，就要取代之前的！</p>
<p>如果这个 Job 是 isPersisted 的，那就需要更新 Jobs.xml 文件！</p>
<h2 id="5-2-SC-maybeStopTrackingJobLocked"><a href="#5-2-SC-maybeStopTrackingJobLocked" class="headerlink" title="5.2 SC.maybeStopTrackingJobLocked"></a>5.2 SC.maybeStopTrackingJobLocked</h2><p>这里先要停止 track 这个任务，参数传递：</p>
<ul>
<li>JobStatus jobStatus：要被注册执行的新的 Job！</li>
<li>JobStatus incomingJob：null</li>
<li>boolean forUpdate：true<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * Remove task - this will happen if the task is cancelled, completed, etc.</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">abstract</span> <span class="keyword">void</span> <span class="title">maybeStopTrackingJobLocked</span><span class="params">(JobStatus jobStatus, JobStatus incomingJob,</span></span></span><br><span class="line"><span class="function"><span class="params">        <span class="keyword">boolean</span> forUpdate)</span></span>;</span><br></pre></td></tr></table></figure>
</li>
</ul>
<p>具体的实现代码是在每个 Controller 中实现的，我们来看一个最简单的 Controller：</p>
<h3 id="5-2-1-ConnectivityController"><a href="#5-2-1-ConnectivityController" class="headerlink" title="5.2.1 ConnectivityController"></a>5.2.1 ConnectivityController</h3><p>代码如下，逻辑很简单：<br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">maybeStopTrackingJobLocked</span><span class="params">(JobStatus jobStatus, JobStatus incomingJob,</span></span></span><br><span class="line"><span class="function"><span class="params">        <span class="keyword">boolean</span> forUpdate)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">if</span> (jobStatus.hasConnectivityConstraint() || jobStatus.hasUnmeteredConstraint()</span><br><span class="line">            || jobStatus.hasNotRoamingConstraint()) &#123;</span><br><span class="line">        <span class="comment">// 从监控列表中移除这个 job！</span></span><br><span class="line">        mTrackedJobs.remove(jobStatus);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>接着看：</p>
<h2 id="5-3-SC-maybeStartTrackingJobLocked"><a href="#5-3-SC-maybeStartTrackingJobLocked" class="headerlink" title="5.3 SC.maybeStartTrackingJobLocked"></a>5.3 SC.maybeStartTrackingJobLocked</h2><p>接着，调用这个方法，来开始 track 任务，方法参数：</p>
<ul>
<li>JobStatus jobStatus：这次要注册的任务</li>
<li>JobStatus lastJob：同一个 uid，同一个 jobId 已经被取消掉的上一个任务，可以为 null！</li>
</ul>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">abstract</span> <span class="keyword">void</span> <span class="title">maybeStartTrackingJobLocked</span><span class="params">(JobStatus jobStatus, JobStatus lastJob)</span></span>;</span><br></pre></td></tr></table></figure>
<p>这里同样是一个抽象接口，具体的实现是子类：</p>
<h3 id="5-3-1-ConnectivityController"><a href="#5-3-1-ConnectivityController" class="headerlink" title="5.3.1 ConnectivityController"></a>5.3.1 ConnectivityController</h3><p>让我们来看看 ConnectivityController 对象的这个方法：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">@Override</span><br><span class="line">public void maybeStartTrackingJobLocked(JobStatus jobStatus, JobStatus lastJob) &#123;</span><br><span class="line">    if (jobStatus.hasConnectivityConstraint() || jobStatus.hasUnmeteredConstraint()</span><br><span class="line">            || jobStatus.hasNotRoamingConstraint()) &#123;</span><br><span class="line">        // 判断当前的 job 约束条件是否满足，如果满足，就可以立即执行！</span><br><span class="line">        updateConstraintsSatisfied(jobStatus);</span><br><span class="line">        // 将这个 Job 添加到 ConnectivityController 的跟踪列表中！</span><br><span class="line">        mTrackedJobs.add(jobStatus);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>首先，判断 Job 是否有设置和 Connectivity 网络相关的属性：</p>
<ul>
<li>jobStatus.hasConnectivityConstraint()</li>
<li>jobStatus.hasUnmeteredConstraint()</li>
<li>jobStatus.hasNotRoamingConstraint()</li>
</ul>
<p>调用了 updateConstraintsSatisfied 方法来判断当前的约束条件是否满足，同时更新 JobStatus 的状态！<br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">boolean</span> <span class="title">updateConstraintsSatisfied</span> <span class="params">(JobStatus jobStatus)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">final</span> <span class="keyword">boolean</span> ignoreBlocked = (jobStatus.getFlags() &amp; JobInfo.FLAG_WILL_BE_FOREGROUND) != <span class="number">0</span>;</span><br><span class="line">    <span class="comment">// 获得当前的网络状态信息：NetworkInfo</span></span><br><span class="line">    <span class="keyword">final</span> NetworkInfo info = mConnManager.getActiveNetworkInfoForUid(jobStatus.getSourceUid(),</span><br><span class="line">            ignoreBlocked);</span><br><span class="line">    <span class="comment">// 判断约束条件是否满足；</span></span><br><span class="line">    <span class="keyword">final</span> <span class="keyword">boolean</span> connected = (info != <span class="keyword">null</span>) &amp;&amp; info.isConnected();</span><br><span class="line">    <span class="keyword">final</span> <span class="keyword">boolean</span> unmetered = connected &amp;&amp; !info.isMetered();</span><br><span class="line">    <span class="keyword">final</span> <span class="keyword">boolean</span> notRoaming = connected &amp;&amp; !info.isRoaming();</span><br><span class="line"></span><br><span class="line">    <span class="keyword">boolean</span> changed = <span class="keyword">false</span>;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// 根据约束条件来更新 JobStatus 的信息！ </span></span><br><span class="line">    changed |= jobStatus.setConnectivityConstraintSatisfied(connected);</span><br><span class="line">    changed |= jobStatus.setUnmeteredConstraintSatisfied(unmetered);</span><br><span class="line">    changed |= jobStatus.setNotRoamingConstraintSatisfied(notRoaming);</span><br><span class="line">    <span class="keyword">return</span> changed;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>返回的 changed 表示：约束条件是否变化！</p>
<p>最后将 jobStatus 加入到指定的 Controller 的监控列表中！</p>
<h1 id="6-JSS-JobHandler-MSG-CHECK-JOB"><a href="#6-JSS-JobHandler-MSG-CHECK-JOB" class="headerlink" title="6 [JSS.JobHandler].MSG_CHECK_JOB"></a>6 [JSS.JobHandler].MSG_CHECK_JOB</h1><p>接着，就是向 JobHandler 发送了 MSG_CHECK_JOB 的消息，我们来看看：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br></pre></td><td class="code"><pre><span class="line">    private class JobHandler extends Handler &#123;</span><br><span class="line">        public JobHandler(Looper looper) &#123;</span><br><span class="line">            super(looper);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        @Override</span><br><span class="line">        public void handleMessage(Message message) &#123;</span><br><span class="line">            synchronized (mLock) &#123;</span><br><span class="line">                if (!mReadyToRock) &#123;</span><br><span class="line">                    return;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            switch (message.what) &#123;</span><br><span class="line">                case MSG_JOB_EXPIRED:</span><br><span class="line">                    ... ... ... ...</span><br><span class="line">                    break;</span><br><span class="line"></span><br><span class="line">                case MSG_CHECK_JOB: // 接收到 MSG_CHECK_JOB 的消息！</span><br><span class="line">                    synchronized (mLock) &#123;</span><br><span class="line">                        if (mReportedActive) &#123; // 为 true，表示 JSS 通知了设备管理器，自己处于活跃状态！</span><br><span class="line">                            // if jobs are currently being run, queue all ready jobs for execution.</span><br><span class="line">                            queueReadyJobsForExecutionLockedH();</span><br><span class="line">                        &#125; else &#123;</span><br><span class="line">                            // Check the list of jobs and run some of them if we feel inclined.</span><br><span class="line">                            maybeQueueReadyJobsForExecutionLockedH();</span><br><span class="line">                        &#125;</span><br><span class="line">                    &#125;</span><br><span class="line">                    break;</span><br><span class="line"></span><br><span class="line">                case MSG_CHECK_JOB_GREEDY:</span><br><span class="line">                    synchronized (mLock) &#123;</span><br><span class="line">                        queueReadyJobsForExecutionLockedH();</span><br><span class="line">                    &#125;</span><br><span class="line">                    break;</span><br><span class="line"></span><br><span class="line">                case MSG_STOP_JOB:</span><br><span class="line">                    cancelJobImpl((JobStatus)message.obj, null);</span><br><span class="line">                    break;</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            // 处理 mPendingJobs 中的任务！</span><br><span class="line">            maybeRunPendingJobsH();</span><br><span class="line"></span><br><span class="line">            // Don&apos;t remove JOB_EXPIRED in case one came along while processing the queue.</span><br><span class="line">            removeMessages(MSG_CHECK_JOB); </span><br><span class="line">        &#125;</span><br><span class="line">        ... ... ... ... ...</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>mReportActive 为 true 的情况：<br>有等待中的 job （mPendingJobs.size 大于 0）或者有正在执行中的 job （JobServiceContext.getRunningJob 不为 null）</p>
<p>接着，收到了 MSG_CHECK_JOB 的消息，开始遍历队列，执行准备好的任务！</p>
<h2 id="6-1-queueReadyJobsForExecutionLockedH"><a href="#6-1-queueReadyJobsForExecutionLockedH" class="headerlink" title="6.1 queueReadyJobsForExecutionLockedH"></a>6.1 queueReadyJobsForExecutionLockedH</h2><p>当 mReport 下面是这个方法的代码：<br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">queueReadyJobsForExecutionLockedH</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    <span class="keyword">if</span> (DEBUG) &#123;</span><br><span class="line">        Slog.d(TAG, <span class="string">"queuing all ready jobs for execution:"</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    noteJobsNonpending(mPendingJobs);</span><br><span class="line">    mPendingJobs.clear();</span><br><span class="line">    mJobs.forEachJob(mReadyQueueFunctor);</span><br><span class="line">    mReadyQueueFunctor.postProcess();</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (DEBUG) &#123;</span><br><span class="line">        <span class="keyword">final</span> <span class="keyword">int</span> queuedJobs = mPendingJobs.size();</span><br><span class="line">        <span class="keyword">if</span> (queuedJobs == <span class="number">0</span>) &#123;</span><br><span class="line">            Slog.d(TAG, <span class="string">"No jobs pending."</span>);</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            Slog.d(TAG, queuedJobs + <span class="string">" jobs queued."</span>);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>这个方法和 maybeQueueReadyJobsForExecutionLockedH 很类似，我们先来看下面的这个方法：</p>
<h2 id="6-2-maybeQueueReadyJobsForExecutionLockedH"><a href="#6-2-maybeQueueReadyJobsForExecutionLockedH" class="headerlink" title="6.2 maybeQueueReadyJobsForExecutionLockedH"></a>6.2 maybeQueueReadyJobsForExecutionLockedH</h2><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">maybeQueueReadyJobsForExecutionLockedH</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    <span class="keyword">if</span> (DEBUG) Slog.d(TAG, <span class="string">"Maybe queuing ready jobs..."</span>);</span><br><span class="line">    noteJobsNonpending(mPendingJobs);</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 先清空 mPendingJobs 集合!</span></span><br><span class="line">    mPendingJobs.clear();</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 将准备好的 Job 加入到 JobHandler 内部的 runnableJobs 集合中。</span></span><br><span class="line">    mJobs.forEachJob(mMaybeQueueFunctor);</span><br><span class="line">    <span class="comment">// 将 runnableJobs 加入到 mPendingJobs 集合中!</span></span><br><span class="line">    mMaybeQueueFunctor.postProcess();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h3 id="6-2-1-mPendingJobs-clear"><a href="#6-2-1-mPendingJobs-clear" class="headerlink" title="6.2.1 mPendingJobs.clear"></a>6.2.1 mPendingJobs.clear</h3><p>首先清除了：mPendingJobs 集合，为这次执行做准备：</p>
<blockquote>
<p>mPendingJobs.clear();</p>
</blockquote>
<p>接着，这里传入了 mMaybeQueueFunctor 对象！<br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">forEachJob</span><span class="params">(JobStatusFunctor functor)</span> </span>&#123;</span><br><span class="line">    mJobSet.forEachJob(functor);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>进入了 JobSet：<br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">forEachJob</span><span class="params">(JobStatusFunctor functor)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">for</span> (<span class="keyword">int</span> uidIndex = mJobs.size() - <span class="number">1</span>; uidIndex &gt;= <span class="number">0</span>; uidIndex--) &#123;</span><br><span class="line">    </span><br><span class="line">        <span class="comment">// 遍历 JobStore 中的所有 job！</span></span><br><span class="line">        ArraySet&lt;JobStatus&gt; jobs = mJobs.valueAt(uidIndex);</span><br><span class="line">        <span class="keyword">for</span> (<span class="keyword">int</span> i = jobs.size() - <span class="number">1</span>; i &gt;= <span class="number">0</span>; i--) &#123;</span><br><span class="line">        </span><br><span class="line">            <span class="comment">// 对每个 uid 的应用程序的 Job，执行下面操作：</span></span><br><span class="line">            functor.process(jobs.valueAt(i));</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>可以看出，这对所有的 Job，都调用了 MaybeReadyJobQueueFunctor 的 process 方法：</p>
<h3 id="6-2-2-MaybeReadyJobQueueFunctor-process"><a href="#6-2-2-MaybeReadyJobQueueFunctor-process" class="headerlink" title="6.2.2 MaybeReadyJobQueueFunctor.process"></a>6.2.2 MaybeReadyJobQueueFunctor.process</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">MaybeReadyJobQueueFunctor</span> <span class="keyword">implements</span> <span class="title">JobStatusFunctor</span> </span>&#123;</span><br><span class="line">    <span class="keyword">int</span> chargingCount;</span><br><span class="line">    <span class="keyword">int</span> idleCount;</span><br><span class="line">    <span class="keyword">int</span> backoffCount;</span><br><span class="line">    <span class="keyword">int</span> connectivityCount;</span><br><span class="line">    <span class="keyword">int</span> contentCount;</span><br><span class="line">    </span><br><span class="line">    List&lt;JobStatus&gt; runnableJobs; <span class="comment">// 符合条件的即将运行的 Job</span></span><br><span class="line">    </span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="title">MaybeReadyJobQueueFunctor</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        reset();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// Functor method invoked for each job via JobStore.forEachJob()</span></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">process</span><span class="params">(JobStatus job)</span> </span>&#123;</span><br><span class="line">    </span><br><span class="line">        <span class="comment">// 判断这个 Job 是否是准备了！</span></span><br><span class="line">        <span class="keyword">if</span> (isReadyToBeExecutedLocked(job)) &#123;</span><br><span class="line">            <span class="keyword">try</span> &#123;</span><br><span class="line">                <span class="keyword">if</span> (ActivityManagerNative.getDefault().getAppStartMode(job.getUid(),</span><br><span class="line">                        job.getJob().getService().getPackageName())</span><br><span class="line">                        == ActivityManager.APP_START_MODE_DISABLED) &#123;</span><br><span class="line">                    Slog.w(TAG, <span class="string">"Aborting job "</span> + job.getUid() + <span class="string">":"</span></span><br><span class="line">                            + job.getJob().toString() + <span class="string">" -- package not allowed to start"</span>);</span><br><span class="line">                    mHandler.obtainMessage(MSG_STOP_JOB, job).sendToTarget();</span><br><span class="line">                    <span class="keyword">return</span>;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125; <span class="keyword">catch</span> (RemoteException e) &#123;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">if</span> (job.getNumFailures() &gt; <span class="number">0</span>) &#123;</span><br><span class="line">                backoffCount++;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">if</span> (job.hasIdleConstraint()) &#123;</span><br><span class="line">                idleCount++;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">if</span> (job.hasConnectivityConstraint() || job.hasUnmeteredConstraint()</span><br><span class="line">                    || job.hasNotRoamingConstraint()) &#123;</span><br><span class="line">                connectivityCount++;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">if</span> (job.hasChargingConstraint()) &#123;</span><br><span class="line">                chargingCount++;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">if</span> (job.hasContentTriggerConstraint()) &#123;</span><br><span class="line">                contentCount++;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">if</span> (runnableJobs == <span class="keyword">null</span>) &#123;</span><br><span class="line">                runnableJobs = <span class="keyword">new</span> ArrayList&lt;&gt;();</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            <span class="comment">// 将满足条件的 Job，先加入到 runnableJobs 集合！</span></span><br><span class="line">            runnableJobs.add(job);</span><br><span class="line">        &#125; <span class="keyword">else</span> <span class="keyword">if</span> (areJobConstraintsNotSatisfiedLocked(job)) &#123;</span><br><span class="line">            stopJobOnServiceContextLocked(job,</span><br><span class="line">                    JobParameters.REASON_CONSTRAINTS_NOT_SATISFIED);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure>
<p>这里调用了 isReadyToBeExecutedLocked 方法来判断，这个 job 是否已经准备好了：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">boolean</span> <span class="title">isReadyToBeExecutedLocked</span><span class="params">(JobStatus job)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">final</span> <span class="keyword">boolean</span> jobReady = job.isReady(); <span class="comment">// job 是否准备好了</span></span><br><span class="line">    <span class="keyword">final</span> <span class="keyword">boolean</span> jobPending = mPendingJobs.contains(job); <span class="comment">// job 是否已经在等待队列中</span></span><br><span class="line">    <span class="keyword">final</span> <span class="keyword">boolean</span> jobActive = isCurrentlyActiveLocked(job); <span class="comment">// job 是否已经在 JobSerivceContext 中运行了！</span></span><br><span class="line">    <span class="keyword">final</span> <span class="keyword">int</span> userId = job.getUserId();</span><br><span class="line">    <span class="keyword">final</span> <span class="keyword">boolean</span> userStarted = ArrayUtils.contains(mStartedUsers, userId); <span class="comment">// job 所在的设备用户是否运行！</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">final</span> <span class="keyword">boolean</span> componentPresent; <span class="comment">// 表示 job 对应的应用程序的 JobService 组件是否存在！</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">        componentPresent = (AppGlobals.getPackageManager().getServiceInfo(</span><br><span class="line">                job.getServiceComponent(), PackageManager.MATCH_DEBUG_TRIAGED_MISSING,</span><br><span class="line">                userId) != <span class="keyword">null</span>);</span><br><span class="line">    &#125; <span class="keyword">catch</span> (RemoteException e) &#123;</span><br><span class="line">        <span class="keyword">throw</span> e.rethrowAsRuntimeException();</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span> (DEBUG) &#123;</span><br><span class="line">        Slog.v(TAG, <span class="string">"isReadyToBeExecutedLocked: "</span> + job.toShortString()</span><br><span class="line">                + <span class="string">" ready="</span> + jobReady + <span class="string">" pending="</span> + jobPending</span><br><span class="line">                + <span class="string">" active="</span> + jobActive + <span class="string">" userStarted="</span> + userStarted</span><br><span class="line">                + <span class="string">" componentPresent="</span> + componentPresent);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> userStarted &amp;&amp; componentPresent &amp;&amp; jobReady &amp;&amp; !jobPending &amp;&amp; !jobActive;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>可以看出，一个准备好的 Job 要满足这些条件：</p>
<ul>
<li>It’s ready.</li>
<li>It’s not pending.  </li>
<li>It’s not already running on a JSC.</li>
<li>The user that requested the job is running.</li>
<li>The component is enabled and runnable.</li>
</ul>
<p>最后，调用 MaybeQueueFunctor.postProcess 方法：</p>
<h3 id="6-2-3-MaybeReadyJobQueueFunctor-postProcess"><a href="#6-2-3-MaybeReadyJobQueueFunctor-postProcess" class="headerlink" title="6.2.3 MaybeReadyJobQueueFunctor.postProcess"></a>6.2.3 MaybeReadyJobQueueFunctor.postProcess</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">postProcess</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// 判断一下条件！</span></span><br><span class="line">    <span class="keyword">if</span> (backoffCount &gt; <span class="number">0</span> ||</span><br><span class="line">            idleCount &gt;= mConstants.MIN_IDLE_COUNT ||</span><br><span class="line">            connectivityCount &gt;= mConstants.MIN_CONNECTIVITY_COUNT ||</span><br><span class="line">            chargingCount &gt;= mConstants.MIN_CHARGING_COUNT ||</span><br><span class="line">            contentCount &gt;= mConstants.MIN_CONTENT_COUNT ||</span><br><span class="line">            (runnableJobs != <span class="keyword">null</span></span><br><span class="line">                    &amp;&amp; runnableJobs.size() &gt;= mConstants.MIN_READY_JOBS_COUNT)) &#123;</span><br><span class="line">        <span class="keyword">if</span> (DEBUG) &#123;</span><br><span class="line">            Slog.d(TAG, <span class="string">"maybeQueueReadyJobsForExecutionLockedH: Running jobs."</span>);</span><br><span class="line">        &#125;</span><br><span class="line">        </span><br><span class="line">        noteJobsPending(runnableJobs);</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 将 runnableJobs 加入到 mPendingJobs 集合中!</span></span><br><span class="line">        mPendingJobs.addAll(runnableJobs);</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        <span class="keyword">if</span> (DEBUG) &#123;</span><br><span class="line">            Slog.d(TAG, <span class="string">"maybeQueueReadyJobsForExecutionLockedH: Not running anything."</span>);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// Be ready for next time</span></span><br><span class="line">    reset();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>该功能:</p>
<ul>
<li>先将 JobStore 的 JobSet 中满足条件的 job 对应的 JobStatus 加入 runnableJobs 队列；</li>
<li>再将 runnableJobs 中满足触发条件的 JobStatus 加入到 mPendingJobs 队列；</li>
</ul>
<h2 id="6-3-maybeRunPendingJobsH"><a href="#6-3-maybeRunPendingJobsH" class="headerlink" title="6.3 maybeRunPendingJobsH"></a>6.3 maybeRunPendingJobsH</h2><p>接着，就是处理 mPendingJobs 中的 Job：<br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">maybeRunPendingJobsH</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    <span class="keyword">synchronized</span> (mLock) &#123;</span><br><span class="line">        <span class="keyword">if</span> (DEBUG) &#123;</span><br><span class="line">            Slog.d(TAG, <span class="string">"pending queue: "</span> + mPendingJobs.size() + <span class="string">" jobs."</span>);</span><br><span class="line">        &#125;</span><br><span class="line">        </span><br><span class="line">        <span class="comment">// 分配 Job 给 JSC!</span></span><br><span class="line">        assignJobsToContextsLocked();</span><br><span class="line">        </span><br><span class="line">        <span class="comment">// 更新 JSS 的状态！</span></span><br><span class="line">        reportActive();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>结合就是调用 JSS 的 assignJobsToContextLocked 方法：</p>
<h3 id="6-3-1-JSS-assignJobsToContextsLocked"><a href="#6-3-1-JSS-assignJobsToContextsLocked" class="headerlink" title="6.3.1 JSS.assignJobsToContextsLocked"></a>6.3.1 JSS.assignJobsToContextsLocked</h3><p>这个方法其实从名字上就可以看出，就是把 Job 分配给 JobServiceContext 方法，我们去那个方法里面看一下：<br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">assignJobsToContextsLocked</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    <span class="keyword">if</span> (DEBUG) &#123;</span><br><span class="line">        Slog.d(TAG, printPendingQueue());</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 根据当前系统的内存级别，设定最大的活跃 Job 数，保存到 mMaxActiveJobs！</span></span><br><span class="line">    <span class="keyword">int</span> memLevel;</span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">        memLevel = ActivityManagerNative.getDefault().getMemoryTrimLevel();</span><br><span class="line">    &#125; <span class="keyword">catch</span> (RemoteException e) &#123;</span><br><span class="line">        memLevel = ProcessStats.ADJ_MEM_FACTOR_NORMAL;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">switch</span> (memLevel) &#123;</span><br><span class="line">        <span class="keyword">case</span> ProcessStats.ADJ_MEM_FACTOR_MODERATE:</span><br><span class="line">            mMaxActiveJobs = mConstants.BG_MODERATE_JOB_COUNT;</span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line">        <span class="keyword">case</span> ProcessStats.ADJ_MEM_FACTOR_LOW:</span><br><span class="line">            mMaxActiveJobs = mConstants.BG_LOW_JOB_COUNT;</span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line">        <span class="keyword">case</span> ProcessStats.ADJ_MEM_FACTOR_CRITICAL:</span><br><span class="line">            mMaxActiveJobs = mConstants.BG_CRITICAL_JOB_COUNT;</span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line">        <span class="keyword">default</span>:</span><br><span class="line">            mMaxActiveJobs = mConstants.BG_NORMAL_JOB_COUNT;</span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    JobStatus[] contextIdToJobMap = mTmpAssignContextIdToJobMap; <span class="comment">// 大小为 16，和 mActiveServices 相对应！</span></span><br><span class="line">    <span class="keyword">boolean</span>[] act = mTmpAssignAct;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">int</span>[] preferredUidForContext = mTmpAssignPreferredUidForContext; <span class="comment">// 大小为 16，和 mActiveServices 相对应！</span></span><br><span class="line">    <span class="keyword">int</span> numActive = <span class="number">0</span>;</span><br><span class="line">    <span class="keyword">int</span> numForeground = <span class="number">0</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; MAX_JOB_CONTEXTS_COUNT; i++) &#123;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 获得每一个 JobSchedulerContext 和其内部运行着的 JobStatus（可为 null）</span></span><br><span class="line">        <span class="keyword">final</span> JobServiceContext js = mActiveServices.get(i);</span><br><span class="line">        <span class="keyword">final</span> JobStatus status = js.getRunningJob();</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 初始化 contextIdToJobMap，里面保存当前运行着的 Job，和空闲的用于增加的 Job 位置!</span></span><br><span class="line">        <span class="comment">// 然后，分别计算活跃 job 和前台 job 的个数！ </span></span><br><span class="line">        <span class="keyword">if</span> ((contextIdToJobMap[i] = status) != <span class="keyword">null</span>) &#123;</span><br><span class="line">            numActive++;</span><br><span class="line">            <span class="keyword">if</span> (status.lastEvaluatedPriority &gt;= JobInfo.PRIORITY_TOP_APP) &#123;</span><br><span class="line">                numForeground++;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        act[i] = <span class="keyword">false</span>;</span><br><span class="line">        <span class="comment">// 如果当前的 JSC 之前有发生过 job 优先级取代，将上一次的被取代的 job 的 uid 保存到 </span></span><br><span class="line">        preferredUidForContext[i] = js.getPreferredUid();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (DEBUG) &#123;</span><br><span class="line">        Slog.d(TAG, printContextIdToJobMap(contextIdToJobMap, <span class="string">"running jobs initial"</span>));</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// 遍历 mPendingJos 任务集合，尽可能为每一个 job 找到合适的 JobSchedulerContext!</span></span><br><span class="line">    <span class="keyword">for</span> (<span class="keyword">int</span> i=<span class="number">0</span>; i&lt;mPendingJobs.size(); i++) &#123;</span><br><span class="line">        JobStatus nextPending = mPendingJobs.get(i);</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 判断当前的 Job 是不是在 contextIdToJobMap 中了，即他是不是已经在运行了!</span></span><br><span class="line">        <span class="keyword">int</span> jobRunningContext = findJobContextIdFromMap(nextPending, contextIdToJobMap);</span><br><span class="line">        <span class="keyword">if</span> (jobRunningContext != -<span class="number">1</span>) &#123;</span><br><span class="line">            <span class="keyword">continue</span>;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 计算 Job 的优先级!</span></span><br><span class="line">        <span class="keyword">final</span> <span class="keyword">int</span> priority = evaluateJobPriorityLocked(nextPending);</span><br><span class="line">        nextPending.lastEvaluatedPriority = priority;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 遍历 contextIdToJobMap</span></span><br><span class="line">        <span class="comment">// 给这个即将被执行的 Job 找一个合适的 context，至少要满足两个中的一个要求：1、可利用；2、优先级最低！</span></span><br><span class="line">        <span class="keyword">int</span> minPriority = Integer.MAX_VALUE;</span><br><span class="line">        <span class="keyword">int</span> minPriorityContextId = -<span class="number">1</span>;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">for</span> (<span class="keyword">int</span> j=<span class="number">0</span>; j &lt; MAX_JOB_CONTEXTS_COUNT; j++) &#123;</span><br><span class="line">            JobStatus job = contextIdToJobMap[j];</span><br><span class="line">            <span class="keyword">int</span> preferredUid = preferredUidForContext[j];</span><br><span class="line">            <span class="keyword">if</span> (job == <span class="keyword">null</span>) &#123; </span><br><span class="line">                <span class="keyword">if</span> ((numActive &lt; mMaxActiveJobs ||</span><br><span class="line">                        (priority &gt;= JobInfo.PRIORITY_TOP_APP &amp;&amp;</span><br><span class="line">                                numForeground &lt; mConstants.FG_JOB_COUNT)) &amp;&amp;</span><br><span class="line">                        (preferredUid == nextPending.getUid() ||</span><br><span class="line">                                preferredUid == JobServiceContext.NO_PREFERRED_UID)) &#123;</span><br><span class="line"></span><br><span class="line">                    <span class="comment">// 如果 context 原有的 job 为空，并且同时满足以下 2 个条件：</span></span><br><span class="line">                    <span class="comment">// 1、当前活跃 job 数小于最大活跃数，或者 job 优先级不低于 PRIORITY_TOP_APP 且前台 job 数小于 mConstants.FG_JOB_COUNT</span></span><br><span class="line">                    <span class="comment">// 2、JobSchedulerContext 中保存的之前被取代的 job 的 uid 等于当前的 job 的 id 或者等于 NO_PREFERRED_UID</span></span><br><span class="line">                    <span class="comment">// 这个 JobSchedulerContext 是合适的，退出循环，处理下一个 job！</span></span><br><span class="line">                    minPriorityContextId = j;</span><br><span class="line">                    <span class="keyword">break</span>;</span><br><span class="line">                &#125;</span><br><span class="line"></span><br><span class="line">                <span class="keyword">continue</span>;</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            <span class="comment">// 如果 context 原有的 job 不为空，且 uid 和即将执行的 job 不一样，那么这个 JobSchedulerContext 不合适!</span></span><br><span class="line">            <span class="keyword">if</span> (job.getUid() != nextPending.getUid()) &#123; </span><br><span class="line">                <span class="keyword">continue</span>;</span><br><span class="line">            &#125;</span><br><span class="line">            </span><br><span class="line">            <span class="comment">// 如果 context 原有的 job 不为空，且 uid 相同，已有 job 优先级大于等于即将执行的 job，那么这个 JobSchedulerContext 不合适!</span></span><br><span class="line">            <span class="keyword">if</span> (evaluateJobPriorityLocked(job) &gt;= nextPending.lastEvaluatedPriority) &#123;</span><br><span class="line">                <span class="keyword">continue</span>;</span><br><span class="line">            &#125;</span><br><span class="line">            </span><br><span class="line">            <span class="comment">// 如果存在 JobSchedulerContext 原有的 job 不为空，且 uid 相同，已有 job 优先级低于即将执行的 job，那么就选择优先级最低的那个！</span></span><br><span class="line">            <span class="keyword">if</span> (minPriority &gt; nextPending.lastEvaluatedPriority) &#123; </span><br><span class="line">                minPriority = nextPending.lastEvaluatedPriority;</span><br><span class="line">                <span class="comment">// 用来存储优先级最低的 JobSchedulerContext 所在的数组下标！</span></span><br><span class="line">                minPriorityContextId = j;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 找到了合适的 JobSchedulerContext 的下标!</span></span><br><span class="line">        <span class="keyword">if</span> (minPriorityContextId != -<span class="number">1</span>) &#123; </span><br><span class="line"></span><br><span class="line">            <span class="comment">// 先将这个要被执行的 Job 放入 contextIdToJobMap 的 minPriorityContextId 位置！</span></span><br><span class="line">            contextIdToJobMap[minPriorityContextId] = nextPending;</span><br><span class="line"></span><br><span class="line">            <span class="comment">// 对应的 act 位置为 true，表示可以运行!</span></span><br><span class="line">            act[minPriorityContextId] = <span class="keyword">true</span>;</span><br><span class="line">            <span class="comment">// 活跃 job 数加 1；</span></span><br><span class="line">            numActive++; </span><br><span class="line">            <span class="keyword">if</span> (priority &gt;= JobInfo.PRIORITY_TOP_APP) &#123;</span><br><span class="line">                <span class="comment">// 如果 job 的权限不低于 PRIORITY_TOP_APP，前台 job 数加 1；</span></span><br><span class="line">                numForeground++;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (DEBUG) &#123;</span><br><span class="line">        Slog.d(TAG, printContextIdToJobMap(contextIdToJobMap, <span class="string">"running jobs final"</span>));</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    mJobPackageTracker.noteConcurrency(numActive, numForeground);</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 执行所有已经分配了 JobSchedulerContext 的 job !</span></span><br><span class="line">    <span class="keyword">for</span> (<span class="keyword">int</span> i=<span class="number">0</span>; i &lt; MAX_JOB_CONTEXTS_COUNT; i++) &#123;</span><br><span class="line">        <span class="keyword">boolean</span> preservePreferredUid = <span class="keyword">false</span>;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (act[i]) &#123; <span class="comment">// art 为 true，表示可运行！</span></span><br><span class="line">            JobStatus js = mActiveServices.get(i).getRunningJob();</span><br><span class="line">            <span class="keyword">if</span> (js != <span class="keyword">null</span>) &#123;</span><br><span class="line">                <span class="keyword">if</span> (DEBUG) &#123;</span><br><span class="line">                    Slog.d(TAG, <span class="string">"preempting job: "</span> + mActiveServices.get(i).getRunningJob());</span><br><span class="line">                &#125;</span><br><span class="line">                </span><br><span class="line">                <span class="comment">// preferredUid will be set to uid of currently running job.</span></span><br><span class="line">                <span class="comment">// 如果这个 context 已经在运行了一个优先级低的 job，那就要取消它！</span></span><br><span class="line">                mActiveServices.get(i).preemptExecutingJob();</span><br><span class="line">                preservePreferredUid = <span class="keyword">true</span>;</span><br><span class="line">            &#125; <span class="keyword">else</span> &#123;</span><br><span class="line"></span><br><span class="line">                <span class="comment">// 从 contextIdToJobMap 中获得即将执行的 Job!</span></span><br><span class="line">                <span class="keyword">final</span> JobStatus pendingJob = contextIdToJobMap[i];</span><br><span class="line">                <span class="keyword">if</span> (DEBUG) &#123;</span><br><span class="line">                    Slog.d(TAG, <span class="string">"About to run job on context "</span></span><br><span class="line">                            + String.valueOf(i) + <span class="string">", job: "</span> + pendingJob);</span><br><span class="line">                &#125;</span><br><span class="line"></span><br><span class="line">                <span class="comment">// 通知控制器!</span></span><br><span class="line">                <span class="keyword">for</span> (<span class="keyword">int</span> ic=<span class="number">0</span>; ic&lt;mControllers.size(); ic++) &#123;</span><br><span class="line">                    mControllers.get(ic).prepareForExecutionLocked(pendingJob);</span><br><span class="line">                &#125;</span><br><span class="line"></span><br><span class="line">                <span class="comment">// 使用对应的 JobServiceContext 来执行 Job</span></span><br><span class="line">                <span class="keyword">if</span> (!mActiveServices.get(i).executeRunnableJob(pendingJob)) &#123;</span><br><span class="line">                    Slog.d(TAG, <span class="string">"Error executing "</span> + pendingJob);</span><br><span class="line">                &#125;</span><br><span class="line"></span><br><span class="line">                <span class="comment">// Job 已经开始执行了，从 mPendingJobs 中移除这个 Job!</span></span><br><span class="line">                <span class="keyword">if</span> (mPendingJobs.remove(pendingJob)) &#123;</span><br><span class="line">                    mJobPackageTracker.noteNonpending(pendingJob);</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 如果 preservePreferredUid 为 false，说明本次执行，没有发生 job 优先级取代</span></span><br><span class="line">        <span class="comment">// 那就要调用 JobServiceContext 的 clearPreferredUid 清除上一次取代（如果有）保存的 uid！</span></span><br><span class="line">        <span class="keyword">if</span> (!preservePreferredUid) &#123; </span><br><span class="line">            mActiveServices.get(i).clearPreferredUid();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>接着我们继续来看：</p>
<h4 id="6-3-1-1-JSS-findJobContextIdFromMap"><a href="#6-3-1-1-JSS-findJobContextIdFromMap" class="headerlink" title="6.3.1.1 JSS.findJobContextIdFromMap"></a>6.3.1.1 JSS.findJobContextIdFromMap</h4><p>这个方法的作用很简单，就是判断 job 是否已经在 map 集合中了！<br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">findJobContextIdFromMap</span><span class="params">(JobStatus jobStatus, JobStatus[] map)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">for</span> (<span class="keyword">int</span> i=<span class="number">0</span>; i&lt;map.length; i++) &#123;</span><br><span class="line">        <span class="comment">// 在 contextIdToJobMap 匹配 JobId 和 uid 相同的一个 job！</span></span><br><span class="line">        <span class="keyword">if</span> (map[i] != <span class="keyword">null</span> &amp;&amp; map[i].matches(jobStatus.getUid(), jobStatus.getJobId())) &#123;</span><br><span class="line">            <span class="keyword">return</span> i;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> -<span class="number">1</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<h4 id="6-3-1-2-JSS-evaluateJobPriorityLocked"><a href="#6-3-1-2-JSS-evaluateJobPriorityLocked" class="headerlink" title="6.3.1.2 JSS.evaluateJobPriorityLocked"></a>6.3.1.2 JSS.evaluateJobPriorityLocked</h4><p>这个方法是为 job 计算优先级：<br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">int</span> <span class="title">adjustJobPriority</span><span class="params">(<span class="keyword">int</span> curPriority, JobStatus job)</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 如果 curPriority 小于 PRIORITY_TOP_APP （40）</span></span><br><span class="line">    <span class="keyword">if</span> (curPriority &lt; JobInfo.PRIORITY_TOP_APP) &#123;</span><br><span class="line">        <span class="comment">// 获得计算因子，根据计算因子，计算优先级！</span></span><br><span class="line">        <span class="keyword">float</span> factor = mJobPackageTracker.getLoadFactor(job);</span><br><span class="line">        <span class="keyword">if</span> (factor &gt;= mConstants.HEAVY_USE_FACTOR) &#123;</span><br><span class="line">            curPriority += JobInfo.PRIORITY_ADJ_ALWAYS_RUNNING;</span><br><span class="line">        &#125; <span class="keyword">else</span> <span class="keyword">if</span> (factor &gt;= mConstants.MODERATE_USE_FACTOR) &#123;</span><br><span class="line">            curPriority += JobInfo.PRIORITY_ADJ_OFTEN_RUNNING;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// 返回 curPriority；</span></span><br><span class="line">    <span class="keyword">return</span> curPriority;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">int</span> <span class="title">evaluateJobPriorityLocked</span><span class="params">(JobStatus job)</span> </span>&#123;</span><br><span class="line">    <span class="comment">// 获得 job 的优先级</span></span><br><span class="line">    <span class="keyword">int</span> priority = job.getPriority();</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 如果 job 的优先级大于等于 PRIORITY_FOREGROUND_APP（30）</span></span><br><span class="line">    <span class="keyword">if</span> (priority &gt;= JobInfo.PRIORITY_FOREGROUND_APP) &#123;</span><br><span class="line">        <span class="comment">// 直接利用 job 的 priority 计算优先级！</span></span><br><span class="line">        <span class="keyword">return</span> adjustJobPriority(priority, job);</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// 如果 job 的优先级小于 PRIORITY_FOREGROUND_APP（30）</span></span><br><span class="line">    <span class="comment">// 就先判断当前的 job 的 uid 是否是前台 uid！</span></span><br><span class="line">    <span class="keyword">int</span> override = mUidPriorityOverride.get(job.getSourceUid(), <span class="number">0</span>);</span><br><span class="line">    <span class="keyword">if</span> (override != <span class="number">0</span>) &#123;</span><br><span class="line">        <span class="comment">// 如果当前 job 的 uid 是前台 uid，那就以这个 uid 对应的优先级计算当前 job 的优先级！</span></span><br><span class="line">        <span class="keyword">return</span> adjustJobPriority(override, job);</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// 直接利用 job 的 priority 计算优先级！</span></span><br><span class="line">    <span class="keyword">return</span> adjustJobPriority(priority, job);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>这里的 mUidPriorityOverride 用来保存当前<strong>所有在前台的 uid，以及 uid 所有的 job 的优先级</strong>，下面是 Jss 中定义的一些优先级：<br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="keyword">int</span> PRIORITY_ADJ_ALWAYS_RUNNING = -<span class="number">80</span>;</span><br><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="keyword">int</span> PRIORITY_ADJ_OFTEN_RUNNING = -<span class="number">40</span>;</span><br><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="keyword">int</span> PRIORITY_DEFAULT = <span class="number">0</span>;</span><br><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="keyword">int</span> PRIORITY_SYNC_EXPEDITED = <span class="number">10</span>;</span><br><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="keyword">int</span> PRIORITY_SYNC_INITIALIZATION = <span class="number">20</span>;</span><br><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="keyword">int</span> PRIORITY_FOREGROUND_APP = <span class="number">30</span>;</span><br><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="keyword">int</span> PRIORITY_TOP_APP = <span class="number">40</span>;</span><br></pre></td></tr></table></figure></p>
<p>值越小，则优先级越高！</p>
<p>接着源码继续分析：</p>
<h4 id="6-3-1-3-JSC-preemptExecutingJob"><a href="#6-3-1-3-JSC-preemptExecutingJob" class="headerlink" title="6.3.1.3 JSC.preemptExecutingJob"></a>6.3.1.3 JSC.preemptExecutingJob</h4><p>这里调用了 JobServiceContext 的 preemptExecutingJob 方法来取消相同 uid 但是优先级更低的任务，之前有说过，如果 Context 已经在执行一个优先级 job，并且这个 job 和即将被执行的 job 属于同一个 uid，那么要取消优先级低的！<br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">preemptExecutingJob</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    Message m = mCallbackHandler.obtainMessage(MSG_CANCEL);</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 参数为 JobParameters.REASON_PREEMPT，表示要取代！</span></span><br><span class="line">    m.arg1 = JobParameters.REASON_PREEMPT;</span><br><span class="line">    m.sendToTarget();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>发送一个 MSG_CANCEL 消息给 JSC 内部的 JobServiceHandler ，附带一个参数，表示原因：JobParameters.REASON_PREEMPT！</p>
<h5 id="JobServiceHandler-MSG-CANCEL"><a href="#JobServiceHandler-MSG-CANCEL" class="headerlink" title="JobServiceHandler.MSG_CANCEL"></a>JobServiceHandler.MSG_CANCEL</h5><p>我们接着来看：<br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">private</span> <span class="class"><span class="keyword">class</span> <span class="title">JobServiceHandler</span> <span class="keyword">extends</span> <span class="title">Handler</span> </span>&#123;</span><br><span class="line">    JobServiceHandler(Looper looper) &#123;</span><br><span class="line">        <span class="keyword">super</span>(looper);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">handleMessage</span><span class="params">(Message message)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">switch</span> (message.what) &#123;</span><br><span class="line">            ... ... ... ...</span><br><span class="line">            <span class="keyword">case</span> MSG_CANCEL:</span><br><span class="line">                <span class="keyword">if</span> (mVerb == VERB_FINISHED) &#123; <span class="comment">// 这个 mVerb 表示的是，这个 Context 的 job 的当前状态!</span></span><br><span class="line">                    <span class="keyword">if</span> (DEBUG) &#123;</span><br><span class="line">                        Slog.d(TAG,</span><br><span class="line">                               <span class="string">"Trying to process cancel for torn-down context, ignoring."</span>);</span><br><span class="line">                    &#125;</span><br><span class="line">                    <span class="keyword">return</span>;</span><br><span class="line">                &#125;</span><br><span class="line">                mParams.setStopReason(message.arg1);</span><br><span class="line">                <span class="keyword">if</span> (message.arg1 == JobParameters.REASON_PREEMPT) &#123;</span><br><span class="line">                    <span class="comment">// 如果是取消的原因是优先级取代，就用 mPreferredUid 保存 uid！</span></span><br><span class="line">                    mPreferredUid = mRunningJob != <span class="keyword">null</span> ? mRunningJob.getUid() :</span><br><span class="line">                            NO_PREFERRED_UID;</span><br><span class="line">                &#125;</span><br><span class="line">                <span class="comment">// 执行取消操作!</span></span><br><span class="line">                handleCancelH();</span><br><span class="line">                <span class="keyword">break</span>;</span><br><span class="line">            <span class="keyword">case</span> MSG_TIMEOUT:</span><br><span class="line">                handleOpTimeoutH();</span><br><span class="line">                <span class="keyword">break</span>;</span><br><span class="line">            <span class="keyword">case</span> MSG_SHUTDOWN_EXECUTION:</span><br><span class="line">                closeAndCleanupJobH(<span class="keyword">true</span> <span class="comment">/* needsReschedule */</span>);</span><br><span class="line">                <span class="keyword">break</span>;</span><br><span class="line">            <span class="keyword">default</span>:</span><br><span class="line">                Slog.e(TAG, <span class="string">"Unrecognised message: "</span> + message);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">   </span><br><span class="line">    ... ... ... ... ... ...</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">handleCancelH</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">if</span> (JobSchedulerService.DEBUG) &#123;</span><br><span class="line">            Slog.d(TAG, <span class="string">"Handling cancel for: "</span> + mRunningJob.getJobId() + <span class="string">" "</span></span><br><span class="line">                    + VERB_STRINGS[mVerb]);</span><br><span class="line">        &#125;</span><br><span class="line">        </span><br><span class="line">        <span class="comment">// 这里因为是取消的是这个 context 里面正在执行的 job，所以 mVerb 的值为 VERB_EXECUTING!</span></span><br><span class="line">        <span class="keyword">switch</span> (mVerb) &#123; </span><br><span class="line">            <span class="keyword">case</span> VERB_BINDING:</span><br><span class="line">            <span class="keyword">case</span> VERB_STARTING:</span><br><span class="line">                mCancelled.set(<span class="keyword">true</span>);</span><br><span class="line">                <span class="keyword">break</span>;</span><br><span class="line">                </span><br><span class="line">            <span class="keyword">case</span> VERB_EXECUTING:</span><br><span class="line">                <span class="comment">// 如果 client 已经调用了 jobFinished 方法结束了 job，那就 return!</span></span><br><span class="line">                <span class="keyword">if</span> (hasMessages(MSG_CALLBACK)) &#123;</span><br><span class="line">                    <span class="comment">// If the client has called jobFinished, ignore this cancel.</span></span><br><span class="line">                    <span class="keyword">return</span>;</span><br><span class="line">                &#125;</span><br><span class="line">                sendStopMessageH(); <span class="comment">// 否则，就发送停止的消息!</span></span><br><span class="line">                <span class="keyword">break</span>;</span><br><span class="line">                </span><br><span class="line">            <span class="keyword">case</span> VERB_STOPPING:</span><br><span class="line">                <span class="comment">// Nada.</span></span><br><span class="line">                <span class="keyword">break</span>;</span><br><span class="line">                </span><br><span class="line">            <span class="keyword">default</span>:</span><br><span class="line">                Slog.e(TAG, <span class="string">"Cancelling a job without a valid verb: "</span> + mVerb);</span><br><span class="line">                <span class="keyword">break</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    ... ... ... ...</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>如果有优先级低的 job 正在运行，那就 stop job，这时 mVerb 会从：VERB_EXECUTING -&gt; VERB_STOPPING.<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line">/**</span><br><span class="line"> * Already running, need to stop. Will switch &#123;@link #mVerb&#125; from VERB_EXECUTING -&gt;</span><br><span class="line"> * VERB_STOPPING.</span><br><span class="line"> */</span><br><span class="line">private void sendStopMessageH() &#123;</span><br><span class="line">    removeOpTimeOut();</span><br><span class="line">    if (mVerb != VERB_EXECUTING) &#123;</span><br><span class="line">        Slog.e(TAG, &quot;Sending onStopJob for a job that isn&apos;t started. &quot; + mRunningJob);</span><br><span class="line">        closeAndCleanupJobH(false /* reschedule */);</span><br><span class="line">        return;</span><br><span class="line">    &#125;</span><br><span class="line">    try &#123;</span><br><span class="line">        // mVerb 状态变为 VERB_STOPPING！</span><br><span class="line">        mVerb = VERB_STOPPING;</span><br><span class="line">        scheduleOpTimeOut();</span><br><span class="line"></span><br><span class="line">        // binder 通信，调用 JobService 的 stopJob 方法</span><br><span class="line">        service.stopJob(mParams); </span><br><span class="line">    &#125; catch (RemoteException e) &#123;</span><br><span class="line">        Slog.e(TAG, &quot;Error sending onStopJob to client.&quot;, e);</span><br><span class="line">        closeAndCleanupJobH(false /* reschedule */);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>这里的 service 是一个 IJobService 对象，本质是一个 Binder 对象，对应着应用程序进程中的 JobService！</p>
<h5 id="JobService-stopJob"><a href="#JobService-stopJob" class="headerlink" title="JobService.stopJob"></a>JobService.stopJob</h5><p>注意：这里对于 Binder 机制来说：应用程序的 JobService 所在进程是 Binder 服务端，JobServiceContext 所在的进程 system_server 是 Binder 客户端！也就是说，应用程序定义的 JobService 是被 JobSerivceContext 来 bind 的，所以，你会发现，你无法 override JobService 的 onbind 方法！<br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">static</span> <span class="keyword">final</span> <span class="class"><span class="keyword">class</span> <span class="title">JobInterface</span> <span class="keyword">extends</span> <span class="title">IJobService</span>.<span class="title">Stub</span> </span>&#123;</span><br><span class="line">    <span class="keyword">final</span> WeakReference&lt;JobService&gt; mService;</span><br><span class="line">    JobInterface(JobService service) &#123;</span><br><span class="line">        mService = <span class="keyword">new</span> WeakReference&lt;&gt;(service);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">startJob</span><span class="params">(JobParameters jobParams)</span> <span class="keyword">throws</span> RemoteException </span>&#123;</span><br><span class="line">        JobService service = mService.get();</span><br><span class="line">        <span class="keyword">if</span> (service != <span class="keyword">null</span>) &#123;</span><br><span class="line">            service.ensureHandler();</span><br><span class="line">            Message m = Message.obtain(service.mHandler, MSG_EXECUTE_JOB, jobParams);</span><br><span class="line">            m.sendToTarget();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">stopJob</span><span class="params">(JobParameters jobParams)</span> <span class="keyword">throws</span> RemoteException </span>&#123; </span><br><span class="line">        <span class="comment">// 通过 binder 机制来来调用指定应用的 JobService 的 stopJob 方法！</span></span><br><span class="line">        JobService service = mService.get();</span><br><span class="line">        <span class="keyword">if</span> (service != <span class="keyword">null</span>) &#123;</span><br><span class="line">            service.ensureHandler();</span><br><span class="line">            <span class="comment">// 发送到 JobService 内部的 JobHandler 对象中！</span></span><br><span class="line">            Message m = Message.obtain(service.mHandler, MSG_STOP_JOB, jobParams);</span><br><span class="line">            m.sendToTarget();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>这里发送了 MSG_STOP_JOB 消息给 JobService.JobHandler，我们去 JobHandler 内部去看看：</p>
<h5 id="JobHandler-MSG-STOP-JOB"><a href="#JobHandler-MSG-STOP-JOB" class="headerlink" title="JobHandler.MSG_STOP_JOB"></a>JobHandler.MSG_STOP_JOB</h5><p>JobHandler 位于应用程序的主线程：<br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">JobHandler</span> <span class="keyword">extends</span> <span class="title">Handler</span> </span>&#123;</span><br><span class="line">    JobHandler(Looper looper) &#123;</span><br><span class="line">        <span class="keyword">super</span>(looper);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">handleMessage</span><span class="params">(Message msg)</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 这里获得传递过来的 JobParameters </span></span><br><span class="line">        <span class="keyword">final</span> JobParameters params = (JobParameters) msg.obj;</span><br><span class="line">        <span class="keyword">switch</span> (msg.what) &#123;</span><br><span class="line"></span><br><span class="line">            ... ... ...</span><br><span class="line"></span><br><span class="line">            <span class="keyword">case</span> MSG_STOP_JOB:</span><br><span class="line">                <span class="keyword">try</span> &#123;</span><br><span class="line"></span><br><span class="line">                    <span class="comment">// 调用 JobService onStopJob 方法，把参数传递过去，这里是不是很熟悉，就不多说!</span></span><br><span class="line">                    <span class="comment">// onStopJob 会返回 true / false， true 表示还会 reschedule 这个 job!</span></span><br><span class="line">                    <span class="keyword">boolean</span> ret = JobService.<span class="keyword">this</span>.onStopJob(params);</span><br><span class="line">                    ackStopMessage(params, ret);</span><br><span class="line">                &#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">                    Log.e(TAG, <span class="string">"Application unable to handle onStopJob."</span>, e);</span><br><span class="line">                    <span class="keyword">throw</span> <span class="keyword">new</span> RuntimeException(e);</span><br><span class="line">                &#125;</span><br><span class="line">                <span class="keyword">break</span>;</span><br><span class="line"></span><br><span class="line">            ... ... ... ...</span><br><span class="line"></span><br><span class="line">            <span class="keyword">default</span>:</span><br><span class="line">                Log.e(TAG, <span class="string">"Unrecognised message received."</span>);</span><br><span class="line">                <span class="keyword">break</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    ... ... ... ... ...</span><br><span class="line">    </span><br><span class="line">    <span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">ackStopMessage</span><span class="params">(JobParameters params, <span class="keyword">boolean</span> reschedule)</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 这里获得了 IJobCallback 对象，这里显示是 Binder 机制，服务端是 JobServiceContext</span></span><br><span class="line">        <span class="keyword">final</span> IJobCallback callback = params.getCallback();</span><br><span class="line">        <span class="keyword">final</span> <span class="keyword">int</span> jobId = params.getJobId();</span><br><span class="line">        <span class="keyword">if</span> (callback != <span class="keyword">null</span>) &#123;</span><br><span class="line">            <span class="keyword">try</span> &#123;</span><br><span class="line"></span><br><span class="line">                <span class="comment">// 发送消息给 JobServiceContext</span></span><br><span class="line">                callback.acknowledgeStopMessage(jobId, reschedule);</span><br><span class="line">            &#125; <span class="keyword">catch</span>(RemoteException e) &#123;</span><br><span class="line">                Log.e(TAG, <span class="string">"System unreachable for stopping job."</span>);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            <span class="keyword">if</span> (Log.isLoggable(TAG, Log.DEBUG)) &#123;</span><br><span class="line">                Log.d(TAG, <span class="string">"Attempting to ack a job that has already been processed."</span>);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>这里的 IJobCallback 又是使用了 Binder 机制，Binder 客户端是应用程序的 JobService 所在进程，Binder 服务端是 JobServiceContext 所在的进程，最后调用的是 JobServiceContext.acknowledgeStopMessage 方法：</p>
<h5 id="JobServiceContext-acknowledgeStopMessage"><a href="#JobServiceContext-acknowledgeStopMessage" class="headerlink" title="JobServiceContext.acknowledgeStopMessage"></a>JobServiceContext.acknowledgeStopMessage</h5><p>通过 Binder 机制，将回调信息发回给 JobServiceContext：<br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">acknowledgeStopMessage</span><span class="params">(<span class="keyword">int</span> jobId, <span class="keyword">boolean</span> reschedule)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">if</span> (!verifyCallingUid()) &#123;</span><br><span class="line">        <span class="keyword">return</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 发送 MSG_CALLBACK 给 JobServiceHandler</span></span><br><span class="line">    mCallbackHandler.obtainMessage(MSG_CALLBACK, jobId, reschedule ? <span class="number">1</span> : <span class="number">0</span>)</span><br><span class="line">            .sendToTarget();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>然后又会发送 MSG_CALLBACK 给 JobServiceContext.JobServiceHandler，这里我们只看关键代码：</p>
<h5 id="JobServiceHandler-MSG-CALLBACK"><a href="#JobServiceHandler-MSG-CALLBACK" class="headerlink" title="JobServiceHandler.MSG_CALLBACK"></a>JobServiceHandler.MSG_CALLBACK</h5><p>JobServiceHandler 同样的也是位于主线程：<br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">case</span> MSG_CALLBACK:</span><br><span class="line">    <span class="keyword">if</span> (DEBUG) &#123;</span><br><span class="line">        Slog.d(TAG, <span class="string">"MSG_CALLBACK of : "</span> + mRunningJob</span><br><span class="line">                + <span class="string">" v:"</span> + VERB_STRINGS[mVerb]);</span><br><span class="line">    &#125;</span><br><span class="line">    removeOpTimeOut();</span><br><span class="line">    <span class="keyword">if</span> (mVerb == VERB_STARTING) &#123;</span><br><span class="line">        <span class="keyword">final</span> <span class="keyword">boolean</span> workOngoing = message.arg2 == <span class="number">1</span>;</span><br><span class="line">        handleStartedH(workOngoing);</span><br><span class="line">        </span><br><span class="line">    &#125; <span class="keyword">else</span> <span class="keyword">if</span> (mVerb == VERB_EXECUTING ||</span><br><span class="line">            mVerb == VERB_STOPPING) &#123; <span class="comment">// 从前面跟代码，可以看出 mVerb 的值为 VERB_STOPPING.</span></span><br><span class="line">        <span class="keyword">final</span> <span class="keyword">boolean</span> reschedule = message.arg2 == <span class="number">1</span>;</span><br><span class="line">        </span><br><span class="line">        handleFinishedH(reschedule);</span><br><span class="line">        </span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        <span class="keyword">if</span> (DEBUG) &#123;</span><br><span class="line">            Slog.d(TAG, <span class="string">"Unrecognised callback: "</span> + mRunningJob);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">break</span>;</span><br></pre></td></tr></table></figure></p>
<p>接着，调用 JobServiceContext 的 handleFinishedH 方法：</p>
<h5 id="JobServiceContext-handleFinishedH"><a href="#JobServiceContext-handleFinishedH" class="headerlink" title="JobServiceContext.handleFinishedH"></a>JobServiceContext.handleFinishedH</h5><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">        <span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">handleFinishedH</span><span class="params">(<span class="keyword">boolean</span> reschedule)</span> </span>&#123;</span><br><span class="line">            <span class="keyword">switch</span> (mVerb) &#123;</span><br><span class="line">                <span class="keyword">case</span> VERB_EXECUTING:</span><br><span class="line">                <span class="keyword">case</span> VERB_STOPPING: <span class="comment">// 进入这个分支！</span></span><br><span class="line">                    closeAndCleanupJobH(reschedule); <span class="comment">// 调用了 closeAndCleanupJobH</span></span><br><span class="line">                    <span class="keyword">break</span>;</span><br><span class="line">、</span><br><span class="line">                <span class="keyword">default</span>:</span><br><span class="line">                    Slog.e(TAG, <span class="string">"Got an execution complete message for a job that wasn't being"</span> +</span><br><span class="line">                            <span class="string">"executed. Was "</span> + VERB_STRINGS[mVerb] + <span class="string">"."</span>);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br></pre></td></tr></table></figure>
<p>接着进入 closeAndCleanupJobH 方法，参数 reschedule 表示是否再次执行这个 job！<br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br></pre></td><td class="code"><pre><span class="line">    <span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">closeAndCleanupJobH</span><span class="params">(<span class="keyword">boolean</span> reschedule)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">final</span> JobStatus completedJob;</span><br><span class="line">        <span class="keyword">synchronized</span> (mLock) &#123;</span><br><span class="line">            <span class="keyword">if</span> (mVerb == VERB_FINISHED) &#123;</span><br><span class="line">                <span class="keyword">return</span>;</span><br><span class="line">            &#125;</span><br><span class="line">            completedJob = mRunningJob;</span><br><span class="line">            mJobPackageTracker.noteInactive(completedJob);</span><br><span class="line">            <span class="keyword">try</span> &#123;</span><br><span class="line">                mBatteryStats.noteJobFinish(mRunningJob.getBatteryName(),</span><br><span class="line">                        mRunningJob.getSourceUid());</span><br><span class="line">            &#125; <span class="keyword">catch</span> (RemoteException e) &#123;</span><br><span class="line">                <span class="comment">// Whatever.</span></span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">if</span> (mWakeLock != <span class="keyword">null</span>) &#123;</span><br><span class="line">                mWakeLock.release();</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            mContext.unbindService(JobServiceContext.<span class="keyword">this</span>); <span class="comment">// 取消绑定 JobService</span></span><br><span class="line">            mWakeLock = <span class="keyword">null</span>;</span><br><span class="line">            mRunningJob = <span class="keyword">null</span>;</span><br><span class="line">            mParams = <span class="keyword">null</span>;</span><br><span class="line">            mVerb = VERB_FINISHED; <span class="comment">// mVerb 状态置为 VERB_FINISHED；</span></span><br><span class="line">            mCancelled.set(<span class="keyword">false</span>);</span><br><span class="line">            service = <span class="keyword">null</span>;</span><br><span class="line">            mAvailable = <span class="keyword">true</span>;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        removeOpTimeOut(); <span class="comment">// 移除已经处理的消息</span></span><br><span class="line">        removeMessages(MSG_CALLBACK);</span><br><span class="line">        removeMessages(MSG_SERVICE_BOUND);</span><br><span class="line">        removeMessages(MSG_CANCEL);</span><br><span class="line">        removeMessages(MSG_SHUTDOWN_EXECUTION);</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 调用了 mCompletedListener 的 onJobCompleted 方法!</span></span><br><span class="line">        mCompletedListener.onJobCompleted(completedJob, reschedule);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>这个方法很简单，就是对当前的 JobSchedulerContext 进行初始化操作，为执行下一个 job 做准备！</p>
<p>这里 mCompletedListener 大家去看 JobServiceContext 的初始化，也就是第二篇，其实就是 JobSchedulerService：</p>
<h5 id="JobSchedulerService-onJobCompleted"><a href="#JobSchedulerService-onJobCompleted" class="headerlink" title="JobSchedulerService.onJobCompleted"></a>JobSchedulerService.onJobCompleted</h5><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onJobCompleted</span><span class="params">(JobStatus jobStatus, <span class="keyword">boolean</span> needsReschedule)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">if</span> (DEBUG) &#123;</span><br><span class="line">        Slog.d(TAG, <span class="string">"Completed "</span> + jobStatus + <span class="string">", reschedule="</span> + needsReschedule);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 停止 track 这个 job，如果是周期性 job 不更新本地的 jobs.xml 文件!</span></span><br><span class="line">    <span class="keyword">if</span> (!stopTrackingJob(jobStatus, <span class="keyword">null</span>, !jobStatus.getJob().isPeriodic())) &#123;</span><br><span class="line">        <span class="keyword">if</span> (DEBUG) &#123;</span><br><span class="line">            Slog.d(TAG, <span class="string">"Could not find job to remove. Was job removed while executing?"</span>);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">// We still want to check for jobs to execute, because this job may have</span></span><br><span class="line">        <span class="comment">// scheduled a new job under the same job id, and now we can run it.</span></span><br><span class="line">        mHandler.obtainMessage(MSG_CHECK_JOB_GREEDY).sendToTarget();</span><br><span class="line">        <span class="keyword">return</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// 重新 schedule 这个 job，注意这时候</span></span><br><span class="line">    <span class="keyword">if</span> (needsReschedule) &#123;</span><br><span class="line">        JobStatus rescheduled = getRescheduleJobForFailure(jobStatus);</span><br><span class="line">        startTrackingJob(rescheduled, jobStatus);</span><br><span class="line"></span><br><span class="line">    &#125; <span class="keyword">else</span> <span class="keyword">if</span> (jobStatus.getJob().isPeriodic()) &#123;</span><br><span class="line">        JobStatus rescheduledPeriodic = getRescheduleJobForPeriodic(jobStatus);</span><br><span class="line">        startTrackingJob(rescheduledPeriodic, jobStatus);</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line">    reportActive();</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 发送 MSG_CHECK_JOB_GREEDY 给 JobSchedulerService.JobHandler</span></span><br><span class="line">    mHandler.obtainMessage(MSG_CHECK_JOB_GREEDY).sendToTarget();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>这里首先调用了 stopTrackingJob 将这个 job 从 JobStore 和 controller 中移除：<br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">boolean</span> <span class="title">stopTrackingJob</span><span class="params">(JobStatus jobStatus, JobStatus incomingJob,</span></span></span><br><span class="line"><span class="function"><span class="params">        <span class="keyword">boolean</span> writeBack)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">synchronized</span> (mLock) &#123;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 从 JobStore 中移除这个 job，如果 writeback 为 true，还要更新本地的 job.xml 文件!</span></span><br><span class="line">        <span class="keyword">final</span> <span class="keyword">boolean</span> removed = mJobs.remove(jobStatus, writeBack);</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (removed &amp;&amp; mReadyToRock) &#123;</span><br><span class="line">            <span class="keyword">for</span> (<span class="keyword">int</span> i=<span class="number">0</span>; i&lt;mControllers.size(); i++) &#123;</span><br><span class="line">                StateController controller = mControllers.get(i);</span><br><span class="line"></span><br><span class="line">                <span class="comment">// 从 Controller 的跟踪队列中移除！</span></span><br><span class="line">                controller.maybeStopTrackingJobLocked(jobStatus, incomingJob, <span class="keyword">false</span>);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> removed;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>最后是发 MSG_CHECK_JOB_GREEDY 给 JobHandler：</p>
<h5 id="JobHandler-MSG-CHECK-JOB-GREEDY"><a href="#JobHandler-MSG-CHECK-JOB-GREEDY" class="headerlink" title="JobHandler.MSG_CHECK_JOB_GREEDY"></a>JobHandler.MSG_CHECK_JOB_GREEDY</h5><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">private</span> <span class="class"><span class="keyword">class</span> <span class="title">JobHandler</span> <span class="keyword">extends</span> <span class="title">Handler</span> </span>&#123;</span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">handleMessage</span><span class="params">(Message message)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">synchronized</span> (mLock) &#123;</span><br><span class="line">            <span class="keyword">if</span> (!mReadyToRock) &#123;</span><br><span class="line">                <span class="keyword">return</span>;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">switch</span> (message.what) &#123;</span><br><span class="line">            ... ... ... ...</span><br><span class="line">            <span class="keyword">case</span> MSG_CHECK_JOB_GREEDY:</span><br><span class="line">                <span class="keyword">synchronized</span> (mLock) &#123;</span><br><span class="line"></span><br><span class="line">                    <span class="comment">// 作用和 maybeQueueReadyJobsForExecutionLockedH 一样的都是更新 mPendingJobs 集合！</span></span><br><span class="line">                    queueReadyJobsForExecutionLockedH();</span><br><span class="line">                &#125;</span><br><span class="line">                <span class="keyword">break</span>;</span><br><span class="line">            ... ... ... ...</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 再次执行 mPendingJobs 中的 job</span></span><br><span class="line">        maybeRunPendingJobsH();</span><br><span class="line">        <span class="comment">// Don't remove JOB_EXPIRED in case one came along while processing the queue.</span></span><br><span class="line">        removeMessages(MSG_CHECK_JOB);</span><br><span class="line">    &#125;</span><br><span class="line">    ... ... ... ...</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>最后继续 maybeRunPendingJobsH，这里又回到了上面的第 6 节了，就不多说了！</p>
<h4 id="6-3-1-4-JSC-prepareForExecutionLocked"><a href="#6-3-1-4-JSC-prepareForExecutionLocked" class="headerlink" title="6.3.1.4 JSC.prepareForExecutionLocked"></a>6.3.1.4 JSC.prepareForExecutionLocked</h4><p>如果不需要优先级取代，取消优先级低的 job，那就直接执行当前的新 job，在执行那个前，调用 prepareForExecutionLocked 做准备工作。</p>
<p>这个方法其实很简单，就是一个抽象类的方法：<br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * Optionally implement logic here to prepare the job to be executed.</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">prepareForExecutionLocked</span><span class="params">(JobStatus jobStatus)</span> </span>&#123;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>表示通知 StateController，做好准备，具体实现是在 Controller 中，我们先看看 ConnectivityController，其他类似：</p>
<h4 id="6-3-1-5-JSC-executeRunnableJob"><a href="#6-3-1-5-JSC-executeRunnableJob" class="headerlink" title="6.3.1.5 JSC.executeRunnableJob"></a>6.3.1.5 JSC.executeRunnableJob</h4><p>这里就是调用 JobSchedulerContext 方法来执行 Job：<br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">boolean</span> <span class="title">executeRunnableJob</span><span class="params">(JobStatus job)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">synchronized</span> (mLock) &#123;</span><br><span class="line">        <span class="keyword">if</span> (!mAvailable) &#123;</span><br><span class="line">            Slog.e(TAG, <span class="string">"Starting new runnable but context is unavailable &gt; Error."</span>);</span><br><span class="line">            <span class="keyword">return</span> <span class="keyword">false</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        </span><br><span class="line">        mPreferredUid = NO_PREFERRED_UID;</span><br><span class="line">        <span class="comment">// 保存到 mRunningJob 中</span></span><br><span class="line">        mRunningJob = job;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">final</span> <span class="keyword">boolean</span> isDeadlineExpired =</span><br><span class="line">                job.hasDeadlineConstraint() &amp;&amp;</span><br><span class="line">                        (job.getLatestRunTimeElapsed() &lt; SystemClock.elapsedRealtime());</span><br><span class="line">                        </span><br><span class="line">        Uri[] triggeredUris = <span class="keyword">null</span>;</span><br><span class="line">        <span class="keyword">if</span> (job.changedUris != <span class="keyword">null</span>) &#123;</span><br><span class="line">            triggeredUris = <span class="keyword">new</span> Uri[job.changedUris.size()];</span><br><span class="line">            job.changedUris.toArray(triggeredUris);</span><br><span class="line">        &#125;</span><br><span class="line">        </span><br><span class="line">        String[] triggeredAuthorities = <span class="keyword">null</span>;</span><br><span class="line">        <span class="keyword">if</span> (job.changedAuthorities != <span class="keyword">null</span>) &#123;</span><br><span class="line">            triggeredAuthorities = <span class="keyword">new</span> String[job.changedAuthorities.size()];</span><br><span class="line">            job.changedAuthorities.toArray(triggeredAuthorities);</span><br><span class="line">        &#125;</span><br><span class="line">        </span><br><span class="line">        <span class="comment">// 创建 job 需要的 JobParamters</span></span><br><span class="line">        mParams = <span class="keyword">new</span> JobParameters(<span class="keyword">this</span>, job.getJobId(), job.getExtras(), isDeadlineExpired,</span><br><span class="line">                triggeredUris, triggeredAuthorities);</span><br><span class="line">                </span><br><span class="line">        mExecutionStartTimeElapsed = SystemClock.elapsedRealtime();</span><br><span class="line">        </span><br><span class="line">        <span class="comment">// mVerb 的值变为 VERB_BINDING!</span></span><br><span class="line">        mVerb = VERB_BINDING;</span><br><span class="line"></span><br><span class="line">        scheduleOpTimeOut();</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 这里很关键，bind 应用程序中注册的 JobService，并返回结果！</span></span><br><span class="line">        <span class="keyword">final</span> Intent intent = <span class="keyword">new</span> Intent().setComponent(job.getServiceComponent());</span><br><span class="line">        <span class="keyword">boolean</span> binding = mContext.bindServiceAsUser(intent, <span class="keyword">this</span>,</span><br><span class="line">                Context.BIND_AUTO_CREATE | Context.BIND_NOT_FOREGROUND,</span><br><span class="line">                <span class="keyword">new</span> UserHandle(job.getUserId()));</span><br><span class="line"> </span><br><span class="line">        <span class="keyword">if</span> (!binding) &#123; <span class="comment">// 如果 bind 失败，异常处理！</span></span><br><span class="line">            <span class="keyword">if</span> (DEBUG) &#123;</span><br><span class="line">                Slog.d(TAG, job.getServiceComponent().getShortClassName() + <span class="string">" unavailable."</span>);</span><br><span class="line">            &#125;</span><br><span class="line">            mRunningJob = <span class="keyword">null</span>;</span><br><span class="line">            mParams = <span class="keyword">null</span>;</span><br><span class="line">            mExecutionStartTimeElapsed = <span class="number">0L</span>;</span><br><span class="line">            mVerb = VERB_FINISHED;</span><br><span class="line">            removeOpTimeOut();</span><br><span class="line">            <span class="keyword">return</span> <span class="keyword">false</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">// 记录信息!</span></span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            mBatteryStats.noteJobStart(job.getBatteryName(), job.getSourceUid());</span><br><span class="line">        &#125; <span class="keyword">catch</span> (RemoteException e) &#123;</span><br><span class="line">            <span class="comment">// Whatever.</span></span><br><span class="line">        &#125;</span><br><span class="line">        mJobPackageTracker.noteActive(job);</span><br><span class="line">        mAvailable = <span class="keyword">false</span>;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">true</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>这便是由 system_server 进程的主线程来执行 bind Service 的方式来拉起的进程，当服务启动后回调到发起端的 onServiceConnected。</p>
<h5 id="6-3-1-5-1-JSC-onServiceConnected"><a href="#6-3-1-5-1-JSC-onServiceConnected" class="headerlink" title="6.3.1.5.1 JSC.onServiceConnected"></a>6.3.1.5.1 JSC.onServiceConnected</h5><p>bind 成功后，JobServiceContext 的 onServiceConnected 方法会执行：<br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onServiceConnected</span><span class="params">(ComponentName name, IBinder service)</span> </span>&#123;</span><br><span class="line">    JobStatus runningJob;</span><br><span class="line">    <span class="keyword">synchronized</span> (mLock) &#123;</span><br><span class="line">        runningJob = mRunningJob;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 异常检测，如果 runningJob 为 null 或者 JobService 组件不匹配，发送 MSG_SHUTDOWN_EXECUTION 终止执行！</span></span><br><span class="line">    <span class="keyword">if</span> (runningJob == <span class="keyword">null</span> || !name.equals(runningJob.getServiceComponent())) &#123;</span><br><span class="line">        mCallbackHandler.obtainMessage(MSG_SHUTDOWN_EXECUTION).sendToTarget();</span><br><span class="line">        <span class="keyword">return</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 获得了应用程序的 JobService 的代理对象！</span></span><br><span class="line">    <span class="keyword">this</span>.service = IJobService.Stub.asInterface(service);</span><br><span class="line">    <span class="comment">// 申请 wakeLock 锁！</span></span><br><span class="line">    <span class="keyword">final</span> PowerManager pm =</span><br><span class="line">            (PowerManager) mContext.getSystemService(Context.POWER_SERVICE);</span><br><span class="line">    PowerManager.WakeLock wl = pm.newWakeLock(PowerManager.PARTIAL_WAKE_LOCK,</span><br><span class="line">            runningJob.getTag());</span><br><span class="line">    wl.setWorkSource(<span class="keyword">new</span> WorkSource(runningJob.getSourceUid()));</span><br><span class="line">    wl.setReferenceCounted(<span class="keyword">false</span>);</span><br><span class="line">    wl.acquire();</span><br><span class="line"></span><br><span class="line">    <span class="keyword">synchronized</span> (mLock) &#123;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (mWakeLock != <span class="keyword">null</span>) &#123;</span><br><span class="line">            Slog.w(TAG, <span class="string">"Bound new job "</span> + runningJob + <span class="string">" but live wakelock "</span> + mWakeLock</span><br><span class="line">                    + <span class="string">" tag="</span> + mWakeLock.getTag());</span><br><span class="line">            mWakeLock.release();</span><br><span class="line">        &#125;</span><br><span class="line">        mWakeLock = wl;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 发送 MSG_SERVICE_BOUND 给 JobServiceHandler 中！</span></span><br><span class="line">    mCallbackHandler.obtainMessage(MSG_SERVICE_BOUND).sendToTarget();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>可以看到，这里会发送消息到 JobServiceHandler 中：</p>
<h5 id="6-3-1-5-2-JSC-JobServiceHandler"><a href="#6-3-1-5-2-JSC-JobServiceHandler" class="headerlink" title="6.3.1.5.2 JSC.JobServiceHandler"></a>6.3.1.5.2 JSC.JobServiceHandler</h5><p>JobServiceHandler 方法也是在主线程中！<br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">private</span> <span class="class"><span class="keyword">class</span> <span class="title">JobServiceHandler</span> <span class="keyword">extends</span> <span class="title">Handler</span> </span>&#123;</span><br><span class="line">    JobServiceHandler(Looper looper) &#123;</span><br><span class="line">        <span class="keyword">super</span>(looper);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">handleMessage</span><span class="params">(Message message)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">switch</span> (message.what) &#123;</span><br><span class="line">            <span class="keyword">case</span> MSG_SERVICE_BOUND: <span class="comment">// 绑定成功！</span></span><br><span class="line">                removeOpTimeOut();</span><br><span class="line">                handleServiceBoundH();</span><br><span class="line">                <span class="keyword">break</span>;</span><br><span class="line"></span><br><span class="line">            ... ... ... ...</span><br><span class="line"></span><br><span class="line">            <span class="keyword">case</span> MSG_SHUTDOWN_EXECUTION: <span class="comment">// 绑定是出现异常的消息！</span></span><br><span class="line">                closeAndCleanupJobH(<span class="keyword">true</span> <span class="comment">/* needsReschedule */</span>);</span><br><span class="line">                <span class="keyword">break</span>;</span><br><span class="line">            <span class="keyword">default</span>:</span><br><span class="line">                Slog.e(TAG, <span class="string">"Unrecognised message: "</span> + message);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"> </span><br><span class="line">    ... ... ... ...</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>接着我们来分别看一下：</p>
<h6 id="6-3-1-5-2-1-JSS-handleServiceBoundH"><a href="#6-3-1-5-2-1-JSS-handleServiceBoundH" class="headerlink" title="6.3.1.5.2.1 JSS.handleServiceBoundH"></a>6.3.1.5.2.1 JSS.handleServiceBoundH</h6><p>收到这个消息后，调用 handleServiceBoundH 方法：<br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/** Start the job on the service. */</span></span><br><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">handleServiceBoundH</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    <span class="keyword">if</span> (DEBUG) &#123;</span><br><span class="line">        Slog.d(TAG, <span class="string">"MSG_SERVICE_BOUND for "</span> + mRunningJob.toShortString());</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span> (mVerb != VERB_BINDING) &#123; <span class="comment">// 状态异常</span></span><br><span class="line">        Slog.e(TAG, <span class="string">"Sending onStartJob for a job that isn't pending. "</span></span><br><span class="line">                + VERB_STRINGS[mVerb]);</span><br><span class="line">        closeAndCleanupJobH(<span class="keyword">false</span> <span class="comment">/* reschedule */</span>);</span><br><span class="line">        <span class="keyword">return</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 如果 mCancelled.get() 为 true，表示 job 被取消了，那就执行舒适化 JSC，并 return！</span></span><br><span class="line">    <span class="keyword">if</span> (mCancelled.get()) &#123; </span><br><span class="line">        <span class="keyword">if</span> (DEBUG) &#123;</span><br><span class="line">            Slog.d(TAG, <span class="string">"Job cancelled while waiting for bind to complete. "</span></span><br><span class="line">                    + mRunningJob);</span><br><span class="line">        &#125;</span><br><span class="line">        closeAndCleanupJobH(<span class="keyword">true</span> <span class="comment">/* reschedule */</span>);</span><br><span class="line">        <span class="keyword">return</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// mVerb 的值设置为 VERB_STARTING！</span></span><br><span class="line">        mVerb = VERB_STARTING;</span><br><span class="line">        scheduleOpTimeOut();</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 这里调用了 JobService 的 startJob 方法</span></span><br><span class="line">        service.startJob(mParams);</span><br><span class="line">    &#125; <span class="keyword">catch</span> (RemoteException e) &#123;</span><br><span class="line">        Slog.e(TAG, <span class="string">"Error sending onStart message to '"</span> +</span><br><span class="line">                mRunningJob.getServiceComponent().getShortClassName() + <span class="string">"' "</span>, e);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>这里就不细看了！</p>
<h1 id="7-总结"><a href="#7-总结" class="headerlink" title="7 总结"></a>7 总结</h1><h2 id="7-1-schedule-流程"><a href="#7-1-schedule-流程" class="headerlink" title="7.1 schedule 流程"></a>7.1 schedule 流程</h2><p>终于跟完了代码。我们来总结一下，整个流程：</p>
<ul>
<li><p>根据传入的 JobInfo，创建 JobStatus；</p>
</li>
<li><p>如果已经注册过一个相同 uid 和 jobId 的 job，就 cancel 之前注册过的 job；</p>
<ul>
<li>停止监控这个 job：<ul>
<li>从 JobStore 和 controller 的监控队列中移除这个 job，并停止 controller 对这个 job 的监控；</li>
</ul>
</li>
<li>如果这个任务在 mPendingJobs 队列中，移除它；</li>
<li>如果正在运行，取消这个任务；</li>
<li>更新 JSS 的状态！</li>
</ul>
</li>
<li><p>将新 job 加入到 JobStore 中，并通知 controller 开始监控新 schedule 的 job！</p>
<ul>
<li>如果 JobStore 中已经存在相同 uid 和 jobId 的 job，就取代这个 job ，并停止对这个旧 job 的监控！</li>
</ul>
</li>
<li><p>发送 MSG_CHECK_JOB 消息给 JobHandler，进行执行 job 前的检查！</p>
<ul>
<li>清空 mPendingJobs，为本次执行做准备，将 JobStore 中所有准备好的 job，加入到 runnableJobs 可执行列表中，再将 runnableJobs 列表中的所有 job 添加到 mPendingJobs 集合中！</li>
<li>给 mPendingJobs 集合中的 job 分配 JobSchedulerContext！</li>
</ul>
</li>
</ul>
<h2 id="7-2-JSC-和-JS-的关系"><a href="#7-2-JSC-和-JS-的关系" class="headerlink" title="7.2 JSC 和 JS 的关系"></a>7.2 JSC 和 JS 的关系</h2><p>先空着，后续补上！</p>
<h2 id="7-3-JSC-的-Job-分配算法"><a href="#7-3-JSC-的-Job-分配算法" class="headerlink" title="7.3 JSC 的 Job 分配算法"></a>7.3 JSC 的 Job 分配算法</h2><p>这里我们来总结一些 job 的分配算法：</p>
</div></article><script data-ad-client="ca-pub-6845729157331145" async src="https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script><div class="post-copyright"><div class="post-copyright__author"><span class="post-copyright-meta">文章作者: </span><span class="post-copyright-info"><a href="mailto:undefined">Coolqi.Li</a></span></div><div class="post-copyright__type"><span class="post-copyright-meta">文章链接: </span><span class="post-copyright-info"><a href="https://lishuaiqi.top/2016/04/18/JobScheduler3-JobSchedulerService-schedule/">https://lishuaiqi.top/2016/04/18/JobScheduler3-JobSchedulerService-schedule/</a></span></div><div class="post-copyright__notice"><span class="post-copyright-meta">版权声明: </span><span class="post-copyright-info">本博客所有文章除特别声明外，均采用 <a href="https://creativecommons.org/licenses/by-nc-sa/4.0/">CC BY-NC-SA 4.0</a> 许可协议。转载请注明来自 <a href="https://lishuaiqi.top">Coolqi`s Blog</a>！</span></div></div><div class="post-meta__tag-list"><a class="post-meta__tags" href="/tags/JobScheduler任务调度/">JobScheduler任务调度</a></div><div class="post-qr-code"><div class="post-qr-code-item"><img class="post-qr-code__img" src="/img/zfb.jpg"><div class="post-qr-code__desc">支付宝打赏</div></div><div class="post-qr-code-item"><img class="post-qr-code__img" src="/img/wechat.jpg"><div class="post-qr-code__desc">微信打赏</div></div></div><div class="social-share pull-right"></div><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/social-share.js@1.0.16/dist/css/share.min.css"><script src="https://cdn.jsdelivr.net/npm/social-share.js@1.0.16/dist/js/social-share.min.js"></script><nav id="pagination"><div class="prev-post pull-left"><a href="/2016/04/21/JobScheduler4-JobSchedulerService-cancel/"><i class="fa fa-chevron-left">  </i><span>JobScheduler第 4 篇 - JobSchedulerService - cancel</span></a></div><div class="next-post pull-right"><a href="/2016/04/13/Process4-thePriorityAndOomAdj/"><span>Process篇 4 - 进程的 priority 和 oomAdj 简析</span><i class="fa fa-chevron-right"></i></a></div></nav></div></div><footer class="footer-bg" style="background-image: url(/img/blog-bg.jpg)"><div class="layout" id="footer"><div class="copyright">&copy;2015 - 2020 By Coolqi.Li</div><div class="framework-info"><span>驱动 - </span><a href="http://hexo.io"><span>Hexo</span></a><span class="footer-separator">|</span><span>主题 - </span><a href="https://github.com/Molunerfinn/hexo-theme-melody"><span>Melody</span></a></div><div class="footer_custom_text">Hi, welcome to my <a href="https://lishuaiqi.top/">blog</a>!</div><div class="busuanzi"><script async src="//busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script><span id="busuanzi_container_page_pv"><i class="fa fa-file-o"></i><span id="busuanzi_value_page_pv"></span><span></span></span></div></div></footer><i class="fa fa-arrow-up" id="go-up" aria-hidden="true"></i><script src="/js/third-party/anime.min.js"></script><script src="/js/third-party/jquery.min.js"></script><script src="/js/third-party/jquery.fancybox.min.js"></script><script src="/js/third-party/velocity.min.js"></script><script src="/js/third-party/velocity.ui.min.js"></script><script src="/js/utils.js?version=1.7.0"></script><script src="/js/fancybox.js?version=1.7.0"></script><script src="/js/sidebar.js?version=1.7.0"></script><script src="/js/copy.js?version=1.7.0"></script><script src="/js/fireworks.js?version=1.7.0"></script><script src="/js/transition.js?version=1.7.0"></script><script src="/js/scroll.js?version=1.7.0"></script><script src="/js/head.js?version=1.7.0"></script><script type="text/x-mathjax-config">MathJax.Hub.Config({
  tex2jax: {
    inlineMath: [ ['$','$'], ["\\(","\\)"]  ],
    processEscapes: true,
    skipTags: ['script', 'noscript', 'style', 'textarea', 'pre', 'code']
  },
  CommonHTML: {
    linebreaks: { automatic: true, width: "90% container" }
  },
  "HTML-CSS": { 
    linebreaks: { automatic: true, width: "90% container" }
  },
  "SVG": { 
    linebreaks: { automatic: true, width: "90% container" }
  }
});
</script><script type="text/x-mathjax-config">MathJax.Hub.Queue(function() {
  var all = MathJax.Hub.getAllJax(), i;
  for (i=0; i < all.length; i += 1) {
    all[i].SourceElement().parentNode.className += ' has-jax';
  }
});
</script><script src="https://cdn.jsdelivr.net/npm/mathjax/MathJax.js?config=TeX-AMS-MML_HTMLorMML"></script><script src="/js/search/local-search.js"></script><script>if(/Android|webOS|iPhone|iPod|iPad|BlackBerry/i.test(navigator.userAgent)) {
  $('#nav').addClass('is-mobile')
  $('footer').addClass('is-mobile')
  $('#top-container').addClass('is-mobile')
}</script><div class="search-dialog" id="local-search"><div class="search-dialog__title" id="local-search-title">本地搜索</div><div id="local-input-panel"><div id="local-search-input"><div class="local-search-box"><input class="local-search-box--input" placeholder="搜索文章"></div></div></div><hr><div id="local-search-results"><div id="local-hits"></div><div id="local-stats"><div class="local-search-stats__hr" id="hr"><span>由</span> <a href="https://github.com/wzpan/hexo-generator-search" style="color:#49B1F5;">hexo-generator-search</a>
 <span>提供支持</span></div></div></div><span class="search-close-button"><i class="fa fa-times"></i></span></div><div class="search-mask"></div></body></html>
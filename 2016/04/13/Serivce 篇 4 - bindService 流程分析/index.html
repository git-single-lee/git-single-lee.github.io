<!DOCTYPE html><html lang="zh-Hans"><head><meta charset="UTF-8"><meta http-equiv="X-UA-Compatible" content="IE=edge"><meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1"><meta name="description" content="Serivce 篇 4 - bindService 流程分析"><meta name="keywords" content="Service服务"><meta name="author" content="Coolqi.Li,undefined"><meta name="copyright" content="Coolqi.Li"><title>Serivce 篇 4 - bindService 流程分析 | Coolqi`s Blog</title><link rel="shortcut icon" href="/img/favicon.ico"><link rel="stylesheet" href="/css/index.css?version=1.5.6"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/font-awesome@4.7.0/css/font-awesome.min.css?version=1.5.6"><link rel="dns-prefetch" href="https://cdn.staticfile.org"><link rel="dns-prefetch" href="https://cdn.bootcss.com"><link rel="dns-prefetch" href="https://creativecommons.org"><script>var GLOBAL_CONFIG = { 
  root: '/',
  algolia: undefined,
  localSearch: {"path":"search.xml","languages":{"hits_empty":"找不到您查询的内容:${query}"}},
  copy: {
    success: '复制成功',
    error: '复制错误',
    noSupport: '浏览器不支持'
  }
} </script></head><body><canvas class="fireworks"></canvas><i class="fa fa-arrow-right" id="toggle-sidebar" aria-hidden="true"></i><div id="sidebar"><div class="toggle-sidebar-info text-center"><span data-toggle="切换文章详情">切换站点概览</span><hr></div><div class="sidebar-toc"><div class="sidebar-toc__title">目录</div><div class="sidebar-toc__progress"><span class="progress-notice">你已经读了</span><span class="progress-num">0</span><span class="progress-percentage">%</span><div class="sidebar-toc__progress-bar"></div></div><div class="sidebar-toc__content"><ol class="toc"><li class="toc-item toc-level-1"><a class="toc-link" href="#0-综述"><span class="toc-text">0 综述</span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#1-绑定者进程"><span class="toc-text">1 绑定者进程</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#1-1-ContextWrapper-bindService"><span class="toc-text">1.1 ContextWrapper.bindService</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#1-2-ContextImpl-bindService"><span class="toc-text">1.2 ContextImpl.bindService</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#1-3-ContextImpl-bindServiceCommon"><span class="toc-text">1.3 ContextImpl.bindServiceCommon</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#1-3-1-LoadedApk-getServiceDispatcher"><span class="toc-text">1.3.1 LoadedApk.getServiceDispatcher</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#1-5-ActivityManagerP-bindService"><span class="toc-text">1.5 ActivityManagerP.bindService</span></a></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#2-系统进程"><span class="toc-text">2 系统进程</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#2-1-ActivityManagerS-bindService"><span class="toc-text">2.1 ActivityManagerS.bindService</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#2-2-ActiveServices-bindServiceLocked"><span class="toc-text">2.2 ActiveServices.bindServiceLocked</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#2-2-1-ActiveServices-retrieveServiceLocked"><span class="toc-text">2.2.1 ActiveServices.retrieveServiceLocked</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#2-2-2-ActiveServices-unscheduleServiceRestartLocked"><span class="toc-text">2.2.2 ActiveServices.unscheduleServiceRestartLocked</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#2-2-3-ServiceRecord-retrieveAppBindingLocked"><span class="toc-text">2.2.3 ServiceRecord.retrieveAppBindingLocked</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#2-3-AServices-bringUpServiceLocked"><span class="toc-text">2.3 AServices.bringUpServiceLocked</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#2-4-ActivityManagerS-attachApplicationLocked"><span class="toc-text">2.4 ActivityManagerS.attachApplicationLocked</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#2-5-ActiveServices-attachApplicationLocked"><span class="toc-text">2.5 ActiveServices.attachApplicationLocked</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#2-6-AS-realStartServiceLocked"><span class="toc-text">2.6 AS.realStartServiceLocked</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#2-6-1-ApplicationThreadP-scheduleCreateService"><span class="toc-text">2.6.1 ApplicationThreadP.scheduleCreateService</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#2-6-2-ActiveServices-requestServiceBindingsLocked"><span class="toc-text">2.6.2 ActiveServices.requestServiceBindingsLocked</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#2-6-2-1-ActiveServices-requestServiceBindingLocked"><span class="toc-text">2.6.2.1 ActiveServices.requestServiceBindingLocked</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#2-6-2-2-ApplicationThreadP-scheduleBindService"><span class="toc-text">2.6.2.2 ApplicationThreadP.scheduleBindService</span></a></li></ol></li></ol></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#3-被绑定者进程"><span class="toc-text">3 被绑定者进程</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#3-1-ApplicationThread-scheduleCreateService"><span class="toc-text">3.1 ApplicationThread.scheduleCreateService</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#3-2-ApplicationThread-scheduleBindService"><span class="toc-text">3.2 ApplicationThread.scheduleBindService</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#3-3-ActivityThread-H"><span class="toc-text">3.3 ActivityThread.H</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#3-3-1-ActivityThread-handleCreateService"><span class="toc-text">3.3.1 ActivityThread.handleCreateService</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#3-3-2-ActivityThread-handleBindService"><span class="toc-text">3.3.2 ActivityThread.handleBindService</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#3-4-ActivityManagerProxy"><span class="toc-text">3.4 ActivityManagerProxy</span></a></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#4-系统进程"><span class="toc-text">4 系统进程</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#4-1-ActivityManagerN-onTransact"><span class="toc-text">4.1 ActivityManagerN.onTransact</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#4-1-1-ActivityManagerS-serviceDoneExecuting"><span class="toc-text">4.1.1 ActivityManagerS.serviceDoneExecuting</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#4-1-2-ActivityManagerS-publishService"><span class="toc-text">4.1.2 ActivityManagerS.publishService</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#4-1-2-1-ActiveServices-publishService"><span class="toc-text">4.1.2.1 ActiveServices.publishService</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#4-1-3-ActivityManagerS-serviceDoneExecutingLocked"><span class="toc-text">4.1.3 ActivityManagerS.serviceDoneExecutingLocked</span></a></li></ol></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#5-绑定者进程"><span class="toc-text">5 绑定者进程</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#5-1-InnerConnection-connected"><span class="toc-text">5.1 InnerConnection.connected</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#5-2-ServiceDispatcher-connected"><span class="toc-text">5.2 ServiceDispatcher.connected</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#5-3-ServiceDispatcher-RunConnection"><span class="toc-text">5.3 ServiceDispatcher.RunConnection</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#5-4-ServiceDispatcher-doConnected"><span class="toc-text">5.4 ServiceDispatcher.doConnected</span></a></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#6-总结"><span class="toc-text">6 总结</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#6-1-数据结构总结"><span class="toc-text">6.1 数据结构总结</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#6-2-binder-通信总结"><span class="toc-text">6.2 binder 通信总结</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#6-3-生命周期总结"><span class="toc-text">6.3 生命周期总结</span></a></li></ol></li></ol></div></div><div class="author-info hide"><div class="author-info__avatar text-center"><img src="/img/avatar.png"></div><div class="author-info__name text-center">Coolqi.Li</div><div class="author-info__description text-center">“你好，我是李帅奇，Android 系统工程师，MineCraft 忠实玩家，设计和绘画爱好者，缺妹纸晚期患者，熬夜星人。”</div><div class="follow-button"><a href="https://github.com/li-coolqi">Follow Me</a></div><hr><div class="author-info-articles"><a class="author-info-articles__archives article-meta" href="/archives"><span class="pull-left">文章</span><span class="pull-right">52</span></a><a class="author-info-articles__tags article-meta" href="/tags"><span class="pull-left">标签</span><span class="pull-right">13</span></a><a class="author-info-articles__categories article-meta" href="/categories"><span class="pull-left">分类</span><span class="pull-right">17</span></a></div><hr><div class="author-info-links"><div class="author-info-links__title text-center">Links</div><a class="author-info-links__name text-center" href="https://molunerfinn.com">Molunerfinn</a><a class="author-info-links__name text-center" href="https://piegg.cn">PiEgg</a><a class="author-info-links__name text-center" href="https://piegg.cn">Elody</a></div></div></div><div id="content-outer"><div class="no-bg" id="top-container"><div id="page-header"><span class="pull-left"> <a id="site-name" href="/">Coolqi`s Blog</a></span><i class="fa fa-bars toggle-menu pull-right" aria-hidden="true"></i><span class="pull-right menus"><a class="site-page social-icon search"><i class="fa fa-search"></i><span> 搜索</span></a><a class="site-page" href="/">Home</a><a class="site-page" href="/archives">Archives</a><a class="site-page" href="/tags">Tags</a><a class="site-page" href="/categories">Categories</a><a class="site-page" href="/about">About</a></span></div><div id="post-info"><div id="post-title">Serivce 篇 4 - bindService 流程分析</div><div id="post-meta"><time class="post-meta__date"><i class="fa fa-calendar" aria-hidden="true"></i> 2016-04-13</time><span class="post-meta__separator">|</span><i class="fa fa-inbox post-meta__icon" aria-hidden="true"></i><a class="post-meta__categories" href="/categories/Service服务/">Service服务</a><div class="post-meta-wordcount"><span>字数总计: </span><span class="word-count">13.3k</span><span class="post-meta__separator">|</span><span>阅读时长: 62 分钟</span></div></div></div></div><div class="layout" id="content-inner"><article id="post"><div class="article-container" id="post-content"><p>本文基于 Android 7.1.1 源码分析，转载请说明出处！</p>
<h1 id="0-综述"><a href="#0-综述" class="headerlink" title="0 综述"></a>0 综述</h1><p>我们在应用中经常会启动 Service：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">context.bindService(intent, mConnection, Service.BIND_AUTO_CREATE);</span><br></pre></td></tr></table></figure>
<p>以前我们只是会调用，但是其底层的调用到底是什么样的呢？知其然知其所以然，今天我们就来学习下 bindService 的过程！</p>
<p>如果之前并不了解这块逻辑的话，那该如何去学习呢？ follow the funtion path！</p>
<h1 id="1-绑定者进程"><a href="#1-绑定者进程" class="headerlink" title="1 绑定者进程"></a>1 绑定者进程</h1><h2 id="1-1-ContextWrapper-bindService"><a href="#1-1-ContextWrapper-bindService" class="headerlink" title="1.1 ContextWrapper.bindService"></a>1.1 ContextWrapper.bindService</h2><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">ContextWrapper</span> <span class="keyword">extends</span> <span class="title">Context</span> </span>&#123;</span><br><span class="line">    Context mBase;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="title">ContextWrapper</span><span class="params">(Context base)</span> </span>&#123;</span><br><span class="line">        mBase = base;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">boolean</span> <span class="title">bindService</span><span class="params">(Intent service, ServiceConnection conn,</span></span></span><br><span class="line"><span class="function"><span class="params">            <span class="keyword">int</span> flags)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> mBase.bindService(service, conn, flags);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/** <span class="doctag">@hide</span> */</span></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">boolean</span> <span class="title">bindServiceAsUser</span><span class="params">(Intent service, ServiceConnection conn, <span class="keyword">int</span> flags,</span></span></span><br><span class="line"><span class="function"><span class="params">            UserHandle user)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> mBase.bindServiceAsUser(service, conn, flags, user);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>ContextWrapper 提供了两个方法来绑定 Service，其中一个是隐藏方法：bindServiceAsUser！</p>
<p>bindService 的第三个参数 flags 一般都会传 0 或 BIND_AUTO_CREATE，<strong>跨进程调用 bindService 会引起组件间的依赖</strong>，比如 A 进程的 Activity 中 bindService 调用 B 进程 service，则 B 进程的 service 的 oom_adj 值依赖于 A 进程 Activity 的 oom_adj 值，这个我们后面在说，这些 flags 也可以通过按位或的方式，进行搭配使用！！</p>
<p>接着来说 flags，这里的 flags 可以取值如下，Android 7.1.1 内置了如下的几个标志位：</p>
<table>
<thead>
<tr>
<th>标志位</th>
<th>解释</th>
</tr>
</thead>
<tbody>
<tr>
<td><strong>0</strong></td>
<td>无意义</td>
</tr>
<tr>
<td><strong>BIND_AUTO_CREATE</strong> (0x0001)</td>
<td>绑定服务时候，如果服务尚未创建，服务会自动创建，在 API LEVEL 14 以前的版本不支持这个标志，使用 Context.BIND_WAIVE_PRIORITY 可以达到同样效果</td>
</tr>
<tr>
<td><strong>BIND_DEBUG_UNBIND</strong> (0x0002)</td>
<td>通常用于 Debug，在 unbindService 时候，会将服务信息保存并打印出来，这个标记很容易造成内存泄漏，应该准备用于 debugging</td>
</tr>
<tr>
<td><strong>BIND_NOT_FOREGROUND</strong> (0x0002)</td>
<td>表示不允许绑定操作将服务所在进程的优先级提升到前台进程优先级</td>
</tr>
<tr>
<td><strong>BIND_ABOVE_CLIENT</strong> (0x0008)</td>
<td>设置服务的进程优先级高于客户端的优先级，只有当需要服务晚于客户端被销毁这种情况才这样设置。</td>
</tr>
<tr>
<td><strong>BIND_ALLOW_OOM_MANAGEMENT</strong> (0x0010)</td>
<td>保持服务受默认的服务管理器管理，当内存不足时候，会销毁服务</td>
</tr>
<tr>
<td><strong>BIND_WAIVE_PRIORITY</strong> (0x0020)</td>
<td>绑定操作不会影响到服务所在进程的优先级</td>
</tr>
<tr>
<td><strong>BIND_IMPORTANT</strong> (0x0040)</td>
<td>标识服务对客户端是非常重要的，会将服务提升至前台进程优先级，通常情况下，即时客户端是前台优先级，服务最多也只能被提升至可见进程优先级</td>
</tr>
<tr>
<td><strong>BIND_ADJUST_WITH_ACTIVITY</strong> (0x0080)</td>
<td>如果绑定来自 Activity，服务优先级的提高取决于Activity的进程优先级，使用这个标识后，会无视其他标识</td>
</tr>
<tr>
<td><strong>BIND_ALLOW_WHITELIST_MANAGEMENT</strong> (0x01000000)</td>
<td></td>
</tr>
<tr>
<td><strong>BIND_FOREGROUND_SERVICE_WHILE_AWAKE</strong> (0x02000000)</td>
<td></td>
</tr>
<tr>
<td><strong>BIND_FOREGROUND_SERVICE</strong> (0x04000000)</td>
<td></td>
</tr>
<tr>
<td><strong>BIND_TREAT_LIKE_ACTIVITY</strong> (0x08000000)</td>
<td></td>
</tr>
<tr>
<td><strong>BIND_VISIBLE</strong> (0x10000000)</td>
<td></td>
</tr>
<tr>
<td><strong>BIND_SHOWING_UI</strong> (0x20000000)</td>
<td>这种绑定方式会让目标服务所在进程显示出 UI 界面，当 UI 界面退出后会触发 UI_HIDDEN 类型的内存回收操作</td>
</tr>
<tr>
<td><strong>BIND_NOT_VISIBLE</strong> (0x40000000)</td>
<td></td>
</tr>
<tr>
<td><strong>BIND_EXTERNAL_SERVICE</strong> (0x80000000)</td>
<td><strong>1、</strong>通过这种方式绑定的服务是属于隔离的外部服务，服务将会被绑定到调用者应用的包内，而不是服务所在的应用包内！<br><strong>2、</strong>使用这个标签进行绑定，服务的代码将会在调用者应用的包名和 uid 下执行！因为服务所在的进程是一个隔离进程，隔离进程是不能直接访问应用程序的数据的！</td>
</tr>
</tbody>
</table>
<p>具体标志位对于 Service 进程有什么影响，请看进程的优先级调度！！！</p>
<p>这里有一点，对于 BIND_AUTO_CREATE，如果服务没有被创建，会自动创建，而对于其他的 flags，是不会自动创建服务的！所以说我们从 Service 的生命周期的角度来说，可以把这些 flags 分为两大类，自动创建和非自动创建类！！</p>
<p>mBase 是 ContextImpl 对象，继续看！</p>
<h2 id="1-2-ContextImpl-bindService"><a href="#1-2-ContextImpl-bindService" class="headerlink" title="1.2 ContextImpl.bindService"></a>1.2 ContextImpl.bindService</h2><p>mMainThread 是应用进程主线程的 Handler！<br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">ContextImpl</span> <span class="keyword">extends</span> <span class="title">Context</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">boolean</span> <span class="title">bindService</span><span class="params">(Intent service, ServiceConnection conn,</span></span></span><br><span class="line"><span class="function"><span class="params">            <span class="keyword">int</span> flags)</span> </span>&#123;</span><br><span class="line">        warnIfCallingFromSystemProcess();</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> bindServiceCommon(service, conn, flags, mMainThread.getHandler(),</span><br><span class="line">                Process.myUserHandle());</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/** <span class="doctag">@hide</span> */</span></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">boolean</span> <span class="title">bindServiceAsUser</span><span class="params">(Intent service, ServiceConnection conn, <span class="keyword">int</span> flags,</span></span></span><br><span class="line"><span class="function"><span class="params">            UserHandle user)</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> bindServiceCommon(service, conn, flags, mMainThread.getHandler(), user);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/** <span class="doctag">@hide</span> */</span></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">boolean</span> <span class="title">bindServiceAsUser</span><span class="params">(Intent service, ServiceConnection conn, <span class="keyword">int</span> flags,</span></span></span><br><span class="line"><span class="function"><span class="params">            Handler handler, UserHandle user)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">if</span> (handler == <span class="keyword">null</span>) &#123;</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> IllegalArgumentException(<span class="string">"handler must not be null."</span>);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> bindServiceCommon(service, conn, flags, handler, user);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>ContextImpl 和 ContextWrapper 的具体关系，请来看另一博文：Android 系统的 Context 分析，这里我们不再详细说明！</p>
<p>mUser：表示的是当前的设备 user！</p>
<p>最终，调用了 bindServiceCommon 方法；</p>
<h2 id="1-3-ContextImpl-bindServiceCommon"><a href="#1-3-ContextImpl-bindServiceCommon" class="headerlink" title="1.3 ContextImpl.bindServiceCommon"></a>1.3 ContextImpl.bindServiceCommon</h2><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">boolean</span> <span class="title">bindServiceCommon</span><span class="params">(Intent service, ServiceConnection conn, <span class="keyword">int</span> flags, Handler</span></span></span><br><span class="line"><span class="function"><span class="params">        handler, UserHandle user)</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    IServiceConnection sd;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (conn == <span class="keyword">null</span>) &#123;</span><br><span class="line">        <span class="keyword">throw</span> <span class="keyword">new</span> IllegalArgumentException(<span class="string">"connection is null"</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span> (mPackageInfo != <span class="keyword">null</span>) &#123;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 获得本次连接的 InnerConnection 对象！</span></span><br><span class="line">        sd = mPackageInfo.getServiceDispatcher(conn, getOuterContext(), handler, flags);</span><br><span class="line"></span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        <span class="keyword">throw</span> <span class="keyword">new</span> RuntimeException(<span class="string">"Not supported in system context"</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    validateServiceIntent(service);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 获得 ActivityClientRecord 对象！</span></span><br><span class="line">        IBinder token = getActivityToken();</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 这里的意思是对于 Android 版本小于 android.os.Build.VERSION_CODES.ICE_CREAM_SANDWICH</span></span><br><span class="line">        <span class="comment">// BIND_AUTO_CREATE 是不使用的，用 BIND_WAIVE_PRIORITY替换！</span></span><br><span class="line">        <span class="keyword">if</span> (token == <span class="keyword">null</span> &amp;&amp; (flags&amp;BIND_AUTO_CREATE) == <span class="number">0</span> &amp;&amp; mPackageInfo != <span class="keyword">null</span></span><br><span class="line">                &amp;&amp; mPackageInfo.getApplicationInfo().targetSdkVersion</span><br><span class="line">                &lt; android.os.Build.VERSION_CODES.ICE_CREAM_SANDWICH) &#123;</span><br><span class="line"></span><br><span class="line">            flags |= BIND_WAIVE_PRIORITY;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        service.prepareToLeaveProcess(<span class="keyword">this</span>);</span><br><span class="line">        </span><br><span class="line">        <span class="comment">// bind 通信，进入 ActivityManagerService！</span></span><br><span class="line">        <span class="keyword">int</span> res = ActivityManagerNative.getDefault().bindService(</span><br><span class="line">            mMainThread.getApplicationThread(), getActivityToken(), service,</span><br><span class="line">            service.resolveTypeIfNeeded(getContentResolver()),</span><br><span class="line">            sd, flags, getOpPackageName(), user.getIdentifier());</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (res &lt; <span class="number">0</span>) &#123;</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> SecurityException(</span><br><span class="line">                    <span class="string">"Not allowed to bind to service "</span> + service);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> res != <span class="number">0</span>;</span><br><span class="line"></span><br><span class="line">    &#125; <span class="keyword">catch</span> (RemoteException e) &#123;</span><br><span class="line">        <span class="keyword">throw</span> e.rethrowFromSystemServer();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>getActivityToken 方法获得的是 ActivityClientRecord 对象，具体为什么是它，请去看 startActivity 相关的博文！！</p>
<h3 id="1-3-1-LoadedApk-getServiceDispatcher"><a href="#1-3-1-LoadedApk-getServiceDispatcher" class="headerlink" title="1.3.1 LoadedApk.getServiceDispatcher"></a>1.3.1 LoadedApk.getServiceDispatcher</h3><p>mPackageInfo 是 LoadedApk 类的实例，每一个进程都会有一个，这里调用了 LoadedApk 的 getServiceDispatcher 方法来获得一个 IServiceConnection 类型的对象，这里我们只需要知道，ServiceConnection 是应用进程中的创建的连接对象，ServiceDispatcher 用来托管 ServiceConnection 对象和 ServiceDispatcher.InnerConnection 对象的映射关系，InnerConnection 能够进行 binder 通信！！</p>
<p>这里会涉及一个集合：<br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">private</span> <span class="keyword">final</span> ArrayMap&lt;Context, ArrayMap&lt;ServiceConnection, LoadedApk.ServiceDispatcher&gt;&gt; mServices</span><br><span class="line">    = <span class="keyword">new</span> ArrayMap&lt;Context, ArrayMap&lt;ServiceConnection, LoadedApk.ServiceDispatcher&gt;&gt;();</span><br></pre></td></tr></table></figure></p>
<p>这个是 LoadedApk 的内部实例集合，每一个进程在创建后，都会有一个 LoadedApk 对象， mServices 集合的 key 值为 Context 对象，表示上下文运行环境，大家可以理解为特定的组件，value 是一个 ArrayMap 集合，封装了特定的组件所持有的所有服务连接对象 ServiceConnection 和服务分发对象 ServiceDispatcher！</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">final</span> IServiceConnection <span class="title">getServiceDispatcher</span><span class="params">(ServiceConnection c,</span></span></span><br><span class="line"><span class="function"><span class="params">        Context context, Handler handler, <span class="keyword">int</span> flags)</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">synchronized</span> (mServices) &#123;</span><br><span class="line"></span><br><span class="line">        LoadedApk.ServiceDispatcher sd = <span class="keyword">null</span>;</span><br><span class="line"></span><br><span class="line">        ArrayMap&lt;ServiceConnection, LoadedApk.ServiceDispatcher&gt; map = mServices.get(context);</span><br><span class="line">        </span><br><span class="line">        <span class="comment">// 如果有的话，就直接返回！</span></span><br><span class="line">        <span class="keyword">if</span> (map != <span class="keyword">null</span>) &#123;</span><br><span class="line">            sd = map.get(c);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (sd == <span class="keyword">null</span>) &#123;</span><br><span class="line"></span><br><span class="line">            <span class="comment">//【1】不然就创建新的 ServiceDispatcher，然后返回，内部会创建 InnerConnection 对象！</span></span><br><span class="line">            sd = <span class="keyword">new</span> ServiceDispatcher(c, context, handler, flags);</span><br><span class="line"></span><br><span class="line">            <span class="keyword">if</span> (map == <span class="keyword">null</span>) &#123;</span><br><span class="line">                map = <span class="keyword">new</span> ArrayMap&lt;ServiceConnection, LoadedApk.ServiceDispatcher&gt;();</span><br><span class="line">                mServices.put(context, map);</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            <span class="comment">//【2】添加到对应的 map 集合中！</span></span><br><span class="line">            map.put(c, sd);</span><br><span class="line"></span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            sd.validate(context, handler);</span><br><span class="line">        &#125;</span><br><span class="line">        </span><br><span class="line">        <span class="comment">// 返回 InnerConnection 对象，其继承了 IServiceConnection.Stub！</span></span><br><span class="line">        <span class="keyword">return</span> sd.getIServiceConnection();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>我们来看看 ServiceDispatcher 对象的创建：<br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">ServiceDispatcher(ServiceConnection conn,</span><br><span class="line">        Context context, Handler activityThread, <span class="keyword">int</span> flags) &#123;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//【1】创建 InnerConnection 对象，用于跨进程调用！</span></span><br><span class="line">    mIServiceConnection = <span class="keyword">new</span> InnerConnection(<span class="keyword">this</span>);</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 初始化内部 ServiceConnection 对象！</span></span><br><span class="line">    mConnection = conn;</span><br><span class="line">    mContext = context;</span><br><span class="line">    mActivityThread = activityThread;</span><br><span class="line">    mLocation = <span class="keyword">new</span> ServiceConnectionLeaked(<span class="keyword">null</span>);</span><br><span class="line">    mLocation.fillInStackTrace();</span><br><span class="line">    mFlags = flags;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>接着再看看 InnerConnection 对象的创建！<br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">InnerConnection(LoadedApk.ServiceDispatcher sd) &#123;</span><br><span class="line">   </span><br><span class="line">    <span class="comment">//【1】持有 ServiceDispatcher 的弱引用！</span></span><br><span class="line">    mDispatcher = <span class="keyword">new</span> WeakReference&lt;LoadedApk.ServiceDispatcher&gt;(sd);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>这里就看这么多！！</p>
<p>我们来他通过一张图看看绑定者进程的数据结构之间的关系：</p>
<p><img src="http://static.zybuluo.com/Coolqi/p0gzyjijwj4mo5gc29oqj3ar/%E7%BB%91%E5%AE%9A%E8%80%85%E8%BF%9B%E7%A8%8B%E4%B8%AD%E7%9A%84%E6%95%B0%E6%8D%AE%E7%BB%93%E6%9E%84%E5%85%B3%E7%B3%BB.png" alt="绑定者进程中的数据结构关系.png-164.8kB"></p>
<p>其中，mActiveConnections 表示的是处于活跃中的连接信息，这个我们后面再看！</p>
<p>接着，调用 ActivityManagerNative.getDefault() 方法，获得 AMS 的代理对象 ActivityManagerProxy，调用代理的 bindService 方法！</p>
<h2 id="1-5-ActivityManagerP-bindService"><a href="#1-5-ActivityManagerP-bindService" class="headerlink" title="1.5 ActivityManagerP.bindService"></a>1.5 ActivityManagerP.bindService</h2><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">int</span> <span class="title">bindService</span><span class="params">(IApplicationThread caller, IBinder token,</span></span></span><br><span class="line"><span class="function"><span class="params">        Intent service, String resolvedType, IServiceConnection connection,</span></span></span><br><span class="line"><span class="function"><span class="params">        <span class="keyword">int</span> flags,  String callingPackage, <span class="keyword">int</span> userId)</span> <span class="keyword">throws</span> RemoteException </span>&#123;</span><br><span class="line"></span><br><span class="line">    Parcel data = Parcel.obtain();</span><br><span class="line">    Parcel reply = Parcel.obtain();</span><br><span class="line">    data.writeInterfaceToken(IActivityManager.descriptor);</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// 这里的 caller 是 ApplicationThread 对象！</span></span><br><span class="line">    data.writeStrongBinder(caller != <span class="keyword">null</span> ? caller.asBinder() : <span class="keyword">null</span>);</span><br><span class="line">    data.writeStrongBinder(token);</span><br><span class="line"></span><br><span class="line">    service.writeToParcel(data, <span class="number">0</span>);</span><br><span class="line">    data.writeString(resolvedType);</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 这里的 connection 是 InnerConnection 对象！</span></span><br><span class="line">    data.writeStrongBinder(connection.asBinder());</span><br><span class="line"></span><br><span class="line">    data.writeInt(flags);</span><br><span class="line">    data.writeString(callingPackage);</span><br><span class="line">    data.writeInt(userId);</span><br><span class="line"></span><br><span class="line">    mRemote.transact(BIND_SERVICE_TRANSACTION, data, reply, <span class="number">0</span>);</span><br><span class="line"></span><br><span class="line">    reply.readException();</span><br><span class="line">    <span class="keyword">int</span> res = reply.readInt();</span><br><span class="line">    data.recycle();</span><br><span class="line">    reply.recycle();</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> res;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>通过 binder 进程间通信，进入系统进程，参数分析：</p>
<ul>
<li>IApplicationThread caller：调用者进程的 ApplicationThread 对象，实现了 IApplicationThread 接口；</li>
<li>IBinder token：应用端的 mActivityToken；</li>
<li>Intent service：启动的 intent</li>
<li>String resolvedType：这个 intent 的 MIME 类型；</li>
<li>IServiceConnection connection：服务连接对象 InnerConnection；</li>
<li>String callingPackage：启动者所属包名；</li>
<li>int userId：设备用户 id；</li>
</ul>
<p>下面会进入系统进程！</p>
<h1 id="2-系统进程"><a href="#2-系统进程" class="headerlink" title="2 系统进程"></a>2 系统进程</h1><p>首先要进入 ActivityManagerN.onTransact 方法！<br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">case</span> BIND_SERVICE_TRANSACTION: &#123;</span><br><span class="line"></span><br><span class="line">    data.enforceInterface(IActivityManager.descriptor);</span><br><span class="line">    </span><br><span class="line">    <span class="comment">//【1】获得 ApplicationThreadProxy 对象！</span></span><br><span class="line">    IBinder b = data.readStrongBinder();</span><br><span class="line">    IApplicationThread app = ApplicationThreadNative.asInterface(b);</span><br><span class="line">    </span><br><span class="line">    <span class="comment">//【2】Activity 句柄！</span></span><br><span class="line">    IBinder token = data.readStrongBinder();</span><br><span class="line"></span><br><span class="line">    Intent service = Intent.CREATOR.createFromParcel(data);</span><br><span class="line">    String resolvedType = data.readString();</span><br><span class="line">    b = data.readStrongBinder();</span><br><span class="line">    <span class="keyword">int</span> fl = data.readInt();</span><br><span class="line">    String callingPackage = data.readString();</span><br><span class="line">    <span class="keyword">int</span> userId = data.readInt();</span><br><span class="line">    </span><br><span class="line">    <span class="comment">//【3】获得 InnerConnection 的代理对象！</span></span><br><span class="line">    IServiceConnection conn = IServiceConnection.Stub.asInterface(b);</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// 进入 AMS!</span></span><br><span class="line">    <span class="keyword">int</span> res = bindService(app, token, service, resolvedType, conn, fl,</span><br><span class="line">            callingPackage, userId);</span><br><span class="line"></span><br><span class="line">    reply.writeNoException();</span><br><span class="line">    reply.writeInt(res);</span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">true</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>继续看！</p>
<h2 id="2-1-ActivityManagerS-bindService"><a href="#2-1-ActivityManagerS-bindService" class="headerlink" title="2.1 ActivityManagerS.bindService"></a>2.1 ActivityManagerS.bindService</h2><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">int</span> <span class="title">bindService</span><span class="params">(IApplicationThread caller, IBinder token, Intent service,</span></span></span><br><span class="line"><span class="function"><span class="params">        String resolvedType, IServiceConnection connection, <span class="keyword">int</span> flags, String callingPackage,</span></span></span><br><span class="line"><span class="function"><span class="params">        <span class="keyword">int</span> userId)</span> <span class="keyword">throws</span> TransactionTooLargeException </span>&#123;</span><br><span class="line"></span><br><span class="line">    enforceNotIsolatedCaller(<span class="string">"bindService"</span>);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (service != <span class="keyword">null</span> &amp;&amp; service.hasFileDescriptors() == <span class="keyword">true</span>) &#123;</span><br><span class="line">        <span class="keyword">throw</span> <span class="keyword">new</span> IllegalArgumentException(<span class="string">"File descriptors passed in Intent"</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (callingPackage == <span class="keyword">null</span>) &#123;</span><br><span class="line">        <span class="keyword">throw</span> <span class="keyword">new</span> IllegalArgumentException(<span class="string">"callingPackage cannot be null"</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">synchronized</span>(<span class="keyword">this</span>) &#123;</span><br><span class="line">    </span><br><span class="line">        <span class="comment">// 进入 ActiveServices 中！！</span></span><br><span class="line">        <span class="keyword">return</span> mServices.bindServiceLocked(caller, token, service,</span><br><span class="line">                resolvedType, connection, flags, callingPackage, userId);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h2 id="2-2-ActiveServices-bindServiceLocked"><a href="#2-2-ActiveServices-bindServiceLocked" class="headerlink" title="2.2 ActiveServices.bindServiceLocked"></a>2.2 ActiveServices.bindServiceLocked</h2><p>这个方法的逻辑比较长，我们来仔细看看！<br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br><span class="line">212</span><br><span class="line">213</span><br><span class="line">214</span><br><span class="line">215</span><br><span class="line">216</span><br><span class="line">217</span><br><span class="line">218</span><br><span class="line">219</span><br><span class="line">220</span><br><span class="line">221</span><br><span class="line">222</span><br><span class="line">223</span><br><span class="line">224</span><br><span class="line">225</span><br><span class="line">226</span><br><span class="line">227</span><br><span class="line">228</span><br><span class="line">229</span><br><span class="line">230</span><br><span class="line">231</span><br><span class="line">232</span><br><span class="line">233</span><br><span class="line">234</span><br><span class="line">235</span><br><span class="line">236</span><br><span class="line">237</span><br><span class="line">238</span><br><span class="line">239</span><br><span class="line">240</span><br><span class="line">241</span><br><span class="line">242</span><br><span class="line">243</span><br><span class="line">244</span><br><span class="line">245</span><br><span class="line">246</span><br><span class="line">247</span><br><span class="line">248</span><br><span class="line">249</span><br><span class="line">250</span><br><span class="line">251</span><br><span class="line">252</span><br><span class="line">253</span><br><span class="line">254</span><br><span class="line">255</span><br><span class="line">256</span><br><span class="line">257</span><br><span class="line">258</span><br><span class="line">259</span><br><span class="line">260</span><br><span class="line">261</span><br><span class="line">262</span><br><span class="line">263</span><br><span class="line">264</span><br><span class="line">265</span><br><span class="line">266</span><br><span class="line">267</span><br><span class="line">268</span><br><span class="line">269</span><br><span class="line">270</span><br><span class="line">271</span><br><span class="line">272</span><br><span class="line">273</span><br><span class="line">274</span><br><span class="line">275</span><br><span class="line">276</span><br><span class="line">277</span><br><span class="line">278</span><br><span class="line">279</span><br><span class="line">280</span><br><span class="line">281</span><br><span class="line">282</span><br><span class="line">283</span><br><span class="line">284</span><br><span class="line">285</span><br><span class="line">286</span><br><span class="line">287</span><br><span class="line">288</span><br><span class="line">289</span><br><span class="line">290</span><br><span class="line">291</span><br><span class="line">292</span><br><span class="line">293</span><br><span class="line">294</span><br><span class="line">295</span><br><span class="line">296</span><br><span class="line">297</span><br><span class="line">298</span><br><span class="line">299</span><br><span class="line">300</span><br><span class="line">301</span><br><span class="line">302</span><br><span class="line">303</span><br><span class="line">304</span><br><span class="line">305</span><br><span class="line">306</span><br><span class="line">307</span><br><span class="line">308</span><br><span class="line">309</span><br><span class="line">310</span><br><span class="line">311</span><br><span class="line">312</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">bindServiceLocked</span><span class="params">(IApplicationThread caller, IBinder token, Intent service,</span></span></span><br><span class="line"><span class="function"><span class="params">        String resolvedType, <span class="keyword">final</span> IServiceConnection connection, <span class="keyword">int</span> flags,</span></span></span><br><span class="line"><span class="function"><span class="params">        String callingPackage, <span class="keyword">final</span> <span class="keyword">int</span> userId)</span> <span class="keyword">throws</span> TransactionTooLargeException </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (DEBUG_SERVICE) Slog.v(TAG_SERVICE, <span class="string">"bindService: "</span> + service</span><br><span class="line">            + <span class="string">" type="</span> + resolvedType + <span class="string">" conn="</span> + connection.asBinder()</span><br><span class="line">            + <span class="string">" flags=0x"</span> + Integer.toHexString(flags));</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// 获得调用者进程 ProcessRecord 对象！</span></span><br><span class="line">    <span class="keyword">final</span> ProcessRecord callerApp = mAm.getRecordForAppLocked(caller);</span><br><span class="line">    <span class="keyword">if</span> (callerApp == <span class="keyword">null</span>) &#123;</span><br><span class="line">        <span class="keyword">throw</span> <span class="keyword">new</span> SecurityException(</span><br><span class="line">                <span class="string">"Unable to find app for caller "</span> + caller</span><br><span class="line">                + <span class="string">" (pid="</span> + Binder.getCallingPid()</span><br><span class="line">                + <span class="string">") when binding service "</span> + service);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 如果 token 不为 null 的话，就获得其对应的 ActivityRecord 对象！</span></span><br><span class="line">    ActivityRecord activity = <span class="keyword">null</span>;</span><br><span class="line">    <span class="keyword">if</span> (token != <span class="keyword">null</span>) &#123;</span><br><span class="line">        activity = ActivityRecord.isInStackLocked(token);</span><br><span class="line">        <span class="keyword">if</span> (activity == <span class="keyword">null</span>) &#123;</span><br><span class="line">            Slog.w(TAG, <span class="string">"Binding with unknown activity: "</span> + token);</span><br><span class="line">            <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">int</span> clientLabel = <span class="number">0</span>;</span><br><span class="line">    PendingIntent clientIntent = <span class="keyword">null</span>;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// 判断是否是系统进程！</span></span><br><span class="line">    <span class="keyword">final</span> <span class="keyword">boolean</span> isCallerSystem = callerApp.info.uid == Process.SYSTEM_UID;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (isCallerSystem) &#123;</span><br><span class="line">    </span><br><span class="line">        service.setDefusable(<span class="keyword">true</span>);</span><br><span class="line">        clientIntent = service.getParcelableExtra(Intent.EXTRA_CLIENT_INTENT);</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (clientIntent != <span class="keyword">null</span>) &#123;</span><br><span class="line">            clientLabel = service.getIntExtra(Intent.EXTRA_CLIENT_LABEL, <span class="number">0</span>);</span><br><span class="line">            <span class="keyword">if</span> (clientLabel != <span class="number">0</span>) &#123;</span><br><span class="line"></span><br><span class="line">                service = service.cloneFilter();</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 如果设置了 Context.BIND_TREAT_LIKE_ACTIVITY 的标签，</span></span><br><span class="line">    <span class="comment">// 必须有权限 android.Manifest.permission.MANAGE_ACTIVITY_STACKS；</span></span><br><span class="line">    <span class="keyword">if</span> ((flags&amp;Context.BIND_TREAT_LIKE_ACTIVITY) != <span class="number">0</span>) &#123;</span><br><span class="line">        mAm.enforceCallingPermission(android.Manifest.permission.MANAGE_ACTIVITY_STACKS,</span><br><span class="line">                <span class="string">"BIND_TREAT_LIKE_ACTIVITY"</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 非系统进程不能设置 BIND_ALLOW_WHITELIST_MANAGEMENT 的 flags！</span></span><br><span class="line">    <span class="keyword">if</span> ((flags &amp; Context.BIND_ALLOW_WHITELIST_MANAGEMENT) != <span class="number">0</span> &amp;&amp; !isCallerSystem) &#123;</span><br><span class="line">        <span class="keyword">throw</span> <span class="keyword">new</span> SecurityException(</span><br><span class="line">                <span class="string">"Non-system caller "</span> + caller + <span class="string">" (pid="</span> + Binder.getCallingPid()</span><br><span class="line">                + <span class="string">") set BIND_ALLOW_WHITELIST_MANAGEMENT when binding service "</span> + service);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// callerFg 表示的是前台调用或者是后台调用！</span></span><br><span class="line">    <span class="keyword">final</span> <span class="keyword">boolean</span> callerFg = callerApp.setSchedGroup != ProcessList.SCHED_GROUP_BACKGROUND;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// 表示是否 bind 的是 isolated， external 类型的服务！</span></span><br><span class="line">    <span class="keyword">final</span> <span class="keyword">boolean</span> isBindExternal = (flags &amp; Context.BIND_EXTERNAL_SERVICE) != <span class="number">0</span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//【1】检索要 bind 的服务信息！</span></span><br><span class="line">    ServiceLookupResult res =</span><br><span class="line">        retrieveServiceLocked(service, resolvedType, callingPackage, Binder.getCallingPid(),</span><br><span class="line">                Binder.getCallingUid(), userId, <span class="keyword">true</span>, callerFg, isBindExternal);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (res == <span class="keyword">null</span>) &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span> (res.record == <span class="keyword">null</span>) &#123;</span><br><span class="line">        <span class="keyword">return</span> -<span class="number">1</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// 获得服务的信息对象 ServiceRecord！</span></span><br><span class="line">    ServiceRecord s = res.record;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">boolean</span> permissionsReviewRequired = <span class="keyword">false</span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 如果编译时，指定需要检测权限，那就先要通过权限的检测！</span></span><br><span class="line">    <span class="keyword">if</span> (Build.PERMISSIONS_REVIEW_REQUIRED) &#123;</span><br><span class="line">        <span class="keyword">if</span> (mAm.getPackageManagerInternalLocked().isPermissionsReviewRequired(</span><br><span class="line">                s.packageName, s.userId)) &#123;</span><br><span class="line"></span><br><span class="line">            permissionsReviewRequired = <span class="keyword">true</span>;</span><br><span class="line"></span><br><span class="line">            <span class="comment">// 对于前台调用才要校验权限！</span></span><br><span class="line">            <span class="keyword">if</span> (!callerFg) &#123;</span><br><span class="line">                Slog.w(TAG, <span class="string">"u"</span> + s.userId + <span class="string">" Binding to a service in package"</span></span><br><span class="line">                        + s.packageName + <span class="string">" requires a permissions review"</span>);</span><br><span class="line">                <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            <span class="keyword">final</span> ServiceRecord serviceRecord = s;</span><br><span class="line">            <span class="keyword">final</span> Intent serviceIntent = service;</span><br><span class="line"></span><br><span class="line">            <span class="comment">// 校验权限后的回调！</span></span><br><span class="line">            RemoteCallback callback = <span class="keyword">new</span> RemoteCallback(</span><br><span class="line">                    <span class="keyword">new</span> RemoteCallback.OnResultListener() &#123;</span><br><span class="line">                <span class="meta">@Override</span></span><br><span class="line">                <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onResult</span><span class="params">(Bundle result)</span> </span>&#123;</span><br><span class="line">                    <span class="keyword">synchronized</span>(mAm) &#123;</span><br><span class="line">                        <span class="keyword">final</span> <span class="keyword">long</span> identity = Binder.clearCallingIdentity();</span><br><span class="line">                        <span class="keyword">try</span> &#123;</span><br><span class="line">                            <span class="keyword">if</span> (!mPendingServices.contains(serviceRecord)) &#123;</span><br><span class="line">                                <span class="keyword">return</span>;</span><br><span class="line">                            &#125;</span><br><span class="line"></span><br><span class="line">                            <span class="keyword">if</span> (!mAm.getPackageManagerInternalLocked()</span><br><span class="line">                                    .isPermissionsReviewRequired(</span><br><span class="line">                                            serviceRecord.packageName,</span><br><span class="line">                                            serviceRecord.userId)) &#123;</span><br><span class="line">                                <span class="keyword">try</span> &#123;</span><br><span class="line">                                    </span><br><span class="line">                                    <span class="comment">//</span></span><br><span class="line">                                    bringUpServiceLocked(serviceRecord,</span><br><span class="line">                                            serviceIntent.getFlags(),</span><br><span class="line">                                            callerFg, <span class="keyword">false</span>, <span class="keyword">false</span>);</span><br><span class="line">                                &#125; <span class="keyword">catch</span> (RemoteException e) &#123;</span><br><span class="line">                                    <span class="comment">/* ignore - local call */</span></span><br><span class="line">                                &#125;</span><br><span class="line">                            &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                                unbindServiceLocked(connection);</span><br><span class="line">                            &#125;</span><br><span class="line">                        &#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">                            Binder.restoreCallingIdentity(identity);</span><br><span class="line">                        &#125;</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;);</span><br><span class="line">            </span><br><span class="line">            <span class="comment">// 创建 intent，启动 PackageInstaller，来校验权限！</span></span><br><span class="line">            <span class="keyword">final</span> Intent intent = <span class="keyword">new</span> Intent(Intent.ACTION_REVIEW_PERMISSIONS);</span><br><span class="line">            intent.addFlags(Intent.FLAG_ACTIVITY_NEW_TASK</span><br><span class="line">                    | Intent.FLAG_ACTIVITY_EXCLUDE_FROM_RECENTS);</span><br><span class="line">            intent.putExtra(Intent.EXTRA_PACKAGE_NAME, s.packageName);</span><br><span class="line">            intent.putExtra(Intent.EXTRA_REMOTE_CALLBACK, callback);</span><br><span class="line"></span><br><span class="line">            <span class="keyword">if</span> (DEBUG_PERMISSIONS_REVIEW) &#123;</span><br><span class="line">                Slog.i(TAG, <span class="string">"u"</span> + s.userId + <span class="string">" Launching permission review for package "</span></span><br><span class="line">                        + s.packageName);</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            mAm.mHandler.post(<span class="keyword">new</span> Runnable() &#123;</span><br><span class="line">                <span class="meta">@Override</span></span><br><span class="line">                <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">run</span><span class="params">()</span> </span>&#123;</span><br><span class="line">                </span><br><span class="line">                    <span class="comment">// 启动权限校验界面！</span></span><br><span class="line">                    mAm.mContext.startActivityAsUser(intent, <span class="keyword">new</span> UserHandle(userId));</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">final</span> <span class="keyword">long</span> origId = Binder.clearCallingIdentity();</span><br><span class="line"></span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">        </span><br><span class="line">        <span class="comment">//【2】取消服务的重启任务！</span></span><br><span class="line">        <span class="keyword">if</span> (unscheduleServiceRestartLocked(s, callerApp.info.uid, <span class="keyword">false</span>)) &#123;</span><br><span class="line">            <span class="keyword">if</span> (DEBUG_SERVICE) Slog.v(TAG_SERVICE, <span class="string">"BIND SERVICE WHILE RESTART PENDING: "</span> + s);</span><br><span class="line">        &#125;</span><br><span class="line">        </span><br><span class="line">        <span class="comment">// 如果启动 flags 设置了 Context.BIND_AUTO_CREATE 标签！</span></span><br><span class="line">        <span class="keyword">if</span> ((flags&amp;Context.BIND_AUTO_CREATE) != <span class="number">0</span>) &#123;</span><br><span class="line">        </span><br><span class="line">            <span class="comment">// 更新服务的活跃时间！</span></span><br><span class="line">            s.lastActivity = SystemClock.uptimeMillis();</span><br><span class="line">            <span class="keyword">if</span> (!s.hasAutoCreateConnections()) &#123;</span><br><span class="line"></span><br><span class="line">                <span class="comment">// 这是第一次 bind，通知服务状态监控器！</span></span><br><span class="line">                ServiceState stracker = s.getTracker();</span><br><span class="line">                <span class="keyword">if</span> (stracker != <span class="keyword">null</span>) &#123;</span><br><span class="line">                    stracker.setBound(<span class="keyword">true</span>, mAm.mProcessStats.getMemFactorLocked(),</span><br><span class="line">                            s.lastActivity);</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        mAm.startAssociationLocked(callerApp.uid, callerApp.processName, callerApp.curProcState,</span><br><span class="line">                s.appInfo.uid, s.name, s.processName);</span><br><span class="line">        </span><br><span class="line">        <span class="comment">//【3】创建 AppBindRecord 对象，用来记录绑定到这个服务的应用的信息！</span></span><br><span class="line">        <span class="comment">// s 是要绑定的 ServiceRecord!</span></span><br><span class="line">        AppBindRecord b = s.retrieveAppBindingLocked(service, callerApp);</span><br><span class="line">        </span><br><span class="line">        <span class="comment">// 创建 ConnectionRecord 对象，用来记本次的绑定连接！</span></span><br><span class="line">        ConnectionRecord c = <span class="keyword">new</span> ConnectionRecord(b, activity,</span><br><span class="line">                connection, flags, clientLabel, clientIntent);</span><br><span class="line">        </span><br><span class="line">        <span class="comment">// connection 是一个从应用进程传过来的 InnerConnection 对象！</span></span><br><span class="line">        IBinder binder = connection.asBinder();</span><br><span class="line"></span><br><span class="line">        <span class="comment">// s.connections 记录了这个服务的 IServiceConnection 对象和 ConnectionRecord 对象的对应关系！</span></span><br><span class="line">        ArrayList&lt;ConnectionRecord&gt; clist = s.connections.get(binder);</span><br><span class="line">        <span class="keyword">if</span> (clist == <span class="keyword">null</span>) &#123;</span><br><span class="line">            clist = <span class="keyword">new</span> ArrayList&lt;ConnectionRecord&gt;();</span><br><span class="line">            s.connections.put(binder, clist);</span><br><span class="line">        &#125;</span><br><span class="line">        </span><br><span class="line">        <span class="comment">// 将 ConnectionRecord 保存到 s.connections 中！</span></span><br><span class="line">        clist.add(c);</span><br><span class="line">        </span><br><span class="line">        <span class="comment">// 将 ConnectionRecord 对象添加到对应的 AppBindRecord 的 connections 中！</span></span><br><span class="line">        b.connections.add(c);</span><br><span class="line">        </span><br><span class="line">        <span class="comment">// 如果 activity 不为 null，说明是 Activity 执行的 bind，所以要把 ConnectionRecord 添加到其 connections 中;</span></span><br><span class="line">        <span class="keyword">if</span> (activity != <span class="keyword">null</span>) &#123;</span><br><span class="line">            <span class="keyword">if</span> (activity.connections == <span class="keyword">null</span>) &#123;</span><br><span class="line">                activity.connections = <span class="keyword">new</span> HashSet&lt;ConnectionRecord&gt;();</span><br><span class="line">            &#125;</span><br><span class="line">            activity.connections.add(c);</span><br><span class="line">        &#125;</span><br><span class="line">        </span><br><span class="line">        <span class="comment">// 将 ConnectionRecord 保存到调用者进程的 connections 列表中！</span></span><br><span class="line">        b.client.connections.add(c);</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> ((c.flags&amp;Context.BIND_ABOVE_CLIENT) != <span class="number">0</span>) &#123;</span><br><span class="line">            b.client.hasAboveClient = <span class="keyword">true</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">if</span> ((c.flags&amp;Context.BIND_ALLOW_WHITELIST_MANAGEMENT) != <span class="number">0</span>) &#123;</span><br><span class="line">            s.whitelistManager = <span class="keyword">true</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">if</span> (s.app != <span class="keyword">null</span>) &#123;</span><br><span class="line">            updateServiceClientActivitiesLocked(s.app, c, <span class="keyword">true</span>);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// mServiceConnections 是 AS 的成员变量，记录着 IServiceConnection 和其 ConnectionRecord 的对应关系！</span></span><br><span class="line">        clist = mServiceConnections.get(binder);</span><br><span class="line">        <span class="keyword">if</span> (clist == <span class="keyword">null</span>) &#123;</span><br><span class="line">            clist = <span class="keyword">new</span> ArrayList&lt;ConnectionRecord&gt;();</span><br><span class="line">            mServiceConnections.put(binder, clist);</span><br><span class="line">        &#125;</span><br><span class="line">        clist.add(c);</span><br><span class="line">        </span><br><span class="line">        <span class="comment">// 如果启动的 flags 设置了 Context.BIND_AUTO_CREATE 标志位，那么就进入这个分支，</span></span><br><span class="line">        <span class="comment">// 如果服务没有被创建，就会自动创建服务！</span></span><br><span class="line">        <span class="keyword">if</span> ((flags&amp;Context.BIND_AUTO_CREATE) != <span class="number">0</span>) &#123;</span><br><span class="line">            </span><br><span class="line">            <span class="comment">// 再次更新服务的活跃时间！</span></span><br><span class="line">            s.lastActivity = SystemClock.uptimeMillis();</span><br><span class="line">            </span><br><span class="line">            <span class="comment">//【4】启动该服务，如果服务所在进程未启动，还要启动相应进程，其返回值为 null，说明启动成功！</span></span><br><span class="line">            <span class="keyword">if</span> (bringUpServiceLocked(s, service.getFlags(), callerFg, <span class="keyword">false</span>,</span><br><span class="line">                    permissionsReviewRequired) != <span class="keyword">null</span>) &#123;</span><br><span class="line"></span><br><span class="line">                <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 如果服务所在进程的 ProcessRecord 不为 null，就要更新服务的优先级以及 oomAdj 的值！</span></span><br><span class="line">        <span class="keyword">if</span> (s.app != <span class="keyword">null</span>) &#123;</span><br><span class="line">            <span class="keyword">if</span> ((flags&amp;Context.BIND_TREAT_LIKE_ACTIVITY) != <span class="number">0</span>) &#123;</span><br><span class="line">                s.app.treatLikeActivity = <span class="keyword">true</span>;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">if</span> (s.whitelistManager) &#123;</span><br><span class="line">                s.app.whitelistManager = <span class="keyword">true</span>;</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            mAm.updateLruProcessLocked(s.app, s.app.hasClientActivities</span><br><span class="line">                    || s.app.treatLikeActivity, b.client);</span><br><span class="line">            mAm.updateOomAdjLocked(s.app);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 【*】接着进入这个分支，这里我们在下面分析：</span></span><br><span class="line">        <span class="keyword">if</span> (DEBUG_SERVICE) Slog.v(TAG_SERVICE, <span class="string">"Bind "</span> + s + <span class="string">" with "</span> + b</span><br><span class="line">                + <span class="string">": received="</span> + b.intent.received</span><br><span class="line">                + <span class="string">" apps="</span> + b.intent.apps.size()</span><br><span class="line">                + <span class="string">" doRebind="</span> + b.intent.doRebind);</span><br><span class="line">        </span><br><span class="line">        <span class="comment">// 第一次自动创建方式的绑定，两个分支都不进入，多次自动创建方式的绑定，只会进入第二个分支！</span></span><br><span class="line">        <span class="keyword">if</span> (s.app != <span class="keyword">null</span> &amp;&amp; b.intent.received) &#123;</span><br><span class="line"></span><br><span class="line">            <span class="keyword">try</span> &#123;</span><br><span class="line"></span><br><span class="line">                <span class="comment">//【5】服务已经在运行中了，那就尝试完成连接，会判断是否已经已有连接</span></span><br><span class="line">                <span class="comment">// 如果有，就不会创建连接！</span></span><br><span class="line">                c.conn.connected(s.name, b.intent.binder);</span><br><span class="line"></span><br><span class="line">            &#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">                Slog.w(TAG, <span class="string">"Failure sending service "</span> + s.shortName</span><br><span class="line">                        + <span class="string">" to connection "</span> + c.conn.asBinder()</span><br><span class="line">                        + <span class="string">" (in "</span> + c.binding.client.processName + <span class="string">")"</span>, e);</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            <span class="comment">// If this is the first app connected back to this binding,</span></span><br><span class="line">            <span class="comment">// and the service had previously asked to be told when</span></span><br><span class="line">            <span class="comment">// rebound, then do so.</span></span><br><span class="line">            <span class="comment">// 【6】尝试拉起服务的 onRebind 方法！</span></span><br><span class="line">            <span class="keyword">if</span> (b.intent.apps.size() == <span class="number">1</span> &amp;&amp; b.intent.doRebind) &#123;</span><br><span class="line">                requestServiceBindingLocked(s, b.intent, callerFg, <span class="keyword">true</span>);</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">        &#125; <span class="keyword">else</span> <span class="keyword">if</span> (!b.intent.requested) &#123;</span><br><span class="line"></span><br><span class="line">            <span class="comment">// 【7】尝试拉起服务的 onBind 方法！</span></span><br><span class="line">            requestServiceBindingLocked(s, b.intent, callerFg, <span class="keyword">false</span>);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        getServiceMap(s.userId).ensureNotStartingBackground(s);</span><br><span class="line"></span><br><span class="line">    &#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">        Binder.restoreCallingIdentity(origId);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> <span class="number">1</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>这个方法的逻辑很长，我们来简单总结一下重点！！</p>
<p><strong>注意</strong>：</p>
<p>对于 Context.BIND_AUTO_CREATE 的方式，bringUpServiceLocked 方法中拉起 onCreate 和 onBind 方法的 Binder 通信是 IBinder.FLAGS_ONEWAY 方式，所以 Binder 服务端系统进程在触发方法后，无需等待，会立即向下执行！</p>
<p><strong>这里来重点说下最后的分支部分</strong>：</p>
<p>这部分内容会涉及到下面的章节！！</p>
<ul>
<li><p>对于 BIND_AUTO_CREATE 的这种 bindService 方式：</p>
<ul>
<li>第一次绑定时，进入该分支前， received 为 false 而 requested 为 true（requested 是在 bringUpServiceLocked -&gt; requestServiceBindingLocked 被置为 true 的），所以下面 <code>IF</code> 和 <code>ELSE</code> 分支都不会进入！</li>
<li>多次绑定时，因为第一次绑定连接已经生成，所以 received 和 requested 都会为 true，这里会进入第一个 <code>IF</code> 分支，尝试执行 ServiceConnection.onServiceConnected 方法，因为之前绑定已经存在，就不会执行！！！</li>
</ul>
</li>
<li><p>对于非 BIND_AUTO_CREATE 的这种 bindService 方式：</p>
<ul>
<li>如果服务之前没有启动，那么不管绑定几次，都只是将绑定所数据绑定到相应的集合中，但 received 和 requested 都为 false！，所以会进入第二个 <code>ELSE</code> 分支，尝试拉起 onbind 方法，但是由于服务没有被创建和运行，r.app 和 r.app.thread 都为 null，所以不会继续执行！</li>
<li>如果服务之前已经被启动了，我们知道对于这种情况，如果之前进行了 bindService 的操作， 因为系统已经保存了绑定信息，所以会立刻拉起服务的 onbind 方法，并执行 ServiceConnection.onServiceConnected 方法！</li>
<li>如果服务之前已经被启动了，这是我们再执行 bindService 操作：<ul>
<li>第一次绑定，进入该分支前， received 和 requested 均为 false（这个第一种情况不同），这样会进入第二个 <code>ELSE</code> 分支，拉起服务的 onBind 方法，并执行 ServiceConnection.onServiceConnected 方法！</li>
<li>多次绑定，进入该分支前， received 和 requested 均为 true，所以会进入第一个 <code>IF</code> 分支，尝试执行 ServiceConnection.onServiceConnected 方法，因为之前绑定已经存在，就不会执行！！！</li>
</ul>
</li>
</ul>
</li>
</ul>
<p>整个流程看起来复杂，但是体现在生命周期上很简单，这里就不说了！！</p>
<p>然后，我们来看下这个方法中的重点！！</p>
<h3 id="2-2-1-ActiveServices-retrieveServiceLocked"><a href="#2-2-1-ActiveServices-retrieveServiceLocked" class="headerlink" title="2.2.1 ActiveServices.retrieveServiceLocked"></a>2.2.1 ActiveServices.retrieveServiceLocked</h3><p>根据 intent 来查询被启动服务的 ServiceRecord 对象，参数传递：</p>
<ul>
<li>boolean createIfNeeded：传入的是 true；</li>
<li>boolean callingFromFg：表示是从前台调用，还是后台调用；</li>
<li>boolean isBindExternal：表示 bind 的是否是 isolated, external 类型的服务，我们这里默认为 false；</li>
</ul>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">private</span> ServiceLookupResult <span class="title">retrieveServiceLocked</span><span class="params">(Intent service,</span></span></span><br><span class="line"><span class="function"><span class="params">        String resolvedType, String callingPackage, <span class="keyword">int</span> callingPid, <span class="keyword">int</span> callingUid, <span class="keyword">int</span> userId,</span></span></span><br><span class="line"><span class="function"><span class="params">        <span class="keyword">boolean</span> createIfNeeded, <span class="keyword">boolean</span> callingFromFg, <span class="keyword">boolean</span> isBindExternal)</span> </span>&#123;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// 被绑定的服务！</span></span><br><span class="line">    ServiceRecord r = <span class="keyword">null</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (DEBUG_SERVICE)</span><br><span class="line">        Slog.v(TAG_SERVICE, <span class="string">"retrieveServiceLocked: "</span> + service</span><br><span class="line">            + <span class="string">" type="</span> + resolvedType + <span class="string">" callingUid="</span> + callingUid);</span><br><span class="line"></span><br><span class="line">    userId = mAm.mUserController.handleIncomingUser(callingPid, callingUid, userId, <span class="keyword">false</span>,</span><br><span class="line">            ActivityManagerService.ALLOW_NON_FULL_IN_PROFILE, <span class="string">"service"</span>, <span class="keyword">null</span>);</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 从 ActiveServices 的 mServiceMap 中获得设备用户 userId 下的所有服务列表！</span></span><br><span class="line">    ServiceMap smap = getServiceMap(userId);</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// 如果 intent 有设置组件名，就从 smap.mServicesByName 中获取！</span></span><br><span class="line">    <span class="keyword">final</span> ComponentName comp = service.getComponent();</span><br><span class="line">    <span class="keyword">if</span> (comp != <span class="keyword">null</span>) &#123;</span><br><span class="line">        r = smap.mServicesByName.get(comp);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 如果 intent 没有设置组件名，就从 smap.mServicesByIntent 通过 filter 获得！</span></span><br><span class="line">    <span class="keyword">if</span> (r == <span class="keyword">null</span> &amp;&amp; !isBindExternal) &#123;</span><br><span class="line">        Intent.FilterComparison filter = <span class="keyword">new</span> Intent.FilterComparison(service);</span><br><span class="line">        r = smap.mServicesByIntent.get(filter);</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// 对于 external 类型的服务，只能限制其应用程序自己 bind！</span></span><br><span class="line">    <span class="keyword">if</span> (r != <span class="keyword">null</span> &amp;&amp; (r.serviceInfo.flags &amp; ServiceInfo.FLAG_EXTERNAL_SERVICE) != <span class="number">0</span></span><br><span class="line">            &amp;&amp; !callingPackage.equals(r.packageName)) &#123;</span><br><span class="line">        r = <span class="keyword">null</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (r == <span class="keyword">null</span>) &#123;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line"></span><br><span class="line">            <span class="comment">// 通过 PMS，查询能够匹配 intent 的服务！</span></span><br><span class="line">            ResolveInfo rInfo = AppGlobals.getPackageManager().resolveService(service,</span><br><span class="line">                    resolvedType, ActivityManagerService.STOCK_PM_FLAGS</span><br><span class="line">                            | PackageManager.MATCH_DEBUG_TRIAGED_MISSING,</span><br><span class="line">                    userId);</span><br><span class="line">            </span><br><span class="line">            <span class="comment">// 获得服务信息！</span></span><br><span class="line">            ServiceInfo sInfo =</span><br><span class="line">                rInfo != <span class="keyword">null</span> ? rInfo.serviceInfo : <span class="keyword">null</span>;</span><br><span class="line"></span><br><span class="line">            <span class="keyword">if</span> (sInfo == <span class="keyword">null</span>) &#123;</span><br><span class="line">                Slog.w(TAG_SERVICE, <span class="string">"Unable to start service "</span> + service + <span class="string">" U="</span> + userId +</span><br><span class="line">                      <span class="string">": not found"</span>);</span><br><span class="line">                <span class="keyword">return</span> <span class="keyword">null</span>;</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            ComponentName name = <span class="keyword">new</span> ComponentName(</span><br><span class="line">                    sInfo.applicationInfo.packageName, sInfo.name);</span><br><span class="line">            </span><br><span class="line">            <span class="comment">// 如果服务类型是 external 的，那么 bind 时必须加 BIND_EXTERNAL_SERVICE 的标志！</span></span><br><span class="line">            <span class="comment">// 不然会抛出安全异常！</span></span><br><span class="line">            <span class="keyword">if</span> ((sInfo.flags &amp; ServiceInfo.FLAG_EXTERNAL_SERVICE) != <span class="number">0</span>) &#123;</span><br><span class="line">                <span class="keyword">if</span> (isBindExternal) &#123;</span><br><span class="line">                    <span class="keyword">if</span> (!sInfo.exported) &#123;</span><br><span class="line"></span><br><span class="line">                        <span class="comment">// 对于 external  类型的服务，必须要设置 android:exported 的值为 true，不然抛异常！</span></span><br><span class="line">                        <span class="keyword">throw</span> <span class="keyword">new</span> SecurityException(<span class="string">"BIND_EXTERNAL_SERVICE failed, "</span> + name +</span><br><span class="line">                                <span class="string">" is not exported"</span>);</span><br><span class="line">                    &#125;</span><br><span class="line">                    </span><br><span class="line">                    <span class="comment">// 对于 external 类型的服务，必须运行在隔离进程中！</span></span><br><span class="line">                    <span class="keyword">if</span> ((sInfo.flags &amp; ServiceInfo.FLAG_ISOLATED_PROCESS) == <span class="number">0</span>) &#123;</span><br><span class="line">                        <span class="keyword">throw</span> <span class="keyword">new</span> SecurityException(<span class="string">"BIND_EXTERNAL_SERVICE failed, "</span> + name +</span><br><span class="line">                                <span class="string">" is not an isolatedProcess"</span>);</span><br><span class="line">                    &#125;</span><br><span class="line"></span><br><span class="line">                    <span class="comment">// 获得调用者应用的 ApplicationInfo 信息</span></span><br><span class="line">                    ApplicationInfo aInfo = AppGlobals.getPackageManager().getApplicationInfo(</span><br><span class="line">                            callingPackage, ActivityManagerService.STOCK_PM_FLAGS, userId);</span><br><span class="line"></span><br><span class="line">                    <span class="keyword">if</span> (aInfo == <span class="keyword">null</span>) &#123;</span><br><span class="line">                        <span class="keyword">throw</span> <span class="keyword">new</span> SecurityException(<span class="string">"BIND_EXTERNAL_SERVICE failed, "</span> +</span><br><span class="line">                                <span class="string">"could not resolve client package "</span> + callingPackage);</span><br><span class="line">                    &#125;</span><br><span class="line"></span><br><span class="line">                    sInfo = <span class="keyword">new</span> ServiceInfo(sInfo);</span><br><span class="line">                    sInfo.applicationInfo = <span class="keyword">new</span> ApplicationInfo(sInfo.applicationInfo);</span><br><span class="line">                    sInfo.applicationInfo.packageName = aInfo.packageName;</span><br><span class="line">                    sInfo.applicationInfo.uid = aInfo.uid;</span><br><span class="line">                    </span><br><span class="line">                    <span class="comment">// 设置 intent 的 ComponentName 对象！</span></span><br><span class="line">                    name = <span class="keyword">new</span> ComponentName(aInfo.packageName, name.getClassName());</span><br><span class="line">                    service.setComponent(name);</span><br><span class="line"></span><br><span class="line">                &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                    <span class="keyword">throw</span> <span class="keyword">new</span> SecurityException(<span class="string">"BIND_EXTERNAL_SERVICE required for "</span> +</span><br><span class="line">                            name);</span><br><span class="line">                &#125;</span><br><span class="line"></span><br><span class="line">            &#125; <span class="keyword">else</span> <span class="keyword">if</span> (isBindExternal) &#123;</span><br><span class="line">                <span class="keyword">throw</span> <span class="keyword">new</span> SecurityException(<span class="string">"BIND_EXTERNAL_SERVICE failed, "</span> + name +</span><br><span class="line">                        <span class="string">" is not an externalService"</span>);</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            <span class="comment">// 处理多用户的情况！</span></span><br><span class="line">            <span class="keyword">if</span> (userId &gt; <span class="number">0</span>) &#123;</span><br><span class="line">                <span class="keyword">if</span> (mAm.isSingleton(sInfo.processName, sInfo.applicationInfo,</span><br><span class="line">                        sInfo.name, sInfo.flags)</span><br><span class="line">                        &amp;&amp; mAm.isValidSingletonCall(callingUid, sInfo.applicationInfo.uid)) &#123;</span><br><span class="line"></span><br><span class="line">                    userId = <span class="number">0</span>;</span><br><span class="line">                    smap = getServiceMap(<span class="number">0</span>);</span><br><span class="line">                &#125;</span><br><span class="line">                sInfo = <span class="keyword">new</span> ServiceInfo(sInfo);</span><br><span class="line">                sInfo.applicationInfo = mAm.getAppInfoForUser(sInfo.applicationInfo, userId);</span><br><span class="line">            &#125;</span><br><span class="line">            </span><br><span class="line">            <span class="comment">// 根据 ComponentName 获得 ServiceRecord 对象！</span></span><br><span class="line">            r = smap.mServicesByName.get(name);</span><br><span class="line"></span><br><span class="line">            <span class="keyword">if</span> (r == <span class="keyword">null</span> &amp;&amp; createIfNeeded) &#123;</span><br><span class="line"></span><br><span class="line">                Intent.FilterComparison filter</span><br><span class="line">                        = <span class="keyword">new</span> Intent.FilterComparison(service.cloneFilter());</span><br><span class="line">                        </span><br><span class="line">                <span class="comment">// 创建服务重启对象，这是一个 Runnable 对象！！</span></span><br><span class="line">                ServiceRestarter res = <span class="keyword">new</span> ServiceRestarter();</span><br><span class="line">                BatteryStatsImpl.Uid.Pkg.Serv ss = <span class="keyword">null</span>;</span><br><span class="line">                BatteryStatsImpl stats = mAm.mBatteryStatsService.getActiveStatistics();</span><br><span class="line"></span><br><span class="line">                <span class="keyword">synchronized</span> (stats) &#123;</span><br><span class="line">                    ss = stats.getServiceStatsLocked(</span><br><span class="line">                            sInfo.applicationInfo.uid, sInfo.packageName,</span><br><span class="line">                            sInfo.name);</span><br><span class="line">                &#125;</span><br><span class="line">                 </span><br><span class="line">                <span class="comment">// 创建新的 ServiceRecord 对象！</span></span><br><span class="line">                r = <span class="keyword">new</span> ServiceRecord(mAm, ss, name, filter, sInfo, callingFromFg, res);</span><br><span class="line">                res.setService(r);</span><br><span class="line">                </span><br><span class="line">                <span class="comment">// 将新的 ServiceRecord 添加到 smap.mServicesByName 和 smap.mServicesByIntent 中！</span></span><br><span class="line">                smap.mServicesByName.put(name, r);</span><br><span class="line">                smap.mServicesByIntent.put(filter, r);</span><br><span class="line"></span><br><span class="line">                <span class="comment">// 从 mPendingServices 中移除这个 ServiceRecord！</span></span><br><span class="line">                <span class="keyword">for</span> (<span class="keyword">int</span> i=mPendingServices.size()-<span class="number">1</span>; i&gt;=<span class="number">0</span>; i--) &#123;</span><br><span class="line">                    ServiceRecord pr = mPendingServices.get(i);</span><br><span class="line">                    <span class="keyword">if</span> (pr.serviceInfo.applicationInfo.uid == sInfo.applicationInfo.uid</span><br><span class="line">                            &amp;&amp; pr.name.equals(name)) &#123;</span><br><span class="line">                        mPendingServices.remove(i);</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125; <span class="keyword">catch</span> (RemoteException ex) &#123;</span><br><span class="line">            <span class="comment">// pm is in same process, this will never happen.</span></span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 下面对查询的数据进行封装！</span></span><br><span class="line">    <span class="keyword">if</span> (r != <span class="keyword">null</span>) &#123;</span><br><span class="line">        <span class="keyword">if</span> (mAm.checkComponentPermission(r.permission,</span><br><span class="line">                callingPid, callingUid, r.appInfo.uid, r.exported)</span><br><span class="line">                != PackageManager.PERMISSION_GRANTED) &#123; <span class="comment">// 检查权限如果不授予！</span></span><br><span class="line"></span><br><span class="line">            <span class="keyword">if</span> (!r.exported) &#123;</span><br><span class="line">                Slog.w(TAG, <span class="string">"Permission Denial: Accessing service "</span> + r.name</span><br><span class="line">                        + <span class="string">" from pid="</span> + callingPid</span><br><span class="line">                        + <span class="string">", uid="</span> + callingUid</span><br><span class="line">                        + <span class="string">" that is not exported from uid "</span> + r.appInfo.uid);</span><br><span class="line">                </span><br><span class="line">                <span class="comment">// 异常返回，_record 为 null，无法启动！</span></span><br><span class="line">                <span class="keyword">return</span> <span class="keyword">new</span> ServiceLookupResult(<span class="keyword">null</span>, <span class="string">"not exported from uid "</span></span><br><span class="line">                        + r.appInfo.uid);</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            Slog.w(TAG, <span class="string">"Permission Denial: Accessing service "</span> + r.name</span><br><span class="line">                    + <span class="string">" from pid="</span> + callingPid</span><br><span class="line">                    + <span class="string">", uid="</span> + callingUid</span><br><span class="line">                    + <span class="string">" requires "</span> + r.permission);</span><br><span class="line"></span><br><span class="line">            <span class="comment">// 异常返回，_record 为 null，无法启动！</span></span><br><span class="line">            <span class="keyword">return</span> <span class="keyword">new</span> ServiceLookupResult(<span class="keyword">null</span>, r.permission);</span><br><span class="line">        &#125; <span class="keyword">else</span> <span class="keyword">if</span> (r.permission != <span class="keyword">null</span> &amp;&amp; callingPackage != <span class="keyword">null</span>) &#123;</span><br><span class="line">            <span class="keyword">final</span> <span class="keyword">int</span> opCode = AppOpsManager.permissionToOpCode(r.permission);</span><br><span class="line">            <span class="keyword">if</span> (opCode != AppOpsManager.OP_NONE &amp;&amp; mAm.mAppOpsService.noteOperation(</span><br><span class="line">                    opCode, callingUid, callingPackage) != AppOpsManager.MODE_ALLOWED) &#123;</span><br><span class="line">                    </span><br><span class="line">                Slog.w(TAG, <span class="string">"Appop Denial: Accessing service "</span> + r.name</span><br><span class="line">                        + <span class="string">" from pid="</span> + callingPid</span><br><span class="line">                        + <span class="string">", uid="</span> + callingUid</span><br><span class="line">                        + <span class="string">" requires appop "</span> + AppOpsManager.opToName(opCode));</span><br><span class="line">                        </span><br><span class="line">                <span class="comment">// 异常返回，无法启动！</span></span><br><span class="line">                <span class="keyword">return</span> <span class="keyword">null</span>;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (!mAm.mIntentFirewall.checkService(r.name, service, callingUid, callingPid,</span><br><span class="line">                resolvedType, r.appInfo)) &#123;</span><br><span class="line"></span><br><span class="line">            <span class="comment">// 异常返回，无法启动！</span></span><br><span class="line">            <span class="keyword">return</span> <span class="keyword">null</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        </span><br><span class="line">        <span class="comment">// 返回最终的服务封装类！！</span></span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> ServiceLookupResult(r, <span class="keyword">null</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">null</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>这个方法的最终目的是返回要启动的服务的信息封装对象 ServiceLookupResult！</p>
<h3 id="2-2-2-ActiveServices-unscheduleServiceRestartLocked"><a href="#2-2-2-ActiveServices-unscheduleServiceRestartLocked" class="headerlink" title="2.2.2 ActiveServices.unscheduleServiceRestartLocked"></a>2.2.2 ActiveServices.unscheduleServiceRestartLocked</h3><p>如果服务此时已经在重启列表中了，就要取消这个任务！</p>
<p>参数传入：</p>
<ul>
<li>boolean force：传入 false<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">final</span> <span class="keyword">boolean</span> <span class="title">unscheduleServiceRestartLocked</span><span class="params">(ServiceRecord r, <span class="keyword">int</span> callingUid,</span></span></span><br><span class="line"><span class="function"><span class="params">        <span class="keyword">boolean</span> force)</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (!force &amp;&amp; r.restartDelay == <span class="number">0</span>) &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">false</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// Remove from the restarting list; if the service is currently on the</span></span><br><span class="line">    <span class="comment">// restarting list, or the call is coming from another app, then this</span></span><br><span class="line">    <span class="comment">// service has become of much more interest so we reset the restart interval.</span></span><br><span class="line">    <span class="keyword">boolean</span> removed = mRestartingServices.remove(r);</span><br><span class="line">    <span class="keyword">if</span> (removed || callingUid != r.appInfo.uid) &#123;</span><br><span class="line">        </span><br><span class="line">        <span class="comment">// 重置重启计数！</span></span><br><span class="line">        r.resetRestartCounter();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (removed) &#123;</span><br><span class="line">        clearRestartingIfNeededLocked(r);</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// 从 mAm.mHandler 中移除对一个的 ServiceStarter 对象！</span></span><br><span class="line">    c.removeCallbacks(r.restarter);</span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">true</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
</li>
</ul>
<p>因为当前服务要重新启动，所以之前的重启就要重置！</p>
<h3 id="2-2-3-ServiceRecord-retrieveAppBindingLocked"><a href="#2-2-3-ServiceRecord-retrieveAppBindingLocked" class="headerlink" title="2.2.3 ServiceRecord.retrieveAppBindingLocked"></a>2.2.3 ServiceRecord.retrieveAppBindingLocked</h3><p>这里是很关键的一段逻辑，创建了很多的对象，并相互引用：<br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 3、创建 AppBindRecord 对象，用来记录绑定到这个服务的应用的信息！</span></span><br><span class="line">AppBindRecord b = s.retrieveAppBindingLocked(service, callerApp);</span><br><span class="line"></span><br><span class="line"><span class="comment">// 创建 ConnectionRecord 对象，用来记录一个连接！</span></span><br><span class="line">ConnectionRecord c = <span class="keyword">new</span> ConnectionRecord(b, activity,</span><br><span class="line">        connection, flags, clientLabel, clientIntent);</span><br><span class="line"></span><br><span class="line"><span class="comment">// connection 是一个绑定者进程的 IServiceConnection.proxy 对象，和 InnerConnection 对应！！</span></span><br><span class="line">IBinder binder = connection.asBinder();</span><br><span class="line"></span><br><span class="line"><span class="comment">// s.connections 记录了这个服务的 IServiceConnection 和 ConnectionRecord 的对应关系！</span></span><br><span class="line">ArrayList&lt;ConnectionRecord&gt; clist = s.connections.get(binder);</span><br><span class="line"><span class="keyword">if</span> (clist == <span class="keyword">null</span>) &#123;</span><br><span class="line">    clist = <span class="keyword">new</span> ArrayList&lt;ConnectionRecord&gt;();</span><br><span class="line">    s.connections.put(binder, clist);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 将 ConnectionRecord 保存到 s.connections 中！</span></span><br><span class="line">clist.add(c);</span><br><span class="line"></span><br><span class="line"><span class="comment">// 将 ConnectionRecord 对象添加到对应的 AppBindRecord 的 connections 中！</span></span><br><span class="line">b.connections.add(c);</span><br><span class="line"></span><br><span class="line"><span class="comment">// 如果 activity 不为 null，说明是 Activity 执行的 bind，所以要把</span></span><br><span class="line"><span class="comment">// 添加到其 connections 中;</span></span><br><span class="line"><span class="keyword">if</span> (activity != <span class="keyword">null</span>) &#123;</span><br><span class="line">    <span class="keyword">if</span> (activity.connections == <span class="keyword">null</span>) &#123;</span><br><span class="line">        activity.connections = <span class="keyword">new</span> HashSet&lt;ConnectionRecord&gt;();</span><br><span class="line">    &#125;</span><br><span class="line">    activity.connections.add(c);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 将 ConnectionRecord 保存到调用者进程的 connections 列表中！</span></span><br><span class="line">b.client.connections.add(c);</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> ((c.flags&amp;Context.BIND_ABOVE_CLIENT) != <span class="number">0</span>) &#123;</span><br><span class="line">    b.client.hasAboveClient = <span class="keyword">true</span>;</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">if</span> ((c.flags&amp;Context.BIND_ALLOW_WHITELIST_MANAGEMENT) != <span class="number">0</span>) &#123;</span><br><span class="line">    s.whitelistManager = <span class="keyword">true</span>;</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">if</span> (s.app != <span class="keyword">null</span>) &#123;</span><br><span class="line">    updateServiceClientActivitiesLocked(s.app, c, <span class="keyword">true</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// mServiceConnections 是 AS 的成员变量，记录着 IServiceConnection 和其 ConnectionRecord 的对应关系！</span></span><br><span class="line">clist = mServiceConnections.get(binder);</span><br><span class="line"><span class="keyword">if</span> (clist == <span class="keyword">null</span>) &#123;</span><br><span class="line">    clist = <span class="keyword">new</span> ArrayList&lt;ConnectionRecord&gt;();</span><br><span class="line">    mServiceConnections.put(binder, clist);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">clist.add(c);</span><br></pre></td></tr></table></figure></p>
<p>这里调用了 ServiceRecord 的 retrieveAppBindingLocked 方法，参数 ProcessRecord app 表示绑定者所在的进程！<br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// in ServiceRecord</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> AppBindRecord <span class="title">retrieveAppBindingLocked</span><span class="params">(Intent intent,</span></span></span><br><span class="line"><span class="function"><span class="params">        ProcessRecord app)</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 首先，创建 FilterComparison 来封装启动 Intent！</span></span><br><span class="line">    <span class="comment">// 并获得其对应的 IntentBindRecord 对象，这里可以看到，多次 bindService，只会保存第一次的信息！</span></span><br><span class="line">    Intent.FilterComparison filter = <span class="keyword">new</span> Intent.FilterComparison(intent);</span><br><span class="line">    IntentBindRecord i = bindings.get(filter);</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// 创建对应的 IntentBindRecord 对象，将 FilterComparison 和 IntentBindRecord 的映射保存到 SR.bindings 中！</span></span><br><span class="line">    <span class="keyword">if</span> (i == <span class="keyword">null</span>) &#123;</span><br><span class="line">        i = <span class="keyword">new</span> IntentBindRecord(<span class="keyword">this</span>, filter);</span><br><span class="line">        bindings.put(filter, i);</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// 创建 AppBindRecord 对象！</span></span><br><span class="line">    AppBindRecord a = i.apps.get(app);</span><br><span class="line">    <span class="keyword">if</span> (a != <span class="keyword">null</span>) &#123;</span><br><span class="line">        <span class="keyword">return</span> a;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    a = <span class="keyword">new</span> AppBindRecord(<span class="keyword">this</span>, i, app);</span><br><span class="line">    i.apps.put(app, a);</span><br><span class="line">    <span class="keyword">return</span> a;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>这里会创建了一下如下对象 AppBindRecord，<strong>用来表示被绑定的 Service 和 bind 它的应用进程 ProcessRecord  的关系</strong>！<br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">final</span> <span class="class"><span class="keyword">class</span> <span class="title">AppBindRecord</span> </span>&#123;</span><br><span class="line">    <span class="keyword">final</span> ServiceRecord service;  <span class="comment">// 被 bind 的服务！</span></span><br><span class="line">    <span class="keyword">final</span> IntentBindRecord intent;    <span class="comment">// IntentBindRecord 对象</span></span><br><span class="line">    <span class="keyword">final</span> ProcessRecord client;  <span class="comment">// bind 发起端的进程！</span></span><br><span class="line">    <span class="keyword">final</span> ArraySet&lt;ConnectionRecord&gt; connections = <span class="keyword">new</span> ArraySet&lt;&gt;(); <span class="comment">// 连接到这个服务的所有 ConnectionRecord！</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>以及 IntentBindRecord 对象，<strong>用来表示绑定 Service 的 intent 的信息</strong>！<br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">final</span> <span class="class"><span class="keyword">class</span> <span class="title">IntentBindRecord</span> </span>&#123;</span><br><span class="line">    <span class="keyword">final</span> ServiceRecord service;  <span class="comment">// 被 bind 的服务！</span></span><br><span class="line">    <span class="keyword">final</span> Intent.FilterComparison intent; <span class="comment">// intent 封装类，等价于 intent！</span></span><br><span class="line">    </span><br><span class="line">    <span class="comment">// 用来托管所有使用这个 intent 来绑定服务的进程 ProcessRecord 和其 AppBindRecord 的映射关系！</span></span><br><span class="line">    <span class="keyword">final</span> ArrayMap&lt;ProcessRecord, AppBindRecord&gt; apps = <span class="keyword">new</span> ArrayMap&lt;ProcessRecord, AppBindRecord&gt;(); </span><br><span class="line">    IBinder binder; <span class="comment">// 当绑定 Service 成功后，onBind 会返回 Service 的“桩”，而这个 binder 是“桩”的客户端代理！</span></span><br><span class="line">    <span class="keyword">boolean</span> requested;</span><br><span class="line">    <span class="keyword">boolean</span> received;</span><br><span class="line">    <span class="keyword">boolean</span> hasBound;</span><br><span class="line">    <span class="keyword">boolean</span> doRebind;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>以及 ConnectionRecord 对象，<strong>用来表示绑定 Service 的 intent 的信息</strong>！！<br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">final</span> <span class="class"><span class="keyword">class</span> <span class="title">ConnectionRecord</span> </span>&#123;</span><br><span class="line">    <span class="keyword">final</span> AppBindRecord binding;    <span class="comment">// AppBindRecord 对象！</span></span><br><span class="line">    <span class="keyword">final</span> ActivityRecord activity;  <span class="comment">// bind 服务的 activity</span></span><br><span class="line">    <span class="keyword">final</span> IServiceConnection conn;  <span class="comment">// 来自 bind 端的 IServiceConnection.proxy 对象！</span></span><br><span class="line">    <span class="keyword">final</span> <span class="keyword">int</span> flags;                <span class="comment">// bindService 的第三个参数！</span></span><br><span class="line">    <span class="keyword">final</span> PendingIntent clientIntent; <span class="comment">// 发送的 intent！</span></span><br><span class="line">    <span class="keyword">boolean</span> serviceDead;            <span class="comment">// 表示服务是否死亡！</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>除此之外，在 ServiceRecord 中:<br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 所有活跃的 intent 和其对应的 IntentBindRecord 对象！</span></span><br><span class="line"><span class="keyword">final</span> ArrayMap&lt;Intent.FilterComparison, IntentBindRecord&gt; bindings</span><br><span class="line">        = <span class="keyword">new</span> ArrayMap&lt;Intent.FilterComparison, IntentBindRecord&gt;();</span><br><span class="line"> </span><br><span class="line"><span class="comment">// 所有 IServiceConnection 对象和其对应的 ArrayList&lt;ConnectionRecord&gt;&gt; 列表！                   </span></span><br><span class="line"><span class="keyword">final</span> ArrayMap&lt;IBinder, ArrayList&lt;ConnectionRecord&gt;&gt; connections</span><br><span class="line">        = <span class="keyword">new</span> ArrayMap&lt;IBinder, ArrayList&lt;ConnectionRecord&gt;&gt;();</span><br><span class="line">                        <span class="comment">// IBinder -&gt; ConnectionRecord of all bound clients</span></span><br></pre></td></tr></table></figure></p>
<p>以及在 ActiveServices 中:<br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">final</span> ArrayMap&lt;IBinder, ArrayList&lt;ConnectionRecord&gt;&gt; mServiceConnections = <span class="keyword">new</span> ArrayMap&lt;&gt;();</span><br></pre></td></tr></table></figure></p>
<p>这里我们用一张图来看下这几个数据结构间的关系；</p>
<p><img src="http://static.zybuluo.com/Coolqi/slum6gwlc12agci9vhvk0ula/%E7%B3%BB%E7%BB%9F%E8%BF%9B%E7%A8%8B%E4%B8%AD%E7%9A%84%E6%95%B0%E6%8D%AE%E7%BB%93%E6%9E%84%E5%85%B3%E7%B3%BB.png" alt="系统进程中的数据结构关系.png-467.2kB"></p>
<p>可以看到，引用关系很复杂，这也是方便 AMS 在调度时，更快的查询到数据！！</p>
<h2 id="2-3-AServices-bringUpServiceLocked"><a href="#2-3-AServices-bringUpServiceLocked" class="headerlink" title="2.3 AServices.bringUpServiceLocked"></a>2.3 AServices.bringUpServiceLocked</h2><p>上面的代码中， <strong>如果 flags 有设置 hasAutoCreateConnections 的话</strong>，会进入 bringUpServiceLocked 这个方法，这里和前面的 startService 很类似了，启动服务！</p>
<p>参数分析：</p>
<ul>
<li><strong>ServiceRecord r</strong>：服务的 ServiceRecord 对象；</li>
<li><strong>int intentFlags</strong>：启动服务的 intent 的 flag，通过 getFlags 获得；</li>
<li><strong>boolean execInFg</strong>：传入 callFg，表示本次启动是前台调用还是后台调用；</li>
<li><strong>boolean whileRestarting</strong>：表示是否是正在重启，传入 false；</li>
<li><strong>boolean permissionsReviewRequired</strong>：是否需要校验权限；</li>
</ul>
<p>我们这里<strong>假设 Service 所在的进程没有启动</strong>！</p>
<p>bringUpServiceLocked 的方法</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">private</span> String <span class="title">bringUpServiceLocked</span><span class="params">(ServiceRecord r, <span class="keyword">int</span> intentFlags, <span class="keyword">boolean</span> execInFg,</span></span></span><br><span class="line"><span class="function"><span class="params">        <span class="keyword">boolean</span> whileRestarting, <span class="keyword">boolean</span> permissionsReviewRequired)</span></span></span><br><span class="line"><span class="function">        <span class="keyword">throws</span> TransactionTooLargeException </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 如果服务所在的进程已经被启动，那就进入 sendServiceArgsLocked 方法，</span></span><br><span class="line">    <span class="comment">// 但对于 bind，这个方法是不会拉起 onStartCommand 方法的，原因下面说！</span></span><br><span class="line">    <span class="comment">// 对于 bindService，如果服务所在进程已经被拉起，条件为 true，这里不会继续往下执行！</span></span><br><span class="line">    <span class="keyword">if</span> (r.app != <span class="keyword">null</span> &amp;&amp; r.app.thread != <span class="keyword">null</span>) &#123;</span><br><span class="line">        sendServiceArgsLocked(r, execInFg, <span class="keyword">false</span>);</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">null</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (!whileRestarting &amp;&amp; r.restartDelay &gt; <span class="number">0</span>) &#123; <span class="comment">// 如果正在等待重启，就退出！</span></span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">null</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (DEBUG_SERVICE) Slog.v(TAG_SERVICE, <span class="string">"Bringing up "</span> + r + <span class="string">" "</span> + r.intent);</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 服务要被启动了，所以要从重启 mRestartingServices 列表中移除它，并清除内部的启动计数！</span></span><br><span class="line">    <span class="keyword">if</span> (mRestartingServices.remove(r)) &#123;</span><br><span class="line"></span><br><span class="line">        r.resetRestartCounter();</span><br><span class="line">        clearRestartingIfNeededLocked(r);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 如果这个服务是被延迟启动，即 delayed 为 true，那就立刻启动它，从 mDelayedStartList 中移除它，并置 delayed 为 false；</span></span><br><span class="line">    <span class="keyword">if</span> (r.delayed) &#123;</span><br><span class="line">        <span class="keyword">if</span> (DEBUG_DELAYED_STARTS) Slog.v(TAG_SERVICE, <span class="string">"REM FR DELAY LIST (bring up): "</span> + r);</span><br><span class="line">        getServiceMap(r.userId).mDelayedStartList.remove(r);</span><br><span class="line">        r.delayed = <span class="keyword">false</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 如果这个服务所在的设备用户没有被启动，那就不允许启动这个服务！</span></span><br><span class="line">    <span class="keyword">if</span> (!mAm.mUserController.hasStartedUserState(r.userId)) &#123;</span><br><span class="line">        String msg = <span class="string">"Unable to launch app "</span></span><br><span class="line">                + r.appInfo.packageName + <span class="string">"/"</span></span><br><span class="line">                + r.appInfo.uid + <span class="string">" for service "</span></span><br><span class="line">                + r.intent.getIntent() + <span class="string">": user "</span> + r.userId + <span class="string">" is stopped"</span>;</span><br><span class="line">        Slog.w(TAG, msg);</span><br><span class="line">        </span><br><span class="line">        <span class="comment">// 执行 bringDown 这个服务！</span></span><br><span class="line">        bringDownServiceLocked(r);</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> msg;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 服务将要被启动，所以要设置其 package 的停止状态为 false；</span></span><br><span class="line">        AppGlobals.getPackageManager().setPackageStoppedState(</span><br><span class="line">                r.packageName, <span class="keyword">false</span>, r.userId);</span><br><span class="line"></span><br><span class="line">    &#125; <span class="keyword">catch</span> (RemoteException e) &#123;</span><br><span class="line"></span><br><span class="line">    &#125; <span class="keyword">catch</span> (IllegalArgumentException e) &#123;</span><br><span class="line">        Slog.w(TAG, <span class="string">"Failed trying to unstop package "</span></span><br><span class="line">                + r.packageName + <span class="string">": "</span> + e);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 判断这个服务是否属于隔离进程；</span></span><br><span class="line">    <span class="keyword">final</span> <span class="keyword">boolean</span> isolated = (r.serviceInfo.flags&amp;ServiceInfo.FLAG_ISOLATED_PROCESS) != <span class="number">0</span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 获得要启动的服务的所在进程名；</span></span><br><span class="line">    <span class="keyword">final</span> String procName = r.processName;</span><br><span class="line">    ProcessRecord app;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (!isolated) &#123;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 对于非隔离进程，先获得所在进程的 ProcessRecord 对象；</span></span><br><span class="line">        app = mAm.getProcessRecordLocked(procName, r.appInfo.uid, <span class="keyword">false</span>);</span><br><span class="line">        </span><br><span class="line">        <span class="keyword">if</span> (DEBUG_MU) Slog.v(TAG_MU, <span class="string">"bringUpServiceLocked: appInfo.uid="</span> + r.appInfo.uid</span><br><span class="line">                    + <span class="string">" app="</span> + app);</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (app != <span class="keyword">null</span> &amp;&amp; app.thread != <span class="keyword">null</span>) &#123; <span class="comment">// 如果进程已经启动；</span></span><br><span class="line">            <span class="keyword">try</span> &#123;</span><br><span class="line">                app.addPackage(r.appInfo.packageName, r.appInfo.versionCode, mAm.mProcessStats);</span><br><span class="line">                </span><br><span class="line">                <span class="comment">//【1】启动指定服务！</span></span><br><span class="line">                realStartServiceLocked(r, app, execInFg);</span><br><span class="line"></span><br><span class="line">                <span class="keyword">return</span> <span class="keyword">null</span>;</span><br><span class="line">            &#125; <span class="keyword">catch</span> (TransactionTooLargeException e) &#123;</span><br><span class="line">                <span class="keyword">throw</span> e;</span><br><span class="line"></span><br><span class="line">            &#125; <span class="keyword">catch</span> (RemoteException e) &#123;</span><br><span class="line">                Slog.w(TAG, <span class="string">"Exception when starting service "</span> + r.shortName, e);</span><br><span class="line"></span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        app = r.isolatedProc;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 如果服务所在的进程没有启动！</span></span><br><span class="line">    <span class="keyword">if</span> (app == <span class="keyword">null</span> &amp;&amp; !permissionsReviewRequired) &#123;</span><br><span class="line">    </span><br><span class="line">        <span class="comment">//【2】首先要启动服务所在的进程，这里请去看进程启动和创建的博文！</span></span><br><span class="line">        <span class="keyword">if</span> ((app=mAm.startProcessLocked(procName, r.appInfo, <span class="keyword">true</span>, intentFlags,</span><br><span class="line">                <span class="string">"service"</span>, r.name, <span class="keyword">false</span>, isolated, <span class="keyword">false</span>)) == <span class="keyword">null</span>) &#123;</span><br><span class="line"></span><br><span class="line">            String msg = <span class="string">"Unable to launch app "</span></span><br><span class="line">                    + r.appInfo.packageName + <span class="string">"/"</span></span><br><span class="line">                    + r.appInfo.uid + <span class="string">" for service "</span></span><br><span class="line">                    + r.intent.getIntent() + <span class="string">": process is bad"</span>;</span><br><span class="line">            Slog.w(TAG, msg);</span><br><span class="line"></span><br><span class="line">            bringDownServiceLocked(r); <span class="comment">// 进程启动失败；</span></span><br><span class="line"></span><br><span class="line">            <span class="keyword">return</span> msg;</span><br><span class="line">        &#125;</span><br><span class="line">        </span><br><span class="line">        <span class="comment">// 如果服务要运行在隔离进程中，就把创建的 ProcessRecord 保存到 r.isolatedProc 中！</span></span><br><span class="line">        <span class="keyword">if</span> (isolated) &#123;</span><br><span class="line">            r.isolatedProc = app;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// 将这个服务加入到 mPendingServices 中，表示该服务正在其所在的进程启动；</span></span><br><span class="line">    <span class="keyword">if</span> (!mPendingServices.contains(r)) &#123;</span><br><span class="line">        mPendingServices.add(r);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (r.delayedStop) &#123; <span class="comment">// 如果服务需要被延迟停止，</span></span><br><span class="line"></span><br><span class="line">        <span class="comment">// Oh and hey we've already been asked to stop!</span></span><br><span class="line">        r.delayedStop = <span class="keyword">false</span>;</span><br><span class="line">        <span class="keyword">if</span> (r.startRequested) &#123;</span><br><span class="line">            <span class="keyword">if</span> (DEBUG_DELAYED_STARTS) Slog.v(TAG_SERVICE,</span><br><span class="line">                    <span class="string">"Applying delayed stop (in bring up): "</span> + r);</span><br><span class="line">            stopServiceLocked(r);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">null</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p><strong>注意</strong></p>
<p>bindService 时候，如果设置了 Context.BIND_AUTO_CREATE 标志，就会调用 bringUpServiceLocked 方法！</p>
<p>然而对应 bind 来说，是不会执行 sendServiceArgsLocked 方法中的逻辑，不会拉起服务的 onStartCommand 方法的！</p>
<p>因为只有 start 的方式，才会将启动项目 StartItem 添加到  ServiceRecord 的 pendingStarts 集合中，而对于 bind，pendingStarts 集合的大小始终为 0，所以不会继续执行的！！</p>
<p>同时，对于 bindService，如果服务所在的进程已经被拉起，那么 bringUpServiceLocked 方法会在 sendServiceArgsLocked 只会返回，不会执行下面的逻辑，而是返回 bindServiceLocked ，继续往下执行！！</p>
<p><strong>方法流程总结</strong></p>
<p>1、如果已经启动，就会进入 realStartServiceLocked 方法，启动服务！<br>2、如果没有启动，就会 startProcessLocked 先启动服务所在进程，，最后进入 attachApplicationLocked 方法。然后还是会进入 realStartServiceLocked ！</p>
<p>所以最终调用的是 realStartServiceLocked 方法，它会拉起 Service 的 onCreate、onBind 方法！</p>
<p>这里我们先假设，服务所在的进程，还没有被启动！！！！</p>
<h2 id="2-4-ActivityManagerS-attachApplicationLocked"><a href="#2-4-ActivityManagerS-attachApplicationLocked" class="headerlink" title="2.4 ActivityManagerS.attachApplicationLocked"></a>2.4 ActivityManagerS.attachApplicationLocked</h2><p>当应用进程启动后，会通过 Binder 通信，调用 AMS.attachApplicationLocked，我们去看看：<br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">final</span> <span class="keyword">boolean</span> <span class="title">attachApplicationLocked</span><span class="params">(IApplicationThread thread,</span></span></span><br><span class="line"><span class="function"><span class="params">        <span class="keyword">int</span> pid)</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">        ... ... ... ...</span><br><span class="line">        </span><br><span class="line">        <span class="comment">// 这里会回到应用进程中，创建 Applicaiton 对象，并调用其 onCreate 方法，这里我们不看！</span></span><br><span class="line">        thread.bindApplication(processName, appInfo, providers, app.instrumentationClass,</span><br><span class="line">                profilerInfo, app.instrumentationArguments, app.instrumentationWatcher,</span><br><span class="line">                app.instrumentationUiAutomationConnection, testMode,</span><br><span class="line">                mBinderTransactionTrackingEnabled, enableTrackAllocation,</span><br><span class="line">                isRestrictedBackupMode || !normalMode, app.persistent,</span><br><span class="line">                <span class="keyword">new</span> Configuration(mConfiguration), app.compat,</span><br><span class="line">                getCommonServicesLocked(app.isolated),</span><br><span class="line">                mCoreSettingsObserver.getCoreSettingsLocked());</span><br><span class="line">        </span><br><span class="line">        <span class="comment">// 更新进程 LRU 队列！</span></span><br><span class="line">        updateLruProcessLocked(app, <span class="keyword">false</span>, <span class="keyword">null</span>);</span><br><span class="line"></span><br><span class="line">        app.lastRequestedGc = app.lastLowMemory = SystemClock.uptimeMillis();</span><br><span class="line">    &#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">        app.resetPackageList(mProcessStats);</span><br><span class="line">        app.unlinkDeathRecipient();</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 每当 bindApplication 操作失败，则重新启动进程, 此处有可能会导致进程无限重启。</span></span><br><span class="line">        startProcessLocked(app, <span class="string">"bind fail"</span>, processName);</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">false</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 将当前已经被启动的新进程的 ProcessRecord 从正在启动的进程集合 mPersistentStartingProcesses</span></span><br><span class="line">    <span class="comment">// 和等待启动的进程集合 mProcessesOnHold 中移除！</span></span><br><span class="line">    mPersistentStartingProcesses.remove(app);</span><br><span class="line">    mProcessesOnHold.remove(app);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">boolean</span> badApp = <span class="keyword">false</span>;</span><br><span class="line">    <span class="keyword">boolean</span> didSomething = <span class="keyword">false</span>;</span><br><span class="line"></span><br><span class="line">    ... ... ... ...</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (!badApp) &#123;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line"></span><br><span class="line">             <span class="comment">// 检查是否有 service 组件要在这个新进程中运行！</span></span><br><span class="line">            didSomething |= mServices.attachApplicationLocked(app, processName);</span><br><span class="line">        &#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">            Slog.wtf(TAG, <span class="string">"Exception thrown starting services in "</span> + app, e);</span><br><span class="line">            badApp = <span class="keyword">true</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    ... ... ... ...</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (badApp) &#123; <span class="comment">// badApp 为 true，就杀掉这个进程</span></span><br><span class="line">        app.kill(<span class="string">"error during init"</span>, <span class="keyword">true</span>);</span><br><span class="line">        handleAppDiedLocked(app, <span class="keyword">false</span>, <span class="keyword">true</span>);</span><br><span class="line">        </span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">false</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (!didSomething) &#123; <span class="comment">// 检查后发现，没有任何组件要运行在新进程，更新 OomAdj 的值！</span></span><br><span class="line">        updateOomAdjLocked();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">true</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>bindApplication 方法会回到应用进程中，创建 Applicaiton 对象，并调用其 onCreate 方法，这里我们不关注！！</p>
<p>这里会调用 ActiveServices 的 attachApplicationLocked 方法！</p>
<h2 id="2-5-ActiveServices-attachApplicationLocked"><a href="#2-5-ActiveServices-attachApplicationLocked" class="headerlink" title="2.5 ActiveServices.attachApplicationLocked"></a>2.5 ActiveServices.attachApplicationLocked</h2><p>当应用进程启动成功，并且 Application 对象已经创建，其 onCreate 方法已经调用后，就要启动指定的服务了！<br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">boolean</span> <span class="title">attachApplicationLocked</span><span class="params">(ProcessRecord proc, String processName)</span></span></span><br><span class="line"><span class="function">        <span class="keyword">throws</span> RemoteException </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">boolean</span> didSomething = <span class="keyword">false</span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 还记得 mPendingServices 吗？这里面保存着所有正在等待其所在的进程启动的服务！</span></span><br><span class="line">    <span class="keyword">if</span> (mPendingServices.size() &gt; <span class="number">0</span>) &#123;</span><br><span class="line">        ServiceRecord sr = <span class="keyword">null</span>;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line"></span><br><span class="line">            <span class="comment">// 遍历 mPendingServices 集合中的所有服务，启动属于这个进程的所有服务！</span></span><br><span class="line">            <span class="keyword">for</span> (<span class="keyword">int</span> i=<span class="number">0</span>; i&lt;mPendingServices.size(); i++) &#123;</span><br><span class="line">                sr = mPendingServices.get(i);</span><br><span class="line"></span><br><span class="line">                <span class="keyword">if</span> (proc != sr.isolatedProc &amp;&amp; (proc.uid != sr.appInfo.uid</span><br><span class="line">                        || !processName.equals(sr.processName))) &#123;</span><br><span class="line">                    <span class="keyword">continue</span>;</span><br><span class="line">                &#125;</span><br><span class="line"></span><br><span class="line">                mPendingServices.remove(i);</span><br><span class="line"></span><br><span class="line">                i--;</span><br><span class="line">                </span><br><span class="line">                <span class="comment">// 将服务的包名，版本号以及 AMS 的进程状态对象保存到进程对象中！</span></span><br><span class="line">                proc.addPackage(sr.appInfo.packageName, sr.appInfo.versionCode,</span><br><span class="line">                        mAm.mProcessStats);</span><br><span class="line">                </span><br><span class="line">                <span class="comment">//【1】启动服务，这里又回到了之前的方法中！</span></span><br><span class="line">                realStartServiceLocked(sr, proc, sr.createdFromFg);</span><br><span class="line"></span><br><span class="line">                didSomething = <span class="keyword">true</span>;</span><br><span class="line"></span><br><span class="line">                <span class="keyword">if</span> (!isServiceNeeded(sr, <span class="keyword">false</span>, <span class="keyword">false</span>)) &#123;</span><br><span class="line"></span><br><span class="line">                    bringDownServiceLocked(sr);</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125; <span class="keyword">catch</span> (RemoteException e) &#123;</span><br><span class="line">            Slog.w(TAG, <span class="string">"Exception in new application when starting service "</span></span><br><span class="line">                    + sr.shortName, e);</span><br><span class="line">            <span class="keyword">throw</span> e;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 接着启动那些需要重启的服务，重启的服务都会保存到 mRestartingServices 服务中！</span></span><br><span class="line">    <span class="comment">// 因为重启的时间可能还没有到，所以这里并不是立刻启动它们，而是启动了一个任务，交给了 AMS 的 MainHandler 去做！</span></span><br><span class="line">    <span class="keyword">if</span> (mRestartingServices.size() &gt; <span class="number">0</span>) &#123;</span><br><span class="line">        ServiceRecord sr;</span><br><span class="line">        <span class="keyword">for</span> (<span class="keyword">int</span> i=<span class="number">0</span>; i&lt;mRestartingServices.size(); i++) &#123;</span><br><span class="line">            sr = mRestartingServices.get(i);</span><br><span class="line">            <span class="keyword">if</span> (proc != sr.isolatedProc &amp;&amp; (proc.uid != sr.appInfo.uid</span><br><span class="line">                    || !processName.equals(sr.processName))) &#123;</span><br><span class="line">                <span class="keyword">continue</span>;</span><br><span class="line">            &#125;</span><br><span class="line">            mAm.mHandler.removeCallbacks(sr.restarter);</span><br><span class="line">            mAm.mHandler.post(sr.restarter);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> didSomething;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>这里最终又回到了 realStartServiceLocked 方法！</p>
<h2 id="2-6-AS-realStartServiceLocked"><a href="#2-6-AS-realStartServiceLocked" class="headerlink" title="2.6 AS.realStartServiceLocked"></a>2.6 AS.realStartServiceLocked</h2><p>对于非隔离的进程，最后都会通过调用 realStartServiceLocked 方法来启动进程中的指定服务：<br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">final</span> <span class="keyword">void</span> <span class="title">realStartServiceLocked</span><span class="params">(ServiceRecord r,</span></span></span><br><span class="line"><span class="function"><span class="params">        ProcessRecord app, <span class="keyword">boolean</span> execInFg)</span> <span class="keyword">throws</span> RemoteException </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (app.thread == <span class="keyword">null</span>) &#123;</span><br><span class="line">        <span class="keyword">throw</span> <span class="keyword">new</span> RemoteException();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (DEBUG_MU)</span><br><span class="line">        Slog.v(TAG_MU, <span class="string">"realStartServiceLocked, ServiceRecord.uid = "</span> + r.appInfo.uid</span><br><span class="line">                + <span class="string">", ProcessRecord.uid = "</span> + app.uid);</span><br><span class="line">                </span><br><span class="line">    <span class="comment">// 跟新活跃时间！</span></span><br><span class="line">    r.app = app;</span><br><span class="line">    r.restartTime = r.lastActivity = SystemClock.uptimeMillis();</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// 将被启动服务的 ServiceRecord 对象添加到所属进程的 app.services 中！</span></span><br><span class="line">    <span class="comment">// 如果本次启动的是一个新的服务，newService 值为 true！</span></span><br><span class="line">    <span class="keyword">final</span> <span class="keyword">boolean</span> newService = app.services.add(r);</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// 针对 onCreate 方法，设置超时处理！</span></span><br><span class="line">    bumpServiceExecutingLocked(r, execInFg, <span class="string">"create"</span>);</span><br><span class="line"> </span><br><span class="line">    <span class="comment">// 更新 LruProcess 和 OomAdj！</span></span><br><span class="line">    mAm.updateLruProcessLocked(app, <span class="keyword">false</span>, <span class="keyword">null</span>);</span><br><span class="line">    mAm.updateOomAdjLocked();</span><br><span class="line"></span><br><span class="line">    <span class="keyword">boolean</span> created = <span class="keyword">false</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (LOG_SERVICE_START_STOP) &#123; <span class="comment">// log 相关！</span></span><br><span class="line">            String nameTerm;</span><br><span class="line">            <span class="keyword">int</span> lastPeriod = r.shortName.lastIndexOf(<span class="string">'.'</span>);</span><br><span class="line">            nameTerm = lastPeriod &gt;= <span class="number">0</span> ? r.shortName.substring(lastPeriod) : r.shortName;</span><br><span class="line">            EventLogTags.writeAmCreateService(</span><br><span class="line">                    r.userId, System.identityHashCode(r), nameTerm, r.app.uid, r.app.pid);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">synchronized</span> (r.stats.getBatteryStats()) &#123;</span><br><span class="line">            r.stats.startLaunchedLocked();</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        mAm.notifyPackageUse(r.serviceInfo.packageName,</span><br><span class="line">                             PackageManager.NOTIFY_PACKAGE_USE_SERVICE);</span><br><span class="line"></span><br><span class="line">        app.forceProcessStateUpTo(ActivityManager.PROCESS_STATE_SERVICE);</span><br><span class="line">        </span><br><span class="line">        <span class="comment">//【1】通过 binder 通信，拉起服务的 onCreate 方法！</span></span><br><span class="line">        app.thread.scheduleCreateService(r, r.serviceInfo,</span><br><span class="line">                mAm.compatibilityInfoForPackageLocked(r.serviceInfo.applicationInfo),</span><br><span class="line">                app.repProcState);</span><br><span class="line"></span><br><span class="line">        r.postNotification();</span><br><span class="line">        </span><br><span class="line">        <span class="comment">// 启动成功的话，置 created 为 true 方法；</span></span><br><span class="line">        created = <span class="keyword">true</span>;</span><br><span class="line"></span><br><span class="line">    &#125; <span class="keyword">catch</span> (DeadObjectException e) &#123;</span><br><span class="line">        Slog.w(TAG, <span class="string">"Application dead when creating service "</span> + r);</span><br><span class="line">        mAm.appDiedLocked(app); <span class="comment">// 如果在服务启动时，应用进程死了，调用 appDiedLocked 通知死亡仆告对象！</span></span><br><span class="line">        <span class="keyword">throw</span> e;</span><br><span class="line"></span><br><span class="line">    &#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">        <span class="keyword">if</span> (!created) &#123; <span class="comment">// 如果启动失败，并且不是一个被销毁的服务，那就尝试重启他！</span></span><br><span class="line"></span><br><span class="line">            <span class="keyword">final</span> <span class="keyword">boolean</span> inDestroying = mDestroyingServices.contains(r);</span><br><span class="line">            serviceDoneExecutingLocked(r, inDestroying, inDestroying);</span><br><span class="line"></span><br><span class="line">            <span class="keyword">if</span> (newService) &#123;</span><br><span class="line">                app.services.remove(r);</span><br><span class="line">                r.app = <span class="keyword">null</span>;</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            <span class="keyword">if</span> (!inDestroying) &#123;</span><br><span class="line">                scheduleServiceRestartLocked(r, <span class="keyword">false</span>);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (r.whitelistManager) &#123;</span><br><span class="line">        app.whitelistManager = <span class="keyword">true</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//【2】执行 bind 操作，这里会拉起服务的 onBind 方法！！</span></span><br><span class="line">    requestServiceBindingsLocked(r, execInFg);</span><br><span class="line"></span><br><span class="line">    updateServiceClientActivitiesLocked(app, <span class="keyword">null</span>, <span class="keyword">true</span>);</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 注意 startRequested 只有在 startService 的情况下被置为 true，所以这里是不会添加启动项的！</span></span><br><span class="line">    <span class="comment">// 即：r.pendingStarts 的大小为 0！！</span></span><br><span class="line">    <span class="keyword">if</span> (r.startRequested &amp;&amp; r.callStart &amp;&amp; r.pendingStarts.size() == <span class="number">0</span>) &#123;</span><br><span class="line">        r.pendingStarts.add(<span class="keyword">new</span> ServiceRecord.StartItem(r, <span class="keyword">false</span>, r.makeNextStartId(),</span><br><span class="line">                <span class="keyword">null</span>, <span class="keyword">null</span>));</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// 这里也不会拉起 Service 的 onSrartCommand 方法，原因是 ：r.pendingStarts 的大小为 0，找不到启动项！！</span></span><br><span class="line">    sendServiceArgsLocked(r, execInFg, <span class="keyword">true</span>);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (r.delayed) &#123;</span><br><span class="line">        <span class="keyword">if</span> (DEBUG_DELAYED_STARTS) Slog.v(TAG_SERVICE, <span class="string">"REM FR DELAY LIST (new proc): "</span> + r);</span><br><span class="line">        getServiceMap(r.userId).mDelayedStartList.remove(r);</span><br><span class="line">        r.delayed = <span class="keyword">false</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (r.delayedStop) &#123;</span><br><span class="line">        r.delayedStop = <span class="keyword">false</span>;</span><br><span class="line">        <span class="keyword">if</span> (r.startRequested) &#123;</span><br><span class="line">            <span class="keyword">if</span> (DEBUG_DELAYED_STARTS) Slog.v(TAG_SERVICE,</span><br><span class="line">                    <span class="string">"Applying delayed stop (from start): "</span> + r);</span><br><span class="line">            stopServiceLocked(r);</span><br><span class="line"></span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p><strong>注意</strong>：<br>startRequested 只有在 startService 的情况下被置为 true，所以这里是不会添加启动项的！所以 sendServiceArgsLocked 也不会拉起  Service 的 onSrartCommand 方法，原因是 ：r.pendingStarts 的大小为 0，找不到启动项！！</p>
<p>这就要进入 requestServiceBindingsLocked 方法了！！！</p>
<h3 id="2-6-1-ApplicationThreadP-scheduleCreateService"><a href="#2-6-1-ApplicationThreadP-scheduleCreateService" class="headerlink" title="2.6.1 ApplicationThreadP.scheduleCreateService"></a>2.6.1 ApplicationThreadP.scheduleCreateService</h3><p>这里首先会拉起 Serivce 的 onCreate 方法！<br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">ApplicationThreadProxy</span> <span class="keyword">implements</span> <span class="title">IApplicationThread</span> </span>&#123;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">final</span> <span class="keyword">void</span> <span class="title">scheduleCreateService</span><span class="params">(IBinder token, ServiceInfo info,</span></span></span><br><span class="line"><span class="function"><span class="params">            CompatibilityInfo compatInfo, <span class="keyword">int</span> processState)</span> <span class="keyword">throws</span> RemoteException </span>&#123;</span><br><span class="line"></span><br><span class="line">        Parcel data = Parcel.obtain();</span><br><span class="line">        data.writeInterfaceToken(IApplicationThread.descriptor);</span><br><span class="line">        data.writeStrongBinder(token);</span><br><span class="line">        info.writeToParcel(data, <span class="number">0</span>);</span><br><span class="line">        compatInfo.writeToParcel(data, <span class="number">0</span>);</span><br><span class="line">        data.writeInt(processState);</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            </span><br><span class="line">            <span class="comment">// 通过 Binder 通信！</span></span><br><span class="line">            mRemote.transact(SCHEDULE_CREATE_SERVICE_TRANSACTION, data, <span class="keyword">null</span>,</span><br><span class="line">                    IBinder.FLAG_ONEWAY);</span><br><span class="line"></span><br><span class="line">        &#125; <span class="keyword">catch</span> (TransactionTooLargeException e) &#123;</span><br><span class="line">            Log.e(<span class="string">"CREATE_SERVICE"</span>, <span class="string">"Binder failure starting service; service="</span> + info);</span><br><span class="line">            <span class="keyword">throw</span> e;</span><br><span class="line">        &#125;</span><br><span class="line">        data.recycle();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>进入应用进程，下面再看！！</p>
<h3 id="2-6-2-ActiveServices-requestServiceBindingsLocked"><a href="#2-6-2-ActiveServices-requestServiceBindingsLocked" class="headerlink" title="2.6.2 ActiveServices.requestServiceBindingsLocked"></a>2.6.2 ActiveServices.requestServiceBindingsLocked</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">final</span> <span class="keyword">void</span> <span class="title">requestServiceBindingsLocked</span><span class="params">(ServiceRecord r, <span class="keyword">boolean</span> execInFg)</span></span></span><br><span class="line"><span class="function">        <span class="keyword">throws</span> TransactionTooLargeException </span>&#123;</span><br><span class="line">        </span><br><span class="line">    <span class="comment">// 遍历 r.bindings！</span></span><br><span class="line">    <span class="keyword">for</span> (<span class="keyword">int</span> i=r.bindings.size()-<span class="number">1</span>; i&gt;=<span class="number">0</span>; i--) &#123;</span><br><span class="line">        IntentBindRecord ibr = r.bindings.valueAt(i);</span><br><span class="line">        </span><br><span class="line">        <span class="comment">// 【1】请求 bind 操作，默认 rebind 为 false！</span></span><br><span class="line">        <span class="keyword">if</span> (!requestServiceBindingLocked(r, ibr, execInFg, <span class="keyword">false</span>)) &#123;</span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>这里会遍历 r.bindings 集合，还记得这个集合吗？这个集合保存这个 bind 的 intent 和 IntentBindRecord 之间的映射关系，只有 bindService 的情况下，该集合才会有元素，startService 的情况下，该集合的 size 为 0，这就解释了 startService 为什么不会执行该方法了！！</p>
<p>继续来看！！</p>
<h4 id="2-6-2-1-ActiveServices-requestServiceBindingLocked"><a href="#2-6-2-1-ActiveServices-requestServiceBindingLocked" class="headerlink" title="2.6.2.1 ActiveServices.requestServiceBindingLocked"></a>2.6.2.1 ActiveServices.requestServiceBindingLocked</h4><p>参数传入：</p>
<ul>
<li>boolean rebind：表示是否重新 bind，这里传入的是 false！</li>
</ul>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">final</span> <span class="keyword">boolean</span> <span class="title">requestServiceBindingLocked</span><span class="params">(ServiceRecord r, IntentBindRecord i,</span></span></span><br><span class="line"><span class="function"><span class="params">        <span class="keyword">boolean</span> execInFg, <span class="keyword">boolean</span> rebind)</span> <span class="keyword">throws</span> TransactionTooLargeException </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (r.app == <span class="keyword">null</span> || r.app.thread == <span class="keyword">null</span>) &#123;</span><br><span class="line">        <span class="comment">// 如果服务没有运行，那就会退出！</span></span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">false</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// 这里 i.requested 和 rebind 均为 false， i.apps.size() 也是大于 0 的！</span></span><br><span class="line">    <span class="keyword">if</span> ((!i.requested || rebind) &amp;&amp; i.apps.size() &gt; <span class="number">0</span>) &#123;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            </span><br><span class="line">            <span class="comment">// 为 bind 操作设置超时消息处理！！</span></span><br><span class="line">            bumpServiceExecutingLocked(r, execInFg, <span class="string">"bind"</span>);</span><br><span class="line">            </span><br><span class="line">            <span class="comment">// 将服务所在的进程状态更新为 ActivityManager.PROCESS_STATE_SERVICE！</span></span><br><span class="line">            r.app.forceProcessStateUpTo(ActivityManager.PROCESS_STATE_SERVICE);</span><br><span class="line">            </span><br><span class="line">            <span class="comment">// 【1】执行 bind 操作，跨进程拉起应用的 onBind 方法！</span></span><br><span class="line">            r.app.thread.scheduleBindService(r, i.intent.getIntent(), rebind,</span><br><span class="line">                    r.app.repProcState);</span><br><span class="line">            </span><br><span class="line">            <span class="comment">// 对于 bindService，因为 rebind 为 false，所以这里会把 requested 置为 true！</span></span><br><span class="line">            <span class="keyword">if</span> (!rebind) &#123;</span><br><span class="line">                i.requested = <span class="keyword">true</span>;</span><br><span class="line">            &#125;</span><br><span class="line">            </span><br><span class="line">            <span class="comment">// 将 i.hasBound 置为 true，表示已经调用了</span></span><br><span class="line">            i.hasBound = <span class="keyword">true</span>;</span><br><span class="line">            i.doRebind = <span class="keyword">false</span>;</span><br><span class="line"></span><br><span class="line">        &#125; <span class="keyword">catch</span> (TransactionTooLargeException e) &#123;</span><br><span class="line"></span><br><span class="line">            <span class="comment">// Keep the executeNesting count accurate.</span></span><br><span class="line">            <span class="keyword">if</span> (DEBUG_SERVICE) Slog.v(TAG_SERVICE, <span class="string">"Crashed while binding "</span> + r, e);</span><br><span class="line">            <span class="keyword">final</span> <span class="keyword">boolean</span> inDestroying = mDestroyingServices.contains(r);</span><br><span class="line">            serviceDoneExecutingLocked(r, inDestroying, inDestroying);</span><br><span class="line">            <span class="keyword">throw</span> e;</span><br><span class="line">        &#125; <span class="keyword">catch</span> (RemoteException e) &#123;</span><br><span class="line"></span><br><span class="line">            <span class="keyword">if</span> (DEBUG_SERVICE) Slog.v(TAG_SERVICE, <span class="string">"Crashed while binding "</span> + r);</span><br><span class="line">            <span class="comment">// Keep the executeNesting count accurate.</span></span><br><span class="line">            <span class="keyword">final</span> <span class="keyword">boolean</span> inDestroying = mDestroyingServices.contains(r);</span><br><span class="line">            serviceDoneExecutingLocked(r, inDestroying, inDestroying);</span><br><span class="line">            <span class="keyword">return</span> <span class="keyword">false</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">true</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>thread 是 ApplicationThreadProxy 代理对象！！</p>
<h4 id="2-6-2-2-ApplicationThreadP-scheduleBindService"><a href="#2-6-2-2-ApplicationThreadP-scheduleBindService" class="headerlink" title="2.6.2.2 ApplicationThreadP.scheduleBindService"></a>2.6.2.2 ApplicationThreadP.scheduleBindService</h4><p>这里的 IBinder token 是 ServiceRecord 对象!!<br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">final</span> <span class="keyword">void</span> <span class="title">scheduleBindService</span><span class="params">(IBinder token, Intent intent, <span class="keyword">boolean</span> rebind,</span></span></span><br><span class="line"><span class="function"><span class="params">        <span class="keyword">int</span> processState)</span> <span class="keyword">throws</span> RemoteException </span>&#123;</span><br><span class="line">    Parcel data = Parcel.obtain();</span><br><span class="line">    data.writeInterfaceToken(IApplicationThread.descriptor);</span><br><span class="line">    data.writeStrongBinder(token);</span><br><span class="line">    intent.writeToParcel(data, <span class="number">0</span>);</span><br><span class="line">    data.writeInt(rebind ? <span class="number">1</span> : <span class="number">0</span>);</span><br><span class="line">    data.writeInt(processState);</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// binder 通信！</span></span><br><span class="line">    mRemote.transact(SCHEDULE_BIND_SERVICE_TRANSACTION, data, <span class="keyword">null</span>,</span><br><span class="line">            IBinder.FLAG_ONEWAY);</span><br><span class="line">    data.recycle();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>可以看到，拉起服务的 onCreate 方法和 onBind 方法的 binder 通信都是 IBinder.FLAG_ONEWAY 的！也就是说 Binder 服务端无需等待 BInder 客户端的操作返回结果，只要 Binder 客户端一收到 Binder服务端传送的命令和数据后，Binder 服务端会立即向下执行！</p>
<p>下面，进入被绑定者进程！</p>
<h1 id="3-被绑定者进程"><a href="#3-被绑定者进程" class="headerlink" title="3 被绑定者进程"></a>3 被绑定者进程</h1><h2 id="3-1-ApplicationThread-scheduleCreateService"><a href="#3-1-ApplicationThread-scheduleCreateService" class="headerlink" title="3.1 ApplicationThread.scheduleCreateService"></a>3.1 ApplicationThread.scheduleCreateService</h2><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">final</span> <span class="keyword">void</span> <span class="title">scheduleCreateService</span><span class="params">(IBinder token,</span></span></span><br><span class="line"><span class="function"><span class="params">        ServiceInfo info, CompatibilityInfo compatInfo, <span class="keyword">int</span> processState)</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    updateProcessState(processState, <span class="keyword">false</span>);</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// 创建了一个 CreateServiceData 对象！</span></span><br><span class="line">    CreateServiceData s = <span class="keyword">new</span> CreateServiceData();</span><br><span class="line"></span><br><span class="line">    s.token = token;</span><br><span class="line">    s.info = info;</span><br><span class="line">    s.compatInfo = compatInfo;</span><br><span class="line"></span><br><span class="line">    sendMessage(H.CREATE_SERVICE, s);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>这里和 startService 一样，不多说了！</p>
<h2 id="3-2-ApplicationThread-scheduleBindService"><a href="#3-2-ApplicationThread-scheduleBindService" class="headerlink" title="3.2 ApplicationThread.scheduleBindService"></a>3.2 ApplicationThread.scheduleBindService</h2><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">final</span> <span class="keyword">void</span> <span class="title">scheduleBindService</span><span class="params">(IBinder token, Intent intent,</span></span></span><br><span class="line"><span class="function"><span class="params">        <span class="keyword">boolean</span> rebind, <span class="keyword">int</span> processState)</span> </span>&#123;</span><br><span class="line">    updateProcessState(processState, <span class="keyword">false</span>);</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// 创建了一个 BindServiceData 对象！</span></span><br><span class="line">    BindServiceData s = <span class="keyword">new</span> BindServiceData();</span><br><span class="line">    s.token = token;</span><br><span class="line">    s.intent = intent;</span><br><span class="line">    s.rebind = rebind;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (DEBUG_SERVICE)</span><br><span class="line">        Slog.v(TAG, <span class="string">"scheduleBindService token="</span> + token + <span class="string">" intent="</span> + intent + <span class="string">" uid="</span></span><br><span class="line">                + Binder.getCallingUid() + <span class="string">" pid="</span> + Binder.getCallingPid());</span><br><span class="line"></span><br><span class="line">    sendMessage(H.BIND_SERVICE, s);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>这里创建了一个 BindServiceData 对象！<br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">static</span> <span class="keyword">final</span> <span class="class"><span class="keyword">class</span> <span class="title">BindServiceData</span> </span>&#123;</span><br><span class="line">    IBinder token;</span><br><span class="line">    Intent intent;</span><br><span class="line">    <span class="keyword">boolean</span> rebind;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> String <span class="title">toString</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="string">"BindServiceData&#123;token="</span> + token + <span class="string">" intent="</span> + intent + <span class="string">"&#125;"</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>很简单，不多说了！</p>
<p>接着，发送 H.BIND_SERVICE 方法，进入主线程的 Handler！</p>
<h2 id="3-3-ActivityThread-H"><a href="#3-3-ActivityThread-H" class="headerlink" title="3.3 ActivityThread.H"></a>3.3 ActivityThread.H</h2><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">private</span> <span class="class"><span class="keyword">class</span> <span class="title">H</span> <span class="keyword">extends</span> <span class="title">Handler</span> </span>&#123;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">handleMessage</span><span class="params">(Message msg)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">if</span> (DEBUG_MESSAGES) Slog.v(TAG, <span class="string">"&gt;&gt;&gt; handling: "</span> + codeToString(msg.what));</span><br><span class="line">        <span class="keyword">switch</span> (msg.what) &#123;</span><br><span class="line">            </span><br><span class="line">            <span class="comment">// 这里是处理 create service 消息；</span></span><br><span class="line">            <span class="keyword">case</span> CREATE_SERVICE:</span><br><span class="line">                Trace.traceBegin(Trace.TRACE_TAG_ACTIVITY_MANAGER, (<span class="string">"serviceCreate: "</span> + String.valueOf(msg.obj)));</span><br><span class="line">                </span><br><span class="line">                handleCreateService((CreateServiceData)msg.obj);</span><br><span class="line">                </span><br><span class="line">                Trace.traceEnd(Trace.TRACE_TAG_ACTIVITY_MANAGER);</span><br><span class="line">                <span class="keyword">break</span>;</span><br><span class="line">                </span><br><span class="line">            <span class="comment">// 这里是处理 bind service 消息；</span></span><br><span class="line">            <span class="keyword">case</span> BIND_SERVICE:</span><br><span class="line">                Trace.traceBegin(Trace.TRACE_TAG_ACTIVITY_MANAGER, <span class="string">"serviceBind"</span>);</span><br><span class="line">                </span><br><span class="line">                handleBindService((BindServiceData)msg.obj);</span><br><span class="line">                </span><br><span class="line">                Trace.traceEnd(Trace.TRACE_TAG_ACTIVITY_MANAGER);</span><br><span class="line">                <span class="keyword">break</span>;</span><br><span class="line">  </span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        Object obj = msg.obj;</span><br><span class="line">        <span class="keyword">if</span> (obj <span class="keyword">instanceof</span> SomeArgs) &#123;</span><br><span class="line">            ((SomeArgs) obj).recycle();</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (DEBUG_MESSAGES) Slog.v(TAG, <span class="string">"&lt;&lt;&lt; done: "</span> + codeToString(msg.what));</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>不多说了！！</p>
<h3 id="3-3-1-ActivityThread-handleCreateService"><a href="#3-3-1-ActivityThread-handleCreateService" class="headerlink" title="3.3.1 ActivityThread.handleCreateService"></a>3.3.1 ActivityThread.handleCreateService</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">handleCreateService</span><span class="params">(CreateServiceData data)</span> </span>&#123;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// 如果此时准备要 GC，那就跳过本次 GC！</span></span><br><span class="line">    unscheduleGcIdler();</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// 获得应用程序的加载信息，先会从缓存中获取，找不到才创建；</span></span><br><span class="line">    LoadedApk packageInfo = getPackageInfoNoCheck(</span><br><span class="line">            data.info.applicationInfo, data.compatInfo);</span><br><span class="line"></span><br><span class="line">    Service service = <span class="keyword">null</span>;</span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">    </span><br><span class="line">        <span class="comment">// 通过反射创建要启动的服务的实例；</span></span><br><span class="line">        java.lang.ClassLoader cl = packageInfo.getClassLoader();</span><br><span class="line">        service = (Service) cl.loadClass(data.info.name).newInstance();</span><br><span class="line"></span><br><span class="line">    &#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">        <span class="keyword">if</span> (!mInstrumentation.onException(service, e)) &#123;</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> RuntimeException(</span><br><span class="line">                <span class="string">"Unable to instantiate service "</span> + data.info.name</span><br><span class="line">                + <span class="string">": "</span> + e.toString(), e);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">        <span class="keyword">if</span> (localLOGV) Slog.v(TAG, <span class="string">"Creating service "</span> + data.info.name);</span><br><span class="line">        </span><br><span class="line">        <span class="comment">// 创建 Context 对象；</span></span><br><span class="line">        ContextImpl context = ContextImpl.createAppContext(<span class="keyword">this</span>, packageInfo);</span><br><span class="line">        context.setOuterContext(service);</span><br><span class="line">        </span><br><span class="line">        <span class="comment">// 返回该进程的 Application 对象！</span></span><br><span class="line">        Application app = packageInfo.makeApplication(<span class="keyword">false</span>, mInstrumentation);</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 将服务实例和 context，Application 进行绑定；</span></span><br><span class="line">        service.attach(context, <span class="keyword">this</span>, data.info.name, data.token, app,</span><br><span class="line">                ActivityManagerNative.getDefault());</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 调用了服务的 onCreate 方法；</span></span><br><span class="line">        service.onCreate();</span><br><span class="line">        </span><br><span class="line">        <span class="comment">// 将创建的服务实例保存到 ActivityThread 的托管集合中！</span></span><br><span class="line">        mServices.put(data.token, service);</span><br><span class="line"></span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line"> </span><br><span class="line">            <span class="comment">// 通知 AMS，操作完成；</span></span><br><span class="line">            ActivityManagerNative.getDefault().serviceDoneExecuting(</span><br><span class="line">                    data.token, SERVICE_DONE_EXECUTING_ANON, <span class="number">0</span>, <span class="number">0</span>);</span><br><span class="line"></span><br><span class="line">        &#125; <span class="keyword">catch</span> (RemoteException e) &#123;</span><br><span class="line">            <span class="keyword">throw</span> e.rethrowFromSystemServer();</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">    &#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (!mInstrumentation.onException(service, e)) &#123;</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> RuntimeException(</span><br><span class="line">                <span class="string">"Unable to create service "</span> + data.info.name</span><br><span class="line">                + <span class="string">": "</span> + e.toString(), e);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>成功地拉起了 Service 的 onCreate 方法！最后有调用了 ActivityManagerNative.getDefault().serviceDoneExecuting，这个和 startService 的流程一样，这里就不多数了！</p>
<h3 id="3-3-2-ActivityThread-handleBindService"><a href="#3-3-2-ActivityThread-handleBindService" class="headerlink" title="3.3.2 ActivityThread.handleBindService"></a>3.3.2 ActivityThread.handleBindService</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">handleBindService</span><span class="params">(BindServiceData data)</span> </span>&#123;</span><br><span class="line">    Service s = mServices.get(data.token);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (DEBUG_SERVICE)</span><br><span class="line">        Slog.v(TAG, <span class="string">"handleBindService s="</span> + s + <span class="string">" rebind="</span> + data.rebind);</span><br><span class="line">    <span class="keyword">if</span> (s != <span class="keyword">null</span>) &#123;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            data.intent.setExtrasClassLoader(s.getClassLoader());</span><br><span class="line">            data.intent.prepareToEnterProcess();</span><br><span class="line">            <span class="keyword">try</span> &#123;</span><br><span class="line">                <span class="keyword">if</span> (!data.rebind) &#123;  <span class="comment">// 如果 rebind 为 false！！</span></span><br><span class="line">                </span><br><span class="line">                    <span class="comment">// 调用服务的 onBind 方法，返回值是 Service 的中定义的 “桩”！</span></span><br><span class="line">                    IBinder binder = s.onBind(data.intent);</span><br><span class="line">                    </span><br><span class="line">                    <span class="comment">// 这里回到了系统进程！</span></span><br><span class="line">                    ActivityManagerNative.getDefault().publishService(</span><br><span class="line">                            data.token, data.intent, binder);</span><br><span class="line"></span><br><span class="line">                &#125; <span class="keyword">else</span> &#123; <span class="comment">// 如果 rebind 为 true！！</span></span><br><span class="line">                    </span><br><span class="line">                    <span class="comment">// 拉起服务的 onRebind 方法！</span></span><br><span class="line">                    s.onRebind(data.intent);</span><br><span class="line">                    </span><br><span class="line">                    <span class="comment">// 这里回到了系统进程！</span></span><br><span class="line">                    ActivityManagerNative.getDefault().serviceDoneExecuting(</span><br><span class="line">                            data.token, SERVICE_DONE_EXECUTING_ANON, <span class="number">0</span>, <span class="number">0</span>);</span><br><span class="line">                &#125;</span><br><span class="line">                ensureJitEnabled();</span><br><span class="line"></span><br><span class="line">            &#125; <span class="keyword">catch</span> (RemoteException ex) &#123;</span><br><span class="line">                <span class="keyword">throw</span> ex.rethrowFromSystemServer();</span><br><span class="line">            &#125;</span><br><span class="line">        &#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">            <span class="keyword">if</span> (!mInstrumentation.onException(s, e)) &#123;</span><br><span class="line">                <span class="keyword">throw</span> <span class="keyword">new</span> RuntimeException(</span><br><span class="line">                        <span class="string">"Unable to bind to service "</span> + s</span><br><span class="line">                        + <span class="string">" with "</span> + data.intent + <span class="string">": "</span> + e.toString(), e);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>这里，我们先默认是第一次绑定，rebind 为 false，我们在重写 Service 的 onBind 方法后，会返回一个 Stub 类型的对象，这个是 Service 这边定义的 “桩”，我们继续看！！！！</p>
<h2 id="3-4-ActivityManagerProxy"><a href="#3-4-ActivityManagerProxy" class="headerlink" title="3.4 ActivityManagerProxy"></a>3.4 ActivityManagerProxy</h2><p>这里不多说了！</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">serviceDoneExecuting</span><span class="params">(IBinder token, <span class="keyword">int</span> type, <span class="keyword">int</span> startId,</span></span></span><br><span class="line"><span class="function"><span class="params">        <span class="keyword">int</span> res)</span> <span class="keyword">throws</span> RemoteException </span>&#123;</span><br><span class="line">    Parcel data = Parcel.obtain();</span><br><span class="line">    Parcel reply = Parcel.obtain();</span><br><span class="line">    data.writeInterfaceToken(IActivityManager.descriptor);</span><br><span class="line">    data.writeStrongBinder(token);</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// 这里的 type 是 SERVICE_DONE_EXECUTING_ANON </span></span><br><span class="line">    data.writeInt(type);</span><br><span class="line">    data.writeInt(startId);</span><br><span class="line">    data.writeInt(res);</span><br><span class="line"></span><br><span class="line">    mRemote.transact(SERVICE_DONE_EXECUTING_TRANSACTION, data, reply, IBinder.FLAG_ONEWAY);</span><br><span class="line"></span><br><span class="line">    reply.readException();</span><br><span class="line">    data.recycle();</span><br><span class="line">    reply.recycle();</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">publishService</span><span class="params">(IBinder token,</span></span></span><br><span class="line"><span class="function"><span class="params">        Intent intent, IBinder service)</span> <span class="keyword">throws</span> RemoteException </span>&#123;</span><br><span class="line"></span><br><span class="line">    Parcel data = Parcel.obtain();</span><br><span class="line">    Parcel reply = Parcel.obtain();</span><br><span class="line">    data.writeInterfaceToken(IActivityManager.descriptor);</span><br><span class="line">    data.writeStrongBinder(token);</span><br><span class="line">    intent.writeToParcel(data, <span class="number">0</span>);</span><br><span class="line">    data.writeStrongBinder(service);</span><br><span class="line"></span><br><span class="line">    mRemote.transact(PUBLISH_SERVICE_TRANSACTION, data, reply, <span class="number">0</span>);</span><br><span class="line"></span><br><span class="line">    reply.readException();</span><br><span class="line">    data.recycle();</span><br><span class="line">    reply.recycle();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h1 id="4-系统进程"><a href="#4-系统进程" class="headerlink" title="4 系统进程"></a>4 系统进程</h1><p>进入 AMS，首先会进入 ActivityManagerN 的 onTransact 方法!</p>
<h2 id="4-1-ActivityManagerN-onTransact"><a href="#4-1-ActivityManagerN-onTransact" class="headerlink" title="4.1 ActivityManagerN.onTransact"></a>4.1 ActivityManagerN.onTransact</h2><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">case</span> SERVICE_DONE_EXECUTING_TRANSACTION: &#123;</span><br><span class="line">    data.enforceInterface(IActivityManager.descriptor);</span><br><span class="line">    IBinder token = data.readStrongBinder();</span><br><span class="line">    <span class="keyword">int</span> type = data.readInt();</span><br><span class="line">    <span class="keyword">int</span> startId = data.readInt();</span><br><span class="line">    <span class="keyword">int</span> res = data.readInt();</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// 进入 AMS!</span></span><br><span class="line">    serviceDoneExecuting(token, type, startId, res);</span><br><span class="line">    reply.writeNoException();</span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">true</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">case</span> PUBLISH_SERVICE_TRANSACTION: &#123;</span><br><span class="line">    data.enforceInterface(IActivityManager.descriptor);</span><br><span class="line">    IBinder token = data.readStrongBinder();</span><br><span class="line">    Intent intent = Intent.CREATOR.createFromParcel(data);</span><br><span class="line">    IBinder service = data.readStrongBinder();</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// 进入 AMS !</span></span><br><span class="line">    publishService(token, intent, service);</span><br><span class="line">    reply.writeNoException();</span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">true</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h3 id="4-1-1-ActivityManagerS-serviceDoneExecuting"><a href="#4-1-1-ActivityManagerS-serviceDoneExecuting" class="headerlink" title="4.1.1 ActivityManagerS.serviceDoneExecuting"></a>4.1.1 ActivityManagerS.serviceDoneExecuting</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br></pre></td><td class="code"><pre><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">serviceDoneExecuting</span><span class="params">(IBinder token, <span class="keyword">int</span> type, <span class="keyword">int</span> startId, <span class="keyword">int</span> res)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">synchronized</span>(<span class="keyword">this</span>) &#123;</span><br><span class="line"></span><br><span class="line">            <span class="keyword">if</span> (!(token <span class="keyword">instanceof</span> ServiceRecord)) &#123;</span><br><span class="line">                Slog.e(TAG, <span class="string">"serviceDoneExecuting: Invalid service token="</span> + token);</span><br><span class="line">                <span class="keyword">throw</span> <span class="keyword">new</span> IllegalArgumentException(<span class="string">"Invalid service token"</span>);</span><br><span class="line">            &#125;</span><br><span class="line">            mServices.serviceDoneExecutingLocked((ServiceRecord)token, type, startId, res);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">``` </span><br><span class="line">最后进入 AS.serviceDoneExecutingLocked 方法！</span><br><span class="line"></span><br><span class="line">#### 4.1.1.1 ActiveServices.serviceDoneExecutingLocked</span><br><span class="line"></span><br><span class="line">参数传递：</span><br><span class="line"></span><br><span class="line">- <span class="keyword">int</span> type：这里的 type 是 `SERVICE_DONE_EXECUTING_ANON`  </span><br><span class="line">```java</span><br><span class="line">    <span class="function"><span class="keyword">void</span> <span class="title">serviceDoneExecutingLocked</span><span class="params">(ServiceRecord r, <span class="keyword">int</span> type, <span class="keyword">int</span> startId, <span class="keyword">int</span> res)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">boolean</span> inDestroying = mDestroyingServices.contains(r);</span><br><span class="line">        <span class="keyword">if</span> (r != <span class="keyword">null</span>) &#123;</span><br><span class="line">            <span class="keyword">if</span> (type == ActivityThread.SERVICE_DONE_EXECUTING_START) &#123;</span><br><span class="line">            </span><br><span class="line">                ... ... ... <span class="comment">// 不进入，不看</span></span><br><span class="line">                </span><br><span class="line">            &#125; <span class="keyword">else</span> <span class="keyword">if</span> (type == ActivityThread.SERVICE_DONE_EXECUTING_STOP) &#123;</span><br><span class="line">            </span><br><span class="line">                ... ... ... <span class="comment">// 不进入，不看</span></span><br><span class="line">                </span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">final</span> <span class="keyword">long</span> origId = Binder.clearCallingIdentity();</span><br><span class="line">            </span><br><span class="line">            <span class="comment">// 进入 serviceDoneExecutingLocked 方法，看</span></span><br><span class="line">            serviceDoneExecutingLocked(r, inDestroying, inDestroying);</span><br><span class="line"></span><br><span class="line">            Binder.restoreCallingIdentity(origId);</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            Slog.w(TAG, <span class="string">"Done executing unknown service from pid "</span></span><br><span class="line">                    + Binder.getCallingPid());</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure>
<h3 id="4-1-2-ActivityManagerS-publishService"><a href="#4-1-2-ActivityManagerS-publishService" class="headerlink" title="4.1.2 ActivityManagerS.publishService"></a>4.1.2 ActivityManagerS.publishService</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">publishService</span><span class="params">(IBinder token, Intent intent, IBinder service)</span> </span>&#123;</span><br><span class="line">    <span class="comment">// Refuse possible leaked file descriptors</span></span><br><span class="line">    <span class="keyword">if</span> (intent != <span class="keyword">null</span> &amp;&amp; intent.hasFileDescriptors() == <span class="keyword">true</span>) &#123;</span><br><span class="line">        <span class="keyword">throw</span> <span class="keyword">new</span> IllegalArgumentException(<span class="string">"File descriptors passed in Intent"</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">synchronized</span>(<span class="keyword">this</span>) &#123;</span><br><span class="line">        <span class="comment">// 这里不多说了！！</span></span><br><span class="line">        <span class="keyword">if</span> (!(token <span class="keyword">instanceof</span> ServiceRecord)) &#123;</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> IllegalArgumentException(<span class="string">"Invalid service token"</span>);</span><br><span class="line">        &#125;</span><br><span class="line">        </span><br><span class="line">        <span class="comment">// 调用 ActiveServices 的 publishServiceLocked 方法！</span></span><br><span class="line">        mServices.publishServiceLocked((ServiceRecord)token, intent, service);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>继续看：</p>
<h4 id="4-1-2-1-ActiveServices-publishService"><a href="#4-1-2-1-ActiveServices-publishService" class="headerlink" title="4.1.2.1 ActiveServices.publishService"></a>4.1.2.1 ActiveServices.publishService</h4><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">publishServiceLocked</span><span class="params">(ServiceRecord r, Intent intent, IBinder service)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">final</span> <span class="keyword">long</span> origId = Binder.clearCallingIdentity();</span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (DEBUG_SERVICE) Slog.v(TAG_SERVICE, <span class="string">"PUBLISHING "</span> + r</span><br><span class="line">                + <span class="string">" "</span> + intent + <span class="string">": "</span> + service);</span><br><span class="line">                </span><br><span class="line">        <span class="keyword">if</span> (r != <span class="keyword">null</span>) &#123;</span><br><span class="line"></span><br><span class="line">            <span class="comment">// 尝试找到 intent 对应的 IntentBindRecord 对象!</span></span><br><span class="line">            Intent.FilterComparison filter</span><br><span class="line">                    = <span class="keyword">new</span> Intent.FilterComparison(intent);</span><br><span class="line">            IntentBindRecord b = r.bindings.get(filter);</span><br><span class="line">            </span><br><span class="line">            <span class="keyword">if</span> (b != <span class="keyword">null</span> &amp;&amp; !b.received) &#123;  <span class="comment">// 这里的 received 还是 false!</span></span><br><span class="line">                </span><br><span class="line">                <span class="comment">// 将服务的 “桩” 保存到！</span></span><br><span class="line">                b.binder = service;</span><br><span class="line"></span><br><span class="line">                <span class="comment">// 将 IntentBindRecord.requested 设为 true！</span></span><br><span class="line">                b.requested = <span class="keyword">true</span>;</span><br><span class="line">                </span><br><span class="line">                <span class="comment">// 将 IntentBindRecord.received 设为 true！</span></span><br><span class="line">                b.received = <span class="keyword">true</span>;</span><br><span class="line"></span><br><span class="line">                <span class="keyword">for</span> (<span class="keyword">int</span> conni=r.connections.size()-<span class="number">1</span>; conni&gt;=<span class="number">0</span>; conni--) &#123;</span><br><span class="line">                    ArrayList&lt;ConnectionRecord&gt; clist = r.connections.valueAt(conni);</span><br><span class="line">                    <span class="keyword">for</span> (<span class="keyword">int</span> i=<span class="number">0</span>; i&lt;clist.size(); i++) &#123;</span><br><span class="line">                        ConnectionRecord c = clist.get(i);</span><br><span class="line"></span><br><span class="line">                        <span class="keyword">if</span> (!filter.equals(c.binding.intent.intent)) &#123;</span><br><span class="line">                            <span class="keyword">if</span> (DEBUG_SERVICE) Slog.v(</span><br><span class="line">                                    TAG_SERVICE, <span class="string">"Not publishing to: "</span> + c);</span><br><span class="line">                            <span class="keyword">if</span> (DEBUG_SERVICE) Slog.v(</span><br><span class="line">                                    TAG_SERVICE, <span class="string">"Bound intent: "</span> + c.binding.intent.intent);</span><br><span class="line">                            <span class="keyword">if</span> (DEBUG_SERVICE) Slog.v(</span><br><span class="line">                                    TAG_SERVICE, <span class="string">"Published intent: "</span> + intent);</span><br><span class="line">                            <span class="keyword">continue</span>;</span><br><span class="line">                        &#125;</span><br><span class="line"></span><br><span class="line">                        <span class="keyword">if</span> (DEBUG_SERVICE) Slog.v(TAG_SERVICE, <span class="string">"Publishing to: "</span> + c);</span><br><span class="line">                        <span class="keyword">try</span> &#123;</span><br><span class="line">                        </span><br><span class="line">                            <span class="comment">// 通过 Bind 回调绑定者进程的 ServcieConnection 的 onServiceDisconnected 方法！</span></span><br><span class="line">                            <span class="comment">// 注意这个方法是非阻塞的，是异步的，因为有 oneway 的标志！！</span></span><br><span class="line">                            c.conn.connected(r.name, service);</span><br><span class="line"></span><br><span class="line">                        &#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">                            Slog.w(TAG, <span class="string">"Failure sending service "</span> + r.name +</span><br><span class="line">                                  <span class="string">" to connection "</span> + c.conn.asBinder() +</span><br><span class="line">                                  <span class="string">" (in "</span> + c.binding.client.processName + <span class="string">")"</span>, e);</span><br><span class="line">                        &#125;</span><br><span class="line"></span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">            </span><br><span class="line">            <span class="comment">// 接着，调用 serviceDoneExecutingLocked 方法，表示执行完成！</span></span><br><span class="line">            serviceDoneExecutingLocked(r, mDestroyingServices.contains(r), <span class="keyword">false</span>);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">        Binder.restoreCallingIdentity(origId);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>这里会继续通过 Bind 回调绑定者进程的 ServcieConnection 的 onServiceDisconnected 方法！这个方法是非阻塞的，是异步的，因为有 oneway 的标志！！</p>
<p>c.conn 是 IServiceConnection.proxy ，即服务连接代理对象！！！这里，就要回到绑定者进程，我们后面再看！！</p>
<h3 id="4-1-3-ActivityManagerS-serviceDoneExecutingLocked"><a href="#4-1-3-ActivityManagerS-serviceDoneExecutingLocked" class="headerlink" title="4.1.3 ActivityManagerS.serviceDoneExecutingLocked"></a>4.1.3 ActivityManagerS.serviceDoneExecutingLocked</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">serviceDoneExecutingLocked</span><span class="params">(ServiceRecord r, <span class="keyword">boolean</span> inDestroying,</span></span></span><br><span class="line"><span class="function"><span class="params">        <span class="keyword">boolean</span> finishing)</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (DEBUG_SERVICE) Slog.v(TAG_SERVICE, <span class="string">"&lt;&lt;&lt; DONE EXECUTING "</span> + r</span><br><span class="line">            + <span class="string">": nesting="</span> + r.executeNesting</span><br><span class="line">            + <span class="string">", inDestroying="</span> + inDestroying + <span class="string">", app="</span> + r.app);</span><br><span class="line">    <span class="keyword">else</span> <span class="keyword">if</span> (DEBUG_SERVICE_EXECUTING) Slog.v(TAG_SERVICE_EXECUTING,</span><br><span class="line">            <span class="string">"&lt;&lt;&lt; DONE EXECUTING "</span> + r.shortName);</span><br><span class="line"></span><br><span class="line">    r.executeNesting--;</span><br><span class="line">    <span class="keyword">if</span> (r.executeNesting &lt;= <span class="number">0</span>) &#123;</span><br><span class="line">        <span class="keyword">if</span> (r.app != <span class="keyword">null</span>) &#123;</span><br><span class="line"></span><br><span class="line">            <span class="keyword">if</span> (DEBUG_SERVICE) Slog.v(TAG_SERVICE,</span><br><span class="line">                    <span class="string">"Nesting at 0 of "</span> + r.shortName);</span><br><span class="line">                    </span><br><span class="line">            r.app.execServicesFg = <span class="keyword">false</span>;</span><br><span class="line">            r.app.executingServices.remove(r);</span><br><span class="line"></span><br><span class="line">            <span class="keyword">if</span> (r.app.executingServices.size() == <span class="number">0</span>) &#123;</span><br><span class="line">                <span class="keyword">if</span> (DEBUG_SERVICE || DEBUG_SERVICE_EXECUTING) Slog.v(TAG_SERVICE_EXECUTING,</span><br><span class="line">                        <span class="string">"No more executingServices of "</span> + r.shortName);</span><br><span class="line">                        </span><br><span class="line">                <span class="comment">// 移除 onCreate / onBind 方法的超时处理任务！</span></span><br><span class="line">                mAm.mHandler.removeMessages(ActivityManagerService.SERVICE_TIMEOUT_MSG, r.app);</span><br><span class="line"></span><br><span class="line">            &#125; <span class="keyword">else</span> <span class="keyword">if</span> (r.executeFg) &#123;</span><br><span class="line"></span><br><span class="line">                <span class="comment">// Need to re-evaluate whether the app still needs to be in the foreground.</span></span><br><span class="line">                <span class="keyword">for</span> (<span class="keyword">int</span> i=r.app.executingServices.size()-<span class="number">1</span>; i&gt;=<span class="number">0</span>; i--) &#123;</span><br><span class="line">                    <span class="keyword">if</span> (r.app.executingServices.valueAt(i).executeFg) &#123;</span><br><span class="line">                        r.app.execServicesFg = <span class="keyword">true</span>;</span><br><span class="line">                        <span class="keyword">break</span>;</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            <span class="keyword">if</span> (inDestroying) &#123;</span><br><span class="line">                <span class="keyword">if</span> (DEBUG_SERVICE) Slog.v(TAG_SERVICE,</span><br><span class="line">                        <span class="string">"doneExecuting remove destroying "</span> + r);</span><br><span class="line">                mDestroyingServices.remove(r);</span><br><span class="line">                r.bindings.clear();</span><br><span class="line">            &#125;</span><br><span class="line">            mAm.updateOomAdjLocked(r.app);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        r.executeFg = <span class="keyword">false</span>;</span><br><span class="line">        <span class="keyword">if</span> (r.tracker != <span class="keyword">null</span>) &#123;</span><br><span class="line">            r.tracker.setExecuting(<span class="keyword">false</span>, mAm.mProcessStats.getMemFactorLocked(),</span><br><span class="line">                    SystemClock.uptimeMillis());</span><br><span class="line">            <span class="keyword">if</span> (finishing) &#123;</span><br><span class="line">                r.tracker.clearCurrentOwner(r, <span class="keyword">false</span>);</span><br><span class="line">                r.tracker = <span class="keyword">null</span>;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (finishing) &#123;</span><br><span class="line">            <span class="keyword">if</span> (r.app != <span class="keyword">null</span> &amp;&amp; !r.app.persistent) &#123;</span><br><span class="line">                r.app.services.remove(r);</span><br><span class="line">                <span class="keyword">if</span> (r.whitelistManager) &#123;</span><br><span class="line">                    updateWhitelistManagerLocked(r.app);</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">            r.app = <span class="keyword">null</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>这里很简单了，就不详细说了！！</p>
<h1 id="5-绑定者进程"><a href="#5-绑定者进程" class="headerlink" title="5 绑定者进程"></a>5 绑定者进程</h1><p>下面来看看绑定者进程的 connected 方法的回调问题！！</p>
<p>IServiceConnection.aild 文件中只定义了一个接口：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> android.content.ComponentName;</span><br><span class="line"></span><br><span class="line"><span class="comment">/** <span class="doctag">@hide</span> */</span></span><br><span class="line">oneway <span class="class"><span class="keyword">interface</span> <span class="title">IServiceConnection</span> </span>&#123;</span><br><span class="line">    <span class="function"><span class="keyword">void</span> <span class="title">connected</span><span class="params">(in ComponentName name, IBinder service)</span></span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>可以看到，这个方法是 oneway 类型的，就是说，binder 通信是非阻塞的！</p>
<h2 id="5-1-InnerConnection-connected"><a href="#5-1-InnerConnection-connected" class="headerlink" title="5.1 InnerConnection.connected"></a>5.1 InnerConnection.connected</h2><p>进入 LoadedApk 的 InnerConnection 类！<br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">private</span> <span class="keyword">static</span> <span class="class"><span class="keyword">class</span> <span class="title">InnerConnection</span> <span class="keyword">extends</span> <span class="title">IServiceConnection</span>.<span class="title">Stub</span> </span>&#123;</span><br><span class="line">    <span class="keyword">final</span> WeakReference&lt;LoadedApk.ServiceDispatcher&gt; mDispatcher;</span><br><span class="line"></span><br><span class="line">    InnerConnection(LoadedApk.ServiceDispatcher sd) &#123;</span><br><span class="line">        mDispatcher = <span class="keyword">new</span> WeakReference&lt;LoadedApk.ServiceDispatcher&gt;(sd);</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// 接着，调用 ServiceDispatcher 的 connected 方法！</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">connected</span><span class="params">(ComponentName name, IBinder service)</span> <span class="keyword">throws</span> RemoteException </span>&#123;</span><br><span class="line">        LoadedApk.ServiceDispatcher sd = mDispatcher.get();</span><br><span class="line">        <span class="keyword">if</span> (sd != <span class="keyword">null</span>) &#123;</span><br><span class="line">            sd.connected(name, service);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<h2 id="5-2-ServiceDispatcher-connected"><a href="#5-2-ServiceDispatcher-connected" class="headerlink" title="5.2 ServiceDispatcher.connected"></a>5.2 ServiceDispatcher.connected</h2><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">connected</span><span class="params">(ComponentName name, IBinder service)</span> </span>&#123;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// 执行一个 RunConnection 的 Runnable！</span></span><br><span class="line">    <span class="keyword">if</span> (mActivityThread != <span class="keyword">null</span>) &#123;</span><br><span class="line">        </span><br><span class="line">        mActivityThread.post(<span class="keyword">new</span> RunConnection(name, service, <span class="number">0</span>));</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        doConnected(name, service);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h2 id="5-3-ServiceDispatcher-RunConnection"><a href="#5-3-ServiceDispatcher-RunConnection" class="headerlink" title="5.3 ServiceDispatcher.RunConnection"></a>5.3 ServiceDispatcher.RunConnection</h2><p>参数传递：</p>
<ul>
<li>int command：0；<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">private</span> <span class="keyword">final</span> <span class="class"><span class="keyword">class</span> <span class="title">RunConnection</span> <span class="keyword">implements</span> <span class="title">Runnable</span> </span>&#123;</span><br><span class="line">    RunConnection(ComponentName name, IBinder service, <span class="keyword">int</span> command) &#123;</span><br><span class="line">        mName = name;</span><br><span class="line">        mService = service;</span><br><span class="line">        mCommand = command;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">run</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">if</span> (mCommand == <span class="number">0</span>) &#123;</span><br><span class="line">            </span><br><span class="line">            <span class="comment">// 执行连接！</span></span><br><span class="line">            doConnected(mName, mService);</span><br><span class="line"></span><br><span class="line">        &#125; <span class="keyword">else</span> <span class="keyword">if</span> (mCommand == <span class="number">1</span>) &#123;</span><br><span class="line">            doDeath(mName, mService);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">final</span> ComponentName mName;</span><br><span class="line">    <span class="keyword">final</span> IBinder mService;</span><br><span class="line">    <span class="keyword">final</span> <span class="keyword">int</span> mCommand;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
</li>
</ul>
<p>继续看：</p>
<h2 id="5-4-ServiceDispatcher-doConnected"><a href="#5-4-ServiceDispatcher-doConnected" class="headerlink" title="5.4 ServiceDispatcher.doConnected"></a>5.4 ServiceDispatcher.doConnected</h2><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">doConnected</span><span class="params">(ComponentName name, IBinder service)</span> </span>&#123;</span><br><span class="line">    ServiceDispatcher.ConnectionInfo old;</span><br><span class="line">    ServiceDispatcher.ConnectionInfo info;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">synchronized</span> (<span class="keyword">this</span>) &#123;</span><br><span class="line">        <span class="comment">// 当 mForgotten 为 true，表示之前执行了 unBindService 操作！</span></span><br><span class="line">        <span class="keyword">if</span> (mForgotten) &#123;</span><br><span class="line">            <span class="comment">// We unbound before receiving the connection; ignore</span></span><br><span class="line">            <span class="comment">// any connection received.</span></span><br><span class="line">            <span class="keyword">return</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        </span><br><span class="line">        <span class="comment">// 先尝试获得旧的可用连接，如果已有，就退出！</span></span><br><span class="line">        <span class="comment">// 所以说，对于多次 bindService，onServiceConnected 只会执行一次！</span></span><br><span class="line">        old = mActiveConnections.get(name);</span><br><span class="line">        <span class="keyword">if</span> (old != <span class="keyword">null</span> &amp;&amp; old.binder == service) &#123;</span><br><span class="line">            <span class="comment">// Huh, already have this one.  Oh well!</span></span><br><span class="line">            <span class="keyword">return</span>;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// service 是被绑定的 Service 的桩对应的代理！</span></span><br><span class="line">        <span class="keyword">if</span> (service != <span class="keyword">null</span>) &#123;</span><br><span class="line"></span><br><span class="line">            <span class="comment">// 创建一个连接信息对象！</span></span><br><span class="line">            info = <span class="keyword">new</span> ConnectionInfo();</span><br><span class="line"></span><br><span class="line">            <span class="comment">//将远程 Service 代理保存到 binder 类中！</span></span><br><span class="line">            info.binder = service;</span><br><span class="line">            </span><br><span class="line">            <span class="comment">// 设置死亡监听器</span></span><br><span class="line">            info.deathMonitor = <span class="keyword">new</span> DeathMonitor(name, service);</span><br><span class="line"></span><br><span class="line">            <span class="keyword">try</span> &#123;</span><br><span class="line">              </span><br><span class="line">                service.linkToDeath(info.deathMonitor, <span class="number">0</span>);</span><br><span class="line">                </span><br><span class="line">                <span class="comment">// 将本次的连接信息保存到 mActiveConnections 中！</span></span><br><span class="line">                mActiveConnections.put(name, info);</span><br><span class="line"></span><br><span class="line">            &#125; <span class="keyword">catch</span> (RemoteException e) &#123;</span><br><span class="line"></span><br><span class="line">                <span class="comment">// This service was dead before we got it...  just</span></span><br><span class="line">                <span class="comment">// don't do anything with it.</span></span><br><span class="line">                mActiveConnections.remove(name);</span><br><span class="line">                <span class="keyword">return</span>;</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            <span class="comment">// The named service is being disconnected... clean up.</span></span><br><span class="line">            mActiveConnections.remove(name);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (old != <span class="keyword">null</span>) &#123;</span><br><span class="line">            old.binder.unlinkToDeath(old.deathMonitor, <span class="number">0</span>);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// If there was an old service, it is now disconnected.</span></span><br><span class="line">    <span class="keyword">if</span> (old != <span class="keyword">null</span>) &#123;</span><br><span class="line">        mConnection.onServiceDisconnected(name);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// If there is a new service, it is now connected.</span></span><br><span class="line">    <span class="keyword">if</span> (service != <span class="keyword">null</span>) &#123;</span><br><span class="line">    </span><br><span class="line">        <span class="comment">// 调用了 Connection 的 onServiceConnected 方法！</span></span><br><span class="line">        mConnection.onServiceConnected(name, service);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>最后，我们看到，调用了 mConnection.onServiceConnected，这个方法大家很熟悉了，不多说了！</p>
<h1 id="6-总结"><a href="#6-总结" class="headerlink" title="6 总结"></a>6 总结</h1><h2 id="6-1-数据结构总结"><a href="#6-1-数据结构总结" class="headerlink" title="6.1 数据结构总结"></a>6.1 数据结构总结</h2><blockquote>
<p>绑定者进程的数据结构关系图</p>
</blockquote>
<p><img src="http://static.zybuluo.com/Coolqi/p0gzyjijwj4mo5gc29oqj3ar/%E7%BB%91%E5%AE%9A%E8%80%85%E8%BF%9B%E7%A8%8B%E4%B8%AD%E7%9A%84%E6%95%B0%E6%8D%AE%E7%BB%93%E6%9E%84%E5%85%B3%E7%B3%BB.png" alt="绑定者进程中的数据结构关系.png-164.8kB"></p>
<p>一个应用进程，只会有一个 InnerConnection 对象！</p>
<blockquote>
<p>系统进程的数据结构关系图</p>
</blockquote>
<p><img src="http://static.zybuluo.com/Coolqi/slum6gwlc12agci9vhvk0ula/%E7%B3%BB%E7%BB%9F%E8%BF%9B%E7%A8%8B%E4%B8%AD%E7%9A%84%E6%95%B0%E6%8D%AE%E7%BB%93%E6%9E%84%E5%85%B3%E7%B3%BB.png" alt="系统进程中的数据结构关系.png-467.2kB"></p>
<h2 id="6-2-binder-通信总结"><a href="#6-2-binder-通信总结" class="headerlink" title="6.2 binder 通信总结"></a>6.2 binder 通信总结</h2><h2 id="6-3-生命周期总结"><a href="#6-3-生命周期总结" class="headerlink" title="6.3 生命周期总结"></a>6.3 生命周期总结</h2><ul>
<li><p>对于<strong>只设置了 BIND_AUTO_CREATE 标志位</strong>的情况，只调用 bindService，Service 的周期如下：</p>
<ul>
<li><p>服务没有被创建：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">Service.onCreate() -&gt; Service.onBind() -&gt; ServiceConnection.onServiceConnected()</span><br></pre></td></tr></table></figure>
</li>
<li><p>服务已经被创建：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">Service.onBind() -&gt; ServiceConnection.onServiceConnected()</span><br></pre></td></tr></table></figure>
</li>
</ul>
</li>
<li><p>对于<strong>没有设置 BIND_AUTO_CREATE 标志，但设置了其他标志的情况</strong>，只调用 bindService，Service 的周期如下：</p>
<ul>
<li><p>服务没有被创建：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 无法实现 bind 操作, 但是会将本次 bind 操作的信息保存到系统进程中！</span></span><br></pre></td></tr></table></figure>
</li>
<li><p>服务之前已经被创建（之前通过 startService 启动服务，或者其他组件通过 BIND_AUTO_CREATE 方式绑定拉起）：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">Service.onBind() -&gt; ServiceConnection.onServiceConnected()</span><br></pre></td></tr></table></figure>
</li>
<li><p>服务之后才被创建（之后通过 startService 启动服务，或者其他组件通过 BIND_AUTO_CREATE 方式绑定拉起）：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">    Service.onCreate() -&gt; Service.onBind() (-&gt; Service.onStartCommand) -&gt; ServiceConnection.onServiceConnected()</span><br><span class="line">    ``` </span><br><span class="line"></span><br><span class="line">对于第三中情况，是不是很奇怪？原因很简单，如果服务之前没有被创建，调用 bindService（只设置了其他标志），是不会拉起 Service.onBind 方法的，但是会把本次 bind 的信息保存相应的集合中，当服务被 startService 或者通过 BIND_AUTO_CREATE 方式绑定拉起后，会对之前的 bind 信息处理，返回之前 bind 对应的代理对象！！详情请参考 startService 篇！</span><br><span class="line"></span><br><span class="line">- 对于多次调用 bindService</span><br><span class="line"></span><br><span class="line">  - 设置了 BIND_AUTO_CREATE 标志！</span><br><span class="line">    ```java</span><br><span class="line">    Service.onCreate()(once) -&gt; Service.onBind()(once) -&gt; ServiceConnection.onServiceConnected()（once）</span><br></pre></td></tr></table></figure>
</li>
</ul>
</li>
</ul>
<p>如果服务已经被创建的话，那 onCreate 方法是不会调用的，直接调用 onBind 方法！</p>
<ul>
<li>未设置 BIND_AUTO_CREATE 标志！ <ul>
<li>服务没有被启动！<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br></pre></td><td class="code"><pre><span class="line">    <span class="comment">// 无法实现 bind 操作, 但是会将本次 bind 操作的信息保存到系统进程中，等到服务被 startService 或者其他自动创建类型的 bindService 拉起后才会执行如下周期：</span></span><br><span class="line">    Service.onBind(once) -&gt; ServiceConnection.onServiceConnected()(once)</span><br><span class="line">    ```    </span><br><span class="line">     - 服务已经被启动！</span><br><span class="line">    ```java</span><br><span class="line">     Service.onBind()(once) -&gt; ServiceConnection.onServiceConnected()(once)</span><br><span class="line">    ```  </span><br><span class="line">    </span><br><span class="line">以上就是 bindService 相关的生命周期，有不对的地方，欢迎指正，谢谢！</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">## 6.4 相关 Log 参考</span><br><span class="line">```shell</span><br><span class="line"><span class="number">07</span>-<span class="number">04</span> <span class="number">17</span>:<span class="number">24</span>:<span class="number">21.523</span>  <span class="number">1761</span>  <span class="number">4194</span> V ActiveServices: bindService: Intent &#123; cmp=com.cooqi.servicedemo/.service.AService &#125; type=<span class="keyword">null</span> conn=android.os.BinderProxy<span class="meta">@abcfcca</span> flags=<span class="number">0x1</span></span><br><span class="line"><span class="number">07</span>-<span class="number">04</span> <span class="number">17</span>:<span class="number">24</span>:<span class="number">21.524</span>  <span class="number">1761</span>  <span class="number">4194</span> V ActiveServices: retrieveServiceLocked: Intent &#123; cmp=com.cooqi.servicedemo/.service.AService &#125; type=<span class="keyword">null</span> callingUid=<span class="number">10106</span></span><br><span class="line"><span class="number">07</span>-<span class="number">04</span> <span class="number">17</span>:<span class="number">24</span>:<span class="number">21.525</span>  <span class="number">1761</span>  <span class="number">4194</span> V ActivityManagerService: processName: com.cooqi.servicedemo uid <span class="number">10106</span> keepIfLarge <span class="keyword">false</span></span><br><span class="line"><span class="number">07</span>-<span class="number">04</span> <span class="number">17</span>:<span class="number">24</span>:<span class="number">21.526</span>  <span class="number">1761</span>  <span class="number">4194</span> V ActiveServices: Bringing up ServiceRecord&#123;<span class="number">7454958</span> u0 com.cooqi.servicedemo/.service.AService&#125; android.content.Intent$FilterComparison@<span class="number">7</span>df9497b</span><br><span class="line"><span class="number">07</span>-<span class="number">04</span> <span class="number">17</span>:<span class="number">24</span>:<span class="number">21.526</span>  <span class="number">1761</span>  <span class="number">4194</span> V ActivityManagerService: processName: com.cooqi.servicedemo uid <span class="number">10106</span> keepIfLarge <span class="keyword">false</span></span><br><span class="line"><span class="number">07</span>-<span class="number">04</span> <span class="number">17</span>:<span class="number">24</span>:<span class="number">21.527</span>  <span class="number">1761</span>  <span class="number">4194</span> V ActiveServices_MU: bringUpServiceLocked: appInfo.uid=<span class="number">10106</span> app=ProcessRecord&#123;<span class="number">39802</span>a4 <span class="number">7994</span>:com.cooqi.servicedemo/u0a106&#125;</span><br><span class="line"><span class="number">07</span>-<span class="number">04</span> <span class="number">17</span>:<span class="number">24</span>:<span class="number">21.527</span>  <span class="number">1761</span>  <span class="number">4194</span> V ActiveServices_MU: realStartServiceLocked, ServiceRecord.uid = <span class="number">10106</span>, ProcessRecord.uid = <span class="number">10106</span></span><br><span class="line"><span class="number">07</span>-<span class="number">04</span> <span class="number">17</span>:<span class="number">24</span>:<span class="number">21.527</span>  <span class="number">1761</span>  <span class="number">4194</span> V ActiveServices: &gt;&gt;&gt; EXECUTING create of ServiceRecord&#123;<span class="number">7454958</span> u0 com.cooqi.servicedemo/.service.AService&#125; in app ProcessRecord&#123;<span class="number">39802</span>a4 <span class="number">7994</span>:com.cooqi.servicedemo/u0a106&#125;</span><br><span class="line"><span class="number">07</span>-<span class="number">04</span> <span class="number">17</span>:<span class="number">24</span>:<span class="number">21.527</span>  <span class="number">1761</span>  <span class="number">4194</span> V ActiveServices: bumpServiceExecutingLocked r.executeNesting <span class="number">0</span></span><br><span class="line"><span class="number">07</span>-<span class="number">04</span> <span class="number">17</span>:<span class="number">24</span>:<span class="number">21.527</span>  <span class="number">1761</span>  <span class="number">4194</span> V ActiveServices: bumpServiceExecutingLocked r.app.executingServices.size() <span class="number">1</span></span><br><span class="line"><span class="number">07</span>-<span class="number">04</span> <span class="number">17</span>:<span class="number">24</span>:<span class="number">21.544</span>  <span class="number">1761</span>  <span class="number">4194</span> D ActivityManagerService: oom: memFactor=<span class="number">0</span> last=<span class="number">0</span> allowLow=<span class="keyword">false</span> numProcs=<span class="number">66</span> last=<span class="number">66</span></span><br><span class="line"><span class="number">07</span>-<span class="number">04</span> <span class="number">17</span>:<span class="number">24</span>:<span class="number">21.545</span>  <span class="number">1761</span>  <span class="number">4194</span> D ActivityManagerService: Did OOM ADJ in <span class="number">18</span>ms</span><br><span class="line"><span class="number">07</span>-<span class="number">04</span> <span class="number">17</span>:<span class="number">24</span>:<span class="number">21.546</span>  <span class="number">1761</span>  <span class="number">4194</span> V ActiveServices: &gt;&gt;&gt; EXECUTING bind of ServiceRecord&#123;<span class="number">7454958</span> u0 com.cooqi.servicedemo/.service.AService&#125; in app ProcessRecord&#123;<span class="number">39802</span>a4 <span class="number">7994</span>:com.cooqi.servicedemo/u0a106&#125;</span><br><span class="line"><span class="number">07</span>-<span class="number">04</span> <span class="number">17</span>:<span class="number">24</span>:<span class="number">21.547</span>  <span class="number">1761</span>  <span class="number">4194</span> V ActiveServices: bumpServiceExecutingLocked r.executeNesting <span class="number">1</span></span><br><span class="line"><span class="number">07</span>-<span class="number">04</span> <span class="number">17</span>:<span class="number">24</span>:<span class="number">21.547</span>  <span class="number">7994</span>  <span class="number">8006</span> V ActivityThread: SCHEDULE <span class="number">114</span> CREATE_SERVICE: <span class="number">0</span> / CreateServiceData&#123;token=android.os.BinderProxy@<span class="number">23f</span>fb1d className=com.cooqi.servicedemo.service.AService packageName=com.cooqi.servicedemo intent=<span class="keyword">null</span>&#125;</span><br><span class="line"><span class="number">07</span>-<span class="number">04</span> <span class="number">17</span>:<span class="number">24</span>:<span class="number">21.547</span>  <span class="number">1761</span>  <span class="number">4194</span> V ActiveServices: Bind ServiceRecord&#123;<span class="number">7454958</span> u0 com.cooqi.servicedemo/.service.AService&#125; with AppBindRecord&#123;<span class="number">6e93</span>ab1 com.cooqi.servicedemo/.service.AService:com.cooqi.servicedemo&#125;: received=<span class="keyword">false</span> apps=<span class="number">1</span> doRebind=<span class="keyword">false</span></span><br><span class="line"><span class="number">07</span>-<span class="number">04</span> <span class="number">17</span>:<span class="number">24</span>:<span class="number">21.548</span>  <span class="number">7994</span>  <span class="number">8006</span> V ActivityThread: scheduleBindService token=android.os.BinderProxy@<span class="number">23f</span>fb1d intent=Intent &#123; cmp=com.cooqi.servicedemo/.service.AService &#125; uid=<span class="number">1000</span> pid=<span class="number">0</span></span><br><span class="line"><span class="number">07</span>-<span class="number">04</span> <span class="number">17</span>:<span class="number">24</span>:<span class="number">21.548</span>  <span class="number">7994</span>  <span class="number">8006</span> V ActivityThread: SCHEDULE <span class="number">121</span> BIND_SERVICE: <span class="number">0</span> / BindServiceData&#123;token=android.os.BinderProxy@<span class="number">23f</span>fb1d intent=Intent &#123; cmp=com.cooqi.servicedemo/.service.AService &#125;&#125;</span><br><span class="line"><span class="number">07</span>-<span class="number">04</span> <span class="number">17</span>:<span class="number">24</span>:<span class="number">21.552</span>  <span class="number">7994</span>  <span class="number">7994</span> V ActivityThread: &gt;&gt;&gt; handling: CREATE_SERVICE</span><br><span class="line"><span class="number">07</span>-<span class="number">04</span> <span class="number">17</span>:<span class="number">24</span>:<span class="number">21.552</span>  <span class="number">7994</span>  <span class="number">7994</span> V ActivityThread: Creating service com.cooqi.servicedemo.service.AService</span><br><span class="line"><span class="number">07</span>-<span class="number">04</span> <span class="number">17</span>:<span class="number">24</span>:<span class="number">21.553</span>  <span class="number">7994</span>  <span class="number">7994</span> D AService: onCreate</span><br><span class="line"><span class="number">07</span>-<span class="number">04</span> <span class="number">17</span>:<span class="number">24</span>:<span class="number">21.553</span>  <span class="number">7994</span>  <span class="number">7994</span> V ActivityThread: &lt;&lt;&lt; done: CREATE_SERVICE</span><br><span class="line"><span class="number">07</span>-<span class="number">04</span> <span class="number">17</span>:<span class="number">24</span>:<span class="number">21.553</span>  <span class="number">7994</span>  <span class="number">7994</span> V ActivityThread: &gt;&gt;&gt; handling: BIND_SERVICE</span><br><span class="line"><span class="number">07</span>-<span class="number">04</span> <span class="number">17</span>:<span class="number">24</span>:<span class="number">21.554</span>  <span class="number">7994</span>  <span class="number">7994</span> V ActivityThread: handleBindService s=com.cooqi.servicedemo.service.AService@<span class="number">92</span>ef192 rebind=<span class="keyword">false</span></span><br><span class="line"><span class="number">07</span>-<span class="number">04</span> <span class="number">17</span>:<span class="number">24</span>:<span class="number">21.554</span>  <span class="number">7994</span>  <span class="number">7994</span> D AService: onBind</span><br><span class="line"><span class="number">07</span>-<span class="number">04</span> <span class="number">17</span>:<span class="number">24</span>:<span class="number">21.554</span>  <span class="number">1761</span>  <span class="number">4106</span> V ActiveServices: serviceDoneExecutingLocked ServiceRecord= ServiceRecord&#123;<span class="number">7454958</span> u0 com.cooqi.servicedemo/.service.AService&#125; type= <span class="number">0</span> startId= <span class="number">0</span> res= <span class="number">0</span></span><br><span class="line"><span class="number">07</span>-<span class="number">04</span> <span class="number">17</span>:<span class="number">24</span>:<span class="number">21.554</span>  <span class="number">1761</span>  <span class="number">4106</span> V ActiveServices: &lt;&lt;&lt; DONE EXECUTING ServiceRecord&#123;<span class="number">7454958</span> u0 com.cooqi.servicedemo/.service.AService&#125;: nesting=<span class="number">2</span>, inDestroying=<span class="keyword">false</span>, app=ProcessRecord&#123;<span class="number">39802</span>a4 <span class="number">7994</span>:com.cooqi.servicedemo/u0a106&#125;</span><br><span class="line"><span class="number">07</span>-<span class="number">04</span> <span class="number">17</span>:<span class="number">24</span>:<span class="number">21.555</span>  <span class="number">1761</span>  <span class="number">3764</span> V ActiveServices: PUBLISHING ServiceRecord&#123;<span class="number">7454958</span> u0 com.cooqi.servicedemo/.service.AService&#125; Intent &#123; cmp=com.cooqi.servicedemo/.service.AService &#125;: android.os.BinderProxy@<span class="number">7161</span>b96</span><br><span class="line"><span class="number">07</span>-<span class="number">04</span> <span class="number">17</span>:<span class="number">24</span>:<span class="number">21.556</span>  <span class="number">1761</span>  <span class="number">3764</span> V ActiveServices: Publishing to: ConnectionRecord&#123;<span class="number">5</span>b95e3b u0 CR com.cooqi.servicedemo/.service.AService:<span class="meta">@abcfcca</span>&#125;</span><br><span class="line"><span class="number">07</span>-<span class="number">04</span> <span class="number">17</span>:<span class="number">24</span>:<span class="number">21.556</span>  <span class="number">1761</span>  <span class="number">3764</span> V ActiveServices: &lt;&lt;&lt; DONE EXECUTING ServiceRecord&#123;<span class="number">7454958</span> u0 com.cooqi.servicedemo/.service.AService&#125;: nesting=<span class="number">1</span>, inDestroying=<span class="keyword">false</span>, app=ProcessRecord&#123;<span class="number">39802</span>a4 <span class="number">7994</span>:com.cooqi.servicedemo/u0a106&#125;</span><br><span class="line"><span class="number">07</span>-<span class="number">04</span> <span class="number">17</span>:<span class="number">24</span>:<span class="number">21.556</span>  <span class="number">1761</span>  <span class="number">3764</span> V ActiveServices: Nesting at <span class="number">0</span> of com.cooqi.servicedemo/.service.AService</span><br><span class="line"><span class="number">07</span>-<span class="number">04</span> <span class="number">17</span>:<span class="number">24</span>:<span class="number">21.556</span>  <span class="number">1761</span>  <span class="number">3764</span> V ActiveServices: r.app.executingServices.size(): <span class="number">0</span></span><br><span class="line"><span class="number">07</span>-<span class="number">04</span> <span class="number">17</span>:<span class="number">24</span>:<span class="number">21.556</span>  <span class="number">1761</span>  <span class="number">3764</span> V ActiveServices: No more executingServices of com.cooqi.servicedemo/.service.AService</span><br><span class="line"><span class="number">07</span>-<span class="number">04</span> <span class="number">17</span>:<span class="number">24</span>:<span class="number">21.557</span>  <span class="number">7994</span>  <span class="number">7994</span> V ActivityThread: &lt;&lt;&lt; done: BIND_SERVICE</span><br><span class="line"><span class="number">07</span>-<span class="number">04</span> <span class="number">17</span>:<span class="number">24</span>:<span class="number">21.561</span>  <span class="number">7994</span>  <span class="number">7994</span> D MainActivity: onServiceConnected</span><br></pre></td></tr></table></figure>
</li>
</ul>
</li>
</ul>
<p><a href="http://www.tuicool.com/articles/67zyea" target="_blank" rel="noopener">http://www.tuicool.com/articles/67zyea</a></p>
</div></article><div class="post-copyright"><div class="post-copyright__author"><span class="post-copyright-meta">文章作者: </span><span class="post-copyright-info"><a href="mailto:undefined">Coolqi.Li</a></span></div><div class="post-copyright__type"><span class="post-copyright-meta">文章链接: </span><span class="post-copyright-info"><a href="http://yoursite.com/2016/04/13/Serivce 篇 4 - bindService 流程分析/">http://yoursite.com/2016/04/13/Serivce 篇 4 - bindService 流程分析/</a></span></div><div class="post-copyright__notice"><span class="post-copyright-meta">版权声明: </span><span class="post-copyright-info">本博客所有文章除特别声明外，均采用 <a href="https://creativecommons.org/licenses/by-nc-sa/4.0/">CC BY-NC-SA 4.0</a> 许可协议。转载请注明来自 <a href="http://yoursite.com">Coolqi`s Blog</a>！</span></div></div><div class="post-meta__tag-list"><a class="post-meta__tags" href="/tags/Service服务/">Service服务</a></div><div class="post-qr-code"><div class="post-qr-code-item"><img class="post-qr-code__img" src="/img/zfb.jpg"><div class="post-qr-code__desc">支付宝打赏</div></div><div class="post-qr-code-item"><img class="post-qr-code__img" src="/img/wechat.jpg"><div class="post-qr-code__desc">微信打赏</div></div></div><nav id="pagination"><div class="prev-post pull-left"><a href="/2016/04/13/Serivce 篇 5 - unbindService 流程分析/"><i class="fa fa-chevron-left">  </i><span>Serivce 篇 5 - unbindService 流程分析</span></a></div><div class="next-post pull-right"><a href="/2016/04/13/Service 篇 2 - startService 流程分析/"><span>Service 篇 3 - startService 流程分析</span><i class="fa fa-chevron-right"></i></a></div></nav><div class="post-adv"><a href="https://www.vultr.com/?ref=7231808"><img src="https://www.vultr.com/media/banner_1.png" width="728" height="90"></a></div></div></div><footer><div class="layout" id="footer"><div class="copyright">&copy;2015 - 2018 By Coolqi.Li</div><div class="framework-info"><span>驱动 - </span><a href="http://hexo.io"><span>Hexo</span></a><span class="footer-separator">|</span><span>主题 - </span><a href="https://github.com/Molunerfinn/hexo-theme-melody"><span>Melody</span></a></div><div class="footer_custom_text">Hi, welcome to my <a href="https://molunerfinn.com">blog</a>!</div><div class="busuanzi"><script async src="//dn-lbstatics.qbox.me/busuanzi/2.3/busuanzi.pure.mini.js"></script><span id="busuanzi_container_page_pv"><i class="fa fa-file-o"></i><span id="busuanzi_value_page_pv"></span><span></span></span></div></div></footer><i class="fa fa-arrow-up" id="go-up" aria-hidden="true"></i><script src="/js/third-party/anime.min.js"></script><script src="/js/third-party/jquery.min.js"></script><script src="/js/third-party/jquery.fancybox.min.js"></script><script src="/js/third-party/velocity.min.js"></script><script src="/js/third-party/velocity.ui.min.js"></script><script src="/js/utils.js?version=1.5.6"></script><script src="/js/fancybox.js?version=1.5.6"></script><script src="/js/sidebar.js?version=1.5.6"></script><script src="/js/copy.js?version=1.5.6"></script><script src="/js/fireworks.js?version=1.5.6"></script><script src="/js/transition.js?version=1.5.6"></script><script src="/js/scroll.js?version=1.5.6"></script><script src="/js/head.js?version=1.5.6"></script><script type="text/x-mathjax-config">MathJax.Hub.Config({
  tex2jax: {
    inlineMath: [ ['$','$'], ["\\(","\\)"]  ],
    processEscapes: true,
    skipTags: ['script', 'noscript', 'style', 'textarea', 'pre', 'code']
  },
  CommonHTML: {
    linebreaks: { automatic: true, width: "90% container" }
  },
  "HTML-CSS": { 
    linebreaks: { automatic: true, width: "90% container" }
  },
  "SVG": { 
    linebreaks: { automatic: true, width: "90% container" }
  }
});
</script><script type="text/x-mathjax-config">MathJax.Hub.Queue(function() {
  var all = MathJax.Hub.getAllJax(), i;
  for (i=0; i < all.length; i += 1) {
    all[i].SourceElement().parentNode.className += ' has-jax';
  }
});
</script><script src="https://cdn.jsdelivr.net/npm/mathjax/MathJax.js?config=TeX-AMS-MML_HTMLorMML"></script><script src="/js/search/local-search.js"></script><div class="search-dialog" id="local-search"><div class="search-dialog__title" id="local-search-title">本地搜索</div><div id="local-input-panel"><div id="local-search-input"><div class="local-search-box"><input class="local-search-box--input" placeholder="搜索文章"></div></div></div><hr><div id="local-search-results"><div id="local-hits"></div><div id="local-stats"><div class="local-search-stats__hr" id="hr"><span>由</span> <a href="https://github.com/wzpan/hexo-generator-search" style="color:#49B1F5;">hexo-generator-search</a>
 <span>提供支持</span></div></div></div><span class="search-close-button"><i class="fa fa-times"></i></span></div><div class="search-mask"></div></body></html>
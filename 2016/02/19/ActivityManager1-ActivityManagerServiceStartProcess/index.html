<!DOCTYPE html><html lang="zh-Hans"><head><meta charset="UTF-8"><meta http-equiv="X-UA-Compatible" content="IE=edge"><meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1"><meta name="description" content="ActivityManager第 1 篇 - ActivityManagerService 的启动"><meta name="keywords" content="ActivityManager活动管理"><meta name="author" content="Coolqi.Li,undefined"><meta name="copyright" content="Coolqi.Li"><title>ActivityManager第 1 篇 - ActivityManagerService 的启动 | Coolqi`s Blog</title><link rel="shortcut icon" href="/img/favicon.ico"><link rel="stylesheet" href="/css/index.css?version=1.5.6"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/font-awesome@4.7.0/css/font-awesome.min.css?version=1.5.6"><link rel="dns-prefetch" href="https://cdn.staticfile.org"><link rel="dns-prefetch" href="https://cdn.bootcss.com"><link rel="dns-prefetch" href="https://creativecommons.org"><link rel="stylesheet" type="text/css" href="https://cdn.jsdelivr.net/npm/gitalk/dist/gitalk.min.css"><script src="https://cdn.jsdelivr.net/gh/upupming/gitalk@36368e5dffd049e956cdbbd751ff96c28d8255cf/dist/gitalk.min.js"></script><script src="https://cdn.jsdelivr.net/npm/blueimp-md5@2.10.0/js/md5.min.js"></script><link rel="dns-prefetch" href="https://hm.baidu.com"><script>var _hmt = _hmt || [];
(function() {
  var hm = document.createElement("script");
  hm.src = "https://hm.baidu.com/hm.js?b7acef5306e54116ad8a99e8b753a92d";
  var s = document.getElementsByTagName("script")[0]; 
  s.parentNode.insertBefore(hm, s);
})();</script><script>var GLOBAL_CONFIG = { 
  root: '/',
  algolia: undefined,
  localSearch: {"path":"search.xml","languages":{"hits_empty":"找不到您查询的内容:${query}"}},
  copy: {
    success: '复制成功',
    error: '复制错误',
    noSupport: '浏览器不支持'
  }
} </script></head><body><canvas class="fireworks"></canvas><i class="fa fa-arrow-right" id="toggle-sidebar" aria-hidden="true"></i><div id="sidebar"><div class="toggle-sidebar-info text-center"><span data-toggle="切换文章详情">切换站点概览</span><hr></div><div class="sidebar-toc"><div class="sidebar-toc__title">目录</div><div class="sidebar-toc__progress"><span class="progress-notice">你已经读了</span><span class="progress-num">0</span><span class="progress-percentage">%</span><div class="sidebar-toc__progress-bar"></div></div><div class="sidebar-toc__content"><ol class="toc"><li class="toc-item toc-level-1"><a class="toc-link" href="#0-综述"><span class="toc-text">0 综述</span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#1-第一阶段-startBootstrapServices"><span class="toc-text">1 第一阶段 - startBootstrapServices</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#1-1-ActivityManagerService"><span class="toc-text">1.1 ActivityManagerService</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#1-1-1-new-ActivityStackSupervisor"><span class="toc-text">1.1.1 new ActivityStackSupervisor</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#1-1-2-new-ActivityStarter"><span class="toc-text">1.1.2 new ActivityStarter</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#1-1-3-new-RecentTasks"><span class="toc-text">1.1.3 new RecentTasks</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#1-1-3-1-new-TaskPersister"><span class="toc-text">1.1.3.1 new TaskPersister</span></a></li></ol></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#1-2-onStart"><span class="toc-text">1.2 onStart</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#1-3-initPowerManagement"><span class="toc-text">1.3 initPowerManagement</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#1-4-setSystemProcess"><span class="toc-text">1.4 setSystemProcess</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#1-4-1-ServiceManager-addService"><span class="toc-text">1.4.1 ServiceManager.addService</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#1-4-2-处理-framework-res-apk"><span class="toc-text">1.4.2 处理 framework-res.apk</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#1-4-2-1-ActivityThread-installSystemApplicaitonInfo"><span class="toc-text">1.4.2.1 ActivityThread.installSystemApplicaitonInfo</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#1-4-2-2-ContextImpl-installSystemApplicaitonInfo"><span class="toc-text">1.4.2.2 ContextImpl.installSystemApplicaitonInfo</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#1-4-2-3-LoadedAPK-installSystemApplicaitonInfo"><span class="toc-text">1.4.2.3 LoadedAPK.installSystemApplicaitonInfo</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#1-4-3-newProcessRecordLocked"><span class="toc-text">1.4.3 newProcessRecordLocked</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#1-4-3-1-addProcessNameLocked"><span class="toc-text">1.4.3.1 addProcessNameLocked</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#1-4-4-ProcessRecord-makeActive"><span class="toc-text">1.4.4 ProcessRecord.makeActive</span></a></li></ol></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#2-第二阶段-startCoreServices"><span class="toc-text">2 第二阶段 - startCoreServices</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#2-1-setUsageStatsManager"><span class="toc-text">2.1 setUsageStatsManager</span></a></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#3-第三阶段-startOtherServices"><span class="toc-text">3 第三阶段 - startOtherServices</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#3-1-AMS-installSystemProviders"><span class="toc-text">3.1 AMS.installSystemProviders</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#3-1-1-AMS-generateApplicationProvidersLocked"><span class="toc-text">3.1.1 AMS.generateApplicationProvidersLocked</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#3-1-2-ActivityThread-installSystemProviders"><span class="toc-text">3.1.2 ActivityThread.installSystemProviders</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#3-1-3-ActivityThread-installContentProviders"><span class="toc-text">3.1.3 ActivityThread.installContentProviders</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#3-1-3-1-ActivityThread-installProvider"><span class="toc-text">3.1.3.1 ActivityThread.installProvider</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#3-1-3-2-AactivityManagerN-publishContentProviders"><span class="toc-text">3.1.3.2 AactivityManagerN.publishContentProviders</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#3-1-3-阶段总结"><span class="toc-text">3.1.3 阶段总结</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#3-2-ActivityManagerS-setWindowManager"><span class="toc-text">3.2 ActivityManagerS.setWindowManager</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#3-2-1-ActivityStackSupervisor-getStack"><span class="toc-text">3.2.1 ActivityStackSupervisor.getStack</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#3-2-2-ActivityStackSupervisor-createStackOnDisplay"><span class="toc-text">3.2.2 ActivityStackSupervisor.createStackOnDisplay</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#3-2-2-1-new-ActivityContainer"><span class="toc-text">3.2.2.1 new ActivityContainer</span></a><ol class="toc-child"><li class="toc-item toc-level-5"><a class="toc-link" href="#3-2-2-2-1-new-ActivityStack"><span class="toc-text">3.2.2.2.1 new ActivityStack</span></a></li></ol></li><li class="toc-item toc-level-4"><a class="toc-link" href="#3-2-2-2-ActivityContainer-attachToDisplayLocked"><span class="toc-text">3.2.2.2 ActivityContainer.attachToDisplayLocked</span></a><ol class="toc-child"><li class="toc-item toc-level-5"><a class="toc-link" href="#3-2-2-2-1-ActivityStack-attachDisplay"><span class="toc-text">3.2.2.2.1 ActivityStack.attachDisplay</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#3-2-2-2-2-ActivityDisplay-attachActivities"><span class="toc-text">3.2.2.2.2 ActivityDisplay.attachActivities</span></a></li></ol></li></ol></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#3-3-ActivityManagerS-systemReady"><span class="toc-text">3.3 ActivityManagerS.systemReady</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#3-3-1-通知其他服务-SystemReady"><span class="toc-text">3.3.1 通知其他服务 - SystemReady</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#3-3-1-1-UserController-onSystemReady"><span class="toc-text">3.3.1.1 UserController.onSystemReady</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#3-3-1-2-RecentTasks-onSystemReady"><span class="toc-text">3.3.1.2 RecentTasks.onSystemReady</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#3-3-1-3-AppOpsService-onSystemReady"><span class="toc-text">3.3.1.3 AppOpsService.onSystemReady</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#3-3-2-杀掉特定进程"><span class="toc-text">3.3.2 杀掉特定进程</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#3-3-2-1-isAllowedWhileBooting"><span class="toc-text">3.3.2.1 isAllowedWhileBooting</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#3-3-3-读取设置信息-retrieveSettings"><span class="toc-text">3.3.3 读取设置信息 - retrieveSettings</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#3-3-4-读取-Uri-权限信息"><span class="toc-text">3.3.4 读取 Uri 权限信息</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#3-3-4-1-读取-Uri-权限信息"><span class="toc-text">3.3.4.1 读取 Uri 权限信息</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#3-3-4-2-ActivityManagerS-findOrCreateUriPermissionLocked"><span class="toc-text">3.3.4.2 ActivityManagerS.findOrCreateUriPermissionLocked</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#3-3-5-启动-persistent-进程-startPersistentApps"><span class="toc-text">3.3.5 启动 persistent 进程 - startPersistentApps</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#3-3-5-1-ActivityManagerS-addAppLocked"><span class="toc-text">3.3.5.1 ActivityManagerS.addAppLocked</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#3-3-6-启动桌面进程"><span class="toc-text">3.3.6 启动桌面进程</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#3-3-6-1-startHomeActivityLocked"><span class="toc-text">3.3.6.1 startHomeActivityLocked</span></a><ol class="toc-child"><li class="toc-item toc-level-5"><a class="toc-link" href="#3-3-6-1-1-ActivityManagerS-getHomeIntent"><span class="toc-text">3.3.6.1.1 ActivityManagerS.getHomeIntent</span></a></li></ol></li><li class="toc-item toc-level-4"><a class="toc-link" href="#3-3-6-2-ActivityThread-handleResumeActivity"><span class="toc-text">3.3.6.2 ActivityThread.handleResumeActivity</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#3-3-6-3-ActivityManagerS-activityIdle"><span class="toc-text">3.3.6.3 ActivityManagerS.activityIdle</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#3-3-6-4-ActivityManagerS-activityIdleInternalLocked"><span class="toc-text">3.3.6.4 ActivityManagerS.activityIdleInternalLocked</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#3-3-6-5-ActivityStackS-checkFinishBootingLocked"><span class="toc-text">3.3.6.5 ActivityStackS.checkFinishBootingLocked</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#3-3-6-6-ActivityManagerS-finishBooting"><span class="toc-text">3.3.6.6 ActivityManagerS.finishBooting</span></a></li></ol></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#4-总结"><span class="toc-text">4 总结</span></a></li></ol></li></ol></div></div><div class="author-info hide"><div class="author-info__avatar text-center"><img src="/img/avatar.png"></div><div class="author-info__name text-center">Coolqi.Li</div><div class="author-info__description text-center">“你好，我是李帅奇，Android 系统工程师，MineCraft 忠实玩家，设计和绘画爱好者，缺妹纸晚期患者，熬夜星人。”</div><hr><div class="author-info-articles"><a class="author-info-articles__archives article-meta" href="/archives"><span class="pull-left">文章</span><span class="pull-right">64</span></a><a class="author-info-articles__tags article-meta" href="/tags"><span class="pull-left">标签</span><span class="pull-right">14</span></a><a class="author-info-articles__categories article-meta" href="/categories"><span class="pull-left">分类</span><span class="pull-right">15</span></a></div><hr><div class="author-info-links"><div class="author-info-links__title text-center">Links</div><a class="author-info-links__name text-center" href="https://developer.android.google.cn/">AndroidDeveloper</a><a class="author-info-links__name text-center" href="http://www.android-studio.org/">AndroidStudio</a><a class="author-info-links__name text-center" href="https://www.jianshu.com/u/123a20a96441">简书</a><a class="author-info-links__name text-center" href="https://weibo.com/coolqiLi">微博</a></div></div></div><div id="content-outer"><div id="top-container" style="background-image: url(https://ws1.sinaimg.cn/large/8700af19ly1fvpabr30o6j22yo1o0q7i.jpg)"><div id="page-header"><span class="pull-left"> <a id="site-name" href="/">Coolqi`s Blog</a></span><i class="fa fa-bars toggle-menu pull-right" aria-hidden="true"></i><span class="pull-right menus"><a class="site-page social-icon search"><i class="fa fa-search"></i><span> 搜索</span></a><a class="site-page" href="/">Home</a><a class="site-page" href="/categories">Categories</a><a class="site-page" href="/tags">Tags</a><a class="site-page" href="/about">About</a><a class="site-page" href="/archives">Archives</a></span></div><div id="post-info"><div id="post-title">ActivityManager第 1 篇 - ActivityManagerService 的启动</div><div id="post-meta"><time class="post-meta__date"><i class="fa fa-calendar" aria-hidden="true"></i> 2016-02-19</time><span class="post-meta__separator">|</span><i class="fa fa-inbox post-meta__icon" aria-hidden="true"></i><a class="post-meta__categories" href="/categories/AndroidFramework源码分析/">AndroidFramework源码分析</a><i class="fa fa-angle-right" aria-hidden="true"></i><i class="fa fa-inbox post-meta__icon" aria-hidden="true"></i><a class="post-meta__categories" href="/categories/AndroidFramework源码分析/ActivityManager活动管理/">ActivityManager活动管理</a><div class="post-meta-wordcount"><span>字数总计: </span><span class="word-count">13.5k</span><span class="post-meta__separator">|</span><span>阅读时长: 62 分钟</span></div></div></div></div><div class="layout" id="content-inner"><article id="post"><div class="article-container" id="post-content"><p>[toc]</p>
<p>基于 <code>Android 7.1.1</code> 源码分析 <code>AMS</code> 的机制，本文为作者原创，转载请说明出处，谢谢！ </p>
<h1 id="0-综述"><a href="#0-综述" class="headerlink" title="0 综述"></a>0 综述</h1><p><code>Android</code> 系统开机时，在 <code>SystemService</code> 进程被 <code>Zygote</code> 启动后，<code>SystemSevice</code> 进程需要启动一些系统的重要服务：<br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">Trace.traceBegin(Trace.TRACE_TAG_SYSTEM_SERVER, <span class="string">"StartServices"</span>);</span><br><span class="line">startBootstrapServices();</span><br><span class="line">startCoreServices();</span><br><span class="line">startOtherServices();</span><br></pre></td></tr></table></figure></p>
<p><code>AMS</code> 的启动涉及到了以上的每个阶段，以为 <code>AMS</code> 需要和其他的系统服务进行交互，下面我们来逐一分析:</p>
<h1 id="1-第一阶段-startBootstrapServices"><a href="#1-第一阶段-startBootstrapServices" class="headerlink" title="1 第一阶段 - startBootstrapServices"></a>1 第一阶段 - startBootstrapServices</h1><p>我们来看看低级阶段，和 <code>AMS</code> 相关的代码；</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">startBootstrapServices</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// 启动 Installer 系统服务</span></span><br><span class="line">    Installer installer = mSystemServiceManager.startService(Installer.class);</span><br><span class="line"></span><br><span class="line">    <span class="comment">//【1】第一阶段：启动 AMS</span></span><br><span class="line">    mActivityManagerService = mSystemServiceManager.startService(</span><br><span class="line">            ActivityManagerService.Lifecycle.class).getService();</span><br><span class="line">    mActivityManagerService.setSystemServiceManager(mSystemServiceManager);</span><br><span class="line">    mActivityManagerService.setInstaller(installer);</span><br><span class="line"></span><br><span class="line">    <span class="comment">//【2】第二阶段，启动 PowerManagerService，AMS 初始化电池管理属性</span></span><br><span class="line">    mPowerManagerService = mSystemServiceManager.startService(PowerManagerService.class);</span><br><span class="line">    mActivityManagerService.initPowerManagement();</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 启动 LED 和背光灯、显示、包管理这些重要的系统服务！</span></span><br><span class="line">    mSystemServiceManager.startService(LightsService.class);</span><br><span class="line">    mDisplayManagerService = mSystemServiceManager.startService(DisplayManagerService.class);</span><br><span class="line"></span><br><span class="line">    mSystemServiceManager.startBootPhase(SystemService.PHASE_WAIT_FOR_DEFAULT_DISPLAY);</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 获得系统属性 vold.decrypt 的值，表示是否只加载核心服务；</span></span><br><span class="line">    String cryptState = SystemProperties.get(<span class="string">"vold.decrypt"</span>);</span><br><span class="line">    <span class="keyword">if</span> (ENCRYPTING_STATE.equals(cryptState)) &#123;</span><br><span class="line">        Slog.w(TAG, <span class="string">"Detected encryption in progress - only parsing core apps"</span>);</span><br><span class="line">        mOnlyCore = <span class="keyword">true</span>;</span><br><span class="line"></span><br><span class="line">    &#125; <span class="keyword">else</span> <span class="keyword">if</span> (ENCRYPTED_STATE.equals(cryptState)) &#123;</span><br><span class="line">        Slog.w(TAG, <span class="string">"Device encrypted - only parsing core apps"</span>);</span><br><span class="line">        mOnlyCore = <span class="keyword">true</span>;</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// 创建 PMS 服务对象，</span></span><br><span class="line">    mPackageManagerService = PackageManagerService.main(mSystemContext, installer,</span><br><span class="line">            mFactoryTestMode != FactoryTest.FACTORY_TEST_OFF, mOnlyCore);</span><br><span class="line">    mFirstBoot = mPackageManagerService.isFirstBoot();</span><br><span class="line">    <span class="comment">// 和 A/B 升级相关！</span></span><br><span class="line">    <span class="keyword">if</span> (!mOnlyCore) &#123;</span><br><span class="line">        <span class="keyword">boolean</span> disableOtaDexopt = SystemProperties.getBoolean(<span class="string">"config.disable_otadexopt"</span>,</span><br><span class="line">                <span class="keyword">false</span>);</span><br><span class="line">        <span class="keyword">if</span> (!disableOtaDexopt) &#123;</span><br><span class="line">            traceBeginAndSlog(<span class="string">"StartOtaDexOptService"</span>);</span><br><span class="line">            <span class="keyword">try</span> &#123;</span><br><span class="line">                OtaDexoptService.main(mSystemContext, mPackageManagerService);</span><br><span class="line">            &#125; <span class="keyword">catch</span> (Throwable e) &#123;</span><br><span class="line">                reportWtf(<span class="string">"starting OtaDexOptService"</span>, e);</span><br><span class="line">            &#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">                Trace.traceEnd(Trace.TRACE_TAG_SYSTEM_SERVER);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 启动用户管理服务！</span></span><br><span class="line">    mSystemServiceManager.startService(UserManagerService.LifeCycle.class);</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 初始化属性缓存，用于缓存包资源</span></span><br><span class="line">    AttributeCache.init(mSystemContext);</span><br><span class="line"></span><br><span class="line">    <span class="comment">//【4】设置系统进程相关的参数！</span></span><br><span class="line">    mActivityManagerService.setSystemProcess();</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 启动 Sensor 相关的服务。这是一个 Native 方法，与硬件相关度较大，这里不关注。</span></span><br><span class="line">    startSensorService();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<ul>
<li>启动 <code>AMS</code> 之前，需要先连接 <code>installd</code> 进程， 通过 <code>Installer</code> 这个服务，就能完成一些重要目录的创建，譬如 <code>/data/user</code>，同时应用程序的安装，也需要这个服务。</li>
<li>启动 <code>ActivityManagerService</code> 服务；</li>
<li>启动 <code>PowerManagerService</code> 服务，<code>AMS</code> 需要使用 <code>PowerManagerService</code> 的服务：譬如，在启动 <code>Activity</code> 时，要避免系统进入休眠状态，就需要获取 <code>WakeLock</code>；</li>
<li>启动 <code>LightsService</code>、 <code>DisplayManagerService</code>、 <code>PackageManagerService</code> 系统服务；</li>
<li>启动 <code>OtaDexoptService</code> 服务，这里是和 A/B 升级相关的；</li>
<li>调用 <code>AMS.setSystemProcess()</code> 设置当前进程为系统进程，设置系统进程相关的参数；<ul>
<li>因为 <code>AMS</code> 的职责之一就是维护系统中所有进程的状态，不管是应用进程还是系统进程，都是 <code>AMS</code> 的管辖范围。</li>
</ul>
</li>
</ul>
<p>接下来，我们来看看和 <code>AMS</code> 相关的流程！</p>
<h2 id="1-1-ActivityManagerService"><a href="#1-1-ActivityManagerService" class="headerlink" title="1.1 ActivityManagerService"></a>1.1 ActivityManagerService</h2><p>接下来，我们仔细的看看 <code>AMS</code> 的构造器！<br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="title">ActivityManagerService</span><span class="params">(Context systemContext)</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 获得系统进程的上下文环境；</span></span><br><span class="line">    mContext = systemContext;</span><br><span class="line">    mFactoryTest = FactoryTest.getMode(); <span class="comment">// 是否是工厂模式！</span></span><br><span class="line">    </span><br><span class="line">    <span class="comment">// 获得 SystemServer 进程的 ActivityThread 对象，每个进程都有一个！</span></span><br><span class="line">    mSystemThread = ActivityThread.currentActivityThread();</span><br><span class="line"></span><br><span class="line">    Slog.i(TAG, <span class="string">"Memory class: "</span> + ActivityManager.staticGetMemoryClass());</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 创建处理消息的 HandlerThread 和 Handler 对象！</span></span><br><span class="line">    mHandlerThread = <span class="keyword">new</span> ServiceThread(TAG,</span><br><span class="line">            android.os.Process.THREAD_PRIORITY_FOREGROUND, <span class="keyword">false</span> <span class="comment">/*allowIo*/</span>);</span><br><span class="line">    mHandlerThread.start();</span><br><span class="line">    mHandler = <span class="keyword">new</span> MainHandler(mHandlerThread.getLooper());</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 创建处理 ANR 相关的 Handler！</span></span><br><span class="line">    mUiHandler = <span class="keyword">new</span> UiHandler();</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 这里的 sKillHandler 绑定了一个 handlerThread 线程对象，用于处理杀进程的消息！</span></span><br><span class="line">    <span class="keyword">if</span> (sKillHandler == <span class="keyword">null</span>) &#123;</span><br><span class="line">        sKillThread = <span class="keyword">new</span> ServiceThread(TAG + <span class="string">":kill"</span>,</span><br><span class="line">                android.os.Process.THREAD_PRIORITY_BACKGROUND, <span class="keyword">true</span> <span class="comment">/* allowIo */</span>);</span><br><span class="line">        sKillThread.start();</span><br><span class="line">        sKillHandler = <span class="keyword">new</span> KillHandler(sKillThread.getLooper());</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 集合管理前台广播和后台广播的集合，有前 / 后台之分，为了区分不同的广播消息超时时间。</span></span><br><span class="line">    mFgBroadcastQueue = <span class="keyword">new</span> BroadcastQueue(<span class="keyword">this</span>, mHandler,</span><br><span class="line">            <span class="string">"foreground"</span>, BROADCAST_FG_TIMEOUT, <span class="keyword">false</span>);</span><br><span class="line">    mBgBroadcastQueue = <span class="keyword">new</span> BroadcastQueue(<span class="keyword">this</span>, mHandler,</span><br><span class="line">            <span class="string">"background"</span>, BROADCAST_BG_TIMEOUT, <span class="keyword">true</span>);</span><br><span class="line">    mBroadcastQueues[<span class="number">0</span>] = mFgBroadcastQueue;</span><br><span class="line">    mBroadcastQueues[<span class="number">1</span>] = mBgBroadcastQueue;</span><br><span class="line">  </span><br><span class="line">    mServices = <span class="keyword">new</span> ActiveServices(<span class="keyword">this</span>); <span class="comment">// 创建管理 Service 组件的 ActiveServices 对象！</span></span><br><span class="line">    mProviderMap = <span class="keyword">new</span> ProviderMap(<span class="keyword">this</span>); <span class="comment">// 创建管理 Provider 组件的 ProviderMap 对象！</span></span><br><span class="line"></span><br><span class="line">    mAppErrors = <span class="keyword">new</span> AppErrors(mContext, <span class="keyword">this</span>); <span class="comment">// 创建管理 ANR 和 crash 的 AppError 对象！</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">// 创建 /data/system 目录，诸如包管理packages.xml, packages.list等文件都存放于此目录</span></span><br><span class="line">    File dataDir = Environment.getDataDirectory();</span><br><span class="line">    File systemDir = <span class="keyword">new</span> File(dataDir, <span class="string">"system"</span>);</span><br><span class="line">    systemDir.mkdirs();</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// 创建电量统计服务 BatteryStatsService 对象，并将 mHandler 传入，用于通信！</span></span><br><span class="line">    mBatteryStatsService = <span class="keyword">new</span> BatteryStatsService(systemDir, mHandler);</span><br><span class="line">    mBatteryStatsService.getActiveStatistics().readLocked();</span><br><span class="line">    mBatteryStatsService.scheduleWriteToDisk();</span><br><span class="line">    mOnBattery = DEBUG_POWER ? <span class="keyword">true</span></span><br><span class="line">            : mBatteryStatsService.getActiveStatistics().getIsOnBattery();</span><br><span class="line">    mBatteryStatsService.getActiveStatistics().setCallback(<span class="keyword">this</span>);</span><br><span class="line">   </span><br><span class="line">    <span class="comment">// 创建进程状态监控服务 ProcessStatsService 对象，/data/system/procstats 文件会存储</span></span><br><span class="line">    <span class="comment">// 进程的状态信息！</span></span><br><span class="line">    mProcessStats = <span class="keyword">new</span> ProcessStatsService(<span class="keyword">this</span>, <span class="keyword">new</span> File(systemDir, <span class="string">"procstats"</span>));</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// 创建应用操作监控服务 AppOpsService 对象，/data/system/appops.xml文件存储app的</span></span><br><span class="line">    <span class="comment">// 权限设置和操作信息！</span></span><br><span class="line">    mAppOpsService = <span class="keyword">new</span> AppOpsService(<span class="keyword">new</span> File(systemDir, <span class="string">"appops.xml"</span>), mHandler);</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 监听是否允许应用在后台运行的操作</span></span><br><span class="line">    mAppOpsService.startWatchingMode(AppOpsManager.OP_RUN_IN_BACKGROUND, <span class="keyword">null</span>,</span><br><span class="line">            <span class="keyword">new</span> IAppOpsCallback.Stub() &#123;</span><br><span class="line">                <span class="meta">@Override</span> <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">opChanged</span><span class="params">(<span class="keyword">int</span> op, <span class="keyword">int</span> uid, String packageName)</span> </span>&#123;</span><br><span class="line">                    <span class="keyword">if</span> (op == AppOpsManager.OP_RUN_IN_BACKGROUND &amp;&amp; packageName != <span class="keyword">null</span>) &#123;</span><br><span class="line">                        <span class="keyword">if</span> (mAppOpsService.checkOperation(op, uid, packageName)</span><br><span class="line">                                != AppOpsManager.MODE_ALLOWED) &#123;</span><br><span class="line">                            runInBackgroundDisabled(uid);</span><br><span class="line">                        &#125;</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;);</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// 创建 urigrants.xml 文件对象！</span></span><br><span class="line">    mGrantFile = <span class="keyword">new</span> AtomicFile(<span class="keyword">new</span> File(systemDir, <span class="string">"urigrants.xml"</span>));</span><br><span class="line">    <span class="comment">// 创建 UserController 对象！</span></span><br><span class="line">    mUserController = <span class="keyword">new</span> UserController(<span class="keyword">this</span>);</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 获取 OpenGL 版本号</span></span><br><span class="line">    GL_ES_VERSION = SystemProperties.getInt(<span class="string">"ro.opengles.version"</span>,</span><br><span class="line">        ConfigurationInfo.GL_ES_VERSION_UNDEFINED);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (SystemProperties.getInt(<span class="string">"sys.use_fifo_ui"</span>, <span class="number">0</span>) != <span class="number">0</span>) &#123;</span><br><span class="line">        mUseFifoUiScheduling = <span class="keyword">true</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    mTrackingAssociations = <span class="string">"1"</span>.equals(SystemProperties.get(<span class="string">"debug.track-associations"</span>));</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 配置区域、语言、字体、屏幕方向等，启动 Activity 时，需要用到这个配置！</span></span><br><span class="line">    mConfiguration.setToDefaults();</span><br><span class="line">    mConfiguration.setLocales(LocaleList.getDefault());</span><br><span class="line">    mConfigurationSeq = mConfiguration.seq = <span class="number">1</span>;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// 初始化 processCpuTracker 对象，用来收集 ANR 情况下的 cpu 使用情况，电池状态等等！</span></span><br><span class="line">    mProcessCpuTracker.init();</span><br><span class="line"></span><br><span class="line">    <span class="comment">// AndroidManifest.xml 中 compatible-screens 相关的解析工具</span></span><br><span class="line">    mCompatModePackages = <span class="keyword">new</span> CompatModePackages(<span class="keyword">this</span>, systemDir, mHandler);</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// 创建 instent 防火墙！</span></span><br><span class="line">    mIntentFirewall = <span class="keyword">new</span> IntentFirewall(<span class="keyword">new</span> IntentFirewallInterface(), mHandler);</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// 创建管理组件 Activity 的 ActivityStackSupervisor 和 ActivityStarter 对象！</span></span><br><span class="line">    mStackSupervisor = <span class="keyword">new</span> ActivityStackSupervisor(<span class="keyword">this</span>);</span><br><span class="line">    mActivityStarter = <span class="keyword">new</span> ActivityStarter(<span class="keyword">this</span>, mStackSupervisor);</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 创建最近任务对象！</span></span><br><span class="line">    mRecentTasks = <span class="keyword">new</span> RecentTasks(<span class="keyword">this</span>, mStackSupervisor);</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// 创建一个子线程，不断循环，更新 cpu 的状态信息！</span></span><br><span class="line">    mProcessCpuThread = <span class="keyword">new</span> Thread(<span class="string">"CpuTracker"</span>) &#123;</span><br><span class="line">        <span class="meta">@Override</span></span><br><span class="line">        <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">run</span><span class="params">()</span> </span>&#123;</span><br><span class="line">            <span class="keyword">while</span> (<span class="keyword">true</span>) &#123;</span><br><span class="line">                <span class="keyword">try</span> &#123;</span><br><span class="line">                    <span class="keyword">try</span> &#123;</span><br><span class="line">                        <span class="keyword">synchronized</span>(<span class="keyword">this</span>) &#123;</span><br><span class="line">                            <span class="keyword">final</span> <span class="keyword">long</span> now = SystemClock.uptimeMillis();</span><br><span class="line">                            <span class="keyword">long</span> nextCpuDelay = (mLastCpuTime.get()+MONITOR_CPU_MAX_TIME)-now;</span><br><span class="line">                            <span class="keyword">long</span> nextWriteDelay = (mLastWriteTime+BATTERY_STATS_TIME)-now;</span><br><span class="line">                            <span class="comment">//Slog.i(TAG, "Cpu delay=" + nextCpuDelay</span></span><br><span class="line">                            <span class="comment">//        + ", write delay=" + nextWriteDelay);</span></span><br><span class="line">                            <span class="keyword">if</span> (nextWriteDelay &lt; nextCpuDelay) &#123;</span><br><span class="line">                                nextCpuDelay = nextWriteDelay;</span><br><span class="line">                            &#125;</span><br><span class="line">                            <span class="keyword">if</span> (nextCpuDelay &gt; <span class="number">0</span>) &#123;</span><br><span class="line">                                mProcessCpuMutexFree.set(<span class="keyword">true</span>);</span><br><span class="line">                                <span class="keyword">this</span>.wait(nextCpuDelay);</span><br><span class="line">                            &#125;</span><br><span class="line">                        &#125;</span><br><span class="line">                    &#125; <span class="keyword">catch</span> (InterruptedException e) &#123;</span><br><span class="line">                    &#125;</span><br><span class="line">                    <span class="comment">// 更新 cpu 的状态以及电池状态信息！</span></span><br><span class="line">                    updateCpuStatsNow();</span><br><span class="line">                &#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">                    Slog.e(TAG, <span class="string">"Unexpected exception collecting process stats"</span>, e);</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 将自身加入到 Watchdog 的监控中！</span></span><br><span class="line">    Watchdog.getInstance().addMonitor(<span class="keyword">this</span>);</span><br><span class="line">    Watchdog.getInstance().addThread(mHandler);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>我们总结一下，在 AMS 的构造器中，主要做了一下几个事情：</p>
<ul>
<li><p>创建了系统目录：<code>/data/system</code></p>
</li>
<li><p>创建了几个系统服务对象：</p>
<ul>
<li><code>BatteryStatsService</code>：用于监控电池状态；</li>
<li><code>ProcessStatsService</code>：用于监控进程状态；</li>
<li><code>AppOpsService</code>：用于监控 <code>app</code> 的操作行为；</li>
<li><code>UserController</code>：</li>
</ul>
</li>
<li><p>创建了四大组件的管理对象；</p>
<ul>
<li><code>Broadcast</code>：<code>mFgBroadcastQueue</code> 和 <code>mBgBroadcastQueue</code>，分别管理前台后台广播；</li>
<li><code>Service</code>：<code>ActiveServices</code>；</li>
<li><code>Provider</code>：<code>ProviderMap</code>；</li>
<li><code>Activity</code>：<code>mStackSupervisor</code>，<code>mActivityStarter</code>；</li>
</ul>
</li>
<li><p>创建了处理 <code>ANR</code> 和 <code>Crash</code> 的对象：<code>mAppErrors</code>；</p>
</li>
<li>创建最近任务对象：<code>RecentTasks</code>；</li>
</ul>
<p>初次之外，还有：</p>
<ul>
<li>初始化 <code>processCpuTracker</code> 对象！</li>
<li>创建了几个 <code>Handler</code>，用于消息处理：<ul>
<li><code>MainHandler</code>：绑定了子线程 <code>ServiceThread</code> 对象 <code>mHandlerThread</code>，<code>AMS</code> 会把它传递个给其他服务，用于交互；</li>
<li><code>UiHandler</code>：绑定了系统进程的主线程，用于处理 <code>ANR</code> 和 <code>Crash</code> 相关的信息！</li>
<li><code>sKillThread</code>：绑定了子线程 <code>ServiceThread</code> 对象 <code>sKillThread</code>，用于处理杀进程的操作；</li>
</ul>
</li>
<li>创建几个子线程<ul>
<li>一个线程 <code>mProcessCpuThread</code>，不断的更新 <code>cpu</code> 和电池的状态信息；</li>
<li>两个 <code>ServiceThread</code> 子线程；</li>
</ul>
</li>
</ul>
<h3 id="1-1-1-new-ActivityStackSupervisor"><a href="#1-1-1-new-ActivityStackSupervisor" class="headerlink" title="1.1.1 new ActivityStackSupervisor"></a>1.1.1 new ActivityStackSupervisor</h3><p><code>ActivityStackSupervisor</code> 是系统中所有的 <code>ActivityStack</code> 的管理对象！<br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="title">ActivityStackSupervisor</span><span class="params">(ActivityManagerService service)</span> </span>&#123;</span><br><span class="line">    mService = service;</span><br><span class="line">    <span class="comment">// 创建了一个 ActivityStackSupervisorHandler 的 Handler 对象！</span></span><br><span class="line">    mHandler = <span class="keyword">new</span> ActivityStackSupervisorHandler(mService.mHandler.getLooper());</span><br><span class="line">    mActivityMetricsLogger = <span class="keyword">new</span> ActivityMetricsLogger(<span class="keyword">this</span>, mService.mContext);</span><br><span class="line">    mResizeDockedStackTimeout = <span class="keyword">new</span> ResizeDockedStackTimeout(service, <span class="keyword">this</span>, mHandler);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<h3 id="1-1-2-new-ActivityStarter"><a href="#1-1-2-new-ActivityStarter" class="headerlink" title="1.1.2 new ActivityStarter"></a>1.1.2 new ActivityStarter</h3><p><code>ActivityStarter</code> 对象负责启动 <code>activity</code>：<br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">ActivityStarter(ActivityManagerService service, ActivityStackSupervisor supervisor) &#123;</span><br><span class="line">    mService = service;</span><br><span class="line">    mSupervisor = supervisor;</span><br><span class="line">    mInterceptor = <span class="keyword">new</span> ActivityStartInterceptor(mService, mSupervisor);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<h3 id="1-1-3-new-RecentTasks"><a href="#1-1-3-new-RecentTasks" class="headerlink" title="1.1.3 new RecentTasks"></a>1.1.3 new RecentTasks</h3><p>创建最近任务管理对象！<br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">RecentTasks(ActivityManagerService service, ActivityStackSupervisor mStackSupervisor) &#123;</span><br><span class="line">    <span class="comment">// 对应 /data/system 目录</span></span><br><span class="line">    File systemDir = Environment.getDataSystemDirectory();</span><br><span class="line">    mService = service;</span><br><span class="line">    <span class="comment">// 创建 TaskPersister 对象，用于管理那些重启后可恢复的任务！</span></span><br><span class="line">    mTaskPersister = <span class="keyword">new</span> TaskPersister(systemDir, mStackSupervisor, service, <span class="keyword">this</span>);</span><br><span class="line">    <span class="comment">// 将最近任务对象传递给 StackSupervisor！</span></span><br><span class="line">    mStackSupervisor.setRecentTasks(<span class="keyword">this</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p><code>TaskPersister</code> 对象用于管理那些重启后可恢复的任务，下面我们去看看：</p>
<h4 id="1-1-3-1-new-TaskPersister"><a href="#1-1-3-1-new-TaskPersister" class="headerlink" title="1.1.3.1 new TaskPersister"></a>1.1.3.1 new TaskPersister</h4><p>用于管理系统中所有的 <code>persisable</code> 类型的 <code>task</code>：<br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line">TaskPersister(File systemDir, ActivityStackSupervisor stackSupervisor,</span><br><span class="line">        ActivityManagerService service, RecentTasks recentTasks) &#123;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 删除目录：/data/system/recent_images 和其子目录！</span></span><br><span class="line">    <span class="keyword">final</span> File legacyImagesDir = <span class="keyword">new</span> File(systemDir, IMAGES_DIRNAME);</span><br><span class="line">    <span class="keyword">if</span> (legacyImagesDir.exists()) &#123;</span><br><span class="line">        <span class="keyword">if</span> (!FileUtils.deleteContents(legacyImagesDir) || !legacyImagesDir.delete()) &#123;</span><br><span class="line">            Slog.i(TAG, <span class="string">"Failure deleting legacy images directory: "</span> + legacyImagesDir);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// 删除目录：/data/system/recent_tasks 和其子目录！</span></span><br><span class="line">    <span class="keyword">final</span> File legacyTasksDir = <span class="keyword">new</span> File(systemDir, TASKS_DIRNAME);</span><br><span class="line">    <span class="keyword">if</span> (legacyTasksDir.exists()) &#123;</span><br><span class="line">        <span class="keyword">if</span> (!FileUtils.deleteContents(legacyTasksDir) || !legacyTasksDir.delete()) &#123;</span><br><span class="line">            Slog.i(TAG, <span class="string">"Failure deleting legacy tasks directory: "</span> + legacyTasksDir);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// 创建目录 ：/data/system_de，保存了 persisable 任务的 id；</span></span><br><span class="line">    mTaskIdsDir = <span class="keyword">new</span> File(Environment.getDataDirectory(), <span class="string">"system_de"</span>);</span><br><span class="line">    mStackSupervisor = stackSupervisor;</span><br><span class="line">    mService = service;</span><br><span class="line">    mRecentTasks = recentTasks;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 创建一个线程对象，用于写数据！</span></span><br><span class="line">    mLazyTaskWriterThread = <span class="keyword">new</span> LazyTaskWriterThread(<span class="string">"LazyTaskWriterThread"</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>这里我来简单的说一下：</p>
<ul>
<li>在 <code>/data/system_de</code> 目录下，会有一个以设备用户 <code>id</code> 命名的文件夹，内部会有一个名为 <code>persisted_taskIds.txt</code> 的文件，内部保存了所有的 <code>persisable</code> 类型的 <code>task</code> 的 <code>id</code>；</li>
</ul>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">lishuaiqi:/data/system_de # ls -al</span><br><span class="line">drwxrwx---  <span class="number">3</span> system system <span class="number">4096</span> <span class="number">2017</span>-<span class="number">08</span>-<span class="number">10</span> <span class="number">08</span>:<span class="number">58</span> <span class="number">0</span></span><br><span class="line">lishuaiqi:/data/system_de/0 # ls -al</span><br><span class="line">-rw-------  <span class="number">1</span> system system   <span class="number">28</span> <span class="number">2017</span>-<span class="number">08</span>-<span class="number">14</span> <span class="number">01</span>:<span class="number">30</span> persisted_taskIds.txt</span><br><span class="line">lishuaiqi:/data/system_de/0 # cat persisted_taskIds.txt</span><br><span class="line"><span class="number">278</span></span><br><span class="line"><span class="number">279</span></span><br><span class="line"><span class="number">320</span></span><br></pre></td></tr></table></figure>
<ul>
<li>在 <code>/data/system_de</code> 目录下，会有一个以设备用户 <code>id</code> 命名的文件夹，内部会有两个文件夹：<code>recent_images</code> 和 <code>recent_tasks</code>：</li>
</ul>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">lishuaiqi:/data/system_ce/0 # ls -al</span><br><span class="line">drwx------ <span class="number">2</span> system system  <span class="number">4096</span> <span class="number">2017</span>-<span class="number">08</span>-<span class="number">14</span> <span class="number">01</span>:<span class="number">30</span> recent_images</span><br><span class="line">drwx------ <span class="number">2</span> system system  <span class="number">4096</span> <span class="number">2017</span>-<span class="number">08</span>-<span class="number">14</span> <span class="number">01</span>:<span class="number">31</span> recent_tasks</span><br></pre></td></tr></table></figure>
<p>其中，<code>recent_images</code> 用来保存 <code>task</code> 的截图信息，文件名的格式为：<code>[task_id]_task_thumbnail.png</code><br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">lishuaiqi:/data/system_ce/0/recent_images # ls -al</span><br><span class="line">-rw------- <span class="number">1</span> system system  <span class="number">68019</span> <span class="number">2017</span>-<span class="number">08</span>-<span class="number">14</span> <span class="number">01</span>:<span class="number">30</span> <span class="number">326</span>_task_thumbnail.png</span><br><span class="line">-rw------- <span class="number">1</span> system system  <span class="number">18394</span> <span class="number">2017</span>-<span class="number">08</span>-<span class="number">14</span> <span class="number">01</span>:<span class="number">30</span> <span class="number">327</span>_task_thumbnail.png</span><br></pre></td></tr></table></figure></p>
<p>其中，<code>recent_tasks</code> 用来保存 <code>task</code> 的信息，文件名的格式为：<code>[task_id]_task.xml</code><br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">lishuaiqi:/data/system_ce/0/recent_tasks # ls -al</span><br><span class="line">-rw------- <span class="number">1</span> system system <span class="number">1107</span> <span class="number">2017</span>-<span class="number">08</span>-<span class="number">14</span> <span class="number">16</span>:<span class="number">58</span> <span class="number">279</span>_task.xml</span><br><span class="line">-rw------- <span class="number">1</span> system system <span class="number">1116</span> <span class="number">2017</span>-<span class="number">08</span>-<span class="number">19</span> <span class="number">19</span>:<span class="number">06</span> <span class="number">320</span>_task.xml</span><br></pre></td></tr></table></figure></p>
<p>下面我们来看看 <code>[task_id]_task.xml</code> 文件中有那些奇葩的属性，这里以腾讯微信为例子：<br><figure class="highlight"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br></pre></td><td class="code"><pre><span class="line">&lt;task task_id=<span class="string">"278"</span> </span><br><span class="line">	  real_activity=<span class="string">"com.tencent.mm/.ui.LauncherUI"</span> </span><br><span class="line">	  real_activity_suspended=<span class="string">"false"</span> </span><br><span class="line">	  affinity=<span class="string">"com.tencent.mm"</span> </span><br><span class="line">	  root_has_reset=<span class="string">"true"</span> </span><br><span class="line">	  auto_remove_recents=<span class="string">"false"</span> </span><br><span class="line">	  asked_compat_mode=<span class="string">"false"</span> </span><br><span class="line">	  user_id=<span class="string">"0"</span> </span><br><span class="line">	  user_setup_complete=<span class="string">"true"</span> </span><br><span class="line">	  effective_uid=<span class="string">"10109"</span> </span><br><span class="line">	  task_type=<span class="string">"0"</span> </span><br><span class="line">	  first_active_time=<span class="string">"1502678072409"</span> </span><br><span class="line">	  last_active_time=<span class="string">"1502678115558"</span> </span><br><span class="line">	  last_time_moved=<span class="string">"1502678078477"</span> </span><br><span class="line">	  never_relinquish_identity=<span class="string">"true"</span> </span><br><span class="line">	  task_description_color=<span class="string">"ff212121"</span> </span><br><span class="line">	  task_description_colorBackground=<span class="string">"fffafafa"</span> </span><br><span class="line">	  task_thumbnailinfo_task_width=<span class="string">"1080"</span> </span><br><span class="line">	  task_thumbnailinfo_task_height=<span class="string">"1920"</span> </span><br><span class="line">	  task_thumbnailinfo_screen_orientation=<span class="string">"1"</span> </span><br><span class="line">	  task_affiliation_color=<span class="string">"-14606047"</span> </span><br><span class="line">	  task_affiliation=<span class="string">"278"</span> </span><br><span class="line">	  prev_affiliation=<span class="string">"-1"</span> </span><br><span class="line">	  next_affiliation=<span class="string">"-1"</span> </span><br><span class="line">	  calling_uid=<span class="string">"10109"</span> </span><br><span class="line">	  calling_package=<span class="string">"com.tencent.mm"</span> </span><br><span class="line">	  resize_mode=<span class="string">"4"</span> </span><br><span class="line">	  privileged=<span class="string">"false"</span> </span><br><span class="line">	  min_width=<span class="string">"-1"</span> </span><br><span class="line">	  min_height=<span class="string">"-1"</span>&gt;</span><br><span class="line"></span><br><span class="line">	&lt;intent action=<span class="string">"android.intent.action.MAIN"</span> </span><br><span class="line">	        component=<span class="string">"com.tencent.mm/.ui.LauncherUI"</span> </span><br><span class="line">			flags=<span class="string">"10200000"</span>&gt;</span><br><span class="line">		&lt;categories category=<span class="string">"android.intent.category.LAUNCHER"</span> /&gt;</span><br><span class="line">	&lt;/intent&gt;</span><br><span class="line">&lt;/task&gt;</span><br></pre></td></tr></table></figure></p>
<p>可以看到，所有的 <code>persisable</code> 类型的 <code>task</code>，系统会将这些属性保存到对应的文件中，开机后可以恢复！</p>
<h2 id="1-2-onStart"><a href="#1-2-onStart" class="headerlink" title="1.2 onStart"></a>1.2 onStart</h2><p>调用构造器，创建完 <code>AMS</code> 的对象之后，要做的就是启动 <code>AMS</code> 哦，在上一篇中，我们有看到，启动先调用 <code>LifeCircle</code> 的 <code>onStart</code> ，然后会调用了 <code>AMS</code> 的 <code>start</code> 方法：<br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">start</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    <span class="comment">// 移除所有的进程组！</span></span><br><span class="line">    Process.removeAllProcessGroups();</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 启动 ProcessCpuThread，监控 cpu 和电池的状态！</span></span><br><span class="line">    mProcessCpuThread.start();</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// 将 BatteryStatsService 服务和 AppOpsService 注册到 ServiceManager 中，用于进程间通讯！</span></span><br><span class="line">    mBatteryStatsService.publish(mContext);</span><br><span class="line">    mAppOpsService.publish(mContext);</span><br><span class="line">    Slog.d(<span class="string">"AppOps"</span>, <span class="string">"AppOpsService published"</span>);</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// 将 AMS 添加进入 LocalServices 集合中，用于同一进程内的本地通信！</span></span><br><span class="line">    LocalServices.addService(ActivityManagerInternal.class, <span class="keyword">new</span> LocalService());</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>这个方法很简单，就不多说了：</p>
<ul>
<li>移除所有的进程组；并启动 <code>ProcessCpuThread</code>，监控 <code>cpu</code> 和电池的状态！</li>
<li>将 <code>BatteryStatsService</code> 服务和 <code>AppOpsService</code> 注册到 <code>ServiceManager</code> 中，用于 <code>Binder</code> 通讯！  </li>
</ul>
<h2 id="1-3-initPowerManagement"><a href="#1-3-initPowerManagement" class="headerlink" title="1.3 initPowerManagement"></a>1.3 initPowerManagement</h2><p>接下来，初始化 电池管理：<br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">initPowerManagement</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    <span class="comment">// 初始化电池管理！</span></span><br><span class="line">    mStackSupervisor.initPowerManagement();</span><br><span class="line">    mBatteryStatsService.initPowerManagement();</span><br><span class="line"></span><br><span class="line">    mLocalPowerManager = LocalServices.getService(PowerManagerInternal.class);</span><br><span class="line">    </span><br><span class="line">    PowerManager pm = (PowerManager)mContext.getSystemService(Context.POWER_SERVICE);</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// 获得 WakeLock！</span></span><br><span class="line">    mVoiceWakeLock = pm.newWakeLock(PowerManager.PARTIAL_WAKE_LOCK, <span class="string">"*voice*"</span>);</span><br><span class="line">    mVoiceWakeLock.setReferenceCounted(<span class="keyword">false</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>这里主要是进一步的初始化电池管理！</p>
<h2 id="1-4-setSystemProcess"><a href="#1-4-setSystemProcess" class="headerlink" title="1.4 setSystemProcess"></a>1.4 setSystemProcess</h2><p>接下来，是设置 SytemServer 系统进程的相关信息，我们来看看代码，这里要仔细的来看了！<br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">setSystemProcess</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line"></span><br><span class="line">        <span class="comment">//【1】注册一些系统相关的服务</span></span><br><span class="line">        ServiceManager.addService(Context.ACTIVITY_SERVICE, <span class="keyword">this</span>, <span class="keyword">true</span>);</span><br><span class="line">        ServiceManager.addService(ProcessStats.SERVICE_NAME, mProcessStats);</span><br><span class="line">        ServiceManager.addService(<span class="string">"meminfo"</span>, <span class="keyword">new</span> MemBinder(<span class="keyword">this</span>));</span><br><span class="line">        ServiceManager.addService(<span class="string">"gfxinfo"</span>, <span class="keyword">new</span> GraphicsBinder(<span class="keyword">this</span>));</span><br><span class="line">        ServiceManager.addService(<span class="string">"dbinfo"</span>, <span class="keyword">new</span> DbBinder(<span class="keyword">this</span>));</span><br><span class="line">        <span class="keyword">if</span> (MONITOR_CPU_USAGE) &#123;</span><br><span class="line">            ServiceManager.addService(<span class="string">"cpuinfo"</span>, <span class="keyword">new</span> CpuBinder(<span class="keyword">this</span>));</span><br><span class="line">        &#125;</span><br><span class="line">        ServiceManager.addService(<span class="string">"permission"</span>, <span class="keyword">new</span> PermissionController(<span class="keyword">this</span>));</span><br><span class="line">        ServiceManager.addService(<span class="string">"processinfo"</span>, <span class="keyword">new</span> ProcessInfoService(<span class="keyword">this</span>));</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 从 PackageManagerService 中获取 framework-res.apk (包名为 android) 的 ApplicationInfo 信息!</span></span><br><span class="line">        ApplicationInfo info = mContext.getPackageManager().getApplicationInfo(<span class="string">"android"</span>, STOCK_PM_FLAGS | MATCH_SYSTEM_ONLY);</span><br><span class="line"></span><br><span class="line">        <span class="comment">//【2】保存 framework-res.apk 的信息到系统进程的主线程中！</span></span><br><span class="line">        mSystemThread.installSystemApplicationInfo(info, getClass().getClassLoader());</span><br><span class="line">        </span><br><span class="line">        <span class="keyword">synchronized</span> (<span class="keyword">this</span>) &#123;</span><br><span class="line"></span><br><span class="line">            <span class="comment">// 初始化系统进程的 ProcessRecord</span></span><br><span class="line">            ProcessRecord app = newProcessRecordLocked(info, info.processName, <span class="keyword">false</span>, <span class="number">0</span>);</span><br><span class="line">            app.persistent = <span class="keyword">true</span>; <span class="comment">// 设置为常驻进程</span></span><br><span class="line">            app.pid = MY_PID; <span class="comment">// 设置 pid</span></span><br><span class="line">            app.maxAdj = ProcessList.SYSTEM_ADJ; <span class="comment">// 设置系统进程的 adj 为 -900，很难被杀死哦！</span></span><br><span class="line">            </span><br><span class="line">            <span class="comment">// 使系统进程处于活跃状态</span></span><br><span class="line">            app.makeActive(mSystemThread.getApplicationThread(), mProcessStats);</span><br><span class="line">            <span class="keyword">synchronized</span> (mPidsSelfLocked) &#123;</span><br><span class="line">                <span class="comment">// 将 systemServer 进程对象加入到 mPidsSelfLocked 中，以便管理！</span></span><br><span class="line">                mPidsSelfLocked.put(app.pid, app);</span><br><span class="line">            &#125;</span><br><span class="line">            </span><br><span class="line">            <span class="comment">// 更新最近使用进程列表</span></span><br><span class="line">            updateLruProcessLocked(app, <span class="keyword">false</span>, <span class="keyword">null</span>);</span><br><span class="line">            <span class="comment">// 用于更新进程的oom_adj值</span></span><br><span class="line">            updateOomAdjLocked();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125; <span class="keyword">catch</span> (PackageManager.NameNotFoundException e) &#123;</span><br><span class="line">        <span class="keyword">throw</span> <span class="keyword">new</span> RuntimeException(<span class="string">"Unable to find android system package"</span>, e);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>上面代码中用到了 <code>mPidsSelfLocked</code> 变量，我们看下这个变量的定义：<br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">final</span> SparseArray&lt;ProcessRecord&gt; mPidsSelfLocked = <span class="keyword">new</span> SparseArray&lt;ProcessRecord&gt;();</span><br></pre></td></tr></table></figure></p>
<p><code>mPidsSelfLocked</code> 保存有 <code>pid</code> 组织起来的正在运行的进程，保存的是 <code>pid</code>，及 <code>pid</code> 对应的 <code>ProcessRecord</code>。</p>
<p>这里我们来总结一下，这方法主要做了什么：</p>
<ul>
<li>注册一些系统相关的服务，我们可以通过 <code>adb shell dumpsys</code> 命令查看！</li>
<li>获取 <code>framework-res.apk</code> 安装包信息，保存到系统进程的 <code>ActivityThread</code> 对象中！</li>
<li>创建 <code>SystemServer</code> 系统进程的进程结构体，初始化属性，将其加入  <code>mPidsSelfLocked</code> ，用于管理！</li>
<li>更新进程的优先级和 <code>oomAdj</code>，这两个方法，我们后面单开一贴！！！</li>
</ul>
<p>下面我们仔细的看看一些细节，有利于我们对 <code>AMS</code> 的结构有一个更深层次的理解！</p>
<h3 id="1-4-1-ServiceManager-addService"><a href="#1-4-1-ServiceManager-addService" class="headerlink" title="1.4.1 ServiceManager.addService"></a>1.4.1 ServiceManager.addService</h3><p>第一步，注册一些重要的服务，包括 ActivityManagerService 自身！<br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 注册一些系统相关的服务</span></span><br><span class="line">ServiceManager.addService(Context.ACTIVITY_SERVICE, <span class="keyword">this</span>, <span class="keyword">true</span>);</span><br><span class="line">ServiceManager.addService(ProcessStats.SERVICE_NAME, mProcessStats);</span><br><span class="line">ServiceManager.addService(<span class="string">"meminfo"</span>, <span class="keyword">new</span> MemBinder(<span class="keyword">this</span>));</span><br><span class="line">ServiceManager.addService(<span class="string">"gfxinfo"</span>, <span class="keyword">new</span> GraphicsBinder(<span class="keyword">this</span>));</span><br><span class="line">ServiceManager.addService(<span class="string">"dbinfo"</span>, <span class="keyword">new</span> DbBinder(<span class="keyword">this</span>));</span><br><span class="line"><span class="keyword">if</span> (MONITOR_CPU_USAGE) &#123;</span><br><span class="line">    ServiceManager.addService(<span class="string">"cpuinfo"</span>, <span class="keyword">new</span> CpuBinder(<span class="keyword">this</span>));</span><br><span class="line">&#125;</span><br><span class="line">ServiceManager.addService(<span class="string">"permission"</span>, <span class="keyword">new</span> PermissionController(<span class="keyword">this</span>));</span><br><span class="line">ServiceManager.addService(<span class="string">"processinfo"</span>, <span class="keyword">new</span> ProcessInfoService(<span class="keyword">this</span>));</span><br></pre></td></tr></table></figure></p>
<p>这里注册了哪些服务呢？这里用到了几个静态变量：</p>
<blockquote>
<p>Context.ACTIVITY_SERVICE = “activity”;<br>ProcessStats.SERVICE_NAME = “procstats”;</p>
</blockquote>
<p>这里注册了那些服务呢，我们来看看：</p>
<table>
<thead>
<tr>
<th>服务名</th>
<th>类名</th>
<th>功能</th>
</tr>
</thead>
<tbody>
<tr>
<td><code>procstats</code></td>
<td><code>ProcessStatsService</code></td>
<td>监控进程信息的服务</td>
</tr>
<tr>
<td><code>cpuinfo</code></td>
<td><code>CpuBinder</code></td>
<td>监控CPU信息的服务</td>
</tr>
<tr>
<td><code>meminfo</code></td>
<td><code>MemBinder</code></td>
<td>dump系统中每个进程的内存使用状况的服务</td>
</tr>
<tr>
<td><code>gfxinfo</code></td>
<td><code>GraphicsBinder</code></td>
<td>dump系统中每个进程使用图形加速卡状态的服务</td>
</tr>
<tr>
<td><code>dbinfo</code></td>
<td><code>DbBinder</code></td>
<td>dump 系统中每个进程的db状况的服务</td>
</tr>
<tr>
<td><code>permission</code></td>
<td><code>PermissionController</code></td>
<td>是检查Binder调用权限的服务</td>
</tr>
<tr>
<td><code>processinfo</code></td>
<td><code>ProcessInfoService</code></td>
<td>进程信息</td>
</tr>
</tbody>
</table>
<p>这些服务我们先不细看，后面遇到了，再具体分析！</p>
<h3 id="1-4-2-处理-framework-res-apk"><a href="#1-4-2-处理-framework-res-apk" class="headerlink" title="1.4.2 处理 framework-res.apk"></a>1.4.2 处理 framework-res.apk</h3><p>接着，处理 <code>framework-res.apk</code> 安装包，在 <code>PMS</code> 的启动过程中，<code>PackageManagerService</code> 会扫描 <code>framework-res.apk</code> 的信息，并将信息封装成 <code>ApplicaitonInfo</code> 并保存在一个集合中：<br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">mSystemThread.installSystemApplicationInfo(info, getClass().getClassLoader());</span><br></pre></td></tr></table></figure></p>
<p><code>mSystemThread</code> 对象是 <code>ActvityThread</code> 实例，每一个进程都有一个 <code>ActivityThread</code>  对象，内部保存着进程的主线程对象，这里保存着 <code>SystemServer</code>进程的主线程对象！</p>
<p>我们继续看方法调用：</p>
<h4 id="1-4-2-1-ActivityThread-installSystemApplicaitonInfo"><a href="#1-4-2-1-ActivityThread-installSystemApplicaitonInfo" class="headerlink" title="1.4.2.1 ActivityThread.installSystemApplicaitonInfo"></a>1.4.2.1 ActivityThread.installSystemApplicaitonInfo</h4><p>我们进入 <code>ActivityThread</code> 的 <code>installSystemApplicationInfo</code> 的方法：<br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">installSystemApplicationInfo</span><span class="params">(ApplicationInfo info, ClassLoader classLoader)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">synchronized</span> (<span class="keyword">this</span>) &#123;</span><br><span class="line"></span><br><span class="line">        <span class="comment">//【1】调用 ContextImpl 对象的 installSystemApplicationInfo 方法！</span></span><br><span class="line">        getSystemContext().installSystemApplicationInfo(info, classLoader);</span><br><span class="line">        mProfiler = <span class="keyword">new</span> Profiler();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p><code>getSystemContext</code> 方法获得的是系统进程的 <code>Context</code> 对象，<code>Context</code> 的具体实现是 <code>ContextImpl</code> 类！</p>
<h4 id="1-4-2-2-ContextImpl-installSystemApplicaitonInfo"><a href="#1-4-2-2-ContextImpl-installSystemApplicaitonInfo" class="headerlink" title="1.4.2.2 ContextImpl.installSystemApplicaitonInfo"></a>1.4.2.2 ContextImpl.installSystemApplicaitonInfo</h4><p>进入 <code>ContextImpl</code> 对象中：<br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">installSystemApplicationInfo</span><span class="params">(ApplicationInfo info, ClassLoader classLoader)</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//【1】调用 LoadedApk.installSystemApplicationInfo 方法；</span></span><br><span class="line">    mPackageInfo.installSystemApplicationInfo(info, classLoader);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>其中 <code>mPackageInfo</code> 是 <code>LoadedApk</code> 对象，这里的 <code>LoadedApk</code> 是属于 <code>SystemServer</code> 进程的：</p>
<h4 id="1-4-2-3-LoadedAPK-installSystemApplicaitonInfo"><a href="#1-4-2-3-LoadedAPK-installSystemApplicaitonInfo" class="headerlink" title="1.4.2.3 LoadedAPK.installSystemApplicaitonInfo"></a>1.4.2.3 LoadedAPK.installSystemApplicaitonInfo</h4><p>最后，将 <code>framework-res.apk</code> 的安装信息，保存到 <code>SystemServer</code> 进程的主线程的 <code>LoadedAPK</code> 对象中！<br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">installSystemApplicationInfo</span><span class="params">(ApplicationInfo info, ClassLoader classLoader)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">assert</span> info.packageName.equals(<span class="string">"android"</span>);</span><br><span class="line">    mApplicationInfo = info;</span><br><span class="line">    mClassLoader = classLoader;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>每一个进程都会有一个 <code>LoadedApk</code> 对象，最后 <code>ApplicationInfo</code> 和 <code>ClassLoader</code> 设置到了 <code>LoadedApk</code> 对象中！</p>
<h3 id="1-4-3-newProcessRecordLocked"><a href="#1-4-3-newProcessRecordLocked" class="headerlink" title="1.4.3 newProcessRecordLocked"></a>1.4.3 newProcessRecordLocked</h3><p>接下来，创建系统进程对应的 <code>ProcessRecord</code> 对象，传入参数：</p>
<ul>
<li><code>info</code>：<code>&quot;framework-res.apk&quot;</code> 的 <code>ApplicationInfo</code> 对象！</li>
<li><code>customProcess</code>：<code>info.processName</code>，所在进程名！</li>
<li><code>isolated</code>：传入 <code>false</code>，表示不是隔离进程！</li>
<li><code>isolatedUid</code>：传入 <code>0</code>，表示隔离进程的 <code>uid</code>；</li>
</ul>
<p><code>isolated</code> 和 <code>isolatedUid</code> 用来表示这进程是不是一个隔离进程！<br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">final</span> ProcessRecord <span class="title">newProcessRecordLocked</span><span class="params">(ApplicationInfo info, String customProcess,</span></span></span><br><span class="line"><span class="function"><span class="params">        <span class="keyword">boolean</span> isolated, <span class="keyword">int</span> isolatedUid)</span> </span>&#123;</span><br><span class="line">    String proc = customProcess != <span class="keyword">null</span> ? customProcess : info.processName;</span><br><span class="line">    BatteryStatsImpl stats = mBatteryStatsService.getActiveStatistics();</span><br><span class="line"></span><br><span class="line">    <span class="keyword">final</span> <span class="keyword">int</span> userId = UserHandle.getUserId(info.uid); <span class="comment">// 获得所属的设备用户！</span></span><br><span class="line">    <span class="keyword">int</span> uid = info.uid;</span><br><span class="line">    <span class="keyword">if</span> (isolated) &#123; <span class="comment">// isolated 为 false, 不进入这个分支!</span></span><br><span class="line">        <span class="keyword">if</span> (isolatedUid == <span class="number">0</span>) &#123;</span><br><span class="line">            <span class="keyword">int</span> stepsLeft = Process.LAST_ISOLATED_UID - Process.FIRST_ISOLATED_UID + <span class="number">1</span>;</span><br><span class="line">            <span class="keyword">while</span> (<span class="keyword">true</span>) &#123;</span><br><span class="line">                <span class="keyword">if</span> (mNextIsolatedProcessUid &lt; Process.FIRST_ISOLATED_UID</span><br><span class="line">                        || mNextIsolatedProcessUid &gt; Process.LAST_ISOLATED_UID) &#123;</span><br><span class="line">                    mNextIsolatedProcessUid = Process.FIRST_ISOLATED_UID;</span><br><span class="line">                &#125;</span><br><span class="line">                uid = UserHandle.getUid(userId, mNextIsolatedProcessUid);</span><br><span class="line">                mNextIsolatedProcessUid++;</span><br><span class="line">                <span class="keyword">if</span> (mIsolatedProcesses.indexOfKey(uid) &lt; <span class="number">0</span>) &#123;</span><br><span class="line">                    <span class="comment">// No process for this uid, use it.</span></span><br><span class="line">                    <span class="keyword">break</span>;</span><br><span class="line">                &#125;</span><br><span class="line">                stepsLeft--;</span><br><span class="line">                <span class="keyword">if</span> (stepsLeft &lt;= <span class="number">0</span>) &#123;</span><br><span class="line">                    <span class="keyword">return</span> <span class="keyword">null</span>;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            <span class="comment">// Special case for startIsolatedProcess (internal only), where</span></span><br><span class="line">            <span class="comment">// the uid of the isolated process is specified by the caller.</span></span><br><span class="line">            uid = isolatedUid;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//【1】创建 ProcessRecord，用于存储系统进程的信息</span></span><br><span class="line">    <span class="keyword">final</span> ProcessRecord r = <span class="keyword">new</span> ProcessRecord(stats, info, proc, uid);</span><br><span class="line">    <span class="keyword">if</span> (!mBooted &amp;&amp; !mBooting</span><br><span class="line">            &amp;&amp; userId == UserHandle.USER_SYSTEM</span><br><span class="line">            &amp;&amp; (info.flags &amp; PERSISTENT_MASK) == PERSISTENT_MASK) &#123;</span><br><span class="line">        r.persistent = <span class="keyword">true</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//【2】保存系统进程 ProcessRecord 对象到 AMS 的结构体中！</span></span><br><span class="line">    addProcessNameLocked(r);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> r;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>接着，调用 <code>addProcessNameLocked</code> 方法：</p>
<h4 id="1-4-3-1-addProcessNameLocked"><a href="#1-4-3-1-addProcessNameLocked" class="headerlink" title="1.4.3.1 addProcessNameLocked"></a>1.4.3.1 addProcessNameLocked</h4><p>保存系统进程 <code>ProcessRecord</code> 对象到 <code>AMS</code> 的结构体中！<br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">final</span> <span class="keyword">void</span> <span class="title">addProcessNameLocked</span><span class="params">(ProcessRecord proc)</span> </span>&#123;</span><br><span class="line">    <span class="comment">//【1】如果已经有了相同的 ProcessRecord 对象，移除旧的！</span></span><br><span class="line">    ProcessRecord old = removeProcessNameLocked(proc.processName, proc.uid);</span><br><span class="line">    <span class="keyword">if</span> (old == proc &amp;&amp; proc.persistent) &#123;</span><br><span class="line">        Slog.w(TAG, <span class="string">"Re-adding persistent process "</span> + proc);</span><br><span class="line">    &#125; <span class="keyword">else</span> <span class="keyword">if</span> (old != <span class="keyword">null</span>) &#123;</span><br><span class="line">        Slog.wtf(TAG, <span class="string">"Already have existing proc "</span> + old + <span class="string">" when adding "</span> + proc);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//【2】创建 UidRecord 用来保存活跃的 uid，如果已经存在，就不创建！</span></span><br><span class="line">    UidRecord uidRec = mActiveUids.get(proc.uid); </span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (uidRec == <span class="keyword">null</span>) &#123;</span><br><span class="line">        uidRec = <span class="keyword">new</span> UidRecord(proc.uid);</span><br><span class="line"></span><br><span class="line">        <span class="comment">// This is the first appearance of the uid, report it now!</span></span><br><span class="line">        <span class="keyword">if</span> (DEBUG_UID_OBSERVERS) Slog.i(TAG_UID_OBSERVERS,</span><br><span class="line">                <span class="string">"Creating new process uid: "</span> + uidRec);</span><br><span class="line">                </span><br><span class="line">        <span class="comment">// 添加到 mActiveUids 对象！</span></span><br><span class="line">        mActiveUids.put(proc.uid, uidRec);</span><br><span class="line">        noteUidProcessState(uidRec.uid, uidRec.curProcState);</span><br><span class="line">        enqueueUidChangeLocked(uidRec, -<span class="number">1</span>, UidRecord.CHANGE_ACTIVE);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    proc.uidRecord = uidRec;</span><br><span class="line">    uidRec.numProcs++; <span class="comment">// 所属该 uid 的进程计数加 1 （uid 代表一个应用程序）</span></span><br><span class="line">    </span><br><span class="line">    <span class="comment">//【3】非隔离进程保存到 mProcessNames 集合中，隔离进程保存到 mIsolatedProcesses 中！</span></span><br><span class="line">    mProcessNames.put(proc.processName, proc.uid, proc); </span><br><span class="line">    <span class="keyword">if</span> (proc.isolated) &#123;</span><br><span class="line">        mIsolatedProcesses.put(proc.uid, proc);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<h3 id="1-4-4-ProcessRecord-makeActive"><a href="#1-4-4-ProcessRecord-makeActive" class="headerlink" title="1.4.4 ProcessRecord.makeActive"></a>1.4.4 ProcessRecord.makeActive</h3><p>参数传递：</p>
<ul>
<li><code>thread</code>：<code>mSystemThread.getApplicationThread()</code>，系统进程的 <code>ApplicationThread</code> 对象！</li>
<li><code>tracker</code>：<code>mProcessStats</code>，是 <code>ProcessStatsService</code> 服务对象，用来监听进程的状态！</li>
</ul>
<p><br></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br></pre></td><td class="code"><pre><span class="line"> <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">makeActive</span><span class="params">(IApplicationThread _thread, ProcessStatsService tracker)</span> </span>&#123;</span><br><span class="line">    <span class="comment">// 第一次进来，为null！</span></span><br><span class="line">    <span class="keyword">if</span> (thread == <span class="keyword">null</span>) &#123;</span><br><span class="line"></span><br><span class="line">        <span class="comment">//【1】将旧的 ProcessState 对象设置为非活跃状态！</span></span><br><span class="line">        <span class="keyword">final</span> ProcessState origBase = baseProcessTracker; </span><br><span class="line">        <span class="keyword">if</span> (origBase != <span class="keyword">null</span>) &#123;</span><br><span class="line">            origBase.setState(ProcessStats.STATE_NOTHING,</span><br><span class="line">                    tracker.getMemFactorLocked(), SystemClock.uptimeMillis(), pkgList);</span><br><span class="line">            origBase.makeInactive();</span><br><span class="line">        &#125;</span><br><span class="line">        </span><br><span class="line">        <span class="comment">// 为系统进程创建新的 ProcessState 监听对象，并设置其为活跃状态！</span></span><br><span class="line">        <span class="comment">// info 为改应用程序所属的应用程序！</span></span><br><span class="line">        baseProcessTracker = tracker.getProcessStateLocked(info.packageName, uid,</span><br><span class="line">                info.versionCode, processName);</span><br><span class="line">        baseProcessTracker.makeActive();</span><br><span class="line"></span><br><span class="line">        <span class="keyword">for</span> (<span class="keyword">int</span> i=<span class="number">0</span>; i&lt;pkgList.size(); i++) &#123;</span><br><span class="line">            ProcessStats.ProcessStateHolder holder = pkgList.valueAt(i);</span><br><span class="line">            <span class="keyword">if</span> (holder.state != <span class="keyword">null</span> &amp;&amp; holder.state != origBase) &#123;</span><br><span class="line">                holder.state.makeInactive();</span><br><span class="line">            &#125;</span><br><span class="line">            holder.state = tracker.getProcessStateLocked(pkgList.keyAt(i), uid,</span><br><span class="line">                    info.versionCode, processName);</span><br><span class="line">            <span class="keyword">if</span> (holder.state != baseProcessTracker) &#123;</span><br><span class="line">                holder.state.makeActive();</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">//【2】将系统进程的 ActivityThread 保存到 ProcessRecord.thread，完成引用关系！</span></span><br><span class="line">    thread = _thread;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>以上是在 <code>SystemServer</code> 启动系统服务的第一阶段做的一些主要的工作，接下来，我们来看第二阶段！</p>
<h1 id="2-第二阶段-startCoreServices"><a href="#2-第二阶段-startCoreServices" class="headerlink" title="2 第二阶段 - startCoreServices"></a>2 第二阶段 - startCoreServices</h1><p>接下来，看看第二阶段的代码段：<br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">startCoreServices</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    <span class="comment">// 启动电池服务,必须是在 lightService 后启动 ；</span></span><br><span class="line">    mSystemServiceManager.startService(BatteryService.class);</span><br><span class="line"></span><br><span class="line">    <span class="comment">//【1】启动应用统计服务，用于监控应用的使用频率等信息，并使得 AMS 持有其引用！</span></span><br><span class="line">    mSystemServiceManager.startService(UsageStatsService.class);</span><br><span class="line">    mActivityManagerService.setUsageStatsManager(</span><br><span class="line">            LocalServices.getService(UsageStatsManagerInternal.class));</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 启动 WebView 更新服务，这里不关注！</span></span><br><span class="line">    mWebViewUpdateService = mSystemServiceManager.startService(WebViewUpdateService.class);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>这里我们看看 <code>setUsageStatsManager</code></p>
<h2 id="2-1-setUsageStatsManager"><a href="#2-1-setUsageStatsManager" class="headerlink" title="2.1 setUsageStatsManager"></a>2.1 setUsageStatsManager</h2><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">setUsageStatsManager</span><span class="params">(UsageStatsManagerInternal usageStatsManager)</span> </span>&#123;</span><br><span class="line">    mUsageStatsService = usageStatsManager;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>这个方法主要的作用是：</p>
<ul>
<li>设置应用统计服务的应用，用于监控应用的使用频率等信息！</li>
</ul>
<h1 id="3-第三阶段-startOtherServices"><a href="#3-第三阶段-startOtherServices" class="headerlink" title="3 第三阶段 - startOtherServices"></a>3 第三阶段 - startOtherServices</h1><p>这里就要进入开机的最后阶段了，<code>startOtherServices</code> 方法非常的长，这里只列举和 <code>ams</code> 相关的代码！<br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">startOtherServices</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line"></span><br><span class="line">        ... ... ... ...</span><br><span class="line">        </span><br><span class="line">        <span class="comment">//【1】安装系统进程的 provider！</span></span><br><span class="line">        traceBeginAndSlog(<span class="string">"InstallSystemProviders"</span>);</span><br><span class="line">        mActivityManagerService.installSystemProviders();</span><br><span class="line">        Trace.traceEnd(Trace.TRACE_TAG_SYSTEM_SERVER);</span><br><span class="line"></span><br><span class="line">        ... ... ... ...</span><br><span class="line">        </span><br><span class="line">        <span class="comment">// 初始化 watch dog 实例！</span></span><br><span class="line">        traceBeginAndSlog(<span class="string">"InitWatchdog"</span>);</span><br><span class="line">        <span class="keyword">final</span> Watchdog watchdog = Watchdog.getInstance();</span><br><span class="line">        watchdog.init(context, mActivityManagerService);</span><br><span class="line">        Trace.traceEnd(Trace.TRACE_TAG_SYSTEM_SERVER);</span><br><span class="line">        </span><br><span class="line">        <span class="comment">// 启动 InputManagerService 和 WindowManagerService 服务！</span></span><br><span class="line">        traceBeginAndSlog(<span class="string">"StartInputManagerService"</span>);</span><br><span class="line">        inputManager = <span class="keyword">new</span> InputManagerService(context);</span><br><span class="line">        Trace.traceEnd(Trace.TRACE_TAG_SYSTEM_SERVER);</span><br><span class="line"></span><br><span class="line">        traceBeginAndSlog(<span class="string">"StartWindowManagerService"</span>);</span><br><span class="line">        wm = WindowManagerService.main(context, inputManager,</span><br><span class="line">                mFactoryTestMode != FactoryTest.FACTORY_TEST_LOW_LEVEL,</span><br><span class="line">                !mFirstBoot, mOnlyCore);</span><br><span class="line">        ServiceManager.addService(Context.WINDOW_SERVICE, wm);</span><br><span class="line">        ServiceManager.addService(Context.INPUT_SERVICE, inputManager);</span><br><span class="line">        Trace.traceEnd(Trace.TRACE_TAG_SYSTEM_SERVER);</span><br><span class="line">        </span><br><span class="line">        ... ... ... ...</span><br><span class="line">        </span><br><span class="line">        <span class="comment">//【2】将 WMS 的引用实例保存到 ams 中！</span></span><br><span class="line">        mActivityManagerService.setWindowManager(wm);</span><br><span class="line"></span><br><span class="line">        inputManager.setWindowManagerCallbacks(wm.getInputMonitor());</span><br><span class="line">        inputManager.start();</span><br><span class="line"></span><br><span class="line">        ... ... ... ...</span><br><span class="line">   </span><br><span class="line">    &#125; <span class="keyword">catch</span> (RuntimeException e) &#123;</span><br><span class="line">        Slog.e(<span class="string">"System"</span>, <span class="string">"******************************************"</span>);</span><br><span class="line">        Slog.e(<span class="string">"System"</span>, <span class="string">"************ Failure starting core service"</span>, e);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    ... ... ... ...</span><br><span class="line"></span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">        wm.displayReady();</span><br><span class="line">    &#125; <span class="keyword">catch</span> (Throwable e) &#123;</span><br><span class="line">        reportWtf(<span class="string">"making display ready"</span>, e);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    ... ... ... ...  </span><br><span class="line"></span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">        wm.systemReady();</span><br><span class="line">    &#125; <span class="keyword">catch</span> (Throwable e) &#123;</span><br><span class="line">        reportWtf(<span class="string">"making Window Manager Service ready"</span>, e);</span><br><span class="line">    &#125;</span><br><span class="line">    Trace.traceEnd(Trace.TRACE_TAG_SYSTEM_SERVER);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (safeMode) &#123;</span><br><span class="line">        mActivityManagerService.showSafeModeOverlay();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 更新显示相关的配置！</span></span><br><span class="line">    Configuration config = wm.computeNewConfiguration();</span><br><span class="line">    DisplayMetrics metrics = <span class="keyword">new</span> DisplayMetrics();</span><br><span class="line">    WindowManager w = (WindowManager)context.getSystemService(Context.WINDOW_SERVICE);</span><br><span class="line">    w.getDefaultDisplay().getMetrics(metrics);</span><br><span class="line">    context.getResources().updateConfiguration(config, metrics);</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 重置系统主题，因为可能依赖显示配置！</span></span><br><span class="line">    <span class="keyword">final</span> Theme systemTheme = context.getTheme();</span><br><span class="line">    <span class="keyword">if</span> (systemTheme.getChangingConfigurations() != <span class="number">0</span>) &#123;</span><br><span class="line">        systemTheme.rebase();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    ... ... ... ...</span><br><span class="line"></span><br><span class="line">    <span class="comment">//【3】进入 AMS 的 systemReady 方法，Runnable 任务中只要是启动一些其他的服务，这里我就省略了！</span></span><br><span class="line">    mActivityManagerService.systemReady(<span class="keyword">new</span> Runnable() &#123;</span><br><span class="line">        <span class="meta">@Override</span></span><br><span class="line">        <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">run</span><span class="params">()</span> </span>&#123;</span><br><span class="line">            Slog.i(TAG, <span class="string">"Making services ready"</span>);</span><br><span class="line">            ... ... ... ...</span><br><span class="line"></span><br><span class="line">            <span class="keyword">try</span> &#123;</span><br><span class="line">                <span class="comment">// 开始监听 native crash！</span></span><br><span class="line">                mActivityManagerService.startObservingNativeCrashes();</span><br><span class="line">            &#125; <span class="keyword">catch</span> (Throwable e) &#123;</span><br><span class="line">                reportWtf(<span class="string">"observing native crashes"</span>, e);</span><br><span class="line">            &#125;</span><br><span class="line">            Trace.traceEnd(Trace.TRACE_TAG_SYSTEM_SERVER);</span><br><span class="line"></span><br><span class="line">            ... ... ... ...</span><br><span class="line">            </span><br><span class="line">            <span class="comment">// 启动 watch dog！</span></span><br><span class="line">            Watchdog.getInstance().start();</span><br><span class="line"></span><br><span class="line">            ... ... ... ...</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<h2 id="3-1-AMS-installSystemProviders"><a href="#3-1-AMS-installSystemProviders" class="headerlink" title="3.1 AMS.installSystemProviders"></a>3.1 AMS.installSystemProviders</h2><p>安装系统数据库：<br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">final</span> <span class="keyword">void</span> <span class="title">installSystemProviders</span><span class="params">()</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    List&lt;ProviderInfo&gt; providers;</span><br><span class="line">    <span class="keyword">synchronized</span> (<span class="keyword">this</span>) &#123;</span><br><span class="line">    </span><br><span class="line">        <span class="comment">//【1】获取系统进程的 ProcessRecord, 之前 setSystemProcess() 时，创建了系统进程对应的 ProcessRecord</span></span><br><span class="line">        ProcessRecord app = mProcessNames.get(<span class="string">"system"</span>, Process.SYSTEM_UID);</span><br><span class="line">        </span><br><span class="line">        <span class="comment">//【2】生成 ProviderInfo 的列表！</span></span><br><span class="line">        providers = generateApplicationProvidersLocked(app);</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (providers != <span class="keyword">null</span>) &#123;</span><br><span class="line">            <span class="keyword">for</span> (<span class="keyword">int</span> i=providers.size()-<span class="number">1</span>; i&gt;=<span class="number">0</span>; i--) &#123;</span><br><span class="line">                ProviderInfo pi = (ProviderInfo)providers.get(i);</span><br><span class="line">                <span class="keyword">if</span> ((pi.applicationInfo.flags&amp;ApplicationInfo.FLAG_SYSTEM) == <span class="number">0</span>) &#123;</span><br><span class="line">                    Slog.w(TAG, <span class="string">"Not installing system proc provider "</span> + pi.name</span><br><span class="line">                            + <span class="string">": not system .apk"</span>);</span><br><span class="line">                            </span><br><span class="line">                    <span class="comment">//【2.1】移除一些非系统的 provider！</span></span><br><span class="line">                    providers.remove(i);</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span> (providers != <span class="keyword">null</span>) &#123;</span><br><span class="line"></span><br><span class="line">        <span class="comment">//【3】调用系统进程的 ActivityThread 的 installSystemProviders 方法，安装系统进程的数据库！</span></span><br><span class="line">        mSystemThread.installSystemProviders(providers);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    mCoreSettingsObserver = <span class="keyword">new</span> CoreSettingsObserver(<span class="keyword">this</span>);</span><br><span class="line">    mFontScaleSettingObserver = <span class="keyword">new</span> FontScaleSettingObserver();</span><br><span class="line"></span><br><span class="line">    <span class="comment">//mUsageStatsService.monitorPackages();</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>这里指定了进程名为 <code>system</code>，进程 <code>uid</code> 为 <code>Process.SYSTEM_UID</code>，一般来说，会有以下 <code>Provider</code> 会出现在返回结果中：</p>
<ul>
<li><code>framework-res.apk</code> 中的 <code>Provider</code>, 定义在：<code>frameworks/base/core/res/AndroidManifest.xml</code></li>
<li><code>SettingsProvider.apk</code> 中的 <code>Provider</code>, 定义在：<code>frameworks/base/packages/SettingsProvider/AndroidManifest.xml</code></li>
</ul>
<p>对于手机厂商，可以对系统 <code>apk</code> 进行定制，比如让系统 <code>apk</code> 共享系统 <code>uid</code>，这样的话，就不止以上两种 <code>provider</code> 了！</p>
<h3 id="3-1-1-AMS-generateApplicationProvidersLocked"><a href="#3-1-1-AMS-generateApplicationProvidersLocked" class="headerlink" title="3.1.1 AMS.generateApplicationProvidersLocked"></a>3.1.1 AMS.generateApplicationProvidersLocked</h3><p>参数传递：</p>
<ul>
<li><code>ProcessRecord app</code>：系统进程的 <code>ProcessRecord</code> 对象！</li>
</ul>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">final</span> List&lt;ProviderInfo&gt; <span class="title">generateApplicationProvidersLocked</span><span class="params">(ProcessRecord app)</span> </span>&#123;</span><br><span class="line">    List&lt;ProviderInfo&gt; providers = <span class="keyword">null</span>;</span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">    </span><br><span class="line">        <span class="comment">//【1】通过 PackageManagerService 获得系统进程的 provider！</span></span><br><span class="line">        providers = AppGlobals.getPackageManager()</span><br><span class="line">                .queryContentProviders(app.processName, app.uid,</span><br><span class="line">                        STOCK_PM_FLAGS | PackageManager.GET_URI_PERMISSION_PATTERNS</span><br><span class="line">                                | MATCH_DEBUG_TRIAGED_MISSING)</span><br><span class="line">                .getList();</span><br><span class="line"></span><br><span class="line">    &#125; <span class="keyword">catch</span> (RemoteException ex) &#123;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">if</span> (DEBUG_MU) Slog.v(TAG_MU,</span><br><span class="line">            <span class="string">"generateApplicationProvidersLocked, app.info.uid = "</span> + app.uid);</span><br><span class="line">            </span><br><span class="line">    <span class="comment">//【2】将 Provider 和 ProcessRecord 绑定！        </span></span><br><span class="line">    <span class="keyword">int</span> userId = app.userId;</span><br><span class="line">    <span class="keyword">if</span> (providers != <span class="keyword">null</span>) &#123;</span><br><span class="line">        <span class="keyword">int</span> N = providers.size();</span><br><span class="line"></span><br><span class="line">        <span class="comment">//【2.1】确保 ProcessRecord 中的 Provider 映射表的容量！</span></span><br><span class="line">        app.pubProviders.ensureCapacity(N + app.pubProviders.size());</span><br><span class="line">        </span><br><span class="line">        <span class="comment">// 遍历 ProviderInfo 列表</span></span><br><span class="line">        <span class="keyword">for</span> (<span class="keyword">int</span> i=<span class="number">0</span>; i&lt;N; i++) &#123;</span><br><span class="line">            ProviderInfo cpi = (ProviderInfo) providers.get(i);</span><br><span class="line">            <span class="comment">// 判断是否是单例模式！</span></span><br><span class="line">            <span class="keyword">boolean</span> singleton = isSingleton(cpi.processName, cpi.applicationInfo,</span><br><span class="line">                    cpi.name, cpi.flags);</span><br><span class="line">                    </span><br><span class="line">            <span class="comment">// 如果是单例模式的 provider，且其 uid 不是 system，跳过该 provider！</span></span><br><span class="line">            <span class="keyword">if</span> (singleton &amp;&amp; UserHandle.getUserId(app.uid) != UserHandle.USER_SYSTEM) &#123;</span><br><span class="line">                providers.remove(i);</span><br><span class="line">                N--;</span><br><span class="line">                i--;</span><br><span class="line">                <span class="keyword">continue</span>;</span><br><span class="line">            &#125;</span><br><span class="line">  </span><br><span class="line">            <span class="comment">//【2.2】如果 mProviderMap 中不存在 ContentProviderRecord 对象，则新建一个！</span></span><br><span class="line">            ComponentName comp = <span class="keyword">new</span> ComponentName(cpi.packageName, cpi.name);</span><br><span class="line">            ContentProviderRecord cpr = mProviderMap.getProviderByClass(comp, userId);</span><br><span class="line"></span><br><span class="line">            <span class="keyword">if</span> (cpr == <span class="keyword">null</span>) &#123;</span><br><span class="line">                cpr = <span class="keyword">new</span> ContentProviderRecord(<span class="keyword">this</span>, cpi, app.info, comp, singleton);</span><br><span class="line">                </span><br><span class="line">                <span class="comment">//【2.3】添加到 AMS.mProciderMap 管理集合中；</span></span><br><span class="line">                mProviderMap.putProviderByClass(comp, cpr);</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            <span class="keyword">if</span> (DEBUG_MU) Slog.v(TAG_MU,</span><br><span class="line">                    <span class="string">"generateApplicationProvidersLocked, cpi.uid = "</span> + cpr.uid);</span><br><span class="line">            </span><br><span class="line">            <span class="comment">//【2.4】将当前的 provider 保存到系统进程的 ProcessRecord 的 pubProviders 中；</span></span><br><span class="line">            app.pubProviders.put(cpi.name, cpr);</span><br><span class="line"></span><br><span class="line">            <span class="keyword">if</span> (!cpi.multiprocess || !<span class="string">"android"</span>.equals(cpi.packageName)) &#123;</span><br><span class="line">                app.addPackage(cpi.applicationInfo.packageName, cpi.applicationInfo.versionCode,</span><br><span class="line">                        mProcessStats);</span><br><span class="line"></span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            notifyPackageUse(cpi.applicationInfo.packageName,</span><br><span class="line">                             PackageManager.NOTIFY_PACKAGE_USE_CONTENT_PROVIDER);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> providers;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>我们通过一张类图，简单的了解一下 <code>AMS</code> 是如何管理 <code>ContentProvider</code> 的：</p>
<p><img src="http://static.zybuluo.com/Coolqi/d5jopu5clkmnagqeu47jldl5/AMS%E7%AE%A1%E7%90%86provider.png" alt="AMS管理provider.png-66.2kB"></p>
<ul>
<li><p><code>AMS</code> 为每一个 <code>ContentProvider</code> 创建了一个 <code>ContentProviderRecord</code> 对象，<code>ContentProviderRecord</code> 中保存着 <code>provider</code> 的配置信息 <code>providerInfo</code>；<code>provider</code> 所属进程的 <code>uid</code>；<code>provider</code> 所属应用的 <code>ApplicaitonInfo</code> 对象！</p>
</li>
<li><p><code>AMS</code> 的 <code>mProviderMap</code> 对象管理着系统中所有的 <code>ContentProviderRecord</code> 对象，其内部保存着 <code>Authority</code> 或者 <code>CompnentName</code> 到指定 <code>ContentProviderRecord</code> 的映射！</p>
</li>
<li><p><code>AMS</code> 内部还维护着和 <code>ProcessRecord</code> 相关的集合，用于管理进程，有前台进程集合，内存常驻进程集合，最近使用的进程等等，当 <code>AMS</code> 将一个 <code>ContentProviderRecord</code> 与 <code>ProcessRecord</code> 关联时，会将它保存到 <code>ProcessRecord</code> 内部的一个 <code>pubProviders</code> 集合中！</p>
</li>
</ul>
<h3 id="3-1-2-ActivityThread-installSystemProviders"><a href="#3-1-2-ActivityThread-installSystemProviders" class="headerlink" title="3.1.2 ActivityThread.installSystemProviders"></a>3.1.2 ActivityThread.installSystemProviders</h3><p>接着调用 <code>systemserver</code> 进程的 <code>ActivityThread</code> 的 <code>installSystemProvider</code> 方法：<br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">final</span> <span class="keyword">void</span> <span class="title">installSystemProviders</span><span class="params">(List&lt;ProviderInfo&gt; providers)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">if</span> (providers != <span class="keyword">null</span>) &#123;</span><br><span class="line"></span><br><span class="line">        <span class="comment">//【1】mInitialApplication 是 SystemServer 的进程的 Application 对象！</span></span><br><span class="line">        installContentProviders(mInitialApplication, providers);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>这里的 <code>mInitialApplication</code> 是系统进程的 <code>Application</code> 对象，接着调用了 <code>installContentProviders</code> 方法！</p>
<h3 id="3-1-3-ActivityThread-installContentProviders"><a href="#3-1-3-ActivityThread-installContentProviders" class="headerlink" title="3.1.3 ActivityThread.installContentProviders"></a>3.1.3 ActivityThread.installContentProviders</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">installContentProviders</span><span class="params">(Context context, List&lt;ProviderInfo&gt; providers)</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">final</span> ArrayList&lt;IActivityManager.ContentProviderHolder&gt; results =</span><br><span class="line">        <span class="keyword">new</span> ArrayList&lt;IActivityManager.ContentProviderHolder&gt;();</span><br><span class="line">        </span><br><span class="line">    <span class="comment">//【1】遍历系统进程的所有 provider，为每一个 provider 创建对应的 ContentProviderHolder 对象！</span></span><br><span class="line">    <span class="keyword">for</span> (ProviderInfo cpi : providers) &#123;</span><br><span class="line">        <span class="keyword">if</span> (DEBUG_PROVIDER) &#123;</span><br><span class="line">            StringBuilder buf = <span class="keyword">new</span> StringBuilder(<span class="number">128</span>);</span><br><span class="line">            buf.append(<span class="string">"Pub "</span>);</span><br><span class="line">            buf.append(cpi.authority);</span><br><span class="line">            buf.append(<span class="string">": "</span>);</span><br><span class="line">            buf.append(cpi.name);</span><br><span class="line">            Log.i(TAG, buf.toString());</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment">//【1.1】将每一个 ProviderInfo 封装为一个 ContentProviderHolder 对象！</span></span><br><span class="line">        IActivityManager.ContentProviderHolder cph = installProvider(context, <span class="keyword">null</span>, cpi,</span><br><span class="line">                <span class="keyword">false</span> <span class="comment">/*noisy*/</span>, <span class="keyword">true</span> <span class="comment">/*noReleaseNeeded*/</span>, <span class="keyword">true</span> <span class="comment">/*stable*/</span>);</span><br><span class="line">        <span class="keyword">if</span> (cph != <span class="keyword">null</span>) &#123;</span><br><span class="line">            cph.noReleaseNeeded = <span class="keyword">true</span>;</span><br><span class="line"></span><br><span class="line">            <span class="comment">// 添加到集合中！</span></span><br><span class="line">            results.add(cph);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line"></span><br><span class="line">        <span class="comment">//【2】调用 AMS 的 publish 方法， 注册 ContentProvider</span></span><br><span class="line">        ActivityManagerNative.getDefault().publishContentProviders(</span><br><span class="line">            getApplicationThread(), results);</span><br><span class="line">    &#125; <span class="keyword">catch</span> (RemoteException ex) &#123;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>所有 <code>ContentProvider</code> 的创建都需要经过 <code>installContentProvider()</code> 函数，这个地方调用了 <code>ActivityThread.installProvider</code> 方法，继续安装 <code>provider</code>!</p>
<h4 id="3-1-3-1-ActivityThread-installProvider"><a href="#3-1-3-1-ActivityThread-installProvider" class="headerlink" title="3.1.3.1 ActivityThread.installProvider"></a>3.1.3.1 ActivityThread.installProvider</h4><p>让我们来继续看看这部分的代码 <code>installProvider</code>，参数传递：</p>
<ul>
<li><code>Context context</code>：传入 <code>context</code> 对象，这里的 <code>context</code> 是 <code>mInitialApplication</code> 对象，是系统进程的上下文运行环境；</li>
<li><code>IActivityManager.ContentProviderHolder holder</code>：传入 <strong><code>null</code></strong>；</li>
<li><code>ProviderInfo info</code>：传入 <code>ProviderInfo</code> 对象，封装着 <code>provider</code> 的信息；</li>
<li><code>boolean noisy</code>：传入 <strong><code>false</code></strong>；</li>
<li><code>boolean noReleaseNeeded</code>：传入 <strong><code>true</code></strong>；</li>
<li><code>boolean stable</code>：传入 <strong><code>true</code></strong>；</li>
</ul>
<p>接着来看：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">private</span> IActivityManager.<span class="function">ContentProviderHolder <span class="title">installProvider</span><span class="params">(Context context,</span></span></span><br><span class="line"><span class="function"><span class="params">        IActivityManager.ContentProviderHolder holder, ProviderInfo info,</span></span></span><br><span class="line"><span class="function"><span class="params">        <span class="keyword">boolean</span> noisy, <span class="keyword">boolean</span> noReleaseNeeded, <span class="keyword">boolean</span> stable)</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    ContentProvider localProvider = <span class="keyword">null</span>;</span><br><span class="line">    IContentProvider provider;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (holder == <span class="keyword">null</span> || holder.provider == <span class="keyword">null</span>) &#123; <span class="comment">// 进入这个分支!</span></span><br><span class="line">        <span class="keyword">if</span> (DEBUG_PROVIDER || noisy) &#123;</span><br><span class="line">            Slog.d(TAG, <span class="string">"Loading provider "</span> + info.authority + <span class="string">": "</span></span><br><span class="line">                    + info.name);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        Context c = <span class="keyword">null</span>;</span><br><span class="line">        ApplicationInfo ai = info.applicationInfo;</span><br><span class="line"></span><br><span class="line">        <span class="comment">//【1】通过包名，找到和 provider 匹配的 context！</span></span><br><span class="line">        <span class="comment">// 如果当前已有的运行环境 Context 不匹配的话，就会创建一个新的 Context！</span></span><br><span class="line">        <span class="keyword">if</span> (context.getPackageName().equals(ai.packageName)) &#123;</span><br><span class="line">            c = context;</span><br><span class="line">        &#125; <span class="keyword">else</span> <span class="keyword">if</span> (mInitialApplication != <span class="keyword">null</span> &amp;&amp;</span><br><span class="line">                mInitialApplication.getPackageName().equals(ai.packageName)) &#123;</span><br><span class="line">            c = mInitialApplication;</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            <span class="keyword">try</span> &#123;</span><br><span class="line">                c = context.createPackageContext(ai.packageName,</span><br><span class="line">                        Context.CONTEXT_INCLUDE_CODE);</span><br><span class="line">            &#125; <span class="keyword">catch</span> (PackageManager.NameNotFoundException e) &#123;</span><br><span class="line">                <span class="comment">// Ignore</span></span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (c == <span class="keyword">null</span>) &#123;</span><br><span class="line">            Slog.w(TAG, <span class="string">"Unable to get context for package "</span> +</span><br><span class="line">                  ai.packageName +</span><br><span class="line">                  <span class="string">" while loading content provider "</span> +</span><br><span class="line">                  info.name);</span><br><span class="line">            <span class="keyword">return</span> <span class="keyword">null</span>;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment">//【2】根据包名，通过反射创建新的 ContentProvider 对象！</span></span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line"></span><br><span class="line">            <span class="keyword">final</span> java.lang.ClassLoader cl = c.getClassLoader();</span><br><span class="line">            localProvider = (ContentProvider)cl.</span><br><span class="line">                loadClass(info.name).newInstance();</span><br><span class="line">            provider = localProvider.getIContentProvider();</span><br><span class="line"></span><br><span class="line">            <span class="keyword">if</span> (provider == <span class="keyword">null</span>) &#123;</span><br><span class="line">                Slog.e(TAG, <span class="string">"Failed to instantiate class "</span> +</span><br><span class="line">                      info.name + <span class="string">" from sourceDir "</span> +</span><br><span class="line">                      info.applicationInfo.sourceDir);</span><br><span class="line">                <span class="keyword">return</span> <span class="keyword">null</span>;</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            <span class="keyword">if</span> (DEBUG_PROVIDER) Slog.v(</span><br><span class="line">                TAG, <span class="string">"Instantiating local provider "</span> + info.name);</span><br><span class="line">            </span><br><span class="line">            <span class="comment">//【2.1】将创建的 provider 和 providerInfo 数据进行绑定；</span></span><br><span class="line">            <span class="comment">// 这个方法对 provider 会做初始化，</span></span><br><span class="line">            localProvider.attachInfo(c, info);</span><br><span class="line"></span><br><span class="line">        &#125; <span class="keyword">catch</span> (java.lang.Exception e) &#123;</span><br><span class="line">            <span class="keyword">if</span> (!mInstrumentation.onException(<span class="keyword">null</span>, e)) &#123;</span><br><span class="line">                <span class="keyword">throw</span> <span class="keyword">new</span> RuntimeException(</span><br><span class="line">                        <span class="string">"Unable to get provider "</span> + info.name</span><br><span class="line">                        + <span class="string">": "</span> + e.toString(), e);</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">return</span> <span class="keyword">null</span>;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        provider = holder.provider;</span><br><span class="line">        <span class="keyword">if</span> (DEBUG_PROVIDER) Slog.v(TAG, <span class="string">"Installing external provider "</span> + info.authority + <span class="string">": "</span></span><br><span class="line">                + info.name);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//【3】设置对应的 ContentProviderHolder 对象！</span></span><br><span class="line">    IActivityManager.ContentProviderHolder retHolder;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">synchronized</span> (mProviderMap) &#123;</span><br><span class="line">        <span class="keyword">if</span> (DEBUG_PROVIDER) Slog.v(TAG, <span class="string">"Checking to add "</span> + provider</span><br><span class="line">                + <span class="string">" / "</span> + info.name);</span><br><span class="line"></span><br><span class="line">        IBinder jBinder = provider.asBinder();</span><br><span class="line">        <span class="keyword">if</span> (localProvider != <span class="keyword">null</span>) &#123;</span><br><span class="line">            ComponentName cname = <span class="keyword">new</span> ComponentName(info.packageName, info.name);</span><br><span class="line"></span><br><span class="line">            <span class="comment">// 尝试获得对应的 ProviderClientRecord 对象！</span></span><br><span class="line">            ProviderClientRecord pr = mLocalProvidersByName.get(cname);</span><br><span class="line">            <span class="keyword">if</span> (pr != <span class="keyword">null</span>) &#123;</span><br><span class="line">                <span class="keyword">if</span> (DEBUG_PROVIDER) &#123;</span><br><span class="line">                    Slog.v(TAG, <span class="string">"installProvider: lost the race, "</span></span><br><span class="line">                            + <span class="string">"using existing local provider"</span>);</span><br><span class="line">                &#125;</span><br><span class="line">                provider = pr.mProvider;</span><br><span class="line">            &#125; <span class="keyword">else</span> &#123;</span><br><span class="line"></span><br><span class="line">                <span class="comment">// 创建一个新的 ContentProviderHolder 对象!</span></span><br><span class="line">                holder = <span class="keyword">new</span> IActivityManager.ContentProviderHolder(info);</span><br><span class="line">                holder.provider = provider;</span><br><span class="line">                holder.noReleaseNeeded = <span class="keyword">true</span>;</span><br><span class="line"></span><br><span class="line">                <span class="comment">// 创建一个新的 ProviderClientRecord 对象，并将映射关系保存起来！</span></span><br><span class="line">                pr = installProviderAuthoritiesLocked(provider, localProvider, holder);</span><br><span class="line">                mLocalProviders.put(jBinder, pr);</span><br><span class="line">                mLocalProvidersByName.put(cname, pr);</span><br><span class="line">            &#125;</span><br><span class="line">            retHolder = pr.mHolder;</span><br><span class="line"></span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            ProviderRefCount prc = mProviderRefCountMap.get(jBinder);</span><br><span class="line">            <span class="keyword">if</span> (prc != <span class="keyword">null</span>) &#123;</span><br><span class="line">                <span class="keyword">if</span> (DEBUG_PROVIDER) &#123;</span><br><span class="line">                    Slog.v(TAG, <span class="string">"installProvider: lost the race, updating ref count"</span>);</span><br><span class="line">                &#125;</span><br><span class="line">                <span class="keyword">if</span> (!noReleaseNeeded) &#123;</span><br><span class="line">                    incProviderRefLocked(prc, stable);</span><br><span class="line">                    <span class="keyword">try</span> &#123;</span><br><span class="line">                        ActivityManagerNative.getDefault().removeContentProvider(</span><br><span class="line">                                holder.connection, stable);</span><br><span class="line">                    &#125; <span class="keyword">catch</span> (RemoteException e) &#123;</span><br><span class="line">                        <span class="comment">// do nothing content provider object is dead any way</span></span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                ProviderClientRecord client = installProviderAuthoritiesLocked(</span><br><span class="line">                        provider, localProvider, holder);</span><br><span class="line">                <span class="keyword">if</span> (noReleaseNeeded) &#123;</span><br><span class="line">                    prc = <span class="keyword">new</span> ProviderRefCount(holder, client, <span class="number">1000</span>, <span class="number">1000</span>);</span><br><span class="line">                &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                    prc = stable</span><br><span class="line">                            ? <span class="keyword">new</span> ProviderRefCount(holder, client, <span class="number">1</span>, <span class="number">0</span>)</span><br><span class="line">                            : <span class="keyword">new</span> ProviderRefCount(holder, client, <span class="number">0</span>, <span class="number">1</span>);</span><br><span class="line">                &#125;</span><br><span class="line">                mProviderRefCountMap.put(jBinder, prc);</span><br><span class="line">            &#125;</span><br><span class="line">            retHolder = prc.holder;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> retHolder;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<ul>
<li><p>首先，找到 <code>ProviderInfo</code> 对应的运行环境 <code>Context</code>：</p>
<ul>
<li>对于 <code>framework-res.apk</code> 中定义的 <code>com.android.server.am.DumpHeapProvider</code> 而言，重新设置的 <code>Context</code> 就是 <code>mInitialApplication</code>，所以就直接使用；</li>
<li>对于 <code>SettingProvider.apk</code> 中定义的 <code>SettingsProvider</code> 而言，它的包名为 <code>com.android.providers.settings</code>，不等于 <code>mInitialApplication</code> 的包名 <code>android</code>，所以，会通过 <code>Context.createPackageContext()</code> 函数创建一个新的 <code>Context</code> 实例！</li>
</ul>
</li>
<li><p>接着，反射创建 <code>ContentProvider</code> 对象，然后，根据反射对象 <code>ContentProvider</code>，创建对应的 <code>ContentProviderHolder</code> 对象！</p>
</li>
</ul>
<h4 id="3-1-3-2-AactivityManagerN-publishContentProviders"><a href="#3-1-3-2-AactivityManagerN-publishContentProviders" class="headerlink" title="3.1.3.2 AactivityManagerN.publishContentProviders"></a>3.1.3.2 AactivityManagerN.publishContentProviders</h4><p>最终会调用 <code>ActivityManagerService</code> 中的 <code>publishContentProviders</code> 方法：<br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">final</span> <span class="keyword">void</span> <span class="title">publishContentProviders</span><span class="params">(IApplicationThread caller,</span></span></span><br><span class="line"><span class="function"><span class="params">        List&lt;ContentProviderHolder&gt; providers)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">if</span> (providers == <span class="keyword">null</span>) &#123;</span><br><span class="line">        <span class="keyword">return</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    enforceNotIsolatedCaller(<span class="string">"publishContentProviders"</span>);</span><br><span class="line">    <span class="keyword">synchronized</span> (<span class="keyword">this</span>) &#123;</span><br><span class="line"></span><br><span class="line">        <span class="comment">//【1】获得调用者所在进程的 ProcessRecord 对象！</span></span><br><span class="line">        <span class="keyword">final</span> ProcessRecord r = getRecordForAppLocked(caller);</span><br><span class="line">        <span class="keyword">if</span> (DEBUG_MU) Slog.v(TAG_MU, <span class="string">"ProcessRecord uid = "</span> + r.uid);</span><br><span class="line">        <span class="keyword">if</span> (r == <span class="keyword">null</span>) &#123;</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> SecurityException(</span><br><span class="line">                    <span class="string">"Unable to find app for caller "</span> + caller</span><br><span class="line">                  + <span class="string">" (pid="</span> + Binder.getCallingPid()</span><br><span class="line">                  + <span class="string">") when publishing content providers"</span>);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">final</span> <span class="keyword">long</span> origId = Binder.clearCallingIdentity();</span><br><span class="line"></span><br><span class="line">        <span class="comment">//【2】遍历传入的 ContentProviderHolder 集合！</span></span><br><span class="line">        <span class="keyword">final</span> <span class="keyword">int</span> N = providers.size();</span><br><span class="line">        <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; N; i++) &#123;</span><br><span class="line"></span><br><span class="line">            ContentProviderHolder src = providers.get(i);</span><br><span class="line">            <span class="keyword">if</span> (src == <span class="keyword">null</span> || src.info == <span class="keyword">null</span> || src.provider == <span class="keyword">null</span>) &#123;</span><br><span class="line">                <span class="keyword">continue</span>;</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            <span class="comment">// 从 ProcessRecord 中获得其对应的 ContentProviderRecord 对象！</span></span><br><span class="line">            ContentProviderRecord dst = r.pubProviders.get(src.info.name);</span><br><span class="line"></span><br><span class="line">            <span class="keyword">if</span> (DEBUG_MU) Slog.v(TAG_MU, <span class="string">"ContentProviderRecord uid = "</span> + dst.uid);</span><br><span class="line">            </span><br><span class="line">            <span class="keyword">if</span> (dst != <span class="keyword">null</span>) &#123;</span><br><span class="line"></span><br><span class="line">                ComponentName comp = <span class="keyword">new</span> ComponentName(dst.info.packageName, dst.info.name);</span><br><span class="line"></span><br><span class="line">                <span class="comment">// 将其保存到 AMS 的 mProviderMap 中！</span></span><br><span class="line">                mProviderMap.putProviderByClass(comp, dst);</span><br><span class="line">                String names[] = dst.info.authority.split(<span class="string">";"</span>);</span><br><span class="line">                <span class="keyword">for</span> (<span class="keyword">int</span> j = <span class="number">0</span>; j &lt; names.length; j++) &#123;</span><br><span class="line">                    mProviderMap.putProviderByName(names[j], dst);</span><br><span class="line">                &#125;</span><br><span class="line"></span><br><span class="line">                <span class="keyword">int</span> launchingCount = mLaunchingProviders.size();</span><br><span class="line">                <span class="keyword">int</span> j;</span><br><span class="line">                <span class="keyword">boolean</span> wasInLaunchingProviders = <span class="keyword">false</span>;</span><br><span class="line">                <span class="keyword">for</span> (j = <span class="number">0</span>; j &lt; launchingCount; j++) &#123;</span><br><span class="line">                    <span class="keyword">if</span> (mLaunchingProviders.get(j) == dst) &#123;</span><br><span class="line">                        <span class="comment">// 从正在启动的 provider 列表中删除！</span></span><br><span class="line">                        mLaunchingProviders.remove(j);</span><br><span class="line">                        wasInLaunchingProviders = <span class="keyword">true</span>;</span><br><span class="line">                        j--;</span><br><span class="line">                        launchingCount--;</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;</span><br><span class="line"></span><br><span class="line">                <span class="keyword">if</span> (wasInLaunchingProviders) &#123;</span><br><span class="line">                    mHandler.removeMessages(CONTENT_PROVIDER_PUBLISH_TIMEOUT_MSG, r);</span><br><span class="line">                &#125;</span><br><span class="line"></span><br><span class="line">                <span class="keyword">synchronized</span> (dst) &#123;</span><br><span class="line">                    dst.provider = src.provider;</span><br><span class="line">                    dst.proc = r;</span><br><span class="line">                    dst.notifyAll();</span><br><span class="line">                &#125;</span><br><span class="line"></span><br><span class="line">                <span class="comment">// 更新 ommAdj 值，用于 LMK！</span></span><br><span class="line">                updateOomAdjLocked(r);</span><br><span class="line"></span><br><span class="line">                <span class="comment">// 更新 provider 的使用状态！</span></span><br><span class="line">                maybeUpdateProviderUsageStatsLocked(r, src.info.packageName,</span><br><span class="line">                        src.info.authority);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        Binder.restoreCallingIdentity(origId);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>关于 <code>ContentProvider</code> 的实现原理，我后续会有对应的博文分析，这里就不多说了！</p>
<h3 id="3-1-3-阶段总结"><a href="#3-1-3-阶段总结" class="headerlink" title="3.1.3 阶段总结"></a>3.1.3 阶段总结</h3><p>我们总结一下：</p>
<ul>
<li><p>首先，获得系统进程的 <code>providerInfo</code> 列表！</p>
<ul>
<li>通过 PMS，获得系统进程的 <code>providerInfo</code> 列表；</li>
<li>确保系统进程 <code>ProcessRecord</code> 有足够的空间存储 <code>ContentProvider</code>；</li>
<li>然后，对找到的 <code>ProviderInfo</code> 列表进行遍历, 如有需要, 则新建一个 <code>ContentProviderRecord</code> 对象, 将其添加到 <code>AMS.mProviderMap</code> 中以方便管理；同时, 也需要将其添加到 <code>PrcoessRecord.mPubProviders</code> 中。</li>
<li>最后返回 <code>providerInfo</code> 列表；</li>
</ul>
</li>
<li><p>将 <code>provider</code> 注册到系统进程！</p>
</li>
</ul>
<h2 id="3-2-ActivityManagerS-setWindowManager"><a href="#3-2-ActivityManagerS-setWindowManager" class="headerlink" title="3.2 ActivityManagerS.setWindowManager"></a>3.2 ActivityManagerS.setWindowManager</h2><p>接着是就是设置 <code>wms</code> 的引用对象！<br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">setWindowManager</span><span class="params">(WindowManagerService wm)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">synchronized</span> (mService) &#123;</span><br><span class="line">        <span class="comment">//【1】设置 wms 引用实例</span></span><br><span class="line">        mWindowManager = wm;</span><br><span class="line">        <span class="comment">//【2】获得 dms 的引用实力，并将 ams 注册进入 dms！</span></span><br><span class="line">        mDisplayManager =</span><br><span class="line">                (DisplayManager)mService.mContext.getSystemService(Context.DISPLAY_SERVICE);</span><br><span class="line">        mDisplayManager.registerDisplayListener(<span class="keyword">this</span>, <span class="keyword">null</span>);</span><br><span class="line">        </span><br><span class="line">        <span class="comment">//【3】通过 dms 获得是当前安卓设备所有有效的逻辑显示器列表！</span></span><br><span class="line">        Display[] displays = mDisplayManager.getDisplays();</span><br><span class="line">        <span class="keyword">for</span> (<span class="keyword">int</span> displayNdx = displays.length - <span class="number">1</span>; displayNdx &gt;= <span class="number">0</span>; --displayNdx) &#123;</span><br><span class="line">            <span class="keyword">final</span> <span class="keyword">int</span> displayId = displays[displayNdx].getDisplayId();</span><br><span class="line">            </span><br><span class="line">            <span class="comment">// 为每一个显示器创建一个 ActivityDisplay 对象，存储该显示器的信息；</span></span><br><span class="line">            ActivityDisplay activityDisplay = <span class="keyword">new</span> ActivityDisplay(displayId);</span><br><span class="line">            <span class="keyword">if</span> (activityDisplay.mDisplay == <span class="keyword">null</span>) &#123;</span><br><span class="line">                <span class="keyword">throw</span> <span class="keyword">new</span> IllegalStateException(<span class="string">"Default Display does not exist"</span>);</span><br><span class="line">            &#125;</span><br><span class="line">            </span><br><span class="line">            <span class="comment">//【3.1】将其保存到 ams 的 mActivityDisplays 集合中，后续会用到！</span></span><br><span class="line">            mActivityDisplays.put(displayId, activityDisplay);</span><br><span class="line">            calculateDefaultMinimalSizeOfResizeableTasks(activityDisplay);</span><br><span class="line">        &#125;</span><br><span class="line">        </span><br><span class="line">        <span class="comment">//【4】初始化 mHomeStack，mFocusedStack 和 mLastFocusedStack 这三个 stack！</span></span><br><span class="line">        mHomeStack = mFocusedStack = mLastFocusedStack =</span><br><span class="line">                getStack(HOME_STACK_ID, CREATE_IF_NEEDED, ON_TOP);</span><br><span class="line">        </span><br><span class="line">        <span class="comment">//【5】通过本地服务过得 ims 的调用接口；</span></span><br><span class="line">        mInputManagerInternal = LocalServices.getService(InputManagerInternal.class);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>这个方法逻辑很简单！这里重点看一下，在系统启动的时候，会初始化 <code>mFocusedStack</code> 和 <code>mLastFocusedStack</code> 为 <code>HOME_STACK_ID</code> 类型的 <code>stack</code>，这个是显而易见的，因为开机后，就会进入桌面，此时焦点 <code>stack</code> 一定是 <code>home stack</code>!</p>
<h3 id="3-2-1-ActivityStackSupervisor-getStack"><a href="#3-2-1-ActivityStackSupervisor-getStack" class="headerlink" title="3.2.1 ActivityStackSupervisor.getStack"></a>3.2.1 ActivityStackSupervisor.getStack</h3><p>该方法的作用是返回一个可用的 <code>stack</code>，<code>createStaticStackIfNeeded</code> 表示有必要的话是否创建一个静态 <code>stack</code>！</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="function">ActivityStack <span class="title">getStack</span><span class="params">(<span class="keyword">int</span> stackId, <span class="keyword">boolean</span> createStaticStackIfNeeded, <span class="keyword">boolean</span> createOnTop)</span> </span>&#123;</span><br><span class="line">    <span class="comment">//【1】获得 stackId 对应的 ActivityContainer 如果其不为 null，返回其内部的 Stack！</span></span><br><span class="line">    ActivityContainer activityContainer = mActivityContainers.get(stackId);</span><br><span class="line">    <span class="keyword">if</span> (activityContainer != <span class="keyword">null</span>) &#123;</span><br><span class="line">        <span class="keyword">return</span> activityContainer.mStack;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">//【2】如果不能通过 ActivityContainer 来获得想要的 statck 话，就先判断是否需要创建一个 stack</span></span><br><span class="line">    <span class="comment">// 不需要创建一个新的 stack 或者 stack id 不是静态的，那就不能创建，返回一个空的 stack！</span></span><br><span class="line">    <span class="keyword">if</span> (!createStaticStackIfNeeded || !StackId.isStaticStack(stackId)) &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">null</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">//【3】创建一个 stack，这里的 Display.DEFAULT_DISPLAY 对应的是默认的显示器 ！</span></span><br><span class="line">    <span class="keyword">return</span> createStackOnDisplay(stackId, Display.DEFAULT_DISPLAY, createOnTop);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>这里我们知道，在刚开机的时候，是没有任何的 <code>ActivityContainer</code> 的，所以这里会进入 <code>createStackOnDisplay</code> 方法中继续创建！</p>
<h3 id="3-2-2-ActivityStackSupervisor-createStackOnDisplay"><a href="#3-2-2-ActivityStackSupervisor-createStackOnDisplay" class="headerlink" title="3.2.2 ActivityStackSupervisor.createStackOnDisplay"></a>3.2.2 ActivityStackSupervisor.createStackOnDisplay</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="function">ActivityStack <span class="title">createStackOnDisplay</span><span class="params">(<span class="keyword">int</span> stackId, <span class="keyword">int</span> displayId, <span class="keyword">boolean</span> onTop)</span> </span>&#123;</span><br><span class="line">    <span class="comment">//【1】获得 displayId 对应的逻辑显示器的 ActivityDisplay 对象！</span></span><br><span class="line">    ActivityDisplay activityDisplay = mActivityDisplays.get(displayId);</span><br><span class="line">    <span class="keyword">if</span> (activityDisplay == <span class="keyword">null</span>) &#123; <span class="comment">// 这里显然不会进入！</span></span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">null</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">//【2】根据 stackId 创建了一个 ActivityContainer 对象爱！</span></span><br><span class="line">    ActivityContainer activityContainer = <span class="keyword">new</span> ActivityContainer(stackId);</span><br><span class="line"></span><br><span class="line">    <span class="comment">//【3】将其加入到 mActivityContainers 中！</span></span><br><span class="line">    mActivityContainers.put(stackId, activityContainer);</span><br><span class="line"></span><br><span class="line">    <span class="comment">//【4】将 activityContainer 绑定到对应的显示器对象 activityDisplay 中！</span></span><br><span class="line">    activityContainer.attachToDisplayLocked(activityDisplay, onTop);</span><br><span class="line">    <span class="keyword">return</span> activityContainer.mStack;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>这里其实很简单，针对于指定的显示器 <code>ActivityDisplay</code>，创建对应的 <code>ActivityContainer</code>，然后 <code>ActivityContainer</code> 内部再去创建 <code>ActivityStack</code>!</p>
<h4 id="3-2-2-1-new-ActivityContainer"><a href="#3-2-2-1-new-ActivityContainer" class="headerlink" title="3.2.2.1 new ActivityContainer"></a>3.2.2.1 new ActivityContainer</h4><p>我们来去看看 <code>ActivityContainer</code> 的创建：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">ActivityContainer</span> <span class="keyword">extends</span> <span class="title">android</span>.<span class="title">app</span>.<span class="title">IActivityContainer</span>.<span class="title">Stub</span> </span>&#123;</span><br><span class="line">    <span class="keyword">final</span> <span class="keyword">static</span> <span class="keyword">int</span> FORCE_NEW_TASK_FLAGS = FLAG_ACTIVITY_NEW_TASK |</span><br><span class="line">            FLAG_ACTIVITY_MULTIPLE_TASK | Intent.FLAG_ACTIVITY_NO_ANIMATION;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">final</span> <span class="keyword">int</span> mStackId; <span class="comment">// stack 的 id！</span></span><br><span class="line">    IActivityContainerCallback mCallback = <span class="keyword">null</span>;</span><br><span class="line">    <span class="keyword">final</span> ActivityStack mStack; <span class="comment">// 对应的 ActivityStack 对象！</span></span><br><span class="line">    ActivityRecord mParentActivity = <span class="keyword">null</span>; <span class="comment">// 父亲 activity！</span></span><br><span class="line">    String mIdString; </span><br><span class="line"></span><br><span class="line">    <span class="keyword">boolean</span> mVisible = <span class="keyword">true</span>; <span class="comment">// 是否是可见的，默认为 true！</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">// 其所绑定到的 ActivityDisplay 对象，不为 null 说明绑定到了一个逻辑显示器，</span></span><br><span class="line">    <span class="comment">// 这样该 stack 中的 activity 就可以被显示出来！</span></span><br><span class="line">    ActivityDisplay mActivityDisplay;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">final</span> <span class="keyword">static</span> <span class="keyword">int</span> CONTAINER_STATE_HAS_SURFACE = <span class="number">0</span>;</span><br><span class="line">    <span class="keyword">final</span> <span class="keyword">static</span> <span class="keyword">int</span> CONTAINER_STATE_NO_SURFACE = <span class="number">1</span>;</span><br><span class="line">    <span class="keyword">final</span> <span class="keyword">static</span> <span class="keyword">int</span> CONTAINER_STATE_FINISHING = <span class="number">2</span>;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// container 的状态，取值有 3 种！</span></span><br><span class="line">    <span class="keyword">int</span> mContainerState = CONTAINER_STATE_HAS_SURFACE;</span><br><span class="line"></span><br><span class="line">    ActivityContainer(<span class="keyword">int</span> stackId) &#123;</span><br><span class="line">        <span class="keyword">synchronized</span> (mService) &#123;</span><br><span class="line">            mStackId = stackId;</span><br><span class="line">            <span class="comment">//【1】创建一个 ActivityStack</span></span><br><span class="line">            mStack = <span class="keyword">new</span> ActivityStack(<span class="keyword">this</span>, mRecentTasks);</span><br><span class="line"></span><br><span class="line">            mIdString = <span class="string">"ActivtyContainer&#123;"</span> + mStackId + <span class="string">"&#125;"</span>;</span><br><span class="line">            <span class="keyword">if</span> (DEBUG_STACK) Slog.d(TAG_STACK, <span class="string">"Creating "</span> + <span class="keyword">this</span>);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    ... ... ...   </span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>我们再去看看 <code>ActivityStack</code> 的创建：</p>
<h5 id="3-2-2-2-1-new-ActivityStack"><a href="#3-2-2-2-1-new-ActivityStack" class="headerlink" title="3.2.2.2.1 new ActivityStack"></a>3.2.2.2.1 new ActivityStack</h5><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line">ActivityStack(ActivityStackSupervisor.ActivityContainer activityContainer,</span><br><span class="line">        RecentTasks recentTasks) &#123;</span><br><span class="line">    <span class="comment">//【1】设置 ActivityContainer 引用关系；</span></span><br><span class="line">    mActivityContainer = activityContainer;</span><br><span class="line">    <span class="comment">// ActivityContainer 是 ActivityStackSupervisor 内部类，这里是通过 getOuter 获得外部类的实例；</span></span><br><span class="line">    mStackSupervisor = activityContainer.getOuter();</span><br><span class="line">    mService = mStackSupervisor.mService; <span class="comment">// ams 的引用实例；</span></span><br><span class="line">    <span class="comment">//【2】创建 ActivityStackHandler 用于处理 activity 的周期变化；</span></span><br><span class="line">    mHandler = <span class="keyword">new</span> ActivityStackHandler(mService.mHandler.getLooper());</span><br><span class="line">    mWindowManager = mService.mWindowManager; <span class="comment">// wms 实例，不多说了；</span></span><br><span class="line">    mStackId = activityContainer.mStackId; <span class="comment">// stack id；</span></span><br><span class="line">    mCurrentUser = mService.mUserController.getCurrentUserIdLocked(); <span class="comment">// 当前的设备用户对象；</span></span><br><span class="line">    mRecentTasks = recentTasks; <span class="comment">// 最近任务；</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">// 如果 stack id 为 FREEFORM_WORKSPACE_STACK_ID，才会创建对应实例，安卓手机默认是为 null</span></span><br><span class="line">    mTaskPositioner = mStackId == FREEFORM_WORKSPACE_STACK_ID</span><br><span class="line">            ? <span class="keyword">new</span> LaunchingTaskPositioner() : <span class="keyword">null</span>; </span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>这里就不多说了！</p>
<h4 id="3-2-2-2-ActivityContainer-attachToDisplayLocked"><a href="#3-2-2-2-ActivityContainer-attachToDisplayLocked" class="headerlink" title="3.2.2.2 ActivityContainer.attachToDisplayLocked"></a>3.2.2.2 ActivityContainer.attachToDisplayLocked</h4><p>接下来就是很关键的一部，就是将 <code>ActivityContainer</code> 绑定到指定的 <code>ActivityDisplay</code> 对象上！</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">attachToDisplayLocked</span><span class="params">(ActivityDisplay activityDisplay, <span class="keyword">boolean</span> onTop)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">if</span> (DEBUG_STACK) Slog.d(TAG_STACK, <span class="string">"attachToDisplayLocked: "</span> + <span class="keyword">this</span></span><br><span class="line">            + <span class="string">" to display="</span> + activityDisplay + <span class="string">" onTop="</span> + onTop);</span><br><span class="line">    <span class="comment">//【1】设置 mActivityDisplay 引用关系！</span></span><br><span class="line">    mActivityDisplay = activityDisplay;</span><br><span class="line">    <span class="comment">// </span></span><br><span class="line">    mStack.attachDisplay(activityDisplay, onTop);</span><br><span class="line">    activityDisplay.attachActivities(mStack, onTop);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h5 id="3-2-2-2-1-ActivityStack-attachDisplay"><a href="#3-2-2-2-1-ActivityStack-attachDisplay" class="headerlink" title="3.2.2.2.1 ActivityStack.attachDisplay"></a>3.2.2.2.1 ActivityStack.attachDisplay</h5><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">attachDisplay</span><span class="params">(ActivityStackSupervisor.ActivityDisplay activityDisplay, <span class="keyword">boolean</span> onTop)</span> </span>&#123;</span><br><span class="line">    mDisplayId = activityDisplay.mDisplayId;</span><br><span class="line">    mStacks = activityDisplay.mStacks;</span><br><span class="line">    mBounds = mWindowManager.attachStack(mStackId, activityDisplay.mDisplayId, onTop);</span><br><span class="line">    mFullscreen = mBounds == <span class="keyword">null</span>;</span><br><span class="line">    <span class="keyword">if</span> (mTaskPositioner != <span class="keyword">null</span>) &#123;</span><br><span class="line">        mTaskPositioner.setDisplay(activityDisplay.mDisplay);</span><br><span class="line">        mTaskPositioner.configure(mBounds);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (mStackId == DOCKED_STACK_ID) &#123;</span><br><span class="line">        <span class="comment">// If we created a docked stack we want to resize it so it resizes all other stacks</span></span><br><span class="line">        <span class="comment">// in the system.</span></span><br><span class="line">        mStackSupervisor.resizeDockedStackLocked(</span><br><span class="line">                mBounds, <span class="keyword">null</span>, <span class="keyword">null</span>, <span class="keyword">null</span>, <span class="keyword">null</span>, PRESERVE_WINDOWS);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h5 id="3-2-2-2-2-ActivityDisplay-attachActivities"><a href="#3-2-2-2-2-ActivityDisplay-attachActivities" class="headerlink" title="3.2.2.2.2 ActivityDisplay.attachActivities"></a>3.2.2.2.2 ActivityDisplay.attachActivities</h5><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">attachActivities</span><span class="params">(ActivityStack stack, <span class="keyword">boolean</span> onTop)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">if</span> (DEBUG_STACK) Slog.v(TAG_STACK,</span><br><span class="line">            <span class="string">"attachActivities: attaching "</span> + stack + <span class="string">" to displayId="</span> + mDisplayId</span><br><span class="line">            + <span class="string">" onTop="</span> + onTop);</span><br><span class="line">    <span class="keyword">if</span> (onTop) &#123;</span><br><span class="line">        mStacks.add(stack);</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        mStacks.add(<span class="number">0</span>, stack);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>其实，整个过程就是创建容器，建立引用关系的过程，通过分析，我们知道，安卓系统的所有的 <code>stack</code> 的创建都是这样的！！</p>
<h2 id="3-3-ActivityManagerS-systemReady"><a href="#3-3-ActivityManagerS-systemReady" class="headerlink" title="3.3 ActivityManagerS.systemReady"></a>3.3 ActivityManagerS.systemReady</h2><p><code>SystemServer</code> 在启动完所有服务之后，将调用 <code>AMS</code> 的 <code>systemReady()</code> 方法。这个方法是 <code>Android</code> 进入用户交互阶段前最后进行的准备工作。这里就即将进入开机的最后阶段了：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">systemReady</span><span class="params">(<span class="keyword">final</span> Runnable goingCallback)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">synchronized</span>(<span class="keyword">this</span>) &#123;</span><br><span class="line"></span><br><span class="line">        <span class="comment">//【3.3.1】最开始是不会进入这个分支的，即 mSystemReady 为 false，但是由于 systemReady 会被调用多次</span></span><br><span class="line">        <span class="comment">// 后续 mSystemReady 会被置为 true，这样执行 goingCallback 后就会退出了！</span></span><br><span class="line">        <span class="keyword">if</span> (mSystemReady) &#123; </span><br><span class="line"></span><br><span class="line">            <span class="keyword">if</span> (goingCallback != <span class="keyword">null</span>) &#123;</span><br><span class="line">                goingCallback.run();</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">return</span>;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        mLocalDeviceIdleController</span><br><span class="line">                = LocalServices.getService(DeviceIdleController.LocalService.class);</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 通知 UserController、RecentTask 和 AppOpsService 服务，系统已经准备好了！</span></span><br><span class="line">        mUserController.onSystemReady();</span><br><span class="line">        mRecentTasks.onSystemReadyLocked();</span><br><span class="line">        mAppOpsService.systemReady();</span><br><span class="line"></span><br><span class="line">        <span class="comment">//【2】mSystemReady 置为 true，表示系统进程已经准备完毕了！</span></span><br><span class="line">        mSystemReady = <span class="keyword">true</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//【3.3.2】遍历 mPidsSelfLocked，找到已经启动但是没有带有 FLAG_PERSISTENT 标记的非 persistent 应用进程；</span></span><br><span class="line">    <span class="comment">// 然后杀掉它们，目的是在启动 Home 前准备一个干净的环境！</span></span><br><span class="line">    ArrayList&lt;ProcessRecord&gt; procsToKill = <span class="keyword">null</span>;</span><br><span class="line">    <span class="keyword">synchronized</span>(mPidsSelfLocked) &#123;</span><br><span class="line">        <span class="keyword">for</span> (<span class="keyword">int</span> i=mPidsSelfLocked.size()-<span class="number">1</span>; i&gt;=<span class="number">0</span>; i--) &#123;</span><br><span class="line">            ProcessRecord proc = mPidsSelfLocked.valueAt(i);</span><br><span class="line"></span><br><span class="line">            <span class="keyword">if</span> (!isAllowedWhileBooting(proc.info))&#123;</span><br><span class="line">                <span class="keyword">if</span> (procsToKill == <span class="keyword">null</span>) &#123;</span><br><span class="line">                    procsToKill = <span class="keyword">new</span> ArrayList&lt;ProcessRecord&gt;();</span><br><span class="line">                &#125;</span><br><span class="line">                procsToKill.add(proc);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">synchronized</span>(<span class="keyword">this</span>) &#123;</span><br><span class="line">        <span class="keyword">if</span> (procsToKill != <span class="keyword">null</span>) &#123;</span><br><span class="line">            <span class="keyword">for</span> (<span class="keyword">int</span> i=procsToKill.size()-<span class="number">1</span>; i&gt;=<span class="number">0</span>; i--) &#123;</span><br><span class="line">                ProcessRecord proc = procsToKill.get(i);</span><br><span class="line">                Slog.i(TAG, <span class="string">"Removing system update proc: "</span> + proc);</span><br><span class="line">                removeProcessLocked(proc, <span class="keyword">true</span>, <span class="keyword">false</span>, <span class="string">"system update done"</span>);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment">//【3.1】表示系统进程已经准备完毕，可以启动其他进程了！</span></span><br><span class="line">        mProcessesReady = <span class="keyword">true</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    Slog.i(TAG, <span class="string">"System now ready"</span>);</span><br><span class="line">    EventLog.writeEvent(EventLogTags.BOOT_PROGRESS_AMS_READY,</span><br><span class="line">        SystemClock.uptimeMillis());</span><br><span class="line"></span><br><span class="line">    <span class="keyword">synchronized</span>(<span class="keyword">this</span>) &#123;</span><br><span class="line">        <span class="keyword">if</span> (mFactoryTest == FactoryTest.FACTORY_TEST_LOW_LEVEL) &#123;</span><br><span class="line">           ... ... ... ...<span class="comment">// 测试模式，非正常情况，先不看！</span></span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">//【3.3.3】读取设置信息！</span></span><br><span class="line">    retrieveSettings();</span><br><span class="line">    <span class="keyword">final</span> <span class="keyword">int</span> currentUserId;</span><br><span class="line">    <span class="keyword">synchronized</span> (<span class="keyword">this</span>) &#123;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 获得当前设备用户 id！</span></span><br><span class="line">        currentUserId = mUserController.getCurrentUserIdLocked();</span><br><span class="line"></span><br><span class="line">        <span class="comment">//【3.3.4】从 /data/system/urigrants.xml 文件中读取 Uri 相关的权限信息！</span></span><br><span class="line">        readGrantedUriPermissionsLocked();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//【5】执行传入的 callback 回调，主要是启动其他服务等等！</span></span><br><span class="line">    <span class="keyword">if</span> (goingCallback != <span class="keyword">null</span>) goingCallback.run();</span><br><span class="line"></span><br><span class="line">    mBatteryStatsService.noteEvent(BatteryStats.HistoryItem.EVENT_USER_RUNNING_START,</span><br><span class="line">            Integer.toString(currentUserId), currentUserId);</span><br><span class="line">    mBatteryStatsService.noteEvent(BatteryStats.HistoryItem.EVENT_USER_FOREGROUND_START,</span><br><span class="line">            Integer.toString(currentUserId), currentUserId);</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 启动当前的设备用户！</span></span><br><span class="line">    mSystemServiceManager.startUser(currentUserId);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">synchronized</span> (<span class="keyword">this</span>) &#123;</span><br><span class="line"></span><br><span class="line">        <span class="comment">//【3.3.5】启动那些 peristent 应用进程!</span></span><br><span class="line">        startPersistentApps(PackageManager.MATCH_DIRECT_BOOT_AWARE);</span><br><span class="line"></span><br><span class="line">        <span class="comment">// Start up initial activity.</span></span><br><span class="line">        mBooting = <span class="keyword">true</span>;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (UserManager.isSplitSystemUser()) &#123;</span><br><span class="line">            ComponentName cName = <span class="keyword">new</span> ComponentName(mContext, SystemUserHomeActivity.class);</span><br><span class="line">            <span class="keyword">try</span> &#123;</span><br><span class="line"></span><br><span class="line">                AppGlobals.getPackageManager().setComponentEnabledSetting(cName,</span><br><span class="line">                        PackageManager.COMPONENT_ENABLED_STATE_ENABLED, <span class="number">0</span>,</span><br><span class="line">                        UserHandle.USER_SYSTEM);</span><br><span class="line"></span><br><span class="line">            &#125; <span class="keyword">catch</span> (RemoteException e) &#123;</span><br><span class="line">                <span class="keyword">throw</span> e.rethrowAsRuntimeException();</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment">//【3.3.6】启动桌面 activity！</span></span><br><span class="line">        startHomeActivityLocked(currentUserId, <span class="string">"systemReady"</span>);</span><br><span class="line"></span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            <span class="keyword">if</span> (AppGlobals.getPackageManager().hasSystemUidErrors()) &#123;</span><br><span class="line">                Slog.e(TAG, <span class="string">"UIDs on the system are inconsistent, you need to wipe your"</span></span><br><span class="line">                        + <span class="string">" data partition or your device will be unstable."</span>);</span><br><span class="line">                mUiHandler.obtainMessage(SHOW_UID_ERROR_UI_MSG).sendToTarget();</span><br><span class="line">            &#125;</span><br><span class="line">        &#125; <span class="keyword">catch</span> (RemoteException e) &#123;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (!Build.isBuildConsistent()) &#123;</span><br><span class="line">            Slog.e(TAG, <span class="string">"Build fingerprint is not consistent, warning user"</span>);</span><br><span class="line">            mUiHandler.obtainMessage(SHOW_FINGERPRINT_ERROR_UI_MSG).sendToTarget();</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">long</span> ident = Binder.clearCallingIdentity();</span><br><span class="line"></span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            <span class="comment">// 发送 ACTION_USER_STARTED 广播！</span></span><br><span class="line">            Intent intent = <span class="keyword">new</span> Intent(Intent.ACTION_USER_STARTED);</span><br><span class="line">            intent.addFlags(Intent.FLAG_RECEIVER_REGISTERED_ONLY</span><br><span class="line">                    | Intent.FLAG_RECEIVER_FOREGROUND);</span><br><span class="line">            intent.putExtra(Intent.EXTRA_USER_HANDLE, currentUserId);</span><br><span class="line">            broadcastIntentLocked(<span class="keyword">null</span>, <span class="keyword">null</span>, intent,</span><br><span class="line">                    <span class="keyword">null</span>, <span class="keyword">null</span>, <span class="number">0</span>, <span class="keyword">null</span>, <span class="keyword">null</span>, <span class="keyword">null</span>, AppOpsManager.OP_NONE,</span><br><span class="line">                    <span class="keyword">null</span>, <span class="keyword">false</span>, <span class="keyword">false</span>, MY_PID, Process.SYSTEM_UID,</span><br><span class="line">                    currentUserId);</span><br><span class="line">            </span><br><span class="line">            <span class="comment">// 发送 ACTION_USER_STARTING 广播！</span></span><br><span class="line">            intent = <span class="keyword">new</span> Intent(Intent.ACTION_USER_STARTING);</span><br><span class="line">            intent.addFlags(Intent.FLAG_RECEIVER_REGISTERED_ONLY);</span><br><span class="line">            intent.putExtra(Intent.EXTRA_USER_HANDLE, currentUserId);</span><br><span class="line"></span><br><span class="line">            broadcastIntentLocked(<span class="keyword">null</span>, <span class="keyword">null</span>, intent,</span><br><span class="line">                    <span class="keyword">null</span>, <span class="keyword">new</span> IIntentReceiver.Stub() &#123;</span><br><span class="line">                        <span class="meta">@Override</span></span><br><span class="line">                        <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">performReceive</span><span class="params">(Intent intent, <span class="keyword">int</span> resultCode, String data,</span></span></span><br><span class="line"><span class="function"><span class="params">                                Bundle extras, <span class="keyword">boolean</span> ordered, <span class="keyword">boolean</span> sticky, <span class="keyword">int</span> sendingUser)</span></span></span><br><span class="line"><span class="function">                                <span class="keyword">throws</span> RemoteException </span>&#123;</span><br><span class="line">                        &#125;</span><br><span class="line">                    &#125;, <span class="number">0</span>, <span class="keyword">null</span>, <span class="keyword">null</span>,</span><br><span class="line">                    <span class="keyword">new</span> String[] &#123;INTERACT_ACROSS_USERS&#125;, AppOpsManager.OP_NONE,</span><br><span class="line">                    <span class="keyword">null</span>, <span class="keyword">true</span>, <span class="keyword">false</span>, MY_PID, Process.SYSTEM_UID, UserHandle.USER_ALL);</span><br><span class="line"></span><br><span class="line">        &#125; <span class="keyword">catch</span> (Throwable t) &#123;</span><br><span class="line">            Slog.wtf(TAG, <span class="string">"Failed sending first user broadcasts"</span>, t);</span><br><span class="line">        &#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">            Binder.restoreCallingIdentity(ident);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment">//【8】此时的桌面已经是 top activity，设置桌面 activity 为 resumed 状态！</span></span><br><span class="line">        mStackSupervisor.resumeFocusedStackTopActivityLocked();</span><br><span class="line">        <span class="comment">// 发送设备用户已经切换的广播；</span></span><br><span class="line">        mUserController.sendUserSwitchBroadcastsLocked(-<span class="number">1</span>, currentUserId);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>这里的代码逻辑比较复杂，里面有一些关键的点，我们来看看：</p>
<h3 id="3-3-1-通知其他服务-SystemReady"><a href="#3-3-1-通知其他服务-SystemReady" class="headerlink" title="3.3.1 通知其他服务 - SystemReady"></a>3.3.1 通知其他服务 - SystemReady</h3><p>代码如下：<br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">mUserController.onSystemReady();</span><br><span class="line">mRecentTasks.onSystemReadyLocked();</span><br><span class="line">mAppOpsService.systemReady();</span><br><span class="line">mSystemReady = <span class="keyword">true</span>;</span><br></pre></td></tr></table></figure></p>
<p>我们一个一个来看：</p>
<h4 id="3-3-1-1-UserController-onSystemReady"><a href="#3-3-1-1-UserController-onSystemReady" class="headerlink" title="3.3.1.1 UserController.onSystemReady"></a>3.3.1.1 UserController.onSystemReady</h4><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">onSystemReady</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    updateCurrentProfileIdsLocked();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>调用了 <code>updateCurrentProfileIdsLocked</code>：<br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">updateCurrentProfileIdsLocked</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    <span class="keyword">final</span> List&lt;UserInfo&gt; profiles = getUserManager().getProfiles(mCurrentUserId,</span><br><span class="line">            <span class="keyword">false</span> <span class="comment">/* enabledOnly */</span>);</span><br><span class="line">    <span class="keyword">int</span>[] currentProfileIds = <span class="keyword">new</span> <span class="keyword">int</span>[profiles.size()]; <span class="comment">// profiles will not be null</span></span><br><span class="line">    <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; currentProfileIds.length; i++) &#123;</span><br><span class="line">        currentProfileIds[i] = profiles.get(i).id;</span><br><span class="line">    &#125;</span><br><span class="line">    mCurrentProfileIds = currentProfileIds;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">synchronized</span> (mUserProfileGroupIdsSelfLocked) &#123;</span><br><span class="line">        mUserProfileGroupIdsSelfLocked.clear();</span><br><span class="line">        <span class="keyword">final</span> List&lt;UserInfo&gt; users = getUserManager().getUsers(<span class="keyword">false</span>);</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 保存所有设备用户的信息，用于以后权限校验使用！</span></span><br><span class="line">        <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; users.size(); i++) &#123;</span><br><span class="line">            UserInfo user = users.get(i);</span><br><span class="line">            <span class="keyword">if</span> (user.profileGroupId != UserInfo.NO_PROFILE_GROUP_ID) &#123;</span><br><span class="line">                <span class="comment">// 保存在这里！</span></span><br><span class="line">                mUserProfileGroupIdsSelfLocked.put(user.id, user.profileGroupId);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>这个方法的作用是：<code>Android</code> 的许多系统调用都需要检查用户的 <code>ID</code>，所以这里调用 <code>updateCurrnetProfileIdsLocked()</code> 方法来通过 <code>UserManagerService</code> 读取系统保持的 <code>Profile</code> 信息，装载系统中已经存在的用户信息。</p>
<h4 id="3-3-1-2-RecentTasks-onSystemReady"><a href="#3-3-1-2-RecentTasks-onSystemReady" class="headerlink" title="3.3.1.2 RecentTasks.onSystemReady"></a>3.3.1.2 RecentTasks.onSystemReady</h4><p>代码如下：<br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">onSystemReadyLocked</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    clear();</span><br><span class="line">    mTaskPersister.startPersisting();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>从 <code>Android5.0</code> 开始支持带有 <code>persistent</code> 标记的 <code>task</code>，这些 <code>task</code> 在关机时，信息保存在 <code>/data/system_ce/recent_tasks</code> 目录下的 <code>xxx_task.xml</code>（<code>xxx</code> 表示 <code>task id</code>）中，系统重启时，通过这些文件中保存的信息重建 <code>task</code>，和 <code>JobSchedulerService</code> 很类似哦！</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">startPersisting</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    <span class="keyword">if</span> (!mLazyTaskWriterThread.isAlive()) &#123;</span><br><span class="line">        mLazyTaskWriterThread.start();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>该方法中启动了一个 <code>mLazyTaskWriterThread</code> 的线程，恢复那些 <code>pesistable</code> 类型的 <code>task</code>，这里不多说了！</p>
<h4 id="3-3-1-3-AppOpsService-onSystemReady"><a href="#3-3-1-3-AppOpsService-onSystemReady" class="headerlink" title="3.3.1.3 AppOpsService.onSystemReady"></a>3.3.1.3 AppOpsService.onSystemReady</h4><p>这里调用了 <code>AppOpsService</code> 的 <code>systemReady</code>，代码如下：<br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">systemReady</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    <span class="keyword">synchronized</span> (<span class="keyword">this</span>) &#123;</span><br><span class="line">        <span class="keyword">boolean</span> changed = <span class="keyword">false</span>;</span><br><span class="line">        <span class="comment">//【1】更新系统中所有的 uid 的状态！</span></span><br><span class="line">        <span class="keyword">for</span> (<span class="keyword">int</span> i = mUidStates.size() - <span class="number">1</span>; i &gt;= <span class="number">0</span>; i--) &#123;</span><br><span class="line">            UidState uidState = mUidStates.valueAt(i);</span><br><span class="line">            </span><br><span class="line">            <span class="comment">//【1.1】uid 对应的 package 为 null，移除该 uid！</span></span><br><span class="line">            String[] packageNames = getPackagesForUid(uidState.uid);</span><br><span class="line">            <span class="keyword">if</span> (ArrayUtils.isEmpty(packageNames)) &#123;</span><br><span class="line">                uidState.clear();</span><br><span class="line">                mUidStates.removeAt(i);</span><br><span class="line">                changed = <span class="keyword">true</span>;</span><br><span class="line">                <span class="keyword">continue</span>;</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            ArrayMap&lt;String, Ops&gt; pkgs = uidState.pkgOps;</span><br><span class="line">            <span class="keyword">if</span> (pkgs == <span class="keyword">null</span>) &#123;</span><br><span class="line">                <span class="keyword">continue</span>;</span><br><span class="line">            &#125;</span><br><span class="line">             </span><br><span class="line">            <span class="comment">//【1.1】如果 uid 的某个 ops 发生变化，移除它！</span></span><br><span class="line">            Iterator&lt;Ops&gt; it = pkgs.values().iterator();</span><br><span class="line">            <span class="keyword">while</span> (it.hasNext()) &#123;</span><br><span class="line">                Ops ops = it.next();</span><br><span class="line">                <span class="keyword">int</span> curUid = -<span class="number">1</span>;</span><br><span class="line">                <span class="keyword">try</span> &#123;</span><br><span class="line">                    curUid = AppGlobals.getPackageManager().getPackageUid(ops.packageName,</span><br><span class="line">                            PackageManager.MATCH_UNINSTALLED_PACKAGES,</span><br><span class="line">                            UserHandle.getUserId(ops.uidState.uid));</span><br><span class="line">                &#125; <span class="keyword">catch</span> (RemoteException ignored) &#123;</span><br><span class="line">                &#125;</span><br><span class="line">                <span class="keyword">if</span> (curUid != ops.uidState.uid) &#123;</span><br><span class="line">                    Slog.i(TAG, <span class="string">"Pruning old package "</span> + ops.packageName</span><br><span class="line">                            + <span class="string">"/"</span> + ops.uidState + <span class="string">": new uid="</span> + curUid);</span><br><span class="line">                    it.remove();</span><br><span class="line">                    changed = <span class="keyword">true</span>;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            <span class="keyword">if</span> (uidState.isDefault()) &#123;</span><br><span class="line">                mUidStates.removeAt(i);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">//【1.3】如果 uid 的状态发生变化，将其持久化到本地文件中！</span></span><br><span class="line">        <span class="keyword">if</span> (changed) &#123;</span><br><span class="line">            scheduleFastWriteLocked();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">//【2】获得挂载服务，设置外置存储挂载策略！</span></span><br><span class="line">    MountServiceInternal mountServiceInternal = LocalServices.getService(</span><br><span class="line">            MountServiceInternal.class);</span><br><span class="line">    mountServiceInternal.addExternalStoragePolicy(</span><br><span class="line">            <span class="keyword">new</span> MountServiceInternal.ExternalStorageMountPolicy() &#123;</span><br><span class="line">                <span class="meta">@Override</span></span><br><span class="line">                <span class="function"><span class="keyword">public</span> <span class="keyword">int</span> <span class="title">getMountMode</span><span class="params">(<span class="keyword">int</span> uid, String packageName)</span> </span>&#123;</span><br><span class="line">                    <span class="keyword">if</span> (Process.isIsolated(uid)) &#123;</span><br><span class="line">                        <span class="keyword">return</span> Zygote.MOUNT_EXTERNAL_NONE;</span><br><span class="line">                    &#125;</span><br><span class="line">                    <span class="keyword">if</span> (noteOperation(AppOpsManager.OP_READ_EXTERNAL_STORAGE, uid,</span><br><span class="line">                            packageName) != AppOpsManager.MODE_ALLOWED) &#123;</span><br><span class="line">                        <span class="keyword">return</span> Zygote.MOUNT_EXTERNAL_NONE;</span><br><span class="line">                    &#125;</span><br><span class="line">                    <span class="keyword">if</span> (noteOperation(AppOpsManager.OP_WRITE_EXTERNAL_STORAGE, uid,</span><br><span class="line">                            packageName) != AppOpsManager.MODE_ALLOWED) &#123;</span><br><span class="line">                        <span class="keyword">return</span> Zygote.MOUNT_EXTERNAL_READ;</span><br><span class="line">                    &#125;</span><br><span class="line">                    <span class="keyword">return</span> Zygote.MOUNT_EXTERNAL_WRITE;</span><br><span class="line">                &#125;</span><br><span class="line"></span><br><span class="line">                <span class="meta">@Override</span></span><br><span class="line">                <span class="function"><span class="keyword">public</span> <span class="keyword">boolean</span> <span class="title">hasExternalStorage</span><span class="params">(<span class="keyword">int</span> uid, String packageName)</span> </span>&#123;</span><br><span class="line">                    <span class="keyword">final</span> <span class="keyword">int</span> mountMode = getMountMode(uid, packageName);</span><br><span class="line">                    <span class="keyword">return</span> mountMode == Zygote.MOUNT_EXTERNAL_READ</span><br><span class="line">                            || mountMode == Zygote.MOUNT_EXTERNAL_WRITE;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>这个 <code>AppOpsService</code> 是谷歌原生的应用程序权限管理服务，在 <code>Android M ( Android 6.0 )</code> 加入的 <code>Application Permission Manager</code> 的功能就是基于 <code>AppOps</code> 实现的！</p>
<p><code>AppOps</code> 全称是 <code>Application Operations</code>，类似我们平时常说的应用程序的操作（权限）管理。目前 <code>Google</code> 在每次版本更新时都会隐藏掉 <code>AppOps</code> 的入口。</p>
<p>注意：<code>AppOps</code> 虽然涵盖了 <code>App</code> 的权限管理，但是 <code>Google</code> 原生的设计并不仅仅是对“权限”的管理，而是对 <code>App</code> 的“动作”的管理。我们平时讲的权限管理多是针对具体的权限（<code>App</code> 开发者在 <code>Manifest</code> 里申请的权限），而 <code>AppOps</code> 所管理的是所有可能涉及用户隐私和安全的操作，包括 <code>access notification</code>, <code>keep weak lock</code>, <code>activate vpn</code>, <code>display toast</code> 等等，有些操作是不需要 <code>Manifest</code> 里申请权限的。</p>
<p>不多说了，这不多关注！</p>
<h3 id="3-3-2-杀掉特定进程"><a href="#3-3-2-杀掉特定进程" class="headerlink" title="3.3.2 杀掉特定进程"></a>3.3.2 杀掉特定进程</h3><p>刚刚有讲到，<code>AMS</code> 会杀掉已经启动并且没有带有 <code>FLAG_PERSISTENT</code> 标记的进程，那如何判断是否具有这个标记呢：</p>
<h4 id="3-3-2-1-isAllowedWhileBooting"><a href="#3-3-2-1-isAllowedWhileBooting" class="headerlink" title="3.3.2.1 isAllowedWhileBooting"></a>3.3.2.1 isAllowedWhileBooting</h4><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">boolean</span> <span class="title">isAllowedWhileBooting</span><span class="params">(ApplicationInfo ai)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">return</span> (ai.flags&amp;ApplicationInfo.FLAG_PERSISTENT) != <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>如果某个进程没有 <code>FLAG_PERSISTENT</code> ，这个方法会返回 <code>false</code>！</p>
<h3 id="3-3-3-读取设置信息-retrieveSettings"><a href="#3-3-3-读取设置信息-retrieveSettings" class="headerlink" title="3.3.3 读取设置信息 - retrieveSettings"></a>3.3.3 读取设置信息 - retrieveSettings</h3><p>该方法的目的是从前面已经配置好的系统 <code>provider</code> 中互动一些设置属性！<br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">retrieveSettings</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    <span class="keyword">final</span> ContentResolver resolver = mContext.getContentResolver();</span><br><span class="line"></span><br><span class="line">    <span class="comment">//【1】获得一些系统属性！</span></span><br><span class="line">    <span class="keyword">final</span> <span class="keyword">boolean</span> freeformWindowManagement =</span><br><span class="line">            mContext.getPackageManager().hasSystemFeature(FEATURE_FREEFORM_WINDOW_MANAGEMENT)</span><br><span class="line">                    || Settings.Global.getInt(</span><br><span class="line">                            resolver, DEVELOPMENT_ENABLE_FREEFORM_WINDOWS_SUPPORT, <span class="number">0</span>) != <span class="number">0</span>;</span><br><span class="line">    <span class="comment">// 是否支持画中画模式！</span></span><br><span class="line">    <span class="keyword">final</span> <span class="keyword">boolean</span> supportsPictureInPicture =</span><br><span class="line">            mContext.getPackageManager().hasSystemFeature(FEATURE_PICTURE_IN_PICTURE);</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 是否支持分屏模式！</span></span><br><span class="line">    <span class="keyword">final</span> <span class="keyword">boolean</span> supportsMultiWindow = ActivityManager.supportsMultiWindow();</span><br><span class="line">    <span class="keyword">final</span> String debugApp = Settings.Global.getString(resolver, DEBUG_APP);</span><br><span class="line">    <span class="keyword">final</span> <span class="keyword">boolean</span> waitForDebugger = Settings.Global.getInt(resolver, WAIT_FOR_DEBUGGER, <span class="number">0</span>) != <span class="number">0</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">final</span> <span class="keyword">boolean</span> alwaysFinishActivities =</span><br><span class="line">            Settings.Global.getInt(resolver, ALWAYS_FINISH_ACTIVITIES, <span class="number">0</span>) != <span class="number">0</span>;</span><br><span class="line">    <span class="keyword">final</span> <span class="keyword">boolean</span> lenientBackgroundCheck =</span><br><span class="line">            Settings.Global.getInt(resolver, LENIENT_BACKGROUND_CHECK, <span class="number">0</span>) != <span class="number">0</span>;</span><br><span class="line">    <span class="comment">// 是否强制 RTL 显示！</span></span><br><span class="line">    <span class="keyword">final</span> <span class="keyword">boolean</span> forceRtl = Settings.Global.getInt(resolver, DEVELOPMENT_FORCE_RTL, <span class="number">0</span>) != <span class="number">0</span>;</span><br><span class="line">    <span class="comment">// 是否强制 activity 显示尺寸可变化！</span></span><br><span class="line">    <span class="keyword">final</span> <span class="keyword">boolean</span> forceResizable = Settings.Global.getInt(</span><br><span class="line">            resolver, DEVELOPMENT_FORCE_RESIZABLE_ACTIVITIES, <span class="number">0</span>) != <span class="number">0</span>;</span><br><span class="line">    <span class="keyword">final</span> <span class="keyword">boolean</span> supportsLeanbackOnly =</span><br><span class="line">            mContext.getPackageManager().hasSystemFeature(FEATURE_LEANBACK_ONLY);</span><br><span class="line"></span><br><span class="line">    SystemProperties.set(DEVELOPMENT_FORCE_RTL, forceRtl ? <span class="string">"1"</span>:<span class="string">"0"</span>);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">final</span> Configuration configuration = <span class="keyword">new</span> Configuration();</span><br><span class="line">    Settings.System.getConfiguration(resolver, configuration);</span><br><span class="line">    <span class="keyword">if</span> (forceRtl) &#123;</span><br><span class="line">        <span class="comment">// This will take care of setting the correct layout direction flags</span></span><br><span class="line">        configuration.setLayoutDirection(configuration.locale);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//【2】根据获得的系统属性，初始化系统属性变量！</span></span><br><span class="line">    <span class="keyword">synchronized</span> (<span class="keyword">this</span>) &#123;</span><br><span class="line">        mDebugApp = mOrigDebugApp = debugApp;</span><br><span class="line">        mWaitForDebugger = mOrigWaitForDebugger = waitForDebugger;</span><br><span class="line">        mAlwaysFinishActivities = alwaysFinishActivities;</span><br><span class="line">        mLenientBackgroundCheck = lenientBackgroundCheck;</span><br><span class="line">        mSupportsLeanbackOnly = supportsLeanbackOnly;</span><br><span class="line">        mForceResizableActivities = forceResizable;</span><br><span class="line">        mWindowManager.setForceResizableTasks(mForceResizableActivities);</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (supportsMultiWindow || forceResizable) &#123;</span><br><span class="line">            mSupportsMultiWindow = <span class="keyword">true</span>;</span><br><span class="line">            mSupportsFreeformWindowManagement = freeformWindowManagement || forceResizable;</span><br><span class="line">            mSupportsPictureInPicture = supportsPictureInPicture || forceResizable;</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            mSupportsMultiWindow = <span class="keyword">false</span>;</span><br><span class="line">            mSupportsFreeformWindowManagement = <span class="keyword">false</span>;</span><br><span class="line">            mSupportsPictureInPicture = <span class="keyword">false</span>;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// This happens before any activities are started, so we can</span></span><br><span class="line">        <span class="comment">// change mConfiguration in-place.</span></span><br><span class="line">        updateConfigurationLocked(configuration, <span class="keyword">null</span>, <span class="keyword">true</span>);</span><br><span class="line">        <span class="keyword">if</span> (DEBUG_CONFIGURATION) Slog.v(TAG_CONFIGURATION,</span><br><span class="line">                <span class="string">"Initial config: "</span> + mConfiguration);</span><br><span class="line"></span><br><span class="line">        <span class="comment">// Load resources only after the current configuration has been set.</span></span><br><span class="line">        <span class="keyword">final</span> Resources res = mContext.getResources();</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 是否有最近任务！</span></span><br><span class="line">        mHasRecents = res.getBoolean(com.android.internal.R.bool.config_hasRecents);</span><br><span class="line">        mThumbnailWidth = res.getDimensionPixelSize(</span><br><span class="line">                com.android.internal.R.dimen.thumbnail_width);</span><br><span class="line">        mThumbnailHeight = res.getDimensionPixelSize(</span><br><span class="line">                com.android.internal.R.dimen.thumbnail_height);</span><br><span class="line">        mDefaultPinnedStackBounds = Rect.unflattenFromString(res.getString(</span><br><span class="line">                com.android.internal.R.string.config_defaultPictureInPictureBounds));</span><br><span class="line">                </span><br><span class="line">        mAppErrors.loadAppsNotReportingCrashesFromConfigLocked(res.getString(</span><br><span class="line">                com.android.internal.R.string.config_appsNotReportingCrashes));</span><br><span class="line">        <span class="keyword">if</span> ((mConfiguration.uiMode &amp; UI_MODE_TYPE_TELEVISION) == UI_MODE_TYPE_TELEVISION) &#123;</span><br><span class="line">            mFullscreenThumbnailScale = (<span class="keyword">float</span>) res</span><br><span class="line">                .getInteger(com.android.internal.R.integer.thumbnail_width_tv) /</span><br><span class="line">                (<span class="keyword">float</span>) mConfiguration.screenWidthDp;</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            mFullscreenThumbnailScale = res.getFraction(</span><br><span class="line">                com.android.internal.R.fraction.thumbnail_fullscreen_scale, <span class="number">1</span>, <span class="number">1</span>);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>这里不多说了！</p>
<h3 id="3-3-4-读取-Uri-权限信息"><a href="#3-3-4-读取-Uri-权限信息" class="headerlink" title="3.3.4 读取 Uri 权限信息"></a>3.3.4 读取 Uri 权限信息</h3><h4 id="3-3-4-1-读取-Uri-权限信息"><a href="#3-3-4-1-读取-Uri-权限信息" class="headerlink" title="3.3.4.1 读取 Uri 权限信息"></a>3.3.4.1 读取 Uri 权限信息</h4><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">readGrantedUriPermissionsLocked</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    <span class="keyword">if</span> (DEBUG_URI_PERMISSION) Slog.v(TAG_URI_PERMISSION, <span class="string">"readGrantedUriPermissions()"</span>);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">final</span> <span class="keyword">long</span> now = System.currentTimeMillis();</span><br><span class="line"></span><br><span class="line">    FileInputStream fis = <span class="keyword">null</span>;</span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">        <span class="comment">//【1】读取 /data/system/urigrants.xml 文件！</span></span><br><span class="line">        fis = mGrantFile.openRead();</span><br><span class="line">        <span class="keyword">final</span> XmlPullParser in = Xml.newPullParser();</span><br><span class="line">        in.setInput(fis, StandardCharsets.UTF_8.name());</span><br><span class="line"></span><br><span class="line">        <span class="keyword">int</span> type;</span><br><span class="line">        <span class="keyword">while</span> ((type = in.next()) != END_DOCUMENT) &#123;</span><br><span class="line">            <span class="keyword">final</span> String tag = in.getName();</span><br><span class="line">            <span class="keyword">if</span> (type == START_TAG) &#123;</span><br><span class="line">                <span class="keyword">if</span> (TAG_URI_GRANT.equals(tag)) &#123; <span class="comment">// uri-grants 标签</span></span><br><span class="line">                    <span class="keyword">final</span> <span class="keyword">int</span> sourceUserId;</span><br><span class="line">                    <span class="keyword">final</span> <span class="keyword">int</span> targetUserId;</span><br><span class="line">                    <span class="keyword">final</span> <span class="keyword">int</span> userHandle = readIntAttribute(in,</span><br><span class="line">                            ATTR_USER_HANDLE, UserHandle.USER_NULL); <span class="comment">// userHandle 属性</span></span><br><span class="line">                    <span class="keyword">if</span> (userHandle != UserHandle.USER_NULL) &#123;</span><br><span class="line">                        <span class="comment">// For backwards compatibility.</span></span><br><span class="line">                        sourceUserId = userHandle;</span><br><span class="line">                        targetUserId = userHandle;</span><br><span class="line">                    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                        sourceUserId = readIntAttribute(in, ATTR_SOURCE_USER_ID); <span class="comment">// sourceUserId 属性</span></span><br><span class="line">                        targetUserId = readIntAttribute(in, ATTR_TARGET_USER_ID); <span class="comment">// targetUserId 属性</span></span><br><span class="line">                    &#125;</span><br><span class="line">                    <span class="keyword">final</span> String sourcePkg = in.getAttributeValue(<span class="keyword">null</span>, ATTR_SOURCE_PKG); <span class="comment">// sourcePkg 属性</span></span><br><span class="line">                    <span class="keyword">final</span> String targetPkg = in.getAttributeValue(<span class="keyword">null</span>, ATTR_TARGET_PKG); <span class="comment">// targetPkg 属性</span></span><br><span class="line">                    <span class="keyword">final</span> Uri uri = Uri.parse(in.getAttributeValue(<span class="keyword">null</span>, ATTR_URI)); <span class="comment">// uri 属性</span></span><br><span class="line">                    <span class="keyword">final</span> <span class="keyword">boolean</span> prefix = readBooleanAttribute(in, ATTR_PREFIX); <span class="comment">// prefix 属性</span></span><br><span class="line">                    <span class="keyword">final</span> <span class="keyword">int</span> modeFlags = readIntAttribute(in, ATTR_MODE_FLAGS); <span class="comment">// modeFlags 属性</span></span><br><span class="line">                    <span class="keyword">final</span> <span class="keyword">long</span> createdTime = readLongAttribute(in, ATTR_CREATED_TIME, now); <span class="comment">// createdTime 属性</span></span><br><span class="line"></span><br><span class="line">                    <span class="comment">// Sanity check that provider still belongs to source package</span></span><br><span class="line">                    <span class="comment">// Both direct boot aware and unaware packages are fine as we</span></span><br><span class="line">                    <span class="comment">// will do filtering at query time to avoid multiple parsing.</span></span><br><span class="line">                    <span class="comment">// 根据 uri 获得其所属的 ContentProvider 对象！</span></span><br><span class="line">                    <span class="keyword">final</span> ProviderInfo pi = getProviderInfoLocked(</span><br><span class="line">                            uri.getAuthority(), sourceUserId, MATCH_DIRECT_BOOT_AWARE</span><br><span class="line">                                    | MATCH_DIRECT_BOOT_UNAWARE);</span><br><span class="line">                    <span class="keyword">if</span> (pi != <span class="keyword">null</span> &amp;&amp; sourcePkg.equals(pi.packageName)) &#123;</span><br><span class="line">                        <span class="keyword">int</span> targetUid = -<span class="number">1</span>;</span><br><span class="line">                        <span class="keyword">try</span> &#123;</span><br><span class="line">                            <span class="comment">// 获得持有该 uri 权限的目标ingyon</span></span><br><span class="line">                            targetUid = AppGlobals.getPackageManager().getPackageUid(</span><br><span class="line">                                    targetPkg, MATCH_UNINSTALLED_PACKAGES, targetUserId);</span><br><span class="line">                        &#125; <span class="keyword">catch</span> (RemoteException e) &#123;</span><br><span class="line">                        &#125;</span><br><span class="line">                        <span class="comment">// 创建 UriPermission，封装该应用的 uri 权限！</span></span><br><span class="line">                        <span class="keyword">if</span> (targetUid != -<span class="number">1</span>) &#123;</span><br><span class="line">                            <span class="keyword">final</span> UriPermission perm = findOrCreateUriPermissionLocked(</span><br><span class="line">                                    sourcePkg, targetPkg, targetUid,</span><br><span class="line">                                    <span class="keyword">new</span> GrantUri(sourceUserId, uri, prefix));</span><br><span class="line">                            perm.initPersistedModes(modeFlags, createdTime);</span><br><span class="line">                        &#125;</span><br><span class="line">                    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                        Slog.w(TAG, <span class="string">"Persisted grant for "</span> + uri + <span class="string">" had source "</span> + sourcePkg</span><br><span class="line">                                + <span class="string">" but instead found "</span> + pi);</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125; <span class="keyword">catch</span> (FileNotFoundException e) &#123;</span><br><span class="line">        <span class="comment">// Missing grants is okay</span></span><br><span class="line">    &#125; <span class="keyword">catch</span> (IOException e) &#123;</span><br><span class="line">        Slog.wtf(TAG, <span class="string">"Failed reading Uri grants"</span>, e);</span><br><span class="line">    &#125; <span class="keyword">catch</span> (XmlPullParserException e) &#123;</span><br><span class="line">        Slog.wtf(TAG, <span class="string">"Failed reading Uri grants"</span>, e);</span><br><span class="line">    &#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">        IoUtils.closeQuietly(fis);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h4 id="3-3-4-2-ActivityManagerS-findOrCreateUriPermissionLocked"><a href="#3-3-4-2-ActivityManagerS-findOrCreateUriPermissionLocked" class="headerlink" title="3.3.4.2 ActivityManagerS.findOrCreateUriPermissionLocked"></a>3.3.4.2 ActivityManagerS.findOrCreateUriPermissionLocked</h4><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">private</span> UriPermission <span class="title">findOrCreateUriPermissionLocked</span><span class="params">(String sourcePkg,</span></span></span><br><span class="line"><span class="function"><span class="params">        String targetPkg, <span class="keyword">int</span> targetUid, GrantUri grantUri)</span> </span>&#123;</span><br><span class="line">    ArrayMap&lt;GrantUri, UriPermission&gt; targetUris = mGrantedUriPermissions.get(targetUid);</span><br><span class="line">    <span class="keyword">if</span> (targetUris == <span class="keyword">null</span>) &#123;</span><br><span class="line">        targetUris = Maps.newArrayMap();</span><br><span class="line">        mGrantedUriPermissions.put(targetUid, targetUris);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    UriPermission perm = targetUris.get(grantUri);</span><br><span class="line">    <span class="keyword">if</span> (perm == <span class="keyword">null</span>) &#123;</span><br><span class="line">        <span class="comment">// 创建一个 UriPermission 对象！</span></span><br><span class="line">        perm = <span class="keyword">new</span> UriPermission(sourcePkg, targetPkg, targetUid, grantUri);</span><br><span class="line">        targetUris.put(grantUri, perm);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> perm;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>mGrantedUriPermissions 用来保存系统中所有已经授予的 uri 权限！</p>
<p>下面去看看 UriPermission 对象！</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">UriPermission(String sourcePkg, String targetPkg, <span class="keyword">int</span> targetUid, GrantUri uri) &#123;</span><br><span class="line">    <span class="keyword">this</span>.targetUserId = UserHandle.getUserId(targetUid);</span><br><span class="line">    <span class="keyword">this</span>.sourcePkg = sourcePkg;</span><br><span class="line">    <span class="keyword">this</span>.targetPkg = targetPkg;</span><br><span class="line">    <span class="keyword">this</span>.targetUid = targetUid;</span><br><span class="line">    <span class="keyword">this</span>.uri = uri;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>接着调用了 initPersistedModes 初始化 persisted 相关属性，包括 persistableModeFlags，persistedModeFlags 和 persistedCreateTime！<br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">initPersistedModes</span><span class="params">(<span class="keyword">int</span> modeFlags, <span class="keyword">long</span> createdTime)</span> </span>&#123;</span><br><span class="line">    <span class="comment">// 初始化 persistableModeFlags 和 persistedModeFlags </span></span><br><span class="line">    <span class="comment">// 只包含 FLAG_GRANT_READ_URI_PERMISSION 和 FLAG_GRANT_WRITE_URI_PERMISSION！</span></span><br><span class="line">    modeFlags &amp;= (Intent.FLAG_GRANT_READ_URI_PERMISSION</span><br><span class="line">            | Intent.FLAG_GRANT_WRITE_URI_PERMISSION);</span><br><span class="line"></span><br><span class="line">    persistableModeFlags = modeFlags;</span><br><span class="line">    persistedModeFlags = modeFlags;</span><br><span class="line">    persistedCreateTime = createdTime;</span><br><span class="line"></span><br><span class="line">    updateModeFlags(); <span class="comment">// 更新 modeFlags!</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">updateModeFlags</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    <span class="keyword">final</span> <span class="keyword">int</span> oldModeFlags = modeFlags;</span><br><span class="line">    modeFlags = ownedModeFlags | globalModeFlags | persistableModeFlags | persistedModeFlags;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (Log.isLoggable(TAG, Log.VERBOSE) &amp;&amp; (modeFlags != oldModeFlags)) &#123;</span><br><span class="line">        Slog.d(TAG,</span><br><span class="line">                <span class="string">"Permission for "</span> + targetPkg + <span class="string">" to "</span> + uri + <span class="string">" is changing from 0x"</span></span><br><span class="line">                        + Integer.toHexString(oldModeFlags) + <span class="string">" to 0x"</span></span><br><span class="line">                        + Integer.toHexString(modeFlags),</span><br><span class="line">                <span class="keyword">new</span> Throwable());</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>关于 UriPermission 我们这里只涉及这么多！</p>
<h3 id="3-3-5-启动-persistent-进程-startPersistentApps"><a href="#3-3-5-启动-persistent-进程-startPersistentApps" class="headerlink" title="3.3.5 启动 persistent 进程 - startPersistentApps"></a>3.3.5 启动 persistent 进程 - startPersistentApps</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">startPersistentApps</span><span class="params">(<span class="keyword">int</span> matchFlags)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">if</span> (mFactoryTest == FactoryTest.FACTORY_TEST_LOW_LEVEL) <span class="keyword">return</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">synchronized</span> (<span class="keyword">this</span>) &#123;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            <span class="comment">//【1】获得 persistent 类型的 app 的信息！</span></span><br><span class="line">            <span class="keyword">final</span> List&lt;ApplicationInfo&gt; apps = AppGlobals.getPackageManager()</span><br><span class="line">                    .getPersistentApplications(STOCK_PM_FLAGS | matchFlags).getList();</span><br><span class="line">            <span class="keyword">for</span> (ApplicationInfo app : apps) &#123;</span><br><span class="line">                <span class="keyword">if</span> (!<span class="string">"android"</span>.equals(app.packageName)) &#123;</span><br><span class="line"></span><br><span class="line">                    <span class="comment">//【2】启动对应进程！</span></span><br><span class="line">                    addAppLocked(app, <span class="keyword">false</span>, <span class="keyword">null</span> <span class="comment">/* ABI override */</span>);</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125; <span class="keyword">catch</span> (RemoteException ex) &#123;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>启动进程调用了 <code>addAppLocked</code>，我们继续看！</p>
<h4 id="3-3-5-1-ActivityManagerS-addAppLocked"><a href="#3-3-5-1-ActivityManagerS-addAppLocked" class="headerlink" title="3.3.5.1 ActivityManagerS.addAppLocked"></a>3.3.5.1 ActivityManagerS.addAppLocked</h4><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">final</span> ProcessRecord <span class="title">addAppLocked</span><span class="params">(ApplicationInfo info, <span class="keyword">boolean</span> isolated,</span></span></span><br><span class="line"><span class="function"><span class="params">        String abiOverride)</span> </span>&#123;</span><br><span class="line">    <span class="comment">//【1】创建 persistent 进程对应的 ProcessRecord 对象！</span></span><br><span class="line">    ProcessRecord app;</span><br><span class="line">    <span class="keyword">if</span> (!isolated) &#123;</span><br><span class="line">        app = getProcessRecordLocked(info.processName, info.uid, <span class="keyword">true</span>);</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        app = <span class="keyword">null</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (app == <span class="keyword">null</span>) &#123;</span><br><span class="line">        app = newProcessRecordLocked(info, <span class="keyword">null</span>, isolated, <span class="number">0</span>);</span><br><span class="line">        updateLruProcessLocked(app, <span class="keyword">false</span>, <span class="keyword">null</span>);</span><br><span class="line">        updateOomAdjLocked();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//【2】要被启动的 package 不能处于 true 状态！</span></span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">        AppGlobals.getPackageManager().setPackageStoppedState(</span><br><span class="line">                info.packageName, <span class="keyword">false</span>, UserHandle.getUserId(app.uid));</span><br><span class="line">    &#125; <span class="keyword">catch</span> (RemoteException e) &#123;</span><br><span class="line">    &#125; <span class="keyword">catch</span> (IllegalArgumentException e) &#123;</span><br><span class="line">        Slog.w(TAG, <span class="string">"Failed trying to unstop package "</span></span><br><span class="line">                + info.packageName + <span class="string">": "</span> + e);</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">//【3】设置进程的 persistent 和 maxAdj 属性！</span></span><br><span class="line">    <span class="keyword">if</span> ((info.flags &amp; PERSISTENT_MASK) == PERSISTENT_MASK) &#123;</span><br><span class="line">        app.persistent = <span class="keyword">true</span>;</span><br><span class="line">        app.maxAdj = ProcessList.PERSISTENT_PROC_ADJ;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">//【4】保存到 mPersistentStartingProcesses 类型的集合中进行管理，并启动进程！</span></span><br><span class="line">    <span class="keyword">if</span> (app.thread == <span class="keyword">null</span> &amp;&amp; mPersistentStartingProcesses.indexOf(app) &lt; <span class="number">0</span>) &#123;</span><br><span class="line">        mPersistentStartingProcesses.add(app);</span><br><span class="line">        startProcessLocked(app, <span class="string">"added application"</span>, app.processName, abiOverride,</span><br><span class="line">                <span class="keyword">null</span> <span class="comment">/* entryPoint */</span>, <span class="keyword">null</span> <span class="comment">/* entryPointArgs */</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> app;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>关于进程的启动，请看我的另一系列的博文，这里就不多说了！</p>
<h3 id="3-3-6-启动桌面进程"><a href="#3-3-6-启动桌面进程" class="headerlink" title="3.3.6 启动桌面进程"></a>3.3.6 启动桌面进程</h3><p>接着是启动桌面所在的进程：</p>
<h4 id="3-3-6-1-startHomeActivityLocked"><a href="#3-3-6-1-startHomeActivityLocked" class="headerlink" title="3.3.6.1 startHomeActivityLocked"></a>3.3.6.1 startHomeActivityLocked</h4><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">boolean</span> <span class="title">startHomeActivityLocked</span><span class="params">(<span class="keyword">int</span> userId, String reason)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">if</span> (mFactoryTest == FactoryTest.FACTORY_TEST_LOW_LEVEL</span><br><span class="line">            &amp;&amp; mTopAction == <span class="keyword">null</span>) &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">false</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">//【1】创建启动桌面的 Intent！</span></span><br><span class="line">    Intent intent = getHomeIntent();</span><br><span class="line"></span><br><span class="line">    <span class="comment">//【2】获得桌面应用对应的 ActivityInfo 实例！</span></span><br><span class="line">    ActivityInfo aInfo = resolveActivityInfo(intent, STOCK_PM_FLAGS, userId);</span><br><span class="line">    <span class="keyword">if</span> (aInfo != <span class="keyword">null</span>) &#123;</span><br><span class="line">        intent.setComponent(<span class="keyword">new</span> ComponentName(aInfo.applicationInfo.packageName, aInfo.name));</span><br><span class="line">        aInfo = <span class="keyword">new</span> ActivityInfo(aInfo);</span><br><span class="line">        aInfo.applicationInfo = getAppInfoForUser(aInfo.applicationInfo, userId);</span><br><span class="line"></span><br><span class="line">        <span class="comment">//【2.1】获得桌面的进程 ProcessRecord，因为 ams 的初始化在开机，所以 app 一定为 null！</span></span><br><span class="line">        ProcessRecord app = getProcessRecordLocked(aInfo.processName,</span><br><span class="line">                aInfo.applicationInfo.uid, <span class="keyword">true</span>);</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (app == <span class="keyword">null</span> || app.instrumentationClass == <span class="keyword">null</span>) &#123;</span><br><span class="line">            intent.setFlags(intent.getFlags() | Intent.FLAG_ACTIVITY_NEW_TASK);</span><br><span class="line"></span><br><span class="line">            <span class="comment">//【2.2】启动桌面！</span></span><br><span class="line">            mActivityStarter.startHomeActivityLocked(intent, aInfo, reason);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        Slog.wtf(TAG, <span class="string">"No home screen found for "</span> + intent, <span class="keyword">new</span> Throwable());</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">true</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h5 id="3-3-6-1-1-ActivityManagerS-getHomeIntent"><a href="#3-3-6-1-1-ActivityManagerS-getHomeIntent" class="headerlink" title="3.3.6.1.1 ActivityManagerS.getHomeIntent"></a>3.3.6.1.1 ActivityManagerS.getHomeIntent</h5><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="function">Intent <span class="title">getHomeIntent</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    <span class="comment">//【1】这里的 mTopAction 等于 Intent.ACTION_MAIN;</span></span><br><span class="line">    Intent intent = <span class="keyword">new</span> Intent(mTopAction, mTopData != <span class="keyword">null</span> ? Uri.parse(mTopData) : <span class="keyword">null</span>);</span><br><span class="line">    intent.setComponent(mTopComponent);</span><br><span class="line">    intent.addFlags(Intent.FLAG_DEBUG_TRIAGED_MISSING);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (mFactoryTest != FactoryTest.FACTORY_TEST_LOW_LEVEL) &#123;</span><br><span class="line">        intent.addCategory(Intent.CATEGORY_HOME);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> intent;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p><code>startHomeActivityLocked</code> 方法最后会来自桌面 <code>activity</code> 的 <code>onCreate</code> 方法，然后，<code>resumeFocusedStackTopActivityLocked</code> 又会拉起桌面 <code>activity</code> 的 <code>onResume</code> 方法：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">mStackSupervisor.resumeFocusedStackTopActivityLocked();</span><br></pre></td></tr></table></figure>
<p>对于 <code>activity</code> 的启动，这里我就不多讲了，请看我的其他博文！</p>
<p>到这里，桌面就完全显示在用户面前的，然而，还没有结束，我们进入到 <code>ActivityThread</code> 中去：</p>
<h4 id="3-3-6-2-ActivityThread-handleResumeActivity"><a href="#3-3-6-2-ActivityThread-handleResumeActivity" class="headerlink" title="3.3.6.2 ActivityThread.handleResumeActivity"></a>3.3.6.2 ActivityThread.handleResumeActivity</h4><p><code>handleResumeActivity</code> 负责拉起桌面 <code>activity</code> 的 <code>onResume</code> 方法，我们过滤掉一些不重要的代码：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">final</span> <span class="keyword">void</span> <span class="title">handleResumeActivity</span><span class="params">(IBinder token,</span></span></span><br><span class="line"><span class="function"><span class="params">        <span class="keyword">boolean</span> clearHide, <span class="keyword">boolean</span> isForward, <span class="keyword">boolean</span> reallyResume, <span class="keyword">int</span> seq, String reason)</span> </span>&#123;</span><br><span class="line">    ... ... ... ...</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 拉起桌面 activity 的 onResume 方法！</span></span><br><span class="line">    r = performResumeActivity(token, clearHide, reason);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (r != <span class="keyword">null</span>) &#123;</span><br><span class="line">        <span class="keyword">final</span> Activity a = r.activity;</span><br><span class="line"></span><br><span class="line">        ... ... ... ...</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (!r.onlyLocalRequest) &#123;</span><br><span class="line">            r.nextIdle = mNewActivities;</span><br><span class="line">            mNewActivities = r;</span><br><span class="line"></span><br><span class="line">            <span class="comment">// 创建了一个 Idler 对象，加入到了主线程的 Looper 队列中！</span></span><br><span class="line">            Looper.myQueue().addIdleHandler(<span class="keyword">new</span> Idler());</span><br><span class="line">        &#125;</span><br><span class="line">        r.onlyLocalRequest = <span class="keyword">false</span>;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (reallyResume) &#123;</span><br><span class="line">            <span class="keyword">try</span> &#123;</span><br><span class="line">                ActivityManagerNative.getDefault().activityResumed(token);</span><br><span class="line">            &#125; <span class="keyword">catch</span> (RemoteException ex) &#123;</span><br><span class="line">                <span class="keyword">throw</span> ex.rethrowFromSystemServer();</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        ... ... ... ...</span><br><span class="line">        <span class="comment">// 异常状态，不处理！</span></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>当桌面进程的主线程进入空闲状态时，<code>Idler.queueIdle</code> 方法会被执行：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">private</span> <span class="class"><span class="keyword">class</span> <span class="title">Idler</span> <span class="keyword">implements</span> <span class="title">MessageQueue</span>.<span class="title">IdleHandler</span> </span>&#123;</span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">final</span> <span class="keyword">boolean</span> <span class="title">queueIdle</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        ActivityClientRecord a = mNewActivities;</span><br><span class="line">        <span class="keyword">boolean</span> stopProfiling = <span class="keyword">false</span>;</span><br><span class="line">        <span class="keyword">if</span> (mBoundApplication != <span class="keyword">null</span> &amp;&amp; mProfiler.profileFd != <span class="keyword">null</span></span><br><span class="line">                &amp;&amp; mProfiler.autoStopProfiler) &#123;</span><br><span class="line">            stopProfiling = <span class="keyword">true</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">if</span> (a != <span class="keyword">null</span>) &#123;</span><br><span class="line">            mNewActivities = <span class="keyword">null</span>;</span><br><span class="line">            IActivityManager am = ActivityManagerNative.getDefault();</span><br><span class="line">            ActivityClientRecord prev;</span><br><span class="line">            <span class="keyword">do</span> &#123;</span><br><span class="line">                <span class="keyword">if</span> (localLOGV) Slog.v(</span><br><span class="line">                    TAG, <span class="string">"Reporting idle of "</span> + a +</span><br><span class="line">                    <span class="string">" finished="</span> +</span><br><span class="line">                    (a.activity != <span class="keyword">null</span> &amp;&amp; a.activity.mFinished));</span><br><span class="line">                <span class="keyword">if</span> (a.activity != <span class="keyword">null</span> &amp;&amp; !a.activity.mFinished) &#123;</span><br><span class="line">                    <span class="keyword">try</span> &#123;</span><br><span class="line">                        <span class="comment">//【1】调用 ams 的 activityIdle 方法！</span></span><br><span class="line">                        am.activityIdle(a.token, a.createdConfig, stopProfiling);</span><br><span class="line">                        a.createdConfig = <span class="keyword">null</span>;</span><br><span class="line">                    &#125; <span class="keyword">catch</span> (RemoteException ex) &#123;</span><br><span class="line">                        <span class="keyword">throw</span> ex.rethrowFromSystemServer();</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;</span><br><span class="line">                prev = a;</span><br><span class="line">                a = a.nextIdle;</span><br><span class="line">                prev.nextIdle = <span class="keyword">null</span>;</span><br><span class="line">            &#125; <span class="keyword">while</span> (a != <span class="keyword">null</span>);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">if</span> (stopProfiling) &#123;</span><br><span class="line">            mProfiler.stopProfiling();</span><br><span class="line">        &#125;</span><br><span class="line">        ensureJitEnabled();</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">false</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>下面，进入 <code>ActivityManagerService</code> 中去：</p>
<h4 id="3-3-6-3-ActivityManagerS-activityIdle"><a href="#3-3-6-3-ActivityManagerS-activityIdle" class="headerlink" title="3.3.6.3 ActivityManagerS.activityIdle"></a>3.3.6.3 ActivityManagerS.activityIdle</h4><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">final</span> <span class="keyword">void</span> <span class="title">activityIdle</span><span class="params">(IBinder token, Configuration config, <span class="keyword">boolean</span> stopProfiling)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">final</span> <span class="keyword">long</span> origId = Binder.clearCallingIdentity();</span><br><span class="line">    <span class="keyword">synchronized</span> (<span class="keyword">this</span>) &#123;</span><br><span class="line">        ActivityStack stack = ActivityRecord.getStackLocked(token);</span><br><span class="line">        <span class="keyword">if</span> (stack != <span class="keyword">null</span>) &#123;</span><br><span class="line">            <span class="comment">//【1】继续调用！</span></span><br><span class="line">            ActivityRecord r =</span><br><span class="line">                    mStackSupervisor.activityIdleInternalLocked(token, <span class="keyword">false</span>, config);</span><br><span class="line">            <span class="keyword">if</span> (stopProfiling) &#123;</span><br><span class="line">                <span class="keyword">if</span> ((mProfileProc == r.app) &amp;&amp; (mProfileFd != <span class="keyword">null</span>)) &#123;</span><br><span class="line">                    <span class="keyword">try</span> &#123;</span><br><span class="line">                        mProfileFd.close();</span><br><span class="line">                    &#125; <span class="keyword">catch</span> (IOException e) &#123;</span><br><span class="line">                    &#125;</span><br><span class="line">                    clearProfilerLocked();</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    Binder.restoreCallingIdentity(origId);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h4 id="3-3-6-4-ActivityManagerS-activityIdleInternalLocked"><a href="#3-3-6-4-ActivityManagerS-activityIdleInternalLocked" class="headerlink" title="3.3.6.4 ActivityManagerS.activityIdleInternalLocked"></a>3.3.6.4 ActivityManagerS.activityIdleInternalLocked</h4><p>这里我们只关注和 <code>AMS</code>启动有关的代码！</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">final</span> ActivityRecord <span class="title">activityIdleInternalLocked</span><span class="params">(<span class="keyword">final</span> IBinder token, <span class="keyword">boolean</span> fromTimeout,</span></span></span><br><span class="line"><span class="function"><span class="params">        Configuration config)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">if</span> (DEBUG_ALL) Slog.v(TAG, <span class="string">"Activity idle: "</span> + token);</span><br><span class="line"></span><br><span class="line">    ArrayList&lt;ActivityRecord&gt; finishes = <span class="keyword">null</span>;</span><br><span class="line">    ArrayList&lt;UserState&gt; startingUsers = <span class="keyword">null</span>;</span><br><span class="line">    <span class="keyword">int</span> NS = <span class="number">0</span>;</span><br><span class="line">    <span class="keyword">int</span> NF = <span class="number">0</span>;</span><br><span class="line">    <span class="keyword">boolean</span> booting = <span class="keyword">false</span>;</span><br><span class="line">    <span class="keyword">boolean</span> activityRemoved = <span class="keyword">false</span>;</span><br><span class="line"></span><br><span class="line">    ActivityRecord r = ActivityRecord.forTokenLocked(token);</span><br><span class="line">    <span class="keyword">if</span> (r != <span class="keyword">null</span>) &#123;</span><br><span class="line">        <span class="keyword">if</span> (DEBUG_IDLE) Slog.d(TAG_IDLE, <span class="string">"activityIdleInternalLocked: Callers="</span></span><br><span class="line">                + Debug.getCallers(<span class="number">4</span>));</span><br><span class="line">        mHandler.removeMessages(IDLE_TIMEOUT_MSG, r);</span><br><span class="line">        r.finishLaunchTickingLocked();</span><br><span class="line">        <span class="keyword">if</span> (fromTimeout) &#123;</span><br><span class="line">            reportActivityLaunchedLocked(fromTimeout, r, -<span class="number">1</span>, -<span class="number">1</span>);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (config != <span class="keyword">null</span>) &#123;</span><br><span class="line">            r.configuration = config;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        r.idle = <span class="keyword">true</span>;</span><br><span class="line">        </span><br><span class="line">        <span class="comment">// 显然，桌面 activity 所在的 stack 就是焦点栈！</span></span><br><span class="line">        <span class="keyword">if</span> (isFocusedStack(r.task.stack) || fromTimeout) &#123;</span><br><span class="line">            <span class="comment">//【1】继续调用！</span></span><br><span class="line">            booting = checkFinishBootingLocked();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    ... ... ... ...</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> r;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h4 id="3-3-6-5-ActivityStackS-checkFinishBootingLocked"><a href="#3-3-6-5-ActivityStackS-checkFinishBootingLocked" class="headerlink" title="3.3.6.5 ActivityStackS.checkFinishBootingLocked"></a>3.3.6.5 ActivityStackS.checkFinishBootingLocked</h4><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">boolean</span> <span class="title">checkFinishBootingLocked</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    <span class="comment">// 此时 mService.mBooting 为 true；</span></span><br><span class="line">    <span class="keyword">final</span> <span class="keyword">boolean</span> booting = mService.mBooting;</span><br><span class="line">    <span class="keyword">boolean</span> enableScreen = <span class="keyword">false</span>;</span><br><span class="line">    mService.mBooting = <span class="keyword">false</span>;</span><br><span class="line">    <span class="keyword">if</span> (!mService.mBooted) &#123;</span><br><span class="line">        mService.mBooted = <span class="keyword">true</span>;</span><br><span class="line">        enableScreen = <span class="keyword">true</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span> (booting || enableScreen) &#123;</span><br><span class="line">        <span class="comment">//【1】进入这里！</span></span><br><span class="line">        mService.postFinishBooting(booting, enableScreen);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> booting;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p><code>postFinishBooting</code> 会通过 <code>MainHandler</code> 发送 <code>FINISH_BOOTING_MSG</code> 消息给子线程，子线程会调用 <code>AMS.finishBooting</code> 的方法！</p>
<h4 id="3-3-6-6-ActivityManagerS-finishBooting"><a href="#3-3-6-6-ActivityManagerS-finishBooting" class="headerlink" title="3.3.6.6 ActivityManagerS.finishBooting"></a>3.3.6.6 ActivityManagerS.finishBooting</h4><p>该方法就是最关键的地方了，我们的开机广播就是在这个地方发送的！！！<br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">final</span> <span class="keyword">void</span> <span class="title">finishBooting</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    <span class="keyword">synchronized</span> (<span class="keyword">this</span>) &#123;</span><br><span class="line">        <span class="comment">//【1】如果开机动画没有显示完，则退出，等开机动画显示完后才会调用！</span></span><br><span class="line">        <span class="keyword">if</span> (!mBootAnimationComplete) &#123;</span><br><span class="line">            mCallFinishBooting = <span class="keyword">true</span>;</span><br><span class="line">            <span class="keyword">return</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        mCallFinishBooting = <span class="keyword">false</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 检查系统 ABI，ABI 和系统 cpu 指令集有关！</span></span><br><span class="line">    ArraySet&lt;String&gt; completedIsas = <span class="keyword">new</span> ArraySet&lt;String&gt;();</span><br><span class="line">    <span class="keyword">for</span> (String abi : Build.SUPPORTED_ABIS) &#123;</span><br><span class="line">        Process.establishZygoteConnectionForAbi(abi);</span><br><span class="line">        <span class="keyword">final</span> String instructionSet = VMRuntime.getInstructionSet(abi);</span><br><span class="line">        <span class="keyword">if</span> (!completedIsas.contains(instructionSet)) &#123;</span><br><span class="line">            <span class="keyword">try</span> &#123;</span><br><span class="line">                mInstaller.markBootComplete(VMRuntime.getInstructionSet(abi));</span><br><span class="line">            &#125; <span class="keyword">catch</span> (InstallerException e) &#123;</span><br><span class="line">                Slog.w(TAG, <span class="string">"Unable to mark boot complete for abi: "</span> + abi + <span class="string">" ("</span> +</span><br><span class="line">                        e.getMessage() +<span class="string">")"</span>);</span><br><span class="line">            &#125;</span><br><span class="line">            completedIsas.add(instructionSet);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// 注册接收者，监听重启 package 的广播，当系统发送了该广播后，该广播会传递所有需要重启的 package</span></span><br><span class="line">    <span class="comment">// 这里监听到该广播后，会重启所有的 package 的进程！</span></span><br><span class="line">    IntentFilter pkgFilter = <span class="keyword">new</span> IntentFilter();</span><br><span class="line">    pkgFilter.addAction(Intent.ACTION_QUERY_PACKAGE_RESTART);</span><br><span class="line">    pkgFilter.addDataScheme(<span class="string">"package"</span>);</span><br><span class="line">    mContext.registerReceiver(<span class="keyword">new</span> BroadcastReceiver() &#123;</span><br><span class="line">        <span class="meta">@Override</span></span><br><span class="line">        <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onReceive</span><span class="params">(Context context, Intent intent)</span> </span>&#123;</span><br><span class="line">            String[] pkgs = intent.getStringArrayExtra(Intent.EXTRA_PACKAGES);</span><br><span class="line">            <span class="keyword">if</span> (pkgs != <span class="keyword">null</span>) &#123;</span><br><span class="line">                <span class="keyword">for</span> (String pkg : pkgs) &#123;</span><br><span class="line">                    <span class="keyword">synchronized</span> (ActivityManagerService.<span class="keyword">this</span>) &#123;</span><br><span class="line">                        <span class="keyword">if</span> (forceStopPackageLocked(pkg, -<span class="number">1</span>, <span class="keyword">false</span>, <span class="keyword">false</span>, <span class="keyword">false</span>, <span class="keyword">false</span>, <span class="keyword">false</span>,</span><br><span class="line">                                <span class="number">0</span>, <span class="string">"query restart"</span>)) &#123;</span><br><span class="line">                            setResultCode(Activity.RESULT_OK);</span><br><span class="line">                            <span class="keyword">return</span>;</span><br><span class="line">                        &#125;</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;, pkgFilter);</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 注册接收者，监听 ACTION_DELETE_DUMPHEAP 广播！</span></span><br><span class="line">    IntentFilter dumpheapFilter = <span class="keyword">new</span> IntentFilter();</span><br><span class="line">    dumpheapFilter.addAction(DumpHeapActivity.ACTION_DELETE_DUMPHEAP);</span><br><span class="line">    mContext.registerReceiver(<span class="keyword">new</span> BroadcastReceiver() &#123;</span><br><span class="line"></span><br><span class="line">        <span class="meta">@Override</span></span><br><span class="line">        <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onReceive</span><span class="params">(Context context, Intent intent)</span> </span>&#123;</span><br><span class="line">            <span class="keyword">if</span> (intent.getBooleanExtra(DumpHeapActivity.EXTRA_DELAY_DELETE, <span class="keyword">false</span>)) &#123;</span><br><span class="line">                mHandler.sendEmptyMessageDelayed(POST_DUMP_HEAP_NOTIFICATION_MSG, <span class="number">5</span>*<span class="number">60</span>*<span class="number">1000</span>);</span><br><span class="line">            &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                mHandler.sendEmptyMessage(POST_DUMP_HEAP_NOTIFICATION_MSG);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;, dumpheapFilter);</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 通知系统服务已经进入最后阶段：PHASE_BOOT_COMPLETED</span></span><br><span class="line">    mSystemServiceManager.startBootPhase(SystemService.PHASE_BOOT_COMPLETED);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">synchronized</span> (<span class="keyword">this</span>) &#123;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 启动那些之前无法启动的进程，比如系统进程未准备好，且不是常驻进程等等！</span></span><br><span class="line">        <span class="keyword">final</span> <span class="keyword">int</span> NP = mProcessesOnHold.size();</span><br><span class="line">        <span class="keyword">if</span> (NP &gt; <span class="number">0</span>) &#123;</span><br><span class="line">            ArrayList&lt;ProcessRecord&gt; procs =</span><br><span class="line">                <span class="keyword">new</span> ArrayList&lt;ProcessRecord&gt;(mProcessesOnHold);</span><br><span class="line">            <span class="keyword">for</span> (<span class="keyword">int</span> ip=<span class="number">0</span>; ip&lt;NP; ip++) &#123;</span><br><span class="line">                <span class="keyword">if</span> (DEBUG_PROCESSES) Slog.v(TAG_PROCESSES, <span class="string">"Starting process on hold: "</span></span><br><span class="line">                        + procs.get(ip));</span><br><span class="line">                <span class="comment">// 启动之前无法启动而被系统暂时监管的应用进程！</span></span><br><span class="line">                startProcessLocked(procs.get(ip), <span class="string">"on-hold"</span>, <span class="keyword">null</span>);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (mFactoryTest != FactoryTest.FACTORY_TEST_LOW_LEVEL) &#123;</span><br><span class="line">            Message nmsg = mHandler.obtainMessage(CHECK_EXCESSIVE_WAKE_LOCKS_MSG);</span><br><span class="line">            mHandler.sendMessageDelayed(nmsg, POWER_CHECK_DELAY);</span><br><span class="line"></span><br><span class="line">            <span class="comment">// 设置系统属性！</span></span><br><span class="line">            SystemProperties.set(<span class="string">"sys.boot_completed"</span>, <span class="string">"1"</span>);</span><br><span class="line"></span><br><span class="line">            <span class="keyword">if</span> (!<span class="string">"trigger_restart_min_framework"</span>.equals(SystemProperties.get(<span class="string">"vold.decrypt"</span>))</span><br><span class="line">                || <span class="string">""</span>.equals(SystemProperties.get(<span class="string">"vold.encrypt_progress"</span>))) &#123;</span><br><span class="line">                SystemProperties.set(<span class="string">"dev.bootcomplete"</span>, <span class="string">"1"</span>);</span><br><span class="line">            &#125;</span><br><span class="line">            </span><br><span class="line">            <span class="comment">//【2】解锁设备用户，发送开机相关的广播！</span></span><br><span class="line">            mUserController.sendBootCompletedLocked(</span><br><span class="line">                    <span class="keyword">new</span> IIntentReceiver.Stub() &#123;</span><br><span class="line">                        <span class="meta">@Override</span></span><br><span class="line">                        <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">performReceive</span><span class="params">(Intent intent, <span class="keyword">int</span> resultCode,</span></span></span><br><span class="line"><span class="function"><span class="params">                                String data, Bundle extras, <span class="keyword">boolean</span> ordered,</span></span></span><br><span class="line"><span class="function"><span class="params">                                <span class="keyword">boolean</span> sticky, <span class="keyword">int</span> sendingUser)</span> </span>&#123;</span><br><span class="line">                            <span class="keyword">synchronized</span> (ActivityManagerService.<span class="keyword">this</span>) &#123;</span><br><span class="line">                                requestPssAllProcsLocked(SystemClock.uptimeMillis(),</span><br><span class="line">                                        <span class="keyword">true</span>, <span class="keyword">false</span>);</span><br><span class="line">                            &#125;</span><br><span class="line">                        &#125;</span><br><span class="line">                    &#125;);</span><br><span class="line"></span><br><span class="line">            scheduleStartProfilesLocked();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>总体来看，逻辑不复杂，最后的一步很关键：<br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">mUserController.sendBootCompletedLocked(...);</span><br></pre></td></tr></table></figure></p>
<p>该方法会发送一系列的开机广播，并且会解除所有启动完成的设备用户的锁定状态！</p>
<p>广播的发送顺序是：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">ACTION_LOCKED_BOOT_COMPLETED -&gt; ACTION_PRE_BOOT_COMPLETED -&gt; ACTION_BOOT_COMPLETED</span><br></pre></td></tr></table></figure>
<ul>
<li><strong>ACTION_LOCKED_BOOT_COMPLETED</strong></li>
</ul>
<p>因为此时设备用户仍然处于锁定状态，该方法会首先发送 <code>ACTION_LOCKED_BOOT_COMPLETED</code> 广播，<br>这个广播的触发时机是：设备用户已经完成了启动，当时仍然处于锁定状态！</p>
<p>发生了该广播后，系统进程就会开始接触设备用户的锁定！！</p>
<ul>
<li><strong>ACTION_PRE_BOOT_COMPLETED</strong></li>
</ul>
<p>当设备用户解除锁定后，就会发送这个广播，这个广播的发送时机是，系统升级后，设备的 <code>FINGERPRINT</code> 发生了变化！如果没有发生变化的话，会直接发送 <code>ACTION_BOOT_COMPLETED</code> 广播！</p>
<p>下面是核心代码：<br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">finishUserUnlocked</span><span class="params">(<span class="keyword">final</span> UserState uss)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">final</span> <span class="keyword">int</span> userId = uss.mHandle.getIdentifier();</span><br><span class="line">    <span class="keyword">synchronized</span> (mService) &#123;</span><br><span class="line">        ... ... ... ...</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (uss.setState(STATE_RUNNING_UNLOCKING, STATE_RUNNING_UNLOCKED)) &#123;</span><br><span class="line">            ... ... ... ... ...</span><br><span class="line">      </span><br><span class="line">            <span class="keyword">final</span> UserInfo info = getUserInfo(userId);</span><br><span class="line">             </span><br><span class="line">            <span class="keyword">if</span> (!Objects.equals(info.lastLoggedInFingerprint, Build.FINGERPRINT)) &#123;</span><br><span class="line">                <span class="keyword">final</span> <span class="keyword">boolean</span> quiet;</span><br><span class="line">                <span class="keyword">if</span> (info.isManagedProfile()) &#123;</span><br><span class="line">                    quiet = !uss.tokenProvided</span><br><span class="line">                            || !mLockPatternUtils.isSeparateProfileChallengeEnabled(userId);</span><br><span class="line">                &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                    quiet = <span class="keyword">false</span>;</span><br><span class="line">                &#125;</span><br><span class="line">                <span class="comment">// PreBootBroadcaster 的 sendNext 方法中会发送 ACTION_PRE_BOOT_COMPLETED！</span></span><br><span class="line">                <span class="keyword">new</span> PreBootBroadcaster(mService, userId, <span class="keyword">null</span>, quiet) &#123;</span><br><span class="line">                    <span class="meta">@Override</span></span><br><span class="line">                    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onFinished</span><span class="params">()</span> </span>&#123;</span><br><span class="line">                        <span class="comment">// 该方法会发送 ACTION_BOOT_COMPLETED 广播！</span></span><br><span class="line">                        finishUserUnlockedCompleted(uss);</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;.sendNext();</span><br><span class="line">            &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                <span class="comment">// 该方法会发送 ACTION_BOOT_COMPLETED 广播！</span></span><br><span class="line">                finishUserUnlockedCompleted(uss);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<ul>
<li><strong>ACTION_BOOT_COMPLETED</strong></li>
</ul>
<p><code>ACTION_PRE_BOOT_COMPLETED</code> 广播是最后发送的，也就是我们说的开机广播，发送的代码在 <code>finishUserUnlockedCompleted</code> 方法中！</p>
<h2 id="4-总结"><a href="#4-总结" class="headerlink" title="4 总结"></a>4 总结</h2><p>到这里，<code>AMS</code> 的启动过程就分析完了!</p>
</div></article><div class="post-copyright"><div class="post-copyright__author"><span class="post-copyright-meta">文章作者: </span><span class="post-copyright-info"><a href="mailto:undefined">Coolqi.Li</a></span></div><div class="post-copyright__type"><span class="post-copyright-meta">文章链接: </span><span class="post-copyright-info"><a href="https://coolqi.top/2016/02/19/ActivityManager1-ActivityManagerServiceStartProcess/">https://coolqi.top/2016/02/19/ActivityManager1-ActivityManagerServiceStartProcess/</a></span></div><div class="post-copyright__notice"><span class="post-copyright-meta">版权声明: </span><span class="post-copyright-info">本博客所有文章除特别声明外，均采用 <a href="https://creativecommons.org/licenses/by-nc-sa/4.0/">CC BY-NC-SA 4.0</a> 许可协议。转载请注明来自 <a href="https://coolqi.top">Coolqi`s Blog</a>！</span></div></div><div class="post-meta__tag-list"><a class="post-meta__tags" href="/tags/ActivityManager活动管理/">ActivityManager活动管理</a></div><div class="post-qr-code"><div class="post-qr-code-item"><img class="post-qr-code__img" src="/img/zfb.jpg"><div class="post-qr-code__desc">支付宝打赏</div></div><div class="post-qr-code-item"><img class="post-qr-code__img" src="/img/wechat.jpg"><div class="post-qr-code__desc">微信打赏</div></div></div><nav id="pagination"><div class="prev-post pull-left"><a href="/2016/03/01/Service2-startService/"><i class="fa fa-chevron-left">  </i><span>Service 篇 2 - startService 流程分析</span></a></div></nav><div class="post-adv"><a href="https://www.vultr.com/?ref=7231808"><img src="https://www.vultr.com/media/banner_1.png" width="728" height="90"></a></div><div id="gitalk-container"></div><script>var gitalk = new Gitalk({
  clientID: '2cd8921819db714376b8',
  clientSecret: '94b82090448833d5295bc0d210f9f0719b2f124d',
  repo: 'single-li.github.io',
  owner: 'single-li',
  admin: 'single-li',
  id: md5(location.pathname),
  language: 'zh-CN'
})
gitalk.render('gitalk-container')</script></div></div><footer><div class="layout" id="footer"><div class="copyright">&copy;2015 - 2019 By Coolqi.Li</div><div class="framework-info"><span>驱动 - </span><a href="http://hexo.io"><span>Hexo</span></a><span class="footer-separator">|</span><span>主题 - </span><a href="https://github.com/Molunerfinn/hexo-theme-melody"><span>Melody</span></a></div><div class="footer_custom_text">Hi, welcome to my <a href="https://coolqi.top/">blog</a>!</div><div class="busuanzi"><script async src="https://busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script><span id="busuanzi_container_page_pv"><i class="fa fa-file-o"></i><span id="busuanzi_value_page_pv"></span><span></span></span></div></div></footer><i class="fa fa-arrow-up" id="go-up" aria-hidden="true"></i><script src="/js/third-party/anime.min.js"></script><script src="/js/third-party/jquery.min.js"></script><script src="/js/third-party/jquery.fancybox.min.js"></script><script src="/js/third-party/velocity.min.js"></script><script src="/js/third-party/velocity.ui.min.js"></script><script src="/js/utils.js?version=1.5.6"></script><script src="/js/fancybox.js?version=1.5.6"></script><script src="/js/sidebar.js?version=1.5.6"></script><script src="/js/copy.js?version=1.5.6"></script><script src="/js/fireworks.js?version=1.5.6"></script><script src="/js/transition.js?version=1.5.6"></script><script src="/js/scroll.js?version=1.5.6"></script><script src="/js/head.js?version=1.5.6"></script><script type="text/x-mathjax-config">MathJax.Hub.Config({
  tex2jax: {
    inlineMath: [ ['$','$'], ["\\(","\\)"]  ],
    processEscapes: true,
    skipTags: ['script', 'noscript', 'style', 'textarea', 'pre', 'code']
  },
  CommonHTML: {
    linebreaks: { automatic: true, width: "90% container" }
  },
  "HTML-CSS": { 
    linebreaks: { automatic: true, width: "90% container" }
  },
  "SVG": { 
    linebreaks: { automatic: true, width: "90% container" }
  }
});
</script><script type="text/x-mathjax-config">MathJax.Hub.Queue(function() {
  var all = MathJax.Hub.getAllJax(), i;
  for (i=0; i < all.length; i += 1) {
    all[i].SourceElement().parentNode.className += ' has-jax';
  }
});
</script><script src="https://cdn.jsdelivr.net/npm/mathjax/MathJax.js?config=TeX-AMS-MML_HTMLorMML"></script><script src="/js/search/local-search.js"></script><div class="search-dialog" id="local-search"><div class="search-dialog__title" id="local-search-title">本地搜索</div><div id="local-input-panel"><div id="local-search-input"><div class="local-search-box"><input class="local-search-box--input" placeholder="搜索文章"></div></div></div><hr><div id="local-search-results"><div id="local-hits"></div><div id="local-stats"><div class="local-search-stats__hr" id="hr"><span>由</span> <a href="https://github.com/wzpan/hexo-generator-search" style="color:#49B1F5;">hexo-generator-search</a>
 <span>提供支持</span></div></div></div><span class="search-close-button"><i class="fa fa-times"></i></span></div><div class="search-mask"></div><script src="/live2dw/lib/L2Dwidget.min.js?0c58a1486de42ac6cc1c59c7d98ae887"></script><script>L2Dwidget.init({"pluginRootPath":"live2dw/","pluginJsPath":"lib/","pluginModelPath":"assets/","tagMode":false,"debug":false,"model":{"jsonPath":"live2d-widget-model-hijiki"},"display":{"position":"right","width":110,"height":220},"mobile":{"show":false},"log":false});</script></body></html>
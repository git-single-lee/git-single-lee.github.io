<!DOCTYPE html><html lang="zh-Hans"><head><meta charset="UTF-8"><meta http-equiv="X-UA-Compatible" content="IE=edge"><meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1"><meta name="description" content="ActivityManager第 1 篇 - AMS 的 Init 和 Start"><meta name="keywords" content="ActivityManager活动管理"><meta name="author" content="Coolqi Li,undefined"><meta name="copyright" content="Coolqi Li"><title>ActivityManager第 1 篇 - AMS 的 Init 和 Start | Coolqi`s Blog</title><link rel="shortcut icon" href="/img/my-favicon.ico"><link rel="stylesheet" href="/css/index.css?version=1.5.6"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/font-awesome@4.7.0/css/font-awesome.min.css?version=1.5.6"><link rel="dns-prefetch" href="https://cdn.staticfile.org"><link rel="dns-prefetch" href="https://cdn.bootcss.com"><link rel="dns-prefetch" href="https://creativecommons.org"><script>var GLOBAL_CONFIG = { 
  root: '/',
  algolia: undefined,
  localSearch: {"path":"search.xml","languages":{"hits_empty":"找不到您查询的内容:${query}"}},
  copy: {
    success: '复制成功',
    error: '复制错误',
    noSupport: '浏览器不支持'
  }
} </script></head><body><canvas class="fireworks"></canvas><i class="fa fa-arrow-right" id="toggle-sidebar" aria-hidden="true"></i><div id="sidebar"><div class="toggle-sidebar-info text-center"><span data-toggle="切换文章详情">切换站点概览</span><hr></div><div class="sidebar-toc"><div class="sidebar-toc__title">目录</div><div class="sidebar-toc__progress"><span class="progress-notice">你已经读了</span><span class="progress-num">0</span><span class="progress-percentage">%</span><div class="sidebar-toc__progress-bar"></div></div><div class="sidebar-toc__content"><ol class="toc"><li class="toc-item toc-level-1"><a class="toc-link" href="#2-第一阶段"><span class="toc-text">2 第一阶段</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#2-1-ActivityManagerService"><span class="toc-text">2.1 ActivityManagerService</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#2-2-onStart"><span class="toc-text">2.2 onStart</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#2-3-initPowerManagement"><span class="toc-text">2.3 initPowerManagement</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#2-4-setSystemProcess"><span class="toc-text">2.4 setSystemProcess</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#2-4-1-ServiceManager-addService"><span class="toc-text">2.4.1 ServiceManager.addService</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#2-4-2-framework-res-apk"><span class="toc-text">2.4.2 framework-res.apk</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#2-4-2-1-ActivityThread-installSystemApplicaitonInfo"><span class="toc-text">2.4.2.1 ActivityThread.installSystemApplicaitonInfo</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#2-4-2-2-ContextImpl-installSystemApplicaitonInfo"><span class="toc-text">2.4.2.2 ContextImpl.installSystemApplicaitonInfo</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#2-4-2-3-LoadedAPK-installSystemApplicaitonInfo"><span class="toc-text">2.4.2.3 LoadedAPK.installSystemApplicaitonInfo</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#2-4-3-newProcessRecordLocked"><span class="toc-text">2.4.3 newProcessRecordLocked</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#2-4-3-1-addProcessNameLocked"><span class="toc-text">2.4.3.1 addProcessNameLocked</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#2-4-4-ProcessRecord-makeActive"><span class="toc-text">2.4.4 ProcessRecord.makeActive</span></a></li></ol></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#3-第二阶段"><span class="toc-text">3 第二阶段</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#3-1-setUsageStatsManager"><span class="toc-text">3.1 setUsageStatsManager</span></a></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#4-第三阶段"><span class="toc-text">4 第三阶段</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#4-1-AMS-installSystemProviders"><span class="toc-text">4.1 AMS.installSystemProviders</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#4-1-1-AMS-generateApplicationProvidersLocked"><span class="toc-text">4.1.1 AMS.generateApplicationProvidersLocked</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#4-1-2-ActivityThread-installSystemProviders"><span class="toc-text">4.1.2 ActivityThread.installSystemProviders</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#4-1-2-1-ActivityThread-installProvider"><span class="toc-text">4.1.2.1 ActivityThread.installProvider</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#4-1-2-2-AMN-publishContentProviders"><span class="toc-text">4.1.2.2 AMN.publishContentProviders</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#4-1-3-阶段总结"><span class="toc-text">4.1.3 阶段总结</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#4-2-AMS-systemReady"><span class="toc-text">4.2 AMS.systemReady</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#4-2-1-通知其他服务SystemReady"><span class="toc-text">4.2.1 通知其他服务SystemReady</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#4-2-1-1-UserController-onSystemReady"><span class="toc-text">4.2.1.1 UserController.onSystemReady</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#4-2-1-2-RecentTasks-onSystemReady"><span class="toc-text">4.2.1.2 RecentTasks.onSystemReady</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#4-2-1-3-AppOpsService-onSystemReady"><span class="toc-text">4.2.1.3 AppOpsService.onSystemReady</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#4-2-2-杀掉特定进程"><span class="toc-text">4.2.2 杀掉特定进程</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#4-2-2-1-isAllowedWhileBooting"><span class="toc-text">4.2.2.1 isAllowedWhileBooting</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#4-2-3-读取设置信息-retrieveSettings"><span class="toc-text">4.2.3 读取设置信息-retrieveSettings</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#4-3-总结"><span class="toc-text">4.3 总结</span></a></li></ol></li></ol></div></div><div class="author-info hide"><div class="author-info__avatar text-center"><img src="/img/avatar.png"></div><div class="author-info__name text-center">Coolqi Li</div><div class="author-info__description text-center">“你好，我是李帅奇，Android 系统工程师，MineCraft 忠实玩家，设计和绘画爱好者，缺妹纸晚期患者，熬夜星人。”</div><div class="follow-button"><a href="https://github.com/USERNAME">Follow Me</a></div><hr><div class="author-info-articles"><a class="author-info-articles__archives article-meta" href="/archives"><span class="pull-left">文章</span><span class="pull-right">47</span></a><a class="author-info-articles__tags article-meta" href="/tags"><span class="pull-left">标签</span><span class="pull-right">12</span></a><a class="author-info-articles__categories article-meta" href="/categories"><span class="pull-left">分类</span><span class="pull-right">13</span></a></div><hr><div class="author-info-links"><div class="author-info-links__title text-center">Links</div><a class="author-info-links__name text-center" href="https://molunerfinn.com">Molunerfinn</a><a class="author-info-links__name text-center" href="https://piegg.cn">PiEgg</a><a class="author-info-links__name text-center" href="https://piegg.cn">Elody</a></div></div></div><div id="content-outer"><div class="no-bg" id="top-container"><div id="page-header"><span class="pull-left"> <a id="site-name" href="/">Coolqi`s Blog</a></span><i class="fa fa-bars toggle-menu pull-right" aria-hidden="true"></i><span class="pull-right menus"><a class="site-page social-icon search"><i class="fa fa-search"></i><span> 搜索</span></a><a class="site-page" href="/">Home</a><a class="site-page" href="/archives">Archives</a><a class="site-page" href="/tags">Tags</a><a class="site-page" href="/categories">Categories</a><a class="site-page" href="/about">About</a></span></div><div id="post-info"><div id="post-title">ActivityManager第 1 篇 - AMS 的 Init 和 Start</div><div id="post-meta"><time class="post-meta__date"><i class="fa fa-calendar" aria-hidden="true"></i> 2016-02-19</time><span class="post-meta__separator">|</span><i class="fa fa-inbox post-meta__icon" aria-hidden="true"></i><a class="post-meta__categories" href="/categories/ActivityManager活动管理/">ActivityManager活动管理</a><div class="post-meta-wordcount"><span>字数总计: </span><span class="word-count">7.4k</span><span class="post-meta__separator">|</span><span>阅读时长: 33 分钟</span></div></div></div></div><div class="layout" id="content-inner"><article id="post"><div class="article-container" id="post-content"><p>基于 Android 7.1.1 源码分析 AMS 的机制，本文为作者原创，转载请说明出处，谢谢！ </p>
<h1 id="2-第一阶段"><a href="#2-第一阶段" class="headerlink" title="2 第一阶段"></a>2 第一阶段</h1><h2 id="2-1-ActivityManagerService"><a href="#2-1-ActivityManagerService" class="headerlink" title="2.1 ActivityManagerService"></a>2.1 ActivityManagerService</h2><p>接下来，我们仔细的看看 AMS 的构造器！<br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="title">ActivityManagerService</span><span class="params">(Context systemContext)</span> </span>&#123;</span><br><span class="line">    mContext = systemContext;</span><br><span class="line">    mFactoryTest = FactoryTest.getMode(); <span class="comment">// 是否是工厂模式！</span></span><br><span class="line">    </span><br><span class="line">    <span class="comment">// 获得 SystemServer 进程的 ActivityThread 对象，每个进程都有一个！</span></span><br><span class="line">    mSystemThread = ActivityThread.currentActivityThread();</span><br><span class="line"></span><br><span class="line">    Slog.i(TAG, <span class="string">"Memory class: "</span> + ActivityManager.staticGetMemoryClass());</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 创建处理消息的 HandlerThread 和 Handler 对象！</span></span><br><span class="line">    mHandlerThread = <span class="keyword">new</span> ServiceThread(TAG,</span><br><span class="line">            android.os.Process.THREAD_PRIORITY_FOREGROUND, <span class="keyword">false</span> <span class="comment">/*allowIo*/</span>);</span><br><span class="line">    mHandlerThread.start();</span><br><span class="line">    mHandler = <span class="keyword">new</span> MainHandler(mHandlerThread.getLooper());</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 创建处理 ANR 相关的 Handler！</span></span><br><span class="line">    mUiHandler = <span class="keyword">new</span> UiHandler();</span><br><span class="line"></span><br><span class="line">    <span class="comment">/* static; one-time init here */</span></span><br><span class="line">    <span class="keyword">if</span> (sKillHandler == <span class="keyword">null</span>) &#123;</span><br><span class="line">        sKillThread = <span class="keyword">new</span> ServiceThread(TAG + <span class="string">":kill"</span>,</span><br><span class="line">                android.os.Process.THREAD_PRIORITY_BACKGROUND, <span class="keyword">true</span> <span class="comment">/* allowIo */</span>);</span><br><span class="line">        sKillThread.start();</span><br><span class="line">        sKillHandler = <span class="keyword">new</span> KillHandler(sKillThread.getLooper());</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 集合管理前台广播和后台广播的集合，有前 / 后台之分，为了区分不同的广播消息超时时间。</span></span><br><span class="line">    mFgBroadcastQueue = <span class="keyword">new</span> BroadcastQueue(<span class="keyword">this</span>, mHandler,</span><br><span class="line">            <span class="string">"foreground"</span>, BROADCAST_FG_TIMEOUT, <span class="keyword">false</span>);</span><br><span class="line">    mBgBroadcastQueue = <span class="keyword">new</span> BroadcastQueue(<span class="keyword">this</span>, mHandler,</span><br><span class="line">            <span class="string">"background"</span>, BROADCAST_BG_TIMEOUT, <span class="keyword">true</span>);</span><br><span class="line">    mBroadcastQueues[<span class="number">0</span>] = mFgBroadcastQueue;</span><br><span class="line">    mBroadcastQueues[<span class="number">1</span>] = mBgBroadcastQueue;</span><br><span class="line">  </span><br><span class="line">    mServices = <span class="keyword">new</span> ActiveServices(<span class="keyword">this</span>); <span class="comment">// 创建管理 Service 组件的 ActiveServices 对象！</span></span><br><span class="line">    mProviderMap = <span class="keyword">new</span> ProviderMap(<span class="keyword">this</span>); <span class="comment">// 创建管理 Provider 组件的 ProviderMap 对象！</span></span><br><span class="line"></span><br><span class="line">    mAppErrors = <span class="keyword">new</span> AppErrors(mContext, <span class="keyword">this</span>); <span class="comment">// 创建管理 ANR 和 crash 的 AppError 对象！</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">// 创建 /data/system 目录，诸如包管理packages.xml, packages.list等文件都存放于此目录</span></span><br><span class="line">    File dataDir = Environment.getDataDirectory();</span><br><span class="line">    File systemDir = <span class="keyword">new</span> File(dataDir, <span class="string">"system"</span>);</span><br><span class="line">    systemDir.mkdirs();</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// 创建电量统计服务 BatteryStatsService 对象，并将 mHandler 传入，用于通信！</span></span><br><span class="line">    mBatteryStatsService = <span class="keyword">new</span> BatteryStatsService(systemDir, mHandler);</span><br><span class="line">    mBatteryStatsService.getActiveStatistics().readLocked();</span><br><span class="line">    mBatteryStatsService.scheduleWriteToDisk();</span><br><span class="line">    mOnBattery = DEBUG_POWER ? <span class="keyword">true</span></span><br><span class="line">            : mBatteryStatsService.getActiveStatistics().getIsOnBattery();</span><br><span class="line">    mBatteryStatsService.getActiveStatistics().setCallback(<span class="keyword">this</span>);</span><br><span class="line">   </span><br><span class="line">    <span class="comment">// 创建进程状态监控服务 ProcessStatsService 对象，/data/system/procstats 文件会存储</span></span><br><span class="line">    <span class="comment">// 进程的状态信息！</span></span><br><span class="line">    mProcessStats = <span class="keyword">new</span> ProcessStatsService(<span class="keyword">this</span>, <span class="keyword">new</span> File(systemDir, <span class="string">"procstats"</span>));</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// 创建应用操作监控服务 AppOpsService 对象，/data/system/appops.xml文件存储app的</span></span><br><span class="line">    <span class="comment">// 权限设置和操作信息！</span></span><br><span class="line">    mAppOpsService = <span class="keyword">new</span> AppOpsService(<span class="keyword">new</span> File(systemDir, <span class="string">"appops.xml"</span>), mHandler);</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 监听是否允许应用在后台运行的操作</span></span><br><span class="line">    mAppOpsService.startWatchingMode(AppOpsManager.OP_RUN_IN_BACKGROUND, <span class="keyword">null</span>,</span><br><span class="line">            <span class="keyword">new</span> IAppOpsCallback.Stub() &#123;</span><br><span class="line">                <span class="meta">@Override</span> <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">opChanged</span><span class="params">(<span class="keyword">int</span> op, <span class="keyword">int</span> uid, String packageName)</span> </span>&#123;</span><br><span class="line">                    <span class="keyword">if</span> (op == AppOpsManager.OP_RUN_IN_BACKGROUND &amp;&amp; packageName != <span class="keyword">null</span>) &#123;</span><br><span class="line">                        <span class="keyword">if</span> (mAppOpsService.checkOperation(op, uid, packageName)</span><br><span class="line">                                != AppOpsManager.MODE_ALLOWED) &#123;</span><br><span class="line">                            runInBackgroundDisabled(uid);</span><br><span class="line">                        &#125;</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;);</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// 创建 urigrants.xml 文件对象！</span></span><br><span class="line">    mGrantFile = <span class="keyword">new</span> AtomicFile(<span class="keyword">new</span> File(systemDir, <span class="string">"urigrants.xml"</span>));</span><br><span class="line">    <span class="comment">// 创建 UserController 对象！</span></span><br><span class="line">    mUserController = <span class="keyword">new</span> UserController(<span class="keyword">this</span>);</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 获取 OpenGL 版本号</span></span><br><span class="line">    GL_ES_VERSION = SystemProperties.getInt(<span class="string">"ro.opengles.version"</span>,</span><br><span class="line">        ConfigurationInfo.GL_ES_VERSION_UNDEFINED);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (SystemProperties.getInt(<span class="string">"sys.use_fifo_ui"</span>, <span class="number">0</span>) != <span class="number">0</span>) &#123;</span><br><span class="line">        mUseFifoUiScheduling = <span class="keyword">true</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    mTrackingAssociations = <span class="string">"1"</span>.equals(SystemProperties.get(<span class="string">"debug.track-associations"</span>));</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 配置区域、语言、字体、屏幕方向等，启动 Activity 时，需要用到这个配置！</span></span><br><span class="line">    mConfiguration.setToDefaults();</span><br><span class="line">    mConfiguration.setLocales(LocaleList.getDefault());</span><br><span class="line">    mConfigurationSeq = mConfiguration.seq = <span class="number">1</span>;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// 初始化 processCpuTracker 对象，用来收集 ANR 情况下的 cpu 使用情况，电池状态等等！</span></span><br><span class="line">    mProcessCpuTracker.init();</span><br><span class="line"></span><br><span class="line">    <span class="comment">// AndroidManifest.xml 中 compatible-screens 相关的解析工具</span></span><br><span class="line">    mCompatModePackages = <span class="keyword">new</span> CompatModePackages(<span class="keyword">this</span>, systemDir, mHandler);</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// 创建 instent 防火墙！</span></span><br><span class="line">    mIntentFirewall = <span class="keyword">new</span> IntentFirewall(<span class="keyword">new</span> IntentFirewallInterface(), mHandler);</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// 创建管理组件 Activity 的 ActivityStackSupervisor 和 ActivityStarter 对象！</span></span><br><span class="line">    mStackSupervisor = <span class="keyword">new</span> ActivityStackSupervisor(<span class="keyword">this</span>);</span><br><span class="line">    mActivityStarter = <span class="keyword">new</span> ActivityStarter(<span class="keyword">this</span>, mStackSupervisor);</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 创建最近任务对象！</span></span><br><span class="line">    mRecentTasks = <span class="keyword">new</span> RecentTasks(<span class="keyword">this</span>, mStackSupervisor);</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// 创建一个子线程，不断循环，更新 cpu 的状态信息！</span></span><br><span class="line">    mProcessCpuThread = <span class="keyword">new</span> Thread(<span class="string">"CpuTracker"</span>) &#123;</span><br><span class="line">        <span class="meta">@Override</span></span><br><span class="line">        <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">run</span><span class="params">()</span> </span>&#123;</span><br><span class="line">            <span class="keyword">while</span> (<span class="keyword">true</span>) &#123;</span><br><span class="line">                <span class="keyword">try</span> &#123;</span><br><span class="line">                    <span class="keyword">try</span> &#123;</span><br><span class="line">                        <span class="keyword">synchronized</span>(<span class="keyword">this</span>) &#123;</span><br><span class="line">                            <span class="keyword">final</span> <span class="keyword">long</span> now = SystemClock.uptimeMillis();</span><br><span class="line">                            <span class="keyword">long</span> nextCpuDelay = (mLastCpuTime.get()+MONITOR_CPU_MAX_TIME)-now;</span><br><span class="line">                            <span class="keyword">long</span> nextWriteDelay = (mLastWriteTime+BATTERY_STATS_TIME)-now;</span><br><span class="line">                            <span class="comment">//Slog.i(TAG, "Cpu delay=" + nextCpuDelay</span></span><br><span class="line">                            <span class="comment">//        + ", write delay=" + nextWriteDelay);</span></span><br><span class="line">                            <span class="keyword">if</span> (nextWriteDelay &lt; nextCpuDelay) &#123;</span><br><span class="line">                                nextCpuDelay = nextWriteDelay;</span><br><span class="line">                            &#125;</span><br><span class="line">                            <span class="keyword">if</span> (nextCpuDelay &gt; <span class="number">0</span>) &#123;</span><br><span class="line">                                mProcessCpuMutexFree.set(<span class="keyword">true</span>);</span><br><span class="line">                                <span class="keyword">this</span>.wait(nextCpuDelay);</span><br><span class="line">                            &#125;</span><br><span class="line">                        &#125;</span><br><span class="line">                    &#125; <span class="keyword">catch</span> (InterruptedException e) &#123;</span><br><span class="line">                    &#125;</span><br><span class="line">                    <span class="comment">// 更新 cpu 的状态以及电池状态信息！</span></span><br><span class="line">                    updateCpuStatsNow();</span><br><span class="line">                &#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">                    Slog.e(TAG, <span class="string">"Unexpected exception collecting process stats"</span>, e);</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 将自身加入到 Watchdog 的监控中！</span></span><br><span class="line">    Watchdog.getInstance().addMonitor(<span class="keyword">this</span>);</span><br><span class="line">    Watchdog.getInstance().addThread(mHandler);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>我们总结一下，在 AMS 的构造器中，主要做了一下几个事情：</p>
<ul>
<li><p>创建了系统目录：/data/system</p>
</li>
<li><p>创建了几个系统服务对象：</p>
<ul>
<li>BatteryStatsService：用于监控电池状态；</li>
<li>ProcessStatsService：用于监控进程状态；</li>
<li>AppOpsService：</li>
<li>UserController：</li>
</ul>
</li>
<li><p>创建了四大组件的管理对象；</p>
<ul>
<li>Broadcast：mFgBroadcastQueue 和 mBgBroadcastQueue，分别管理前台后台广播；</li>
<li>Service：ActiveServices；</li>
<li>Provider：ProviderMap；</li>
<li>Activity：mStackSupervisor，mActivityStarter；</li>
</ul>
</li>
<li><p>创建了处理 ANR 和 Crash 的对象：mAppErrors；</p>
</li>
<li>创建最近任务对象：RecentTasks；</li>
</ul>
<p>初次之外，还有：</p>
<ul>
<li>初始化 processCpuTracker 对象！</li>
<li>创建了几个 Handler，用于消息处理：<ul>
<li>MainHandler：位于子线程中，AMS 会把它传递个给其他服务，用于交互；</li>
<li>UiHandler：位于主线程中，用于处理 ANR 和 Crash 相关的信息！</li>
</ul>
</li>
<li>创建一个线程 mProcessCpuThread，不断的更新 cpu 和电池的状态信息 </li>
</ul>
<p>以上是 AMS 的构造器做的事情！！</p>
<h2 id="2-2-onStart"><a href="#2-2-onStart" class="headerlink" title="2.2 onStart"></a>2.2 onStart</h2><p>调用构造器，创建完 AMS 的对象之后，要做的就是启动 AMS 哦，在上一篇中，我们有看到，启动先调用 LifeCircle 的 onStart ，然后会调用了 AMS 的 start 方法：<br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">start</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    <span class="comment">// 移除所有的进程组！</span></span><br><span class="line">    Process.removeAllProcessGroups();</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 启动 ProcessCpuThread，监控 cpu 和电池的状态！</span></span><br><span class="line">    mProcessCpuThread.start();</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// 将 BatteryStatsService 服务和 AppOpsService 注册到 ServiceManager 中，用于进程间通讯！</span></span><br><span class="line">    mBatteryStatsService.publish(mContext);</span><br><span class="line">    mAppOpsService.publish(mContext);</span><br><span class="line">    Slog.d(<span class="string">"AppOps"</span>, <span class="string">"AppOpsService published"</span>);</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// 将 AMS 添加进入 LocalServices 集合中，用于同一进程内的通信！</span></span><br><span class="line">    LocalServices.addService(ActivityManagerInternal.class, <span class="keyword">new</span> LocalService());</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>这个方法很简单，就不多说了：</p>
<ul>
<li>移除所有的进程组；并启动 ProcessCpuThread，监控 cpu 和电池的状态！</li>
<li>将 BatteryStatsService 服务和 AppOpsService 注册到 ServiceManager 中，用于 Binder 通讯！  </li>
</ul>
<h2 id="2-3-initPowerManagement"><a href="#2-3-initPowerManagement" class="headerlink" title="2.3 initPowerManagement"></a>2.3 initPowerManagement</h2><p>接下来，初始化 电池管理：<br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">initPowerManagement</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    <span class="comment">// 初始化电池管理！</span></span><br><span class="line">    mStackSupervisor.initPowerManagement();</span><br><span class="line">    mBatteryStatsService.initPowerManagement();</span><br><span class="line"></span><br><span class="line">    mLocalPowerManager = LocalServices.getService(PowerManagerInternal.class);</span><br><span class="line">    </span><br><span class="line">    PowerManager pm = (PowerManager)mContext.getSystemService(Context.POWER_SERVICE);</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// 获得 WakeLock！</span></span><br><span class="line">    mVoiceWakeLock = pm.newWakeLock(PowerManager.PARTIAL_WAKE_LOCK, <span class="string">"*voice*"</span>);</span><br><span class="line">    mVoiceWakeLock.setReferenceCounted(<span class="keyword">false</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>这里主要是进一步的初始化电池管理！</p>
<h2 id="2-4-setSystemProcess"><a href="#2-4-setSystemProcess" class="headerlink" title="2.4 setSystemProcess"></a>2.4 setSystemProcess</h2><p>接下来，是设置 SytemServer 系统进程的相关信息，我们来看看代码，这里要仔细的来看了！<br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">setSystemProcess</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 注册一些系统相关的服务</span></span><br><span class="line">        ServiceManager.addService(Context.ACTIVITY_SERVICE, <span class="keyword">this</span>, <span class="keyword">true</span>);</span><br><span class="line">        ServiceManager.addService(ProcessStats.SERVICE_NAME, mProcessStats);</span><br><span class="line">        ServiceManager.addService(<span class="string">"meminfo"</span>, <span class="keyword">new</span> MemBinder(<span class="keyword">this</span>));</span><br><span class="line">        ServiceManager.addService(<span class="string">"gfxinfo"</span>, <span class="keyword">new</span> GraphicsBinder(<span class="keyword">this</span>));</span><br><span class="line">        ServiceManager.addService(<span class="string">"dbinfo"</span>, <span class="keyword">new</span> DbBinder(<span class="keyword">this</span>));</span><br><span class="line">        <span class="keyword">if</span> (MONITOR_CPU_USAGE) &#123;</span><br><span class="line">            ServiceManager.addService(<span class="string">"cpuinfo"</span>, <span class="keyword">new</span> CpuBinder(<span class="keyword">this</span>));</span><br><span class="line">        &#125;</span><br><span class="line">        ServiceManager.addService(<span class="string">"permission"</span>, <span class="keyword">new</span> PermissionController(<span class="keyword">this</span>));</span><br><span class="line">        ServiceManager.addService(<span class="string">"processinfo"</span>, <span class="keyword">new</span> ProcessInfoService(<span class="keyword">this</span>));</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 从 PackageManagerService 中获取 framework-res.apk (包名 为 android) </span></span><br><span class="line">        <span class="comment">// 的 ApplicationInfo 信息!</span></span><br><span class="line">        ApplicationInfo info = mContext.getPackageManager().getApplicationInfo(<span class="string">"android"</span>, STOCK_PM_FLAGS | MATCH_SYSTEM_ONLY);</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 保存 framework-res.apk 的信息到系统进程的主线程中！</span></span><br><span class="line">        mSystemThread.installSystemApplicationInfo(info, getClass().getClassLoader());</span><br><span class="line">        </span><br><span class="line">        <span class="keyword">synchronized</span> (<span class="keyword">this</span>) &#123;</span><br><span class="line"></span><br><span class="line">            <span class="comment">// 初始化系统进程的 ProcessRecord</span></span><br><span class="line">            ProcessRecord app = newProcessRecordLocked(info, info.processName, <span class="keyword">false</span>, <span class="number">0</span>);</span><br><span class="line">            app.persistent = <span class="keyword">true</span>; <span class="comment">// 设置为常驻进程</span></span><br><span class="line">            app.pid = MY_PID; <span class="comment">// 设置 pid</span></span><br><span class="line">            app.maxAdj = ProcessList.SYSTEM_ADJ;</span><br><span class="line">            </span><br><span class="line">            <span class="comment">// 使系统进程处于活跃状态</span></span><br><span class="line">            app.makeActive(mSystemThread.getApplicationThread(), mProcessStats);</span><br><span class="line">            <span class="keyword">synchronized</span> (mPidsSelfLocked) &#123;</span><br><span class="line">                <span class="comment">// 将 systemServer 进程对象加入到 mPidsSelfLocked 中，以便管理！</span></span><br><span class="line">                mPidsSelfLocked.put(app.pid, app);</span><br><span class="line">            &#125;</span><br><span class="line">            </span><br><span class="line">            <span class="comment">// 更新最近使用进程列表</span></span><br><span class="line">            updateLruProcessLocked(app, <span class="keyword">false</span>, <span class="keyword">null</span>);</span><br><span class="line">            <span class="comment">// 用于更新进程的oom_adj值</span></span><br><span class="line">            updateOomAdjLocked();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125; <span class="keyword">catch</span> (PackageManager.NameNotFoundException e) &#123;</span><br><span class="line">        <span class="keyword">throw</span> <span class="keyword">new</span> RuntimeException(<span class="string">"Unable to find android system package"</span>, e);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>注意：PackageManagerService 和 ActivityManagerService 运行在同一个进程，这里为什么仍然要使用跨进程的方式来进行通信呢？这样可以保证架构的统一性！<br>上面代码中用到了 mPidsSelfLocked 变量，我们看下这个变量的定义：<br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">final</span> SparseArray&lt;ProcessRecord&gt; mPidsSelfLocked = <span class="keyword">new</span> SparseArray&lt;ProcessRecord&gt;();</span><br></pre></td></tr></table></figure></p>
<p>mPidsSelfLocked 保存有 pid 组织起来的正在运行的进程，保存的是 pid，及 pid 对应的 ProcessRecord。</p>
<p>这里我们来总结一下，这方法主要做了什么：</p>
<ul>
<li>注册一些系统相关的服务，我们可以通过 adb shell dumpsys 命令查看！</li>
<li>获取 framework-res.apk 安装包信息，保存到系统进程的 ActivityThread 对象中！</li>
<li>创建 SystemServer 系统进程的进程结构体，初始化属性，将其加入  mPidsSelfLocked ，用于管理！</li>
<li>更新进程的优先级和 oomAdj，这两个方法，我们后面单开一贴！！！</li>
</ul>
<p>下面我们仔细的看看一些细节，有利于我们对 AMS 的结构有一个更深层次的理解！</p>
<h3 id="2-4-1-ServiceManager-addService"><a href="#2-4-1-ServiceManager-addService" class="headerlink" title="2.4.1 ServiceManager.addService"></a>2.4.1 ServiceManager.addService</h3><p>第一步，注册一些重要的服务，包括 ActivityManagerService 自身！<br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 注册一些系统相关的服务</span></span><br><span class="line">ServiceManager.addService(Context.ACTIVITY_SERVICE, <span class="keyword">this</span>, <span class="keyword">true</span>);</span><br><span class="line">ServiceManager.addService(ProcessStats.SERVICE_NAME, mProcessStats);</span><br><span class="line">ServiceManager.addService(<span class="string">"meminfo"</span>, <span class="keyword">new</span> MemBinder(<span class="keyword">this</span>));</span><br><span class="line">ServiceManager.addService(<span class="string">"gfxinfo"</span>, <span class="keyword">new</span> GraphicsBinder(<span class="keyword">this</span>));</span><br><span class="line">ServiceManager.addService(<span class="string">"dbinfo"</span>, <span class="keyword">new</span> DbBinder(<span class="keyword">this</span>));</span><br><span class="line"><span class="keyword">if</span> (MONITOR_CPU_USAGE) &#123;</span><br><span class="line">    ServiceManager.addService(<span class="string">"cpuinfo"</span>, <span class="keyword">new</span> CpuBinder(<span class="keyword">this</span>));</span><br><span class="line">&#125;</span><br><span class="line">ServiceManager.addService(<span class="string">"permission"</span>, <span class="keyword">new</span> PermissionController(<span class="keyword">this</span>));</span><br><span class="line">ServiceManager.addService(<span class="string">"processinfo"</span>, <span class="keyword">new</span> ProcessInfoService(<span class="keyword">this</span>));</span><br></pre></td></tr></table></figure></p>
<p>这里注册了哪些服务呢？这里用到了几个静态变量：</p>
<blockquote>
<p>Context.ACTIVITY_SERVICE = “activity”;<br>ProcessStats.SERVICE_NAME = “procstats”;</p>
</blockquote>
<p>这里注册了那些服务呢，我们来看看：</p>
<table>
<thead>
<tr>
<th>服务名</th>
<th>类名</th>
<th>功能</th>
</tr>
</thead>
<tbody>
<tr>
<td>procstats</td>
<td>ProcessStatsService</td>
<td>监控进程信息的服务</td>
</tr>
<tr>
<td>cpuinfo</td>
<td>CpuBinder</td>
<td>监控CPU信息的服务</td>
</tr>
<tr>
<td>meminfo</td>
<td>MemBinder</td>
<td>dump系统中每个进程的内存使用状况的服务</td>
</tr>
<tr>
<td>gfxinfo</td>
<td>GraphicsBinder</td>
<td>dump系统中每个进程使用图形加速卡状态的服务</td>
</tr>
<tr>
<td>dbinfo</td>
<td>DbBinder</td>
<td>dump系统中每个进程的db状况的服务</td>
</tr>
<tr>
<td>permission</td>
<td>PermissionController</td>
<td>是检查Binder调用权限的服务</td>
</tr>
<tr>
<td>processinfo</td>
<td>ProcessInfoService</td>
<td>进程信息</td>
</tr>
</tbody>
</table>
<p>这些服务我们先不细看，后面遇到了，再具体分析！</p>
<h3 id="2-4-2-framework-res-apk"><a href="#2-4-2-framework-res-apk" class="headerlink" title="2.4.2 framework-res.apk"></a>2.4.2 framework-res.apk</h3><p>接着，处理 framework-res.apk 安装包，在 PMS 的启动过程中，PackageManagerService 会扫描 framework-res.apk 的信息，并将信息封装成 ApplicaitonInfo 并保存在一个集合中：<br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">mSystemThread.installSystemApplicationInfo(info, getClass().getClassLoader());</span><br></pre></td></tr></table></figure></p>
<p>mSystemThread 对象是 ActvityThread 实例，每一个进程都有一个 ActivityThread  对象，内部保存着进程的主线程对象，这里其保存着 SystemServer 进程的主线程对象！</p>
<p>我们继续看方法调用：</p>
<h4 id="2-4-2-1-ActivityThread-installSystemApplicaitonInfo"><a href="#2-4-2-1-ActivityThread-installSystemApplicaitonInfo" class="headerlink" title="2.4.2.1 ActivityThread.installSystemApplicaitonInfo"></a>2.4.2.1 ActivityThread.installSystemApplicaitonInfo</h4><p>我们进入 ActivityThread 的 installSystemApplicationInfo 的方法：<br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">installSystemApplicationInfo</span><span class="params">(ApplicationInfo info, ClassLoader classLoader)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">synchronized</span> (<span class="keyword">this</span>) &#123;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 调用 ContextImpl 对象的 installSystemApplicationInfo 方法！</span></span><br><span class="line">        getSystemContext().installSystemApplicationInfo(info, classLoader);</span><br><span class="line">        mProfiler = <span class="keyword">new</span> Profiler();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>getSystemContext 方法获得的是系统进程的 Context 对象，Context 的具体实现是 ContextImpl 类！</p>
<h4 id="2-4-2-2-ContextImpl-installSystemApplicaitonInfo"><a href="#2-4-2-2-ContextImpl-installSystemApplicaitonInfo" class="headerlink" title="2.4.2.2 ContextImpl.installSystemApplicaitonInfo"></a>2.4.2.2 ContextImpl.installSystemApplicaitonInfo</h4><p>进入 ContextImpl 对象中：<br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">installSystemApplicationInfo</span><span class="params">(ApplicationInfo info, ClassLoader classLoader)</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 调用 LoadedApk.installSystemApplicationInfo 方法；</span></span><br><span class="line">    mPackageInfo.installSystemApplicationInfo(info, classLoader);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>其中 mPackageInfo 是 LoadedApk 对象，这里的 LoadedApk 是属于 SystemServer 进程的：</p>
<h4 id="2-4-2-3-LoadedAPK-installSystemApplicaitonInfo"><a href="#2-4-2-3-LoadedAPK-installSystemApplicaitonInfo" class="headerlink" title="2.4.2.3 LoadedAPK.installSystemApplicaitonInfo"></a>2.4.2.3 LoadedAPK.installSystemApplicaitonInfo</h4><p>最后，将 framework-res.apk 的安装信息，保存到 SystemServer 进程的主线程的 LoadedAPK 对象中！<br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">installSystemApplicationInfo</span><span class="params">(ApplicationInfo info, ClassLoader classLoader)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">assert</span> info.packageName.equals(<span class="string">"android"</span>);</span><br><span class="line">    mApplicationInfo = info;</span><br><span class="line">    mClassLoader = classLoader;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>每一个进程都会有一个 LoadedApk 对象，最后 ApplicationInfo 和 ClassLoader 设置到了 LoadedApk 对象中！</p>
<h3 id="2-4-3-newProcessRecordLocked"><a href="#2-4-3-newProcessRecordLocked" class="headerlink" title="2.4.3 newProcessRecordLocked"></a>2.4.3 newProcessRecordLocked</h3><p>接下来，创建系统进程对应的 ProcessRecord 对象，传入参数：</p>
<ul>
<li>info：”framework-res.apk” 的 ApplicationInfo 对象！</li>
<li>customProcess：info.processName，所在进程名！</li>
<li>isolated：传入 false，表示不是隔离进程！</li>
<li>isolatedUid：传入 0，表示隔离进程的 uid；</li>
</ul>
<p>isolated 和 isolatedUid 用来表示这进程是不是一个隔离进程！<br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">final</span> ProcessRecord <span class="title">newProcessRecordLocked</span><span class="params">(ApplicationInfo info, String customProcess,</span></span></span><br><span class="line"><span class="function"><span class="params">        <span class="keyword">boolean</span> isolated, <span class="keyword">int</span> isolatedUid)</span> </span>&#123;</span><br><span class="line">    String proc = customProcess != <span class="keyword">null</span> ? customProcess : info.processName;</span><br><span class="line">    BatteryStatsImpl stats = mBatteryStatsService.getActiveStatistics();</span><br><span class="line"></span><br><span class="line">    <span class="keyword">final</span> <span class="keyword">int</span> userId = UserHandle.getUserId(info.uid); <span class="comment">// 获得所属的设备用户！</span></span><br><span class="line">    <span class="keyword">int</span> uid = info.uid;</span><br><span class="line">    <span class="keyword">if</span> (isolated) &#123; <span class="comment">// isolated 为 false, 不进入这个分支!</span></span><br><span class="line">        <span class="keyword">if</span> (isolatedUid == <span class="number">0</span>) &#123;</span><br><span class="line">            <span class="keyword">int</span> stepsLeft = Process.LAST_ISOLATED_UID - Process.FIRST_ISOLATED_UID + <span class="number">1</span>;</span><br><span class="line">            <span class="keyword">while</span> (<span class="keyword">true</span>) &#123;</span><br><span class="line">                <span class="keyword">if</span> (mNextIsolatedProcessUid &lt; Process.FIRST_ISOLATED_UID</span><br><span class="line">                        || mNextIsolatedProcessUid &gt; Process.LAST_ISOLATED_UID) &#123;</span><br><span class="line">                    mNextIsolatedProcessUid = Process.FIRST_ISOLATED_UID;</span><br><span class="line">                &#125;</span><br><span class="line">                uid = UserHandle.getUid(userId, mNextIsolatedProcessUid);</span><br><span class="line">                mNextIsolatedProcessUid++;</span><br><span class="line">                <span class="keyword">if</span> (mIsolatedProcesses.indexOfKey(uid) &lt; <span class="number">0</span>) &#123;</span><br><span class="line">                    <span class="comment">// No process for this uid, use it.</span></span><br><span class="line">                    <span class="keyword">break</span>;</span><br><span class="line">                &#125;</span><br><span class="line">                stepsLeft--;</span><br><span class="line">                <span class="keyword">if</span> (stepsLeft &lt;= <span class="number">0</span>) &#123;</span><br><span class="line">                    <span class="keyword">return</span> <span class="keyword">null</span>;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            <span class="comment">// Special case for startIsolatedProcess (internal only), where</span></span><br><span class="line">            <span class="comment">// the uid of the isolated process is specified by the caller.</span></span><br><span class="line">            uid = isolatedUid;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 创建 ProcessRecord，用于存储系统进程的信息</span></span><br><span class="line">    <span class="keyword">final</span> ProcessRecord r = <span class="keyword">new</span> ProcessRecord(stats, info, proc, uid);</span><br><span class="line">    <span class="keyword">if</span> (!mBooted &amp;&amp; !mBooting</span><br><span class="line">            &amp;&amp; userId == UserHandle.USER_SYSTEM</span><br><span class="line">            &amp;&amp; (info.flags &amp; PERSISTENT_MASK) == PERSISTENT_MASK) &#123;</span><br><span class="line">        r.persistent = <span class="keyword">true</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 保存系统进程 ProcessRecord 对象到 AMS 的结构体中！</span></span><br><span class="line">    addProcessNameLocked(r);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> r;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>接着，调用 addProcessNameLocked 方法：</p>
<h4 id="2-4-3-1-addProcessNameLocked"><a href="#2-4-3-1-addProcessNameLocked" class="headerlink" title="2.4.3.1 addProcessNameLocked"></a>2.4.3.1 addProcessNameLocked</h4><p>保存系统进程 ProcessRecord 对象到 AMS 的结构体中！<br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">final</span> <span class="keyword">void</span> <span class="title">addProcessNameLocked</span><span class="params">(ProcessRecord proc)</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// We shouldn't already have a process under this name, but just in case we</span></span><br><span class="line">    <span class="comment">// need to clean up whatever may be there now.</span></span><br><span class="line">    ProcessRecord old = removeProcessNameLocked(proc.processName, proc.uid);</span><br><span class="line">    <span class="keyword">if</span> (old == proc &amp;&amp; proc.persistent) &#123;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// We are re-adding a persistent process.  Whatevs!  Just leave it there.</span></span><br><span class="line">        Slog.w(TAG, <span class="string">"Re-adding persistent process "</span> + proc);</span><br><span class="line">    &#125; <span class="keyword">else</span> <span class="keyword">if</span> (old != <span class="keyword">null</span>) &#123;</span><br><span class="line">        Slog.wtf(TAG, <span class="string">"Already have existing proc "</span> + old + <span class="string">" when adding "</span> + proc);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 创建 UidRecord 用来保存活跃的 uid，如果已经存在，就不创建！</span></span><br><span class="line">    UidRecord uidRec = mActiveUids.get(proc.uid); </span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (uidRec == <span class="keyword">null</span>) &#123;</span><br><span class="line">        uidRec = <span class="keyword">new</span> UidRecord(proc.uid);</span><br><span class="line"></span><br><span class="line">        <span class="comment">// This is the first appearance of the uid, report it now!</span></span><br><span class="line">        <span class="keyword">if</span> (DEBUG_UID_OBSERVERS) Slog.i(TAG_UID_OBSERVERS,</span><br><span class="line">                <span class="string">"Creating new process uid: "</span> + uidRec);</span><br><span class="line">                </span><br><span class="line">        <span class="comment">// 添加到 mActiveUids 对象！</span></span><br><span class="line">        mActiveUids.put(proc.uid, uidRec);</span><br><span class="line">        noteUidProcessState(uidRec.uid, uidRec.curProcState);</span><br><span class="line">        enqueueUidChangeLocked(uidRec, -<span class="number">1</span>, UidRecord.CHANGE_ACTIVE);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    proc.uidRecord = uidRec;</span><br><span class="line">    uidRec.numProcs++; <span class="comment">// 所属该 uid 的进程计数加 1 （uid 代表一个应用程序）</span></span><br><span class="line">    </span><br><span class="line">    <span class="comment">// 非隔离进程保存到 mProcessNames 集合中，隔离进程保存到 mIsolatedProcesses 中！</span></span><br><span class="line">    mProcessNames.put(proc.processName, proc.uid, proc); </span><br><span class="line">    <span class="keyword">if</span> (proc.isolated) &#123;</span><br><span class="line">        mIsolatedProcesses.put(proc.uid, proc);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<h3 id="2-4-4-ProcessRecord-makeActive"><a href="#2-4-4-ProcessRecord-makeActive" class="headerlink" title="2.4.4 ProcessRecord.makeActive"></a>2.4.4 ProcessRecord.makeActive</h3><p>参数传递：</p>
<ul>
<li>thread: mSystemThread.getApplicationThread()，系统进程的 ApplicationThread 对象！</li>
<li>tracker: mProcessStats，是 ProcessStatsService 服务对象，用来监听进程的状态！<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br></pre></td><td class="code"><pre><span class="line"> <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">makeActive</span><span class="params">(IApplicationThread _thread, ProcessStatsService tracker)</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 第一次进来，为null！</span></span><br><span class="line">    <span class="keyword">if</span> (thread == <span class="keyword">null</span>) &#123;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 将旧的 ProcessState 对象设置为非活跃状态</span></span><br><span class="line">        <span class="keyword">final</span> ProcessState origBase = baseProcessTracker; </span><br><span class="line">        <span class="keyword">if</span> (origBase != <span class="keyword">null</span>) &#123;</span><br><span class="line">            origBase.setState(ProcessStats.STATE_NOTHING,</span><br><span class="line">                    tracker.getMemFactorLocked(), SystemClock.uptimeMillis(), pkgList);</span><br><span class="line">            origBase.makeInactive();</span><br><span class="line">        &#125;</span><br><span class="line">        </span><br><span class="line">        <span class="comment">// 为系统进程创建新的 ProcessState 监听对象，并设置其为活跃状态！</span></span><br><span class="line">        <span class="comment">// info 为改应用程序所属的应用程序！</span></span><br><span class="line">        baseProcessTracker = tracker.getProcessStateLocked(info.packageName, uid,</span><br><span class="line">                info.versionCode, processName);</span><br><span class="line">        baseProcessTracker.makeActive();</span><br><span class="line"></span><br><span class="line">        <span class="keyword">for</span> (<span class="keyword">int</span> i=<span class="number">0</span>; i&lt;pkgList.size(); i++) &#123;</span><br><span class="line">            ProcessStats.ProcessStateHolder holder = pkgList.valueAt(i);</span><br><span class="line">            <span class="keyword">if</span> (holder.state != <span class="keyword">null</span> &amp;&amp; holder.state != origBase) &#123;</span><br><span class="line">                holder.state.makeInactive();</span><br><span class="line">            &#125;</span><br><span class="line">            holder.state = tracker.getProcessStateLocked(pkgList.keyAt(i), uid,</span><br><span class="line">                    info.versionCode, processName);</span><br><span class="line">            <span class="keyword">if</span> (holder.state != baseProcessTracker) &#123;</span><br><span class="line">                holder.state.makeActive();</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// 将系统进程的 ActivityThread 保存到 ProcessRecord.thread，完成引用关系！</span></span><br><span class="line">    thread = _thread;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
</li>
</ul>
<p>以上是在 SystemServer 启动系统服务的第一阶段做的一些主要的工作，接下来，我们来看第二阶段！</p>
<h1 id="3-第二阶段"><a href="#3-第二阶段" class="headerlink" title="3 第二阶段"></a>3 第二阶段</h1><p>接下来，看看第二阶段：</p>
<h2 id="3-1-setUsageStatsManager"><a href="#3-1-setUsageStatsManager" class="headerlink" title="3.1 setUsageStatsManager"></a>3.1 setUsageStatsManager</h2><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">setUsageStatsManager</span><span class="params">(UsageStatsManagerInternal usageStatsManager)</span> </span>&#123;</span><br><span class="line">    mUsageStatsService = usageStatsManager;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>这个方法主要的作用是：</p>
<ul>
<li>设置应用统计服务的应用，用于监控应用的使用频率等信息！</li>
</ul>
<h1 id="4-第三阶段"><a href="#4-第三阶段" class="headerlink" title="4 第三阶段"></a>4 第三阶段</h1><p>这里就要进入开机的最后阶段了！</p>
<h2 id="4-1-AMS-installSystemProviders"><a href="#4-1-AMS-installSystemProviders" class="headerlink" title="4.1 AMS.installSystemProviders"></a>4.1 AMS.installSystemProviders</h2><p>安装系统数据库：<br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">final</span> <span class="keyword">void</span> <span class="title">installSystemProviders</span><span class="params">()</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    List&lt;ProviderInfo&gt; providers;</span><br><span class="line">    <span class="keyword">synchronized</span> (<span class="keyword">this</span>) &#123;</span><br><span class="line">    </span><br><span class="line">        <span class="comment">// 获取系统进程的 ProcessRecord, 之前 setSystemProcess() 时，创建了系统进程对应的 ProcessRecord</span></span><br><span class="line">        ProcessRecord app = mProcessNames.get(<span class="string">"system"</span>, Process.SYSTEM_UID);</span><br><span class="line">        </span><br><span class="line">        <span class="comment">// 生成 ProviderInfo 的列表！</span></span><br><span class="line">        providers = generateApplicationProvidersLocked(app);</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (providers != <span class="keyword">null</span>) &#123;</span><br><span class="line">            <span class="keyword">for</span> (<span class="keyword">int</span> i=providers.size()-<span class="number">1</span>; i&gt;=<span class="number">0</span>; i--) &#123;</span><br><span class="line">                ProviderInfo pi = (ProviderInfo)providers.get(i);</span><br><span class="line">                <span class="keyword">if</span> ((pi.applicationInfo.flags&amp;ApplicationInfo.FLAG_SYSTEM) == <span class="number">0</span>) &#123;</span><br><span class="line">                    Slog.w(TAG, <span class="string">"Not installing system proc provider "</span> + pi.name</span><br><span class="line">                            + <span class="string">": not system .apk"</span>);</span><br><span class="line">                            </span><br><span class="line">                    <span class="comment">// 移除一些非系统的 provider！</span></span><br><span class="line">                    providers.remove(i);</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span> (providers != <span class="keyword">null</span>) &#123;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 调用系统进程的 ActivityThread 的 installSystemProviders 方法，</span></span><br><span class="line">        <span class="comment">// 安装系统进程的数据库！</span></span><br><span class="line">        mSystemThread.installSystemProviders(providers);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    mCoreSettingsObserver = <span class="keyword">new</span> CoreSettingsObserver(<span class="keyword">this</span>);</span><br><span class="line">    mFontScaleSettingObserver = <span class="keyword">new</span> FontScaleSettingObserver();</span><br><span class="line"></span><br><span class="line">    <span class="comment">//mUsageStatsService.monitorPackages();</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>这里指定了进程名为 system，进程 uid 为 Process.SYSTEM_UID，一般来说，会有以下 Provider 会出现在返回结果中:</p>
<ul>
<li>framework-res.apk 中的 Provider, 定义在：frameworks/base/core/res/AndroidManifest.xml</li>
<li>SettingsProvider.apk 中的 Provider, 定义在：frameworks/base/packages/SettingsProvider/AndroidManifest.xml</li>
</ul>
<p>对于手机厂商，可以对系统 apk 进行定制，比如让系统 apk 共享系统 uid，这样的话，就不止以上两种 provider 了！</p>
<h3 id="4-1-1-AMS-generateApplicationProvidersLocked"><a href="#4-1-1-AMS-generateApplicationProvidersLocked" class="headerlink" title="4.1.1 AMS.generateApplicationProvidersLocked"></a>4.1.1 AMS.generateApplicationProvidersLocked</h3><p>参数传递：</p>
<ul>
<li>ProcessRecord app：系统进程的 ProcessRecord 对象！</li>
</ul>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">final</span> List&lt;ProviderInfo&gt; <span class="title">generateApplicationProvidersLocked</span><span class="params">(ProcessRecord app)</span> </span>&#123;</span><br><span class="line">    List&lt;ProviderInfo&gt; providers = <span class="keyword">null</span>;</span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">    </span><br><span class="line">        <span class="comment">// 通过 PackageManagerService 获得系统进程的 provider！</span></span><br><span class="line">        providers = AppGlobals.getPackageManager()</span><br><span class="line">                .queryContentProviders(app.processName, app.uid,</span><br><span class="line">                        STOCK_PM_FLAGS | PackageManager.GET_URI_PERMISSION_PATTERNS</span><br><span class="line">                                | MATCH_DEBUG_TRIAGED_MISSING)</span><br><span class="line">                .getList();</span><br><span class="line"></span><br><span class="line">    &#125; <span class="keyword">catch</span> (RemoteException ex) &#123;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">if</span> (DEBUG_MU) Slog.v(TAG_MU,</span><br><span class="line">            <span class="string">"generateApplicationProvidersLocked, app.info.uid = "</span> + app.uid);</span><br><span class="line">            </span><br><span class="line">    <span class="comment">// 将 Provider 和 ProcessRecord 绑定！        </span></span><br><span class="line">    <span class="keyword">int</span> userId = app.userId;</span><br><span class="line">    <span class="keyword">if</span> (providers != <span class="keyword">null</span>) &#123;</span><br><span class="line">        <span class="keyword">int</span> N = providers.size();</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 确保 ProcessRecord 中的 Provider 映射表的容量！</span></span><br><span class="line">        app.pubProviders.ensureCapacity(N + app.pubProviders.size());</span><br><span class="line">        </span><br><span class="line">        <span class="comment">// 遍历 ProviderInfo 列表</span></span><br><span class="line">        <span class="keyword">for</span> (<span class="keyword">int</span> i=<span class="number">0</span>; i&lt;N; i++) &#123;</span><br><span class="line"></span><br><span class="line">            <span class="comment">// <span class="doctag">TODO:</span> keep logic in sync with installEncryptionUnawareProviders</span></span><br><span class="line">            ProviderInfo cpi =</span><br><span class="line">                (ProviderInfo)providers.get(i);</span><br><span class="line">            <span class="keyword">boolean</span> singleton = isSingleton(cpi.processName, cpi.applicationInfo,</span><br><span class="line">                    cpi.name, cpi.flags);</span><br><span class="line">                    </span><br><span class="line">            <span class="comment">// 对于单例模式的 provider，如果其 uid 不是 system，就不处理！</span></span><br><span class="line">            <span class="keyword">if</span> (singleton &amp;&amp; UserHandle.getUserId(app.uid) != UserHandle.USER_SYSTEM) &#123;</span><br><span class="line">                providers.remove(i);</span><br><span class="line">                N--;</span><br><span class="line">                i--;</span><br><span class="line">                <span class="keyword">continue</span>;</span><br><span class="line">            &#125;</span><br><span class="line">  </span><br><span class="line">            <span class="comment">// 如果 mProviderMap 中不存在 ContentProviderRecord 对象，则新建一个！</span></span><br><span class="line">            ComponentName comp = <span class="keyword">new</span> ComponentName(cpi.packageName, cpi.name);</span><br><span class="line">            ContentProviderRecord cpr = mProviderMap.getProviderByClass(comp, userId);</span><br><span class="line"></span><br><span class="line">            <span class="keyword">if</span> (cpr == <span class="keyword">null</span>) &#123;</span><br><span class="line">                cpr = <span class="keyword">new</span> ContentProviderRecord(<span class="keyword">this</span>, cpi, app.info, comp, singleton);</span><br><span class="line">                </span><br><span class="line">                <span class="comment">// 添加到 AMS.mProciderMap 管理集合中；</span></span><br><span class="line">                mProviderMap.putProviderByClass(comp, cpr);</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            <span class="keyword">if</span> (DEBUG_MU) Slog.v(TAG_MU,</span><br><span class="line">                    <span class="string">"generateApplicationProvidersLocked, cpi.uid = "</span> + cpr.uid);</span><br><span class="line">            </span><br><span class="line">            <span class="comment">// 将当前的 provider 绑定到 ProcessRecord 中；</span></span><br><span class="line">            app.pubProviders.put(cpi.name, cpr);</span><br><span class="line"></span><br><span class="line">            <span class="keyword">if</span> (!cpi.multiprocess || !<span class="string">"android"</span>.equals(cpi.packageName)) &#123;</span><br><span class="line">                app.addPackage(cpi.applicationInfo.packageName, cpi.applicationInfo.versionCode,</span><br><span class="line">                        mProcessStats);</span><br><span class="line"></span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            notifyPackageUse(cpi.applicationInfo.packageName,</span><br><span class="line">                             PackageManager.NOTIFY_PACKAGE_USE_CONTENT_PROVIDER);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> providers;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>我们通过一张类图，了解一下 AMS 是如何管理 ContentProvider 的：</p>
<p><img src="http://static.zybuluo.com/Coolqi/d5jopu5clkmnagqeu47jldl5/AMS%E7%AE%A1%E7%90%86provider.png" alt="AMS管理provider.png-66.2kB"></p>
<ul>
<li><p>AMS 为每一个 ContentProvider 创建了一个 ContentProviderRecord 对象，ContentProviderRecord 中保存着 provider 的配置信息 providerInfo；provider 所属进程的 uid；provider 所属应用的 ApplicaitonInfo 对象！</p>
</li>
<li><p>AMS 的 mProviderMap 对象管理着系统中所有的 ContentProviderRecord 对象，其内部保存着 Authority 或者 CompnentName 到指定 ContentProviderRecord 的映射！</p>
</li>
<li><p>AMS 内部还维护着和 ProcessRecord 相关的集合，用于管理进程，有前台进程集合，内存常驻进程集合，最近使用的进程等等，当 AMS 将一个 ContentProviderRecord 与 ProcessRecord 关联时，会将它保存到 ProcessRecord 内部的一个 pubProviders 集合中！</p>
</li>
</ul>
<h3 id="4-1-2-ActivityThread-installSystemProviders"><a href="#4-1-2-ActivityThread-installSystemProviders" class="headerlink" title="4.1.2 ActivityThread.installSystemProviders"></a>4.1.2 ActivityThread.installSystemProviders</h3><p>接着调用 systemserver 进程的 ActivityThread 的 installSystemProvider 方法：<br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">final</span> <span class="keyword">void</span> <span class="title">installSystemProviders</span><span class="params">(List&lt;ProviderInfo&gt; providers)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">if</span> (providers != <span class="keyword">null</span>) &#123;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// mInitialApplication 是 SystemServer 的进程的 Application 对象！</span></span><br><span class="line">        installContentProviders(mInitialApplication, providers);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>这里的 mInitialApplication 是系统进程的 Application 对象，接着调用了 installContentProviders 方法！</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">installContentProviders</span><span class="params">(</span></span></span><br><span class="line"><span class="function"><span class="params">        Context context, List&lt;ProviderInfo&gt; providers)</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">final</span> ArrayList&lt;IActivityManager.ContentProviderHolder&gt; results =</span><br><span class="line">        <span class="keyword">new</span> ArrayList&lt;IActivityManager.ContentProviderHolder&gt;();</span><br><span class="line">        </span><br><span class="line">    <span class="comment">// 遍历系统进程的所有 provider，为每一个 provider 创建对应的 ContentProviderHolder 对象！</span></span><br><span class="line">    <span class="keyword">for</span> (ProviderInfo cpi : providers) &#123;</span><br><span class="line">        <span class="keyword">if</span> (DEBUG_PROVIDER) &#123;</span><br><span class="line">            StringBuilder buf = <span class="keyword">new</span> StringBuilder(<span class="number">128</span>);</span><br><span class="line">            buf.append(<span class="string">"Pub "</span>);</span><br><span class="line">            buf.append(cpi.authority);</span><br><span class="line">            buf.append(<span class="string">": "</span>);</span><br><span class="line">            buf.append(cpi.name);</span><br><span class="line">            Log.i(TAG, buf.toString());</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 将每一个 ProviderInfo 封装为一个 ContentProviderHolder 对象！</span></span><br><span class="line">        IActivityManager.ContentProviderHolder cph = installProvider(context, <span class="keyword">null</span>, cpi,</span><br><span class="line">                <span class="keyword">false</span> <span class="comment">/*noisy*/</span>, <span class="keyword">true</span> <span class="comment">/*noReleaseNeeded*/</span>, <span class="keyword">true</span> <span class="comment">/*stable*/</span>);</span><br><span class="line">        <span class="keyword">if</span> (cph != <span class="keyword">null</span>) &#123;</span><br><span class="line">            cph.noReleaseNeeded = <span class="keyword">true</span>;</span><br><span class="line"></span><br><span class="line">            <span class="comment">// 添加到集合中！</span></span><br><span class="line">            results.add(cph);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 调用 AMS 的 publish 方法， 注册 ContentProvider</span></span><br><span class="line">        ActivityManagerNative.getDefault().publishContentProviders(</span><br><span class="line">            getApplicationThread(), results);</span><br><span class="line">    &#125; <span class="keyword">catch</span> (RemoteException ex) &#123;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>所有 ContentProvider 的创建都需要经过 installContentProvider() 函数, ，这个地方调用了 ActivityThread.installProvider 方法，继续安装 provider：</p>
<h4 id="4-1-2-1-ActivityThread-installProvider"><a href="#4-1-2-1-ActivityThread-installProvider" class="headerlink" title="4.1.2.1 ActivityThread.installProvider"></a>4.1.2.1 ActivityThread.installProvider</h4><p>让我们来继续看看这部分的代码 installProvider，参数传递：</p>
<ul>
<li>Context context：传入 context 对象，这里的 context 是 mInitialApplication 对象，是系统进程的上下文运行环境；</li>
<li>IActivityManager.ContentProviderHolder holder：传入 <strong>null</strong>；</li>
<li>ProviderInfo info：传入 ProviderInfo 对象，封装着 provider 的信息；</li>
<li>boolean noisy：传入 <strong>false</strong>；</li>
<li>boolean noReleaseNeeded：传入 <strong>true</strong>；</li>
<li>boolean stable：传入 <strong>true</strong>；</li>
</ul>
<p>接着来看：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">private</span> IActivityManager.<span class="function">ContentProviderHolder <span class="title">installProvider</span><span class="params">(Context context,</span></span></span><br><span class="line"><span class="function"><span class="params">        IActivityManager.ContentProviderHolder holder, ProviderInfo info,</span></span></span><br><span class="line"><span class="function"><span class="params">        <span class="keyword">boolean</span> noisy, <span class="keyword">boolean</span> noReleaseNeeded, <span class="keyword">boolean</span> stable)</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    ContentProvider localProvider = <span class="keyword">null</span>;</span><br><span class="line">    IContentProvider provider;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (holder == <span class="keyword">null</span> || holder.provider == <span class="keyword">null</span>) &#123; <span class="comment">// 进入这个分支!</span></span><br><span class="line">        <span class="keyword">if</span> (DEBUG_PROVIDER || noisy) &#123;</span><br><span class="line">            Slog.d(TAG, <span class="string">"Loading provider "</span> + info.authority + <span class="string">": "</span></span><br><span class="line">                    + info.name);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        Context c = <span class="keyword">null</span>;</span><br><span class="line">        ApplicationInfo ai = info.applicationInfo;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 通过包名，找到和 provider 匹配的 context！</span></span><br><span class="line">        <span class="comment">// 如果当前已有的运行环境 Context 不匹配的话，就会创建一个新的 Context！</span></span><br><span class="line">        <span class="keyword">if</span> (context.getPackageName().equals(ai.packageName)) &#123;</span><br><span class="line">            c = context;</span><br><span class="line"></span><br><span class="line">        &#125; <span class="keyword">else</span> <span class="keyword">if</span> (mInitialApplication != <span class="keyword">null</span> &amp;&amp;</span><br><span class="line">                mInitialApplication.getPackageName().equals(ai.packageName)) &#123;</span><br><span class="line">            c = mInitialApplication;</span><br><span class="line"></span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            <span class="keyword">try</span> &#123;</span><br><span class="line">                c = context.createPackageContext(ai.packageName,</span><br><span class="line">                        Context.CONTEXT_INCLUDE_CODE);</span><br><span class="line"></span><br><span class="line">            &#125; <span class="keyword">catch</span> (PackageManager.NameNotFoundException e) &#123;</span><br><span class="line">                <span class="comment">// Ignore</span></span><br><span class="line"></span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (c == <span class="keyword">null</span>) &#123;</span><br><span class="line">            Slog.w(TAG, <span class="string">"Unable to get context for package "</span> +</span><br><span class="line">                  ai.packageName +</span><br><span class="line">                  <span class="string">" while loading content provider "</span> +</span><br><span class="line">                  info.name);</span><br><span class="line">            <span class="keyword">return</span> <span class="keyword">null</span>;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 根据包名，通过反射创建新的 ContentProvider 对象！</span></span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line"></span><br><span class="line">            <span class="keyword">final</span> java.lang.ClassLoader cl = c.getClassLoader();</span><br><span class="line">            localProvider = (ContentProvider)cl.</span><br><span class="line">                loadClass(info.name).newInstance();</span><br><span class="line">            provider = localProvider.getIContentProvider();</span><br><span class="line"></span><br><span class="line">            <span class="keyword">if</span> (provider == <span class="keyword">null</span>) &#123;</span><br><span class="line">                Slog.e(TAG, <span class="string">"Failed to instantiate class "</span> +</span><br><span class="line">                      info.name + <span class="string">" from sourceDir "</span> +</span><br><span class="line">                      info.applicationInfo.sourceDir);</span><br><span class="line">                <span class="keyword">return</span> <span class="keyword">null</span>;</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            <span class="keyword">if</span> (DEBUG_PROVIDER) Slog.v(</span><br><span class="line">                TAG, <span class="string">"Instantiating local provider "</span> + info.name);</span><br><span class="line">            </span><br><span class="line">            <span class="comment">// 将创建的 provider 和 providerInfo 数据进行绑定；</span></span><br><span class="line">            <span class="comment">// 这个方法对 provider 会做初始化，</span></span><br><span class="line">            localProvider.attachInfo(c, info);</span><br><span class="line"></span><br><span class="line">        &#125; <span class="keyword">catch</span> (java.lang.Exception e) &#123;</span><br><span class="line">            <span class="keyword">if</span> (!mInstrumentation.onException(<span class="keyword">null</span>, e)) &#123;</span><br><span class="line">                <span class="keyword">throw</span> <span class="keyword">new</span> RuntimeException(</span><br><span class="line">                        <span class="string">"Unable to get provider "</span> + info.name</span><br><span class="line">                        + <span class="string">": "</span> + e.toString(), e);</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">return</span> <span class="keyword">null</span>;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        provider = holder.provider;</span><br><span class="line">        <span class="keyword">if</span> (DEBUG_PROVIDER) Slog.v(TAG, <span class="string">"Installing external provider "</span> + info.authority + <span class="string">": "</span></span><br><span class="line">                + info.name);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 设置一个 ContentProviderHolder 对象！</span></span><br><span class="line">    IActivityManager.ContentProviderHolder retHolder;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">synchronized</span> (mProviderMap) &#123;</span><br><span class="line">        <span class="keyword">if</span> (DEBUG_PROVIDER) Slog.v(TAG, <span class="string">"Checking to add "</span> + provider</span><br><span class="line">                + <span class="string">" / "</span> + info.name);</span><br><span class="line"></span><br><span class="line">        IBinder jBinder = provider.asBinder();</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (localProvider != <span class="keyword">null</span>) &#123;</span><br><span class="line">            ComponentName cname = <span class="keyword">new</span> ComponentName(info.packageName, info.name);</span><br><span class="line">            ProviderClientRecord pr = mLocalProvidersByName.get(cname);</span><br><span class="line">            <span class="keyword">if</span> (pr != <span class="keyword">null</span>) &#123;</span><br><span class="line">                <span class="keyword">if</span> (DEBUG_PROVIDER) &#123;</span><br><span class="line">                    Slog.v(TAG, <span class="string">"installProvider: lost the race, "</span></span><br><span class="line">                            + <span class="string">"using existing local provider"</span>);</span><br><span class="line">                &#125;</span><br><span class="line">                provider = pr.mProvider;</span><br><span class="line">            &#125; <span class="keyword">else</span> &#123;</span><br><span class="line"></span><br><span class="line">                <span class="comment">// 创建一个新的 ContentProviderHolder 对象!</span></span><br><span class="line">                holder = <span class="keyword">new</span> IActivityManager.ContentProviderHolder(info);</span><br><span class="line">                holder.provider = provider;</span><br><span class="line">                holder.noReleaseNeeded = <span class="keyword">true</span>;</span><br><span class="line"></span><br><span class="line">                <span class="comment">// 创建一个新的 ProviderClientRecord 对象!</span></span><br><span class="line">                pr = installProviderAuthoritiesLocked(provider, localProvider, holder);</span><br><span class="line">                mLocalProviders.put(jBinder, pr);</span><br><span class="line">                mLocalProvidersByName.put(cname, pr);</span><br><span class="line">            &#125;</span><br><span class="line">            retHolder = pr.mHolder;</span><br><span class="line"></span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            ProviderRefCount prc = mProviderRefCountMap.get(jBinder);</span><br><span class="line">            <span class="keyword">if</span> (prc != <span class="keyword">null</span>) &#123;</span><br><span class="line">                <span class="keyword">if</span> (DEBUG_PROVIDER) &#123;</span><br><span class="line">                    Slog.v(TAG, <span class="string">"installProvider: lost the race, updating ref count"</span>);</span><br><span class="line">                &#125;</span><br><span class="line">                <span class="comment">// We need to transfer our new reference to the existing</span></span><br><span class="line">                <span class="comment">// ref count, releasing the old one...  but only if</span></span><br><span class="line">                <span class="comment">// release is needed (that is, it is not running in the</span></span><br><span class="line">                <span class="comment">// system process).</span></span><br><span class="line">                <span class="keyword">if</span> (!noReleaseNeeded) &#123;</span><br><span class="line">                    incProviderRefLocked(prc, stable);</span><br><span class="line">                    <span class="keyword">try</span> &#123;</span><br><span class="line">                        ActivityManagerNative.getDefault().removeContentProvider(</span><br><span class="line">                                holder.connection, stable);</span><br><span class="line">                    &#125; <span class="keyword">catch</span> (RemoteException e) &#123;</span><br><span class="line">                        <span class="comment">//do nothing content provider object is dead any way</span></span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                ProviderClientRecord client = installProviderAuthoritiesLocked(</span><br><span class="line">                        provider, localProvider, holder);</span><br><span class="line">                <span class="keyword">if</span> (noReleaseNeeded) &#123;</span><br><span class="line">                    prc = <span class="keyword">new</span> ProviderRefCount(holder, client, <span class="number">1000</span>, <span class="number">1000</span>);</span><br><span class="line">                &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                    prc = stable</span><br><span class="line">                            ? <span class="keyword">new</span> ProviderRefCount(holder, client, <span class="number">1</span>, <span class="number">0</span>)</span><br><span class="line">                            : <span class="keyword">new</span> ProviderRefCount(holder, client, <span class="number">0</span>, <span class="number">1</span>);</span><br><span class="line">                &#125;</span><br><span class="line">                mProviderRefCountMap.put(jBinder, prc);</span><br><span class="line">            &#125;</span><br><span class="line">            retHolder = prc.holder;</span><br><span class="line"></span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> retHolder;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<ul>
<li><p>找到 ProviderInfo 对应的运行环境 Context：</p>
<ul>
<li>对于 framework-res.apk 中定义的 com.android.server.am.DumpHeapProvider 而言，重新设置的 Context 就是 mInitialApplication</li>
<li>对于 SettingProvider.apk 中定义的 SettingsProvider 而言，它的包名为 com.android.providers.settings，不等于 mInitialApplication 的包名 android，所以，会通过 Context.createPackageContext() 函数创建一个新的 Context！</li>
</ul>
</li>
<li><p>反射创建 ContentProvider 对象：</p>
<ul>
<li>之所以前面要找到 ProviderInfo 的 Context，就是因为<strong>只有与 ContentProvider 对应的 Context 才能从 APK 中加载 Java 字节码进行反射</strong>。</li>
<li>ContentProvider 创建好后，会调用 ContentProvider.attachInfo 函数, 其内部进行一些初始化操作后，会调用 ContentProvider.onCreate 函数，<strong>这样以来，ContentProvider 就进入其生命周期</strong>了。</li>
</ul>
</li>
<li><p>设置CotentProviderHolder。</p>
<ul>
<li>要理解这一段逻辑, 需要先理解 ContentProvider 的管理机制, 在此, 我们只需要了解这里会找到 ContentProviderHolder， 拿到这个数据结构后， 就能向 AMS 申报 Provider 可以使用了。</li>
</ul>
</li>
</ul>
<h4 id="4-1-2-2-AMN-publishContentProviders"><a href="#4-1-2-2-AMN-publishContentProviders" class="headerlink" title="4.1.2.2 AMN.publishContentProviders"></a>4.1.2.2 AMN.publishContentProviders</h4><p>最终会调用 ActivityManagerService 中的 publishContentProviders 方法，IApplicationThread caller<br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">final</span> <span class="keyword">void</span> <span class="title">publishContentProviders</span><span class="params">(IApplicationThread caller,</span></span></span><br><span class="line"><span class="function"><span class="params">        List&lt;ContentProviderHolder&gt; providers)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">if</span> (providers == <span class="keyword">null</span>) &#123;</span><br><span class="line">        <span class="keyword">return</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    enforceNotIsolatedCaller(<span class="string">"publishContentProviders"</span>);</span><br><span class="line">    <span class="keyword">synchronized</span> (<span class="keyword">this</span>) &#123;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 获得调用者所在进程的 ProcessRecord 对象！</span></span><br><span class="line">        <span class="keyword">final</span> ProcessRecord r = getRecordForAppLocked(caller);</span><br><span class="line">        <span class="keyword">if</span> (DEBUG_MU) Slog.v(TAG_MU, <span class="string">"ProcessRecord uid = "</span> + r.uid);</span><br><span class="line">        <span class="keyword">if</span> (r == <span class="keyword">null</span>) &#123;</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> SecurityException(</span><br><span class="line">                    <span class="string">"Unable to find app for caller "</span> + caller</span><br><span class="line">                  + <span class="string">" (pid="</span> + Binder.getCallingPid()</span><br><span class="line">                  + <span class="string">") when publishing content providers"</span>);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">final</span> <span class="keyword">long</span> origId = Binder.clearCallingIdentity();</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 遍历传入的 ContentProviderHolder 集合！</span></span><br><span class="line">        <span class="keyword">final</span> <span class="keyword">int</span> N = providers.size();</span><br><span class="line">        <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; N; i++) &#123;</span><br><span class="line"></span><br><span class="line">            ContentProviderHolder src = providers.get(i);</span><br><span class="line">            <span class="keyword">if</span> (src == <span class="keyword">null</span> || src.info == <span class="keyword">null</span> || src.provider == <span class="keyword">null</span>) &#123;</span><br><span class="line">                <span class="keyword">continue</span>;</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            <span class="comment">// 从 ProcessRecord 中获得其对应的 ContentProviderRecord 对象！</span></span><br><span class="line">            ContentProviderRecord dst = r.pubProviders.get(src.info.name);</span><br><span class="line"></span><br><span class="line">            <span class="keyword">if</span> (DEBUG_MU) Slog.v(TAG_MU, <span class="string">"ContentProviderRecord uid = "</span> + dst.uid);</span><br><span class="line">            </span><br><span class="line">            <span class="keyword">if</span> (dst != <span class="keyword">null</span>) &#123;</span><br><span class="line"></span><br><span class="line">                ComponentName comp = <span class="keyword">new</span> ComponentName(dst.info.packageName, dst.info.name);</span><br><span class="line">                mProviderMap.putProviderByClass(comp, dst);</span><br><span class="line">                String names[] = dst.info.authority.split(<span class="string">";"</span>);</span><br><span class="line">                <span class="keyword">for</span> (<span class="keyword">int</span> j = <span class="number">0</span>; j &lt; names.length; j++) &#123;</span><br><span class="line">                    mProviderMap.putProviderByName(names[j], dst);</span><br><span class="line">                &#125;</span><br><span class="line"></span><br><span class="line">                <span class="keyword">int</span> launchingCount = mLaunchingProviders.size();</span><br><span class="line">                <span class="keyword">int</span> j;</span><br><span class="line">                <span class="keyword">boolean</span> wasInLaunchingProviders = <span class="keyword">false</span>;</span><br><span class="line">                <span class="keyword">for</span> (j = <span class="number">0</span>; j &lt; launchingCount; j++) &#123;</span><br><span class="line">                    <span class="keyword">if</span> (mLaunchingProviders.get(j) == dst) &#123;</span><br><span class="line">                        mLaunchingProviders.remove(j);</span><br><span class="line">                        wasInLaunchingProviders = <span class="keyword">true</span>;</span><br><span class="line">                        j--;</span><br><span class="line">                        launchingCount--;</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;</span><br><span class="line"></span><br><span class="line">                <span class="keyword">if</span> (wasInLaunchingProviders) &#123;</span><br><span class="line">                    mHandler.removeMessages(CONTENT_PROVIDER_PUBLISH_TIMEOUT_MSG, r);</span><br><span class="line">                &#125;</span><br><span class="line"></span><br><span class="line">                <span class="keyword">synchronized</span> (dst) &#123;</span><br><span class="line">                    dst.provider = src.provider;</span><br><span class="line">                    dst.proc = r;</span><br><span class="line">                    dst.notifyAll();</span><br><span class="line">                &#125;</span><br><span class="line"></span><br><span class="line">                <span class="comment">// 更新 ommAdj 值，用于 LMK！</span></span><br><span class="line">                updateOomAdjLocked(r);</span><br><span class="line"></span><br><span class="line">                <span class="comment">// 更新 provider 的使用状态！</span></span><br><span class="line">                maybeUpdateProviderUsageStatsLocked(r, src.info.packageName,</span><br><span class="line">                        src.info.authority);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        Binder.restoreCallingIdentity(origId);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<h3 id="4-1-3-阶段总结"><a href="#4-1-3-阶段总结" class="headerlink" title="4.1.3 阶段总结"></a>4.1.3 阶段总结</h3><p>我们总结一下：</p>
<ul>
<li><p>首先，获得系统进程的 providerInfo 列表！</p>
<ul>
<li>通过 PMS，获得系统进程的 providerInfo 列表；</li>
<li>确保系统进程 ProcessRecord 有足够的空间存储 ContentProvider；</li>
<li>然后，对找到的 ProviderInfo 列表进行遍历, 如有需要, 则新建一个 ContentProviderRecord 对象, 将其添加到 AMS.mProviderMap 中以方便管理；同时, 也需要将其添加到 PrcoessRecord.mPubProviders 中。</li>
<li>最后返回 providerInfo 列表；</li>
</ul>
</li>
<li><p>将 provider 注册到系统进程！</p>
</li>
</ul>
<h2 id="4-2-AMS-systemReady"><a href="#4-2-AMS-systemReady" class="headerlink" title="4.2 AMS.systemReady"></a>4.2 AMS.systemReady</h2><p>SystemServer 在启动完所有服务之后，将调用 AMS 的 systemReady() 方法。这个方法是 Android 进入用户交互阶段前最后进行的准备工作。这里就即将进入开机的最后阶段了：<br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">systemReady</span><span class="params">(<span class="keyword">final</span> Runnable goingCallback)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">synchronized</span>(<span class="keyword">this</span>) &#123;</span><br><span class="line">      </span><br><span class="line">        <span class="keyword">if</span> (mSystemReady) &#123; <span class="comment">// 第一次是不会进入这个分支的！</span></span><br><span class="line"></span><br><span class="line">            <span class="keyword">if</span> (goingCallback != <span class="keyword">null</span>) &#123;</span><br><span class="line">                goingCallback.run();</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">return</span>;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        mLocalDeviceIdleController</span><br><span class="line">                = LocalServices.getService(DeviceIdleController.LocalService.class);</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 通知 UserController、RecentTask 和 AppOpsService 服务，系统已经准备好了！</span></span><br><span class="line">        mUserController.onSystemReady();</span><br><span class="line">        mRecentTasks.onSystemReadyLocked();</span><br><span class="line">        mAppOpsService.systemReady();</span><br><span class="line"></span><br><span class="line">        <span class="comment">// mSystemReady 置为 true，表示系统进程已经准备完毕了！</span></span><br><span class="line">        mSystemReady = <span class="keyword">true</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 遍历 mPidsSelfLocked，找到已经启动但是没有带有 FLAG_PERSISTENT 标记的非 peristent 应用进程；</span></span><br><span class="line">    <span class="comment">// 然后杀掉它们，目的是在启动 Home 前准备一个干净的环境！</span></span><br><span class="line">    ArrayList&lt;ProcessRecord&gt; procsToKill = <span class="keyword">null</span>;</span><br><span class="line">    <span class="keyword">synchronized</span>(mPidsSelfLocked) &#123;</span><br><span class="line">        <span class="keyword">for</span> (<span class="keyword">int</span> i=mPidsSelfLocked.size()-<span class="number">1</span>; i&gt;=<span class="number">0</span>; i--) &#123;</span><br><span class="line">            ProcessRecord proc = mPidsSelfLocked.valueAt(i);</span><br><span class="line"></span><br><span class="line">            <span class="keyword">if</span> (!isAllowedWhileBooting(proc.info))&#123;</span><br><span class="line">                <span class="keyword">if</span> (procsToKill == <span class="keyword">null</span>) &#123;</span><br><span class="line">                    procsToKill = <span class="keyword">new</span> ArrayList&lt;ProcessRecord&gt;();</span><br><span class="line">                &#125;</span><br><span class="line">                procsToKill.add(proc);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">synchronized</span>(<span class="keyword">this</span>) &#123;</span><br><span class="line">        <span class="keyword">if</span> (procsToKill != <span class="keyword">null</span>) &#123;</span><br><span class="line">            <span class="keyword">for</span> (<span class="keyword">int</span> i=procsToKill.size()-<span class="number">1</span>; i&gt;=<span class="number">0</span>; i--) &#123;</span><br><span class="line">                ProcessRecord proc = procsToKill.get(i);</span><br><span class="line">                Slog.i(TAG, <span class="string">"Removing system update proc: "</span> + proc);</span><br><span class="line">                removeProcessLocked(proc, <span class="keyword">true</span>, <span class="keyword">false</span>, <span class="string">"system update done"</span>);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 表示 AMS 已经准备完毕，可以启动其他进程了！</span></span><br><span class="line">        mProcessesReady = <span class="keyword">true</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    Slog.i(TAG, <span class="string">"System now ready"</span>);</span><br><span class="line">    EventLog.writeEvent(EventLogTags.BOOT_PROGRESS_AMS_READY,</span><br><span class="line">        SystemClock.uptimeMillis());</span><br><span class="line"></span><br><span class="line">    <span class="keyword">synchronized</span>(<span class="keyword">this</span>) &#123;</span><br><span class="line">        <span class="keyword">if</span> (mFactoryTest == FactoryTest.FACTORY_TEST_LOW_LEVEL) &#123;</span><br><span class="line">           ... ... ... ...<span class="comment">// 工厂模式，非正常情况，先不看！</span></span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// 读取设置信息！</span></span><br><span class="line">    retrieveSettings();</span><br><span class="line">    <span class="keyword">final</span> <span class="keyword">int</span> currentUserId;</span><br><span class="line">    <span class="keyword">synchronized</span> (<span class="keyword">this</span>) &#123;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 获得当前设备用户 id！</span></span><br><span class="line">        currentUserId = mUserController.getCurrentUserIdLocked();</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 从 /data/system/urigrants.xml 文件中读取URI相关的权限信息！</span></span><br><span class="line">        readGrantedUriPermissionsLocked();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 执行传入的 callback 回调，主要是启动其他服务等等！</span></span><br><span class="line">    <span class="keyword">if</span> (goingCallback != <span class="keyword">null</span>) goingCallback.run();</span><br><span class="line"></span><br><span class="line">    mBatteryStatsService.noteEvent(BatteryStats.HistoryItem.EVENT_USER_RUNNING_START,</span><br><span class="line">            Integer.toString(currentUserId), currentUserId);</span><br><span class="line">    mBatteryStatsService.noteEvent(BatteryStats.HistoryItem.EVENT_USER_FOREGROUND_START,</span><br><span class="line">            Integer.toString(currentUserId), currentUserId);</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 启动当前的设备用户！</span></span><br><span class="line">    mSystemServiceManager.startUser(currentUserId);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">synchronized</span> (<span class="keyword">this</span>) &#123;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 启动那些 peristent 应用进程!</span></span><br><span class="line">        startPersistentApps(PackageManager.MATCH_DIRECT_BOOT_AWARE);</span><br><span class="line"></span><br><span class="line">        <span class="comment">// Start up initial activity.</span></span><br><span class="line">        mBooting = <span class="keyword">true</span>;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (UserManager.isSplitSystemUser()) &#123;</span><br><span class="line">            ComponentName cName = <span class="keyword">new</span> ComponentName(mContext, SystemUserHomeActivity.class);</span><br><span class="line">            <span class="keyword">try</span> &#123;</span><br><span class="line"></span><br><span class="line">                AppGlobals.getPackageManager().setComponentEnabledSetting(cName,</span><br><span class="line">                        PackageManager.COMPONENT_ENABLED_STATE_ENABLED, <span class="number">0</span>,</span><br><span class="line">                        UserHandle.USER_SYSTEM);</span><br><span class="line"></span><br><span class="line">            &#125; <span class="keyword">catch</span> (RemoteException e) &#123;</span><br><span class="line">                <span class="keyword">throw</span> e.rethrowAsRuntimeException();</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 启动桌面！</span></span><br><span class="line">        startHomeActivityLocked(currentUserId, <span class="string">"systemReady"</span>);</span><br><span class="line"></span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            <span class="keyword">if</span> (AppGlobals.getPackageManager().hasSystemUidErrors()) &#123;</span><br><span class="line">                Slog.e(TAG, <span class="string">"UIDs on the system are inconsistent, you need to wipe your"</span></span><br><span class="line">                        + <span class="string">" data partition or your device will be unstable."</span>);</span><br><span class="line">                mUiHandler.obtainMessage(SHOW_UID_ERROR_UI_MSG).sendToTarget();</span><br><span class="line">            &#125;</span><br><span class="line">        &#125; <span class="keyword">catch</span> (RemoteException e) &#123;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (!Build.isBuildConsistent()) &#123;</span><br><span class="line">            Slog.e(TAG, <span class="string">"Build fingerprint is not consistent, warning user"</span>);</span><br><span class="line">            mUiHandler.obtainMessage(SHOW_FINGERPRINT_ERROR_UI_MSG).sendToTarget();</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">long</span> ident = Binder.clearCallingIdentity();</span><br><span class="line"></span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            Intent intent = <span class="keyword">new</span> Intent(Intent.ACTION_USER_STARTED);</span><br><span class="line">            intent.addFlags(Intent.FLAG_RECEIVER_REGISTERED_ONLY</span><br><span class="line">                    | Intent.FLAG_RECEIVER_FOREGROUND);</span><br><span class="line">            intent.putExtra(Intent.EXTRA_USER_HANDLE, currentUserId);</span><br><span class="line">            broadcastIntentLocked(<span class="keyword">null</span>, <span class="keyword">null</span>, intent,</span><br><span class="line">                    <span class="keyword">null</span>, <span class="keyword">null</span>, <span class="number">0</span>, <span class="keyword">null</span>, <span class="keyword">null</span>, <span class="keyword">null</span>, AppOpsManager.OP_NONE,</span><br><span class="line">                    <span class="keyword">null</span>, <span class="keyword">false</span>, <span class="keyword">false</span>, MY_PID, Process.SYSTEM_UID,</span><br><span class="line">                    currentUserId);</span><br><span class="line">            intent = <span class="keyword">new</span> Intent(Intent.ACTION_USER_STARTING);</span><br><span class="line">            intent.addFlags(Intent.FLAG_RECEIVER_REGISTERED_ONLY);</span><br><span class="line">            intent.putExtra(Intent.EXTRA_USER_HANDLE, currentUserId);</span><br><span class="line">            broadcastIntentLocked(<span class="keyword">null</span>, <span class="keyword">null</span>, intent,</span><br><span class="line">                    <span class="keyword">null</span>, <span class="keyword">new</span> IIntentReceiver.Stub() &#123;</span><br><span class="line">                        <span class="meta">@Override</span></span><br><span class="line">                        <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">performReceive</span><span class="params">(Intent intent, <span class="keyword">int</span> resultCode, String data,</span></span></span><br><span class="line"><span class="function"><span class="params">                                Bundle extras, <span class="keyword">boolean</span> ordered, <span class="keyword">boolean</span> sticky, <span class="keyword">int</span> sendingUser)</span></span></span><br><span class="line"><span class="function">                                <span class="keyword">throws</span> RemoteException </span>&#123;</span><br><span class="line">                        &#125;</span><br><span class="line">                    &#125;, <span class="number">0</span>, <span class="keyword">null</span>, <span class="keyword">null</span>,</span><br><span class="line">                    <span class="keyword">new</span> String[] &#123;INTERACT_ACROSS_USERS&#125;, AppOpsManager.OP_NONE,</span><br><span class="line">                    <span class="keyword">null</span>, <span class="keyword">true</span>, <span class="keyword">false</span>, MY_PID, Process.SYSTEM_UID, UserHandle.USER_ALL);</span><br><span class="line">        &#125; <span class="keyword">catch</span> (Throwable t) &#123;</span><br><span class="line">            Slog.wtf(TAG, <span class="string">"Failed sending first user broadcasts"</span>, t);</span><br><span class="line">        &#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">            Binder.restoreCallingIdentity(ident);</span><br><span class="line">        &#125;</span><br><span class="line">        mStackSupervisor.resumeFocusedStackTopActivityLocked();</span><br><span class="line">        mUserController.sendUserSwitchBroadcastsLocked(-<span class="number">1</span>, currentUserId);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>这里的代码路基比较复杂，里面有一些关键的点，我们来看看：</p>
<h3 id="4-2-1-通知其他服务SystemReady"><a href="#4-2-1-通知其他服务SystemReady" class="headerlink" title="4.2.1 通知其他服务SystemReady"></a>4.2.1 通知其他服务SystemReady</h3><p>代码如下：<br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">mUserController.onSystemReady();</span><br><span class="line">mRecentTasks.onSystemReadyLocked();</span><br><span class="line">mAppOpsService.systemReady();</span><br><span class="line">mSystemReady = <span class="keyword">true</span>;</span><br></pre></td></tr></table></figure></p>
<p>我们一个一个来看：</p>
<h4 id="4-2-1-1-UserController-onSystemReady"><a href="#4-2-1-1-UserController-onSystemReady" class="headerlink" title="4.2.1.1 UserController.onSystemReady"></a>4.2.1.1 UserController.onSystemReady</h4><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">onSystemReady</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    updateCurrentProfileIdsLocked();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>调用了 updateCurrentProfileIdsLocked：<br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">updateCurrentProfileIdsLocked</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    <span class="keyword">final</span> List&lt;UserInfo&gt; profiles = getUserManager().getProfiles(mCurrentUserId,</span><br><span class="line">            <span class="keyword">false</span> <span class="comment">/* enabledOnly */</span>);</span><br><span class="line">    <span class="keyword">int</span>[] currentProfileIds = <span class="keyword">new</span> <span class="keyword">int</span>[profiles.size()]; <span class="comment">// profiles will not be null</span></span><br><span class="line">    <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; currentProfileIds.length; i++) &#123;</span><br><span class="line">        currentProfileIds[i] = profiles.get(i).id;</span><br><span class="line">    &#125;</span><br><span class="line">    mCurrentProfileIds = currentProfileIds;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">synchronized</span> (mUserProfileGroupIdsSelfLocked) &#123;</span><br><span class="line">        mUserProfileGroupIdsSelfLocked.clear();</span><br><span class="line">        <span class="keyword">final</span> List&lt;UserInfo&gt; users = getUserManager().getUsers(<span class="keyword">false</span>);</span><br><span class="line">        <span class="comment">// 保存所有设备用户的信息，用于以后权限校验使用！</span></span><br><span class="line">        <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; users.size(); i++) &#123;</span><br><span class="line">            UserInfo user = users.get(i);</span><br><span class="line">            <span class="keyword">if</span> (user.profileGroupId != UserInfo.NO_PROFILE_GROUP_ID) &#123;</span><br><span class="line">                <span class="comment">// 保存在这里！</span></span><br><span class="line">                mUserProfileGroupIdsSelfLocked.put(user.id, user.profileGroupId);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>这个方法的作用是：Android 的许多系统调用都需要检查用户的 ID，所以这里调用 updateCurrnetProfileIdsLocked() 方法来通过 UserManagerService 读取系统保持的 Profile 信息，装载系统中已经存在的用户信息。</p>
<h4 id="4-2-1-2-RecentTasks-onSystemReady"><a href="#4-2-1-2-RecentTasks-onSystemReady" class="headerlink" title="4.2.1.2 RecentTasks.onSystemReady"></a>4.2.1.2 RecentTasks.onSystemReady</h4><p>代码如下：<br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">onSystemReadyLocked</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    clear();</span><br><span class="line">    mTaskPersister.startPersisting();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>从 Android5.0 开始支持带有 persistent 标记的 task，这些 task 在关机时，信息保存在 /data/system/recent_tasks 目录下的 xxx_task.xml（xxx 表示 task id）中，系统重启时，通过这些文件中保存的信息重建 task，和 JobSchedulerService 很类似哦！</p>
<h4 id="4-2-1-3-AppOpsService-onSystemReady"><a href="#4-2-1-3-AppOpsService-onSystemReady" class="headerlink" title="4.2.1.3 AppOpsService.onSystemReady"></a>4.2.1.3 AppOpsService.onSystemReady</h4><p>这个 AppOpsService 是谷歌原生的应用程序权限管理服务，在 Android M ( Android 6.0 ) 加入的 Application Permission Manage 的功能就是基于 AppOps 实现的!</p>
<p>AppOps 全称是 Application Operations，类似我们平时常说的应用程序的操作（权限）管理。AppOps 是 Google 原生Android 包含的功能，但是 Google 在每次版本更新时都会隐藏掉 AppOps 的入口。</p>
<p>注意：AppOps 虽然涵盖了 App 的权限管理，但是 Google 原生的设计并不仅仅是对“权限”的管理，而是对 App 的“动作”的管理。我们平时讲的权限管理多是针对具体的权限（App 开发者在 Manifest 里申请的权限），而 AppOps 所管理的是所有可能涉及用户隐私和安全的操作，包括 access notification, keep weak lock, activate vpn, display toast 等等，有些操作是不需要 Manifest 里申请权限的。</p>
<p>这里调用了 AppOpsService 的 systemReady，代码如下：<br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">systemReady</span><span class="params">()</span> </span>&#123;</span><br><span class="line">   </span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>这里后续再补上，哈哈哈哈，我也有周期性颓废～～～～～～</p>
<h3 id="4-2-2-杀掉特定进程"><a href="#4-2-2-杀掉特定进程" class="headerlink" title="4.2.2 杀掉特定进程"></a>4.2.2 杀掉特定进程</h3><p>刚刚有讲到，AMS 会杀掉已经启动并且没有带有 FLAG_PERSISTENT 标记的进程，那如何判断是否具有这个标记呢：</p>
<h4 id="4-2-2-1-isAllowedWhileBooting"><a href="#4-2-2-1-isAllowedWhileBooting" class="headerlink" title="4.2.2.1 isAllowedWhileBooting"></a>4.2.2.1 isAllowedWhileBooting</h4><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">boolean</span> <span class="title">isAllowedWhileBooting</span><span class="params">(ApplicationInfo ai)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">return</span> (ai.flags&amp;ApplicationInfo.FLAG_PERSISTENT) != <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>如果某个进程没有 FLAG_PERSISTENT ，这个方法会返回 false！</p>
<h3 id="4-2-3-读取设置信息-retrieveSettings"><a href="#4-2-3-读取设置信息-retrieveSettings" class="headerlink" title="4.2.3 读取设置信息-retrieveSettings"></a>4.2.3 读取设置信息-retrieveSettings</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">retrieveSettings</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    <span class="keyword">final</span> ContentResolver resolver = mContext.getContentResolver();</span><br><span class="line">    <span class="comment">// 获得一些系统属性！</span></span><br><span class="line">    <span class="keyword">final</span> <span class="keyword">boolean</span> freeformWindowManagement =</span><br><span class="line">            mContext.getPackageManager().hasSystemFeature(FEATURE_FREEFORM_WINDOW_MANAGEMENT)</span><br><span class="line">                    || Settings.Global.getInt(</span><br><span class="line">                            resolver, DEVELOPMENT_ENABLE_FREEFORM_WINDOWS_SUPPORT, <span class="number">0</span>) != <span class="number">0</span>;</span><br><span class="line">    <span class="keyword">final</span> <span class="keyword">boolean</span> supportsPictureInPicture =</span><br><span class="line">            mContext.getPackageManager().hasSystemFeature(FEATURE_PICTURE_IN_PICTURE);</span><br><span class="line">    <span class="comment">// 是否支持分屏</span></span><br><span class="line">    <span class="keyword">final</span> <span class="keyword">boolean</span> supportsMultiWindow = ActivityManager.supportsMultiWindow();</span><br><span class="line">    <span class="keyword">final</span> String debugApp = Settings.Global.getString(resolver, DEBUG_APP);</span><br><span class="line">    <span class="keyword">final</span> <span class="keyword">boolean</span> waitForDebugger = Settings.Global.getInt(resolver, WAIT_FOR_DEBUGGER, <span class="number">0</span>) != <span class="number">0</span>;</span><br><span class="line">    <span class="keyword">final</span> <span class="keyword">boolean</span> alwaysFinishActivities =</span><br><span class="line">            Settings.Global.getInt(resolver, ALWAYS_FINISH_ACTIVITIES, <span class="number">0</span>) != <span class="number">0</span>;</span><br><span class="line">    <span class="keyword">final</span> <span class="keyword">boolean</span> lenientBackgroundCheck =</span><br><span class="line">            Settings.Global.getInt(resolver, LENIENT_BACKGROUND_CHECK, <span class="number">0</span>) != <span class="number">0</span>;</span><br><span class="line">    <span class="keyword">final</span> <span class="keyword">boolean</span> forceRtl = Settings.Global.getInt(resolver, DEVELOPMENT_FORCE_RTL, <span class="number">0</span>) != <span class="number">0</span>;</span><br><span class="line">    <span class="keyword">final</span> <span class="keyword">boolean</span> forceResizable = Settings.Global.getInt(</span><br><span class="line">            resolver, DEVELOPMENT_FORCE_RESIZABLE_ACTIVITIES, <span class="number">0</span>) != <span class="number">0</span>;</span><br><span class="line">    <span class="keyword">final</span> <span class="keyword">boolean</span> supportsLeanbackOnly =</span><br><span class="line">            mContext.getPackageManager().hasSystemFeature(FEATURE_LEANBACK_ONLY);</span><br><span class="line"></span><br><span class="line">    <span class="comment">// Transfer any global setting for forcing RTL layout, into a System Property</span></span><br><span class="line">    SystemProperties.set(DEVELOPMENT_FORCE_RTL, forceRtl ? <span class="string">"1"</span>:<span class="string">"0"</span>);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">final</span> Configuration configuration = <span class="keyword">new</span> Configuration();</span><br><span class="line">    Settings.System.getConfiguration(resolver, configuration);</span><br><span class="line">    <span class="keyword">if</span> (forceRtl) &#123;</span><br><span class="line">        <span class="comment">// This will take care of setting the correct layout direction flags</span></span><br><span class="line">        configuration.setLayoutDirection(configuration.locale);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">synchronized</span> (<span class="keyword">this</span>) &#123;</span><br><span class="line">        mDebugApp = mOrigDebugApp = debugApp;</span><br><span class="line">        mWaitForDebugger = mOrigWaitForDebugger = waitForDebugger;</span><br><span class="line">        mAlwaysFinishActivities = alwaysFinishActivities;</span><br><span class="line">        mLenientBackgroundCheck = lenientBackgroundCheck;</span><br><span class="line">        mSupportsLeanbackOnly = supportsLeanbackOnly;</span><br><span class="line">        mForceResizableActivities = forceResizable;</span><br><span class="line">        mWindowManager.setForceResizableTasks(mForceResizableActivities);</span><br><span class="line">        <span class="keyword">if</span> (supportsMultiWindow || forceResizable) &#123;</span><br><span class="line">            mSupportsMultiWindow = <span class="keyword">true</span>;</span><br><span class="line">            mSupportsFreeformWindowManagement = freeformWindowManagement || forceResizable;</span><br><span class="line">            mSupportsPictureInPicture = supportsPictureInPicture || forceResizable;</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            mSupportsMultiWindow = <span class="keyword">false</span>;</span><br><span class="line">            mSupportsFreeformWindowManagement = <span class="keyword">false</span>;</span><br><span class="line">            mSupportsPictureInPicture = <span class="keyword">false</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">// This happens before any activities are started, so we can</span></span><br><span class="line">        <span class="comment">// change mConfiguration in-place.</span></span><br><span class="line">        updateConfigurationLocked(configuration, <span class="keyword">null</span>, <span class="keyword">true</span>);</span><br><span class="line">        <span class="keyword">if</span> (DEBUG_CONFIGURATION) Slog.v(TAG_CONFIGURATION,</span><br><span class="line">                <span class="string">"Initial config: "</span> + mConfiguration);</span><br><span class="line"></span><br><span class="line">        <span class="comment">// Load resources only after the current configuration has been set.</span></span><br><span class="line">        <span class="keyword">final</span> Resources res = mContext.getResources();</span><br><span class="line">        mHasRecents = res.getBoolean(com.android.internal.R.bool.config_hasRecents);</span><br><span class="line">        mThumbnailWidth = res.getDimensionPixelSize(</span><br><span class="line">                com.android.internal.R.dimen.thumbnail_width);</span><br><span class="line">        mThumbnailHeight = res.getDimensionPixelSize(</span><br><span class="line">                com.android.internal.R.dimen.thumbnail_height);</span><br><span class="line">        mDefaultPinnedStackBounds = Rect.unflattenFromString(res.getString(</span><br><span class="line">                com.android.internal.R.string.config_defaultPictureInPictureBounds));</span><br><span class="line">        mAppErrors.loadAppsNotReportingCrashesFromConfigLocked(res.getString(</span><br><span class="line">                com.android.internal.R.string.config_appsNotReportingCrashes));</span><br><span class="line">        <span class="keyword">if</span> ((mConfiguration.uiMode &amp; UI_MODE_TYPE_TELEVISION) == UI_MODE_TYPE_TELEVISION) &#123;</span><br><span class="line">            mFullscreenThumbnailScale = (<span class="keyword">float</span>) res</span><br><span class="line">                .getInteger(com.android.internal.R.integer.thumbnail_width_tv) /</span><br><span class="line">                (<span class="keyword">float</span>) mConfiguration.screenWidthDp;</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            mFullscreenThumbnailScale = res.getFraction(</span><br><span class="line">                com.android.internal.R.fraction.thumbnail_fullscreen_scale, <span class="number">1</span>, <span class="number">1</span>);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>调用 retrieveSettings() 方法来读取设置，这个方法中读取了几种设置。</p>
<ul>
<li>DEBUG_APP：需要调试的app的名称。</li>
<li>WAIT_FOR_DEBUGGER：值为1表示启动调试的app时要先等待调试器，否则正常启动。</li>
<li>ALWAYS_FINISH_ACTIVITIES：值为1表示Activity不再需要时，系统会立即清除他们。</li>
<li>DEVELOPMENT_FORCE_RTL：值为1表示要将系统设置为从右到左的模式。</li>
<li>LENIENT_BACKGROUND_CHECK。 </li>
<li>DEVELOPMENT_FORCE_RESIZABLE_ACTIVITIES。</li>
</ul>
<p>之后再从资源文件中读取几个缺省的系统配置信息。</p>
<h2 id="4-3-总结"><a href="#4-3-总结" class="headerlink" title="4.3 总结"></a>4.3 总结</h2><p>这里我们来总结一下，三个阶段，都做了什么！</p>
<p>好累，先写到这里吧！</p>
</div></article><div class="post-copyright"><div class="post-copyright__author"><span class="post-copyright-meta">文章作者: </span><span class="post-copyright-info"><a href="mailto:undefined">Coolqi Li</a></span></div><div class="post-copyright__type"><span class="post-copyright-meta">文章链接: </span><span class="post-copyright-info"><a href="http://yoursite.com/2016/02/19/ActivityManager第 2 篇 - AMS 的 Init 和 Start/">http://yoursite.com/2016/02/19/ActivityManager第 2 篇 - AMS 的 Init 和 Start/</a></span></div><div class="post-copyright__notice"><span class="post-copyright-meta">版权声明: </span><span class="post-copyright-info">本博客所有文章除特别声明外，均采用 <a href="https://creativecommons.org/licenses/by-nc-sa/4.0/">CC BY-NC-SA 4.0</a> 许可协议。转载请注明来自 <a href="http://yoursite.com">Coolqi`s Blog</a>！</span></div></div><div class="post-meta__tag-list"><a class="post-meta__tags" href="/tags/ActivityManager活动管理/">ActivityManager活动管理</a></div><div class="post-qr-code"><div class="post-qr-code-item"><img class="post-qr-code__img" src="/img/zfb.jpg"><div class="post-qr-code__desc">支付宝打赏</div></div><div class="post-qr-code-item"><img class="post-qr-code__img" src="/img/wechat.jpg"><div class="post-qr-code__desc">微信打赏</div></div></div><nav id="pagination"><div class="prev-post pull-left"><a href="/2016/03/06/Binder跨进程通信 - 信使 Messenger/"><i class="fa fa-chevron-left">  </i><span>Binder跨进程通信 - 信使 Messenger</span></a></div><div class="next-post pull-right"><a href="/2016/02/15/ActivityManager第 1 篇 - SystemServer 进程和 AMS/"><span>ActivityManager第 1 篇 - SystemServer 进程和 AMS</span><i class="fa fa-chevron-right"></i></a></div></nav><div class="post-adv"><a href="https://www.vultr.com/?ref=7231808"><img src="https://www.vultr.com/media/banner_1.png" width="728" height="90"></a></div></div></div><footer><div class="layout" id="footer"><div class="copyright">&copy;2015 - 2018 By Coolqi Li</div><div class="framework-info"><span>驱动 - </span><a href="http://hexo.io"><span>Hexo</span></a><span class="footer-separator">|</span><span>主题 - </span><a href="https://github.com/Molunerfinn/hexo-theme-melody"><span>Melody</span></a></div><div class="footer_custom_text">Hi, welcome to my <a href="https://molunerfinn.com">blog</a>!</div><div class="busuanzi"><script async src="//dn-lbstatics.qbox.me/busuanzi/2.3/busuanzi.pure.mini.js"></script><span id="busuanzi_container_page_pv"><i class="fa fa-file-o"></i><span id="busuanzi_value_page_pv"></span><span></span></span></div></div></footer><i class="fa fa-arrow-up" id="go-up" aria-hidden="true"></i><script src="/js/third-party/anime.min.js"></script><script src="/js/third-party/jquery.min.js"></script><script src="/js/third-party/jquery.fancybox.min.js"></script><script src="/js/third-party/velocity.min.js"></script><script src="/js/third-party/velocity.ui.min.js"></script><script src="/js/utils.js?version=1.5.6"></script><script src="/js/fancybox.js?version=1.5.6"></script><script src="/js/sidebar.js?version=1.5.6"></script><script src="/js/copy.js?version=1.5.6"></script><script src="/js/fireworks.js?version=1.5.6"></script><script src="/js/transition.js?version=1.5.6"></script><script src="/js/scroll.js?version=1.5.6"></script><script src="/js/head.js?version=1.5.6"></script><script src="/js/search/local-search.js"></script><div class="search-dialog" id="local-search"><div class="search-dialog__title" id="local-search-title">本地搜索</div><div id="local-input-panel"><div id="local-search-input"><div class="local-search-box"><input class="local-search-box--input" placeholder="搜索文章"></div></div></div><hr><div id="local-search-results"><div id="local-hits"></div><div id="local-stats"><div class="local-search-stats__hr" id="hr"><span>由</span> <a href="https://github.com/wzpan/hexo-generator-search" style="color:#49B1F5;">hexo-generator-search</a>
 <span>提供支持</span></div></div></div><span class="search-close-button"><i class="fa fa-times"></i></span></div><div class="search-mask"></div></body></html>
<!DOCTYPE html><html lang="zh-Hans"><head><meta charset="UTF-8"><meta http-equiv="X-UA-Compatible" content="IE=edge"><meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1"><meta name="description" content="BroadcastReceiver篇 4 - BroadcastReceiver 静态注册"><meta name="keywords" content="BroadcastReceiver广播接收者"><meta name="author" content="Coolqi.Li,undefined"><meta name="copyright" content="Coolqi.Li"><title>BroadcastReceiver篇 4 - BroadcastReceiver 静态注册 | Coolqi`s Blog</title><link rel="shortcut icon" href="/img/favicon.ico"><link rel="stylesheet" href="/css/index.css?version=1.5.6"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/font-awesome@4.7.0/css/font-awesome.min.css?version=1.5.6"><link rel="dns-prefetch" href="https://cdn.staticfile.org"><link rel="dns-prefetch" href="https://cdn.bootcss.com"><link rel="dns-prefetch" href="https://creativecommons.org"><script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script><script>(adsbygoogle = window.adsbygoogle || []).push({
  google_ad_client: 'ca-pub-6845729157331145',
  enable_page_level_ads: 'true'
});
</script><link rel="dns-prefetch" href="https://hm.baidu.com"><script>var _hmt = _hmt || [];
(function() {
  var hm = document.createElement("script");
  hm.src = "https://hm.baidu.com/hm.js?b7acef5306e54116ad8a99e8b753a92d";
  var s = document.getElementsByTagName("script")[0]; 
  s.parentNode.insertBefore(hm, s);
})();</script><script>var GLOBAL_CONFIG = { 
  root: '/',
  algolia: undefined,
  localSearch: {"path":"search.xml","languages":{"hits_empty":"找不到您查询的内容:${query}"}},
  copy: {
    success: '复制成功',
    error: '复制错误',
    noSupport: '浏览器不支持'
  }
} </script></head><body><i class="fa fa-arrow-right" id="toggle-sidebar" aria-hidden="true"></i><div id="sidebar"><div class="toggle-sidebar-info text-center"><span data-toggle="切换文章详情">切换站点概览</span><hr></div><div class="sidebar-toc"><div class="sidebar-toc__title">目录</div><div class="sidebar-toc__progress"><span class="progress-notice">你已经读了</span><span class="progress-num">0</span><span class="progress-percentage">%</span><div class="sidebar-toc__progress-bar"></div></div><div class="sidebar-toc__content"><ol class="toc"><li class="toc-item toc-level-1"><a class="toc-link" href="#0-综述"><span class="toc-text">0 综述</span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#1-PackageParser-parseBaseApplication-解析-application"><span class="toc-text">1 PackageParser.parseBaseApplication - 解析 application</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#2-1-PackageParser-parseActivity"><span class="toc-text">2.1 PackageParser.parseActivity</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#2-2-PackageParser-parseIntent"><span class="toc-text">2.2 PackageParser.parseIntent</span></a></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#2-PMS-scanPackageDirtyLI"><span class="toc-text">2 PMS.scanPackageDirtyLI</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#2-1-PMS-ActivityIntentResolver"><span class="toc-text">2.1 PMS.ActivityIntentResolver</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#2-2-IntentResolver-addFilter"><span class="toc-text">2.2 IntentResolver.addFilter</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#2-2-1-IntentResolver-register-intent-filter"><span class="toc-text">2.2.1 IntentResolver.register_intent_filter</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#2-2-2-IntentResolver-addFilter"><span class="toc-text">2.2.2 IntentResolver.addFilter</span></a></li></ol></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#3-PMS-queryIntentReceivers-查询静态接收者"><span class="toc-text">3 PMS.queryIntentReceivers - 查询静态接收者</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#3-1-PackageManagerS-getReceiverInfo-组件名查询"><span class="toc-text">3.1 PackageManagerS.getReceiverInfo - 组件名查询</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#3-1-1-PackageParser-generateActivityInfo"><span class="toc-text">3.1.1 PackageParser.generateActivityInfo</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#3-2-ActivityIntentResolver-queryIntent-意图匹配查询"><span class="toc-text">3.2 ActivityIntentResolver.queryIntent - 意图匹配查询</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#3-2-1-IntentResolver-queryIntent"><span class="toc-text">3.2.1 IntentResolver.queryIntent</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#3-3-ActivityIntentResolver-queryIntentForPackage-包名查询"><span class="toc-text">3.3 ActivityIntentResolver.queryIntentForPackage - 包名查询</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#3-3-1-ActivityIntentResolver-queryIntentFromList"><span class="toc-text">3.3.1 ActivityIntentResolver.queryIntentFromList</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#3-4-IntentResolver-buildResolveList"><span class="toc-text">3.4 IntentResolver.buildResolveList</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#3-4-1-ActivityIntentResolver-ActivityIntentResolver-isFilterStopped"><span class="toc-text">3.4.1 ActivityIntentResolver ActivityIntentResolver.isFilterStopped</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#3-4-2-ActivityIntentResolver-isPackageForFilter"><span class="toc-text">3.4.2 ActivityIntentResolver.isPackageForFilter</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#3-4-3-ActivityIntentResolver-allowFilterResult"><span class="toc-text">3.4.3 ActivityIntentResolver.allowFilterResult</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#3-4-4-ActivityIntentResolver-newResult"><span class="toc-text">3.4.4 ActivityIntentResolver.newResult</span></a></li></ol></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#4-总结！"><span class="toc-text">4 总结！</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#4-1-静态注册类关系图"><span class="toc-text">4.1 静态注册类关系图</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#4-2-查询注册结果关系图"><span class="toc-text">4.2 查询注册结果关系图</span></a></li></ol></li></ol></div></div><div class="author-info hide"><div class="author-info__avatar text-center"><img src="/img/avatar.png"></div><div class="author-info__name text-center">Coolqi.Li</div><div class="author-info__description text-center">“你好，我是李帅奇，Android 系统工程师，MineCraft 忠实玩家，设计和绘画爱好者，缺妹纸晚期患者，熬夜星人。”</div><hr><div class="author-info-articles"><a class="author-info-articles__archives article-meta" href="/archives"><span class="pull-left">文章</span><span class="pull-right">84</span></a><a class="author-info-articles__tags article-meta" href="/tags"><span class="pull-left">标签</span><span class="pull-right">20</span></a><a class="author-info-articles__categories article-meta" href="/categories"><span class="pull-left">分类</span><span class="pull-right">24</span></a></div><hr><div class="author-info-links"><div class="author-info-links__title text-center">Links</div><a class="author-info-links__name text-center" href="https://developer.android.google.cn/">AndroidDeveloper</a><a class="author-info-links__name text-center" href="http://www.android-studio.org/">AndroidStudio</a><a class="author-info-links__name text-center" href="https://www.jianshu.com/u/123a20a96441">简书</a><a class="author-info-links__name text-center" href="https://weibo.com/coolqiLi">微博</a></div></div></div><div id="content-outer"><div id="top-container" style="background-image: url(https://ws1.sinaimg.cn/large/8700af19ly1fvpabr30o6j22yo1o0q7i.jpg)"><div id="page-header"><span class="pull-left"> <a id="site-name" href="/">Coolqi`s Blog</a></span><i class="fa fa-bars toggle-menu pull-right" aria-hidden="true"></i><span class="pull-right menus"><a class="site-page social-icon search"><i class="fa fa-search"></i><span> 搜索</span></a><a class="site-page" href="/">Home</a><a class="site-page" href="/categories">Categories</a><a class="site-page" href="/tags">Tags</a><a class="site-page" href="/archives">Archives</a><a class="site-page" href="/about">About</a></span></div><div id="post-info"><div id="post-title">BroadcastReceiver篇 4 - BroadcastReceiver 静态注册</div><div id="post-meta"><time class="post-meta__date"><i class="fa fa-calendar" aria-hidden="true"></i> 2016-05-08</time><span class="post-meta__separator">|</span><i class="fa fa-inbox post-meta__icon" aria-hidden="true"></i><a class="post-meta__categories" href="/categories/AndroidFramework源码分析/">AndroidFramework源码分析</a><i class="fa fa-angle-right" aria-hidden="true"></i><i class="fa fa-inbox post-meta__icon" aria-hidden="true"></i><a class="post-meta__categories" href="/categories/AndroidFramework源码分析/BroadcastReceiver广播接收者/">BroadcastReceiver广播接收者</a><div class="post-meta-wordcount"><span>字数总计: </span><span class="word-count">5.6k</span><span class="post-meta__separator">|</span><span>阅读时长: 27 分钟</span></div></div></div></div><div class="layout" id="content-inner"><article id="post"><div class="article-container" id="post-content"><p>[toc]</p>
<p>本文基于 Android 7.1.1 源码，分析 BroadcastReceiver 的静态注册过程，转载请说明出处，谢谢！</p>
<h1 id="0-综述"><a href="#0-综述" class="headerlink" title="0 综述"></a>0 综述</h1><p>广播接收者除了动态注册之外，还有静态注册，就是在 AndroidManifest.xml 文件中进行配置！</p>
<figure class="highlight"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">&lt;receiver </span><br><span class="line">    android:enabled=[<span class="string">"true"</span> | <span class="string">"false"</span>]</span><br><span class="line">    android:exported=[<span class="string">"true"</span> | <span class="string">"false"</span>]</span><br><span class="line">    android:icon=<span class="string">"drawable resource"</span></span><br><span class="line">    android:label=<span class="string">"string resource"</span></span><br><span class="line">    android:name=<span class="string">"string"</span></span><br><span class="line">    android:permission=<span class="string">"string"</span></span><br><span class="line">    android:process=<span class="string">"string"</span> &gt;</span><br><span class="line">    &lt;intent-filter&gt;</span><br><span class="line">        &lt;action android:name=<span class="string">"android.intent.action.BOOT_COMPLETED"</span> /&gt;</span><br><span class="line">    &lt;/intent-filter&gt;</span><br><span class="line">&lt;/receiver&gt;</span><br></pre></td></tr></table></figure>
<p>我们来简单地看看这些属性的意思： </p>
<ul>
<li>android:enabled：此 broadcastReceiver 是否可用，默认值为 true。</li>
<li>android:exported：此 broadcastReceiver 能否接收其它 App 的发出的广播，如果标签中定义了 intent-filter 字段，则此值默认值为 true，否则为 false。</li>
<li>android:name：此 BroadcastReceiver 的组件名。</li>
<li>android:permission：广播发送方应该具有的权限； </li>
<li>android:process：表示 broadcastReceiver 运行的进程，BroadcastReceiver 默认运行在当前 app 的进程中，也可以通过此字段指定其运行于其它独立的进程。</li>
<li>intent-filter：用于指定该broadcastReceiver接收广播的类型。</li>
</ul>
<p>静态注册的 BroadcastReceiver 不能作为内部类，必须要单独作为一个 BroadcastReceiver.java 文件！</p>
<p>其实，如果大家对于 PMS 熟悉的话，应该很清楚了，对于静态注册的方式，是会通过 PMS 的解析来获得 BroadcastReceiver 的信息的！！下面我们就到 PMS 中去看看：</p>
<h1 id="1-PackageParser-parseBaseApplication-解析-application"><a href="#1-PackageParser-parseBaseApplication-解析-application" class="headerlink" title="1 PackageParser.parseBaseApplication - 解析 application"></a>1 PackageParser.parseBaseApplication - 解析 application</h1><p>解析的关键的代码段如下，我们简单的回顾下：<br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">boolean</span> <span class="title">parseBaseApplication</span><span class="params">(Package owner, Resources res,</span></span></span><br><span class="line"><span class="function"><span class="params">        XmlResourceParser parser, <span class="keyword">int</span> flags, String[] outError)</span></span></span><br><span class="line"><span class="function">    <span class="keyword">throws</span> XmlPullParserException, IOException </span>&#123;</span><br><span class="line">    ... ... ... ...</span><br><span class="line">    <span class="keyword">while</span> ((type = parser.next()) != XmlPullParser.END_DOCUMENT</span><br><span class="line">            &amp;&amp; (type != XmlPullParser.END_TAG || parser.getDepth() &gt; innerDepth)) &#123;</span><br><span class="line">        <span class="keyword">if</span> (type == XmlPullParser.END_TAG || type == XmlPullParser.TEXT) &#123;</span><br><span class="line">            <span class="keyword">continue</span>;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        String tagName = parser.getName();</span><br><span class="line">        <span class="keyword">if</span> (tagName.equals(<span class="string">"activity"</span>)) &#123;</span><br><span class="line">            Activity a = parseActivity(owner, res, parser, flags, outError, <span class="keyword">false</span>,</span><br><span class="line">                    owner.baseHardwareAccelerated);</span><br><span class="line">            <span class="keyword">if</span> (a == <span class="keyword">null</span>) &#123;</span><br><span class="line">                mParseError = PackageManager.INSTALL_PARSE_FAILED_MANIFEST_MALFORMED;</span><br><span class="line">                <span class="keyword">return</span> <span class="keyword">false</span>;</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            owner.activities.add(a);</span><br><span class="line">        </span><br><span class="line">        <span class="comment">//【2.1】解析 "receiver"，获得静态注册的广播接收者的信息！</span></span><br><span class="line">        &#125; <span class="keyword">else</span> <span class="keyword">if</span> (tagName.equals(<span class="string">"receiver"</span>)) &#123;</span><br><span class="line">            Activity a = parseActivity(owner, res, parser, flags, outError, <span class="keyword">true</span>, <span class="keyword">false</span>);</span><br><span class="line">            <span class="keyword">if</span> (a == <span class="keyword">null</span>) &#123;</span><br><span class="line">                mParseError = PackageManager.INSTALL_PARSE_FAILED_MANIFEST_MALFORMED;</span><br><span class="line">                <span class="keyword">return</span> <span class="keyword">false</span>;</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            <span class="comment">//【1】将解析到的 receiver 加入到 Package owner 中！</span></span><br><span class="line">            owner.receivers.add(a);</span><br><span class="line"></span><br><span class="line">        &#125; </span><br><span class="line">        ... ... ...</span><br><span class="line">    &#125;</span><br><span class="line">    ... ... ... ...</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>可以看到，这里会解析静态注册的广播接收者，并将其信息封装成 Activity 对象保存到了 Package.receivers 对象中去！</p>
<p>我们进入到 PackageParser 的 parseActivity 中去看看！</p>
<h2 id="2-1-PackageParser-parseActivity"><a href="#2-1-PackageParser-parseActivity" class="headerlink" title="2.1 PackageParser.parseActivity"></a>2.1 PackageParser.parseActivity</h2><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">private</span> Activity <span class="title">parseActivity</span><span class="params">(Package owner, Resources res,</span></span></span><br><span class="line"><span class="function"><span class="params">        XmlResourceParser parser, <span class="keyword">int</span> flags, String[] outError,</span></span></span><br><span class="line"><span class="function"><span class="params">        <span class="keyword">boolean</span> receiver, <span class="keyword">boolean</span> hardwareAccelerated)</span></span></span><br><span class="line"><span class="function">        <span class="keyword">throws</span> XmlPullParserException, IOException </span>&#123;</span><br><span class="line"></span><br><span class="line">    TypedArray sa = res.obtainAttributes(parser, R.styleable.AndroidManifestActivity);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (mParseActivityArgs == <span class="keyword">null</span>) &#123;</span><br><span class="line">        mParseActivityArgs = <span class="keyword">new</span> ParseComponentArgs(owner, outError,</span><br><span class="line">                R.styleable.AndroidManifestActivity_name,</span><br><span class="line">                R.styleable.AndroidManifestActivity_label,</span><br><span class="line">                R.styleable.AndroidManifestActivity_icon,</span><br><span class="line">                R.styleable.AndroidManifestActivity_roundIcon,</span><br><span class="line">                R.styleable.AndroidManifestActivity_logo,</span><br><span class="line">                R.styleable.AndroidManifestActivity_banner,</span><br><span class="line">                mSeparateProcesses,</span><br><span class="line">                R.styleable.AndroidManifestActivity_process,</span><br><span class="line">                R.styleable.AndroidManifestActivity_description,</span><br><span class="line">                R.styleable.AndroidManifestActivity_enabled);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    mParseActivityArgs.tag = receiver ? <span class="string">"&lt;receiver&gt;"</span> : <span class="string">"&lt;activity&gt;"</span>;</span><br><span class="line">    mParseActivityArgs.sa = sa;</span><br><span class="line">    mParseActivityArgs.flags = flags;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">//【1】创建了一个 Activity 对象！</span></span><br><span class="line">    Activity a = <span class="keyword">new</span> Activity(mParseActivityArgs, <span class="keyword">new</span> ActivityInfo());</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">if</span> (outError[<span class="number">0</span>] != <span class="keyword">null</span>) &#123;</span><br><span class="line">        sa.recycle();</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">null</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    ... ... ... ...</span><br><span class="line"></span><br><span class="line">    <span class="keyword">int</span> outerDepth = parser.getDepth();</span><br><span class="line">    <span class="keyword">int</span> type;</span><br><span class="line">    <span class="keyword">while</span> ((type=parser.next()) != XmlPullParser.END_DOCUMENT</span><br><span class="line">           &amp;&amp; (type != XmlPullParser.END_TAG</span><br><span class="line">                   || parser.getDepth() &gt; outerDepth)) &#123;</span><br><span class="line">        <span class="keyword">if</span> (type == XmlPullParser.END_TAG || type == XmlPullParser.TEXT) &#123;</span><br><span class="line">            <span class="keyword">continue</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        </span><br><span class="line">        </span><br><span class="line">        <span class="comment">// 解析 "intent-filter" 标签！</span></span><br><span class="line">        <span class="keyword">if</span> (parser.getName().equals(<span class="string">"intent-filter"</span>)) &#123;</span><br><span class="line"></span><br><span class="line">            <span class="comment">//【2】创建 ActivityIntentInfo 对象！</span></span><br><span class="line">            ActivityIntentInfo intent = <span class="keyword">new</span> ActivityIntentInfo(a);</span><br><span class="line">            </span><br><span class="line">            <span class="comment">//【2.2】解析 "intent-filter" 的子标签！</span></span><br><span class="line">            <span class="keyword">if</span> (!parseIntent(res, parser, <span class="keyword">true</span>, <span class="keyword">true</span>, intent, outError)) &#123;</span><br><span class="line">                <span class="keyword">return</span> <span class="keyword">null</span>;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">if</span> (intent.countActions() == <span class="number">0</span>) &#123;</span><br><span class="line">                Slog.w(TAG, <span class="string">"No actions in intent filter at "</span></span><br><span class="line">                        + mArchiveSourcePath + <span class="string">" "</span></span><br><span class="line">                        + parser.getPositionDescription());</span><br><span class="line">            &#125; <span class="keyword">else</span> &#123;</span><br><span class="line"></span><br><span class="line">                <span class="comment">//【4】如果设置了 intent 过滤属性，即 intent.countActions() != 0：</span></span><br><span class="line">                a.intents.add(intent);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125; <span class="keyword">else</span> <span class="keyword">if</span> (!receiver &amp;&amp; parser.getName().equals(<span class="string">"preferred"</span>)) &#123; <span class="comment">// 这个是和 activity 相关的</span></span><br><span class="line">            ActivityIntentInfo intent = <span class="keyword">new</span> ActivityIntentInfo(a);</span><br><span class="line">            <span class="keyword">if</span> (!parseIntent(res, parser, <span class="keyword">false</span>, <span class="keyword">false</span>, intent, outError)) &#123;</span><br><span class="line">                <span class="keyword">return</span> <span class="keyword">null</span>;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">if</span> (intent.countActions() == <span class="number">0</span>) &#123;</span><br><span class="line">                Slog.w(TAG, <span class="string">"No actions in preferred at "</span></span><br><span class="line">                        + mArchiveSourcePath + <span class="string">" "</span></span><br><span class="line">                        + parser.getPositionDescription());</span><br><span class="line">            &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                <span class="keyword">if</span> (owner.preferredActivityFilters == <span class="keyword">null</span>) &#123;</span><br><span class="line">                    owner.preferredActivityFilters = <span class="keyword">new</span> ArrayList&lt;ActivityIntentInfo&gt;();</span><br><span class="line">                &#125;</span><br><span class="line">                owner.preferredActivityFilters.add(intent);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125; <span class="keyword">else</span> <span class="keyword">if</span> (parser.getName().equals(<span class="string">"meta-data"</span>)) &#123;</span><br><span class="line">            <span class="keyword">if</span> ((a.metaData = parseMetaData(res, parser, a.metaData,</span><br><span class="line">                    outError)) == <span class="keyword">null</span>) &#123;</span><br><span class="line">                <span class="keyword">return</span> <span class="keyword">null</span>;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125; <span class="keyword">else</span> <span class="keyword">if</span> (!receiver &amp;&amp; parser.getName().equals(<span class="string">"layout"</span>)) &#123;</span><br><span class="line">            parseLayout(res, parser, a);</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            ... ... ... ...</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (!setExported) &#123;</span><br><span class="line">        a.info.exported = a.intents.size() &gt; <span class="number">0</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> a;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h2 id="2-2-PackageParser-parseIntent"><a href="#2-2-PackageParser-parseIntent" class="headerlink" title="2.2 PackageParser.parseIntent"></a>2.2 PackageParser.parseIntent</h2><p>我们来看看 parseIntent 方法中做过了些什么！</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">boolean</span> <span class="title">parseIntent</span><span class="params">(Resources res, XmlResourceParser parser,</span></span></span><br><span class="line"><span class="function"><span class="params">        <span class="keyword">boolean</span> allowGlobs, <span class="keyword">boolean</span> allowAutoVerify, IntentInfo outInfo, String[] outError)</span></span></span><br><span class="line"><span class="function">        <span class="keyword">throws</span> XmlPullParserException, IOException </span>&#123;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">//【1】这里是解析 "intent-filter" 标签的属性，我们这里不重点关注！</span></span><br><span class="line">    TypedArray sa = res.obtainAttributes(parser,</span><br><span class="line">            com.android.internal.R.styleable.AndroidManifestIntentFilter);</span><br><span class="line"></span><br><span class="line">    ... ... ... ...</span><br><span class="line"></span><br><span class="line">    sa.recycle();</span><br><span class="line"></span><br><span class="line">    <span class="keyword">int</span> outerDepth = parser.getDepth();</span><br><span class="line">    <span class="keyword">int</span> type;</span><br><span class="line">    <span class="keyword">while</span> ((type = parser.next()) != XmlPullParser.END_DOCUMENT</span><br><span class="line">            &amp;&amp; (type != XmlPullParser.END_TAG || parser.getDepth() &gt; outerDepth)) &#123;</span><br><span class="line">        <span class="keyword">if</span> (type == XmlPullParser.END_TAG || type == XmlPullParser.TEXT) &#123;</span><br><span class="line">            <span class="keyword">continue</span>;</span><br><span class="line">        &#125;</span><br><span class="line">       </span><br><span class="line">        String nodeName = parser.getName();</span><br><span class="line"></span><br><span class="line">        <span class="comment">//【2】解析 "action"</span></span><br><span class="line">        <span class="keyword">if</span> (nodeName.equals(<span class="string">"action"</span>)) &#123;</span><br><span class="line">            String value = parser.getAttributeValue(</span><br><span class="line">                    ANDROID_RESOURCES, <span class="string">"name"</span>);</span><br><span class="line">            <span class="keyword">if</span> (value == <span class="keyword">null</span> || value == <span class="string">""</span>) &#123;</span><br><span class="line">                outError[<span class="number">0</span>] = <span class="string">"No value supplied for &lt;android:name&gt;"</span>;</span><br><span class="line">                <span class="keyword">return</span> <span class="keyword">false</span>;</span><br><span class="line">            &#125;</span><br><span class="line">            XmlUtils.skipCurrentTag(parser);</span><br><span class="line">            <span class="comment">//【1】设置 action 属性；</span></span><br><span class="line">            outInfo.addAction(value);</span><br><span class="line"></span><br><span class="line">        <span class="comment">//【3】解析 "category"</span></span><br><span class="line">        &#125; <span class="keyword">else</span> <span class="keyword">if</span> (nodeName.equals(<span class="string">"category"</span>)) &#123;</span><br><span class="line">            String value = parser.getAttributeValue(</span><br><span class="line">                    ANDROID_RESOURCES, <span class="string">"name"</span>); <span class="comment">// android:na</span></span><br><span class="line">            <span class="keyword">if</span> (value == <span class="keyword">null</span> || value == <span class="string">""</span>) &#123;</span><br><span class="line">                outError[<span class="number">0</span>] = <span class="string">"No value supplied for &lt;android:name&gt;"</span>;</span><br><span class="line">                <span class="keyword">return</span> <span class="keyword">false</span>;</span><br><span class="line">            &#125;</span><br><span class="line">            XmlUtils.skipCurrentTag(parser);</span><br><span class="line">            <span class="comment">//【2】设置 category 属性；</span></span><br><span class="line">            outInfo.addCategory(value);</span><br><span class="line">        </span><br><span class="line">        <span class="comment">//【4】解析 "data"</span></span><br><span class="line">        &#125; <span class="keyword">else</span> <span class="keyword">if</span> (nodeName.equals(<span class="string">"data"</span>)) &#123;</span><br><span class="line">            sa = res.obtainAttributes(parser,</span><br><span class="line">                    com.android.internal.R.styleable.AndroidManifestData);</span><br><span class="line"></span><br><span class="line">            String str = sa.getNonConfigurationString(</span><br><span class="line">                    com.android.internal.R.styleable.AndroidManifestData_mimeType, <span class="number">0</span>);</span><br><span class="line">            <span class="keyword">if</span> (str != <span class="keyword">null</span>) &#123;</span><br><span class="line">                <span class="keyword">try</span> &#123;</span><br><span class="line">                    <span class="comment">//【4.2】设置 dataType 属性；</span></span><br><span class="line">                    outInfo.addDataType(str);</span><br><span class="line">                &#125; <span class="keyword">catch</span> (IntentFilter.MalformedMimeTypeException e) &#123;</span><br><span class="line">                    outError[<span class="number">0</span>] = e.toString();</span><br><span class="line">                    sa.recycle();</span><br><span class="line">                    <span class="keyword">return</span> <span class="keyword">false</span>;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            ... ... ... ...</span><br><span class="line"></span><br><span class="line">            sa.recycle();</span><br><span class="line">            XmlUtils.skipCurrentTag(parser);</span><br><span class="line">        &#125; <span class="keyword">else</span> <span class="keyword">if</span> (!RIGID_PARSER) &#123;</span><br><span class="line">            Slog.w(TAG, <span class="string">"Unknown element under &lt;intent-filter&gt;: "</span></span><br><span class="line">                    + parser.getName() + <span class="string">" at "</span> + mArchiveSourcePath + <span class="string">" "</span></span><br><span class="line">                    + parser.getPositionDescription());</span><br><span class="line">            XmlUtils.skipCurrentTag(parser);</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            outError[<span class="number">0</span>] = <span class="string">"Bad element under &lt;intent-filter&gt;: "</span> + parser.getName();</span><br><span class="line">            <span class="keyword">return</span> <span class="keyword">false</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    outInfo.hasDefault = outInfo.hasCategory(Intent.CATEGORY_DEFAULT);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (DEBUG_PARSER) &#123;</span><br><span class="line"></span><br><span class="line">        ... ... ...</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">true</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>其实看到这里，我们已经能够看出静态注册的 broadcastReceiver 是如何被 PMS 解析了，解析的数据都会被保存到 PackageParser.Package 中！</p>
<h1 id="2-PMS-scanPackageDirtyLI"><a href="#2-PMS-scanPackageDirtyLI" class="headerlink" title="2 PMS.scanPackageDirtyLI"></a>2 PMS.scanPackageDirtyLI</h1><p>接下来，PMS 会进一步处理解析的数据！<br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">private</span> PackageParser.<span class="function">Package <span class="title">scanPackageDirtyLI</span><span class="params">(PackageParser.Package pkg,</span></span></span><br><span class="line"><span class="function"><span class="params">        <span class="keyword">final</span> <span class="keyword">int</span> policyFlags, <span class="keyword">final</span> <span class="keyword">int</span> scanFlags, <span class="keyword">long</span> currentTime, UserHandle user)</span></span></span><br><span class="line"><span class="function">        <span class="keyword">throws</span> PackageManagerException </span>&#123;</span><br><span class="line"></span><br><span class="line">        ... ... ...</span><br><span class="line">        </span><br><span class="line">        <span class="comment">//【1】将解析到的 BroadcastRecord 数据保存到 PMS 的内部变量 mReceivers 中！</span></span><br><span class="line">        N = pkg.receivers.size();</span><br><span class="line">        r = <span class="keyword">null</span>;</span><br><span class="line">        <span class="keyword">for</span> (i=<span class="number">0</span>; i&lt;N; i++) &#123;</span><br><span class="line"></span><br><span class="line">            <span class="comment">//【2】获得该 package 中静态注册的广播接收者的信息对象 Activity；</span></span><br><span class="line">            PackageParser.Activity a = pkg.receivers.get(i);</span><br><span class="line"></span><br><span class="line">            a.info.processName = fixProcessName(pkg.applicationInfo.processName,</span><br><span class="line">                    a.info.processName, pkg.applicationInfo.uid);</span><br><span class="line">            </span><br><span class="line">            <span class="comment">//【3】添加到 PMS.mReceivers 中;</span></span><br><span class="line">            mReceivers.addActivity(a, <span class="string">"receiver"</span>);</span><br><span class="line">            </span><br><span class="line">            <span class="keyword">if</span> ((policyFlags&amp;PackageParser.PARSE_CHATTY) != <span class="number">0</span>) &#123;</span><br><span class="line">                <span class="keyword">if</span> (r == <span class="keyword">null</span>) &#123;</span><br><span class="line">                    r = <span class="keyword">new</span> StringBuilder(<span class="number">256</span>);</span><br><span class="line">                &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                    r.append(<span class="string">' '</span>);</span><br><span class="line">                &#125;</span><br><span class="line">                r.append(a.info.name);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (r != <span class="keyword">null</span>) &#123;</span><br><span class="line">            <span class="keyword">if</span> (DEBUG_PACKAGE_SCANNING) Log.d(TAG, <span class="string">"  Receivers: "</span> + r);</span><br><span class="line">        &#125;</span><br><span class="line">        </span><br><span class="line">        ... ...</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>将之前是扫描解析到的信息对象 Activity，保存到 PMS.mReceivers 对象中，mReceivers 是一个 ActivityIntentResolver 类的对象，用于保存系统中定义的所有的静态接收者：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// All available receivers, for your resolving pleasure.</span></span><br><span class="line"><span class="keyword">final</span> ActivityIntentResolver mReceivers =</span><br><span class="line">        <span class="keyword">new</span> ActivityIntentResolver();</span><br></pre></td></tr></table></figure>
<p>我们继续分析！</p>
<h2 id="2-1-PMS-ActivityIntentResolver"><a href="#2-1-PMS-ActivityIntentResolver" class="headerlink" title="2.1 PMS.ActivityIntentResolver"></a>2.1 PMS.ActivityIntentResolver</h2><p>我们来看下 ActivityIntentResolver 是如何处理静态接收者的注册的！</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">final</span> <span class="class"><span class="keyword">class</span> <span class="title">ActivityIntentResolver</span></span></span><br><span class="line"><span class="class">        <span class="keyword">extends</span> <span class="title">IntentResolver</span>&lt;<span class="title">PackageParser</span>.<span class="title">ActivityIntentInfo</span>, <span class="title">ResolveInfo</span>&gt; </span>&#123;</span><br><span class="line"></span><br><span class="line">    ... ... ... ...</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">final</span> <span class="keyword">void</span> <span class="title">addActivity</span><span class="params">(PackageParser.Activity a, String type)</span> </span>&#123;</span><br><span class="line">        <span class="comment">//【1】key 为广播接收者组件名，value 为 PackageParser.Activity 对象，保存到内部的 mActivities 哈希表中！</span></span><br><span class="line">        mActivities.put(a.getComponentName(), a);</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (DEBUG_SHOW_INFO)</span><br><span class="line">            Log.v(</span><br><span class="line">            TAG, <span class="string">"  "</span> + type + <span class="string">" "</span> +</span><br><span class="line">            (a.info.nonLocalizedLabel != <span class="keyword">null</span> ? a.info.nonLocalizedLabel : a.info.name) + <span class="string">":"</span>);</span><br><span class="line">        <span class="keyword">if</span> (DEBUG_SHOW_INFO)</span><br><span class="line">            Log.v(TAG, <span class="string">"    Class="</span> + a.info.name);</span><br><span class="line">        </span><br><span class="line">        <span class="comment">//【2】处理对应的 ActivityIntentInfo 对象！</span></span><br><span class="line">        <span class="keyword">final</span> <span class="keyword">int</span> NI = a.intents.size();</span><br><span class="line">        <span class="keyword">for</span> (<span class="keyword">int</span> j=<span class="number">0</span>; j&lt;NI; j++) &#123;</span><br><span class="line">            PackageParser.ActivityIntentInfo intent = a.intents.get(j);</span><br><span class="line"></span><br><span class="line">            <span class="keyword">if</span> (<span class="string">"activity"</span>.equals(type)) &#123; <span class="comment">// 因为我们的 type 是 "receiver" ，所以不进入该分支！</span></span><br><span class="line">                <span class="keyword">final</span> PackageSetting ps =</span><br><span class="line">                        mSettings.getDisabledSystemPkgLPr(intent.activity.info.packageName);</span><br><span class="line">                <span class="keyword">final</span> List&lt;PackageParser.Activity&gt; systemActivities =</span><br><span class="line">                        ps != <span class="keyword">null</span> &amp;&amp; ps.pkg != <span class="keyword">null</span> ? ps.pkg.activities : <span class="keyword">null</span>;</span><br><span class="line">                adjustPriority(systemActivities, intent);</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            <span class="keyword">if</span> (DEBUG_SHOW_INFO) &#123;</span><br><span class="line">                Log.v(TAG, <span class="string">"    IntentFilter:"</span>);</span><br><span class="line">                intent.dump(<span class="keyword">new</span> LogPrinter(Log.VERBOSE, TAG), <span class="string">"      "</span>);</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">if</span> (!intent.debugCheck()) &#123;</span><br><span class="line">                Log.w(TAG, <span class="string">"==&gt; For Activity "</span> + a.info.name);</span><br><span class="line">            &#125;</span><br><span class="line">            </span><br><span class="line">            <span class="comment">//【2.2】调用了父类的 addFilter 方法；</span></span><br><span class="line">            addFilter(intent);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    ... ... ... ...</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 内部集合，存储解析到的组件！</span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> ArrayMap&lt;ComponentName, PackageParser.Activity&gt; mActivities</span><br><span class="line">            = <span class="keyword">new</span> ArrayMap&lt;ComponentName, PackageParser.Activity&gt;();</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">int</span> mFlags;            </span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>ActivityIntentResolver 继承了 IntentResolver，IntentResolver 是一个模板类：</p>
<h2 id="2-2-IntentResolver-addFilter"><a href="#2-2-IntentResolver-addFilter" class="headerlink" title="2.2 IntentResolver.addFilter"></a>2.2 IntentResolver.addFilter</h2><p>这里 F 是 PackageParser.ActivityIntentInfo， R 是 ResolveInfo：<br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">abstract</span> <span class="class"><span class="keyword">class</span> <span class="title">IntentResolver</span>&lt;<span class="title">F</span> <span class="keyword">extends</span> <span class="title">IntentFilter</span>, <span class="title">R</span> <span class="keyword">extends</span> <span class="title">Object</span>&gt; </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//【1】调用了 addFilter 方法！</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">addFilter</span><span class="params">(F f)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">if</span> (localLOGV) &#123;</span><br><span class="line">            Slog.v(TAG, <span class="string">"Adding filter: "</span> + f);</span><br><span class="line">            f.dump(<span class="keyword">new</span> LogPrinter(Log.VERBOSE, TAG, Log.LOG_ID_SYSTEM), <span class="string">"      "</span>);</span><br><span class="line">            Slog.v(TAG, <span class="string">"    Building Lookup Maps:"</span>);</span><br><span class="line">        &#125;</span><br><span class="line">        </span><br><span class="line">        <span class="comment">//【2】添加到内部总集合 mFilters 中！</span></span><br><span class="line">        mFilters.add(f);</span><br><span class="line">        <span class="comment">//【3】根据 filter 属性配置，添加到不同的子集合中！</span></span><br><span class="line">        <span class="comment">//【3.1】处理 Scheme；</span></span><br><span class="line">        <span class="keyword">int</span> numS = register_intent_filter(f, f.schemesIterator(),</span><br><span class="line">                mSchemeToFilter, <span class="string">"      Scheme: "</span>);</span><br><span class="line">        <span class="comment">//【3.2】处理 Type；</span></span><br><span class="line">        <span class="keyword">int</span> numT = register_mime_types(f, <span class="string">"      Type: "</span>);</span><br><span class="line">        <span class="comment">//【3.3】处理 Action；</span></span><br><span class="line">        <span class="keyword">if</span> (numS == <span class="number">0</span> &amp;&amp; numT == <span class="number">0</span>) &#123;</span><br><span class="line">            register_intent_filter(f, f.actionsIterator(),</span><br><span class="line">                    mActionToFilter, <span class="string">"      Action: "</span>);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">//【3.4】处理 TypedAction；</span></span><br><span class="line">        <span class="keyword">if</span> (numT != <span class="number">0</span>) &#123;</span><br><span class="line">            register_intent_filter(f, f.actionsIterator(),</span><br><span class="line">                    mTypedActionToFilter, <span class="string">"      TypedAction: "</span>);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> ArraySet&lt;F&gt; mFilters = <span class="keyword">new</span> ArraySet&lt;F&gt;(); <span class="comment">// 所有注册的 filter</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>这里我们就是实现了对静态注册的广播接收者的处理！！</p>
<h3 id="2-2-1-IntentResolver-register-intent-filter"><a href="#2-2-1-IntentResolver-register-intent-filter" class="headerlink" title="2.2.1 IntentResolver.register_intent_filter"></a>2.2.1 IntentResolver.register_intent_filter</h3><p>register_intent_filter 用于注册 filter ，并返回注册的数量，对于参数，我们以 mSchemeToFilter 为例：</p>
<p><strong>F filter</strong>：这里是我们解析的 intentFilter 的 ActivityIntentInfo 对象！</p>
<p><strong>Iterator<string> i</string></strong>：f.schemesIterator()，是一个 Scheme 迭代器，用于遍历该 filter 设置的所有的 Scheme；</p>
<p><strong>ArrayMap&lt;String, F[]&gt; dest</strong>：是我们要加入集合，这里是 mSchemeToFilter；</p>
<p><strong>String prefix</strong>：用于 log，不过多关注！</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">final</span> <span class="keyword">int</span> <span class="title">register_intent_filter</span><span class="params">(F filter, Iterator&lt;String&gt; i,</span></span></span><br><span class="line"><span class="function"><span class="params">        ArrayMap&lt;String, F[]&gt; dest, String prefix)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">if</span> (i == <span class="keyword">null</span>) &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">int</span> num = <span class="number">0</span>;</span><br><span class="line">    <span class="keyword">while</span> (i.hasNext()) &#123;</span><br><span class="line">        <span class="comment">//【1】这里返回的就是 android:name 属性对应的值！</span></span><br><span class="line">        String name = i.next();</span><br><span class="line">        num++;</span><br><span class="line">        <span class="keyword">if</span> (localLOGV) Slog.v(TAG, prefix + name);</span><br><span class="line">        <span class="comment">//【2.2.2】继续处理！</span></span><br><span class="line">        addFilter(dest, name, filter);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> num;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h3 id="2-2-2-IntentResolver-addFilter"><a href="#2-2-2-IntentResolver-addFilter" class="headerlink" title="2.2.2 IntentResolver.addFilter"></a>2.2.2 IntentResolver.addFilter</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">final</span> <span class="keyword">void</span> <span class="title">addFilter</span><span class="params">(ArrayMap&lt;String, F[]&gt; map, String name, F filter)</span> </span>&#123;</span><br><span class="line">    F[] array = map.get(name);</span><br><span class="line">    <span class="keyword">if</span> (array == <span class="keyword">null</span>) &#123;</span><br><span class="line">        array = newArray(<span class="number">2</span>);</span><br><span class="line">        map.put(name,  array);</span><br><span class="line">        array[<span class="number">0</span>] = filter; <span class="comment">//【1】保存到 array[0] 中！</span></span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        <span class="keyword">final</span> <span class="keyword">int</span> N = array.length;</span><br><span class="line">        <span class="keyword">int</span> i = N;</span><br><span class="line">        <span class="keyword">while</span> (i &gt; <span class="number">0</span> &amp;&amp; array[i-<span class="number">1</span>] == <span class="keyword">null</span>) &#123;</span><br><span class="line">            i--;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">if</span> (i &lt; N) &#123;</span><br><span class="line">            <span class="comment">//【2】插入到末尾！</span></span><br><span class="line">            array[i] = filter;</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            <span class="comment">//【3】扩充数组为之前的 3/2 倍，插入到末尾！</span></span><br><span class="line">            F[] newa = newArray((N*<span class="number">3</span>)/<span class="number">2</span>);</span><br><span class="line">            System.arraycopy(array, <span class="number">0</span>, newa, <span class="number">0</span>, N);</span><br><span class="line">            newa[N] = filter;</span><br><span class="line">            map.put(name, newa);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>当我们要发送广播时，是要查找当前系统中所有已经静态注册的广播接收者的，那么我们去看看查询相关的方法：</p>
<h1 id="3-PMS-queryIntentReceivers-查询静态接收者"><a href="#3-PMS-queryIntentReceivers-查询静态接收者" class="headerlink" title="3 PMS.queryIntentReceivers - 查询静态接收者"></a>3 PMS.queryIntentReceivers - 查询静态接收者</h1><p>查询静态注册的广播接收者方法如下：<br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="keyword">public</span> <span class="meta">@NonNull</span> <span class="function">ParceledListSlice&lt;ResolveInfo&gt; <span class="title">queryIntentReceivers</span><span class="params">(Intent intent,</span></span></span><br><span class="line"><span class="function"><span class="params">        String resolvedType, <span class="keyword">int</span> flags, <span class="keyword">int</span> userId)</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">new</span> ParceledListSlice&lt;&gt;(</span><br><span class="line">            queryIntentReceiversInternal(intent, resolvedType, flags, userId));</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>最终会调用：<br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">private</span> <span class="meta">@NonNull</span> <span class="function">List&lt;ResolveInfo&gt; <span class="title">queryIntentReceiversInternal</span><span class="params">(Intent intent,</span></span></span><br><span class="line"><span class="function"><span class="params">        String resolvedType, <span class="keyword">int</span> flags, <span class="keyword">int</span> userId)</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//【1】如果不存在这个设备用户 id，就返回一个数据为 null 的 list；</span></span><br><span class="line">    <span class="keyword">if</span> (!sUserManager.exists(userId)) <span class="keyword">return</span> Collections.emptyList();</span><br><span class="line"></span><br><span class="line">    flags = updateFlagsForResolve(flags, userId, intent);</span><br><span class="line"></span><br><span class="line">    ComponentName comp = intent.getComponent();</span><br><span class="line">    <span class="keyword">if</span> (comp == <span class="keyword">null</span>) &#123;</span><br><span class="line">        <span class="keyword">if</span> (intent.getSelector() != <span class="keyword">null</span>) &#123;</span><br><span class="line">            intent = intent.getSelector();</span><br><span class="line">            comp = intent.getComponent();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//【2】如果 Intent 设置了组件名，就通过组件名直接获取！</span></span><br><span class="line">    <span class="keyword">if</span> (comp != <span class="keyword">null</span>) &#123;</span><br><span class="line">        List&lt;ResolveInfo&gt; list = <span class="keyword">new</span> ArrayList&lt;ResolveInfo&gt;(<span class="number">1</span>);</span><br><span class="line">        <span class="comment">//【3.1】创建 ResolveInfo 的 list 列表，用于保存匹配结果！</span></span><br><span class="line">        ActivityInfo ai = getReceiverInfo(comp, flags, userId);</span><br><span class="line">        <span class="keyword">if</span> (ai != <span class="keyword">null</span>) &#123;</span><br><span class="line">            ResolveInfo ri = <span class="keyword">new</span> ResolveInfo();</span><br><span class="line">            ri.activityInfo = ai;</span><br><span class="line">            list.add(ri);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> list;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">synchronized</span> (mPackages) &#123;</span><br><span class="line"></span><br><span class="line">        <span class="comment">//【2】如果 Intent 没有设置组件名和包名，就调用 queryIntent 进行查询！</span></span><br><span class="line">        String pkgName = intent.getPackage();</span><br><span class="line">        <span class="keyword">if</span> (pkgName == <span class="keyword">null</span>) &#123;</span><br><span class="line">            <span class="comment">//【3.2】使用 queryIntent 方法！</span></span><br><span class="line">            <span class="keyword">return</span> mReceivers.queryIntent(intent, resolvedType, flags, userId);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment">//【3】如果 Intent 没有设置组件名，但是设置了包名，就通过之前的扫描解析信息，查询！</span></span><br><span class="line">        <span class="keyword">final</span> PackageParser.Package pkg = mPackages.get(pkgName);</span><br><span class="line">        <span class="keyword">if</span> (pkg != <span class="keyword">null</span>) &#123;</span><br><span class="line">            <span class="comment">//【3.3】使用 queryIntentForPackage 根据包名查询，mReceivers 中保存了解析到的所有的；</span></span><br><span class="line">            <span class="keyword">return</span> mReceivers.queryIntentForPackage(intent, resolvedType, flags, pkg.receivers,</span><br><span class="line">                    userId);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> Collections.emptyList();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>下面我们一个一个去看看：</p>
<h2 id="3-1-PackageManagerS-getReceiverInfo-组件名查询"><a href="#3-1-PackageManagerS-getReceiverInfo-组件名查询" class="headerlink" title="3.1 PackageManagerS.getReceiverInfo - 组件名查询"></a>3.1 PackageManagerS.getReceiverInfo - 组件名查询</h2><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> ActivityInfo <span class="title">getReceiverInfo</span><span class="params">(ComponentName component, <span class="keyword">int</span> flags, <span class="keyword">int</span> userId)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">if</span> (!sUserManager.exists(userId)) <span class="keyword">return</span> <span class="keyword">null</span>;</span><br><span class="line">    </span><br><span class="line">    flags = updateFlagsForComponent(flags, userId, component);</span><br><span class="line">    enforceCrossUserPermission(Binder.getCallingUid(), userId,</span><br><span class="line">            <span class="keyword">false</span> <span class="comment">/* requireFullPermission */</span>, <span class="keyword">false</span> <span class="comment">/* checkShell */</span>, <span class="string">"get receiver info"</span>);</span><br><span class="line">    <span class="keyword">synchronized</span> (mPackages) &#123;</span><br><span class="line">        <span class="comment">//【1】直接通过组件名获得对应的 PackageParser.Activity 对象，封装了 receiver 的信息！</span></span><br><span class="line">        PackageParser.Activity a = mReceivers.mActivities.get(component);</span><br><span class="line">        <span class="keyword">if</span> (DEBUG_PACKAGE_INFO) Log.v(</span><br><span class="line">            TAG, <span class="string">"getReceiverInfo "</span> + component + <span class="string">": "</span> + a);</span><br><span class="line">        <span class="keyword">if</span> (a != <span class="keyword">null</span> &amp;&amp; mSettings.isEnabledAndMatchLPr(a.info, flags, userId)) &#123;</span><br><span class="line">        </span><br><span class="line">            <span class="comment">//【2】如果对应的 PackageSetting 对象为 null，说明应用没有安装，返回 null</span></span><br><span class="line">            PackageSetting ps = mSettings.mPackages.get(component.getPackageName());</span><br><span class="line">            <span class="keyword">if</span> (ps == <span class="keyword">null</span>) <span class="keyword">return</span> <span class="keyword">null</span>;</span><br><span class="line">            </span><br><span class="line">            <span class="comment">//【3.1.1】调用 PackageParser 的 generateActivityInfo 方法继续查询！</span></span><br><span class="line">            <span class="keyword">return</span> PackageParser.generateActivityInfo(a, flags, ps.readUserState(userId),</span><br><span class="line">                    userId);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">null</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>继续看：</p>
<h3 id="3-1-1-PackageParser-generateActivityInfo"><a href="#3-1-1-PackageParser-generateActivityInfo" class="headerlink" title="3.1.1 PackageParser.generateActivityInfo"></a>3.1.1 PackageParser.generateActivityInfo</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> ActivityInfo <span class="title">generateActivityInfo</span><span class="params">(Activity a, <span class="keyword">int</span> flags,</span></span></span><br><span class="line"><span class="function"><span class="params">        PackageUserState state, <span class="keyword">int</span> userId)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">if</span> (a == <span class="keyword">null</span>) <span class="keyword">return</span> <span class="keyword">null</span>;</span><br><span class="line">    <span class="comment">//【1】判断应用是否安装或者隐藏；</span></span><br><span class="line">    <span class="keyword">if</span> (!checkUseInstalledOrHidden(flags, state)) &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">null</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">//【2】判断是否需要 copy 一份数据，如果不需要就直接返回 mReceivers 中解析到的！</span></span><br><span class="line">    <span class="keyword">if</span> (!copyNeeded(flags, a.owner, state, a.metaData, userId)) &#123;</span><br><span class="line">        <span class="keyword">return</span> a.info;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//【3】获得 Activity 内部的 ActivityInfo 对象的拷贝！</span></span><br><span class="line">    ActivityInfo ai = <span class="keyword">new</span> ActivityInfo(a.info);</span><br><span class="line">    ai.metaData = a.metaData;</span><br><span class="line">    <span class="comment">//【4】拷贝封装需要的信息</span></span><br><span class="line">    ai.applicationInfo = generateApplicationInfo(a.owner, flags, state, userId);</span><br><span class="line">    <span class="keyword">return</span> ai;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>这里很简单，返回了之前解析获得的广播接收者的 ActivityInfo 对象 ai！</p>
<p>然后，创建 ResolveInfo ri = new ResolveInfo() 对象，然后初始化 ri.activityInfo = ai，将 ResolveInfo 对象 ri 添加到 List<resolveinfo> 返回！</resolveinfo></p>
<h2 id="3-2-ActivityIntentResolver-queryIntent-意图匹配查询"><a href="#3-2-ActivityIntentResolver-queryIntent-意图匹配查询" class="headerlink" title="3.2 ActivityIntentResolver.queryIntent - 意图匹配查询"></a>3.2 ActivityIntentResolver.queryIntent - 意图匹配查询</h2><p>这里先会调用子类 ActivityIntentResolver 的 queryIntent 方法！</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> List&lt;ResolveInfo&gt; <span class="title">queryIntent</span><span class="params">(Intent intent, String resolvedType, <span class="keyword">int</span> flags,</span></span></span><br><span class="line"><span class="function"><span class="params">        <span class="keyword">int</span> userId)</span> </span>&#123;</span><br><span class="line">    <span class="comment">//【1】userId 不存在，返回 null</span></span><br><span class="line">    <span class="keyword">if</span> (!sUserManager.exists(userId)) <span class="keyword">return</span> <span class="keyword">null</span>;</span><br><span class="line">    mFlags = flags;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">//【3.2.1】调用父类的 queryIntent 方法继续查询！</span></span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">super</span>.queryIntent(intent, resolvedType,</span><br><span class="line">            (flags &amp; PackageManager.MATCH_DEFAULT_ONLY) != <span class="number">0</span>, userId);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>进入父类 IntentResolver：</p>
<h3 id="3-2-1-IntentResolver-queryIntent"><a href="#3-2-1-IntentResolver-queryIntent" class="headerlink" title="3.2.1 IntentResolver.queryIntent"></a>3.2.1 IntentResolver.queryIntent</h3><p>这里的模板参数 R 为 ResolveInfo 类：<br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> List&lt;R&gt; <span class="title">queryIntent</span><span class="params">(Intent intent, String resolvedType, <span class="keyword">boolean</span> defaultOnly,</span></span></span><br><span class="line"><span class="function"><span class="params">        <span class="keyword">int</span> userId)</span> </span>&#123;</span><br><span class="line">    String scheme = intent.getScheme();</span><br><span class="line"></span><br><span class="line">    <span class="comment">//【1】最终要返回的 ArrayList&lt;R&gt; list 集合！</span></span><br><span class="line">    ArrayList&lt;R&gt; finalList = <span class="keyword">new</span> ArrayList&lt;R&gt;();</span><br><span class="line"></span><br><span class="line">    <span class="keyword">final</span> <span class="keyword">boolean</span> debug = localLOGV ||</span><br><span class="line">            ((intent.getFlags() &amp; Intent.FLAG_DEBUG_LOG_RESOLUTION) != <span class="number">0</span>);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (debug) Slog.v(</span><br><span class="line">        TAG, <span class="string">"Resolving type="</span> + resolvedType + <span class="string">" scheme="</span> + scheme</span><br><span class="line">        + <span class="string">" defaultOnly="</span> + defaultOnly + <span class="string">" userId="</span> + userId + <span class="string">" of "</span> + intent);</span><br><span class="line"></span><br><span class="line">    F[] firstTypeCut = <span class="keyword">null</span>;</span><br><span class="line">    F[] secondTypeCut = <span class="keyword">null</span>;</span><br><span class="line">    F[] thirdTypeCut = <span class="keyword">null</span>;</span><br><span class="line">    F[] schemeCut = <span class="keyword">null</span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//【2】如果 intent 包含一个 MIME type，我们会手机所有能匹配该 MIME 的 filters！</span></span><br><span class="line">    <span class="comment">// MIME 是描述消息内容类型的因特网标准，格式如下：application/pdf</span></span><br><span class="line">    <span class="keyword">if</span> (resolvedType != <span class="keyword">null</span>) &#123;</span><br><span class="line">        <span class="keyword">int</span> slashpos = resolvedType.indexOf(<span class="string">'/'</span>);</span><br><span class="line">        <span class="comment">//【2.1】校验指定的 MIME 的格式是否正确，必须要有 / 隔开！</span></span><br><span class="line">        <span class="keyword">if</span> (slashpos &gt; <span class="number">0</span>) &#123;</span><br><span class="line">            <span class="comment">//【2.1.1】获得 MIME 的前半部分：application，针对其取值做不同的处理！</span></span><br><span class="line">            <span class="keyword">final</span> String baseType = resolvedType.substring(<span class="number">0</span>, slashpos);</span><br><span class="line">            <span class="keyword">if</span> (!baseType.equals(<span class="string">"*"</span>)) &#123;</span><br><span class="line">                <span class="comment">//【2.1.1.1】如果 baseType 不为 *，说明 intent 可能指定了一个 MIME，接下来，我们继续处理！</span></span><br><span class="line">                <span class="keyword">if</span> (resolvedType.length() != slashpos+<span class="number">2</span></span><br><span class="line">                        || resolvedType.charAt(slashpos+<span class="number">1</span>) != <span class="string">'*'</span>) &#123;</span><br><span class="line">                    <span class="comment">// Not a wild card, so we can just look for all filters that</span></span><br><span class="line">                    <span class="comment">// completely match or wildcards whose base type matches.</span></span><br><span class="line">                    <span class="comment">//【2.1.1.1.1】如果 resolvedType</span></span><br><span class="line">                    firstTypeCut = mTypeToFilter.get(resolvedType);</span><br><span class="line">                    <span class="keyword">if</span> (debug) Slog.v(TAG, <span class="string">"First type cut: "</span> + Arrays.toString(firstTypeCut));</span><br><span class="line">                    secondTypeCut = mWildTypeToFilter.get(baseType);</span><br><span class="line">                    <span class="keyword">if</span> (debug) Slog.v(TAG, <span class="string">"Second type cut: "</span></span><br><span class="line">                            + Arrays.toString(secondTypeCut));</span><br><span class="line"></span><br><span class="line">                &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                    <span class="comment">//【2.1.1.1.2】如果 resolvedType 的长度等于 slashpos + 2，且 slashpos + 1 为 "*"</span></span><br><span class="line">                    <span class="comment">// 那么其能够匹配所有的 "baseType/*"</span></span><br><span class="line">                    firstTypeCut = mBaseTypeToFilter.get(baseType);</span><br><span class="line">                    <span class="keyword">if</span> (debug) Slog.v(TAG, <span class="string">"First type cut: "</span> + Arrays.toString(firstTypeCut));</span><br><span class="line">                    secondTypeCut = mWildTypeToFilter.get(baseType);</span><br><span class="line">                    <span class="keyword">if</span> (debug) Slog.v(TAG, <span class="string">"Second type cut: "</span></span><br><span class="line">                            + Arrays.toString(secondTypeCut));</span><br><span class="line"></span><br><span class="line">                &#125;</span><br><span class="line">                <span class="comment">// Any */* types always apply, but we only need to do this</span></span><br><span class="line">                <span class="comment">// if the intent type was not already */*.</span></span><br><span class="line">                thirdTypeCut = mWildTypeToFilter.get(<span class="string">"*"</span>);</span><br><span class="line">                <span class="keyword">if</span> (debug) Slog.v(TAG, <span class="string">"Third type cut: "</span> + Arrays.toString(thirdTypeCut));</span><br><span class="line"></span><br><span class="line">            &#125; <span class="keyword">else</span> <span class="keyword">if</span> (intent.getAction() != <span class="keyword">null</span>) &#123;</span><br><span class="line">                <span class="comment">//【2.1.1.2】如果 baseType 为 *，说明是通过正则表达式匹配任何类型的 filters</span></span><br><span class="line">                <span class="comment">// 这种情况会有风险，那就使用 action 来匹配！</span></span><br><span class="line">                firstTypeCut = mTypedActionToFilter.get(intent.getAction());</span><br><span class="line">                <span class="keyword">if</span> (debug) Slog.v(TAG, <span class="string">"Typed Action list: "</span> + Arrays.toString(firstTypeCut));</span><br><span class="line"></span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//【3】如果 intent 设置了 scheme（data URI），收集所有能匹配该 scheme 的 filter！</span></span><br><span class="line">    <span class="keyword">if</span> (scheme != <span class="keyword">null</span>) &#123;</span><br><span class="line">        schemeCut = mSchemeToFilter.get(scheme);</span><br><span class="line">        <span class="keyword">if</span> (debug) Slog.v(TAG, <span class="string">"Scheme list: "</span> + Arrays.toString(schemeCut));</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//【4】intent 没有设置 Scheme 和 MIME，那就匹配 action！</span></span><br><span class="line">    <span class="keyword">if</span> (resolvedType == <span class="keyword">null</span> &amp;&amp; scheme == <span class="keyword">null</span> &amp;&amp; intent.getAction() != <span class="keyword">null</span>) &#123;</span><br><span class="line">        firstTypeCut = mActionToFilter.get(intent.getAction());</span><br><span class="line">        <span class="keyword">if</span> (debug) Slog.v(TAG, <span class="string">"Action list: "</span> + Arrays.toString(firstTypeCut));</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="comment">//【3.4】开始进一步的匹配，将结果保存到 finalList 中！</span></span><br><span class="line">    FastImmutableArraySet&lt;String&gt; categories = getFastIntentCategories(intent);</span><br><span class="line">    <span class="keyword">if</span> (firstTypeCut != <span class="keyword">null</span>) &#123;</span><br><span class="line">        buildResolveList(intent, categories, debug, defaultOnly,</span><br><span class="line">                resolvedType, scheme, firstTypeCut, finalList, userId);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span> (secondTypeCut != <span class="keyword">null</span>) &#123;</span><br><span class="line">        buildResolveList(intent, categories, debug, defaultOnly,</span><br><span class="line">                resolvedType, scheme, secondTypeCut, finalList, userId);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span> (thirdTypeCut != <span class="keyword">null</span>) &#123;</span><br><span class="line">        buildResolveList(intent, categories, debug, defaultOnly,</span><br><span class="line">                resolvedType, scheme, thirdTypeCut, finalList, userId);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span> (schemeCut != <span class="keyword">null</span>) &#123;</span><br><span class="line">        buildResolveList(intent, categories, debug, defaultOnly,</span><br><span class="line">                resolvedType, scheme, schemeCut, finalList, userId);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">//【3.5】对结果进行过滤；</span></span><br><span class="line">    filterResults(finalList);</span><br><span class="line">    <span class="comment">//【3.6】对结果进行排序；</span></span><br><span class="line">    sortResults(finalList);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (debug) &#123;</span><br><span class="line">        Slog.v(TAG, <span class="string">"Final result list:"</span>);</span><br><span class="line">        <span class="keyword">for</span> (<span class="keyword">int</span> i=<span class="number">0</span>; i&lt;finalList.size(); i++) &#123;</span><br><span class="line">            Slog.v(TAG, <span class="string">"  "</span> + finalList.get(i));</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> finalList;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>最后返回匹配的 intent filter！</p>
<h2 id="3-3-ActivityIntentResolver-queryIntentForPackage-包名查询"><a href="#3-3-ActivityIntentResolver-queryIntentForPackage-包名查询" class="headerlink" title="3.3 ActivityIntentResolver.queryIntentForPackage - 包名查询"></a>3.3 ActivityIntentResolver.queryIntentForPackage - 包名查询</h2><p>参数：</p>
<ul>
<li><strong>ArrayList&lt;PackageParser.Activity&gt; packageActivities</strong>：传入 PackageParser.Package.receivers list 集合！<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> List&lt;ResolveInfo&gt; <span class="title">queryIntentForPackage</span><span class="params">(Intent intent, String resolvedType,</span></span></span><br><span class="line"><span class="function"><span class="params">        <span class="keyword">int</span> flags, ArrayList&lt;PackageParser.Activity&gt; packageActivities, <span class="keyword">int</span> userId)</span> </span>&#123;</span><br><span class="line">    <span class="comment">//【1】userId 不存在，返回 null；</span></span><br><span class="line">    <span class="keyword">if</span> (!sUserManager.exists(userId)) <span class="keyword">return</span> <span class="keyword">null</span>;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">//【2】如果 packageActivities 为 null，返回 null；</span></span><br><span class="line">    <span class="keyword">if</span> (packageActivities == <span class="keyword">null</span>) &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">null</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    mFlags = flags;</span><br><span class="line">    <span class="keyword">final</span> <span class="keyword">boolean</span> defaultOnly = (flags&amp;PackageManager.MATCH_DEFAULT_ONLY) != <span class="number">0</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">final</span> <span class="keyword">int</span> N = packageActivities.size();</span><br><span class="line"></span><br><span class="line">    ArrayList&lt;PackageParser.ActivityIntentInfo[]&gt; listCut =</span><br><span class="line">        <span class="keyword">new</span> ArrayList&lt;PackageParser.ActivityIntentInfo[]&gt;(N);</span><br><span class="line">    </span><br><span class="line">    <span class="comment">//【3】这里是找到 packageActivities 列表中所有 Activity 对象的 ActivityIntentInfo 数组！</span></span><br><span class="line">    <span class="comment">// 将其收集起来，保存到 listCut 列表中！</span></span><br><span class="line">    ArrayList&lt;PackageParser.ActivityIntentInfo&gt; intentFilters;</span><br><span class="line">    <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; N; ++i) &#123;</span><br><span class="line">        intentFilters = packageActivities.get(i).intents;</span><br><span class="line">        <span class="keyword">if</span> (intentFilters != <span class="keyword">null</span> &amp;&amp; intentFilters.size() &gt; <span class="number">0</span>) &#123;</span><br><span class="line"></span><br><span class="line">            PackageParser.ActivityIntentInfo[] array =</span><br><span class="line">                    <span class="keyword">new</span> PackageParser.ActivityIntentInfo[intentFilters.size()];</span><br><span class="line">            intentFilters.toArray(array);</span><br><span class="line">            listCut.add(array);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">//【3.3.1】调用父类的 queryIntentFromList 方法继续查询！</span></span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">super</span>.queryIntentFromList(intent, resolvedType, defaultOnly, listCut, userId);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
</li>
</ul>
<p>进入父类 IntentResolver 中：</p>
<h3 id="3-3-1-ActivityIntentResolver-queryIntentFromList"><a href="#3-3-1-ActivityIntentResolver-queryIntentFromList" class="headerlink" title="3.3.1 ActivityIntentResolver.queryIntentFromList"></a>3.3.1 ActivityIntentResolver.queryIntentFromList</h3><p>这里的模板参数 R 为 ResolveInfo 类：<br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> List&lt;R&gt; <span class="title">queryIntentFromList</span><span class="params">(Intent intent, String resolvedType, </span></span></span><br><span class="line"><span class="function"><span class="params">        <span class="keyword">boolean</span> defaultOnly, ArrayList&lt;F[]&gt; listCut, <span class="keyword">int</span> userId)</span> </span>&#123;</span><br><span class="line">    <span class="comment">//【1】用于保存查询的结果！</span></span><br><span class="line">    ArrayList&lt;R&gt; resultList = <span class="keyword">new</span> ArrayList&lt;R&gt;();</span><br><span class="line"></span><br><span class="line">    <span class="keyword">final</span> <span class="keyword">boolean</span> debug = localLOGV ||</span><br><span class="line">            ((intent.getFlags() &amp; Intent.FLAG_DEBUG_LOG_RESOLUTION) != <span class="number">0</span>);</span><br><span class="line"></span><br><span class="line">    FastImmutableArraySet&lt;String&gt; categories = getFastIntentCategories(intent);</span><br><span class="line">    <span class="keyword">final</span> String scheme = intent.getScheme();</span><br><span class="line">    <span class="keyword">int</span> N = listCut.size();</span><br><span class="line">    <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; N; ++i) &#123;</span><br><span class="line">        <span class="comment">//【3.4】遍历 ArrayList&lt;PackageParser.ActivityIntentInfo[]&gt; 列表 listCut</span></span><br><span class="line">        <span class="comment">// 处理每一个 ActivityIntentInfo 数组，也就是 IntentFliter 数组！</span></span><br><span class="line">        buildResolveList(intent, categories, debug, defaultOnly,</span><br><span class="line">                resolvedType, scheme, listCut.get(i), resultList, userId);</span><br><span class="line">    &#125;</span><br><span class="line">    filterResults(resultList);</span><br><span class="line"></span><br><span class="line">    <span class="comment">//【3】对结果进行排序！</span></span><br><span class="line">    sortResults(resultList);</span><br><span class="line">    <span class="keyword">return</span> resultList;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<h2 id="3-4-IntentResolver-buildResolveList"><a href="#3-4-IntentResolver-buildResolveList" class="headerlink" title="3.4 IntentResolver.buildResolveList"></a>3.4 IntentResolver.buildResolveList</h2><p>下面我们来看一下，查询静态注册的广播接收者信息的最重要的一个方法，如何通过 <code>ActivityIntentInfo[]</code> 数组 src，生成 <code>List&lt;ResolveList&gt;</code> 列表 dest：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">buildResolveList</span><span class="params">(Intent intent, FastImmutableArraySet&lt;String&gt; categories,</span></span></span><br><span class="line"><span class="function"><span class="params">        <span class="keyword">boolean</span> debug, <span class="keyword">boolean</span> defaultOnly,</span></span></span><br><span class="line"><span class="function"><span class="params">        String resolvedType, String scheme, F[] src, List&lt;R&gt; dest, <span class="keyword">int</span> userId)</span> </span>&#123;</span><br><span class="line">    <span class="comment">//【1】获得广播 Intent 的 action！</span></span><br><span class="line">    <span class="keyword">final</span> String action = intent.getAction();</span><br><span class="line">    <span class="comment">//【2】获得广播 Intent 的 uri 数据！</span></span><br><span class="line">    <span class="keyword">final</span> Uri data = intent.getData();</span><br><span class="line">    <span class="comment">//【3】获得广播 Intent 的 package 数据！</span></span><br><span class="line">    <span class="keyword">final</span> String packageName = intent.getPackage();</span><br><span class="line">    <span class="comment">//【4】广播是否设置了 FLAG_EXCLUDE_STOPPED_PACKAGES 标志！</span></span><br><span class="line">    <span class="keyword">final</span> <span class="keyword">boolean</span> excludingStopped = intent.isExcludingStopped();</span><br><span class="line"></span><br><span class="line">    <span class="keyword">final</span> Printer logPrinter;</span><br><span class="line">    <span class="keyword">final</span> PrintWriter logPrintWriter;</span><br><span class="line">    <span class="keyword">if</span> (debug) &#123;</span><br><span class="line">        logPrinter = <span class="keyword">new</span> LogPrinter(Log.VERBOSE, TAG, Log.LOG_ID_SYSTEM);</span><br><span class="line">        logPrintWriter = <span class="keyword">new</span> FastPrintWriter(logPrinter);</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        logPrinter = <span class="keyword">null</span>;</span><br><span class="line">        logPrintWriter = <span class="keyword">null</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">final</span> <span class="keyword">int</span> N = src != <span class="keyword">null</span> ? src.length : <span class="number">0</span>;</span><br><span class="line">    <span class="keyword">boolean</span> hasNonDefaults = <span class="keyword">false</span>;</span><br><span class="line">    <span class="keyword">int</span> i;</span><br><span class="line">    F filter;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">//【1】遍历传入的 ActivityIntentInfo[] 数组 src，选择能接受当前广播 Intent 的 ActivityIntentInfo！</span></span><br><span class="line">    <span class="keyword">for</span> (i=<span class="number">0</span>; i&lt;N &amp;&amp; (filter=src[i]) != <span class="keyword">null</span>; i++) &#123;</span><br><span class="line">        <span class="keyword">int</span> match;</span><br><span class="line">        <span class="keyword">if</span> (debug) Slog.v(TAG, <span class="string">"Matching against filter "</span> + filter);</span><br><span class="line">        </span><br><span class="line">        <span class="comment">//【3.4.1】如果广播设置了 FLAG_EXCLUDE_STOPPED_PACKAGES 标签，那就要判断 filter 所属的应用是否被 stop 了！</span></span><br><span class="line">        <span class="comment">// isFilterStopped 方法是 IntentResolver 的子类中实现！</span></span><br><span class="line">        <span class="comment">// 如果满足，那么这个应用是不能接收到当前的广播的！</span></span><br><span class="line">        <span class="keyword">if</span> (excludingStopped &amp;&amp; isFilterStopped(filter, userId)) &#123;</span><br><span class="line">            <span class="keyword">if</span> (debug) &#123;</span><br><span class="line">                Slog.v(TAG, <span class="string">"  Filter's target is stopped; skipping"</span>);</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">continue</span>;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment">//【3.4.2】如果广播 Intent 设置了包名，那就要判断当前 ActivityIntentInfo 所属的目标应用包名是否一致</span></span><br><span class="line">        <span class="comment">// 不一致，说明这个不是目标应用，isPackageForFilter 也是在 IntentResolver 的子类中实现！</span></span><br><span class="line">        <span class="keyword">if</span> (packageName != <span class="keyword">null</span> &amp;&amp; !isPackageForFilter(packageName, filter)) &#123;</span><br><span class="line">            <span class="keyword">if</span> (debug) &#123;</span><br><span class="line">                Slog.v(TAG, <span class="string">"  Filter is not from package "</span> + packageName + <span class="string">"; skipping"</span>);</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">continue</span>;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (filter.getAutoVerify()) &#123;</span><br><span class="line">            <span class="keyword">if</span> (localVerificationLOGV || debug) &#123;</span><br><span class="line">                Slog.v(TAG, <span class="string">"  Filter verified: "</span> + isFilterVerified(filter));</span><br><span class="line">                <span class="keyword">int</span> authorities = filter.countDataAuthorities();</span><br><span class="line">                <span class="keyword">for</span> (<span class="keyword">int</span> z = <span class="number">0</span>; z &lt; authorities; z++) &#123;</span><br><span class="line">                    Slog.v(TAG, <span class="string">"   "</span> + filter.getDataAuthority(z).getHost());</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment">//【3.4.3】allowFilterResult 方法也是在 IntentResolver 的子类中实现！</span></span><br><span class="line">        <span class="comment">// 判断我们是否已经添加过这个 filter！</span></span><br><span class="line">        <span class="keyword">if</span> (!allowFilterResult(filter, dest)) &#123;</span><br><span class="line">            <span class="keyword">if</span> (debug) &#123;</span><br><span class="line">                Slog.v(TAG, <span class="string">"  Filter's target already added"</span>);</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">continue</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        </span><br><span class="line">        <span class="comment">//【2】进行匹配操作，结果返回值 match &gt;= 0，说明匹配成功！</span></span><br><span class="line">        match = filter.match(action, resolvedType, scheme, data, categories, TAG);</span><br><span class="line">        <span class="keyword">if</span> (match &gt;= <span class="number">0</span>) &#123;</span><br><span class="line">            <span class="keyword">if</span> (debug) Slog.v(TAG, <span class="string">"  Filter matched!  match=0x"</span> +</span><br><span class="line">                    Integer.toHexString(match) + <span class="string">" hasDefault="</span></span><br><span class="line">                    + filter.hasCategory(Intent.CATEGORY_DEFAULT));</span><br><span class="line">            <span class="keyword">if</span> (!defaultOnly || filter.hasCategory(Intent.CATEGORY_DEFAULT)) &#123;</span><br><span class="line">                <span class="comment">//【3.4.4】创建 ResolveList 对象！</span></span><br><span class="line">                <span class="comment">// newResult 方法也是在 IntentResolver 的子类中实现中实现</span></span><br><span class="line">                <span class="keyword">final</span> R oneResult = newResult(filter, match, userId);</span><br><span class="line">                <span class="keyword">if</span> (oneResult != <span class="keyword">null</span>) &#123;</span><br><span class="line">                    <span class="comment">//【2.2】添加到目标集合 dest 中！</span></span><br><span class="line">                    dest.add(oneResult);</span><br><span class="line">                    <span class="keyword">if</span> (debug) &#123;</span><br><span class="line">                        dumpFilter(logPrintWriter, <span class="string">"    "</span>, filter);</span><br><span class="line">                        logPrintWriter.flush();</span><br><span class="line">                        filter.dump(logPrinter, <span class="string">"    "</span>);</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                hasNonDefaults = <span class="keyword">true</span>;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            <span class="keyword">if</span> (debug) &#123;</span><br><span class="line">                String reason;</span><br><span class="line">                <span class="keyword">switch</span> (match) &#123;</span><br><span class="line">                    <span class="keyword">case</span> IntentFilter.NO_MATCH_ACTION: reason = <span class="string">"action"</span>; <span class="keyword">break</span>;</span><br><span class="line">                    <span class="keyword">case</span> IntentFilter.NO_MATCH_CATEGORY: reason = <span class="string">"category"</span>; <span class="keyword">break</span>;</span><br><span class="line">                    <span class="keyword">case</span> IntentFilter.NO_MATCH_DATA: reason = <span class="string">"data"</span>; <span class="keyword">break</span>;</span><br><span class="line">                    <span class="keyword">case</span> IntentFilter.NO_MATCH_TYPE: reason = <span class="string">"type"</span>; <span class="keyword">break</span>;</span><br><span class="line">                    <span class="keyword">default</span>: reason = <span class="string">"unknown reason"</span>; <span class="keyword">break</span>;</span><br><span class="line">                &#125;</span><br><span class="line">                Slog.v(TAG, <span class="string">"  Filter did not match: "</span> + reason);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (debug &amp;&amp; hasNonDefaults) &#123;</span><br><span class="line">        <span class="keyword">if</span> (dest.size() == <span class="number">0</span>) &#123;</span><br><span class="line">            Slog.v(TAG, <span class="string">"resolveIntent failed: found match, but none with CATEGORY_DEFAULT"</span>);</span><br><span class="line">        &#125; <span class="keyword">else</span> <span class="keyword">if</span> (dest.size() &gt; <span class="number">1</span>) &#123;</span><br><span class="line">            Slog.v(TAG, <span class="string">"resolveIntent: multiple matches, only some with CATEGORY_DEFAULT"</span>);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>这个方法流程很简单，我们来看一些细节！</p>
<h3 id="3-4-1-ActivityIntentResolver-ActivityIntentResolver-isFilterStopped"><a href="#3-4-1-ActivityIntentResolver-ActivityIntentResolver-isFilterStopped" class="headerlink" title="3.4.1 ActivityIntentResolver ActivityIntentResolver.isFilterStopped"></a>3.4.1 ActivityIntentResolver ActivityIntentResolver.isFilterStopped</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="function"><span class="keyword">protected</span> <span class="keyword">boolean</span> <span class="title">isFilterStopped</span><span class="params">(PackageParser.ActivityIntentInfo filter, <span class="keyword">int</span> userId)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">if</span> (!sUserManager.exists(userId)) <span class="keyword">return</span> <span class="keyword">true</span>;</span><br><span class="line">    PackageParser.Package p = filter.activity.owner;</span><br><span class="line">    <span class="keyword">if</span> (p != <span class="keyword">null</span>) &#123;</span><br><span class="line">        PackageSetting ps = (PackageSetting)p.mExtras;</span><br><span class="line">        <span class="keyword">if</span> (ps != <span class="keyword">null</span>) &#123;</span><br><span class="line">            <span class="keyword">return</span> (ps.pkgFlags&amp;ApplicationInfo.FLAG_SYSTEM) == <span class="number">0</span></span><br><span class="line">                    &amp;&amp; ps.getStopped(userId);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">false</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>isFilterStopped 方法用来判断 filter 所属的应用是否被强行停止了，返回 true 的情况如下：</p>
<ul>
<li>设备用户 id 不存在；</li>
<li>filter 所属的应用是非系统应用，且应用的 stoped 属性被置为 true；</li>
</ul>
<p>该方法返回  true，表示该应用在该设备用户下，被强制停止了！</p>
<h3 id="3-4-2-ActivityIntentResolver-isPackageForFilter"><a href="#3-4-2-ActivityIntentResolver-isPackageForFilter" class="headerlink" title="3.4.2 ActivityIntentResolver.isPackageForFilter"></a>3.4.2 ActivityIntentResolver.isPackageForFilter</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="function"><span class="keyword">protected</span> <span class="keyword">boolean</span> <span class="title">isPackageForFilter</span><span class="params">(String packageName,</span></span></span><br><span class="line"><span class="function"><span class="params">        PackageParser.ActivityIntentInfo info)</span> </span>&#123;</span><br><span class="line">    <span class="comment">//【1】就是匹配下 package name！</span></span><br><span class="line">    <span class="keyword">return</span> packageName.equals(info.activity.owner.packageName);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>这个方法很简单，不用多说了，就是判断 Intent 设置的包名和 filter 所属的应用的包名是不是一样的！一样的话，说明该应用是广播的目标应用！</p>
<h3 id="3-4-3-ActivityIntentResolver-allowFilterResult"><a href="#3-4-3-ActivityIntentResolver-allowFilterResult" class="headerlink" title="3.4.3 ActivityIntentResolver.allowFilterResult"></a>3.4.3 ActivityIntentResolver.allowFilterResult</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="function"><span class="keyword">protected</span> <span class="keyword">boolean</span> <span class="title">allowFilterResult</span><span class="params">(</span></span></span><br><span class="line"><span class="function"><span class="params">        PackageParser.ActivityIntentInfo filter, List&lt;ResolveInfo&gt; dest)</span> </span>&#123;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">//【1】获得 filter 所属的组件的 ActivityInfo 对象！</span></span><br><span class="line">    ActivityInfo filterAi = filter.activity.info;</span><br><span class="line">    <span class="keyword">for</span> (<span class="keyword">int</span> i=dest.size()-<span class="number">1</span>; i&gt;=<span class="number">0</span>; i--) &#123;</span><br><span class="line">        ActivityInfo destAi = dest.get(i).activityInfo;</span><br><span class="line">        <span class="keyword">if</span> (destAi.name == filterAi.name</span><br><span class="line">                &amp;&amp; destAi.packageName == filterAi.packageName) &#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="keyword">false</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">true</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>该方法的作用是是否重复添加过同一个 filter，判断依据是：要被添加的 filter 的组件名和包名是否和 dest 集合中的某个 filter 一样！！</p>
<p>ActivityInfo 是对应组件的信息对象，ActivityInfo.name 这个值来自于 android:name 属性！！</p>
<h3 id="3-4-4-ActivityIntentResolver-newResult"><a href="#3-4-4-ActivityIntentResolver-newResult" class="headerlink" title="3.4.4 ActivityIntentResolver.newResult"></a>3.4.4 ActivityIntentResolver.newResult</h3><p>最后，就是将 ActivityIntentInfo 对象封装为 ResolveInfo 对象了！<br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="function"><span class="keyword">protected</span> ResolveInfo <span class="title">newResult</span><span class="params">(PackageParser.ActivityIntentInfo info,</span></span></span><br><span class="line"><span class="function"><span class="params">        <span class="keyword">int</span> match, <span class="keyword">int</span> userId)</span> </span>&#123;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">//【1】如果设备用户不存在，返回 null；</span></span><br><span class="line">    <span class="keyword">if</span> (!sUserManager.exists(userId)) <span class="keyword">return</span> <span class="keyword">null</span>;</span><br><span class="line">    <span class="keyword">if</span> (!mSettings.isEnabledAndMatchLPr(info.activity.info, mFlags, userId)) &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">null</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">final</span> PackageParser.Activity activity = info.activity;</span><br><span class="line">    PackageSetting ps = (PackageSetting) activity.owner.mExtras;</span><br><span class="line">    <span class="keyword">if</span> (ps == <span class="keyword">null</span>) &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">null</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">//【2】获得组件新的 ActivityInfo 拷贝对象 ai！</span></span><br><span class="line">    ActivityInfo ai = PackageParser.generateActivityInfo(activity, mFlags,</span><br><span class="line">            ps.readUserState(userId), userId);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (ai == <span class="keyword">null</span>) &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">null</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">//【3】创建一个 ResolveInfo 对象 res，并设置 res.activityInfo 为 ai；</span></span><br><span class="line">    <span class="keyword">final</span> ResolveInfo res = <span class="keyword">new</span> ResolveInfo();</span><br><span class="line">    res.activityInfo = ai;</span><br><span class="line">    <span class="keyword">if</span> ((mFlags&amp;PackageManager.GET_RESOLVED_FILTER) != <span class="number">0</span>) &#123;</span><br><span class="line">        res.filter = info;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span> (info != <span class="keyword">null</span>) &#123;</span><br><span class="line">        res.handleAllWebDataURI = info.handleAllWebDataURI();</span><br><span class="line">    &#125;</span><br><span class="line">    res.priority = info.getPriority();</span><br><span class="line">    res.preferredOrder = activity.owner.mPreferredOrder;</span><br><span class="line">    <span class="comment">//System.out.println("Result: " + res.activityInfo.className +</span></span><br><span class="line">    <span class="comment">//                   " = " + res.priority);</span></span><br><span class="line">    res.match = match;</span><br><span class="line">    res.isDefault = info.hasDefault;</span><br><span class="line">    res.labelRes = info.labelRes;</span><br><span class="line">    res.nonLocalizedLabel = info.nonLocalizedLabel;</span><br><span class="line">    <span class="keyword">if</span> (userNeedsBadging(userId)) &#123;</span><br><span class="line">        res.noResourceId = <span class="keyword">true</span>;</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        res.icon = info.icon;</span><br><span class="line">    &#125;</span><br><span class="line">    res.iconResourceId = info.icon;</span><br><span class="line">    <span class="comment">//【4】是否是系统应用！</span></span><br><span class="line">    res.system = res.activityInfo.applicationInfo.isSystemApp();</span><br><span class="line">    <span class="comment">//【5】返回我们创建的新的 ResolveInfo 对象！</span></span><br><span class="line">    <span class="keyword">return</span> res;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>到这里，我们就知道了如何查询系统中所有注册过的广播接收者了！</p>
<h1 id="4-总结！"><a href="#4-总结！" class="headerlink" title="4 总结！"></a>4 总结！</h1><p>我们来看看广播的静态注册的类关系图：</p>
<h2 id="4-1-静态注册类关系图"><a href="#4-1-静态注册类关系图" class="headerlink" title="4.1 静态注册类关系图"></a>4.1 静态注册类关系图</h2><p>PMS 解析了静态注册的广播接收者后，数据结婚间的关系图如下：</p>
<p><img src="http://static.zybuluo.com/Coolqi/rx01mfez26ljxjxoykphjyr7/%E5%B9%BF%E6%92%AD%E9%9D%99%E6%80%81%E6%B3%A8%E5%86%8C.png" alt="广播静态注册.png-169.5kB"></p>
<h2 id="4-2-查询注册结果关系图"><a href="#4-2-查询注册结果关系图" class="headerlink" title="4.2 查询注册结果关系图"></a>4.2 查询注册结果关系图</h2></div></article><div class="post-copyright"><div class="post-copyright__author"><span class="post-copyright-meta">文章作者: </span><span class="post-copyright-info"><a href="mailto:undefined">Coolqi.Li</a></span></div><div class="post-copyright__type"><span class="post-copyright-meta">文章链接: </span><span class="post-copyright-info"><a href="https://coolqi.top/2016/05/08/BroadcastReceiver4-staticRegisterReceiver/">https://coolqi.top/2016/05/08/BroadcastReceiver4-staticRegisterReceiver/</a></span></div><div class="post-copyright__notice"><span class="post-copyright-meta">版权声明: </span><span class="post-copyright-info">本博客所有文章除特别声明外，均采用 <a href="https://creativecommons.org/licenses/by-nc-sa/4.0/">CC BY-NC-SA 4.0</a> 许可协议。转载请注明来自 <a href="https://coolqi.top">Coolqi`s Blog</a>！</span></div></div><div class="post-meta__tag-list"><a class="post-meta__tags" href="/tags/BroadcastReceiver广播接收者/">BroadcastReceiver广播接收者</a></div><div class="post-qr-code"><div class="post-qr-code-item"><img class="post-qr-code__img" src="/img/zfb.jpg"><div class="post-qr-code__desc">支付宝打赏</div></div><div class="post-qr-code-item"><img class="post-qr-code__img" src="/img/wechat.jpg"><div class="post-qr-code__desc">微信打赏</div></div></div><div class="social-share"></div><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/social-share.js@1.0.16/dist/css/share.min.css"><script src="https://cdn.jsdelivr.net/npm/social-share.js@1.0.16/dist/js/social-share.min.js"></script><nav id="pagination"><div class="prev-post pull-left"><a href="/2016/05/10/BroadcastReceiver5-sendBroadcast/"><i class="fa fa-chevron-left">  </i><span>BroadcastReceiver篇 5 - sendBroadcast 流程分析</span></a></div><div class="next-post pull-right"><a href="/2016/05/04/BroadcastReceiver3-unregisterReceiverAndTimeOut/"><span>BroadcastReceiver篇 3 - unregisterReceiver 和 TimeOut 流程分析</span><i class="fa fa-chevron-right"></i></a></div></nav></div></div><footer><div class="layout" id="footer"><div class="copyright">&copy;2015 - 2019 By Coolqi.Li</div><div class="framework-info"><span>驱动 - </span><a href="http://hexo.io"><span>Hexo</span></a><span class="footer-separator">|</span><span>主题 - </span><a href="https://github.com/Molunerfinn/hexo-theme-melody"><span>Melody</span></a></div><div class="footer_custom_text">Hi, welcome to my <a href="https://lishuaiqi.top/">blog</a>!</div><div class="busuanzi"><script async src="https://busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script><span id="busuanzi_container_page_pv"><i class="fa fa-file-o"></i><span id="busuanzi_value_page_pv"></span><span></span></span></div></div></footer><i class="fa fa-arrow-up" id="go-up" aria-hidden="true"></i><script src="/js/third-party/anime.min.js"></script><script src="/js/third-party/jquery.min.js"></script><script src="/js/third-party/jquery.fancybox.min.js"></script><script src="/js/third-party/velocity.min.js"></script><script src="/js/third-party/velocity.ui.min.js"></script><script src="/js/utils.js?version=1.5.6"></script><script src="/js/fancybox.js?version=1.5.6"></script><script src="/js/sidebar.js?version=1.5.6"></script><script src="/js/copy.js?version=1.5.6"></script><script src="/js/fireworks.js?version=1.5.6"></script><script src="/js/transition.js?version=1.5.6"></script><script src="/js/scroll.js?version=1.5.6"></script><script src="/js/head.js?version=1.5.6"></script><script type="text/x-mathjax-config">MathJax.Hub.Config({
  tex2jax: {
    inlineMath: [ ['$','$'], ["\\(","\\)"]  ],
    processEscapes: true,
    skipTags: ['script', 'noscript', 'style', 'textarea', 'pre', 'code']
  },
  CommonHTML: {
    linebreaks: { automatic: true, width: "90% container" }
  },
  "HTML-CSS": { 
    linebreaks: { automatic: true, width: "90% container" }
  },
  "SVG": { 
    linebreaks: { automatic: true, width: "90% container" }
  }
});
</script><script type="text/x-mathjax-config">MathJax.Hub.Queue(function() {
  var all = MathJax.Hub.getAllJax(), i;
  for (i=0; i < all.length; i += 1) {
    all[i].SourceElement().parentNode.className += ' has-jax';
  }
});
</script><script src="https://cdn.jsdelivr.net/npm/mathjax/MathJax.js?config=TeX-AMS-MML_HTMLorMML"></script><script src="/js/search/local-search.js"></script><div class="search-dialog" id="local-search"><div class="search-dialog__title" id="local-search-title">本地搜索</div><div id="local-input-panel"><div id="local-search-input"><div class="local-search-box"><input class="local-search-box--input" placeholder="搜索文章"></div></div></div><hr><div id="local-search-results"><div id="local-hits"></div><div id="local-stats"><div class="local-search-stats__hr" id="hr"><span>由</span> <a href="https://github.com/wzpan/hexo-generator-search" style="color:#49B1F5;">hexo-generator-search</a>
 <span>提供支持</span></div></div></div><span class="search-close-button"><i class="fa fa-times"></i></span></div><div class="search-mask"></div><script src="/live2dw/lib/L2Dwidget.min.js?0c58a1486de42ac6cc1c59c7d98ae887"></script><script>L2Dwidget.init({"pluginRootPath":"live2dw/","pluginJsPath":"lib/","pluginModelPath":"assets/","tagMode":false,"debug":false,"model":{"jsonPath":"live2d-widget-model-hijiki"},"display":{"position":"right","width":110,"height":220},"mobile":{"show":false},"log":false});</script></body></html>
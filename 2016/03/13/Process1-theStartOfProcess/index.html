<!DOCTYPE html><html lang="zh-Hans"><head><meta charset="UTF-8"><meta http-equiv="X-UA-Compatible" content="IE=edge"><meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1"><meta name="description" content="Process篇 1 - Android 进程的启动"><meta name="keywords" content="Process进程"><meta name="author" content="Coolqi.Li,undefined"><meta name="copyright" content="Coolqi.Li"><title>Process篇 1 - Android 进程的启动 | Coolqi`s Blog</title><link rel="shortcut icon" href="/img/favicon.ico"><link rel="stylesheet" href="/css/index.css?version=1.5.6"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/font-awesome@4.7.0/css/font-awesome.min.css?version=1.5.6"><link rel="dns-prefetch" href="https://cdn.staticfile.org"><link rel="dns-prefetch" href="https://cdn.bootcss.com"><link rel="dns-prefetch" href="https://creativecommons.org"><link rel="dns-prefetch" href="https://hm.baidu.com"><script>var _hmt = _hmt || [];
(function() {
  var hm = document.createElement("script");
  hm.src = "https://hm.baidu.com/hm.js?b7acef5306e54116ad8a99e8b753a92d";
  var s = document.getElementsByTagName("script")[0]; 
  s.parentNode.insertBefore(hm, s);
})();</script><script>var GLOBAL_CONFIG = { 
  root: '/',
  algolia: undefined,
  localSearch: {"path":"search.xml","languages":{"hits_empty":"找不到您查询的内容:${query}"}},
  copy: {
    success: '复制成功',
    error: '复制错误',
    noSupport: '浏览器不支持'
  }
} </script></head><body><i class="fa fa-arrow-right" id="toggle-sidebar" aria-hidden="true"></i><div id="sidebar"><div class="toggle-sidebar-info text-center"><span data-toggle="切换文章详情">切换站点概览</span><hr></div><div class="sidebar-toc"><div class="sidebar-toc__title">目录</div><div class="sidebar-toc__progress"><span class="progress-notice">你已经读了</span><span class="progress-num">0</span><span class="progress-percentage">%</span><div class="sidebar-toc__progress-bar"></div></div><div class="sidebar-toc__content"><ol class="toc"><li class="toc-item toc-level-1"><a class="toc-link" href="#1-前言"><span class="toc-text">1 前言</span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#2-启动进程的方法"><span class="toc-text">2 启动进程的方法</span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#3-startProcessLocked-启动"><span class="toc-text">3 startProcessLocked - 启动</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#3-1-AMS-newProcessRecordLocked"><span class="toc-text">3.1 AMS.newProcessRecordLocked</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#3-1-1-AMS-addProcessNameLocked"><span class="toc-text">3.1.1 AMS.addProcessNameLocked</span></a></li></ol></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#4-startProcessLocked-ProcessRecord"><span class="toc-text">4 startProcessLocked - ProcessRecord</span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#5-ActivityThread-main"><span class="toc-text">5 ActivityThread.main</span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#6-ActivityThread-attach"><span class="toc-text">6 ActivityThread.attach</span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#7-ActivityManagerProxy-attachApplication"><span class="toc-text">7 ActivityManagerProxy.attachApplication</span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#8-ActivityManagerNative-onTransact"><span class="toc-text">8 ActivityManagerNative.onTransact</span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#9-ActivityManagerService-attachApplication"><span class="toc-text">9 ActivityManagerService.attachApplication</span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#10-ActivityManagerService-attachApplicationLocked"><span class="toc-text">10 ActivityManagerService.attachApplicationLocked</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#10-1-new-AppDeathRecipient"><span class="toc-text">10.1 new AppDeathRecipient</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#10-1-AMS-appDiedLocked"><span class="toc-text">10.1 AMS.appDiedLocked</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#10-2-AMS-handleAppDiedLocked"><span class="toc-text">10.2 AMS.handleAppDiedLocked</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#10-2-1-AMS-cleanUpApplicationRecordLocked"><span class="toc-text">10.2.1 AMS.cleanUpApplicationRecordLocked</span></a></li></ol></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#11-ApplicationThreadProxy-bindApplication"><span class="toc-text">11 ApplicationThreadProxy.bindApplication</span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#12-ApplicationThreadNative-onTransact"><span class="toc-text">12 ApplicationThreadNative.onTransact</span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#13-ApplicationThread-bindApplication"><span class="toc-text">13 ApplicationThread.bindApplication</span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#14-ActivityThread-H-消息处理"><span class="toc-text">14 ActivityThread.H - 消息处理</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#14-1-消息-H-SET-CORE-SETTINGS"><span class="toc-text">14.1 消息 H.SET_CORE_SETTINGS</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#14-2-消息-H-BIND-APPLICATION"><span class="toc-text">14.2 消息 H.BIND_APPLICATION</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#14-2-1-ContextImpl-createAppContext"><span class="toc-text">14.2.1 ContextImpl.createAppContext</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#14-2-2-LoadedApk-makeApplication"><span class="toc-text">14.2.2 LoadedApk.makeApplication</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#14-2-3-Instrumentation-callApplicationOnCreate"><span class="toc-text">14.2.3 Instrumentation.callApplicationOnCreate</span></a></li></ol></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#15-总结"><span class="toc-text">15 总结</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#15-1-进程的创建和启动"><span class="toc-text">15.1 进程的创建和启动</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#15-2-ActivityThread-关系图"><span class="toc-text">15.2 ActivityThread 关系图</span></a></li></ol></li></ol></div></div><div class="author-info hide"><div class="author-info__avatar text-center"><img src="/img/avatar.png"></div><div class="author-info__name text-center">Coolqi.Li</div><div class="author-info__description text-center">“你好，我是李帅奇，Android 系统工程师，MineCraft 忠实玩家，设计和绘画爱好者，缺妹纸晚期患者，熬夜星人。”</div><hr><div class="author-info-articles"><a class="author-info-articles__archives article-meta" href="/archives"><span class="pull-left">文章</span><span class="pull-right">72</span></a><a class="author-info-articles__tags article-meta" href="/tags"><span class="pull-left">标签</span><span class="pull-right">16</span></a><a class="author-info-articles__categories article-meta" href="/categories"><span class="pull-left">分类</span><span class="pull-right">18</span></a></div><hr><div class="author-info-links"><div class="author-info-links__title text-center">Links</div><a class="author-info-links__name text-center" href="https://developer.android.google.cn/">AndroidDeveloper</a><a class="author-info-links__name text-center" href="http://www.android-studio.org/">AndroidStudio</a><a class="author-info-links__name text-center" href="https://www.jianshu.com/u/123a20a96441">简书</a><a class="author-info-links__name text-center" href="https://weibo.com/coolqiLi">微博</a></div></div></div><div id="content-outer"><div id="top-container" style="background-image: url(https://ws1.sinaimg.cn/large/8700af19ly1fvpabr30o6j22yo1o0q7i.jpg)"><div id="page-header"><span class="pull-left"> <a id="site-name" href="/">Coolqi`s Blog</a></span><i class="fa fa-bars toggle-menu pull-right" aria-hidden="true"></i><span class="pull-right menus"><a class="site-page social-icon search"><i class="fa fa-search"></i><span> 搜索</span></a><a class="site-page" href="/">Home</a><a class="site-page" href="/categories">Categories</a><a class="site-page" href="/tags">Tags</a><a class="site-page" href="/archives">Archives</a><a class="site-page" href="/about">About</a></span></div><div id="post-info"><div id="post-title">Process篇 1 - Android 进程的启动</div><div id="post-meta"><time class="post-meta__date"><i class="fa fa-calendar" aria-hidden="true"></i> 2016-03-13</time><span class="post-meta__separator">|</span><i class="fa fa-inbox post-meta__icon" aria-hidden="true"></i><a class="post-meta__categories" href="/categories/AndroidFramework源码分析/">AndroidFramework源码分析</a><i class="fa fa-angle-right" aria-hidden="true"></i><i class="fa fa-inbox post-meta__icon" aria-hidden="true"></i><a class="post-meta__categories" href="/categories/AndroidFramework源码分析/Process进程/">Process进程</a><div class="post-meta-wordcount"><span>字数总计: </span><span class="word-count">10.9k</span><span class="post-meta__separator">|</span><span>阅读时长: 53 分钟</span></div></div></div></div><div class="layout" id="content-inner"><article id="post"><div class="article-container" id="post-content"><p>[toc]</p>
<p>基于 Android 7.1.1 源码分析，进程</p>
<h1 id="1-前言"><a href="#1-前言" class="headerlink" title="1 前言"></a>1 前言</h1><p>我们知道，在 Android 系统中，每一个 app 都至少运行在一个进程中的，可以通过配置 Android:process 属性，来使 app 的某个组件运行在不同的进程中的，从而达到一个 app 在运行在多个进程中！</p>
<p>本文将总结和分析 Android 进程启动进程的主要流程，更深入地理解 Android 系统的架构！</p>
<h1 id="2-启动进程的方法"><a href="#2-启动进程的方法" class="headerlink" title="2 启动进程的方法"></a>2 启动进程的方法</h1><p>AMS 中进程启动相关的方法有如下的 2 组：<br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">final</span> <span class="keyword">void</span> <span class="title">startProcessLocked</span><span class="params">(ProcessRecord app,</span></span></span><br><span class="line"><span class="function"><span class="params">                                      String hostingType, String hostingNameStr)</span> </span>&#123;</span><br><span class="line">        <span class="comment">//【1】进一步调用                              </span></span><br><span class="line">        startProcessLocked(app, hostingType, </span><br><span class="line">                           hostingNameStr, <span class="keyword">null</span> <span class="comment">/* abiOverride */</span>,</span><br><span class="line">                           <span class="keyword">null</span> <span class="comment">/* entryPoint */</span>, <span class="keyword">null</span> <span class="comment">/* entryPointArgs */</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">final</span> <span class="keyword">void</span> <span class="title">startProcessLocked</span><span class="params">(ProcessRecord app, String hostingType,</span></span></span><br><span class="line"><span class="function"><span class="params">                                      String hostingNameStr, String abiOverride,                                                  String entryPoint, String[] entryPointArgs)</span> </span>&#123;</span><br><span class="line">       ... ... ... ...</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>第一组，可以看出启动方式是通过进程的 ProcessRecord 对象来启动的！<br>参数传递：</p>
<ul>
<li><strong>ProcessRecord app</strong>：进程对应的 ProcessRecord 对象！</li>
<li><strong>String hostingType</strong>：</li>
<li><strong>String hostingNameStr</strong>：</li>
<li><strong>String abiOverride：null</strong></li>
<li><strong>String entryPoint：null</strong></li>
<li><strong>String[] entryPointArgs：null</strong></li>
</ul>
<p>接着来看：<br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">final</span> ProcessRecord <span class="title">startProcessLocked</span><span class="params">(String processName, ApplicationInfo info，</span></span></span><br><span class="line"><span class="function"><span class="params">                                       <span class="keyword">boolean</span> knownToBeDead, <span class="keyword">int</span> intentFlags,</span></span></span><br><span class="line"><span class="function"><span class="params">                                       String hostingType, ComponentName hostingName, </span></span></span><br><span class="line"><span class="function"><span class="params">                                       <span class="keyword">boolean</span> allowWhileBooting,</span></span></span><br><span class="line"><span class="function"><span class="params">                                       <span class="keyword">boolean</span> isolated, <span class="keyword">boolean</span> keepIfLarge)</span> </span>&#123;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// 进一步调用</span></span><br><span class="line">    <span class="keyword">return</span> startProcessLocked(processName, info, </span><br><span class="line">                              knownToBeDead, intentFlags, hostingType,</span><br><span class="line">                              hostingName, allowWhileBooting, isolated, </span><br><span class="line">                              <span class="number">0</span> <span class="comment">/* isolatedUid */</span>, keepIfLarge,</span><br><span class="line">                              <span class="keyword">null</span> <span class="comment">/* ABI override */</span>, <span class="keyword">null</span> <span class="comment">/* entryPoint */</span>,</span><br><span class="line">                              <span class="keyword">null</span> <span class="comment">/* entryPointArgs */</span>,<span class="keyword">null</span> <span class="comment">/* crashHandler */</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">final</span> ProcessRecord <span class="title">startProcessLocked</span><span class="params">(String processName, ApplicationInfo info,</span></span></span><br><span class="line"><span class="function"><span class="params">                                       <span class="keyword">boolean</span> knownToBeDead, <span class="keyword">int</span> intentFlags, </span></span></span><br><span class="line"><span class="function"><span class="params">                                       String hostingType, ComponentName hostingName,</span></span></span><br><span class="line"><span class="function"><span class="params">                                       <span class="keyword">boolean</span> allowWhileBooting, <span class="keyword">boolean</span> isolated, </span></span></span><br><span class="line"><span class="function"><span class="params">                                       <span class="keyword">int</span> isolatedUid, <span class="keyword">boolean</span> keepIfLarge,</span></span></span><br><span class="line"><span class="function"><span class="params">                                       String abiOverride, String entryPoint, </span></span></span><br><span class="line"><span class="function"><span class="params">                                       String[] entryPointArgs, Runnable crashHandler)</span> </span>&#123;</span><br><span class="line">                                       </span><br><span class="line">   ... ... ... ...</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 最后又调用了第一组方法中的第二个方法！！</span></span><br><span class="line">    startProcessLocked(app, hostingType, hostingNameStr, abiOverride,   </span><br><span class="line">                                              entryPoint, entryPointArgs);</span><br><span class="line"></span><br><span class="line">    checkTime(startTime, <span class="string">"startProcess: done starting proc!"</span>);</span><br><span class="line">    <span class="keyword">return</span> (app.pid != <span class="number">0</span>) ? app : <span class="keyword">null</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>第二组，可以看出启动方式是通过应用的进程名和 ApplicationInfo来启动进程的！<br>参数传递：</p>
<ul>
<li><strong>String processName</strong>：进程名字，默认为包名！</li>
<li><strong>ApplicationInfo info</strong>：进程所属应用的信息对象！</li>
<li><strong>boolean knownToBeDead</strong>：父进程是否需要在该进程死亡后接到通知！</li>
<li><strong>int intentFlags</strong>：intent 启动的 flags 参数！</li>
<li><strong>String hostingType</strong>：值为 “activity”，“service”，“broadcast” 或者 “content provider”；</li>
<li><strong>String hostingNameStr</strong>：数据类型为 ComponentName，代表的是具体相对应的组件名！</li>
<li><strong>boolean allowWhileBooting</strong>：这个在AMS的启动篇里有涉及过，表示开机时是否拉起该进程!</li>
<li><strong>boolean isolated</strong>：表示该进程是否是一个隔离进程！</li>
<li><strong>int isolatedUid</strong>：0 隔离进程的 uid！</li>
<li><strong>boolean keepIfLarge</strong>：</li>
<li><strong>String abiOverride：null</strong></li>
<li><strong>String entryPoint：null</strong></li>
<li><strong>String[] entryPointArgs：null</strong></li>
<li><strong>Runnable crashHandler：null</strong></li>
</ul>
<p>最后，都调用了：<br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">final</span> <span class="keyword">void</span> <span class="title">startProcessLocked</span><span class="params">(ProcessRecord app, String hostingType,</span></span></span><br><span class="line"><span class="function"><span class="params">                                  String hostingNameStr, String abiOverride,                                                  String entryPoint, String[] entryPointArgs)</span> </span>&#123;</span><br><span class="line">   ... ... ... ...</span><br></pre></td></tr></table></figure></p>
<p>接着，我们进入今天的正文，进程的启动！！</p>
<h1 id="3-startProcessLocked-启动"><a href="#3-startProcessLocked-启动" class="headerlink" title="3 startProcessLocked - 启动"></a>3 startProcessLocked - 启动</h1><p>接下来，我们来看看用进程名 precessName 和应用的 ApplicationInfo 对象启动进程的方法，这个方法略微有些长，我们来仔细的分析：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">final</span> ProcessRecord <span class="title">startProcessLocked</span><span class="params">(String processName, ApplicationInfo info,</span></span></span><br><span class="line"><span class="function"><span class="params">        <span class="keyword">boolean</span> knownToBeDead, <span class="keyword">int</span> intentFlags, String hostingType, ComponentName hostingName,</span></span></span><br><span class="line"><span class="function"><span class="params">        <span class="keyword">boolean</span> allowWhileBooting, <span class="keyword">boolean</span> isolated, <span class="keyword">int</span> isolatedUid, <span class="keyword">boolean</span> keepIfLarge,</span></span></span><br><span class="line"><span class="function"><span class="params">        String abiOverride, String entryPoint, String[] entryPointArgs, Runnable crashHandler)</span> </span>&#123;</span><br><span class="line">        </span><br><span class="line">    <span class="keyword">long</span> startTime = SystemClock.elapsedRealtime();</span><br><span class="line">    ProcessRecord app;</span><br><span class="line">    <span class="comment">//【1】如果该进程不是一个隔离进程！</span></span><br><span class="line">    <span class="keyword">if</span> (!isolated) &#123; </span><br><span class="line">        <span class="comment">//【1】尝试获得其对应的 ProcessRecord 对象！</span></span><br><span class="line">        app = getProcessRecordLocked(processName, info.uid, keepIfLarge);</span><br><span class="line">        checkTime(startTime, <span class="string">"startProcess: after getProcessRecord"</span>);</span><br><span class="line">        </span><br><span class="line">        <span class="keyword">if</span> ((intentFlags &amp; Intent.FLAG_FROM_BACKGROUND) != <span class="number">0</span>) &#123;</span><br><span class="line"></span><br><span class="line">            <span class="comment">// 如果是后台操作启动该进程，需要判断该进程是否是一个 bad 进程，如果是，启动失败！</span></span><br><span class="line">            <span class="keyword">if</span> (mAppErrors.isBadProcessLocked(info)) &#123;</span><br><span class="line">                <span class="keyword">if</span> (DEBUG_PROCESSES) Slog.v(TAG, <span class="string">"Bad process: "</span> + info.uid</span><br><span class="line">                        + <span class="string">"/"</span> + info.processName);</span><br><span class="line">                <span class="keyword">return</span> <span class="keyword">null</span>;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line"></span><br><span class="line">            <span class="keyword">if</span> (DEBUG_PROCESSES) Slog.v(TAG, <span class="string">"Clearing bad process: "</span> + info.uid</span><br><span class="line">                    + <span class="string">"/"</span> + info.processName);</span><br><span class="line"></span><br><span class="line">            <span class="comment">// 如果是用户交互，主动启动这个进程，那么，就要清空这个进程的 crash  次数</span></span><br><span class="line">            <span class="comment">// 并且将该进程从 bad 列表中移除，变为一个 good 进程！</span></span><br><span class="line">            <span class="comment">// 直到下一次再次 crash 才会变成一个 bad 进程！</span></span><br><span class="line">            mAppErrors.resetProcessCrashTimeLocked(info);</span><br><span class="line">            <span class="keyword">if</span> (mAppErrors.isBadProcessLocked(info)) &#123;</span><br><span class="line">                EventLog.writeEvent(EventLogTags.AM_PROC_GOOD,</span><br><span class="line">                        UserHandle.getUserId(info.uid), info.uid,</span><br><span class="line">                        info.processName);</span><br><span class="line"></span><br><span class="line">                mAppErrors.clearBadProcessLocked(info);</span><br><span class="line">                <span class="keyword">if</span> (app != <span class="keyword">null</span>) &#123;</span><br><span class="line">                    app.bad = <span class="keyword">false</span>;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 对于隔离进程，不能利用已存在的 ProcessRecord！</span></span><br><span class="line">        app = <span class="keyword">null</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// app launch boost for big.little configurations</span></span><br><span class="line">    <span class="comment">// use cpusets to migrate freshly launched tasks to big cores</span></span><br><span class="line">    nativeMigrateToBoost();</span><br><span class="line">    mIsBoosted = <span class="keyword">true</span>;</span><br><span class="line">    mBoostStartTime = SystemClock.uptimeMillis();</span><br><span class="line">    Message msg = mHandler.obtainMessage(APP_BOOST_DEACTIVATE_MSG);</span><br><span class="line">    mHandler.sendMessageDelayed(msg, APP_BOOST_MESSAGE_DELAY);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (DEBUG_PROCESSES) Slog.v(TAG_PROCESSES, <span class="string">"startProcess: name="</span> + processName</span><br><span class="line">            + <span class="string">" app="</span> + app + <span class="string">" knownToBeDead="</span> + knownToBeDead</span><br><span class="line">            + <span class="string">" thread="</span> + (app != <span class="keyword">null</span> ? app.thread : <span class="keyword">null</span>)</span><br><span class="line">            + <span class="string">" pid="</span> + (app != <span class="keyword">null</span> ? app.pid : -<span class="number">1</span>));</span><br><span class="line"></span><br><span class="line">     <span class="comment">// 如果 app 不为 null，且 pid 大于 0，说明这个进程已经或者正在启动！</span></span><br><span class="line">    <span class="keyword">if</span> (app != <span class="keyword">null</span> &amp;&amp; app.pid &gt; <span class="number">0</span>) &#123;</span><br><span class="line">    </span><br><span class="line">        <span class="comment">// 如果调用者不知道该进程已死亡，并且进程并没有被 kill（正在运行）</span></span><br><span class="line">        <span class="comment">// 或是该 ProcessRecord 没有绑定应用程序进程的 ApplicationThread 对象！</span></span><br><span class="line">        <span class="keyword">if</span> ((!knownToBeDead &amp;&amp; !app.killed) || app.thread == <span class="keyword">null</span>) &#123;</span><br><span class="line"></span><br><span class="line">            <span class="keyword">if</span> (DEBUG_PROCESSES) Slog.v(TAG_PROCESSES, <span class="string">"App already running: "</span> + app);</span><br><span class="line"></span><br><span class="line">            <span class="comment">// 如果这是该进程中的一个新应用 package，将其加入到进程的列表中！</span></span><br><span class="line">            app.addPackage(info.packageName, info.versionCode, mProcessStats);</span><br><span class="line">            checkTime(startTime, <span class="string">"startProcess: done, added package to proc"</span>);</span><br><span class="line">            </span><br><span class="line">            <span class="comment">// 直接返回这个已经存在的 ProcessRecord，退出！</span></span><br><span class="line">            <span class="keyword">return</span> app;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// An application record is attached to a previous process,</span></span><br><span class="line">        <span class="comment">// clean it up now.</span></span><br><span class="line">        <span class="keyword">if</span> (DEBUG_PROCESSES || DEBUG_CLEANUP) Slog.v(TAG_PROCESSES, <span class="string">"App died: "</span> + app);</span><br><span class="line">        checkTime(startTime, <span class="string">"startProcess: bad proc running, killing"</span>);</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 该 ProcessRecord 已经绑定了上一个进程，杀死并清理该进程！</span></span><br><span class="line">        killProcessGroup(app.uid, app.pid);</span><br><span class="line">        handleAppDiedLocked(app, <span class="keyword">true</span>, <span class="keyword">true</span>);</span><br><span class="line">        checkTime(startTime, <span class="string">"startProcess: done killing old proc"</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    String hostingNameStr = hostingName != <span class="keyword">null</span></span><br><span class="line">            ? hostingName.flattenToShortString() : <span class="keyword">null</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (app == <span class="keyword">null</span>) &#123; <span class="comment">// 如果 app 为 null，那说明这是一个新进程！</span></span><br><span class="line">        checkTime(startTime, <span class="string">"startProcess: creating new process record"</span>);</span><br><span class="line">        </span><br><span class="line">        <span class="comment">// 创建新进程对应的 ProcessRecord 对象！</span></span><br><span class="line">        app = newProcessRecordLocked(info, processName, isolated, isolatedUid);</span><br><span class="line">        <span class="keyword">if</span> (app == <span class="keyword">null</span>) &#123;</span><br><span class="line">            Slog.w(TAG, <span class="string">"Failed making new process record for "</span></span><br><span class="line">                    + processName + <span class="string">"/"</span> + info.uid + <span class="string">" isolated="</span> + isolated);</span><br><span class="line">            <span class="keyword">return</span> <span class="keyword">null</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        </span><br><span class="line">        <span class="comment">// 设置进程的 crashHandler，默认为 null！</span></span><br><span class="line">        app.crashHandler = crashHandler;</span><br><span class="line">        checkTime(startTime, <span class="string">"startProcess: done creating new process record"</span>);</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 如果这是该进程中的一个新应用 package，将其加入到进程的列表中！</span></span><br><span class="line">        app.addPackage(info.packageName, info.versionCode, mProcessStats);</span><br><span class="line">        checkTime(startTime, <span class="string">"startProcess: added package to existing proc"</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 如果系统还没准备好，则将当前进程加入到 mPorcessOnHold 中！</span></span><br><span class="line">    <span class="keyword">if</span> (!mProcessesReady</span><br><span class="line">            &amp;&amp; !isAllowedWhileBooting(info)</span><br><span class="line">            &amp;&amp; !allowWhileBooting) &#123;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (!mProcessesOnHold.contains(app)) &#123;</span><br><span class="line">            mProcessesOnHold.add(app);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">if</span> (DEBUG_PROCESSES) Slog.v(TAG_PROCESSES,</span><br><span class="line">                <span class="string">"System not ready, putting on hold: "</span> + app);</span><br><span class="line">        checkTime(startTime, <span class="string">"startProcess: returning with proc on hold"</span>);</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 返回这个进程对应的 ProcessRecord 对象！</span></span><br><span class="line">        <span class="keyword">return</span> app;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    checkTime(startTime, <span class="string">"startProcess: stepping in to startProcess"</span>);</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 到这里，说明进程还没有创建，接着调用 startRrocessLocked 方法，进行进一步的启动！</span></span><br><span class="line">    startProcessLocked(</span><br><span class="line">            app, hostingType, hostingNameStr, abiOverride, entryPoint, entryPointArgs);</span><br><span class="line">            </span><br><span class="line"></span><br><span class="line">    checkTime(startTime, <span class="string">"startProcess: done starting proc!"</span>);</span><br><span class="line">    <span class="keyword">return</span> (app.pid != <span class="number">0</span>) ? app : <span class="keyword">null</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>继续分析！</p>
<h2 id="3-1-AMS-newProcessRecordLocked"><a href="#3-1-AMS-newProcessRecordLocked" class="headerlink" title="3.1 AMS.newProcessRecordLocked"></a>3.1 AMS.newProcessRecordLocked</h2><p>创建进程对应的 ProcessRecord 结构体，参数传递：</p>
<ul>
<li>ApplicationInfo info：应用程序的 info 对象！</li>
<li>String customProcess：进程名</li>
<li>boolean isolated：是否是隔离进程！</li>
<li>int isolatedUid：隔离进程的 uid，默认传入 0！</li>
</ul>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">final</span> ProcessRecord <span class="title">newProcessRecordLocked</span><span class="params">(ApplicationInfo info, String customProcess,</span></span></span><br><span class="line"><span class="function"><span class="params">        <span class="keyword">boolean</span> isolated, <span class="keyword">int</span> isolatedUid)</span> </span>&#123;</span><br><span class="line">    String proc = customProcess != <span class="keyword">null</span> ? customProcess : info.processName;</span><br><span class="line">    BatteryStatsImpl stats = mBatteryStatsService.getActiveStatistics();</span><br><span class="line">    <span class="keyword">final</span> <span class="keyword">int</span> userId = UserHandle.getUserId(info.uid);</span><br><span class="line">    <span class="keyword">int</span> uid = info.uid;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (isolated) &#123; <span class="comment">// 隔离进程！</span></span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (isolatedUid == <span class="number">0</span>) &#123; <span class="comment">//如果传入的值的是默认值 0，系统会给隔离进程分配 uid！</span></span><br><span class="line">            <span class="keyword">int</span> stepsLeft = Process.LAST_ISOLATED_UID - Process.FIRST_ISOLATED_UID + <span class="number">1</span>;</span><br><span class="line">            <span class="keyword">while</span> (<span class="keyword">true</span>) &#123;</span><br><span class="line">                <span class="keyword">if</span> (mNextIsolatedProcessUid &lt; Process.FIRST_ISOLATED_UID</span><br><span class="line">                        || mNextIsolatedProcessUid &gt; Process.LAST_ISOLATED_UID) &#123;</span><br><span class="line">                    mNextIsolatedProcessUid = Process.FIRST_ISOLATED_UID;</span><br><span class="line">                &#125;</span><br><span class="line">                uid = UserHandle.getUid(userId, mNextIsolatedProcessUid);</span><br><span class="line">                mNextIsolatedProcessUid++;</span><br><span class="line">                <span class="keyword">if</span> (mIsolatedProcesses.indexOfKey(uid) &lt; <span class="number">0</span>) &#123;</span><br><span class="line">                    <span class="comment">// No process for this uid, use it.</span></span><br><span class="line">                    <span class="keyword">break</span>;</span><br><span class="line">                &#125;</span><br><span class="line">                stepsLeft--;</span><br><span class="line">                <span class="keyword">if</span> (stepsLeft &lt;= <span class="number">0</span>) &#123;</span><br><span class="line">                    <span class="keyword">return</span> <span class="keyword">null</span>;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123; <span class="comment">// 如果传入的不是默认值 0，那隔离进程的 uid 就由传入参数指定！</span></span><br><span class="line">            uid = isolatedUid;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// Register the isolated UID with this application so BatteryStats knows to</span></span><br><span class="line">        <span class="comment">// attribute resource usage to the application.</span></span><br><span class="line">        <span class="comment">//</span></span><br><span class="line">        <span class="comment">// <span class="doctag">NOTE:</span> This is done here before addProcessNameLocked, which will tell BatteryStats</span></span><br><span class="line">        <span class="comment">// about the process state of the isolated UID *before* it is registered with the</span></span><br><span class="line">        <span class="comment">// owning application.</span></span><br><span class="line">        mBatteryStatsService.addIsolatedUid(uid, info.uid);</span><br><span class="line">    &#125;</span><br><span class="line"> </span><br><span class="line">    <span class="comment">// 创建 ProcessRecord 对象！</span></span><br><span class="line">    <span class="keyword">final</span> ProcessRecord r = <span class="keyword">new</span> ProcessRecord(stats, info, proc, uid);</span><br><span class="line">    <span class="keyword">if</span> (!mBooted &amp;&amp; !mBooting</span><br><span class="line">            &amp;&amp; userId == UserHandle.USER_SYSTEM</span><br><span class="line">            &amp;&amp; (info.flags &amp; PERSISTENT_MASK) == PERSISTENT_MASK) &#123;</span><br><span class="line">        <span class="comment">// 设置其 persistent 属性 为 true！</span></span><br><span class="line">        r.persistent = <span class="keyword">true</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// 见 3.1.1</span></span><br><span class="line">    addProcessNameLocked(r);</span><br><span class="line">    <span class="keyword">return</span> r;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h3 id="3-1-1-AMS-addProcessNameLocked"><a href="#3-1-1-AMS-addProcessNameLocked" class="headerlink" title="3.1.1 AMS.addProcessNameLocked"></a>3.1.1 AMS.addProcessNameLocked</h3><p>接着，调用该方法，将新创建的 ProcessRecord 加入到 AMS 对应的集合：<br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">final</span> <span class="keyword">void</span> <span class="title">addProcessNameLocked</span><span class="params">(ProcessRecord proc)</span> </span>&#123;</span><br><span class="line">    <span class="comment">// We shouldn't already have a process under this name, but just in case we</span></span><br><span class="line">    <span class="comment">// need to clean up whatever may be there now.</span></span><br><span class="line">    </span><br><span class="line">    <span class="comment">// 移除相同的之前被添加过的进程！</span></span><br><span class="line">    ProcessRecord old = removeProcessNameLocked(proc.processName, proc.uid);</span><br><span class="line">    <span class="keyword">if</span> (old == proc &amp;&amp; proc.persistent) &#123;</span><br><span class="line">        <span class="comment">// We are re-adding a persistent process.  Whatevs!  Just leave it there.</span></span><br><span class="line">        Slog.w(TAG, <span class="string">"Re-adding persistent process "</span> + proc);</span><br><span class="line">    &#125; <span class="keyword">else</span> <span class="keyword">if</span> (old != <span class="keyword">null</span>) &#123;</span><br><span class="line">        Slog.wtf(TAG, <span class="string">"Already have existing proc "</span> + old + <span class="string">" when adding "</span> + proc);</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// 给这个进程的所属 uid 创建 UidRecord 对象，如果已创建过了，就不创建！！</span></span><br><span class="line">    UidRecord uidRec = mActiveUids.get(proc.uid);</span><br><span class="line">    <span class="keyword">if</span> (uidRec == <span class="keyword">null</span>) &#123;</span><br><span class="line">        uidRec = <span class="keyword">new</span> UidRecord(proc.uid);</span><br><span class="line">        <span class="comment">// This is the first appearance of the uid, report it now!</span></span><br><span class="line">        <span class="keyword">if</span> (DEBUG_UID_OBSERVERS) Slog.i(TAG_UID_OBSERVERS,</span><br><span class="line">                <span class="string">"Creating new process uid: "</span> + uidRec);</span><br><span class="line">        <span class="comment">// 第一次创建时，要加入到 mActiveUids 集合中去！        </span></span><br><span class="line">        mActiveUids.put(proc.uid, uidRec);</span><br><span class="line">        noteUidProcessState(uidRec.uid, uidRec.curProcState);</span><br><span class="line">        enqueueUidChangeLocked(uidRec, -<span class="number">1</span>, UidRecord.CHANGE_ACTIVE);</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// 添加 proc 对 UidRecord 引用！</span></span><br><span class="line">    proc.uidRecord = uidRec;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// Reset render thread tid if it was already set, so new process can set it again.</span></span><br><span class="line">    proc.renderThreadTid = <span class="number">0</span>;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// UidRecord 的被引用计数加 1</span></span><br><span class="line">    uidRec.numProcs++;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// 将新创建的 ProcessRecord 对象加入到 ams 的 ProcessNames 中！</span></span><br><span class="line">    mProcessNames.put(proc.processName, proc.uid, proc);</span><br><span class="line">    <span class="keyword">if</span> (proc.isolated) &#123;</span><br><span class="line">        <span class="comment">// 如果该进程是隔离进程，还要添加到 mIsolatedProcesses 集合中去！！</span></span><br><span class="line">        mIsolatedProcesses.put(proc.uid, proc);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>这里有提到 AMS 的几个成员对象：</p>
<ul>
<li>mActiveUids：当前活跃的 uid 集合；</li>
<li>mProcessNames：以进程的 processName 为 key，存储所有的 ProcessRecord 对象！</li>
<li>mIsolatedProcesses：以进程的 pid 为 key，存储所有的 ProcessRecord 对象！</li>
</ul>
<h1 id="4-startProcessLocked-ProcessRecord"><a href="#4-startProcessLocked-ProcessRecord" class="headerlink" title="4 startProcessLocked - ProcessRecord"></a>4 startProcessLocked - ProcessRecord</h1><p>接着们就要进入最关键的一个方法哦，启动进程！<br>参数传递：</p>
<ul>
<li>ProcessRecord app, </li>
<li>String hostingType,</li>
<li>String hostingNameStr：</li>
<li>String abiOverride：</li>
<li>String entryPoint：null</li>
<li>String[] entryPointArg：null</li>
</ul>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br><span class="line">212</span><br><span class="line">213</span><br><span class="line">214</span><br><span class="line">215</span><br><span class="line">216</span><br><span class="line">217</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">final</span> <span class="keyword">void</span> <span class="title">startProcessLocked</span><span class="params">(ProcessRecord app, String hostingType,</span></span></span><br><span class="line"><span class="function"><span class="params">        String hostingNameStr, String abiOverride, String entryPoint, String[] entryPointArgs)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">long</span> startTime = SystemClock.elapsedRealtime();</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 如果要启动的进程不是 systemServer 进程，也就是应用进程！</span></span><br><span class="line">    <span class="keyword">if</span> (app.pid &gt; <span class="number">0</span> &amp;&amp; app.pid != MY_PID) &#123;</span><br><span class="line">        checkTime(startTime, <span class="string">"startProcess: removing from pids map"</span>);</span><br><span class="line"></span><br><span class="line">        <span class="keyword">synchronized</span> (mPidsSelfLocked) &#123;</span><br><span class="line">            <span class="comment">// 将进程从 mPidsSelfLocked 中移除！</span></span><br><span class="line">            mPidsSelfLocked.remove(app.pid);</span><br><span class="line">            mHandler.removeMessages(PROC_START_TIMEOUT_MSG, app);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        checkTime(startTime, <span class="string">"startProcess: done removing from pids map"</span>);</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 先设置进程的 pid 为 0！</span></span><br><span class="line">        app.setPid(<span class="number">0</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (DEBUG_PROCESSES &amp;&amp; mProcessesOnHold.contains(app)) Slog.v(TAG_PROCESSES,</span><br><span class="line">            <span class="string">"startProcessLocked removing on hold: "</span> + app);</span><br><span class="line">            </span><br><span class="line">    <span class="comment">// 记得前面的 mProcessesOnHold 吗？也要把进程从这里 remove 掉！</span></span><br><span class="line">    mProcessesOnHold.remove(app);</span><br><span class="line"></span><br><span class="line">    checkTime(startTime, <span class="string">"startProcess: starting to update cpu stats"</span>);</span><br><span class="line">    updateCpuStats();</span><br><span class="line">    checkTime(startTime, <span class="string">"startProcess: done updating cpu stats"</span>);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            <span class="comment">// 获得设备用户 id!</span></span><br><span class="line">            <span class="keyword">final</span> <span class="keyword">int</span> userId = UserHandle.getUserId(app.uid);</span><br><span class="line">            AppGlobals.getPackageManager().checkPackageStartable(app.info.packageName, userId);</span><br><span class="line">        &#125; <span class="keyword">catch</span> (RemoteException e) &#123;</span><br><span class="line">            <span class="keyword">throw</span> e.rethrowAsRuntimeException();</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">int</span> uid = app.uid;</span><br><span class="line">        <span class="keyword">int</span>[] gids = <span class="keyword">null</span>;</span><br><span class="line">        <span class="keyword">int</span> mountExternal = Zygote.MOUNT_EXTERNAL_NONE;</span><br><span class="line">        </span><br><span class="line">        <span class="keyword">if</span> (!app.isolated) &#123; <span class="comment">// 对于非隔离的进程！</span></span><br><span class="line"></span><br><span class="line">            <span class="keyword">int</span>[] permGids = <span class="keyword">null</span>;</span><br><span class="line">            <span class="keyword">try</span> &#123;</span><br><span class="line"></span><br><span class="line">                checkTime(startTime, <span class="string">"startProcess: getting gids from package manager"</span>);</span><br><span class="line">                <span class="keyword">final</span> IPackageManager pm = AppGlobals.getPackageManager();</span><br><span class="line"></span><br><span class="line">                permGids = pm.getPackageGids(app.info.packageName,</span><br><span class="line">                        MATCH_DEBUG_TRIAGED_MISSING, app.userId);</span><br><span class="line"></span><br><span class="line">                MountServiceInternal mountServiceInternal = LocalServices.getService(</span><br><span class="line">                        MountServiceInternal.class);</span><br><span class="line"></span><br><span class="line">                mountExternal = mountServiceInternal.getExternalStorageMountMode(uid,</span><br><span class="line">                        app.info.packageName);</span><br><span class="line"></span><br><span class="line">            &#125; <span class="keyword">catch</span> (RemoteException e) &#123;</span><br><span class="line">                <span class="keyword">throw</span> e.rethrowAsRuntimeException();</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            <span class="comment">/*</span></span><br><span class="line"><span class="comment">             * Add shared application and profile GIDs so applications can share some</span></span><br><span class="line"><span class="comment">             * resources like shared libraries and access user-wide resources</span></span><br><span class="line"><span class="comment">             */</span></span><br><span class="line">            <span class="keyword">if</span> (ArrayUtils.isEmpty(permGids)) &#123;</span><br><span class="line">                gids = <span class="keyword">new</span> <span class="keyword">int</span>[<span class="number">2</span>];</span><br><span class="line">            &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                gids = <span class="keyword">new</span> <span class="keyword">int</span>[permGids.length + <span class="number">2</span>];</span><br><span class="line">                System.arraycopy(permGids, <span class="number">0</span>, gids, <span class="number">2</span>, permGids.length);</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            gids[<span class="number">0</span>] = UserHandle.getSharedAppGid(UserHandle.getAppId(uid));</span><br><span class="line">            gids[<span class="number">1</span>] = UserHandle.getUserGid(UserHandle.getUserId(uid));</span><br><span class="line">        &#125;</span><br><span class="line">        checkTime(startTime, <span class="string">"startProcess: building args"</span>);</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (mFactoryTest != FactoryTest.FACTORY_TEST_OFF) &#123;</span><br><span class="line">            <span class="keyword">if</span> (mFactoryTest == FactoryTest.FACTORY_TEST_LOW_LEVEL</span><br><span class="line">                    &amp;&amp; mTopComponent != <span class="keyword">null</span></span><br><span class="line">                    &amp;&amp; app.processName.equals(mTopComponent.getPackageName())) &#123;</span><br><span class="line">                uid = <span class="number">0</span>;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">if</span> (mFactoryTest == FactoryTest.FACTORY_TEST_HIGH_LEVEL</span><br><span class="line">                    &amp;&amp; (app.info.flags&amp;ApplicationInfo.FLAG_FACTORY_TEST) != <span class="number">0</span>) &#123;</span><br><span class="line">                uid = <span class="number">0</span>;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        </span><br><span class="line">        <span class="comment">// 处理 debugFlags 相关的取值！</span></span><br><span class="line">        <span class="keyword">int</span> debugFlags = <span class="number">0</span>;</span><br><span class="line">       </span><br><span class="line">        ... ... ... ...<span class="comment">// 此处是设置调试相关的代码，暂时省略！ </span></span><br><span class="line">       </span><br><span class="line">        <span class="comment">// 设置 app 要运行的硬件环境！</span></span><br><span class="line">        String requiredAbi = (abiOverride != <span class="keyword">null</span>) ? abiOverride : app.info.primaryCpuAbi;</span><br><span class="line">        <span class="keyword">if</span> (requiredAbi == <span class="keyword">null</span>) &#123;</span><br><span class="line">            requiredAbi = Build.SUPPORTED_ABIS[<span class="number">0</span>];</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        String instructionSet = <span class="keyword">null</span>;</span><br><span class="line">        <span class="keyword">if</span> (app.info.primaryCpuAbi != <span class="keyword">null</span>) &#123;</span><br><span class="line">            instructionSet = VMRuntime.getInstructionSet(app.info.primaryCpuAbi);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 设置进程的 gids，运行的环境等等！</span></span><br><span class="line">        app.gids = gids;</span><br><span class="line">        app.requiredAbi = requiredAbi;</span><br><span class="line">        app.instructionSet = instructionSet;</span><br><span class="line"></span><br><span class="line">        </span><br><span class="line">        <span class="comment">// 设置新进程创建后的入口："android.app.ActivityThread"</span></span><br><span class="line">        <span class="keyword">boolean</span> isActivityProcess = (entryPoint == <span class="keyword">null</span>);</span><br><span class="line">        <span class="keyword">if</span> (entryPoint == <span class="keyword">null</span>) entryPoint = <span class="string">"android.app.ActivityThread"</span>;</span><br><span class="line">        Trace.traceBegin(Trace.TRACE_TAG_ACTIVITY_MANAGER, <span class="string">"Start proc: "</span> +</span><br><span class="line">                app.processName);</span><br><span class="line"></span><br><span class="line">        checkTime(startTime, <span class="string">"startProcess: asking zygote to start proc"</span>);</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 这里很关键！！调用了 Process.Start 方法，创建新进程，并返回创建结果！</span></span><br><span class="line">        <span class="comment">// 这类返回 startResult 包含子进程的 pid 等信息！</span></span><br><span class="line">        Process.ProcessStartResult startResult = Process.start(entryPoint,</span><br><span class="line">                app.processName, uid, uid, gids, debugFlags, mountExternal,</span><br><span class="line">                app.info.targetSdkVersion, app.info.seinfo, requiredAbi, instructionSet,</span><br><span class="line">                app.info.dataDir, entryPointArgs);</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">        checkTime(startTime, <span class="string">"startProcess: returned from zygote!"</span>);</span><br><span class="line">        Trace.traceEnd(Trace.TRACE_TAG_ACTIVITY_MANAGER);</span><br><span class="line"></span><br><span class="line">        mBatteryStatsService.noteProcessStart(app.processName, app.info.uid);</span><br><span class="line">        checkTime(startTime, <span class="string">"startProcess: done updating battery stats"</span>);</span><br><span class="line"></span><br><span class="line">        EventLog.writeEvent(EventLogTags.AM_PROC_START,</span><br><span class="line">                UserHandle.getUserId(uid), startResult.pid, uid,</span><br><span class="line">                app.processName, hostingType,</span><br><span class="line">                hostingNameStr != <span class="keyword">null</span> ? hostingNameStr : <span class="string">""</span>);</span><br><span class="line"></span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            AppGlobals.getPackageManager().logAppProcessStartIfNeeded(app.processName, app.uid,</span><br><span class="line">                    app.info.seinfo, app.info.sourceDir, startResult.pid);</span><br><span class="line">        &#125; <span class="keyword">catch</span> (RemoteException ex) &#123;</span><br><span class="line">            <span class="comment">// Ignore</span></span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (app.persistent) &#123; <span class="comment">// 如果是 persistent 的进程，启动 WathDog 进行监控！</span></span><br><span class="line">            Watchdog.getInstance().processStarted(app.processName, startResult.pid);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        checkTime(startTime, <span class="string">"startProcess: building log message"</span>);</span><br><span class="line">        StringBuilder buf = mStringBuilder;</span><br><span class="line">        buf.setLength(<span class="number">0</span>);</span><br><span class="line">        buf.append(<span class="string">"Start proc "</span>);</span><br><span class="line">        buf.append(startResult.pid);</span><br><span class="line">        buf.append(<span class="string">':'</span>);</span><br><span class="line">        buf.append(app.processName);</span><br><span class="line">        buf.append(<span class="string">'/'</span>);</span><br><span class="line">        UserHandle.formatUid(buf, uid);</span><br><span class="line">        <span class="keyword">if</span> (!isActivityProcess) &#123;</span><br><span class="line">            buf.append(<span class="string">" ["</span>);</span><br><span class="line">            buf.append(entryPoint);</span><br><span class="line">            buf.append(<span class="string">"]"</span>);</span><br><span class="line">        &#125;</span><br><span class="line">        buf.append(<span class="string">" for "</span>);</span><br><span class="line">        buf.append(hostingType);</span><br><span class="line">        <span class="keyword">if</span> (hostingNameStr != <span class="keyword">null</span>) &#123;</span><br><span class="line">            buf.append(<span class="string">" "</span>);</span><br><span class="line">            buf.append(hostingNameStr);</span><br><span class="line">        &#125;</span><br><span class="line">        Slog.i(TAG, buf.toString());</span><br><span class="line">        </span><br><span class="line">        <span class="comment">// 根据创建进程的返回结果设置对应的 ProcessRecord 的参数：pid 等等！</span></span><br><span class="line">        app.setPid(startResult.pid);</span><br><span class="line">        app.usingWrapper = startResult.usingWrapper;</span><br><span class="line">        app.removed = <span class="keyword">false</span>;</span><br><span class="line">        app.killed = <span class="keyword">false</span>;</span><br><span class="line">        app.killedByAm = <span class="keyword">false</span>;</span><br><span class="line">        checkTime(startTime, <span class="string">"startProcess: starting to update pids map"</span>);</span><br><span class="line"></span><br><span class="line">        ProcessRecord oldApp;</span><br><span class="line">        <span class="keyword">synchronized</span> (mPidsSelfLocked) &#123;</span><br><span class="line">            oldApp = mPidsSelfLocked.get(startResult.pid);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 如果已经有一个应用进程占用了分配的 pid，那就对这个进程进行清理！</span></span><br><span class="line">        <span class="keyword">if</span> (oldApp != <span class="keyword">null</span> &amp;&amp; !app.isolated) &#123;</span><br><span class="line">            <span class="comment">// Clean up anything relating to this pid first</span></span><br><span class="line">            Slog.w(TAG, <span class="string">"Reusing pid "</span> + startResult.pid</span><br><span class="line">                    + <span class="string">" while app is still mapped to it"</span>);</span><br><span class="line">            cleanUpApplicationRecordLocked(oldApp, <span class="keyword">false</span>, <span class="keyword">false</span>, -<span class="number">1</span>,</span><br><span class="line">                    <span class="keyword">true</span> <span class="comment">/*replacingPid*/</span>);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">synchronized</span> (mPidsSelfLocked) &#123;</span><br><span class="line"></span><br><span class="line">            <span class="comment">// 将新创建的进程加入到 mPidsSelfLocked，用于 AMS 进行管理！ </span></span><br><span class="line">            <span class="keyword">this</span>.mPidsSelfLocked.put(startResult.pid, app);</span><br><span class="line">            <span class="keyword">if</span> (isActivityProcess) &#123;</span><br><span class="line">                Message msg = mHandler.obtainMessage(PROC_START_TIMEOUT_MSG);</span><br><span class="line">                msg.obj = app;</span><br><span class="line">                mHandler.sendMessageDelayed(msg, startResult.usingWrapper</span><br><span class="line">                        ? PROC_START_TIMEOUT_WITH_WRAPPER : PROC_START_TIMEOUT);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        checkTime(startTime, <span class="string">"startProcess: done updating pids map"</span>);</span><br><span class="line"></span><br><span class="line">    &#125; <span class="keyword">catch</span> (RuntimeException e) &#123;</span><br><span class="line">        Slog.e(TAG, <span class="string">"Failure starting process "</span> + app.processName, e);</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 进程启动失败：比如，进程被冻结了等等，就调用  forceStopPackageLocked 清理进程！</span></span><br><span class="line">        forceStopPackageLocked(app.info.packageName, UserHandle.getAppId(app.uid), <span class="keyword">false</span>,</span><br><span class="line">                <span class="keyword">false</span>, <span class="keyword">true</span>, <span class="keyword">false</span>, <span class="keyword">false</span>, UserHandle.getUserId(app.userId), <span class="string">"start failure"</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>这个方法很长，我们回顾一下它的主要作用：</p>
<ul>
<li>先将进程的 pid 设置为 0，</li>
<li>根据不同参数，设置相应的 debugFlags，比如在 AndroidManifest.xml 中设置 androidd:debuggable 为 true，代表 app 运行在 debug 模式，则增加 debugger 标识以及开启 JNI check 功能等等。</li>
<li>调用 <strong>Process.start</strong> 进入 Zygote，来创建新进程，并返回创建的结果 ProcessStartResult 。</li>
<li>根据 fork 的结果，再次设置 ProcessRecord 的成员变量， 包括 pid， killded，killedByAm 等等属性！</li>
</ul>
<p>可以看出，这个方法的关键，就在于 Process.start 方法，是用来创建进程的，这个方法我们在第二篇：进程的创建一文中有讲，这里因为篇幅关系，就省略了！</p>
<p>接着就要进入这个新进程的 ActivityThread.main 方法了：</p>
<h1 id="5-ActivityThread-main"><a href="#5-ActivityThread-main" class="headerlink" title="5 ActivityThread.main"></a>5 ActivityThread.main</h1><p>这个方法是应用程序进程的入口：<br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> </span>&#123;</span><br><span class="line">    Trace.traceBegin(Trace.TRACE_TAG_ACTIVITY_MANAGER, <span class="string">"ActivityThreadMain"</span>);</span><br><span class="line">    SamplingProfilerIntegration.start();</span><br><span class="line"></span><br><span class="line">    <span class="comment">// CloseGuard defaults to true and can be quite spammy.  We</span></span><br><span class="line">    <span class="comment">// disable it here, but selectively enable it later (via</span></span><br><span class="line">    <span class="comment">// StrictMode) on debug builds, but using DropBox, not logs.</span></span><br><span class="line">    CloseGuard.setEnabled(<span class="keyword">false</span>);</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 将当前进程所在 userId 赋值给 sCurrentUser</span></span><br><span class="line">    Environment.initForCurrentUser();</span><br><span class="line"></span><br><span class="line">    <span class="comment">// Set the reporter for event logging in libcore</span></span><br><span class="line">    EventLogger.setReporter(<span class="keyword">new</span> EventLoggingReporter());</span><br><span class="line"></span><br><span class="line">    <span class="comment">// Make sure TrustedCertificateStore looks in the right place for CA certificates</span></span><br><span class="line">    <span class="keyword">final</span> File configDir = Environment.getUserConfigDirectory(UserHandle.myUserId());</span><br><span class="line">    TrustedCertificateStore.setDefaultUserDirectory(configDir);</span><br><span class="line"></span><br><span class="line">    Process.setArgV0(<span class="string">"&lt;pre-initialized&gt;"</span>);</span><br><span class="line">    <span class="comment">// 创建主线程的 Looper 对象！</span></span><br><span class="line">    Looper.prepareMainLooper();</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// 创建该进程的  ActivityThread 对象！</span></span><br><span class="line">    ActivityThread thread = <span class="keyword">new</span> ActivityThread();</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// attach 到 ActiviyManagerService ，保持进程和 SystemServer 的 binder 通信！</span></span><br><span class="line">    <span class="comment">// 这里我们下面重点讲！</span></span><br><span class="line">    thread.attach(<span class="keyword">false</span>);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (sMainThreadHandler == <span class="keyword">null</span>) &#123;</span><br><span class="line">        <span class="comment">// 获得主线程的 Handler 对象 mH；</span></span><br><span class="line">        sMainThreadHandler = thread.getHandler();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (<span class="keyword">false</span>) &#123; <span class="comment">// 当设置为 true 时，可打开消息队列的 debug log 信息</span></span><br><span class="line">        Looper.myLooper().setMessageLogging(<span class="keyword">new</span></span><br><span class="line">                LogPrinter(Log.DEBUG, <span class="string">"ActivityThread"</span>));</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// End of event ActivityThreadMain.</span></span><br><span class="line">    Trace.traceEnd(Trace.TRACE_TAG_ACTIVITY_MANAGER);</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// 进入消息循环，没消息进入休眠状态，有消息进入唤醒状态!</span></span><br><span class="line">    Looper.loop();</span><br><span class="line"></span><br><span class="line">    <span class="keyword">throw</span> <span class="keyword">new</span> RuntimeException(<span class="string">"Main thread loop unexpectedly exited"</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>这个方法的作用有如下：</p>
<ul>
<li>创建主线程的 Looper 对象，主线程的 Looper 对象是在进程创建后自动创建的！</li>
<li>创建该进程的 ActivityThread 对象，每一个进程都有一个 ActivityThread 对象！<ul>
<li>mAppThread = new ApplicationThread()，创建 ApplicationThread 对象，他是应用进程和 AMS 通信的桥梁；</li>
<li>mLooper = Looper.myLooper()，获得主线程的 Looper 对象；</li>
<li>mH = new H()，H 继承于 Handler 对象，主线程的 Handler，用于处理组件的生命周期！</li>
<li>… … …</li>
</ul>
</li>
<li>获得主线程的 Handler 对象 mH：</li>
<li>进入消息循环：Looper.loop，没有消息进入休眠，有消息就被唤醒，处理消息！</li>
</ul>
<blockquote>
<p><strong>注意</strong>：这里要先说一下：ActivityThread 和 ApplicationThread 对象，二者都不是线程对象！一个应用程序进程对应一个 ActivityThread 实例，应用程序进程由 ActivityThread.main 打开消息循环；同时，一个应用程序进程也对应一个 ApplicationThread 对象，此对象是 ActivityThread 与 ActivityManagerService 连接的桥梁！</p>
</blockquote>
<h1 id="6-ActivityThread-attach"><a href="#6-ActivityThread-attach" class="headerlink" title="6 ActivityThread.attach"></a>6 ActivityThread.attach</h1><p>参数传递：</p>
<ul>
<li>system：表示是否是系统进程的 ActivityThread，调用传入 false。</li>
</ul>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">attach</span><span class="params">(<span class="keyword">boolean</span> system)</span> </span>&#123;</span><br><span class="line">    <span class="comment">// 表示当前进程的 ActivityThread</span></span><br><span class="line">    sCurrentActivityThread = <span class="keyword">this</span>;</span><br><span class="line">    mSystemThread = system;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">if</span> (!system) &#123; <span class="comment">// 应用进程，进入这个分支。</span></span><br><span class="line">        ViewRootImpl.addFirstDrawHandler(<span class="keyword">new</span> Runnable() &#123;</span><br><span class="line">            <span class="meta">@Override</span></span><br><span class="line">            <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">run</span><span class="params">()</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">                <span class="comment">// 开启虚拟机的 jit 即时编译功能</span></span><br><span class="line">                ensureJitEnabled();</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;);</span><br><span class="line">        android.ddm.DdmHandleAppName.setAppName(<span class="string">"&lt;pre-initialized&gt;"</span>,</span><br><span class="line">                                                UserHandle.myUserId());</span><br><span class="line">        RuntimeInit.setApplicationObject(mAppThread.asBinder());</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 获得 AMS </span></span><br><span class="line">        <span class="keyword">final</span> IActivityManager mgr = ActivityManagerNative.getDefault();</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">        </span><br><span class="line">            <span class="comment">// 调用 ams 的 attachApplication 方法</span></span><br><span class="line">            mgr.attachApplication(mAppThread);</span><br><span class="line">            </span><br><span class="line">        &#125; <span class="keyword">catch</span> (RemoteException ex) &#123;</span><br><span class="line">            <span class="keyword">throw</span> ex.rethrowFromSystemServer();</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">// Watch for getting close to heap limit.</span></span><br><span class="line">        <span class="comment">// 观察是否快接近 heap 的上限</span></span><br><span class="line">        BinderInternal.addGcWatcher(<span class="keyword">new</span> Runnable() &#123;</span><br><span class="line">            <span class="meta">@Override</span> <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">run</span><span class="params">()</span> </span>&#123;</span><br><span class="line">                <span class="keyword">if</span> (!mSomeActivitiesChanged) &#123;</span><br><span class="line">                    <span class="keyword">return</span>;</span><br><span class="line">                &#125;</span><br><span class="line">                Runtime runtime = Runtime.getRuntime();</span><br><span class="line">                <span class="keyword">long</span> dalvikMax = runtime.maxMemory();</span><br><span class="line">                <span class="keyword">long</span> dalvikUsed = runtime.totalMemory() - runtime.freeMemory();</span><br><span class="line">                </span><br><span class="line">                <span class="comment">// 当进程虚拟机的已用内存超过最大内存的 3/4</span></span><br><span class="line">                <span class="keyword">if</span> (dalvikUsed &gt; ((<span class="number">3</span>*dalvikMax)/<span class="number">4</span>)) &#123;</span><br><span class="line">                </span><br><span class="line">                    <span class="keyword">if</span> (DEBUG_MEMORY_TRIM) Slog.d(TAG, <span class="string">"Dalvik max="</span> + (dalvikMax/<span class="number">1024</span>)</span><br><span class="line">                            + <span class="string">" total="</span> + (runtime.totalMemory()/<span class="number">1024</span>)</span><br><span class="line">                            + <span class="string">" used="</span> + (dalvikUsed/<span class="number">1024</span>));</span><br><span class="line">                            </span><br><span class="line">                    mSomeActivitiesChanged = <span class="keyword">false</span>;</span><br><span class="line">                    <span class="keyword">try</span> &#123;</span><br><span class="line">                        <span class="comment">// 调用 AMS 的 releaseSomeActivities 方法释放进程的内存！</span></span><br><span class="line">                        mgr.releaseSomeActivities(mAppThread);</span><br><span class="line">                    &#125; <span class="keyword">catch</span> (RemoteException e) &#123;</span><br><span class="line">                        <span class="keyword">throw</span> e.rethrowFromSystemServer();</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;);</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123; <span class="comment">// 这里是处理系统进程的：SystemServer，这里不看</span></span><br><span class="line">        android.ddm.DdmHandleAppName.setAppName(<span class="string">"system_process"</span>,</span><br><span class="line">                UserHandle.myUserId());</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            mInstrumentation = <span class="keyword">new</span> Instrumentation();</span><br><span class="line">            ContextImpl context = ContextImpl.createAppContext(<span class="keyword">this</span>, getSystemContext().mPackageInfo);</span><br><span class="line"></span><br><span class="line">            <span class="comment">// 创建系统进程的 Application 对象！        </span></span><br><span class="line">            mInitialApplication = context.mPackageInfo.makeApplication(<span class="keyword">true</span>, <span class="keyword">null</span>);</span><br><span class="line">            mInitialApplication.onCreate();</span><br><span class="line">        &#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> RuntimeException(</span><br><span class="line">                    <span class="string">"Unable to instantiate Application():"</span> + e.toString(), e);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// add dropbox logging to libcore</span></span><br><span class="line">    DropBox.setReporter(<span class="keyword">new</span> DropBoxReporter());</span><br><span class="line">    <span class="comment">// 添加 Config 回调接口</span></span><br><span class="line">    ViewRootImpl.addConfigCallback(<span class="keyword">new</span> ComponentCallbacks2() &#123;</span><br><span class="line">        <span class="meta">@Override</span></span><br><span class="line">        <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onConfigurationChanged</span><span class="params">(Configuration newConfig)</span> </span>&#123;</span><br><span class="line">            <span class="keyword">synchronized</span> (mResourcesManager) &#123;</span><br><span class="line">                <span class="comment">// We need to apply this change to the resources</span></span><br><span class="line">                <span class="comment">// immediately, because upon returning the view</span></span><br><span class="line">                <span class="comment">// hierarchy will be informed about it.</span></span><br><span class="line">                <span class="keyword">if</span> (mResourcesManager.applyConfigurationToResourcesLocked(newConfig, <span class="keyword">null</span>)) &#123;</span><br><span class="line">                    updateLocaleListFromAppContext(mInitialApplication.getApplicationContext(),</span><br><span class="line">                            mResourcesManager.getConfiguration().getLocales());</span><br><span class="line"></span><br><span class="line">                    <span class="comment">// This actually changed the resources!  Tell</span></span><br><span class="line">                    <span class="comment">// everyone about it.</span></span><br><span class="line">                    <span class="keyword">if</span> (mPendingConfiguration == <span class="keyword">null</span> ||</span><br><span class="line">                            mPendingConfiguration.isOtherSeqNewer(newConfig)) &#123;</span><br><span class="line">                        mPendingConfiguration = newConfig;</span><br><span class="line"></span><br><span class="line">                        sendMessage(H.CONFIGURATION_CHANGED, newConfig);</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="meta">@Override</span></span><br><span class="line">        <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onLowMemory</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="meta">@Override</span></span><br><span class="line">        <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onTrimMemory</span><span class="params">(<span class="keyword">int</span> level)</span> </span>&#123;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>对于应用进程的 attach 主要流程：</p>
<ul>
<li>创建线程来开启虚拟机的 JIT 即时编译。</li>
<li><strong>通过 binder，调用到 AMS.attachApplication，其参数 mAppThread 的数据类型为 ApplicationThread</strong>。</li>
<li>观察是否快接近 heap 的上限，当已用内存超过最大内存的 3 / 4，则请求释放内存空间。</li>
<li>添加 dropbox 日志到 libcore。</li>
<li>添加 Config 回调接口。</li>
</ul>
<h1 id="7-ActivityManagerProxy-attachApplication"><a href="#7-ActivityManagerProxy-attachApplication" class="headerlink" title="7 ActivityManagerProxy.attachApplication"></a>7 ActivityManagerProxy.attachApplication</h1><ul>
<li>参数传递：IApplicationThread app，这里传入的是 ApplicationThread 对象！</li>
</ul>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">public void attachApplication(IApplicationThread app) throws RemoteException</span><br><span class="line">&#123;</span><br><span class="line">    Parcel data = Parcel.obtain();</span><br><span class="line">    Parcel reply = Parcel.obtain();</span><br><span class="line">    data.writeInterfaceToken(IActivityManager.descriptor);</span><br><span class="line">    data.writeStrongBinder(app.asBinder());</span><br><span class="line">    // binder 通信！</span><br><span class="line">    mRemote.transact(ATTACH_APPLICATION_TRANSACTION, data, reply, 0);</span><br><span class="line">    reply.readException();</span><br><span class="line">    data.recycle();</span><br><span class="line">    reply.recycle();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>以上是在应用进程里面，下面就要通过 Binder 通信，进入系统进程中：<br>此处：descriptor = “android.app.IActivityManager”，用来校验使用的！</p>
<h1 id="8-ActivityManagerNative-onTransact"><a href="#8-ActivityManagerNative-onTransact" class="headerlink" title="8 ActivityManagerNative.onTransact"></a>8 ActivityManagerNative.onTransact</h1><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">boolean</span> <span class="title">onTransact</span><span class="params">(<span class="keyword">int</span> code, Parcel data, Parcel reply, <span class="keyword">int</span> flags)</span></span></span><br><span class="line"><span class="function">        <span class="keyword">throws</span> RemoteException </span>&#123;</span><br><span class="line">    <span class="keyword">switch</span> (code) &#123;</span><br><span class="line"></span><br><span class="line">    ... ... ... ...</span><br><span class="line"></span><br><span class="line">    <span class="keyword">case</span> ATTACH_APPLICATION_TRANSACTION: &#123;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 校验 binder 通信是否匹配!</span></span><br><span class="line">        data.enforceInterface(IActivityManager.descriptor);</span><br><span class="line">        </span><br><span class="line">        <span class="comment">// 通过 asInterface 接口，将 ApplicationThread 对象转为 ApplicationTreadProxy 对象！</span></span><br><span class="line">        IApplicationThread app = ApplicationThreadNative.asInterface(</span><br><span class="line">                data.readStrongBinder());</span><br><span class="line">                </span><br><span class="line">        <span class="keyword">if</span> (app != <span class="keyword">null</span>) &#123;</span><br><span class="line"></span><br><span class="line">            <span class="comment">// 调用 IActivityManager 的方法，接下来，进入 AMS！</span></span><br><span class="line">            attachApplication(app);</span><br><span class="line">        &#125;</span><br><span class="line">        reply.writeNoException();</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">true</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    ... ... ... ...</span><br><span class="line">    </span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>通过 Binder 通信，调用 AMS 的方法：！</p>
<h1 id="9-ActivityManagerService-attachApplication"><a href="#9-ActivityManagerService-attachApplication" class="headerlink" title="9 ActivityManagerService.attachApplication"></a>9 ActivityManagerService.attachApplication</h1><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">final</span> <span class="keyword">void</span> <span class="title">attachApplication</span><span class="params">(IApplicationThread thread)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">synchronized</span> (<span class="keyword">this</span>) &#123;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 获得调用方的 pid，这里是应用进程的 pid！</span></span><br><span class="line">        <span class="keyword">int</span> callingPid = Binder.getCallingPid();</span><br><span class="line">        <span class="keyword">final</span> <span class="keyword">long</span> origId = Binder.clearCallingIdentity();</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 调用 attachApplicationLocked 继续处理！</span></span><br><span class="line">        attachApplicationLocked(thread, callingPid);</span><br><span class="line">        Binder.restoreCallingIdentity(origId);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>这里简单，再获得应用进程的 pid！</p>
<h1 id="10-ActivityManagerService-attachApplicationLocked"><a href="#10-ActivityManagerService-attachApplicationLocked" class="headerlink" title="10 ActivityManagerService.attachApplicationLocked"></a>10 ActivityManagerService.attachApplicationLocked</h1><p>传入参数：</p>
<ul>
<li>ApplicationThreadProxy 对象，应用程序进程的 pid</li>
</ul>
<p>删掉了部分的注释！</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br><span class="line">212</span><br><span class="line">213</span><br><span class="line">214</span><br><span class="line">215</span><br><span class="line">216</span><br><span class="line">217</span><br><span class="line">218</span><br><span class="line">219</span><br><span class="line">220</span><br><span class="line">221</span><br><span class="line">222</span><br><span class="line">223</span><br><span class="line">224</span><br><span class="line">225</span><br><span class="line">226</span><br><span class="line">227</span><br><span class="line">228</span><br><span class="line">229</span><br><span class="line">230</span><br><span class="line">231</span><br><span class="line">232</span><br><span class="line">233</span><br><span class="line">234</span><br><span class="line">235</span><br><span class="line">236</span><br><span class="line">237</span><br><span class="line">238</span><br><span class="line">239</span><br><span class="line">240</span><br><span class="line">241</span><br><span class="line">242</span><br><span class="line">243</span><br><span class="line">244</span><br><span class="line">245</span><br><span class="line">246</span><br><span class="line">247</span><br><span class="line">248</span><br><span class="line">249</span><br><span class="line">250</span><br><span class="line">251</span><br><span class="line">252</span><br><span class="line">253</span><br><span class="line">254</span><br><span class="line">255</span><br><span class="line">256</span><br><span class="line">257</span><br><span class="line">258</span><br><span class="line">259</span><br><span class="line">260</span><br><span class="line">261</span><br><span class="line">262</span><br><span class="line">263</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">final</span> <span class="keyword">boolean</span> <span class="title">attachApplicationLocked</span><span class="params">(IApplicationThread thread,</span></span></span><br><span class="line"><span class="function"><span class="params">        <span class="keyword">int</span> pid)</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    ProcessRecord app;</span><br><span class="line">    <span class="keyword">if</span> (pid != MY_PID &amp;&amp; pid &gt;= <span class="number">0</span>) &#123; <span class="comment">// 显然，调用方进程不是 SystemServer 进程！</span></span><br><span class="line">        <span class="keyword">synchronized</span> (mPidsSelfLocked) &#123;</span><br><span class="line"></span><br><span class="line">            app = mPidsSelfLocked.get(pid); <span class="comment">// 获得该进程的 ProcessRecord 对象！</span></span><br><span class="line"></span><br><span class="line">        &#125;</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        app = <span class="keyword">null</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (app == <span class="keyword">null</span>) &#123;  <span class="comment">// 如果获得的 ProcessRecord 为 null，这里是属于异常情况！</span></span><br><span class="line">       </span><br><span class="line">        Slog.w(TAG, <span class="string">"No pending application record for pid "</span> + pid</span><br><span class="line">                + <span class="string">" (IApplicationThread "</span> + thread + <span class="string">"); dropping process"</span>);</span><br><span class="line">        EventLog.writeEvent(EventLogTags.AM_DROP_PROCESS, pid);</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (pid &gt; <span class="number">0</span> &amp;&amp; pid != MY_PID) &#123; <span class="comment">// 如果调用方不是 SystemServer 进程，杀掉进程组！</span></span><br><span class="line"></span><br><span class="line">            Process.killProcessQuiet(pid);</span><br><span class="line">            <span class="comment">//<span class="doctag">TODO:</span> killProcessGroup(app.info.uid, pid);</span></span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            <span class="keyword">try</span> &#123;</span><br><span class="line"></span><br><span class="line">                thread.scheduleExit(); </span><br><span class="line">                </span><br><span class="line">            &#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">                <span class="comment">// Ignore exceptions.</span></span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">false</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 如果 ProcessRecord 不为 null，且 ProcessRecord.thread 不为 null</span></span><br><span class="line">    <span class="comment">// 说明该 ProcessRecord 已经 attach 了另外一个进程，需要立即清空这个 ProcessRecord！</span></span><br><span class="line">    <span class="keyword">if</span> (app.thread != <span class="keyword">null</span>) &#123;</span><br><span class="line">        handleAppDiedLocked(app, <span class="keyword">true</span>, <span class="keyword">true</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// Tell the process all about itself.</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (DEBUG_ALL) Slog.v(</span><br><span class="line">            TAG, <span class="string">"Binding process pid "</span> + pid + <span class="string">" to record "</span> + app);</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 获得进程的名称!</span></span><br><span class="line">    <span class="keyword">final</span> String processName = app.processName;</span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 创建进程死亡通知对象，并绑定死亡通知对象！</span></span><br><span class="line">        AppDeathRecipient adr = <span class="keyword">new</span> AppDeathRecipient(</span><br><span class="line">                app, pid, thread);</span><br><span class="line">        thread.asBinder().linkToDeath(adr, <span class="number">0</span>);</span><br><span class="line">        app.deathRecipient = adr;</span><br><span class="line"></span><br><span class="line">    &#125; <span class="keyword">catch</span> (RemoteException e) &#123;</span><br><span class="line"></span><br><span class="line">        app.resetPackageList(mProcessStats);</span><br><span class="line">        startProcessLocked(app, <span class="string">"link fail"</span>, processName);</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">false</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    EventLog.writeEvent(EventLogTags.AM_PROC_BOUND, app.userId, app.pid, app.processName);</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 重置进程的信息！ </span></span><br><span class="line">    <span class="comment">// 这里将传入的 ApplicationThreadProxy 对象赋给 app.thread，完成 attach 操作！！</span></span><br><span class="line">    <span class="comment">// 这里进程开始处于 active 状态!</span></span><br><span class="line">    app.makeActive(thread, mProcessStats);</span><br><span class="line"></span><br><span class="line">    app.curAdj = app.setAdj = app.verifiedAdj = ProcessList.INVALID_ADJ;</span><br><span class="line">    app.curSchedGroup = app.setSchedGroup = ProcessList.SCHED_GROUP_DEFAULT;</span><br><span class="line">    app.forcingToForeground = <span class="keyword">null</span>;</span><br><span class="line">    updateProcessForegroundLocked(app, <span class="keyword">false</span>, <span class="keyword">false</span>);</span><br><span class="line">    app.hasShownUi = <span class="keyword">false</span>;</span><br><span class="line">    app.debugging = <span class="keyword">false</span>;</span><br><span class="line">    app.cached = <span class="keyword">false</span>;</span><br><span class="line">    app.killedByAm = <span class="keyword">false</span>;</span><br><span class="line"></span><br><span class="line">    app.unlocked = StorageManager.isUserKeyUnlocked(app.userId);</span><br><span class="line"></span><br><span class="line">    mHandler.removeMessages(PROC_START_TIMEOUT_MSG, app);</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// 进程处于 ready 状态或者该进程为 FLAG_PERSISTENT 进程，即常驻进程，则 normalMode 为 true！</span></span><br><span class="line">    <span class="keyword">boolean</span> normalMode = mProcessesReady || isAllowedWhileBooting(app.info);</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 获得该进程中的 providers！</span></span><br><span class="line">    List&lt;ProviderInfo&gt; providers = normalMode ? generateApplicationProvidersLocked(app) : <span class="keyword">null</span>;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// 检查新进程是否存在正在启动中的 provider，</span></span><br><span class="line">    <span class="comment">// 如果有，则超时 10s 后发送 CONTENT_PROVIDER_PUBLISH_TIMEOUT_MSG 消息！</span></span><br><span class="line">    <span class="keyword">if</span> (providers != <span class="keyword">null</span> &amp;&amp; checkAppInLaunchingProvidersLocked(app)) &#123;</span><br><span class="line">        Message msg = mHandler.obtainMessage(CONTENT_PROVIDER_PUBLISH_TIMEOUT_MSG);</span><br><span class="line">        msg.obj = app;</span><br><span class="line">        mHandler.sendMessageDelayed(msg, CONTENT_PROVIDER_PUBLISH_TIMEOUT);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (!normalMode) &#123;</span><br><span class="line">        Slog.i(TAG, <span class="string">"Launching preboot mode app: "</span> + app);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (DEBUG_ALL) Slog.v(</span><br><span class="line">        TAG, <span class="string">"New app record "</span> + app</span><br><span class="line">        + <span class="string">" thread="</span> + thread.asBinder() + <span class="string">" pid="</span> + pid);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">        <span class="keyword">int</span> testMode = IApplicationThread.DEBUG_OFF;</span><br><span class="line">        <span class="keyword">if</span> (mDebugApp != <span class="keyword">null</span> &amp;&amp; mDebugApp.equals(processName)) &#123;</span><br><span class="line">            testMode = mWaitForDebugger</span><br><span class="line">                ? IApplicationThread.DEBUG_WAIT</span><br><span class="line">                : IApplicationThread.DEBUG_ON;</span><br><span class="line">            app.debugging = <span class="keyword">true</span>;</span><br><span class="line">            <span class="keyword">if</span> (mDebugTransient) &#123;</span><br><span class="line">                mDebugApp = mOrigDebugApp;</span><br><span class="line">                mWaitForDebugger = mOrigWaitForDebugger;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        String profileFile = app.instrumentationProfileFile;</span><br><span class="line">        ParcelFileDescriptor profileFd = <span class="keyword">null</span>;</span><br><span class="line">        <span class="keyword">int</span> samplingInterval = <span class="number">0</span>;</span><br><span class="line">        <span class="keyword">boolean</span> profileAutoStop = <span class="keyword">false</span>;</span><br><span class="line">        <span class="keyword">if</span> (mProfileApp != <span class="keyword">null</span> &amp;&amp; mProfileApp.equals(processName)) &#123;</span><br><span class="line">            mProfileProc = app;</span><br><span class="line">            profileFile = mProfileFile;</span><br><span class="line">            profileFd = mProfileFd;</span><br><span class="line">            samplingInterval = mSamplingInterval;</span><br><span class="line">            profileAutoStop = mAutoStopProfiler;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">boolean</span> enableTrackAllocation = <span class="keyword">false</span>;</span><br><span class="line">        <span class="keyword">if</span> (mTrackAllocationApp != <span class="keyword">null</span> &amp;&amp; mTrackAllocationApp.equals(processName)) &#123;</span><br><span class="line">            enableTrackAllocation = <span class="keyword">true</span>;</span><br><span class="line">            mTrackAllocationApp = <span class="keyword">null</span>;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// If the app is being launched for restore or full backup, set it up specially</span></span><br><span class="line">        <span class="keyword">boolean</span> isRestrictedBackupMode = <span class="keyword">false</span>;</span><br><span class="line">        <span class="keyword">if</span> (mBackupTarget != <span class="keyword">null</span> &amp;&amp; mBackupAppName.equals(processName)) &#123;</span><br><span class="line">            isRestrictedBackupMode = mBackupTarget.appInfo.uid &gt;= Process.FIRST_APPLICATION_UID</span><br><span class="line">                    &amp;&amp; ((mBackupTarget.backupMode == BackupRecord.RESTORE)</span><br><span class="line">                            || (mBackupTarget.backupMode == BackupRecord.RESTORE_FULL)</span><br><span class="line">                            || (mBackupTarget.backupMode == BackupRecord.BACKUP_FULL));</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (app.instrumentationClass != <span class="keyword">null</span>) &#123;</span><br><span class="line">            notifyPackageUse(app.instrumentationClass.getPackageName(),</span><br><span class="line">                             PackageManager.NOTIFY_PACKAGE_USE_INSTRUMENTATION);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">if</span> (DEBUG_CONFIGURATION) Slog.v(TAG_CONFIGURATION, <span class="string">"Binding proc "</span></span><br><span class="line">                + processName + <span class="string">" with config "</span> + mConfiguration);</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 获得进程的所有者应用程序的信息！        </span></span><br><span class="line">        ApplicationInfo appInfo = app.instrumentationInfo != <span class="keyword">null</span></span><br><span class="line">                ? app.instrumentationInfo : app.info;</span><br><span class="line">                </span><br><span class="line">        app.compat = compatibilityInfoForPackageLocked(appInfo);</span><br><span class="line">        <span class="keyword">if</span> (profileFd != <span class="keyword">null</span>) &#123;</span><br><span class="line">            profileFd = profileFd.dup();</span><br><span class="line">        &#125;</span><br><span class="line">        ProfilerInfo profilerInfo = profileFile == <span class="keyword">null</span> ? <span class="keyword">null</span></span><br><span class="line">                : <span class="keyword">new</span> ProfilerInfo(profileFile, profileFd, samplingInterval, profileAutoStop);</span><br><span class="line">        </span><br><span class="line">        <span class="comment">// 这里很关键了，之前通过 attach 的方式，实现了从 SystemServer 进程到应用程序进程的单向 bind </span></span><br><span class="line">        <span class="comment">// 通信，而这里的 bind 操作最终的结果，是实现了 SystemServer 进程和应用程序进程的双向 bind 通信！</span></span><br><span class="line">        thread.bindApplication(processName, appInfo, providers, app.instrumentationClass,</span><br><span class="line">                profilerInfo, app.instrumentationArguments, app.instrumentationWatcher,</span><br><span class="line">                app.instrumentationUiAutomationConnection, testMode,</span><br><span class="line">                mBinderTransactionTrackingEnabled, enableTrackAllocation,</span><br><span class="line">                isRestrictedBackupMode || !normalMode, app.persistent,</span><br><span class="line">                <span class="keyword">new</span> Configuration(mConfiguration), app.compat,</span><br><span class="line">                getCommonServicesLocked(app.isolated),</span><br><span class="line">                mCoreSettingsObserver.getCoreSettingsLocked());</span><br><span class="line">        </span><br><span class="line">        <span class="comment">// 更新进程 LRU 队列！</span></span><br><span class="line">        updateLruProcessLocked(app, <span class="keyword">false</span>, <span class="keyword">null</span>);</span><br><span class="line"></span><br><span class="line">        app.lastRequestedGc = app.lastLowMemory = SystemClock.uptimeMillis();</span><br><span class="line">    &#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line"></span><br><span class="line">        app.resetPackageList(mProcessStats);</span><br><span class="line">        app.unlinkDeathRecipient();</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 每当 bind 操作失败，则重新启动进程, 此处有可能会导致进程无限重启。</span></span><br><span class="line">        startProcessLocked(app, <span class="string">"bind fail"</span>, processName);</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">false</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 将当前已经被启动的新进程的 ProcessRecord 从正在启动的进程集合 mPersistentStartingProcesses！</span></span><br><span class="line">    <span class="comment">// 和等待启动的进程集合 mProcessesOnHold 中移除！</span></span><br><span class="line">    mPersistentStartingProcesses.remove(app);</span><br><span class="line">    mProcessesOnHold.remove(app);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">boolean</span> badApp = <span class="keyword">false</span>;</span><br><span class="line">    <span class="keyword">boolean</span> didSomething = <span class="keyword">false</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (normalMode) &#123; <span class="comment">// 如果是正常启动的情况下！</span></span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line"></span><br><span class="line">            <span class="comment">// 检查是否有 activity 组件要在这个新进程中运行！</span></span><br><span class="line">            <span class="keyword">if</span> (mStackSupervisor.attachApplicationLocked(app)) &#123;</span><br><span class="line">                didSomething = <span class="keyword">true</span>;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">            Slog.wtf(TAG, <span class="string">"Exception thrown launching activities in "</span> + app, e);</span><br><span class="line">            </span><br><span class="line">            <span class="comment">// 检查异常，将 badApp 置为 true！</span></span><br><span class="line">            badApp = <span class="keyword">true</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (!badApp) &#123;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line"></span><br><span class="line">             <span class="comment">// 检查是否有 sevvce 组件要在这个新进程中运行！</span></span><br><span class="line">            didSomething |= mServices.attachApplicationLocked(app, processName);</span><br><span class="line">        &#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">            Slog.wtf(TAG, <span class="string">"Exception thrown starting services in "</span> + app, e);</span><br><span class="line">            badApp = <span class="keyword">true</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 检查是否有 broadcast 组件要在这个新进程中运行！</span></span><br><span class="line">    <span class="keyword">if</span> (!badApp &amp;&amp; isPendingBroadcastProcessLocked(pid)) &#123;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            didSomething |= sendPendingBroadcastsLocked(app);</span><br><span class="line">        &#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">            <span class="comment">// If the app died trying to launch the receiver we declare it 'bad'</span></span><br><span class="line">            Slog.wtf(TAG, <span class="string">"Exception thrown dispatching broadcasts in "</span> + app, e);</span><br><span class="line">            badApp = <span class="keyword">true</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 检查是否在这个新进程中有下一个 backup 代理！</span></span><br><span class="line">    <span class="keyword">if</span> (!badApp &amp;&amp; mBackupTarget != <span class="keyword">null</span> &amp;&amp; mBackupTarget.appInfo.uid == app.uid) &#123;</span><br><span class="line">        <span class="keyword">if</span> (DEBUG_BACKUP) Slog.v(TAG_BACKUP,</span><br><span class="line">                <span class="string">"New app is backup target, launching agent for "</span> + app);</span><br><span class="line">        notifyPackageUse(mBackupTarget.appInfo.packageName,</span><br><span class="line">                         PackageManager.NOTIFY_PACKAGE_USE_BACKUP);</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            thread.scheduleCreateBackupAgent(mBackupTarget.appInfo,</span><br><span class="line">                    compatibilityInfoForPackageLocked(mBackupTarget.appInfo),</span><br><span class="line">                    mBackupTarget.backupMode);</span><br><span class="line">        &#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">            Slog.wtf(TAG, <span class="string">"Exception thrown creating backup agent in "</span> + app, e);</span><br><span class="line">            badApp = <span class="keyword">true</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (badApp) &#123; <span class="comment">// badApp 为 true，就杀掉这个进程</span></span><br><span class="line">        app.kill(<span class="string">"error during init"</span>, <span class="keyword">true</span>);</span><br><span class="line">        handleAppDiedLocked(app, <span class="keyword">false</span>, <span class="keyword">true</span>);</span><br><span class="line">        </span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">false</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (!didSomething) &#123; <span class="comment">// 检查后发现，没有任何组件要运行在新进程，更新 OomAdj 的值！</span></span><br><span class="line">        updateOomAdjLocked();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">true</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>我们来回顾一下这个方法：</p>
<ul>
<li>根据 pid 从 mPidsSelfLocked 中查询到相应的 ProcessRecord 对象 app。<ul>
<li>当 app==null，意味着本次创建的进程不存在，则直接返回，这属于异常。</li>
</ul>
</li>
<li>判断 app.thread 是否为 null，此时 thread 应该为 null，若不为 null 则表示该 app 附到上一个进程，则调用 handleAppDiedLocked 清理。</li>
<li>绑定死亡通知，当进程 pid 死亡时会通过 binder 死亡回调，来通知 system_server 进程死亡的消息。</li>
<li><strong>重置 ProcessRecord 进程信息，并设置 app.thread 为新进程的 ApplicationThreadProxy ，attach 操作完成</strong> 。</li>
<li>app 进程存在正在启动中的 provider，则超时 10s 后发送 CONTENT_PROVIDER_PUBLISH_TIMEOUT_MSG 消息。</li>
<li>调用 thread.bindApplication 绑定应用进程，后面再进一步说明。</li>
<li>检查是否有 Provider，Activity，Service，Broadcast 等组件运行在该新进程。</li>
</ul>
<h2 id="10-1-new-AppDeathRecipient"><a href="#10-1-new-AppDeathRecipient" class="headerlink" title="10.1 new AppDeathRecipient"></a>10.1 new AppDeathRecipient</h2><p>我们来看看死亡通知对象的创建！<br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">private</span> <span class="keyword">final</span> <span class="class"><span class="keyword">class</span> <span class="title">AppDeathRecipient</span> <span class="keyword">implements</span> <span class="title">IBinder</span>.<span class="title">DeathRecipient</span> </span>&#123;</span><br><span class="line">    <span class="keyword">final</span> ProcessRecord mApp; <span class="comment">// 进程对应的 ProcessRecord 对象！</span></span><br><span class="line">    <span class="keyword">final</span> <span class="keyword">int</span> mPid; <span class="comment">// 进程的 pid</span></span><br><span class="line">    <span class="keyword">final</span> IApplicationThread mAppThread; <span class="comment">// 进程的 ApplicationThreadProxy 对象！</span></span><br><span class="line"></span><br><span class="line">    AppDeathRecipient(ProcessRecord app, <span class="keyword">int</span> pid,</span><br><span class="line">            IApplicationThread thread) &#123;</span><br><span class="line">        <span class="keyword">if</span> (DEBUG_ALL) Slog.v(</span><br><span class="line">            TAG, <span class="string">"New death recipient "</span> + <span class="keyword">this</span></span><br><span class="line">            + <span class="string">" for thread "</span> + thread.asBinder());</span><br><span class="line">        mApp = app;</span><br><span class="line">        mPid = pid;</span><br><span class="line">        mAppThread = thread;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">binderDied</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">if</span> (DEBUG_ALL) Slog.v(</span><br><span class="line">            TAG, <span class="string">"Death received in "</span> + <span class="keyword">this</span></span><br><span class="line">            + <span class="string">" for thread "</span> + mAppThread.asBinder());</span><br><span class="line">        <span class="keyword">synchronized</span>(ActivityManagerService.<span class="keyword">this</span>) &#123;</span><br><span class="line">            appDiedLocked(mApp, mPid, mAppThread, <span class="keyword">true</span>);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>当进程死亡后，其对应的死亡通知对象就会收到通知，其 binderDied 方法就会被调用，接着进入 appDiedLocked 方法：</p>
<h2 id="10-1-AMS-appDiedLocked"><a href="#10-1-AMS-appDiedLocked" class="headerlink" title="10.1 AMS.appDiedLocked"></a>10.1 AMS.appDiedLocked</h2><p>参数 fromBinderDied 置为 true！<br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">final</span> <span class="keyword">void</span> <span class="title">appDiedLocked</span><span class="params">(ProcessRecord app, <span class="keyword">int</span> pid, IApplicationThread thread,</span></span></span><br><span class="line"><span class="function"><span class="params">        <span class="keyword">boolean</span> fromBinderDied)</span> </span>&#123;</span><br><span class="line">    <span class="comment">// First check if this ProcessRecord is actually active for the pid.</span></span><br><span class="line">    <span class="keyword">synchronized</span> (mPidsSelfLocked) &#123;</span><br><span class="line">        ProcessRecord curProc = mPidsSelfLocked.get(pid);</span><br><span class="line">        <span class="keyword">if</span> (curProc != app) &#123;</span><br><span class="line">            Slog.w(TAG, <span class="string">"Spurious death for "</span> + app + <span class="string">", curProc for "</span> + pid + <span class="string">": "</span> + curProc);</span><br><span class="line">            <span class="keyword">return</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    BatteryStatsImpl stats = mBatteryStatsService.getActiveStatistics();</span><br><span class="line">    <span class="keyword">synchronized</span> (stats) &#123;</span><br><span class="line">        stats.noteProcessDiedLocked(app.info.uid, pid);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 这里 killed 值为 false；</span></span><br><span class="line">    <span class="keyword">if</span> (!app.killed) &#123;</span><br><span class="line">        <span class="keyword">if</span> (!fromBinderDied) &#123;</span><br><span class="line">            Process.killProcessQuiet(pid);</span><br><span class="line">        &#125;</span><br><span class="line">        </span><br><span class="line">        <span class="comment">// 杀掉进程所在的进程组！</span></span><br><span class="line">        killProcessGroup(app.uid, pid);</span><br><span class="line">        app.killed = <span class="keyword">true</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// Clean up already done if the process has been re-started.</span></span><br><span class="line">    <span class="keyword">if</span> (app.pid == pid &amp;&amp; app.thread != <span class="keyword">null</span> &amp;&amp;</span><br><span class="line">            app.thread.asBinder() == thread.asBinder()) &#123;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">boolean</span> doLowMem = app.instrumentationClass == <span class="keyword">null</span>;</span><br><span class="line">        <span class="keyword">boolean</span> doOomAdj = doLowMem;</span><br><span class="line">        <span class="keyword">if</span> (!app.killedByAm) &#123;</span><br><span class="line">            Slog.i(TAG, <span class="string">"Process "</span> + app.processName + <span class="string">" (pid "</span> + pid</span><br><span class="line">                    + <span class="string">") has died"</span>);</span><br><span class="line">            mAllowLowerMemLevel = <span class="keyword">true</span>;</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            <span class="comment">// Note that we always want to do oom adj to update our state with the</span></span><br><span class="line">            <span class="comment">// new number of procs.</span></span><br><span class="line">            mAllowLowerMemLevel = <span class="keyword">false</span>;</span><br><span class="line">            doLowMem = <span class="keyword">false</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        EventLog.writeEvent(EventLogTags.AM_PROC_DIED, app.userId, app.pid, app.processName);</span><br><span class="line">        <span class="keyword">if</span> (DEBUG_CLEANUP) Slog.v(TAG_CLEANUP,</span><br><span class="line">            <span class="string">"Dying app: "</span> + app + <span class="string">", pid: "</span> + pid + <span class="string">", thread: "</span> + thread.asBinder());</span><br><span class="line">            </span><br><span class="line">        <span class="comment">// 杀掉进程后继续调用 handleAppDiedLocked 方法！</span></span><br><span class="line">        handleAppDiedLocked(app, <span class="keyword">false</span>, <span class="keyword">true</span>);</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (doOomAdj) &#123;</span><br><span class="line">            updateOomAdjLocked();</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">if</span> (doLowMem) &#123;</span><br><span class="line">            doLowMemReportIfNeededLocked(app);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125; <span class="keyword">else</span> <span class="keyword">if</span> (app.pid != pid) &#123;</span><br><span class="line">        <span class="comment">// A new process has already been started.</span></span><br><span class="line">        Slog.i(TAG, <span class="string">"Process "</span> + app.processName + <span class="string">" (pid "</span> + pid</span><br><span class="line">                + <span class="string">") has died and restarted (pid "</span> + app.pid + <span class="string">")."</span>);</span><br><span class="line">        EventLog.writeEvent(EventLogTags.AM_PROC_DIED, app.userId, app.pid, app.processName);</span><br><span class="line">    &#125; <span class="keyword">else</span> <span class="keyword">if</span> (DEBUG_PROCESSES) &#123;</span><br><span class="line">        Slog.d(TAG_PROCESSES, <span class="string">"Received spurious death notification for thread "</span></span><br><span class="line">                + thread.asBinder());</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<h2 id="10-2-AMS-handleAppDiedLocked"><a href="#10-2-AMS-handleAppDiedLocked" class="headerlink" title="10.2 AMS.handleAppDiedLocked"></a>10.2 AMS.handleAppDiedLocked</h2><ul>
<li>参数 restarting 表示进程是否在重启，这里传入 false；</li>
<li>参数 allowRestart 表示是否允许进程重启，这里传入 true；<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">final</span> <span class="keyword">void</span> <span class="title">handleAppDiedLocked</span><span class="params">(ProcessRecord app,</span></span></span><br><span class="line"><span class="function"><span class="params">        <span class="keyword">boolean</span> restarting, <span class="keyword">boolean</span> allowRestart)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">int</span> pid = app.pid;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">boolean</span> kept = cleanUpApplicationRecordLocked(app, restarting, allowRestart, -<span class="number">1</span>,</span><br><span class="line">            <span class="keyword">false</span> <span class="comment">/*replacingPid*/</span>);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (!kept &amp;&amp; !restarting) &#123;</span><br><span class="line">        removeLruProcessLocked(app);</span><br><span class="line">        <span class="keyword">if</span> (pid &gt; <span class="number">0</span>) &#123;</span><br><span class="line">            ProcessList.remove(pid);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (mProfileProc == app) &#123;</span><br><span class="line">        clearProfilerLocked();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// Remove this application's activities from active lists.</span></span><br><span class="line">    <span class="keyword">boolean</span> hasVisibleActivities = mStackSupervisor.handleAppDiedLocked(app);</span><br><span class="line"></span><br><span class="line">    app.activities.clear();</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (app.instrumentationClass != <span class="keyword">null</span>) &#123;</span><br><span class="line">        Slog.w(TAG, <span class="string">"Crash of app "</span> + app.processName</span><br><span class="line">              + <span class="string">" running instrumentation "</span> + app.instrumentationClass);</span><br><span class="line"></span><br><span class="line">        Bundle info = <span class="keyword">new</span> Bundle();</span><br><span class="line">        info.putString(<span class="string">"shortMsg"</span>, <span class="string">"Process crashed."</span>);</span><br><span class="line">        finishInstrumentationLocked(app, Activity.RESULT_CANCELED, info);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (!restarting &amp;&amp; hasVisibleActivities</span><br><span class="line">            &amp;&amp; !mStackSupervisor.resumeFocusedStackTopActivityLocked()) &#123;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// If there was nothing to resume, and we are not already restarting this process, but</span></span><br><span class="line">        <span class="comment">// there is a visible activity that is hosted by the process...  then make sure all</span></span><br><span class="line">        <span class="comment">// visible activities are running, taking care of restarting this process.</span></span><br><span class="line">        mStackSupervisor.ensureActivitiesVisibleLocked(<span class="keyword">null</span>, <span class="number">0</span>, !PRESERVE_WINDOWS);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
</li>
</ul>
<h3 id="10-2-1-AMS-cleanUpApplicationRecordLocked"><a href="#10-2-1-AMS-cleanUpApplicationRecordLocked" class="headerlink" title="10.2.1 AMS.cleanUpApplicationRecordLocked"></a>10.2.1 AMS.cleanUpApplicationRecordLocked</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">final</span> <span class="keyword">boolean</span> <span class="title">cleanUpApplicationRecordLocked</span><span class="params">(ProcessRecord app,</span></span></span><br><span class="line"><span class="function"><span class="params">        <span class="keyword">boolean</span> restarting, <span class="keyword">boolean</span> allowRestart, <span class="keyword">int</span> index, <span class="keyword">boolean</span> replacingPid)</span> </span>&#123;</span><br><span class="line">    Slog.d(TAG, <span class="string">"cleanUpApplicationRecord -- "</span> + app.pid);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (index &gt;= <span class="number">0</span>) &#123;</span><br><span class="line">        removeLruProcessLocked(app);</span><br><span class="line">        ProcessList.remove(app.pid);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    mProcessesToGc.remove(app);</span><br><span class="line">    mPendingPssProcesses.remove(app);</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 取消掉这个进程所有已经可见的 Dialog！</span></span><br><span class="line">    <span class="keyword">if</span> (app.crashDialog != <span class="keyword">null</span> &amp;&amp; !app.forceCrashReport) &#123;</span><br><span class="line">        app.crashDialog.dismiss();</span><br><span class="line">        app.crashDialog = <span class="keyword">null</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (app.anrDialog != <span class="keyword">null</span>) &#123;</span><br><span class="line">        app.anrDialog.dismiss();</span><br><span class="line">        app.anrDialog = <span class="keyword">null</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (app.waitDialog != <span class="keyword">null</span>) &#123;</span><br><span class="line">        app.waitDialog.dismiss();</span><br><span class="line">        app.waitDialog = <span class="keyword">null</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    app.crashing = <span class="keyword">false</span>;</span><br><span class="line">    app.notResponding = <span class="keyword">false</span>;</span><br><span class="line"></span><br><span class="line">    app.resetPackageList(mProcessStats);</span><br><span class="line">    app.unlinkDeathRecipient();</span><br><span class="line">    app.makeInactive(mProcessStats);</span><br><span class="line">    app.waitingToKill = <span class="keyword">null</span>;</span><br><span class="line">    app.forcingToForeground = <span class="keyword">null</span>;</span><br><span class="line">    updateProcessForegroundLocked(app, <span class="keyword">false</span>, <span class="keyword">false</span>);</span><br><span class="line">    app.foregroundActivities = <span class="keyword">false</span>;</span><br><span class="line">    app.hasShownUi = <span class="keyword">false</span>;</span><br><span class="line">    app.treatLikeActivity = <span class="keyword">false</span>;</span><br><span class="line">    app.hasAboveClient = <span class="keyword">false</span>;</span><br><span class="line">    app.hasClientActivities = <span class="keyword">false</span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 杀掉进程中所有的 Service！</span></span><br><span class="line">    mServices.killServicesLocked(app, allowRestart);</span><br><span class="line"></span><br><span class="line">    <span class="comment">// restart 表示是否重启这个进程！</span></span><br><span class="line">    <span class="keyword">boolean</span> restart = <span class="keyword">false</span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 移除这个进程的所有 publish 的 provider！</span></span><br><span class="line">    <span class="keyword">for</span> (<span class="keyword">int</span> i = app.pubProviders.size() - <span class="number">1</span>; i &gt;= <span class="number">0</span>; i--) &#123;</span><br><span class="line">        ContentProviderRecord cpr = app.pubProviders.valueAt(i);</span><br><span class="line">        <span class="keyword">final</span> <span class="keyword">boolean</span> always = app.bad || !allowRestart;</span><br><span class="line">        <span class="keyword">boolean</span> inLaunching = removeDyingProviderLocked(app, cpr, always);</span><br><span class="line">        <span class="keyword">if</span> ((inLaunching || always) &amp;&amp; cpr.hasConnectionOrHandle()) &#123;</span><br><span class="line"></span><br><span class="line">            <span class="comment">// We left the provider in the launching list, need to</span></span><br><span class="line">            <span class="comment">// restart it.</span></span><br><span class="line">            restart = <span class="keyword">true</span>;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        cpr.provider = <span class="keyword">null</span>;</span><br><span class="line">        cpr.proc = <span class="keyword">null</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    app.pubProviders.clear();</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 移除这个进程的所有正在启动的 provider！</span></span><br><span class="line">    <span class="keyword">if</span> (cleanupAppInLaunchingProvidersLocked(app, <span class="keyword">false</span>)) &#123;</span><br><span class="line">        restart = <span class="keyword">true</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 取消所有的 ContentProviderConnection 对象！</span></span><br><span class="line">    <span class="keyword">if</span> (!app.conProviders.isEmpty()) &#123;</span><br><span class="line">        <span class="keyword">for</span> (<span class="keyword">int</span> i = app.conProviders.size() - <span class="number">1</span>; i &gt;= <span class="number">0</span>; i--) &#123;</span><br><span class="line"></span><br><span class="line">            ContentProviderConnection conn = app.conProviders.get(i);</span><br><span class="line">            conn.provider.connections.remove(conn);</span><br><span class="line">            stopAssociationLocked(app.uid, app.processName, conn.provider.uid,</span><br><span class="line">                    conn.provider.name);</span><br><span class="line">        &#125;</span><br><span class="line">        app.conProviders.clear();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// At this point there may be remaining entries in mLaunchingProviders</span></span><br><span class="line">    <span class="comment">// where we were the only one waiting, so they are no longer of use.</span></span><br><span class="line">    <span class="comment">// Look for these and clean up if found.</span></span><br><span class="line">    <span class="comment">// XXX Commented out for now.  Trying to figure out a way to reproduce</span></span><br><span class="line">    <span class="comment">// the actual situation to identify what is actually going on.</span></span><br><span class="line">    <span class="keyword">if</span> (<span class="keyword">false</span>) &#123;</span><br><span class="line">        <span class="keyword">for</span> (<span class="keyword">int</span> i = mLaunchingProviders.size() - <span class="number">1</span>; i &gt;= <span class="number">0</span>; i--) &#123;</span><br><span class="line">            ContentProviderRecord cpr = mLaunchingProviders.get(i);</span><br><span class="line">            <span class="keyword">if</span> (cpr.connections.size() &lt;= <span class="number">0</span> &amp;&amp; !cpr.hasExternalProcessHandles()) &#123;</span><br><span class="line">                <span class="keyword">synchronized</span> (cpr) &#123;</span><br><span class="line">                    cpr.launchingApp = <span class="keyword">null</span>;</span><br><span class="line">                    cpr.notifyAll();</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    skipCurrentReceiverLocked(app);</span><br><span class="line"></span><br><span class="line">    <span class="comment">// Unregister any receivers.</span></span><br><span class="line">    <span class="keyword">for</span> (<span class="keyword">int</span> i = app.receivers.size() - <span class="number">1</span>; i &gt;= <span class="number">0</span>; i--) &#123;</span><br><span class="line">        removeReceiverLocked(app.receivers.valueAt(i));</span><br><span class="line">    &#125;</span><br><span class="line">    app.receivers.clear();</span><br><span class="line"></span><br><span class="line">    <span class="comment">// If the app is undergoing backup, tell the backup manager about it</span></span><br><span class="line">    <span class="keyword">if</span> (mBackupTarget != <span class="keyword">null</span> &amp;&amp; app.pid == mBackupTarget.app.pid) &#123;</span><br><span class="line">        <span class="keyword">if</span> (DEBUG_BACKUP || DEBUG_CLEANUP) Slog.d(TAG_CLEANUP, <span class="string">"App "</span></span><br><span class="line">                + mBackupTarget.appInfo + <span class="string">" died during backup"</span>);</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            IBackupManager bm = IBackupManager.Stub.asInterface(</span><br><span class="line">                    ServiceManager.getService(Context.BACKUP_SERVICE));</span><br><span class="line">            bm.agentDisconnected(app.info.packageName);</span><br><span class="line">        &#125; <span class="keyword">catch</span> (RemoteException e) &#123;</span><br><span class="line">            <span class="comment">// can't happen; backup manager is local</span></span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">for</span> (<span class="keyword">int</span> i = mPendingProcessChanges.size() - <span class="number">1</span>; i &gt;= <span class="number">0</span>; i--) &#123;</span><br><span class="line">        ProcessChangeItem item = mPendingProcessChanges.get(i);</span><br><span class="line">        <span class="keyword">if</span> (item.pid == app.pid) &#123;</span><br><span class="line">            mPendingProcessChanges.remove(i);</span><br><span class="line">            mAvailProcessChanges.add(item);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    mUiHandler.obtainMessage(DISPATCH_PROCESS_DIED_UI_MSG, app.pid, app.info.uid,</span><br><span class="line">            <span class="keyword">null</span>).sendToTarget();</span><br><span class="line"></span><br><span class="line">    <span class="comment">// If the caller is restarting this app, then leave it in its</span></span><br><span class="line">    <span class="comment">// current lists and let the caller take care of it.</span></span><br><span class="line">    <span class="keyword">if</span> (restarting) &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">false</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (!app.persistent || app.isolated) &#123;</span><br><span class="line">        <span class="keyword">if</span> (DEBUG_PROCESSES || DEBUG_CLEANUP) Slog.v(TAG_CLEANUP,</span><br><span class="line">                <span class="string">"Removing non-persistent process during cleanup: "</span> + app);</span><br><span class="line">        <span class="keyword">if</span> (!replacingPid) &#123;</span><br><span class="line">            removeProcessNameLocked(app.processName, app.uid);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">if</span> (mHeavyWeightProcess == app) &#123;</span><br><span class="line">            mHandler.sendMessage(mHandler.obtainMessage(CANCEL_HEAVY_NOTIFICATION_MSG,</span><br><span class="line">                    mHeavyWeightProcess.userId, <span class="number">0</span>));</span><br><span class="line">            mHeavyWeightProcess = <span class="keyword">null</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125; <span class="keyword">else</span> <span class="keyword">if</span> (!app.removed) &#123;</span><br><span class="line">        <span class="comment">// This app is persistent, so we need to keep its record around.</span></span><br><span class="line">        <span class="comment">// If it is not already on the pending app list, add it there</span></span><br><span class="line">        <span class="comment">// and start a new process for it.</span></span><br><span class="line">        <span class="keyword">if</span> (mPersistentStartingProcesses.indexOf(app) &lt; <span class="number">0</span>) &#123;</span><br><span class="line">            mPersistentStartingProcesses.add(app);</span><br><span class="line">            restart = <span class="keyword">true</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span> ((DEBUG_PROCESSES || DEBUG_CLEANUP) &amp;&amp; mProcessesOnHold.contains(app)) Slog.v(</span><br><span class="line">            TAG_CLEANUP, <span class="string">"Clean-up removing on hold: "</span> + app);</span><br><span class="line">    mProcessesOnHold.remove(app);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (app == mHomeProcess) &#123;</span><br><span class="line">        mHomeProcess = <span class="keyword">null</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span> (app == mPreviousProcess) &#123;</span><br><span class="line">        mPreviousProcess = <span class="keyword">null</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    </span><br><span class="line">    <span class="keyword">if</span> (restart &amp;&amp; !app.isolated) &#123;</span><br><span class="line">        <span class="comment">// We have components that still need to be running in the</span></span><br><span class="line">        <span class="comment">// process, so re-launch it.</span></span><br><span class="line">        <span class="keyword">if</span> (index &lt; <span class="number">0</span>) &#123;</span><br><span class="line">            ProcessList.remove(app.pid);</span><br><span class="line">        &#125;</span><br><span class="line">        addProcessNameLocked(app);</span><br><span class="line">        startProcessLocked(app, <span class="string">"restart"</span>, app.processName);</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">true</span>;</span><br><span class="line">    &#125; <span class="keyword">else</span> <span class="keyword">if</span> (app.pid &gt; <span class="number">0</span> &amp;&amp; app.pid != MY_PID) &#123;</span><br><span class="line">        <span class="comment">// Goodbye!</span></span><br><span class="line">        <span class="keyword">boolean</span> removed;</span><br><span class="line">        <span class="keyword">synchronized</span> (mPidsSelfLocked) &#123;</span><br><span class="line">            mPidsSelfLocked.remove(app.pid);</span><br><span class="line">            mHandler.removeMessages(PROC_START_TIMEOUT_MSG, app);</span><br><span class="line">        &#125;</span><br><span class="line">        mBatteryStatsService.noteProcessFinish(app.processName, app.info.uid);</span><br><span class="line">        <span class="keyword">if</span> (app.isolated) &#123;</span><br><span class="line">            mBatteryStatsService.removeIsolatedUid(app.uid, app.info.uid);</span><br><span class="line">        &#125;</span><br><span class="line">        app.setPid(<span class="number">0</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">false</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>从上面可以看到，如果已经进程是 persistent 进程，死亡通知对象接收到通知后会重启这个进程！</p>
<p>attach 结束了，接下来，是 SystemServer 进程 bind 应用程序进程！</p>
<h1 id="11-ApplicationThreadProxy-bindApplication"><a href="#11-ApplicationThreadProxy-bindApplication" class="headerlink" title="11 ApplicationThreadProxy.bindApplication"></a>11 ApplicationThreadProxy.bindApplication</h1><p>这里是在 SystemServer 进程中：<br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">ApplicationThreadProxy</span> <span class="keyword">implements</span> <span class="title">IApplicationThread</span> </span>&#123;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> IBinder mRemote;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="title">ApplicationThreadProxy</span><span class="params">(IBinder remote)</span> </span>&#123;</span><br><span class="line">        mRemote = remote;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">final</span> IBinder <span class="title">asBinder</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> mRemote;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    ... ... ...<span class="comment">// 省略其他暂时不需要的方法！ </span></span><br><span class="line">    </span><br><span class="line">    <span class="comment">// 这里是 bind 操作！</span></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">final</span> <span class="keyword">void</span> <span class="title">bindApplication</span><span class="params">(String packageName, ApplicationInfo info,</span></span></span><br><span class="line"><span class="function"><span class="params">            List&lt;ProviderInfo&gt; providers, ComponentName testName, ProfilerInfo profilerInfo,</span></span></span><br><span class="line"><span class="function"><span class="params">            Bundle testArgs, IInstrumentationWatcher testWatcher,</span></span></span><br><span class="line"><span class="function"><span class="params">            IUiAutomationConnection uiAutomationConnection, <span class="keyword">int</span> debugMode,</span></span></span><br><span class="line"><span class="function"><span class="params">            <span class="keyword">boolean</span> enableBinderTracking, <span class="keyword">boolean</span> trackAllocation, <span class="keyword">boolean</span> restrictedBackupMode,</span></span></span><br><span class="line"><span class="function"><span class="params">            <span class="keyword">boolean</span> persistent, Configuration config, CompatibilityInfo compatInfo,</span></span></span><br><span class="line"><span class="function"><span class="params">            Map&lt;String, IBinder&gt; services, Bundle coreSettings)</span> <span class="keyword">throws</span> RemoteException </span>&#123;</span><br><span class="line"></span><br><span class="line">        Parcel data = Parcel.obtain();</span><br><span class="line">        data.writeInterfaceToken(IApplicationThread.descriptor);</span><br><span class="line">        data.writeString(packageName);</span><br><span class="line">        info.writeToParcel(data, <span class="number">0</span>);</span><br><span class="line">        data.writeTypedList(providers);</span><br><span class="line">        <span class="keyword">if</span> (testName == <span class="keyword">null</span>) &#123;</span><br><span class="line">            data.writeInt(<span class="number">0</span>);</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            data.writeInt(<span class="number">1</span>);</span><br><span class="line">            testName.writeToParcel(data, <span class="number">0</span>);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">if</span> (profilerInfo != <span class="keyword">null</span>) &#123;</span><br><span class="line">            data.writeInt(<span class="number">1</span>);</span><br><span class="line">            profilerInfo.writeToParcel(data, Parcelable.PARCELABLE_WRITE_RETURN_VALUE);</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            data.writeInt(<span class="number">0</span>);</span><br><span class="line">        &#125;</span><br><span class="line">        data.writeBundle(testArgs);</span><br><span class="line">        data.writeStrongInterface(testWatcher);</span><br><span class="line">        data.writeStrongInterface(uiAutomationConnection);</span><br><span class="line">        data.writeInt(debugMode);</span><br><span class="line">        data.writeInt(enableBinderTracking ? <span class="number">1</span> : <span class="number">0</span>);</span><br><span class="line">        data.writeInt(trackAllocation ? <span class="number">1</span> : <span class="number">0</span>);</span><br><span class="line">        data.writeInt(restrictedBackupMode ? <span class="number">1</span> : <span class="number">0</span>);</span><br><span class="line">        data.writeInt(persistent ? <span class="number">1</span> : <span class="number">0</span>);</span><br><span class="line">        config.writeToParcel(data, <span class="number">0</span>);</span><br><span class="line">        compatInfo.writeToParcel(data, <span class="number">0</span>);</span><br><span class="line">        data.writeMap(services);</span><br><span class="line">        data.writeBundle(coreSettings);</span><br><span class="line"></span><br><span class="line">        <span class="comment">// binder 通信！</span></span><br><span class="line">        mRemote.transact(BIND_APPLICATION_TRANSACTION, data, <span class="keyword">null</span>,</span><br><span class="line">                IBinder.FLAG_ONEWAY);</span><br><span class="line">        data.recycle();</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    ... ... ...</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>参数 Map&lt;String, IBinder&gt; services 是通过 AMS 的 getCommonServicesLocked 方法获得的：<br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">private</span> HashMap&lt;String, IBinder&gt; <span class="title">getCommonServicesLocked</span><span class="params">(<span class="keyword">boolean</span> isolated)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">if</span> (isolated) &#123;</span><br><span class="line">        <span class="keyword">if</span> (mIsolatedAppBindArgs == <span class="keyword">null</span>) &#123;</span><br><span class="line">            mIsolatedAppBindArgs = <span class="keyword">new</span> HashMap&lt;&gt;();</span><br><span class="line">            mIsolatedAppBindArgs.put(<span class="string">"package"</span>, ServiceManager.getService(<span class="string">"package"</span>));</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> mIsolatedAppBindArgs;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (mAppBindArgs == <span class="keyword">null</span>) &#123; <span class="comment">// 对于非隔离进程，这里会获得一些常用服务的 binder 对象！！</span></span><br><span class="line">        mAppBindArgs = <span class="keyword">new</span> HashMap&lt;&gt;();</span><br><span class="line"></span><br><span class="line">        <span class="comment">// Setup the application init args</span></span><br><span class="line">        mAppBindArgs.put(<span class="string">"package"</span>, ServiceManager.getService(<span class="string">"package"</span>));</span><br><span class="line">        mAppBindArgs.put(<span class="string">"window"</span>, ServiceManager.getService(<span class="string">"window"</span>));</span><br><span class="line">        mAppBindArgs.put(Context.ALARM_SERVICE,</span><br><span class="line">                ServiceManager.getService(Context.ALARM_SERVICE));</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> mAppBindArgs;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>这里的 IApplicationThread.descriptor = “android.app.IApplicationThread”<br>ATP 经过 binder ipc 传递到 ATN 的 onTransact 方法。</p>
<h1 id="12-ApplicationThreadNative-onTransact"><a href="#12-ApplicationThreadNative-onTransact" class="headerlink" title="12 ApplicationThreadNative.onTransact"></a>12 ApplicationThreadNative.onTransact</h1><p>进入到 ATN 的 onTransact 方法中，这里进入了应用程序的进程中了：<br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">boolean</span> <span class="title">onTransact</span><span class="params">(<span class="keyword">int</span> code, Parcel data, Parcel reply, <span class="keyword">int</span> flags)</span></span></span><br><span class="line"><span class="function">        <span class="keyword">throws</span> RemoteException </span>&#123;</span><br><span class="line">    <span class="keyword">switch</span> (code) &#123;</span><br><span class="line">    ...</span><br><span class="line">    <span class="keyword">case</span> BIND_APPLICATION_TRANSACTION:</span><br><span class="line">    &#123;</span><br><span class="line">        data.enforceInterface(IApplicationThread.descriptor);</span><br><span class="line">        <span class="comment">// 获得应用程序的包名！</span></span><br><span class="line">        String packageName = data.readString();</span><br><span class="line">        ApplicationInfo info =</span><br><span class="line">            ApplicationInfo.CREATOR.createFromParcel(data);</span><br><span class="line">        List&lt;ProviderInfo&gt; providers =</span><br><span class="line">            data.createTypedArrayList(ProviderInfo.CREATOR);</span><br><span class="line">        ComponentName testName = (data.readInt() != <span class="number">0</span>)</span><br><span class="line">            ? <span class="keyword">new</span> ComponentName(data) : <span class="keyword">null</span>;</span><br><span class="line">        ProfilerInfo profilerInfo = data.readInt() != <span class="number">0</span></span><br><span class="line">                ? ProfilerInfo.CREATOR.createFromParcel(data) : <span class="keyword">null</span>;</span><br><span class="line">        Bundle testArgs = data.readBundle();</span><br><span class="line"></span><br><span class="line">        IBinder binder = data.readStrongBinder();</span><br><span class="line">        IInstrumentationWatcher testWatcher = IInstrumentationWatcher.Stub.asInterface(binder);</span><br><span class="line"></span><br><span class="line">        binder = data.readStrongBinder();</span><br><span class="line">        IUiAutomationConnection uiAutomationConnection =</span><br><span class="line">                IUiAutomationConnection.Stub.asInterface(binder);</span><br><span class="line"></span><br><span class="line">        <span class="keyword">int</span> testMode = data.readInt();</span><br><span class="line">        <span class="keyword">boolean</span> openGlTrace = data.readInt() != <span class="number">0</span>;</span><br><span class="line">        <span class="keyword">boolean</span> restrictedBackupMode = (data.readInt() != <span class="number">0</span>);</span><br><span class="line">        <span class="keyword">boolean</span> persistent = (data.readInt() != <span class="number">0</span>);</span><br><span class="line">        Configuration config = Configuration.CREATOR.createFromParcel(data);</span><br><span class="line">        CompatibilityInfo compatInfo = CompatibilityInfo.CREATOR.createFromParcel(data);</span><br><span class="line">        HashMap&lt;String, IBinder&gt; services = data.readHashMap(<span class="keyword">null</span>);</span><br><span class="line">        Bundle coreSettings = data.readBundle();</span><br><span class="line"></span><br><span class="line">        <span class="comment">// [见流程3.11]</span></span><br><span class="line">        bindApplication(packageName, info, providers, testName, profilerInfo, testArgs,</span><br><span class="line">                testWatcher, uiAutomationConnection, testMode, openGlTrace,</span><br><span class="line">                restrictedBackupMode, persistent, config, compatInfo, services, coreSettings);</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">true</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    ...</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<h1 id="13-ApplicationThread-bindApplication"><a href="#13-ApplicationThread-bindApplication" class="headerlink" title="13 ApplicationThread.bindApplication"></a>13 ApplicationThread.bindApplication</h1><p>我们接着看：<br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">final</span> <span class="keyword">void</span> <span class="title">bindApplication</span><span class="params">(String processName, ApplicationInfo appInfo,</span></span></span><br><span class="line"><span class="function"><span class="params">        List&lt;ProviderInfo&gt; providers, ComponentName instrumentationName,</span></span></span><br><span class="line"><span class="function"><span class="params">        ProfilerInfo profilerInfo, Bundle instrumentationArgs,</span></span></span><br><span class="line"><span class="function"><span class="params">        IInstrumentationWatcher instrumentationWatcher,</span></span></span><br><span class="line"><span class="function"><span class="params">        IUiAutomationConnection instrumentationUiConnection, <span class="keyword">int</span> debugMode,</span></span></span><br><span class="line"><span class="function"><span class="params">        <span class="keyword">boolean</span> enableBinderTracking, <span class="keyword">boolean</span> trackAllocation,</span></span></span><br><span class="line"><span class="function"><span class="params">        <span class="keyword">boolean</span> isRestrictedBackupMode, <span class="keyword">boolean</span> persistent, Configuration config,</span></span></span><br><span class="line"><span class="function"><span class="params">        CompatibilityInfo compatInfo, Map&lt;String, IBinder&gt; services, Bundle coreSettings)</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (services != <span class="keyword">null</span>) &#123;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 这里将前面获得的系统公共 services 缓存到 ServiceManager 的 sCache 中, </span></span><br><span class="line">        <span class="comment">// 减少 binder 检索服务的次数.</span></span><br><span class="line">        ServiceManager.initServiceCache(services);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 发送消息 H.SET_CORE_SETTINGS</span></span><br><span class="line">    setCoreSettings(coreSettings);</span><br><span class="line"></span><br><span class="line">    AppBindData data = <span class="keyword">new</span> AppBindData(); <span class="comment">// 初始化 AppBindData</span></span><br><span class="line">    data.processName = processName;</span><br><span class="line">    data.appInfo = appInfo;</span><br><span class="line">    data.providers = providers;</span><br><span class="line">    </span><br><span class="line">    data.instrumentationName = instrumentationName;</span><br><span class="line">    data.instrumentationArgs = instrumentationArgs;</span><br><span class="line">    data.instrumentationWatcher = instrumentationWatcher;</span><br><span class="line">    data.instrumentationUiAutomationConnection = instrumentationUiConnection;</span><br><span class="line">    </span><br><span class="line">    data.debugMode = debugMode;</span><br><span class="line">    data.enableBinderTracking = enableBinderTracking;</span><br><span class="line">    data.trackAllocation = trackAllocation;</span><br><span class="line">    data.restrictedBackupMode = isRestrictedBackupMode;</span><br><span class="line">    data.persistent = persistent;</span><br><span class="line">    data.config = config;</span><br><span class="line">    data.compatInfo = compatInfo;</span><br><span class="line">    data.initProfilerInfo = profilerInfo;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 发送 H.BIND_APPLICATION 消息！</span></span><br><span class="line">    sendMessage(H.BIND_APPLICATION, data);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>其中 setCoreSettings() 过程就是调用 sendMessage(H.SET_CORE_SETTINGS, coreSettings) 来向主线程发送 SET_CORE_SETTINGS 消息，如下：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">setCoreSettings</span><span class="params">(Bundle coreSettings)</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    sendMessage(H.SET_CORE_SETTINGS, coreSettings);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>总结一下：bindApplication 方法的主要功能是依次向主线程发送消息 H.SET_CORE_SETTINGS 和 H.BIND_APPLICATION。</p>
<h1 id="14-ActivityThread-H-消息处理"><a href="#14-ActivityThread-H-消息处理" class="headerlink" title="14 ActivityThread.H - 消息处理"></a>14 ActivityThread.H - 消息处理</h1><p>进入到应用程序进程的主线程 Handler “H”：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">private</span> <span class="class"><span class="keyword">class</span> <span class="title">H</span> <span class="keyword">extends</span> <span class="title">Handler</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">       ... ... ...</span><br><span class="line"></span><br><span class="line">       <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">handleMessage</span><span class="params">(Message msg)</span> </span>&#123;</span><br><span class="line">       </span><br><span class="line">               ... ... ...</span><br><span class="line">               </span><br><span class="line">               <span class="keyword">case</span> SET_CORE_SETTINGS:</span><br><span class="line">               </span><br><span class="line">                   Trace.traceBegin(Trace.TRACE_TAG_ACTIVITY_MANAGER, <span class="string">"setCoreSettings"</span>);</span><br><span class="line">                   </span><br><span class="line">                   handleSetCoreSettings((Bundle) msg.obj);</span><br><span class="line">                   </span><br><span class="line">                   Trace.traceEnd(Trace.TRACE_TAG_ACTIVITY_MANAGER);</span><br><span class="line">                   <span class="keyword">break</span>;</span><br><span class="line">                   </span><br><span class="line">               ... ... ... </span><br><span class="line">               </span><br><span class="line">               <span class="keyword">case</span> BIND_APPLICATION:</span><br><span class="line"></span><br><span class="line">                   Trace.traceBegin(Trace.TRACE_TAG_ACTIVITY_MANAGER, <span class="string">"bindApplication"</span>);</span><br><span class="line">                   AppBindData data = (AppBindData)msg.obj;</span><br><span class="line">                   </span><br><span class="line">                   handleBindApplication(data);</span><br><span class="line">                   </span><br><span class="line">                   Trace.traceEnd(Trace.TRACE_TAG_ACTIVITY_MANAGER);</span><br><span class="line">                   <span class="keyword">break</span>;</span><br><span class="line">                   </span><br><span class="line">               ... ... ...    </span><br><span class="line">               </span><br><span class="line">       &#125; </span><br><span class="line">       </span><br><span class="line">       ... ... ...</span><br><span class="line">       </span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>我们继续来看吧：</p>
<h2 id="14-1-消息-H-SET-CORE-SETTINGS"><a href="#14-1-消息-H-SET-CORE-SETTINGS" class="headerlink" title="14.1 消息 H.SET_CORE_SETTINGS"></a>14.1 消息 H.SET_CORE_SETTINGS</h2><p>处理 H.SET_CORE_SETTINGS 消息，调用 handleSetCoreSettings 方法：<br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">handleSetCoreSettings</span><span class="params">(Bundle coreSettings)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">synchronized</span> (mResourcesManager) &#123;</span><br><span class="line">        mCoreSettings = coreSettings;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    onCoreSettingsChange();</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">onCoreSettingsChange</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    <span class="keyword">boolean</span> debugViewAttributes =</span><br><span class="line">            mCoreSettings.getInt(Settings.Global.DEBUG_VIEW_ATTRIBUTES, <span class="number">0</span>) != <span class="number">0</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (debugViewAttributes != View.mDebugViewAttributes) &#123;</span><br><span class="line">        View.mDebugViewAttributes = debugViewAttributes;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// request all activities to relaunch for the changes to take place</span></span><br><span class="line">        <span class="comment">// 由于发生改变, 请求所有的 activities 重启启动！</span></span><br><span class="line">        <span class="keyword">for</span> (Map.Entry&lt;IBinder, ActivityClientRecord&gt; entry : mActivities.entrySet()) &#123;</span><br><span class="line">            requestRelaunchActivity(entry.getKey(), <span class="keyword">null</span>, <span class="keyword">null</span>, <span class="number">0</span>, <span class="keyword">false</span>, <span class="keyword">null</span>, <span class="keyword">null</span>, <span class="keyword">false</span>,</span><br><span class="line">                    <span class="keyword">false</span> <span class="comment">/* preserveWindow */</span>);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<h2 id="14-2-消息-H-BIND-APPLICATION"><a href="#14-2-消息-H-BIND-APPLICATION" class="headerlink" title="14.2 消息 H.BIND_APPLICATION"></a>14.2 消息 H.BIND_APPLICATION</h2><p>处理 H.BIND_APPLICATION 消息，调用 handleBindApplication 方法：<br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br><span class="line">212</span><br><span class="line">213</span><br><span class="line">214</span><br><span class="line">215</span><br><span class="line">216</span><br><span class="line">217</span><br><span class="line">218</span><br><span class="line">219</span><br><span class="line">220</span><br><span class="line">221</span><br><span class="line">222</span><br><span class="line">223</span><br><span class="line">224</span><br><span class="line">225</span><br><span class="line">226</span><br><span class="line">227</span><br><span class="line">228</span><br><span class="line">229</span><br><span class="line">230</span><br><span class="line">231</span><br><span class="line">232</span><br><span class="line">233</span><br><span class="line">234</span><br><span class="line">235</span><br><span class="line">236</span><br><span class="line">237</span><br><span class="line">238</span><br><span class="line">239</span><br><span class="line">240</span><br><span class="line">241</span><br><span class="line">242</span><br><span class="line">243</span><br><span class="line">244</span><br><span class="line">245</span><br><span class="line">246</span><br><span class="line">247</span><br><span class="line">248</span><br><span class="line">249</span><br><span class="line">250</span><br><span class="line">251</span><br><span class="line">252</span><br><span class="line">253</span><br><span class="line">254</span><br><span class="line">255</span><br><span class="line">256</span><br><span class="line">257</span><br><span class="line">258</span><br><span class="line">259</span><br><span class="line">260</span><br><span class="line">261</span><br><span class="line">262</span><br><span class="line">263</span><br><span class="line">264</span><br><span class="line">265</span><br><span class="line">266</span><br><span class="line">267</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">handleBindApplication</span><span class="params">(AppBindData data)</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 将 UI 线程注册到 VMRuntime 中！</span></span><br><span class="line">    VMRuntime.registerSensitiveThread();</span><br><span class="line">    <span class="keyword">if</span> (data.trackAllocation) &#123;</span><br><span class="line">        DdmVmInternal.enableRecentAllocations(<span class="keyword">true</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 记录进程的开始时间！</span></span><br><span class="line">    Process.setStartTimes(SystemClock.elapsedRealtime(), SystemClock.uptimeMillis());</span><br><span class="line"></span><br><span class="line">    mBoundApplication = data;</span><br><span class="line">    mConfiguration = <span class="keyword">new</span> Configuration(data.config);</span><br><span class="line">    mCompatConfiguration = <span class="keyword">new</span> Configuration(data.config);</span><br><span class="line"></span><br><span class="line">    mProfiler = <span class="keyword">new</span> Profiler();</span><br><span class="line">    <span class="keyword">if</span> (data.initProfilerInfo != <span class="keyword">null</span>) &#123;</span><br><span class="line">        mProfiler.profileFile = data.initProfilerInfo.profileFile;</span><br><span class="line">        mProfiler.profileFd = data.initProfilerInfo.profileFd;</span><br><span class="line">        mProfiler.samplingInterval = data.initProfilerInfo.samplingInterval;</span><br><span class="line">        mProfiler.autoStopProfiler = data.initProfilerInfo.autoStopProfiler;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 设置进程名, 也就是说进程名是在进程真正创建以后的 BIND_APPLICATION 过程中才取名!</span></span><br><span class="line">    Process.setArgV0(data.processName);</span><br><span class="line">    android.ddm.DdmHandleAppName.setAppName(data.processName,</span><br><span class="line">                                            UserHandle.myUserId());</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (data.persistent) &#123; </span><br><span class="line">        <span class="comment">// 如果常驻进程，在低内存设备, 不采用硬件加速绘制,以节省内存使用量！</span></span><br><span class="line">        <span class="keyword">if</span> (!ActivityManager.isHighEndGfx()) &#123;</span><br><span class="line">            ThreadedRenderer.disable(<span class="keyword">false</span>);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (mProfiler.profileFd != <span class="keyword">null</span>) &#123;</span><br><span class="line">        mProfiler.startProfiling();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 如果应用程序的目标 sdk 小于等于 Honeycomb MR1</span></span><br><span class="line">    <span class="comment">// 设置 AsyncTask 默认的线程池为 THREAD_POOL_EXECUTOR！</span></span><br><span class="line">    <span class="keyword">if</span> (data.appInfo.targetSdkVersion &lt;= android.os.Build.VERSION_CODES.HONEYCOMB_MR1) &#123;</span><br><span class="line">        AsyncTask.setDefaultExecutor(AsyncTask.THREAD_POOL_EXECUTOR);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    Message.updateCheckRecycle(data.appInfo.targetSdkVersion);</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 重置进程时区为系统时区！</span></span><br><span class="line">    TimeZone.setDefault(<span class="keyword">null</span>);</span><br><span class="line">    <span class="comment">// 设置语言环境列表！</span></span><br><span class="line">    LocaleList.setDefault(data.config.getLocales());</span><br><span class="line"></span><br><span class="line">    <span class="keyword">synchronized</span> (mResourcesManager) &#123;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 更新系统配置</span></span><br><span class="line">        mResourcesManager.applyConfigurationToResourcesLocked(data.config, data.compatInfo);</span><br><span class="line">        mCurDefaultDisplayDpi = data.config.densityDpi;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// This calls mResourcesManager so keep it within the synchronized block.</span></span><br><span class="line">        applyCompatConfiguration(mCurDefaultDisplayDpi);</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// 创建应用程序的 LoadedApk 对象，每个进程都有一个。</span></span><br><span class="line">    data.info = getPackageInfoNoCheck(data.appInfo, data.compatInfo);</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 如果需要的话，设置该进程为像素</span></span><br><span class="line">    <span class="keyword">if</span> ((data.appInfo.flags&amp;ApplicationInfo.FLAG_SUPPORTS_SCREEN_DENSITIES)</span><br><span class="line">            == <span class="number">0</span>) &#123;</span><br><span class="line">        mDensityCompatMode = <span class="keyword">true</span>;</span><br><span class="line">        Bitmap.setDefaultDensity(DisplayMetrics.DENSITY_DEFAULT);</span><br><span class="line">    &#125;</span><br><span class="line">    updateDefaultDensity();</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// 设置时间显示的格式！</span></span><br><span class="line">    <span class="keyword">final</span> <span class="keyword">boolean</span> is24Hr = <span class="string">"24"</span>.equals(mCoreSettings.getString(Settings.System.TIME_12_24));</span><br><span class="line">    DateFormat.set24HourTimePref(is24Hr);</span><br><span class="line"></span><br><span class="line">    View.mDebugViewAttributes =</span><br><span class="line">            mCoreSettings.getInt(Settings.Global.DEBUG_VIEW_ATTRIBUTES, <span class="number">0</span>) != <span class="number">0</span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 对于 userdebug/eng 编译方式的系统应用来说，使用 dropbox 工具来分析 log 堆栈！</span></span><br><span class="line">    <span class="keyword">if</span> ((data.appInfo.flags &amp;</span><br><span class="line">         (ApplicationInfo.FLAG_SYSTEM |</span><br><span class="line">          ApplicationInfo.FLAG_UPDATED_SYSTEM_APP)) != <span class="number">0</span>) &#123;</span><br><span class="line">        StrictMode.conditionallyEnableDebugLogging();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 如果应用的目标平台大于等于Honeycomb，就不允许在主线程使用网络相关功能</span></span><br><span class="line">    <span class="comment">// 不然会抛出 NetworkOnMainThreadException 异常！</span></span><br><span class="line">    <span class="keyword">if</span> (data.appInfo.targetSdkVersion &gt;= Build.VERSION_CODES.HONEYCOMB) &#123;</span><br><span class="line">        StrictMode.enableDeathOnNetwork();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 如果应用的目标平台不低于 Android N，那就不允许应用将 “file://” 这样的 Uri</span></span><br><span class="line">    <span class="comment">// 直接暴露出去，比如跨包传递等等，不然会抛出 FileUriExposedException</span></span><br><span class="line">    <span class="keyword">if</span> (data.appInfo.targetSdkVersion &gt;= Build.VERSION_CODES.N) &#123;</span><br><span class="line">        StrictMode.enableDeathOnFileUriExposure();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    NetworkSecurityPolicy.getInstance().setCleartextTrafficPermitted(</span><br><span class="line">            (data.appInfo.flags &amp; ApplicationInfo.FLAG_USES_CLEARTEXT_TRAFFIC) != <span class="number">0</span>);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (data.debugMode != IApplicationThread.DEBUG_OFF) &#123;</span><br><span class="line">        <span class="comment">// XXX should have option to change the port.</span></span><br><span class="line">        Debug.changeDebugPort(<span class="number">8100</span>);</span><br><span class="line">        <span class="keyword">if</span> (data.debugMode == IApplicationThread.DEBUG_WAIT) &#123;</span><br><span class="line">            Slog.w(TAG, <span class="string">"Application "</span> + data.info.getPackageName()</span><br><span class="line">                  + <span class="string">" is waiting for the debugger on port 8100..."</span>);</span><br><span class="line"></span><br><span class="line">            IActivityManager mgr = ActivityManagerNative.getDefault();</span><br><span class="line">            <span class="keyword">try</span> &#123;</span><br><span class="line">                mgr.showWaitingForDebugger(mAppThread, <span class="keyword">true</span>);</span><br><span class="line">            &#125; <span class="keyword">catch</span> (RemoteException ex) &#123;</span><br><span class="line">                <span class="keyword">throw</span> ex.rethrowFromSystemServer();</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            Debug.waitForDebugger();</span><br><span class="line"></span><br><span class="line">            <span class="keyword">try</span> &#123;</span><br><span class="line">                mgr.showWaitingForDebugger(mAppThread, <span class="keyword">false</span>);</span><br><span class="line">            &#125; <span class="keyword">catch</span> (RemoteException ex) &#123;</span><br><span class="line">                <span class="keyword">throw</span> ex.rethrowFromSystemServer();</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            Slog.w(TAG, <span class="string">"Application "</span> + data.info.getPackageName()</span><br><span class="line">                  + <span class="string">" can be debugged on port 8100..."</span>);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 当处于调试模式,则运行应用生成 systrace 信息</span></span><br><span class="line">    <span class="keyword">boolean</span> isAppDebuggable = (data.appInfo.flags &amp; ApplicationInfo.FLAG_DEBUGGABLE) != <span class="number">0</span>;</span><br><span class="line">    Trace.setAppTracingAllowed(isAppDebuggable);</span><br><span class="line">    <span class="keyword">if</span> (isAppDebuggable &amp;&amp; data.enableBinderTracking) &#123;</span><br><span class="line">        Binder.enableTracing();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * Initialize the default http proxy in this process for the reasons we set the time zone.</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="comment">// 初始化默认的 http 代理！</span></span><br><span class="line">    Trace.traceBegin(Trace.TRACE_TAG_ACTIVITY_MANAGER, <span class="string">"Setup proxies"</span>);</span><br><span class="line">    <span class="keyword">final</span> IBinder b = ServiceManager.getService(Context.CONNECTIVITY_SERVICE);</span><br><span class="line">    <span class="keyword">if</span> (b != <span class="keyword">null</span>) &#123;</span><br><span class="line">        <span class="comment">// In pre-boot mode (doing initial launch to collect password), not</span></span><br><span class="line">        <span class="comment">// all system is up.  This includes the connectivity service, so don't</span></span><br><span class="line">        <span class="comment">// crash if we can't get it.</span></span><br><span class="line">        <span class="keyword">final</span> IConnectivityManager service = IConnectivityManager.Stub.asInterface(b);</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            <span class="keyword">final</span> ProxyInfo proxyInfo = service.getProxyForNetwork(<span class="keyword">null</span>);</span><br><span class="line">            Proxy.setHttpProxySystemProperty(proxyInfo);</span><br><span class="line">        &#125; <span class="keyword">catch</span> (RemoteException e) &#123;</span><br><span class="line">            Trace.traceEnd(Trace.TRACE_TAG_ACTIVITY_MANAGER);</span><br><span class="line">            <span class="keyword">throw</span> e.rethrowFromSystemServer();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    Trace.traceEnd(Trace.TRACE_TAG_ACTIVITY_MANAGER);</span><br><span class="line"></span><br><span class="line">    <span class="comment">// Instrumentation 是谷歌提供的一个基本测试类，具有监控交互的作用！</span></span><br><span class="line">    <span class="comment">// 每个进程都有一个 Instrumentation 对象，这里我们不看测试相关的！</span></span><br><span class="line">    <span class="keyword">final</span> InstrumentationInfo ii;</span><br><span class="line">    <span class="keyword">if</span> (data.instrumentationName != <span class="keyword">null</span>) &#123;</span><br><span class="line">        ... ... ... ...</span><br><span class="line">        </span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        ii = <span class="keyword">null</span>; <span class="comment">// 进入此分支！</span></span><br><span class="line">        </span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// 创建应用的上下文实例，更新本地语言平台列表！</span></span><br><span class="line">    <span class="keyword">final</span> ContextImpl appContext = ContextImpl.createAppContext(<span class="keyword">this</span>, data.info);</span><br><span class="line">    updateLocaleListFromAppContext(appContext,</span><br><span class="line">            mResourcesManager.getConfiguration().getLocales());</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (!Process.isIsolated() &amp;&amp; !<span class="string">"android"</span>.equals(appContext.getPackageName())) &#123;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 对于非隔离且所属包名不是 “android”（即系统进程）的进程</span></span><br><span class="line">        <span class="comment">// 创建缓存目录，来存放模板文集，和图形编译相关的代码！</span></span><br><span class="line">        <span class="keyword">final</span> File cacheDir = appContext.getCacheDir();</span><br><span class="line">        <span class="keyword">if</span> (cacheDir != <span class="keyword">null</span>) &#123;</span><br><span class="line">            <span class="comment">// Provide a usable directory for temporary files</span></span><br><span class="line">            System.setProperty(<span class="string">"java.io.tmpdir"</span>, cacheDir.getAbsolutePath());</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            Log.v(TAG, <span class="string">"Unable to initialize \"java.io.tmpdir\" property "</span></span><br><span class="line">                    + <span class="string">"due to missing cache directory"</span>);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">final</span> Context deviceContext = appContext.createDeviceProtectedStorageContext();</span><br><span class="line">        <span class="keyword">final</span> File codeCacheDir = deviceContext.getCodeCacheDir();</span><br><span class="line">        <span class="keyword">if</span> (codeCacheDir != <span class="keyword">null</span>) &#123;</span><br><span class="line">            setupGraphicsSupport(data.info, codeCacheDir);</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            Log.e(TAG, <span class="string">"Unable to setupGraphicsSupport due to missing code-cache directory"</span>);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    Trace.traceBegin(Trace.TRACE_TAG_ACTIVITY_MANAGER, <span class="string">"NetworkSecurityConfigProvider.install"</span>);</span><br><span class="line">    NetworkSecurityConfigProvider.install(appContext);</span><br><span class="line">    Trace.traceEnd(Trace.TRACE_TAG_ACTIVITY_MANAGER);</span><br><span class="line"></span><br><span class="line">    <span class="comment">// Continue loading instrumentation.</span></span><br><span class="line">    <span class="keyword">if</span> (ii != <span class="keyword">null</span>) &#123;</span><br><span class="line">    </span><br><span class="line">        ... ... ... ...</span><br><span class="line">        </span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">    </span><br><span class="line">        <span class="comment">// 进入此分支，非测试情况，默认会创建一个 Instrumentation ！</span></span><br><span class="line">        mInstrumentation = <span class="keyword">new</span> Instrumentation(); </span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> ((data.appInfo.flags&amp;ApplicationInfo.FLAG_LARGE_HEAP) != <span class="number">0</span>) &#123;</span><br><span class="line">        dalvik.system.VMRuntime.getRuntime().clearGrowthLimit();</span><br><span class="line">        </span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        dalvik.system.VMRuntime.getRuntime().clampGrowthLimit();</span><br><span class="line">        </span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// Allow disk access during application and provider setup. This could</span></span><br><span class="line">    <span class="comment">// block processing ordered broadcasts, but later processing would</span></span><br><span class="line">    <span class="comment">// probably end up doing the same disk access.</span></span><br><span class="line">    <span class="keyword">final</span> StrictMode.ThreadPolicy savedPolicy = StrictMode.allowThreadDiskWrites();</span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">    </span><br><span class="line">        <span class="comment">// 通过反射，创建目标应用程序的 Application 对象！</span></span><br><span class="line">        Application app = data.info.makeApplication(data.restrictedBackupMode, <span class="keyword">null</span>);</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 保存到 ActivityThread.mInitialApplication 中！</span></span><br><span class="line">        mInitialApplication = app;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// don't bring up providers in restricted mode; they may depend on the</span></span><br><span class="line">        <span class="comment">// app's custom Application class</span></span><br><span class="line">        <span class="keyword">if</span> (!data.restrictedBackupMode) &#123;</span><br><span class="line">            <span class="keyword">if</span> (!ArrayUtils.isEmpty(data.providers)) &#123;</span><br><span class="line">                installContentProviders(app, data.providers);</span><br><span class="line"></span><br><span class="line">                <span class="comment">// For process that contains content providers, we want to</span></span><br><span class="line">                <span class="comment">// ensure that the JIT is enabled "at some point".</span></span><br><span class="line">                mH.sendEmptyMessageDelayed(H.ENABLE_JIT, <span class="number">10</span>*<span class="number">1000</span>);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            mInstrumentation.onCreate(data.instrumentationArgs);</span><br><span class="line">            </span><br><span class="line">        &#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> RuntimeException(</span><br><span class="line">                <span class="string">"Exception thrown in onCreate() of "</span></span><br><span class="line">                + data.instrumentationName + <span class="string">": "</span> + e.toString(), e);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line"></span><br><span class="line">            <span class="comment">// 调用 Application.onCreate() 回调方法.</span></span><br><span class="line">            mInstrumentation.callApplicationOnCreate(app);</span><br><span class="line">        &#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">            <span class="keyword">if</span> (!mInstrumentation.onException(app, e)) &#123;</span><br><span class="line">                <span class="keyword">throw</span> <span class="keyword">new</span> RuntimeException(</span><br><span class="line">                    <span class="string">"Unable to create application "</span> + app.getClass().getName()</span><br><span class="line">                    + <span class="string">": "</span> + e.toString(), e);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">        StrictMode.setThreadPolicy(savedPolicy);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>总结一下，上面的方法的主要流程：</p>
<ul>
<li>设置新进程的名字；</li>
<li>创建应用程序的 LoadedApk 对象；</li>
<li>创建应用的 ContextIpml 上下文实例；</li>
<li>创建应用程序的 Application 对象；</li>
<li>调用 Application.onCreate() 回调方法，初始化 app；</li>
</ul>
<p>上面是这个方法的主要作用，下面我们一个一个看：</p>
<h3 id="14-2-1-ContextImpl-createAppContext"><a href="#14-2-1-ContextImpl-createAppContext" class="headerlink" title="14.2.1 ContextImpl.createAppContext"></a>14.2.1 ContextImpl.createAppContext</h3><p>创建应用程序的上下文实例，参数传递：</p>
<ul>
<li>ActivityThread mainThread：当前进程的 ActivityThread 对象！</li>
<li>LoadedApk packageInfo：应用程序的信息对象;</li>
</ul>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">static</span> ContextImpl <span class="title">createAppContext</span><span class="params">(ActivityThread mainThread, LoadedApk packageInfo)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">if</span> (packageInfo == <span class="keyword">null</span>) <span class="keyword">throw</span> <span class="keyword">new</span> IllegalArgumentException(<span class="string">"packageInfo"</span>);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">new</span> ContextImpl(<span class="keyword">null</span>, mainThread,</span><br><span class="line">            packageInfo, <span class="keyword">null</span>, <span class="keyword">null</span>, <span class="keyword">false</span>, <span class="keyword">null</span>, <span class="keyword">null</span>, Display.INVALID_DISPLAY);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>这里调用了 new ContextImpl，创建了 ContextImpl 对象：<br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">private</span> <span class="title">ContextImpl</span><span class="params">(ContextImpl container, ActivityThread mainThread,</span></span></span><br><span class="line"><span class="function"><span class="params">        LoadedApk packageInfo, IBinder activityToken, UserHandle user, <span class="keyword">boolean</span> restricted,</span></span></span><br><span class="line"><span class="function"><span class="params">        Display display, Configuration overrideConfiguration, <span class="keyword">int</span> createDisplayWithId)</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    mOuterContext = <span class="keyword">this</span>;</span><br><span class="line"></span><br><span class="line">    mMainThread = mainThread;</span><br><span class="line">    mActivityToken = activityToken;</span><br><span class="line">    mRestricted = restricted;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (user == <span class="keyword">null</span>) &#123;</span><br><span class="line">        user = Process.myUserHandle();</span><br><span class="line">    &#125;</span><br><span class="line">    mUser = user;</span><br><span class="line"></span><br><span class="line">    mPackageInfo = packageInfo;</span><br><span class="line">    mResourcesManager = ResourcesManager.getInstance();</span><br><span class="line"></span><br><span class="line">    <span class="keyword">final</span> <span class="keyword">int</span> displayId = (createDisplayWithId != Display.INVALID_DISPLAY)</span><br><span class="line">            ? createDisplayWithId</span><br><span class="line">            : (display != <span class="keyword">null</span>) ? display.getDisplayId() : Display.DEFAULT_DISPLAY;</span><br><span class="line"></span><br><span class="line">    CompatibilityInfo compatInfo = <span class="keyword">null</span>;</span><br><span class="line">    <span class="keyword">if</span> (container != <span class="keyword">null</span>) &#123;</span><br><span class="line">        compatInfo = container.getDisplayAdjustments(displayId).getCompatibilityInfo();</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span> (compatInfo == <span class="keyword">null</span>) &#123;</span><br><span class="line">        compatInfo = (displayId == Display.DEFAULT_DISPLAY)</span><br><span class="line">                ? packageInfo.getCompatibilityInfo()</span><br><span class="line">                : CompatibilityInfo.DEFAULT_COMPATIBILITY_INFO;</span><br><span class="line">    &#125;</span><br><span class="line">    mDisplayAdjustments.setCompatibilityInfo(compatInfo);</span><br><span class="line">    mDisplayAdjustments.setConfiguration(overrideConfiguration);</span><br><span class="line"></span><br><span class="line">    mDisplay = (createDisplayWithId == Display.INVALID_DISPLAY) ? display</span><br><span class="line">            : ResourcesManager.getInstance().getAdjustedDisplay(displayId, mDisplayAdjustments);</span><br><span class="line"></span><br><span class="line">    Resources resources = packageInfo.getResources(mainThread);</span><br><span class="line">    <span class="keyword">if</span> (resources != <span class="keyword">null</span>) &#123;</span><br><span class="line">        <span class="keyword">if</span> (displayId != Display.DEFAULT_DISPLAY</span><br><span class="line">                || overrideConfiguration != <span class="keyword">null</span></span><br><span class="line">                || (compatInfo != <span class="keyword">null</span> &amp;&amp; compatInfo.applicationScale</span><br><span class="line">                        != resources.getCompatibilityInfo().applicationScale)) &#123;</span><br><span class="line">            resources = mResourcesManager.getTopLevelResources(packageInfo.getResDir(),</span><br><span class="line">                    packageInfo.getSplitResDirs(), packageInfo.getOverlayDirs(),</span><br><span class="line">                    packageInfo.getApplicationInfo().sharedLibraryFiles, displayId,</span><br><span class="line">                    overrideConfiguration, compatInfo);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    mResources = resources;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (container != <span class="keyword">null</span>) &#123;</span><br><span class="line">        mBasePackageName = container.mBasePackageName;</span><br><span class="line">        mOpPackageName = container.mOpPackageName;</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        mBasePackageName = packageInfo.mPackageName;</span><br><span class="line">        ApplicationInfo ainfo = packageInfo.getApplicationInfo();</span><br><span class="line">        <span class="keyword">if</span> (ainfo.uid == Process.SYSTEM_UID &amp;&amp; ainfo.uid != Process.myUid()) &#123;</span><br><span class="line"></span><br><span class="line">            <span class="comment">// Special case: system components allow themselves to be loaded in to other</span></span><br><span class="line">            <span class="comment">// processes.  For purposes of app ops, we must then consider the context as</span></span><br><span class="line">            <span class="comment">// belonging to the package of this process, not the system itself, otherwise</span></span><br><span class="line">            <span class="comment">// the package+uid verifications in app ops will fail.</span></span><br><span class="line">            mOpPackageName = ActivityThread.currentPackageName();</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            mOpPackageName = mBasePackageName;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    mContentResolver = <span class="keyword">new</span> ApplicationContentResolver(<span class="keyword">this</span>, mainThread, user);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<h3 id="14-2-2-LoadedApk-makeApplication"><a href="#14-2-2-LoadedApk-makeApplication" class="headerlink" title="14.2.2 LoadedApk.makeApplication"></a>14.2.2 LoadedApk.makeApplication</h3><p>调用了 LoadedApk.makeApplication 方法，利用反射创建应用的 Application 对象，参数传入：</p>
<ul>
<li>boolean forceDefaultAppClass：data.restrictedBackupMode</li>
<li>Instrumentation instrumentation：null<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br></pre></td><td class="code"><pre><span class="line">public Application makeApplication(boolean forceDefaultAppClass,</span><br><span class="line">        Instrumentation instrumentation) &#123;</span><br><span class="line">    if (mApplication != null) &#123;</span><br><span class="line"></span><br><span class="line">        // 如果已经创建，就直接返回！</span><br><span class="line">        return mApplication;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    Application app = null;</span><br><span class="line"></span><br><span class="line">    String appClass = mApplicationInfo.className;</span><br><span class="line">    if (forceDefaultAppClass || (appClass == null)) &#123;</span><br><span class="line"></span><br><span class="line">        // 要反射的类！</span><br><span class="line">        appClass = &quot;android.app.Application&quot;;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    try &#123;</span><br><span class="line">        java.lang.ClassLoader cl = getClassLoader();</span><br><span class="line">        if (!mPackageName.equals(&quot;android&quot;)) &#123; // 如果应用不是 framework-res.apk</span><br><span class="line">            initializeJavaContextClassLoader();</span><br><span class="line">        &#125;</span><br><span class="line">        </span><br><span class="line">        // 创建应用的上下文实例！</span><br><span class="line">        ContextImpl appContext = ContextImpl.createAppContext(mActivityThread, this);</span><br><span class="line"></span><br><span class="line">        // 利用上下文实例，创建应用的 Application 对象！</span><br><span class="line">        app = mActivityThread.mInstrumentation.newApplication(</span><br><span class="line">                cl, appClass, appContext);</span><br><span class="line"></span><br><span class="line">        // 这里是实现 Context 和 Application 的相互引用！</span><br><span class="line">        appContext.setOuterContext(app);</span><br><span class="line">        </span><br><span class="line">    &#125; catch (Exception e) &#123;</span><br><span class="line">        if (!mActivityThread.mInstrumentation.onException(app, e)) &#123;</span><br><span class="line">            throw new RuntimeException(</span><br><span class="line">                &quot;Unable to instantiate application &quot; + appClass</span><br><span class="line">                + &quot;: &quot; + e.toString(), e);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    mActivityThread.mAllApplications.add(app);</span><br><span class="line">    mApplication = app;</span><br><span class="line"></span><br><span class="line">    if (instrumentation != null) &#123; //这里不看！</span><br><span class="line">       ... ... ...</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    // Rewrite the R &apos;constants&apos; for all library apks.</span><br><span class="line">    SparseArray&lt;String&gt; packageIdentifiers = getAssets(mActivityThread)</span><br><span class="line">            .getAssignedPackageIdentifiers();</span><br><span class="line">            </span><br><span class="line">    final int N = packageIdentifiers.size();</span><br><span class="line">    for (int i = 0; i &lt; N; i++) &#123;</span><br><span class="line">        final int id = packageIdentifiers.keyAt(i);</span><br><span class="line">        if (id == 0x01 || id == 0x7f) &#123;</span><br><span class="line">            continue;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        rewriteRValues(getClassLoader(), packageIdentifiers.valueAt(i), id);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    return app;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
</li>
</ul>
<p>这里调用了 Instrumentation.newApplication 方法，创建 Application 的实例：<br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> Application <span class="title">newApplication</span><span class="params">(ClassLoader cl, String className, Context context)</span></span></span><br><span class="line"><span class="function">        <span class="keyword">throws</span> InstantiationException, IllegalAccessException, </span></span><br><span class="line"><span class="function">        ClassNotFoundException </span>&#123;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// 继续调用 newApplication 方法！  </span></span><br><span class="line">    <span class="keyword">return</span> newApplication(cl.loadClass(className), context);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">static</span> <span class="keyword">public</span> Application <span class="title">newApplication</span><span class="params">(Class&lt;?&gt; clazz, Context context)</span></span></span><br><span class="line"><span class="function">        <span class="keyword">throws</span> InstantiationException, IllegalAccessException, </span></span><br><span class="line"><span class="function">        ClassNotFoundException </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 创建 Application 对象！</span></span><br><span class="line">    Application app = (Application)clazz.newInstance();</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 将 context 和 Application 绑定，我们直接通过 getApplicationContext</span></span><br><span class="line">    <span class="comment">// 获得的就是这个 context 实例！</span></span><br><span class="line">    app.attach(context);</span><br><span class="line">    <span class="keyword">return</span> app;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<h3 id="14-2-3-Instrumentation-callApplicationOnCreate"><a href="#14-2-3-Instrumentation-callApplicationOnCreate" class="headerlink" title="14.2.3 Instrumentation.callApplicationOnCreate"></a>14.2.3 Instrumentation.callApplicationOnCreate</h3><p>这个方法很简单：<br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">callApplicationOnCreate</span><span class="params">(Application app)</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 调用 onCreate 方法！</span></span><br><span class="line">    app.onCreate();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>调用 Application 的 onCreate 方法！</p>
<p>到这里，bind 操作也完成了<strong>，应用程序进程已经启动，并且完成了和 SystemServer 进程的双向 Binder 绑定，也创建了应用程序的 Application 对象，调用了Application.onCreate  方法</strong>，接下来，就是启动指定的组件了！</p>
<p>回到 ActivityManagerService.attachApplicationLocked 方法中，bind 成功后，就会检测新进程中的组件了，组件的启动就在那里！！</p>
<p>关于组件的启动，以后在说！！</p>
<h1 id="15-总结"><a href="#15-总结" class="headerlink" title="15 总结"></a>15 总结</h1><p>其实，我们可以看到，进程的启动和创建，还是相当复杂的，其中涉及的细节很多，当时，阅读源码，最忌讳死扣细节，我们需要对框架有个整体的理解，下面，我们来通过几张图来总结一下，进程的启动！！</p>
<h2 id="15-1-进程的创建和启动"><a href="#15-1-进程的创建和启动" class="headerlink" title="15.1 进程的创建和启动"></a>15.1 进程的创建和启动</h2><p>下面我们用一张图来回顾下这个流程：</p>
<p><img src="http://static.zybuluo.com/Coolqi/7aj6yzbtt7yk3h70qjps38w0/Process%20%E5%88%9B%E5%BB%BA%E6%B5%81%E7%A8%8B%E5%9B%BE.png" alt="Process 创建流程图.png-33.2kB"></p>
<p>其中，check/start 指定组件，也存在系统进程和应用进程间的多次 Binder 通信，这里我们不重点讨论，在后面分析四大组件时，会详细分析他们的生命周期过程，会重点分析这个部分！</p>
<h2 id="15-2-ActivityThread-关系图"><a href="#15-2-ActivityThread-关系图" class="headerlink" title="15.2 ActivityThread 关系图"></a>15.2 ActivityThread 关系图</h2></div></article><div class="post-copyright"><div class="post-copyright__author"><span class="post-copyright-meta">文章作者: </span><span class="post-copyright-info"><a href="mailto:undefined">Coolqi.Li</a></span></div><div class="post-copyright__type"><span class="post-copyright-meta">文章链接: </span><span class="post-copyright-info"><a href="https://coolqi.top/2016/03/13/Process1-theStartOfProcess/">https://coolqi.top/2016/03/13/Process1-theStartOfProcess/</a></span></div><div class="post-copyright__notice"><span class="post-copyright-meta">版权声明: </span><span class="post-copyright-info">本博客所有文章除特别声明外，均采用 <a href="https://creativecommons.org/licenses/by-nc-sa/4.0/">CC BY-NC-SA 4.0</a> 许可协议。转载请注明来自 <a href="https://coolqi.top">Coolqi`s Blog</a>！</span></div></div><div class="post-meta__tag-list"><a class="post-meta__tags" href="/tags/Process进程/">Process进程</a></div><div class="post-qr-code"><div class="post-qr-code-item"><img class="post-qr-code__img" src="/img/zfb.jpg"><div class="post-qr-code__desc">支付宝打赏</div></div><div class="post-qr-code-item"><img class="post-qr-code__img" src="/img/wechat.jpg"><div class="post-qr-code__desc">微信打赏</div></div></div><div class="social-share"></div><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/social-share.js@1.0.16/dist/css/share.min.css"><script src="https://cdn.jsdelivr.net/npm/social-share.js@1.0.16/dist/js/social-share.min.js"></script><nav id="pagination"><div class="prev-post pull-left"><a href="/2016/03/19/Process2-theCreateOfProcess/"><i class="fa fa-chevron-left">  </i><span>Process篇 2 - Android 进程的创建</span></a></div><div class="next-post pull-right"><a href="/2016/03/01/Service2-startService/"><span>Service 篇 2 - startService 流程分析</span><i class="fa fa-chevron-right"></i></a></div></nav><div class="post-adv"><a href="https://www.vultr.com/?ref=7231808"><img src="https://www.vultr.com/media/banner_1.png" width="728" height="90"></a></div></div></div><footer><div class="layout" id="footer"><div class="copyright">&copy;2015 - 2019 By Coolqi.Li</div><div class="framework-info"><span>驱动 - </span><a href="http://hexo.io"><span>Hexo</span></a><span class="footer-separator">|</span><span>主题 - </span><a href="https://github.com/Molunerfinn/hexo-theme-melody"><span>Melody</span></a></div><div class="footer_custom_text">Hi, welcome to my <a href="https://lishuaiqi.top/">blog</a>!</div><div class="busuanzi"><script async src="https://busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script><span id="busuanzi_container_page_pv"><i class="fa fa-file-o"></i><span id="busuanzi_value_page_pv"></span><span></span></span></div></div></footer><i class="fa fa-arrow-up" id="go-up" aria-hidden="true"></i><script src="/js/third-party/anime.min.js"></script><script src="/js/third-party/jquery.min.js"></script><script src="/js/third-party/jquery.fancybox.min.js"></script><script src="/js/third-party/velocity.min.js"></script><script src="/js/third-party/velocity.ui.min.js"></script><script src="/js/utils.js?version=1.5.6"></script><script src="/js/fancybox.js?version=1.5.6"></script><script src="/js/sidebar.js?version=1.5.6"></script><script src="/js/copy.js?version=1.5.6"></script><script src="/js/fireworks.js?version=1.5.6"></script><script src="/js/transition.js?version=1.5.6"></script><script src="/js/scroll.js?version=1.5.6"></script><script src="/js/head.js?version=1.5.6"></script><script type="text/x-mathjax-config">MathJax.Hub.Config({
  tex2jax: {
    inlineMath: [ ['$','$'], ["\\(","\\)"]  ],
    processEscapes: true,
    skipTags: ['script', 'noscript', 'style', 'textarea', 'pre', 'code']
  },
  CommonHTML: {
    linebreaks: { automatic: true, width: "90% container" }
  },
  "HTML-CSS": { 
    linebreaks: { automatic: true, width: "90% container" }
  },
  "SVG": { 
    linebreaks: { automatic: true, width: "90% container" }
  }
});
</script><script type="text/x-mathjax-config">MathJax.Hub.Queue(function() {
  var all = MathJax.Hub.getAllJax(), i;
  for (i=0; i < all.length; i += 1) {
    all[i].SourceElement().parentNode.className += ' has-jax';
  }
});
</script><script src="https://cdn.jsdelivr.net/npm/mathjax/MathJax.js?config=TeX-AMS-MML_HTMLorMML"></script><script src="/js/search/local-search.js"></script><div class="search-dialog" id="local-search"><div class="search-dialog__title" id="local-search-title">本地搜索</div><div id="local-input-panel"><div id="local-search-input"><div class="local-search-box"><input class="local-search-box--input" placeholder="搜索文章"></div></div></div><hr><div id="local-search-results"><div id="local-hits"></div><div id="local-stats"><div class="local-search-stats__hr" id="hr"><span>由</span> <a href="https://github.com/wzpan/hexo-generator-search" style="color:#49B1F5;">hexo-generator-search</a>
 <span>提供支持</span></div></div></div><span class="search-close-button"><i class="fa fa-times"></i></span></div><div class="search-mask"></div><script src="/live2dw/lib/L2Dwidget.min.js?0c58a1486de42ac6cc1c59c7d98ae887"></script><script>L2Dwidget.init({"pluginRootPath":"live2dw/","pluginJsPath":"lib/","pluginModelPath":"assets/","tagMode":false,"debug":false,"model":{"jsonPath":"live2d-widget-model-hijiki"},"display":{"position":"right","width":110,"height":220},"mobile":{"show":false},"log":false});</script></body></html>
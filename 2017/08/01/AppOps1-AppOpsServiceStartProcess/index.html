<!DOCTYPE html><html lang="zh-Hans"><head><meta name="generator" content="Hexo 3.9.0"><meta charset="UTF-8"><meta http-equiv="X-UA-Compatible" content="IE=edge"><meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1"><meta name="description" content="AppOps 第 1 篇 - AppOpsService 的启动"><meta name="keywords" content="AppOps应用操作管理"><meta name="author" content="Coolqi.Li"><meta name="copyright" content="Coolqi.Li"><title>AppOps 第 1 篇 - AppOpsService 的启动 | Coolqi`s Blog</title><link rel="shortcut icon" href="/img/favicon.ico"><link rel="stylesheet" href="/css/index.css?version=1.7.0"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/font-awesome@latest/css/font-awesome.min.css?version=1.7.0"><link rel="stylesheet" href="https://use.fontawesome.com/releases/v5.7.2/css/all.css?version=1.7.0"><meta name="format-detection" content="telephone=no"><meta http-equiv="x-dns-prefetch-control" content="on"><link rel="dns-prefetch" href="https://cdn.jsdelivr.net"><link rel="dns-prefetch" href="https://unpkg.com"><link rel="stylesheet" type="text/css" href="https://cdn.jsdelivr.net/npm/gitment/style/default.min.css"><script src="https://cdn.jsdelivr.net/npm/gitment/dist/gitment.browser.min.js"></script><script src="https://cdn.jsdelivr.net/npm/blueimp-md5@2.10.0/js/md5.min.js"></script><link rel="dns-prefetch" href="https://hm.baidu.com"><script>var _hmt = _hmt || [];
(function() {
  var hm = document.createElement("script");
  hm.src = "https://hm.baidu.com/hm.js?b7acef5306e54116ad8a99e8b753a92d";
  var s = document.getElementsByTagName("script")[0]; 
  s.parentNode.insertBefore(hm, s);
})();</script><script>var GLOBAL_CONFIG = { 
  root: '/',
  algolia: undefined,
  localSearch: {"path":"search.xml","languages":{"hits_empty":"找不到您查询的内容:${query}"}},
  copy: {
    success: '复制成功',
    error: '复制错误',
    noSupport: '浏览器不支持'
  }
} </script></head><body><i class="fa fa-arrow-right" id="toggle-sidebar" aria-hidden="true"></i><div id="sidebar" data-display="true"><div class="toggle-sidebar-info text-center"><span data-toggle="切换文章详情">切换站点概览</span><hr></div><div class="sidebar-toc"><div class="sidebar-toc__title">目录</div><div class="sidebar-toc__progress"><span class="progress-notice">你已经读了</span><span class="progress-num">0</span><span class="progress-percentage">%</span><div class="sidebar-toc__progress-bar"></div></div><div class="sidebar-toc__content"><ol class="toc"><li class="toc-item toc-level-1"><a class="toc-link" href="#0-综述"><span class="toc-text">0 综述</span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#1-new-AppOpsService"><span class="toc-text">1 new AppOpsService</span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#2-AppOpsService-readState"><span class="toc-text">2 AppOpsService.readState</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#2-1-AppOpsService-readUid-1-读取-uid-的-op-信息"><span class="toc-text">2.1 AppOpsService.readUid[1] - 读取 uid 的 op 信息</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#2-1-1-getUidStateLocked"><span class="toc-text">2.1.1 getUidStateLocked</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#2-1-2-new-UidState"><span class="toc-text">2.1.2 new UidState</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#2-1-2-1-new-Ops"><span class="toc-text">2.1.2.1 new Ops</span></a></li></ol></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#2-2-AppOpsService-readPackage-读取-package-的-op-信息"><span class="toc-text">2.2 AppOpsService.readPackage  - 读取 package 的 op 信息</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#2-2-1-AppOpsService-readUid-2"><span class="toc-text">2.2.1 AppOpsService.readUid[2]</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#2-2-1-1-new-Op"><span class="toc-text">2.2.1.1 new Op</span></a></li></ol></li></ol></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#3-AppOpsService-startWatchingMode"><span class="toc-text">3 AppOpsService.startWatchingMode</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#3-1-new-Callback-死亡回调"><span class="toc-text">3.1 new Callback - 死亡回调</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#3-1-1-AppOpsService-stopWatchingMode"><span class="toc-text">3.1.1 AppOpsService.stopWatchingMode</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#3-2-AMS-对-OP-RUN-IN-BACKGROUND-的处理"><span class="toc-text">3.2 AMS 对 OP_RUN_IN_BACKGROUND 的处理</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#3-2-1-runInBackgroundDisabled"><span class="toc-text">3.2.1 runInBackgroundDisabled</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#3-2-2-doStopUidLocked"><span class="toc-text">3.2.2 doStopUidLocked</span></a></li></ol></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#4-AppOpsService-publish-publish-到-ServiceManager-中！"><span class="toc-text">4 AppOpsService.publish - publish 到 ServiceManager 中！</span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#5-AppOpsService-systemReady"><span class="toc-text">5 AppOpsService.systemReady</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#5-1-getPackagesForUid"><span class="toc-text">5.1 getPackagesForUid</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#5-2-scheduleFastWriteLocked"><span class="toc-text">5.2 scheduleFastWriteLocked</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#5-3-writeState"><span class="toc-text">5.3 writeState</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#5-3-1-getPackagesForOps"><span class="toc-text">5.3.1 getPackagesForOps</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#5-3-1-1-collectOps"><span class="toc-text">5.3.1.1 collectOps</span></a><ol class="toc-child"><li class="toc-item toc-level-5"><a class="toc-link" href="#5-3-1-1-1-new-AppOpsManager-OpEntry"><span class="toc-text">5.3.1.1.1 new AppOpsManager.OpEntry</span></a></li></ol></li><li class="toc-item toc-level-4"><a class="toc-link" href="#5-3-1-2-new-AppOpsManager-PackageOps"><span class="toc-text">5.3.1.2 new AppOpsManager.PackageOps</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#5-3-2-getOpsRawLocked"><span class="toc-text">5.3.2 getOpsRawLocked</span></a></li></ol></li></ol></li></ol></div></div><div class="author-info hide"><div class="author-info__avatar text-center"><img src="/img/avatar.jpg"></div><div class="author-info__name text-center">Coolqi.Li</div><div class="author-info__description text-center">“Hi，我是李帅奇，Android 开发工程师，TeamLeader，熬夜星人，一个努力赚钱，积极向上的好人。”</div><div class="follow-button"><a href="https://github.com/single-li">Follow Me</a></div><hr><div class="author-info-articles"><a class="author-info-articles__archives article-meta" href="/archives"><span class="pull-left">文章</span><span class="pull-right">88</span></a><a class="author-info-articles__tags article-meta" href="/tags"><span class="pull-left">标签</span><span class="pull-right">21</span></a><a class="author-info-articles__categories article-meta" href="/categories"><span class="pull-left">分类</span><span class="pull-right">26</span></a></div><hr><div class="author-info-links"><div class="author-info-links__title text-center">Links</div><a class="author-info-links__name text-center" href="https://developer.android.google.cn/">AndroidDeveloper</a><a class="author-info-links__name text-center" href="http://www.android-studio.org/">AndroidStudio</a><a class="author-info-links__name text-center" href="https://www.jianshu.com/u/123a20a96441">简书</a><a class="author-info-links__name text-center" href="https://weibo.com/coolqiLi">微博</a></div></div></div><div id="content-outer"><div id="top-container" style="background-image: url(/img/blog-bg.jpg)"><div id="page-header"><span class="pull-left"> <a id="site-name" href="/">Coolqi`s Blog</a></span><i class="fa fa-bars toggle-menu pull-right" aria-hidden="true"></i><span class="pull-right menus">   <a class="site-page" href="/">Home</a><a class="site-page" href="/categories">Categories</a><a class="site-page" href="/tags">Tags</a><a class="site-page" href="/archives">Archives</a><a class="site-page" href="/about">About</a></span><span class="pull-right"><a class="site-page social-icon search"><i class="fa fa-search"></i><span> 搜索</span></a></span></div><div id="post-info"><div id="post-title">AppOps 第 1 篇 - AppOpsService 的启动</div><div id="post-meta"><time class="post-meta__date"><i class="fa fa-calendar" aria-hidden="true"></i> 2017-08-01</time><span class="post-meta__separator">|</span><i class="fa fa-inbox post-meta__icon" aria-hidden="true"></i><a class="post-meta__categories" href="/categories/AndroidFramework源码分析/">AndroidFramework源码分析</a><i class="fa fa-angle-right" aria-hidden="true"></i><i class="fa fa-inbox post-meta__icon" aria-hidden="true"></i><a class="post-meta__categories" href="/categories/AndroidFramework源码分析/AppOps应用操作管理/">AppOps应用操作管理</a><div class="post-meta-wordcount"><span>字数总计: </span><span class="word-count">6.3k</span><span class="post-meta__separator">|</span><span>阅读时长: 31 分钟</span></div></div></div></div><div class="layout" id="content-inner"><article id="post"><div class="article-container" id="post-content"><p>[toc]</p>
<p>本文基于 Android 7.1.1 源码分析，如有错误，欢迎指正，谢谢！</p>
<h1 id="0-综述"><a href="#0-综述" class="headerlink" title="0 综述"></a>0 综述</h1><p>AppOpsService 的初始化是在 ActivityManagerService 启动的时候：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="title">ActivityManagerService</span><span class="params">(Context systemContext)</span> </span>&#123;</span><br><span class="line">    ... ... ...   </span><br><span class="line">    mHandlerThread = <span class="keyword">new</span> ServiceThread(TAG,</span><br><span class="line">            android.os.Process.THREAD_PRIORITY_FOREGROUND, <span class="keyword">false</span> <span class="comment">/*allowIo*/</span>);</span><br><span class="line">    mHandlerThread.start();</span><br><span class="line">    mHandler = <span class="keyword">new</span> MainHandler(mHandlerThread.getLooper());</span><br><span class="line">    </span><br><span class="line">    ... ... ... </span><br><span class="line">    <span class="comment">// <span class="doctag">TODO:</span> Move creation of battery stats service outside of activity manager service.</span></span><br><span class="line">    File dataDir = Environment.getDataDirectory();</span><br><span class="line">    File systemDir = <span class="keyword">new</span> File(dataDir, <span class="string">"system"</span>);</span><br><span class="line">    systemDir.mkdirs();</span><br><span class="line"></span><br><span class="line">    ... ... ...</span><br><span class="line">    <span class="comment">//【1】创建了 AppOpsService 对象！</span></span><br><span class="line">    mAppOpsService = <span class="keyword">new</span> AppOpsService(<span class="keyword">new</span> File(systemDir, <span class="string">"appops.xml"</span>), mHandler);</span><br><span class="line">    <span class="comment">//【2】启动监听，开始监听是否有应用要在后台运行！</span></span><br><span class="line">    mAppOpsService.startWatchingMode(AppOpsManager.OP_RUN_IN_BACKGROUND, <span class="keyword">null</span>,</span><br><span class="line">            <span class="keyword">new</span> IAppOpsCallback.Stub() &#123;</span><br><span class="line">                <span class="meta">@Override</span> <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">opChanged</span><span class="params">(<span class="keyword">int</span> op, <span class="keyword">int</span> uid, String packageName)</span> </span>&#123;</span><br><span class="line">                    <span class="keyword">if</span> (op == AppOpsManager.OP_RUN_IN_BACKGROUND &amp;&amp; packageName != <span class="keyword">null</span>) &#123;</span><br><span class="line">                        <span class="keyword">if</span> (mAppOpsService.checkOperation(op, uid, packageName)</span><br><span class="line">                                != AppOpsManager.MODE_ALLOWED) &#123;</span><br><span class="line">                            runInBackgroundDisabled(uid);</span><br><span class="line">                        &#125;</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;);</span><br><span class="line">    ... ... ...</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h1 id="1-new-AppOpsService"><a href="#1-new-AppOpsService" class="headerlink" title="1 new AppOpsService"></a>1 new AppOpsService</h1><p>创建 AppOpsService 的时候，传入了一个 File 对象，用于访问 /data/system/appops.xml 文件！</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="title">AppOpsService</span><span class="params">(File storagePath, Handler handler)</span> </span>&#123;</span><br><span class="line">    mFile = <span class="keyword">new</span> AtomicFile(storagePath);</span><br><span class="line">    mHandler = handler;</span><br><span class="line">    <span class="comment">//【2】从 /data/system/appops.xml 文件中读取记录！</span></span><br><span class="line">    readState();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>我们来看下，appops.xml 文件的内容：</p>
<figure class="highlight"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br></pre></td><td class="code"><pre><span class="line">&lt;?xml version=<span class="string">'1.0'</span> encoding=<span class="string">'utf-8'</span> standalone=<span class="string">'yes'</span> ?&gt;</span><br><span class="line">&lt;app-ops&gt;</span><br><span class="line">    &lt;uid n=<span class="string">"1001"</span>&gt;</span><br><span class="line">        &lt;op m=<span class="string">"0"</span> n=<span class="string">"15"</span>/&gt;</span><br><span class="line">    &lt;/uid&gt;</span><br><span class="line">    &lt;pkg n=<span class="string">"android"</span>&gt;</span><br><span class="line">        &lt;uid n=<span class="string">"1000"</span> p=<span class="string">"true"</span>&gt;</span><br><span class="line">            &lt;op n=<span class="string">"0"</span> pu=<span class="string">"0"</span> t=<span class="string">"1514736165168"</span>/&gt;</span><br><span class="line">            &lt;op n=<span class="string">"1"</span> pu=<span class="string">"0"</span> t=<span class="string">"1514738472778"</span>/&gt;</span><br><span class="line">            &lt;op d=<span class="string">"133"</span> n=<span class="string">"3"</span> t=<span class="string">"1514752786349"</span>/&gt;</span><br><span class="line">            &lt;op n=<span class="string">"24"</span> r=<span class="string">"1514738089301"</span>/&gt;</span><br><span class="line">            &lt;op n=<span class="string">"40"</span> t=<span class="string">"1514756174224"</span>/&gt;</span><br><span class="line">            &lt;op d=<span class="string">"20027926"</span> n=<span class="string">"41"</span> t=<span class="string">"1514736155960"</span>/&gt;</span><br><span class="line">            &lt;op n=<span class="string">"61"</span> pu=<span class="string">"0"</span> t=<span class="string">"1514756174065"</span>/&gt;</span><br><span class="line">        &lt;/uid&gt;</span><br><span class="line">    &lt;/pkg&gt;</span><br><span class="line">    &lt;pkg n=<span class="string">"com.android.settings"</span>&gt;</span><br><span class="line">        &lt;uid n=<span class="string">"1000"</span> p=<span class="string">"true"</span>&gt;</span><br><span class="line">            &lt;op d=<span class="string">"135"</span> n=<span class="string">"3"</span> t=<span class="string">"1514738402132"</span>/&gt;</span><br><span class="line">            &lt;op m=<span class="string">"0"</span> n=<span class="string">"15"</span>/&gt;</span><br><span class="line">            &lt;op n=<span class="string">"59"</span> pp=<span class="string">"com.android.providers.media"</span> pu=<span class="string">"0"</span> t=<span class="string">"1514738336945"</span>/&gt;</span><br><span class="line">            &lt;op n=<span class="string">"60"</span> pu=<span class="string">"0"</span> t=<span class="string">"1514736151388"</span>/&gt;</span><br><span class="line">            &lt;op n=<span class="string">"63"</span> pu=<span class="string">"0"</span> t=<span class="string">"1514749896628"</span>/&gt;</span><br><span class="line">            &lt;op n=<span class="string">"73"</span> pu=<span class="string">"0"</span> t=<span class="string">"1514749896649"</span>/&gt;</span><br><span class="line">        &lt;/uid&gt;</span><br><span class="line">    &lt;/pkg&gt;</span><br><span class="line">    &lt;pkg n=<span class="string">"com.android.systemui"</span>&gt;</span><br><span class="line">        &lt;uid n=<span class="string">"1000"</span> p=<span class="string">"true"</span>&gt;</span><br><span class="line">            &lt;op d=<span class="string">"74"</span> n=<span class="string">"3"</span> t=<span class="string">"1514752786572"</span>/&gt;</span><br><span class="line">            &lt;op n=<span class="string">"24"</span> r=<span class="string">"1514741582746"</span>/&gt;</span><br><span class="line">            &lt;op d=<span class="string">"98"</span> n=<span class="string">"40"</span> t=<span class="string">"1514752835557"</span>/&gt;</span><br><span class="line">            &lt;op n=<span class="string">"59"</span> pu=<span class="string">"0"</span> t=<span class="string">"493576354"</span>/&gt;</span><br><span class="line">            &lt;op n=<span class="string">"60"</span> pu=<span class="string">"0"</span> t=<span class="string">"493576354"</span>/&gt;</span><br><span class="line">        &lt;/uid&gt;</span><br><span class="line">    &lt;/pkg&gt;</span><br><span class="line">&lt;/app-ops&gt;</span><br></pre></td></tr></table></figure>
<p>内容我们先简单的分析下：</p>
<ul>
<li>uid 用于记录和 uid 相关的限制信息；</li>
<li>pkg 用于记录和具体应用的限制信息；</li>
</ul>
<h1 id="2-AppOpsService-readState"><a href="#2-AppOpsService-readState" class="headerlink" title="2 AppOpsService.readState"></a>2 AppOpsService.readState</h1><p>AppOpsService 启动的时候，会读取本地持久化文件，恢复上一次的数据！<br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">readState</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    <span class="keyword">synchronized</span> (mFile) &#123;</span><br><span class="line">        <span class="keyword">synchronized</span> (<span class="keyword">this</span>) &#123;</span><br><span class="line">            FileInputStream stream;</span><br><span class="line">            <span class="keyword">try</span> &#123;</span><br><span class="line">                stream = mFile.openRead();</span><br><span class="line">            &#125; <span class="keyword">catch</span> (FileNotFoundException e) &#123;</span><br><span class="line">                Slog.i(TAG, <span class="string">"No existing app ops "</span> + mFile.getBaseFile() + <span class="string">"; starting empty"</span>);</span><br><span class="line">                <span class="keyword">return</span>;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">boolean</span> success = <span class="keyword">false</span>;</span><br><span class="line">            mUidStates.clear();</span><br><span class="line">            <span class="keyword">try</span> &#123;</span><br><span class="line">                XmlPullParser parser = Xml.newPullParser();</span><br><span class="line">                parser.setInput(stream, StandardCharsets.UTF_8.name());</span><br><span class="line">                <span class="keyword">int</span> type;</span><br><span class="line">                <span class="keyword">while</span> ((type = parser.next()) != XmlPullParser.START_TAG</span><br><span class="line">                        &amp;&amp; type != XmlPullParser.END_DOCUMENT) &#123;</span><br><span class="line">                    ;</span><br><span class="line">                &#125;</span><br><span class="line"></span><br><span class="line">                <span class="keyword">if</span> (type != XmlPullParser.START_TAG) &#123;</span><br><span class="line">                    <span class="keyword">throw</span> <span class="keyword">new</span> IllegalStateException(<span class="string">"no start tag found"</span>);</span><br><span class="line">                &#125;</span><br><span class="line"></span><br><span class="line">                <span class="keyword">int</span> outerDepth = parser.getDepth();</span><br><span class="line">                <span class="keyword">while</span> ((type = parser.next()) != XmlPullParser.END_DOCUMENT</span><br><span class="line">                        &amp;&amp; (type != XmlPullParser.END_TAG || parser.getDepth() &gt; outerDepth)) &#123;</span><br><span class="line">                    <span class="keyword">if</span> (type == XmlPullParser.END_TAG || type == XmlPullParser.TEXT) &#123;</span><br><span class="line">                        <span class="keyword">continue</span>;</span><br><span class="line">                    &#125;</span><br><span class="line"></span><br><span class="line">                    String tagName = parser.getName();</span><br><span class="line">                    <span class="keyword">if</span> (tagName.equals(<span class="string">"pkg"</span>)) &#123;</span><br><span class="line">                        <span class="comment">//【1】读取 pkg 标签；</span></span><br><span class="line">                        readPackage(parser);</span><br><span class="line">                    &#125; <span class="keyword">else</span> <span class="keyword">if</span> (tagName.equals(<span class="string">"uid"</span>)) &#123;</span><br><span class="line">                        <span class="comment">//【2】读取 uid 标签；</span></span><br><span class="line">                        readUidOps(parser);</span><br><span class="line">                    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                        Slog.w(TAG, <span class="string">"Unknown element under &lt;app-ops&gt;: "</span></span><br><span class="line">                                + parser.getName());</span><br><span class="line">                        XmlUtils.skipCurrentTag(parser);</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;</span><br><span class="line">                success = <span class="keyword">true</span>;</span><br><span class="line">            &#125; <span class="keyword">catch</span> (IllegalStateException e) &#123;</span><br><span class="line">                Slog.w(TAG, <span class="string">"Failed parsing "</span> + e);</span><br><span class="line">            &#125; <span class="keyword">catch</span> (NullPointerException e) &#123;</span><br><span class="line">                Slog.w(TAG, <span class="string">"Failed parsing "</span> + e);</span><br><span class="line">            &#125; <span class="keyword">catch</span> (NumberFormatException e) &#123;</span><br><span class="line">                Slog.w(TAG, <span class="string">"Failed parsing "</span> + e);</span><br><span class="line">            &#125; <span class="keyword">catch</span> (XmlPullParserException e) &#123;</span><br><span class="line">                Slog.w(TAG, <span class="string">"Failed parsing "</span> + e);</span><br><span class="line">            &#125; <span class="keyword">catch</span> (IOException e) &#123;</span><br><span class="line">                Slog.w(TAG, <span class="string">"Failed parsing "</span> + e);</span><br><span class="line">            &#125; <span class="keyword">catch</span> (IndexOutOfBoundsException e) &#123;</span><br><span class="line">                Slog.w(TAG, <span class="string">"Failed parsing "</span> + e);</span><br><span class="line">            &#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">                <span class="keyword">if</span> (!success) &#123;</span><br><span class="line">                    mUidStates.clear();</span><br><span class="line">                &#125;</span><br><span class="line">                <span class="keyword">try</span> &#123;</span><br><span class="line">                    stream.close();</span><br><span class="line">                &#125; <span class="keyword">catch</span> (IOException e) &#123;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>readState 会 pkg 和 uid 标签的数据，然后保存到内部的数据结构中！</p>
<h2 id="2-1-AppOpsService-readUid-1-读取-uid-的-op-信息"><a href="#2-1-AppOpsService-readUid-1-读取-uid-的-op-信息" class="headerlink" title="2.1 AppOpsService.readUid[1] - 读取 uid 的 op 信息"></a>2.1 AppOpsService.readUid[1] - 读取 uid 的 op 信息</h2><p>首先，解析的是 uid 信息！</p>
<figure class="highlight"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">&lt;uid n=<span class="string">"1001"</span>&gt;</span><br><span class="line">    &lt;op m=<span class="string">"0"</span> n=<span class="string">"15"</span>/&gt;</span><br><span class="line">&lt;/uid&gt;</span><br></pre></td></tr></table></figure>
<p>解释一下：</p>
<ul>
<li>uid 的 n 属性表示 uid 的取值；</li>
<li>op 的 n 属性表示 op 的数值，m 表示 op 的 mode 值；</li>
</ul>
<p>我们来看看解析的过程！</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">readUidOps</span><span class="params">(XmlPullParser parser)</span> <span class="keyword">throws</span> NumberFormatException,</span></span><br><span class="line"><span class="function">        XmlPullParserException, IOException </span>&#123;</span><br><span class="line">    <span class="keyword">final</span> <span class="keyword">int</span> uid = Integer.parseInt(parser.getAttributeValue(<span class="keyword">null</span>, <span class="string">"n"</span>));</span><br><span class="line">    <span class="keyword">int</span> outerDepth = parser.getDepth();</span><br><span class="line">    <span class="keyword">int</span> type;</span><br><span class="line">    <span class="keyword">while</span> ((type = parser.next()) != XmlPullParser.END_DOCUMENT</span><br><span class="line">            &amp;&amp; (type != XmlPullParser.END_TAG || parser.getDepth() &gt; outerDepth)) &#123;</span><br><span class="line">        <span class="keyword">if</span> (type == XmlPullParser.END_TAG || type == XmlPullParser.TEXT) &#123;</span><br><span class="line">            <span class="keyword">continue</span>;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        String tagName = parser.getName();</span><br><span class="line">        <span class="keyword">if</span> (tagName.equals(<span class="string">"op"</span>)) &#123; <span class="comment">// 解析 op 子标签！</span></span><br><span class="line">            <span class="keyword">final</span> <span class="keyword">int</span> code = Integer.parseInt(parser.getAttributeValue(<span class="keyword">null</span>, <span class="string">"n"</span>)); <span class="comment">//</span></span><br><span class="line">            <span class="keyword">final</span> <span class="keyword">int</span> mode = Integer.parseInt(parser.getAttributeValue(<span class="keyword">null</span>, <span class="string">"m"</span>));</span><br><span class="line">            <span class="comment">//【2.1.1】调用 getUidStateLocked 获得 uid 对应的状态信息，如果没有，就会创建一个！</span></span><br><span class="line">            UidState uidState = getUidStateLocked(uid, <span class="keyword">true</span>);</span><br><span class="line">            <span class="keyword">if</span> (uidState.opModes == <span class="keyword">null</span>) &#123;</span><br><span class="line">                uidState.opModes = <span class="keyword">new</span> SparseIntArray();</span><br><span class="line">            &#125;</span><br><span class="line">            uidState.opModes.put(code, mode);</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            Slog.w(TAG, <span class="string">"Unknown element under &lt;uid-ops&gt;: "</span></span><br><span class="line">                    + parser.getName());</span><br><span class="line">            XmlUtils.skipCurrentTag(parser);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>我们看到，创建了一个 UidState 对象，封装对 uid 的 op 控制，uidState.opModes 则保存了该 uid 的所有 op 和控制情况的映射关系！</p>
<h3 id="2-1-1-getUidStateLocked"><a href="#2-1-1-getUidStateLocked" class="headerlink" title="2.1.1 getUidStateLocked"></a>2.1.1 getUidStateLocked</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">private</span> UidState <span class="title">getUidStateLocked</span><span class="params">(<span class="keyword">int</span> uid, <span class="keyword">boolean</span> edit)</span> </span>&#123;</span><br><span class="line">    <span class="comment">// 通过 uid，获得对应的 UidState 对象！</span></span><br><span class="line">    UidState uidState = mUidStates.get(uid);</span><br><span class="line">    <span class="keyword">if</span> (uidState == <span class="keyword">null</span>) &#123;</span><br><span class="line">        <span class="keyword">if</span> (!edit) &#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="keyword">null</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">//【2.1.2】创建一个新的 UidState，并添加到 mUidStates 中！</span></span><br><span class="line">        uidState = <span class="keyword">new</span> UidState(uid);</span><br><span class="line">        mUidStates.put(uid, uidState);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> uidState;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>AppOpsService 有一个内部的 SparseArray，用于保存 uid 和其对应的 UidState 的映射关系！<br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">private</span> <span class="keyword">final</span> SparseArray&lt;UidState&gt; mUidStates = <span class="keyword">new</span> SparseArray&lt;&gt;();</span><br></pre></td></tr></table></figure></p>
<h3 id="2-1-2-new-UidState"><a href="#2-1-2-new-UidState" class="headerlink" title="2.1.2 new UidState"></a>2.1.2 new UidState</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="class"><span class="keyword">class</span> <span class="title">UidState</span> </span>&#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">final</span> <span class="keyword">int</span> uid; <span class="comment">// uid 值</span></span><br><span class="line">    <span class="keyword">public</span> ArrayMap&lt;String, Ops&gt; pkgOps; <span class="comment">//【2.1.2.1】属于 uid 的所有 package 和其 Op 集合的映射关系！</span></span><br><span class="line">    <span class="keyword">public</span> SparseIntArray opModes; <span class="comment">// 用于保存该 uid 的 op 集合 ！</span></span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="title">UidState</span><span class="params">(<span class="keyword">int</span> uid)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">this</span>.uid = uid;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">clear</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        pkgOps = <span class="keyword">null</span>;</span><br><span class="line">        opModes = <span class="keyword">null</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">boolean</span> <span class="title">isDefault</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> (pkgOps == <span class="keyword">null</span> || pkgOps.isEmpty())</span><br><span class="line">                &amp;&amp; (opModes == <span class="keyword">null</span> || opModes.size() &lt;= <span class="number">0</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>UidState.pkgOps 是一个 ArrayMap，key 为 packageName，而 value 为 Ops，Ops 用于封装该 package 所有的 Op 控制数据！</p>
<p>这里涉及到了一个 Ops 类，我们来看下他的结构!</p>
<h4 id="2-1-2-1-new-Ops"><a href="#2-1-2-1-new-Ops" class="headerlink" title="2.1.2.1 new Ops"></a>2.1.2.1 new Ops</h4><p>可以看到 Ops 本质上是一个 SparseArray，用于记录 package 的所有 Op 控制信息！<br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">final</span> <span class="keyword">static</span> <span class="class"><span class="keyword">class</span> <span class="title">Ops</span> <span class="keyword">extends</span> <span class="title">SparseArray</span>&lt;<span class="title">Op</span>&gt; </span>&#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">final</span> String packageName; <span class="comment">// 所属的 package</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">final</span> UidState uidState; <span class="comment">// 所属的 UidState</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">final</span> <span class="keyword">boolean</span> isPrivileged;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="title">Ops</span><span class="params">(String _packageName, UidState _uidState, <span class="keyword">boolean</span> _isPrivileged)</span> </span>&#123;</span><br><span class="line">        packageName = _packageName;</span><br><span class="line">        uidState = _uidState;</span><br><span class="line">        isPrivileged = _isPrivileged;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>保存的规则是：下标为 op，值为控制情况！</p>
<h2 id="2-2-AppOpsService-readPackage-读取-package-的-op-信息"><a href="#2-2-AppOpsService-readPackage-读取-package-的-op-信息" class="headerlink" title="2.2 AppOpsService.readPackage  - 读取 package 的 op 信息"></a>2.2 AppOpsService.readPackage  - 读取 package 的 op 信息</h2><p>我们来看下 readPackage 解析的数据：</p>
<figure class="highlight"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">&lt;pkg n=<span class="string">"com.android.settings"</span>&gt; <span class="comment">// readPackage 解析</span></span><br><span class="line">    &lt;uid n=<span class="string">"1000"</span> p=<span class="string">"true"</span>&gt; <span class="comment">// readUid[2] 解析</span></span><br><span class="line">        &lt;op d=<span class="string">"135"</span> n=<span class="string">"3"</span> t=<span class="string">"1514738402132"</span>/&gt;</span><br><span class="line">        &lt;op m=<span class="string">"0"</span> n=<span class="string">"15"</span>/&gt;</span><br><span class="line">        &lt;op n=<span class="string">"59"</span> pp=<span class="string">"com.android.providers.media"</span> pu=<span class="string">"0"</span> t=<span class="string">"1514738336945"</span>/&gt;</span><br><span class="line">        &lt;op n=<span class="string">"60"</span> pu=<span class="string">"0"</span> t=<span class="string">"1514736151388"</span>/&gt;</span><br><span class="line">        &lt;op n=<span class="string">"63"</span> pu=<span class="string">"0"</span> t=<span class="string">"1514749896628"</span>/&gt;</span><br><span class="line">        &lt;op n=<span class="string">"73"</span> pu=<span class="string">"0"</span> t=<span class="string">"1514749896649"</span>/&gt;</span><br><span class="line">    &lt;/uid&gt;</span><br><span class="line">&lt;/pkg&gt;</span><br></pre></td></tr></table></figure>
<p>解释一下：</p>
<ul>
<li>pkg 的 n 属性表示包名；</li>
<li>uid 的 n 表示应用包所属的 uid 值，uid 的 p 表示应用包是否是特权应用；</li>
<li>op 的 n 属性表示 op 的数值，m 表示 op 的 mode 值；</li>
</ul>
<p>首先是解析 pkg 标签！<br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">readPackage</span><span class="params">(XmlPullParser parser)</span> <span class="keyword">throws</span> NumberFormatException,</span></span><br><span class="line"><span class="function">        XmlPullParserException, IOException </span>&#123;</span><br><span class="line">    <span class="comment">//【1】获取包名 package name！</span></span><br><span class="line">    String pkgName = parser.getAttributeValue(<span class="keyword">null</span>, <span class="string">"n"</span>);</span><br><span class="line">    <span class="keyword">int</span> outerDepth = parser.getDepth();</span><br><span class="line">    <span class="keyword">int</span> type;</span><br><span class="line">    <span class="keyword">while</span> ((type = parser.next()) != XmlPullParser.END_DOCUMENT</span><br><span class="line">            &amp;&amp; (type != XmlPullParser.END_TAG || parser.getDepth() &gt; outerDepth)) &#123;</span><br><span class="line">        <span class="keyword">if</span> (type == XmlPullParser.END_TAG || type == XmlPullParser.TEXT) &#123;</span><br><span class="line">            <span class="keyword">continue</span>;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        String tagName = parser.getName();</span><br><span class="line">        <span class="keyword">if</span> (tagName.equals(<span class="string">"uid"</span>)) &#123; </span><br><span class="line">            <span class="comment">//【2.1.1】这里的 uid 标签是 pkg 标签的子标签！</span></span><br><span class="line">            readUid(parser, pkgName);</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            Slog.w(TAG, <span class="string">"Unknown element under &lt;pkg&gt;: "</span></span><br><span class="line">                    + parser.getName());</span><br><span class="line">            XmlUtils.skipCurrentTag(parser);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>继续来看：</p>
<h3 id="2-2-1-AppOpsService-readUid-2"><a href="#2-2-1-AppOpsService-readUid-2" class="headerlink" title="2.2.1 AppOpsService.readUid[2]"></a>2.2.1 AppOpsService.readUid[2]</h3><p>然后是解析子 uid 标签！<br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">readUid</span><span class="params">(XmlPullParser parser, String pkgName)</span> <span class="keyword">throws</span> NumberFormatException,</span></span><br><span class="line"><span class="function">        XmlPullParserException, IOException </span>&#123;</span><br><span class="line">    <span class="comment">//【1】解析 n 属性，uid；</span></span><br><span class="line">    <span class="keyword">int</span> uid = Integer.parseInt(parser.getAttributeValue(<span class="keyword">null</span>, <span class="string">"n"</span>));</span><br><span class="line">    <span class="comment">//【2】解析 p 属性，是否是特权应用；</span></span><br><span class="line">    String isPrivilegedString = parser.getAttributeValue(<span class="keyword">null</span>, <span class="string">"p"</span>);</span><br><span class="line">    <span class="keyword">boolean</span> isPrivileged = <span class="keyword">false</span>;</span><br><span class="line">    <span class="keyword">if</span> (isPrivilegedString == <span class="keyword">null</span>) &#123;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            IPackageManager packageManager = ActivityThread.getPackageManager();</span><br><span class="line">            <span class="keyword">if</span> (packageManager != <span class="keyword">null</span>) &#123;</span><br><span class="line">                <span class="comment">//【3】获得 pkg 对应的 ApplicationInfo 对象！</span></span><br><span class="line">                ApplicationInfo appInfo = ActivityThread.getPackageManager()</span><br><span class="line">                        .getApplicationInfo(pkgName, <span class="number">0</span>, UserHandle.getUserId(uid));</span><br><span class="line">                <span class="keyword">if</span> (appInfo != <span class="keyword">null</span>) &#123;</span><br><span class="line">                    isPrivileged = (appInfo.privateFlags</span><br><span class="line">                            &amp; ApplicationInfo.PRIVATE_FLAG_PRIVILEGED) != <span class="number">0</span>;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                <span class="keyword">return</span>;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125; <span class="keyword">catch</span> (RemoteException e) &#123;</span><br><span class="line">            Slog.w(TAG, <span class="string">"Could not contact PackageManager"</span>, e);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        <span class="comment">//【4】是否是特权应用！</span></span><br><span class="line">        isPrivileged = Boolean.parseBoolean(isPrivilegedString);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">int</span> outerDepth = parser.getDepth();</span><br><span class="line">    <span class="keyword">int</span> type;</span><br><span class="line">    <span class="keyword">while</span> ((type = parser.next()) != XmlPullParser.END_DOCUMENT</span><br><span class="line">            &amp;&amp; (type != XmlPullParser.END_TAG || parser.getDepth() &gt; outerDepth)) &#123;</span><br><span class="line">        <span class="keyword">if</span> (type == XmlPullParser.END_TAG || type == XmlPullParser.TEXT) &#123;</span><br><span class="line">            <span class="keyword">continue</span>;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        String tagName = parser.getName();</span><br><span class="line">        <span class="comment">//【5】解析 op 标签！</span></span><br><span class="line">        <span class="keyword">if</span> (tagName.equals(<span class="string">"op"</span>)) &#123;</span><br><span class="line">            <span class="comment">//【2.2.1.1】创建一个 Op 对象，封装 op 标签的属性！</span></span><br><span class="line">            <span class="comment">// 解析 n 属性，表示 op 的类别，保存到 Op.op！</span></span><br><span class="line">            Op op = <span class="keyword">new</span> Op(uid, pkgName, Integer.parseInt(parser.getAttributeValue(<span class="keyword">null</span>, <span class="string">"n"</span>)));</span><br><span class="line">            String mode = parser.getAttributeValue(<span class="keyword">null</span>, <span class="string">"m"</span>); <span class="comment">// 解析 m 属性，用于获取该 op 的 mode 情况！</span></span><br><span class="line">            <span class="keyword">if</span> (mode != <span class="keyword">null</span>) &#123;</span><br><span class="line">                op.mode = Integer.parseInt(mode);</span><br><span class="line">            &#125;</span><br><span class="line">            String time = parser.getAttributeValue(<span class="keyword">null</span>, <span class="string">"t"</span>); <span class="comment">// 解析 t 属性，用于获取该 op 的授予情况！</span></span><br><span class="line">            <span class="keyword">if</span> (time != <span class="keyword">null</span>) &#123;</span><br><span class="line">                op.time = Long.parseLong(time);</span><br><span class="line">            &#125;</span><br><span class="line">            time = parser.getAttributeValue(<span class="keyword">null</span>, <span class="string">"r"</span>);  <span class="comment">// 解析 r 属性，用于获取该 op 的拒绝时间！</span></span><br><span class="line">            <span class="keyword">if</span> (time != <span class="keyword">null</span>) &#123;</span><br><span class="line">                op.rejectTime = Long.parseLong(time);</span><br><span class="line">            &#125;</span><br><span class="line">            String dur = parser.getAttributeValue(<span class="keyword">null</span>, <span class="string">"d"</span>);  <span class="comment">// 解析 d 属性，用于获取该 op 的时间间隔！</span></span><br><span class="line">            <span class="keyword">if</span> (dur != <span class="keyword">null</span>) &#123;</span><br><span class="line">                op.duration = Integer.parseInt(dur);</span><br><span class="line">            &#125;</span><br><span class="line">            String proxyUid = parser.getAttributeValue(<span class="keyword">null</span>, <span class="string">"pu"</span>);  <span class="comment">// 解析 pu 属性，用于获取该 op 的代理 uid！</span></span><br><span class="line">            <span class="keyword">if</span> (proxyUid != <span class="keyword">null</span>) &#123;</span><br><span class="line">                op.proxyUid = Integer.parseInt(proxyUid);</span><br><span class="line">            &#125;</span><br><span class="line">            String proxyPackageName = parser.getAttributeValue(<span class="keyword">null</span>, <span class="string">"pp"</span>);  <span class="comment">// 解析 pp 属性，用于获取该 op 的代理 pkg！</span></span><br><span class="line">            <span class="keyword">if</span> (proxyPackageName != <span class="keyword">null</span>) &#123;</span><br><span class="line">                op.proxyPackageName = proxyPackageName;</span><br><span class="line">            &#125;</span><br><span class="line">            </span><br><span class="line">            <span class="comment">//【2.1.1】获得 uid 对应的 UidState 状态对象！</span></span><br><span class="line">            UidState uidState = getUidStateLocked(uid, <span class="keyword">true</span>);</span><br><span class="line">            <span class="keyword">if</span> (uidState.pkgOps == <span class="keyword">null</span>) &#123;</span><br><span class="line">                <span class="comment">// 如果 uidState.pkgOps 为 null，初始化！</span></span><br><span class="line">                uidState.pkgOps = <span class="keyword">new</span> ArrayMap&lt;&gt;();</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="comment">//【2.2.1.1】从 uidState.pkgOps 获得该 package 的 Ops 集合</span></span><br><span class="line">            <span class="comment">// 如果为 null，会创建一个新的 Ops！</span></span><br><span class="line">            Ops ops = uidState.pkgOps.get(pkgName);</span><br><span class="line">            <span class="keyword">if</span> (ops == <span class="keyword">null</span>) &#123;</span><br><span class="line">                ops = <span class="keyword">new</span> Ops(pkgName, uidState, isPrivileged);</span><br><span class="line">                <span class="comment">// 将其添加到 uidState.pkgOps 中！</span></span><br><span class="line">                uidState.pkgOps.put(pkgName, ops);</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="comment">// 保存 op 类别和对应的控制情况！</span></span><br><span class="line">            ops.put(op.op, op);</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            Slog.w(TAG, <span class="string">"Unknown element under &lt;pkg&gt;: "</span></span><br><span class="line">                    + parser.getName());</span><br><span class="line">            XmlUtils.skipCurrentTag(parser);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>整个过程很简单，不多说了！</p>
<h4 id="2-2-1-1-new-Op"><a href="#2-2-1-1-new-Op" class="headerlink" title="2.2.1.1 new Op"></a>2.2.1.1 new Op</h4><p>创建一个 Op 对象，封装 package 的每一个 Operation 信息！<br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">final</span> <span class="keyword">static</span> <span class="class"><span class="keyword">class</span> <span class="title">Op</span> </span>&#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">final</span> <span class="keyword">int</span> uid; <span class="comment">// 所属 uid</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">final</span> String packageName; <span class="comment">// 所属 package</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">int</span> proxyUid = -<span class="number">1</span>;</span><br><span class="line">    <span class="keyword">public</span> String proxyPackageName;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">final</span> <span class="keyword">int</span> op; <span class="comment">// 操作码，表示一个访问操作！</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">int</span> mode; <span class="comment">// 操作的控制信息！</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">int</span> duration;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">long</span> time;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">long</span> rejectTime;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">int</span> nesting;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="title">Op</span><span class="params">(<span class="keyword">int</span> _uid, String _packageName, <span class="keyword">int</span> _op)</span> </span>&#123;</span><br><span class="line">        uid = _uid;</span><br><span class="line">        packageName = _packageName;</span><br><span class="line">        op = _op;</span><br><span class="line">        mode = AppOpsManager.opToDefaultMode(op); <span class="comment">// 计算 op 的默认控制状态！</span></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<h1 id="3-AppOpsService-startWatchingMode"><a href="#3-AppOpsService-startWatchingMode" class="headerlink" title="3 AppOpsService.startWatchingMode"></a>3 AppOpsService.startWatchingMode</h1><p>在 AMS 的构造函数中，接着启动了对 AppOpsManager.OP_RUN_IN_BACKGROUND op 操作的监听！<br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">mAppOpsService.startWatchingMode(AppOpsManager.OP_RUN_IN_BACKGROUND, <span class="keyword">null</span>,</span><br><span class="line">        <span class="keyword">new</span> IAppOpsCallback.Stub() &#123;</span><br><span class="line">            <span class="meta">@Override</span> <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">opChanged</span><span class="params">(<span class="keyword">int</span> op, <span class="keyword">int</span> uid, String packageName)</span> </span>&#123;</span><br><span class="line">                <span class="keyword">if</span> (op == AppOpsManager.OP_RUN_IN_BACKGROUND &amp;&amp; packageName != <span class="keyword">null</span>) &#123;</span><br><span class="line">                    <span class="keyword">if</span> (mAppOpsService.checkOperation(op, uid, packageName)</span><br><span class="line">                            != AppOpsManager.MODE_ALLOWED) &#123;</span><br><span class="line">                        runInBackgroundDisabled(uid);</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;);</span><br></pre></td></tr></table></figure></p>
<p>可以看到，这里传入了一个回调：<br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">new</span> IAppOpsCallback.Stub() &#123;</span><br><span class="line">    <span class="meta">@Override</span> <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">opChanged</span><span class="params">(<span class="keyword">int</span> op, <span class="keyword">int</span> uid, String packageName)</span> </span>&#123;</span><br><span class="line">        <span class="comment">//【1】当 op 为 AppOpsManager.OP_RUN_IN_BACKGROUND 时，并且 packageName 不为 null</span></span><br><span class="line">        <span class="comment">// 这时候会检查 packageName 是有允许在后台运行！</span></span><br><span class="line">        <span class="keyword">if</span> (op == AppOpsManager.OP_RUN_IN_BACKGROUND &amp;&amp; packageName != <span class="keyword">null</span>) &#123;</span><br><span class="line">            <span class="comment">//【1.1】检查是否有权限执行 op 操作，关于这部分内容，我们后面再分析！</span></span><br><span class="line">            <span class="keyword">if</span> (mAppOpsService.checkOperation(op, uid, packageName)</span><br><span class="line">                    != AppOpsManager.MODE_ALLOWED) &#123;</span><br><span class="line">                <span class="comment">//【3.2.1】如果不允许，ams 会 stop 掉该进程！</span></span><br><span class="line">                runInBackgroundDisabled(uid);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>这个 Callback 是一个 IAppOpsCallback.Stub 对象，用于跨进程通信，为什么是个桩对象呢？我们后面会知道！</p>
<p>op 参数表示的是要监听的 op 操作；packageName 表示要监听的具体的 package，这里传入的是 null；callback 表示当 op 操作发生改变时，要执行的回调！</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">startWatchingMode</span><span class="params">(<span class="keyword">int</span> op, String packageName, IAppOpsCallback callback)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">if</span> (callback == <span class="keyword">null</span>) &#123;</span><br><span class="line">        <span class="keyword">return</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">synchronized</span> (<span class="keyword">this</span>) &#123;</span><br><span class="line">        op = (op != AppOpsManager.OP_NONE) ? AppOpsManager.opToSwitch(op) : op;</span><br><span class="line">        <span class="comment">//【×3.1】将 callback 转为 Binder 对象，封装为一个 Callback 对象，添加到 mModeWatchers 中！</span></span><br><span class="line">        Callback cb = mModeWatchers.get(callback.asBinder());</span><br><span class="line">        <span class="keyword">if</span> (cb == <span class="keyword">null</span>) &#123;</span><br><span class="line">            <span class="comment">// 创建了一个 Callback 对象，用于监听远程 Binder 对象的死亡布告对象</span></span><br><span class="line">            <span class="comment">// 这样当 IAppOpsCallback.Stub 死亡后，可以停止监听！</span></span><br><span class="line">            cb = <span class="keyword">new</span> Callback(callback);</span><br><span class="line">            <span class="comment">// 将 IAppOpsCallback.Stub 和 Callback 的映射保存到 mModeWatchers 中！</span></span><br><span class="line">            mModeWatchers.put(callback.asBinder(), cb);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment">//【3.2】将要监听的 op 操作和对应的监听回调 Callback 的映射关系保存到 mOpModeWatchers 中！</span></span><br><span class="line">        <span class="keyword">if</span> (op != AppOpsManager.OP_NONE) &#123;</span><br><span class="line">            ArrayList&lt;Callback&gt; cbs = mOpModeWatchers.get(op);</span><br><span class="line">            <span class="keyword">if</span> (cbs == <span class="keyword">null</span>) &#123;</span><br><span class="line">                cbs = <span class="keyword">new</span> ArrayList&lt;Callback&gt;();</span><br><span class="line">                mOpModeWatchers.put(op, cbs);</span><br><span class="line">            &#125;</span><br><span class="line">            cbs.add(cb);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">//【3.3】将要监听的 package 和对应的监听回调 Callback 的映射关系保存到 mPackageModeWatchers 中！</span></span><br><span class="line">        <span class="keyword">if</span> (packageName != <span class="keyword">null</span>) &#123;</span><br><span class="line">            ArrayList&lt;Callback&gt; cbs = mPackageModeWatchers.get(packageName);</span><br><span class="line">            <span class="keyword">if</span> (cbs == <span class="keyword">null</span>) &#123;</span><br><span class="line">                cbs = <span class="keyword">new</span> ArrayList&lt;Callback&gt;();</span><br><span class="line">                mPackageModeWatchers.put(packageName, cbs);</span><br><span class="line">            &#125;</span><br><span class="line">            cbs.add(cb);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>AppOpsService 内部有多个集合：<br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//【1】用与 IBinder 作和对应的回调 Callback 的映射关系！</span></span><br><span class="line"><span class="keyword">final</span> ArrayMap&lt;IBinder, Callback&gt; mModeWatchers</span><br><span class="line">        = <span class="keyword">new</span> ArrayMap&lt;IBinder, Callback&gt;();</span><br></pre></td></tr></table></figure></p>
<p>用于保存远程回调 IAppOpsCallback.Stub 和其对应的死亡仆告对象 Callback 的映射关系，当 IAppOpsCallback.Stub 死亡后，Callback.binderDied 会被触发，然</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//【1】用与保存 op 操作和对应的回调 Callback 的映射关系！</span></span><br><span class="line"><span class="keyword">final</span> SparseArray&lt;ArrayList&lt;Callback&gt;&gt; mOpModeWatchers</span><br><span class="line">        = <span class="keyword">new</span> SparseArray&lt;ArrayList&lt;Callback&gt;&gt;();</span><br><span class="line"><span class="comment">//【2】用与保存 package 和对应的回调 Callback 的映射关系！</span></span><br><span class="line"><span class="keyword">final</span> ArrayMap&lt;String, ArrayList&lt;Callback&gt;&gt; mPackageModeWatchers</span><br><span class="line">        = <span class="keyword">new</span> ArrayMap&lt;String, ArrayList&lt;Callback&gt;&gt;();</span><br></pre></td></tr></table></figure>
<p>而 mOpModeWatchers 和 mPackageModeWatchers 则是从不同的角度来建立监听关系：mOpModeWatchers 是从具体 op 的角度，而 mPackageModeWatchers 则是从 package 的角度！</p>
<p>可以看到 Callback 实例的作用是，作为远程回调的死亡仆告对象，用于停止监听！！</p>
<h2 id="3-1-new-Callback-死亡回调"><a href="#3-1-new-Callback-死亡回调" class="headerlink" title="3.1 new Callback - 死亡回调"></a>3.1 new Callback - 死亡回调</h2><p>我们来看下 Callback 对象的创建，同时 Callback 又是一个 DeathRecipient 对象，用来监听远程 IAppOpsCallback 桩对象是否死亡！<br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">final</span> <span class="class"><span class="keyword">class</span> <span class="title">Callback</span> <span class="keyword">implements</span> <span class="title">DeathRecipient</span> </span>&#123;</span><br><span class="line">    <span class="keyword">final</span> IAppOpsCallback mCallback;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="title">Callback</span><span class="params">(IAppOpsCallback callback)</span> </span>&#123;</span><br><span class="line">        mCallback = callback;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            <span class="comment">//【1】将自身注册为一个死亡仆告对象！</span></span><br><span class="line">            mCallback.asBinder().linkToDeath(<span class="keyword">this</span>, <span class="number">0</span>);</span><br><span class="line">        &#125; <span class="keyword">catch</span> (RemoteException e) &#123;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">unlinkToDeath</span><span class="params">()</span> </span>&#123; <span class="comment">//【2】解除注册！</span></span><br><span class="line">        mCallback.asBinder().unlinkToDeath(<span class="keyword">this</span>, <span class="number">0</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">binderDied</span><span class="params">()</span> </span>&#123; <span class="comment">//【3.1.1】当远程桩对象死亡后，停止监听！</span></span><br><span class="line">        stopWatchingMode(mCallback);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>当远程的 IAppOpsCallback.Stub 死亡后，AppOpsService.stopWatchingMode 会被执行！</p>
<h3 id="3-1-1-AppOpsService-stopWatchingMode"><a href="#3-1-1-AppOpsService-stopWatchingMode" class="headerlink" title="3.1.1 AppOpsService.stopWatchingMode"></a>3.1.1 AppOpsService.stopWatchingMode</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">stopWatchingMode</span><span class="params">(IAppOpsCallback callback)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">if</span> (callback == <span class="keyword">null</span>) &#123;</span><br><span class="line">        <span class="keyword">return</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">synchronized</span> (<span class="keyword">this</span>) &#123;</span><br><span class="line">        <span class="comment">//【1】从 mModeWatchers 中移除 Callback！</span></span><br><span class="line">        Callback cb = mModeWatchers.remove(callback.asBinder());</span><br><span class="line">        <span class="keyword">if</span> (cb != <span class="keyword">null</span>) &#123;</span><br><span class="line">            <span class="comment">// 解除死亡仆告对象注册！</span></span><br><span class="line">            cb.unlinkToDeath();</span><br><span class="line">            <span class="comment">//【2】从 mOpModeWatchers 移除该 Callback！</span></span><br><span class="line">            <span class="keyword">for</span> (<span class="keyword">int</span> i=mOpModeWatchers.size()-<span class="number">1</span>; i&gt;=<span class="number">0</span>; i--) &#123;</span><br><span class="line">                ArrayList&lt;Callback&gt; cbs = mOpModeWatchers.valueAt(i);</span><br><span class="line">                cbs.remove(cb);</span><br><span class="line">                <span class="keyword">if</span> (cbs.size() &lt;= <span class="number">0</span>) &#123;</span><br><span class="line">                    mOpModeWatchers.removeAt(i);</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="comment">//【3】从 mPackageModeWatchers 移除该 Callback！</span></span><br><span class="line">            <span class="keyword">for</span> (<span class="keyword">int</span> i=mPackageModeWatchers.size()-<span class="number">1</span>; i&gt;=<span class="number">0</span>; i--) &#123;</span><br><span class="line">                ArrayList&lt;Callback&gt; cbs = mPackageModeWatchers.valueAt(i);</span><br><span class="line">                cbs.remove(cb);</span><br><span class="line">                <span class="keyword">if</span> (cbs.size() &lt;= <span class="number">0</span>) &#123;</span><br><span class="line">                    mPackageModeWatchers.removeAt(i);</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>流程很简单，不多说了！</p>
<h2 id="3-2-AMS-对-OP-RUN-IN-BACKGROUND-的处理"><a href="#3-2-AMS-对-OP-RUN-IN-BACKGROUND-的处理" class="headerlink" title="3.2 AMS 对 OP_RUN_IN_BACKGROUND 的处理"></a>3.2 AMS 对 OP_RUN_IN_BACKGROUND 的处理</h2><p>再次回到 AMS 的构造器中去看看：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//【1】当 op 为 AppOpsManager.OP_RUN_IN_BACKGROUND 时，并且 packageName 不为 null</span></span><br><span class="line"><span class="comment">// 这时候会检查 packageName 是有允许在后台运行！</span></span><br><span class="line"><span class="keyword">if</span> (op == AppOpsManager.OP_RUN_IN_BACKGROUND &amp;&amp; packageName != <span class="keyword">null</span>) &#123;</span><br><span class="line">    <span class="comment">//【1.1】检查是否有权限执行 op 操作，关于这部分内容，我们后面再分析！</span></span><br><span class="line">    <span class="keyword">if</span> (mAppOpsService.checkOperation(op, uid, packageName)</span><br><span class="line">            != AppOpsManager.MODE_ALLOWED) &#123;</span><br><span class="line">        <span class="comment">//【3.2.1】如果不允许，ams 会 stop 掉该进程！</span></span><br><span class="line">        runInBackgroundDisabled(uid);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>AMS 中并没有监听某个具体的 package 的 op 变化，所以 packageName 传入的是 null；AMS 关心的是 AppOpsManager.OP_RUN_IN_BACKGROUND 操作的变化！</p>
<p>当有 op 发生变化后，opChanged 方法会被调用，这时 AMS 会判断如果 op 为 AppOpsManager.OP_RUN_IN_BACKGROUND，同时 packageName 不为 null；</p>
<p>这时，AMS 会调用 mAppOpsService.checkOperation 判断该应用是否允许后台运行，如果不允许，那么，会调用 runInBackgroundDisabled 方法 stop 掉进程！</p>
<h3 id="3-2-1-runInBackgroundDisabled"><a href="#3-2-1-runInBackgroundDisabled" class="headerlink" title="3.2.1 runInBackgroundDisabled"></a>3.2.1 runInBackgroundDisabled</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">final</span> <span class="keyword">void</span> <span class="title">runInBackgroundDisabled</span><span class="params">(<span class="keyword">int</span> uid)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">synchronized</span> (<span class="keyword">this</span>) &#123;</span><br><span class="line">        UidRecord uidRec = mActiveUids.get(uid);</span><br><span class="line">        <span class="comment">//【1】如果该 uid 仍然在运行，那么只有其处于 idle 状态才能 stop 进程！</span></span><br><span class="line">        <span class="keyword">if</span> (uidRec != <span class="keyword">null</span>) &#123;</span><br><span class="line">            <span class="keyword">if</span> (uidRec.idle) &#123;</span><br><span class="line">                <span class="comment">//【3.2.2】stop 进程！</span></span><br><span class="line">                doStopUidLocked(uidRec.uid, uidRec);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            <span class="comment">//【2】如果 uid 不再运行，那就 stop 进程！</span></span><br><span class="line">            doStopUidLocked(uid, <span class="keyword">null</span>);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h3 id="3-2-2-doStopUidLocked"><a href="#3-2-2-doStopUidLocked" class="headerlink" title="3.2.2 doStopUidLocked"></a>3.2.2 doStopUidLocked</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">final</span> <span class="keyword">void</span> <span class="title">doStopUidLocked</span><span class="params">(<span class="keyword">int</span> uid, <span class="keyword">final</span> UidRecord uidRec)</span> </span>&#123;</span><br><span class="line">    mServices.stopInBackgroundLocked(uid); <span class="comment">// stop 掉该进程！</span></span><br><span class="line">    enqueueUidChangeLocked(uidRec, uid, UidRecord.CHANGE_IDLE);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>这里就不多说了！</p>
<h1 id="4-AppOpsService-publish-publish-到-ServiceManager-中！"><a href="#4-AppOpsService-publish-publish-到-ServiceManager-中！" class="headerlink" title="4 AppOpsService.publish - publish 到 ServiceManager 中！"></a>4 AppOpsService.publish - publish 到 ServiceManager 中！</h1><p>我们回到 ActivityManagerService 的 start 方法中去看看：<br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">start</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    Process.removeAllProcessGroups();</span><br><span class="line">    mProcessCpuThread.start();</span><br><span class="line"></span><br><span class="line">    mBatteryStatsService.publish(mContext);</span><br><span class="line">    <span class="comment">//【1】调用了 AppOpsService 方法！</span></span><br><span class="line">    mAppOpsService.publish(mContext);</span><br><span class="line">    Slog.d(<span class="string">"AppOps"</span>, <span class="string">"AppOpsService published"</span>);</span><br><span class="line">    LocalServices.addService(ActivityManagerInternal<span class="class">.<span class="keyword">class</span>, <span class="title">new</span> <span class="title">LocalService</span>())</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>我们来看看 AppOpsService.publish！<br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">publish</span><span class="params">(Context context)</span> </span>&#123;</span><br><span class="line">    mContext = context;</span><br><span class="line">    ServiceManager.addService(Context.APP_OPS_SERVICE, asBinder());</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>将自身注册进入 ServiceManager 中！</p>
<h1 id="5-AppOpsService-systemReady"><a href="#5-AppOpsService-systemReady" class="headerlink" title="5 AppOpsService.systemReady"></a>5 AppOpsService.systemReady</h1><p>我们回到 ActivityManagerService 的 systemReady 方法中去看看：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">systemReady</span><span class="params">(<span class="keyword">final</span> Runnable goingCallback)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">synchronized</span>(<span class="keyword">this</span>) &#123;</span><br><span class="line">        <span class="keyword">if</span> (mSystemReady) &#123;</span><br><span class="line">            <span class="comment">// If we're done calling all the receivers, run the next "boot phase" passed in</span></span><br><span class="line">            <span class="comment">// by the SystemServer</span></span><br><span class="line">            <span class="keyword">if</span> (goingCallback != <span class="keyword">null</span>) &#123;</span><br><span class="line">                goingCallback.run();</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">return</span>;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        mLocalDeviceIdleController</span><br><span class="line">                = LocalServices.getService(DeviceIdleController.LocalService<span class="class">.<span class="keyword">class</span>)</span>;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// Make sure we have the current profile info, since it is needed for security checks.</span></span><br><span class="line">        mUserController.onSystemReady();</span><br><span class="line">        mRecentTasks.onSystemReadyLocked();</span><br><span class="line">        <span class="comment">//【1】调用了 mAppOpsService 的 systemReady 方法！</span></span><br><span class="line">        mAppOpsService.systemReady();</span><br><span class="line">        mSystemReady = <span class="keyword">true</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    ... ... ... ...</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>去看看 mAppOpsService 的 systemReady 方法：<br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">systemReady</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    <span class="keyword">synchronized</span> (<span class="keyword">this</span>) &#123;</span><br><span class="line">        <span class="keyword">boolean</span> changed = <span class="keyword">false</span>;</span><br><span class="line">        <span class="keyword">for</span> (<span class="keyword">int</span> i = mUidStates.size() - <span class="number">1</span>; i &gt;= <span class="number">0</span>; i--) &#123;</span><br><span class="line">            UidState uidState = mUidStates.valueAt(i);</span><br><span class="line">            <span class="comment">//【×5.1】获取属于该 uid 的所有 PacakgeName！</span></span><br><span class="line">            String[] packageNames = getPackagesForUid(uidState.uid);</span><br><span class="line">            <span class="keyword">if</span> (ArrayUtils.isEmpty(packageNames)) &#123;</span><br><span class="line">                <span class="comment">//【1】如果属于该 uid 的 package 为 null，从 mUidStates 中移除！</span></span><br><span class="line">                uidState.clear();</span><br><span class="line">                mUidStates.removeAt(i);</span><br><span class="line">                changed = <span class="keyword">true</span>;</span><br><span class="line">                <span class="keyword">continue</span>;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="comment">// 如果 uidState.pkgOps 为 null，跳过！</span></span><br><span class="line">            ArrayMap&lt;String, Ops&gt; pkgs = uidState.pkgOps;</span><br><span class="line">            <span class="keyword">if</span> (pkgs == <span class="keyword">null</span>) &#123;</span><br><span class="line">                <span class="keyword">continue</span>;</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            <span class="comment">//【2】我们知道 uidState.pkgOps 保存了该 uid 下所有的 package 的 op 信息！</span></span><br><span class="line">            Iterator&lt;Ops&gt; it = pkgs.values().iterator();</span><br><span class="line">            <span class="keyword">while</span> (it.hasNext()) &#123; <span class="comment">// 遍历每一个 package 的 Op 信息！</span></span><br><span class="line">                Ops ops = it.next();</span><br><span class="line">                <span class="keyword">int</span> curUid = -<span class="number">1</span>;</span><br><span class="line">                <span class="keyword">try</span> &#123;</span><br><span class="line">                    <span class="comment">//【2.1】首先，通过包名获得 package 的 uid！</span></span><br><span class="line">                    curUid = AppGlobals.getPackageManager().getPackageUid(ops.packageName,</span><br><span class="line">                            PackageManager.MATCH_UNINSTALLED_PACKAGES,</span><br><span class="line">                            UserHandle.getUserId(ops.uidState.uid));</span><br><span class="line">                &#125; <span class="keyword">catch</span> (RemoteException ignored) &#123;</span><br><span class="line">                &#125;</span><br><span class="line">                <span class="comment">//【2.2】然后和 op 所属的 uid 进行比较，如果不相等，说明 package 信息发生了变化！</span></span><br><span class="line">                <span class="comment">// 移除旧的 Ops 集合！</span></span><br><span class="line">                <span class="keyword">if</span> (curUid != ops.uidState.uid) &#123;</span><br><span class="line">                    Slog.i(TAG, <span class="string">"Pruning old package "</span> + ops.packageName</span><br><span class="line">                            + <span class="string">"/"</span> + ops.uidState + <span class="string">": new uid="</span> + curUid);</span><br><span class="line">                    it.remove();</span><br><span class="line">                    changed = <span class="keyword">true</span>;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            <span class="keyword">if</span> (uidState.isDefault()) &#123; </span><br><span class="line">                <span class="comment">//【3】移除那些没有对应 Package 和 Ops 的 UidState！</span></span><br><span class="line">                mUidStates.removeAt(i);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">if</span> (changed) &#123; </span><br><span class="line">            <span class="comment">//【5.2】如果 changed 为 true，表示 UidState，或者 Ops 发生了变化，更新本地持久化文件！</span></span><br><span class="line">            scheduleFastWriteLocked();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    MountServiceInternal mountServiceInternal = LocalServices.getService(</span><br><span class="line">            MountServiceInternal<span class="class">.<span class="keyword">class</span>)</span>;</span><br><span class="line">    mountServiceInternal.addExternalStoragePolicy(</span><br><span class="line">            <span class="keyword">new</span> MountServiceInternal.ExternalStorageMountPolicy() &#123;</span><br><span class="line">                <span class="meta">@Override</span></span><br><span class="line">                <span class="function"><span class="keyword">public</span> <span class="keyword">int</span> <span class="title">getMountMode</span><span class="params">(<span class="keyword">int</span> uid, String packageName)</span> </span>&#123;</span><br><span class="line">                    <span class="keyword">if</span> (Process.isIsolated(uid)) &#123;</span><br><span class="line">                        <span class="keyword">return</span> Zygote.MOUNT_EXTERNAL_NONE;</span><br><span class="line">                    &#125;</span><br><span class="line">                    <span class="keyword">if</span> (noteOperation(AppOpsManager.OP_READ_EXTERNAL_STORAGE, uid,</span><br><span class="line">                            packageName) != AppOpsManager.MODE_ALLOWED) &#123;</span><br><span class="line">                        <span class="keyword">return</span> Zygote.MOUNT_EXTERNAL_NONE;</span><br><span class="line">                    &#125;</span><br><span class="line">                    <span class="keyword">if</span> (noteOperation(AppOpsManager.OP_WRITE_EXTERNAL_STORAGE, uid,</span><br><span class="line">                            packageName) != AppOpsManager.MODE_ALLOWED) &#123;</span><br><span class="line">                        <span class="keyword">return</span> Zygote.MOUNT_EXTERNAL_READ;</span><br><span class="line">                    &#125;</span><br><span class="line">                    <span class="keyword">return</span> Zygote.MOUNT_EXTERNAL_WRITE;</span><br><span class="line">                &#125;</span><br><span class="line"></span><br><span class="line">                <span class="meta">@Override</span></span><br><span class="line">                <span class="function"><span class="keyword">public</span> <span class="keyword">boolean</span> <span class="title">hasExternalStorage</span><span class="params">(<span class="keyword">int</span> uid, String packageName)</span> </span>&#123;</span><br><span class="line">                    <span class="keyword">final</span> <span class="keyword">int</span> mountMode = getMountMode(uid, packageName);</span><br><span class="line">                    <span class="keyword">return</span> mountMode == Zygote.MOUNT_EXTERNAL_READ</span><br><span class="line">                            || mountMode == Zygote.MOUNT_EXTERNAL_WRITE;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<h2 id="5-1-getPackagesForUid"><a href="#5-1-getPackagesForUid" class="headerlink" title="5.1 getPackagesForUid"></a>5.1 getPackagesForUid</h2><p>获取 uid 所有的 package：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">private</span> <span class="keyword">static</span> String[] getPackagesForUid(<span class="keyword">int</span> uid) &#123;</span><br><span class="line">    String[] packageNames = <span class="keyword">null</span>;</span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">        packageNames = AppGlobals.getPackageManager().getPackagesForUid(uid);</span><br><span class="line">    &#125; <span class="keyword">catch</span> (RemoteException e) &#123;</span><br><span class="line">        <span class="comment">/* ignore - local call */</span></span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span> (packageNames == <span class="keyword">null</span>) &#123;</span><br><span class="line">        <span class="keyword">return</span> EmptyArray.STRING;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> packageNames;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>以数组形式放回！</p>
<h2 id="5-2-scheduleFastWriteLocked"><a href="#5-2-scheduleFastWriteLocked" class="headerlink" title="5.2 scheduleFastWriteLocked"></a>5.2 scheduleFastWriteLocked</h2><p>更新本地的持久化文件！<br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">scheduleFastWriteLocked</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    <span class="keyword">if</span> (!mFastWriteScheduled) &#123;</span><br><span class="line">        mWriteScheduled = <span class="keyword">true</span>;</span><br><span class="line">        mFastWriteScheduled = <span class="keyword">true</span>;</span><br><span class="line">        mHandler.removeCallbacks(mWriteRunner);</span><br><span class="line">        mHandler.postDelayed(mWriteRunner, <span class="number">10</span>*<span class="number">1000</span>); <span class="comment">// </span></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>这里的 mHandler 是由 AMS 创建的一个子线程的 Handler！</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">final</span> Runnable mWriteRunner = <span class="keyword">new</span> Runnable() &#123;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">run</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">synchronized</span> (AppOpsService.<span class="keyword">this</span>) &#123;</span><br><span class="line">            mWriteScheduled = <span class="keyword">false</span>;</span><br><span class="line">            mFastWriteScheduled = <span class="keyword">false</span>;</span><br><span class="line">            <span class="comment">//【1】创建一个 AsyncTask 异步任务对象！</span></span><br><span class="line">            AsyncTask&lt;Void, Void, Void&gt; task = <span class="keyword">new</span> AsyncTask&lt;Void, Void, Void&gt;() &#123;</span><br><span class="line">                <span class="meta">@Override</span> <span class="function"><span class="keyword">protected</span> Void <span class="title">doInBackground</span><span class="params">(Void... params)</span> </span>&#123;</span><br><span class="line">                    <span class="comment">//【5.3】writeState 更新持久化文件！</span></span><br><span class="line">                    writeState();</span><br><span class="line">                    <span class="keyword">return</span> <span class="keyword">null</span>;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;;</span><br><span class="line">            <span class="comment">//【2】执行任务！</span></span><br><span class="line">            task.executeOnExecutor(AsyncTask.THREAD_POOL_EXECUTOR, (Void[])<span class="keyword">null</span>);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>
<p>继续来看！！</p>
<h2 id="5-3-writeState"><a href="#5-3-writeState" class="headerlink" title="5.3 writeState"></a>5.3 writeState</h2><p>我们来看下，如何更新持久化文件！<br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">writeState</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    <span class="keyword">synchronized</span> (mFile) &#123;</span><br><span class="line">        <span class="comment">//【5.2.1】获得所有 package 的 Op 信息！</span></span><br><span class="line">        List&lt;AppOpsManager.PackageOps&gt; allOps = getPackagesForOps(<span class="keyword">null</span>);</span><br><span class="line"></span><br><span class="line">        FileOutputStream stream;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            stream = mFile.startWrite();</span><br><span class="line">        &#125; <span class="keyword">catch</span> (IOException e) &#123;</span><br><span class="line">            Slog.w(TAG, <span class="string">"Failed to write state: "</span> + e);</span><br><span class="line">            <span class="keyword">return</span>;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            XmlSerializer out = <span class="keyword">new</span> FastXmlSerializer();</span><br><span class="line">            out.setOutput(stream, StandardCharsets.UTF_8.name());</span><br><span class="line">            out.startDocument(<span class="keyword">null</span>, <span class="keyword">true</span>);</span><br><span class="line">            out.startTag(<span class="keyword">null</span>, <span class="string">"app-ops"</span>); <span class="comment">//【1】写入 app-ops 标签！</span></span><br><span class="line"></span><br><span class="line">            <span class="keyword">final</span> <span class="keyword">int</span> uidStateCount = mUidStates.size();</span><br><span class="line">            <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; uidStateCount; i++) &#123; <span class="comment">//【2】首先写入 uid 标签！</span></span><br><span class="line">                UidState uidState = mUidStates.valueAt(i);</span><br><span class="line">                <span class="keyword">if</span> (uidState.opModes != <span class="keyword">null</span> &amp;&amp; uidState.opModes.size() &gt; <span class="number">0</span>) &#123;</span><br><span class="line">                    out.startTag(<span class="keyword">null</span>, <span class="string">"uid"</span>);</span><br><span class="line">                    out.attribute(<span class="keyword">null</span>, <span class="string">"n"</span>, Integer.toString(uidState.uid)); <span class="comment">//【2.1】写入 n 属性！</span></span><br><span class="line">                    SparseIntArray uidOpModes = uidState.opModes;</span><br><span class="line">                    <span class="keyword">final</span> <span class="keyword">int</span> opCount = uidOpModes.size();</span><br><span class="line">                    <span class="keyword">for</span> (<span class="keyword">int</span> j = <span class="number">0</span>; j &lt; opCount; j++) &#123;</span><br><span class="line">                        <span class="keyword">final</span> <span class="keyword">int</span> op = uidOpModes.keyAt(j);</span><br><span class="line">                        <span class="keyword">final</span> <span class="keyword">int</span> mode = uidOpModes.valueAt(j);</span><br><span class="line">                        out.startTag(<span class="keyword">null</span>, <span class="string">"op"</span>); <span class="comment">//【2.2】写入 op 子标签，和对应的 n，m 属性！</span></span><br><span class="line">                        out.attribute(<span class="keyword">null</span>, <span class="string">"n"</span>, Integer.toString(op));</span><br><span class="line">                        out.attribute(<span class="keyword">null</span>, <span class="string">"m"</span>, Integer.toString(mode));</span><br><span class="line">                        out.endTag(<span class="keyword">null</span>, <span class="string">"op"</span>);</span><br><span class="line">                    &#125;</span><br><span class="line">                    out.endTag(<span class="keyword">null</span>, <span class="string">"uid"</span>);</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            <span class="keyword">if</span> (allOps != <span class="keyword">null</span>) &#123; <span class="comment">// 如果 allOps 不为 null，那就开始写入 pkg 标签！</span></span><br><span class="line">                String lastPkg = <span class="keyword">null</span>;</span><br><span class="line">                <span class="keyword">for</span> (<span class="keyword">int</span> i=<span class="number">0</span>; i&lt;allOps.size(); i++) &#123;</span><br><span class="line">                    AppOpsManager.PackageOps pkg = allOps.get(i);</span><br><span class="line">                    <span class="keyword">if</span> (!pkg.getPackageName().equals(lastPkg)) &#123;</span><br><span class="line">                        <span class="keyword">if</span> (lastPkg != <span class="keyword">null</span>) &#123;</span><br><span class="line">                            out.endTag(<span class="keyword">null</span>, <span class="string">"pkg"</span>);</span><br><span class="line">                        &#125;</span><br><span class="line">                        lastPkg = pkg.getPackageName();</span><br><span class="line">                        out.startTag(<span class="keyword">null</span>, <span class="string">"pkg"</span>); <span class="comment">// 写入 pkg 标签</span></span><br><span class="line">                        out.attribute(<span class="keyword">null</span>, <span class="string">"n"</span>, lastPkg); <span class="comment">// 写入 n 属性，包名</span></span><br><span class="line">                    &#125;</span><br><span class="line">                    out.startTag(<span class="keyword">null</span>, <span class="string">"uid"</span>); <span class="comment">// 写入 uid 子标签</span></span><br><span class="line">                    out.attribute(<span class="keyword">null</span>, <span class="string">"n"</span>, Integer.toString(pkg.getUid())); <span class="comment">// 写入 n 属性，uid 的值</span></span><br><span class="line">                    <span class="keyword">synchronized</span> (<span class="keyword">this</span>) &#123;</span><br><span class="line">                        Ops ops = getOpsRawLocked(pkg.getUid(), pkg.getPackageName(), <span class="keyword">false</span>);</span><br><span class="line">                        <span class="comment">// 写入 p 属性，表示是否是 Privileged！</span></span><br><span class="line">                        <span class="keyword">if</span> (ops != <span class="keyword">null</span>) &#123;</span><br><span class="line">                            out.attribute(<span class="keyword">null</span>, <span class="string">"p"</span>, Boolean.toString(ops.isPrivileged));</span><br><span class="line">                        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                            out.attribute(<span class="keyword">null</span>, <span class="string">"p"</span>, Boolean.toString(<span class="keyword">false</span>));</span><br><span class="line">                        &#125;</span><br><span class="line">                    &#125;</span><br><span class="line">                    List&lt;AppOpsManager.OpEntry&gt; ops = pkg.getOps(); <span class="comment">// 处理该 package 的 Ops！</span></span><br><span class="line">                    <span class="keyword">for</span> (<span class="keyword">int</span> j=<span class="number">0</span>; j&lt;ops.size(); j++) &#123;</span><br><span class="line">                        AppOpsManager.OpEntry op = ops.get(j);</span><br><span class="line">                        out.startTag(<span class="keyword">null</span>, <span class="string">"op"</span>); <span class="comment">// 写入 op 标签；</span></span><br><span class="line">                        out.attribute(<span class="keyword">null</span>, <span class="string">"n"</span>, Integer.toString(op.getOp())); <span class="comment">// 写入 n 属性，op 码；</span></span><br><span class="line">                        <span class="comment">// 写入 m 属性，表示控制状态，这里先调用了 AppOpsManager.opToDefaultMode 来计算下</span></span><br><span class="line">                        <span class="comment">// 默认的控制状态。如果 op 的控制状态不等于默认值才会写入！</span></span><br><span class="line">                        <span class="keyword">if</span> (op.getMode() != AppOpsManager.opToDefaultMode(op.getOp())) &#123;</span><br><span class="line">                            out.attribute(<span class="keyword">null</span>, <span class="string">"m"</span>, Integer.toString(op.getMode()));</span><br><span class="line">                        &#125;</span><br><span class="line">                        <span class="comment">// 写入 t 属性！</span></span><br><span class="line">                        <span class="keyword">long</span> time = op.getTime();</span><br><span class="line">                        <span class="keyword">if</span> (time != <span class="number">0</span>) &#123;</span><br><span class="line">                            out.attribute(<span class="keyword">null</span>, <span class="string">"t"</span>, Long.toString(time));</span><br><span class="line">                        &#125;</span><br><span class="line">                        <span class="comment">// 写入 r 属性！                            </span></span><br><span class="line">                        time = op.getRejectTime();</span><br><span class="line">                        <span class="keyword">if</span> (time != <span class="number">0</span>) &#123;</span><br><span class="line">                            out.attribute(<span class="keyword">null</span>, <span class="string">"r"</span>, Long.toString(time));</span><br><span class="line">                        &#125;</span><br><span class="line">                        <span class="comment">// 写入 d 属性！                               </span></span><br><span class="line">                        <span class="keyword">int</span> dur = op.getDuration();</span><br><span class="line">                        <span class="keyword">if</span> (dur != <span class="number">0</span>) &#123;</span><br><span class="line">                            out.attribute(<span class="keyword">null</span>, <span class="string">"d"</span>, Integer.toString(dur));</span><br><span class="line">                        &#125;</span><br><span class="line">                        <span class="comment">// 写入 pu 属性！                               </span></span><br><span class="line">                        <span class="keyword">int</span> proxyUid = op.getProxyUid();</span><br><span class="line">                        <span class="keyword">if</span> (proxyUid != -<span class="number">1</span>) &#123;</span><br><span class="line">                            out.attribute(<span class="keyword">null</span>, <span class="string">"pu"</span>, Integer.toString(proxyUid));</span><br><span class="line">                        &#125;</span><br><span class="line">                        <span class="comment">// 写入 pp 属性！   </span></span><br><span class="line">                        String proxyPackageName = op.getProxyPackageName();</span><br><span class="line">                        <span class="keyword">if</span> (proxyPackageName != <span class="keyword">null</span>) &#123;</span><br><span class="line">                            out.attribute(<span class="keyword">null</span>, <span class="string">"pp"</span>, proxyPackageName);</span><br><span class="line">                        &#125;</span><br><span class="line">                        out.endTag(<span class="keyword">null</span>, <span class="string">"op"</span>); </span><br><span class="line">                    &#125;</span><br><span class="line">                    out.endTag(<span class="keyword">null</span>, <span class="string">"uid"</span>);</span><br><span class="line">                &#125;</span><br><span class="line">                <span class="keyword">if</span> (lastPkg != <span class="keyword">null</span>) &#123;</span><br><span class="line">                    out.endTag(<span class="keyword">null</span>, <span class="string">"pkg"</span>);</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            out.endTag(<span class="keyword">null</span>, <span class="string">"app-ops"</span>);</span><br><span class="line">            out.endDocument();</span><br><span class="line">            mFile.finishWrite(stream);</span><br><span class="line">        &#125; <span class="keyword">catch</span> (IOException e) &#123;</span><br><span class="line">            Slog.w(TAG, <span class="string">"Failed to write state, restoring backup."</span>, e);</span><br><span class="line">            mFile.failWrite(stream);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>writeState 的流程还是很简单的！</p>
<h3 id="5-3-1-getPackagesForOps"><a href="#5-3-1-getPackagesForOps" class="headerlink" title="5.3.1 getPackagesForOps"></a>5.3.1 getPackagesForOps</h3><p>该方法用于获得所有 package 的 Op 信息，参数 ops 表示只收集其指定的 op 信息！</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="keyword">public</span> List&lt;AppOpsManager.PackageOps&gt; getPackagesForOps(<span class="keyword">int</span>[] ops) &#123;</span><br><span class="line">    <span class="comment">//【1】首先，强制检查调用者是否有 GET_APP_OPS_STATS 权限！</span></span><br><span class="line">    mContext.enforcePermission(android.Manifest.permission.GET_APP_OPS_STATS,</span><br><span class="line">            Binder.getCallingPid(), Binder.getCallingUid(), <span class="keyword">null</span>);</span><br><span class="line">    ArrayList&lt;AppOpsManager.PackageOps&gt; res = <span class="keyword">null</span>;</span><br><span class="line">    <span class="keyword">synchronized</span> (<span class="keyword">this</span>) &#123;</span><br><span class="line">        <span class="keyword">final</span> <span class="keyword">int</span> uidStateCount = mUidStates.size();</span><br><span class="line">        <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; uidStateCount; i++) &#123;</span><br><span class="line">            UidState uidState = mUidStates.valueAt(i);</span><br><span class="line">            <span class="keyword">if</span> (uidState.pkgOps == <span class="keyword">null</span> || uidState.pkgOps.isEmpty()) &#123;</span><br><span class="line">                <span class="keyword">continue</span>;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="comment">//【1.1】首先，获得 uidState.pkgOps 中保存的该 uid 下，所有的 package 的 Ops！</span></span><br><span class="line">            ArrayMap&lt;String, Ops&gt; packages = uidState.pkgOps;</span><br><span class="line">            <span class="keyword">final</span> <span class="keyword">int</span> packageCount = packages.size();</span><br><span class="line">            <span class="keyword">for</span> (<span class="keyword">int</span> j = <span class="number">0</span>; j &lt; packageCount; j++) &#123;</span><br><span class="line">                <span class="comment">//【1.2】处理每一个 package 的 Ops！</span></span><br><span class="line">                Ops pkgOps = packages.valueAt(j); </span><br><span class="line">                <span class="comment">//【5.3.1.1】调用 collectOps 方法,收集 package 的 Op 信息，封装为 OpEntry 对象！！</span></span><br><span class="line">                ArrayList&lt;AppOpsManager.OpEntry&gt; resOps = collectOps(pkgOps, ops);</span><br><span class="line">                <span class="keyword">if</span> (resOps != <span class="keyword">null</span>) &#123;</span><br><span class="line">                    <span class="keyword">if</span> (res == <span class="keyword">null</span>) &#123;</span><br><span class="line">                        res = <span class="keyword">new</span> ArrayList&lt;AppOpsManager.PackageOps&gt;();</span><br><span class="line">                    &#125;</span><br><span class="line">                    <span class="comment">//【5.3.1.2】创建一个 PackageOps 对象，封装该 package 的所有 Op 信息</span></span><br><span class="line">                    <span class="comment">// 最后添加到 res 列表中！</span></span><br><span class="line">                    AppOpsManager.PackageOps resPackage = <span class="keyword">new</span> AppOpsManager.PackageOps(</span><br><span class="line">                            pkgOps.packageName, pkgOps.uidState.uid, resOps);</span><br><span class="line">                    res.add(resPackage);</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// 返回列表！</span></span><br><span class="line">    <span class="keyword">return</span> res;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h4 id="5-3-1-1-collectOps"><a href="#5-3-1-1-collectOps" class="headerlink" title="5.3.1.1 collectOps"></a>5.3.1.1 collectOps</h4><p>参数 int[] ops 用于指定特定的 Op，这样我们会只收集这些特定的 Ops，当然这里我们要收集所有 package 的 Op 信息，所以 int[] ops 传入 null；</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">private</span> ArrayList&lt;AppOpsManager.OpEntry&gt; collectOps(Ops pkgOps, <span class="keyword">int</span>[] ops) &#123;</span><br><span class="line">    ArrayList&lt;AppOpsManager.OpEntry&gt; resOps = <span class="keyword">null</span>;</span><br><span class="line">    <span class="keyword">if</span> (ops == <span class="keyword">null</span>) &#123; <span class="comment">//【1】ops 为 null，我们收集该 package 的所有 Ops！</span></span><br><span class="line">        resOps = <span class="keyword">new</span> ArrayList&lt;AppOpsManager.OpEntry&gt;();</span><br><span class="line">        <span class="keyword">for</span> (<span class="keyword">int</span> j=<span class="number">0</span>; j&lt;pkgOps.size(); j++) &#123;</span><br><span class="line">            Op curOp = pkgOps.valueAt(j); <span class="comment">// 处理每一个 Op 对象！</span></span><br><span class="line">            <span class="comment">//【5.3.1.1.1】创建一个  AppOpsManager.OpEntry 对象，并添加到 resOps 中！</span></span><br><span class="line">            resOps.add(<span class="keyword">new</span> AppOpsManager.OpEntry(curOp.op, curOp.mode, curOp.time,</span><br><span class="line">                    curOp.rejectTime, curOp.duration, curOp.proxyUid,</span><br><span class="line">                    curOp.proxyPackageName));</span><br><span class="line">        &#125;</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        <span class="keyword">for</span> (<span class="keyword">int</span> j=<span class="number">0</span>; j&lt;ops.length; j++) &#123;</span><br><span class="line">            Op curOp = pkgOps.get(ops[j]);</span><br><span class="line">            <span class="keyword">if</span> (curOp != <span class="keyword">null</span>) &#123; <span class="comment">//【2】ops 不为 null，我们收集数组 ops 指定的 Op！</span></span><br><span class="line">                <span class="keyword">if</span> (resOps == <span class="keyword">null</span>) &#123;</span><br><span class="line">                    resOps = <span class="keyword">new</span> ArrayList&lt;AppOpsManager.OpEntry&gt;();</span><br><span class="line">                &#125;</span><br><span class="line">                resOps.add(<span class="keyword">new</span> AppOpsManager.OpEntry(curOp.op, curOp.mode, curOp.time,</span><br><span class="line">                        curOp.rejectTime, curOp.duration, curOp.proxyUid,</span><br><span class="line">                        curOp.proxyPackageName));</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">//【3】返回 resOps</span></span><br><span class="line">    <span class="keyword">return</span> resOps;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>collectOps 方法很简单，不多说了！</p>
<h5 id="5-3-1-1-1-new-AppOpsManager-OpEntry"><a href="#5-3-1-1-1-new-AppOpsManager-OpEntry" class="headerlink" title="5.3.1.1.1 new AppOpsManager.OpEntry"></a>5.3.1.1.1 new AppOpsManager.OpEntry</h5><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> <span class="class"><span class="keyword">class</span> <span class="title">OpEntry</span> <span class="keyword">implements</span> <span class="title">Parcelable</span> </span>&#123;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> <span class="keyword">int</span> mOp;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> <span class="keyword">int</span> mMode;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> <span class="keyword">long</span> mTime;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> <span class="keyword">long</span> mRejectTime;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> <span class="keyword">int</span> mDuration;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> <span class="keyword">int</span> mProxyUid;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> String mProxyPackageName;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="title">OpEntry</span><span class="params">(<span class="keyword">int</span> op, <span class="keyword">int</span> mode, <span class="keyword">long</span> time, <span class="keyword">long</span> rejectTime, <span class="keyword">int</span> duration,</span></span></span><br><span class="line"><span class="function"><span class="params">            <span class="keyword">int</span> proxyUid, String proxyPackage)</span> </span>&#123;</span><br><span class="line">        mOp = op;</span><br><span class="line">        mMode = mode;</span><br><span class="line">        mTime = time;</span><br><span class="line">        mRejectTime = rejectTime;</span><br><span class="line">        mDuration = duration;</span><br><span class="line">        mProxyUid = proxyUid;</span><br><span class="line">        mProxyPackageName = proxyPackage;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    ... ... ... ...<span class="comment">// 省略 get 和 set，以及 Parcelable 相关方法！</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>OpEntry 的结构很简单，不多说了！</p>
<h4 id="5-3-1-2-new-AppOpsManager-PackageOps"><a href="#5-3-1-2-new-AppOpsManager-PackageOps" class="headerlink" title="5.3.1.2 new AppOpsManager.PackageOps"></a>5.3.1.2 new AppOpsManager.PackageOps</h4><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> <span class="class"><span class="keyword">class</span> <span class="title">PackageOps</span> <span class="keyword">implements</span> <span class="title">Parcelable</span> </span>&#123;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> String mPackageName; <span class="comment">// package </span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> <span class="keyword">int</span> mUid; <span class="comment">// uid </span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> List&lt;OpEntry&gt; mEntries; <span class="comment">// 持有的所有 Op 对应的 OpEntry 对象！</span></span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="title">PackageOps</span><span class="params">(String packageName, <span class="keyword">int</span> uid, List&lt;OpEntry&gt; entries)</span> </span>&#123;</span><br><span class="line">        mPackageName = packageName;</span><br><span class="line">        mUid = uid;</span><br><span class="line">        mEntries = entries;</span><br><span class="line">    &#125;</span><br><span class="line">    ... ... ... ...<span class="comment">// 省略 get 和 set，以及 Parcelable 相关方法！</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>PackageOps 的结构很简单，不多说了！</p>
<h3 id="5-3-2-getOpsRawLocked"><a href="#5-3-2-getOpsRawLocked" class="headerlink" title="5.3.2 getOpsRawLocked"></a>5.3.2 getOpsRawLocked</h3><p>getOpsRawLocked 方法用于获得 package 的 Ops 列表！<br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">private</span> Ops <span class="title">getOpsRawLocked</span><span class="params">(<span class="keyword">int</span> uid, String packageName, <span class="keyword">boolean</span> edit)</span> </span>&#123;</span><br><span class="line">    <span class="comment">//【1】获得 uid 对应的 UidState！</span></span><br><span class="line">    UidState uidState = getUidStateLocked(uid, edit);</span><br><span class="line">    <span class="keyword">if</span> (uidState == <span class="keyword">null</span>) &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">null</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (uidState.pkgOps == <span class="keyword">null</span>) &#123;</span><br><span class="line">        <span class="keyword">if</span> (!edit) &#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="keyword">null</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        uidState.pkgOps = <span class="keyword">new</span> ArrayMap&lt;&gt;();</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">//【2】获得 package 对应的 Ops 集合！</span></span><br><span class="line">    Ops ops = uidState.pkgOps.get(packageName);</span><br><span class="line">    <span class="keyword">if</span> (ops == <span class="keyword">null</span>) &#123; <span class="comment">// 处理 package 的 ops 为 null 的特殊情况！</span></span><br><span class="line">        <span class="keyword">if</span> (!edit) &#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="keyword">null</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">boolean</span> isPrivileged = <span class="keyword">false</span>;</span><br><span class="line">        <span class="comment">//【3】如果 uid 不为 null，需要校验 uid 是否一致！</span></span><br><span class="line">        <span class="keyword">if</span> (uid != <span class="number">0</span>) &#123;</span><br><span class="line">            <span class="keyword">final</span> <span class="keyword">long</span> ident = Binder.clearCallingIdentity();</span><br><span class="line">            <span class="keyword">try</span> &#123;</span><br><span class="line">                <span class="keyword">int</span> pkgUid = -<span class="number">1</span>;</span><br><span class="line">                <span class="keyword">try</span> &#123;</span><br><span class="line">                    <span class="comment">//【3.1】获得该 package 的 ApplicationInfo 对象！</span></span><br><span class="line">                    ApplicationInfo appInfo = ActivityThread.getPackageManager()</span><br><span class="line">                            .getApplicationInfo(packageName,</span><br><span class="line">                                    PackageManager.MATCH_DEBUG_TRIAGED_MISSING,</span><br><span class="line">                                    UserHandle.getUserId(uid));</span><br><span class="line">                    <span class="comment">//【3.2】获得 package 的 uid，并判断是否是 FLAG_PRIVILEGED 的！</span></span><br><span class="line">                    <span class="keyword">if</span> (appInfo != <span class="keyword">null</span>) &#123;</span><br><span class="line">                        pkgUid = appInfo.uid;</span><br><span class="line">                        isPrivileged = (appInfo.privateFlags</span><br><span class="line">                                &amp; ApplicationInfo.PRIVATE_FLAG_PRIVILEGED) != <span class="number">0</span>;</span><br><span class="line">                    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                        <span class="comment">// 如果 appInfo 为 null，那就判断一些特殊 uid 的情况！</span></span><br><span class="line">                        <span class="keyword">if</span> (<span class="string">"media"</span>.equals(packageName)) &#123;</span><br><span class="line">                            pkgUid = Process.MEDIA_UID;</span><br><span class="line">                            isPrivileged = <span class="keyword">false</span>;</span><br><span class="line">                        &#125; <span class="keyword">else</span> <span class="keyword">if</span> (<span class="string">"audioserver"</span>.equals(packageName)) &#123;</span><br><span class="line">                            pkgUid = Process.AUDIOSERVER_UID;</span><br><span class="line">                            isPrivileged = <span class="keyword">false</span>;</span><br><span class="line">                        &#125; <span class="keyword">else</span> <span class="keyword">if</span> (<span class="string">"cameraserver"</span>.equals(packageName)) &#123;</span><br><span class="line">                            pkgUid = Process.CAMERASERVER_UID;</span><br><span class="line">                            isPrivileged = <span class="keyword">false</span>;</span><br><span class="line">                        &#125;</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125; <span class="keyword">catch</span> (RemoteException e) &#123;</span><br><span class="line">                    Slog.w(TAG, <span class="string">"Could not contact PackageManager"</span>, e);</span><br><span class="line">                &#125;</span><br><span class="line">                <span class="comment">//【3.3】检查 uid 是否发生变化，如果有变化，无效，那就返回 null！</span></span><br><span class="line">                <span class="keyword">if</span> (pkgUid != uid) &#123;</span><br><span class="line">                    RuntimeException ex = <span class="keyword">new</span> RuntimeException(<span class="string">"here"</span>);</span><br><span class="line">                    ex.fillInStackTrace();</span><br><span class="line">                    Slog.w(TAG, <span class="string">"Bad call: specified package "</span> + packageName</span><br><span class="line">                            + <span class="string">" under uid "</span> + uid + <span class="string">" but it is really "</span> + pkgUid, ex);</span><br><span class="line">                    <span class="keyword">return</span> <span class="keyword">null</span>;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">                Binder.restoreCallingIdentity(ident);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">//【4】如果该 package 的 Ops 为 null，那就会</span></span><br><span class="line">        <span class="comment">// 给该 package 重新创建一个 Ops，并添加到所属的 uidState.pkgOps 中！</span></span><br><span class="line">        ops = <span class="keyword">new</span> Ops(packageName, uidState, isPrivileged);</span><br><span class="line">        uidState.pkgOps.put(packageName, ops);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> ops; <span class="comment">// 返回该 package 的 Ops 列表！</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>方法很简单，不多说了！</p>
</div></article><div class="post-copyright"><div class="post-copyright__author"><span class="post-copyright-meta">文章作者: </span><span class="post-copyright-info"><a href="mailto:undefined">Coolqi.Li</a></span></div><div class="post-copyright__type"><span class="post-copyright-meta">文章链接: </span><span class="post-copyright-info"><a href="https://lishuaiqi.top/2017/08/01/AppOps1-AppOpsServiceStartProcess/">https://lishuaiqi.top/2017/08/01/AppOps1-AppOpsServiceStartProcess/</a></span></div><div class="post-copyright__notice"><span class="post-copyright-meta">版权声明: </span><span class="post-copyright-info">本博客所有文章除特别声明外，均采用 <a href="https://creativecommons.org/licenses/by-nc-sa/4.0/">CC BY-NC-SA 4.0</a> 许可协议。转载请注明来自 <a href="https://lishuaiqi.top">Coolqi`s Blog</a>！</span></div></div><div class="post-meta__tag-list"><a class="post-meta__tags" href="/tags/AppOps应用操作管理/">AppOps应用操作管理</a></div><div class="post-qr-code"><div class="post-qr-code-item"><img class="post-qr-code__img" src="/img/zfb.jpg"><div class="post-qr-code__desc">支付宝打赏</div></div><div class="post-qr-code-item"><img class="post-qr-code__img" src="/img/wechat.jpg"><div class="post-qr-code__desc">微信打赏</div></div></div><div class="social-share pull-right"></div><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/social-share.js@1.0.16/dist/css/share.min.css"><script src="https://cdn.jsdelivr.net/npm/social-share.js@1.0.16/dist/js/social-share.min.js"></script><nav id="pagination"><div class="prev-post pull-left"><a href="/2017/08/03/UsageStats4-usageStatsServiceInteractionWithServiceOrProcess/"><i class="fa fa-chevron-left">  </i><span>UsageStats 第 4 篇 - UsageStatsService 和其他服务和进程的交互</span></a></div><div class="next-post pull-right"><a href="/2017/07/25/AlarmManager2-setAlarm/"><span>AlarmManager第 2 篇 - set Alarm 流程分析</span><i class="fa fa-chevron-right"></i></a></div></nav><div id="gitment-container"></div><script>var gitment = new Gitment({
  id: md5(decodeURI(location.pathname)),
  owner: '',
  repo: '',
  oauth: {
    client_id: '7b4efbcd7027d15749d6',
    client_secret: '14b5d7e8580ee29f7aeca733a25c000795967448'
  }
})
gitment.render('gitment-container')</script></div></div><footer class="footer-bg" style="background-image: url(/img/blog-bg.jpg)"><div class="layout" id="footer"><div class="copyright">&copy;2015 - 2020 By Coolqi.Li</div><div class="framework-info"><span>驱动 - </span><a href="http://hexo.io"><span>Hexo</span></a><span class="footer-separator">|</span><span>主题 - </span><a href="https://github.com/Molunerfinn/hexo-theme-melody"><span>Melody</span></a></div><div class="footer_custom_text">Hi, welcome to my <a href="https://lishuaiqi.top/">blog</a>!</div><div class="busuanzi"><script async src="//busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script><span id="busuanzi_container_page_pv"><i class="fa fa-file-o"></i><span id="busuanzi_value_page_pv"></span><span></span></span></div></div></footer><i class="fa fa-arrow-up" id="go-up" aria-hidden="true"></i><script src="/js/third-party/anime.min.js"></script><script src="/js/third-party/jquery.min.js"></script><script src="/js/third-party/jquery.fancybox.min.js"></script><script src="/js/third-party/velocity.min.js"></script><script src="/js/third-party/velocity.ui.min.js"></script><script src="/js/utils.js?version=1.7.0"></script><script src="/js/fancybox.js?version=1.7.0"></script><script src="/js/sidebar.js?version=1.7.0"></script><script src="/js/copy.js?version=1.7.0"></script><script src="/js/fireworks.js?version=1.7.0"></script><script src="/js/transition.js?version=1.7.0"></script><script src="/js/scroll.js?version=1.7.0"></script><script src="/js/head.js?version=1.7.0"></script><script type="text/x-mathjax-config">MathJax.Hub.Config({
  tex2jax: {
    inlineMath: [ ['$','$'], ["\\(","\\)"]  ],
    processEscapes: true,
    skipTags: ['script', 'noscript', 'style', 'textarea', 'pre', 'code']
  },
  CommonHTML: {
    linebreaks: { automatic: true, width: "90% container" }
  },
  "HTML-CSS": { 
    linebreaks: { automatic: true, width: "90% container" }
  },
  "SVG": { 
    linebreaks: { automatic: true, width: "90% container" }
  }
});
</script><script type="text/x-mathjax-config">MathJax.Hub.Queue(function() {
  var all = MathJax.Hub.getAllJax(), i;
  for (i=0; i < all.length; i += 1) {
    all[i].SourceElement().parentNode.className += ' has-jax';
  }
});
</script><script src="https://cdn.jsdelivr.net/npm/mathjax/MathJax.js?config=TeX-AMS-MML_HTMLorMML"></script><script src="/js/search/local-search.js"></script><script>if(/Android|webOS|iPhone|iPod|iPad|BlackBerry/i.test(navigator.userAgent)) {
  $('#nav').addClass('is-mobile')
  $('footer').addClass('is-mobile')
  $('#top-container').addClass('is-mobile')
}</script><div class="search-dialog" id="local-search"><div class="search-dialog__title" id="local-search-title">本地搜索</div><div id="local-input-panel"><div id="local-search-input"><div class="local-search-box"><input class="local-search-box--input" placeholder="搜索文章"></div></div></div><hr><div id="local-search-results"><div id="local-hits"></div><div id="local-stats"><div class="local-search-stats__hr" id="hr"><span>由</span> <a href="https://github.com/wzpan/hexo-generator-search" style="color:#49B1F5;">hexo-generator-search</a>
 <span>提供支持</span></div></div></div><span class="search-close-button"><i class="fa fa-times"></i></span></div><div class="search-mask"></div></body></html>
<!DOCTYPE html><html lang="zh-Hans"><head><meta charset="UTF-8"><meta http-equiv="X-UA-Compatible" content="IE=edge"><meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1"><meta name="description" content="Permission第 5 篇 - grantPermission 权限授予"><meta name="keywords" content="Permission权限管理"><meta name="author" content="Coolqi.Li,undefined"><meta name="copyright" content="Coolqi.Li"><title>Permission第 5 篇 - grantPermission 权限授予 | Coolqi`s Blog</title><link rel="shortcut icon" href="/img/favicon.ico"><link rel="stylesheet" href="/css/index.css?version=1.5.6"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/font-awesome@4.7.0/css/font-awesome.min.css?version=1.5.6"><link rel="dns-prefetch" href="https://cdn.staticfile.org"><link rel="dns-prefetch" href="https://cdn.bootcss.com"><link rel="dns-prefetch" href="https://creativecommons.org"><link rel="dns-prefetch" href="https://hm.baidu.com"><script>var _hmt = _hmt || [];
(function() {
  var hm = document.createElement("script");
  hm.src = "https://hm.baidu.com/hm.js?b7acef5306e54116ad8a99e8b753a92d";
  var s = document.getElementsByTagName("script")[0]; 
  s.parentNode.insertBefore(hm, s);
})();</script><script>var GLOBAL_CONFIG = { 
  root: '/',
  algolia: undefined,
  localSearch: {"path":"search.xml","languages":{"hits_empty":"找不到您查询的内容:${query}"}},
  copy: {
    success: '复制成功',
    error: '复制错误',
    noSupport: '浏览器不支持'
  }
} </script></head><body><i class="fa fa-arrow-right" id="toggle-sidebar" aria-hidden="true"></i><div id="sidebar"><div class="toggle-sidebar-info text-center"><span data-toggle="切换文章详情">切换站点概览</span><hr></div><div class="sidebar-toc"><div class="sidebar-toc__title">目录</div><div class="sidebar-toc__progress"><span class="progress-notice">你已经读了</span><span class="progress-num">0</span><span class="progress-percentage">%</span><div class="sidebar-toc__progress-bar"></div></div><div class="sidebar-toc__content"><ol class="toc"><li class="toc-item toc-level-1"><a class="toc-link" href="#0-综述"><span class="toc-text">0 综述</span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#1-grantPermission-ContextImpl"><span class="toc-text">1 grantPermission - ContextImpl</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#1-1-grantUriPermission"><span class="toc-text">1.1 grantUriPermission</span></a></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#2-grantPermission-ActivityManagerService"><span class="toc-text">2 grantPermission - ActivityManagerService</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#2-1-grantUriPermission"><span class="toc-text">2.1 grantUriPermission</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#2-1-1-new-GrantUri"><span class="toc-text">2.1.1 new GrantUri</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#2-1-2-跨进程调用"><span class="toc-text">2.1.2 跨进程调用</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#2-2-grantUriPermissionLocked-内部调用"><span class="toc-text">2.2 grantUriPermissionLocked - 内部调用</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#2-2-1-调用时机"><span class="toc-text">2.2.1 调用时机</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#2-3-grantUriPermissionUncheckedLocked-内部调用，核心接口"><span class="toc-text">2.3 grantUriPermissionUncheckedLocked - 内部调用，核心接口</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#2-3-1-findOrCreateUriPermissionLocked"><span class="toc-text">2.3.1 findOrCreateUriPermissionLocked</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#2-3-1-1-new-UriPermission"><span class="toc-text">2.3.1.1 new UriPermission</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#2-3-2-UriPermission-grantModes"><span class="toc-text">2.3.2 UriPermission.grantModes</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#2-3-2-1-addReadOwner"><span class="toc-text">2.3.2.1 addReadOwner</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#2-3-2-2-addWriteOwner"><span class="toc-text">2.3.2.2 addWriteOwner</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#2-3-2-3-updateModeFlags"><span class="toc-text">2.3.2.3 updateModeFlags</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#2-3-3-调用时机"><span class="toc-text">2.3.3 调用时机</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#2-4-grantUriPermissionFromIntentLocked"><span class="toc-text">2.4 grantUriPermissionFromIntentLocked</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#2-4-1-调用时机"><span class="toc-text">2.4.1 调用时机</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#2-4-1-1-finishActivityResultsLocked-ActivityStack"><span class="toc-text">2.4.1.1 finishActivityResultsLocked - ActivityStack</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#2-4-1-2-sendActivityResultLocked-ActivityStack"><span class="toc-text">2.4.1.2 sendActivityResultLocked  - ActivityStack</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#2-4-1-3-deliverNewIntentLocked-ActivityRecord"><span class="toc-text">2.4.1.3 deliverNewIntentLocked  - ActivityRecord</span></a><ol class="toc-child"><li class="toc-item toc-level-5"><a class="toc-link" href="#2-4-1-3-1-getUriPermissionsLocked"><span class="toc-text">2.4.1.3.1 getUriPermissionsLocked</span></a></li></ol></li><li class="toc-item toc-level-4"><a class="toc-link" href="#2-4-1-4-startActivityUnchecked-ActivityStarter"><span class="toc-text">2.4.1.4 startActivityUnchecked - ActivityStarter</span></a></li></ol></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#2-5-grantUriPermissionUncheckedFromIntentLocked"><span class="toc-text">2.5 grantUriPermissionUncheckedFromIntentLocked</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#2-5-1-调用时机"><span class="toc-text">2.5.1 调用时机</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#2-5-1-1-sendServiceArgsLocked"><span class="toc-text">2.5.1.1 sendServiceArgsLocked</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#2-5-1-2-StartItem-getUriPermissionsLocked"><span class="toc-text">2.5.1.2 StartItem.getUriPermissionsLocked</span></a></li></ol></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#2-6-grantUriPermissionFromOwner"><span class="toc-text">2.6 grantUriPermissionFromOwner</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#2-6-1-newUriPermissionOwner"><span class="toc-text">2.6.1 newUriPermissionOwner</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#2-6-1-1-new-UriPermissionOwner"><span class="toc-text">2.6.1.1 new UriPermissionOwner</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#2-6-1-2-getExternalTokenLocked"><span class="toc-text">2.6.1.2 getExternalTokenLocked</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#2-6-1-3-fromExternalToken"><span class="toc-text">2.6.1.3 fromExternalToken</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#2-6-2-调用时机"><span class="toc-text">2.6.2 调用时机</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#2-6-2-1-new-VoiceInteractionSessionConnection"><span class="toc-text">2.6.2.1 new VoiceInteractionSessionConnection</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#2-6-2-2-deliverSessionDataLocked-VoiceInteractionSessionConnection"><span class="toc-text">2.6.2.2 deliverSessionDataLocked - VoiceInteractionSessionConnection</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#2-6-2-3-grantUriPermission-VoiceInteractionSessionConnection"><span class="toc-text">2.6.2.3 grantUriPermission - VoiceInteractionSessionConnection</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#2-6-3-跨进程通信"><span class="toc-text">2.6.3 跨进程通信</span></a></li></ol></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#3-grantPermission-PackageManagerService"><span class="toc-text">3 grantPermission - PackageManagerService</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#3-1-grantPermissionsLPw-权限更新时调用重新授予"><span class="toc-text">3.1 grantPermissionsLPw - 权限更新时调用重新授予</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#3-2-1-grantSignaturePermission-Signature-权限授予核心接口"><span class="toc-text">3.2.1 grantSignaturePermission - Signature 权限授予核心接口</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#3-2-grantRuntimePermission-运行时权限授予核心接口"><span class="toc-text">3.2 grantRuntimePermission - 运行时权限授予核心接口</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#3-3-grantRequestedRuntimePermissions-安装时授予运行时权限"><span class="toc-text">3.3 grantRequestedRuntimePermissions - 安装时授予运行时权限</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#3-3-1-grantRequestedRuntimePermissionsForUser"><span class="toc-text">3.3.1 grantRequestedRuntimePermissionsForUser</span></a></li></ol></li></ol></li></ol></div></div><div class="author-info hide"><div class="author-info__avatar text-center"><img src="/img/avatar.png"></div><div class="author-info__name text-center">Coolqi.Li</div><div class="author-info__description text-center">“你好，我是李帅奇，Android 系统工程师，MineCraft 忠实玩家，设计和绘画爱好者，缺妹纸晚期患者，熬夜星人。”</div><hr><div class="author-info-articles"><a class="author-info-articles__archives article-meta" href="/archives"><span class="pull-left">文章</span><span class="pull-right">71</span></a><a class="author-info-articles__tags article-meta" href="/tags"><span class="pull-left">标签</span><span class="pull-right">16</span></a><a class="author-info-articles__categories article-meta" href="/categories"><span class="pull-left">分类</span><span class="pull-right">18</span></a></div><hr><div class="author-info-links"><div class="author-info-links__title text-center">Links</div><a class="author-info-links__name text-center" href="https://developer.android.google.cn/">AndroidDeveloper</a><a class="author-info-links__name text-center" href="http://www.android-studio.org/">AndroidStudio</a><a class="author-info-links__name text-center" href="https://www.jianshu.com/u/123a20a96441">简书</a><a class="author-info-links__name text-center" href="https://weibo.com/coolqiLi">微博</a></div></div></div><div id="content-outer"><div id="top-container" style="background-image: url(https://ws1.sinaimg.cn/large/8700af19ly1fvpabr30o6j22yo1o0q7i.jpg)"><div id="page-header"><span class="pull-left"> <a id="site-name" href="/">Coolqi`s Blog</a></span><i class="fa fa-bars toggle-menu pull-right" aria-hidden="true"></i><span class="pull-right menus"><a class="site-page social-icon search"><i class="fa fa-search"></i><span> 搜索</span></a><a class="site-page" href="/">Home</a><a class="site-page" href="/categories">Categories</a><a class="site-page" href="/tags">Tags</a><a class="site-page" href="/archives">Archives</a><a class="site-page" href="/about">About</a></span></div><div id="post-info"><div id="post-title">Permission第 5 篇 - grantPermission 权限授予</div><div id="post-meta"><time class="post-meta__date"><i class="fa fa-calendar" aria-hidden="true"></i> 2017-08-25</time><span class="post-meta__separator">|</span><i class="fa fa-inbox post-meta__icon" aria-hidden="true"></i><a class="post-meta__categories" href="/categories/AndroidFramework源码分析/">AndroidFramework源码分析</a><i class="fa fa-angle-right" aria-hidden="true"></i><i class="fa fa-inbox post-meta__icon" aria-hidden="true"></i><a class="post-meta__categories" href="/categories/AndroidFramework源码分析/Permission权限管理/">Permission权限管理</a><div class="post-meta-wordcount"><span>字数总计: </span><span class="word-count">9.2k</span><span class="post-meta__separator">|</span><span>阅读时长: 42 分钟</span></div></div></div></div><div class="layout" id="content-inner"><article id="post"><div class="article-container" id="post-content"><p>[TOC]</p>
<h1 id="0-综述"><a href="#0-综述" class="headerlink" title="0 综述"></a>0 综述</h1><p>基于 Android 7.1.1 源码，分析系统的权限管理机制！</p>
<p>本片文章总结一下权限授予的相关接口。</p>
<p>对于 dangrous 权限，应用程序需要显式的弹出弹窗，让用户主动的选择。当用户撤销或者授予时，会主动的调用！</p>
<p>但是对于 normal permission，siginature permission 以及 uri permission 都是无需弹窗申请的！</p>
<p>那么我们来看下系统中有那些和其相关的接口！</p>
<h1 id="1-grantPermission-ContextImpl"><a href="#1-grantPermission-ContextImpl" class="headerlink" title="1 grantPermission - ContextImpl"></a>1 grantPermission - ContextImpl</h1><p>在 ContextImpl 中提供了一个 grantUriPermission 方法：</p>
<h2 id="1-1-grantUriPermission"><a href="#1-1-grantUriPermission" class="headerlink" title="1.1 grantUriPermission"></a>1.1 grantUriPermission</h2><p>该方法由于是在 ContextImpl 暴露的，所以应用程序可以通过该方法 grant uri permission 给其他应用程序：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">grantUriPermission</span><span class="params">(String toPackage, Uri uri, <span class="keyword">int</span> modeFlags)</span> </span>&#123;</span><br><span class="line">     <span class="keyword">try</span> &#123;</span><br><span class="line">        <span class="comment">//【*2.1】继续授予：</span></span><br><span class="line">        ActivityManagerNative.getDefault().grantUriPermission(</span><br><span class="line">                mMainThread.getApplicationThread(), toPackage,</span><br><span class="line">                ContentProvider.getUriWithoutUserId(uri), modeFlags, resolveUserId(uri));</span><br><span class="line">    &#125; <span class="keyword">catch</span> (RemoteException e) &#123;</span><br><span class="line">        <span class="keyword">throw</span> e.rethrowFromSystemServer();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>不多说了!</p>
<h1 id="2-grantPermission-ActivityManagerService"><a href="#2-grantPermission-ActivityManagerService" class="headerlink" title="2 grantPermission - ActivityManagerService"></a>2 grantPermission - ActivityManagerService</h1><p>ActivityManagerService 内部提供了一些和 uri permission 相关的接口：</p>
<h2 id="2-1-grantUriPermission"><a href="#2-1-grantUriPermission" class="headerlink" title="2.1 grantUriPermission"></a>2.1 grantUriPermission</h2><p>授予一个 uri permisson 给 target package，这个方法授予的 permission 是一个 global permisson；</p>
<p>因为其在调用 grantUriPermissionLocked 时传入的 UriPermissionOwner owner 为 null；</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">grantUriPermission</span><span class="params">(IApplicationThread caller, String targetPkg, Uri uri,</span></span></span><br><span class="line"><span class="function"><span class="params">        <span class="keyword">final</span> <span class="keyword">int</span> modeFlags, <span class="keyword">int</span> userId)</span> </span>&#123;</span><br><span class="line">    enforceNotIsolatedCaller(<span class="string">"grantUriPermission"</span>);</span><br><span class="line">    <span class="comment">//【*2.1.1】创建了一个 GrantUri 对象！</span></span><br><span class="line">    GrantUri grantUri = <span class="keyword">new</span> GrantUri(userId, uri, <span class="keyword">false</span>);</span><br><span class="line">    <span class="keyword">synchronized</span>(<span class="keyword">this</span>) &#123;</span><br><span class="line">        <span class="keyword">final</span> ProcessRecord r = getRecordForAppLocked(caller);</span><br><span class="line">        <span class="keyword">if</span> (r == <span class="keyword">null</span>) &#123;</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> SecurityException(<span class="string">"Unable to find app for caller "</span></span><br><span class="line">                    + caller</span><br><span class="line">                    + <span class="string">" when granting permission to uri "</span> + grantUri);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">if</span> (targetPkg == <span class="keyword">null</span>) &#123;</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> IllegalArgumentException(<span class="string">"null target"</span>);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">if</span> (grantUri == <span class="keyword">null</span>) &#123;</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> IllegalArgumentException(<span class="string">"null uri"</span>);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">//【1】强制检查下 intent 的 flags 标志位！</span></span><br><span class="line">        Preconditions.checkFlagsArgument(modeFlags, Intent.FLAG_GRANT_READ_URI_PERMISSION</span><br><span class="line">                | Intent.FLAG_GRANT_WRITE_URI_PERMISSION</span><br><span class="line">                | Intent.FLAG_GRANT_PERSISTABLE_URI_PERMISSION</span><br><span class="line">                | Intent.FLAG_GRANT_PREFIX_URI_PERMISSION);</span><br><span class="line">        <span class="comment">//【*2.2】调用了另外一个方法！</span></span><br><span class="line">        grantUriPermissionLocked(r.uid, targetPkg, grantUri, modeFlags, <span class="keyword">null</span>,</span><br><span class="line">                UserHandle.getUserId(r.uid));</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h3 id="2-1-1-new-GrantUri"><a href="#2-1-1-new-GrantUri" class="headerlink" title="2.1.1 new GrantUri"></a>2.1.1 new GrantUri</h3><p>GrantUri 实例是对 uri 信息的简单封装：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> <span class="class"><span class="keyword">class</span> <span class="title">GrantUri</span> </span>&#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">final</span> <span class="keyword">int</span> sourceUserId;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">final</span> Uri uri;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">boolean</span> prefix;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="title">GrantUri</span><span class="params">(<span class="keyword">int</span> sourceUserId, Uri uri, <span class="keyword">boolean</span> prefix)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">this</span>.sourceUserId = sourceUserId;</span><br><span class="line">        <span class="keyword">this</span>.uri = uri;</span><br><span class="line">        <span class="keyword">this</span>.prefix = prefix;</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure>
<h3 id="2-1-2-跨进程调用"><a href="#2-1-2-跨进程调用" class="headerlink" title="2.1.2 跨进程调用"></a>2.1.2 跨进程调用</h3><p>ContextImpl 的 grantUriPermission 可以跨进程调用该方法：</p>
<ul>
<li><strong>ActivityManagerProxy</strong></li>
</ul>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">grantUriPermission</span><span class="params">(IApplicationThread caller, String targetPkg,</span></span></span><br><span class="line"><span class="function"><span class="params">        Uri uri, <span class="keyword">int</span> mode, <span class="keyword">int</span> userId)</span> <span class="keyword">throws</span> RemoteException </span>&#123;</span><br><span class="line">    Parcel data = Parcel.obtain();</span><br><span class="line">    Parcel reply = Parcel.obtain();</span><br><span class="line">    data.writeInterfaceToken(IActivityManager.descriptor);</span><br><span class="line">    data.writeStrongBinder(caller.asBinder());</span><br><span class="line">    data.writeString(targetPkg);</span><br><span class="line">    uri.writeToParcel(data, <span class="number">0</span>);</span><br><span class="line">    data.writeInt(mode);</span><br><span class="line">    data.writeInt(userId);</span><br><span class="line">    mRemote.transact(GRANT_URI_PERMISSION_TRANSACTION, data, reply, <span class="number">0</span>);</span><br><span class="line">    reply.readException();</span><br><span class="line">    data.recycle();</span><br><span class="line">    reply.recycle();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<ul>
<li><strong>ActivityManagerNative</strong></li>
</ul>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">case</span> GRANT_URI_PERMISSION_TRANSACTION: &#123;</span><br><span class="line">    data.enforceInterface(IActivityManager.descriptor);</span><br><span class="line">    IBinder b = data.readStrongBinder();</span><br><span class="line">    IApplicationThread app = ApplicationThreadNative.asInterface(b);</span><br><span class="line">    String targetPkg = data.readString();</span><br><span class="line">    Uri uri = Uri.CREATOR.createFromParcel(data);</span><br><span class="line">    <span class="keyword">int</span> mode = data.readInt();</span><br><span class="line">    <span class="keyword">int</span> userId = data.readInt();</span><br><span class="line">    grantUriPermission(app, targetPkg, uri, mode, userId);</span><br><span class="line">    reply.writeNoException();</span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">true</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h2 id="2-2-grantUriPermissionLocked-内部调用"><a href="#2-2-grantUriPermissionLocked-内部调用" class="headerlink" title="2.2 grantUriPermissionLocked - 内部调用"></a>2.2 grantUriPermissionLocked - 内部调用</h2><p>该方法的特点是，系统在调用时，会持有 AMS 大锁，所以此时系统进程的其他需要 AMS 大锁的线程会等待：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">grantUriPermissionLocked</span><span class="params">(<span class="keyword">int</span> callingUid, String targetPkg, GrantUri grantUri,</span></span></span><br><span class="line"><span class="function"><span class="params">        <span class="keyword">final</span> <span class="keyword">int</span> modeFlags, UriPermissionOwner owner, <span class="keyword">int</span> targetUserId)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">if</span> (targetPkg == <span class="keyword">null</span>) &#123;</span><br><span class="line">        <span class="keyword">throw</span> <span class="keyword">new</span> NullPointerException(<span class="string">"targetPkg"</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">int</span> targetUid;</span><br><span class="line">    <span class="keyword">final</span> IPackageManager pm = AppGlobals.getPackageManager();</span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">        targetUid = pm.getPackageUid(targetPkg, MATCH_DEBUG_TRIAGED_MISSING, targetUserId);</span><br><span class="line">    &#125; <span class="keyword">catch</span> (RemoteException ex) &#123;</span><br><span class="line">        <span class="keyword">return</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">//【1】检查是否需要授予 uri 权限，</span></span><br><span class="line">    targetUid = checkGrantUriPermissionLocked(callingUid, targetPkg, grantUri, modeFlags,</span><br><span class="line">            targetUid);</span><br><span class="line">    <span class="keyword">if</span> (targetUid &lt; <span class="number">0</span>) &#123;</span><br><span class="line">        <span class="keyword">return</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">//【*2.3】调用了另外一个方法！</span></span><br><span class="line">    grantUriPermissionUncheckedLocked(targetUid, targetPkg, grantUri, modeFlags,</span><br><span class="line">            owner);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>这里调用了 checkGrantUriPermissionLocked 方法，检查是否需要授予 uri 权限！</p>
<p>checkGrantUriPermissionLocked 方法会判断是否已经有 uri 权限，以及发送包含 uri 的 intent 程序是否有权限访问 uri 等等！！</p>
<p>只有发送方对 uri 有权限，接收者才能被授予权限！！</p>
<h3 id="2-2-1-调用时机"><a href="#2-2-1-调用时机" class="headerlink" title="2.2.1 调用时机"></a>2.2.1 调用时机</h3><ul>
<li>第二个是在 1.1 grantUriPermission 中调用的；</li>
<li>第二个是在 1.6 grantUriPermissionFromOwner 中调用的；</li>
</ul>
<p>该方法也是一个内部方法！</p>
<h2 id="2-3-grantUriPermissionUncheckedLocked-内部调用，核心接口"><a href="#2-3-grantUriPermissionUncheckedLocked-内部调用，核心接口" class="headerlink" title="2.3 grantUriPermissionUncheckedLocked - 内部调用，核心接口"></a>2.3 grantUriPermissionUncheckedLocked - 内部调用，核心接口</h2><p>这个方法不会做一些 check 操作，所以最好不要直接调用，默认发送方对 uri 是有权限的：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">grantUriPermissionUncheckedLocked</span><span class="params">(<span class="keyword">int</span> targetUid, String targetPkg, GrantUri grantUri,</span></span></span><br><span class="line"><span class="function"><span class="params">        <span class="keyword">final</span> <span class="keyword">int</span> modeFlags, UriPermissionOwner owner)</span> </span>&#123;</span><br><span class="line">    <span class="comment">//【1】这个方法之前有讲过，判断是否设置了和 uri 下相关的标志位！</span></span><br><span class="line">    <span class="keyword">if</span> (!Intent.isAccessUriMode(modeFlags)) &#123;</span><br><span class="line">        <span class="keyword">return</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (DEBUG_URI_PERMISSION) Slog.v(TAG_URI_PERMISSION,</span><br><span class="line">            <span class="string">"Granting "</span> + targetPkg + <span class="string">"/"</span> + targetUid + <span class="string">" permission to "</span> + grantUri);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">final</span> String authority = grantUri.uri.getAuthority();</span><br><span class="line">    <span class="comment">//【2】根据 uri 找到对应的 provider！</span></span><br><span class="line">    <span class="keyword">final</span> ProviderInfo pi = getProviderInfoLocked(authority, grantUri.sourceUserId,</span><br><span class="line">            MATCH_DEBUG_TRIAGED_MISSING);</span><br><span class="line">    <span class="keyword">if</span> (pi == <span class="keyword">null</span>) &#123;</span><br><span class="line">        Slog.w(TAG, <span class="string">"No content provider found for grant: "</span> + grantUri.toSafeString());</span><br><span class="line">        <span class="keyword">return</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">//【3】判断是否仅仅匹配 uri 前缀！</span></span><br><span class="line">    <span class="keyword">if</span> ((modeFlags &amp; Intent.FLAG_GRANT_PREFIX_URI_PERMISSION) != <span class="number">0</span>) &#123;</span><br><span class="line">        grantUri.prefix = <span class="keyword">true</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">//【*2.3.1】找到已存在或者新建的 UriPermission 实例；</span></span><br><span class="line">    <span class="keyword">final</span> UriPermission perm = findOrCreateUriPermissionLocked(</span><br><span class="line">            pi.packageName, targetPkg, targetUid, grantUri);</span><br><span class="line">    <span class="comment">//【*2.3.2】授予该权限；</span></span><br><span class="line">    perm.grantModes(modeFlags, owner);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>所以我们看到，对于 uri permission，其管理是在 AMS 中的！</p>
<h3 id="2-3-1-findOrCreateUriPermissionLocked"><a href="#2-3-1-findOrCreateUriPermissionLocked" class="headerlink" title="2.3.1 findOrCreateUriPermissionLocked"></a>2.3.1 findOrCreateUriPermissionLocked</h3><p>找到一个已存在或者新建的 UriPermission 实例：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">private</span> UriPermission <span class="title">findOrCreateUriPermissionLocked</span><span class="params">(String sourcePkg,</span></span></span><br><span class="line"><span class="function"><span class="params">        String targetPkg, <span class="keyword">int</span> targetUid, GrantUri grantUri)</span> </span>&#123;</span><br><span class="line">    <span class="comment">//【1】尝试找到 targetUid 被授予的所有 uri permission 集合</span></span><br><span class="line">    ArrayMap&lt;GrantUri, UriPermission&gt; targetUris = mGrantedUriPermissions.get(targetUid);</span><br><span class="line">    <span class="comment">//【2】如果没有的话，下面会做初始化工作！</span></span><br><span class="line">    <span class="keyword">if</span> (targetUris == <span class="keyword">null</span>) &#123;</span><br><span class="line">        targetUris = Maps.newArrayMap();</span><br><span class="line">        mGrantedUriPermissions.put(targetUid, targetUris);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">//【*2.3.1.1】同理，创建一个新的 UriPermission！</span></span><br><span class="line">    UriPermission perm = targetUris.get(grantUri);</span><br><span class="line">    <span class="keyword">if</span> (perm == <span class="keyword">null</span>) &#123;</span><br><span class="line">        perm = <span class="keyword">new</span> UriPermission(sourcePkg, targetPkg, targetUid, grantUri);</span><br><span class="line">        targetUris.put(grantUri, perm);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">//【3】返回 UriPermission 实例！</span></span><br><span class="line">    <span class="keyword">return</span> perm;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>在 ActivityManagerService 内部是有一个 mGrantedUriPermissions 数组：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//【1】用于保存所有已经被授予的 uri permissions；</span></span><br><span class="line"><span class="meta">@GuardedBy</span>(<span class="string">"this"</span>)</span><br><span class="line">        mGrantedUriPermissions = <span class="keyword">new</span> SparseArray&lt;ArrayMap&lt;GrantUri, UriPermission&gt;&gt;();</span><br></pre></td></tr></table></figure>
<p>SparseArray 的下标是被授予 uri permission 的目标 uid，值是一个 ArrayMap&lt;GrantUri, UriPermission&gt;，保存了 uri 和对应的 UriPermission 的映射关系！</p>
<h4 id="2-3-1-1-new-UriPermission"><a href="#2-3-1-1-new-UriPermission" class="headerlink" title="2.3.1.1 new UriPermission"></a>2.3.1.1 new UriPermission</h4><p>创建一个更新的 UriPermission：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">final</span> <span class="class"><span class="keyword">class</span> <span class="title">UriPermission</span> </span>&#123;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> String TAG = <span class="string">"UriPermission"</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="keyword">int</span> STRENGTH_NONE = <span class="number">0</span>;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="keyword">int</span> STRENGTH_OWNED = <span class="number">1</span>;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="keyword">int</span> STRENGTH_GLOBAL = <span class="number">2</span>;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="keyword">int</span> STRENGTH_PERSISTABLE = <span class="number">3</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">final</span> <span class="keyword">int</span> targetUserId; <span class="comment">// 目标 userId；</span></span><br><span class="line">    <span class="keyword">final</span> String sourcePkg; <span class="comment">// 源 pkg；</span></span><br><span class="line">    <span class="keyword">final</span> String targetPkg; <span class="comment">// 目标 pkg；</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">// 目标 uid，用于缓存 targetPkg 对应的 uid，不会被 persist；</span></span><br><span class="line">    <span class="keyword">final</span> <span class="keyword">int</span> targetUid;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">final</span> GrantUri uri; <span class="comment">// 对应的 uri；</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">// 允许模式，是其他四个 mode 的结合，所有的 uri permission 都要用该 mode 标志处理权限检查和授予；</span></span><br><span class="line">    <span class="keyword">int</span> modeFlags = <span class="number">0</span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 允许模式，当该模式被设置，表示该 uri permission 有非全局的显式 owner；</span></span><br><span class="line">    <span class="keyword">int</span> ownedModeFlags = <span class="number">0</span>;</span><br><span class="line">    <span class="comment">// 允许模式，当该模式被设置，表示该 uri permission 是全局 global 的；</span></span><br><span class="line">    <span class="keyword">int</span> globalModeFlags = <span class="number">0</span>;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// 允许模式，当该模式被设置，表示该 uri permission 可能需要被持久化；</span></span><br><span class="line">    <span class="keyword">int</span> persistableModeFlags = <span class="number">0</span>;</span><br><span class="line">    <span class="comment">// 允许模式，当该模式被设置，表示该 uri permission 需要被持久化；</span></span><br><span class="line">    <span class="keyword">int</span> persistedModeFlags = <span class="number">0</span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * Timestamp when &#123;<span class="doctag">@link</span> #persistedModeFlags&#125; was first defined in</span></span><br><span class="line"><span class="comment">     * &#123;<span class="doctag">@link</span> System#currentTimeMillis()&#125; time base.</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">long</span> persistedCreateTime = INVALID_TIME;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="keyword">long</span> INVALID_TIME = Long.MIN_VALUE;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> ArraySet&lt;UriPermissionOwner&gt; mReadOwners; <span class="comment">// 保存所有读权限的拥有者；</span></span><br><span class="line">    <span class="keyword">private</span> ArraySet&lt;UriPermissionOwner&gt; mWriteOwners; <span class="comment">// 保存所有写权限的拥有者；</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> String stringName;</span><br><span class="line"></span><br><span class="line">    UriPermission(String sourcePkg, String targetPkg, <span class="keyword">int</span> targetUid, GrantUri uri) &#123;</span><br><span class="line">        <span class="keyword">this</span>.targetUserId = UserHandle.getUserId(targetUid);</span><br><span class="line">        <span class="keyword">this</span>.sourcePkg = sourcePkg;</span><br><span class="line">        <span class="keyword">this</span>.targetPkg = targetPkg;</span><br><span class="line">        <span class="keyword">this</span>.targetUid = targetUid;</span><br><span class="line">        <span class="keyword">this</span>.uri = uri;</span><br><span class="line">    &#125;</span><br><span class="line">    ... ... ... ...</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>上面只是简单的介绍了下 UriPermission  内部的一些主要的属性，后面我们遇到了具体的逻辑时再分析！</p>
<h3 id="2-3-2-UriPermission-grantModes"><a href="#2-3-2-UriPermission-grantModes" class="headerlink" title="2.3.2 UriPermission.grantModes"></a>2.3.2 UriPermission.grantModes</h3><p>授予 uri permission：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">grantModes</span><span class="params">(<span class="keyword">int</span> modeFlags, UriPermissionOwner owner)</span> </span>&#123;</span><br><span class="line">    <span class="comment">//【1】判断是否需要 persist 该权限！</span></span><br><span class="line">    <span class="keyword">final</span> <span class="keyword">boolean</span> persistable = (modeFlags &amp; Intent.FLAG_GRANT_PERSISTABLE_URI_PERMISSION) != <span class="number">0</span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//【2】只保留 modeFlags 中的 FLAG_GRANT_READ_URI_PERMISSION 和 FLAG_GRANT_WRITE_URI_PERMISSION 位！</span></span><br><span class="line">    modeFlags &amp;= (Intent.FLAG_GRANT_READ_URI_PERMISSION</span><br><span class="line">            | Intent.FLAG_GRANT_WRITE_URI_PERMISSION);</span><br><span class="line"></span><br><span class="line">    <span class="comment">//【2】如果 intent 设置了 FLAG_GRANT_PERSISTABLE_URI_PERMISSION 标志位；</span></span><br><span class="line">    <span class="comment">// 说明该权限可能需要 persisit 所以设置 persistableModeFlags 标志位</span></span><br><span class="line">    <span class="keyword">if</span> (persistable) &#123;</span><br><span class="line">        persistableModeFlags |= modeFlags;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">//【3】如果 owner 为 null，那么该权限就是一个全局 uri permission！</span></span><br><span class="line">    <span class="comment">// 设置 globalModeFlags 标志位；</span></span><br><span class="line">    <span class="keyword">if</span> (owner == <span class="keyword">null</span>) &#123;</span><br><span class="line">        globalModeFlags |= modeFlags;</span><br><span class="line"></span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        <span class="comment">//【4】如果传入了指定的 owner，那么该权限就不是一个全局 uri permission！</span></span><br><span class="line">        <span class="keyword">if</span> ((modeFlags &amp; Intent.FLAG_GRANT_READ_URI_PERMISSION) != <span class="number">0</span>) &#123;</span><br><span class="line">            <span class="comment">//【*2.3.2.1】添加读权限的拥有者；</span></span><br><span class="line">            addReadOwner(owner);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">if</span> ((modeFlags &amp; Intent.FLAG_GRANT_WRITE_URI_PERMISSION) != <span class="number">0</span>) &#123;</span><br><span class="line">            <span class="comment">//【*2.3.2.2】添加写权限的拥有者；</span></span><br><span class="line">            addWriteOwner(owner);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">//【*2.3.2.3】更新 modeFlags 标志位；</span></span><br><span class="line">    updateModeFlags ();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<ul>
<li><strong>方法流程</strong>：</li>
</ul>
<p>首先，判断是否需要 persist，同时对传入的 modeFlags 作如下处理：<br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">modeFlags &amp;= (Intent.FLAG_GRANT_READ_URI_PERMISSION | Intent.FLAG_GRANT_WRITE_URI_PERMISSION);</span><br></pre></td></tr></table></figure></p>
<p>只保留 modeFlags 中的这两位，也就是说，此时，modeFlags 要么择其一，要么二者都有；</p>
<p>如果 modeFlags 需要 persistable，那么设置 persistableModeFlags；</p>
<p>接着，判断是否指定 UriPermissionOwner：</p>
<ul>
<li>如果没有，那么该权限就是 global 的，更新 globalModeFlags 标志位；</li>
<li>如果有，说明这是一个有指定 owner 的权限，那就添加到如下集合中：</li>
</ul>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">private</span> ArraySet&lt;UriPermissionOwner&gt; mReadOwners; <span class="comment">// 保存所有非全局读权限的拥有者</span></span><br><span class="line"><span class="keyword">private</span> ArraySet&lt;UriPermissionOwner&gt; mWriteOwners; <span class="comment">// 保存所有非全局写权限的拥有者</span></span><br></pre></td></tr></table></figure>
<p>同时，更新 ownedModeFlags 的标志位（只有在初始化的 mReadOwners 和 mWriteOwners，第一次添加 owner 时)</p>
<p>最后，调用 updateModeFlags 更新 modeFlags </p>
<ul>
<li><strong>总结</strong>：</li>
</ul>
<p>其实整个过程就是对传入的 modeFlags 的标志位进行一一拆解，然后保存到 ownedModeFlags | globalModeFlags | persistableModeFlags | persistedModeFlags 中，最后在 updateModeFlags 中，用这几个标志位更新 modeFlags；</p>
<h4 id="2-3-2-1-addReadOwner"><a href="#2-3-2-1-addReadOwner" class="headerlink" title="2.3.2.1 addReadOwner"></a>2.3.2.1 addReadOwner</h4><p>UriPermission 内部方法，，用于添加一个对该 uri 有非全局，读权限的拥有者；<br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">addReadOwner</span><span class="params">(UriPermissionOwner owner)</span> </span>&#123;</span><br><span class="line">    <span class="comment">//【1】初始化 mReadOwners， </span></span><br><span class="line">    <span class="keyword">if</span> (mReadOwners == <span class="keyword">null</span>) &#123;</span><br><span class="line">        mReadOwners = Sets.newArraySet();</span><br><span class="line">        <span class="comment">//【1.1】更新 ownedModeFlags 标志位；</span></span><br><span class="line">        ownedModeFlags |= Intent.FLAG_GRANT_READ_URI_PERMISSION;</span><br><span class="line">        <span class="comment">//【*2.3.2.3】ownedModeFlags 变化了，更新 modeFlags；</span></span><br><span class="line">        updateModeFlags();</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">//【2】建立相互引用关系！</span></span><br><span class="line">    <span class="keyword">if</span> (mReadOwners.add(owner)) &#123;</span><br><span class="line">        owner.addReadPermission(<span class="keyword">this</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>因为 mReadOwners 默认为 null，所以如果有最开始要初始化 mReadOwners，我们可以看到：</p>
<ul>
<li>只有在第一次初始化 mReadOwners 时，才会设置 ownedModeFlags 标志位；</li>
<li>以后在添加新的 owner 时，就不在处理了！</li>
</ul>
<h4 id="2-3-2-2-addWriteOwner"><a href="#2-3-2-2-addWriteOwner" class="headerlink" title="2.3.2.2 addWriteOwner"></a>2.3.2.2 addWriteOwner</h4><p>UriPermission 内部方法，用于添加一个对该 uri 有非全局，写权限的拥有者；</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">addWriteOwner</span><span class="params">(UriPermissionOwner owner)</span> </span>&#123;</span><br><span class="line">    <span class="comment">//【1】初始化 mWriteOwners，</span></span><br><span class="line">    <span class="keyword">if</span> (mWriteOwners == <span class="keyword">null</span>) &#123;</span><br><span class="line">        mWriteOwners = Sets.newArraySet();</span><br><span class="line">        <span class="comment">//【1.1】更新 ownedModeFlags 标志位；</span></span><br><span class="line">        ownedModeFlags |= Intent.FLAG_GRANT_WRITE_URI_PERMISSION;</span><br><span class="line">        <span class="comment">//【*2.3.2.3】ownedModeFlags 变化了，更新 modeFlags；</span></span><br><span class="line">        updateModeFlags();</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">//【2】建立相互引用关系！</span></span><br><span class="line">    <span class="keyword">if</span> (mWriteOwners.add(owner)) &#123;</span><br><span class="line">        owner.addWritePermission(<span class="keyword">this</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>因为 mWriteOwners 默认为 null，所以如果有最开始要初始化 mWriteOwners，我们可以看到：</p>
<ul>
<li>只有在第一次初始化 mWriteOwners 时，才会设置 ownedModeFlags 标志位；</li>
<li>以后在添加新的 owner 时，就不在处理了！</li>
</ul>
<h4 id="2-3-2-3-updateModeFlags"><a href="#2-3-2-3-updateModeFlags" class="headerlink" title="2.3.2.3 updateModeFlags"></a>2.3.2.3 updateModeFlags</h4><p>UriPermission 内部方法，更新 modeFlags 标志位；</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">updateModeFlags</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    <span class="keyword">final</span> <span class="keyword">int</span> oldModeFlags = modeFlags;</span><br><span class="line">    <span class="comment">//【1】可以看到，就是使用其他四个标志位更新 modeFlags！</span></span><br><span class="line">    modeFlags = ownedModeFlags | globalModeFlags | persistableModeFlags | persistedModeFlags;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (Log.isLoggable(TAG, Log.VERBOSE) &amp;&amp; (modeFlags != oldModeFlags)) &#123;</span><br><span class="line">        Slog.d(TAG,</span><br><span class="line">                <span class="string">"Permission for "</span> + targetPkg + <span class="string">" to "</span> + uri + <span class="string">" is changing from 0x"</span></span><br><span class="line">                        + Integer.toHexString(oldModeFlags) + <span class="string">" to 0x"</span></span><br><span class="line">                        + Integer.toHexString(modeFlags),</span><br><span class="line">                <span class="keyword">new</span> Throwable());</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>不多说了！</p>
<h3 id="2-3-3-调用时机"><a href="#2-3-3-调用时机" class="headerlink" title="2.3.3 调用时机"></a>2.3.3 调用时机</h3><ul>
<li>第二个是在 1.2 grantUriPermissionLocked 中调用的；</li>
<li>第二个是在 1.5 grantUriPermissionUncheckedFromIntentLocked 中调用的；</li>
</ul>
<p>可以看出，均是内部调用，因为该方法不做 check 所以，不建议直接调用；</p>
<h2 id="2-4-grantUriPermissionFromIntentLocked"><a href="#2-4-grantUriPermissionFromIntentLocked" class="headerlink" title="2.4 grantUriPermissionFromIntentLocked"></a>2.4 grantUriPermissionFromIntentLocked</h2><p>通过 intent 授予 targetPkg uri permission，该方法会先去 check 看是否需要授予权限：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">grantUriPermissionFromIntentLocked</span><span class="params">(<span class="keyword">int</span> callingUid,</span></span></span><br><span class="line"><span class="function"><span class="params">        String targetPkg, Intent intent, UriPermissionOwner owner, <span class="keyword">int</span> targetUserId)</span> </span>&#123;</span><br><span class="line">    <span class="comment">//【1】检查是否需要授予权限；</span></span><br><span class="line">    NeededUriGrants needed = checkGrantUriPermissionFromIntentLocked(callingUid, targetPkg,</span><br><span class="line">            intent, intent != <span class="keyword">null</span> ? intent.getFlags() : <span class="number">0</span>, <span class="keyword">null</span>, targetUserId);</span><br><span class="line">    <span class="keyword">if</span> (needed == <span class="keyword">null</span>) &#123;</span><br><span class="line">        <span class="comment">//【1.1】如果不需要，那就返回！</span></span><br><span class="line">        <span class="keyword">return</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">//【*2.5】进一步授予 uri pemission；</span></span><br><span class="line">    grantUriPermissionUncheckedFromIntentLocked(needed, owner);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h3 id="2-4-1-调用时机"><a href="#2-4-1-调用时机" class="headerlink" title="2.4.1 调用时机"></a>2.4.1 调用时机</h3><p>我们来看下该方法的调用时机，框架中主要的调用均是在和 activity 启动，finish，已经结果返回相关的地方：</p>
<h4 id="2-4-1-1-finishActivityResultsLocked-ActivityStack"><a href="#2-4-1-1-finishActivityResultsLocked-ActivityStack" class="headerlink" title="2.4.1.1 finishActivityResultsLocked - ActivityStack"></a>2.4.1.1 finishActivityResultsLocked - ActivityStack</h4><p>在退出一个 activity 的时候，如果我们要返回结果给启动者 activity 的时候：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">final</span> <span class="keyword">void</span> <span class="title">finishActivityResultsLocked</span><span class="params">(ActivityRecord r, <span class="keyword">int</span> resultCode, Intent resultData)</span> </span>&#123;</span><br><span class="line">    ActivityRecord resultTo = r.resultTo;</span><br><span class="line">    <span class="keyword">if</span> (resultTo != <span class="keyword">null</span>) &#123;</span><br><span class="line">        <span class="keyword">if</span> (DEBUG_RESULTS) Slog.v(TAG_RESULTS, <span class="string">"Adding result to "</span> + resultTo</span><br><span class="line">                + <span class="string">" who="</span> + r.resultWho + <span class="string">" req="</span> + r.requestCode</span><br><span class="line">                + <span class="string">" res="</span> + resultCode + <span class="string">" data="</span> + resultData);</span><br><span class="line">        <span class="keyword">if</span> (resultTo.userId != r.userId) &#123;</span><br><span class="line">            <span class="keyword">if</span> (resultData != <span class="keyword">null</span>) &#123;</span><br><span class="line">                resultData.prepareToLeaveUser(r.userId);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">//【1】关键点，判断了下启动者 acitivty 的 uid 是否大于 0；</span></span><br><span class="line">        <span class="keyword">if</span> (r.info.applicationInfo.uid &gt; <span class="number">0</span>) &#123;</span><br><span class="line">            <span class="comment">//【*2.4】授予启动者 acitivty 访问 uri 的权限，传入的 callingUid 是被启动的 activity 的 uid；</span></span><br><span class="line">            <span class="comment">//【*2.4.1.3.1】获得 activity 对应的 UriPermissionsOwner；</span></span><br><span class="line">            mService.grantUriPermissionFromIntentLocked(r.info.applicationInfo.uid,</span><br><span class="line">                    resultTo.packageName, resultData,</span><br><span class="line">                    resultTo.getUriPermissionsLocked(), resultTo.userId);</span><br><span class="line">        &#125;</span><br><span class="line">        resultTo.addResultLocked(r, r.resultWho, r.requestCode, resultCode,</span><br><span class="line">                                 resultData);</span><br><span class="line">        r.resultTo = <span class="keyword">null</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">else</span> <span class="keyword">if</span> (DEBUG_RESULTS) Slog.v(TAG_RESULTS, <span class="string">"No result destination from "</span> + r);</span><br><span class="line">    </span><br><span class="line">    r.results = <span class="keyword">null</span>;</span><br><span class="line">    r.pendingResults = <span class="keyword">null</span>;</span><br><span class="line">    r.newIntents = <span class="keyword">null</span>;</span><br><span class="line">    r.icicle = <span class="keyword">null</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h4 id="2-4-1-2-sendActivityResultLocked-ActivityStack"><a href="#2-4-1-2-sendActivityResultLocked-ActivityStack" class="headerlink" title="2.4.1.2 sendActivityResultLocked  - ActivityStack"></a>2.4.1.2 sendActivityResultLocked  - ActivityStack</h4><p>发送启动返回结果给 activity：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">sendActivityResultLocked</span><span class="params">(<span class="keyword">int</span> callingUid, ActivityRecord r,</span></span></span><br><span class="line"><span class="function"><span class="params">        String resultWho, <span class="keyword">int</span> requestCode, <span class="keyword">int</span> resultCode, Intent data)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">if</span> (callingUid &gt; <span class="number">0</span>) &#123;</span><br><span class="line">        <span class="comment">//【*2.4】授予 acitivty 访问 uri 的权限！</span></span><br><span class="line">        <span class="comment">//【*2.4.1.3.1】获得 activity 对应的 UriPermissionsOwner；</span></span><br><span class="line">        mService.grantUriPermissionFromIntentLocked(callingUid, r.packageName,</span><br><span class="line">                data, r.getUriPermissionsLocked(), r.userId);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (DEBUG_RESULTS) Slog.v(TAG, <span class="string">"Send activity result to "</span> + r</span><br><span class="line">            + <span class="string">" : who="</span> + resultWho + <span class="string">" req="</span> + requestCode</span><br><span class="line">            + <span class="string">" res="</span> + resultCode + <span class="string">" data="</span> + data);</span><br><span class="line">    <span class="keyword">if</span> (mResumedActivity == r &amp;&amp; r.app != <span class="keyword">null</span> &amp;&amp; r.app.thread != <span class="keyword">null</span>) &#123;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            ArrayList&lt;ResultInfo&gt; list = <span class="keyword">new</span> ArrayList&lt;ResultInfo&gt;();</span><br><span class="line">            list.add(<span class="keyword">new</span> ResultInfo(resultWho, requestCode,</span><br><span class="line">                    resultCode, data));</span><br><span class="line">            <span class="comment">//【1】发送启动结果！</span></span><br><span class="line">            r.app.thread.scheduleSendResult(r.appToken, list);</span><br><span class="line">            <span class="keyword">return</span>;</span><br><span class="line">        &#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">            Slog.w(TAG, <span class="string">"Exception thrown sending result to "</span> + r, e);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    r.addResultLocked(<span class="keyword">null</span>, resultWho, requestCode, resultCode, data);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>不多说了！</p>
<h4 id="2-4-1-3-deliverNewIntentLocked-ActivityRecord"><a href="#2-4-1-3-deliverNewIntentLocked-ActivityRecord" class="headerlink" title="2.4.1.3 deliverNewIntentLocked  - ActivityRecord"></a>2.4.1.3 deliverNewIntentLocked  - ActivityRecord</h4><p>该方法会拉起一个 activity 的 onNewIntent 方法：<br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">final</span> <span class="keyword">void</span> <span class="title">deliverNewIntentLocked</span><span class="params">(<span class="keyword">int</span> callingUid, Intent intent, String referrer)</span> </span>&#123;</span><br><span class="line">    <span class="comment">//【*2.4】授予要启动的 activity 访问 intent 中 uri 的权限！</span></span><br><span class="line">    <span class="comment">//【*2.4.1.3.1】获得 activity 对应的 UriPermissionsOwner</span></span><br><span class="line">    service.grantUriPermissionFromIntentLocked(callingUid, packageName,</span><br><span class="line">            intent, getUriPermissionsLocked(), userId);</span><br><span class="line">    <span class="keyword">final</span> ReferrerIntent rintent = <span class="keyword">new</span> ReferrerIntent(intent, referrer);</span><br><span class="line">    <span class="keyword">boolean</span> unsent = <span class="keyword">true</span>;</span><br><span class="line">    <span class="keyword">final</span> ActivityStack stack = task.stack;</span><br><span class="line">    <span class="keyword">final</span> <span class="keyword">boolean</span> isTopActivityInStack =</span><br><span class="line">            stack != <span class="keyword">null</span> &amp;&amp; stack.topRunningActivityLocked() == <span class="keyword">this</span>;</span><br><span class="line">    <span class="keyword">final</span> <span class="keyword">boolean</span> isTopActivityWhileSleeping =</span><br><span class="line">            service.isSleepingLocked() &amp;&amp; isTopActivityInStack;</span><br><span class="line">    <span class="keyword">if</span> ((state == ActivityState.RESUMED || state == ActivityState.PAUSED</span><br><span class="line">            || isTopActivityWhileSleeping) &amp;&amp; app != <span class="keyword">null</span> &amp;&amp; app.thread != <span class="keyword">null</span>) &#123;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            ArrayList&lt;ReferrerIntent&gt; ar = <span class="keyword">new</span> ArrayList&lt;&gt;(<span class="number">1</span>);</span><br><span class="line">            ar.add(rintent);</span><br><span class="line">            <span class="comment">//【1】拉起 onNewIntent 方法：</span></span><br><span class="line">            app.thread.scheduleNewIntent(</span><br><span class="line">                    ar, appToken, state == ActivityState.PAUSED <span class="comment">/* andPause */</span>);</span><br><span class="line">            unsent = <span class="keyword">false</span>;</span><br><span class="line">        &#125; <span class="keyword">catch</span> (RemoteException e) &#123;</span><br><span class="line">            Slog.w(TAG, <span class="string">"Exception thrown sending new intent to "</span> + <span class="keyword">this</span>, e);</span><br><span class="line">        &#125; <span class="keyword">catch</span> (NullPointerException e) &#123;</span><br><span class="line">            Slog.w(TAG, <span class="string">"Exception thrown sending new intent to "</span> + <span class="keyword">this</span>, e);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span> (unsent) &#123;</span><br><span class="line">        addNewIntentLocked(rintent);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<h5 id="2-4-1-3-1-getUriPermissionsLocked"><a href="#2-4-1-3-1-getUriPermissionsLocked" class="headerlink" title="2.4.1.3.1 getUriPermissionsLocked"></a>2.4.1.3.1 getUriPermissionsLocked</h5><p>同样的，ActivityRecord 内部也有一个 getUriPermissionsLocked 方法，用来获得其对应的 UriPermissionOwner 实例：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="function">UriPermissionOwner <span class="title">getUriPermissionsLocked</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    <span class="keyword">if</span> (uriPermissions == <span class="keyword">null</span>) &#123;</span><br><span class="line">        <span class="comment">//【*2.6.1.1】创建一个新的 UriPermissionOwner 实例！                                                               </span></span><br><span class="line">        uriPermissions = <span class="keyword">new</span> UriPermissionOwner(service, <span class="keyword">this</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> uriPermissions;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h4 id="2-4-1-4-startActivityUnchecked-ActivityStarter"><a href="#2-4-1-4-startActivityUnchecked-ActivityStarter" class="headerlink" title="2.4.1.4 startActivityUnchecked - ActivityStarter"></a>2.4.1.4 startActivityUnchecked - ActivityStarter</h4><p>在启动一个新的 acitivity 的时候：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">int</span> <span class="title">startActivityUnchecked</span><span class="params">(<span class="keyword">final</span> ActivityRecord r, ActivityRecord sourceRecord,</span></span></span><br><span class="line"><span class="function"><span class="params">        IVoiceInteractionSession voiceSession, IVoiceInteractor voiceInteractor,</span></span></span><br><span class="line"><span class="function"><span class="params">        <span class="keyword">int</span> startFlags, <span class="keyword">boolean</span> doResume, ActivityOptions options, TaskRecord inTask)</span> </span>&#123;</span><br><span class="line">    setInitialState(r, options, inTask, doResume, startFlags, sourceRecord, voiceSession,</span><br><span class="line">            voiceInteractor);</span><br><span class="line">    computeLaunchingTaskFlags();</span><br><span class="line">    computeSourceStack();</span><br><span class="line">    mIntent.setFlags(mLaunchFlags);</span><br><span class="line">    mReusedActivity = getReusableIntentActivity();</span><br><span class="line">    <span class="keyword">final</span> <span class="keyword">int</span> preferredLaunchStackId =</span><br><span class="line">            (mOptions != <span class="keyword">null</span>) ? mOptions.getLaunchStackId() : INVALID_STACK_ID;</span><br><span class="line"></span><br><span class="line">    ... ... ...</span><br><span class="line"></span><br><span class="line">    <span class="comment">//【*2.4】授予要启动的 activity 访问 intent 中 uri 的权限！</span></span><br><span class="line">    <span class="comment">//【*2.4.1.3.1】获得 activity 对应的 UriPermissionsOwner</span></span><br><span class="line">    mService.grantUriPermissionFromIntentLocked(mCallingUid, mStartActivity.packageName,</span><br><span class="line">            mIntent, mStartActivity.getUriPermissionsLocked(), mStartActivity.userId);</span><br><span class="line"></span><br><span class="line">    ... ... ...</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> START_SUCCESS;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>不多说了！</p>
<h2 id="2-5-grantUriPermissionUncheckedFromIntentLocked"><a href="#2-5-grantUriPermissionUncheckedFromIntentLocked" class="headerlink" title="2.5 grantUriPermissionUncheckedFromIntentLocked"></a>2.5 grantUriPermissionUncheckedFromIntentLocked</h2><p>通过 intent 授予 uri permission，但是该方法不会 check 是否需要授予权限，所以尽量不要直接调用这个函数；</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">grantUriPermissionUncheckedFromIntentLocked</span><span class="params">(NeededUriGrants needed,</span></span></span><br><span class="line"><span class="function"><span class="params">        UriPermissionOwner owner)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">if</span> (needed != <span class="keyword">null</span>) &#123;</span><br><span class="line">        <span class="keyword">for</span> (<span class="keyword">int</span> i=<span class="number">0</span>; i&lt;needed.size(); i++) &#123;</span><br><span class="line">            GrantUri grantUri = needed.get(i);</span><br><span class="line">            <span class="comment">//【*2.3】调用了 grantUriPermissionUncheckedLocked 方法，继续授予！</span></span><br><span class="line">            grantUriPermissionUncheckedLocked(needed.targetUid, needed.targetPkg,</span><br><span class="line">                    grantUri, needed.flags, owner);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>首先遍历所有的 GrantUri，处理每一个 GrantUri 的授予！</p>
<h3 id="2-5-1-调用时机"><a href="#2-5-1-调用时机" class="headerlink" title="2.5.1 调用时机"></a>2.5.1 调用时机</h3><h4 id="2-5-1-1-sendServiceArgsLocked"><a href="#2-5-1-1-sendServiceArgsLocked" class="headerlink" title="2.5.1.1 sendServiceArgsLocked"></a>2.5.1.1 sendServiceArgsLocked</h4><p>在我们启动 Service 的时候，我们会将启动参数 StartItems 发送给 Service：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">final</span> <span class="keyword">void</span> <span class="title">sendServiceArgsLocked</span><span class="params">(ServiceRecord r, <span class="keyword">boolean</span> execInFg,</span></span></span><br><span class="line"><span class="function"><span class="params">        <span class="keyword">boolean</span> oomAdjusted)</span> <span class="keyword">throws</span> TransactionTooLargeException </span>&#123;</span><br><span class="line">    <span class="keyword">final</span> <span class="keyword">int</span> N = r.pendingStarts.size();</span><br><span class="line">    <span class="keyword">if</span> (N == <span class="number">0</span>) &#123;</span><br><span class="line">        <span class="keyword">return</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">//【1】如果 Service 有等待处理的启动项目！</span></span><br><span class="line">    <span class="keyword">while</span> (r.pendingStarts.size() &gt; <span class="number">0</span>) &#123;</span><br><span class="line">        Exception caughtException = <span class="keyword">null</span>;</span><br><span class="line">        ServiceRecord.StartItem si = <span class="keyword">null</span>;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            si = r.pendingStarts.remove(<span class="number">0</span>);</span><br><span class="line">            <span class="keyword">if</span> (DEBUG_SERVICE) Slog.v(TAG_SERVICE, <span class="string">"Sending arguments to: "</span></span><br><span class="line">                    + r + <span class="string">" "</span> + r.intent + <span class="string">" args="</span> + si.intent);</span><br><span class="line">            <span class="keyword">if</span> (si.intent == <span class="keyword">null</span> &amp;&amp; N &gt; <span class="number">1</span>) &#123;</span><br><span class="line">                <span class="keyword">continue</span>;</span><br><span class="line">            &#125;</span><br><span class="line">            si.deliveredTime = SystemClock.uptimeMillis();</span><br><span class="line">            r.deliveredStarts.add(si);</span><br><span class="line">            si.deliveryCount++;</span><br><span class="line">            <span class="comment">//【1】关键地方是在这里，如果启动项有 neededGrants，那么会授予被启动这 uri permission！</span></span><br><span class="line">            <span class="keyword">if</span> (si.neededGrants != <span class="keyword">null</span>) &#123;</span><br><span class="line">                <span class="comment">//【*2.5】授予 uri 权限！</span></span><br><span class="line">                <span class="comment">//【*2.5.1.2】通过 StartItem 创建一个新的 UriPermissionOwner 实例！</span></span><br><span class="line">                mAm.grantUriPermissionUncheckedFromIntentLocked(si.neededGrants,</span><br><span class="line">                        si.getUriPermissionsLocked());</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="comment">//【2】超时处理；</span></span><br><span class="line">            bumpServiceExecutingLocked(r, execInFg, <span class="string">"start"</span>);</span><br><span class="line">            <span class="keyword">if</span> (!oomAdjusted) &#123;</span><br><span class="line">                oomAdjusted = <span class="keyword">true</span>;</span><br><span class="line">                mAm.updateOomAdjLocked(r.app);</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">int</span> flags = <span class="number">0</span>;</span><br><span class="line">            <span class="keyword">if</span> (si.deliveryCount &gt; <span class="number">1</span>) &#123;</span><br><span class="line">                flags |= Service.START_FLAG_RETRY;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">if</span> (si.doneExecutingCount &gt; <span class="number">0</span>) &#123;</span><br><span class="line">                flags |= Service.START_FLAG_REDELIVERY;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="comment">//【3】启动服务！</span></span><br><span class="line">            r.app.thread.scheduleServiceArgs(r, si.taskRemoved, si.id, flags, si.intent);</span><br><span class="line">        &#125; <span class="keyword">catch</span> (TransactionTooLargeException e) &#123;</span><br><span class="line">            <span class="keyword">if</span> (DEBUG_SERVICE) Slog.v(TAG_SERVICE, <span class="string">"Transaction too large: intent="</span></span><br><span class="line">                    + si.intent);</span><br><span class="line">            caughtException = e;</span><br><span class="line">        &#125; <span class="keyword">catch</span> (RemoteException e) &#123;</span><br><span class="line">            <span class="comment">// Remote process gone...  we'll let the normal cleanup take care of this.</span></span><br><span class="line">            <span class="keyword">if</span> (DEBUG_SERVICE) Slog.v(TAG_SERVICE, <span class="string">"Crashed while sending args: "</span> + r);</span><br><span class="line">            caughtException = e;</span><br><span class="line">        &#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">            Slog.w(TAG, <span class="string">"Unexpected exception"</span>, e);</span><br><span class="line">            caughtException = e;</span><br><span class="line">        &#125;</span><br><span class="line">        ... ... ... ...</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>逻辑很简单，不多说了！</p>
<h4 id="2-5-1-2-StartItem-getUriPermissionsLocked"><a href="#2-5-1-2-StartItem-getUriPermissionsLocked" class="headerlink" title="2.5.1.2 StartItem.getUriPermissionsLocked"></a>2.5.1.2 StartItem.getUriPermissionsLocked</h4><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="function">UriPermissionOwner <span class="title">getUriPermissionsLocked</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    <span class="keyword">if</span> (uriPermissions == <span class="keyword">null</span>) &#123;</span><br><span class="line">        <span class="comment">//【*2.6.1.1】新建一个 UriPermissionOwner 实例！</span></span><br><span class="line">        uriPermissions = <span class="keyword">new</span> UriPermissionOwner(sr.ams, <span class="keyword">this</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> uriPermissions;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h2 id="2-6-grantUriPermissionFromOwner"><a href="#2-6-grantUriPermissionFromOwner" class="headerlink" title="2.6 grantUriPermissionFromOwner"></a>2.6 grantUriPermissionFromOwner</h2><p>授予 UriPermissionOwner owner 访问 uri 的 permission，这里的 UriPermissionOwner 是通过 IBinder token 转换而来！</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">grantUriPermissionFromOwner</span><span class="params">(IBinder token, <span class="keyword">int</span> fromUid, String targetPkg, Uri uri,</span></span></span><br><span class="line"><span class="function"><span class="params">        <span class="keyword">final</span> <span class="keyword">int</span> modeFlags, <span class="keyword">int</span> sourceUserId, <span class="keyword">int</span> targetUserId)</span> </span>&#123;</span><br><span class="line">    <span class="comment">//【1】计算下 targetUserId！</span></span><br><span class="line">    targetUserId = mUserController.handleIncomingUser(Binder.getCallingPid(),</span><br><span class="line">            Binder.getCallingUid(), targetUserId, <span class="keyword">false</span>, ALLOW_FULL_ONLY,</span><br><span class="line">            <span class="string">"grantUriPermissionFromOwner"</span>, <span class="keyword">null</span>);</span><br><span class="line">    <span class="keyword">synchronized</span>(<span class="keyword">this</span>) &#123;</span><br><span class="line">        <span class="comment">//【*2.6.1.3】通过 token 找到对应的 UriPermissionOwner，如果没有就会抛出异常！</span></span><br><span class="line">        UriPermissionOwner owner = UriPermissionOwner.fromExternalToken(token);</span><br><span class="line">        <span class="keyword">if</span> (owner == <span class="keyword">null</span>) &#123;</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> IllegalArgumentException(<span class="string">"Unknown owner: "</span> + token);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">//【1.1】fromUid 表示该 grant 操作来自哪个 uid；</span></span><br><span class="line">        <span class="comment">// Binder.getCallingUid() 表示调用该方法的 uid，一般情况 fromUid 和 callingUid 应该是一样的；</span></span><br><span class="line">        <span class="comment">// 如果不一样，callingUid 必须是 system uid！</span></span><br><span class="line">        <span class="keyword">if</span> (fromUid != Binder.getCallingUid()) &#123;</span><br><span class="line">            <span class="keyword">if</span> (Binder.getCallingUid() != Process.myUid()) &#123;</span><br><span class="line">                <span class="keyword">throw</span> <span class="keyword">new</span> SecurityException(<span class="string">"nice try"</span>);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">if</span> (targetPkg == <span class="keyword">null</span>) &#123;</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> IllegalArgumentException(<span class="string">"null target"</span>);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">if</span> (uri == <span class="keyword">null</span>) &#123;</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> IllegalArgumentException(<span class="string">"null uri"</span>);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">//【*2.2】继续处理 grant 操作！</span></span><br><span class="line">        grantUriPermissionLocked(fromUid, targetPkg, <span class="keyword">new</span> GrantUri(sourceUserId, uri, <span class="keyword">false</span>),</span><br><span class="line">                modeFlags, owner, targetUserId);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>可以看到，grantUriPermissionFromOwner 可以提供跨进程的支持，也就是说应用程序可以通过 grantUriPermissionFromOwner 来授予其他应用 uri 权限；</p>
<p>同时，我们还看到要调用该方法，必须要存在一个 UriPermissionOwner，我们去看下如何创建一个 UriPermissionOwner：</p>
<h3 id="2-6-1-newUriPermissionOwner"><a href="#2-6-1-newUriPermissionOwner" class="headerlink" title="2.6.1 newUriPermissionOwner"></a>2.6.1 newUriPermissionOwner</h3><p>同样的，AMS 提供了一个 newUriPermissionOwner 方法，来实现创建一个新的 UriPermissionOwner，其支持跨进程调用：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> IBinder <span class="title">newUriPermissionOwner</span><span class="params">(String name)</span> </span>&#123;</span><br><span class="line">    enforceNotIsolatedCaller(<span class="string">"newUriPermissionOwner"</span>);</span><br><span class="line">    <span class="keyword">synchronized</span>(<span class="keyword">this</span>) &#123;</span><br><span class="line">        <span class="comment">//【*2.6.1.1】创建一个新的 UriPermissionOwner；</span></span><br><span class="line">        UriPermissionOwner owner = <span class="keyword">new</span> UriPermissionOwner(<span class="keyword">this</span>, name);</span><br><span class="line">        <span class="comment">//【*2.6.1.2】返回一个新的</span></span><br><span class="line">        <span class="keyword">return</span> owner.getExternalTokenLocked();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h4 id="2-6-1-1-new-UriPermissionOwner"><a href="#2-6-1-1-new-UriPermissionOwner" class="headerlink" title="2.6.1.1 new UriPermissionOwner"></a>2.6.1.1 new UriPermissionOwner</h4><p>新建一个 UriPermissionOwner 实例：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">final</span> <span class="class"><span class="keyword">class</span> <span class="title">UriPermissionOwner</span> </span>&#123;</span><br><span class="line">    <span class="keyword">final</span> ActivityManagerService service; <span class="comment">// ams 对象！</span></span><br><span class="line">    <span class="keyword">final</span> Object owner; <span class="comment">// 用于表示所有者，</span></span><br><span class="line"></span><br><span class="line">    Binder externalToken; <span class="comment">// 用于 token，跨进程的表示同一个 owner</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> ArraySet&lt;UriPermission&gt; mReadPerms; <span class="comment">// 该 owner 持有的所有的 read uri permission</span></span><br><span class="line">    <span class="keyword">private</span> ArraySet&lt;UriPermission&gt; mWritePerms; <span class="comment">// 该 owner 持有的所有的 write uri permission</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">// 内部类，用于初始化 externalToken！</span></span><br><span class="line">    <span class="class"><span class="keyword">class</span> <span class="title">ExternalToken</span> <span class="keyword">extends</span> <span class="title">Binder</span> </span>&#123;</span><br><span class="line">        <span class="function">UriPermissionOwner <span class="title">getOwner</span><span class="params">()</span> </span>&#123;</span><br><span class="line">            <span class="keyword">return</span> UriPermissionOwner.<span class="keyword">this</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    UriPermissionOwner(ActivityManagerService service, Object owner) &#123;</span><br><span class="line">        <span class="keyword">this</span>.service = service;</span><br><span class="line">        <span class="keyword">this</span>.owner = owner;</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure>
<h4 id="2-6-1-2-getExternalTokenLocked"><a href="#2-6-1-2-getExternalTokenLocked" class="headerlink" title="2.6.1.2 getExternalTokenLocked"></a>2.6.1.2 getExternalTokenLocked</h4><p>返回 UriPermissionOwner 的 Binder 对象 token：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="function">Binder <span class="title">getExternalTokenLocked</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    <span class="keyword">if</span> (externalToken == <span class="keyword">null</span>) &#123;</span><br><span class="line">        externalToken = <span class="keyword">new</span> ExternalToken();</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> externalToken;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>不多说了！</p>
<h4 id="2-6-1-3-fromExternalToken"><a href="#2-6-1-3-fromExternalToken" class="headerlink" title="2.6.1.3 fromExternalToken"></a>2.6.1.3 fromExternalToken</h4><p>UriPermissionOwner 有一个方法，通过 token 找到对应的 UriPermissionOwner 实例：<br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">static</span> UriPermissionOwner <span class="title">fromExternalToken</span><span class="params">(IBinder token)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">if</span> (token <span class="keyword">instanceof</span> ExternalToken) &#123;</span><br><span class="line">        <span class="keyword">return</span> ((ExternalToken)token).getOwner();</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">null</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>不多说了！</p>
<h3 id="2-6-2-调用时机"><a href="#2-6-2-调用时机" class="headerlink" title="2.6.2 调用时机"></a>2.6.2 调用时机</h3><p>我们来看下该方法的具体调用，用 VoiceInteraction 举个例子！</p>
<h4 id="2-6-2-1-new-VoiceInteractionSessionConnection"><a href="#2-6-2-1-new-VoiceInteractionSessionConnection" class="headerlink" title="2.6.2.1 new VoiceInteractionSessionConnection"></a>2.6.2.1 new VoiceInteractionSessionConnection</h4><p>首先，在创建 VoiceInteractionSessionConnection 时，我们为这个 ComponentName component 对应的组件创建了一个 UriPermissionOwner，并返回了其 Binder token！</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="title">VoiceInteractionSessionConnection</span><span class="params">(Object lock, ComponentName component, <span class="keyword">int</span> user,</span></span></span><br><span class="line"><span class="function"><span class="params">        Context context, Callback callback, <span class="keyword">int</span> callingUid, Handler handler)</span> </span>&#123;</span><br><span class="line">    mLock = lock;</span><br><span class="line">    mSessionComponentName = component;</span><br><span class="line">    mUser = user;</span><br><span class="line">    mContext = context;</span><br><span class="line">    mCallback = callback;</span><br><span class="line">    mCallingUid = callingUid;</span><br><span class="line">    mHandler = handler;</span><br><span class="line">    mAm = ActivityManagerNative.getDefault();</span><br><span class="line">    ... ... ...</span><br><span class="line">    IBinder permOwner = <span class="keyword">null</span>;</span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">        <span class="comment">//【1】为这个 ComponentName component 对应的组件创建了一个 UriPermissionOwner，</span></span><br><span class="line">        <span class="comment">// 并返回了其 Binder token！</span></span><br><span class="line">        permOwner = mAm.newUriPermissionOwner(<span class="string">"voicesession:"</span></span><br><span class="line">                + component.flattenToShortString());</span><br><span class="line">    &#125; <span class="keyword">catch</span> (RemoteException e) &#123;</span><br><span class="line">        Slog.w(<span class="string">"voicesession"</span>, <span class="string">"AM dead"</span>, e);</span><br><span class="line">    &#125;</span><br><span class="line">    mPermissionOwner = permOwner;</span><br><span class="line">    ... ... ...</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h4 id="2-6-2-2-deliverSessionDataLocked-VoiceInteractionSessionConnection"><a href="#2-6-2-2-deliverSessionDataLocked-VoiceInteractionSessionConnection" class="headerlink" title="2.6.2.2 deliverSessionDataLocked - VoiceInteractionSessionConnection"></a>2.6.2.2 deliverSessionDataLocked - VoiceInteractionSessionConnection</h4><p>在 VoiceInteractionSessionConnection 的 deliverSessionDataLocked 分发语音事务是，会授予 uri permission！</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">deliverSessionDataLocked</span><span class="params">(AssistDataForActivity assistDataForActivity)</span> </span>&#123;</span><br><span class="line">    Bundle assistData = assistDataForActivity.data.getBundle(</span><br><span class="line">            VoiceInteractionSession.KEY_DATA);</span><br><span class="line">    AssistStructure structure = assistDataForActivity.data.getParcelable(</span><br><span class="line">            VoiceInteractionSession.KEY_STRUCTURE);</span><br><span class="line">    AssistContent content = assistDataForActivity.data.getParcelable(</span><br><span class="line">            VoiceInteractionSession.KEY_CONTENT);</span><br><span class="line">    <span class="keyword">int</span> uid = assistDataForActivity.data.getInt(Intent.EXTRA_ASSIST_UID, -<span class="number">1</span>);</span><br><span class="line">    <span class="keyword">if</span> (uid &gt;= <span class="number">0</span> &amp;&amp; content != <span class="keyword">null</span>) &#123;</span><br><span class="line">        Intent intent = content.getIntent();</span><br><span class="line">        <span class="keyword">if</span> (intent != <span class="keyword">null</span>) &#123;</span><br><span class="line">            ClipData data = intent.getClipData();</span><br><span class="line">            <span class="keyword">if</span> (data != <span class="keyword">null</span> &amp;&amp; Intent.isAccessUriMode(intent.getFlags())) &#123;</span><br><span class="line">                <span class="comment">//【1】授予权限！</span></span><br><span class="line">                grantClipDataPermissions(data, intent.getFlags(), uid,</span><br><span class="line">                        mCallingUid, mSessionComponentName.getPackageName());</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        ClipData data = content.getClipData();</span><br><span class="line">        <span class="keyword">if</span> (data != <span class="keyword">null</span>) &#123;</span><br><span class="line">            <span class="comment">//【1】授予权限！</span></span><br><span class="line">            grantClipDataPermissions(data,</span><br><span class="line">                    Intent.FLAG_GRANT_READ_URI_PERMISSION,</span><br><span class="line">                    uid, mCallingUid, mSessionComponentName.getPackageName());</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">        mSession.handleAssist(assistData, structure, content,</span><br><span class="line">                assistDataForActivity.activityIndex, assistDataForActivity.activityCount);</span><br><span class="line">    &#125; <span class="keyword">catch</span> (RemoteException e) &#123;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>这里我们省略掉中间过程，大家可以请自去看源码：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">grantClipDataPermissions(...)  -&gt; grantClipDataItemPermission(...) -&gt; grantUriPermission(...)</span><br></pre></td></tr></table></figure>
<h4 id="2-6-2-3-grantUriPermission-VoiceInteractionSessionConnection"><a href="#2-6-2-3-grantUriPermission-VoiceInteractionSessionConnection" class="headerlink" title="2.6.2.3 grantUriPermission - VoiceInteractionSessionConnection"></a>2.6.2.3 grantUriPermission - VoiceInteractionSessionConnection</h4><p>grant 指定的 uid uri permission：<br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">grantUriPermission</span><span class="params">(Uri uri, <span class="keyword">int</span> mode, <span class="keyword">int</span> srcUid, <span class="keyword">int</span> destUid, String destPkg)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">if</span> (!<span class="string">"content"</span>.equals(uri.getScheme())) &#123;</span><br><span class="line">        <span class="keyword">return</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">long</span> ident = Binder.clearCallingIdentity();</span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">        <span class="comment">//【1】这里首先检查了 srcUid 是否已经有权限，这里我们在 check 的时候有讲过！</span></span><br><span class="line">        <span class="comment">// 如果该方法不抛出异常，那就可以 grant！</span></span><br><span class="line">        mAm.checkGrantUriPermission(srcUid, <span class="keyword">null</span>, ContentProvider.getUriWithoutUserId(uri),</span><br><span class="line">                mode, ContentProvider.getUserIdFromUri(uri, UserHandle.getUserId(srcUid)));</span><br><span class="line"></span><br><span class="line">        <span class="keyword">int</span> sourceUserId = ContentProvider.getUserIdFromUri(uri, mUser);</span><br><span class="line">        uri = ContentProvider.getUriWithoutUserId(uri);</span><br><span class="line"></span><br><span class="line">        <span class="comment">//【*1.6】授予 uri 权限！</span></span><br><span class="line">        mAm.grantUriPermissionFromOwner(mPermissionOwner, srcUid, destPkg,</span><br><span class="line">                uri, Intent.FLAG_GRANT_READ_URI_PERMISSION, sourceUserId, mUser);</span><br><span class="line">    &#125; <span class="keyword">catch</span> (RemoteException e) &#123;</span><br><span class="line">    &#125; <span class="keyword">catch</span> (SecurityException e) &#123;</span><br><span class="line">        Slog.w(TAG, <span class="string">"Can't propagate permission"</span>, e);</span><br><span class="line">    &#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">        Binder.restoreCallingIdentity(ident);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>这里传入的 mPermissionOwner 是我们前面创建的 Binder token！</p>
<h3 id="2-6-3-跨进程通信"><a href="#2-6-3-跨进程通信" class="headerlink" title="2.6.3 跨进程通信"></a>2.6.3 跨进程通信</h3><p>ActivityManagerProxy 中提供了相关的接口：</p>
<ul>
<li><strong>ActivityManagerProxy</strong></li>
</ul>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">grantUriPermissionFromOwner</span><span class="params">(IBinder owner, <span class="keyword">int</span> fromUid, String targetPkg,</span></span></span><br><span class="line"><span class="function"><span class="params">        Uri uri, <span class="keyword">int</span> mode, <span class="keyword">int</span> sourceUserId, <span class="keyword">int</span> targetUserId)</span> <span class="keyword">throws</span> RemoteException </span>&#123;</span><br><span class="line">    Parcel data = Parcel.obtain();</span><br><span class="line">    Parcel reply = Parcel.obtain();</span><br><span class="line">    data.writeInterfaceToken(IActivityManager.descriptor);</span><br><span class="line">    data.writeStrongBinder(owner);</span><br><span class="line">    data.writeInt(fromUid);</span><br><span class="line">    data.writeString(targetPkg);</span><br><span class="line">    uri.writeToParcel(data, <span class="number">0</span>);</span><br><span class="line">    data.writeInt(mode);</span><br><span class="line">    data.writeInt(sourceUserId);</span><br><span class="line">    data.writeInt(targetUserId);</span><br><span class="line">    <span class="comment">//【1】这里我改正了错误：</span></span><br><span class="line">    mRemote.transact(GRANT_URI_PERMISSION_FROM_OWNER_TRANSACTION, data, reply, <span class="number">0</span>);</span><br><span class="line">    reply.readException();</span><br><span class="line">    data.recycle();</span><br><span class="line">    reply.recycle();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>7.1.1 的源码有一个问题：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">GRANT_URI_PERMISSION_FROM_OWNER_TRANSACTION 被写成了 GRANT_URI_PERMISSION_TRANSACTION</span><br></pre></td></tr></table></figure>
<p>我个人觉得是一个错误！</p>
<ul>
<li><strong>ActivityManagerNative</strong></li>
</ul>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">case</span> GRANT_URI_PERMISSION_FROM_OWNER_TRANSACTION: &#123;</span><br><span class="line">    data.enforceInterface(IActivityManager.descriptor);</span><br><span class="line">    IBinder owner = data.readStrongBinder();</span><br><span class="line">    <span class="keyword">int</span> fromUid = data.readInt();</span><br><span class="line">    String targetPkg = data.readString();</span><br><span class="line">    Uri uri = Uri.CREATOR.createFromParcel(data);</span><br><span class="line">    <span class="keyword">int</span> mode = data.readInt();</span><br><span class="line">    <span class="keyword">int</span> sourceUserId = data.readInt();</span><br><span class="line">    <span class="keyword">int</span> targetUserId = data.readInt();</span><br><span class="line">    grantUriPermissionFromOwner(owner, fromUid, targetPkg, uri, mode, sourceUserId,</span><br><span class="line">            targetUserId);</span><br><span class="line">    reply.writeNoException();</span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">true</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h1 id="3-grantPermission-PackageManagerService"><a href="#3-grantPermission-PackageManagerService" class="headerlink" title="3 grantPermission - PackageManagerService"></a>3 grantPermission - PackageManagerService</h1><p>权限的授予核心接口是在 PackageManagerService 中，包括运行时和安装时权限：</p>
<h2 id="3-1-grantPermissionsLPw-权限更新时调用重新授予"><a href="#3-1-grantPermissionsLPw-权限更新时调用重新授予" class="headerlink" title="3.1 grantPermissionsLPw - 权限更新时调用重新授予"></a>3.1 grantPermissionsLPw - 权限更新时调用重新授予</h2><p>在更新过权限后，会再次授予应用权限，因为可能有些权限已经失效并且被移除！</p>
<p>这里的 replace 为 true，由于我们是更新所有的 pacakge，所以 packageOfInterest 均为 null，参数 pkg 是需要更新权限授予信息的应用！</p>
<p>该方法主要是在 updatePermissionsLPw 方法</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br><span class="line">212</span><br><span class="line">213</span><br><span class="line">214</span><br><span class="line">215</span><br><span class="line">216</span><br><span class="line">217</span><br><span class="line">218</span><br><span class="line">219</span><br><span class="line">220</span><br><span class="line">221</span><br><span class="line">222</span><br><span class="line">223</span><br><span class="line">224</span><br><span class="line">225</span><br><span class="line">226</span><br><span class="line">227</span><br><span class="line">228</span><br><span class="line">229</span><br><span class="line">230</span><br><span class="line">231</span><br><span class="line">232</span><br><span class="line">233</span><br><span class="line">234</span><br><span class="line">235</span><br><span class="line">236</span><br><span class="line">237</span><br><span class="line">238</span><br><span class="line">239</span><br><span class="line">240</span><br><span class="line">241</span><br><span class="line">242</span><br><span class="line">243</span><br><span class="line">244</span><br><span class="line">245</span><br><span class="line">246</span><br><span class="line">247</span><br><span class="line">248</span><br><span class="line">249</span><br><span class="line">250</span><br><span class="line">251</span><br><span class="line">252</span><br><span class="line">253</span><br><span class="line">254</span><br><span class="line">255</span><br><span class="line">256</span><br><span class="line">257</span><br><span class="line">258</span><br><span class="line">259</span><br><span class="line">260</span><br><span class="line">261</span><br><span class="line">262</span><br><span class="line">263</span><br><span class="line">264</span><br><span class="line">265</span><br><span class="line">266</span><br><span class="line">267</span><br><span class="line">268</span><br><span class="line">269</span><br><span class="line">270</span><br><span class="line">271</span><br><span class="line">272</span><br><span class="line">273</span><br><span class="line">274</span><br><span class="line">275</span><br><span class="line">276</span><br><span class="line">277</span><br><span class="line">278</span><br><span class="line">279</span><br><span class="line">280</span><br><span class="line">281</span><br><span class="line">282</span><br><span class="line">283</span><br><span class="line">284</span><br><span class="line">285</span><br><span class="line">286</span><br><span class="line">287</span><br><span class="line">288</span><br><span class="line">289</span><br><span class="line">290</span><br><span class="line">291</span><br><span class="line">292</span><br><span class="line">293</span><br><span class="line">294</span><br><span class="line">295</span><br><span class="line">296</span><br><span class="line">297</span><br><span class="line">298</span><br><span class="line">299</span><br><span class="line">300</span><br><span class="line">301</span><br><span class="line">302</span><br><span class="line">303</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">grantPermissionsLPw</span><span class="params">(PackageParser.Package pkg, <span class="keyword">boolean</span> replace,</span></span></span><br><span class="line"><span class="function"><span class="params">        String packageOfInterest)</span> </span>&#123;</span><br><span class="line">    <span class="comment">//【1】如果该应用的 PackageSetting 没有，那么不处理！</span></span><br><span class="line">    <span class="keyword">final</span> PackageSetting ps = (PackageSetting) pkg.mExtras;</span><br><span class="line">    <span class="keyword">if</span> (ps == <span class="keyword">null</span>) &#123;</span><br><span class="line">        <span class="keyword">return</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    Trace.traceBegin(TRACE_TAG_PACKAGE_MANAGER, <span class="string">"grantPermissions"</span>);</span><br><span class="line">    </span><br><span class="line">    <span class="comment">//【2】获得该 package 的权限管理对象，此时这个权限管理对象是解析上次安装信息时恢复的！</span></span><br><span class="line">    <span class="comment">// 我们将其保存到 origPermissions 中，作为原始数据！</span></span><br><span class="line">    PermissionsState permissionsState = ps.getPermissionsState();</span><br><span class="line">    PermissionsState origPermissions = permissionsState;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">final</span> <span class="keyword">int</span>[] currentUserIds = UserManagerService.getInstance().getUserIds();</span><br><span class="line"></span><br><span class="line">    <span class="keyword">boolean</span> runtimePermissionsRevoked = <span class="keyword">false</span>;</span><br><span class="line">    <span class="keyword">int</span>[] changedRuntimePermissionUserIds = EMPTY_INT_ARRAY;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">boolean</span> changedInstallPermission = <span class="keyword">false</span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//【3】如果 replace 的值为 true，进入这里！</span></span><br><span class="line">    <span class="keyword">if</span> (replace) &#123;</span><br><span class="line">        <span class="comment">// 设置 installPermissionsFixed 为 true，因为下面会对权限信息调整！</span></span><br><span class="line">        ps.installPermissionsFixed = <span class="keyword">false</span>;</span><br><span class="line">        <span class="keyword">if</span> (!ps.isSharedUser()) &#123;</span><br><span class="line">            <span class="comment">//【3.1】如果该 package 不是共享 uid 的，那就重置 permissionsState，但是会将</span></span><br><span class="line">            <span class="comment">// 原始信息 copy到 origPermissions 中！</span></span><br><span class="line">            origPermissions = <span class="keyword">new</span> PermissionsState(permissionsState);</span><br><span class="line">            permissionsState.reset();</span><br><span class="line"></span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            <span class="comment">//【3.2】如果该 package 是共享 uid 的，那么我们会拒绝那些不用的共享 uid 相关权限信息！</span></span><br><span class="line">            changedRuntimePermissionUserIds = revokeUnusedSharedUserPermissionsLPw(</span><br><span class="line">                    ps.sharedUser, UserManagerService.getInstance().getUserIds());</span><br><span class="line">            <span class="keyword">if</span> (!ArrayUtils.isEmpty(changedRuntimePermissionUserIds)) &#123;</span><br><span class="line">                runtimePermissionsRevoked = <span class="keyword">true</span>;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    permissionsState.setGlobalGids(mGlobalGids);</span><br><span class="line"></span><br><span class="line">    <span class="comment">//【4】处理该 package 请求的所有权限！</span></span><br><span class="line">    <span class="keyword">final</span> <span class="keyword">int</span> N = pkg.requestedPermissions.size();</span><br><span class="line">    <span class="keyword">for</span> (<span class="keyword">int</span> i=<span class="number">0</span>; i &lt; N; i++) &#123;</span><br><span class="line">        <span class="keyword">final</span> String name = pkg.requestedPermissions.get(i);</span><br><span class="line">        <span class="keyword">final</span> BasePermission bp = mSettings.mPermissions.get(name);</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (DEBUG_INSTALL) &#123;</span><br><span class="line">            Log.i(TAG, <span class="string">"Package "</span> + pkg.packageName + <span class="string">" checking "</span> + name + <span class="string">": "</span> + bp);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">//【4.1】如果该权限没有定义，那么跳过！！</span></span><br><span class="line">        <span class="keyword">if</span> (bp == <span class="keyword">null</span> || bp.packageSetting == <span class="keyword">null</span>) &#123;</span><br><span class="line">            <span class="keyword">if</span> (packageOfInterest == <span class="keyword">null</span> || packageOfInterest.equals(pkg.packageName)) &#123;</span><br><span class="line">                Slog.w(TAG, <span class="string">"Unknown permission "</span> + name</span><br><span class="line">                        + <span class="string">" in package "</span> + pkg.packageName);</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">continue</span>;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">final</span> String perm = bp.name;</span><br><span class="line">        <span class="keyword">boolean</span> allowedSig = <span class="keyword">false</span>;</span><br><span class="line">        <span class="keyword">int</span> grant = GRANT_DENIED; <span class="comment">// 用于保存每个权限的授予情况！</span></span><br><span class="line"></span><br><span class="line">        <span class="comment">//【4.2】如果申请的权限设置了 PROTECTION_FLAG_APPOP 标志位，</span></span><br><span class="line">        <span class="comment">// 我们会将其添加到 mAppOpPermissionPackages 进行监控！</span></span><br><span class="line">        <span class="keyword">if</span> ((bp.protectionLevel &amp; PermissionInfo.PROTECTION_FLAG_APPOP) != <span class="number">0</span>) &#123;</span><br><span class="line">            ArraySet&lt;String&gt; pkgs = mAppOpPermissionPackages.get(bp.name);</span><br><span class="line">            <span class="keyword">if</span> (pkgs == <span class="keyword">null</span>) &#123;</span><br><span class="line">                pkgs = <span class="keyword">new</span> ArraySet&lt;&gt;();</span><br><span class="line">                mAppOpPermissionPackages.put(bp.name, pkgs);</span><br><span class="line">            &#125;</span><br><span class="line">            pkgs.add(pkg.packageName);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment">//【4.3】计算权限的基本类型，并判断应用是否支持运行时权限！！！</span></span><br><span class="line">        <span class="keyword">final</span> <span class="keyword">int</span> level = bp.protectionLevel &amp; PermissionInfo.PROTECTION_MASK_BASE;</span><br><span class="line">        <span class="keyword">final</span> <span class="keyword">boolean</span> appSupportsRuntimePermissions = pkg.applicationInfo.targetSdkVersion</span><br><span class="line">                &gt;= Build.VERSION_CODES.M;</span><br><span class="line"></span><br><span class="line">        <span class="comment">//【4.4】根据权限的基本类型，判断权限的授予情况！！</span></span><br><span class="line">        <span class="keyword">switch</span> (level) &#123;</span><br><span class="line">            <span class="keyword">case</span> PermissionInfo.PROTECTION_NORMAL: &#123; </span><br><span class="line">                <span class="comment">//【4.4.1】基本类型为 normal，为安装时权限，默认授予！</span></span><br><span class="line">                grant = GRANT_INSTALL;</span><br><span class="line">            &#125; <span class="keyword">break</span>;</span><br><span class="line"></span><br><span class="line">            <span class="keyword">case</span> PermissionInfo.PROTECTION_DANGEROUS: &#123;</span><br><span class="line">                <span class="comment">//【4.4.2】基本类型为 dangerous，那么我们要分不同的情况！！</span></span><br><span class="line">                <span class="keyword">if</span> (!appSupportsRuntimePermissions &amp;&amp; !Build.PERMISSIONS_REVIEW_REQUIRED) &#123;</span><br><span class="line">                    <span class="comment">//【4.4.2.1】如果 legacy apps，同时也不需要在组件启动之前重新 review 权限</span></span><br><span class="line">                    <span class="comment">// 说明应用的 targetSDKVersion &lt; 23 是 legacy apps，那么运行时权限视为安装时权限；</span></span><br><span class="line">                    grant = GRANT_INSTALL;</span><br><span class="line">                    </span><br><span class="line">                &#125; <span class="keyword">else</span> <span class="keyword">if</span> (origPermissions.hasInstallPermission(bp.name)) &#123;</span><br><span class="line">                    <span class="comment">//【4.4.2.2】如果应用支持安装是权限，或者需要在组件启动之前重新 review 权限</span></span><br><span class="line">                    <span class="comment">// 并且该运行时权限之前是属于安装时权限，那么就要升级为运行时权限（系统升级会出现）</span></span><br><span class="line">                    grant = GRANT_UPGRADE;</span><br><span class="line">                    </span><br><span class="line">                &#125; <span class="keyword">else</span> <span class="keyword">if</span> (mPromoteSystemApps</span><br><span class="line">                        &amp;&amp; isSystemApp(ps)</span><br><span class="line">                        &amp;&amp; mExistingSystemPackages.contains(ps.name)) &#123;</span><br><span class="line">                    <span class="comment">//【4.4.2.3】如果是从 API 22 升级上来的话，对于 Promote System Apps，</span></span><br><span class="line">                    <span class="comment">// 那么安装时权限就要升级为运行时权限；</span></span><br><span class="line">                    grant = GRANT_UPGRADE;</span><br><span class="line">                    </span><br><span class="line">                &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                    <span class="comment">//【4.4.2.4】其他情况，直接视为安装时权限！</span></span><br><span class="line">                    grant = GRANT_RUNTIME;</span><br><span class="line">                    </span><br><span class="line">                &#125;</span><br><span class="line">            &#125; <span class="keyword">break</span>;</span><br><span class="line"></span><br><span class="line">            <span class="keyword">case</span> PermissionInfo.PROTECTION_SIGNATURE: &#123;</span><br><span class="line">                <span class="comment">//【4.4.3】基本类型为 signature 的权限，需要校验签名！！</span></span><br><span class="line">                <span class="comment">//【*1.2.2-important】校验签名是否匹配，如果是的话，是为安装时权限！</span></span><br><span class="line">                allowedSig = grantSignaturePermission(perm, pkg, bp, origPermissions);</span><br><span class="line">                <span class="keyword">if</span> (allowedSig) &#123;</span><br><span class="line">                    <span class="comment">// 如果签名校验通过，直接视为安装时权限！</span></span><br><span class="line">                    grant = GRANT_INSTALL;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125; <span class="keyword">break</span>;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (DEBUG_INSTALL) &#123;</span><br><span class="line">            Log.i(TAG, <span class="string">"Package "</span> + pkg.packageName + <span class="string">" granting "</span> + perm);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment">//【4.5】处理授予情况，如果授予情况不是拒绝 GRANT_DENIED，进入 IF 分支；</span></span><br><span class="line">        <span class="comment">// 如果授予情况是拒绝 GRANT_DENIED，进入 ELSE 分支！</span></span><br><span class="line">        <span class="keyword">if</span> (grant != GRANT_DENIED) &#123;</span><br><span class="line">            <span class="keyword">if</span> (!isSystemApp(ps) &amp;&amp; ps.installPermissionsFixed) &#123;</span><br><span class="line">                <span class="comment">//【4.5.1】如果这是一个已经被安装了的非系统的应用，同时本次申请的权限之前不属于安装时权限</span></span><br><span class="line">                <span class="comment">// 除非该权限属于 new platform permission 不然的话，我们是不会授予他这个权限的；</span></span><br><span class="line">                <span class="keyword">if</span> (!allowedSig &amp;&amp; !origPermissions.hasInstallPermission(perm)) &#123;</span><br><span class="line">                    <span class="keyword">if</span> (!isNewPlatformPermissionForPackage(perm, pkg)) &#123;</span><br><span class="line">                        grant = GRANT_DENIED;</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="comment">//【4.5.2】处理权限的授予状态！</span></span><br><span class="line">            <span class="keyword">switch</span> (grant) &#123;</span><br><span class="line">                <span class="keyword">case</span> GRANT_INSTALL: &#123; <span class="comment">// 处理安装时权限；</span></span><br><span class="line">                    <span class="comment">//【4.5.2.1.1】首先，判断该权限之前是否是运行时权限，如果是的话，那就要撤销之前的授予！</span></span><br><span class="line">                    <span class="keyword">for</span> (<span class="keyword">int</span> userId : UserManagerService.getInstance().getUserIds()) &#123;</span><br><span class="line">                        <span class="keyword">if</span> (origPermissions.getRuntimePermissionState(</span><br><span class="line">                                bp.name, userId) != <span class="keyword">null</span>) &#123;</span><br><span class="line">                            <span class="comment">// 撤销权限，并取消所有的标志位；</span></span><br><span class="line">                            origPermissions.revokeRuntimePermission(bp, userId);</span><br><span class="line">                            origPermissions.updatePermissionFlags(bp, userId,</span><br><span class="line">                                  PackageManager.MASK_PERMISSION_FLAGS, <span class="number">0</span>);</span><br><span class="line">                            <span class="comment">// 将运行时权限授予状态发生变化的 userId 记录下来，后面用于持久化数据！</span></span><br><span class="line">                            changedRuntimePermissionUserIds = ArrayUtils.appendInt(</span><br><span class="line">                                    changedRuntimePermissionUserIds, userId);</span><br><span class="line">                        &#125;</span><br><span class="line">                    &#125;</span><br><span class="line">                    <span class="comment">//【4.5.2.1.2】授予安装时权限；</span></span><br><span class="line">                    <span class="keyword">if</span> (permissionsState.grantInstallPermission(bp) !=</span><br><span class="line">                            PermissionsState.PERMISSION_OPERATION_FAILURE) &#123;</span><br><span class="line">                        changedInstallPermission = <span class="keyword">true</span>;</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125; <span class="keyword">break</span>;</span><br><span class="line"></span><br><span class="line">                <span class="keyword">case</span> GRANT_RUNTIME: &#123; <span class="comment">// 处理运行时权限；</span></span><br><span class="line">                    <span class="comment">//【4.5.2.1.3】授予之前被授予的运行时权限；</span></span><br><span class="line">                    <span class="keyword">for</span> (<span class="keyword">int</span> userId : UserManagerService.getInstance().getUserIds()) &#123;</span><br><span class="line">                        <span class="comment">//【4.5.2.1.3.1】获得每个 userId 下的该运行时权限对象和其 flags；</span></span><br><span class="line">                        PermissionState permissionState = origPermissions</span><br><span class="line">                                .getRuntimePermissionState(bp.name, userId);</span><br><span class="line">                        <span class="keyword">int</span> flags = permissionState != <span class="keyword">null</span></span><br><span class="line">                                ? permissionState.getFlags() : <span class="number">0</span>;</span><br><span class="line">                        </span><br><span class="line">                        <span class="comment">//【4.5.2.1.3.2】如果本次授予的权限是已经申请的，那么我们就再次授予！</span></span><br><span class="line">                        <span class="keyword">if</span> (origPermissions.hasRuntimePermission(bp.name, userId)) &#123;</span><br><span class="line">                            <span class="comment">//【4.5.2.1.3.2.1】授予运行时权限，如果失败的话，意味着本次无法授予，那就更新</span></span><br><span class="line">                            <span class="comment">// changedRuntimePermissionUserIds 列表；</span></span><br><span class="line">                            <span class="keyword">if</span> (permissionsState.grantRuntimePermission(bp, userId) ==</span><br><span class="line">                                    PermissionsState.PERMISSION_OPERATION_FAILURE) &#123;</span><br><span class="line">                                changedRuntimePermissionUserIds = ArrayUtils.appendInt(</span><br><span class="line">                                        changedRuntimePermissionUserIds, userId);</span><br><span class="line">                            &#125;</span><br><span class="line">                            <span class="comment">//【4.5.2.1.3.2.2】如果应用支持运行时权限，该权限之前是需要 review 的</span></span><br><span class="line">                            <span class="comment">// 那么这里会取消 review 的标志位！</span></span><br><span class="line">                            <span class="keyword">if</span> (Build.PERMISSIONS_REVIEW_REQUIRED</span><br><span class="line">                                    &amp;&amp; appSupportsRuntimePermissions</span><br><span class="line">                                    &amp;&amp; (flags &amp; PackageManager</span><br><span class="line">                                            .FLAG_PERMISSION_REVIEW_REQUIRED) != <span class="number">0</span>) &#123;</span><br><span class="line">                                flags &amp;= ~PackageManager.FLAG_PERMISSION_REVIEW_REQUIRED;</span><br><span class="line">                                <span class="comment">// 标志位变了，那就更新 changedRuntimePermissionUserIds 列表；</span></span><br><span class="line">                                changedRuntimePermissionUserIds = ArrayUtils.appendInt(</span><br><span class="line">                                        changedRuntimePermissionUserIds, userId);</span><br><span class="line">                            &#125;</span><br><span class="line"></span><br><span class="line">                        &#125; <span class="keyword">else</span> <span class="keyword">if</span> (Build.PERMISSIONS_REVIEW_REQUIRED</span><br><span class="line">                                &amp;&amp; !appSupportsRuntimePermissions) &#123;</span><br><span class="line">                            <span class="comment">//【4.5.2.1.3.2】如果应用不支持运行时权限，但是系统需要权限 review</span></span><br><span class="line">                            <span class="comment">// 每一个被授予的新的运行时权限，都要被 review！</span></span><br><span class="line">                            <span class="comment">// 如果是系统权限，强制增加 FLAG_PERMISSION_REVIEW_REQUIRED 标志位</span></span><br><span class="line">                            <span class="keyword">if</span> (PLATFORM_PACKAGE_NAME.equals(bp.sourcePackage)) &#123;</span><br><span class="line">                                <span class="keyword">if</span> ((flags &amp; FLAG_PERMISSION_REVIEW_REQUIRED) == <span class="number">0</span>) &#123;</span><br><span class="line">                                    flags |= FLAG_PERMISSION_REVIEW_REQUIRED;</span><br><span class="line">                                    <span class="comment">// 标志位变了，那就更新 changedRuntimePermissionUserIds 列表；</span></span><br><span class="line">                                    changedRuntimePermissionUserIds = ArrayUtils.appendInt(</span><br><span class="line">                                            changedRuntimePermissionUserIds, userId);</span><br><span class="line">                                &#125;</span><br><span class="line">                            &#125;</span><br><span class="line">                            <span class="comment">// 授予这个新的运行时权限，如果授予失败，更新 changedRuntimePermissionUserIds 列表；</span></span><br><span class="line">                            <span class="keyword">if</span> (permissionsState.grantRuntimePermission(bp, userId)</span><br><span class="line">                                    != PermissionsState.PERMISSION_OPERATION_FAILURE) &#123;</span><br><span class="line">                                changedRuntimePermissionUserIds = ArrayUtils.appendInt(</span><br><span class="line">                                        changedRuntimePermissionUserIds, userId);</span><br><span class="line">                            &#125;</span><br><span class="line">                        &#125;</span><br><span class="line">                        <span class="comment">//【4.5.2.1.3.2.1】更新权限的 flags！</span></span><br><span class="line">                        permissionsState.updatePermissionFlags(bp, userId, flags, flags);</span><br><span class="line"></span><br><span class="line">                    &#125;</span><br><span class="line">                &#125; <span class="keyword">break</span>;</span><br><span class="line"></span><br><span class="line">                <span class="keyword">case</span> GRANT_UPGRADE: &#123; <span class="comment">// 处理安装时权限升级为运行时权限</span></span><br><span class="line">                    <span class="comment">//【4.5.2.1.4】授予安装时升级为运行时的权限；</span></span><br><span class="line">                    <span class="comment">// 获得权限管理对象和 flags；</span></span><br><span class="line">                    PermissionState permissionState = origPermissions</span><br><span class="line">                            .getInstallPermissionState(bp.name);</span><br><span class="line">                    <span class="keyword">final</span> <span class="keyword">int</span> flags = permissionState != <span class="keyword">null</span> ? permissionState.getFlags() : <span class="number">0</span>;</span><br><span class="line"></span><br><span class="line">                    <span class="comment">//【4.5.2.1.4.1】撤销之前的安装时权限，并清空 flags；</span></span><br><span class="line">                    <span class="keyword">if</span> (origPermissions.revokeInstallPermission(bp)</span><br><span class="line">                            != PermissionsState.PERMISSION_OPERATION_FAILURE) &#123;</span><br><span class="line">                        origPermissions.updatePermissionFlags(bp, UserHandle.USER_ALL,</span><br><span class="line">                                PackageManager.MASK_PERMISSION_FLAGS, <span class="number">0</span>);</span><br><span class="line">                        changedInstallPermission = <span class="keyword">true</span>;</span><br><span class="line">                    &#125;</span><br><span class="line"></span><br><span class="line">                    <span class="comment">//【4.5.2.1.4.2】如果该权限没有设置 FLAG_PERMISSION_REVOKE_ON_UPGRADE，</span></span><br><span class="line">                    <span class="comment">// 表示在升级后可以授予，那么我们就授予运行时权限；</span></span><br><span class="line">                    <span class="keyword">if</span> ((flags &amp; PackageManager.FLAG_PERMISSION_REVOKE_ON_UPGRADE) == <span class="number">0</span>) &#123;</span><br><span class="line">                        <span class="keyword">for</span> (<span class="keyword">int</span> userId : currentUserIds) &#123;</span><br><span class="line">                            <span class="keyword">if</span> (permissionsState.grantRuntimePermission(bp, userId) !=</span><br><span class="line">                                    PermissionsState.PERMISSION_OPERATION_FAILURE) &#123;</span><br><span class="line">                                <span class="comment">// 将旧的 flags 更新到运行时权限；</span></span><br><span class="line">                                permissionsState.updatePermissionFlags(bp, userId,</span><br><span class="line">                                        flags, flags);</span><br><span class="line">                                <span class="comment">// 标志位变了，那就更新 changedRuntimePermissionUserIds 列表；</span></span><br><span class="line">                                changedRuntimePermissionUserIds = ArrayUtils.appendInt(</span><br><span class="line">                                        changedRuntimePermissionUserIds, userId);</span><br><span class="line">                            &#125;</span><br><span class="line">                        &#125;</span><br><span class="line">                    &#125;</span><br><span class="line"></span><br><span class="line">                &#125; <span class="keyword">break</span>;</span><br><span class="line"></span><br><span class="line">                <span class="keyword">default</span>: &#123;</span><br><span class="line">                    <span class="keyword">if</span> (packageOfInterest == <span class="keyword">null</span></span><br><span class="line">                            || packageOfInterest.equals(pkg.packageName)) &#123;</span><br><span class="line">                        Slog.w(TAG, <span class="string">"Not granting permission "</span> + perm</span><br><span class="line">                                + <span class="string">" to package "</span> + pkg.packageName</span><br><span class="line">                                + <span class="string">" because it was previously installed without"</span>);</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125; <span class="keyword">break</span>;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            <span class="comment">//【4.6】处理撤销情况，撤销该权限，同时清空所有的标志位；</span></span><br><span class="line">            <span class="keyword">if</span> (permissionsState.revokeInstallPermission(bp) !=</span><br><span class="line">                    PermissionsState.PERMISSION_OPERATION_FAILURE) &#123;</span><br><span class="line">                <span class="comment">// 清空标志位；</span></span><br><span class="line">                permissionsState.updatePermissionFlags(bp, UserHandle.USER_ALL,</span><br><span class="line">                        PackageManager.MASK_PERMISSION_FLAGS, <span class="number">0</span>);</span><br><span class="line">                changedInstallPermission = <span class="keyword">true</span>;</span><br><span class="line">                Slog.i(TAG, <span class="string">"Un-granting permission "</span> + perm</span><br><span class="line">                        + <span class="string">" from package "</span> + pkg.packageName</span><br><span class="line">                        + <span class="string">" (protectionLevel="</span> + bp.protectionLevel</span><br><span class="line">                        + <span class="string">" flags=0x"</span> + Integer.toHexString(pkg.applicationInfo.flags)</span><br><span class="line">                        + <span class="string">")"</span>);</span><br><span class="line">            &#125; <span class="keyword">else</span> <span class="keyword">if</span> ((bp.protectionLevel&amp;PermissionInfo.PROTECTION_FLAG_APPOP) == <span class="number">0</span>) &#123;</span><br><span class="line">                <span class="comment">//【4.6.1】如果撤销失败，但是该权限和一个 appOp 相关联，这种情况可以不处理。因为</span></span><br><span class="line">                <span class="comment">// 对于这类权限，我们不处理，因为我们会通过 appOps 进行控制，通过 ui 给用户选择；</span></span><br><span class="line">                <span class="keyword">if</span> (packageOfInterest == <span class="keyword">null</span> || packageOfInterest.equals(pkg.packageName)) &#123;</span><br><span class="line">                    Slog.w(TAG, <span class="string">"Not granting permission "</span> + perm</span><br><span class="line">                            + <span class="string">" to package "</span> + pkg.packageName</span><br><span class="line">                            + <span class="string">" (protectionLevel="</span> + bp.protectionLevel</span><br><span class="line">                            + <span class="string">" flags=0x"</span> + Integer.toHexString(pkg.applicationInfo.flags)</span><br><span class="line">                            + <span class="string">")"</span>);</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span> ((changedInstallPermission || replace) &amp;&amp; !ps.installPermissionsFixed &amp;&amp;</span><br><span class="line">            !isSystemApp(ps) || isUpdatedSystemApp(ps))&#123;</span><br><span class="line">        <span class="comment">// 这是我们第一次听说过这个包，所以我们现在选择的权限是固定的，直到明确更改为止。</span></span><br><span class="line">        <span class="comment">// 没看懂这段逻辑...</span></span><br><span class="line">        ps.installPermissionsFixed = <span class="keyword">true</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//【5】持久化变化调整后的运行时权限数据！</span></span><br><span class="line">    <span class="keyword">for</span> (<span class="keyword">int</span> userId : changedRuntimePermissionUserIds) &#123;</span><br><span class="line">        mSettings.writeRuntimePermissionsForUserLPr(userId, runtimePermissionsRevoked);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    Trace.traceEnd(TRACE_TAG_PACKAGE_MANAGER);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h3 id="3-2-1-grantSignaturePermission-Signature-权限授予核心接口"><a href="#3-2-1-grantSignaturePermission-Signature-权限授予核心接口" class="headerlink" title="3.2.1 grantSignaturePermission - Signature 权限授予核心接口"></a>3.2.1 grantSignaturePermission - Signature 权限授予核心接口</h3><p>grantSignaturePermission 方法用于判断签名是否能校验通过，我们在这里先忽略掉签名校验的过程，假设要么校验成功，要么校验失败！</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">boolean</span> <span class="title">grantSignaturePermission</span><span class="params">(String perm, PackageParser.Package pkg,</span></span></span><br><span class="line"><span class="function"><span class="params">        BasePermission bp, PermissionsState origPermissions)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">boolean</span> allowed;</span><br><span class="line">    <span class="comment">//【1】判断应用的签名和权限定义者签名或者平台签名是否匹配！</span></span><br><span class="line">    allowed = (compareSignatures(</span><br><span class="line">            bp.packageSetting.signatures.mSignatures, pkg.mSignatures)</span><br><span class="line">                    == PackageManager.SIGNATURE_MATCH)</span><br><span class="line">            || (compareSignatures(mPlatformPackage.mSignatures, pkg.mSignatures)</span><br><span class="line">                    == PackageManager.SIGNATURE_MATCH);</span><br><span class="line">                    </span><br><span class="line">    <span class="comment">//【2】如果和权限定义者签名或者平台签名不匹配，并且该权限是 PRIVILEGED 的，进行进一步的判断！</span></span><br><span class="line">    <span class="keyword">if</span> (!allowed &amp;&amp; (bp.protectionLevel</span><br><span class="line">            &amp; PermissionInfo.PROTECTION_FLAG_PRIVILEGED) != <span class="number">0</span>) &#123;</span><br><span class="line">        </span><br><span class="line">        <span class="keyword">if</span> (isSystemApp(pkg)) &#123; <span class="comment">// 对于 PRIVILEGED 类型的权限，首先必须是系统应用！</span></span><br><span class="line">            <span class="comment">//【2.1】如果该应用是一个被更新过的系统应用，那么只有更新前的旧 apk 被授予了这个权限，</span></span><br><span class="line">            <span class="comment">// 新的 apk 才能被授予这个权限！</span></span><br><span class="line">            <span class="keyword">if</span> (pkg.isUpdatedSystemApp()) &#123;</span><br><span class="line">                <span class="comment">// 获得更新前的安装数据(system)！</span></span><br><span class="line">                <span class="keyword">final</span> PackageSetting sysPs = mSettings</span><br><span class="line">                        .getDisabledSystemPkgLPr(pkg.packageName);</span><br><span class="line"></span><br><span class="line">                <span class="keyword">if</span> (sysPs != <span class="keyword">null</span> &amp;&amp; sysPs.getPermissionsState().hasInstallPermission(perm)) &#123;</span><br><span class="line">                    <span class="comment">//【2.1.1】如果更新前，其已经被授予了该权限，并且其是一个特权应用，</span></span><br><span class="line">                    <span class="comment">// 那么本次也允许授予！！</span></span><br><span class="line">                    <span class="keyword">if</span> (sysPs.isPrivileged()) &#123;</span><br><span class="line">                        allowed = <span class="keyword">true</span>;</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                    <span class="comment">//【2.1.2】如果更新前，并没有被授予该权限，该权限是更新后新申请的权限！</span></span><br><span class="line">                    <span class="comment">// 那就要看之前是否有请求该权限，只有请求了该权限，才允许授予；</span></span><br><span class="line">                    <span class="keyword">if</span> (sysPs != <span class="keyword">null</span> &amp;&amp; sysPs.pkg != <span class="keyword">null</span> &amp;&amp; sysPs.isPrivileged()) &#123;</span><br><span class="line">                        <span class="keyword">for</span> (<span class="keyword">int</span> j = <span class="number">0</span>; j &lt; sysPs.pkg.requestedPermissions.size(); j++) &#123;</span><br><span class="line">                            <span class="keyword">if</span> (perm.equals(sysPs.pkg.requestedPermissions.get(j))) &#123;</span><br><span class="line">                                allowed = <span class="keyword">true</span>;</span><br><span class="line">                                <span class="keyword">break</span>;</span><br><span class="line">                            &#125;</span><br><span class="line">                        &#125;</span><br><span class="line">                    &#125;</span><br><span class="line"></span><br><span class="line">                    <span class="comment">// 此外，如果系统映像上的特权父包或其父包任何子代请求特权权限，则更新的子包也可以获得该许可。</span></span><br><span class="line">                    <span class="keyword">if</span> (pkg.parentPackage != <span class="keyword">null</span>) &#123;</span><br><span class="line">                        <span class="keyword">final</span> PackageSetting disabledSysParentPs = mSettings</span><br><span class="line">                                .getDisabledSystemPkgLPr(pkg.parentPackage.packageName);</span><br><span class="line">                        <span class="keyword">if</span> (disabledSysParentPs != <span class="keyword">null</span> &amp;&amp; disabledSysParentPs.pkg != <span class="keyword">null</span></span><br><span class="line">                                &amp;&amp; disabledSysParentPs.isPrivileged()) &#123;</span><br><span class="line">                            <span class="keyword">if</span> (isPackageRequestingPermission(disabledSysParentPs.pkg, perm)) &#123;</span><br><span class="line">                                allowed = <span class="keyword">true</span>;</span><br><span class="line">                            &#125; <span class="keyword">else</span> <span class="keyword">if</span> (disabledSysParentPs.pkg.childPackages != <span class="keyword">null</span>) &#123;</span><br><span class="line">                                <span class="keyword">final</span> <span class="keyword">int</span> count = disabledSysParentPs.pkg.childPackages.size();</span><br><span class="line">                                <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; count; i++) &#123;</span><br><span class="line">                                    PackageParser.Package disabledSysChildPkg =</span><br><span class="line">                                            disabledSysParentPs.pkg.childPackages.get(i);</span><br><span class="line">                                    <span class="keyword">if</span> (isPackageRequestingPermission(disabledSysChildPkg,</span><br><span class="line">                                            perm)) &#123;</span><br><span class="line">                                        allowed = <span class="keyword">true</span>;</span><br><span class="line">                                        <span class="keyword">break</span>;</span><br><span class="line">                                    &#125;</span><br><span class="line">                                &#125;</span><br><span class="line">                            &#125;</span><br><span class="line">                        &#125;</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                <span class="comment">//【2.2】如果该应用是一个没有被更新过的系统应用，那就要判读其是否是特权应用！</span></span><br><span class="line">                allowed = isPrivilegedApp(pkg);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">//【3】经过了上面的判断，依然不允许，接着进行下一步的判断，下面会根据额外的标志位继续判断！</span></span><br><span class="line">    <span class="keyword">if</span> (!allowed) &#123;</span><br><span class="line">        <span class="keyword">if</span> (!allowed &amp;&amp; (bp.protectionLevel</span><br><span class="line">                &amp; PermissionInfo.PROTECTION_FLAG_PRE23) != <span class="number">0</span></span><br><span class="line">                &amp;&amp; pkg.applicationInfo.targetSdkVersion &lt; Build.VERSION_CODES.M) &#123;</span><br><span class="line">            <span class="comment">//【3.1】PROTECTION_FLAG_PRE23 指定此权限会自动授予低于 M（在引入运行时权限之前）的 API 级别的应用程序。</span></span><br><span class="line">            <span class="comment">// 如果应用的 targetSdkVersion 是小于 M 的，那么我们授予他签名权限！</span></span><br><span class="line">            allowed = <span class="keyword">true</span>;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (!allowed &amp;&amp; (bp.protectionLevel &amp; PermissionInfo.PROTECTION_FLAG_INSTALLER) != <span class="number">0</span></span><br><span class="line">                &amp;&amp; pkg.packageName.equals(mRequiredInstallerPackage)) &#123;</span><br><span class="line">            <span class="comment">//【3.2】PROTECTION_FLAG_INSTALLER 指定此权限可以自动授予包软件应用程序。</span></span><br><span class="line">            <span class="comment">// 而此时的 apk 就是 packageInstaller，那么授予他签名权限！</span></span><br><span class="line">            allowed = <span class="keyword">true</span>;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (!allowed &amp;&amp; (bp.protectionLevel &amp; PermissionInfo.PROTECTION_FLAG_VERIFIER) != <span class="number">0</span></span><br><span class="line">                &amp;&amp; pkg.packageName.equals(mRequiredVerifierPackage)) &#123;</span><br><span class="line">            <span class="comment">//【3.3】PROTECTION_FLAG_INSTALLER 指定此权限可以被自动授予给验证软件包的系统应用程序。</span></span><br><span class="line">            <span class="comment">// 而此时的 apk 就是 VerifierPackage，那么授予他签名权限！</span></span><br><span class="line">            allowed = <span class="keyword">true</span>;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (!allowed &amp;&amp; (bp.protectionLevel</span><br><span class="line">                &amp; PermissionInfo.PROTECTION_FLAG_PREINSTALLED) != <span class="number">0</span></span><br><span class="line">                &amp;&amp; isSystemApp(pkg)) &#123;</span><br><span class="line">            <span class="comment">//【3.4】PROTECTION_FLAG_PREINSTALLED 指定此权限可以自动授予 system 分区预先安装的任何应用程序</span></span><br><span class="line">            <span class="comment">// 而此时的 apk 就是 system app，那么授予他签名权限！</span></span><br><span class="line">            allowed = <span class="keyword">true</span>;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (!allowed &amp;&amp; (bp.protectionLevel</span><br><span class="line">                &amp; PermissionInfo.PROTECTION_FLAG_DEVELOPMENT) != <span class="number">0</span>) &#123;</span><br><span class="line">            <span class="comment">//【3.4】PROTECTION_FLAG_DEVELOPMENT 指定此权限可以授予（可选）给开发应用程序</span></span><br><span class="line">            <span class="comment">// 而上一次应用是被授予了这个权限，那么一次也不被授予</span></span><br><span class="line">            allowed = origPermissions.hasInstallPermission(perm);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (!allowed &amp;&amp; (bp.protectionLevel &amp; PermissionInfo.PROTECTION_FLAG_SETUP) != <span class="number">0</span></span><br><span class="line">                &amp;&amp; pkg.packageName.equals(mSetupWizardPackage)) &#123;</span><br><span class="line">            <span class="comment">//【3.5】PROTECTION_FLAG_SETUP 指定此权限可以被自动授予给开机向导应用程序</span></span><br><span class="line">            <span class="comment">// 而此时的 apk 就是开机向导，那么授予他签名权限！.</span></span><br><span class="line">            allowed = <span class="keyword">true</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> allowed;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>可以看到，这里对 Signature 类型的权限做了详细的处理！</p>
<h2 id="3-2-grantRuntimePermission-运行时权限授予核心接口"><a href="#3-2-grantRuntimePermission-运行时权限授予核心接口" class="headerlink" title="3.2 grantRuntimePermission - 运行时权限授予核心接口"></a>3.2 grantRuntimePermission - 运行时权限授予核心接口</h2><p>授予运行时权限，其主要是在应用运行的时候，显示一个伪弹窗的 acitivity</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">grantRuntimePermission</span><span class="params">(String packageName, String name, <span class="keyword">final</span> <span class="keyword">int</span> userId)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">if</span> (!sUserManager.exists(userId)) &#123; <span class="comment">//【1】校验用户是否存在！</span></span><br><span class="line">        Log.e(TAG, <span class="string">"No such user:"</span> + userId);</span><br><span class="line">        <span class="keyword">return</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    mContext.enforceCallingOrSelfPermission( <span class="comment">//【2】校验调用者是否有相应权限；</span></span><br><span class="line">            android.Manifest.permission.GRANT_RUNTIME_PERMISSIONS,</span><br><span class="line">            <span class="string">"grantRuntimePermission"</span>);</span><br><span class="line"></span><br><span class="line">    enforceCrossUserPermission(Binder.getCallingUid(), userId,</span><br><span class="line">            <span class="keyword">true</span> <span class="comment">/* requireFullPermission */</span>, <span class="keyword">true</span> <span class="comment">/* checkShell */</span>,</span><br><span class="line">            <span class="string">"grantRuntimePermission"</span>);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">final</span> <span class="keyword">int</span> uid;</span><br><span class="line">    <span class="keyword">final</span> SettingBase sb;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">synchronized</span> (mPackages) &#123;</span><br><span class="line">        <span class="keyword">final</span> PackageParser.Package pkg = mPackages.get(packageName);</span><br><span class="line">        <span class="keyword">if</span> (pkg == <span class="keyword">null</span>) &#123; <span class="comment">//【3】package 不存在，异常！</span></span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> IllegalArgumentException(<span class="string">"Unknown package: "</span> + packageName);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">final</span> BasePermission bp = mSettings.mPermissions.get(name);</span><br><span class="line">        <span class="keyword">if</span> (bp == <span class="keyword">null</span>) &#123; <span class="comment">//【4】权限不存在，异常！</span></span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> IllegalArgumentException(<span class="string">"Unknown permission: "</span> + name);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        enforceDeclaredAsUsedAndRuntimeOrDevelopmentPermission(pkg, bp);</span><br><span class="line"></span><br><span class="line">        <span class="comment">//【5】如果 targetSdkVersion 小于 M，那么是不支持运行时权限的，我们在安装的时候会自动授予运行时权限！</span></span><br><span class="line">        <span class="keyword">if</span> (Build.PERMISSIONS_REVIEW_REQUIRED</span><br><span class="line">                &amp;&amp; pkg.applicationInfo.targetSdkVersion &lt; Build.VERSION_CODES.M</span><br><span class="line">                &amp;&amp; bp.isRuntime()) &#123;</span><br><span class="line">            <span class="keyword">return</span>;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        uid = UserHandle.getUid(userId, pkg.applicationInfo.uid);</span><br><span class="line">        sb = (SettingBase) pkg.mExtras;</span><br><span class="line">        <span class="keyword">if</span> (sb == <span class="keyword">null</span>) &#123; <span class="comment">//【6】升级包未安装过，异常！</span></span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> IllegalArgumentException(<span class="string">"Unknown package: "</span> + packageName);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">final</span> PermissionsState permissionsState = sb.getPermissionsState();</span><br><span class="line">        <span class="comment">//【7】获得权限的 flags 标志位，如果该权限是被 system fix 的，我们不能操作这样的权限！</span></span><br><span class="line">        <span class="keyword">final</span> <span class="keyword">int</span> flags = permissionsState.getPermissionFlags(name, userId);</span><br><span class="line">        <span class="keyword">if</span> ((flags &amp; PackageManager.FLAG_PERMISSION_SYSTEM_FIXED) != <span class="number">0</span>) &#123;</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> SecurityException(<span class="string">"Cannot grant system fixed permission "</span></span><br><span class="line">                    + name + <span class="string">" for package "</span> + packageName);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment">//【8】如果该权限是开发者权限，特殊处理，作为安装时权限，立刻授予！</span></span><br><span class="line">        <span class="comment">// 授予成功，会触发 Settings.writeLPr 方法，该方法会更新多个文件</span></span><br><span class="line">        <span class="comment">// 包括 pacakges.xml，pacakges.list，runtime-permissions.xml 等文件！</span></span><br><span class="line">        <span class="keyword">if</span> (bp.isDevelopment()) &#123;</span><br><span class="line">            <span class="keyword">if</span> (permissionsState.grantInstallPermission(bp) !=</span><br><span class="line">                    PermissionsState.PERMISSION_OPERATION_FAILURE) &#123;</span><br><span class="line">                scheduleWriteSettingsLocked();</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">return</span>;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (pkg.applicationInfo.targetSdkVersion &lt; Build.VERSION_CODES.M) &#123;</span><br><span class="line">            Slog.w(TAG, <span class="string">"Cannot grant runtime permission to a legacy app"</span>);</span><br><span class="line">            <span class="keyword">return</span>;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment">//【9】授予权限，并处理授予结果！！</span></span><br><span class="line">        <span class="keyword">final</span> <span class="keyword">int</span> result = permissionsState.grantRuntimePermission(bp, userId);</span><br><span class="line">        <span class="keyword">switch</span> (result) &#123;</span><br><span class="line">            <span class="keyword">case</span> PermissionsState.PERMISSION_OPERATION_FAILURE: &#123;</span><br><span class="line">                <span class="comment">//【9.1】授予失败，可能应用已经被授予权限了！</span></span><br><span class="line">                <span class="keyword">return</span>;</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            <span class="keyword">case</span> PermissionsState.PERMISSION_OPERATION_SUCCESS_GIDS_CHANGED: &#123;</span><br><span class="line">                <span class="comment">//【9.2】授予成功，但是应用映射的 gids 变化了！</span></span><br><span class="line">                <span class="keyword">final</span> <span class="keyword">int</span> appId = UserHandle.getAppId(pkg.applicationInfo.uid);</span><br><span class="line">                mHandler.post(<span class="keyword">new</span> Runnable() &#123;</span><br><span class="line">                    <span class="meta">@Override</span></span><br><span class="line">                    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">run</span><span class="params">()</span> </span>&#123;</span><br><span class="line">                        <span class="comment">//【9.2.1】杀掉应用的进程，应用后续会重启！</span></span><br><span class="line">                        killUid(appId, userId, KILL_APP_REASON_GIDS_CHANGED);</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;);</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        mOnPermissionChangeListeners.onPermissionsChanged(uid);</span><br><span class="line"></span><br><span class="line">        <span class="comment">//【10】更新 runtime-permissions.xml 文件！</span></span><br><span class="line">        mSettings.writeRuntimePermissionsForUserLPr(userId, <span class="keyword">false</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// Only need to do this if user is initialized. Otherwise it's a new user</span></span><br><span class="line">    <span class="comment">// and there are no processes running as the user yet and there's no need</span></span><br><span class="line">    <span class="comment">// to make an expensive call to remount processes for the changed permissions.</span></span><br><span class="line">    <span class="keyword">if</span> (READ_EXTERNAL_STORAGE.equals(name)</span><br><span class="line">            || WRITE_EXTERNAL_STORAGE.equals(name)) &#123;</span><br><span class="line">        <span class="keyword">final</span> <span class="keyword">long</span> token = Binder.clearCallingIdentity();</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            <span class="keyword">if</span> (sUserManager.isInitialized(userId)) &#123;</span><br><span class="line">                MountServiceInternal mountServiceInternal = LocalServices.getService(</span><br><span class="line">                        MountServiceInternal.class);</span><br><span class="line">                mountServiceInternal.onExternalStoragePolicyChanged(uid, packageName);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">            Binder.restoreCallingIdentity(token);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h2 id="3-3-grantRequestedRuntimePermissions-安装时授予运行时权限"><a href="#3-3-grantRequestedRuntimePermissions-安装时授予运行时权限" class="headerlink" title="3.3 grantRequestedRuntimePermissions - 安装时授予运行时权限"></a>3.3 grantRequestedRuntimePermissions - 安装时授予运行时权限</h2><p>在签名分析 pkg install 的时候，我们有看 handlePackagePostInstall 方法：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">handlePackagePostInstall</span><span class="params">(PackageInstalledInfo res, <span class="keyword">boolean</span> grantPermissions,</span></span></span><br><span class="line"><span class="function"><span class="params">        <span class="keyword">boolean</span> killApp, String[] grantedPermissions,</span></span></span><br><span class="line"><span class="function"><span class="params">        <span class="keyword">boolean</span> launchedForRestore, String installerPackage,</span></span></span><br><span class="line"><span class="function"><span class="params">        IPackageInstallObserver2 installObserver)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">if</span> (res.returnCode == PackageManager.INSTALL_SUCCEEDED) &#123;</span><br><span class="line">        <span class="comment">// Send the removed broadcasts</span></span><br><span class="line">        <span class="keyword">if</span> (res.removedInfo != <span class="keyword">null</span>) &#123;</span><br><span class="line">            res.removedInfo.sendPackageRemovedBroadcasts(killApp);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment">//【1】如果我们指定了在安装时授予其运行时权限，那么就会调用 grantRequestedRuntimePermissions 方法：</span></span><br><span class="line">        <span class="keyword">if</span> (grantPermissions &amp;&amp; res.pkg.applicationInfo.targetSdkVersion</span><br><span class="line">                &gt;= Build.VERSION_CODES.M) &#123;</span><br><span class="line">            grantRequestedRuntimePermissions(res.pkg, res.newUsers, grantedPermissions);</span><br><span class="line">        &#125;</span><br></pre></td></tr></table></figure>
<p>继续来分析：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">grantRequestedRuntimePermissions</span><span class="params">(PackageParser.Package pkg, <span class="keyword">int</span>[] userIds,</span></span></span><br><span class="line"><span class="function"><span class="params">        String[] grantedPermissions)</span> </span>&#123;</span><br><span class="line">    <span class="comment">//【3.3.1】授予每个设备用户下的运行时权限！</span></span><br><span class="line">    <span class="keyword">for</span> (<span class="keyword">int</span> userId : userIds) &#123;</span><br><span class="line">        grantRequestedRuntimePermissionsForUser(pkg, userId, grantedPermissions);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// We could have touched GID membership, so flush out packages.list</span></span><br><span class="line">    <span class="keyword">synchronized</span> (mPackages) &#123;</span><br><span class="line">        mSettings.writePackageListLPr();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>继续跟踪：</p>
<h3 id="3-3-1-grantRequestedRuntimePermissionsForUser"><a href="#3-3-1-grantRequestedRuntimePermissionsForUser" class="headerlink" title="3.3.1 grantRequestedRuntimePermissionsForUser"></a>3.3.1 grantRequestedRuntimePermissionsForUser</h3><p>下面的代码很简单：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">grantRequestedRuntimePermissionsForUser</span><span class="params">(PackageParser.Package pkg, <span class="keyword">int</span> userId,</span></span></span><br><span class="line"><span class="function"><span class="params">        String[] grantedPermissions)</span> </span>&#123;</span><br><span class="line">    SettingBase sb = (SettingBase) pkg.mExtras;</span><br><span class="line">    <span class="keyword">if</span> (sb == <span class="keyword">null</span>) &#123;</span><br><span class="line">        <span class="keyword">return</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    PermissionsState permissionsState = sb.getPermissionsState();</span><br><span class="line"></span><br><span class="line">    <span class="comment">//【1】对于 installer 他没有权限去改变 SYSTEM_FIXED 和 POLICY_FIXED 的权限状态！</span></span><br><span class="line">    <span class="keyword">final</span> <span class="keyword">int</span> immutableFlags = PackageManager.FLAG_PERMISSION_SYSTEM_FIXED</span><br><span class="line">            | PackageManager.FLAG_PERMISSION_POLICY_FIXED;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">for</span> (String permission : pkg.requestedPermissions) &#123;</span><br><span class="line">        <span class="keyword">final</span> BasePermission bp;</span><br><span class="line">        <span class="keyword">synchronized</span> (mPackages) &#123;</span><br><span class="line">            bp = mSettings.mPermissions.get(permission);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">if</span> (bp != <span class="keyword">null</span> &amp;&amp; (bp.isRuntime() || bp.isDevelopment())</span><br><span class="line">                &amp;&amp; (grantedPermissions == <span class="keyword">null</span></span><br><span class="line">                       || ArrayUtils.contains(grantedPermissions, permission))) &#123;</span><br><span class="line">            <span class="keyword">final</span> <span class="keyword">int</span> flags = permissionsState.getPermissionFlags(permission, userId);</span><br><span class="line">            <span class="comment">//【2】禁止修改！</span></span><br><span class="line">            <span class="keyword">if</span> ((flags &amp; immutableFlags) == <span class="number">0</span>) &#123;</span><br><span class="line">                <span class="comment">//【×3.2】授予运行时权限！</span></span><br><span class="line">                grantRuntimePermission(pkg.packageName, permission, userId);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></div></article><div class="post-copyright"><div class="post-copyright__author"><span class="post-copyright-meta">文章作者: </span><span class="post-copyright-info"><a href="mailto:undefined">Coolqi.Li</a></span></div><div class="post-copyright__type"><span class="post-copyright-meta">文章链接: </span><span class="post-copyright-info"><a href="https://coolqi.top/2017/08/25/Permission5-grantPermission/">https://coolqi.top/2017/08/25/Permission5-grantPermission/</a></span></div><div class="post-copyright__notice"><span class="post-copyright-meta">版权声明: </span><span class="post-copyright-info">本博客所有文章除特别声明外，均采用 <a href="https://creativecommons.org/licenses/by-nc-sa/4.0/">CC BY-NC-SA 4.0</a> 许可协议。转载请注明来自 <a href="https://coolqi.top">Coolqi`s Blog</a>！</span></div></div><div class="post-meta__tag-list"><a class="post-meta__tags" href="/tags/Permission权限管理/">Permission权限管理</a></div><div class="post-qr-code"><div class="post-qr-code-item"><img class="post-qr-code__img" src="/img/zfb.jpg"><div class="post-qr-code__desc">支付宝打赏</div></div><div class="post-qr-code-item"><img class="post-qr-code__img" src="/img/wechat.jpg"><div class="post-qr-code__desc">微信打赏</div></div></div><div class="social-share"></div><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/social-share.js@1.0.16/dist/css/share.min.css"><script src="https://cdn.jsdelivr.net/npm/social-share.js@1.0.16/dist/js/social-share.min.js"></script><nav id="pagination"><div class="prev-post pull-left"><a href="/2017/09/10/AppOps3-AppOpsWithMethods/"><i class="fa fa-chevron-left">  </i><span>AppOps 第 3 篇 - AppOps 权限相关方法</span></a></div><div class="next-post pull-right"><a href="/2017/08/15/AlarmManager3-triggerAlarm/"><span>AlarmManager第 3 篇 - trigger Alarm 流程分析</span><i class="fa fa-chevron-right"></i></a></div></nav><div class="post-adv"><a href="https://www.vultr.com/?ref=7231808"><img src="https://www.vultr.com/media/banner_1.png" width="728" height="90"></a></div></div></div><footer><div class="layout" id="footer"><div class="copyright">&copy;2015 - 2019 By Coolqi.Li</div><div class="framework-info"><span>驱动 - </span><a href="http://hexo.io"><span>Hexo</span></a><span class="footer-separator">|</span><span>主题 - </span><a href="https://github.com/Molunerfinn/hexo-theme-melody"><span>Melody</span></a></div><div class="footer_custom_text">Hi, welcome to my <a href="https://lishuaiqi.top/">blog</a>!</div><div class="busuanzi"><script async src="https://busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script><span id="busuanzi_container_page_pv"><i class="fa fa-file-o"></i><span id="busuanzi_value_page_pv"></span><span></span></span></div></div></footer><i class="fa fa-arrow-up" id="go-up" aria-hidden="true"></i><script src="/js/third-party/anime.min.js"></script><script src="/js/third-party/jquery.min.js"></script><script src="/js/third-party/jquery.fancybox.min.js"></script><script src="/js/third-party/velocity.min.js"></script><script src="/js/third-party/velocity.ui.min.js"></script><script src="/js/utils.js?version=1.5.6"></script><script src="/js/fancybox.js?version=1.5.6"></script><script src="/js/sidebar.js?version=1.5.6"></script><script src="/js/copy.js?version=1.5.6"></script><script src="/js/fireworks.js?version=1.5.6"></script><script src="/js/transition.js?version=1.5.6"></script><script src="/js/scroll.js?version=1.5.6"></script><script src="/js/head.js?version=1.5.6"></script><script type="text/x-mathjax-config">MathJax.Hub.Config({
  tex2jax: {
    inlineMath: [ ['$','$'], ["\\(","\\)"]  ],
    processEscapes: true,
    skipTags: ['script', 'noscript', 'style', 'textarea', 'pre', 'code']
  },
  CommonHTML: {
    linebreaks: { automatic: true, width: "90% container" }
  },
  "HTML-CSS": { 
    linebreaks: { automatic: true, width: "90% container" }
  },
  "SVG": { 
    linebreaks: { automatic: true, width: "90% container" }
  }
});
</script><script type="text/x-mathjax-config">MathJax.Hub.Queue(function() {
  var all = MathJax.Hub.getAllJax(), i;
  for (i=0; i < all.length; i += 1) {
    all[i].SourceElement().parentNode.className += ' has-jax';
  }
});
</script><script src="https://cdn.jsdelivr.net/npm/mathjax/MathJax.js?config=TeX-AMS-MML_HTMLorMML"></script><script src="/js/search/local-search.js"></script><div class="search-dialog" id="local-search"><div class="search-dialog__title" id="local-search-title">本地搜索</div><div id="local-input-panel"><div id="local-search-input"><div class="local-search-box"><input class="local-search-box--input" placeholder="搜索文章"></div></div></div><hr><div id="local-search-results"><div id="local-hits"></div><div id="local-stats"><div class="local-search-stats__hr" id="hr"><span>由</span> <a href="https://github.com/wzpan/hexo-generator-search" style="color:#49B1F5;">hexo-generator-search</a>
 <span>提供支持</span></div></div></div><span class="search-close-button"><i class="fa fa-times"></i></span></div><div class="search-mask"></div><script src="/live2dw/lib/L2Dwidget.min.js?0c58a1486de42ac6cc1c59c7d98ae887"></script><script>L2Dwidget.init({"pluginRootPath":"live2dw/","pluginJsPath":"lib/","pluginModelPath":"assets/","tagMode":false,"debug":false,"model":{"jsonPath":"live2d-widget-model-hijiki"},"display":{"position":"right","width":110,"height":220},"mobile":{"show":false},"log":false});</script></body></html>
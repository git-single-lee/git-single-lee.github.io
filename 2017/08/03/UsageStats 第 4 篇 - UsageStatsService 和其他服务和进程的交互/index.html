<!DOCTYPE html><html lang="zh-Hans"><head><meta charset="UTF-8"><meta http-equiv="X-UA-Compatible" content="IE=edge"><meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1"><meta name="description" content="UsageStats 第 4 篇 - UsageStatsService 和其他服务和进程的交互"><meta name="keywords" content="UsageStats使用状态管理"><meta name="author" content="Coolqi.Li,undefined"><meta name="copyright" content="Coolqi.Li"><title>UsageStats 第 4 篇 - UsageStatsService 和其他服务和进程的交互 | Coolqi`s Blog</title><link rel="shortcut icon" href="/img/favicon.ico"><link rel="stylesheet" href="/css/index.css?version=1.5.6"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/font-awesome@4.7.0/css/font-awesome.min.css?version=1.5.6"><link rel="dns-prefetch" href="https://cdn.staticfile.org"><link rel="dns-prefetch" href="https://cdn.bootcss.com"><link rel="dns-prefetch" href="https://creativecommons.org"><script>var GLOBAL_CONFIG = { 
  root: '/',
  algolia: undefined,
  localSearch: {"path":"search.xml","languages":{"hits_empty":"找不到您查询的内容:${query}"}},
  copy: {
    success: '复制成功',
    error: '复制错误',
    noSupport: '浏览器不支持'
  }
} </script></head><body><canvas class="fireworks"></canvas><i class="fa fa-arrow-right" id="toggle-sidebar" aria-hidden="true"></i><div id="sidebar"><div class="toggle-sidebar-info text-center"><span data-toggle="切换文章详情">切换站点概览</span><hr></div><div class="sidebar-toc"><div class="sidebar-toc__title">目录</div><div class="sidebar-toc__progress"><span class="progress-notice">你已经读了</span><span class="progress-num">0</span><span class="progress-percentage">%</span><div class="sidebar-toc__progress-bar"></div></div><div class="sidebar-toc__content"><ol class="toc"><li class="toc-item toc-level-1"><a class="toc-link" href="#0-综述"><span class="toc-text">0 综述</span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#1-和-UsageStatsService-通信的服务"><span class="toc-text">1 和 UsageStatsService 通信的服务</span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#2-ActivityManagerService"><span class="toc-text">2 ActivityManagerService</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#2-1-updateUsageStats"><span class="toc-text">2.1 updateUsageStats</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#2-1-1-调用时机"><span class="toc-text">2.1.1 调用时机</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#2-1-2-方法流程分析"><span class="toc-text">2.1.2 方法流程分析</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#2-1-3-LocalService-reportEvent"><span class="toc-text">2.1.3 LocalService.reportEvent</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#2-2-updateConfigurationLocked"><span class="toc-text">2.2 updateConfigurationLocked</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#2-2-1-调用时机"><span class="toc-text">2.2.1 调用时机</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#2-2-2-方法流程分析"><span class="toc-text">2.2.2 方法流程分析</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#2-2-3-LocalService-updateConfigurationLocked"><span class="toc-text">2.2.3 LocalService.updateConfigurationLocked</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#2-3-maybeUpdateProviderUsageStatsLocked"><span class="toc-text">2.3 maybeUpdateProviderUsageStatsLocked</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#2-3-1-调用时机"><span class="toc-text">2.3.1 调用时机</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#2-3-2-方法流程分析"><span class="toc-text">2.3.2 方法流程分析</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#2-3-3-LocalService-reportContentProviderUsage"><span class="toc-text">2.3.3 LocalService.reportContentProviderUsage</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#2-4-maybeUpdateUsageStatsLocked"><span class="toc-text">2.4 maybeUpdateUsageStatsLocked</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#2-4-1-调用时机"><span class="toc-text">2.4.1 调用时机</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#2-4-2-方法流程分析"><span class="toc-text">2.4.2 方法流程分析</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#2-4-3-LocalService-reportEvent"><span class="toc-text">2.4.3 LocalService.reportEvent</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#2-5-shutdown"><span class="toc-text">2.5 shutdown</span></a></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#3-NotificationManagerService"><span class="toc-text">3 NotificationManagerService</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#3-1-onStart"><span class="toc-text">3.1 onStart</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#3-2-setNotificationsShownFromListener"><span class="toc-text">3.2 setNotificationsShownFromListener</span></a></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#4-NetworkPolicyManagerService"><span class="toc-text">4 NetworkPolicyManagerService</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#4-1-systemReady"><span class="toc-text">4.1 systemReady</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#4-2-new-AppIdleStateChangeListener"><span class="toc-text">4.2 new AppIdleStateChangeListener</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#4-3-App-Idle-State-Changed"><span class="toc-text">4.3 App Idle State Changed</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#4-3-1-updateRuleForAppIdleUL"><span class="toc-text">4.3.1 updateRuleForAppIdleUL</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#4-3-1-1-setUidFirewallRule"><span class="toc-text">4.3.1.1 setUidFirewallRule</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#4-3-2-updateRulesForPowerRestrictionsUL-1"><span class="toc-text">4.3.2 updateRulesForPowerRestrictionsUL[1]</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#4-4-Parole-State-Changed"><span class="toc-text">4.4 Parole State Changed</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#4-4-1-updateRulesForAppIdleParoleUL"><span class="toc-text">4.4.1 updateRulesForAppIdleParoleUL</span></a></li></ol></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#5-AppIdleController"><span class="toc-text">5 AppIdleController</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#5-1-new-AppIdleController"><span class="toc-text">5.1 new AppIdleController</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#5-2-new-AppIdleStateChangeListener"><span class="toc-text">5.2 new AppIdleStateChangeListener</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#5-2-1-PackageUpdateFunc-process"><span class="toc-text">5.2.1 PackageUpdateFunc.process</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#5-2-2-setAppIdleParoleOn"><span class="toc-text">5.2.2 setAppIdleParoleOn</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#5-2-2-1-GlobalUpdateFunc-process"><span class="toc-text">5.2.2.1 GlobalUpdateFunc.process</span></a></li></ol></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#5-3-maybeStartTrackingJobLocked"><span class="toc-text">5.3 maybeStartTrackingJobLocked</span></a></li></ol></li></ol></div></div><div class="author-info hide"><div class="author-info__avatar text-center"><img src="/img/avatar.png"></div><div class="author-info__name text-center">Coolqi.Li</div><div class="author-info__description text-center">“你好，我是李帅奇，Android 系统工程师，MineCraft 忠实玩家，设计和绘画爱好者，缺妹纸晚期患者，熬夜星人。”</div><hr><div class="author-info-articles"><a class="author-info-articles__archives article-meta" href="/archives"><span class="pull-left">文章</span><span class="pull-right">64</span></a><a class="author-info-articles__tags article-meta" href="/tags"><span class="pull-left">标签</span><span class="pull-right">14</span></a><a class="author-info-articles__categories article-meta" href="/categories"><span class="pull-left">分类</span><span class="pull-right">15</span></a></div><hr><div class="author-info-links"><div class="author-info-links__title text-center">Links</div><a class="author-info-links__name text-center" href="https://developer.android.google.cn/">AndroidDeveloper</a><a class="author-info-links__name text-center" href="http://www.android-studio.org/">AndroidStudio</a><a class="author-info-links__name text-center" href="https://www.jianshu.com/u/123a20a96441">简书</a><a class="author-info-links__name text-center" href="https://weibo.com/coolqiLi">微博</a></div></div></div><div id="content-outer"><div id="top-container" style="background-image: url(https://ws1.sinaimg.cn/large/8700af19ly1fvpabr30o6j22yo1o0q7i.jpg)"><div id="page-header"><span class="pull-left"> <a id="site-name" href="/">Coolqi`s Blog</a></span><i class="fa fa-bars toggle-menu pull-right" aria-hidden="true"></i><span class="pull-right menus"><a class="site-page social-icon search"><i class="fa fa-search"></i><span> 搜索</span></a><a class="site-page" href="/">Home</a><a class="site-page" href="/categories">Categories</a><a class="site-page" href="/tags">Tags</a><a class="site-page" href="/about">About</a><a class="site-page" href="/archives">Archives</a></span></div><div id="post-info"><div id="post-title">UsageStats 第 4 篇 - UsageStatsService 和其他服务和进程的交互</div><div id="post-meta"><time class="post-meta__date"><i class="fa fa-calendar" aria-hidden="true"></i> 2017-08-03</time><span class="post-meta__separator">|</span><i class="fa fa-inbox post-meta__icon" aria-hidden="true"></i><a class="post-meta__categories" href="/categories/AndroidFramework源码分析/">AndroidFramework源码分析</a><i class="fa fa-angle-right" aria-hidden="true"></i><i class="fa fa-inbox post-meta__icon" aria-hidden="true"></i><a class="post-meta__categories" href="/categories/AndroidFramework源码分析/UsageStats使用状态管理/">UsageStats使用状态管理</a><div class="post-meta-wordcount"><span>字数总计: </span><span class="word-count">5.5k</span><span class="post-meta__separator">|</span><span>阅读时长: 28 分钟</span></div></div></div></div><div class="layout" id="content-inner"><article id="post"><div class="article-container" id="post-content"><p>[toc]</p>
<p>基于 Android7.1.1 源码分析 UsageStatsService 的架构和原理！</p>
<h1 id="0-综述"><a href="#0-综述" class="headerlink" title="0 综述"></a>0 综述</h1><p>本文主要分析 UsageStatsService 和其他服务 / 进程交互！</p>
<p>我们知道 UsageStatsService 内部有两个类 LocalService 和 BinderService，他们是 UsageStatsService 提供給其他服务或进程的通信接口类！</p>
<ul>
<li><strong>BinderService</strong></li>
</ul>
<p>BinderService 主要用于跨进程调用：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">private</span> <span class="keyword">final</span> <span class="class"><span class="keyword">class</span> <span class="title">BinderService</span> <span class="keyword">extends</span> <span class="title">IUsageStatsManager</span>.<span class="title">Stub</span> </span>&#123;...&#125;</span><br></pre></td></tr></table></figure>
<p>BinderService 继承了 IUsageStatsManager.Stub，作为服务端桩对象，注册进 ServiceManager！</p>
<p>我们在其他进程中可以通过 UsageStatsManager 来获得客户端代理对象！</p>
<ul>
<li><strong>LocalService</strong></li>
</ul>
<p>LocalService 用于系统进程中的其他服务调用，比如 ActivityManagerService，NotificationManagerService 等服务，下面是一些主要接口的调用逻辑：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">LocalService.reportEvent                 -&gt; UsageStatsService.H.MSG_REPORT_EVENT</span><br><span class="line">LocalService.reportConfigurationChange   -&gt; UsageStatsService.H.MSG_REPORT_EVENT</span><br><span class="line">LocalService.reportShortcutUsage         -&gt; UsageStatsService.H.MSG_REPORT_EVENT</span><br><span class="line">LocalService.reportContentProviderUsage  -&gt; UsageStatsService.H.MSG_REPORT_CONTENT_PROVIDER_USAGE</span><br><span class="line"></span><br><span class="line">LocalService.isAppIdle                   -&gt; UsageStatsService.isAppIdleFiltered</span><br><span class="line">LocalService.getIdleUidsForUser          -&gt; UsageStatsService.getIdleUidsForUse</span><br><span class="line">LocalService.isAppIdleParoleOn           -&gt; UsageStatsService.isParoledOrCharging</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">LocalService.addAppIdleStateChangeListener  -&gt; UsageStatsService.addListener</span><br></pre></td></tr></table></figure>
<p>我们重点关注 LocalService 的逻辑调用！</p>
<h1 id="1-和-UsageStatsService-通信的服务"><a href="#1-和-UsageStatsService-通信的服务" class="headerlink" title="1 和 UsageStatsService 通信的服务"></a>1 和 UsageStatsService 通信的服务</h1><ul>
<li><strong>ActivityManagerService</strong></li>
</ul>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">mActivityManagerService.setUsageStatsManager(</span><br><span class="line">        LocalServices.getService(UsageStatsManagerInternal.class));</span><br></pre></td></tr></table></figure>
<ul>
<li><strong>NotificationManagerService</strong></li>
</ul>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onStart</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    ... ... ...</span><br><span class="line">    mAppUsageStats = LocalServices.getService(UsageStatsManagerInternal.class);</span><br><span class="line">    ... ... ..</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<ul>
<li><strong>NetworkPolicyManagerService</strong></li>
</ul>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">systemReady</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    Trace.traceBegin(Trace.TRACE_TAG_NETWORK, <span class="string">"systemReady"</span>);</span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">        <span class="keyword">if</span> (!isBandwidthControlEnabled()) &#123;</span><br><span class="line">            Slog.w(TAG, <span class="string">"bandwidth controls disabled, unable to enforce policy"</span>);</span><br><span class="line">            <span class="keyword">return</span>;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        mUsageStats = LocalServices.getService(UsageStatsManagerInternal.class);</span><br><span class="line">    ... ... ...</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<ul>
<li><strong>AppIdleController</strong></li>
</ul>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">private</span> <span class="title">AppIdleController</span><span class="params">(JobSchedulerService service, Context context, Object lock)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">super</span>(service, context, lock);</span><br><span class="line">    mJobSchedulerService = service;</span><br><span class="line">    mUsageStatsInternal = LocalServices.getService(UsageStatsManagerInternal.class);</span><br><span class="line">    mAppIdleParoleOn = <span class="keyword">true</span>;</span><br><span class="line">    mUsageStatsInternal.addAppIdleStateChangeListener(<span class="keyword">new</span> AppIdleStateChangeListener());</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>主要有以上的服务！</p>
<h1 id="2-ActivityManagerService"><a href="#2-ActivityManagerService" class="headerlink" title="2 ActivityManagerService"></a>2 ActivityManagerService</h1><p>ActivityManagerService 和 UsageStatsService 交互可算是重头戏！</p>
<h2 id="2-1-updateUsageStats"><a href="#2-1-updateUsageStats" class="headerlink" title="2.1 updateUsageStats"></a>2.1 updateUsageStats</h2><p>updateUsageStats 方法用于更新 Activity 的使用信息！</p>
<h3 id="2-1-1-调用时机"><a href="#2-1-1-调用时机" class="headerlink" title="2.1.1 调用时机"></a>2.1.1 调用时机</h3><p>我们来看看调用时机：</p>
<ul>
<li><strong>ActivityStack.startPausingLocked</strong></li>
</ul>
<p>当 activty 进入 paused 状态的时候，会触发 startPausingLocked 方法！</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">final</span> <span class="keyword">boolean</span> <span class="title">startPausingLocked</span><span class="params">(<span class="keyword">boolean</span> userLeaving, <span class="keyword">boolean</span> uiSleeping,</span></span></span><br><span class="line"><span class="function"><span class="params">        ActivityRecord resuming, <span class="keyword">boolean</span> dontWait)</span> </span>&#123;</span><br><span class="line">    ... ... ...</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (prev.app != <span class="keyword">null</span> &amp;&amp; prev.app.thread != <span class="keyword">null</span>) &#123;</span><br><span class="line">        <span class="keyword">if</span> (DEBUG_PAUSE) Slog.v(TAG_PAUSE, <span class="string">"Enqueueing pending pause: "</span> + prev);</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            EventLog.writeEvent(EventLogTags.AM_PAUSE_ACTIVITY,</span><br><span class="line">                    prev.userId, System.identityHashCode(prev),</span><br><span class="line">                    prev.shortComponentName);</span><br><span class="line">            <span class="comment">//【2.1.2】记录 activity 组件的 UsageEvents.Event.MOVE_TO_BACKGROUND 事件！</span></span><br><span class="line">            mService.updateUsageStats(prev, <span class="keyword">false</span>);</span><br><span class="line">            <span class="comment">//【1】拉起 activity 的 onPause 方法！</span></span><br><span class="line">            prev.app.thread.schedulePauseActivity(prev.appToken, prev.finishing,</span><br><span class="line">                    userLeaving, prev.configChangeFlags, dontWait);</span><br><span class="line">        &#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">            <span class="comment">// Ignore exception, if process died other code will cleanup.</span></span><br><span class="line">            Slog.w(TAG, <span class="string">"Exception thrown during pause"</span>, e);</span><br><span class="line">            mPausingActivity = <span class="keyword">null</span>;</span><br><span class="line">            mLastPausedActivity = <span class="keyword">null</span>;</span><br><span class="line">            mLastNoHistoryActivity = <span class="keyword">null</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        mPausingActivity = <span class="keyword">null</span>;</span><br><span class="line">        mLastPausedActivity = <span class="keyword">null</span>;</span><br><span class="line">        mLastNoHistoryActivity = <span class="keyword">null</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    ... ... ...</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<ul>
<li><strong>ActivityStackSupervisor.reportResumedActivityLocked</strong></li>
</ul>
<p>当 activty 进入 resume 状态的时候，会触发 reportResumedActivityLocked 方法！<br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">boolean</span> <span class="title">reportResumedActivityLocked</span><span class="params">(ActivityRecord r)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">final</span> ActivityStack stack = r.task.stack;</span><br><span class="line">    <span class="keyword">if</span> (isFocusedStack(stack)) &#123;</span><br><span class="line">        <span class="comment">//【2.1.2】记录 activity 组件的 UsageEvents.Event.MOVE_TO_FOREGROUND 事件！</span></span><br><span class="line">        mService.updateUsageStats(r, <span class="keyword">true</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span> (allResumedActivitiesComplete()) &#123;</span><br><span class="line">        ensureActivitiesVisibleLocked(<span class="keyword">null</span>, <span class="number">0</span>, !PRESERVE_WINDOWS);</span><br><span class="line">        mWindowManager.executeAppTransition();</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">true</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">false</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<ul>
<li><strong>ActivityStack.handleAppDiedLocked</strong></li>
</ul>
<p>当 app process 死亡后，会触发 ActivityStack.handleAppDiedLocked 方法！</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">boolean</span> <span class="title">handleAppDiedLocked</span><span class="params">(ProcessRecord app)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">if</span> (mPausingActivity != <span class="keyword">null</span> &amp;&amp; mPausingActivity.app == app) &#123;</span><br><span class="line">        <span class="keyword">if</span> (DEBUG_PAUSE || DEBUG_CLEANUP) Slog.v(TAG_PAUSE,</span><br><span class="line">                <span class="string">"App died while pausing: "</span> + mPausingActivity);</span><br><span class="line">        mPausingActivity = <span class="keyword">null</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span> (mLastPausedActivity != <span class="keyword">null</span> &amp;&amp; mLastPausedActivity.app == app) &#123;</span><br><span class="line">        mLastPausedActivity = <span class="keyword">null</span>;</span><br><span class="line">        mLastNoHistoryActivity = <span class="keyword">null</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">//【1】调用自身的 removeHistoryRecordsForAppLocked 方法！</span></span><br><span class="line">    <span class="keyword">return</span> removeHistoryRecordsForAppLocked(app);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>进入 removeHistoryRecordsForAppLocked 方法！</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">boolean</span> <span class="title">removeHistoryRecordsForAppLocked</span><span class="params">(ProcessRecord app)</span> </span>&#123;</span><br><span class="line">     ... ... ...</span><br><span class="line">     <span class="keyword">for</span> (<span class="keyword">int</span> taskNdx = mTaskHistory.size() - <span class="number">1</span>; taskNdx &gt;= <span class="number">0</span>; --taskNdx) &#123;</span><br><span class="line">         <span class="keyword">final</span> ArrayList&lt;ActivityRecord&gt; activities = mTaskHistory.get(taskNdx).mActivities;</span><br><span class="line">         <span class="keyword">for</span> (<span class="keyword">int</span> activityNdx = activities.size() - <span class="number">1</span>; activityNdx &gt;= <span class="number">0</span>; --activityNdx) &#123;</span><br><span class="line">             <span class="keyword">final</span> ActivityRecord r = activities.get(activityNdx);</span><br><span class="line">             --i;</span><br><span class="line">             <span class="keyword">if</span> (DEBUG_CLEANUP) Slog.v(TAG_CLEANUP,</span><br><span class="line">                     <span class="string">"Record #"</span> + i + <span class="string">" "</span> + r + <span class="string">": app="</span> + r.app);</span><br><span class="line">             <span class="keyword">if</span> (r.app == app) &#123;</span><br><span class="line">                 <span class="keyword">if</span> (r.visible) &#123;</span><br><span class="line">                     hasVisibleActivities = <span class="keyword">true</span>;</span><br><span class="line">                 &#125;</span><br><span class="line">                 <span class="keyword">final</span> <span class="keyword">boolean</span> remove;</span><br><span class="line">                 ... ... ...</span><br><span class="line">                 <span class="keyword">if</span> (remove) &#123;</span><br><span class="line">                     <span class="keyword">if</span> (DEBUG_ADD_REMOVE || DEBUG_CLEANUP) Slog.i(TAG_ADD_REMOVE,</span><br><span class="line">                             <span class="string">"Removing activity "</span> + r + <span class="string">" from stack at "</span> + i</span><br><span class="line">                             + <span class="string">": haveState="</span> + r.haveState</span><br><span class="line">                             + <span class="string">" stateNotNeeded="</span> + r.stateNotNeeded</span><br><span class="line">                             + <span class="string">" finishing="</span> + r.finishing</span><br><span class="line">                             + <span class="string">" state="</span> + r.state + <span class="string">" callers="</span> + Debug.getCallers(<span class="number">5</span>));</span><br><span class="line">                     <span class="keyword">if</span> (!r.finishing) &#123;</span><br><span class="line">                         Slog.w(TAG, <span class="string">"Force removing "</span> + r + <span class="string">": app died, no saved state"</span>);</span><br><span class="line">                         EventLog.writeEvent(EventLogTags.AM_FINISH_ACTIVITY,</span><br><span class="line">                                 r.userId, System.identityHashCode(r),</span><br><span class="line">                                 r.task.taskId, r.shortComponentName,</span><br><span class="line">                                 <span class="string">"proc died without state saved"</span>);</span><br><span class="line">                         <span class="keyword">if</span> (r.state == ActivityState.RESUMED) &#123;</span><br><span class="line">                             <span class="comment">//【2.2.2】如果 activity 处于 resume 状态，记录状态！</span></span><br><span class="line">                             mService.updateUsageStats(r, <span class="keyword">false</span>);</span><br><span class="line">                         &#125;</span><br><span class="line">                     &#125;</span><br><span class="line">                 &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                     ... ... ..</span><br><span class="line">                 &#125;</span><br><span class="line">                 ... ... ...</span><br><span class="line">             &#125;</span><br><span class="line">         &#125;</span><br><span class="line">     &#125;</span><br><span class="line"></span><br><span class="line">     <span class="keyword">return</span> hasVisibleActivities;</span><br><span class="line"> &#125;</span><br></pre></td></tr></table></figure>
<p>逻辑很简单，不多说！</p>
<h3 id="2-1-2-方法流程分析"><a href="#2-1-2-方法流程分析" class="headerlink" title="2.1.2 方法流程分析"></a>2.1.2 方法流程分析</h3><p>参数 boolean resumed 表示是否处于 resume 状态！</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">updateUsageStats</span><span class="params">(ActivityRecord component, <span class="keyword">boolean</span> resumed)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">if</span> (DEBUG_SWITCH) Slog.d(TAG_SWITCH,</span><br><span class="line">            <span class="string">"updateUsageStats: comp="</span> + component + <span class="string">"res="</span> + resumed);</span><br><span class="line">    <span class="keyword">final</span> BatteryStatsImpl stats = mBatteryStatsService.getActiveStatistics();</span><br><span class="line">    <span class="keyword">if</span> (resumed) &#123;</span><br><span class="line">        <span class="keyword">if</span> (mUsageStatsService != <span class="keyword">null</span>) &#123;</span><br><span class="line">            <span class="comment">//【2.1.3】如果是 resume 状态，记录 UsageEvents.Event.MOVE_TO_FOREGROUND 事件！</span></span><br><span class="line">            mUsageStatsService.reportEvent(component.realActivity, component.userId,</span><br><span class="line">                    UsageEvents.Event.MOVE_TO_FOREGROUND);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">synchronized</span> (stats) &#123;</span><br><span class="line">            stats.noteActivityResumedLocked(component.app.uid);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        <span class="keyword">if</span> (mUsageStatsService != <span class="keyword">null</span>) &#123;</span><br><span class="line">            <span class="comment">//【2.1.3】如果不是 resume 状态，记录 UsageEvents.Event.MOVE_TO_BACKGROUND 事件！</span></span><br><span class="line">            mUsageStatsService.reportEvent(component.realActivity, component.userId,</span><br><span class="line">                    UsageEvents.Event.MOVE_TO_BACKGROUND);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">synchronized</span> (stats) &#123;</span><br><span class="line">            stats.noteActivityPausedLocked(component.app.uid);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>不多说了！</p>
<h3 id="2-1-3-LocalService-reportEvent"><a href="#2-1-3-LocalService-reportEvent" class="headerlink" title="2.1.3 LocalService.reportEvent"></a>2.1.3 LocalService.reportEvent</h3><p>这里最终调用了 reportEvent 方法，传入的 ComponentName component 为 Activity！<br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">reportEvent</span><span class="params">(ComponentName component, <span class="keyword">int</span> userId, <span class="keyword">int</span> eventType)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">if</span> (component == <span class="keyword">null</span>) &#123;</span><br><span class="line">        Slog.w(TAG, <span class="string">"Event reported without a component name"</span>);</span><br><span class="line">        <span class="keyword">return</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    UsageEvents.Event event = <span class="keyword">new</span> UsageEvents.Event();</span><br><span class="line">    event.mPackage = component.getPackageName();</span><br><span class="line">    event.mClass = component.getClassName();</span><br><span class="line"></span><br><span class="line">    event.mTimeStamp = SystemClock.elapsedRealtime();</span><br><span class="line"></span><br><span class="line">    event.mEventType = eventType;</span><br><span class="line">    <span class="comment">//【1】发送了 MSG_REPORT_EVENT 消息！</span></span><br><span class="line">    mHandler.obtainMessage(MSG_REPORT_EVENT, userId, <span class="number">0</span>, event).sendToTarget();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>不多说了！</p>
<h2 id="2-2-updateConfigurationLocked"><a href="#2-2-updateConfigurationLocked" class="headerlink" title="2.2 updateConfigurationLocked"></a>2.2 updateConfigurationLocked</h2><h3 id="2-2-1-调用时机"><a href="#2-2-1-调用时机" class="headerlink" title="2.2.1 调用时机"></a>2.2.1 调用时机</h3><p>主要是和 Configuration 配置更新相关的内容，调用地方过多，这里先不列出！</p>
<h3 id="2-2-2-方法流程分析"><a href="#2-2-2-方法流程分析" class="headerlink" title="2.2.2 方法流程分析"></a>2.2.2 方法流程分析</h3><p>和 updateConfigurationLocked 相关的有多个重载函数：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">updateConfiguration</span><span class="params">(Configuration values)</span> </span>&#123;</span><br><span class="line">    enforceCallingPermission(android.Manifest.permission.CHANGE_CONFIGURATION,</span><br><span class="line">            <span class="string">"updateConfiguration()"</span>);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">synchronized</span>(<span class="keyword">this</span>) &#123;</span><br><span class="line">        <span class="keyword">if</span> (values == <span class="keyword">null</span> &amp;&amp; mWindowManager != <span class="keyword">null</span>) &#123;</span><br><span class="line">            <span class="comment">// sentinel: fetch the current configuration from the window manager</span></span><br><span class="line">            values = mWindowManager.computeNewConfiguration();</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (mWindowManager != <span class="keyword">null</span>) &#123;</span><br><span class="line">            mProcessList.applyDisplaySize(mWindowManager);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">final</span> <span class="keyword">long</span> origId = Binder.clearCallingIdentity();</span><br><span class="line">        <span class="keyword">if</span> (values != <span class="keyword">null</span>) &#123;</span><br><span class="line">            Settings.System.clearConfiguration(values);</span><br><span class="line">        &#125;</span><br><span class="line">        updateConfigurationLocked(values, <span class="keyword">null</span>, <span class="keyword">false</span>);</span><br><span class="line">        Binder.restoreCallingIdentity(origId);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">updateUserConfigurationLocked</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    Configuration configuration = <span class="keyword">new</span> Configuration(mConfiguration);</span><br><span class="line">    Settings.System.adjustConfigurationForUser(mContext.getContentResolver(), configuration,</span><br><span class="line">            mUserController.getCurrentUserIdLocked(), Settings.System.canWrite(mContext));</span><br><span class="line">    updateConfigurationLocked(configuration, <span class="keyword">null</span>, <span class="keyword">false</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">boolean</span> <span class="title">updateConfigurationLocked</span><span class="params">(Configuration values, ActivityRecord starting,</span></span></span><br><span class="line"><span class="function"><span class="params">        <span class="keyword">boolean</span> initLocale)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">return</span> updateConfigurationLocked(values, starting, initLocale, <span class="keyword">false</span> <span class="comment">/* deferResume */</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">boolean</span> <span class="title">updateConfigurationLocked</span><span class="params">(Configuration values, ActivityRecord starting,</span></span></span><br><span class="line"><span class="function"><span class="params">        <span class="keyword">boolean</span> initLocale, <span class="keyword">boolean</span> deferResume)</span> </span>&#123;</span><br><span class="line">    <span class="comment">// pass UserHandle.USER_NULL as userId because we don't persist configuration for any user</span></span><br><span class="line">    <span class="keyword">return</span> updateConfigurationLocked(values, starting, initLocale, <span class="keyword">false</span> <span class="comment">/* persistent */</span>,</span><br><span class="line">            UserHandle.USER_NULL, deferResume);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>updateConfigurationLocked 方法用于更新指定 activity 的 Configuration 属性，主要有两个作用：</p>
<ul>
<li>改变当前的配置；</li>
<li>确保指定的 activity 使用的是当前最新的 activity；</li>
</ul>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">boolean</span> <span class="title">updateConfigurationLocked</span><span class="params">(Configuration values, ActivityRecord starting,</span></span></span><br><span class="line"><span class="function"><span class="params">        <span class="keyword">boolean</span> initLocale, <span class="keyword">boolean</span> persistent, <span class="keyword">int</span> userId, <span class="keyword">boolean</span> deferResume)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">int</span> changes = <span class="number">0</span>;</span><br><span class="line">    <span class="comment">//【1】停止布局！</span></span><br><span class="line">    <span class="keyword">if</span> (mWindowManager != <span class="keyword">null</span>) &#123;</span><br><span class="line">        mWindowManager.deferSurfaceLayout();</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">//【2】处理配置变化！</span></span><br><span class="line">    <span class="keyword">if</span> (values != <span class="keyword">null</span>) &#123;</span><br><span class="line">        <span class="comment">//【2.1】获得旧配置的拷贝；</span></span><br><span class="line">        Configuration newConfig = <span class="keyword">new</span> Configuration(mConfiguration);</span><br><span class="line">        <span class="comment">//【2.2】获得配置的更新信息！</span></span><br><span class="line">        changes = newConfig.updateFrom(values);</span><br><span class="line">        <span class="keyword">if</span> (changes != <span class="number">0</span>) &#123;</span><br><span class="line">            <span class="keyword">if</span> (DEBUG_SWITCH || DEBUG_CONFIGURATION) Slog.i(TAG_CONFIGURATION,</span><br><span class="line">                    <span class="string">"Updating configuration to: "</span> + values);</span><br><span class="line"></span><br><span class="line">            EventLog.writeEvent(EventLogTags.CONFIGURATION_CHANGED, changes);</span><br><span class="line">            </span><br><span class="line">            <span class="comment">//【2.3】处理多语言的更新！</span></span><br><span class="line">            <span class="keyword">if</span> (!initLocale &amp;&amp; !values.getLocales().isEmpty() &amp;&amp; values.userSetLocale) &#123;</span><br><span class="line">                <span class="keyword">final</span> LocaleList locales = values.getLocales();</span><br><span class="line">                <span class="keyword">int</span> bestLocaleIndex = <span class="number">0</span>;</span><br><span class="line">                <span class="keyword">if</span> (locales.size() &gt; <span class="number">1</span>) &#123;</span><br><span class="line">                    <span class="keyword">if</span> (mSupportedSystemLocales == <span class="keyword">null</span>) &#123;</span><br><span class="line">                        mSupportedSystemLocales =</span><br><span class="line">                                Resources.getSystem().getAssets().getLocales();</span><br><span class="line">                    &#125;</span><br><span class="line">                    bestLocaleIndex = Math.max(<span class="number">0</span>,</span><br><span class="line">                            locales.getFirstMatchIndex(mSupportedSystemLocales));</span><br><span class="line">                &#125;</span><br><span class="line">                SystemProperties.set(<span class="string">"persist.sys.locale"</span>,</span><br><span class="line">                        locales.get(bestLocaleIndex).toLanguageTag());</span><br><span class="line">                LocaleList.setDefault(locales, bestLocaleIndex);</span><br><span class="line">                mHandler.sendMessage(mHandler.obtainMessage(SEND_LOCALE_TO_MOUNT_DAEMON_MSG,</span><br><span class="line">                        locales.get(bestLocaleIndex)));</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="comment">//【2.4】计算本次更新的序列号；</span></span><br><span class="line">            mConfigurationSeq++;</span><br><span class="line">            <span class="keyword">if</span> (mConfigurationSeq &lt;= <span class="number">0</span>) &#123;</span><br><span class="line">                mConfigurationSeq = <span class="number">1</span>;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="comment">//【2.5】更新配置引用对象！</span></span><br><span class="line">            newConfig.seq = mConfigurationSeq;</span><br><span class="line">            mConfiguration = newConfig;</span><br><span class="line">            Slog.i(TAG, <span class="string">"Config changes="</span> + Integer.toHexString(changes) + <span class="string">" "</span> + newConfig);</span><br><span class="line">            </span><br><span class="line">            <span class="comment">//【×2.2.3】调用 reportConfigurationChange 方法！</span></span><br><span class="line">            mUsageStatsService.reportConfigurationChange(newConfig,</span><br><span class="line">                    mUserController.getCurrentUserIdLocked());</span><br><span class="line"></span><br><span class="line">            <span class="keyword">final</span> Configuration configCopy = <span class="keyword">new</span> Configuration(mConfiguration);</span><br><span class="line"></span><br><span class="line">            <span class="comment">// <span class="doctag">TODO:</span> If our config changes, should we auto dismiss any currently</span></span><br><span class="line">            <span class="comment">// showing dialogs?</span></span><br><span class="line">            mShowDialogs = shouldShowDialogs(newConfig, mInVrMode);</span><br><span class="line"></span><br><span class="line">            AttributeCache ac = AttributeCache.instance();</span><br><span class="line">            <span class="keyword">if</span> (ac != <span class="keyword">null</span>) &#123;</span><br><span class="line">                ac.updateConfiguration(configCopy);</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            <span class="comment">//【2.6】更新资源配置！</span></span><br><span class="line">            mSystemThread.applyConfigurationToResources(configCopy);</span><br><span class="line">            </span><br><span class="line">            <span class="keyword">if</span> (persistent &amp;&amp; Settings.System.hasInterestingConfigurationChanges(changes)) &#123;</span><br><span class="line">                Message msg = mHandler.obtainMessage(UPDATE_CONFIGURATION_MSG);</span><br><span class="line">                msg.obj = <span class="keyword">new</span> Configuration(configCopy);</span><br><span class="line">                msg.arg1 = userId;</span><br><span class="line">                mHandler.sendMessage(msg);</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="comment">//【2.7】调整屏幕密度改变</span></span><br><span class="line">            <span class="keyword">final</span> <span class="keyword">boolean</span> isDensityChange = (changes &amp; ActivityInfo.CONFIG_DENSITY) != <span class="number">0</span>;</span><br><span class="line">            <span class="keyword">if</span> (isDensityChange) &#123;</span><br><span class="line">                <span class="comment">// Reset the unsupported display size dialog.</span></span><br><span class="line">                mUiHandler.sendEmptyMessage(SHOW_UNSUPPORTED_DISPLAY_SIZE_DIALOG_MSG);</span><br><span class="line"></span><br><span class="line">                killAllBackgroundProcessesExcept(Build.VERSION_CODES.N,</span><br><span class="line">                        ActivityManager.PROCESS_STATE_FOREGROUND_SERVICE);</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="comment">//【2.8】修改进程的配置信息！</span></span><br><span class="line">            <span class="keyword">for</span> (<span class="keyword">int</span> i=mLruProcesses.size()-<span class="number">1</span>; i&gt;=<span class="number">0</span>; i--) &#123;</span><br><span class="line">                ProcessRecord app = mLruProcesses.get(i);</span><br><span class="line">                <span class="keyword">try</span> &#123;</span><br><span class="line">                    <span class="keyword">if</span> (app.thread != <span class="keyword">null</span>) &#123;</span><br><span class="line">                        <span class="keyword">if</span> (DEBUG_CONFIGURATION) Slog.v(TAG_CONFIGURATION, <span class="string">"Sending to proc "</span></span><br><span class="line">                                + app.processName + <span class="string">" new config "</span> + mConfiguration);</span><br><span class="line">                        app.thread.scheduleConfigurationChanged(configCopy);</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="comment">//【2.9】发送配置改变的广播！</span></span><br><span class="line">            Intent intent = <span class="keyword">new</span> Intent(Intent.ACTION_CONFIGURATION_CHANGED);</span><br><span class="line">            intent.addFlags(Intent.FLAG_RECEIVER_REGISTERED_ONLY</span><br><span class="line">                    | Intent.FLAG_RECEIVER_REPLACE_PENDING</span><br><span class="line">                    | Intent.FLAG_RECEIVER_FOREGROUND);</span><br><span class="line">            broadcastIntentLocked(<span class="keyword">null</span>, <span class="keyword">null</span>, intent, <span class="keyword">null</span>, <span class="keyword">null</span>, <span class="number">0</span>, <span class="keyword">null</span>, <span class="keyword">null</span>,</span><br><span class="line">                    <span class="keyword">null</span>, AppOpsManager.OP_NONE, <span class="keyword">null</span>, <span class="keyword">false</span>, <span class="keyword">false</span>,</span><br><span class="line">                    MY_PID, Process.SYSTEM_UID, UserHandle.USER_ALL);</span><br><span class="line">            <span class="keyword">if</span> ((changes&amp;ActivityInfo.CONFIG_LOCALE) != <span class="number">0</span>) &#123;</span><br><span class="line">                intent = <span class="keyword">new</span> Intent(Intent.ACTION_LOCALE_CHANGED);</span><br><span class="line">                intent.addFlags(Intent.FLAG_RECEIVER_FOREGROUND);</span><br><span class="line">         <span class="keyword">if</span> (initLocale || !mProcessesReady) &#123;</span><br><span class="line">                    intent.addFlags(Intent.FLAG_RECEIVER_REGISTERED_ONLY);</span><br><span class="line">                &#125;</span><br><span class="line">                broadcastIntentLocked(<span class="keyword">null</span>, <span class="keyword">null</span>, intent,</span><br><span class="line">                        <span class="keyword">null</span>, <span class="keyword">null</span>, <span class="number">0</span>, <span class="keyword">null</span>, <span class="keyword">null</span>, <span class="keyword">null</span>, AppOpsManager.OP_NONE,</span><br><span class="line">                        <span class="keyword">null</span>, <span class="keyword">false</span>, <span class="keyword">false</span>, MY_PID, Process.SYSTEM_UID, UserHandle.USER_ALL);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment">//【2.10】更新 wms 中的配置信息，并且检查在更新了配置后，是否有 stack 需要被 resize；</span></span><br><span class="line">        <span class="comment">// 如果有的话，那就进行 resize 和 relaunch！</span></span><br><span class="line">        <span class="keyword">if</span> (mWindowManager != <span class="keyword">null</span>) &#123;</span><br><span class="line">            <span class="keyword">final</span> <span class="keyword">int</span>[] resizedStacks = mWindowManager.setNewConfiguration(mConfiguration);</span><br><span class="line">            <span class="keyword">if</span> (resizedStacks != <span class="keyword">null</span>) &#123;</span><br><span class="line">                <span class="keyword">for</span> (<span class="keyword">int</span> stackId : resizedStacks) &#123;</span><br><span class="line">                    <span class="keyword">final</span> Rect newBounds = mWindowManager.getBoundsForNewConfiguration(stackId);</span><br><span class="line">                    mStackSupervisor.resizeStackLocked(</span><br><span class="line">                            stackId, newBounds, <span class="keyword">null</span>, <span class="keyword">null</span>, <span class="keyword">false</span>, <span class="keyword">false</span>, deferResume);</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">boolean</span> kept = <span class="keyword">true</span>;</span><br><span class="line">    <span class="keyword">final</span> ActivityStack mainStack = mStackSupervisor.getFocusedStack();</span><br><span class="line">    <span class="comment">//【4】获得焦点栈，调整 top activity 的配置信息！</span></span><br><span class="line">    <span class="comment">// mainStack is null during startup.</span></span><br><span class="line">    <span class="keyword">if</span> (mainStack != <span class="keyword">null</span>) &#123;</span><br><span class="line">        <span class="keyword">if</span> (changes != <span class="number">0</span> &amp;&amp; starting == <span class="keyword">null</span>) &#123;</span><br><span class="line">            starting = mainStack.topRunningActivityLocked();</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (starting != <span class="keyword">null</span>) &#123;</span><br><span class="line">            kept = mainStack.ensureActivityConfigurationLocked(starting, changes, <span class="keyword">false</span>);</span><br><span class="line">            mStackSupervisor.ensureActivitiesVisibleLocked(starting, changes,</span><br><span class="line">                    !PRESERVE_WINDOWS);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">//【5】继续布局！</span></span><br><span class="line">    <span class="keyword">if</span> (mWindowManager != <span class="keyword">null</span>) &#123;</span><br><span class="line">        mWindowManager.continueSurfaceLayout();</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> kept;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>这里调用了 UsageStatsService.reportConfigurationChange 方法，更新配置信息！</p>
<h3 id="2-2-3-LocalService-updateConfigurationLocked"><a href="#2-2-3-LocalService-updateConfigurationLocked" class="headerlink" title="2.2.3 LocalService.updateConfigurationLocked"></a>2.2.3 LocalService.updateConfigurationLocked</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">reportConfigurationChange</span><span class="params">(Configuration config, <span class="keyword">int</span> userId)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">if</span> (config == <span class="keyword">null</span>) &#123;</span><br><span class="line">        Slog.w(TAG, <span class="string">"Configuration event reported with a null config"</span>);</span><br><span class="line">        <span class="keyword">return</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    UsageEvents.Event event = <span class="keyword">new</span> UsageEvents.Event();</span><br><span class="line">    event.mPackage = <span class="string">"android"</span>;</span><br><span class="line"></span><br><span class="line">    event.mTimeStamp = SystemClock.elapsedRealtime();</span><br><span class="line"></span><br><span class="line">    event.mEventType = UsageEvents.Event.CONFIGURATION_CHANGE;</span><br><span class="line">    event.mConfiguration = <span class="keyword">new</span> Configuration(config);</span><br><span class="line">    mHandler.obtainMessage(MSG_REPORT_EVENT, userId, <span class="number">0</span>, event).sendToTarget();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>对于 config 相关的 event 来说，目标包名是 android！</p>
<h2 id="2-3-maybeUpdateProviderUsageStatsLocked"><a href="#2-3-maybeUpdateProviderUsageStatsLocked" class="headerlink" title="2.3 maybeUpdateProviderUsageStatsLocked"></a>2.3 maybeUpdateProviderUsageStatsLocked</h2><h3 id="2-3-1-调用时机"><a href="#2-3-1-调用时机" class="headerlink" title="2.3.1 调用时机"></a>2.3.1 调用时机</h3><ul>
<li><strong>ActivityManagerService.publishContentProviders</strong></li>
</ul>
<p>当注册 ContentProvider 的时候，会触发 publishContentProviders 方法！</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">final</span> <span class="keyword">void</span> <span class="title">publishContentProviders</span><span class="params">(IApplicationThread caller,</span></span></span><br><span class="line"><span class="function"><span class="params">        List&lt;ContentProviderHolder&gt; providers)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">if</span> (providers == <span class="keyword">null</span>) &#123;</span><br><span class="line">        <span class="keyword">return</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    enforceNotIsolatedCaller(<span class="string">"publishContentProviders"</span>);</span><br><span class="line">    <span class="keyword">synchronized</span> (<span class="keyword">this</span>) &#123;</span><br><span class="line">        <span class="keyword">final</span> ProcessRecord r = getRecordForAppLocked(caller);</span><br><span class="line">        <span class="keyword">if</span> (DEBUG_MU) Slog.v(TAG_MU, <span class="string">"ProcessRecord uid = "</span> + r.uid);</span><br><span class="line">        <span class="keyword">if</span> (r == <span class="keyword">null</span>) &#123;</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> SecurityException(</span><br><span class="line">                    <span class="string">"Unable to find app for caller "</span> + caller</span><br><span class="line">                  + <span class="string">" (pid="</span> + Binder.getCallingPid()</span><br><span class="line">                  + <span class="string">") when publishing content providers"</span>);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">final</span> <span class="keyword">long</span> origId = Binder.clearCallingIdentity();</span><br><span class="line"></span><br><span class="line">        <span class="keyword">final</span> <span class="keyword">int</span> N = providers.size();</span><br><span class="line">        <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; N; i++) &#123;</span><br><span class="line">            ContentProviderHolder src = providers.get(i);</span><br><span class="line">                ... ... ...</span><br><span class="line">                updateOomAdjLocked(r);</span><br><span class="line">                <span class="comment">//【2.3.2】调用 maybeUpdateProviderUsageStatsLocked 方法，记录 ContentProvider 使用信息！</span></span><br><span class="line">                maybeUpdateProviderUsageStatsLocked(r, src.info.packageName,</span><br><span class="line">                        src.info.authority);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        Binder.restoreCallingIdentity(origId);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<ul>
<li><strong>ActivityManagerService.getContentProviderImpl</strong></li>
</ul>
<p>当获得 ContentProvider 的时候，会触发 getContentProviderImpl 方法！<br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">private</span> ContentProviderHolder <span class="title">getContentProviderImpl</span><span class="params">(IApplicationThread caller,</span></span></span><br><span class="line"><span class="function"><span class="params">        String name, IBinder token, <span class="keyword">boolean</span> stable, <span class="keyword">int</span> userId)</span> </span>&#123;</span><br><span class="line">    ContentProviderRecord cpr;</span><br><span class="line">    ContentProviderConnection conn = <span class="keyword">null</span>;</span><br><span class="line">    ProviderInfo cpi = <span class="keyword">null</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">synchronized</span>(<span class="keyword">this</span>) &#123;</span><br><span class="line">        <span class="keyword">long</span> startTime = SystemClock.uptimeMillis();</span><br><span class="line">        </span><br><span class="line">        ... ... ...</span><br><span class="line">        </span><br><span class="line">        <span class="keyword">boolean</span> providerRunning = cpr != <span class="keyword">null</span> &amp;&amp; cpr.proc != <span class="keyword">null</span> &amp;&amp; !cpr.proc.killed;</span><br><span class="line">        <span class="keyword">if</span> (providerRunning) &#123;</span><br><span class="line">            cpi = cpr.info;</span><br><span class="line">            String msg;</span><br><span class="line">            checkTime(startTime, <span class="string">"getContentProviderImpl: before checkContentProviderPermission"</span>);</span><br><span class="line">            <span class="keyword">if</span> ((msg = checkContentProviderPermissionLocked(cpi, r, userId, checkCrossUser))</span><br><span class="line">                    != <span class="keyword">null</span>) &#123;</span><br><span class="line">                <span class="keyword">throw</span> <span class="keyword">new</span> SecurityException(msg);</span><br><span class="line">            &#125;</span><br><span class="line">            checkTime(startTime, <span class="string">"getContentProviderImpl: after checkContentProviderPermission"</span>);</span><br><span class="line"></span><br><span class="line">            <span class="keyword">if</span> (r != <span class="keyword">null</span> &amp;&amp; cpr.canRunHere(r)) &#123;</span><br><span class="line">                ContentProviderHolder holder = cpr.newHolder(<span class="keyword">null</span>);</span><br><span class="line">                holder.provider = <span class="keyword">null</span>;</span><br><span class="line">                <span class="keyword">return</span> holder;</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            <span class="keyword">final</span> <span class="keyword">long</span> origId = Binder.clearCallingIdentity();</span><br><span class="line"></span><br><span class="line">            checkTime(startTime, <span class="string">"getContentProviderImpl: incProviderCountLocked"</span>);</span><br><span class="line"></span><br><span class="line">            conn = incProviderCountLocked(r, cpr, token, stable);</span><br><span class="line">            <span class="keyword">if</span> (conn != <span class="keyword">null</span> &amp;&amp; (conn.stableCount+conn.unstableCount) == <span class="number">1</span>) &#123;</span><br><span class="line">                <span class="keyword">if</span> (cpr.proc != <span class="keyword">null</span> &amp;&amp; r.setAdj &lt;= ProcessList.PERCEPTIBLE_APP_ADJ) &#123;</span><br><span class="line">                    checkTime(startTime, <span class="string">"getContentProviderImpl: before updateLruProcess"</span>);</span><br><span class="line">                    updateLruProcessLocked(cpr.proc, <span class="keyword">false</span>, <span class="keyword">null</span>);</span><br><span class="line">                    checkTime(startTime, <span class="string">"getContentProviderImpl: after updateLruProcess"</span>);</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            checkTime(startTime, <span class="string">"getContentProviderImpl: before updateOomAdj"</span>);</span><br><span class="line">            <span class="keyword">final</span> <span class="keyword">int</span> verifiedAdj = cpr.proc.verifiedAdj;</span><br><span class="line">            <span class="keyword">boolean</span> success = updateOomAdjLocked(cpr.proc);</span><br><span class="line">            <span class="keyword">if</span> (success &amp;&amp; verifiedAdj != cpr.proc.setAdj &amp;&amp; !isProcessAliveLocked(cpr.proc)) &#123;</span><br><span class="line">                success = <span class="keyword">false</span>;</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            <span class="comment">//【2.2.2】调用 maybeUpdateProviderUsageStatsLocked 方法再次记录！</span></span><br><span class="line">            maybeUpdateProviderUsageStatsLocked(r, cpr.info.packageName, name);</span><br><span class="line">            checkTime(startTime, <span class="string">"getContentProviderImpl: after updateOomAdj"</span>);</span><br><span class="line">            <span class="keyword">if</span> (DEBUG_PROVIDER) Slog.i(TAG_PROVIDER, <span class="string">"Adjust success: "</span> + success);</span><br><span class="line"></span><br><span class="line">            <span class="keyword">if</span> (!success) &#123;</span><br><span class="line">                Slog.i(TAG, <span class="string">"Existing provider "</span> + cpr.name.flattenToShortString()</span><br><span class="line">                        + <span class="string">" is crashing; detaching "</span> + r);</span><br><span class="line">                <span class="keyword">boolean</span> lastRef = decProviderCountLocked(conn, cpr, token, stable);</span><br><span class="line">                checkTime(startTime, <span class="string">"getContentProviderImpl: before appDied"</span>);</span><br><span class="line">                appDiedLocked(cpr.proc);</span><br><span class="line">                checkTime(startTime, <span class="string">"getContentProviderImpl: after appDied"</span>);</span><br><span class="line">                <span class="keyword">if</span> (!lastRef) &#123;</span><br><span class="line">                    <span class="keyword">return</span> <span class="keyword">null</span>;</span><br><span class="line">                &#125;</span><br><span class="line">                providerRunning = <span class="keyword">false</span>;</span><br><span class="line">                conn = <span class="keyword">null</span>;</span><br><span class="line">            &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                cpr.proc.verifiedAdj = cpr.proc.setAdj;</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            Binder.restoreCallingIdentity(origId);</span><br><span class="line">        &#125;</span><br><span class="line">        ... ... ...</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">return</span> cpr != <span class="keyword">null</span> ? cpr.newHolder(conn) : <span class="keyword">null</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>对于 getContentProviderImpl 这里我们不再过多分析！</p>
<h3 id="2-3-2-方法流程分析"><a href="#2-3-2-方法流程分析" class="headerlink" title="2.3.2 方法流程分析"></a>2.3.2 方法流程分析</h3><p>maybeUpdateProviderUsageStatsLocked 方法中会进行事件上报！<br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">maybeUpdateProviderUsageStatsLocked</span><span class="params">(ProcessRecord app, String providerPkgName,</span></span></span><br><span class="line"><span class="function"><span class="params">        String authority)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">if</span> (app == <span class="keyword">null</span>) <span class="keyword">return</span>;</span><br><span class="line">    <span class="keyword">if</span> (app.curProcState &lt;= ActivityManager.PROCESS_STATE_IMPORTANT_FOREGROUND) &#123;</span><br><span class="line">        UserState userState = mUserController.getStartedUserStateLocked(app.userId);</span><br><span class="line">        <span class="keyword">if</span> (userState == <span class="keyword">null</span>) <span class="keyword">return</span>;</span><br><span class="line">        <span class="keyword">final</span> <span class="keyword">long</span> now = SystemClock.elapsedRealtime();</span><br><span class="line">        Long lastReported = userState.mProviderLastReportedFg.get(authority);</span><br><span class="line">        <span class="keyword">if</span> (lastReported == <span class="keyword">null</span> || lastReported &lt; now - <span class="number">60</span> * <span class="number">1000L</span>) &#123;</span><br><span class="line">            <span class="keyword">if</span> (mSystemReady) &#123;</span><br><span class="line">                <span class="comment">//【2.3.3】调用了 reportContentProviderUsage 方法！</span></span><br><span class="line">                mUsageStatsService.reportContentProviderUsage(</span><br><span class="line">                        authority, providerPkgName, app.userId);</span><br><span class="line">            &#125;</span><br><span class="line">            userState.mProviderLastReportedFg.put(authority, now);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<h3 id="2-3-3-LocalService-reportContentProviderUsage"><a href="#2-3-3-LocalService-reportContentProviderUsage" class="headerlink" title="2.3.3 LocalService.reportContentProviderUsage"></a>2.3.3 LocalService.reportContentProviderUsage</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">reportContentProviderUsage</span><span class="params">(String name, String packageName, <span class="keyword">int</span> userId)</span> </span>&#123;</span><br><span class="line">    SomeArgs args = SomeArgs.obtain();</span><br><span class="line">    args.arg1 = name;</span><br><span class="line">    args.arg2 = packageName;</span><br><span class="line">    args.arg3 = userId;</span><br><span class="line">    <span class="comment">//【1】发送了 MSG_REPORT_CONTENT_PROVIDER_USAGE 消息！</span></span><br><span class="line">    mHandler.obtainMessage(MSG_REPORT_CONTENT_PROVIDER_USAGE, args)</span><br><span class="line">            .sendToTarget();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>不多说了！</p>
<h2 id="2-4-maybeUpdateUsageStatsLocked"><a href="#2-4-maybeUpdateUsageStatsLocked" class="headerlink" title="2.4 maybeUpdateUsageStatsLocked"></a>2.4 maybeUpdateUsageStatsLocked</h2><h3 id="2-4-1-调用时机"><a href="#2-4-1-调用时机" class="headerlink" title="2.4.1 调用时机"></a>2.4.1 调用时机</h3><ul>
<li><strong>ActivityManagerService.applyOomAdjLocked</strong></li>
</ul>
<p>在调整进程的 oomAdj 的时候，会触发 maybeUpdateUsageStatsLocked！</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">final</span> <span class="keyword">boolean</span> <span class="title">applyOomAdjLocked</span><span class="params">(ProcessRecord app, <span class="keyword">boolean</span> doingAll, <span class="keyword">long</span> now,</span></span></span><br><span class="line"><span class="function"><span class="params">        <span class="keyword">long</span> nowElapsed)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">boolean</span> success = <span class="keyword">true</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (app.curRawAdj != app.setRawAdj) &#123;</span><br><span class="line">        app.setRawAdj = app.curRawAdj;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">int</span> changes = <span class="number">0</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (app.curAdj != app.setAdj) &#123;</span><br><span class="line">        ProcessList.setOomAdj(app.pid, app.info.uid, app.curAdj);</span><br><span class="line">        <span class="keyword">if</span> (DEBUG_SWITCH || DEBUG_OOM_ADJ) Slog.v(TAG_OOM_ADJ,</span><br><span class="line">                <span class="string">"Set "</span> + app.pid + <span class="string">" "</span> + app.processName + <span class="string">" adj "</span> + app.curAdj + <span class="string">": "</span></span><br><span class="line">                + app.adjType);</span><br><span class="line">        app.setAdj = app.curAdj;</span><br><span class="line">        app.verifiedAdj = ProcessList.INVALID_ADJ;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    ... ... ...</span><br><span class="line"></span><br><span class="line">    <span class="comment">//【1】当进程的 ProcState 发生了变化是，进入 IF 分支！</span></span><br><span class="line">    <span class="keyword">if</span> (app.setProcState != app.curProcState) &#123;</span><br><span class="line">        <span class="keyword">if</span> (DEBUG_SWITCH || DEBUG_OOM_ADJ) Slog.v(TAG_OOM_ADJ,</span><br><span class="line">                <span class="string">"Proc state change of "</span> + app.processName</span><br><span class="line">                        + <span class="string">" to "</span> + app.curProcState);</span><br><span class="line">        <span class="keyword">boolean</span> setImportant = app.setProcState &lt; ActivityManager.PROCESS_STATE_SERVICE;</span><br><span class="line">        <span class="keyword">boolean</span> curImportant = app.curProcState &lt; ActivityManager.PROCESS_STATE_SERVICE;</span><br><span class="line">        <span class="keyword">if</span> (setImportant &amp;&amp; !curImportant) &#123;</span><br><span class="line">            BatteryStatsImpl stats = mBatteryStatsService.getActiveStatistics();</span><br><span class="line">            <span class="keyword">synchronized</span> (stats) &#123;</span><br><span class="line">                app.lastWakeTime = stats.getProcessWakeTime(app.info.uid,</span><br><span class="line">                        app.pid, nowElapsed);</span><br><span class="line">            &#125;</span><br><span class="line">            app.lastCpuTime = app.curCpuTime;</span><br><span class="line"></span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment">//【2.4.1】在更新进程的状态之前，调用 maybeUpdateUsageStatsLocked 方法</span></span><br><span class="line">        <span class="comment">// 记录进程的信息！</span></span><br><span class="line">        maybeUpdateUsageStatsLocked(app, nowElapsed);</span><br><span class="line"></span><br><span class="line">        app.setProcState = app.curProcState;</span><br><span class="line">        <span class="keyword">if</span> (app.setProcState &gt;= ActivityManager.PROCESS_STATE_HOME) &#123;</span><br><span class="line">            app.notCachedSinceIdle = <span class="keyword">false</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">if</span> (!doingAll) &#123;</span><br><span class="line">            setProcessTrackerStateLocked(app, mProcessStats.getMemFactorLocked(), now);</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            app.procStateChanged = <span class="keyword">true</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125; <span class="keyword">else</span> <span class="keyword">if</span> (app.reportedInteraction &amp;&amp; (nowElapsed-app.interactionEventTime)</span><br><span class="line">            &gt; USAGE_STATS_INTERACTION_INTERVAL) &#123;</span><br><span class="line">        <span class="comment">//【2.4.1】对于长期处于互动状态的应用，我们需要每天至少报告一次，以免它们进入 idle 状态。</span></span><br><span class="line">        maybeUpdateUsageStatsLocked(app, nowElapsed);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    ... ... ...</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> success;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>这里调用了 maybeUpdateUsageStatsLocked 方法！</p>
<h3 id="2-4-2-方法流程分析"><a href="#2-4-2-方法流程分析" class="headerlink" title="2.4.2 方法流程分析"></a>2.4.2 方法流程分析</h3><p>下面我们来看看 maybeUpdateUsageStatsLocked 方法流程：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">maybeUpdateUsageStatsLocked</span><span class="params">(ProcessRecord app, <span class="keyword">long</span> nowElapsed)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">if</span> (DEBUG_USAGE_STATS) &#123;</span><br><span class="line">        Slog.d(TAG, <span class="string">"Checking proc ["</span> + Arrays.toString(app.getPackageList())</span><br><span class="line">                + <span class="string">"] state changes: old = "</span> + app.setProcState + <span class="string">", new = "</span></span><br><span class="line">                + app.curProcState);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span> (mUsageStatsService == <span class="keyword">null</span>) &#123;</span><br><span class="line">        <span class="keyword">return</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">//【1】判断此时进程是否处于交互中！        </span></span><br><span class="line">    <span class="keyword">boolean</span> isInteraction;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">if</span> (app.curProcState &lt;= ActivityManager.PROCESS_STATE_BOUND_FOREGROUND_SERVICE) &#123;</span><br><span class="line">        <span class="comment">//【2】如果进程的 curProcState 小于等于 PROCESS_STATE_BOUND_FOREGROUND_SERVICE: 3</span></span><br><span class="line">        <span class="comment">// 此时是处于交互状态的！</span></span><br><span class="line">        isInteraction = <span class="keyword">true</span>;</span><br><span class="line">        app.fgInteractionTime = <span class="number">0</span>;</span><br><span class="line">        </span><br><span class="line">    &#125; <span class="keyword">else</span> <span class="keyword">if</span> (app.curProcState &lt;= ActivityManager.PROCESS_STATE_TOP_SLEEPING) &#123;</span><br><span class="line">        <span class="comment">//【3】如果进程的 curProcState 小于等于 PROCESS_STATE_TOP_SLEEPING: 5</span></span><br><span class="line">        <span class="comment">// 进入这里！！</span></span><br><span class="line">        <span class="keyword">if</span> (app.fgInteractionTime == <span class="number">0</span>) &#123;</span><br><span class="line">            app.fgInteractionTime = nowElapsed;</span><br><span class="line">            isInteraction = <span class="keyword">false</span>;</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            isInteraction = nowElapsed &gt; app.fgInteractionTime + SERVICE_USAGE_INTERACTION_TIME;</span><br><span class="line">        &#125;</span><br><span class="line">        </span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        <span class="comment">//【4】如果 app.forcingToForeground 为 null，并且进程的 curProcState </span></span><br><span class="line">        <span class="comment">// 小于等于 PROCESS_STATE_IMPORTANT_FOREGROUND:6 说明该进程是可以被感知的重要进程！</span></span><br><span class="line">        <span class="comment">// isInteraction 为 true！</span></span><br><span class="line">        isInteraction = app.forcingToForeground == <span class="keyword">null</span></span><br><span class="line">                &amp;&amp; app.curProcState &lt;= ActivityManager.PROCESS_STATE_IMPORTANT_FOREGROUND;</span><br><span class="line">        app.fgInteractionTime = <span class="number">0</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//【5】如果本次进程是处于交互状态，并且上次是处于非交互状态（或者此时距离上次交互时间点超过了交互间隔）</span></span><br><span class="line">    <span class="comment">// 那么我们会上报一次记录！</span></span><br><span class="line">    <span class="keyword">if</span> (isInteraction &amp;&amp; (!app.reportedInteraction</span><br><span class="line">            || (nowElapsed-app.interactionEventTime) &gt; USAGE_STATS_INTERACTION_INTERVAL)) &#123;</span><br><span class="line">        app.interactionEventTime = nowElapsed;</span><br><span class="line">        String[] packages = app.getPackageList();</span><br><span class="line">        <span class="keyword">if</span> (packages != <span class="keyword">null</span>) &#123;</span><br><span class="line">            <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; packages.length; i++) &#123;</span><br><span class="line">                <span class="comment">//【5.1】调用了 reportEvent 方法，更新进程中所有 pacakge 的使用信息</span></span><br><span class="line">                <span class="comment">// event 类型为 SYSTEM_INTERACTION！</span></span><br><span class="line">                mUsageStatsService.reportEvent(packages[i], app.userId,</span><br><span class="line">                        UsageEvents.Event.SYSTEM_INTERACTION);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">//【6】更新 app.reportedInteraction 和 app.interactionEventTime！</span></span><br><span class="line">    app.reportedInteraction = isInteraction;</span><br><span class="line">    <span class="keyword">if</span> (!isInteraction) &#123;</span><br><span class="line">        app.interactionEventTime = <span class="number">0</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>最终调用了 UsageStatsService.reportEvent 方法！</p>
<h3 id="2-4-3-LocalService-reportEvent"><a href="#2-4-3-LocalService-reportEvent" class="headerlink" title="2.4.3 LocalService.reportEvent"></a>2.4.3 LocalService.reportEvent</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">reportEvent</span><span class="params">(String packageName, <span class="keyword">int</span> userId, <span class="keyword">int</span> eventType)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">if</span> (packageName == <span class="keyword">null</span>) &#123;</span><br><span class="line">        Slog.w(TAG, <span class="string">"Event reported without a package name"</span>);</span><br><span class="line">        <span class="keyword">return</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    UsageEvents.Event event = <span class="keyword">new</span> UsageEvents.Event();</span><br><span class="line">    event.mPackage = packageName;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// This will later be converted to system time.</span></span><br><span class="line">    event.mTimeStamp = SystemClock.elapsedRealtime();</span><br><span class="line"></span><br><span class="line">    event.mEventType = eventType;</span><br><span class="line">    mHandler.obtainMessage(MSG_REPORT_EVENT, userId, <span class="number">0</span>, event).sendToTarget();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h2 id="2-5-shutdown"><a href="#2-5-shutdown" class="headerlink" title="2.5 shutdown"></a>2.5 shutdown</h2><p>shutdown 主要用关机时候，保存重要的信息！<br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">boolean</span> <span class="title">shutdown</span><span class="params">(<span class="keyword">int</span> timeout)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">if</span> (checkCallingPermission(android.Manifest.permission.SHUTDOWN)</span><br><span class="line">            != PackageManager.PERMISSION_GRANTED) &#123;</span><br><span class="line">        <span class="keyword">throw</span> <span class="keyword">new</span> SecurityException(<span class="string">"Requires permission "</span></span><br><span class="line">                + android.Manifest.permission.SHUTDOWN);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">boolean</span> timedout = <span class="keyword">false</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">synchronized</span>(<span class="keyword">this</span>) &#123;</span><br><span class="line">        mShuttingDown = <span class="keyword">true</span>;</span><br><span class="line">        updateEventDispatchingLocked();</span><br><span class="line">        timedout = mStackSupervisor.shutdownLocked(timeout);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    mAppOpsService.shutdown();</span><br><span class="line">    <span class="keyword">if</span> (mUsageStatsService != <span class="keyword">null</span>) &#123;</span><br><span class="line">        <span class="comment">//【1】调用 UsageStatsService 的 prepareShutdown 方法！</span></span><br><span class="line">        mUsageStatsService.prepareShutdown();</span><br><span class="line">    &#125;</span><br><span class="line">    mBatteryStatsService.shutdown();</span><br><span class="line">    <span class="keyword">synchronized</span> (<span class="keyword">this</span>) &#123;</span><br><span class="line">        mProcessStats.shutdownLocked();</span><br><span class="line">        notifyTaskPersisterLocked(<span class="keyword">null</span>, <span class="keyword">true</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> timedout;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>这个逻辑不多说了！</p>
<h1 id="3-NotificationManagerService"><a href="#3-NotificationManagerService" class="headerlink" title="3 NotificationManagerService"></a>3 NotificationManagerService</h1><p>我们来看看 NotificationManagerService 和 UsageStatsService 的通信：</p>
<h2 id="3-1-onStart"><a href="#3-1-onStart" class="headerlink" title="3.1 onStart"></a>3.1 onStart</h2><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Override</span></span><br><span class="line"> <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onStart</span><span class="params">()</span> </span>&#123;</span><br><span class="line">     Resources resources = getContext().getResources();</span><br><span class="line"></span><br><span class="line">     mMaxPackageEnqueueRate = Settings.Global.getFloat(getContext().getContentResolver(),</span><br><span class="line">             Settings.Global.MAX_NOTIFICATION_ENQUEUE_RATE,</span><br><span class="line">             DEFAULT_MAX_NOTIFICATION_ENQUEUE_RATE);</span><br><span class="line">     ... ... ...</span><br><span class="line"></span><br><span class="line">     mAppUsageStats = LocalServices.getService(UsageStatsManagerInternal.class);</span><br></pre></td></tr></table></figure>
<h2 id="3-2-setNotificationsShownFromListener"><a href="#3-2-setNotificationsShownFromListener" class="headerlink" title="3.2 setNotificationsShownFromListener"></a>3.2 setNotificationsShownFromListener</h2><p>当通知可见后 setNotificationsShownFromListener 会被触发！</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">setNotificationsShownFromListener</span><span class="params">(INotificationListener token, String[] keys)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">long</span> identity = Binder.clearCallingIdentity();</span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">        <span class="keyword">synchronized</span> (mNotificationList) &#123;</span><br><span class="line">            <span class="keyword">final</span> ManagedServiceInfo info = mListeners.checkServiceTokenLocked(token);</span><br><span class="line">            <span class="keyword">if</span> (keys != <span class="keyword">null</span>) &#123;</span><br><span class="line">                <span class="keyword">final</span> <span class="keyword">int</span> N = keys.length;</span><br><span class="line">                <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; N; i++) &#123;</span><br><span class="line">                    NotificationRecord r = mNotificationsByKey.get(keys[i]);</span><br><span class="line">                    <span class="keyword">if</span> (r == <span class="keyword">null</span>) <span class="keyword">continue</span>;</span><br><span class="line">                    <span class="keyword">final</span> <span class="keyword">int</span> userId = r.sbn.getUserId();</span><br><span class="line">                    <span class="keyword">if</span> (userId != info.userid &amp;&amp; userId != UserHandle.USER_ALL &amp;&amp;</span><br><span class="line">                            !mUserProfiles.isCurrentProfile(userId)) &#123;</span><br><span class="line">                        <span class="keyword">throw</span> <span class="keyword">new</span> SecurityException(<span class="string">"Disallowed call from listener: "</span></span><br><span class="line">                                + info.service);</span><br><span class="line">                    &#125;</span><br><span class="line">                    <span class="keyword">if</span> (!r.isSeen()) &#123;</span><br><span class="line">                        <span class="keyword">if</span> (DBG) Slog.d(TAG, <span class="string">"Marking notification as seen "</span> + keys[i]);</span><br><span class="line">                        <span class="comment">//【1】调用了 UsageStatsService 的 reportEvent 方法！</span></span><br><span class="line">                        mAppUsageStats.reportEvent(r.sbn.getPackageName(),</span><br><span class="line">                                userId == UserHandle.USER_ALL ? UserHandle.USER_SYSTEM</span><br><span class="line">                                        : userId,</span><br><span class="line">                                UsageEvents.Event.USER_INTERACTION);</span><br><span class="line">                        r.setSeen();</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">        Binder.restoreCallingIdentity(identity);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>这里对传入的 UserId 做了一个判断，如果为 UserHandle.USER_ALL，那么就设置为 UserHandle.USER_SYSTEM！</p>
<p>最终，调用了 UsageStatsService.reportEvent 上报事件：<br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">mAppUsageStats.reportEvent(r.sbn.getPackageName(),</span><br><span class="line">        userId == UserHandle.USER_ALL ? UserHandle.USER_SYSTEM</span><br><span class="line">                : userId,</span><br><span class="line">        UsageEvents.Event.USER_INTERACTION);</span><br></pre></td></tr></table></figure></p>
<h1 id="4-NetworkPolicyManagerService"><a href="#4-NetworkPolicyManagerService" class="headerlink" title="4 NetworkPolicyManagerService"></a>4 NetworkPolicyManagerService</h1><p>我们来看看 NetworkPolicyManagerService 和 UsageStatsService 的通信方式！</p>
<h2 id="4-1-systemReady"><a href="#4-1-systemReady" class="headerlink" title="4.1 systemReady"></a>4.1 systemReady</h2><p>先来看看 NetworkPolicyManagerService 的 systemReady 方法！</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">systemReady</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    Trace.traceBegin(Trace.TRACE_TAG_NETWORK, <span class="string">"systemReady"</span>);</span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">        <span class="keyword">if</span> (!isBandwidthControlEnabled()) &#123;</span><br><span class="line">            Slog.w(TAG, <span class="string">"bandwidth controls disabled, unable to enforce policy"</span>);</span><br><span class="line">            <span class="keyword">return</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">//【1】获得了 UsageStats 对象！</span></span><br><span class="line">        mUsageStats = LocalServices.getService(UsageStatsManagerInternal.class);</span><br><span class="line">        ... ... ... ...</span><br><span class="line">        <span class="comment">//【2】注册 AppIdleStateChangeListener 监听器！</span></span><br><span class="line">        mUsageStats.addAppIdleStateChangeListener(<span class="keyword">new</span> AppIdleStateChangeListener());</span><br><span class="line">    &#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">        Trace.traceEnd(Trace.TRACE_TAG_NETWORK);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>可以看到，最关键的一个地方，就是监听器的注册！</p>
<h2 id="4-2-new-AppIdleStateChangeListener"><a href="#4-2-new-AppIdleStateChangeListener" class="headerlink" title="4.2 new AppIdleStateChangeListener"></a>4.2 new AppIdleStateChangeListener</h2><p>AppIdleStateChangeListener 继承了 UsageStatsManagerInternal.AppIdleStateChangeListener，覆写了两个父类方法：</p>
<ul>
<li><strong>onAppIdleStateChanged</strong>：用于监听 app idle 状态变化！</li>
</ul>
<ul>
<li><strong>onParoleStateChanged</strong>：用于监听 app 假释状态的变化！</li>
</ul>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">private</span> <span class="class"><span class="keyword">class</span> <span class="title">AppIdleStateChangeListener</span></span></span><br><span class="line"><span class="class">        <span class="keyword">extends</span> <span class="title">UsageStatsManagerInternal</span>.<span class="title">AppIdleStateChangeListener</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onAppIdleStateChanged</span><span class="params">(String packageName, <span class="keyword">int</span> userId, <span class="keyword">boolean</span> idle)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            <span class="keyword">final</span> <span class="keyword">int</span> uid = mContext.getPackageManager().getPackageUidAsUser(packageName,</span><br><span class="line">                    PackageManager.MATCH_UNINSTALLED_PACKAGES, userId);</span><br><span class="line">            <span class="keyword">if</span> (LOGV) Log.v(TAG, <span class="string">"onAppIdleStateChanged(): uid="</span> + uid + <span class="string">", idle="</span> + idle);</span><br><span class="line">            <span class="keyword">synchronized</span> (mUidRulesFirstLock) &#123;</span><br><span class="line">                <span class="comment">//【4.3.1】更新 app idle 规则；</span></span><br><span class="line">                updateRuleForAppIdleUL(uid);</span><br><span class="line">                <span class="comment">//【4.3.2】更新省电模式的规则；</span></span><br><span class="line">                updateRulesForPowerRestrictionsUL(uid);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125; <span class="keyword">catch</span> (NameNotFoundException nnfe) &#123;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onParoleStateChanged</span><span class="params">(<span class="keyword">boolean</span> isParoleOn)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">synchronized</span> (mUidRulesFirstLock) &#123;</span><br><span class="line">            <span class="comment">//【4.4.1】更新 app idle parole 规则；</span></span><br><span class="line">            updateRulesForAppIdleParoleUL();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h2 id="4-3-App-Idle-State-Changed"><a href="#4-3-App-Idle-State-Changed" class="headerlink" title="4.3 App Idle State Changed"></a>4.3 App Idle State Changed</h2><p>处理 app idle 状态的改变！</p>
<p>当 AppIdleStateChangeListener.onAppIdleStateChanged 触发！</p>
<h3 id="4-3-1-updateRuleForAppIdleUL"><a href="#4-3-1-updateRuleForAppIdleUL" class="headerlink" title="4.3.1 updateRuleForAppIdleUL"></a>4.3.1 updateRuleForAppIdleUL</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">updateRuleForAppIdleUL</span><span class="params">(<span class="keyword">int</span> uid)</span> </span>&#123;</span><br><span class="line">    <span class="comment">//【1】判断 uid 是否在名单中，在名单中的应用不受机制影响！！</span></span><br><span class="line">    <span class="keyword">if</span> (!isUidValidForBlacklistRules(uid)) <span class="keyword">return</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">int</span> appId = UserHandle.getAppId(uid);</span><br><span class="line">    <span class="keyword">if</span> (!mPowerSaveTempWhitelistAppIds.get(appId) &amp;&amp; isUidIdle(uid)</span><br><span class="line">            &amp;&amp; !isUidForegroundOnRestrictPowerUL(uid)) &#123;</span><br><span class="line">        <span class="comment">//【4.3.1.1】修改 FIREWALL_CHAIN_STANDBY 的规则为 FIREWALL_RULE_DENY</span></span><br><span class="line">        setUidFirewallRule(FIREWALL_CHAIN_STANDBY, uid, FIREWALL_RULE_DENY);</span><br><span class="line"></span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        <span class="comment">//【4.3.1.2】修改 FIREWALL_CHAIN_STANDBY 的规则为 FIREWALL_RULE_DEFAULT</span></span><br><span class="line">        setUidFirewallRule(FIREWALL_CHAIN_STANDBY, uid, FIREWALL_RULE_DEFAULT);</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h4 id="4-3-1-1-setUidFirewallRule"><a href="#4-3-1-1-setUidFirewallRule" class="headerlink" title="4.3.1.1 setUidFirewallRule"></a>4.3.1.1 setUidFirewallRule</h4><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">setUidFirewallRule</span><span class="params">(<span class="keyword">int</span> chain, <span class="keyword">int</span> uid, <span class="keyword">int</span> rule)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">if</span> (chain == FIREWALL_CHAIN_DOZABLE) &#123;</span><br><span class="line">        mUidFirewallDozableRules.put(uid, rule);</span><br><span class="line">    &#125; <span class="keyword">else</span> <span class="keyword">if</span> (chain == FIREWALL_CHAIN_STANDBY) &#123;</span><br><span class="line">        <span class="comment">//【1】将 FIREWALL_CHAIN_STANDBY 相关的规则加入 mUidFirewallStandbyRules！</span></span><br><span class="line">        mUidFirewallStandbyRules.put(uid, rule);</span><br><span class="line">    &#125; <span class="keyword">else</span> <span class="keyword">if</span> (chain == FIREWALL_CHAIN_POWERSAVE) &#123;</span><br><span class="line">        mUidFirewallPowerSaveRules.put(uid, rule);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">        mNetworkManager.setFirewallUidRule(chain, uid, rule);</span><br><span class="line">    &#125; <span class="keyword">catch</span> (IllegalStateException e) &#123;</span><br><span class="line">        Log.wtf(TAG, <span class="string">"problem setting firewall uid rules"</span>, e);</span><br><span class="line">    &#125; <span class="keyword">catch</span> (RemoteException e) &#123;</span><br><span class="line">        <span class="comment">// ignored; service lives in system_server</span></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h3 id="4-3-2-updateRulesForPowerRestrictionsUL-1"><a href="#4-3-2-updateRulesForPowerRestrictionsUL-1" class="headerlink" title="4.3.2 updateRulesForPowerRestrictionsUL[1]"></a>4.3.2 updateRulesForPowerRestrictionsUL[1]</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">updateRulesForPowerRestrictionsUL</span><span class="params">(<span class="keyword">int</span> uid)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">final</span> <span class="keyword">int</span> oldUidRules = mUidRules.get(uid, RULE_NONE);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">final</span> <span class="keyword">int</span> newUidRules = updateRulesForPowerRestrictionsUL(uid, oldUidRules, <span class="keyword">false</span>);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (newUidRules == RULE_NONE) &#123;</span><br><span class="line">        mUidRules.delete(uid);</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        mUidRules.put(uid, newUidRules);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h2 id="4-4-Parole-State-Changed"><a href="#4-4-Parole-State-Changed" class="headerlink" title="4.4 Parole State Changed"></a>4.4 Parole State Changed</h2><p>处理 app 假释状态的改变！</p>
<h3 id="4-4-1-updateRulesForAppIdleParoleUL"><a href="#4-4-1-updateRulesForAppIdleParoleUL" class="headerlink" title="4.4.1 updateRulesForAppIdleParoleUL"></a>4.4.1 updateRulesForAppIdleParoleUL</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br></pre></td><td class="code"><pre><span class="line">    <span class="function"><span class="keyword">void</span> <span class="title">updateRulesForAppIdleParoleUL</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="comment">//【1】判断此时是否处于假释状态！</span></span><br><span class="line">        <span class="keyword">boolean</span> paroled = mUsageStats.isAppIdleParoleOn();</span><br><span class="line"></span><br><span class="line">        <span class="comment">//【2】判断是否可以访问网网络！</span></span><br><span class="line">        <span class="keyword">boolean</span> enableChain = !paroled;</span><br><span class="line">        enableFirewallChainUL(FIREWALL_CHAIN_STANDBY, enableChain);</span><br><span class="line"></span><br><span class="line">        <span class="comment">//【3】遍历 mUidFirewallStandbyRules 中的所有 rule！</span></span><br><span class="line">        <span class="keyword">int</span> ruleCount = mUidFirewallStandbyRules.size();</span><br><span class="line">        <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; ruleCount; i++) &#123;</span><br><span class="line">            <span class="keyword">int</span> uid = mUidFirewallStandbyRules.keyAt(i);</span><br><span class="line">            <span class="keyword">int</span> oldRules = mUidRules.get(uid);</span><br><span class="line">            <span class="keyword">if</span> (enableChain) &#123;</span><br><span class="line">                <span class="comment">//【3.1】如果可以访问网络，取消掉 RULE_ALLOW_ALL/RULE_REJECT_ALL 位！</span></span><br><span class="line">                oldRules &amp;= MASK_METERED_NETWORKS;</span><br><span class="line"></span><br><span class="line">            &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                <span class="comment">//【3.2】如果不可以访问网络，并且 oldRules 没有设置 RULE_ALLOW_ALL/RULE_REJECT_ALL 位！</span></span><br><span class="line">                <span class="comment">// 那就跳过，否则进入下面的环节！</span></span><br><span class="line">                <span class="keyword">if</span> ((oldRules &amp; MASK_ALL_NETWORKS) == <span class="number">0</span>) <span class="keyword">continue</span>;</span><br><span class="line"></span><br><span class="line">            &#125;</span><br><span class="line">            <span class="comment">//【4.4.2】进入 updateRulesForPowerRestrictionsUL 方法！</span></span><br><span class="line">            updateRulesForPowerRestrictionsUL(uid, oldRules, paroled);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">``` </span><br><span class="line">### 4.4.2 updateRulesForPowerRestrictionsUL[3]</span><br><span class="line"></span><br><span class="line">```java</span><br><span class="line">    <span class="function"><span class="keyword">private</span> <span class="keyword">int</span> <span class="title">updateRulesForPowerRestrictionsUL</span><span class="params">(<span class="keyword">int</span> uid, <span class="keyword">int</span> oldUidRules, <span class="keyword">boolean</span> paroled)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">if</span> (!isUidValidForBlacklistRules(uid)) &#123;</span><br><span class="line">            <span class="keyword">if</span> (LOGD) Slog.d(TAG, <span class="string">"no need to update restrict power rules for uid "</span> + uid);</span><br><span class="line">            <span class="keyword">return</span> RULE_NONE;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">//【1】判断是否是 idle 状态！</span></span><br><span class="line">        <span class="keyword">final</span> <span class="keyword">boolean</span> isIdle = !paroled &amp;&amp; isUidIdle(uid);</span><br><span class="line">        <span class="comment">//【2】判断是否是强制模式！</span></span><br><span class="line">        <span class="keyword">final</span> <span class="keyword">boolean</span> restrictMode = isIdle || mRestrictPower || mDeviceIdleMode;</span><br><span class="line">        <span class="comment">//【3】判断 uid 下的进程是否是前台进程！</span></span><br><span class="line">        <span class="keyword">final</span> <span class="keyword">boolean</span> isForeground = isUidForegroundOnRestrictPowerUL(uid);</span><br><span class="line">        <span class="comment">//【4】判断 uid 是否在省电白名单中！</span></span><br><span class="line">        <span class="keyword">final</span> <span class="keyword">boolean</span> isWhitelisted = isWhitelistedBatterySaverUL(uid);</span><br><span class="line">        <span class="keyword">final</span> <span class="keyword">int</span> oldRule = oldUidRules &amp; MASK_ALL_NETWORKS;</span><br><span class="line">        <span class="keyword">int</span> newRule = RULE_NONE;</span><br><span class="line"></span><br><span class="line">        <span class="comment">//【5】</span></span><br><span class="line">        <span class="keyword">if</span> (isForeground) &#123;</span><br><span class="line">            <span class="keyword">if</span> (restrictMode) &#123;</span><br><span class="line">                newRule = RULE_ALLOW_ALL;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125; <span class="keyword">else</span> <span class="keyword">if</span> (restrictMode) &#123;</span><br><span class="line">            newRule = isWhitelisted ? RULE_ALLOW_ALL : RULE_REJECT_ALL;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment">//【6】计算新的 rules,oldUidRules &amp; MASK_METERED_NETWORKS 取消旧的高四位！</span></span><br><span class="line">        <span class="keyword">final</span> <span class="keyword">int</span> newUidRules = (oldUidRules &amp; MASK_METERED_NETWORKS) | newRule;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (LOGV) &#123;</span><br><span class="line">            Log.v(TAG, <span class="string">"updateRulesForPowerRestrictionsUL("</span> + uid + <span class="string">")"</span></span><br><span class="line">                    + <span class="string">", isIdle: "</span> + isIdle</span><br><span class="line">                    + <span class="string">", mRestrictPower: "</span> + mRestrictPower</span><br><span class="line">                    + <span class="string">", mDeviceIdleMode: "</span> + mDeviceIdleMode</span><br><span class="line">                    + <span class="string">", isForeground="</span> + isForeground</span><br><span class="line">                    + <span class="string">", isWhitelisted="</span> + isWhitelisted</span><br><span class="line">                    + <span class="string">", oldRule="</span> + uidRulesToString(oldRule)</span><br><span class="line">                    + <span class="string">", newRule="</span> + uidRulesToString(newRule)</span><br><span class="line">                    + <span class="string">", newUidRules="</span> + uidRulesToString(newUidRules)</span><br><span class="line">                    + <span class="string">", oldUidRules="</span> + uidRulesToString(oldUidRules));</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment">//【7】如果规则发生了变化，那就发送 MSG_RULES_CHANGED 消息！</span></span><br><span class="line">        <span class="keyword">if</span> (newRule != oldRule) &#123;</span><br><span class="line">            <span class="keyword">if</span> (newRule == RULE_NONE || (newRule &amp; RULE_ALLOW_ALL) != <span class="number">0</span>) &#123;</span><br><span class="line">                <span class="keyword">if</span> (LOGV) Log.v(TAG, <span class="string">"Allowing non-metered access for UID "</span> + uid);</span><br><span class="line">            &#125; <span class="keyword">else</span> <span class="keyword">if</span> ((newRule &amp; RULE_REJECT_ALL) != <span class="number">0</span>) &#123;</span><br><span class="line">                <span class="keyword">if</span> (LOGV) Log.v(TAG, <span class="string">"Rejecting non-metered access for UID "</span> + uid);</span><br><span class="line">            &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                Log.wtf(TAG, <span class="string">"Unexpected change of non-metered UID state for "</span> + uid</span><br><span class="line">                        + <span class="string">": foreground="</span> + isForeground</span><br><span class="line">                        + <span class="string">", whitelisted="</span> + isWhitelisted</span><br><span class="line">                        + <span class="string">", newRule="</span> + uidRulesToString(newUidRules)</span><br><span class="line">                        + <span class="string">", oldRule="</span> + uidRulesToString(oldUidRules));</span><br><span class="line">            &#125;</span><br><span class="line">            mHandler.obtainMessage(MSG_RULES_CHANGED, uid, newUidRules).sendToTarget();</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> newUidRules;</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure>
<h1 id="5-AppIdleController"><a href="#5-AppIdleController" class="headerlink" title="5 AppIdleController"></a>5 AppIdleController</h1><p>学习过 JobSchedulerSerivce，我们知道 AppIdleController 会判断 app 是否进入 idle 状态，这样动态控制 app 对应的 job！</p>
<h2 id="5-1-new-AppIdleController"><a href="#5-1-new-AppIdleController" class="headerlink" title="5.1 new AppIdleController"></a>5.1 new AppIdleController</h2><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">private</span> <span class="title">AppIdleController</span><span class="params">(JobSchedulerService service, Context context, Object lock)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">super</span>(service, context, lock);</span><br><span class="line">    mJobSchedulerService = service;</span><br><span class="line">    <span class="comment">//【1】获得 UsageStatsService 的 LocalService 对象！</span></span><br><span class="line">    mUsageStatsInternal = LocalServices.getService(UsageStatsManagerInternal.class);</span><br><span class="line">    <span class="comment">//【2】初始化 mAppIdleParoleOn 为 true！</span></span><br><span class="line">    mAppIdleParoleOn = <span class="keyword">true</span>;</span><br><span class="line">    <span class="comment">//【3】注册 AppIdleStateChangeListener 监听器！</span></span><br><span class="line">    mUsageStatsInternal.addAppIdleStateChangeListener(<span class="keyword">new</span> AppIdleStateChangeListener());</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h2 id="5-2-new-AppIdleStateChangeListener"><a href="#5-2-new-AppIdleStateChangeListener" class="headerlink" title="5.2 new AppIdleStateChangeListener"></a>5.2 new AppIdleStateChangeListener</h2><p>AppIdleStateChangeListener 用于监听 app idle 状态的变化！<br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">private</span> <span class="class"><span class="keyword">class</span> <span class="title">AppIdleStateChangeListener</span></span></span><br><span class="line"><span class="class">        <span class="keyword">extends</span> <span class="title">UsageStatsManagerInternal</span>.<span class="title">AppIdleStateChangeListener</span> </span>&#123;</span><br><span class="line">        </span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onAppIdleStateChanged</span><span class="params">(String packageName, <span class="keyword">int</span> userId, <span class="keyword">boolean</span> idle)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">boolean</span> changed = <span class="keyword">false</span>;</span><br><span class="line">        <span class="keyword">synchronized</span> (mLock) &#123;</span><br><span class="line">            <span class="comment">//【1】如果此时应用进入了假释状态，不处理！</span></span><br><span class="line">            <span class="keyword">if</span> (mAppIdleParoleOn) &#123;</span><br><span class="line">                <span class="keyword">return</span>;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="comment">//【2】为系统中的所有 Job 执行 PackageUpdateFunc 操作！</span></span><br><span class="line">            <span class="comment">// idle 表示是否处于 idle 状态！</span></span><br><span class="line">            PackageUpdateFunc update = <span class="keyword">new</span> PackageUpdateFunc(userId, packageName, idle);</span><br><span class="line">            mJobSchedulerService.getJobStore().forEachJob(update);</span><br><span class="line">            <span class="keyword">if</span> (update.mChanged) &#123;</span><br><span class="line">                changed = <span class="keyword">true</span>;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">//【3】通知 JobSchedulerService，AppIdleController 状态发生了变化！</span></span><br><span class="line">        <span class="comment">// 需要执行/停止 Job！</span></span><br><span class="line">        <span class="keyword">if</span> (changed) &#123;</span><br><span class="line">            mStateChangedListener.onControllerStateChanged();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onParoleStateChanged</span><span class="params">(<span class="keyword">boolean</span> isParoleOn)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">if</span> (DEBUG) &#123;</span><br><span class="line">            Slog.d(LOG_TAG, <span class="string">"Parole on: "</span> + isParoleOn);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">//【4】当应用的假释模式发生变化后，调用 setAppIdleParoleOn 方法！</span></span><br><span class="line">        setAppIdleParoleOn(isParoleOn);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<ul>
<li>当应用的 app idle 状态发生了变化，会触发 onAppIdleStateChanged 方法！</li>
<li>当应用的 app 假释状态发生了变化，会触发 onParoleStateChanged 方法！</li>
</ul>
<h3 id="5-2-1-PackageUpdateFunc-process"><a href="#5-2-1-PackageUpdateFunc-process" class="headerlink" title="5.2.1 PackageUpdateFunc.process"></a>5.2.1 PackageUpdateFunc.process</h3><p>当 app idle 状态变化后，会触发 AppIdleController.AppIdleStateChangeListener.onAppIdleStateChanged 方法！</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">final</span> <span class="keyword">static</span> <span class="class"><span class="keyword">class</span> <span class="title">PackageUpdateFunc</span> <span class="keyword">implements</span> <span class="title">JobStore</span>.<span class="title">JobStatusFunctor</span> </span>&#123;</span><br><span class="line">    <span class="keyword">final</span> <span class="keyword">int</span> mUserId;</span><br><span class="line">    <span class="keyword">final</span> String mPackage;</span><br><span class="line">    <span class="keyword">final</span> <span class="keyword">boolean</span> mIdle;</span><br><span class="line">    <span class="keyword">boolean</span> mChanged; <span class="comment">// 是否有 job 的条件发生变化！</span></span><br><span class="line"></span><br><span class="line">    PackageUpdateFunc(<span class="keyword">int</span> userId, String pkg, <span class="keyword">boolean</span> idle) &#123;</span><br><span class="line">        mUserId = userId;</span><br><span class="line">        mPackage = pkg;</span><br><span class="line">        mIdle = idle;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span> <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">process</span><span class="params">(JobStatus jobStatus)</span> </span>&#123;</span><br><span class="line">        <span class="comment">//【1】匹配到对应的 JobStatus！</span></span><br><span class="line">        <span class="keyword">if</span> (jobStatus.getSourcePackageName().equals(mPackage)</span><br><span class="line">                &amp;&amp; jobStatus.getSourceUserId() == mUserId) &#123;</span><br><span class="line"></span><br><span class="line">            <span class="comment">//【1.1】设置 Job 的 AppNotIdle 条件，如果 Job 的条件发生变化</span></span><br><span class="line">            <span class="comment">// mChanged 为 true！</span></span><br><span class="line">            <span class="keyword">if</span> (jobStatus.setAppNotIdleConstraintSatisfied(!mIdle)) &#123;</span><br><span class="line">                <span class="keyword">if</span> (DEBUG) &#123;</span><br><span class="line">                    Slog.d(LOG_TAG, <span class="string">"App Idle state changed, setting idle state of "</span></span><br><span class="line">                            + mPackage + <span class="string">" to "</span> + mIdle);</span><br><span class="line">                &#125;</span><br><span class="line">                mChanged = <span class="keyword">true</span>;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>
<p>jobStatus.setAppNotIdleConstraintSatisfied 方法用于设置 app 是否满足不处于 idle 状态下的条件！</p>
<h3 id="5-2-2-setAppIdleParoleOn"><a href="#5-2-2-setAppIdleParoleOn" class="headerlink" title="5.2.2 setAppIdleParoleOn"></a>5.2.2 setAppIdleParoleOn</h3><p>当应用的 app 假释状态发生了变化，会触发 setAppIdleParoleOn 方法！</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">setAppIdleParoleOn</span><span class="params">(<span class="keyword">boolean</span> isAppIdleParoleOn)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">boolean</span> changed = <span class="keyword">false</span>;</span><br><span class="line">    <span class="keyword">synchronized</span> (mLock) &#123;</span><br><span class="line">        <span class="comment">//【1】如果假释状态没有变化，不处理!</span></span><br><span class="line">        <span class="keyword">if</span> (mAppIdleParoleOn == isAppIdleParoleOn) &#123;</span><br><span class="line">            <span class="keyword">return</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">//【2】保存最新的假释状态！</span></span><br><span class="line">        mAppIdleParoleOn = isAppIdleParoleOn;</span><br><span class="line">        </span><br><span class="line">        <span class="comment">//【3】对所有的 Job 执行 GlobalUpdateFunc！</span></span><br><span class="line">        GlobalUpdateFunc update = <span class="keyword">new</span> GlobalUpdateFunc();</span><br><span class="line">        mJobSchedulerService.getJobStore().forEachJob(update);</span><br><span class="line">        </span><br><span class="line">        <span class="comment">//【4】如果 Job 触发条件变化，changed 为 true！</span></span><br><span class="line">        <span class="keyword">if</span> (update.mChanged) &#123;</span><br><span class="line">            changed = <span class="keyword">true</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">//【4】通知 JobSchedulerService，AppIdleController 状态发生了变化！</span></span><br><span class="line">    <span class="comment">// 需要执行/停止 Job！</span></span><br><span class="line">    <span class="keyword">if</span> (changed) &#123;</span><br><span class="line">        mStateChangedListener.onControllerStateChanged();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>方法流程很简单！</p>
<h4 id="5-2-2-1-GlobalUpdateFunc-process"><a href="#5-2-2-1-GlobalUpdateFunc-process" class="headerlink" title="5.2.2.1 GlobalUpdateFunc.process"></a>5.2.2.1 GlobalUpdateFunc.process</h4><p>我们来看看 GlobalUpdateFunc 的逻辑！<br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">final</span> <span class="class"><span class="keyword">class</span> <span class="title">GlobalUpdateFunc</span> <span class="keyword">implements</span> <span class="title">JobStore</span>.<span class="title">JobStatusFunctor</span> </span>&#123;</span><br><span class="line">    <span class="keyword">boolean</span> mChanged;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span> <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">process</span><span class="params">(JobStatus jobStatus)</span> </span>&#123;</span><br><span class="line">        String packageName = jobStatus.getSourcePackageName();</span><br><span class="line">        <span class="comment">//【1】判断 app 是否处于 idle 状态，满足条件是进入了 idle 状态，但是不能是假释状态！</span></span><br><span class="line">        <span class="keyword">final</span> <span class="keyword">boolean</span> appIdle = !mAppIdleParoleOn &amp;&amp; mUsageStatsInternal.isAppIdle(packageName,</span><br><span class="line">                jobStatus.getSourceUid(), jobStatus.getSourceUserId());</span><br><span class="line">        <span class="keyword">if</span> (DEBUG) &#123;</span><br><span class="line">            Slog.d(LOG_TAG, <span class="string">"Setting idle state of "</span> + packageName + <span class="string">" to "</span> + appIdle);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">//【2】修改 Job 的 appNotIdle 执行条件，如果条件发生了变化，mChanged 为 true！</span></span><br><span class="line">        <span class="keyword">if</span> (jobStatus.setAppNotIdleConstraintSatisfied(!appIdle)) &#123;</span><br><span class="line">            mChanged = <span class="keyword">true</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure></p>
<p>方法流程很简单！</p>
<h2 id="5-3-maybeStartTrackingJobLocked"><a href="#5-3-maybeStartTrackingJobLocked" class="headerlink" title="5.3 maybeStartTrackingJobLocked"></a>5.3 maybeStartTrackingJobLocked</h2><p>AppIdleController 开始监控指定的 Job！</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">maybeStartTrackingJobLocked</span><span class="params">(JobStatus jobStatus, JobStatus lastJob)</span> </span>&#123;</span><br><span class="line">    <span class="comment">//【1】如果还没有初始化过假释状态，进行初始化！</span></span><br><span class="line">    <span class="keyword">if</span> (!mInitializedParoleOn) &#123;</span><br><span class="line">        mInitializedParoleOn = <span class="keyword">true</span>;</span><br><span class="line">        <span class="comment">//【1.1】调用 UsageStatsService.isAppIdleParoleOn 方法判断此时是否是应用假释模式！</span></span><br><span class="line">        mAppIdleParoleOn = mUsageStatsInternal.isAppIdleParoleOn();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    String packageName = jobStatus.getSourcePackageName();</span><br><span class="line">    <span class="comment">//【2】判断 app 是否处于 app idle ，满足 2 个条件，应用处于 idle 状态，但是不能处于假释模式！</span></span><br><span class="line">    <span class="keyword">final</span> <span class="keyword">boolean</span> appIdle = !mAppIdleParoleOn &amp;&amp; mUsageStatsInternal.isAppIdle(packageName,</span><br><span class="line">            jobStatus.getSourceUid(), jobStatus.getSourceUserId());</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (DEBUG) &#123;</span><br><span class="line">        Slog.d(LOG_TAG, <span class="string">"Start tracking, setting idle state of "</span></span><br><span class="line">                + packageName + <span class="string">" to "</span> + appIdle);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">//【3】设置 Job 的条件属性！</span></span><br><span class="line">    jobStatus.setAppNotIdleConstraintSatisfied(!appIdle);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>方法流程很简单！</p>
</div></article><div class="post-copyright"><div class="post-copyright__author"><span class="post-copyright-meta">文章作者: </span><span class="post-copyright-info"><a href="mailto:undefined">Coolqi.Li</a></span></div><div class="post-copyright__type"><span class="post-copyright-meta">文章链接: </span><span class="post-copyright-info"><a href="https://coolqi.top/2017/08/03/UsageStats 第 4 篇 - UsageStatsService 和其他服务和进程的交互/">https://coolqi.top/2017/08/03/UsageStats 第 4 篇 - UsageStatsService 和其他服务和进程的交互/</a></span></div><div class="post-copyright__notice"><span class="post-copyright-meta">版权声明: </span><span class="post-copyright-info">本博客所有文章除特别声明外，均采用 <a href="https://creativecommons.org/licenses/by-nc-sa/4.0/">CC BY-NC-SA 4.0</a> 许可协议。转载请注明来自 <a href="https://coolqi.top">Coolqi`s Blog</a>！</span></div></div><div class="post-meta__tag-list"><a class="post-meta__tags" href="/tags/UsageStats使用状态管理/">UsageStats使用状态管理</a></div><div class="post-qr-code"><div class="post-qr-code-item"><img class="post-qr-code__img" src="/img/zfb.jpg"><div class="post-qr-code__desc">支付宝打赏</div></div><div class="post-qr-code-item"><img class="post-qr-code__img" src="/img/wechat.jpg"><div class="post-qr-code__desc">微信打赏</div></div></div><nav id="pagination"><div class="prev-post pull-left"><a href="/2017/08/13/AppOps 第 2 篇 - AppOpsManager 分析/"><i class="fa fa-chevron-left">  </i><span>AppOps 第 2 篇 - AppOpsManager 分析</span></a></div><div class="next-post pull-right"><a href="/2017/08/01/AppOps 第 1 篇 - AppOpsService 的启动/"><span>AppOps 第 1 篇 - AppOpsService 的启动</span><i class="fa fa-chevron-right"></i></a></div></nav><div class="post-adv"><a href="https://www.vultr.com/?ref=7231808"><img src="https://www.vultr.com/media/banner_1.png" width="728" height="90"></a></div></div></div><footer><div class="layout" id="footer"><div class="copyright">&copy;2015 - 2019 By Coolqi.Li</div><div class="framework-info"><span>驱动 - </span><a href="http://hexo.io"><span>Hexo</span></a><span class="footer-separator">|</span><span>主题 - </span><a href="https://github.com/Molunerfinn/hexo-theme-melody"><span>Melody</span></a></div><div class="footer_custom_text">Hi, welcome to my <a href="https://coolqi.top/">blog</a>!</div><div class="busuanzi"><script async src="//dn-lbstatics.qbox.me/busuanzi/2.3/busuanzi.pure.mini.js"></script><span id="busuanzi_container_page_pv"><i class="fa fa-file-o"></i><span id="busuanzi_value_page_pv"></span><span></span></span></div></div></footer><i class="fa fa-arrow-up" id="go-up" aria-hidden="true"></i><script src="/js/third-party/anime.min.js"></script><script src="/js/third-party/jquery.min.js"></script><script src="/js/third-party/jquery.fancybox.min.js"></script><script src="/js/third-party/velocity.min.js"></script><script src="/js/third-party/velocity.ui.min.js"></script><script src="/js/utils.js?version=1.5.6"></script><script src="/js/fancybox.js?version=1.5.6"></script><script src="/js/sidebar.js?version=1.5.6"></script><script src="/js/copy.js?version=1.5.6"></script><script src="/js/fireworks.js?version=1.5.6"></script><script src="/js/transition.js?version=1.5.6"></script><script src="/js/scroll.js?version=1.5.6"></script><script src="/js/head.js?version=1.5.6"></script><script type="text/x-mathjax-config">MathJax.Hub.Config({
  tex2jax: {
    inlineMath: [ ['$','$'], ["\\(","\\)"]  ],
    processEscapes: true,
    skipTags: ['script', 'noscript', 'style', 'textarea', 'pre', 'code']
  },
  CommonHTML: {
    linebreaks: { automatic: true, width: "90% container" }
  },
  "HTML-CSS": { 
    linebreaks: { automatic: true, width: "90% container" }
  },
  "SVG": { 
    linebreaks: { automatic: true, width: "90% container" }
  }
});
</script><script type="text/x-mathjax-config">MathJax.Hub.Queue(function() {
  var all = MathJax.Hub.getAllJax(), i;
  for (i=0; i < all.length; i += 1) {
    all[i].SourceElement().parentNode.className += ' has-jax';
  }
});
</script><script src="https://cdn.jsdelivr.net/npm/mathjax/MathJax.js?config=TeX-AMS-MML_HTMLorMML"></script><script src="/js/search/local-search.js"></script><div class="search-dialog" id="local-search"><div class="search-dialog__title" id="local-search-title">本地搜索</div><div id="local-input-panel"><div id="local-search-input"><div class="local-search-box"><input class="local-search-box--input" placeholder="搜索文章"></div></div></div><hr><div id="local-search-results"><div id="local-hits"></div><div id="local-stats"><div class="local-search-stats__hr" id="hr"><span>由</span> <a href="https://github.com/wzpan/hexo-generator-search" style="color:#49B1F5;">hexo-generator-search</a>
 <span>提供支持</span></div></div></div><span class="search-close-button"><i class="fa fa-times"></i></span></div><div class="search-mask"></div><script src="/live2dw/lib/L2Dwidget.min.js?0c58a1486de42ac6cc1c59c7d98ae887"></script><script>L2Dwidget.init({"pluginRootPath":"live2dw/","pluginJsPath":"lib/","pluginModelPath":"assets/","tagMode":false,"debug":false,"model":{"jsonPath":"/live2dw/assets/hijiki.model.json"},"display":{"position":"right","width":110,"height":220},"mobile":{"show":false},"log":false});</script></body></html>
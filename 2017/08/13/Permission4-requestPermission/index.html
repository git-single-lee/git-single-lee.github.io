<!DOCTYPE html><html lang="zh-Hans"><head><meta name="generator" content="Hexo 3.9.0"><meta charset="UTF-8"><meta http-equiv="X-UA-Compatible" content="IE=edge"><meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1"><meta name="description" content="Permission第 4 篇 - requestPermission 权限申请"><meta name="keywords" content="Permission权限管理"><meta name="author" content="Coolqi.Li"><meta name="copyright" content="Coolqi.Li"><title>Permission第 4 篇 - requestPermission 权限申请 | Coolqi`s Blog</title><link rel="shortcut icon" href="/img/favicon.ico"><link rel="stylesheet" href="/css/index.css?version=1.7.0"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/font-awesome@latest/css/font-awesome.min.css?version=1.7.0"><link rel="stylesheet" href="https://use.fontawesome.com/releases/v5.7.2/css/all.css?version=1.7.0"><meta name="format-detection" content="telephone=no"><meta http-equiv="x-dns-prefetch-control" content="on"><link rel="dns-prefetch" href="https://cdn.jsdelivr.net"><link rel="dns-prefetch" href="https://unpkg.com"><link rel="stylesheet" type="text/css" href="https://cdn.jsdelivr.net/npm/gitment/style/default.min.css"><script src="https://cdn.jsdelivr.net/npm/gitment/dist/gitment.browser.min.js"></script><script src="https://cdn.jsdelivr.net/npm/blueimp-md5@2.10.0/js/md5.min.js"></script><link rel="dns-prefetch" href="https://hm.baidu.com"><script>var _hmt = _hmt || [];
(function() {
  var hm = document.createElement("script");
  hm.src = "https://hm.baidu.com/hm.js?b7acef5306e54116ad8a99e8b753a92d";
  var s = document.getElementsByTagName("script")[0]; 
  s.parentNode.insertBefore(hm, s);
})();</script><script>var GLOBAL_CONFIG = { 
  root: '/',
  algolia: undefined,
  localSearch: {"path":"search.xml","languages":{"hits_empty":"找不到您查询的内容:${query}"}},
  copy: {
    success: '复制成功',
    error: '复制错误',
    noSupport: '浏览器不支持'
  }
} </script></head><body><i class="fa fa-arrow-right" id="toggle-sidebar" aria-hidden="true"></i><div id="sidebar" data-display="true"><div class="toggle-sidebar-info text-center"><span data-toggle="切换文章详情">切换站点概览</span><hr></div><div class="sidebar-toc"><div class="sidebar-toc__title">目录</div><div class="sidebar-toc__progress"><span class="progress-notice">你已经读了</span><span class="progress-num">0</span><span class="progress-percentage">%</span><div class="sidebar-toc__progress-bar"></div></div><div class="sidebar-toc__content"><ol class="toc"><li class="toc-item toc-level-1"><a class="toc-link" href="#0-综述"><span class="toc-text">0 综述</span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#1-Activity-requestPermissions-请求入口"><span class="toc-text">1 Activity.requestPermissions - 请求入口</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#1-1-PackageManager-buildRequestPermissionsIntent"><span class="toc-text">1.1 PackageManager.buildRequestPermissionsIntent</span></a></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#2-PackageInstaller-GrantPermissionsActivity"><span class="toc-text">2 PackageInstaller.GrantPermissionsActivity</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#2-1-GrantPermissionsActivity-onCreate"><span class="toc-text">2.1 GrantPermissionsActivity.onCreate</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#2-1-1-new-GrantPermissionsViewHandlerImpl-this"><span class="toc-text">2.1.1 new GrantPermissionsViewHandlerImpl(this)</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#2-1-2-GrantPermissionsActivity-setResultAndFinish"><span class="toc-text">2.1.2 GrantPermissionsActivity.setResultAndFinish</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#2-1-3-GrantPermissionsActivity-getCallingPackageInfo"><span class="toc-text">2.1.3 GrantPermissionsActivity.getCallingPackageInfo</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#2-1-3-1-PackageManagerS-getPackageInfo"><span class="toc-text">2.1.3.1 PackageManagerS.getPackageInfo</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#2-1-3-2-PackageManagerS-generatePackageInfo"><span class="toc-text">2.1.3.2 PackageManagerS.generatePackageInfo</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#2-1-3-3-PackageManagerS-generatePackageInfo"><span class="toc-text">2.1.3.3 PackageManagerS.generatePackageInfo</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#2-1-4-GrantPermissionsActivity-updateDefaultResults"><span class="toc-text">2.1.4 GrantPermissionsActivity.updateDefaultResults</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#2-1-4-1-GrantPermissionsActivity-computePermissionGrantState"><span class="toc-text">2.1.4.1 GrantPermissionsActivity.computePermissionGrantState</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#2-1-5-new-AppPermissions-封装-App-的权限请求信息"><span class="toc-text">2.1.5 new AppPermissions - 封装 App 的权限请求信息</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#2-1-5-1-AppPermissions-loadPermissionGroups"><span class="toc-text">2.1.5.1 AppPermissions.loadPermissionGroups</span></a><ol class="toc-child"><li class="toc-item toc-level-5"><a class="toc-link" href="#2-1-5-1-1-AppPermissions-hasGroupForPermission"><span class="toc-text">2.1.5.1.1 AppPermissions.hasGroupForPermission</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#2-1-5-1-2-AppPermissionGroup-create-3-创建运行时权限组信息"><span class="toc-text">2.1.5.1.2 AppPermissionGroup.create[3] - 创建运行时权限组信息</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#2-1-5-1-3-AppPermissionGroup-create-5"><span class="toc-text">2.1.5.1.3 AppPermissionGroup.create[5]</span></a><ol class="toc-child"><li class="toc-item toc-level-6"><a class="toc-link" href="#2-1-5-1-3-1-new-AppPermissionGroup"><span class="toc-text">2.1.5.1.3.1 new AppPermissionGroup</span></a></li><li class="toc-item toc-level-6"><a class="toc-link" href="#2-1-5-1-3-2-new-Permission"><span class="toc-text">2.1.5.1.3.2 new Permission</span></a></li><li class="toc-item toc-level-6"><a class="toc-link" href="#2-1-5-1-3-3-AppPermissionGroup-addPermission"><span class="toc-text">2.1.5.1.3.3 AppPermissionGroup.addPermission</span></a></li></ol></li></ol></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#2-1-6-处理运行时权限组"><span class="toc-text">2.1.6 处理运行时权限组</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#2-1-6-1-AppPermissionGroup-isUserFixed-isPolicyFixed"><span class="toc-text">2.1.6.1 AppPermissionGroup.isUserFixed/isPolicyFixed</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#2-1-6-2-AppPermissionGroup-areRuntimePermissionsGranted"><span class="toc-text">2.1.6.2 AppPermissionGroup.areRuntimePermissionsGranted</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#2-1-7-GPViewHandlerImpl-createView"><span class="toc-text">2.1.7 GPViewHandlerImpl.createView</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#2-1-7-1-GrantPermissionsActivity-onPermissionGrantResult"><span class="toc-text">2.1.7.1 GrantPermissionsActivity.onPermissionGrantResult</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#2-1-8-GPViewHandlerImpl-showNextPermissionGroupGrantRequest"><span class="toc-text">2.1.8 GPViewHandlerImpl.showNextPermissionGroupGrantRequest</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#2-1-8-1-GPViewHandlerImpl-updateUi"><span class="toc-text">2.1.8.1 GPViewHandlerImpl.updateUi</span></a><ol class="toc-child"><li class="toc-item toc-level-5"><a class="toc-link" href="#2-1-8-1-1-GPViewHandlerImpl-updateDescription"><span class="toc-text">2.1.8.1.1 GPViewHandlerImpl.updateDescription</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#2-1-8-1-2-GPViewHandlerImpl-updateGroup"><span class="toc-text">2.1.8.1.2 GPViewHandlerImpl.updateGroup</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#2-1-8-1-3-GPViewHandlerImpl-updateDoNotAskCheckBox"><span class="toc-text">2.1.8.1.3 GPViewHandlerImpl.updateDoNotAskCheckBox</span></a></li></ol></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#2-1-9-GrantPermissionsActivity-setResultAndFinish"><span class="toc-text">2.1.9 GrantPermissionsActivity.setResultAndFinish</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#2-1-9-1-RequestActivity-onRequestPermissionsResult"><span class="toc-text">2.1.9.1 RequestActivity.onRequestPermissionsResult</span></a></li></ol></li></ol></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#3-AppPermissionGroup-Grant-or-Revoke-授予-拒绝"><span class="toc-text">3 AppPermissionGroup: Grant or Revoke - 授予/拒绝</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#3-1-AppPermissionGroup-grantRuntimePermissions"><span class="toc-text">3.1 AppPermissionGroup.grantRuntimePermissions</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#3-2-AppPermissionGroup-revokeRuntimePermissions"><span class="toc-text">3.2 AppPermissionGroup.revokeRuntimePermissions</span></a></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#4-PackageManagerService-Grant-or-Revoke-核心接口"><span class="toc-text">4 PackageManagerService: Grant or Revoke - 核心接口</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#4-1-PackageManagerS-grantRuntimePermission"><span class="toc-text">4.1 PackageManagerS.grantRuntimePermission</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#4-2-PackageManagerS-revokeRuntimePermission"><span class="toc-text">4.2 PackageManagerS.revokeRuntimePermission</span></a></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#5-Activity-shouldShowRequestPermissionRationale-解释权限含义"><span class="toc-text">5 Activity.shouldShowRequestPermissionRationale - 解释权限含义</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#5-1-PackageManagerS-shouldShowRequestPermissionRationale"><span class="toc-text">5.1 PackageManagerS.shouldShowRequestPermissionRationale</span></a></li></ol></li></ol></div></div><div class="author-info hide"><div class="author-info__avatar text-center"><img src="/img/avatar.jpg"></div><div class="author-info__name text-center">Coolqi.Li</div><div class="author-info__description text-center">“Hi，我是李帅奇，Android 开发工程师，熬夜星人，一个努力赚钱，积极向上的好人。微信公众号：CoolOriLans (酷奇源语)”</div><div class="follow-button"><a href="https://github.com/git-single-lee">Follow Me</a></div><hr><div class="author-info-articles"><a class="author-info-articles__archives article-meta" href="/archives"><span class="pull-left">文章</span><span class="pull-right">90</span></a><a class="author-info-articles__tags article-meta" href="/tags"><span class="pull-left">标签</span><span class="pull-right">23</span></a><a class="author-info-articles__categories article-meta" href="/categories"><span class="pull-left">分类</span><span class="pull-right">29</span></a></div><hr><div class="author-info-links"><div class="author-info-links__title text-center">coolqi 和他的朋友们</div><a class="author-info-links__name text-center" href="https://developer.android.google.cn/">AndroidDeveloper</a><a class="author-info-links__name text-center" href="http://www.android-studio.org/">AndroidStudio</a><a class="author-info-links__name text-center" href="https://www.jianshu.com/u/123a20a96441">个人简书</a><a class="author-info-links__name text-center" href="https://weibo.com/coolqiLi">个人微博</a><a class="author-info-links__name text-center" href="https://www.jianshu.com/u/fd0b722ce11f">小二哥的 Android 站</a></div></div></div><div id="content-outer"><div id="top-container" style="background-image: url(/img/blog-bg.jpg)"><div id="page-header"><span class="pull-left"> <a id="site-name" href="/">Coolqi`s Blog</a></span><i class="fa fa-bars toggle-menu pull-right" aria-hidden="true"></i><span class="pull-right menus">   <a class="site-page" href="/">Home</a><a class="site-page" href="/categories">Categories</a><a class="site-page" href="/tags">Tags</a><a class="site-page" href="/archives">Archives</a><a class="site-page" href="/about">About</a></span><span class="pull-right"><a class="site-page social-icon search"><i class="fa fa-search"></i><span> 搜索</span></a></span></div><div id="post-info"><div id="post-title">Permission第 4 篇 - requestPermission 权限申请</div><div id="post-meta"><time class="post-meta__date"><i class="fa fa-calendar" aria-hidden="true"></i> 2017-08-13</time><span class="post-meta__separator">|</span><i class="fa fa-inbox post-meta__icon" aria-hidden="true"></i><a class="post-meta__categories" href="/categories/AndroidFramework源码分析/">AndroidFramework源码分析</a><i class="fa fa-angle-right" aria-hidden="true"></i><i class="fa fa-inbox post-meta__icon" aria-hidden="true"></i><a class="post-meta__categories" href="/categories/AndroidFramework源码分析/Permission权限管理/">Permission权限管理</a><div class="post-meta-wordcount"><span>字数总计: </span><span class="word-count">10.6k</span><span class="post-meta__separator">|</span><span>阅读时长: 48 分钟</span></div></div></div></div><div class="layout" id="content-inner"><article id="post"><div class="article-container" id="post-content"><p>[TOC]</p>
<h1 id="0-综述"><a href="#0-综述" class="headerlink" title="0 综述"></a>0 综述</h1><p>基于 Android 7.1.1 源码，分析系统的权限管理机制！</p>
<p>我们来分析下 dangerous 权限的申请，这类权限只能在 Activity 中申请，Activity 提供了如下接口，来帮助程序申请权限：</p>
<h1 id="1-Activity-requestPermissions-请求入口"><a href="#1-Activity-requestPermissions-请求入口" class="headerlink" title="1 Activity.requestPermissions - 请求入口"></a>1 Activity.requestPermissions - 请求入口</h1><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">final</span> <span class="keyword">void</span> <span class="title">requestPermissions</span><span class="params">(@NonNull String[] permissions, <span class="keyword">int</span> requestCode)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">if</span> (mHasCurrentPermissionsRequest) &#123;</span><br><span class="line">        Log.w(TAG, <span class="string">"Can reqeust only one set of permissions at a time"</span>);</span><br><span class="line">        <span class="comment">//【1】防止同一时间多次申请权限！</span></span><br><span class="line">        onRequestPermissionsResult(requestCode, <span class="keyword">new</span> String[<span class="number">0</span>], <span class="keyword">new</span> <span class="keyword">int</span>[<span class="number">0</span>]);</span><br><span class="line">        <span class="keyword">return</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">//【2】设置了发送给 packageInstaller 的 intent！</span></span><br><span class="line">    Intent intent = getPackageManager().buildRequestPermissionsIntent(permissions);</span><br><span class="line">    startActivityForResult(REQUEST_PERMISSIONS_WHO_PREFIX, intent, requestCode, <span class="keyword">null</span>);</span><br><span class="line">    mHasCurrentPermissionsRequest = <span class="keyword">true</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h2 id="1-1-PackageManager-buildRequestPermissionsIntent"><a href="#1-1-PackageManager-buildRequestPermissionsIntent" class="headerlink" title="1.1 PackageManager.buildRequestPermissionsIntent"></a>1.1 PackageManager.buildRequestPermissionsIntent</h2><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> Intent <span class="title">buildRequestPermissionsIntent</span><span class="params">(@NonNull String[] permissions)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">if</span> (ArrayUtils.isEmpty(permissions)) &#123;</span><br><span class="line">       <span class="keyword">throw</span> <span class="keyword">new</span> IllegalArgumentException(<span class="string">"permission cannot be null or empty"</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    Intent intent = <span class="keyword">new</span> Intent(ACTION_REQUEST_PERMISSIONS);</span><br><span class="line">    intent.putExtra(EXTRA_REQUEST_PERMISSIONS_NAMES, permissions);</span><br><span class="line">    intent.setPackage(getPermissionControllerPackageName());</span><br><span class="line">    <span class="keyword">return</span> intent;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>这里创建了一个 intent，action 为 android.content.pm.action.REQUEST_PERMISSIONS，同时用 intent 封装了权限信息！<br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@SystemApi</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> String ACTION_REQUEST_PERMISSIONS =</span><br><span class="line">        <span class="string">"android.content.pm.action.REQUEST_PERMISSIONS"</span>; <span class="comment">// hide</span></span><br><span class="line"><span class="meta">@SystemApi</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> String EXTRA_REQUEST_PERMISSIONS_NAMES =</span><br><span class="line">        <span class="string">"android.content.pm.extra.REQUEST_PERMISSIONS_NAMES"</span>;</span><br></pre></td></tr></table></figure></p>
<p>接下来，我们要问，谁会接受这个 intent 呢？</p>
<p>下面还调用了 getPermissionControllerPackageName 方法，设置了 intent 的接收者<br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> String <span class="title">getPermissionControllerPackageName</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    <span class="keyword">synchronized</span> (mPackages) &#123;</span><br><span class="line">        <span class="keyword">return</span> mRequiredInstallerPackage; <span class="comment">// 就是 PackageInstaller！</span></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>就是 PackageInstaller，我们需要进入 PackageInstaller，分析接下来的逻辑！</p>
<h1 id="2-PackageInstaller-GrantPermissionsActivity"><a href="#2-PackageInstaller-GrantPermissionsActivity" class="headerlink" title="2 PackageInstaller.GrantPermissionsActivity"></a>2 PackageInstaller.GrantPermissionsActivity</h1><p>通过分析 PackageInstaller 的代码，我们知道了 GrantPermissionsActivity 会接受该 intent！</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">activity</span> <span class="attr">android:name</span>=<span class="string">".permission.ui.GrantPermissionsActivity"</span></span></span><br><span class="line"><span class="tag">        <span class="attr">android:configChanges</span>=<span class="string">"orientation|keyboardHidden|screenSize"</span></span></span><br><span class="line"><span class="tag">        <span class="attr">android:excludeFromRecents</span>=<span class="string">"true"</span></span></span><br><span class="line"><span class="tag">        <span class="attr">android:theme</span>=<span class="string">"@style/GrantPermissions"</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">intent-filter</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">action</span> <span class="attr">android:name</span>=<span class="string">"android.content.pm.action.REQUEST_PERMISSIONS"</span> /&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">category</span> <span class="attr">android:name</span>=<span class="string">"android.intent.category.DEFAULT"</span> /&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">intent-filter</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">activity</span>&gt;</span></span><br></pre></td></tr></table></figure>
<p>GrantPermissionsActivity 虽然是一个 Activity，但实际的现实效果是一个 Dialog，下面我们会一个一个分析！</p>
<h2 id="2-1-GrantPermissionsActivity-onCreate"><a href="#2-1-GrantPermissionsActivity-onCreate" class="headerlink" title="2.1 GrantPermissionsActivity.onCreate"></a>2.1 GrantPermissionsActivity.onCreate</h2><p>我们去 onCreate 方法中去看看：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">GrantPermissionsActivity</span> <span class="keyword">extends</span> <span class="title">OverlayTouchActivity</span></span></span><br><span class="line"><span class="class">        <span class="keyword">implements</span> <span class="title">GrantPermissionsViewHandler</span>.<span class="title">ResultListener</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onCreate</span><span class="params">(Bundle icicle)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">super</span>.onCreate(icicle);</span><br><span class="line">        setFinishOnTouchOutside(<span class="keyword">false</span>);</span><br><span class="line"></span><br><span class="line">        setTitle(R.string.permission_request_title);</span><br><span class="line">        <span class="comment">// 根据不同的设备类型进行不同的操作！</span></span><br><span class="line">        <span class="keyword">if</span> (DeviceUtils.isTelevision(<span class="keyword">this</span>)) &#123;</span><br><span class="line">            mViewHandler = <span class="keyword">new</span> com.android.packageinstaller.permission.ui.television</span><br><span class="line">                    .GrantPermissionsViewHandlerImpl(<span class="keyword">this</span>).setResultListener(<span class="keyword">this</span>);</span><br><span class="line">        &#125; <span class="keyword">else</span> <span class="keyword">if</span> (DeviceUtils.isWear(<span class="keyword">this</span>)) &#123;</span><br><span class="line">            mViewHandler = <span class="keyword">new</span> GrantPermissionsWatchViewHandler(<span class="keyword">this</span>).setResultListener(<span class="keyword">this</span>);</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            <span class="comment">//【2.1.1】对于 Android 来说，进入这里，创建了一个 GrantPermissionsViewHandlerImpl，用于显示权限弹窗</span></span><br><span class="line">            <span class="comment">// 以及和处理和弹窗相关的逻辑！</span></span><br><span class="line">            mViewHandler = <span class="keyword">new</span> com.android.packageinstaller.permission.ui.handheld</span><br><span class="line">                    .GrantPermissionsViewHandlerImpl(<span class="keyword">this</span>).setResultListener(<span class="keyword">this</span>);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">//【1】获得应用本次要请求的运行时权限！</span></span><br><span class="line">        mRequestedPermissions = getIntent().getStringArrayExtra(</span><br><span class="line">                PackageManager.EXTRA_REQUEST_PERMISSIONS_NAMES);</span><br><span class="line">        <span class="keyword">if</span> (mRequestedPermissions == <span class="keyword">null</span>) &#123;</span><br><span class="line">            mRequestedPermissions = <span class="keyword">new</span> String[<span class="number">0</span>];</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">//【2】创建每个权限对应的授结果况数组，默认值为！</span></span><br><span class="line">        <span class="keyword">final</span> <span class="keyword">int</span> requestedPermCount = mRequestedPermissions.length;</span><br><span class="line">        mGrantResults = <span class="keyword">new</span> <span class="keyword">int</span>[requestedPermCount];</span><br><span class="line">        Arrays.fill(mGrantResults, PackageManager.PERMISSION_DENIED);</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (requestedPermCount == <span class="number">0</span>) &#123; <span class="comment">// 如果请求权限的数量为 0 ，无法申请！</span></span><br><span class="line">            <span class="comment">//【2.1.2】调用 setResultAndFinish 结束申请！</span></span><br><span class="line">            setResultAndFinish();</span><br><span class="line">            <span class="keyword">return</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">//【2.1.3】获得请求的应用程序信息</span></span><br><span class="line">        PackageInfo callingPackageInfo = getCallingPackageInfo();</span><br><span class="line">        <span class="comment">// 如果应用程序不存在，或者应用程序没有申请权限，无法申请！</span></span><br><span class="line">        <span class="keyword">if</span> (callingPackageInfo == <span class="keyword">null</span> || callingPackageInfo.requestedPermissions == <span class="keyword">null</span></span><br><span class="line">                || callingPackageInfo.requestedPermissions.length &lt;= <span class="number">0</span>) &#123;</span><br><span class="line">            setResultAndFinish();</span><br><span class="line">            <span class="keyword">return</span>;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 如果应用程序的 targetSdkVersion 低于 Android M，不能申请运行时权限，直接取消！</span></span><br><span class="line">        <span class="keyword">if</span> (callingPackageInfo.applicationInfo.targetSdkVersion &lt; Build.VERSION_CODES.M) &#123;</span><br><span class="line">            mRequestedPermissions = <span class="keyword">new</span> String[<span class="number">0</span>];</span><br><span class="line">            mGrantResults = <span class="keyword">new</span> <span class="keyword">int</span>[<span class="number">0</span>];</span><br><span class="line">            setResultAndFinish();</span><br><span class="line">            <span class="keyword">return</span>;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment">//【2.1.4】通过 DevicePolicyManager 获得设备对于权限的配置，然后根据配置信息，更新运行时权限的默认状态！</span></span><br><span class="line">        DevicePolicyManager devicePolicyManager = getSystemService(DevicePolicyManager.class);</span><br><span class="line">        <span class="keyword">final</span> <span class="keyword">int</span> permissionPolicy = devicePolicyManager.getPermissionPolicy(<span class="keyword">null</span>);</span><br><span class="line">        updateDefaultResults(callingPackageInfo, permissionPolicy);</span><br><span class="line"></span><br><span class="line">        <span class="comment">//【2.1.5】创建了一个 AppPermissions 对象！</span></span><br><span class="line">        mAppPermissions = <span class="keyword">new</span> AppPermissions(<span class="keyword">this</span>, callingPackageInfo, <span class="keyword">null</span>, <span class="keyword">false</span>,</span><br><span class="line">                <span class="keyword">new</span> Runnable() &#123;</span><br><span class="line">                    <span class="meta">@Override</span></span><br><span class="line">                    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">run</span><span class="params">()</span> </span>&#123;</span><br><span class="line">                        setResultAndFinish();</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;);</span><br><span class="line"></span><br><span class="line">        <span class="comment">//【3】接着遍历本次请求的所有运行时权限！</span></span><br><span class="line">        <span class="keyword">for</span> (String requestedPermission : mRequestedPermissions) &#123;</span><br><span class="line">            AppPermissionGroup group = <span class="keyword">null</span>;</span><br><span class="line">            <span class="comment">//【3.1】找到该运行时权限所在的 group，我们会授予该组内的所有运行时权限！</span></span><br><span class="line">            <span class="keyword">for</span> (AppPermissionGroup nextGroup : mAppPermissions.getPermissionGroups()) &#123;</span><br><span class="line">                <span class="keyword">if</span> (nextGroup.hasPermission(requestedPermission)) &#123;</span><br><span class="line">                    group = nextGroup;</span><br><span class="line">                    <span class="keyword">break</span>;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">if</span> (group == <span class="keyword">null</span>) &#123;</span><br><span class="line">                <span class="keyword">continue</span>;</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            <span class="comment">//【2.1.6】处理那些没有被 fix 的需要提醒的权限！</span></span><br><span class="line">            <span class="keyword">if</span> (!group.isUserFixed() &amp;&amp; !group.isPolicyFixed()) &#123;</span><br><span class="line">                <span class="comment">// 根据设备配置，对权限做不同的处理！</span></span><br><span class="line">                <span class="keyword">switch</span> (permissionPolicy) &#123;</span><br><span class="line">                    <span class="keyword">case</span> DevicePolicyManager.PERMISSION_POLICY_AUTO_GRANT: &#123;</span><br><span class="line">                        <span class="comment">// 如果设备策略管理设定的是自动授予，</span></span><br><span class="line">                        <span class="comment">// 如果该 group 中有权限未授予，那就授予他们！</span></span><br><span class="line">                        <span class="keyword">if</span> (!group.areRuntimePermissionsGranted()) &#123;</span><br><span class="line">                            group.grantRuntimePermissions(<span class="keyword">false</span>);</span><br><span class="line">                        &#125;</span><br><span class="line">                        group.setPolicyFixed(); <span class="comment">// 设置 policy fix 标志，不再提醒！</span></span><br><span class="line">                    &#125; <span class="keyword">break</span>;</span><br><span class="line"></span><br><span class="line">                    <span class="keyword">case</span> DevicePolicyManager.PERMISSION_POLICY_AUTO_DENY: &#123;</span><br><span class="line">                        <span class="comment">// 如果设备策略管理设定的是自动拒绝，</span></span><br><span class="line">                        <span class="comment">// 如果该 group 中有权限已授予，那就拒绝他们！</span></span><br><span class="line">                        <span class="keyword">if</span> (group.areRuntimePermissionsGranted()) &#123;</span><br><span class="line">                            group.revokeRuntimePermissions(<span class="keyword">false</span>);</span><br><span class="line">                        &#125;</span><br><span class="line">                        group.setPolicyFixed();</span><br><span class="line">                    &#125; <span class="keyword">break</span>;</span><br><span class="line"></span><br><span class="line">                    <span class="keyword">default</span>: &#123;</span><br><span class="line">                        <span class="comment">// 如果设备策略管理设定的是其他策略（也是正常情况），</span></span><br><span class="line">                        <span class="comment">// 如果 group 中有权限未授予，那就将其添加到 mRequestGrantPermissionGroups，接下来要申请！</span></span><br><span class="line">                        <span class="comment">// 如果 group 中有权限已授予，那就授予所有的权限，并更新授予结果；</span></span><br><span class="line">                        <span class="keyword">if</span> (!group.areRuntimePermissionsGranted()) &#123;</span><br><span class="line">                            mRequestGrantPermissionGroups.put(group.getName(),</span><br><span class="line">                                    <span class="keyword">new</span> GroupState(group));</span><br><span class="line">                        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                            group.grantRuntimePermissions(<span class="keyword">false</span>);</span><br><span class="line">                            updateGrantResults(group); <span class="comment">// 更新申请结果</span></span><br><span class="line">                        &#125;</span><br><span class="line">                    &#125; <span class="keyword">break</span>;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                <span class="comment">// 如果权限已经被 fix，不用再提醒，那就直接更新权限的申请结果！</span></span><br><span class="line">                updateGrantResults(group);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment">//【2.1.7】显示权限申请弹窗界面！</span></span><br><span class="line">        setContentView(mViewHandler.createView());</span><br><span class="line"></span><br><span class="line">        Window window = getWindow();</span><br><span class="line">        WindowManager.LayoutParams layoutParams = window.getAttributes();</span><br><span class="line">        mViewHandler.updateWindowAttributes(layoutParams);</span><br><span class="line">        window.setAttributes(layoutParams);</span><br><span class="line"></span><br><span class="line">        <span class="comment">//【2.1.8】显示权限请求 ui，处理权限的授予和拒绝！</span></span><br><span class="line">        <span class="keyword">if</span> (!showNextPermissionGroupGrantRequest()) &#123;</span><br><span class="line">            <span class="comment">//【2.1.9】返回处理结果！</span></span><br><span class="line">            setResultAndFinish();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h3 id="2-1-1-new-GrantPermissionsViewHandlerImpl-this"><a href="#2-1-1-new-GrantPermissionsViewHandlerImpl-this" class="headerlink" title="2.1.1 new GrantPermissionsViewHandlerImpl(this)"></a>2.1.1 new GrantPermissionsViewHandlerImpl(this)</h3><p>有一个成员变量 private GrantPermissionsViewHandler mViewHandler，用于处理权限弹窗的显示和相关逻辑显示，在 onCreate 方法中，首先会创建一个 GrantPermissionsViewHandlerImpl 对象！<br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">final</span> <span class="class"><span class="keyword">class</span> <span class="title">GrantPermissionsViewHandlerImpl</span></span></span><br><span class="line"><span class="class">        <span class="keyword">implements</span> <span class="title">GrantPermissionsViewHandler</span>, <span class="title">OnClickListener</span> </span>&#123;</span><br><span class="line"> </span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="title">GrantPermissionsViewHandlerImpl</span><span class="params">(Context context)</span> </span>&#123;</span><br><span class="line">        mContext = context;</span><br><span class="line">    &#125; </span><br><span class="line">        </span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>同时，又调用了 setResultListener，设置监听器！</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> GrantPermissionsViewHandlerImpl <span class="title">setResultListener</span><span class="params">(ResultListener listener)</span> </span>&#123;</span><br><span class="line">    mResultListener = listener;</span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">this</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>这里的 ResultListener 就是 GrantPermissionsActivity，因为其实现了 ResultListener 接口！</p>
<h3 id="2-1-2-GrantPermissionsActivity-setResultAndFinish"><a href="#2-1-2-GrantPermissionsActivity-setResultAndFinish" class="headerlink" title="2.1.2 GrantPermissionsActivity.setResultAndFinish"></a>2.1.2 GrantPermissionsActivity.setResultAndFinish</h3><p>当遇到一些特殊情况，不能继续申请权限的时候，我们会调用 setResultAndFinish 结束申请！</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">setResultAndFinish</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    setResultIfNeeded(RESULT_OK);</span><br><span class="line">    finish();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>继续调用了 setResultIfNeeded 方法！<br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">setResultIfNeeded</span><span class="params">(<span class="keyword">int</span> resultCode)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">if</span> (!mResultSet) &#123;</span><br><span class="line">        mResultSet = <span class="keyword">true</span>;</span><br><span class="line">        logRequestedPermissionGroups();</span><br><span class="line">        Intent result = <span class="keyword">new</span> Intent(PackageManager.ACTION_REQUEST_PERMISSIONS);</span><br><span class="line">        result.putExtra(PackageManager.EXTRA_REQUEST_PERMISSIONS_NAMES, mRequestedPermissions);</span><br><span class="line">        result.putExtra(PackageManager.EXTRA_REQUEST_PERMISSIONS_RESULTS, mGrantResults);</span><br><span class="line">        <span class="comment">// 调用 Activity.setResult 方法！</span></span><br><span class="line">        setResult(resultCode, result);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<h3 id="2-1-3-GrantPermissionsActivity-getCallingPackageInfo"><a href="#2-1-3-GrantPermissionsActivity-getCallingPackageInfo" class="headerlink" title="2.1.3 GrantPermissionsActivity.getCallingPackageInfo"></a>2.1.3 GrantPermissionsActivity.getCallingPackageInfo</h3><p>该方法用于获得申请运行时权限的应用的 PackageInfo 对象！<br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">private</span> PackageInfo <span class="title">getCallingPackageInfo</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">        <span class="comment">//【2.1.3.1】最终调用 PMS 的 getPackageInfo 方法！</span></span><br><span class="line">        <span class="keyword">return</span> getPackageManager().getPackageInfo(getCallingPackage(),</span><br><span class="line">                PackageManager.GET_PERMISSIONS);</span><br><span class="line">    &#125; <span class="keyword">catch</span> (NameNotFoundException e) &#123;</span><br><span class="line">        Log.i(LOG_TAG, <span class="string">"No package: "</span> + getCallingPackage(), e);</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">null</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>PackageManager.GET_PERMISSIONS 标志是为了限制查询到的数据的量！</p>
<h4 id="2-1-3-1-PackageManagerS-getPackageInfo"><a href="#2-1-3-1-PackageManagerS-getPackageInfo" class="headerlink" title="2.1.3.1 PackageManagerS.getPackageInfo"></a>2.1.3.1 PackageManagerS.getPackageInfo</h4><p>flags 传入 PackageManager.GET_PERMISSIONS！<br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> PackageInfo <span class="title">getPackageInfo</span><span class="params">(String packageName, <span class="keyword">int</span> flags, <span class="keyword">int</span> userId)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">if</span> (!sUserManager.exists(userId)) <span class="keyword">return</span> <span class="keyword">null</span>;</span><br><span class="line">    flags = updateFlagsForPackage(flags, userId, packageName);</span><br><span class="line">    enforceCrossUserPermission(Binder.getCallingUid(), userId,</span><br><span class="line">            <span class="keyword">false</span> <span class="comment">/* requireFullPermission */</span>, <span class="keyword">false</span> <span class="comment">/* checkShell */</span>, <span class="string">"get package info"</span>);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">synchronized</span> (mPackages) &#123;</span><br><span class="line">        <span class="comment">// 如果 package 重命名过，返回旧名字！</span></span><br><span class="line">        packageName = normalizePackageNameLPr(packageName);</span><br><span class="line"></span><br><span class="line">        <span class="keyword">final</span> <span class="keyword">boolean</span> matchFactoryOnly = (flags &amp; MATCH_FACTORY_ONLY) != <span class="number">0</span>;</span><br><span class="line">        PackageParser.Package p = <span class="keyword">null</span>;</span><br><span class="line">        <span class="keyword">if</span> (matchFactoryOnly) &#123;</span><br><span class="line">            <span class="keyword">final</span> PackageSetting ps = mSettings.getDisabledSystemPkgLPr(packageName);</span><br><span class="line">            <span class="keyword">if</span> (ps != <span class="keyword">null</span>) &#123;</span><br><span class="line">                <span class="keyword">return</span> generatePackageInfo(ps, flags, userId);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">// 从 PMS.mPackages 中获取扫描解析后的 PackageParser.Package 对象！</span></span><br><span class="line">        <span class="keyword">if</span> (p == <span class="keyword">null</span>) &#123;</span><br><span class="line">            p = mPackages.get(packageName);</span><br><span class="line">            <span class="keyword">if</span> (matchFactoryOnly &amp;&amp; p != <span class="keyword">null</span> &amp;&amp; !isSystemApp(p)) &#123;</span><br><span class="line">                <span class="keyword">return</span> <span class="keyword">null</span>;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">if</span> (DEBUG_PACKAGE_INFO)</span><br><span class="line">            Log.v(TAG, <span class="string">"getPackageInfo "</span> + packageName + <span class="string">": "</span> + p);</span><br><span class="line">        <span class="keyword">if</span> (p != <span class="keyword">null</span>) &#123; </span><br><span class="line">            <span class="comment">//【2.1.3.2】如果有扫描结果，那就调用 generatePackageInfo 返回包信息！</span></span><br><span class="line">            <span class="keyword">return</span> generatePackageInfo((PackageSetting)p.mExtras, flags, userId);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">// 如果没有扫描结果，那么我们从上一次的安装信息中获取包信息！</span></span><br><span class="line">        <span class="keyword">if</span> (!matchFactoryOnly &amp;&amp; (flags &amp; MATCH_UNINSTALLED_PACKAGES) != <span class="number">0</span>) &#123;</span><br><span class="line">            <span class="keyword">final</span> PackageSetting ps = mSettings.mPackages.get(packageName);</span><br><span class="line">            <span class="keyword">return</span> generatePackageInfo(ps, flags, userId);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">null</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>流程很简单，不多说了！</p>
<h4 id="2-1-3-2-PackageManagerS-generatePackageInfo"><a href="#2-1-3-2-PackageManagerS-generatePackageInfo" class="headerlink" title="2.1.3.2 PackageManagerS.generatePackageInfo"></a>2.1.3.2 PackageManagerS.generatePackageInfo</h4><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">private</span> PackageInfo <span class="title">generatePackageInfo</span><span class="params">(PackageSetting ps, <span class="keyword">int</span> flags, <span class="keyword">int</span> userId)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">if</span> (!sUserManager.exists(userId)) <span class="keyword">return</span> <span class="keyword">null</span>;</span><br><span class="line">    <span class="keyword">if</span> (ps == <span class="keyword">null</span>) &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">null</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// 获得扫描信息！</span></span><br><span class="line">    <span class="keyword">final</span> PackageParser.Package p = ps.pkg;</span><br><span class="line">    <span class="keyword">if</span> (p == <span class="keyword">null</span>) &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">null</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// 获得该 package 的权限状态信息！</span></span><br><span class="line">    <span class="keyword">final</span> PermissionsState permissionsState = ps.getPermissionsState();</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 如果 flags 设置了 GET_GIDS，说明我们要获得 gids 信息，那就计算 gid！</span></span><br><span class="line">    <span class="keyword">final</span> <span class="keyword">int</span>[] gids = (flags &amp; PackageManager.GET_GIDS) == <span class="number">0</span></span><br><span class="line">            ? EMPTY_INT_ARRAY : permissionsState.computeGids(userId);</span><br><span class="line">    <span class="comment">// 获取应用已经被授予的所有权限！</span></span><br><span class="line">    <span class="keyword">final</span> Set&lt;String&gt; permissions = ArrayUtils.isEmpty(p.requestedPermissions)</span><br><span class="line">            ? Collections.&lt;String&gt;emptySet() : permissionsState.getPermissions(userId);</span><br><span class="line">    <span class="comment">// 获取应用在当前 userId 下的状态信息！</span></span><br><span class="line">    <span class="keyword">final</span> PackageUserState state = ps.readUserState(userId);</span><br><span class="line">    <span class="comment">//【2.1.3.3】继续调用 generatePackageInfo！</span></span><br><span class="line">    <span class="keyword">return</span> PackageParser.generatePackageInfo(p, gids, flags,</span><br><span class="line">            ps.firstInstallTime, ps.lastUpdateTime, permissions, state, userId);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>继续看：</p>
<h4 id="2-1-3-3-PackageManagerS-generatePackageInfo"><a href="#2-1-3-3-PackageManagerS-generatePackageInfo" class="headerlink" title="2.1.3.3 PackageManagerS.generatePackageInfo"></a>2.1.3.3 PackageManagerS.generatePackageInfo</h4><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">static</span> PackageInfo <span class="title">generatePackageInfo</span><span class="params">(PackageParser.Package p,</span></span></span><br><span class="line"><span class="function"><span class="params">        <span class="keyword">int</span> gids[], <span class="keyword">int</span> flags, <span class="keyword">long</span> firstInstallTime, <span class="keyword">long</span> lastUpdateTime,</span></span></span><br><span class="line"><span class="function"><span class="params">        Set&lt;String&gt; grantedPermissions, PackageUserState state, <span class="keyword">int</span> userId)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">if</span> (!checkUseInstalledOrHidden(flags, state) || !p.isMatch(flags)) &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">null</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">//【1】创建了一个 PackageInfo 对象，保存应用的包信息的拷贝！</span></span><br><span class="line">    PackageInfo pi = <span class="keyword">new</span> PackageInfo();</span><br><span class="line">    pi.packageName = p.packageName;</span><br><span class="line">    pi.splitNames = p.splitNames;</span><br><span class="line">    pi.versionCode = p.mVersionCode;</span><br><span class="line">    pi.baseRevisionCode = p.baseRevisionCode;</span><br><span class="line">    pi.splitRevisionCodes = p.splitRevisionCodes;</span><br><span class="line">    pi.versionName = p.mVersionName;</span><br><span class="line">    pi.sharedUserId = p.mSharedUserId;</span><br><span class="line">    pi.sharedUserLabel = p.mSharedUserLabel;</span><br><span class="line">    pi.applicationInfo = generateApplicationInfo(p, flags, state, userId);</span><br><span class="line">    pi.installLocation = p.installLocation;</span><br><span class="line">    pi.coreApp = p.coreApp;</span><br><span class="line">    <span class="keyword">if</span> ((pi.applicationInfo.flags&amp;ApplicationInfo.FLAG_SYSTEM) != <span class="number">0</span></span><br><span class="line">            || (pi.applicationInfo.flags&amp;ApplicationInfo.FLAG_UPDATED_SYSTEM_APP) != <span class="number">0</span>) &#123;</span><br><span class="line">        pi.requiredForAllUsers = p.mRequiredForAllUsers;</span><br><span class="line">    &#125;</span><br><span class="line">    pi.restrictedAccountType = p.mRestrictedAccountType;</span><br><span class="line">    pi.requiredAccountType = p.mRequiredAccountType;</span><br><span class="line">    pi.overlayTarget = p.mOverlayTarget;</span><br><span class="line">    pi.firstInstallTime = firstInstallTime;</span><br><span class="line">    pi.lastUpdateTime = lastUpdateTime;</span><br><span class="line">    <span class="comment">//【2】根据 flags 设置的标志位，获取标志为对应的信息！</span></span><br><span class="line">    <span class="keyword">if</span> ((flags&amp;PackageManager.GET_GIDS) != <span class="number">0</span>) &#123;</span><br><span class="line">        pi.gids = gids;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span> ((flags&amp;PackageManager.GET_CONFIGURATIONS) != <span class="number">0</span>) &#123;</span><br><span class="line">        <span class="keyword">int</span> N = p.configPreferences != <span class="keyword">null</span> ? p.configPreferences.size() : <span class="number">0</span>;</span><br><span class="line">        <span class="keyword">if</span> (N &gt; <span class="number">0</span>) &#123;</span><br><span class="line">            pi.configPreferences = <span class="keyword">new</span> ConfigurationInfo[N];</span><br><span class="line">            p.configPreferences.toArray(pi.configPreferences);</span><br><span class="line">        &#125;</span><br><span class="line">        N = p.reqFeatures != <span class="keyword">null</span> ? p.reqFeatures.size() : <span class="number">0</span>;</span><br><span class="line">        <span class="keyword">if</span> (N &gt; <span class="number">0</span>) &#123;</span><br><span class="line">            pi.reqFeatures = <span class="keyword">new</span> FeatureInfo[N];</span><br><span class="line">            p.reqFeatures.toArray(pi.reqFeatures);</span><br><span class="line">        &#125;</span><br><span class="line">        N = p.featureGroups != <span class="keyword">null</span> ? p.featureGroups.size() : <span class="number">0</span>;</span><br><span class="line">        <span class="keyword">if</span> (N &gt; <span class="number">0</span>) &#123;</span><br><span class="line">            pi.featureGroups = <span class="keyword">new</span> FeatureGroupInfo[N];</span><br><span class="line">            p.featureGroups.toArray(pi.featureGroups);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span> ((flags &amp; PackageManager.GET_ACTIVITIES) != <span class="number">0</span>) &#123;</span><br><span class="line">        <span class="keyword">final</span> <span class="keyword">int</span> N = p.activities.size();</span><br><span class="line">        <span class="keyword">if</span> (N &gt; <span class="number">0</span>) &#123;</span><br><span class="line">            <span class="keyword">int</span> num = <span class="number">0</span>;</span><br><span class="line">            <span class="keyword">final</span> ActivityInfo[] res = <span class="keyword">new</span> ActivityInfo[N];</span><br><span class="line">            <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; N; i++) &#123;</span><br><span class="line">                <span class="keyword">final</span> Activity a = p.activities.get(i);</span><br><span class="line">                <span class="keyword">if</span> (state.isMatch(a.info, flags)) &#123;</span><br><span class="line">                    res[num++] = generateActivityInfo(a, flags, state, userId);</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">            pi.activities = ArrayUtils.trimToSize(res, num);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span> ((flags &amp; PackageManager.GET_RECEIVERS) != <span class="number">0</span>) &#123;</span><br><span class="line">        <span class="keyword">final</span> <span class="keyword">int</span> N = p.receivers.size();</span><br><span class="line">        <span class="keyword">if</span> (N &gt; <span class="number">0</span>) &#123;</span><br><span class="line">            <span class="keyword">int</span> num = <span class="number">0</span>;</span><br><span class="line">            <span class="keyword">final</span> ActivityInfo[] res = <span class="keyword">new</span> ActivityInfo[N];</span><br><span class="line">            <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; N; i++) &#123;</span><br><span class="line">                <span class="keyword">final</span> Activity a = p.receivers.get(i);</span><br><span class="line">                <span class="keyword">if</span> (state.isMatch(a.info, flags)) &#123;</span><br><span class="line">                    res[num++] = generateActivityInfo(a, flags, state, userId);</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">            pi.receivers = ArrayUtils.trimToSize(res, num);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span> ((flags &amp; PackageManager.GET_SERVICES) != <span class="number">0</span>) &#123;</span><br><span class="line">        <span class="keyword">final</span> <span class="keyword">int</span> N = p.services.size();</span><br><span class="line">        <span class="keyword">if</span> (N &gt; <span class="number">0</span>) &#123;</span><br><span class="line">            <span class="keyword">int</span> num = <span class="number">0</span>;</span><br><span class="line">            <span class="keyword">final</span> ServiceInfo[] res = <span class="keyword">new</span> ServiceInfo[N];</span><br><span class="line">            <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; N; i++) &#123;</span><br><span class="line">                <span class="keyword">final</span> Service s = p.services.get(i);</span><br><span class="line">                <span class="keyword">if</span> (state.isMatch(s.info, flags)) &#123;</span><br><span class="line">                    res[num++] = generateServiceInfo(s, flags, state, userId);</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">            pi.services = ArrayUtils.trimToSize(res, num);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span> ((flags &amp; PackageManager.GET_PROVIDERS) != <span class="number">0</span>) &#123;</span><br><span class="line">        <span class="keyword">final</span> <span class="keyword">int</span> N = p.providers.size();</span><br><span class="line">        <span class="keyword">if</span> (N &gt; <span class="number">0</span>) &#123;</span><br><span class="line">            <span class="keyword">int</span> num = <span class="number">0</span>;</span><br><span class="line">            <span class="keyword">final</span> ProviderInfo[] res = <span class="keyword">new</span> ProviderInfo[N];</span><br><span class="line">            <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; N; i++) &#123;</span><br><span class="line">                <span class="keyword">final</span> Provider pr = p.providers.get(i);</span><br><span class="line">                <span class="keyword">if</span> (state.isMatch(pr.info, flags)) &#123;</span><br><span class="line">                    res[num++] = generateProviderInfo(pr, flags, state, userId);</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">            pi.providers = ArrayUtils.trimToSize(res, num);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span> ((flags&amp;PackageManager.GET_INSTRUMENTATION) != <span class="number">0</span>) &#123;</span><br><span class="line">        <span class="keyword">int</span> N = p.instrumentation.size();</span><br><span class="line">        <span class="keyword">if</span> (N &gt; <span class="number">0</span>) &#123;</span><br><span class="line">            pi.instrumentation = <span class="keyword">new</span> InstrumentationInfo[N];</span><br><span class="line">            <span class="keyword">for</span> (<span class="keyword">int</span> i=<span class="number">0</span>; i&lt;N; i++) &#123;</span><br><span class="line">                pi.instrumentation[i] = generateInstrumentationInfo(</span><br><span class="line">                        p.instrumentation.get(i), flags);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// 因为我们只设置了 GET_PERMISSIONS，所以只会手机和权限相关的信息！</span></span><br><span class="line">    <span class="keyword">if</span> ((flags&amp;PackageManager.GET_PERMISSIONS) != <span class="number">0</span>) &#123;</span><br><span class="line">        <span class="comment">// 处理该应用定义的所有权限！</span></span><br><span class="line">        <span class="keyword">int</span> N = p.permissions.size();</span><br><span class="line">        <span class="keyword">if</span> (N &gt; <span class="number">0</span>) &#123;</span><br><span class="line">            pi.permissions = <span class="keyword">new</span> PermissionInfo[N];</span><br><span class="line">            <span class="keyword">for</span> (<span class="keyword">int</span> i=<span class="number">0</span>; i&lt;N; i++) &#123;</span><br><span class="line">                pi.permissions[i] = generatePermissionInfo(p.permissions.get(i), flags);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">// 处理该应用请求的所有权限！</span></span><br><span class="line">        N = p.requestedPermissions.size();</span><br><span class="line">        <span class="keyword">if</span> (N &gt; <span class="number">0</span>) &#123;</span><br><span class="line">            pi.requestedPermissions = <span class="keyword">new</span> String[N];</span><br><span class="line">            pi.requestedPermissionsFlags = <span class="keyword">new</span> <span class="keyword">int</span>[N];</span><br><span class="line">            <span class="keyword">for</span> (<span class="keyword">int</span> i=<span class="number">0</span>; i&lt;N; i++) &#123;</span><br><span class="line">                <span class="keyword">final</span> String perm = p.requestedPermissions.get(i);</span><br><span class="line">                <span class="comment">// requestedPermissions[i] 表示应用申请的权限名；</span></span><br><span class="line">                pi.requestedPermissions[i] = perm;</span><br><span class="line">                <span class="comment">// requestedPermissionsFlags[i] 表示应用申请的权限的授予情况；</span></span><br><span class="line">                <span class="comment">// 开始默认初始化为需要再次请求，然后比较该权限是否已经被授予，如果授予，改为授予状态！</span></span><br><span class="line">                pi.requestedPermissionsFlags[i] |= PackageInfo.REQUESTED_PERMISSION_REQUIRED;</span><br><span class="line">                <span class="keyword">if</span> (grantedPermissions != <span class="keyword">null</span> &amp;&amp; grantedPermissions.contains(perm)) &#123;</span><br><span class="line">                    pi.requestedPermissionsFlags[i] |= PackageInfo.REQUESTED_PERMISSION_GRANTED;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span> ((flags&amp;PackageManager.GET_SIGNATURES) != <span class="number">0</span>) &#123;</span><br><span class="line">       <span class="keyword">int</span> N = (p.mSignatures != <span class="keyword">null</span>) ? p.mSignatures.length : <span class="number">0</span>;</span><br><span class="line">       <span class="keyword">if</span> (N &gt; <span class="number">0</span>) &#123;</span><br><span class="line">            pi.signatures = <span class="keyword">new</span> Signature[N];</span><br><span class="line">            System.arraycopy(p.mSignatures, <span class="number">0</span>, pi.signatures, <span class="number">0</span>, N);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> pi;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>最后，返回的是一个 PackageInfo 对象！</p>
<h3 id="2-1-4-GrantPermissionsActivity-updateDefaultResults"><a href="#2-1-4-GrantPermissionsActivity-updateDefaultResults" class="headerlink" title="2.1.4 GrantPermissionsActivity.updateDefaultResults"></a>2.1.4 GrantPermissionsActivity.updateDefaultResults</h3><p>更新下权限的默认授予情况！<br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">updateDefaultResults</span><span class="params">(PackageInfo callingPackageInfo, <span class="keyword">int</span> permissionPolicy)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">final</span> <span class="keyword">int</span> requestedPermCount = mRequestedPermissions.length;</span><br><span class="line">    <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; requestedPermCount; i++) &#123;</span><br><span class="line">        String permission = mRequestedPermissions[i];</span><br><span class="line">        <span class="comment">//【2.1.3.1 】如果申请应用的信息存在，那么会调用 computePermissionGrantState 方法，获得权限的默认授予状态！</span></span><br><span class="line">        <span class="comment">// 否则，所有运行时权限默认为 deny！</span></span><br><span class="line">        mGrantResults[i] = callingPackageInfo != <span class="keyword">null</span></span><br><span class="line">                ? computePermissionGrantState(callingPackageInfo, permission, permissionPolicy)</span><br><span class="line">                : PERMISSION_DENIED;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>关键的实现是在 computePermissionGrantState 中！</p>
<h4 id="2-1-4-1-GrantPermissionsActivity-computePermissionGrantState"><a href="#2-1-4-1-GrantPermissionsActivity-computePermissionGrantState" class="headerlink" title="2.1.4.1 GrantPermissionsActivity.computePermissionGrantState"></a>2.1.4.1 GrantPermissionsActivity.computePermissionGrantState</h4><p>该方法用于根据参数，计算该运行时权限的授予情况，这里的 permission 是应用本次申请的运行时权限！<br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">int</span> <span class="title">computePermissionGrantState</span><span class="params">(PackageInfo callingPackageInfo,</span></span></span><br><span class="line"><span class="function"><span class="params">        String permission, <span class="keyword">int</span> permissionPolicy)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">boolean</span> permissionRequested = <span class="keyword">false</span>;</span><br><span class="line">    <span class="comment">//【1】如果运行时权限 permission 在 package 请求权限列表中</span></span><br><span class="line">    <span class="comment">// 并且已经授予，那么就返回 PERMISSION_GRANTED！</span></span><br><span class="line">    <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; callingPackageInfo.requestedPermissions.length; i++) &#123;</span><br><span class="line">        <span class="keyword">if</span> (permission.equals(callingPackageInfo.requestedPermissions[i])) &#123;</span><br><span class="line">            permissionRequested = <span class="keyword">true</span>;</span><br><span class="line">            <span class="keyword">if</span> ((callingPackageInfo.requestedPermissionsFlags[i]</span><br><span class="line">                    &amp; PackageInfo.REQUESTED_PERMISSION_GRANTED) != <span class="number">0</span>) &#123;</span><br><span class="line">                <span class="keyword">return</span> PERMISSION_GRANTED;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">//【2】申请的运行时权限，应用没有申明，返回 PERMISSION_DENIED！</span></span><br><span class="line">    <span class="keyword">if</span> (!permissionRequested) &#123;</span><br><span class="line">        <span class="keyword">return</span> PERMISSION_DENIED;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">//【3】只有基本权限类型为 dangerous 的权限才需要动态申请，其他类型的权限，默认返回 PERMISSION_DENIED！</span></span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">        PermissionInfo pInfo = getPackageManager().getPermissionInfo(permission, <span class="number">0</span>);</span><br><span class="line">        <span class="keyword">if</span> ((pInfo.protectionLevel &amp; PermissionInfo.PROTECTION_MASK_BASE)</span><br><span class="line">                != PermissionInfo.PROTECTION_DANGEROUS) &#123;</span><br><span class="line">            <span class="keyword">return</span> PERMISSION_DENIED;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125; <span class="keyword">catch</span> (NameNotFoundException e) &#123;</span><br><span class="line">        <span class="keyword">return</span> PERMISSION_DENIED;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//【4】根据 permissionPolicy 的值来处理权限的授予情况，如果是 PERMISSION_POLICY_AUTO_GRANT，表示自动授予；</span></span><br><span class="line">    <span class="comment">// 那么返回 PERMISSION_GRANTED，否则返回 PERMISSION_DENIED！</span></span><br><span class="line">    <span class="keyword">switch</span> (permissionPolicy) &#123;</span><br><span class="line">        <span class="keyword">case</span> DevicePolicyManager.PERMISSION_POLICY_AUTO_GRANT: &#123;</span><br><span class="line">            <span class="keyword">return</span> PERMISSION_GRANTED;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">default</span>: &#123;</span><br><span class="line">            <span class="keyword">return</span> PERMISSION_DENIED;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>最后 computePermissionGrantState 的结果会保存 mGrantResults 数组中！</p>
<p>不多说了！</p>
<h3 id="2-1-5-new-AppPermissions-封装-App-的权限请求信息"><a href="#2-1-5-new-AppPermissions-封装-App-的权限请求信息" class="headerlink" title="2.1.5 new AppPermissions - 封装 App 的权限请求信息"></a>2.1.5 new AppPermissions - 封装 App 的权限请求信息</h3><p>这里的 onErrorCallback 是一个 Runnable，执行后会触发 setResultAndFinish 方法！</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="title">AppPermissions</span><span class="params">(Context context, PackageInfo packageInfo, String[] permissions,</span></span></span><br><span class="line"><span class="function"><span class="params">        <span class="keyword">boolean</span> sortGroups, Runnable onErrorCallback)</span> </span>&#123;</span><br><span class="line">    mContext = context;</span><br><span class="line">    mPackageInfo = packageInfo; <span class="comment">// 请求权限的应用的 PackageInfo 实例！</span></span><br><span class="line">    mFilterPermissions = permissions; <span class="comment">// 传入 null；</span></span><br><span class="line">    mAppLabel = BidiFormatter.getInstance().unicodeWrap(</span><br><span class="line">            packageInfo.applicationInfo.loadSafeLabel(</span><br><span class="line">            context.getPackageManager()).toString());</span><br><span class="line">    mSortGroups = sortGroups; <span class="comment">// 传入 false；</span></span><br><span class="line">    mOnErrorCallback = onErrorCallback;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//【2.1.4.1】加载权限组信息！</span></span><br><span class="line">    loadPermissionGroups();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>mFilterPermissions 属性表示要过滤的权限，这里我们传入的是 null；</p>
<p>同时，AppPermissions 还有如下的属性：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 保存所有运行时权限所属的组信息 AppPermissionGroup</span></span><br><span class="line"><span class="keyword">private</span> <span class="keyword">final</span> ArrayList&lt;AppPermissionGroup&gt; mGroups = <span class="keyword">new</span> ArrayList&lt;&gt;();</span><br><span class="line"><span class="comment">// 保存组名和 AppPermissionGroup 的映射关系</span></span><br><span class="line"><span class="keyword">private</span> <span class="keyword">final</span> LinkedHashMap&lt;String, AppPermissionGroup&gt; mNameToGroupMap = <span class="keyword">new</span> LinkedHashMap&lt;&gt;();</span><br></pre></td></tr></table></figure>
<h4 id="2-1-5-1-AppPermissions-loadPermissionGroups"><a href="#2-1-5-1-AppPermissions-loadPermissionGroups" class="headerlink" title="2.1.5.1 AppPermissions.loadPermissionGroups"></a>2.1.5.1 AppPermissions.loadPermissionGroups</h4><p>加载权限组信息</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">loadPermissionGroups</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    mGroups.clear();</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (mPackageInfo.requestedPermissions == <span class="keyword">null</span>) &#123;</span><br><span class="line">        <span class="keyword">return</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (mFilterPermissions != <span class="keyword">null</span>) &#123; <span class="comment">//【1】mFilterPermissions 为 null，不进入！</span></span><br><span class="line">        <span class="keyword">for</span> (String filterPermission : mFilterPermissions) &#123;</span><br><span class="line">            <span class="keyword">for</span> (String requestedPerm : mPackageInfo.requestedPermissions) &#123;</span><br><span class="line">                <span class="keyword">if</span> (!filterPermission.equals(requestedPerm)) &#123; <span class="comment">// 过滤掉那些不是 filterPermission 的权限！</span></span><br><span class="line">                    <span class="keyword">continue</span>;</span><br><span class="line">                &#125;</span><br><span class="line"></span><br><span class="line">                <span class="keyword">if</span> (hasGroupForPermission(requestedPerm)) &#123;</span><br><span class="line">                    <span class="keyword">break</span>;</span><br><span class="line">                &#125;</span><br><span class="line"></span><br><span class="line">                AppPermissionGroup group = AppPermissionGroup.create(mContext,</span><br><span class="line">                        mPackageInfo, requestedPerm);</span><br><span class="line">                <span class="keyword">if</span> (group == <span class="keyword">null</span>) &#123;</span><br><span class="line">                    <span class="keyword">break</span>;</span><br><span class="line">                &#125;</span><br><span class="line"></span><br><span class="line">                mGroups.add(group);</span><br><span class="line">                <span class="keyword">break</span>;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        <span class="comment">//【2】遍历该 package 请求的所有权限（安装/运行），</span></span><br><span class="line">        <span class="keyword">for</span> (String requestedPerm : mPackageInfo.requestedPermissions) &#123;</span><br><span class="line">            <span class="comment">//【2.1.4.1.1】判断是否已经有对应的 group 存在，存在的话，那就不处理！</span></span><br><span class="line">            <span class="keyword">if</span> (hasGroupForPermission(requestedPerm)) &#123;</span><br><span class="line">                <span class="keyword">continue</span>;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="comment">//【2.1.4.1.2】如果不存在，那就创建一个 AppPermissionGroup 对象，封装运行时权限所属的组信息！</span></span><br><span class="line">            AppPermissionGroup group = AppPermissionGroup.create(mContext,</span><br><span class="line">                    mPackageInfo, requestedPerm);</span><br><span class="line">            <span class="keyword">if</span> (group == <span class="keyword">null</span>) &#123;</span><br><span class="line">                <span class="keyword">continue</span>;</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            mGroups.add(group); <span class="comment">//【2.1】添加到 mGroups 中！</span></span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (mSortGroups) &#123; <span class="comment">//【3】如果 mSortGroups 为 true，表示对 group 进行排序！</span></span><br><span class="line">        Collections.sort(mGroups);</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">//【4】mNameToGroupMap 用于保存组名和 AppPermissionGroup 的映射关系！</span></span><br><span class="line">    mNameToGroupMap.clear();</span><br><span class="line">    <span class="keyword">for</span> (AppPermissionGroup group : mGroups) &#123;</span><br><span class="line">        mNameToGroupMap.put(group.getName(), group);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>对于 mPackageInfo.requestedPermissions，不仅包含运行时权限，还包含安装时权限！</p>
<h5 id="2-1-5-1-1-AppPermissions-hasGroupForPermission"><a href="#2-1-5-1-1-AppPermissions-hasGroupForPermission" class="headerlink" title="2.1.5.1.1 AppPermissions.hasGroupForPermission"></a>2.1.5.1.1 AppPermissions.hasGroupForPermission</h5><p>加载权限组信息！<br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">boolean</span> <span class="title">hasGroupForPermission</span><span class="params">(String permission)</span> </span>&#123;</span><br><span class="line">    <span class="comment">//【1】遍历所有的 AppPermissionGroup，如果 permission 在 group 的权限集合中，返回 true！</span></span><br><span class="line">    <span class="keyword">for</span> (AppPermissionGroup group : mGroups) &#123;</span><br><span class="line">        <span class="keyword">if</span> (group.hasPermission(permission)) &#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="keyword">true</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">false</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>AppPermissions 内部有一个 mGroups，保存所有的权限组信息 AppPermissionGroup 实例！</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">final</span> <span class="class"><span class="keyword">class</span> <span class="title">AppPermissionGroup</span> <span class="keyword">implements</span> <span class="title">Comparable</span>&lt;<span class="title">AppPermissionGroup</span>&gt; </span>&#123;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> ArrayMap&lt;String, Permission&gt; mPermissions = <span class="keyword">new</span> ArrayMap&lt;&gt;();</span><br><span class="line">    <span class="comment">//【2】在该 group 中是否有该权限！</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">boolean</span> <span class="title">hasPermission</span><span class="params">(String permission)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> mPermissions.get(permission) != <span class="keyword">null</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>AppPermissionGroup 内部有一个 mPermissions 哈希表，用于保存该 group 中所有权限的权限名和其 Permission 的映射关系！</p>
<h5 id="2-1-5-1-2-AppPermissionGroup-create-3-创建运行时权限组信息"><a href="#2-1-5-1-2-AppPermissionGroup-create-3-创建运行时权限组信息" class="headerlink" title="2.1.5.1.2 AppPermissionGroup.create[3] - 创建运行时权限组信息"></a>2.1.5.1.2 AppPermissionGroup.create[3] - 创建运行时权限组信息</h5><p>接下来我们看下，AppPermissionGroup 的创建，String permissionName 表示的是该 package 的申请的权限：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">static</span> AppPermissionGroup <span class="title">create</span><span class="params">(Context context, PackageInfo packageInfo,</span></span></span><br><span class="line"><span class="function"><span class="params">        String permissionName)</span> </span>&#123;</span><br><span class="line">    <span class="comment">//【1】获得运行时权限的信息，找不到，返回 null；</span></span><br><span class="line">    PermissionInfo permissionInfo;</span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">        permissionInfo = context.getPackageManager().getPermissionInfo(permissionName, <span class="number">0</span>);</span><br><span class="line">    &#125; <span class="keyword">catch</span> (PackageManager.NameNotFoundException e) &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">null</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">//【2】校验权限的类型，如果该权限的基本类型不是 dangerous 或者说权限的 flags 没有设置 FLAG_INSTALLED 属性</span></span><br><span class="line">    <span class="comment">// 或者权限的 flags 设置了 FLAG_REMOVED 属性，那么，返回 null!</span></span><br><span class="line">    <span class="keyword">if</span> (permissionInfo.protectionLevel != PermissionInfo.PROTECTION_DANGEROUS</span><br><span class="line">            || (permissionInfo.flags &amp; PermissionInfo.FLAG_INSTALLED) == <span class="number">0</span></span><br><span class="line">            || (permissionInfo.flags &amp; PermissionInfo.FLAG_REMOVED) != <span class="number">0</span>) &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">null</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">//【3】查询该权限所属 group 的信息，如果权限的 group 属性不为 null，说明其有所属组；</span></span><br><span class="line">    PackageItemInfo groupInfo = permissionInfo;</span><br><span class="line">    <span class="keyword">if</span> (permissionInfo.group != <span class="keyword">null</span>) &#123;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            groupInfo = context.getPackageManager().getPermissionGroupInfo(</span><br><span class="line">                    permissionInfo.group, <span class="number">0</span>);</span><br><span class="line">        &#125; <span class="keyword">catch</span> (PackageManager.NameNotFoundException e) &#123;</span><br><span class="line">            <span class="comment">/* ignore */</span></span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//【4】查询所有属于该 group 的权限信息，保存到 permissionInfos 列表中！！</span></span><br><span class="line">    <span class="comment">// 注意这里的 permissionInfos 会包含应用没有申请的权限！</span></span><br><span class="line">    List&lt;PermissionInfo&gt; permissionInfos = <span class="keyword">null</span>;</span><br><span class="line">    <span class="keyword">if</span> (groupInfo <span class="keyword">instanceof</span> PermissionGroupInfo) &#123;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            permissionInfos = context.getPackageManager().queryPermissionsByGroup(</span><br><span class="line">                    groupInfo.name, <span class="number">0</span>);</span><br><span class="line">        &#125; <span class="keyword">catch</span> (PackageManager.NameNotFoundException e) &#123;</span><br><span class="line">            <span class="comment">/* ignore */</span></span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//【2.1.4.1.3】创建 AppPermissionGroup 对象！！</span></span><br><span class="line">    <span class="keyword">return</span> create(context, packageInfo, groupInfo, permissionInfos,</span><br><span class="line">            Process.myUserHandle());</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>这里可以看到，流程【2】中，会排除掉所有的非 dangerous 类型的权限！</p>
<p>在创建一个 group 的时候，会将属于该 group 的所有权限都查出来！！</p>
<p>这里继续调用了五参数的 create 方法！</p>
<h5 id="2-1-5-1-3-AppPermissionGroup-create-5"><a href="#2-1-5-1-3-AppPermissionGroup-create-5" class="headerlink" title="2.1.5.1.3 AppPermissionGroup.create[5]"></a>2.1.5.1.3 AppPermissionGroup.create[5]</h5><p>继续调用 create 方法来创建 AppPermissionGroup 对象！</p>
<p>参数分析：</p>
<ul>
<li><strong>PackageInfo packageInfo</strong>：本次请求权限的 package 的 PackageInfo 对象；</li>
<li><strong>PackageItemInfo groupInfo</strong>：该 package 的请求的权限所属的组信息；</li>
<li><strong>List<permissioninfo> permissionInfos</permissioninfo></strong>：属于该组的所有权限信息；</li>
</ul>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">static</span> AppPermissionGroup <span class="title">create</span><span class="params">(Context context, PackageInfo packageInfo,</span></span></span><br><span class="line"><span class="function"><span class="params">        PackageItemInfo groupInfo, List&lt;PermissionInfo&gt; permissionInfos,</span></span></span><br><span class="line"><span class="function"><span class="params">        UserHandle userHandle)</span> </span>&#123;</span><br><span class="line">    <span class="comment">//【2.1.5.1.3.1】创建一个 AppPermissionGroup 对象，封装了 group name，label 相关信息！</span></span><br><span class="line">    AppPermissionGroup group = <span class="keyword">new</span> AppPermissionGroup(context, packageInfo, groupInfo.name,</span><br><span class="line">            groupInfo.packageName, groupInfo.loadLabel(context.getPackageManager()),</span><br><span class="line">            loadGroupDescription(context, groupInfo), groupInfo.packageName, groupInfo.icon,</span><br><span class="line">            userHandle);</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 如果 groupInfo 不是权限组对象，而是一个运行时权限，那就添加到 permissionInfos 中！</span></span><br><span class="line">    <span class="keyword">if</span> (groupInfo <span class="keyword">instanceof</span> PermissionInfo) &#123;</span><br><span class="line">        permissionInfos = <span class="keyword">new</span> ArrayList&lt;&gt;();</span><br><span class="line">        permissionInfos.add((PermissionInfo) groupInfo);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//【1】如果权限组没有权限，返回 null，该 group 无效！</span></span><br><span class="line">    <span class="keyword">if</span> (permissionInfos == <span class="keyword">null</span> || permissionInfos.isEmpty()) &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">null</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//【2】遍历该 package 请求的所有权限（安装/运行）！</span></span><br><span class="line">    <span class="keyword">final</span> <span class="keyword">int</span> permissionCount = packageInfo.requestedPermissions.length;</span><br><span class="line">    <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; permissionCount; i++) &#123;</span><br><span class="line">        String requestedPermission = packageInfo.requestedPermissions[i];</span><br><span class="line"></span><br><span class="line">        PermissionInfo requestedPermissionInfo = <span class="keyword">null</span>;</span><br><span class="line">        <span class="comment">//【2.1】如果应用请求的权限（安装/运行）中有权限属于该权限组，我们会处理该权限！</span></span><br><span class="line">        <span class="comment">// permissionInfos 是该权限组中的所有权限，这里我们要过滤掉非应用申请的权限！</span></span><br><span class="line">        <span class="keyword">for</span> (PermissionInfo permissionInfo : permissionInfos) &#123;</span><br><span class="line">            <span class="keyword">if</span> (requestedPermission.equals(permissionInfo.name)) &#123;</span><br><span class="line">                requestedPermissionInfo = permissionInfo;</span><br><span class="line">                <span class="keyword">break</span>;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (requestedPermissionInfo == <span class="keyword">null</span>) &#123;</span><br><span class="line">            <span class="keyword">continue</span>;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment">//【2.2】我们只处理运行时权限，对于非 dangerous 权限，直接跳过！！</span></span><br><span class="line">        <span class="keyword">if</span> (requestedPermissionInfo.protectionLevel != PermissionInfo.PROTECTION_DANGEROUS) &#123;</span><br><span class="line">            <span class="keyword">continue</span>;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// Don't allow toggling non-platform permission groups for legacy apps via app ops.</span></span><br><span class="line">        <span class="comment">// 如果应用程序的 targetSdkVersion 不高于 Android 5.1，并且定义权限组的 package 不是 android！</span></span><br><span class="line">        <span class="comment">// 不处理该运行时权限！</span></span><br><span class="line">        <span class="keyword">if</span> (packageInfo.applicationInfo.targetSdkVersion &lt;= Build.VERSION_CODES.LOLLIPOP_MR1</span><br><span class="line">                &amp;&amp; !PLATFORM_PACKAGE_NAME.equals(groupInfo.packageName)) &#123;</span><br><span class="line">            <span class="keyword">continue</span>;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment">//【2.3】判断该运行时权限是否已经授予！</span></span><br><span class="line">        <span class="keyword">final</span> <span class="keyword">boolean</span> granted = (packageInfo.requestedPermissionsFlags[i]</span><br><span class="line">                &amp; PackageInfo.REQUESTED_PERMISSION_GRANTED) != <span class="number">0</span>;</span><br><span class="line"></span><br><span class="line">        <span class="comment">//【2.4】当该运行时权限的定义者不为系统时，appOp 为 null，如果为系统权限的话，匹配其对应的 AppOps，</span></span><br><span class="line">        <span class="comment">// 也有可能为 null！</span></span><br><span class="line">        <span class="keyword">final</span> String appOp = PLATFORM_PACKAGE_NAME.equals(requestedPermissionInfo.packageName)</span><br><span class="line">                ? AppOpsManager.permissionToOp(requestedPermissionInfo.name) : <span class="keyword">null</span>;</span><br><span class="line">        <span class="comment">//【2.5】如果该系统权限有对应的 AppOps，获得其模式的值是否为 ALLOWED!</span></span><br><span class="line">        <span class="keyword">final</span> <span class="keyword">boolean</span> appOpAllowed = appOp != <span class="keyword">null</span></span><br><span class="line">                &amp;&amp; context.getSystemService(AppOpsManager.class).checkOpNoThrow(appOp,</span><br><span class="line">                packageInfo.applicationInfo.uid, packageInfo.packageName)</span><br><span class="line">                == AppOpsManager.MODE_ALLOWED;</span><br><span class="line">        </span><br><span class="line">        <span class="comment">//【2.6】获得权限的 flags，可以取值为 user set,user fixed 等等！</span></span><br><span class="line">        <span class="keyword">final</span> <span class="keyword">int</span> flags = context.getPackageManager().getPermissionFlags(</span><br><span class="line">                requestedPermission, packageInfo.packageName, userHandle);</span><br><span class="line"></span><br><span class="line">        <span class="comment">//【2.1.5.1.3.2】创建一个 Permission 对象，保存该运行时权限的信息！</span></span><br><span class="line">        Permission permission = <span class="keyword">new</span> Permission(requestedPermission, granted,</span><br><span class="line">                appOp, appOpAllowed, flags);</span><br><span class="line">        <span class="comment">//【2.1.5.1.3.3】添加到 AppPermissionGroup 中去！</span></span><br><span class="line">        group.addPermission(permission);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> group;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>到这里，AppPermissionGroup 就正式创建完了！</p>
<h6 id="2-1-5-1-3-1-new-AppPermissionGroup"><a href="#2-1-5-1-3-1-new-AppPermissionGroup" class="headerlink" title="2.1.5.1.3.1 new AppPermissionGroup"></a>2.1.5.1.3.1 new AppPermissionGroup</h6><p>创建了一个 AppPermissionGroup，封装运行时权限所在权限组信息！<br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">final</span> <span class="class"><span class="keyword">class</span> <span class="title">AppPermissionGroup</span> <span class="keyword">implements</span> <span class="title">Comparable</span>&lt;<span class="title">AppPermissionGroup</span>&gt; </span>&#123;</span><br><span class="line">    ... ... ...</span><br><span class="line">    <span class="function"><span class="keyword">private</span> <span class="title">AppPermissionGroup</span><span class="params">(Context context, PackageInfo packageInfo, String name,</span></span></span><br><span class="line"><span class="function"><span class="params">            String declaringPackage, CharSequence label, CharSequence description,</span></span></span><br><span class="line"><span class="function"><span class="params">            String iconPkg, <span class="keyword">int</span> iconResId, UserHandle userHandle)</span> </span>&#123;</span><br><span class="line">        mContext = context;</span><br><span class="line">        mUserHandle = userHandle;</span><br><span class="line">        mPackageManager = mContext.getPackageManager();</span><br><span class="line">        mPackageInfo = packageInfo;</span><br><span class="line">        mAppSupportsRuntimePermissions = packageInfo.applicationInfo</span><br><span class="line">                .targetSdkVersion &gt; Build.VERSION_CODES.LOLLIPOP_MR1; <span class="comment">// 该应用是否支持运行时权限！</span></span><br><span class="line">        mAppOps = context.getSystemService(AppOpsManager.class);</span><br><span class="line">        mActivityManager = context.getSystemService(ActivityManager.class);</span><br><span class="line">        mDeclaringPackage = declaringPackage;</span><br><span class="line">        mName = name;</span><br><span class="line">        mLabel = label;</span><br><span class="line">        mDescription = description;</span><br><span class="line">        <span class="keyword">if</span> (iconResId != <span class="number">0</span>) &#123;</span><br><span class="line">            mIconPkg = iconPkg;</span><br><span class="line">            mIconResId = iconResId;</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            mIconPkg = context.getPackageName();</span><br><span class="line">            mIconResId = R.drawable.ic_perm_device_info;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    ... ... ...</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>AppPermissionGroup 内部有一个 mPermissions 集合，负责管理该 group 中该 package 申请的权限！</p>
<h6 id="2-1-5-1-3-2-new-Permission"><a href="#2-1-5-1-3-2-new-Permission" class="headerlink" title="2.1.5.1.3.2 new Permission"></a>2.1.5.1.3.2 new Permission</h6><p>该 Permission 是 PackageInstaller 定义的一个类，和系统中的不一样！</p>
<p>Permission 用来封装一个运行时权限信息！<br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">final</span> <span class="class"><span class="keyword">class</span> <span class="title">Permission</span> </span>&#123;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> String mName;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> String mAppOp;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">boolean</span> mGranted; <span class="comment">// 是否已经授予该权限！</span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">boolean</span> mAppOpAllowed;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">int</span> mFlags;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="title">Permission</span><span class="params">(String name, <span class="keyword">boolean</span> granted,</span></span></span><br><span class="line"><span class="function"><span class="params">            String appOp, <span class="keyword">boolean</span> appOpAllowed, <span class="keyword">int</span> flags)</span> </span>&#123;</span><br><span class="line">        mName = name; <span class="comment">//</span></span><br><span class="line">        mGranted = granted;</span><br><span class="line">        mAppOp = appOp;</span><br><span class="line">        mAppOpAllowed = appOpAllowed;</span><br><span class="line">        mFlags = flags;</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure></p>
<h6 id="2-1-5-1-3-3-AppPermissionGroup-addPermission"><a href="#2-1-5-1-3-3-AppPermissionGroup-addPermission" class="headerlink" title="2.1.5.1.3.3 AppPermissionGroup.addPermission"></a>2.1.5.1.3.3 AppPermissionGroup.addPermission</h6><p>将该运行时权限添加到 AppPermissionGroup.mPermissions 中去！<br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">addPermission</span><span class="params">(Permission permission)</span> </span>&#123;</span><br><span class="line">    mPermissions.put(permission.getName(), permission);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<h3 id="2-1-6-处理运行时权限组"><a href="#2-1-6-处理运行时权限组" class="headerlink" title="2.1.6 处理运行时权限组"></a>2.1.6 处理运行时权限组</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//【3】接着遍历本次请求的所有运行时权限！</span></span><br><span class="line"><span class="keyword">for</span> (String requestedPermission : mRequestedPermissions) &#123;</span><br><span class="line">    AppPermissionGroup group = <span class="keyword">null</span>;</span><br><span class="line">    <span class="comment">//【3.1】找到该运行时权限所在的 group!！</span></span><br><span class="line">    <span class="keyword">for</span> (AppPermissionGroup nextGroup : mAppPermissions.getPermissionGroups()) &#123;</span><br><span class="line">        <span class="keyword">if</span> (nextGroup.hasPermission(requestedPermission)) &#123;</span><br><span class="line">            group = nextGroup;</span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span> (group == <span class="keyword">null</span>) &#123;</span><br><span class="line">        <span class="keyword">continue</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//【2.1.6.1】处理那些 no fix 的需要提醒的权限！</span></span><br><span class="line">    <span class="keyword">if</span> (!group.isUserFixed() &amp;&amp; !group.isPolicyFixed()) &#123;</span><br><span class="line">        <span class="comment">// 根据设备配置，对权限做不同的处理！</span></span><br><span class="line">        <span class="keyword">switch</span> (permissionPolicy) &#123;</span><br><span class="line">            <span class="keyword">case</span> DevicePolicyManager.PERMISSION_POLICY_AUTO_GRANT: &#123;</span><br><span class="line">                <span class="comment">// 如果设备策略管理设定的是自动授予，</span></span><br><span class="line">                <span class="comment">//【2.1.6.2】且该 group 中有权限未授予，那就授予他们！</span></span><br><span class="line">                <span class="keyword">if</span> (!group.areRuntimePermissionsGranted()) &#123;</span><br><span class="line">                    <span class="comment">//【3.1】授予权限</span></span><br><span class="line">                    group.grantRuntimePermissions(<span class="keyword">false</span>);</span><br><span class="line">                &#125;</span><br><span class="line">                group.setPolicyFixed(); <span class="comment">// 设置 policy fix 标志位</span></span><br><span class="line">            &#125; <span class="keyword">break</span>;</span><br><span class="line"></span><br><span class="line">            <span class="keyword">case</span> DevicePolicyManager.PERMISSION_POLICY_AUTO_DENY: &#123;</span><br><span class="line">                <span class="comment">// 如果设备策略管理设定的是自动拒绝，</span></span><br><span class="line">                <span class="comment">//【2.1.6.2】且该 group 中有权限已授予，那就拒绝他们！</span></span><br><span class="line">                <span class="keyword">if</span> (group.areRuntimePermissionsGranted()) &#123;</span><br><span class="line">                    <span class="comment">//【3.2】撤掉权限</span></span><br><span class="line">                    group.revokeRuntimePermissions(<span class="keyword">false</span>);</span><br><span class="line">                &#125;</span><br><span class="line">                group.setPolicyFixed();  <span class="comment">// 设置 policy fix 标志位</span></span><br><span class="line">            &#125; <span class="keyword">break</span>;</span><br><span class="line"></span><br><span class="line">            <span class="keyword">default</span>: &#123;</span><br><span class="line">                <span class="comment">// 如果设备策略管理设定的是其他策略（正常情况），</span></span><br><span class="line">                <span class="comment">// 如果 group 中有权限未授予，那就将其添加到 mRequestGrantPermissionGroups，接下来要申请！</span></span><br><span class="line">                <span class="comment">// 如果 group 中有权限已授予，那就授予所有的权限，并更新授予结果；</span></span><br><span class="line">                <span class="keyword">if</span> (!group.areRuntimePermissionsGranted()) &#123; <span class="comment">// 同【2.1.6.2】</span></span><br><span class="line">                    mRequestGrantPermissionGroups.put(group.getName(),</span><br><span class="line">                            <span class="keyword">new</span> GroupState(group));</span><br><span class="line">                &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                    <span class="comment">//【3.1】直接授予运行时权限！</span></span><br><span class="line">                    group.grantRuntimePermissions(<span class="keyword">false</span>);</span><br><span class="line">                    updateGrantResults(group); <span class="comment">// 更新申请结果！</span></span><br><span class="line">                &#125;</span><br><span class="line">            &#125; <span class="keyword">break</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        <span class="comment">// 如果权限已经被 fix，不用再提醒，那就直接更新权限的申请结果！</span></span><br><span class="line">        updateGrantResults(group);</span><br><span class="line">    &#125;</span><br><span class="line">    ... ... ... ...</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>当然，一般情况下，我们会进入 default 分支！</p>
<p>这里的 mRequestGrantPermissionGroups 用于保存所有的需要申请的 group 信息：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="class"><span class="keyword">class</span> <span class="title">GroupState</span> </span>&#123;</span><br><span class="line">    <span class="keyword">static</span> <span class="keyword">final</span> <span class="keyword">int</span> STATE_UNKNOWN = <span class="number">0</span>;</span><br><span class="line">    <span class="keyword">static</span> <span class="keyword">final</span> <span class="keyword">int</span> STATE_ALLOWED = <span class="number">1</span>;</span><br><span class="line">    <span class="keyword">static</span> <span class="keyword">final</span> <span class="keyword">int</span> STATE_DENIED = <span class="number">2</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">final</span> AppPermissionGroup mGroup;</span><br><span class="line">    <span class="keyword">int</span> mState = STATE_UNKNOWN;</span><br><span class="line"></span><br><span class="line">    GroupState(AppPermissionGroup group) &#123;</span><br><span class="line">        mGroup = group;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>AppPermissionGroup 会被封装为一个 GroupState 对象，GroupState.mState 保存了该组的授予情况！</p>
<h4 id="2-1-6-1-AppPermissionGroup-isUserFixed-isPolicyFixed"><a href="#2-1-6-1-AppPermissionGroup-isUserFixed-isPolicyFixed" class="headerlink" title="2.1.6.1 AppPermissionGroup.isUserFixed/isPolicyFixed"></a>2.1.6.1 AppPermissionGroup.isUserFixed/isPolicyFixed</h4><p>判断该权限组中是否包含没被 user fix 的权限，如果包含，返回 false！</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">boolean</span> <span class="title">isUserFixed</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    <span class="keyword">final</span> <span class="keyword">int</span> permissionCount = mPermissions.size();</span><br><span class="line">    <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; permissionCount; i++) &#123;</span><br><span class="line">        Permission permission = mPermissions.valueAt(i);</span><br><span class="line">        <span class="comment">//【1】该权限组只要有一个 no user fix 的权限，那个这个组就是 no user fix 的！</span></span><br><span class="line">        <span class="keyword">if</span> (!permission.isUserFixed()) &#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="keyword">false</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">true</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>调用了 Permission.isUserFixed 方法！<br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">boolean</span> <span class="title">isUserFixed</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    <span class="keyword">return</span> (mFlags &amp; PackageManager.FLAG_PERMISSION_USER_FIXED) != <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>同样的，isPolicyFixed 也是类似的作用，判断该权限组中是否包含没有被 policy fix 的权限！<br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">boolean</span> <span class="title">isPolicyFixed</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    <span class="keyword">final</span> <span class="keyword">int</span> permissionCount = mPermissions.size();</span><br><span class="line">    <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; permissionCount; i++) &#123;</span><br><span class="line">        Permission permission = mPermissions.valueAt(i);</span><br><span class="line">        <span class="comment">//【1】该权限组中没有任何一个 policy fix 的权限，那个这个组才是 no policy fix 的！</span></span><br><span class="line">        <span class="keyword">if</span> (permission.isPolicyFixed()) &#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="keyword">true</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">false</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>这是因为 policy fix 属于系统的默认授予机制，针对整个组的权限！</p>
<p>同样的调用了 Permission.isPolicyFixed 方法！<br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">boolean</span> <span class="title">isPolicyFixed</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    <span class="keyword">return</span> (mFlags &amp; PackageManager.FLAG_PERMISSION_POLICY_FIXED) != <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<h4 id="2-1-6-2-AppPermissionGroup-areRuntimePermissionsGranted"><a href="#2-1-6-2-AppPermissionGroup-areRuntimePermissionsGranted" class="headerlink" title="2.1.6.2 AppPermissionGroup.areRuntimePermissionsGranted"></a>2.1.6.2 AppPermissionGroup.areRuntimePermissionsGranted</h4><p>该方法用户判断该 group 中是否有运行时权限被授予！<br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">boolean</span> <span class="title">areRuntimePermissionsGranted</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    <span class="keyword">return</span> areRuntimePermissionsGranted(<span class="keyword">null</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>接着会调用一参数的 areRuntimePermissionsGranted 方法，参数的意思不多说了！<br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">boolean</span> <span class="title">areRuntimePermissionsGranted</span><span class="params">(String[] filterPermissions)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">if</span> (LocationUtils.isLocationGroupAndProvider(mName, mPackageInfo.packageName)) &#123;</span><br><span class="line">        <span class="keyword">return</span> LocationUtils.isLocationEnabled(mContext);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">//【1】遍历该组中的所有运行时权限，根据前面知道，该组中的权限都是该 package 申请的！</span></span><br><span class="line">    <span class="keyword">final</span> <span class="keyword">int</span> permissionCount = mPermissions.size();</span><br><span class="line">    <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; permissionCount; i++) &#123;</span><br><span class="line">        Permission permission = mPermissions.valueAt(i);</span><br><span class="line">        <span class="keyword">if</span> (filterPermissions != <span class="keyword">null</span> <span class="comment">// 如果 filterPermissions 不为 null，那就只处理其内部的权限！</span></span><br><span class="line">                &amp;&amp; !ArrayUtils.contains(filterPermissions, permission.getName())) &#123;</span><br><span class="line">            <span class="keyword">continue</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">//【1.1】如果应用支持运行时权限机制，并且该权限已经被授予，那就返回 true！</span></span><br><span class="line">        <span class="keyword">if</span> (mAppSupportsRuntimePermissions) &#123;</span><br><span class="line">            <span class="keyword">if</span> (permission.isGranted()) &#123;</span><br><span class="line">                <span class="keyword">return</span> <span class="keyword">true</span>;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125; <span class="keyword">else</span> <span class="keyword">if</span> (permission.isGranted() &amp;&amp; (permission.getAppOp() == <span class="keyword">null</span></span><br><span class="line">                || permission.isAppOpAllowed())) &#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="keyword">true</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">false</span>; <span class="comment">// 如果该 group 中没有运行时权限被授予，返回 false！</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>如果有一个运行时权限被授予，那么就会返回 true！</p>
<p>如果没有一个运行时权限被授予，那么就会返回 false！</p>
<h3 id="2-1-7-GPViewHandlerImpl-createView"><a href="#2-1-7-GPViewHandlerImpl-createView" class="headerlink" title="2.1.7 GPViewHandlerImpl.createView"></a>2.1.7 GPViewHandlerImpl.createView</h3><p>接着，通过 setContentView，创建布局界面！<br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> View <span class="title">createView</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    mRootView = (ManualLayoutFrame) LayoutInflater.from(mContext)</span><br><span class="line">            .inflate(R.layout.grant_permissions, <span class="keyword">null</span>);</span><br><span class="line">    mButtonBar = (ButtonBarLayout) mRootView.findViewById(R.id.button_group);</span><br><span class="line">    mButtonBar.setAllowStacking(<span class="keyword">true</span>);</span><br><span class="line">    mMessageView = (TextView) mRootView.findViewById(R.id.permission_message);</span><br><span class="line">    mIconView = (ImageView) mRootView.findViewById(R.id.permission_icon);</span><br><span class="line">    mCurrentGroupView = (TextView) mRootView.findViewById(R.id.current_page_text);</span><br><span class="line">    mDoNotAskCheckbox = (CheckBox) mRootView.findViewById(R.id.do_not_ask_checkbox);</span><br><span class="line">    mAllowButton = (Button) mRootView.findViewById(R.id.permission_allow_button);</span><br><span class="line"></span><br><span class="line">    mDialogContainer = (ViewGroup) mRootView.findViewById(R.id.dialog_container);</span><br><span class="line">    mDescContainer = (ViewGroup) mRootView.findViewById(R.id.desc_container);</span><br><span class="line">    mCurrentDesc = (ViewGroup) mRootView.findViewById(R.id.perm_desc_root);</span><br><span class="line"></span><br><span class="line">    mAllowButton.setOnClickListener(<span class="keyword">this</span>); <span class="comment">// 授予按钮！</span></span><br><span class="line">    mRootView.findViewById(R.id.permission_deny_button).setOnClickListener(<span class="keyword">this</span>); <span class="comment">// 拒绝按钮！</span></span><br><span class="line">    mDoNotAskCheckbox.setOnClickListener(<span class="keyword">this</span>); <span class="comment">// 不在提醒按钮！</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (mGroupName != <span class="keyword">null</span>) &#123; <span class="comment">// mGroupName 用于恢复界面显示！</span></span><br><span class="line">        updateDescription();</span><br><span class="line">        updateGroup();</span><br><span class="line">        updateDoNotAskCheckBox();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> mRootView;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>我们看到，这里给三个按钮绑定的点击事件！</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onClick</span><span class="params">(View view)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">switch</span> (view.getId()) &#123;</span><br><span class="line">        <span class="keyword">case</span> R.id.permission_allow_button: <span class="comment">// 授予权限</span></span><br><span class="line">            <span class="keyword">if</span> (mResultListener != <span class="keyword">null</span>) &#123;</span><br><span class="line">                view.clearAccessibilityFocus();</span><br><span class="line">                mResultListener.onPermissionGrantResult(mGroupName, <span class="keyword">true</span>, <span class="keyword">false</span>); </span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line">        <span class="keyword">case</span> R.id.permission_deny_button: <span class="comment">// 拒绝权限</span></span><br><span class="line">            mAllowButton.setEnabled(<span class="keyword">true</span>);</span><br><span class="line">            <span class="keyword">if</span> (mResultListener != <span class="keyword">null</span>) &#123;</span><br><span class="line">                view.clearAccessibilityFocus();</span><br><span class="line">                mResultListener.onPermissionGrantResult(mGroupName, <span class="keyword">false</span>,</span><br><span class="line">                        mShowDonNotAsk &amp;&amp; mDoNotAskCheckbox.isChecked());</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line">        <span class="keyword">case</span> R.id.do_not_ask_checkbox: <span class="comment">// 不再提醒</span></span><br><span class="line">            mAllowButton.setEnabled(!mDoNotAskCheckbox.isChecked());</span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>当我们点击 allow 或者 deny 后，会回调 mResultListener.onPermissionGrantResult 方法！</p>
<p>当我们点击授予后，执行：<br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">mResultListener.onPermissionGrantResult(mGroupName, <span class="keyword">true</span>, <span class="keyword">false</span>);</span><br></pre></td></tr></table></figure></p>
<p>当我们点击拒绝后，执行：<br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">mResultListener.onPermissionGrantResult(mGroupName, <span class="keyword">false</span>, mShowDonNotAsk &amp;&amp; mDoNotAskCheckbox.isChecked());</span><br></pre></td></tr></table></figure></p>
<ul>
<li><strong>onPermissionGrantResult 参数解析</strong></li>
</ul>
<p>onPermissionGrantResult 的第二个参数 granted 表示授予或者拒绝，为 true 表示授予，为 false 表示拒绝；</p>
<p>onPermissionGrantResult 的第三个参数 doNotAskAgain 表示是否不再询问，为 true 表示不再询问，为 false 需再次询问；</p>
<ul>
<li><p><strong>onPermissionGrantResult 参数处理</strong></p>
<ul>
<li>如果用户本次授予了权限，那么 doNotAskAgain 为 false，意味着下次会继续询问；</li>
<li>如果用户本次拒绝了权限，但是没有选择不再提醒，那么 doNotAskAgain 为 false，意味着下次会继续询问；</li>
<li>如果用户本次拒绝了权限，但是同时选择不再提醒，那么 doNotAskAgain 为 true，那么下次就不会再提醒询问了；</li>
</ul>
</li>
</ul>
<p>当我们点击不再提醒 CheckBox 后，可以看到，授予按钮是无法点击的！</p>
<h4 id="2-1-7-1-GrantPermissionsActivity-onPermissionGrantResult"><a href="#2-1-7-1-GrantPermissionsActivity-onPermissionGrantResult" class="headerlink" title="2.1.7.1 GrantPermissionsActivity.onPermissionGrantResult"></a>2.1.7.1 GrantPermissionsActivity.onPermissionGrantResult</h4><p>mResultListener 实际上就是 GrantPermissionsActivity，我们去看看 onPermissionGrantResult 方法！</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onPermissionGrantResult</span><span class="params">(String name, <span class="keyword">boolean</span> granted, <span class="keyword">boolean</span> doNotAskAgain)</span> </span>&#123;</span><br><span class="line">    <span class="comment">//【1】根据 name 获得对应的运行时权限组！</span></span><br><span class="line">    GroupState groupState = mRequestGrantPermissionGroups.get(name);</span><br><span class="line">    <span class="keyword">if</span> (groupState.mGroup != <span class="keyword">null</span>) &#123;</span><br><span class="line">        <span class="keyword">if</span> (granted) &#123; </span><br><span class="line">            <span class="comment">//【2.1.6.3】处理授予情况！</span></span><br><span class="line">            groupState.mGroup.grantRuntimePermissions(doNotAskAgain); </span><br><span class="line">            groupState.mState = GroupState.STATE_ALLOWED; <span class="comment">// 更新 group 状态！</span></span><br><span class="line">        &#125; <span class="keyword">else</span> &#123; </span><br><span class="line">            <span class="comment">//【2.1.6.4】处理拒绝情况！</span></span><br><span class="line">            groupState.mGroup.revokeRuntimePermissions(doNotAskAgain);</span><br><span class="line">            groupState.mState = GroupState.STATE_DENIED;</span><br><span class="line">        &#125;</span><br><span class="line">        updateGrantResults(groupState.mGroup); <span class="comment">// 更新结果！</span></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (!showNextPermissionGroupGrantRequest()) &#123; <span class="comment">//【2.1.8】继续下一个组的处理！</span></span><br><span class="line">        setResultAndFinish(); <span class="comment">//【2.1.9】处理请求结果，结束！</span></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>可以看到，对于每个组的运行时权限，最后调用的是 setResultAndFinish 会将权限处理的结果返回给请求的 activity！</p>
<h3 id="2-1-8-GPViewHandlerImpl-showNextPermissionGroupGrantRequest"><a href="#2-1-8-GPViewHandlerImpl-showNextPermissionGroupGrantRequest" class="headerlink" title="2.1.8 GPViewHandlerImpl.showNextPermissionGroupGrantRequest"></a>2.1.8 GPViewHandlerImpl.showNextPermissionGroupGrantRequest</h3><p>接下来，就是请求运行时权限了！mRequestGrantPermissionGroups 中保存了所有需要请求的运行时权限组！</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">boolean</span> <span class="title">showNextPermissionGroupGrantRequest</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    <span class="keyword">final</span> <span class="keyword">int</span> groupCount = mRequestGrantPermissionGroups.size();</span><br><span class="line"></span><br><span class="line">    <span class="keyword">int</span> currentIndex = <span class="number">0</span>;</span><br><span class="line">    <span class="keyword">for</span> (GroupState groupState : mRequestGrantPermissionGroups.values()) &#123;</span><br><span class="line">        <span class="keyword">if</span> (groupState.mState == GroupState.STATE_UNKNOWN) &#123;</span><br><span class="line">            CharSequence appLabel = mAppPermissions.getAppLabel();</span><br><span class="line">            Spanned message = Html.fromHtml(getString(R.string.permission_warning_template,</span><br><span class="line">                    appLabel, groupState.mGroup.getDescription()), <span class="number">0</span>);</span><br><span class="line"></span><br><span class="line">            <span class="comment">//【1】将权限信息作为 titile！</span></span><br><span class="line">            setTitle(message);</span><br><span class="line"></span><br><span class="line">            Resources resources;</span><br><span class="line">            <span class="keyword">try</span> &#123;</span><br><span class="line">                resources = getPackageManager().getResourcesForApplication(</span><br><span class="line">                        groupState.mGroup.getIconPkg());</span><br><span class="line">            &#125; <span class="keyword">catch</span> (NameNotFoundException e) &#123;</span><br><span class="line">                <span class="comment">// Fallback to system.</span></span><br><span class="line">                resources = Resources.getSystem();</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">int</span> icon = groupState.mGroup.getIconResId();</span><br><span class="line"></span><br><span class="line">            <span class="comment">//【2.1.8.1】更新 ui 显示！</span></span><br><span class="line">            mViewHandler.updateUi(groupState.mGroup.getName(), groupCount, currentIndex,</span><br><span class="line">                    Icon.createWithResource(resources, icon), message,</span><br><span class="line">                    groupState.mGroup.isUserSet());</span><br><span class="line">            <span class="keyword">return</span> <span class="keyword">true</span>;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        currentIndex++;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">false</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>最后会调用了 updateUi 方法，更新 ui 显示！</p>
<p>updateUi 的最后一个参数：boolean showDonNotAsk 表示是否显示　“不再提醒”　的 CheckBox，为 true，表示不显示，其值取决于：<br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">groupState.mGroup.isUserSet()</span><br></pre></td></tr></table></figure></p>
<p>我们去看看 group 的 isUserSet 方法！<br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">boolean</span> <span class="title">isUserSet</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    <span class="keyword">final</span> <span class="keyword">int</span> permissionCount = mPermissions.size();</span><br><span class="line">    <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; permissionCount; i++) &#123;</span><br><span class="line">        Permission permission = mPermissions.valueAt(i);</span><br><span class="line">        <span class="keyword">if</span> (!permission.isUserSet()) &#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="keyword">false</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">true</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>也就是说，取决于该 group 中该应用请求的运行时权限是否都是 user set 的，即：<strong>之前用户是否拒绝授予过权限</strong>，只有之前拒绝过并且没有选择不在提醒，下一次提醒用户时，才会显示 checkbox！</p>
<h4 id="2-1-8-1-GPViewHandlerImpl-updateUi"><a href="#2-1-8-1-GPViewHandlerImpl-updateUi" class="headerlink" title="2.1.8.1 GPViewHandlerImpl.updateUi"></a>2.1.8.1 GPViewHandlerImpl.updateUi</h4><p>showDonNotAsk 的取值为 groupState.mGroup.isUserSet()，就似乎说，如果用户之前拒绝了该权限并且没有选择不再提醒，那么再次提示时 showDonNotAsk 为 true！</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">updateUi</span><span class="params">(String groupName, <span class="keyword">int</span> groupCount, <span class="keyword">int</span> groupIndex, Icon icon,</span></span></span><br><span class="line"><span class="function"><span class="params">        CharSequence message, <span class="keyword">boolean</span> showDonNotAsk)</span> </span>&#123;</span><br><span class="line">    <span class="comment">//【1】保存当前的显示内容和进度！</span></span><br><span class="line">    mGroupName = groupName; <span class="comment">// group 名！</span></span><br><span class="line">    mGroupCount = groupCount; <span class="comment">// group 的总数！</span></span><br><span class="line">    mGroupIndex = groupIndex; <span class="comment">// 当前处理的 group！ </span></span><br><span class="line">    mGroupIcon = icon;</span><br><span class="line">    mGroupMessage = message;</span><br><span class="line">    mShowDonNotAsk = showDonNotAsk; <span class="comment">// 是否显示 checkBox</span></span><br><span class="line">    mDoNotAskChecked = <span class="keyword">false</span>; <span class="comment">// 是否不再提醒！</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">// If this is a second (or later) permission and the views exist, then animate.</span></span><br><span class="line">    <span class="keyword">if</span> (mIconView != <span class="keyword">null</span>) &#123;</span><br><span class="line">        <span class="keyword">if</span> (mGroupIndex &gt; <span class="number">0</span>) &#123;</span><br><span class="line">            <span class="comment">// The first message will be announced as the title of the activity, all others</span></span><br><span class="line">            <span class="comment">// we need to announce ourselves.</span></span><br><span class="line">            mDescContainer.announceForAccessibility(message);</span><br><span class="line">            animateToPermission();</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            updateDescription();</span><br><span class="line">            updateGroup();</span><br><span class="line">            updateDoNotAskCheckBox();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>接下来，就会显示出权限弹窗了！</p>
<p>用户会通过点击弹窗中的按钮，授予或者拒绝权限！</p>
<h5 id="2-1-8-1-1-GPViewHandlerImpl-updateDescription"><a href="#2-1-8-1-1-GPViewHandlerImpl-updateDescription" class="headerlink" title="2.1.8.1.1 GPViewHandlerImpl.updateDescription"></a>2.1.8.1.1 GPViewHandlerImpl.updateDescription</h5><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">updateDescription</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    mIconView.setImageDrawable(mGroupIcon.loadDrawable(mContext));</span><br><span class="line">    mMessageView.setText(mGroupMessage);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h5 id="2-1-8-1-2-GPViewHandlerImpl-updateGroup"><a href="#2-1-8-1-2-GPViewHandlerImpl-updateGroup" class="headerlink" title="2.1.8.1.2 GPViewHandlerImpl.updateGroup"></a>2.1.8.1.2 GPViewHandlerImpl.updateGroup</h5><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">updateGroup</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    <span class="keyword">if</span> (mGroupCount &gt; <span class="number">1</span>) &#123;</span><br><span class="line">        mCurrentGroupView.setVisibility(View.VISIBLE);</span><br><span class="line">        mCurrentGroupView.setText(mContext.getString(R.string.current_permission_template,</span><br><span class="line">                mGroupIndex + <span class="number">1</span>, mGroupCount));</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        mCurrentGroupView.setVisibility(View.INVISIBLE);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h5 id="2-1-8-1-3-GPViewHandlerImpl-updateDoNotAskCheckBox"><a href="#2-1-8-1-3-GPViewHandlerImpl-updateDoNotAskCheckBox" class="headerlink" title="2.1.8.1.3 GPViewHandlerImpl.updateDoNotAskCheckBox"></a>2.1.8.1.3 GPViewHandlerImpl.updateDoNotAskCheckBox</h5><p>是否显示 CheckBox 取决于 mShowDonNotAsk，如果 mShowDonNotAsk 为 true，那就显示 checkBox！</p>
<p>CheckBox 的默认状态则是由 mDoNotAskChecked 来决定，默认 mDoNotAskChecked 为 false，此时 CheckBox 没有被选中！</p>
<p>同时 CheckBox 的点击也会修改 mDoNotAskChecked 的值！<br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">updateDoNotAskCheckBox</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    <span class="keyword">if</span> (mShowDonNotAsk) &#123;</span><br><span class="line">        <span class="comment">// 显示 CheckBox</span></span><br><span class="line">        mDoNotAskCheckbox.setVisibility(View.VISIBLE);</span><br><span class="line">        mDoNotAskCheckbox.setOnClickListener(<span class="keyword">this</span>);</span><br><span class="line">        mDoNotAskCheckbox.setChecked(mDoNotAskChecked); <span class="comment">// 根据 mDoNotAskChecked 的值设置 CheckBox 的状态！</span></span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        <span class="comment">// 不显示 CheckBox</span></span><br><span class="line">        mDoNotAskCheckbox.setVisibility(View.GONE);</span><br><span class="line">        mDoNotAskCheckbox.setOnClickListener(<span class="keyword">null</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<h3 id="2-1-9-GrantPermissionsActivity-setResultAndFinish"><a href="#2-1-9-GrantPermissionsActivity-setResultAndFinish" class="headerlink" title="2.1.9 GrantPermissionsActivity.setResultAndFinish"></a>2.1.9 GrantPermissionsActivity.setResultAndFinish</h3><p>处理结果：<br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">setResultAndFinish</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    setResultIfNeeded(RESULT_OK);</span><br><span class="line">    finish(); <span class="comment">// 调用 finish，结束当前 activity！</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>setResultAndFinish 会调用 setResultIfNeeded 方法！<br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">setResultIfNeeded</span><span class="params">(<span class="keyword">int</span> resultCode)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">if</span> (!mResultSet) &#123;</span><br><span class="line">        mResultSet = <span class="keyword">true</span>;</span><br><span class="line">        logRequestedPermissionGroups();</span><br><span class="line">        <span class="comment">// 同样的，创建一个 intent，action 为 ACTION_REQUEST_PERMISSIONS！</span></span><br><span class="line">        Intent result = <span class="keyword">new</span> Intent(PackageManager.ACTION_REQUEST_PERMISSIONS);</span><br><span class="line">        <span class="comment">// 保存了请求的权限和请求结果！</span></span><br><span class="line">        result.putExtra(PackageManager.EXTRA_REQUEST_PERMISSIONS_NAMES, mRequestedPermissions);</span><br><span class="line">        result.putExtra(PackageManager.EXTRA_REQUEST_PERMISSIONS_RESULTS, mGrantResults);</span><br><span class="line">        <span class="comment">// 将结果返回给请求权限的 activity</span></span><br><span class="line">        setResult(resultCode, result);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>在调用了 finish 后，请求结果会返回到请求的 acitivty！</p>
<h4 id="2-1-9-1-RequestActivity-onRequestPermissionsResult"><a href="#2-1-9-1-RequestActivity-onRequestPermissionsResult" class="headerlink" title="2.1.9.1 RequestActivity.onRequestPermissionsResult"></a>2.1.9.1 RequestActivity.onRequestPermissionsResult</h4><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onRequestPermissionsResult</span><span class="params">(<span class="keyword">int</span> requestCode, String[] permissions, <span class="keyword">int</span>[] grantResults)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">super</span>.onRequestPermissionsResult(requestCode, permissions, grantResults);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>最后，我们会在请求的 activity 中收到权限请求的结果！</p>
<h1 id="3-AppPermissionGroup-Grant-or-Revoke-授予-拒绝"><a href="#3-AppPermissionGroup-Grant-or-Revoke-授予-拒绝" class="headerlink" title="3 AppPermissionGroup: Grant or Revoke - 授予/拒绝"></a>3 AppPermissionGroup: Grant or Revoke - 授予/拒绝</h1><p>下面我们来看看 AppPermissionGroup 是如何授予和拒绝权限的！</p>
<h2 id="3-1-AppPermissionGroup-grantRuntimePermissions"><a href="#3-1-AppPermissionGroup-grantRuntimePermissions" class="headerlink" title="3.1 AppPermissionGroup.grantRuntimePermissions"></a>3.1 AppPermissionGroup.grantRuntimePermissions</h2><p>fixedByTheUser 表示是否是被用户 fix 的:</p>
<p>对于 permissionPolicy 如果为 DevicePolicyManager.PERMISSION_POLICY_AUTO_GRANT 的情况，其值为 false，我们会自动授予权限！</p>
<p>正常情况下，是需要根据用户的选择来设置这个值的，如果用户本次授予了权限，那么 fixedByTheUser 依然为 false； </p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">boolean</span> <span class="title">grantRuntimePermissions</span><span class="params">(<span class="keyword">boolean</span> fixedByTheUser)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">return</span> grantRuntimePermissions(fixedByTheUser, <span class="keyword">null</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>调用的二参数的同名方法！<br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">boolean</span> <span class="title">grantRuntimePermissions</span><span class="params">(<span class="keyword">boolean</span> fixedByTheUser, String[] filterPermissions)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">final</span> <span class="keyword">int</span> uid = mPackageInfo.applicationInfo.uid;</span><br><span class="line">    <span class="comment">//【1】我们仅将权限切换到支持运行时权限的应用程序，否则，如果权限授予应用程序，则会切换与权限对应的应用程序op。</span></span><br><span class="line">    <span class="keyword">for</span> (Permission permission : mPermissions.values()) &#123;</span><br><span class="line">        <span class="keyword">if</span> (filterPermissions != <span class="keyword">null</span> <span class="comment">// 处理权限过滤，这里不关注！</span></span><br><span class="line">                &amp;&amp; !ArrayUtils.contains(filterPermissions, permission.getName())) &#123;</span><br><span class="line">            <span class="keyword">continue</span>;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (mAppSupportsRuntimePermissions) &#123; <span class="comment">//【1.1】对于运行时权限进入这里！</span></span><br><span class="line">            <span class="keyword">if</span> (permission.isSystemFixed()) &#123; <span class="comment">// 如果运行时权限被 system fix 了，结束处理！</span></span><br><span class="line">                <span class="keyword">return</span> <span class="keyword">false</span>;</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            <span class="comment">//【1.1.1】确保运行时权限在授予之前，AppOp 为 allow 状态！</span></span><br><span class="line">            <span class="comment">// 判断该权限是否有对应的 AppOps，如果有且不处于 Allow 状态，设置其为 Allow！</span></span><br><span class="line">            <span class="keyword">if</span> (permission.hasAppOp() &amp;&amp; !permission.isAppOpAllowed()) &#123;</span><br><span class="line">                permission.setAppOpAllowed(<span class="keyword">true</span>);</span><br><span class="line">                mAppOps.setUidMode(permission.getAppOp(), uid, AppOpsManager.MODE_ALLOWED);</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            <span class="keyword">if</span> (!permission.isGranted()) &#123;</span><br><span class="line">                permission.setGranted(<span class="keyword">true</span>);</span><br><span class="line">                <span class="comment">//【4.1】调用了 pms 的接口授予用户权限</span></span><br><span class="line">                mPackageManager.grantRuntimePermission(mPackageInfo.packageName,</span><br><span class="line">                        permission.getName(), mUserHandle);</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            <span class="comment">//【1.1.2】如果 fixedByTheUser 为 false，更新权限的 flags。</span></span><br><span class="line">            <span class="keyword">if</span> (!fixedByTheUser) &#123;</span><br><span class="line">                <span class="comment">// 如果该运行时权限处于 user fix 或者 user set 状态，那么我们会强制取消 user fix 状态！</span></span><br><span class="line">                <span class="comment">// 这样用户就可以再次请求请求权限，因为其不处于 user fix 状态！</span></span><br><span class="line">                <span class="keyword">if</span> (permission.isUserFixed() || permission.isUserSet()) &#123;</span><br><span class="line">                    permission.setUserFixed(<span class="keyword">false</span>);</span><br><span class="line">                    permission.setUserSet(<span class="keyword">true</span>);</span><br><span class="line">                    <span class="comment">// 更新权限的 flags，</span></span><br><span class="line">                    <span class="comment">// 去掉 flags 中 FLAG_PERMISSION_USER_FIXED 和 FLAG_PERMISSION_USER_SET 位！</span></span><br><span class="line">                    mPackageManager.updatePermissionFlags(permission.getName(),</span><br><span class="line">                            mPackageInfo.packageName,</span><br><span class="line">                            PackageManager.FLAG_PERMISSION_USER_FIXED</span><br><span class="line">                                    | PackageManager.FLAG_PERMISSION_USER_SET,</span><br><span class="line">                            <span class="number">0</span>, mUserHandle);</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            <span class="comment">//【1.2】如果应用不支持运行时权限，这里不处理未授予情况，因为在 API 23 之前运行时权限是自动授予的！</span></span><br><span class="line">            <span class="keyword">if</span> (!permission.isGranted()) &#123;</span><br><span class="line">                <span class="keyword">continue</span>;</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            <span class="keyword">int</span> killUid = -<span class="number">1</span>;</span><br><span class="line">            <span class="keyword">int</span> mask = <span class="number">0</span>;</span><br><span class="line"></span><br><span class="line">            <span class="comment">// 如果权限没有对应的 app op，那么说明这是一个第三方应用，那么我们不对其做调整；</span></span><br><span class="line">            <span class="comment">// 否则，我们会调整其 app op！</span></span><br><span class="line">            <span class="keyword">if</span> (permission.hasAppOp()) &#123;</span><br><span class="line">                <span class="comment">// 如果权限不允许 app op，那就开启 app ops！</span></span><br><span class="line">                <span class="keyword">if</span> (!permission.isAppOpAllowed()) &#123;</span><br><span class="line">                    permission.setAppOpAllowed(<span class="keyword">true</span>);</span><br><span class="line">                    <span class="comment">// 开启 app op</span></span><br><span class="line">                    mAppOps.setUidMode(permission.getAppOp(), uid, AppOpsManager.MODE_ALLOWED);</span><br><span class="line"></span><br><span class="line">                    <span class="comment">// 对于旧版本的不支持运行时权限的应用，当其运行时权限改变后，其不会尝试重试资源的访问，</span></span><br><span class="line">                    <span class="comment">// 所以我们需要杀掉其进程，使其重新加载！</span></span><br><span class="line">                    killUid = uid;</span><br><span class="line">                &#125;</span><br><span class="line"></span><br><span class="line">                <span class="comment">// 如果应用从不支持运行时权限升级到了支持运行时权限的版本，升级后不能自动授予权限！</span></span><br><span class="line">                <span class="comment">// 权限设置了 FLAG_PERMISSION_REVOKE_ON_UPGRADE 标志位！</span></span><br><span class="line">                <span class="keyword">if</span> (permission.shouldRevokeOnUpgrade()) &#123;</span><br><span class="line">                    permission.setRevokeOnUpgrade(<span class="keyword">false</span>);</span><br><span class="line">                    mask |= PackageManager.FLAG_PERMISSION_REVOKE_ON_UPGRADE;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            <span class="keyword">if</span> (mask != <span class="number">0</span>) &#123;</span><br><span class="line">                <span class="comment">// 更新该权限的 flags，取消 FLAG_PERMISSION_REVOKE_ON_UPGRADE 标志位！</span></span><br><span class="line">                mPackageManager.updatePermissionFlags(permission.getName(),</span><br><span class="line">                        mPackageInfo.packageName, mask, <span class="number">0</span>, mUserHandle);</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            <span class="keyword">if</span> (killUid != -<span class="number">1</span>) &#123; <span class="comment">// 杀掉进程！</span></span><br><span class="line">                mActivityManager.killUid(uid, KILL_REASON_APP_OP_CHANGE);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">true</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>对于允许权限的情况：</p>
<ul>
<li>那么 fixedByTheUser 只能是 false，我们会取消 user set 和 user fix 标志位！</li>
</ul>
<h2 id="3-2-AppPermissionGroup-revokeRuntimePermissions"><a href="#3-2-AppPermissionGroup-revokeRuntimePermissions" class="headerlink" title="3.2 AppPermissionGroup.revokeRuntimePermissions"></a>3.2 AppPermissionGroup.revokeRuntimePermissions</h2><p>对于 permissionPolicy 为 DevicePolicyManager.PERMISSION_POLICY_AUTO_DENY 的情况，fixedByTheUser 为 false，同时会自动撤销权限！</p>
<p>正常情况下，是需要根据用户的选择来设置这个值的，如果用户本次拒绝了权限，但是 fixedByTheUser 可能有两种情况：</p>
<ul>
<li>如果用户只是拒绝了权限，但是没有点击不再提醒，那么 fixedByTheUser 为 false；</li>
<li>如果用户不仅拒绝了权限，同时选择了不再提醒，那么 fixedByTheUser 为 true；</li>
</ul>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">boolean</span> <span class="title">revokeRuntimePermissions</span><span class="params">(<span class="keyword">boolean</span> fixedByTheUser)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">return</span> revokeRuntimePermissions(fixedByTheUser, <span class="keyword">null</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>调用了 revokeRuntimePermissions 的另一个方法！<br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">boolean</span> <span class="title">revokeRuntimePermissions</span><span class="params">(<span class="keyword">boolean</span> fixedByTheUser, String[] filterPermissions)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">final</span> <span class="keyword">int</span> uid = mPackageInfo.applicationInfo.uid;</span><br><span class="line">    <span class="comment">//【1】我们仅将权限切换到支持运行时权限的应用程序，否则，如果权限授予应用程序，则会切换与权限对应的应用程序 op。</span></span><br><span class="line">    <span class="keyword">for</span> (Permission permission : mPermissions.values()) &#123;</span><br><span class="line">        <span class="keyword">if</span> (filterPermissions != <span class="keyword">null</span></span><br><span class="line">                &amp;&amp; !ArrayUtils.contains(filterPermissions, permission.getName())) &#123;</span><br><span class="line">            <span class="keyword">continue</span>;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (mAppSupportsRuntimePermissions) &#123; <span class="comment">//【1.1】对于运行时权限进入这里！</span></span><br><span class="line">            <span class="keyword">if</span> (permission.isSystemFixed()) &#123; <span class="comment">// 如果运行时权限被 system fix 了，结束处理！</span></span><br><span class="line">                <span class="keyword">return</span> <span class="keyword">false</span>;</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            <span class="keyword">if</span> (permission.isGranted()) &#123;</span><br><span class="line">                permission.setGranted(<span class="keyword">false</span>);</span><br><span class="line">                <span class="comment">//【4.2】调用了 PMS 的接口撤销权限</span></span><br><span class="line">                mPackageManager.revokeRuntimePermission(mPackageInfo.packageName,</span><br><span class="line">                        permission.getName(), mUserHandle);</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            <span class="comment">//【1.1.1】更新权限的标志位！</span></span><br><span class="line">            <span class="keyword">if</span> (fixedByTheUser) &#123;</span><br><span class="line">                <span class="comment">//【1.1.1.1】如果 fixedByTheUser 是 true，且权限是 user set 或者不是 user fix，</span></span><br><span class="line">                <span class="comment">// 我们取消 set 设置其为 user fix！</span></span><br><span class="line">                <span class="keyword">if</span> (permission.isUserSet() || !permission.isUserFixed()) &#123;</span><br><span class="line">                    permission.setUserSet(<span class="keyword">false</span>);</span><br><span class="line">                    permission.setUserFixed(<span class="keyword">true</span>);</span><br><span class="line">                    <span class="comment">// 取消 user set 标志，设置 user fix 标志！</span></span><br><span class="line">                    mPackageManager.updatePermissionFlags(permission.getName(),</span><br><span class="line">                            mPackageInfo.packageName,</span><br><span class="line">                            PackageManager.FLAG_PERMISSION_USER_SET</span><br><span class="line">                                    | PackageManager.FLAG_PERMISSION_USER_FIXED,</span><br><span class="line">                            PackageManager.FLAG_PERMISSION_USER_FIXED,</span><br><span class="line">                            mUserHandle);</span><br><span class="line">                &#125;</span><br><span class="line">            &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                <span class="comment">//【1.1.1.2】如果 fixedByTheUser 是 false，且权限不是 user set，我们设置其为 user set！</span></span><br><span class="line">                <span class="keyword">if</span> (!permission.isUserSet()) &#123;</span><br><span class="line">                    permission.setUserSet(<span class="keyword">true</span>);</span><br><span class="line">                    <span class="comment">// 设置 user set 标志，表示用户已经做过选择！！</span></span><br><span class="line">                    mPackageManager.updatePermissionFlags(permission.getName(),</span><br><span class="line">                            mPackageInfo.packageName,</span><br><span class="line">                            PackageManager.FLAG_PERMISSION_USER_SET,</span><br><span class="line">                            PackageManager.FLAG_PERMISSION_USER_SET,</span><br><span class="line">                            mUserHandle);</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            <span class="comment">//【1.2】如果应用不支持运行时权限，这里不处理未授予情况，因为在 API 23 之前运行时权限是自动授予的！</span></span><br><span class="line">            <span class="keyword">if</span> (!permission.isGranted()) &#123;</span><br><span class="line">                <span class="keyword">continue</span>;</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            <span class="keyword">int</span> mask = <span class="number">0</span>;</span><br><span class="line">            <span class="keyword">int</span> flags = <span class="number">0</span>;</span><br><span class="line">            <span class="keyword">int</span> killUid = -<span class="number">1</span>;</span><br><span class="line"></span><br><span class="line">            <span class="comment">// 如果权限没有对应的 app op，那么说明这是一个第三方应用，那么我们不对其做调整；</span></span><br><span class="line">            <span class="comment">// 否则，我们会调整其 app op！</span></span><br><span class="line">            <span class="keyword">if</span> (permission.hasAppOp()) &#123;</span><br><span class="line">                <span class="keyword">if</span> (permission.isAppOpAllowed()) &#123; <span class="comment">// 如果权限允许 app op，那就关闭 app ops！</span></span><br><span class="line">                    permission.setAppOpAllowed(<span class="keyword">false</span>);</span><br><span class="line">                    mAppOps.setUidMode(permission.getAppOp(), uid, AppOpsManager.MODE_IGNORED);</span><br><span class="line"></span><br><span class="line">                    <span class="comment">// 对于旧版本的不支持运行时权限的引用，当其运行时权限改变后，其不会尝试重试资源的访问，</span></span><br><span class="line">                    <span class="comment">// 所以我们需要杀掉其进程，使其重新加载！</span></span><br><span class="line">                    killUid = uid;</span><br><span class="line">                &#125;</span><br><span class="line"></span><br><span class="line">                <span class="comment">// 如果应用从不支持运行时权限升级到了支持运行时权限的版本，升级后不能自动授予权限！</span></span><br><span class="line">                <span class="comment">// 权限未设置 FLAG_PERMISSION_REVOKE_ON_UPGRADE 标志位！</span></span><br><span class="line">                <span class="keyword">if</span> (!permission.shouldRevokeOnUpgrade()) &#123;</span><br><span class="line">                    permission.setRevokeOnUpgrade(<span class="keyword">true</span>);</span><br><span class="line">                    mask |= PackageManager.FLAG_PERMISSION_REVOKE_ON_UPGRADE;</span><br><span class="line">                    flags |= PackageManager.FLAG_PERMISSION_REVOKE_ON_UPGRADE;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            <span class="keyword">if</span> (mask != <span class="number">0</span>) &#123;</span><br><span class="line">                <span class="comment">// 更新该权限的 flags，增加 FLAG_PERMISSION_REVOKE_ON_UPGRADE 标志位！</span></span><br><span class="line">                mPackageManager.updatePermissionFlags(permission.getName(),</span><br><span class="line">                        mPackageInfo.packageName, mask, flags, mUserHandle);</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            <span class="keyword">if</span> (killUid != -<span class="number">1</span>) &#123; <span class="comment">// 杀掉进程！</span></span><br><span class="line">                mActivityManager.killUid(uid, KILL_REASON_APP_OP_CHANGE);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">true</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>对于拒绝权限的情况：</p>
<ul>
<li><p>如果用户没有选择不再提醒，那么 fixedByTheUser 为 false，我们会设置 user set 标志位！</p>
</li>
<li><p>如果用户同时还选择了不再提醒，那么 fixedByTheUser 为 true，那么会取消 user set 标志位，同时设置 user fix 标志位！</p>
</li>
</ul>
<h1 id="4-PackageManagerService-Grant-or-Revoke-核心接口"><a href="#4-PackageManagerService-Grant-or-Revoke-核心接口" class="headerlink" title="4 PackageManagerService: Grant or Revoke - 核心接口"></a>4 PackageManagerService: Grant or Revoke - 核心接口</h1><p>当然，核心方法是调用 pms 的接口完成的，我们去看看这些方法！</p>
<h2 id="4-1-PackageManagerS-grantRuntimePermission"><a href="#4-1-PackageManagerS-grantRuntimePermission" class="headerlink" title="4.1 PackageManagerS.grantRuntimePermission"></a>4.1 PackageManagerS.grantRuntimePermission</h2><p>授予运行时权限：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">grantRuntimePermission</span><span class="params">(String packageName, String name, <span class="keyword">final</span> <span class="keyword">int</span> userId)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">if</span> (!sUserManager.exists(userId)) &#123; <span class="comment">//【1】校验用户是否存在！</span></span><br><span class="line">        Log.e(TAG, <span class="string">"No such user:"</span> + userId);</span><br><span class="line">        <span class="keyword">return</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    mContext.enforceCallingOrSelfPermission( <span class="comment">//【2】校验调用者是否有相应权限；</span></span><br><span class="line">            android.Manifest.permission.GRANT_RUNTIME_PERMISSIONS,</span><br><span class="line">            <span class="string">"grantRuntimePermission"</span>);</span><br><span class="line"></span><br><span class="line">    enforceCrossUserPermission(Binder.getCallingUid(), userId,</span><br><span class="line">            <span class="keyword">true</span> <span class="comment">/* requireFullPermission */</span>, <span class="keyword">true</span> <span class="comment">/* checkShell */</span>,</span><br><span class="line">            <span class="string">"grantRuntimePermission"</span>);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">final</span> <span class="keyword">int</span> uid;</span><br><span class="line">    <span class="keyword">final</span> SettingBase sb;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">synchronized</span> (mPackages) &#123;</span><br><span class="line">        <span class="keyword">final</span> PackageParser.Package pkg = mPackages.get(packageName);</span><br><span class="line">        <span class="keyword">if</span> (pkg == <span class="keyword">null</span>) &#123; <span class="comment">//【3】package 不存在，异常！</span></span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> IllegalArgumentException(<span class="string">"Unknown package: "</span> + packageName);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">final</span> BasePermission bp = mSettings.mPermissions.get(name);</span><br><span class="line">        <span class="keyword">if</span> (bp == <span class="keyword">null</span>) &#123; <span class="comment">//【4】权限不存在，异常！</span></span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> IllegalArgumentException(<span class="string">"Unknown permission: "</span> + name);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        enforceDeclaredAsUsedAndRuntimeOrDevelopmentPermission(pkg, bp);</span><br><span class="line"></span><br><span class="line">        <span class="comment">//【5】如果 targetSdkVersion 小于 M，那么是不支持运行时权限的，我们在安装的时候会自动授予运行时权限！</span></span><br><span class="line">        <span class="keyword">if</span> (Build.PERMISSIONS_REVIEW_REQUIRED</span><br><span class="line">                &amp;&amp; pkg.applicationInfo.targetSdkVersion &lt; Build.VERSION_CODES.M</span><br><span class="line">                &amp;&amp; bp.isRuntime()) &#123;</span><br><span class="line">            <span class="keyword">return</span>;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        uid = UserHandle.getUid(userId, pkg.applicationInfo.uid);</span><br><span class="line">        sb = (SettingBase) pkg.mExtras;</span><br><span class="line">        <span class="keyword">if</span> (sb == <span class="keyword">null</span>) &#123;<span class="comment">//【6】升级包未安装过，异常！</span></span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> IllegalArgumentException(<span class="string">"Unknown package: "</span> + packageName);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">final</span> PermissionsState permissionsState = sb.getPermissionsState();</span><br><span class="line">        <span class="comment">//【7】获得权限的 flags 标志位，如果该权限是被 system fix 的，我们不能操作这样的权限！</span></span><br><span class="line">        <span class="keyword">final</span> <span class="keyword">int</span> flags = permissionsState.getPermissionFlags(name, userId);</span><br><span class="line">        <span class="keyword">if</span> ((flags &amp; PackageManager.FLAG_PERMISSION_SYSTEM_FIXED) != <span class="number">0</span>) &#123;</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> SecurityException(<span class="string">"Cannot grant system fixed permission "</span></span><br><span class="line">                    + name + <span class="string">" for package "</span> + packageName);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment">//【8】如果该权限是开发者权限，特殊处理，作为安装时权限，立刻授予！</span></span><br><span class="line">        <span class="comment">// 授予成功，会触发 Settings.writeLPr 方法，该方法会更新多个文件</span></span><br><span class="line">        <span class="comment">// 包括 pacakges.xml，pacakges.list，runtime-permissions.xml 等文件！</span></span><br><span class="line">        <span class="keyword">if</span> (bp.isDevelopment()) &#123;</span><br><span class="line">            <span class="keyword">if</span> (permissionsState.grantInstallPermission(bp) !=</span><br><span class="line">                    PermissionsState.PERMISSION_OPERATION_FAILURE) &#123;</span><br><span class="line">                scheduleWriteSettingsLocked();</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">return</span>;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (pkg.applicationInfo.targetSdkVersion &lt; Build.VERSION_CODES.M) &#123;</span><br><span class="line">            Slog.w(TAG, <span class="string">"Cannot grant runtime permission to a legacy app"</span>);</span><br><span class="line">            <span class="keyword">return</span>;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment">//【9】授予权限，并处理授予结果！！</span></span><br><span class="line">        <span class="keyword">final</span> <span class="keyword">int</span> result = permissionsState.grantRuntimePermission(bp, userId);</span><br><span class="line">        <span class="keyword">switch</span> (result) &#123;</span><br><span class="line">            <span class="keyword">case</span> PermissionsState.PERMISSION_OPERATION_FAILURE: &#123;</span><br><span class="line">                <span class="comment">//【9.1】授予失败，可能应用已经被授予权限了！</span></span><br><span class="line">                <span class="keyword">return</span>;</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            <span class="keyword">case</span> PermissionsState.PERMISSION_OPERATION_SUCCESS_GIDS_CHANGED: &#123;</span><br><span class="line">                <span class="comment">//【9.2】授予成功，但是应用映射的 gids 变化了！</span></span><br><span class="line">                <span class="keyword">final</span> <span class="keyword">int</span> appId = UserHandle.getAppId(pkg.applicationInfo.uid);</span><br><span class="line">                mHandler.post(<span class="keyword">new</span> Runnable() &#123;</span><br><span class="line">                    <span class="meta">@Override</span></span><br><span class="line">                    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">run</span><span class="params">()</span> </span>&#123;</span><br><span class="line">                        <span class="comment">//【9.2.1】杀掉应用的进程，应用后续会重启！</span></span><br><span class="line">                        killUid(appId, userId, KILL_APP_REASON_GIDS_CHANGED);</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;);</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        mOnPermissionChangeListeners.onPermissionsChanged(uid);</span><br><span class="line"></span><br><span class="line">        <span class="comment">//【10】更新 runtime-permissions.xml 文件！</span></span><br><span class="line">        mSettings.writeRuntimePermissionsForUserLPr(userId, <span class="keyword">false</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// Only need to do this if user is initialized. Otherwise it's a new user</span></span><br><span class="line">    <span class="comment">// and there are no processes running as the user yet and there's no need</span></span><br><span class="line">    <span class="comment">// to make an expensive call to remount processes for the changed permissions.</span></span><br><span class="line">    <span class="keyword">if</span> (READ_EXTERNAL_STORAGE.equals(name)</span><br><span class="line">            || WRITE_EXTERNAL_STORAGE.equals(name)) &#123;</span><br><span class="line">        <span class="keyword">final</span> <span class="keyword">long</span> token = Binder.clearCallingIdentity();</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            <span class="keyword">if</span> (sUserManager.isInitialized(userId)) &#123;</span><br><span class="line">                MountServiceInternal mountServiceInternal = LocalServices.getService(</span><br><span class="line">                        MountServiceInternal.class);</span><br><span class="line">                mountServiceInternal.onExternalStoragePolicyChanged(uid, packageName);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">            Binder.restoreCallingIdentity(token);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h2 id="4-2-PackageManagerS-revokeRuntimePermission"><a href="#4-2-PackageManagerS-revokeRuntimePermission" class="headerlink" title="4.2 PackageManagerS.revokeRuntimePermission"></a>4.2 PackageManagerS.revokeRuntimePermission</h2><p>拒绝运行时权限！</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">revokeRuntimePermission</span><span class="params">(String packageName, String name, <span class="keyword">int</span> userId)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">if</span> (!sUserManager.exists(userId)) &#123; <span class="comment">//【1】校验用户是否存在！</span></span><br><span class="line">        Log.e(TAG, <span class="string">"No such user:"</span> + userId);</span><br><span class="line">        <span class="keyword">return</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    mContext.enforceCallingOrSelfPermission( <span class="comment">//【2】校验调用者是否有相应权限；</span></span><br><span class="line">            android.Manifest.permission.REVOKE_RUNTIME_PERMISSIONS,</span><br><span class="line">            <span class="string">"revokeRuntimePermission"</span>);</span><br><span class="line"></span><br><span class="line">    enforceCrossUserPermission(Binder.getCallingUid(), userId,</span><br><span class="line">            <span class="keyword">true</span> <span class="comment">/* requireFullPermission */</span>, <span class="keyword">true</span> <span class="comment">/* checkShell */</span>,</span><br><span class="line">            <span class="string">"revokeRuntimePermission"</span>);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">final</span> <span class="keyword">int</span> appId;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">synchronized</span> (mPackages) &#123;</span><br><span class="line">        <span class="keyword">final</span> PackageParser.Package pkg = mPackages.get(packageName);</span><br><span class="line">        <span class="keyword">if</span> (pkg == <span class="keyword">null</span>) &#123; <span class="comment">//【3】package 不存在，异常！</span></span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> IllegalArgumentException(<span class="string">"Unknown package: "</span> + packageName);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">final</span> BasePermission bp = mSettings.mPermissions.get(name);</span><br><span class="line">        <span class="keyword">if</span> (bp == <span class="keyword">null</span>) &#123; <span class="comment">//【4】权限不存在，异常！</span></span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> IllegalArgumentException(<span class="string">"Unknown permission: "</span> + name);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        enforceDeclaredAsUsedAndRuntimeOrDevelopmentPermission(pkg, bp);</span><br><span class="line"></span><br><span class="line">        <span class="comment">//【5】如果 targetSdkVersion 小于 M，那么是不支持运行时权限的，我们在安装的时候会自动授予运行时权限！</span></span><br><span class="line">        <span class="keyword">if</span> (Build.PERMISSIONS_REVIEW_REQUIRED</span><br><span class="line">                &amp;&amp; pkg.applicationInfo.targetSdkVersion &lt; Build.VERSION_CODES.M</span><br><span class="line">                &amp;&amp; bp.isRuntime()) &#123;</span><br><span class="line">            <span class="keyword">return</span>;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        SettingBase sb = (SettingBase) pkg.mExtras;</span><br><span class="line">        <span class="keyword">if</span> (sb == <span class="keyword">null</span>) &#123; <span class="comment">//【6】升级包未安装过，异常！</span></span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> IllegalArgumentException(<span class="string">"Unknown package: "</span> + packageName);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">final</span> PermissionsState permissionsState = sb.getPermissionsState();</span><br><span class="line">        <span class="comment">//【7】获得权限的 flags 标志位，如果该权限是被 system fix 的，我们不能撤销这样的权限！</span></span><br><span class="line">        <span class="keyword">final</span> <span class="keyword">int</span> flags = permissionsState.getPermissionFlags(name, userId);</span><br><span class="line">        <span class="keyword">if</span> ((flags &amp; PackageManager.FLAG_PERMISSION_SYSTEM_FIXED) != <span class="number">0</span>) &#123;</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> SecurityException(<span class="string">"Cannot revoke system fixed permission "</span></span><br><span class="line">                    + name + <span class="string">" for package "</span> + packageName);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">//【8】如果该权限是开发者权限，特殊处理，立刻授予！</span></span><br><span class="line">        <span class="comment">// 授予成功，会触发 Settings.writeLPr 方法，该方法会更新多个文件</span></span><br><span class="line">        <span class="comment">// 包括 pacakges.xml，pacakges.list，runtime-permissions.xml 等文件！</span></span><br><span class="line">        <span class="keyword">if</span> (bp.isDevelopment()) &#123;</span><br><span class="line">            <span class="keyword">if</span> (permissionsState.revokeInstallPermission(bp) !=</span><br><span class="line">                    PermissionsState.PERMISSION_OPERATION_FAILURE) &#123;</span><br><span class="line">                scheduleWriteSettingsLocked();</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">return</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">//【9】撤销运行时权限！</span></span><br><span class="line">        <span class="keyword">if</span> (permissionsState.revokeRuntimePermission(bp, userId) ==</span><br><span class="line">                PermissionsState.PERMISSION_OPERATION_FAILURE) &#123;</span><br><span class="line">            <span class="keyword">return</span>;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        mOnPermissionChangeListeners.onPermissionsChanged(pkg.applicationInfo.uid);</span><br><span class="line"></span><br><span class="line">        <span class="comment">//【10】更新 runtime-permissions.xml 文件！</span></span><br><span class="line">        mSettings.writeRuntimePermissionsForUserLPr(userId, <span class="keyword">true</span>);</span><br><span class="line"></span><br><span class="line">        appId = UserHandle.getAppId(pkg.applicationInfo.uid);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    killUid(appId, userId, KILL_APP_REASON_PERMISSIONS_REVOKED); <span class="comment">// 杀掉应用的进程！</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>最后的又进入了 PermissionsState 对象，这个我在 PMS 中有分析过，这里就不在多说了！！</p>
<h1 id="5-Activity-shouldShowRequestPermissionRationale-解释权限含义"><a href="#5-Activity-shouldShowRequestPermissionRationale-解释权限含义" class="headerlink" title="5 Activity.shouldShowRequestPermissionRationale - 解释权限含义"></a>5 Activity.shouldShowRequestPermissionRationale - 解释权限含义</h1><p>为了防止用户因为不理解而拒绝了权限，我们可以在恰当的时间给用户解释为什么申请权限，这里要用到 shouldShowRequestPermissionRationale 方法！</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">boolean</span> <span class="title">shouldShowRequestPermissionRationale</span><span class="params">(@NonNull String permission)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">return</span> getPackageManager().shouldShowRequestPermissionRationale(permission);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>最终会调用 PackageManagerService 中的方法！</p>
<h2 id="5-1-PackageManagerS-shouldShowRequestPermissionRationale"><a href="#5-1-PackageManagerS-shouldShowRequestPermissionRationale" class="headerlink" title="5.1 PackageManagerS.shouldShowRequestPermissionRationale"></a>5.1 PackageManagerS.shouldShowRequestPermissionRationale</h2><p>该方法的返回值决定了是否应该给用户解释权限！</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">boolean</span> <span class="title">shouldShowRequestPermissionRationale</span><span class="params">(String permissionName,</span></span></span><br><span class="line"><span class="function"><span class="params">        String packageName, <span class="keyword">int</span> userId)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">if</span> (UserHandle.getCallingUserId() != userId) &#123;</span><br><span class="line">        mContext.enforceCallingPermission(</span><br><span class="line">                android.Manifest.permission.INTERACT_ACROSS_USERS_FULL,</span><br><span class="line">                <span class="string">"canShowRequestPermissionRationale for user "</span> + userId);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">final</span> <span class="keyword">int</span> uid = getPackageUid(packageName, MATCH_DEBUG_TRIAGED_MISSING, userId);</span><br><span class="line">    <span class="keyword">if</span> (UserHandle.getAppId(getCallingUid()) != UserHandle.getAppId(uid)) &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">false</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">//【1】如果已经拒绝权限，那么就返回 false！</span></span><br><span class="line">    <span class="keyword">if</span> (checkPermission(permissionName, packageName, userId)</span><br><span class="line">            == PackageManager.PERMISSION_GRANTED) &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">false</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">final</span> <span class="keyword">int</span> flags;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">final</span> <span class="keyword">long</span> identity = Binder.clearCallingIdentity();</span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">        <span class="comment">// 获得权限的标志位！</span></span><br><span class="line">        flags = getPermissionFlags(permissionName,</span><br><span class="line">                packageName, userId);</span><br><span class="line">    &#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">        Binder.restoreCallingIdentity(identity);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// fixedFlags 包含了所有的被 fix 的情况！</span></span><br><span class="line">    <span class="keyword">final</span> <span class="keyword">int</span> fixedFlags  = PackageManager.FLAG_PERMISSION_SYSTEM_FIXED</span><br><span class="line">            | PackageManager.FLAG_PERMISSION_POLICY_FIXED</span><br><span class="line">            | PackageManager.FLAG_PERMISSION_USER_FIXED;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//【2】如果该权限被 fix 了，那就返回 false；</span></span><br><span class="line">    <span class="keyword">if</span> ((flags &amp; fixedFlags) != <span class="number">0</span>) &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">false</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">//【3】判断权限是否被 user set，如果被用户 set 了，返回 true！</span></span><br><span class="line">    <span class="keyword">return</span> (flags &amp; PackageManager.FLAG_PERMISSION_USER_SET) != <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>policy fix 和 system fix 这些状态都是系统机制的处理！</p>
<p>我们可以看到：</p>
<ul>
<li>如果用户授予了权限，那么该方法返回的是 false；</li>
<li>如果该权限被 system/policy/user fix 了，即用户拒绝了授权，又点击了不再提醒，那返回的是 false；</li>
<li>如果该权限被 user set 了，即用户拒绝了授权，但是没有点击不再提醒，那么会返回 true；</li>
</ul>
</div></article><div class="post-copyright"><div class="post-copyright__author"><span class="post-copyright-meta">文章作者: </span><span class="post-copyright-info"><a href="mailto:undefined">Coolqi.Li</a></span></div><div class="post-copyright__type"><span class="post-copyright-meta">文章链接: </span><span class="post-copyright-info"><a href="https://lishuaiqi.top/2017/08/13/Permission4-requestPermission/">https://lishuaiqi.top/2017/08/13/Permission4-requestPermission/</a></span></div><div class="post-copyright__notice"><span class="post-copyright-meta">版权声明: </span><span class="post-copyright-info">本博客所有文章除特别声明外，均采用 <a href="https://creativecommons.org/licenses/by-nc-sa/4.0/">CC BY-NC-SA 4.0</a> 许可协议。转载请注明来自 <a href="https://lishuaiqi.top">Coolqi`s Blog</a>！</span></div></div><div class="post-meta__tag-list"><a class="post-meta__tags" href="/tags/Permission权限管理/">Permission权限管理</a></div><div class="post-qr-code"><div class="post-qr-code-item"><img class="post-qr-code__img" src="/img/zfb.jpg"><div class="post-qr-code__desc">支付宝打赏</div></div><div class="post-qr-code-item"><img class="post-qr-code__img" src="/img/wechat.jpg"><div class="post-qr-code__desc">微信打赏</div></div></div><div class="social-share pull-right"></div><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/social-share.js@1.0.16/dist/css/share.min.css"><script src="https://cdn.jsdelivr.net/npm/social-share.js@1.0.16/dist/js/social-share.min.js"></script><nav id="pagination"><div class="prev-post pull-left"><a href="/2017/08/13/AppOps2-AppOpsManager/"><i class="fa fa-chevron-left">  </i><span>AppOps 第 2 篇 - AppOpsManager 分析</span></a></div><div class="next-post pull-right"><a href="/2017/08/03/UsageStats4-usageStatsServiceInteractionWithServiceOrProcess/"><span>UsageStats 第 4 篇 - UsageStatsService 和其他服务和进程的交互</span><i class="fa fa-chevron-right"></i></a></div></nav><div id="gitment-container"></div><script>var gitment = new Gitment({
  id: md5(decodeURI(location.pathname)),
  owner: '',
  repo: '',
  oauth: {
    client_id: '7b4efbcd7027d15749d6',
    client_secret: '14b5d7e8580ee29f7aeca733a25c000795967448'
  }
})
gitment.render('gitment-container')</script></div></div><footer class="footer-bg" style="background-image: url(/img/blog-bg.jpg)"><div class="layout" id="footer"><div class="copyright">&copy;2015 - 2022 By Coolqi.Li</div><div class="framework-info"><span>驱动 - </span><a href="http://hexo.io"><span>Hexo</span></a><span class="footer-separator">|</span><span>主题 - </span><a href="https://github.com/Molunerfinn/hexo-theme-melody"><span>Melody</span></a></div><div class="footer_custom_text">Hi, welcome to my <a href="https://lishuaiqi.top/">blog</a>!</div><div class="busuanzi"><script async src="//busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script><span id="busuanzi_container_page_pv"><i class="fa fa-file-o"></i><span id="busuanzi_value_page_pv"></span><span></span></span></div></div></footer><i class="fa fa-arrow-up" id="go-up" aria-hidden="true"></i><script src="/js/third-party/anime.min.js"></script><script src="/js/third-party/jquery.min.js"></script><script src="/js/third-party/jquery.fancybox.min.js"></script><script src="/js/third-party/velocity.min.js"></script><script src="/js/third-party/velocity.ui.min.js"></script><script src="/js/utils.js?version=1.7.0"></script><script src="/js/fancybox.js?version=1.7.0"></script><script src="/js/sidebar.js?version=1.7.0"></script><script src="/js/copy.js?version=1.7.0"></script><script src="/js/fireworks.js?version=1.7.0"></script><script src="/js/transition.js?version=1.7.0"></script><script src="/js/scroll.js?version=1.7.0"></script><script src="/js/head.js?version=1.7.0"></script><script type="text/x-mathjax-config">MathJax.Hub.Config({
  tex2jax: {
    inlineMath: [ ['$','$'], ["\\(","\\)"]  ],
    processEscapes: true,
    skipTags: ['script', 'noscript', 'style', 'textarea', 'pre', 'code']
  },
  CommonHTML: {
    linebreaks: { automatic: true, width: "90% container" }
  },
  "HTML-CSS": { 
    linebreaks: { automatic: true, width: "90% container" }
  },
  "SVG": { 
    linebreaks: { automatic: true, width: "90% container" }
  }
});
</script><script type="text/x-mathjax-config">MathJax.Hub.Queue(function() {
  var all = MathJax.Hub.getAllJax(), i;
  for (i=0; i < all.length; i += 1) {
    all[i].SourceElement().parentNode.className += ' has-jax';
  }
});
</script><script src="https://cdn.jsdelivr.net/npm/mathjax/MathJax.js?config=TeX-AMS-MML_HTMLorMML"></script><script src="/js/search/local-search.js"></script><script>if(/Android|webOS|iPhone|iPod|iPad|BlackBerry/i.test(navigator.userAgent)) {
  $('#nav').addClass('is-mobile')
  $('footer').addClass('is-mobile')
  $('#top-container').addClass('is-mobile')
}</script><div class="search-dialog" id="local-search"><div class="search-dialog__title" id="local-search-title">本地搜索</div><div id="local-input-panel"><div id="local-search-input"><div class="local-search-box"><input class="local-search-box--input" placeholder="搜索文章"></div></div></div><hr><div id="local-search-results"><div id="local-hits"></div><div id="local-stats"><div class="local-search-stats__hr" id="hr"><span>由</span> <a href="https://github.com/wzpan/hexo-generator-search" style="color:#49B1F5;">hexo-generator-search</a>
 <span>提供支持</span></div></div></div><span class="search-close-button"><i class="fa fa-times"></i></span></div><div class="search-mask"></div></body></html>
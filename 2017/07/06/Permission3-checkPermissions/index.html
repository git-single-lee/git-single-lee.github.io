<!DOCTYPE html><html lang="zh-Hans"><head><meta charset="UTF-8"><meta http-equiv="X-UA-Compatible" content="IE=edge"><meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1"><meta name="description" content="Permission第 3 篇 - checkPermissions 权限检查"><meta name="keywords" content="Permission权限管理"><meta name="author" content="Coolqi.Li,undefined"><meta name="copyright" content="Coolqi.Li"><title>Permission第 3 篇 - checkPermissions 权限检查 | Coolqi`s Blog</title><link rel="shortcut icon" href="/img/favicon.ico"><link rel="stylesheet" href="/css/index.css?version=1.5.6"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/font-awesome@4.7.0/css/font-awesome.min.css?version=1.5.6"><link rel="dns-prefetch" href="https://cdn.staticfile.org"><link rel="dns-prefetch" href="https://cdn.bootcss.com"><link rel="dns-prefetch" href="https://creativecommons.org"><link rel="dns-prefetch" href="https://hm.baidu.com"><script>var _hmt = _hmt || [];
(function() {
  var hm = document.createElement("script");
  hm.src = "https://hm.baidu.com/hm.js?b7acef5306e54116ad8a99e8b753a92d";
  var s = document.getElementsByTagName("script")[0]; 
  s.parentNode.insertBefore(hm, s);
})();</script><script>var GLOBAL_CONFIG = { 
  root: '/',
  algolia: undefined,
  localSearch: {"path":"search.xml","languages":{"hits_empty":"找不到您查询的内容:${query}"}},
  copy: {
    success: '复制成功',
    error: '复制错误',
    noSupport: '浏览器不支持'
  }
} </script></head><body><i class="fa fa-arrow-right" id="toggle-sidebar" aria-hidden="true"></i><div id="sidebar"><div class="toggle-sidebar-info text-center"><span data-toggle="切换文章详情">切换站点概览</span><hr></div><div class="sidebar-toc"><div class="sidebar-toc__title">目录</div><div class="sidebar-toc__progress"><span class="progress-notice">你已经读了</span><span class="progress-num">0</span><span class="progress-percentage">%</span><div class="sidebar-toc__progress-bar"></div></div><div class="sidebar-toc__content"><ol class="toc"><li class="toc-item toc-level-1"><a class="toc-link" href="#0-综述"><span class="toc-text">0 综述</span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#1-Context-权限检查接口-ContextImpl"><span class="toc-text">1 Context 权限检查接口 - ContextImpl</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#1-1-checkCallingPermission"><span class="toc-text">1.1 checkCallingPermission</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#1-2-checkCallingOrSelfPermission"><span class="toc-text">1.2 checkCallingOrSelfPermission</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#1-3-checkPermission"><span class="toc-text">1.3 checkPermission</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#1-4-Check-Uri-Permissions"><span class="toc-text">1.4 Check Uri Permissions</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#1-4-1-checkCallingUriPermission"><span class="toc-text">1.4.1 checkCallingUriPermission</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#1-4-2-checkCallingOrSelfUriPermission"><span class="toc-text">1.4.2 checkCallingOrSelfUriPermission</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#1-4-3-checkUriPermission"><span class="toc-text">1.4.3 checkUriPermission</span></a></li></ol></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#2-框架层权限检查接口-ActivityManagerService"><span class="toc-text">2 框架层权限检查接口 - ActivityManagerService</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#2-1-checkCallingPermission"><span class="toc-text">2.1 checkCallingPermission</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#2-1-1-调用时机"><span class="toc-text">2.1.1 调用时机</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#2-1-1-1-NotificationManagerService-enforcePolicyAccess"><span class="toc-text">2.1.1.1 NotificationManagerService.enforcePolicyAccess</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#2-1-1-2-InputManagerService-addKeyboardLayoutForInputDevice"><span class="toc-text">2.1.1.2 InputManagerService.addKeyboardLayoutForInputDevice</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#2-1-1-3-WindowManagerService-startAppFreezingScreen"><span class="toc-text">2.1.1.3 WindowManagerService.startAppFreezingScreen</span></a></li></ol></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#2-2-checkPermission"><span class="toc-text">2.2 checkPermission</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#2-2-1-调用时机"><span class="toc-text">2.2.1 调用时机</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#2-2-1-1-ActivityManagerService-isGetTasksAllowed"><span class="toc-text">2.2.1.1 ActivityManagerService.isGetTasksAllowed</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#2-2-2-跨进程调用"><span class="toc-text">2.2.2 跨进程调用</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#2-3-checkContentProviderPermissionLocked"><span class="toc-text">2.3 checkContentProviderPermissionLocked</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#2-3-1-调用时机"><span class="toc-text">2.3.1 调用时机</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#2-3-1-1-ActivityManagerService-getContentProviderImpl"><span class="toc-text">2.3.1.1 ActivityManagerService.getContentProviderImpl</span></a></li></ol></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#2-4-checkGrantUriPermission"><span class="toc-text">2.4 checkGrantUriPermission</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#2-4-1-调用时机"><span class="toc-text">2.4.1 调用时机</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#2-4-1-1-Clipboard-setPrimaryClip"><span class="toc-text">2.4.1.1 Clipboard.setPrimaryClip</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#2-4-1-2-VoiceInteractionSessionConnection-deliverSessionDataLocked"><span class="toc-text">2.4.1.2 VoiceInteractionSessionConnection.deliverSessionDataLocked</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#2-4-2-跨进程调用"><span class="toc-text">2.4.2 跨进程调用</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#2-5-checkGrantUriPermissionFromIntentLocked"><span class="toc-text">2.5 checkGrantUriPermissionFromIntentLocked</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#2-5-1-调用时机"><span class="toc-text">2.5.1 调用时机</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#2-5-1-1-ActiveServices-startServiceLocked"><span class="toc-text">2.5.1.1 ActiveServices.startServiceLocked</span></a></li></ol></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#2-6-checkGrantUriPermissionLocked"><span class="toc-text">2.6 checkGrantUriPermissionLocked</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#2-6-1-调用时机"><span class="toc-text">2.6.1 调用时机</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#2-7-checkHoldingPermissionsLocked"><span class="toc-text">2.7 checkHoldingPermissionsLocked</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#2-7-1-调用时机"><span class="toc-text">2.7.1 调用时机</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#2-8-checkHoldingPermissionsInternalLocked"><span class="toc-text">2.8 checkHoldingPermissionsInternalLocked</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#2-8-1-调用时机"><span class="toc-text">2.8.1 调用时机</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#2-9-checkUriPermission"><span class="toc-text">2.9 checkUriPermission</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#2-9-1-调用时机-跨进程"><span class="toc-text">2.9.1 调用时机 - 跨进程</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#2-10-checkUriPermissionLocked"><span class="toc-text">2.10 checkUriPermissionLocked</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#2-10-1-调用时机"><span class="toc-text">2.10.1 调用时机</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#2-11-checkPermissionWithToken"><span class="toc-text">2.11 checkPermissionWithToken</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#2-11-1-跨进程调用"><span class="toc-text">2.11.1 跨进程调用</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#2-12-checkComponentPermission"><span class="toc-text">2.12 checkComponentPermission</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#2-12-1-ActivityM-checkComponentPermission"><span class="toc-text">2.12.1 ActivityM.checkComponentPermission</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#2-12-2-ActivityM-checkUidPermission"><span class="toc-text">2.12.2 ActivityM.checkUidPermission</span></a></li></ol></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#3-权限检查关键接口-PackageManagerService"><span class="toc-text">3 权限检查关键接口 - PackageManagerService</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#3-1-checkUidPermission"><span class="toc-text">3.1 checkUidPermission</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#3-2-checkPermission"><span class="toc-text">3.2 checkPermission</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#3-2-1-调用时机"><span class="toc-text">3.2.1 调用时机</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#3-2-1-1-BroadcastQueue-processNextBroadcast"><span class="toc-text">3.2.1.1 BroadcastQueue.processNextBroadcast</span></a></li></ol></li></ol></li></ol></li></ol></div></div><div class="author-info hide"><div class="author-info__avatar text-center"><img src="/img/avatar.png"></div><div class="author-info__name text-center">Coolqi.Li</div><div class="author-info__description text-center">“你好，我是李帅奇，Android 系统工程师，MineCraft 忠实玩家，设计和绘画爱好者，缺妹纸晚期患者，熬夜星人。”</div><hr><div class="author-info-articles"><a class="author-info-articles__archives article-meta" href="/archives"><span class="pull-left">文章</span><span class="pull-right">73</span></a><a class="author-info-articles__tags article-meta" href="/tags"><span class="pull-left">标签</span><span class="pull-right">16</span></a><a class="author-info-articles__categories article-meta" href="/categories"><span class="pull-left">分类</span><span class="pull-right">18</span></a></div><hr><div class="author-info-links"><div class="author-info-links__title text-center">Links</div><a class="author-info-links__name text-center" href="https://developer.android.google.cn/">AndroidDeveloper</a><a class="author-info-links__name text-center" href="http://www.android-studio.org/">AndroidStudio</a><a class="author-info-links__name text-center" href="https://www.jianshu.com/u/123a20a96441">简书</a><a class="author-info-links__name text-center" href="https://weibo.com/coolqiLi">微博</a></div></div></div><div id="content-outer"><div id="top-container" style="background-image: url(https://ws1.sinaimg.cn/large/8700af19ly1fvpabr30o6j22yo1o0q7i.jpg)"><div id="page-header"><span class="pull-left"> <a id="site-name" href="/">Coolqi`s Blog</a></span><i class="fa fa-bars toggle-menu pull-right" aria-hidden="true"></i><span class="pull-right menus"><a class="site-page social-icon search"><i class="fa fa-search"></i><span> 搜索</span></a><a class="site-page" href="/">Home</a><a class="site-page" href="/categories">Categories</a><a class="site-page" href="/tags">Tags</a><a class="site-page" href="/archives">Archives</a><a class="site-page" href="/about">About</a></span></div><div id="post-info"><div id="post-title">Permission第 3 篇 - checkPermissions 权限检查</div><div id="post-meta"><time class="post-meta__date"><i class="fa fa-calendar" aria-hidden="true"></i> 2017-07-06</time><span class="post-meta__separator">|</span><i class="fa fa-inbox post-meta__icon" aria-hidden="true"></i><a class="post-meta__categories" href="/categories/AndroidFramework源码分析/">AndroidFramework源码分析</a><i class="fa fa-angle-right" aria-hidden="true"></i><i class="fa fa-inbox post-meta__icon" aria-hidden="true"></i><a class="post-meta__categories" href="/categories/AndroidFramework源码分析/Permission权限管理/">Permission权限管理</a><div class="post-meta-wordcount"><span>字数总计: </span><span class="word-count">9.2k</span><span class="post-meta__separator">|</span><span>阅读时长: 43 分钟</span></div></div></div></div><div class="layout" id="content-inner"><article id="post"><div class="article-container" id="post-content"><p>[toc]</p>
<h1 id="0-综述"><a href="#0-综述" class="headerlink" title="0 综述"></a>0 综述</h1><p>基于 Android 7.1.1 源码，分析系统的权限管理机制！</p>
<p>下面来看下系统中的 check permission 相关的接口：</p>
<h1 id="1-Context-权限检查接口-ContextImpl"><a href="#1-Context-权限检查接口-ContextImpl" class="headerlink" title="1 Context 权限检查接口 - ContextImpl"></a>1 Context 权限检查接口 - ContextImpl</h1><p>在应用中申请权限离不开 Context，Context 中暴露了多个检查权限相关的接口，具体的实现是在 ContextImpl 中！</p>
<h2 id="1-1-checkCallingPermission"><a href="#1-1-checkCallingPermission" class="headerlink" title="1.1 checkCallingPermission"></a>1.1 checkCallingPermission</h2><p>检查来自其他进程的调用者的是否有权限，该接口不能用于检查自身是否具有权限！</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">int</span> <span class="title">checkCallingPermission</span><span class="params">(String permission)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">if</span> (permission == <span class="keyword">null</span>) &#123;</span><br><span class="line">        <span class="keyword">throw</span> <span class="keyword">new</span> IllegalArgumentException(<span class="string">"permission is null"</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">int</span> pid = Binder.getCallingPid();</span><br><span class="line">    <span class="keyword">if</span> (pid != Process.myPid()) &#123;</span><br><span class="line">        <span class="comment">//【*1.3】调用自身的 checkPermission 方法！</span></span><br><span class="line">        <span class="keyword">return</span> checkPermission(permission, pid, Binder.getCallingUid());</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> PackageManager.PERMISSION_DENIED;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>应用程序权限检查，最终需要进入框架层！</p>
<h2 id="1-2-checkCallingOrSelfPermission"><a href="#1-2-checkCallingOrSelfPermission" class="headerlink" title="1.2 checkCallingOrSelfPermission"></a>1.2 checkCallingOrSelfPermission</h2><p>该方法和 checkCallingPermission 不同，他还可以检查自身是否具有权限！<br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">int</span> <span class="title">checkCallingOrSelfPermission</span><span class="params">(String permission)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">if</span> (permission == <span class="keyword">null</span>) &#123;</span><br><span class="line">        <span class="keyword">throw</span> <span class="keyword">new</span> IllegalArgumentException(<span class="string">"permission is null"</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">//【*1.3】调用自身的 checkPermission 方法！</span></span><br><span class="line">    <span class="keyword">return</span> checkPermission(permission, Binder.getCallingPid(),</span><br><span class="line">            Binder.getCallingUid());</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<h2 id="1-3-checkPermission"><a href="#1-3-checkPermission" class="headerlink" title="1.3 checkPermission"></a>1.3 checkPermission</h2><ul>
<li><strong>checkPermission[3]</strong></li>
</ul>
<p>该方法需要指定 pid 和 uid：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">int</span> <span class="title">checkPermission</span><span class="params">(String permission, <span class="keyword">int</span> pid, <span class="keyword">int</span> uid)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">if</span> (permission == <span class="keyword">null</span>) &#123;</span><br><span class="line">        <span class="keyword">throw</span> <span class="keyword">new</span> IllegalArgumentException(<span class="string">"permission is null"</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">        <span class="comment">//【*2.2】调用了 ams 的 checkPermission 接口</span></span><br><span class="line">        <span class="keyword">return</span> ActivityManagerNative.getDefault().checkPermission(</span><br><span class="line">                permission, pid, uid);</span><br><span class="line">    &#125; <span class="keyword">catch</span> (RemoteException e) &#123;</span><br><span class="line">        <span class="keyword">return</span> PackageManager.PERMISSION_DENIED;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<ul>
<li><strong>checkPermission[4]</strong></li>
</ul>
<p>还有一个重载函数，需要额外传入一个 callerToken 实例，这里是一个 hide 方法，目前是隐藏的，只能由系统调用：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/** <span class="doctag">@hide</span> */</span></span><br><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">int</span> <span class="title">checkPermission</span><span class="params">(String permission, <span class="keyword">int</span> pid, <span class="keyword">int</span> uid, IBinder callerToken)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">if</span> (permission == <span class="keyword">null</span>) &#123;</span><br><span class="line">        <span class="keyword">throw</span> <span class="keyword">new</span> IllegalArgumentException(<span class="string">"permission is null"</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">        <span class="comment">//【*2.10】调用了 ams 的 checkPermissionWithToken 接口</span></span><br><span class="line">        <span class="keyword">return</span> ActivityManagerNative.getDefault().checkPermissionWithToken(</span><br><span class="line">                permission, pid, uid, callerToken);</span><br><span class="line">    &#125; <span class="keyword">catch</span> (RemoteException e) &#123;</span><br><span class="line">        <span class="keyword">return</span> PackageManager.PERMISSION_DENIED;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h2 id="1-4-Check-Uri-Permissions"><a href="#1-4-Check-Uri-Permissions" class="headerlink" title="1.4 Check Uri Permissions"></a>1.4 Check Uri Permissions</h2><p>ContextImpl 还提供了检查 Uri Permissions 的接口，这些接口依赖于一个 modeFlags 标志位，取值有如下：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">Intent.FLAG_GRANT_READ_URI_PERMISSION</span><br><span class="line">Intent.FLAG_GRANT_WRITE_URI_PERMISSION</span><br></pre></td></tr></table></figure>
<p>下面我们来看下相关的接口的逻辑：</p>
<h3 id="1-4-1-checkCallingUriPermission"><a href="#1-4-1-checkCallingUriPermission" class="headerlink" title="1.4.1 checkCallingUriPermission"></a>1.4.1 checkCallingUriPermission</h3><p>同样的，这个方法只能检查其他进程是否具有访问 uri 权限！</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">int</span> <span class="title">checkCallingUriPermission</span><span class="params">(Uri uri, <span class="keyword">int</span> modeFlags)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">int</span> pid = Binder.getCallingPid();</span><br><span class="line">    <span class="keyword">if</span> (pid != Process.myPid()) &#123;</span><br><span class="line">        <span class="comment">//【*1.4.3】调用 ContextImpl 的 checkUriPermission 方法！</span></span><br><span class="line">        <span class="keyword">return</span> checkUriPermission(uri, pid,</span><br><span class="line">                Binder.getCallingUid(), modeFlags);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> PackageManager.PERMISSION_DENIED;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h3 id="1-4-2-checkCallingOrSelfUriPermission"><a href="#1-4-2-checkCallingOrSelfUriPermission" class="headerlink" title="1.4.2 checkCallingOrSelfUriPermission"></a>1.4.2 checkCallingOrSelfUriPermission</h3><p>同样的，这个方法能检查其他进程或者自身是否具有访问 uri 权限！</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">int</span> <span class="title">checkCallingOrSelfUriPermission</span><span class="params">(Uri uri, <span class="keyword">int</span> modeFlags)</span> </span>&#123;</span><br><span class="line">    <span class="comment">//【*1.4.3】调用 ContextImpl 的 checkUriPermission 方法！</span></span><br><span class="line">    <span class="keyword">return</span> checkUriPermission(uri, Binder.getCallingPid(),</span><br><span class="line">            Binder.getCallingUid(), modeFlags);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h3 id="1-4-3-checkUriPermission"><a href="#1-4-3-checkUriPermission" class="headerlink" title="1.4.3 checkUriPermission"></a>1.4.3 checkUriPermission</h3><p>checkUriPermission 方法一共有三个重载实现：</p>
<ul>
<li><strong>checkUriPermission[6]</strong></li>
</ul>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">int</span> <span class="title">checkUriPermission</span><span class="params">(Uri uri, String readPermission,</span></span></span><br><span class="line"><span class="function"><span class="params">        String writePermission, <span class="keyword">int</span> pid, <span class="keyword">int</span> uid, <span class="keyword">int</span> modeFlags)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">if</span> (DEBUG) &#123;</span><br><span class="line">        Log.i(<span class="string">"foo"</span>, <span class="string">"checkUriPermission: uri="</span> + uri + <span class="string">"readPermission="</span></span><br><span class="line">                + readPermission + <span class="string">" writePermission="</span> + writePermission</span><br><span class="line">                + <span class="string">" pid="</span> + pid + <span class="string">" uid="</span> + uid + <span class="string">" mode"</span> + modeFlags);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">//【1】如果 flags 设置了 FLAG_GRANT_READ_URI_PERMISSION 标志位，那么</span></span><br><span class="line">    <span class="comment">// 如果 readPermission 不为 null，且 pid uid 是有这个 readPermission 权限的；</span></span><br><span class="line">    <span class="comment">// 那就返回 PERMISSION_GRANTED</span></span><br><span class="line">    <span class="keyword">if</span> ((modeFlags &amp; Intent.FLAG_GRANT_READ_URI_PERMISSION) != <span class="number">0</span>) &#123;</span><br><span class="line">        <span class="keyword">if</span> (readPermission == <span class="keyword">null</span></span><br><span class="line">                || checkPermission(readPermission, pid, uid)</span><br><span class="line">                == PackageManager.PERMISSION_GRANTED) &#123;</span><br><span class="line">            <span class="keyword">return</span> PackageManager.PERMISSION_GRANTED;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">//【2】如果 flags 设置了 FLAG_GRANT_WRITE_URI_PERMISSION 标志位，那么</span></span><br><span class="line">    <span class="comment">// 如果 writePermission 不为 null，且 pid uid 是有这个 writePermission 权限的；</span></span><br><span class="line">    <span class="comment">// 那就返回 PERMISSION_GRANTED</span></span><br><span class="line">    <span class="keyword">if</span> ((modeFlags &amp; Intent.FLAG_GRANT_WRITE_URI_PERMISSION) != <span class="number">0</span>) &#123;</span><br><span class="line">        <span class="keyword">if</span> (writePermission == <span class="keyword">null</span></span><br><span class="line">                || checkPermission(writePermission, pid, uid)</span><br><span class="line">                == PackageManager.PERMISSION_GRANTED) &#123;</span><br><span class="line">            <span class="keyword">return</span> PackageManager.PERMISSION_GRANTED;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">//【*self-other】上述条件不满足的话，会进入到这部分中，调用另外一个重载的函数：</span></span><br><span class="line">    <span class="keyword">return</span> uri != <span class="keyword">null</span> ? checkUriPermission(uri, pid, uid, modeFlags)</span><br><span class="line">            : PackageManager.PERMISSION_DENIED;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<ul>
<li><strong>checkUriPermission[4]</strong></li>
</ul>
<p>第二个 checkUriPermission 会被第一个方法调用：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">int</span> <span class="title">checkUriPermission</span><span class="params">(Uri uri, <span class="keyword">int</span> pid, <span class="keyword">int</span> uid, <span class="keyword">int</span> modeFlags)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">        <span class="comment">//【*2.9】调用 ams 的 checkUriPermission 方法！</span></span><br><span class="line">        <span class="keyword">return</span> ActivityManagerNative.getDefault().checkUriPermission(</span><br><span class="line">                ContentProvider.getUriWithoutUserId(uri), pid, uid, modeFlags,</span><br><span class="line">                resolveUserId(uri), <span class="keyword">null</span>);</span><br><span class="line">    &#125; <span class="keyword">catch</span> (RemoteException e) &#123;</span><br><span class="line">        <span class="keyword">return</span> PackageManager.PERMISSION_DENIED;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<ul>
<li><strong>checkUriPermission[5]</strong></li>
</ul>
<p>第三个 checkUriPermission 方法，需要传入一个 IBinder token 对象，这是一个 hide 方法，只能由系统调用！</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/** <span class="doctag">@hide</span> */</span></span><br><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">int</span> <span class="title">checkUriPermission</span><span class="params">(Uri uri, <span class="keyword">int</span> pid, <span class="keyword">int</span> uid, <span class="keyword">int</span> modeFlags, IBinder callerToken)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">        <span class="comment">//【*2.9】调用 ams 的 checkUriPermission 方法！</span></span><br><span class="line">        <span class="keyword">return</span> ActivityManagerNative.getDefault().checkUriPermission(</span><br><span class="line">                ContentProvider.getUriWithoutUserId(uri), pid, uid, modeFlags,</span><br><span class="line">                resolveUserId(uri), callerToken);</span><br><span class="line">    &#125; <span class="keyword">catch</span> (RemoteException e) &#123;</span><br><span class="line">        <span class="keyword">return</span> PackageManager.PERMISSION_DENIED;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h1 id="2-框架层权限检查接口-ActivityManagerService"><a href="#2-框架层权限检查接口-ActivityManagerService" class="headerlink" title="2 框架层权限检查接口 - ActivityManagerService"></a>2 框架层权限检查接口 - ActivityManagerService</h1><p>我们来看看 Android 7.1.1 中框架层提供了那些用于校验权限的接口，这些接口主要位于 ActivityManager，ActivityManagerService 中，我们做一个简单的归类！</p>
<ul>
<li>访问 ContentProvider 的权限校验；</li>
</ul>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="function">String <span class="title">checkContentProviderPermissionLocked</span><span class="params">(ProviderInfo cpi, ProcessRecord r, <span class="keyword">int</span> userId, <span class="keyword">boolean</span> checkUser)</span></span></span><br></pre></td></tr></table></figure>
<ul>
<li>判断 pid，uid 对应的进程是否具有某个权限；</li>
</ul>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"> <span class="comment">// 检测调用者的权限，第一个方法会调用第二个方法！</span></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">checkCallingPermission</span><span class="params">(String permission)</span> </span>&#123;...&#125;</span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">checkPermission</span><span class="params">(String permission, <span class="keyword">int</span> pid, <span class="keyword">int</span> uid)</span> </span>&#123;...&#125;</span><br></pre></td></tr></table></figure>
<ul>
<li>检测组件的权限；</li>
</ul>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"> <span class="comment">// 检测组件的权限</span></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">checkComponentPermission</span><span class="params">(String permission, <span class="keyword">int</span> pid, <span class="keyword">int</span> uid, <span class="keyword">int</span> owningUid, <span class="keyword">boolean</span> exported)</span>  </span>&#123;...&#125;</span><br></pre></td></tr></table></figure>
<ul>
<li>检测 Uri 相关的权限；</li>
</ul>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">checkGrantUriPermission</span><span class="params">(<span class="keyword">int</span> callingUid, String targetPkg, Uri uri, </span></span></span><br><span class="line"><span class="function"><span class="params">                                                    <span class="keyword">final</span> <span class="keyword">int</span> modeFlags, <span class="keyword">int</span> userId)</span>  </span>&#123;...&#125;</span><br><span class="line"></span><br><span class="line"><span class="function">NeededUriGrants <span class="title">checkGrantUriPermissionFromIntentLocked</span><span class="params">(<span class="keyword">int</span> callingUid, String targetPkg, Intent intent,</span></span></span><br><span class="line"><span class="function"><span class="params">                                                    <span class="keyword">int</span> mode, NeededUriGrants needed, <span class="keyword">int</span> targetUserId)</span>  </span>&#123;...&#125;</span><br><span class="line">            </span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">checkGrantUriPermissionLocked</span><span class="params">(<span class="keyword">int</span> callingUid, String targetPkg, GrantUri grantUri, </span></span></span><br><span class="line"><span class="function"><span class="params">                                                    <span class="keyword">final</span> <span class="keyword">int</span> modeFlags, <span class="keyword">int</span> lastTargetUid)</span>  </span>&#123;...&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">checkUriPermission</span><span class="params">(Uri uri, <span class="keyword">int</span> pid, <span class="keyword">int</span> uid, <span class="keyword">final</span> <span class="keyword">int</span> modeFlags, <span class="keyword">int</span> userId, IBinder callerToken)</span> </span>&#123;...&#125;</span><br><span class="line">            </span><br><span class="line"><span class="function"><span class="keyword">boolean</span> <span class="title">checkUriPermissionLocked</span><span class="params">(GrantUri grantUri, <span class="keyword">int</span> uid, <span class="keyword">final</span> <span class="keyword">int</span> modeFlags)</span> </span>&#123;...&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">boolean</span> <span class="title">checkHoldingPermissionsLocked</span><span class="params">(IPackageManager pm, ProviderInfo pi, GrantUri grantUri,</span></span></span><br><span class="line"><span class="function"><span class="params">                                                                    <span class="keyword">int</span> uid, <span class="keyword">final</span> <span class="keyword">int</span> modeFlags)</span>  </span>&#123;...&#125;</span><br><span class="line">                                </span><br><span class="line"><span class="function"><span class="keyword">boolean</span> <span class="title">checkHoldingPermissionsInternalLocked</span><span class="params">(IPackageManager pm, ProviderInfo pi, GrantUri grantUri,</span></span></span><br><span class="line"><span class="function"><span class="params">                                        <span class="keyword">int</span> uid, <span class="keyword">final</span> <span class="keyword">int</span> modeFlags, <span class="keyword">boolean</span> considerUidPermissions)</span>  </span>&#123;...&#125;</span><br></pre></td></tr></table></figure>
<ul>
<li>检测 Binder 对象的权限；</li>
</ul>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">checkPermissionWithToken</span><span class="params">(String permission, <span class="keyword">int</span> pid, <span class="keyword">int</span> uid, IBinder callerToken)</span>  </span>&#123;...&#125;</span><br></pre></td></tr></table></figure>
<p>同时，系统也提供了一些强制检查权限的接口，以 enforce 开头，我们在很多的系统调用过程中都会看到，这些接口会调用上面的接口来查询权限是否授予，没有授予会抛出异常，这里就不再列举！</p>
<h2 id="2-1-checkCallingPermission"><a href="#2-1-checkCallingPermission" class="headerlink" title="2.1 checkCallingPermission"></a>2.1 checkCallingPermission</h2><p>该方法用于判断调用者是否具有指定的权限，内部会自动通过 Binder 相关接口获得调用者的 pid 和 uid！！<br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">checkCallingPermission</span><span class="params">(String permission)</span> </span>&#123;</span><br><span class="line">    <span class="comment">//【*2.2】这里调用了 checkPermission 方法！</span></span><br><span class="line">    <span class="keyword">return</span> checkPermission(permission,</span><br><span class="line">            Binder.getCallingPid(),</span><br><span class="line">            UserHandle.getAppId(Binder.getCallingUid()));</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>该方法内部会通过 Binder.getCallingPid() 和 Binder.getCallingUid() 方法，计算 pid 和 uid！</p>
<h3 id="2-1-1-调用时机"><a href="#2-1-1-调用时机" class="headerlink" title="2.1.1 调用时机"></a>2.1.1 调用时机</h3><p>checkCallingPermission 方法系统中调用的很多，一些重要服务都会调用它来检查权限，比如 InputManagerService，WindowManagerService，NotificationManagerService，DisplayManagerService 等等，下面只简单列出来几个：</p>
<h4 id="2-1-1-1-NotificationManagerService-enforcePolicyAccess"><a href="#2-1-1-1-NotificationManagerService-enforcePolicyAccess" class="headerlink" title="2.1.1.1 NotificationManagerService.enforcePolicyAccess"></a>2.1.1.1 NotificationManagerService.enforcePolicyAccess</h4><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">enforcePolicyAccess</span><span class="params">(String pkg, String method)</span> </span>&#123;</span><br><span class="line">    <span class="comment">//【1】检查调用者是否有 MANAGE_NOTIFICATIONS 权限</span></span><br><span class="line">    <span class="keyword">if</span> (PackageManager.PERMISSION_GRANTED == getContext().checkCallingPermission(</span><br><span class="line">            android.Manifest.permission.MANAGE_NOTIFICATIONS)) &#123;</span><br><span class="line">        <span class="keyword">return</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    checkCallerIsSameApp(pkg);</span><br><span class="line">    <span class="keyword">if</span> (!checkPolicyAccess(pkg)) &#123;</span><br><span class="line">        Slog.w(TAG, <span class="string">"Notification policy access denied calling "</span> + method);</span><br><span class="line">        <span class="keyword">throw</span> <span class="keyword">new</span> SecurityException(<span class="string">"Notification policy access denied"</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>NotificationManagerService 有很多方法设计到了权限校验，这里只是举例展示。</p>
<h4 id="2-1-1-2-InputManagerService-addKeyboardLayoutForInputDevice"><a href="#2-1-1-2-InputManagerService-addKeyboardLayoutForInputDevice" class="headerlink" title="2.1.1.2 InputManagerService.addKeyboardLayoutForInputDevice"></a>2.1.1.2 InputManagerService.addKeyboardLayoutForInputDevice</h4><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Override</span> <span class="comment">// Binder call</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">addKeyboardLayoutForInputDevice</span><span class="params">(InputDeviceIdentifier identifier,</span></span></span><br><span class="line"><span class="function"><span class="params">        String keyboardLayoutDescriptor)</span> </span>&#123;</span><br><span class="line">    <span class="comment">//【1】检查调用者是否有 SET_KEYBOARD_LAYOUT 权限</span></span><br><span class="line">    <span class="keyword">if</span> (!checkCallingPermission(android.Manifest.permission.SET_KEYBOARD_LAYOUT,</span><br><span class="line">            <span class="string">"addKeyboardLayoutForInputDevice()"</span>)) &#123;</span><br><span class="line">        <span class="keyword">throw</span> <span class="keyword">new</span> SecurityException(<span class="string">"Requires SET_KEYBOARD_LAYOUT permission"</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    ... ... ... ...</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>InputManagerService 有很多方法设计到了权限校验，这里只是举例展示。</p>
<h4 id="2-1-1-3-WindowManagerService-startAppFreezingScreen"><a href="#2-1-1-3-WindowManagerService-startAppFreezingScreen" class="headerlink" title="2.1.1.3 WindowManagerService.startAppFreezingScreen"></a>2.1.1.3 WindowManagerService.startAppFreezingScreen</h4><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">startAppFreezingScreen</span><span class="params">(IBinder token, <span class="keyword">int</span> configChanges)</span> </span>&#123;</span><br><span class="line">    <span class="comment">//【1】检查调用者是否有 MANAGE_APP_TOKENS 权限</span></span><br><span class="line">    <span class="keyword">if</span> (!checkCallingPermission(android.Manifest.permission.MANAGE_APP_TOKENS,</span><br><span class="line">            <span class="string">"setAppFreezingScreen()"</span>)) &#123;</span><br><span class="line">        <span class="keyword">throw</span> <span class="keyword">new</span> SecurityException(<span class="string">"Requires MANAGE_APP_TOKENS permission"</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">synchronized</span>(mWindowMap) &#123;</span><br><span class="line">        <span class="keyword">if</span> (configChanges == <span class="number">0</span> &amp;&amp; okToDisplay()) &#123;</span><br><span class="line">            <span class="keyword">if</span> (DEBUG_ORIENTATION) Slog.v(TAG_WM, <span class="string">"Skipping set freeze of "</span> + token);</span><br><span class="line">            <span class="keyword">return</span>;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        AppWindowToken wtoken = findAppWindowToken(token);</span><br><span class="line">        <span class="keyword">if</span> (wtoken == <span class="keyword">null</span> || wtoken.appToken == <span class="keyword">null</span>) &#123;</span><br><span class="line">            Slog.w(TAG_WM, <span class="string">"Attempted to freeze screen with non-existing app token: "</span> + wtoken);</span><br><span class="line">            <span class="keyword">return</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">final</span> <span class="keyword">long</span> origId = Binder.clearCallingIdentity();</span><br><span class="line">        startAppFreezingScreenLocked(wtoken);</span><br><span class="line">        Binder.restoreCallingIdentity(origId);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>WindowManagerService 有很多方法设计到了权限校验，这里只是举例展示。</p>
<h2 id="2-2-checkPermission"><a href="#2-2-checkPermission" class="headerlink" title="2.2 checkPermission"></a>2.2 checkPermission</h2><p>该方法用于判断 pid uid 是否有具体的权限，调用这个方法必须要知道对应的 pid 和 uid：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">int</span> <span class="title">checkPermission</span><span class="params">(String permission, <span class="keyword">int</span> pid, <span class="keyword">int</span> uid)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">if</span> (permission == <span class="keyword">null</span>) &#123;</span><br><span class="line">        <span class="keyword">return</span> PackageManager.PERMISSION_DENIED;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">//【*2.12】调用了 checkComponentPermission 方法！</span></span><br><span class="line">    <span class="keyword">return</span> checkComponentPermission(permission, pid, uid, -<span class="number">1</span>, <span class="keyword">true</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h3 id="2-2-1-调用时机"><a href="#2-2-1-调用时机" class="headerlink" title="2.2.1 调用时机"></a>2.2.1 调用时机</h3><p>checkPermission 方法的调用也很多，所以简单的看几个：</p>
<h4 id="2-2-1-1-ActivityManagerService-isGetTasksAllowed"><a href="#2-2-1-1-ActivityManagerService-isGetTasksAllowed" class="headerlink" title="2.2.1.1 ActivityManagerService.isGetTasksAllowed"></a>2.2.1.1 ActivityManagerService.isGetTasksAllowed</h4><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">boolean</span> <span class="title">isGetTasksAllowed</span><span class="params">(String caller, <span class="keyword">int</span> callingPid, <span class="keyword">int</span> callingUid)</span> </span>&#123;</span><br><span class="line">    <span class="comment">//【1】检查调用者是否具有 REAL_GET_TASKS 和 GET_TASKS 权限！</span></span><br><span class="line">    <span class="keyword">boolean</span> allowed = checkPermission(android.Manifest.permission.REAL_GET_TASKS,</span><br><span class="line">            callingPid, callingUid) == PackageManager.PERMISSION_GRANTED;</span><br><span class="line">    <span class="keyword">if</span> (!allowed) &#123;</span><br><span class="line">        <span class="keyword">if</span> (checkPermission(android.Manifest.permission.GET_TASKS,</span><br><span class="line">                callingPid, callingUid) == PackageManager.PERMISSION_GRANTED) &#123;</span><br><span class="line">            <span class="keyword">try</span> &#123;</span><br><span class="line">                <span class="keyword">if</span> (AppGlobals.getPackageManager().isUidPrivileged(callingUid)) &#123;</span><br><span class="line">                    allowed = <span class="keyword">true</span>;</span><br><span class="line">                    <span class="keyword">if</span> (DEBUG_TASKS) Slog.w(TAG, caller + <span class="string">": caller "</span> + callingUid</span><br><span class="line">                            + <span class="string">" is using old GET_TASKS but privileged; allowing"</span>);</span><br><span class="line">                &#125;</span><br><span class="line">            &#125; <span class="keyword">catch</span> (RemoteException e) &#123;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span> (!allowed) &#123;</span><br><span class="line">        <span class="keyword">if</span> (DEBUG_TASKS) Slog.w(TAG, caller + <span class="string">": caller "</span> + callingUid</span><br><span class="line">                + <span class="string">" does not hold REAL_GET_TASKS; limiting output"</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> allowed;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h3 id="2-2-2-跨进程调用"><a href="#2-2-2-跨进程调用" class="headerlink" title="2.2.2 跨进程调用"></a>2.2.2 跨进程调用</h3><p>调用方法：<br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">try</span> &#123;</span><br><span class="line">    ActivityManagerNative.getDefault().checkPermission(...);</span><br><span class="line">&#125; <span class="keyword">catch</span> (RemoteException e) &#123;</span><br><span class="line">    <span class="keyword">throw</span> e.rethrowFromSystemServer();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>具体流程：</p>
<ul>
<li><strong>ActivityManagerProxy</strong></li>
</ul>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">int</span> <span class="title">checkPermission</span><span class="params">(String permission, <span class="keyword">int</span> pid, <span class="keyword">int</span> uid)</span></span></span><br><span class="line"><span class="function">        <span class="keyword">throws</span> RemoteException </span>&#123;</span><br><span class="line">    Parcel data = Parcel.obtain();</span><br><span class="line">    Parcel reply = Parcel.obtain();</span><br><span class="line">    data.writeInterfaceToken(IActivityManager.descriptor);</span><br><span class="line">    data.writeString(permission);</span><br><span class="line">    data.writeInt(pid);</span><br><span class="line">    data.writeInt(uid);</span><br><span class="line">    mRemote.transact(CHECK_PERMISSION_TRANSACTION, data, reply, <span class="number">0</span>);</span><br><span class="line">    reply.readException();</span><br><span class="line">    <span class="keyword">int</span> res = reply.readInt();</span><br><span class="line">    data.recycle();</span><br><span class="line">    reply.recycle();</span><br><span class="line">    <span class="keyword">return</span> res;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<ul>
<li><strong>ActivityManagerNative</strong></li>
</ul>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">case</span> CHECK_PERMISSION_TRANSACTION: &#123;</span><br><span class="line">    data.enforceInterface(IActivityManager.descriptor);</span><br><span class="line">    String perm = data.readString();</span><br><span class="line">    <span class="keyword">int</span> pid = data.readInt();</span><br><span class="line">    <span class="keyword">int</span> uid = data.readInt();</span><br><span class="line">    <span class="keyword">int</span> res = checkPermission(perm, pid, uid);</span><br><span class="line">    reply.writeNoException();</span><br><span class="line">    reply.writeInt(res);</span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">true</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h2 id="2-3-checkContentProviderPermissionLocked"><a href="#2-3-checkContentProviderPermissionLocked" class="headerlink" title="2.3 checkContentProviderPermissionLocked"></a>2.3 checkContentProviderPermissionLocked</h2><p>checkContentProviderPermissionLocked 方法用于判断：</p>
<ul>
<li>进程 ProcessRecord 是否可以访问目标 ContentProvider 对象，该方法返回 null 表示该进程是有这个权限的！</li>
</ul>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">final</span> String <span class="title">checkContentProviderPermissionLocked</span><span class="params">(</span></span></span><br><span class="line"><span class="function"><span class="params">        ProviderInfo cpi, ProcessRecord r, <span class="keyword">int</span> userId, <span class="keyword">boolean</span> checkUser)</span> </span>&#123;</span><br><span class="line">    <span class="comment">//【1】获得进程的 pid 和 uid！</span></span><br><span class="line">    <span class="keyword">final</span> <span class="keyword">int</span> callingPid = (r != <span class="keyword">null</span>) ? r.pid : Binder.getCallingPid();</span><br><span class="line">    <span class="keyword">final</span> <span class="keyword">int</span> callingUid = (r != <span class="keyword">null</span>) ? r.uid : Binder.getCallingUid();</span><br><span class="line">    <span class="keyword">boolean</span> checkedGrants = <span class="keyword">false</span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//【2】如果 checkUser 为 true 的话，会进入下面的分支，检查 userId</span></span><br><span class="line">    <span class="keyword">if</span> (checkUser) &#123;</span><br><span class="line">        <span class="comment">// Looking for cross-user grants before enforcing the typical cross-users permissions</span></span><br><span class="line">        <span class="keyword">int</span> tmpTargetUserId = mUserController.unsafeConvertIncomingUserLocked(userId);</span><br><span class="line">        <span class="keyword">if</span> (tmpTargetUserId != UserHandle.getUserId(callingUid)) &#123;</span><br><span class="line">            <span class="keyword">if</span> (checkAuthorityGrants(callingUid, cpi, tmpTargetUserId, checkUser)) &#123;</span><br><span class="line">                <span class="keyword">return</span> <span class="keyword">null</span>;</span><br><span class="line">            &#125;</span><br><span class="line">            checkedGrants = <span class="keyword">true</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        userId = mUserController.handleIncomingUser(callingPid, callingUid, userId, <span class="keyword">false</span>,</span><br><span class="line">                ALLOW_NON_FULL, <span class="string">"checkContentProviderPermissionLocked "</span> + cpi.authority, <span class="keyword">null</span>);</span><br><span class="line">        <span class="keyword">if</span> (userId != tmpTargetUserId) &#123;</span><br><span class="line">            <span class="comment">// When we actually went to determine the final targer user ID, this ended</span></span><br><span class="line">            <span class="comment">// up different than our initial check for the authority.  This is because</span></span><br><span class="line">            <span class="comment">// they had asked for USER_CURRENT_OR_SELF and we ended up switching to</span></span><br><span class="line">            <span class="comment">// SELF.  So we need to re-check the grants again.</span></span><br><span class="line">            checkedGrants = <span class="keyword">false</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">//【*2.12】检查访问进程是否具有读权限！</span></span><br><span class="line">    <span class="keyword">if</span> (checkComponentPermission(cpi.readPermission, callingPid, callingUid,</span><br><span class="line">            cpi.applicationInfo.uid, cpi.exported)</span><br><span class="line">            == PackageManager.PERMISSION_GRANTED) &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">null</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">//【*2.12】检查访问进程是否具有写权限！</span></span><br><span class="line">    <span class="keyword">if</span> (checkComponentPermission(cpi.writePermission, callingPid, callingUid,</span><br><span class="line">            cpi.applicationInfo.uid, cpi.exported)</span><br><span class="line">            == PackageManager.PERMISSION_GRANTED) &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">null</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">//【3】检查访问进程是否具有 pathPermissions，每个 path 都可以指定 read 和 write 权限！</span></span><br><span class="line">    PathPermission[] pps = cpi.pathPermissions;</span><br><span class="line">    <span class="keyword">if</span> (pps != <span class="keyword">null</span>) &#123;</span><br><span class="line">        <span class="keyword">int</span> i = pps.length;</span><br><span class="line">        <span class="keyword">while</span> (i &gt; <span class="number">0</span>) &#123;</span><br><span class="line">            i--;</span><br><span class="line">            PathPermission pp = pps[i];</span><br><span class="line">            <span class="comment">//【*2.12】检查访问进程是否具有 path 读权限！</span></span><br><span class="line">            String pprperm = pp.getReadPermission();</span><br><span class="line">            <span class="keyword">if</span> (pprperm != <span class="keyword">null</span> &amp;&amp; checkComponentPermission(pprperm, callingPid, callingUid,</span><br><span class="line">                    cpi.applicationInfo.uid, cpi.exported)</span><br><span class="line">                    == PackageManager.PERMISSION_GRANTED) &#123;</span><br><span class="line">                <span class="keyword">return</span> <span class="keyword">null</span>;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="comment">//【*2.12】检查访问进程是否具有 path 写权限！</span></span><br><span class="line">            String ppwperm = pp.getWritePermission();</span><br><span class="line">            <span class="keyword">if</span> (ppwperm != <span class="keyword">null</span> &amp;&amp; checkComponentPermission(ppwperm, callingPid, callingUid,</span><br><span class="line">                    cpi.applicationInfo.uid, cpi.exported)</span><br><span class="line">                    == PackageManager.PERMISSION_GRANTED) &#123;</span><br><span class="line">                <span class="keyword">return</span> <span class="keyword">null</span>;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span> (!checkedGrants &amp;&amp; checkAuthorityGrants(callingUid, cpi, userId, checkUser)) &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">null</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    String msg;</span><br><span class="line">    <span class="comment">//【4】最后校验该 ContentProvider 是否是 exported 的！</span></span><br><span class="line">    <span class="keyword">if</span> (!cpi.exported) &#123;</span><br><span class="line">        msg = <span class="string">"Permission Denial: opening provider "</span> + cpi.name</span><br><span class="line">                + <span class="string">" from "</span> + (r != <span class="keyword">null</span> ? r : <span class="string">"(null)"</span>) + <span class="string">" (pid="</span> + callingPid</span><br><span class="line">                + <span class="string">", uid="</span> + callingUid + <span class="string">") that is not exported from uid "</span></span><br><span class="line">                + cpi.applicationInfo.uid;</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        msg = <span class="string">"Permission Denial: opening provider "</span> + cpi.name</span><br><span class="line">                + <span class="string">" from "</span> + (r != <span class="keyword">null</span> ? r : <span class="string">"(null)"</span>) + <span class="string">" (pid="</span> + callingPid</span><br><span class="line">                + <span class="string">", uid="</span> + callingUid + <span class="string">") requires "</span></span><br><span class="line">                + cpi.readPermission + <span class="string">" or "</span> + cpi.writePermission;</span><br><span class="line">    &#125;</span><br><span class="line">    Slog.w(TAG, msg);</span><br><span class="line">    <span class="keyword">return</span> msg;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>我们看到了这里调用了 checkComponentPermission 方法，判断访问者对该 ContentProvider 是否具有读或写的权限！</p>
<h3 id="2-3-1-调用时机"><a href="#2-3-1-调用时机" class="headerlink" title="2.3.1 调用时机"></a>2.3.1 调用时机</h3><h4 id="2-3-1-1-ActivityManagerService-getContentProviderImpl"><a href="#2-3-1-1-ActivityManagerService-getContentProviderImpl" class="headerlink" title="2.3.1.1 ActivityManagerService.getContentProviderImpl"></a>2.3.1.1 ActivityManagerService.getContentProviderImpl</h4><p>该方法主要是在访问 provider 的时候做权限校验的，调用的方法在 getContentProviderImpl 方法;</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">private</span> ContentProviderHolder <span class="title">getContentProviderImpl</span><span class="params">(IApplicationThread caller,</span></span></span><br><span class="line"><span class="function"><span class="params">        String name, IBinder token, <span class="keyword">boolean</span> stable, <span class="keyword">int</span> userId)</span> </span>&#123;</span><br><span class="line">    ContentProviderRecord cpr;</span><br><span class="line">    ContentProviderConnection conn = <span class="keyword">null</span>;</span><br><span class="line">    ProviderInfo cpi = <span class="keyword">null</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">synchronized</span>(<span class="keyword">this</span>) &#123;</span><br><span class="line">        ... ... ...</span><br><span class="line">        <span class="keyword">boolean</span> providerRunning = cpr != <span class="keyword">null</span> &amp;&amp; cpr.proc != <span class="keyword">null</span> &amp;&amp; !cpr.proc.killed;</span><br><span class="line">        <span class="keyword">if</span> (providerRunning) &#123;</span><br><span class="line">            cpi = cpr.info;</span><br><span class="line">            String msg;</span><br><span class="line">            checkTime(startTime, <span class="string">"getContentProviderImpl: before checkContentProviderPermission"</span>);</span><br><span class="line">            <span class="comment">//【*2.3】校验是否有访问 provider 的权限；</span></span><br><span class="line">            <span class="keyword">if</span> ((msg = checkContentProviderPermissionLocked(cpi, r, userId, checkCrossUser))</span><br><span class="line">                    != <span class="keyword">null</span>) &#123;</span><br><span class="line">                <span class="keyword">throw</span> <span class="keyword">new</span> SecurityException(msg);</span><br><span class="line">            &#125;</span><br><span class="line">            checkTime(startTime, <span class="string">"getContentProviderImpl: after checkContentProviderPermission"</span>);</span><br><span class="line">            ... ... ... ...</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (!providerRunning) &#123;</span><br><span class="line">            ... ... ... ...</span><br><span class="line">            String msg;</span><br><span class="line">            checkTime(startTime, <span class="string">"getContentProviderImpl: before checkContentProviderPermission"</span>);</span><br><span class="line">            <span class="comment">//【*2.3】同上；</span></span><br><span class="line">            <span class="keyword">if</span> ((msg = checkContentProviderPermissionLocked(cpi, r, userId, !singleton))</span><br><span class="line">                    != <span class="keyword">null</span>) &#123;</span><br><span class="line">                <span class="keyword">throw</span> <span class="keyword">new</span> SecurityException(msg);</span><br><span class="line">            &#125;</span><br><span class="line">            checkTime(startTime, <span class="string">"getContentProviderImpl: after checkContentProviderPermission"</span>);</span><br><span class="line">            ... ... ... ...</span><br><span class="line">        &#125;</span><br><span class="line">        checkTime(startTime, <span class="string">"getContentProviderImpl: done!"</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    ... ... ... ...</span><br><span class="line">    <span class="keyword">return</span> cpr != <span class="keyword">null</span> ? cpr.newHolder(conn) : <span class="keyword">null</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>getContentProviderImpl 方法我就不多说了，之前分析总结过！</p>
<h2 id="2-4-checkGrantUriPermission"><a href="#2-4-checkGrantUriPermission" class="headerlink" title="2.4 checkGrantUriPermission"></a>2.4 checkGrantUriPermission</h2><p>判断 callingUid 是否能够授予 targetPkg 访问 uri 的权限，modeFlags 指定了访问模式！</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">int</span> <span class="title">checkGrantUriPermission</span><span class="params">(<span class="keyword">int</span> callingUid, String targetPkg, Uri uri,</span></span></span><br><span class="line"><span class="function"><span class="params">        <span class="keyword">final</span> <span class="keyword">int</span> modeFlags, <span class="keyword">int</span> userId)</span> </span>&#123;</span><br><span class="line">    enforceNotIsolatedCaller(<span class="string">"checkGrantUriPermission"</span>);</span><br><span class="line">    <span class="keyword">synchronized</span>(<span class="keyword">this</span>) &#123;</span><br><span class="line">        <span class="comment">//【*2.6】这里调用了 checkGrantUriPermissionLocked 方法！</span></span><br><span class="line">        <span class="keyword">return</span> checkGrantUriPermissionLocked(callingUid, targetPkg,</span><br><span class="line">                <span class="keyword">new</span> GrantUri(userId, uri, <span class="keyword">false</span>), modeFlags, -<span class="number">1</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>该方法会对参数做一个简单的封装，然后调用 checkGrantUriPermissionLocked 继续处理！</p>
<h3 id="2-4-1-调用时机"><a href="#2-4-1-调用时机" class="headerlink" title="2.4.1 调用时机"></a>2.4.1 调用时机</h3><h4 id="2-4-1-1-Clipboard-setPrimaryClip"><a href="#2-4-1-1-Clipboard-setPrimaryClip" class="headerlink" title="2.4.1.1 Clipboard.setPrimaryClip"></a>2.4.1.1 Clipboard.setPrimaryClip</h4><p>这里我们通过一个简单的例子来看下这个方法的使用，Android 系统有一个 Clipboard，当我们机型拷贝的时候会调用其 setPrimaryClip 方法：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">setPrimaryClip</span><span class="params">(ClipData clip, String callingPackage)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">synchronized</span> (<span class="keyword">this</span>) &#123;</span><br><span class="line">        <span class="keyword">if</span> (clip != <span class="keyword">null</span> &amp;&amp; clip.getItemCount() &lt;= <span class="number">0</span>) &#123;</span><br><span class="line">           <span class="keyword">throw</span> <span class="keyword">new</span> IllegalArgumentException(<span class="string">"No items"</span>);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">final</span> <span class="keyword">int</span> callingUid = Binder.getCallingUid();</span><br><span class="line">        <span class="comment">//【1】当然这边是对调用者是否有 write clipboard 的 op 操作进行检查和记录！</span></span><br><span class="line">        <span class="keyword">if</span> (mAppOps.noteOp(AppOpsManager.OP_WRITE_CLIPBOARD, callingUid,</span><br><span class="line">                callingPackage) != AppOpsManager.MODE_ALLOWED) &#123;</span><br><span class="line">            <span class="keyword">return</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">//【2】检查调用者是否是 data 的所有者！</span></span><br><span class="line">        checkDataOwnerLocked(clip, callingUid);</span><br><span class="line">        ... ... ...</span><br></pre></td></tr></table></figure>
<p>调用了 checkDataOwnerLocked 方法：<br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">final</span> <span class="keyword">void</span> <span class="title">checkDataOwnerLocked</span><span class="params">(ClipData data, <span class="keyword">int</span> uid)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">final</span> <span class="keyword">int</span> N = data.getItemCount();</span><br><span class="line">    <span class="keyword">for</span> (<span class="keyword">int</span> i=<span class="number">0</span>; i&lt;N; i++) &#123;</span><br><span class="line">        <span class="comment">//【1】对所有的 data 进行检查！ </span></span><br><span class="line">        checkItemOwnerLocked(data.getItemAt(i), uid);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>调用了 checkItemOwnerLocked 方法：<br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">final</span> <span class="keyword">void</span> <span class="title">checkUriOwnerLocked</span><span class="params">(Uri uri, <span class="keyword">int</span> uid)</span> </span>&#123;</span><br><span class="line">    <span class="comment">//【1】如果 uri 的 scheme 不是 content 的话，不会检查；</span></span><br><span class="line">    <span class="keyword">if</span> (!<span class="string">"content"</span>.equals(uri.getScheme())) &#123;</span><br><span class="line">        <span class="keyword">return</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">long</span> ident = Binder.clearCallingIdentity();</span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">        <span class="comment">//【2】校验下 uid 是否有权限访问 uri！</span></span><br><span class="line">        mAm.checkGrantUriPermission(uid, <span class="keyword">null</span>, ContentProvider.getUriWithoutUserId(uri),</span><br><span class="line">                Intent.FLAG_GRANT_READ_URI_PERMISSION,</span><br><span class="line">                ContentProvider.getUserIdFromUri(uri, UserHandle.getUserId(uid)));</span><br><span class="line">    &#125; <span class="keyword">catch</span> (RemoteException e) &#123;</span><br><span class="line">    &#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">        Binder.restoreCallingIdentity(ident);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>这个调用流程很清晰！</p>
<h4 id="2-4-1-2-VoiceInteractionSessionConnection-deliverSessionDataLocked"><a href="#2-4-1-2-VoiceInteractionSessionConnection-deliverSessionDataLocked" class="headerlink" title="2.4.1.2 VoiceInteractionSessionConnection.deliverSessionDataLocked"></a>2.4.1.2 VoiceInteractionSessionConnection.deliverSessionDataLocked</h4><p>还有一个是语音识别服务，需要传递数据的时候：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">deliverSessionDataLocked</span><span class="params">(AssistDataForActivity assistDataForActivity)</span> </span>&#123;</span><br><span class="line">    Bundle assistData = assistDataForActivity.data.getBundle(</span><br><span class="line">            VoiceInteractionSession.KEY_DATA);</span><br><span class="line">    AssistStructure structure = assistDataForActivity.data.getParcelable(</span><br><span class="line">            VoiceInteractionSession.KEY_STRUCTURE);</span><br><span class="line">    AssistContent content = assistDataForActivity.data.getParcelable(</span><br><span class="line">            VoiceInteractionSession.KEY_CONTENT);</span><br><span class="line">    <span class="comment">//【1】获得目标 uid！</span></span><br><span class="line">    <span class="keyword">int</span> uid = assistDataForActivity.data.getInt(Intent.EXTRA_ASSIST_UID, -<span class="number">1</span>);</span><br><span class="line">    <span class="keyword">if</span> (uid &gt;= <span class="number">0</span> &amp;&amp; content != <span class="keyword">null</span>) &#123;</span><br><span class="line">        <span class="comment">//【1.1】获得要传递的 intent，遍历处理内部的 ClipData 数据！</span></span><br><span class="line">        Intent intent = content.getIntent();</span><br><span class="line">        <span class="keyword">if</span> (intent != <span class="keyword">null</span>) &#123;</span><br><span class="line">            ClipData data = intent.getClipData();</span><br><span class="line">            <span class="keyword">if</span> (data != <span class="keyword">null</span> &amp;&amp; Intent.isAccessUriMode(intent.getFlags())) &#123;</span><br><span class="line">                <span class="comment">//【1.1.1】由于目标 uid 需要访问数据，所以这里会尝试授予 uid 对应的 uri 权限！</span></span><br><span class="line">                grantClipDataPermissions(data, intent.getFlags(), uid,</span><br><span class="line">                        mCallingUid, mSessionComponentName.getPackageName());</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">//【1.2】同理！</span></span><br><span class="line">        ClipData data = content.getClipData();</span><br><span class="line">        <span class="keyword">if</span> (data != <span class="keyword">null</span>) &#123;</span><br><span class="line">            grantClipDataPermissions(data,</span><br><span class="line">                    Intent.FLAG_GRANT_READ_URI_PERMISSION,</span><br><span class="line">                    uid, mCallingUid, mSessionComponentName.getPackageName());</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">        <span class="comment">//【2】处理语音相关事务！</span></span><br><span class="line">        mSession.handleAssist(assistData, structure, content,</span><br><span class="line">                assistDataForActivity.activityIndex, assistDataForActivity.activityCount);</span><br><span class="line">    &#125; <span class="keyword">catch</span> (RemoteException e) &#123;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>调用 grantClipDataPermissions 方法，这里的 srcUid 是 EXTRA_ASSIST_UID 对应的 uid！！<br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">grantClipDataPermissions</span><span class="params">(ClipData data, <span class="keyword">int</span> mode, <span class="keyword">int</span> srcUid, <span class="keyword">int</span> destUid,</span></span></span><br><span class="line"><span class="function"><span class="params">        String destPkg)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">final</span> <span class="keyword">int</span> N = data.getItemCount();</span><br><span class="line">    <span class="keyword">for</span> (<span class="keyword">int</span> i=<span class="number">0</span>; i&lt;N; i++) &#123;</span><br><span class="line">        <span class="comment">//【1】继续调用：</span></span><br><span class="line">        grantClipDataItemPermission(data.getItemAt(i), mode, srcUid, destUid, destPkg);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>再调用 grantClipDataItemPermission 方法：<br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">grantClipDataItemPermission</span><span class="params">(ClipData.Item item, <span class="keyword">int</span> mode, <span class="keyword">int</span> srcUid, <span class="keyword">int</span> destUid,</span></span></span><br><span class="line"><span class="function"><span class="params">        String destPkg)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">if</span> (item.getUri() != <span class="keyword">null</span>) &#123;</span><br><span class="line">        <span class="comment">//【1】继续调用，授予 uid 对应的 uri 权限！</span></span><br><span class="line">        grantUriPermission(item.getUri(), mode, srcUid, destUid, destPkg);</span><br><span class="line">    &#125;</span><br><span class="line">    Intent intent = item.getIntent();</span><br><span class="line">    <span class="keyword">if</span> (intent != <span class="keyword">null</span> &amp;&amp; intent.getData() != <span class="keyword">null</span>) &#123;</span><br><span class="line">        grantUriPermission(intent.getData(), mode, srcUid, destUid, destPkg);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>继续调用 grantUriPermission 方法：<br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">grantUriPermission</span><span class="params">(Uri uri, <span class="keyword">int</span> mode, <span class="keyword">int</span> srcUid, <span class="keyword">int</span> destUid, String destPkg)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">if</span> (!<span class="string">"content"</span>.equals(uri.getScheme())) &#123;</span><br><span class="line">        <span class="keyword">return</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">long</span> ident = Binder.clearCallingIdentity();</span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">        <span class="comment">//【1】做一次检查，如果有异常，那么终止操作！</span></span><br><span class="line">        mAm.checkGrantUriPermission(srcUid, <span class="keyword">null</span>, ContentProvider.getUriWithoutUserId(uri),</span><br><span class="line">                mode, ContentProvider.getUserIdFromUri(uri, UserHandle.getUserId(srcUid)));</span><br><span class="line">        <span class="comment">// No security exception, do the grant.</span></span><br><span class="line">        <span class="keyword">int</span> sourceUserId = ContentProvider.getUserIdFromUri(uri, mUser);</span><br><span class="line">        uri = ContentProvider.getUriWithoutUserId(uri);</span><br><span class="line">        <span class="comment">//【2】授予 srcUid 访问 uri 的权限！</span></span><br><span class="line">        mAm.grantUriPermissionFromOwner(mPermissionOwner, srcUid, destPkg,</span><br><span class="line">                uri, Intent.FLAG_GRANT_READ_URI_PERMISSION, sourceUserId, mUser);</span><br><span class="line">    &#125; <span class="keyword">catch</span> (RemoteException e) &#123;</span><br><span class="line">    &#125; <span class="keyword">catch</span> (SecurityException e) &#123;</span><br><span class="line">        Slog.w(TAG, <span class="string">"Can't propagate permission"</span>, e);</span><br><span class="line">    &#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">        Binder.restoreCallingIdentity(ident);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>不多说了！！</p>
<h3 id="2-4-2-跨进程调用"><a href="#2-4-2-跨进程调用" class="headerlink" title="2.4.2 跨进程调用"></a>2.4.2 跨进程调用</h3><p>调用方法：<br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">try</span> &#123;</span><br><span class="line">    ActivityManagerNative.getDefault().checkGrantUriPermission(...);</span><br><span class="line">&#125; <span class="keyword">catch</span> (RemoteException e) &#123;</span><br><span class="line">    <span class="keyword">throw</span> e.rethrowFromSystemServer();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>具体流程：</p>
<ul>
<li><strong>ActivityManagerProxy</strong></li>
</ul>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">int</span> <span class="title">checkGrantUriPermission</span><span class="params">(<span class="keyword">int</span> callingUid, String targetPkg,</span></span></span><br><span class="line"><span class="function"><span class="params">        Uri uri, <span class="keyword">int</span> modeFlags, <span class="keyword">int</span> userId)</span> <span class="keyword">throws</span> RemoteException </span>&#123;</span><br><span class="line">    Parcel data = Parcel.obtain();</span><br><span class="line">    Parcel reply = Parcel.obtain();</span><br><span class="line">    data.writeInterfaceToken(IActivityManager.descriptor);</span><br><span class="line">    data.writeInt(callingUid);</span><br><span class="line">    data.writeString(targetPkg);</span><br><span class="line">    uri.writeToParcel(data, <span class="number">0</span>);</span><br><span class="line">    data.writeInt(modeFlags);</span><br><span class="line">    data.writeInt(userId);</span><br><span class="line">    mRemote.transact(CHECK_GRANT_URI_PERMISSION_TRANSACTION, data, reply, <span class="number">0</span>);</span><br><span class="line">    reply.readException();</span><br><span class="line">    <span class="keyword">int</span> res = reply.readInt();</span><br><span class="line">    data.recycle();</span><br><span class="line">    reply.recycle();</span><br><span class="line">    <span class="keyword">return</span> res;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<ul>
<li><strong>ActivityManagerNative</strong></li>
</ul>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">case</span> CHECK_GRANT_URI_PERMISSION_TRANSACTION: &#123;</span><br><span class="line">    data.enforceInterface(IActivityManager.descriptor);</span><br><span class="line">    <span class="keyword">int</span> callingUid = data.readInt();</span><br><span class="line">    String targetPkg = data.readString();</span><br><span class="line">    Uri uri = Uri.CREATOR.createFromParcel(data);</span><br><span class="line">    <span class="keyword">int</span> modeFlags = data.readInt();</span><br><span class="line">    <span class="keyword">int</span> userId = data.readInt();</span><br><span class="line">    <span class="keyword">int</span> res = checkGrantUriPermission(callingUid, targetPkg, uri, modeFlags, userId);</span><br><span class="line">    reply.writeNoException();</span><br><span class="line">    reply.writeInt(res);</span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">true</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h2 id="2-5-checkGrantUriPermissionFromIntentLocked"><a href="#2-5-checkGrantUriPermissionFromIntentLocked" class="headerlink" title="2.5 checkGrantUriPermissionFromIntentLocked"></a>2.5 checkGrantUriPermissionFromIntentLocked</h2><p>该方法用于判断是否能够授予 targetPkg 访问 uri 的权限，uri 来自接收到的 intent；</p>
<p>和 2.6 的 checkGrantUriPermissionLocked 很类似，区别是 checkGrantUriPermissionLocked 直接操作的是 Uri；而该方法直接作用于 Intent！</p>
<p>返回 null 表示不需要授予权限！</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br></pre></td><td class="code"><pre><span class="line"><span class="function">NeededUriGrants <span class="title">checkGrantUriPermissionFromIntentLocked</span><span class="params">(<span class="keyword">int</span> callingUid,</span></span></span><br><span class="line"><span class="function"><span class="params">        String targetPkg, Intent intent, <span class="keyword">int</span> mode, NeededUriGrants needed, <span class="keyword">int</span> targetUserId)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">if</span> (DEBUG_URI_PERMISSION) Slog.v(TAG_URI_PERMISSION,</span><br><span class="line">            <span class="string">"Checking URI perm to data="</span> + (intent != <span class="keyword">null</span> ? intent.getData() : <span class="keyword">null</span>)</span><br><span class="line">            + <span class="string">" clip="</span> + (intent != <span class="keyword">null</span> ? intent.getClipData() : <span class="keyword">null</span>)</span><br><span class="line">            + <span class="string">" from "</span> + intent + <span class="string">"; flags=0x"</span></span><br><span class="line">            + Integer.toHexString(intent != <span class="keyword">null</span> ? intent.getFlags() : <span class="number">0</span>));</span><br><span class="line"></span><br><span class="line">    <span class="comment">//【1】如果 targetPkg / intent 为 null，则抛出异常！</span></span><br><span class="line">    <span class="keyword">if</span> (targetPkg == <span class="keyword">null</span>) &#123;</span><br><span class="line">        <span class="keyword">throw</span> <span class="keyword">new</span> NullPointerException(<span class="string">"targetPkg"</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span> (intent == <span class="keyword">null</span>) &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">null</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">//【2】获得 intent 中的 Uri 和 ClipData 数据，如果都为 null，抛出异常！</span></span><br><span class="line">    Uri data = intent.getData();</span><br><span class="line">    ClipData clip = intent.getClipData();</span><br><span class="line">    <span class="keyword">if</span> (data == <span class="keyword">null</span> &amp;&amp; clip == <span class="keyword">null</span>) &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">null</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//【3】获得 uri 所在的 userId，如果 contentUserHint 等于 UserHandle.USER_CURRENT，</span></span><br><span class="line">    <span class="comment">// 说明该 intent 没有离开当前 userId！</span></span><br><span class="line">    <span class="keyword">int</span> contentUserHint = intent.getContentUserHint();</span><br><span class="line">    <span class="keyword">if</span> (contentUserHint == UserHandle.USER_CURRENT) &#123;</span><br><span class="line">        contentUserHint = UserHandle.getUserId(callingUid);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">//【4】计算目标 uid，如果已经知道需要什么权限，即 NeededUriGrants 不为 null，那么通过 NeededUriGrants.targetUid</span></span><br><span class="line">    <span class="comment">// 获得目标 uid，否则，通过 targetPkg 计算 targetUid！</span></span><br><span class="line">    <span class="keyword">final</span> IPackageManager pm = AppGlobals.getPackageManager();</span><br><span class="line">    <span class="keyword">int</span> targetUid;</span><br><span class="line">    <span class="keyword">if</span> (needed != <span class="keyword">null</span>) &#123;</span><br><span class="line">        targetUid = needed.targetUid;</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            targetUid = pm.getPackageUid(targetPkg, MATCH_DEBUG_TRIAGED_MISSING,</span><br><span class="line">                    targetUserId);</span><br><span class="line">        &#125; <span class="keyword">catch</span> (RemoteException ex) &#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="keyword">null</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">if</span> (targetUid &lt; <span class="number">0</span>) &#123;</span><br><span class="line">            <span class="keyword">if</span> (DEBUG_URI_PERMISSION) Slog.v(TAG_URI_PERMISSION,</span><br><span class="line">                    <span class="string">"Can't grant URI permission no uid for: "</span> + targetPkg</span><br><span class="line">                    + <span class="string">" on user "</span> + targetUserId);</span><br><span class="line">            <span class="keyword">return</span> <span class="keyword">null</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">//【5】首先处理 data 数据，获得传递的 uri，调用 checkGrantUriPermissionLocked 判断是否需要授予 uri 权限！</span></span><br><span class="line">    <span class="keyword">if</span> (data != <span class="keyword">null</span>) &#123;</span><br><span class="line">        GrantUri grantUri = GrantUri.resolve(contentUserHint, data);</span><br><span class="line">        <span class="comment">//【*2.6】首先判断是否有访问 data 指定的数据！</span></span><br><span class="line">        targetUid = checkGrantUriPermissionLocked(callingUid, targetPkg, grantUri, mode,</span><br><span class="line">                targetUid);</span><br><span class="line">        <span class="comment">//【5.1】如果返回值大于 0，说明需要授予权限，创建 NeededUriGrants 对象，记录下！</span></span><br><span class="line">        <span class="keyword">if</span> (targetUid &gt; <span class="number">0</span>) &#123;</span><br><span class="line">            <span class="keyword">if</span> (needed == <span class="keyword">null</span>) &#123;</span><br><span class="line">                needed = <span class="keyword">new</span> NeededUriGrants(targetPkg, targetUid, mode);</span><br><span class="line">            &#125;</span><br><span class="line">            needed.add(grantUri);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">//【6】接着处理 ClipData 数据，遍历 ClipData 中的所有 item，处理其 uri 和 intent 数据！</span></span><br><span class="line">    <span class="keyword">if</span> (clip != <span class="keyword">null</span>) &#123;</span><br><span class="line">        <span class="keyword">for</span> (<span class="keyword">int</span> i=<span class="number">0</span>; i&lt;clip.getItemCount(); i++) &#123;</span><br><span class="line">            Uri uri = clip.getItemAt(i).getUri();</span><br><span class="line">            <span class="keyword">if</span> (uri != <span class="keyword">null</span>) &#123;</span><br><span class="line">                <span class="comment">//【*2.6】如果其 uri 不为 null，检查是否有权限访问该 url，同样是 checkGrantUriPermissionLocked</span></span><br><span class="line">                <span class="comment">// 方法！</span></span><br><span class="line">                GrantUri grantUri = GrantUri.resolve(contentUserHint, uri);</span><br><span class="line">                targetUid = checkGrantUriPermissionLocked(callingUid, targetPkg, grantUri, mode,</span><br><span class="line">                        targetUid);</span><br><span class="line">                <span class="keyword">if</span> (targetUid &gt; <span class="number">0</span>) &#123;</span><br><span class="line">                    <span class="keyword">if</span> (needed == <span class="keyword">null</span>) &#123;</span><br><span class="line">                        needed = <span class="keyword">new</span> NeededUriGrants(targetPkg, targetUid, mode);</span><br><span class="line">                    &#125;</span><br><span class="line">                    needed.add(grantUri);</span><br><span class="line">                &#125;</span><br><span class="line">            &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                <span class="comment">//【6.1】如果其 clipIntent 不为 null，递归检查该 intent!</span></span><br><span class="line">                Intent clipIntent = clip.getItemAt(i).getIntent();</span><br><span class="line">                <span class="keyword">if</span> (clipIntent != <span class="keyword">null</span>) &#123;</span><br><span class="line">                    <span class="comment">//【*2.6】递归检查！ </span></span><br><span class="line">                    NeededUriGrants newNeeded = checkGrantUriPermissionFromIntentLocked(</span><br><span class="line">                            callingUid, targetPkg, clipIntent, mode, needed, targetUserId);</span><br><span class="line">                    <span class="keyword">if</span> (newNeeded != <span class="keyword">null</span>) &#123;</span><br><span class="line">                        needed = newNeeded;</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">//【7】返回 NeededUriGrants 对象，该对象保存了需要授权访问的所有 url！！</span></span><br><span class="line">    <span class="keyword">return</span> needed;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>该方法会返回一个 NeededUriGrants 对象，用于保存该 intent 携带的所有需要授权访问了 GrantUri 对象，包括其 ClipData 中的 intent 携带的 uri：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">static</span> <span class="class"><span class="keyword">class</span> <span class="title">NeededUriGrants</span> <span class="keyword">extends</span> <span class="title">ArrayList</span>&lt;<span class="title">GrantUri</span>&gt; </span>&#123;</span><br><span class="line">    <span class="keyword">final</span> String targetPkg;</span><br><span class="line">    <span class="keyword">final</span> <span class="keyword">int</span> targetUid;</span><br><span class="line">    <span class="keyword">final</span> <span class="keyword">int</span> flags;</span><br><span class="line"></span><br><span class="line">    NeededUriGrants(String targetPkg, <span class="keyword">int</span> targetUid, <span class="keyword">int</span> flags) &#123;</span><br><span class="line">        <span class="keyword">this</span>.targetPkg = targetPkg;</span><br><span class="line">        <span class="keyword">this</span>.targetUid = targetUid;</span><br><span class="line">        <span class="keyword">this</span>.flags = flags;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>这里的 mode 可以设置下面的两个标志位！</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="keyword">int</span> FLAG_GRANT_READ_URI_PERMISSION = <span class="number">0x00000001</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="keyword">int</span> FLAG_GRANT_WRITE_URI_PERMISSION = <span class="number">0x00000002</span>;</span><br></pre></td></tr></table></figure>
<p>如果设置该标记，Intent 的接受者将会被赋予读/写 Intent 中 uri 数据和 Intent.ClipData 中的 uri 的权限。</p>
<p>当应用到 Intent 的 ClipData 时，其携带的所有 uri 都会被 intent 接收者读/写，同时其会递归处理其携带的所有 intent！</p>
<p>其实，mode 的值是为了标志授予的权限类型是读还是写的，都设置的话，那就是可读可写！</p>
<h3 id="2-5-1-调用时机"><a href="#2-5-1-调用时机" class="headerlink" title="2.5.1 调用时机"></a>2.5.1 调用时机</h3><p>该方法的调用实际比较少，ActiveServices 和 ActivityManagerService 中：</p>
<h4 id="2-5-1-1-ActiveServices-startServiceLocked"><a href="#2-5-1-1-ActiveServices-startServiceLocked" class="headerlink" title="2.5.1.1 ActiveServices.startServiceLocked"></a>2.5.1.1 ActiveServices.startServiceLocked</h4><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><span class="line"><span class="function">ComponentName <span class="title">startServiceLocked</span><span class="params">(IApplicationThread caller, Intent service, String resolvedType,</span></span></span><br><span class="line"><span class="function"><span class="params">        <span class="keyword">int</span> callingPid, <span class="keyword">int</span> callingUid, String callingPackage, <span class="keyword">final</span> <span class="keyword">int</span> userId)</span></span></span><br><span class="line"><span class="function">        <span class="keyword">throws</span> TransactionTooLargeException </span>&#123;</span><br><span class="line">    <span class="keyword">if</span> (DEBUG_DELAYED_STARTS) Slog.v(TAG_SERVICE, <span class="string">"startService: "</span> + service</span><br><span class="line">            + <span class="string">" type="</span> + resolvedType + <span class="string">" args="</span> + service.getExtras());</span><br><span class="line">    ... ... ... ...</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (!r.startRequested) &#123;</span><br><span class="line">        <span class="keyword">final</span> <span class="keyword">long</span> token = Binder.clearCallingIdentity();</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            <span class="comment">// Before going further -- if this app is not allowed to run in the</span></span><br><span class="line">            <span class="comment">// background, then at this point we aren't going to let it period.</span></span><br><span class="line">            <span class="keyword">final</span> <span class="keyword">int</span> allowed = mAm.checkAllowBackgroundLocked(</span><br><span class="line">                    r.appInfo.uid, r.packageName, callingPid, <span class="keyword">true</span>);</span><br><span class="line">            <span class="keyword">if</span> (allowed != ActivityManager.APP_START_MODE_NORMAL) &#123;</span><br><span class="line">                Slog.w(TAG, <span class="string">"Background start not allowed: service "</span></span><br><span class="line">                        + service + <span class="string">" to "</span> + r.name.flattenToShortString()</span><br><span class="line">                        + <span class="string">" from pid="</span> + callingPid + <span class="string">" uid="</span> + callingUid</span><br><span class="line">                        + <span class="string">" pkg="</span> + callingPackage);</span><br><span class="line">                <span class="keyword">return</span> <span class="keyword">null</span>;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125; <span class="keyword">finally</span> &#123;f</span><br><span class="line">            Binder.restoreCallingIdentity(token);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">//【1】校验了下是否需要授予 uri 权限！</span></span><br><span class="line">    NeededUriGrants neededGrants = mAm.checkGrantUriPermissionFromIntentLocked(</span><br><span class="line">            callingUid, r.packageName, service, service.getFlags(), <span class="keyword">null</span>, r.userId);</span><br><span class="line"></span><br><span class="line">    ... ... ... ...</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> startServiceInnerLocked(smap, service, r, callerFg, addToStarting);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>这里就不多说了！</p>
<h2 id="2-6-checkGrantUriPermissionLocked"><a href="#2-6-checkGrantUriPermissionLocked" class="headerlink" title="2.6 checkGrantUriPermissionLocked"></a>2.6 checkGrantUriPermissionLocked</h2><p>判断是否需要授予 targetPkg 访问 uri 的权限，modeFlags 指定了访问模式， callingUid 是调用者 uid！</p>
<p>如果 callingUid 不被允许，会抛出 SecurityException 异常！ 如果方法返回了 targetPkg 的 uid，说明需要授予权限；如果返回 -1，表示不需要或者无法授予（比如目标包已经有权限访问 uri）！</p>
<p>lastTargetUid 表示 targetPkg 的 uid，如果已经知道了 targetPkg.uid，那么就设置 lastTargetUid 为 targetPkg.uid 即可；如果不知道，那么设置为 -1，方法内部会计算出对应的 uid！</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">checkGrantUriPermissionLocked</span><span class="params">(<span class="keyword">int</span> callingUid, String targetPkg, GrantUri grantUri,</span></span></span><br><span class="line"><span class="function"><span class="params">        <span class="keyword">final</span> <span class="keyword">int</span> modeFlags, <span class="keyword">int</span> lastTargetUid)</span> </span>&#123;</span><br><span class="line">    <span class="comment">//【1】判断 modeFlags 是否至少设置了 Intent.FLAG_GRANT_WRITE_URI_PERMISSION 或者</span></span><br><span class="line">    <span class="comment">// Intent.FLAG_GRANT_READ_URI_PERMISSION，如果都没有，返回 -1!</span></span><br><span class="line">    <span class="keyword">if</span> (!Intent.isAccessUriMode(modeFlags)) &#123;</span><br><span class="line">        <span class="keyword">return</span> -<span class="number">1</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (targetPkg != <span class="keyword">null</span>) &#123;</span><br><span class="line">        <span class="keyword">if</span> (DEBUG_URI_PERMISSION) Slog.v(TAG_URI_PERMISSION,</span><br><span class="line">                <span class="string">"Checking grant "</span> + targetPkg + <span class="string">" permission to "</span> + grantUri);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">final</span> IPackageManager pm = AppGlobals.getPackageManager();</span><br><span class="line"></span><br><span class="line">    <span class="comment">//【2】如果 uri 不是和 content 相关的，异常，返回 -1；</span></span><br><span class="line">    <span class="keyword">if</span> (!ContentResolver.SCHEME_CONTENT.equals(grantUri.uri.getScheme())) &#123;</span><br><span class="line">        <span class="keyword">if</span> (DEBUG_URI_PERMISSION) Slog.v(TAG_URI_PERMISSION,</span><br><span class="line">                <span class="string">"Can't grant URI permission for non-content URI: "</span> + grantUri);</span><br><span class="line">        <span class="keyword">return</span> -<span class="number">1</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//【3】无法通过 uri 找到一个 ContentProvider，异常，返回 -1；</span></span><br><span class="line">    <span class="keyword">final</span> String authority = grantUri.uri.getAuthority();</span><br><span class="line">    <span class="keyword">final</span> ProviderInfo pi = getProviderInfoLocked(authority, grantUri.sourceUserId,</span><br><span class="line">            MATCH_DEBUG_TRIAGED_MISSING);</span><br><span class="line">    <span class="keyword">if</span> (pi == <span class="keyword">null</span>) &#123;</span><br><span class="line">        Slog.w(TAG, <span class="string">"No content provider found for permission check: "</span> +</span><br><span class="line">                grantUri.uri.toSafeString());</span><br><span class="line">        <span class="keyword">return</span> -<span class="number">1</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//【4】计算 targetPkg 的 uid！</span></span><br><span class="line">    <span class="keyword">int</span> targetUid = lastTargetUid;</span><br><span class="line">    <span class="keyword">if</span> (targetUid &lt; <span class="number">0</span> &amp;&amp; targetPkg != <span class="keyword">null</span>) &#123;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            targetUid = pm.getPackageUid(targetPkg, MATCH_DEBUG_TRIAGED_MISSING,</span><br><span class="line">                    UserHandle.getUserId(callingUid));</span><br><span class="line">            <span class="keyword">if</span> (targetUid &lt; <span class="number">0</span>) &#123;</span><br><span class="line">                <span class="keyword">if</span> (DEBUG_URI_PERMISSION) Slog.v(TAG_URI_PERMISSION,</span><br><span class="line">                        <span class="string">"Can't grant URI permission no uid for: "</span> + targetPkg);</span><br><span class="line">                <span class="keyword">return</span> -<span class="number">1</span>;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125; <span class="keyword">catch</span> (RemoteException ex) &#123;</span><br><span class="line">            <span class="keyword">return</span> -<span class="number">1</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (targetUid &gt;= <span class="number">0</span>) &#123;</span><br><span class="line">        <span class="comment">// 一般情况 targetUid &gt;= 0，说明 targetPkg 是存在的，那么就判断下 targetPkg 是否已经持有该权限！</span></span><br><span class="line">        <span class="comment">//【*2.7】这里调用了 checkHoldingPermissionsLocked 判断是否已经有权限，如果已经持有，返回 -1；</span></span><br><span class="line">        <span class="keyword">if</span> (checkHoldingPermissionsLocked(pm, pi, grantUri, targetUid, modeFlags)) &#123;</span><br><span class="line">            <span class="keyword">if</span> (DEBUG_URI_PERMISSION) Slog.v(TAG_URI_PERMISSION,</span><br><span class="line">                    <span class="string">"Target "</span> + targetPkg + <span class="string">" already has full permission to "</span> + grantUri);</span><br><span class="line">            <span class="keyword">return</span> -<span class="number">1</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        <span class="comment">//【5】如果 targetUid &lt; 0，说明没有 targetPkg，</span></span><br><span class="line">        <span class="comment">// 此时如果 ContentProvider 指定了读写权限，那就要进一步判断是否要授予权限；如果没有指定读写权限</span></span><br><span class="line">        <span class="comment">// 就要看 provider 是否是暴露的，如果是 export 的，那么可以直接访问，无需授权，返回 -1；</span></span><br><span class="line">        <span class="comment">// 否则，需要继续判断；</span></span><br><span class="line">        <span class="keyword">boolean</span> allowed = pi.exported;</span><br><span class="line">        <span class="keyword">if</span> ((modeFlags &amp; Intent.FLAG_GRANT_READ_URI_PERMISSION) != <span class="number">0</span>) &#123;</span><br><span class="line">            <span class="keyword">if</span> (pi.readPermission != <span class="keyword">null</span>) &#123;</span><br><span class="line">                allowed = <span class="keyword">false</span>;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">if</span> ((modeFlags &amp; Intent.FLAG_GRANT_WRITE_URI_PERMISSION) != <span class="number">0</span>) &#123;</span><br><span class="line">            <span class="keyword">if</span> (pi.writePermission != <span class="keyword">null</span>) &#123;</span><br><span class="line">                allowed = <span class="keyword">false</span>;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">if</span> (allowed) &#123;</span><br><span class="line">            <span class="keyword">return</span> -<span class="number">1</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//【6】这里来处理一种跨用户访问的特殊情况：</span></span><br><span class="line">    <span class="comment">// 如果 targetUid 和 uri 不再同一个 userId 下，并且当前 userId 下的应用不需要任何权限就可以访问该 uri，</span></span><br><span class="line">    <span class="comment">// 那么我们也会授予 targetPkg 访问 uri 的权限，</span></span><br><span class="line">    <span class="comment">// 即使 provider 没有授予该权限，这种情况 specialCrossUserGrant 为 true！</span></span><br><span class="line">    <span class="comment">//【*2.8】这里调用了 checkHoldingPermissionsInternalLocked 方法！</span></span><br><span class="line">    <span class="keyword">boolean</span> specialCrossUserGrant = UserHandle.getUserId(targetUid) != grantUri.sourceUserId</span><br><span class="line">            &amp;&amp; checkHoldingPermissionsInternalLocked(pm, pi, grantUri, callingUid,</span><br><span class="line">            modeFlags, <span class="keyword">false</span> <span class="comment">/*without considering the uid permissions*/</span>);</span><br><span class="line"></span><br><span class="line">    <span class="comment">//【7】一般情况下，我们的访问是不会是跨用户的，继续判断 provider 是否允许授予 uri 权限！</span></span><br><span class="line">    <span class="keyword">if</span> (!specialCrossUserGrant) &#123;</span><br><span class="line">        <span class="comment">//【7.1】provider 不允许授予 uri 权限，抛出异常！</span></span><br><span class="line">        <span class="keyword">if</span> (!pi.grantUriPermissions) &#123;</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> SecurityException(<span class="string">"Provider "</span> + pi.packageName</span><br><span class="line">                    + <span class="string">"/"</span> + pi.name</span><br><span class="line">                    + <span class="string">" does not allow granting of Uri permissions (uri "</span></span><br><span class="line">                    + grantUri + <span class="string">")"</span>);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">//【7.2】provider 允许授予 uri 权限，如果其指定了 uriPermissionPatterns，判断下要访问呢的 url</span></span><br><span class="line">        <span class="comment">// 是不是能够匹配 uriPermissionPatterns，如果不行，那就说明不允许访问，抛出异常！</span></span><br><span class="line">        <span class="keyword">if</span> (pi.uriPermissionPatterns != <span class="keyword">null</span>) &#123;</span><br><span class="line">            <span class="keyword">final</span> <span class="keyword">int</span> N = pi.uriPermissionPatterns.length;</span><br><span class="line">            <span class="keyword">boolean</span> allowed = <span class="keyword">false</span>;</span><br><span class="line">            <span class="keyword">for</span> (<span class="keyword">int</span> i=<span class="number">0</span>; i&lt;N; i++) &#123;</span><br><span class="line">                <span class="keyword">if</span> (pi.uriPermissionPatterns[i] != <span class="keyword">null</span></span><br><span class="line">                        &amp;&amp; pi.uriPermissionPatterns[i].match(grantUri.uri.getPath())) &#123;</span><br><span class="line">                    allowed = <span class="keyword">true</span>;</span><br><span class="line">                    <span class="keyword">break</span>;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">if</span> (!allowed) &#123;</span><br><span class="line">                <span class="keyword">throw</span> <span class="keyword">new</span> SecurityException(<span class="string">"Provider "</span> + pi.packageName</span><br><span class="line">                        + <span class="string">"/"</span> + pi.name</span><br><span class="line">                        + <span class="string">" does not allow granting of permission to path of Uri "</span></span><br><span class="line">                        + grantUri);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//【8】这里判断了下调用者自身 callingUid 是否有权限访问该 Uri，如果 callingUid 不是 system uid 的话</span></span><br><span class="line">    <span class="comment">// 就会进行检查！</span></span><br><span class="line">    <span class="keyword">if</span> (UserHandle.getAppId(callingUid) != Process.SYSTEM_UID) &#123;</span><br><span class="line">        <span class="comment">//【*2.7】同样的，这里调用了 checkHoldingPermissionsLocked 方法判断是否已经有权限！</span></span><br><span class="line">        <span class="keyword">if</span> (!checkHoldingPermissionsLocked(pm, pi, grantUri, callingUid, modeFlags)) &#123;</span><br><span class="line">            <span class="comment">//【*2.10】调用了 checkUriPermissionLocked 判断是否有 uri 权限！</span></span><br><span class="line">            <span class="keyword">if</span> (!checkUriPermissionLocked(grantUri, callingUid, modeFlags)) &#123;</span><br><span class="line">                <span class="keyword">throw</span> <span class="keyword">new</span> SecurityException(<span class="string">"Uid "</span> + callingUid</span><br><span class="line">                        + <span class="string">" does not have permission to uri "</span> + grantUri);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">//【9】最后返回 targetUid，如果大于 0，说明需要授予权限！！</span></span><br><span class="line">    <span class="keyword">return</span> targetUid;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>我们看到这里会有几种情况出现异常：</p>
<ul>
<li>uri 所属的 provider 的 grantUriPermissions 为 false，说明 provider 禁止 uri 访问，会抛出异常；</li>
<li>如果 provider 的 grantUriPermissions 为 true，但是 provider 的 uriPermissionPatterns 中的 uri 没有和要访问的 uri 相匹配的，抛出异常；</li>
<li>如果调用者接口的程序，不具有对该 uri 的访问权限，那么就会抛出异常；</li>
</ul>
<p>这里也用到了那 2 个 flags，不在多说了！</p>
<h3 id="2-6-1-调用时机"><a href="#2-6-1-调用时机" class="headerlink" title="2.6.1 调用时机"></a>2.6.1 调用时机</h3><p>该方法的调用比较少，在 ActivityManagerService 中：</p>
<ul>
<li>一个是 2.4 checkGrantUriPermission 方法；</li>
<li>一个是 2.5 checkGrantUriPermissionFromIntentLocked 方法；</li>
<li>一个是在 grantUriPermissionLocked 方法，关于 grant 后面单独分析；</li>
</ul>
<h2 id="2-7-checkHoldingPermissionsLocked"><a href="#2-7-checkHoldingPermissionsLocked" class="headerlink" title="2.7 checkHoldingPermissionsLocked"></a>2.7 checkHoldingPermissionsLocked</h2><p>判断 uid 是否已经有访问 uri 的权限！<br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">final</span> <span class="keyword">boolean</span> <span class="title">checkHoldingPermissionsLocked</span><span class="params">(</span></span></span><br><span class="line"><span class="function"><span class="params">        IPackageManager pm, ProviderInfo pi, GrantUri grantUri, <span class="keyword">int</span> uid, <span class="keyword">final</span> <span class="keyword">int</span> modeFlags)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">if</span> (DEBUG_URI_PERMISSION) Slog.v(TAG_URI_PERMISSION,</span><br><span class="line">            <span class="string">"checkHoldingPermissionsLocked: uri="</span> + grantUri + <span class="string">" uid="</span> + uid);</span><br><span class="line">    <span class="comment">//【1】首先，如果 uid 和 uri 的 userId 不相等的话，需要检查 uid 是否具有跨用户的权限！</span></span><br><span class="line">    <span class="keyword">if</span> (UserHandle.getUserId(uid) != grantUri.sourceUserId) &#123;</span><br><span class="line">        <span class="comment">//【*2.12】这里调用了 checkComponentPermission 方法，如果没有跨用户的权限，那肯定是不会有</span></span><br><span class="line">        <span class="comment">// 访问 url 的权限的！！</span></span><br><span class="line">        <span class="keyword">if</span> (ActivityManager.checkComponentPermission(INTERACT_ACROSS_USERS, uid, -<span class="number">1</span>, <span class="keyword">true</span>)</span><br><span class="line">                != PERMISSION_GRANTED) &#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="keyword">false</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">//【*2.8】如果是同一用户下的，调用 checkHoldingPermissionsInternalLocked 方法进一步处理，</span></span><br><span class="line">    <span class="comment">// 这里 considerUidPermissions 为 true！表示需要校验 uid 权限！</span></span><br><span class="line">    <span class="keyword">return</span> checkHoldingPermissionsInternalLocked(pm, pi, grantUri, uid, modeFlags, <span class="keyword">true</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<h3 id="2-7-1-调用时机"><a href="#2-7-1-调用时机" class="headerlink" title="2.7.1 调用时机"></a>2.7.1 调用时机</h3><p>该方法的调用比较少，在 ActivityManagerService 中：</p>
<ul>
<li>一个是 2.6 checkGrantUriPermissionLocked 方法；</li>
<li>一个是在 revokeUriPermissionLocked 方法，关于 revoke 后面单独分析；</li>
</ul>
<h2 id="2-8-checkHoldingPermissionsInternalLocked"><a href="#2-8-checkHoldingPermissionsInternalLocked" class="headerlink" title="2.8 checkHoldingPermissionsInternalLocked"></a>2.8 checkHoldingPermissionsInternalLocked</h2><p>判断 uid 是否已经具有访问 uri 的权限，该接口并不检查是否是跨用户的调用！</p>
<p>considerUidPermissions 参数表示是否检查 uid 权限，一般我们是会传入 true 的！</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">final</span> <span class="keyword">boolean</span> <span class="title">checkHoldingPermissionsInternalLocked</span><span class="params">(IPackageManager pm, ProviderInfo pi,</span></span></span><br><span class="line"><span class="function"><span class="params">        GrantUri grantUri, <span class="keyword">int</span> uid, <span class="keyword">final</span> <span class="keyword">int</span> modeFlags, <span class="keyword">boolean</span> considerUidPermissions)</span> </span>&#123;</span><br><span class="line">    <span class="comment">//【1】如果 provider 的 uid 和访问者 uid 一样，同一应用，那是有权限访问的，返回 true；</span></span><br><span class="line">    <span class="comment">// 如果 provider.exported 为 false，那么，其没有权限访问，返回 false；</span></span><br><span class="line">    <span class="keyword">if</span> (pi.applicationInfo.uid == uid) &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">true</span>;</span><br><span class="line">    &#125; <span class="keyword">else</span> <span class="keyword">if</span> (!pi.exported) &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">false</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//【2】解析 modeFlags 中的 read 和 write 标志位，如果设置了该标志位，则为 false</span></span><br><span class="line">    <span class="comment">// 那么，下面会进行权限检查！</span></span><br><span class="line">    <span class="keyword">boolean</span> readMet = (modeFlags &amp; Intent.FLAG_GRANT_READ_URI_PERMISSION) == <span class="number">0</span>;</span><br><span class="line">    <span class="keyword">boolean</span> writeMet = (modeFlags &amp; Intent.FLAG_GRANT_WRITE_URI_PERMISSION) == <span class="number">0</span>;</span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">        <span class="comment">//【2.1】首先判断 uid 是否持有 read 和 write 的 top-level 的权限，该权限是在 &lt;provider&gt; 标签中设定的！</span></span><br><span class="line">        <span class="comment">// 当然判断的前提是 considerUidPermissions 为 true！</span></span><br><span class="line">        <span class="keyword">if</span> (!readMet &amp;&amp; pi.readPermission != <span class="keyword">null</span> &amp;&amp; considerUidPermissions</span><br><span class="line">                &amp;&amp; (pm.checkUidPermission(pi.readPermission, uid) == PERMISSION_GRANTED)) &#123;</span><br><span class="line">            readMet = <span class="keyword">true</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">if</span> (!writeMet &amp;&amp; pi.writePermission != <span class="keyword">null</span> &amp;&amp; considerUidPermissions</span><br><span class="line">                &amp;&amp; (pm.checkUidPermission(pi.writePermission, uid) == PERMISSION_GRANTED)) &#123;</span><br><span class="line">            writeMet = <span class="keyword">true</span>;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment">//【2.2】如果 provider 没有设置 top-level 的权限的话，allowDefaultRead 和 allowDefaultWrite 为 true！</span></span><br><span class="line">        <span class="comment">// 否则，为 false！</span></span><br><span class="line">        <span class="keyword">boolean</span> allowDefaultRead = pi.readPermission == <span class="keyword">null</span>;</span><br><span class="line">        <span class="keyword">boolean</span> allowDefaultWrite = pi.writePermission == <span class="keyword">null</span>;</span><br><span class="line"></span><br><span class="line">        <span class="comment">//【2.3】下面是非 top-level 的权限检查！</span></span><br><span class="line">        <span class="comment">// 如果 provider 设置了 path permission，那还要判断 uid 其是否持有对应的 path permission！</span></span><br><span class="line">        <span class="comment">// 当然判断的前提是 considerUidPermissions 为 true！</span></span><br><span class="line">        <span class="keyword">final</span> PathPermission[] pps = pi.pathPermissions;</span><br><span class="line">        <span class="keyword">if</span> (pps != <span class="keyword">null</span>) &#123;</span><br><span class="line">            <span class="keyword">final</span> String path = grantUri.uri.getPath();</span><br><span class="line">            <span class="keyword">int</span> i = pps.length;</span><br><span class="line">            <span class="comment">//【2.3.1】只有 readMet/writeMet 为 false 时，才会做 path permission 校验！</span></span><br><span class="line">            <span class="comment">// 因为如果 readMet | writeMet 为 true 的话，说明 uid 持有 top-level 的权限！</span></span><br><span class="line">            <span class="keyword">while</span> (i &gt; <span class="number">0</span> &amp;&amp; (!readMet || !writeMet)) &#123;</span><br><span class="line">                i--;</span><br><span class="line">                PathPermission pp = pps[i];</span><br><span class="line">                <span class="keyword">if</span> (pp.match(path)) &#123;</span><br><span class="line">                    <span class="keyword">if</span> (!readMet) &#123;</span><br><span class="line">                        <span class="keyword">final</span> String pprperm = pp.getReadPermission();</span><br><span class="line">                        <span class="keyword">if</span> (DEBUG_URI_PERMISSION) Slog.v(TAG_URI_PERMISSION,</span><br><span class="line">                                <span class="string">"Checking read perm for "</span> + pprperm + <span class="string">" for "</span> + pp.getPath()</span><br><span class="line">                                + <span class="string">": match="</span> + pp.match(path)</span><br><span class="line">                                + <span class="string">" check="</span> + pm.checkUidPermission(pprperm, uid));</span><br><span class="line">                        <span class="keyword">if</span> (pprperm != <span class="keyword">null</span>) &#123;</span><br><span class="line">                            <span class="comment">//【2.3.1】当 considerUidPermissions 为 true，并且 uid 有权限，那么 readMet 为 true</span></span><br><span class="line">                            <span class="comment">// 表示可读，否则 readMet == allowDefaultRead == false；</span></span><br><span class="line">                            <span class="comment">//【*3.1】调用了 pms 的 checkUidPermission 接口！</span></span><br><span class="line">                            <span class="keyword">if</span> (considerUidPermissions &amp;&amp; pm.checkUidPermission(pprperm, uid)</span><br><span class="line">                                    == PERMISSION_GRANTED) &#123;</span><br><span class="line">                                readMet = <span class="keyword">true</span>;</span><br><span class="line">                            &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                                allowDefaultRead = <span class="keyword">false</span>;</span><br><span class="line">                            &#125;</span><br><span class="line">                        &#125;</span><br><span class="line">                    &#125;</span><br><span class="line">                    <span class="keyword">if</span> (!writeMet) &#123;</span><br><span class="line">                        <span class="keyword">final</span> String ppwperm = pp.getWritePermission();</span><br><span class="line">                        <span class="keyword">if</span> (DEBUG_URI_PERMISSION) Slog.v(TAG_URI_PERMISSION,</span><br><span class="line">                                <span class="string">"Checking write perm "</span> + ppwperm + <span class="string">" for "</span> + pp.getPath()</span><br><span class="line">                                + <span class="string">": match="</span> + pp.match(path)</span><br><span class="line">                                + <span class="string">" check="</span> + pm.checkUidPermission(ppwperm, uid));</span><br><span class="line">                        <span class="keyword">if</span> (ppwperm != <span class="keyword">null</span>) &#123;</span><br><span class="line">                            <span class="comment">//【2.3.2】当 considerUidPermissions 为 true，并且 uid 有权限，那么 writeMet 为 true</span></span><br><span class="line">                            <span class="comment">// 表示可写；否则 writeMet == allowDefaultWrite == false；</span></span><br><span class="line">                            <span class="comment">//【*3.1】调用了 pms 的 checkUidPermission 接口！</span></span><br><span class="line">                            <span class="keyword">if</span> (considerUidPermissions &amp;&amp; pm.checkUidPermission(ppwperm, uid)</span><br><span class="line">                                    == PERMISSION_GRANTED) &#123;</span><br><span class="line">                                writeMet = <span class="keyword">true</span>;</span><br><span class="line">                            &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                                allowDefaultWrite = <span class="keyword">false</span>;</span><br><span class="line">                            &#125;</span><br><span class="line">                        &#125;</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment">//【3】如果 allowDefaultRead/allowDefaultWrite 为 true 了，设置 readMet/writeMet 为 true！</span></span><br><span class="line">        <span class="keyword">if</span> (allowDefaultRead) readMet = <span class="keyword">true</span>;</span><br><span class="line">        <span class="keyword">if</span> (allowDefaultWrite) writeMet = <span class="keyword">true</span>;</span><br><span class="line"></span><br><span class="line">    &#125; <span class="keyword">catch</span> (RemoteException e) &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">false</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// 最后返回 readMet &amp;&amp; writeMet，如果为 true，表示其具有访问 uri的权限！</span></span><br><span class="line">    <span class="keyword">return</span> readMet &amp;&amp; writeMet;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>通过逻辑可以知道：</p>
<ul>
<li><p>如果 considerUidPermissions 为 true，那么会调用 checkUidPermission 进行 uid 权限的校验!</p>
</li>
<li><p>如果 considerUidPermissions 为 false 的话，如果 uid 想要对 provider 持有访问权限的话，只能是</p>
</li>
</ul>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">pi.readPermission == <span class="keyword">null</span>;</span><br><span class="line">pi.writePermission == <span class="keyword">null</span>;</span><br><span class="line">pi.pathPermissions == <span class="keyword">null</span>;</span><br><span class="line">pi.exported == <span class="keyword">true</span></span><br></pre></td></tr></table></figure>
<p>也就是说，provider 不设置任何权限，同时是暴露的！！</p>
<h3 id="2-8-1-调用时机"><a href="#2-8-1-调用时机" class="headerlink" title="2.8.1 调用时机"></a>2.8.1 调用时机</h3><p>该方法的调用比较少，在 ActivityManagerService 中：</p>
<ul>
<li>一个是 2.7 checkHoldingPermissionsLocked 方法中；</li>
<li>一个是在 revokeUriPermissionLocked 方法，关于 revoke 后面单独分析；</li>
</ul>
<h2 id="2-9-checkUriPermission"><a href="#2-9-checkUriPermission" class="headerlink" title="2.9 checkUriPermission"></a>2.9 checkUriPermission</h2><p>用于检查 uid 是否持有 uri permissions：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">int</span> <span class="title">checkUriPermission</span><span class="params">(Uri uri, <span class="keyword">int</span> pid, <span class="keyword">int</span> uid,</span></span></span><br><span class="line"><span class="function"><span class="params">        <span class="keyword">final</span> <span class="keyword">int</span> modeFlags, <span class="keyword">int</span> userId, IBinder callerToken)</span> </span>&#123;</span><br><span class="line">    enforceNotIsolatedCaller(<span class="string">"checkUriPermission"</span>);</span><br><span class="line">    <span class="comment">//【1】通过 IBinder 对象获得调用者进程的 pid 和 uid！</span></span><br><span class="line">    Identity tlsIdentity = sCallerIdentity.get();</span><br><span class="line">    <span class="keyword">if</span> (tlsIdentity != <span class="keyword">null</span> &amp;&amp; tlsIdentity.token == callerToken) &#123;</span><br><span class="line">        uid = tlsIdentity.uid;</span><br><span class="line">        pid = tlsIdentity.pid;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//【2】如果 pid 是系统进程自身，默认授予！</span></span><br><span class="line">    <span class="keyword">if</span> (pid == MY_PID) &#123;</span><br><span class="line">        <span class="keyword">return</span> PackageManager.PERMISSION_GRANTED;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">synchronized</span> (<span class="keyword">this</span>) &#123;</span><br><span class="line">        <span class="comment">//【*2.10】调用 checkUriPermissionLocked 继续检查是否具有 uri 权限！</span></span><br><span class="line">        <span class="keyword">return</span> checkUriPermissionLocked(<span class="keyword">new</span> GrantUri(userId, uri, <span class="keyword">false</span>), uid, modeFlags)</span><br><span class="line">                ? PackageManager.PERMISSION_GRANTED</span><br><span class="line">                : PackageManager.PERMISSION_DENIED;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>这里的 sCallerIdentity 是一个线程本地变量：<br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> ThreadLocal&lt;Identity&gt; sCallerIdentity = <span class="keyword">new</span> ThreadLocal&lt;Identity&gt;();</span><br></pre></td></tr></table></figure></p>
<p>我们通过传入的 IBinder 对象和 Identity.token 进行匹配，然后就可以获得调用者的进程 pid 和 uid！</p>
<h3 id="2-9-1-调用时机-跨进程"><a href="#2-9-1-调用时机-跨进程" class="headerlink" title="2.9.1 调用时机 - 跨进程"></a>2.9.1 调用时机 - 跨进程</h3><p>该方法主要是从 Context 的 checkUriPermission 调用过来的！</p>
<p>调用方法：<br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">try</span> &#123;</span><br><span class="line">    ActivityManagerNative.getDefault().checkUriPermission(...);</span><br><span class="line">&#125; <span class="keyword">catch</span> (RemoteException e) &#123;</span><br><span class="line">    <span class="keyword">throw</span> e.rethrowFromSystemServer();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>具体流程：</p>
<ul>
<li><strong>ActivityManagerProxy</strong></li>
</ul>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">int</span> <span class="title">checkUriPermission</span><span class="params">(Uri uri, <span class="keyword">int</span> pid, <span class="keyword">int</span> uid, <span class="keyword">int</span> mode, <span class="keyword">int</span> userId,</span></span></span><br><span class="line"><span class="function"><span class="params">        IBinder callerToken)</span> <span class="keyword">throws</span> RemoteException </span>&#123;</span><br><span class="line">    Parcel data = Parcel.obtain();</span><br><span class="line">    Parcel reply = Parcel.obtain();</span><br><span class="line">    data.writeInterfaceToken(IActivityManager.descriptor);</span><br><span class="line">    uri.writeToParcel(data, <span class="number">0</span>);</span><br><span class="line">    data.writeInt(pid);</span><br><span class="line">    data.writeInt(uid);</span><br><span class="line">    data.writeInt(mode);</span><br><span class="line">    data.writeInt(userId);</span><br><span class="line">    data.writeStrongBinder(callerToken);</span><br><span class="line">    mRemote.transact(CHECK_URI_PERMISSION_TRANSACTION, data, reply, <span class="number">0</span>);</span><br><span class="line">    reply.readException();</span><br><span class="line">    <span class="keyword">int</span> res = reply.readInt();</span><br><span class="line">    data.recycle();</span><br><span class="line">    reply.recycle();</span><br><span class="line">    <span class="keyword">return</span> res;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<ul>
<li><strong>ActivityManagerNative</strong></li>
</ul>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">case</span> CHECK_URI_PERMISSION_TRANSACTION: &#123;</span><br><span class="line">    data.enforceInterface(IActivityManager.descriptor);</span><br><span class="line">    Uri uri = Uri.CREATOR.createFromParcel(data);</span><br><span class="line">    <span class="keyword">int</span> pid = data.readInt();</span><br><span class="line">    <span class="keyword">int</span> uid = data.readInt();</span><br><span class="line">    <span class="keyword">int</span> mode = data.readInt();</span><br><span class="line">    <span class="keyword">int</span> userId = data.readInt();</span><br><span class="line">    IBinder callerToken = data.readStrongBinder();</span><br><span class="line">    <span class="comment">//【*1.9】继续调用；</span></span><br><span class="line">    <span class="keyword">int</span> res = checkUriPermission(uri, pid, uid, mode, userId, callerToken);</span><br><span class="line">    reply.writeNoException();</span><br><span class="line">    reply.writeInt(res);</span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">true</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h2 id="2-10-checkUriPermissionLocked"><a href="#2-10-checkUriPermissionLocked" class="headerlink" title="2.10 checkUriPermissionLocked"></a>2.10 checkUriPermissionLocked</h2><p>用于检查 uid 是否已经被授予uri permissions！</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">final</span> <span class="keyword">boolean</span> <span class="title">checkUriPermissionLocked</span><span class="params">(GrantUri grantUri, <span class="keyword">int</span> uid,</span></span></span><br><span class="line"><span class="function"><span class="params">        <span class="keyword">final</span> <span class="keyword">int</span> modeFlags)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">final</span> <span class="keyword">boolean</span> persistable = (modeFlags &amp; Intent.FLAG_GRANT_PERSISTABLE_URI_PERMISSION) != <span class="number">0</span>;</span><br><span class="line">    <span class="keyword">final</span> <span class="keyword">int</span> minStrength = persistable ? UriPermission.STRENGTH_PERSISTABLE</span><br><span class="line">            : UriPermission.STRENGTH_OWNED;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//【1】如果 uid 是 0，为 root 用户，默认是授予，返回 true！</span></span><br><span class="line">    <span class="keyword">if</span> (uid == <span class="number">0</span>) &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">true</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">//【2】获得 uid 已经被授予的 UriPermission，如果没有，返回 false，表示没有授予权限！！</span></span><br><span class="line">    <span class="keyword">final</span> ArrayMap&lt;GrantUri, UriPermission&gt; perms = mGrantedUriPermissions.get(uid);</span><br><span class="line">    <span class="keyword">if</span> (perms == <span class="keyword">null</span>) <span class="keyword">return</span> <span class="keyword">false</span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//【3】精确匹配 uri！</span></span><br><span class="line">    <span class="keyword">final</span> UriPermission exactPerm = perms.get(grantUri);</span><br><span class="line">    <span class="keyword">if</span> (exactPerm != <span class="keyword">null</span> &amp;&amp; exactPerm.getStrength(modeFlags) &gt;= minStrength) &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">true</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//【4】前缀匹配 uri！</span></span><br><span class="line">    <span class="keyword">final</span> <span class="keyword">int</span> N = perms.size();</span><br><span class="line">    <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; N; i++) &#123;</span><br><span class="line">        <span class="keyword">final</span> UriPermission perm = perms.valueAt(i);</span><br><span class="line">        <span class="keyword">if</span> (perm.uri.prefix &amp;&amp; grantUri.uri.isPathPrefixMatch(perm.uri.uri)</span><br><span class="line">                &amp;&amp; perm.getStrength(modeFlags) &gt;= minStrength) &#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="keyword">true</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">false</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>对于 modeFlags，除了能设置上面的 2 个标志之外，还可以设置下面的标志位：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">Intent.FLAG_GRANT_PERSISTABLE_URI_PERMISSION</span><br></pre></td></tr></table></figure>
<p>FLAG_GRANT_READ_URI_PERMISSION 跟 FLAG_GRANT_WRITE_URI_PERMISSION 是用于授予临时权限，如果和 FLAG_GRANT_PERSISTABLE_URI_PERMISSION 结合使用，URI 权限会持久存在，重启也无法撤消，直到明确的用 revokeUriPermission(Uri, int) 撤销。 </p>
<p>这个 flag 只提供可能持久授权。但是接收的应用必须调用 ContentResolver.takePersistableUriPermission(Uri, int) 方法实现 。</p>
<h3 id="2-10-1-调用时机"><a href="#2-10-1-调用时机" class="headerlink" title="2.10.1 调用时机"></a>2.10.1 调用时机</h3><p>该方法的调用比较少，在 ActivityManagerService 中：</p>
<ul>
<li>一个是 2.9 checkUriPermission 方法中；</li>
<li>一个是 2.10 checkUriPermissionLocked 方法中；</li>
</ul>
<h2 id="2-11-checkPermissionWithToken"><a href="#2-11-checkPermissionWithToken" class="headerlink" title="2.11 checkPermissionWithToken"></a>2.11 checkPermissionWithToken</h2><p>检查 IBinder 对象对应的进程是否具有指定权限！</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">int</span> <span class="title">checkPermissionWithToken</span><span class="params">(String permission, <span class="keyword">int</span> pid, <span class="keyword">int</span> uid, IBinder callerToken)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">if</span> (permission == <span class="keyword">null</span>) &#123;</span><br><span class="line">        <span class="keyword">return</span> PackageManager.PERMISSION_DENIED;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//【1】计算 IBinder 对象对应的进程的 pid 和 uid！</span></span><br><span class="line">    Identity tlsIdentity = sCallerIdentity.get();</span><br><span class="line">    <span class="keyword">if</span> (tlsIdentity != <span class="keyword">null</span> &amp;&amp; tlsIdentity.token == callerToken) &#123;</span><br><span class="line">        Slog.d(TAG, <span class="string">"checkComponentPermission() adjusting &#123;pid,uid&#125; to &#123;"</span></span><br><span class="line">                + tlsIdentity.pid + <span class="string">","</span> + tlsIdentity.uid + <span class="string">"&#125;"</span>);</span><br><span class="line">        uid = tlsIdentity.uid;</span><br><span class="line">        pid = tlsIdentity.pid;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">//【*2.12】调用 checkComponentPermission 方法，继续检查：</span></span><br><span class="line">    <span class="keyword">return</span> checkComponentPermission(permission, pid, uid, -<span class="number">1</span>, <span class="keyword">true</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h3 id="2-11-1-跨进程调用"><a href="#2-11-1-跨进程调用" class="headerlink" title="2.11.1 跨进程调用"></a>2.11.1 跨进程调用</h3><p>调用方法：<br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">try</span> &#123;</span><br><span class="line">    ActivityManagerNative.getDefault().checkPermissionWithToken(...);</span><br><span class="line">&#125; <span class="keyword">catch</span> (RemoteException e) &#123;</span><br><span class="line">    <span class="keyword">throw</span> e.rethrowFromSystemServer();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>具体流程：</p>
<ul>
<li><strong>ActivityManagerProxy</strong></li>
</ul>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">int</span> <span class="title">checkPermissionWithToken</span><span class="params">(String permission, <span class="keyword">int</span> pid, <span class="keyword">int</span> uid, IBinder callerToken)</span></span></span><br><span class="line"><span class="function">        <span class="keyword">throws</span> RemoteException </span>&#123;</span><br><span class="line">    Parcel data = Parcel.obtain();</span><br><span class="line">    Parcel reply = Parcel.obtain();</span><br><span class="line">    data.writeInterfaceToken(IActivityManager.descriptor);</span><br><span class="line">    data.writeString(permission);</span><br><span class="line">    data.writeInt(pid);</span><br><span class="line">    data.writeInt(uid);</span><br><span class="line">    data.writeStrongBinder(callerToken);</span><br><span class="line">    mRemote.transact(CHECK_PERMISSION_WITH_TOKEN_TRANSACTION, data, reply, <span class="number">0</span>);</span><br><span class="line">    reply.readException();</span><br><span class="line">    <span class="keyword">int</span> res = reply.readInt();</span><br><span class="line">    data.recycle();</span><br><span class="line">    reply.recycle();</span><br><span class="line">    <span class="keyword">return</span> res;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<ul>
<li><strong>ActivityManagerNative</strong></li>
</ul>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">case</span> CHECK_PERMISSION_WITH_TOKEN_TRANSACTION: &#123;</span><br><span class="line">    data.enforceInterface(IActivityManager.descriptor);</span><br><span class="line">    String perm = data.readString();</span><br><span class="line">    <span class="keyword">int</span> pid = data.readInt();</span><br><span class="line">    <span class="keyword">int</span> uid = data.readInt();</span><br><span class="line">    IBinder token = data.readStrongBinder();</span><br><span class="line">    <span class="comment">//【*2.11】继续调用；</span></span><br><span class="line">    <span class="keyword">int</span> res = checkPermissionWithToken(perm, pid, uid, token);</span><br><span class="line">    reply.writeNoException();</span><br><span class="line">    reply.writeInt(res);</span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">true</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h2 id="2-12-checkComponentPermission"><a href="#2-12-checkComponentPermission" class="headerlink" title="2.12 checkComponentPermission"></a>2.12 checkComponentPermission</h2><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">checkComponentPermission</span><span class="params">(String permission, <span class="keyword">int</span> pid, <span class="keyword">int</span> uid,</span></span></span><br><span class="line"><span class="function"><span class="params">        <span class="keyword">int</span> owningUid, <span class="keyword">boolean</span> exported)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">if</span> (pid == MY_PID) &#123; <span class="comment">// 如果是进程自身，是持有权限的！</span></span><br><span class="line">        <span class="keyword">return</span> PackageManager.PERMISSION_GRANTED;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">//【*2.12.1】调用 ActivityManager 的 checkComponentPermission 方法！</span></span><br><span class="line">    <span class="keyword">return</span> ActivityManager.checkComponentPermission(permission, uid,</span><br><span class="line">            owningUid, exported);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h3 id="2-12-1-ActivityM-checkComponentPermission"><a href="#2-12-1-ActivityM-checkComponentPermission" class="headerlink" title="2.12.1 ActivityM.checkComponentPermission"></a>2.12.1 ActivityM.checkComponentPermission</h3><p>这个方法是一个 hide 方法，只能由系统调用！</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/** <span class="doctag">@hide</span> */</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">int</span> <span class="title">checkComponentPermission</span><span class="params">(String permission, <span class="keyword">int</span> uid,</span></span></span><br><span class="line"><span class="function"><span class="params">        <span class="keyword">int</span> owningUid, <span class="keyword">boolean</span> exported)</span> </span>&#123;</span><br><span class="line">    <span class="comment">//【1】如果是 root 用户或者 system 用户，</span></span><br><span class="line">    <span class="keyword">final</span> <span class="keyword">int</span> appId = UserHandle.getAppId(uid);</span><br><span class="line">    <span class="keyword">if</span> (appId == Process.ROOT_UID || appId == Process.SYSTEM_UID) &#123;</span><br><span class="line">        <span class="keyword">return</span> PackageManager.PERMISSION_GRANTED;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">//【2】隔离进程无权限！</span></span><br><span class="line">    <span class="keyword">if</span> (UserHandle.isIsolated(uid)) &#123;</span><br><span class="line">        <span class="keyword">return</span> PackageManager.PERMISSION_DENIED;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">//【3】如果是相同 uid，有权限！</span></span><br><span class="line">    <span class="keyword">if</span> (owningUid &gt;= <span class="number">0</span> &amp;&amp; UserHandle.isSameApp(uid, owningUid)) &#123;</span><br><span class="line">        <span class="keyword">return</span> PackageManager.PERMISSION_GRANTED;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">//【4】如果组件不是暴露的，那就无权限！</span></span><br><span class="line">    <span class="keyword">if</span> (!exported) &#123;</span><br><span class="line">        <span class="comment">/*</span></span><br><span class="line"><span class="comment">        RuntimeException here = new RuntimeException("here");</span></span><br><span class="line"><span class="comment">        here.fillInStackTrace();</span></span><br><span class="line"><span class="comment">        Slog.w(TAG, "Permission denied: checkComponentPermission() owningUid=" + owningUid,</span></span><br><span class="line"><span class="comment">                here);</span></span><br><span class="line"><span class="comment">        */</span></span><br><span class="line">        <span class="keyword">return</span> PackageManager.PERMISSION_DENIED;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span> (permission == <span class="keyword">null</span>) &#123;</span><br><span class="line">        <span class="keyword">return</span> PackageManager.PERMISSION_GRANTED;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">//【*3.1】调用 pms 的 checkUidPermission 方法继续检查权限！</span></span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> AppGlobals.getPackageManager()</span><br><span class="line">                .checkUidPermission(permission, uid);</span><br><span class="line">    &#125; <span class="keyword">catch</span> (RemoteException e) &#123;</span><br><span class="line">        <span class="keyword">throw</span> e.rethrowFromSystemServer();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h3 id="2-12-2-ActivityM-checkUidPermission"><a href="#2-12-2-ActivityM-checkUidPermission" class="headerlink" title="2.12.2 ActivityM.checkUidPermission"></a>2.12.2 ActivityM.checkUidPermission</h3><p>同时 ActivityManager 也有 checkUidPermission 方法，这方法是一个 hide 方法，只能由系统调用！</p>
<p>该方法会直接访问 pms 的接口！</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/** <span class="doctag">@hide</span> */</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">int</span> <span class="title">checkUidPermission</span><span class="params">(String permission, <span class="keyword">int</span> uid)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">        <span class="comment">//【*3.1】调用 pms 的 checkUidPermission 方法继续检查权限！</span></span><br><span class="line">        <span class="keyword">return</span> AppGlobals.getPackageManager()</span><br><span class="line">                .checkUidPermission(permission, uid);</span><br><span class="line">    &#125; <span class="keyword">catch</span> (RemoteException e) &#123;</span><br><span class="line">        <span class="keyword">throw</span> e.rethrowFromSystemServer();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h1 id="3-权限检查关键接口-PackageManagerService"><a href="#3-权限检查关键接口-PackageManagerService" class="headerlink" title="3 权限检查关键接口 - PackageManagerService"></a>3 权限检查关键接口 - PackageManagerService</h1><p>通过分析系统中的一些 checkPermissions 接口，我们发现最终都调用了 PackageManagerService.checkUidPermission 方法，下面我们去看下：</p>
<h2 id="3-1-checkUidPermission"><a href="#3-1-checkUidPermission" class="headerlink" title="3.1 checkUidPermission"></a>3.1 checkUidPermission</h2><p>用于检查 uid 是否具有权限 permName！</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">int</span> <span class="title">checkUidPermission</span><span class="params">(String permName, <span class="keyword">int</span> uid)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">final</span> <span class="keyword">int</span> userId = UserHandle.getUserId(uid);</span><br><span class="line">    <span class="comment">//【1】首先是校验 userId 有效性！</span></span><br><span class="line">    <span class="keyword">if</span> (!sUserManager.exists(userId)) &#123;</span><br><span class="line">        <span class="keyword">return</span> PackageManager.PERMISSION_DENIED;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">synchronized</span> (mPackages) &#123;</span><br><span class="line">        <span class="comment">//【2】尝试根据 uid 获得其 PackageSetting 或者 SharedUserSetting 对象，这取决于 uid 是独立还是共享的！</span></span><br><span class="line">        Object obj = mSettings.getUserIdLPr(UserHandle.getAppId(uid));</span><br><span class="line">        <span class="keyword">if</span> (obj != <span class="keyword">null</span>) &#123;</span><br><span class="line">            <span class="keyword">final</span> SettingBase ps = (SettingBase) obj;</span><br><span class="line">            <span class="comment">//【2.1】获得权限管理对象 PermissionsState！</span></span><br><span class="line">            <span class="keyword">final</span> PermissionsState permissionsState = ps.getPermissionsState();</span><br><span class="line">            <span class="comment">// 如果该权限确实授予了该 uid，返回 PackageManager.PERMISSION_GRANTED！</span></span><br><span class="line">            <span class="keyword">if</span> (permissionsState.hasPermission(permName, userId)) &#123;</span><br><span class="line">                <span class="keyword">return</span> PackageManager.PERMISSION_GRANTED;</span><br><span class="line">            &#125;</span><br><span class="line">            </span><br><span class="line">            <span class="comment">//【2.2】这里是处理一种特殊的权限！</span></span><br><span class="line">            <span class="keyword">if</span> (Manifest.permission.ACCESS_COARSE_LOCATION.equals(permName) &amp;&amp; permissionsState</span><br><span class="line">                    .hasPermission(Manifest.permission.ACCESS_FINE_LOCATION, userId)) &#123;</span><br><span class="line">                <span class="keyword">return</span> PackageManager.PERMISSION_GRANTED;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            <span class="comment">//【3】mSystemPermissions 中保存的是系统 uid 和其权限的对应关系！</span></span><br><span class="line">            ArraySet&lt;String&gt; perms = mSystemPermissions.get(uid);</span><br><span class="line">            <span class="keyword">if</span> (perms != <span class="keyword">null</span>) &#123;</span><br><span class="line">                <span class="keyword">if</span> (perms.contains(permName)) &#123;</span><br><span class="line">                    <span class="keyword">return</span> PackageManager.PERMISSION_GRANTED;</span><br><span class="line">                &#125;</span><br><span class="line">                <span class="keyword">if</span> (Manifest.permission.ACCESS_COARSE_LOCATION.equals(permName) &amp;&amp; perms</span><br><span class="line">                        .contains(Manifest.permission.ACCESS_FINE_LOCATION)) &#123;</span><br><span class="line">                    <span class="keyword">return</span> PackageManager.PERMISSION_GRANTED;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> PackageManager.PERMISSION_DENIED;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>我们来看下 getUserIdLPr 方法的逻辑：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> Object <span class="title">getUserIdLPr</span><span class="params">(<span class="keyword">int</span> uid)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">if</span> (uid &gt;= Process.FIRST_APPLICATION_UID) &#123;</span><br><span class="line">        <span class="keyword">final</span> <span class="keyword">int</span> N = mUserIds.size();</span><br><span class="line">        <span class="keyword">final</span> <span class="keyword">int</span> index = uid - Process.FIRST_APPLICATION_UID;</span><br><span class="line">        <span class="keyword">return</span> index &lt; N ? mUserIds.get(index) : <span class="keyword">null</span>;</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> mOtherUserIds.get(uid);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<ul>
<li><strong>uid 的取值范围</strong>：</li>
</ul>
<p>从 Process.FIRST_APPLICATION_UID（10000） 开始的 uid 是普通 Android 的应用程序，即使用户安装的应用程序，最大值为 Process.LAST_APPLICATION_UID（19999）！</p>
<p>而 Process.FIRST_APPLICATION_UID 以下的 uid 都是系统应用和系统进程的！</p>
<ul>
<li><strong>PackageSetting 和 SharedUserSetting</strong>：</li>
</ul>
<p>如果应用程序是独立 uid 的话，那么其会有一个 PackageSetting 对象，然后会根据其 uid 的类型，添加到 mUserIds 或者 mOtherUserIds；</p>
<p>如果应用程序是共享 uid 的话，除了会创建 PackageSetting 对象，还会创建一个 SharedUserSetting 对象，用来封装共享 uid 的信息 ，然后会根据其 uid 的类型，将 SharedUserSetting 对象添加到 mUserIds 或者 mOtherUserIds；</p>
<ul>
<li><strong>权限的处理</strong>：</li>
</ul>
<p>如果应用是独立 uid 的话，那么 getUserIdLPr 返回是 PackageSetting 对象！</p>
<p>如果应用是共享 uid 的话，那么 getUserIdLPr 返回的是 SharedUserSetting 对象，这是因为共享同一个 uid 的应用持有相同的权限！</p>
<p>PackageSetting 和 SharedUserSetting 都有一个 PermissionsState 对象，用于封装 package 在不同 userId 下的权限授予情况！</p>
<h2 id="3-2-checkPermission"><a href="#3-2-checkPermission" class="headerlink" title="3.2 checkPermission"></a>3.2 checkPermission</h2><p>PMS 还有另外一个用于检查权限的方法，判断包名对应的应用程序是否有权限！</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">int</span> <span class="title">checkPermission</span><span class="params">(String permName, String pkgName, <span class="keyword">int</span> userId)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">if</span> (!sUserManager.exists(userId)) &#123;</span><br><span class="line">        <span class="keyword">return</span> PackageManager.PERMISSION_DENIED;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">synchronized</span> (mPackages) &#123;</span><br><span class="line">        <span class="comment">//【1】获得该 pkg 对应的 Package 实例！</span></span><br><span class="line">        <span class="keyword">final</span> PackageParser.Package p = mPackages.get(pkgName);</span><br><span class="line">        <span class="keyword">if</span> (p != <span class="keyword">null</span> &amp;&amp; p.mExtras != <span class="keyword">null</span>) &#123;</span><br><span class="line">            <span class="keyword">final</span> PackageSetting ps = (PackageSetting) p.mExtras;</span><br><span class="line">            <span class="keyword">final</span> PermissionsState permissionsState = ps.getPermissionsState();</span><br><span class="line">            <span class="comment">//【1.1】判断 permissionsState 中该权限状态是否是 true！</span></span><br><span class="line">            <span class="keyword">if</span> (permissionsState.hasPermission(permName, userId)) &#123;</span><br><span class="line">                <span class="keyword">return</span> PackageManager.PERMISSION_GRANTED;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="comment">//【1.2】对于 ACCESS_COARSE_LOCATION 比较特殊，如果应用已经有了 ACCESS_FINE_LOCATION</span></span><br><span class="line">            <span class="comment">// 那么应用也会有 ACCESS_COARSE_LOCATION 权限！</span></span><br><span class="line">            <span class="keyword">if</span> (Manifest.permission.ACCESS_COARSE_LOCATION.equals(permName) &amp;&amp; permissionsState</span><br><span class="line">                    .hasPermission(Manifest.permission.ACCESS_FINE_LOCATION, userId)) &#123;</span><br><span class="line">                <span class="keyword">return</span> PackageManager.PERMISSION_GRANTED;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> PackageManager.PERMISSION_DENIED;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>该方法用于判断 pkgName 在 userId 下，是否有权限 permName！</p>
<h3 id="3-2-1-调用时机"><a href="#3-2-1-调用时机" class="headerlink" title="3.2.1 调用时机"></a>3.2.1 调用时机</h3><p>PMS 的接口可以被其他 check 接口调用，同时我们也可以直接调用其进行权限检查：</p>
<h4 id="3-2-1-1-BroadcastQueue-processNextBroadcast"><a href="#3-2-1-1-BroadcastQueue-processNextBroadcast" class="headerlink" title="3.2.1.1 BroadcastQueue.processNextBroadcast"></a>3.2.1.1 BroadcastQueue.processNextBroadcast</h4><p>在我们发送广播的时候，如果广播指定了接收者的权限，那么我们会校验</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">final</span> <span class="keyword">void</span> <span class="title">processNextBroadcast</span><span class="params">(<span class="keyword">boolean</span> fromMsg)</span> </span>&#123;</span><br><span class="line">    ... ... ...</span><br><span class="line">       <span class="keyword">if</span> (!skip &amp;&amp; info.activityInfo.applicationInfo.uid != Process.SYSTEM_UID &amp;&amp;</span><br><span class="line">            r.requiredPermissions != <span class="keyword">null</span> &amp;&amp; r.requiredPermissions.length &gt; <span class="number">0</span>) &#123;</span><br><span class="line">            <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; r.requiredPermissions.length; i++) &#123;</span><br><span class="line">                String requiredPermission = r.requiredPermissions[i];</span><br><span class="line">                <span class="keyword">try</span> &#123;</span><br><span class="line">                    perm = AppGlobals.getPackageManager().</span><br><span class="line">                            checkPermission(requiredPermission,</span><br><span class="line">                                    info.activityInfo.applicationInfo.packageName,</span><br><span class="line">                                    UserHandle</span><br><span class="line">                                            .getUserId(info.activityInfo.applicationInfo.uid));</span><br><span class="line">                &#125; <span class="keyword">catch</span> (RemoteException e) &#123;</span><br><span class="line">                    perm = PackageManager.PERMISSION_DENIED;</span><br><span class="line">                &#125;</span><br><span class="line">                ... ... ...</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    ... ... ...</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
</div></article><div class="post-copyright"><div class="post-copyright__author"><span class="post-copyright-meta">文章作者: </span><span class="post-copyright-info"><a href="mailto:undefined">Coolqi.Li</a></span></div><div class="post-copyright__type"><span class="post-copyright-meta">文章链接: </span><span class="post-copyright-info"><a href="https://coolqi.top/2017/07/06/Permission3-checkPermissions/">https://coolqi.top/2017/07/06/Permission3-checkPermissions/</a></span></div><div class="post-copyright__notice"><span class="post-copyright-meta">版权声明: </span><span class="post-copyright-info">本博客所有文章除特别声明外，均采用 <a href="https://creativecommons.org/licenses/by-nc-sa/4.0/">CC BY-NC-SA 4.0</a> 许可协议。转载请注明来自 <a href="https://coolqi.top">Coolqi`s Blog</a>！</span></div></div><div class="post-meta__tag-list"><a class="post-meta__tags" href="/tags/Permission权限管理/">Permission权限管理</a></div><div class="post-qr-code"><div class="post-qr-code-item"><img class="post-qr-code__img" src="/img/zfb.jpg"><div class="post-qr-code__desc">支付宝打赏</div></div><div class="post-qr-code-item"><img class="post-qr-code__img" src="/img/wechat.jpg"><div class="post-qr-code__desc">微信打赏</div></div></div><div class="social-share"></div><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/social-share.js@1.0.16/dist/css/share.min.css"><script src="https://cdn.jsdelivr.net/npm/social-share.js@1.0.16/dist/js/social-share.min.js"></script><nav id="pagination"><div class="prev-post pull-left"><a href="/2017/07/25/AlarmManager2-setAlarm/"><i class="fa fa-chevron-left">  </i><span>AlarmManager第 2 篇 - set Alarm 流程分析</span></a></div><div class="next-post pull-right"><a href="/2017/05/23/AlarmManager1-AlarmManagerServiceStartProcess/"><span>AlarmManager第 1 篇 - AlarmManagerService启动</span><i class="fa fa-chevron-right"></i></a></div></nav><div class="post-adv"><a href="https://www.vultr.com/?ref=7231808"><img src="https://www.vultr.com/media/banner_1.png" width="728" height="90"></a></div></div></div><footer><div class="layout" id="footer"><div class="copyright">&copy;2015 - 2019 By Coolqi.Li</div><div class="framework-info"><span>驱动 - </span><a href="http://hexo.io"><span>Hexo</span></a><span class="footer-separator">|</span><span>主题 - </span><a href="https://github.com/Molunerfinn/hexo-theme-melody"><span>Melody</span></a></div><div class="footer_custom_text">Hi, welcome to my <a href="https://lishuaiqi.top/">blog</a>!</div><div class="busuanzi"><script async src="https://busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script><span id="busuanzi_container_page_pv"><i class="fa fa-file-o"></i><span id="busuanzi_value_page_pv"></span><span></span></span></div></div></footer><i class="fa fa-arrow-up" id="go-up" aria-hidden="true"></i><script src="/js/third-party/anime.min.js"></script><script src="/js/third-party/jquery.min.js"></script><script src="/js/third-party/jquery.fancybox.min.js"></script><script src="/js/third-party/velocity.min.js"></script><script src="/js/third-party/velocity.ui.min.js"></script><script src="/js/utils.js?version=1.5.6"></script><script src="/js/fancybox.js?version=1.5.6"></script><script src="/js/sidebar.js?version=1.5.6"></script><script src="/js/copy.js?version=1.5.6"></script><script src="/js/fireworks.js?version=1.5.6"></script><script src="/js/transition.js?version=1.5.6"></script><script src="/js/scroll.js?version=1.5.6"></script><script src="/js/head.js?version=1.5.6"></script><script type="text/x-mathjax-config">MathJax.Hub.Config({
  tex2jax: {
    inlineMath: [ ['$','$'], ["\\(","\\)"]  ],
    processEscapes: true,
    skipTags: ['script', 'noscript', 'style', 'textarea', 'pre', 'code']
  },
  CommonHTML: {
    linebreaks: { automatic: true, width: "90% container" }
  },
  "HTML-CSS": { 
    linebreaks: { automatic: true, width: "90% container" }
  },
  "SVG": { 
    linebreaks: { automatic: true, width: "90% container" }
  }
});
</script><script type="text/x-mathjax-config">MathJax.Hub.Queue(function() {
  var all = MathJax.Hub.getAllJax(), i;
  for (i=0; i < all.length; i += 1) {
    all[i].SourceElement().parentNode.className += ' has-jax';
  }
});
</script><script src="https://cdn.jsdelivr.net/npm/mathjax/MathJax.js?config=TeX-AMS-MML_HTMLorMML"></script><script src="/js/search/local-search.js"></script><div class="search-dialog" id="local-search"><div class="search-dialog__title" id="local-search-title">本地搜索</div><div id="local-input-panel"><div id="local-search-input"><div class="local-search-box"><input class="local-search-box--input" placeholder="搜索文章"></div></div></div><hr><div id="local-search-results"><div id="local-hits"></div><div id="local-stats"><div class="local-search-stats__hr" id="hr"><span>由</span> <a href="https://github.com/wzpan/hexo-generator-search" style="color:#49B1F5;">hexo-generator-search</a>
 <span>提供支持</span></div></div></div><span class="search-close-button"><i class="fa fa-times"></i></span></div><div class="search-mask"></div><script src="/live2dw/lib/L2Dwidget.min.js?0c58a1486de42ac6cc1c59c7d98ae887"></script><script>L2Dwidget.init({"pluginRootPath":"live2dw/","pluginJsPath":"lib/","pluginModelPath":"assets/","tagMode":false,"debug":false,"model":{"jsonPath":"live2d-widget-model-hijiki"},"display":{"position":"right","width":110,"height":220},"mobile":{"show":false},"log":false});</script></body></html>
<!DOCTYPE html><html lang="zh-Hans"><head><meta charset="UTF-8"><meta http-equiv="X-UA-Compatible" content="IE=edge"><meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1"><meta name="description" content="Permission第 1 篇 - Permission 配置和解析"><meta name="keywords" content="Permission权限管理"><meta name="author" content="Coolqi.Li,undefined"><meta name="copyright" content="Coolqi.Li"><title>Permission第 1 篇 - Permission 配置和解析 | Coolqi`s Blog</title><link rel="shortcut icon" href="/img/favicon.ico"><link rel="stylesheet" href="/css/index.css?version=1.5.6"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/font-awesome@4.7.0/css/font-awesome.min.css?version=1.5.6"><link rel="dns-prefetch" href="https://cdn.staticfile.org"><link rel="dns-prefetch" href="https://cdn.bootcss.com"><link rel="dns-prefetch" href="https://creativecommons.org"><script>var GLOBAL_CONFIG = { 
  root: '/',
  algolia: undefined,
  localSearch: {"path":"search.xml","languages":{"hits_empty":"找不到您查询的内容:${query}"}},
  copy: {
    success: '复制成功',
    error: '复制错误',
    noSupport: '浏览器不支持'
  }
} </script></head><body><canvas class="fireworks"></canvas><i class="fa fa-arrow-right" id="toggle-sidebar" aria-hidden="true"></i><div id="sidebar"><div class="toggle-sidebar-info text-center"><span data-toggle="切换文章详情">切换站点概览</span><hr></div><div class="sidebar-toc"><div class="sidebar-toc__title">目录</div><div class="sidebar-toc__progress"><span class="progress-notice">你已经读了</span><span class="progress-num">0</span><span class="progress-percentage">%</span><div class="sidebar-toc__progress-bar"></div></div><div class="sidebar-toc__content"><ol class="toc"><li class="toc-item toc-level-1"><a class="toc-link" href="#0-综述"><span class="toc-text">0 综述</span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#1-Application-的权限配置和解析"><span class="toc-text">1 Application 的权限配置和解析</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#1-1-权限配置"><span class="toc-text">1.1 权限配置</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#1-1-1-manifest-配置"><span class="toc-text">1.1.1 manifest 配置</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#1-1-2-application-配置"><span class="toc-text">1.1.2 application 配置</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#1-2-权限解析"><span class="toc-text">1.2 权限解析</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#1-2-1-PackageParser-parseBaseApkCommon"><span class="toc-text">1.2.1 PackageParser.parseBaseApkCommon</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#1-2-1-1-PackageP-parsePermissionGroup"><span class="toc-text">1.2.1.1 PackageP.parsePermissionGroup</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#1-2-1-2-PackageP-parsePermission"><span class="toc-text">1.2.1.2 PackageP.parsePermission</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#1-2-1-3-PackageP-parsePermissionTree"><span class="toc-text">1.2.1.3 PackageP.parsePermissionTree</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#1-2-1-4-PackageP-parseUsesPermission"><span class="toc-text">1.2.1.4 PackageP.parseUsesPermission</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#1-2-2-PackageParser-parseBaseApplication"><span class="toc-text">1.2.2 PackageParser.parseBaseApplication</span></a></li></ol></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#2-Activity-的权限配置和解析"><span class="toc-text">2 Activity 的权限配置和解析</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#2-1-权限配置"><span class="toc-text">2.1 权限配置</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#2-2-权限解析"><span class="toc-text">2.2 权限解析</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#2-2-1-PackageParser-parseActivity"><span class="toc-text">2.2.1 PackageParser.parseActivity</span></a></li></ol></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#3-Service-的权限配置和解析"><span class="toc-text">3 Service 的权限配置和解析</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#3-1-权限配置"><span class="toc-text">3.1 权限配置</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#3-2-权限解析"><span class="toc-text">3.2 权限解析</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#3-2-1-PackageParser-parseService"><span class="toc-text">3.2.1 PackageParser.parseService</span></a></li></ol></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#4-Receiver-的权限配置和解析"><span class="toc-text">4 Receiver 的权限配置和解析</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#4-1-权限配置"><span class="toc-text">4.1 权限配置</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#4-2-权限解析"><span class="toc-text">4.2 权限解析</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#4-2-1-PackageParser-parseActivity"><span class="toc-text">4.2.1 PackageParser.parseActivity</span></a></li></ol></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#5-Provider-的权限配置和解析"><span class="toc-text">5 Provider 的权限配置和解析</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#5-1-权限配置"><span class="toc-text">5.1 权限配置</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#5-1-1-android-exported"><span class="toc-text">5.1.1 android:exported</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#5-1-2-android-permission"><span class="toc-text">5.1.2 android:permission</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#5-1-3-android-readPermission"><span class="toc-text">5.1.3 android:readPermission</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#5-1-4-android-writePermission"><span class="toc-text">5.1.4 android:writePermission</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#5-1-5-android-grantUriPermissions"><span class="toc-text">5.1.5 android:grantUriPermissions</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#5-1-6-provider-子标签"><span class="toc-text">5.1.6 provider 子标签</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#5-1-6-1-grant-uri-permission"><span class="toc-text">5.1.6.1 grant-uri-permission</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#5-1-6-2-path-permission"><span class="toc-text">5.1.6.2 path-permission</span></a></li></ol></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#5-2-权限解析"><span class="toc-text">5.2 权限解析</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#5-2-1-PackageParser-parseProvider"><span class="toc-text">5.2.1 PackageParser.parseProvider</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#5-2-2-PackageParser-parseProviderTags"><span class="toc-text">5.2.2 PackageParser.parseProviderTags</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#5-2-2-1-解析-grant-uri-permission"><span class="toc-text">5.2.2.1 解析 grant-uri-permission</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#5-2-2-2-解析-patch-permission"><span class="toc-text">5.2.2.2 解析 patch-permission</span></a></li></ol></li></ol></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#6-权限知识点总结"><span class="toc-text">6 权限知识点总结</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#6-1-基本权限类型"><span class="toc-text">6.1 基本权限类型</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#6-2-附加标志位"><span class="toc-text">6.2 附加标志位</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#6-3-权限组"><span class="toc-text">6.3 权限组</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#6-4-特殊权限"><span class="toc-text">6.4 特殊权限</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#6-4-1-signature-with-appop"><span class="toc-text">6.4.1 signature with appop</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#6-4-1-signature-with-bind-service"><span class="toc-text">6.4.1 signature with bind service</span></a></li></ol></li></ol></li></ol></div></div><div class="author-info hide"><div class="author-info__avatar text-center"><img src="/img/avatar.png"></div><div class="author-info__name text-center">Coolqi.Li</div><div class="author-info__description text-center">“你好，我是李帅奇，Android 系统工程师，MineCraft 忠实玩家，设计和绘画爱好者，缺妹纸晚期患者，熬夜星人。”</div><div class="follow-button"><a href="https://github.com/li-coolqi">Follow Me</a></div><hr><div class="author-info-articles"><a class="author-info-articles__archives article-meta" href="/archives"><span class="pull-left">文章</span><span class="pull-right">63</span></a><a class="author-info-articles__tags article-meta" href="/tags"><span class="pull-left">标签</span><span class="pull-right">14</span></a><a class="author-info-articles__categories article-meta" href="/categories"><span class="pull-left">分类</span><span class="pull-right">15</span></a></div><hr><div class="author-info-links"><div class="author-info-links__title text-center">Links</div><a class="author-info-links__name text-center" href="https://molunerfinn.com">Molunerfinn</a><a class="author-info-links__name text-center" href="https://piegg.cn">PiEgg</a><a class="author-info-links__name text-center" href="https://piegg.cn">Elody</a></div></div></div><div id="content-outer"><div id="top-container" style="background-image: url(https://ws1.sinaimg.cn/large/8700af19ly1fvpabr30o6j22yo1o0q7i.jpg)"><div id="page-header"><span class="pull-left"> <a id="site-name" href="/">Coolqi`s Blog</a></span><i class="fa fa-bars toggle-menu pull-right" aria-hidden="true"></i><span class="pull-right menus"><a class="site-page social-icon search"><i class="fa fa-search"></i><span> 搜索</span></a><a class="site-page" href="/">Home</a><a class="site-page" href="/archives">Archives</a><a class="site-page" href="/tags">Tags</a><a class="site-page" href="/categories">Categories</a><a class="site-page" href="/about">About</a></span></div><div id="post-info"><div id="post-title">Permission第 1 篇 - Permission 配置和解析</div><div id="post-meta"><time class="post-meta__date"><i class="fa fa-calendar" aria-hidden="true"></i> 2017-05-09</time><span class="post-meta__separator">|</span><i class="fa fa-inbox post-meta__icon" aria-hidden="true"></i><a class="post-meta__categories" href="/categories/AndroidFramework源码分析/">AndroidFramework源码分析</a><i class="fa fa-angle-right" aria-hidden="true"></i><i class="fa fa-inbox post-meta__icon" aria-hidden="true"></i><a class="post-meta__categories" href="/categories/AndroidFramework源码分析/Permission权限管理/">Permission权限管理</a><div class="post-meta-wordcount"><span>字数总计: </span><span class="word-count">9.5k</span><span class="post-meta__separator">|</span><span>阅读时长: 41 分钟</span></div></div></div></div><div class="layout" id="content-inner"><article id="post"><div class="article-container" id="post-content"><p>[toc]</p>
<h1 id="0-综述"><a href="#0-综述" class="headerlink" title="0 综述"></a>0 综述</h1><p>基于 Android 7.1.1，分析权限管理相关知识，下面关于 xml 配置的内容来自于 Android developer 文档，在加上我自身的理解！</p>
<h1 id="1-Application-的权限配置和解析"><a href="#1-Application-的权限配置和解析" class="headerlink" title="1 Application 的权限配置和解析"></a>1 Application 的权限配置和解析</h1><h2 id="1-1-权限配置"><a href="#1-1-权限配置" class="headerlink" title="1.1 权限配置"></a>1.1 权限配置</h2><h3 id="1-1-1-manifest-配置"><a href="#1-1-1-manifest-配置" class="headerlink" title="1.1.1 manifest 配置"></a>1.1.1 manifest 配置</h3><p>和 Application 权限相关配置相关的内容主要有 2 部分：</p>
<ul>
<li>一个是在 <code>&lt;manifest&gt;&lt;/manifest&gt;</code> 中定义的和权限相关的配置；</li>
<li>一个是在 <code>&lt;application&gt;&lt;/application&gt;</code> 中定义的和权限相关的配置；</li>
</ul>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">uses-permission</span> <span class="attr">android:name</span>=<span class="string">"string"</span></span></span><br><span class="line"><span class="tag">                 <span class="attr">android:maxSdkVersion</span>=<span class="string">"integer"</span> /&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="tag">&lt;<span class="name">permission</span> <span class="attr">android:description</span>=<span class="string">"string resource"</span></span></span><br><span class="line"><span class="tag">            <span class="attr">android:icon</span>=<span class="string">"drawable resource"</span></span></span><br><span class="line"><span class="tag">            <span class="attr">android:label</span>=<span class="string">"string resource"</span></span></span><br><span class="line"><span class="tag">            <span class="attr">android:name</span>=<span class="string">"string"</span></span></span><br><span class="line"><span class="tag">            <span class="attr">android:permissionFlags</span>=<span class="string">"[costsMoney | removed | installed ]"</span></span></span><br><span class="line"><span class="tag">            <span class="attr">android:permissionGroup</span>=<span class="string">"string"</span></span></span><br><span class="line"><span class="tag">            <span class="attr">android:protectionLevel</span>=<span class="string">"[normal | dangerous | signature | ...]"</span> /&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="tag">&lt;<span class="name">permission-tree</span> <span class="attr">android:icon</span>=<span class="string">"drawable resource"</span></span></span><br><span class="line"><span class="tag">                 <span class="attr">android:label</span>=<span class="string">"string resource"</span></span></span><br><span class="line"><span class="tag">                 <span class="attr">android:name</span>=<span class="string">"string"</span> /&gt;</span></span><br><span class="line">                 </span><br><span class="line"><span class="tag">&lt;<span class="name">permission-group</span> <span class="attr">android:description</span>=<span class="string">"string resource"</span></span></span><br><span class="line"><span class="tag">                  <span class="attr">android:icon</span>=<span class="string">"drawable resource"</span></span></span><br><span class="line"><span class="tag">                  <span class="attr">android:label</span>=<span class="string">"string resource"</span></span></span><br><span class="line"><span class="tag">                  <span class="attr">android:name</span>=<span class="string">"string"</span> </span></span><br><span class="line"><span class="tag">                  <span class="attr">android:parsePermissionGroup</span>=<span class="string">"string"</span></span></span><br><span class="line"><span class="tag">                  <span class="attr">android:priority</span>=<span class="string">"string"</span> /&gt;</span></span><br></pre></td></tr></table></figure>
<p>下面我们来解释一下，每个标签的意思：</p>
<ul>
<li><strong>uses-permission</strong></li>
</ul>
<p>用来申请应用要使用的权限，包括安装时权限和运行时权限！</p>
<table>
<thead>
<tr>
<th>属性名</th>
<th style="text-align:left">解释</th>
</tr>
</thead>
<tbody>
<tr>
<td><strong>android:name</strong></td>
<td style="text-align:left">表示申请的权限名，可以是应用自身通过 <code>&lt;permission&gt;</code> 元素定义的权限、另一个应用定义的权限，或者一个标准系统权限！</td>
</tr>
<tr>
<td><strong>android:maxSdkVersion</strong></td>
<td style="text-align:left">不常用，表示应用需要申请该权限的最高 API 级别，高于这个值就无需申请权限！</td>
</tr>
</tbody>
</table>
<ul>
<li><strong>permission</strong></li>
</ul>
<p>声明一个权限，可用于限制对此应用程序或其他应用程序的特定组件或功能的访问。</p>
<table>
<thead>
<tr>
<th>属性名</th>
<th style="text-align:left">解释</th>
</tr>
</thead>
<tbody>
<tr>
<td><strong>android:description</strong></td>
<td style="text-align:left">用于显示给用户的权限描述，解释权限</td>
</tr>
<tr>
<td><strong>android:icon</strong></td>
<td style="text-align:left">表示权限的图标</td>
</tr>
<tr>
<td><strong>android:label</strong></td>
<td style="text-align:left">权限的可视化名称，用于显示给用户</td>
</tr>
<tr>
<td><strong>android:name</strong></td>
<td style="text-align:left">权限的名称，用于在代码中引用该权限，例如， <code>&lt;uses-permission&gt;</code> 元素，应用组件的 <code>android:permission</code> 属性</td>
</tr>
<tr>
<td><strong>android:permissionFlags</strong></td>
<td style="text-align:left">权限的额外标志位</td>
</tr>
<tr>
<td><strong>android:permissionGroup</strong></td>
<td style="text-align:left">权限所属权限组的名称，必须是此应用程序或其他应用程序中的 <code>&lt;permission-group&gt;</code> 元素声明的组名 。如果未设置此属性，则权限不属于组</td>
</tr>
<tr>
<td><strong>android:protectionLevel</strong></td>
<td style="text-align:left">权限保护级别，每个保护级别由基本权限类型和零个或多个标志组成。例如，”dangerous”保护级别没有标志。相反，保护级别 “signature\</td>
<td>privileged” 是”signature”基本权限类型和 “privileged”标志的组合。</td>
</tr>
</tbody>
</table>
<p>以上就是和 permission 相关的配置！</p>
<ul>
<li><strong>permission-group</strong></li>
</ul>
<p>为相关权限的逻辑分组声明一个名称。权限通过其 android:permissionGroup 属性加入权限组。权限组的所有权限会在用户界面中一起呈现。</p>
<p>其本身并未声明权限，只是申明了一个可以放置权限的类别。</p>
<table>
<thead>
<tr>
<th>属性名</th>
<th style="text-align:left">解释</th>
</tr>
</thead>
<tbody>
<tr>
<td><strong>android:description</strong></td>
<td style="text-align:left">用于显示给用户的组描述</td>
</tr>
<tr>
<td><strong>android:icon</strong></td>
<td style="text-align:left">表示权限组的图标</td>
</tr>
<tr>
<td><strong>android:label</strong></td>
<td style="text-align:left">权限组的可视化名称，用于显示给用户</td>
</tr>
<tr>
<td><strong>android:name</strong></td>
<td style="text-align:left">组的名称，用于在代码中引用该权限组，例如， <code>&lt;permission&gt;</code> 的 <code>android:android:permissionGroup</code> 属性</td>
</tr>
</tbody>
</table>
<p>继续来看：</p>
<ul>
<li><strong>permission-tree</strong></li>
</ul>
<p>权限树和权限组很类似，该标签用于声明权限树的基本名称，定义了权限树的应用程序拥有权限树名称的所有权，可以调用 PackageManager.addPermission() 向树中动态添加权限！</p>
<p>此元素本身并未声明权限，只是定义了可以动态放置权限的名称空间。</p>
<table>
<thead>
<tr>
<th>属性名</th>
<th style="text-align:left">解释</th>
</tr>
</thead>
<tbody>
<tr>
<td><strong>android:icon</strong></td>
<td style="text-align:left">表示树中所有权限的图标；</td>
</tr>
<tr>
<td><strong>android:label</strong></td>
<td style="text-align:left">用户可读的组名称；</td>
</tr>
<tr>
<td><strong>android:name</strong></td>
<td style="text-align:left">权限树的名称，为树中所有权限名称的前缀，用于在代码中引用该权限组，该名称的路径中必须包含至少两个以句点分隔的段</td>
</tr>
</tbody>
</table>
<h3 id="1-1-2-application-配置"><a href="#1-1-2-application-配置" class="headerlink" title="1.1.2 application 配置"></a>1.1.2 application 配置</h3><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">application</span></span></span><br><span class="line"><span class="tag">       <span class="attr">android:permission</span>=<span class="string">""</span> &gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">application</span>&gt;</span></span><br></pre></td></tr></table></figure>
<ul>
<li><strong>android:permission</strong></li>
</ul>
<p>permission 属性表示访问该 application 应该具有的权限！</p>
<h2 id="1-2-权限解析"><a href="#1-2-权限解析" class="headerlink" title="1.2 权限解析"></a>1.2 权限解析</h2><p>下面，我们深入到 PMS 中，看下 Application 权限信息是如何解析的，这部分从两方面来看：</p>
<ul>
<li>manifest 的属性配置解析；</li>
<li>application 的属性配置解析；</li>
</ul>
<h3 id="1-2-1-PackageParser-parseBaseApkCommon"><a href="#1-2-1-PackageParser-parseBaseApkCommon" class="headerlink" title="1.2.1 PackageParser.parseBaseApkCommon"></a>1.2.1 PackageParser.parseBaseApkCommon</h3><p>我们先来看看 manifest 的属性配置解析！</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">private</span> Package <span class="title">parseBaseApkCommon</span><span class="params">(Package pkg, Set&lt;String&gt; acceptedTags, Resources res,</span></span></span><br><span class="line"><span class="function"><span class="params">        XmlResourceParser parser, <span class="keyword">int</span> flags, String[] outError)</span> <span class="keyword">throws</span> XmlPullParserException,</span></span><br><span class="line"><span class="function">        IOException </span>&#123;</span><br><span class="line">    ... ... ... ...</span><br><span class="line"></span><br><span class="line">    <span class="keyword">int</span> outerDepth = parser.getDepth();</span><br><span class="line">    <span class="keyword">while</span> ((type = parser.next()) != XmlPullParser.END_DOCUMENT</span><br><span class="line">            &amp;&amp; (type != XmlPullParser.END_TAG || parser.getDepth() &gt; outerDepth)) &#123;</span><br><span class="line">        <span class="keyword">if</span> (type == XmlPullParser.END_TAG || type == XmlPullParser.TEXT) &#123;</span><br><span class="line">            <span class="keyword">continue</span>;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        String tagName = parser.getName();</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (acceptedTags != <span class="keyword">null</span> &amp;&amp; !acceptedTags.contains(tagName)) &#123;</span><br><span class="line">            Slog.w(TAG, <span class="string">"Skipping unsupported element under &lt;manifest&gt;: "</span></span><br><span class="line">                    + tagName + <span class="string">" at "</span> + mArchiveSourcePath + <span class="string">" "</span></span><br><span class="line">                    + parser.getPositionDescription());</span><br><span class="line">            XmlUtils.skipCurrentTag(parser);</span><br><span class="line">            <span class="keyword">continue</span>;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (tagName.equals(TAG_APPLICATION)) &#123; <span class="comment">//【1】解析 application 标签属性！</span></span><br><span class="line">            <span class="keyword">if</span> (foundApp) &#123;</span><br><span class="line">                <span class="keyword">if</span> (RIGID_PARSER) &#123;</span><br><span class="line">                    outError[<span class="number">0</span>] = <span class="string">"&lt;manifest&gt; has more than one &lt;application&gt;"</span>;</span><br><span class="line">                    mParseError = PackageManager.INSTALL_PARSE_FAILED_MANIFEST_MALFORMED;</span><br><span class="line">                    <span class="keyword">return</span> <span class="keyword">null</span>;</span><br><span class="line">                &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                    Slog.w(TAG, <span class="string">"&lt;manifest&gt; has more than one &lt;application&gt;"</span>);</span><br><span class="line">                    XmlUtils.skipCurrentTag(parser);</span><br><span class="line">                    <span class="keyword">continue</span>;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            foundApp = <span class="keyword">true</span>;</span><br><span class="line"></span><br><span class="line">            <span class="comment">//【*1.2.2】调用 parseBaseApplication 解析 application 属性！</span></span><br><span class="line">            <span class="keyword">if</span> (!parseBaseApplication(pkg, res, parser, flags, outError)) &#123;</span><br><span class="line">                <span class="keyword">return</span> <span class="keyword">null</span>;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125; <span class="keyword">else</span> <span class="keyword">if</span> (</span><br><span class="line">        </span><br><span class="line">            ... ... ...</span><br><span class="line">        </span><br><span class="line">        &#125; <span class="keyword">else</span> <span class="keyword">if</span> (tagName.equals(TAG_PERMISSION_GROUP)) &#123;</span><br><span class="line">            <span class="comment">//【*1.2.1.1】解析 permission-group 标签属性</span></span><br><span class="line">            <span class="keyword">if</span> (parsePermissionGroup(pkg, flags, res, parser, outError) == <span class="keyword">null</span>) &#123;</span><br><span class="line">                <span class="keyword">return</span> <span class="keyword">null</span>;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125; <span class="keyword">else</span> <span class="keyword">if</span> (tagName.equals(TAG_PERMISSION)) &#123;</span><br><span class="line">            <span class="comment">//【*1.2.1.2】解析 permission 标签属性</span></span><br><span class="line">            <span class="keyword">if</span> (parsePermission(pkg, res, parser, outError) == <span class="keyword">null</span>) &#123;</span><br><span class="line">                <span class="keyword">return</span> <span class="keyword">null</span>;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125; <span class="keyword">else</span> <span class="keyword">if</span> (tagName.equals(TAG_PERMISSION_TREE)) &#123; </span><br><span class="line">            <span class="comment">//【*1.2.1.3】解析 permission-tree 标签属性</span></span><br><span class="line">            <span class="keyword">if</span> (parsePermissionTree(pkg, res, parser, outError) == <span class="keyword">null</span>) &#123;</span><br><span class="line">                <span class="keyword">return</span> <span class="keyword">null</span>;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125; <span class="keyword">else</span> <span class="keyword">if</span> (tagName.equals(TAG_USES_PERMISSION)) &#123;</span><br><span class="line">            <span class="comment">//【*1.2.1.4】解析 uses-permission 标签属性</span></span><br><span class="line">            <span class="keyword">if</span> (!parseUsesPermission(pkg, res, parser)) &#123;</span><br><span class="line">                <span class="keyword">return</span> <span class="keyword">null</span>;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125; <span class="keyword">else</span> <span class="keyword">if</span> (tagName.equals(TAG_USES_PERMISSION_SDK_M)</span><br><span class="line">                || tagName.equals(TAG_USES_PERMISSION_SDK_23)) &#123; </span><br><span class="line">            <span class="comment">//【*1.2.1.4】解析 uses-permission-sdk-m/23 标签属性</span></span><br><span class="line">            <span class="keyword">if</span> (!parseUsesPermission(pkg, res, parser)) &#123;</span><br><span class="line">                <span class="keyword">return</span> <span class="keyword">null</span>;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125; <span class="keyword">else</span> <span class="keyword">if</span> (</span><br><span class="line">        </span><br><span class="line">            ... ... ... ...</span><br><span class="line">        </span><br><span class="line">        &#125; <span class="keyword">else</span> <span class="keyword">if</span> (tagName.equals(TAG_ADOPT_PERMISSIONS)) &#123;</span><br><span class="line">            <span class="comment">//【2】解析 adopt-permissions 标签</span></span><br><span class="line">            sa = res.obtainAttributes(parser, <span class="comment">// 解析源包属性</span></span><br><span class="line">                    com.android.internal.R.styleable.AndroidManifestOriginalPackage);</span><br><span class="line"></span><br><span class="line">            String name = sa.getNonConfigurationString( <span class="comment">// 解析权限名属性</span></span><br><span class="line">                    com.android.internal.R.styleable.AndroidManifestOriginalPackage_name, <span class="number">0</span>);</span><br><span class="line"></span><br><span class="line">            sa.recycle();</span><br><span class="line"></span><br><span class="line">            <span class="keyword">if</span> (name != <span class="keyword">null</span>) &#123;</span><br><span class="line">                <span class="comment">//【2.1】加入到 Package.mAdoptPermissions 集合中！</span></span><br><span class="line">                <span class="keyword">if</span> (pkg.mAdoptPermissions == <span class="keyword">null</span>) &#123;</span><br><span class="line">                    pkg.mAdoptPermissions = <span class="keyword">new</span> ArrayList&lt;String&gt;();</span><br><span class="line">                &#125;</span><br><span class="line">                pkg.mAdoptPermissions.add(name);</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            XmlUtils.skipCurrentTag(parser);</span><br><span class="line"></span><br><span class="line">        &#125; <span class="keyword">else</span> <span class="keyword">if</span> (</span><br><span class="line">        </span><br><span class="line">            ... ... ... ...</span><br><span class="line">            </span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    ... ... ... ...</span><br><span class="line"></span><br><span class="line">    <span class="comment">//【3】处理一些新添加的权限，如果当前应用的 targetSdkVersion 小于这些权限的 sdkVersion！</span></span><br><span class="line">    <span class="comment">// 我们会默认将其添加到 Package.requestedPermissions 中！</span></span><br><span class="line">    <span class="keyword">final</span> <span class="keyword">int</span> NP = PackageParser.NEW_PERMISSIONS.length;</span><br><span class="line">    StringBuilder implicitPerms = <span class="keyword">null</span>;</span><br><span class="line">    <span class="keyword">for</span> (<span class="keyword">int</span> ip = <span class="number">0</span>; ip &lt; NP; ip++) &#123;</span><br><span class="line">        <span class="keyword">final</span> PackageParser.NewPermissionInfo npi</span><br><span class="line">                = PackageParser.NEW_PERMISSIONS[ip];</span><br><span class="line">        <span class="comment">//【3.1】如果应用的 target SDK Version 高于权限的该权限的 version，不做处理</span></span><br><span class="line">        <span class="keyword">if</span> (pkg.applicationInfo.targetSdkVersion &gt;= npi.sdkVersion) &#123;</span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">if</span> (!pkg.requestedPermissions.contains(npi.name)) &#123;</span><br><span class="line">            <span class="keyword">if</span> (implicitPerms == <span class="keyword">null</span>) &#123;</span><br><span class="line">                implicitPerms = <span class="keyword">new</span> StringBuilder(<span class="number">128</span>);</span><br><span class="line">                implicitPerms.append(pkg.packageName);</span><br><span class="line">                implicitPerms.append(<span class="string">": compat added "</span>);</span><br><span class="line">            &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                implicitPerms.append(<span class="string">' '</span>);</span><br><span class="line">            &#125;</span><br><span class="line">            implicitPerms.append(npi.name);</span><br><span class="line">            pkg.requestedPermissions.add(npi.name);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span> (implicitPerms != <span class="keyword">null</span>) &#123;</span><br><span class="line">        Slog.i(TAG, implicitPerms.toString());</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//【4】处理一些相互依赖的权限，这里除了有 sdkVersion 限制之外，</span></span><br><span class="line">    <span class="comment">// 还有一个判断 rootPerm 是否在 requestedPermissions 列表中的判断 ！</span></span><br><span class="line">    <span class="keyword">final</span> <span class="keyword">int</span> NS = PackageParser.SPLIT_PERMISSIONS.length;</span><br><span class="line">    <span class="keyword">for</span> (<span class="keyword">int</span> is = <span class="number">0</span>; is &lt; NS; is++) &#123;</span><br><span class="line">        <span class="keyword">final</span> PackageParser.SplitPermissionInfo spi</span><br><span class="line">                = PackageParser.SPLIT_PERMISSIONS[is];</span><br><span class="line">        <span class="comment">//【4.1】如果应用的 target SDK Version 高于权限的该权限的 version，不做处理，</span></span><br><span class="line">        <span class="comment">// 或者应用没有请求这个根权限，不用处理！</span></span><br><span class="line">        <span class="keyword">if</span> (pkg.applicationInfo.targetSdkVersion &gt;= spi.targetSdk</span><br><span class="line">                || !pkg.requestedPermissions.contains(spi.rootPerm)) &#123;</span><br><span class="line">            <span class="keyword">continue</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">for</span> (<span class="keyword">int</span> in=<span class="number">0</span>; in &lt; spi.newPerms.length; in++) &#123;</span><br><span class="line">            <span class="keyword">final</span> String perm = spi.newPerms[in];</span><br><span class="line">            <span class="keyword">if</span> (!pkg.requestedPermissions.contains(perm)) &#123;</span><br><span class="line">                pkg.requestedPermissions.add(perm);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    ... ... ...</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> pkg;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>最后，处理了下在指定版本中出现的新权限的添加！</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> PackageParser.NewPermissionInfo NEW_PERMISSIONS[] =</span><br><span class="line">    <span class="keyword">new</span> PackageParser.NewPermissionInfo[] &#123;</span><br><span class="line">        <span class="keyword">new</span> PackageParser.NewPermissionInfo(android.Manifest.permission.WRITE_EXTERNAL_STORAGE,</span><br><span class="line">                android.os.Build.VERSION_CODES.DONUT, <span class="number">0</span>),</span><br><span class="line">        <span class="keyword">new</span> PackageParser.NewPermissionInfo(android.Manifest.permission.READ_PHONE_STATE,</span><br><span class="line">                android.os.Build.VERSION_CODES.DONUT, <span class="number">0</span>)</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>
<p>Build.VERSION_CODES.DONUT 的值为 4，表示 Android 1.6，意思是如果是 Android 1.6 之前话，应用如果没有申请 NEW_PERMISSIONS 的权限，那么我们会默认给他申请，因为我们关注的是 Android 7.1.1 那么这里我们不会进入！</p>
<p>对于 SPLIT_PERMISSIONS 列表中的权限，保存了 root 权限和相互依赖的权限，以及首次出现的平台！</p>
<p>举个例子，如果应用只是申请了 WRITE_EXTERNAL_STORAGE，即使其在 Manifest 中没有申明 READ_EXTERNAL_STORAGE 权限，我们也会将其主动加入到 Package.requestedPermissions！！<br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> PackageParser.SplitPermissionInfo SPLIT_PERMISSIONS[] =</span><br><span class="line">    <span class="keyword">new</span> PackageParser.SplitPermissionInfo[] &#123;</span><br><span class="line">        <span class="keyword">new</span> PackageParser.SplitPermissionInfo(android.Manifest.permission.WRITE_EXTERNAL_STORAGE,</span><br><span class="line">                <span class="keyword">new</span> String[] &#123; android.Manifest.permission.READ_EXTERNAL_STORAGE &#125;,</span><br><span class="line">                android.os.Build.VERSION_CODES.CUR_DEVELOPMENT+<span class="number">1</span>),</span><br><span class="line">        <span class="keyword">new</span> PackageParser.SplitPermissionInfo(android.Manifest.permission.READ_CONTACTS,</span><br><span class="line">                <span class="keyword">new</span> String[] &#123; android.Manifest.permission.READ_CALL_LOG &#125;,</span><br><span class="line">                android.os.Build.VERSION_CODES.JELLY_BEAN),</span><br><span class="line">        <span class="keyword">new</span> PackageParser.SplitPermissionInfo(android.Manifest.permission.WRITE_CONTACTS,</span><br><span class="line">                <span class="keyword">new</span> String[] &#123; android.Manifest.permission.WRITE_CALL_LOG &#125;,</span><br><span class="line">                android.os.Build.VERSION_CODES.JELLY_BEAN)</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure></p>
<p>Build.VERSION_CODES.JELLY_BEAN 的值为 16，表示 Android 4.1；</p>
<p>Build.VERSION_CODES.CUR_DEVELOPMENT 值为 10000，表示开发者版本！</p>
<p>这段代码的意思是：如果是 Android 4.1 之前，且应用申请了 SPLIT_PERMISSIONS 中指定的根权限，那么我们也会将其对应的子权限添加到其申请列表中，因为我们关注的是 Android 7.1.1 那么这里我们不会进入！</p>
<h4 id="1-2-1-1-PackageP-parsePermissionGroup"><a href="#1-2-1-1-PackageP-parsePermissionGroup" class="headerlink" title="1.2.1.1 PackageP.parsePermissionGroup"></a>1.2.1.1 PackageP.parsePermissionGroup</h4><p>parsePermissionGroup 用于处理 permission-group 的解析：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">private</span> PermissionGroup <span class="title">parsePermissionGroup</span><span class="params">(Package owner, <span class="keyword">int</span> flags, Resources res,</span></span></span><br><span class="line"><span class="function"><span class="params">        XmlResourceParser parser, String[] outError)</span></span></span><br><span class="line"><span class="function">        <span class="keyword">throws</span> XmlPullParserException, IOException </span>&#123;</span><br><span class="line">    <span class="comment">//【1】创建 PermissionGroup 对象！</span></span><br><span class="line">    PermissionGroup perm = <span class="keyword">new</span> PermissionGroup(owner);</span><br><span class="line">    TypedArray sa = res.obtainAttributes(parser,</span><br><span class="line">            com.android.internal.R.styleable.AndroidManifestPermissionGroup);</span><br><span class="line">    <span class="keyword">if</span> (!parsePackageItemInfo(owner, perm.info, outError,</span><br><span class="line">            <span class="string">"&lt;permission-group&gt;"</span>, sa, <span class="keyword">true</span> <span class="comment">/*nameRequired*/</span>,</span><br><span class="line">            com.android.internal.R.styleable.AndroidManifestPermissionGroup_name,</span><br><span class="line">            com.android.internal.R.styleable.AndroidManifestPermissionGroup_label,</span><br><span class="line">            com.android.internal.R.styleable.AndroidManifestPermissionGroup_icon,</span><br><span class="line">            com.android.internal.R.styleable.AndroidManifestPermissionGroup_roundIcon,</span><br><span class="line">            com.android.internal.R.styleable.AndroidManifestPermissionGroup_logo,</span><br><span class="line">            com.android.internal.R.styleable.AndroidManifestPermissionGroup_banner)) &#123;</span><br><span class="line">        sa.recycle();</span><br><span class="line">        mParseError = PackageManager.INSTALL_PARSE_FAILED_MANIFEST_MALFORMED;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">null</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    perm.info.descriptionRes = sa.getResourceId(</span><br><span class="line">            com.android.internal.R.styleable.AndroidManifestPermissionGroup_description, <span class="number">0</span>);</span><br><span class="line">    </span><br><span class="line">     <span class="comment">//【2】解析 permissionGroupFlags 属性；</span></span><br><span class="line">    perm.info.flags = sa.getInt(</span><br><span class="line">            com.android.internal.R.styleable.AndroidManifestPermissionGroup_permissionGroupFlags, <span class="number">0</span>);</span><br><span class="line">     <span class="comment">//【3】解析 priority 属性；</span></span><br><span class="line">    perm.info.priority = sa.getInt(</span><br><span class="line">            com.android.internal.R.styleable.AndroidManifestPermissionGroup_priority, <span class="number">0</span>);</span><br><span class="line"></span><br><span class="line">    <span class="comment">//【4】只有系统应用才能设置权限组的优先级</span></span><br><span class="line">    <span class="keyword">if</span> (perm.info.priority &gt; <span class="number">0</span> &amp;&amp; (flags &amp; PARSE_IS_SYSTEM) == <span class="number">0</span>) &#123;</span><br><span class="line">        perm.info.priority = <span class="number">0</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    sa.recycle();</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (!parseAllMetaData(res, parser, <span class="string">"&lt;permission-group&gt;"</span>, perm,</span><br><span class="line">            outError)) &#123;</span><br><span class="line">        mParseError = PackageManager.INSTALL_PARSE_FAILED_MANIFEST_MALFORMED;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">null</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    owner.permissionGroups.add(perm);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> perm;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>只有系统应用才能设置权限组的优先级！</p>
<p>创建了 PermissionGroup 对象！<br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">final</span> <span class="keyword">static</span> <span class="class"><span class="keyword">class</span> <span class="title">PermissionGroup</span> <span class="keyword">extends</span> <span class="title">Component</span>&lt;<span class="title">IntentInfo</span>&gt; </span>&#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">final</span> PermissionGroupInfo info;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="title">PermissionGroup</span><span class="params">(Package _owner)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">super</span>(_owner);</span><br><span class="line">        info = <span class="keyword">new</span> PermissionGroupInfo();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="title">PermissionGroup</span><span class="params">(Package _owner, PermissionGroupInfo _info)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">super</span>(_owner);</span><br><span class="line">        info = _info;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">setPackageName</span><span class="params">(String packageName)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">super</span>.setPackageName(packageName);</span><br><span class="line">        info.packageName = packageName;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> String <span class="title">toString</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="string">"PermissionGroup&#123;"</span></span><br><span class="line">            + Integer.toHexString(System.identityHashCode(<span class="keyword">this</span>))</span><br><span class="line">            + <span class="string">" "</span> + info.name + <span class="string">"&#125;"</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>最终的解析结果会保存到 Package.permissionGroups 中！</p>
<h4 id="1-2-1-2-PackageP-parsePermission"><a href="#1-2-1-2-PackageP-parsePermission" class="headerlink" title="1.2.1.2 PackageP.parsePermission"></a>1.2.1.2 PackageP.parsePermission</h4><p>parsePermission 用于处理 permission 的解析：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">private</span> Permission <span class="title">parsePermission</span><span class="params">(Package owner, Resources res,</span></span></span><br><span class="line"><span class="function"><span class="params">        XmlResourceParser parser, String[] outError)</span></span></span><br><span class="line"><span class="function">    <span class="keyword">throws</span> XmlPullParserException, IOException </span>&#123;</span><br><span class="line">    <span class="comment">//【1】创建一个 Permission 对象，封装 permission-tree </span></span><br><span class="line">    Permission perm = <span class="keyword">new</span> Permission(owner);</span><br><span class="line"></span><br><span class="line">    TypedArray sa = res.obtainAttributes(parser,</span><br><span class="line">            com.android.internal.R.styleable.AndroidManifestPermission);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (!parsePackageItemInfo(owner, perm.info, outError,</span><br><span class="line">            <span class="string">"&lt;permission&gt;"</span>, sa, <span class="keyword">true</span> <span class="comment">/*nameRequired*/</span>,</span><br><span class="line">            com.android.internal.R.styleable.AndroidManifestPermission_name,</span><br><span class="line">            com.android.internal.R.styleable.AndroidManifestPermission_label,</span><br><span class="line">            com.android.internal.R.styleable.AndroidManifestPermission_icon,</span><br><span class="line">            com.android.internal.R.styleable.AndroidManifestPermission_roundIcon,</span><br><span class="line">            com.android.internal.R.styleable.AndroidManifestPermission_logo,</span><br><span class="line">            com.android.internal.R.styleable.AndroidManifestPermission_banner)) &#123;</span><br><span class="line">        sa.recycle();</span><br><span class="line">        mParseError = PackageManager.INSTALL_PARSE_FAILED_MANIFEST_MALFORMED;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">null</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//【2】解析权限所属的组信息！</span></span><br><span class="line">    perm.info.group = sa.getNonResourceString(</span><br><span class="line">            com.android.internal.R.styleable.AndroidManifestPermission_permissionGroup);</span><br><span class="line">    <span class="keyword">if</span> (perm.info.group != <span class="keyword">null</span>) &#123;</span><br><span class="line">        perm.info.group = perm.info.group.intern();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    perm.info.descriptionRes = sa.getResourceId(</span><br><span class="line">            com.android.internal.R.styleable.AndroidManifestPermission_description,</span><br><span class="line">            <span class="number">0</span>);</span><br><span class="line">    <span class="comment">//【3】解析权限的保护级别，默认为 normal！</span></span><br><span class="line">    perm.info.protectionLevel = sa.getInt(</span><br><span class="line">            com.android.internal.R.styleable.AndroidManifestPermission_protectionLevel,</span><br><span class="line">            PermissionInfo.PROTECTION_NORMAL);</span><br><span class="line"></span><br><span class="line">    <span class="comment">//【4】解析权限的 flags，默认为 0！</span></span><br><span class="line">    perm.info.flags = sa.getInt(</span><br><span class="line">            com.android.internal.R.styleable.AndroidManifestPermission_permissionFlags, <span class="number">0</span>);</span><br><span class="line"></span><br><span class="line">    sa.recycle();</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (perm.info.protectionLevel == -<span class="number">1</span>) &#123;</span><br><span class="line">        outError[<span class="number">0</span>] = <span class="string">"&lt;permission&gt; does not specify protectionLevel"</span>;</span><br><span class="line">        mParseError = PackageManager.INSTALL_PARSE_FAILED_MANIFEST_MALFORMED;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">null</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">//【5】将 signatureOrSystem 转为 signature|privileged</span></span><br><span class="line">    perm.info.protectionLevel = PermissionInfo.fixProtectionLevel(perm.info.protectionLevel);</span><br><span class="line"></span><br><span class="line">    <span class="comment">//【6】这里是检查保护级别的有效性！</span></span><br><span class="line">    <span class="comment">// 如果 protectionLevel 设置了额外的标志位，那么其基本权限类型必须是 signature！！</span></span><br><span class="line">    <span class="keyword">if</span> ((perm.info.protectionLevel &amp; PermissionInfo.PROTECTION_MASK_FLAGS) != <span class="number">0</span>) &#123;</span><br><span class="line">        <span class="keyword">if</span> ((perm.info.protectionLevel &amp; PermissionInfo.PROTECTION_MASK_BASE) !=</span><br><span class="line">                PermissionInfo.PROTECTION_SIGNATURE) &#123;</span><br><span class="line">            outError[<span class="number">0</span>] = <span class="string">"&lt;permission&gt;  protectionLevel specifies a flag but is "</span></span><br><span class="line">                    + <span class="string">"not based on signature type"</span>;</span><br><span class="line">            mParseError = PackageManager.INSTALL_PARSE_FAILED_MANIFEST_MALFORMED;</span><br><span class="line">            <span class="keyword">return</span> <span class="keyword">null</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (!parseAllMetaData(res, parser, <span class="string">"&lt;permission&gt;"</span>, perm, outError)) &#123; <span class="comment">// 解析 meta-data 属性！</span></span><br><span class="line">        mParseError = PackageManager.INSTALL_PARSE_FAILED_MANIFEST_MALFORMED;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">null</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    owner.permissions.add(perm);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> perm;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>这里会涉及到 2 个标志位：<br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 用于获取基本权限类型</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="keyword">int</span> PROTECTION_MASK_BASE = <span class="number">0xf</span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 用于获取额外的标志位</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="keyword">int</span> PROTECTION_MASK_FLAGS = <span class="number">0xff0</span>;</span><br></pre></td></tr></table></figure></p>
<p>我们可以通过如下方式获得基本权限类型和附加标志位：<br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">protectionLevel &amp; PermissionInfo.PROTECTION_MASK_BASE <span class="comment">// 获取基本权限类型；</span></span><br><span class="line">protectionLevel &amp; PermissionInfo.PROTECTION_MASK_FLAGS <span class="comment">// 获取额外的标志位；</span></span><br></pre></td></tr></table></figure></p>
<p>fixProtectionLevel 的意义就是将 signatureOrSystem 转为 signature|privileged 而已！<br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/** <span class="doctag">@hide</span> */</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">int</span> <span class="title">fixProtectionLevel</span><span class="params">(<span class="keyword">int</span> level)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">if</span> (level == PROTECTION_SIGNATURE_OR_SYSTEM) &#123;</span><br><span class="line">        level = PROTECTION_SIGNATURE | PROTECTION_FLAG_PRIVILEGED;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> level;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>如果 protectionLevel 设置了额外的标志位，那么其基本权限类型必须是 signature！！</p>
<p>解析的结果会封装到一个 Permission 对象中！<br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">final</span> <span class="keyword">static</span> <span class="class"><span class="keyword">class</span> <span class="title">Permission</span> <span class="keyword">extends</span> <span class="title">Component</span>&lt;<span class="title">IntentInfo</span>&gt; </span>&#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">final</span> PermissionInfo info; <span class="comment">// 用于保存该权限的信息！</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">boolean</span> tree; <span class="comment">// 是否是权限树，是权限则为 false；</span></span><br><span class="line">    <span class="keyword">public</span> PermissionGroup group;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="title">Permission</span><span class="params">(Package _owner)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">super</span>(_owner);</span><br><span class="line">        info = <span class="keyword">new</span> PermissionInfo();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="title">Permission</span><span class="params">(Package _owner, PermissionInfo _info)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">super</span>(_owner);</span><br><span class="line">        info = _info;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">setPackageName</span><span class="params">(String packageName)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">super</span>.setPackageName(packageName);</span><br><span class="line">        info.packageName = packageName;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> String <span class="title">toString</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="string">"Permission&#123;"</span></span><br><span class="line">            + Integer.toHexString(System.identityHashCode(<span class="keyword">this</span>))</span><br><span class="line">            + <span class="string">" "</span> + info.name + <span class="string">"&#125;"</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>最终的解析结果会保存到 Package.permissions 中！</p>
<h4 id="1-2-1-3-PackageP-parsePermissionTree"><a href="#1-2-1-3-PackageP-parsePermissionTree" class="headerlink" title="1.2.1.3 PackageP.parsePermissionTree"></a>1.2.1.3 PackageP.parsePermissionTree</h4><p>parsePermissionTree 用于处理 permission-tree 的解析：<br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">private</span> Permission <span class="title">parsePermissionTree</span><span class="params">(Package owner, Resources res,</span></span></span><br><span class="line"><span class="function"><span class="params">        XmlResourceParser parser, String[] outError)</span></span></span><br><span class="line"><span class="function">    <span class="keyword">throws</span> XmlPullParserException, IOException </span>&#123;</span><br><span class="line">    <span class="comment">//【1】创建一个 Permission 对象，封装 permission-tree </span></span><br><span class="line">    Permission perm = <span class="keyword">new</span> Permission(owner);</span><br><span class="line"></span><br><span class="line">    TypedArray sa = res.obtainAttributes(parser,</span><br><span class="line">            com.android.internal.R.styleable.AndroidManifestPermissionTree);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (!parsePackageItemInfo(owner, perm.info, outError,</span><br><span class="line">            <span class="string">"&lt;permission-tree&gt;"</span>, sa, <span class="keyword">true</span> <span class="comment">/*nameRequired*/</span>,</span><br><span class="line">            com.android.internal.R.styleable.AndroidManifestPermissionTree_name,</span><br><span class="line">            com.android.internal.R.styleable.AndroidManifestPermissionTree_label,</span><br><span class="line">            com.android.internal.R.styleable.AndroidManifestPermissionTree_icon,</span><br><span class="line">            com.android.internal.R.styleable.AndroidManifestPermissionTree_roundIcon,</span><br><span class="line">            com.android.internal.R.styleable.AndroidManifestPermissionTree_logo,</span><br><span class="line">            com.android.internal.R.styleable.AndroidManifestPermissionTree_banner)) &#123;</span><br><span class="line">        sa.recycle();</span><br><span class="line">        mParseError = PackageManager.INSTALL_PARSE_FAILED_MANIFEST_MALFORMED;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">null</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    sa.recycle();</span><br><span class="line"></span><br><span class="line">    <span class="comment">//【2】校验权限树的名称合法性，必须是至少由两个 “.” 分割开的段！</span></span><br><span class="line">    <span class="keyword">int</span> index = perm.info.name.indexOf(<span class="string">'.'</span>);</span><br><span class="line">    <span class="keyword">if</span> (index &gt; <span class="number">0</span>) &#123;</span><br><span class="line">        index = perm.info.name.indexOf(<span class="string">'.'</span>, index+<span class="number">1</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span> (index &lt; <span class="number">0</span>) &#123;</span><br><span class="line">        outError[<span class="number">0</span>] = <span class="string">"&lt;permission-tree&gt; name has less than three segments: "</span></span><br><span class="line">            + perm.info.name;</span><br><span class="line">        mParseError = PackageManager.INSTALL_PARSE_FAILED_MANIFEST_MALFORMED;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">null</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    perm.info.descriptionRes = <span class="number">0</span>;</span><br><span class="line">    perm.info.protectionLevel = PermissionInfo.PROTECTION_NORMAL; <span class="comment">// 默认为 nomal</span></span><br><span class="line">    perm.tree = <span class="keyword">true</span>; <span class="comment">// 设置 perm.tree，表示其为权限树！</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (!parseAllMetaData(res, parser, <span class="string">"&lt;permission-tree&gt;"</span>, perm,</span><br><span class="line">            outError)) &#123;</span><br><span class="line">        mParseError = PackageManager.INSTALL_PARSE_FAILED_MANIFEST_MALFORMED;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">null</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    owner.permissions.add(perm);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> perm;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>我们看到，对于权限树，也是会创建一个 Permission 对象！</p>
<p>最终的解析结果会保存到 Package.permissions 中！</p>
<h4 id="1-2-1-4-PackageP-parseUsesPermission"><a href="#1-2-1-4-PackageP-parseUsesPermission" class="headerlink" title="1.2.1.4 PackageP.parseUsesPermission"></a>1.2.1.4 PackageP.parseUsesPermission</h4><p>parseUsesPermission 用于处理 uses-permission 的解析：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">boolean</span> <span class="title">parseUsesPermission</span><span class="params">(Package pkg, Resources res, XmlResourceParser parser)</span></span></span><br><span class="line"><span class="function">        <span class="keyword">throws</span> XmlPullParserException, IOException </span>&#123;</span><br><span class="line">    TypedArray sa = res.obtainAttributes(parser,</span><br><span class="line">            com.android.internal.R.styleable.AndroidManifestUsesPermission);</span><br><span class="line"></span><br><span class="line">    String name = sa.getNonResourceString( <span class="comment">// 解析 name 属性；</span></span><br><span class="line">            com.android.internal.R.styleable.AndroidManifestUsesPermission_name);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">int</span> maxSdkVersion = <span class="number">0</span>;</span><br><span class="line">    TypedValue val = sa.peekValue( <span class="comment">// 解析 maxSdkVersion 属性；</span></span><br><span class="line">            com.android.internal.R.styleable.AndroidManifestUsesPermission_maxSdkVersion);</span><br><span class="line">    <span class="keyword">if</span> (val != <span class="keyword">null</span>) &#123;</span><br><span class="line">        <span class="keyword">if</span> (val.type &gt;= TypedValue.TYPE_FIRST_INT &amp;&amp; val.type &lt;= TypedValue.TYPE_LAST_INT) &#123;</span><br><span class="line">            maxSdkVersion = val.data;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    sa.recycle();</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> ((maxSdkVersion == <span class="number">0</span>) || (maxSdkVersion &gt;= Build.VERSION.RESOURCES_SDK_INT)) &#123;</span><br><span class="line">        <span class="keyword">if</span> (name != <span class="keyword">null</span>) &#123;</span><br><span class="line">            <span class="keyword">int</span> index = pkg.requestedPermissions.indexOf(name);</span><br><span class="line">            <span class="keyword">if</span> (index == -<span class="number">1</span>) &#123;</span><br><span class="line">                <span class="comment">// 将该 package </span></span><br><span class="line">                pkg.requestedPermissions.add(name.intern());</span><br><span class="line">            &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                Slog.w(TAG, <span class="string">"Ignoring duplicate uses-permissions/uses-permissions-sdk-m: "</span></span><br><span class="line">                        + name + <span class="string">" in package: "</span> + pkg.packageName + <span class="string">" at: "</span></span><br><span class="line">                        + parser.getPositionDescription());</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    XmlUtils.skipCurrentTag(parser);</span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">true</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>最终的解析结果会保存到 Package.requestedPermissions 中！</p>
<h3 id="1-2-2-PackageParser-parseBaseApplication"><a href="#1-2-2-PackageParser-parseBaseApplication" class="headerlink" title="1.2.2 PackageParser.parseBaseApplication"></a>1.2.2 PackageParser.parseBaseApplication</h3><p>我们先来看看 application 的属性配置解析！</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">boolean</span> <span class="title">parseBaseApplication</span><span class="params">(Package owner, Resources res,</span></span></span><br><span class="line"><span class="function"><span class="params">        XmlResourceParser parser, <span class="keyword">int</span> flags, String[] outError)</span></span></span><br><span class="line"><span class="function">    <span class="keyword">throws</span> XmlPullParserException, IOException </span>&#123;</span><br><span class="line">    <span class="comment">//【1.1】获得 package 的 ApplicationInfo 成员变量，封装 Application 标签的信息</span></span><br><span class="line">    <span class="keyword">final</span> ApplicationInfo ai = owner.applicationInfo;</span><br><span class="line">    <span class="keyword">final</span> String pkgName = owner.applicationInfo.packageName;</span><br><span class="line"></span><br><span class="line">    ... ... ...</span><br><span class="line"></span><br><span class="line">    <span class="comment">//【1.2】解析 android:permission 属性</span></span><br><span class="line">    String str;</span><br><span class="line">    str = sa.getNonConfigurationString(</span><br><span class="line">            com.android.internal.R.styleable.AndroidManifestApplication_permission, <span class="number">0</span>);</span><br><span class="line">    ai.permission = (str != <span class="keyword">null</span> &amp;&amp; str.length() &gt; <span class="number">0</span>) ? str.intern() : <span class="keyword">null</span>;</span><br><span class="line"></span><br><span class="line">    ... ... ...</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">while</span> ((type = parser.next()) != XmlPullParser.END_DOCUMENT</span><br><span class="line">            &amp;&amp; (type != XmlPullParser.END_TAG || parser.getDepth() &gt; innerDepth)) &#123;</span><br><span class="line">        <span class="keyword">if</span> (type == XmlPullParser.END_TAG || type == XmlPullParser.TEXT) &#123;</span><br><span class="line">            <span class="keyword">continue</span>;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        String tagName = parser.getName();</span><br><span class="line">        <span class="keyword">if</span> (tagName.equals(<span class="string">"activity"</span>)) &#123; <span class="comment">//【2】解析 activity 属性</span></span><br><span class="line">            Activity a = parseActivity(owner, res, parser, flags, outError, <span class="keyword">false</span>,</span><br><span class="line">                    owner.baseHardwareAccelerated);</span><br><span class="line">            <span class="keyword">if</span> (a == <span class="keyword">null</span>) &#123;</span><br><span class="line">                mParseError = PackageManager.INSTALL_PARSE_FAILED_MANIFEST_MALFORMED;</span><br><span class="line">                <span class="keyword">return</span> <span class="keyword">false</span>;</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            owner.activities.add(a);</span><br><span class="line"></span><br><span class="line">        &#125; <span class="keyword">else</span> <span class="keyword">if</span> (tagName.equals(<span class="string">"receiver"</span>)) &#123; <span class="comment">//【3】解析 receiver 属性</span></span><br><span class="line">            Activity a = parseActivity(owner, res, parser, flags, outError, <span class="keyword">true</span>, <span class="keyword">false</span>);</span><br><span class="line">            <span class="keyword">if</span> (a == <span class="keyword">null</span>) &#123;</span><br><span class="line">                mParseError = PackageManager.INSTALL_PARSE_FAILED_MANIFEST_MALFORMED;</span><br><span class="line">                <span class="keyword">return</span> <span class="keyword">false</span>;</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            owner.receivers.add(a);</span><br><span class="line"></span><br><span class="line">        &#125; <span class="keyword">else</span> <span class="keyword">if</span> (tagName.equals(<span class="string">"service"</span>)) &#123; <span class="comment">//【4】解析 service 属性</span></span><br><span class="line">            Service s = parseService(owner, res, parser, flags, outError);</span><br><span class="line">            <span class="keyword">if</span> (s == <span class="keyword">null</span>) &#123;</span><br><span class="line">                mParseError = PackageManager.INSTALL_PARSE_FAILED_MANIFEST_MALFORMED;</span><br><span class="line">                <span class="keyword">return</span> <span class="keyword">false</span>;</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            owner.services.add(s);</span><br><span class="line"></span><br><span class="line">        &#125; <span class="keyword">else</span> <span class="keyword">if</span> (tagName.equals(<span class="string">"provider"</span>)) &#123; <span class="comment">//【5】解析 provider 属性</span></span><br><span class="line">            Provider p = parseProvider(owner, res, parser, flags, outError);</span><br><span class="line">            <span class="keyword">if</span> (p == <span class="keyword">null</span>) &#123;</span><br><span class="line">                mParseError = PackageManager.INSTALL_PARSE_FAILED_MANIFEST_MALFORMED;</span><br><span class="line">                <span class="keyword">return</span> <span class="keyword">false</span>;</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            owner.providers.add(p);</span><br><span class="line"></span><br><span class="line">        &#125; <span class="keyword">else</span> <span class="keyword">if</span> (</span><br><span class="line">        </span><br><span class="line">            ... ... ...</span><br><span class="line">        </span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    modifySharedLibrariesForBackwardCompatibility(owner);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (hasDomainURLs(owner)) &#123;</span><br><span class="line">        owner.applicationInfo.privateFlags |= ApplicationInfo.PRIVATE_FLAG_HAS_DOMAIN_URLS;</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        owner.applicationInfo.privateFlags &amp;= ~ApplicationInfo.PRIVATE_FLAG_HAS_DOMAIN_URLS;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">true</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>最后，解析的 android:permission 属性会保存到 Provider.ApplicationInfo.permission 中去！</p>
<h1 id="2-Activity-的权限配置和解析"><a href="#2-Activity-的权限配置和解析" class="headerlink" title="2 Activity 的权限配置和解析"></a>2 Activity 的权限配置和解析</h1><h2 id="2-1-权限配置"><a href="#2-1-权限配置" class="headerlink" title="2.1 权限配置"></a>2.1 权限配置</h2><p>在 Activity 中有如下的权限相关配置：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">android:exported=[&quot;true&quot; | &quot;false&quot;]</span><br><span class="line">android:permission=&quot;string&quot;</span><br></pre></td></tr></table></figure>
<ul>
<li>exported 属性</li>
</ul>
<p>exported 属性决定了该 activity 是否暴露给其他应用！</p>
<ul>
<li>permission 属性</li>
</ul>
<p>permission 属性表示启动该 activity 应该具有的权限</p>
<h2 id="2-2-权限解析"><a href="#2-2-权限解析" class="headerlink" title="2.2 权限解析"></a>2.2 权限解析</h2><h3 id="2-2-1-PackageParser-parseActivity"><a href="#2-2-1-PackageParser-parseActivity" class="headerlink" title="2.2.1 PackageParser.parseActivity"></a>2.2.1 PackageParser.parseActivity</h3><p>Activity 使用是 parseActivity 方法解析，对于 Activity，boolean receiver 取值为 false：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">private</span> Activity <span class="title">parseActivity</span><span class="params">(Package owner, Resources res,</span></span></span><br><span class="line"><span class="function"><span class="params">        XmlResourceParser parser, <span class="keyword">int</span> flags, String[] outError,</span></span></span><br><span class="line"><span class="function"><span class="params">        <span class="keyword">boolean</span> receiver, <span class="keyword">boolean</span> hardwareAccelerated)</span></span></span><br><span class="line"><span class="function">        <span class="keyword">throws</span> XmlPullParserException, IOException </span>&#123;</span><br><span class="line">    ... ... ...</span><br><span class="line"></span><br><span class="line">    <span class="comment">//【1】创建了一个 Activity 对象，表示 Receiver  组件，创建了 ActivityInfo 对象，封装 Receiver 信息！</span></span><br><span class="line">    Activity a = <span class="keyword">new</span> Activity(mParseActivityArgs, <span class="keyword">new</span> ActivityInfo());</span><br><span class="line">    <span class="keyword">if</span> (outError[<span class="number">0</span>] != <span class="keyword">null</span>) &#123;</span><br><span class="line">        sa.recycle();</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">null</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">//【2】解析 android:exported 属性！</span></span><br><span class="line">    <span class="keyword">boolean</span> setExported = sa.hasValue(R.styleable.AndroidManifestActivity_exported);</span><br><span class="line">    <span class="keyword">if</span> (setExported) &#123;</span><br><span class="line">        a.info.exported = sa.getBoolean(R.styleable.AndroidManifestActivity_exported, <span class="keyword">false</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    ... ... ...</span><br><span class="line"></span><br><span class="line">    <span class="comment">//【3】解析 android:permission 属性！</span></span><br><span class="line">    String str;</span><br><span class="line">    str = sa.getNonConfigurationString(R.styleable.AndroidManifestActivity_permission, <span class="number">0</span>);</span><br><span class="line">    <span class="keyword">if</span> (str == <span class="keyword">null</span>) &#123;</span><br><span class="line">        a.info.permission = owner.applicationInfo.permission;</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        a.info.permission = str.length() &gt; <span class="number">0</span> ? str.toString().intern() : <span class="keyword">null</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    ... ... ...</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">if</span> (!setExported) &#123; </span><br><span class="line">        <span class="comment">//【4】如果没有显式设置 android:exported，取决于是否设置了意图过滤器；</span></span><br><span class="line">        s.info.exported = s.intents.size() &gt; <span class="number">0</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">return</span> a;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p><strong>属性解析</strong>：</p>
<ul>
<li>android:exported 属性的值会保存到 Activity.ActivityInfo.exported 中；</li>
<li>android:permission 会保存到 Activity.ActivityInfo.permission 中；</li>
</ul>
<p>android:permission 使用的权限必须在 permission 标签中定义才可以使用！</p>
<h1 id="3-Service-的权限配置和解析"><a href="#3-Service-的权限配置和解析" class="headerlink" title="3 Service 的权限配置和解析"></a>3 Service 的权限配置和解析</h1><h2 id="3-1-权限配置"><a href="#3-1-权限配置" class="headerlink" title="3.1 权限配置"></a>3.1 权限配置</h2><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">service</span></span></span><br><span class="line"><span class="tag">         <span class="attr">android:exported</span>=<span class="string">[</span>"<span class="attr">true</span>" | "<span class="attr">false</span>"]</span></span><br><span class="line"><span class="tag">         <span class="attr">android:permission</span>=<span class="string">"string"</span> &gt;</span></span><br><span class="line">    . . .</span><br><span class="line"><span class="tag">&lt;/<span class="name">service</span>&gt;</span></span><br></pre></td></tr></table></figure>
<ul>
<li><strong>android:exported</strong></li>
</ul>
<p>其他应用程序的组件是否可以调用服务或与其进行交互，为 true 表示可以，为 false 表示不可以。</p>
<p>当值为 false 时，只有具有相同 uid 的应用程序或该应用程序的组件才能启动服务或绑定到该服务。</p>
<p>默认值取决于服务是否包含意图过滤器，如果包含，则为 true；否则为 false；</p>
<ul>
<li><strong>android:permission</strong></li>
</ul>
<p>启动服务或绑定服务所必须具有的权限；</p>
<p>如果未设置此属性，则由该 application 元素 permission 属性设置的权限将 应用于该服务。如果两个属性均未设置，则该服务不受权限保护。</p>
<h2 id="3-2-权限解析"><a href="#3-2-权限解析" class="headerlink" title="3.2 权限解析"></a>3.2 权限解析</h2><h3 id="3-2-1-PackageParser-parseService"><a href="#3-2-1-PackageParser-parseService" class="headerlink" title="3.2.1 PackageParser.parseService"></a>3.2.1 PackageParser.parseService</h3><p>Service 使用是 parseService 方法解析:</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">private</span> Service <span class="title">parseService</span><span class="params">(Package owner, Resources res,</span></span></span><br><span class="line"><span class="function"><span class="params">        XmlResourceParser parser, <span class="keyword">int</span> flags, String[] outError)</span></span></span><br><span class="line"><span class="function">        <span class="keyword">throws</span> XmlPullParserException, IOException </span>&#123;</span><br><span class="line">    TypedArray sa = res.obtainAttributes(parser,</span><br><span class="line">            com.android.internal.R.styleable.AndroidManifestService);</span><br><span class="line"></span><br><span class="line">    ... ... ...</span><br><span class="line"></span><br><span class="line">    <span class="comment">//【1】创建 Service 对象，代表 Service 组件，创建 ServiceInfo 对象，封装 Service 的信息！</span></span><br><span class="line">    Service s = <span class="keyword">new</span> Service(mParseServiceArgs, <span class="keyword">new</span> ServiceInfo());</span><br><span class="line">    <span class="keyword">if</span> (outError[<span class="number">0</span>] != <span class="keyword">null</span>) &#123;</span><br><span class="line">        sa.recycle();</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">null</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">//【2】解析 android:exported 属性；</span></span><br><span class="line">    <span class="keyword">boolean</span> setExported = sa.hasValue(</span><br><span class="line">            com.android.internal.R.styleable.AndroidManifestService_exported);</span><br><span class="line">    <span class="keyword">if</span> (setExported) &#123;</span><br><span class="line">        s.info.exported = sa.getBoolean(</span><br><span class="line">                com.android.internal.R.styleable.AndroidManifestService_exported, <span class="keyword">false</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">//【3】解析 android:permission 属性；</span></span><br><span class="line">    String str = sa.getNonConfigurationString(</span><br><span class="line">            com.android.internal.R.styleable.AndroidManifestService_permission, <span class="number">0</span>);</span><br><span class="line">    <span class="keyword">if</span> (str == <span class="keyword">null</span>) &#123;</span><br><span class="line">        s.info.permission = owner.applicationInfo.permission;</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        s.info.permission = str.length() &gt; <span class="number">0</span> ? str.toString().intern() : <span class="keyword">null</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    ... ... ... ...</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (!setExported) &#123; </span><br><span class="line">        <span class="comment">//【4】如果没有显式设置 android:exported，取决于是否设置了意图过滤器；</span></span><br><span class="line">        s.info.exported = s.intents.size() &gt; <span class="number">0</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> s;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h1 id="4-Receiver-的权限配置和解析"><a href="#4-Receiver-的权限配置和解析" class="headerlink" title="4 Receiver 的权限配置和解析"></a>4 Receiver 的权限配置和解析</h1><h2 id="4-1-权限配置"><a href="#4-1-权限配置" class="headerlink" title="4.1 权限配置"></a>4.1 权限配置</h2><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">receiver</span> </span></span><br><span class="line"><span class="tag">          <span class="attr">android:exported</span>=<span class="string">[</span>"<span class="attr">true</span>" | "<span class="attr">false</span>"]</span></span><br><span class="line"><span class="tag">          <span class="attr">android:permission</span>=<span class="string">"string"</span> &gt;</span></span><br><span class="line">    . . .</span><br><span class="line"><span class="tag">&lt;/<span class="name">receiver</span>&gt;</span></span><br></pre></td></tr></table></figure>
<ul>
<li><strong>android:exported</strong></li>
</ul>
<p>广播接收器是否可以接收来自其应用程序之外的消息的消息 ，为 true 表示可以，为 false 表示不可以。</p>
<p>当值为 false 时，则广播接收器可以接收的唯一消息是由具有相同 uid 的应用程序或该应用程序自身的组件发送的消息。</p>
<p>默认值取决于广播接收者是否包含意图过滤器，如果包含，则为 true；否则为 false；</p>
<ul>
<li><strong>android:permission</strong></li>
</ul>
<p>向该广播接收者发送消息必须具有的权限；</p>
<p>如果未设置此属性，则该 application 元素 permission 属性设置的权限将 应用于广播接收器。如果两个属性均未设置，则接收方不受权限保护。</p>
<h2 id="4-2-权限解析"><a href="#4-2-权限解析" class="headerlink" title="4.2 权限解析"></a>4.2 权限解析</h2><p>我们回到 PMS 中去，看下应用程序的 Receiver 组件是如何被解析的，我们重点关注和权限相关的：</p>
<h3 id="4-2-1-PackageParser-parseActivity"><a href="#4-2-1-PackageParser-parseActivity" class="headerlink" title="4.2.1 PackageParser.parseActivity"></a>4.2.1 PackageParser.parseActivity</h3><p>Receiver 和 Activity 使用是同一个方法，对于 Receiver，boolean receiver 取值为 true；</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">private</span> Activity <span class="title">parseActivity</span><span class="params">(Package owner, Resources res,</span></span></span><br><span class="line"><span class="function"><span class="params">        XmlResourceParser parser, <span class="keyword">int</span> flags, String[] outError,</span></span></span><br><span class="line"><span class="function"><span class="params">        <span class="keyword">boolean</span> receiver, <span class="keyword">boolean</span> hardwareAccelerated)</span></span></span><br><span class="line"><span class="function">        <span class="keyword">throws</span> XmlPullParserException, IOException </span>&#123;</span><br><span class="line">    ... ... ...</span><br><span class="line"></span><br><span class="line">    <span class="comment">//【1】创建了一个 Activity 对象，表示 Receiver  组件，创建了 ActivityInfo 对象，封装 Receiver 信息！</span></span><br><span class="line">    Activity a = <span class="keyword">new</span> Activity(mParseActivityArgs, <span class="keyword">new</span> ActivityInfo());</span><br><span class="line">    <span class="keyword">if</span> (outError[<span class="number">0</span>] != <span class="keyword">null</span>) &#123;</span><br><span class="line">        sa.recycle();</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">null</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">//【2】解析 android:exported 属性！</span></span><br><span class="line">    <span class="keyword">boolean</span> setExported = sa.hasValue(R.styleable.AndroidManifestActivity_exported);</span><br><span class="line">    <span class="keyword">if</span> (setExported) &#123;</span><br><span class="line">        a.info.exported = sa.getBoolean(R.styleable.AndroidManifestActivity_exported, <span class="keyword">false</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    ... ... ...</span><br><span class="line"></span><br><span class="line">    <span class="comment">//【3】解析 android:permission 属性！</span></span><br><span class="line">    String str;</span><br><span class="line">    str = sa.getNonConfigurationString(R.styleable.AndroidManifestActivity_permission, <span class="number">0</span>);</span><br><span class="line">    <span class="keyword">if</span> (str == <span class="keyword">null</span>) &#123;</span><br><span class="line">        a.info.permission = owner.applicationInfo.permission;</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        a.info.permission = str.length() &gt; <span class="number">0</span> ? str.toString().intern() : <span class="keyword">null</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    ... ... ...</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">if</span> (!setExported) &#123; </span><br><span class="line">        <span class="comment">//【4】如果没有显式设置 android:exported，取决于是否设置了意图过滤器；</span></span><br><span class="line">        s.info.exported = s.intents.size() &gt; <span class="number">0</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> a;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p><strong>属性解析</strong>：</p>
<ul>
<li>android:exported 属性的值会保存到 Activity.ActivityInfo.exported 中；</li>
<li>android:permission 会保存到 Activity.ActivityInfo.permission 中；</li>
</ul>
<h1 id="5-Provider-的权限配置和解析"><a href="#5-Provider-的权限配置和解析" class="headerlink" title="5 Provider 的权限配置和解析"></a>5 Provider 的权限配置和解析</h1><h2 id="5-1-权限配置"><a href="#5-1-权限配置" class="headerlink" title="5.1 权限配置"></a>5.1 权限配置</h2><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">provider</span> <span class="attr">android:exported</span>=<span class="string">[</span>"<span class="attr">true</span>" | "<span class="attr">false</span>"]</span></span><br><span class="line"><span class="tag">          <span class="attr">android:grantUriPermissions</span>=<span class="string">[</span>"<span class="attr">true</span>" | "<span class="attr">false</span>"]</span></span><br><span class="line"><span class="tag">          <span class="attr">android:permission</span>=<span class="string">"string"</span></span></span><br><span class="line"><span class="tag">          <span class="attr">android:readPermission</span>=<span class="string">"string"</span></span></span><br><span class="line"><span class="tag">          <span class="attr">android:writePermission</span>=<span class="string">"string"</span> &gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">provider</span>&gt;</span></span><br></pre></td></tr></table></figure>
<p>和 provider 相关的权限配置比较多，我们来分别看下：</p>
<h3 id="5-1-1-android-exported"><a href="#5-1-1-android-exported" class="headerlink" title="5.1.1 android:exported"></a>5.1.1 <strong>android:exported</strong></h3><p>provider 是否被其他应用程序使用：</p>
<ul>
<li>如果为 true， provider 可被其他应用程序使用。任何应用程序都可以使用提供程序的内容 URI 来访问它，但必须持有 provider 指定的权限。</li>
<li>如果为 false，provider 不能被其他应用程序使用，只有具有与提供者相同的 uid 的应用程序或者自身才有权访问它。</li>
</ul>
<p>因为此属性是在 API 级别 17 中引入的，在 API 17 及以后，默认为 false！</p>
<h3 id="5-1-2-android-permission"><a href="#5-1-2-android-permission" class="headerlink" title="5.1.2 android:permission"></a>5.1.2 <strong>android:permission</strong></h3><p>应用程序读取或者写入 provider 必须要有的权限，readPermission和 writePermission 设置的权限优先级更高！</p>
<p>如果 readPermission 属性也被设置，则它控制查询权限。如果 writePermission 属性被设置，它将控制访问权限。</p>
<h3 id="5-1-3-android-readPermission"><a href="#5-1-3-android-readPermission" class="headerlink" title="5.1.3 android:readPermission"></a>5.1.3 <strong>android:readPermission</strong></h3><p>应用程序读取 provider 数据必须要有的权限。</p>
<h3 id="5-1-4-android-writePermission"><a href="#5-1-4-android-writePermission" class="headerlink" title="5.1.4 android:writePermission"></a>5.1.4 <strong>android:writePermission</strong></h3><p>应用程序向 provider 写入数据必须要有的权限。</p>
<h3 id="5-1-5-android-grantUriPermissions"><a href="#5-1-5-android-grantUriPermissions" class="headerlink" title="5.1.5 android:grantUriPermissions"></a>5.1.5 <strong>android:grantUriPermissions</strong></h3><p>用于临时授予应用程序访问该 provider 的全部 uri 的权限！</p>
<p>该属性默认为 false，通过该属性，那些没有被授予 permission/readPermission/writePermission 指定的权限的应用可以临时访问 provider！</p>
<ul>
<li><p>如果为 true，那么应用有权限临时访问该 provider 的所有数据；</p>
</li>
<li><p>如果为 false，那么应用将不会被授予临时权限，除非 provider 还设置 grant-uri-permission，那应用程序将有权限访问 grant-uri-permission 指定的特定数据子集！</p>
</li>
</ul>
<p>通过这种方式，可以让应用程序组件能够一次性地临时访问受权限保护的数据！ </p>
<p><strong>eg：</strong>当电子邮件包含附件时，邮件应用程序可能会调用适当的查看器来打开它，即使查看器没有一般的权限来查看所有内容提供者的数据。</p>
<p>可以通过设置 Intent.FLAG_GRANT_READ_URI_PERMISSION 和 Intent.FLAG_GRANT_WRITE_URI_PERMISSION 标志来授予对指定 Uri 的一次性的访问权限 。</p>
<p><strong>eg：</strong>邮件应用程序会将 FLAG_GRANT_READ_URI_PERMISSION 标志位传递给 Context.startActivity() 的 Intent，被启动的 actitivity 会获得上面的标志位和 Uri，从而具有对 uri 的读权限！</p>
<h3 id="5-1-6-provider-子标签"><a href="#5-1-6-provider-子标签" class="headerlink" title="5.1.6 provider 子标签"></a>5.1.6 provider 子标签</h3><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">path-permission</span> <span class="attr">android:path</span>=<span class="string">"string"</span></span></span><br><span class="line"><span class="tag">             <span class="attr">android:pathPrefix</span>=<span class="string">"string"</span></span></span><br><span class="line"><span class="tag">             <span class="attr">android:pathPattern</span>=<span class="string">"string"</span></span></span><br><span class="line"><span class="tag">             <span class="attr">android:permission</span>=<span class="string">"string"</span></span></span><br><span class="line"><span class="tag">             <span class="attr">android:readPermission</span>=<span class="string">"string"</span></span></span><br><span class="line"><span class="tag">             <span class="attr">android:writePermission</span>=<span class="string">"string"</span> /&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="tag">&lt;<span class="name">grant-uri-permission</span> <span class="attr">android:path</span>=<span class="string">"string"</span></span></span><br><span class="line"><span class="tag">                  <span class="attr">android:pathPrefix</span>=<span class="string">"string"</span> </span></span><br><span class="line"><span class="tag">                  <span class="attr">android:pathPattern</span>=<span class="string">"string"</span>/&gt;</span></span><br></pre></td></tr></table></figure>
<p>grant-uri-permission 和 path-permission 均为 provider 的子标签！</p>
<h4 id="5-1-6-1-grant-uri-permission"><a href="#5-1-6-1-grant-uri-permission" class="headerlink" title="5.1.6.1 grant-uri-permission"></a>5.1.6.1 <strong>grant-uri-permission</strong></h4><p>用于临时授予应用程序访问 provider 中指定 uri 的权限！</p>
<p>如果 provider 的 android:grantUriPermissions 属性为 true，那么应用程序可以临时访问该 provider 的所有 Uri 数据；</p>
<p>如果 android:grantUriPermissions 属性为 false，那么应用程序只能临时访问通过 grant-uri-permission 标签指定的特定 uri 子集！</p>
<p>一个 provider 可以定义多个 grant-uri-permission，每一个 grant-uri-permission 申明一个特定 uri 数据子集！</p>
<table>
<thead>
<tr>
<th>属性名</th>
<th style="text-align:left">解释</th>
</tr>
</thead>
<tbody>
<tr>
<td>android:path</td>
<td style="text-align:left">provider 的数据子集的完整 uri 路径</td>
</tr>
<tr>
<td>android:pathPrefix</td>
<td style="text-align:left">provider 数据子集的 uri 路径的初始部分</td>
</tr>
<tr>
<td>android:pathPattern</td>
<td style="text-align:left">provider 数据子集的完整 uri 路径，但可以使用通配符</td>
</tr>
</tbody>
</table>
<p>如果设置了 android:path，临时访问权限只能被授予给 path 指定的数据子集；</p>
<p>如果设置了 android:pathPrefix，临时访问权限将会被授予给具有 pathPrefix 初始部分的所有数据子集；</p>
<h4 id="5-1-6-2-path-permission"><a href="#5-1-6-2-path-permission" class="headerlink" title="5.1.6.2 path-permission"></a>5.1.6.2 <strong>path-permission</strong></h4><p>定义 provider 中特定数据子集的路径和所需权限，用于开放部分 Uri 数据的读写权限！</p>
<p>一个 provider 可以定义多个 path-permission，每一个 path-permission 申明一个特定 uri 数据子集！</p>
<table>
<thead>
<tr>
<th>属性名</th>
<th style="text-align:left">解释</th>
</tr>
</thead>
<tbody>
<tr>
<td>android:path</td>
<td style="text-align:left">provider 数据子集的完整 uri 路径</td>
</tr>
<tr>
<td>android:pathPrefix</td>
<td style="text-align:left">provider 数据子集的 uri 路径的初始部分</td>
</tr>
<tr>
<td>android:pathPattern</td>
<td style="text-align:left">provider 数据子集的完整 uri 路径，但可以使用通配符</td>
</tr>
<tr>
<td>android:permission</td>
<td style="text-align:left">读写权限，readPermission 和 writePermission 优先级</td>
</tr>
<tr>
<td>android:readPermission</td>
<td style="text-align:left">读数据的权限</td>
</tr>
<tr>
<td>android:writePermission</td>
<td style="text-align:left">写数据的权限</td>
</tr>
</tbody>
</table>
<p>如果设置了 android:path，临时访问权限只能被授予给 path 指定的数据子集；</p>
<p>如果设置了 android:pathPrefix，临时访问权限将会被授予给具有 pathPrefix 初始部分的所有数据子集；</p>
<h2 id="5-2-权限解析"><a href="#5-2-权限解析" class="headerlink" title="5.2 权限解析"></a>5.2 权限解析</h2><p>我们回到 PMS 中去，看下应用程序的 Provider 组件是如何被解析的，我们重点关注和权限相关的：</p>
<h3 id="5-2-1-PackageParser-parseProvider"><a href="#5-2-1-PackageParser-parseProvider" class="headerlink" title="5.2.1 PackageParser.parseProvider"></a>5.2.1 PackageParser.parseProvider</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">private</span> Provider <span class="title">parseProvider</span><span class="params">(Package owner, Resources res,</span></span></span><br><span class="line"><span class="function"><span class="params">        XmlResourceParser parser, <span class="keyword">int</span> flags, String[] outError)</span></span></span><br><span class="line"><span class="function">        <span class="keyword">throws</span> XmlPullParserException, IOException </span>&#123;</span><br><span class="line">    TypedArray sa = res.obtainAttributes(parser,</span><br><span class="line">            com.android.internal.R.styleable.AndroidManifestProvider);</span><br><span class="line">    ... ... ...</span><br><span class="line"></span><br><span class="line">    <span class="comment">//【1】创建一个 Provider 对象和 ProviderInfo 对象！</span></span><br><span class="line">    Provider p = <span class="keyword">new</span> Provider(mParseProviderArgs, <span class="keyword">new</span> ProviderInfo());</span><br><span class="line">    <span class="keyword">if</span> (outError[<span class="number">0</span>] != <span class="keyword">null</span>) &#123;</span><br><span class="line">        sa.recycle();</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">null</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">boolean</span> providerExportedDefault = <span class="keyword">false</span>;</span><br><span class="line">    <span class="keyword">if</span> (owner.applicationInfo.targetSdkVersion &lt; Build.VERSION_CODES.JELLY_BEAN_MR1) &#123;</span><br><span class="line">        providerExportedDefault = <span class="keyword">true</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">//【2】解析 android:exported 属性！</span></span><br><span class="line">    p.info.exported = sa.getBoolean(</span><br><span class="line">            com.android.internal.R.styleable.AndroidManifestProvider_exported,</span><br><span class="line">            providerExportedDefault);</span><br><span class="line">            </span><br><span class="line">    ... ... ...</span><br><span class="line"></span><br><span class="line">    <span class="comment">//【3】解析 android:permission 属性！</span></span><br><span class="line">    String permission = sa.getNonConfigurationString(</span><br><span class="line">            com.android.internal.R.styleable.AndroidManifestProvider_permission, <span class="number">0</span>);</span><br><span class="line">    <span class="comment">//【4】解析 android:readPermission 属性！</span></span><br><span class="line">    String str = sa.getNonConfigurationString(</span><br><span class="line">            com.android.internal.R.styleable.AndroidManifestProvider_readPermission, <span class="number">0</span>);</span><br><span class="line">    <span class="keyword">if</span> (str == <span class="keyword">null</span>) &#123;</span><br><span class="line">        str = permission;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span> (str == <span class="keyword">null</span>) &#123;</span><br><span class="line">        p.info.readPermission = owner.applicationInfo.permission;</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        p.info.readPermission =</span><br><span class="line">            str.length() &gt; <span class="number">0</span> ? str.toString().intern() : <span class="keyword">null</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">//【5】解析 android:writePermission 属性！</span></span><br><span class="line">    str = sa.getNonConfigurationString(</span><br><span class="line">            com.android.internal.R.styleable.AndroidManifestProvider_writePermission, <span class="number">0</span>);</span><br><span class="line">    <span class="keyword">if</span> (str == <span class="keyword">null</span>) &#123;</span><br><span class="line">        str = permission;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span> (str == <span class="keyword">null</span>) &#123;</span><br><span class="line">        p.info.writePermission = owner.applicationInfo.permission;</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        p.info.writePermission =</span><br><span class="line">            str.length() &gt; <span class="number">0</span> ? str.toString().intern() : <span class="keyword">null</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">//【6】解析 android:grantUriPermissions 属性！</span></span><br><span class="line">    p.info.grantUriPermissions = sa.getBoolean(</span><br><span class="line">            com.android.internal.R.styleable.AndroidManifestProvider_grantUriPermissions,</span><br><span class="line">            <span class="keyword">false</span>);</span><br><span class="line"></span><br><span class="line">    ... ... ...</span><br><span class="line"></span><br><span class="line">    <span class="comment">//【*5.2.2】调用 parseProviderTags 来解析子标签！</span></span><br><span class="line">    <span class="keyword">if</span> (!parseProviderTags(res, parser, p, outError)) &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">null</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> p;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>这里我们看到：</p>
<ul>
<li>在 API 17 以前，exported 默认是 true，因为这个属性是在 API 17 才引入的！</li>
<li>readPermission 和 writePermission 的优先级高于 permission，如果没有定义</li>
</ul>
<p>属性的处理：</p>
<ul>
<li>android:grantUriPermissions 属性的值会保存到 Provider.ProviderInfo.grantUriPermissions 中；</li>
<li>android:exported 属性的值会保存到 Provider.ProviderInfo.exported 中；</li>
<li>android:permission 属性和 android:readPermission 属性会保存到 Provider.ProviderInfo.readPermission 中；</li>
<li>android:permission 属性和 android:writePermission 属性会保存到 Provider.ProviderInfo.writePermission 中；</li>
</ul>
<h3 id="5-2-2-PackageParser-parseProviderTags"><a href="#5-2-2-PackageParser-parseProviderTags" class="headerlink" title="5.2.2 PackageParser.parseProviderTags"></a>5.2.2 PackageParser.parseProviderTags</h3><p>在 parseProviderTags 中会对 grant-uri-permission 和 path-permission 进行解析！</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">boolean</span> <span class="title">parseProviderTags</span><span class="params">(Resources res,</span></span></span><br><span class="line"><span class="function"><span class="params">        XmlResourceParser parser, Provider outInfo, String[] outError)</span></span></span><br><span class="line"><span class="function">        <span class="keyword">throws</span> XmlPullParserException, IOException </span>&#123;</span><br><span class="line">    <span class="keyword">int</span> outerDepth = parser.getDepth();</span><br><span class="line">    <span class="keyword">int</span> type;</span><br><span class="line">    <span class="keyword">while</span> ((type=parser.next()) != XmlPullParser.END_DOCUMENT</span><br><span class="line">           &amp;&amp; (type != XmlPullParser.END_TAG</span><br><span class="line">                   || parser.getDepth() &gt; outerDepth)) &#123;</span><br><span class="line">        <span class="keyword">if</span> (type == XmlPullParser.END_TAG || type == XmlPullParser.TEXT) &#123;</span><br><span class="line">            <span class="keyword">continue</span>;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (parser.getName().equals(<span class="string">"intent-filter"</span>)) &#123;</span><br><span class="line">            ProviderIntentInfo intent = <span class="keyword">new</span> ProviderIntentInfo(outInfo);</span><br><span class="line">            <span class="keyword">if</span> (!parseIntent(res, parser, <span class="keyword">true</span>, <span class="keyword">false</span>, intent, outError)) &#123;</span><br><span class="line">                <span class="keyword">return</span> <span class="keyword">false</span>;</span><br><span class="line">            &#125;</span><br><span class="line">            outInfo.intents.add(intent);</span><br><span class="line"></span><br><span class="line">        &#125; <span class="keyword">else</span> <span class="keyword">if</span> (parser.getName().equals(<span class="string">"meta-data"</span>)) &#123;</span><br><span class="line">            <span class="keyword">if</span> ((outInfo.metaData=parseMetaData(res, parser,</span><br><span class="line">                    outInfo.metaData, outError)) == <span class="keyword">null</span>) &#123;</span><br><span class="line">                <span class="keyword">return</span> <span class="keyword">false</span>;</span><br><span class="line">            &#125;</span><br><span class="line">            </span><br><span class="line">        <span class="comment">//【1】解析 grant-uri-permission</span></span><br><span class="line">        &#125; <span class="keyword">else</span> <span class="keyword">if</span> (parser.getName().equals(<span class="string">"grant-uri-permission"</span>)) &#123;</span><br><span class="line">            <span class="comment">// 获得其所有属性！</span></span><br><span class="line">            TypedArray sa = res.obtainAttributes(parser,</span><br><span class="line">                    com.android.internal.R.styleable.AndroidManifestGrantUriPermission);</span><br><span class="line">            <span class="comment">//【1.1】这里创建了一个 PatternMatcher 对象，用于封装 grant-uri-permission 的解析内容；</span></span><br><span class="line">            PatternMatcher pa = <span class="keyword">null</span>;</span><br><span class="line">            <span class="comment">//【1.2】pathPattern 优先级最高，接下来是 pathPrefix，最后是 pathPattern，优先级高会覆盖优先级低：</span></span><br><span class="line">            String str = sa.getNonConfigurationString(</span><br><span class="line">                    com.android.internal.R.styleable.AndroidManifestGrantUriPermission_path, <span class="number">0</span>); <span class="comment">// path 属性</span></span><br><span class="line">            <span class="keyword">if</span> (str != <span class="keyword">null</span>) &#123;</span><br><span class="line">                pa = <span class="keyword">new</span> PatternMatcher(str, PatternMatcher.PATTERN_LITERAL);</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            str = sa.getNonConfigurationString( <span class="comment">// pathPrefix 属性</span></span><br><span class="line">                    com.android.internal.R.styleable.AndroidManifestGrantUriPermission_pathPrefix, <span class="number">0</span>);</span><br><span class="line">            <span class="keyword">if</span> (str != <span class="keyword">null</span>) &#123;</span><br><span class="line">                pa = <span class="keyword">new</span> PatternMatcher(str, PatternMatcher.PATTERN_PREFIX);</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            str = sa.getNonConfigurationString(  <span class="comment">// pathPattern 属性</span></span><br><span class="line">                    com.android.internal.R.styleable.AndroidManifestGrantUriPermission_pathPattern, <span class="number">0</span>);</span><br><span class="line">            <span class="keyword">if</span> (str != <span class="keyword">null</span>) &#123;</span><br><span class="line">                pa = <span class="keyword">new</span> PatternMatcher(str, PatternMatcher.PATTERN_SIMPLE_GLOB);</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            sa.recycle();</span><br><span class="line"></span><br><span class="line">            <span class="keyword">if</span> (pa != <span class="keyword">null</span>) &#123;</span><br><span class="line">                <span class="comment">//【1.3】如果 provider 设置了以上三个属性（至少是一个），</span></span><br><span class="line">                <span class="comment">// 这里可以看出 provider 是支持多个 grant-uri-permission 的！</span></span><br><span class="line">                <span class="keyword">if</span> (outInfo.info.uriPermissionPatterns == <span class="keyword">null</span>) &#123;</span><br><span class="line">                    outInfo.info.uriPermissionPatterns = <span class="keyword">new</span> PatternMatcher[<span class="number">1</span>];</span><br><span class="line">                    outInfo.info.uriPermissionPatterns[<span class="number">0</span>] = pa;</span><br><span class="line">                &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                    <span class="keyword">final</span> <span class="keyword">int</span> N = outInfo.info.uriPermissionPatterns.length;</span><br><span class="line">                    PatternMatcher[] newp = <span class="keyword">new</span> PatternMatcher[N+<span class="number">1</span>];</span><br><span class="line">                    System.arraycopy(outInfo.info.uriPermissionPatterns, <span class="number">0</span>, newp, <span class="number">0</span>, N);</span><br><span class="line">                    newp[N] = pa;</span><br><span class="line">                    outInfo.info.uriPermissionPatterns = newp;</span><br><span class="line">                &#125;</span><br><span class="line">                <span class="comment">//【1.4】由于 provider 设置了 grant-uri-permission，也将 info.grantUriPermissions 置为 true；</span></span><br><span class="line">                outInfo.info.grantUriPermissions = <span class="keyword">true</span>;</span><br><span class="line">            &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                <span class="keyword">if</span> (!RIGID_PARSER) &#123;</span><br><span class="line">                    Slog.w(TAG, <span class="string">"Unknown element under &lt;path-permission&gt;: "</span></span><br><span class="line">                            + parser.getName() + <span class="string">" at "</span> + mArchiveSourcePath + <span class="string">" "</span></span><br><span class="line">                            + parser.getPositionDescription());</span><br><span class="line">                    XmlUtils.skipCurrentTag(parser);</span><br><span class="line">                    <span class="keyword">continue</span>;</span><br><span class="line">                &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                    outError[<span class="number">0</span>] = <span class="string">"No path, pathPrefix, or pathPattern for &lt;path-permission&gt;"</span>;</span><br><span class="line">                    <span class="keyword">return</span> <span class="keyword">false</span>;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">            XmlUtils.skipCurrentTag(parser);</span><br><span class="line"></span><br><span class="line">        <span class="comment">//【2】解析 path-permission</span></span><br><span class="line">        &#125; <span class="keyword">else</span> <span class="keyword">if</span> (parser.getName().equals(<span class="string">"path-permission"</span>)) &#123;</span><br><span class="line">            <span class="comment">//【2.1】获得其所有属性！</span></span><br><span class="line">            TypedArray sa = res.obtainAttributes(parser,</span><br><span class="line">                    com.android.internal.R.styleable.AndroidManifestPathPermission);</span><br><span class="line">            <span class="comment">//【2.2】这里创建了一个 PathPermission 对象，用于封装 path-permission 的解析内容；</span></span><br><span class="line">            PathPermission pa = <span class="keyword">null</span>;</span><br><span class="line">            <span class="comment">//【2.3】解析 readPermission 和 writePermission！</span></span><br><span class="line">            String permission = sa.getNonConfigurationString(</span><br><span class="line">                    com.android.internal.R.styleable.AndroidManifestPathPermission_permission, <span class="number">0</span>);</span><br><span class="line">            String readPermission = sa.getNonConfigurationString(</span><br><span class="line">                    com.android.internal.R.styleable.AndroidManifestPathPermission_readPermission, <span class="number">0</span>);</span><br><span class="line">            <span class="keyword">if</span> (readPermission == <span class="keyword">null</span>) &#123;</span><br><span class="line">                readPermission = permission;</span><br><span class="line">            &#125;</span><br><span class="line">            String writePermission = sa.getNonConfigurationString(</span><br><span class="line">                    com.android.internal.R.styleable.AndroidManifestPathPermission_writePermission, <span class="number">0</span>);</span><br><span class="line">            <span class="keyword">if</span> (writePermission == <span class="keyword">null</span>) &#123;</span><br><span class="line">                writePermission = permission;</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            <span class="keyword">boolean</span> havePerm = <span class="keyword">false</span>;</span><br><span class="line">            <span class="keyword">if</span> (readPermission != <span class="keyword">null</span>) &#123;</span><br><span class="line">                readPermission = readPermission.intern();</span><br><span class="line">                havePerm = <span class="keyword">true</span>;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">if</span> (writePermission != <span class="keyword">null</span>) &#123;</span><br><span class="line">                writePermission = writePermission.intern();</span><br><span class="line">                havePerm = <span class="keyword">true</span>;</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            <span class="keyword">if</span> (!havePerm) &#123;</span><br><span class="line">                <span class="keyword">if</span> (!RIGID_PARSER) &#123;</span><br><span class="line">                    Slog.w(TAG, <span class="string">"No readPermission or writePermssion for &lt;path-permission&gt;: "</span></span><br><span class="line">                            + parser.getName() + <span class="string">" at "</span> + mArchiveSourcePath + <span class="string">" "</span></span><br><span class="line">                            + parser.getPositionDescription());</span><br><span class="line">                    XmlUtils.skipCurrentTag(parser);</span><br><span class="line">                    <span class="keyword">continue</span>;</span><br><span class="line">                &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                    outError[<span class="number">0</span>] = <span class="string">"No readPermission or writePermssion for &lt;path-permission&gt;"</span>;</span><br><span class="line">                    <span class="keyword">return</span> <span class="keyword">false</span>;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="comment">//【2.4】pathPattern 优先级最高，接下来是 pathPrefix，最后是 pathPattern，优先级高覆盖优先级低！</span></span><br><span class="line">            String path = sa.getNonConfigurationString(</span><br><span class="line">                    com.android.internal.R.styleable.AndroidManifestPathPermission_path, <span class="number">0</span>);</span><br><span class="line">            <span class="keyword">if</span> (path != <span class="keyword">null</span>) &#123;</span><br><span class="line">                pa = <span class="keyword">new</span> PathPermission(path,</span><br><span class="line">                        PatternMatcher.PATTERN_LITERAL, readPermission, writePermission);</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            path = sa.getNonConfigurationString(</span><br><span class="line">                    com.android.internal.R.styleable.AndroidManifestPathPermission_pathPrefix, <span class="number">0</span>);</span><br><span class="line">            <span class="keyword">if</span> (path != <span class="keyword">null</span>) &#123;</span><br><span class="line">                pa = <span class="keyword">new</span> PathPermission(path,</span><br><span class="line">                        PatternMatcher.PATTERN_PREFIX, readPermission, writePermission);</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            path = sa.getNonConfigurationString(</span><br><span class="line">                    com.android.internal.R.styleable.AndroidManifestPathPermission_pathPattern, <span class="number">0</span>);</span><br><span class="line">            <span class="keyword">if</span> (path != <span class="keyword">null</span>) &#123;</span><br><span class="line">                pa = <span class="keyword">new</span> PathPermission(path,</span><br><span class="line">                        PatternMatcher.PATTERN_SIMPLE_GLOB, readPermission, writePermission);</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            sa.recycle();</span><br><span class="line">    </span><br><span class="line">            <span class="keyword">if</span> (pa != <span class="keyword">null</span>) &#123;</span><br><span class="line">                <span class="comment">//【2.5】如果 provider 设置了以上三个属性（至少是一个），</span></span><br><span class="line">                <span class="comment">// 这里可以看出 provider 是支持多个 path-permission 的！</span></span><br><span class="line">                <span class="keyword">if</span> (outInfo.info.pathPermissions == <span class="keyword">null</span>) &#123;</span><br><span class="line">                    outInfo.info.pathPermissions = <span class="keyword">new</span> PathPermission[<span class="number">1</span>];</span><br><span class="line">                    outInfo.info.pathPermissions[<span class="number">0</span>] = pa;</span><br><span class="line">                &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                    <span class="keyword">final</span> <span class="keyword">int</span> N = outInfo.info.pathPermissions.length;</span><br><span class="line">                    PathPermission[] newp = <span class="keyword">new</span> PathPermission[N+<span class="number">1</span>];</span><br><span class="line">                    System.arraycopy(outInfo.info.pathPermissions, <span class="number">0</span>, newp, <span class="number">0</span>, N);</span><br><span class="line">                    newp[N] = pa;</span><br><span class="line">                    outInfo.info.pathPermissions = newp;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                <span class="keyword">if</span> (!RIGID_PARSER) &#123;</span><br><span class="line">                    Slog.w(TAG, <span class="string">"No path, pathPrefix, or pathPattern for &lt;path-permission&gt;: "</span></span><br><span class="line">                            + parser.getName() + <span class="string">" at "</span> + mArchiveSourcePath + <span class="string">" "</span></span><br><span class="line">                            + parser.getPositionDescription());</span><br><span class="line">                    XmlUtils.skipCurrentTag(parser);</span><br><span class="line">                    <span class="keyword">continue</span>;</span><br><span class="line">                &#125;</span><br><span class="line">                outError[<span class="number">0</span>] = <span class="string">"No path, pathPrefix, or pathPattern for &lt;path-permission&gt;"</span>;</span><br><span class="line">                <span class="keyword">return</span> <span class="keyword">false</span>;</span><br><span class="line">            &#125;</span><br><span class="line">            XmlUtils.skipCurrentTag(parser);</span><br><span class="line"></span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            <span class="keyword">if</span> (!RIGID_PARSER) &#123;</span><br><span class="line">                Slog.w(TAG, <span class="string">"Unknown element under &lt;provider&gt;: "</span></span><br><span class="line">                        + parser.getName() + <span class="string">" at "</span> + mArchiveSourcePath + <span class="string">" "</span></span><br><span class="line">                        + parser.getPositionDescription());</span><br><span class="line">                XmlUtils.skipCurrentTag(parser);</span><br><span class="line">                <span class="keyword">continue</span>;</span><br><span class="line">            &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                outError[<span class="number">0</span>] = <span class="string">"Bad element under &lt;provider&gt;: "</span> + parser.getName();</span><br><span class="line">                <span class="keyword">return</span> <span class="keyword">false</span>;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">true</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h4 id="5-2-2-1-解析-grant-uri-permission"><a href="#5-2-2-1-解析-grant-uri-permission" class="headerlink" title="5.2.2.1 解析 grant-uri-permission"></a>5.2.2.1 解析 grant-uri-permission</h4><p>我们可以看到，三个属性中 pathPattern 优先级最高，接下来是 pathPrefix，最后是 pathPattern，优先级高的会覆盖优先级低的属性：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//【1】path 属性；</span></span><br><span class="line">String str = sa.getNonConfigurationString(</span><br><span class="line">        com.android.internal.R.styleable.AndroidManifestGrantUriPermission_path, <span class="number">0</span>);</span><br><span class="line"><span class="keyword">if</span> (str != <span class="keyword">null</span>) &#123;</span><br><span class="line">    pa = <span class="keyword">new</span> PatternMatcher(str, PatternMatcher.PATTERN_LITERAL);</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">//【2】pathPrefix 属性；</span></span><br><span class="line">str = sa.getNonConfigurationString(</span><br><span class="line">        com.android.internal.R.styleable.AndroidManifestGrantUriPermission_pathPrefix, <span class="number">0</span>);</span><br><span class="line"><span class="keyword">if</span> (str != <span class="keyword">null</span>) &#123;</span><br><span class="line">    pa = <span class="keyword">new</span> PatternMatcher(str, PatternMatcher.PATTERN_PREFIX);</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">//【3】pathPattern 属性；</span></span><br><span class="line">str = sa.getNonConfigurationString(</span><br><span class="line">        com.android.internal.R.styleable.AndroidManifestGrantUriPermission_pathPattern, <span class="number">0</span>);</span><br><span class="line"><span class="keyword">if</span> (str != <span class="keyword">null</span>) &#123;</span><br><span class="line">    pa = <span class="keyword">new</span> PatternMatcher(str, PatternMatcher.PATTERN_SIMPLE_GLOB);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>最后会创建一个 PatternMatcher 对象！</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="title">PatternMatcher</span><span class="params">(String pattern, <span class="keyword">int</span> type)</span> </span>&#123;</span><br><span class="line">    mPattern = pattern;</span><br><span class="line">    mType = type;</span><br><span class="line">    <span class="keyword">if</span> (mType == PATTERN_ADVANCED_GLOB) &#123;</span><br><span class="line">        mParsedPattern = parseAndVerifyAdvancedPattern(pattern);</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        mParsedPattern = <span class="keyword">null</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>如果 provider 设置了 grant-uri-permission，也会将前面的 p.info.grantUriPermissions 置为 true，即使应用没有显式设置 android:grantUriPermissions 的值；</p>
<p>解析得到的 PatternMatcher 会保存到 Provider.ProviderInfo.uriPermissionPatterns 数组中；</p>
<h4 id="5-2-2-2-解析-patch-permission"><a href="#5-2-2-2-解析-patch-permission" class="headerlink" title="5.2.2.2 解析 patch-permission"></a>5.2.2.2 解析 patch-permission</h4><p>同样的，三个属性中 pathPattern 优先级最高，接下来是 pathPrefix，最后是 pathPattern，优先级高的会覆盖优先级低的属性！</p>
<p>最后会创建一个 PathPermission 对象，PathPermission 是 PatternMatcher 的子类！<br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">PathPermission</span> <span class="keyword">extends</span> <span class="title">PatternMatcher</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="title">PathPermission</span><span class="params">(String pattern, <span class="keyword">int</span> type, String readPermission,</span></span></span><br><span class="line"><span class="function"><span class="params">            String writePermission)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">super</span>(pattern, type);</span><br><span class="line">        mReadPermission = readPermission;</span><br><span class="line">        mWritePermission = writePermission;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>所以，大家应该明白 String pattern, int type 是如何处理的了！</p>
<p>解析得到的 PathPermission 会保存到 Provider.ProviderInfo.pathPermissions 数组中；</p>
<h1 id="6-权限知识点总结"><a href="#6-权限知识点总结" class="headerlink" title="6 权限知识点总结"></a>6 权限知识点总结</h1><p>我们知道，权限的 protectionLevel 分为基本权限类型和附加的标志位：</p>
<h2 id="6-1-基本权限类型"><a href="#6-1-基本权限类型" class="headerlink" title="6.1 基本权限类型"></a>6.1 基本权限类型</h2><p>下表显示了所有基本权限类型：</p>
<table>
<thead>
<tr>
<th>基本权限类型</th>
<th style="text-align:center">取值</th>
<th style="text-align:left">解释</th>
</tr>
</thead>
<tbody>
<tr>
<td><strong>normal</strong></td>
<td style="text-align:center">0</td>
<td style="text-align:left">默认值，这种权限是风险较低的权限，安装时，系统会自动授予这种类型的权限给请求应用程序。</td>
</tr>
<tr>
<td><strong>dangerous</strong></td>
<td style="text-align:center">1</td>
<td style="text-align:left">这种权限是风险较高的权限，因此系统可能不会自动将其授予请求的应用程序，而是需要应用显式的申请。</td>
</tr>
<tr>
<td><strong>signature</strong></td>
<td style="text-align:center">2</td>
<td style="text-align:left">仅当请求权限的应用程序使用与声明权限的应用程序相同的证书签名时，系统才会授予该权限。如果签名匹配，系统会自动授予权限，而不需要通知用户或要求用户明确批准；如果签名不匹配，一些 signature 权限需要用户显式申请。</td>
</tr>
<tr>
<td><strong>signatureOrSystem</strong></td>
<td style="text-align:center">3</td>
<td style="text-align:left">该权限只会授予和声明权限的应用程序相同的证书签名的应用或者系统分区应用，避免使用此选项，因为 signature 保护级别应该足以满足大多数需求，并且可以工作，而不管应用程序的安装位置。<strong>在 API 级别 23 中已弃用</strong>，现在用 “signature\</td>
<td>privileged” 替代； “ signatureOrSystem” 许可用于某些特定情况，其中多个供应商将应用程序内置到系统映像中，并且需要明确地共享特定功能，因为它们正在构建在一起。</td>
</tr>
</tbody>
</table>
<p>小小的思考：</p>
<ul>
<li>normal 类型的权限，无论是系统应用还是三方应用都会默认授予；</li>
<li>dangerous 类型的权限，无论是系统应用还是三方应用都需要显式申请，但是系统会有一个类会给某些系统应用默认授予这些权限；</li>
<li>那么 signature 类型的权限的意义就很显然了，对于系统定义的 signature 权限，系统应用会默认授予；而对于三方应用，一些  signature 权限其无法申请，而另外一些  signature 权限，三方应用可以通过一定的方式申请，这些权限是一些特殊的权限！</li>
</ul>
<h2 id="6-2-附加标志位"><a href="#6-2-附加标志位" class="headerlink" title="6.2 附加标志位"></a>6.2 附加标志位</h2><p>对于 signature 类型的权限，可以配合下面的特殊的附加标志位：</p>
<table>
<thead>
<tr>
<th>附加标志位</th>
<th style="text-align:center">取值</th>
<th style="text-align:left">解释</th>
</tr>
</thead>
<tbody>
<tr>
<td><strong>appop</strong></td>
<td style="text-align:center">40</td>
<td style="text-align:left">该权限与用于控制访问的 app op 密切相关，也就是我们说的 AppOpsManager。</td>
</tr>
<tr>
<td><strong>development</strong></td>
<td style="text-align:center">20</td>
<td style="text-align:left">此权限也<strong>可以授予</strong>（可选）给开发应用程序。</td>
</tr>
<tr>
<td><strong>installer</strong></td>
<td style="text-align:center">100</td>
<td style="text-align:left">此权限可以<strong>自动授予</strong>安装软件包的系统应用程序，就是我们的 PackageInstaller</td>
</tr>
<tr>
<td><strong>instant</strong></td>
<td style="text-align:center">1000</td>
<td style="text-align:left">此权限<strong>可被授予</strong>给即时应用程序（instant app）</td>
</tr>
<tr>
<td><strong>oem</strong></td>
<td style="text-align:center">4000</td>
<td style="text-align:left"></td>
</tr>
<tr>
<td><strong>pre23</strong></td>
<td style="text-align:center">80</td>
<td style="text-align:left">此权限会自动授予低于 M（在引入运行时权限之前）的 API 级别的应用程序。</td>
</tr>
<tr>
<td><strong>preinstalled</strong></td>
<td style="text-align:center">400</td>
<td style="text-align:left">此权限可以<strong>自动授予</strong> system 分区预先安装的任何应用程序（不仅仅是特权应用程序）。</td>
</tr>
<tr>
<td><strong>privileged</strong></td>
<td style="text-align:center">10</td>
<td style="text-align:left">此权限也<strong>可以授予</strong>安装在 system 分区的特权应用。请避免使用此标志位，因为 signature 保护级别已足以满足大多数需求，并且无论应用程序的安装位置如何，都能正常工作。 此权限标志用于某些特殊情况，其中多个供应商将应用程序内置到系统映像中，需要明确地共享特定功能。</td>
</tr>
<tr>
<td><strong>runtime</strong></td>
<td style="text-align:center">2000</td>
<td style="text-align:left">此权限<strong>只能被授予</strong>适用于运行时权限（M 及以上）的应用程序</td>
</tr>
<tr>
<td><strong>setup</strong></td>
<td style="text-align:center">800</td>
<td style="text-align:left">此权限可以被<strong>自动授予</strong>给开机向导应用程序（setup wizard app）</td>
</tr>
<tr>
<td><strong>system</strong></td>
<td style="text-align:center">10</td>
<td style="text-align:left">在 API 级别 23 中已弃用，用 privileged 替代</td>
</tr>
<tr>
<td><strong>textClassifier</strong></td>
<td style="text-align:center">10000</td>
<td style="text-align:left">此权限可以被<strong>自动授予</strong>给系统默认的文本解析器</td>
</tr>
<tr>
<td><strong>vendorPrivileged</strong></td>
<td style="text-align:center">8000</td>
<td style="text-align:left">此权限可以被授予给供应商（vendor）分区中的特权应用程序。</td>
</tr>
<tr>
<td><strong>verifier</strong></td>
<td style="text-align:center">200</td>
<td style="text-align:left">此权限可以被<strong>自动授予</strong>给验证软件包的系统应用程序。</td>
</tr>
</tbody>
</table>
<p>注：如果保护级别设置了额外的标志位，那么其基本权限类型必须是 signature！</p>
<h2 id="6-3-权限组"><a href="#6-3-权限组" class="headerlink" title="6.3 权限组"></a>6.3 权限组</h2><p>任何权限都可以属于某个权限组，所有的 dangerous 权限都有所属的组，但是，权限组只有在申请的权限是 dangerous 权限是才会对用户体验有影响！</p>
<p>在 Android 6.0 （API level 23）以及以上，如果应用的 targetSdkVersion &gt;= 23 ，系统是这样处理运行时权限的申请的：</p>
<ul>
<li>如果应用程序没有被授予权限组中的任何运行时权限，在申请权限时，系统会向用户显示描述应用程序要访问的权限组的权限请求对话框。 但是该对话框不会描述该组中的特定权限的信息。如果用户同意授予权限，该权限将被授予。</li>
<li>如果应用程序已经被授予同一权限组中的某个权限，则对于其他权限，系统会立即授予权限，而不与用户进行任何交互。 例如：如果应用程序先前已请求并已获得READ_CONTACTS权限，然后它请求WRITE_CONTACTS，则系统会立即授予该权限，而不向用户显示权限对话框。</li>
</ul>
<p>在 Android 5.1 （API level 22）以及以下，或者应用的 targetSdkVersion &lt;= 22：</p>
<ul>
<li>系统会在应用安装的时候授予所有的运行时权限；同时，也是只会告诉用户应用程序需要哪些权限组，而不是单个权限。</li>
</ul>
<h2 id="6-4-特殊权限"><a href="#6-4-特殊权限" class="headerlink" title="6.4 特殊权限"></a>6.4 特殊权限</h2><h3 id="6-4-1-signature-with-appop"><a href="#6-4-1-signature-with-appop" class="headerlink" title="6.4.1 signature with appop"></a>6.4.1 signature with appop</h3><p>signature 权限中有几个权限特殊，signature 权限本身是安装时权限，但是当其设置了 appop 标志位的时候，其可以通过 appOps 动态管理。</p>
<p>Android7.1.1 提供了如下 signature appop 权限：</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">permission</span> <span class="attr">android:name</span>=<span class="string">"android.permission.WRITE_SETTINGS"</span></span></span><br><span class="line"><span class="tag">    <span class="attr">android:label</span>=<span class="string">"@string/permlab_writeSettings"</span></span></span><br><span class="line"><span class="tag">    <span class="attr">android:description</span>=<span class="string">"@string/permdesc_writeSettings"</span></span></span><br><span class="line"><span class="tag">    <span class="attr">android:protectionLevel</span>=<span class="string">"signature|preinstalled|appop|pre23"</span> /&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="tag">&lt;<span class="name">permission</span> <span class="attr">android:name</span>=<span class="string">"android.permission.SYSTEM_ALERT_WINDOW"</span></span></span><br><span class="line"><span class="tag">    <span class="attr">android:label</span>=<span class="string">"@string/permlab_systemAlertWindow"</span></span></span><br><span class="line"><span class="tag">    <span class="attr">android:description</span>=<span class="string">"@string/permdesc_systemAlertWindow"</span></span></span><br><span class="line"><span class="tag">    <span class="attr">android:protectionLevel</span>=<span class="string">"signature|preinstalled|appop|pre23|development"</span> /&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="tag">&lt;<span class="name">permission</span> <span class="attr">android:name</span>=<span class="string">"android.permission.PACKAGE_USAGE_STATS"</span></span></span><br><span class="line"><span class="tag">    <span class="attr">android:protectionLevel</span>=<span class="string">"signature|privileged|development|appop"</span> /&gt;</span></span><br></pre></td></tr></table></figure>
<p>这三个权限，可以通过 AppOps 的方式来授予那些签名不匹配的应用！</p>
<h3 id="6-4-1-signature-with-bind-service"><a href="#6-4-1-signature-with-bind-service" class="headerlink" title="6.4.1 signature with bind service"></a>6.4.1 signature with bind service</h3><p>signature 内部还有一些权限的使用方式也很特殊，应用需要配置这个权限，但是应用自身并不是权限的申请方：<br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line">BIND_ACCESSIBILITY_SERVICE</span><br><span class="line">BIND_AUTOFILL_SERVICE</span><br><span class="line">BIND_CARRIER_SERVICES</span><br><span class="line">BIND_CHOOSER_TARGET_SERVICE</span><br><span class="line">BIND_CONDITION_PROVIDER_SERVICE</span><br><span class="line">BIND_DEVICE_ADMIN</span><br><span class="line">BIND_DREAM_SERVICE</span><br><span class="line">BIND_INCALL_SERVICE</span><br><span class="line">BIND_INPUT_METHOD</span><br><span class="line">BIND_MIDI_DEVICE_SERVICE</span><br><span class="line">BIND_NFC_SERVICE</span><br><span class="line">BIND_NOTIFICATION_LISTENER_SERVICE</span><br><span class="line">BIND_PRINT_SERVICE</span><br><span class="line">BIND_SCREENING_SERVICE</span><br><span class="line">BIND_TELECOM_CONNECTION_SERVICE</span><br><span class="line">BIND_TEXT_SERVICE</span><br><span class="line">BIND_TV_INPUT</span><br><span class="line">BIND_VISUAL_VOICEMAIL_SERVICE</span><br><span class="line">BIND_VOICE_INTERACTION</span><br><span class="line">BIND_VPN_SERVICE</span><br><span class="line">BIND_VR_LISTENER_SERVICE</span><br><span class="line">BIND_WALLPAPER</span><br></pre></td></tr></table></figure></p>
<p>这些权限的使用后面会单独写一篇博文记录下！</p>
</div></article><div class="post-copyright"><div class="post-copyright__author"><span class="post-copyright-meta">文章作者: </span><span class="post-copyright-info"><a href="mailto:undefined">Coolqi.Li</a></span></div><div class="post-copyright__type"><span class="post-copyright-meta">文章链接: </span><span class="post-copyright-info"><a href="http://yoursite.com/2017/05/09/Permission第 1 篇 - Permission 配置和解析/">http://yoursite.com/2017/05/09/Permission第 1 篇 - Permission 配置和解析/</a></span></div><div class="post-copyright__notice"><span class="post-copyright-meta">版权声明: </span><span class="post-copyright-info">本博客所有文章除特别声明外，均采用 <a href="https://creativecommons.org/licenses/by-nc-sa/4.0/">CC BY-NC-SA 4.0</a> 许可协议。转载请注明来自 <a href="http://yoursite.com">Coolqi`s Blog</a>！</span></div></div><div class="post-meta__tag-list"><a class="post-meta__tags" href="/tags/Permission权限管理/">Permission权限管理</a></div><div class="post-qr-code"><div class="post-qr-code-item"><img class="post-qr-code__img" src="/img/zfb.jpg"><div class="post-qr-code__desc">支付宝打赏</div></div><div class="post-qr-code-item"><img class="post-qr-code__img" src="/img/wechat.jpg"><div class="post-qr-code__desc">微信打赏</div></div></div><nav id="pagination"><div class="prev-post pull-left"><a href="/2017/05/13/Permission第 2 篇 - PackageManager 对权限的初始化流程/"><i class="fa fa-chevron-left">  </i><span>Permission第 2 篇 - PackageManager 对权限的初始化流程</span></a></div><div class="next-post pull-right"><a href="/2017/05/03/UsageStats 第 3 篇 - UserUsageStatsService 逻辑分析/"><span>UsageStats 第 3 篇 - UserUsageStatsService 逻辑分析</span><i class="fa fa-chevron-right"></i></a></div></nav><div class="post-adv"><a href="https://www.vultr.com/?ref=7231808"><img src="https://www.vultr.com/media/banner_1.png" width="728" height="90"></a></div></div></div><footer><div class="layout" id="footer"><div class="copyright">&copy;2015 - 2019 By Coolqi.Li</div><div class="framework-info"><span>驱动 - </span><a href="http://hexo.io"><span>Hexo</span></a><span class="footer-separator">|</span><span>主题 - </span><a href="https://github.com/Molunerfinn/hexo-theme-melody"><span>Melody</span></a></div><div class="footer_custom_text">Hi, welcome to my <a href="https://molunerfinn.com">blog</a>!</div><div class="busuanzi"><script async src="//dn-lbstatics.qbox.me/busuanzi/2.3/busuanzi.pure.mini.js"></script><span id="busuanzi_container_page_pv"><i class="fa fa-file-o"></i><span id="busuanzi_value_page_pv"></span><span></span></span></div></div></footer><i class="fa fa-arrow-up" id="go-up" aria-hidden="true"></i><script src="/js/third-party/anime.min.js"></script><script src="/js/third-party/jquery.min.js"></script><script src="/js/third-party/jquery.fancybox.min.js"></script><script src="/js/third-party/velocity.min.js"></script><script src="/js/third-party/velocity.ui.min.js"></script><script src="/js/utils.js?version=1.5.6"></script><script src="/js/fancybox.js?version=1.5.6"></script><script src="/js/sidebar.js?version=1.5.6"></script><script src="/js/copy.js?version=1.5.6"></script><script src="/js/fireworks.js?version=1.5.6"></script><script src="/js/transition.js?version=1.5.6"></script><script src="/js/scroll.js?version=1.5.6"></script><script src="/js/head.js?version=1.5.6"></script><script type="text/x-mathjax-config">MathJax.Hub.Config({
  tex2jax: {
    inlineMath: [ ['$','$'], ["\\(","\\)"]  ],
    processEscapes: true,
    skipTags: ['script', 'noscript', 'style', 'textarea', 'pre', 'code']
  },
  CommonHTML: {
    linebreaks: { automatic: true, width: "90% container" }
  },
  "HTML-CSS": { 
    linebreaks: { automatic: true, width: "90% container" }
  },
  "SVG": { 
    linebreaks: { automatic: true, width: "90% container" }
  }
});
</script><script type="text/x-mathjax-config">MathJax.Hub.Queue(function() {
  var all = MathJax.Hub.getAllJax(), i;
  for (i=0; i < all.length; i += 1) {
    all[i].SourceElement().parentNode.className += ' has-jax';
  }
});
</script><script src="https://cdn.jsdelivr.net/npm/mathjax/MathJax.js?config=TeX-AMS-MML_HTMLorMML"></script><script src="/js/search/local-search.js"></script><div class="search-dialog" id="local-search"><div class="search-dialog__title" id="local-search-title">本地搜索</div><div id="local-input-panel"><div id="local-search-input"><div class="local-search-box"><input class="local-search-box--input" placeholder="搜索文章"></div></div></div><hr><div id="local-search-results"><div id="local-hits"></div><div id="local-stats"><div class="local-search-stats__hr" id="hr"><span>由</span> <a href="https://github.com/wzpan/hexo-generator-search" style="color:#49B1F5;">hexo-generator-search</a>
 <span>提供支持</span></div></div></div><span class="search-close-button"><i class="fa fa-times"></i></span></div><div class="search-mask"></div></body></html>
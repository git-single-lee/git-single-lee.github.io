<!DOCTYPE html><html lang="zh-Hans"><head><meta charset="UTF-8"><meta http-equiv="X-UA-Compatible" content="IE=edge"><meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1"><meta name="description" content="AppOps 第 3 篇 - AppOps 权限相关方法"><meta name="keywords" content="AppOps应用操作管理"><meta name="author" content="Coolqi.Li,undefined"><meta name="copyright" content="Coolqi.Li"><title>AppOps 第 3 篇 - AppOps 权限相关方法 | Coolqi`s Blog</title><link rel="shortcut icon" href="/img/favicon.ico"><link rel="stylesheet" href="/css/index.css?version=1.5.6"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/font-awesome@4.7.0/css/font-awesome.min.css?version=1.5.6"><link rel="dns-prefetch" href="https://cdn.staticfile.org"><link rel="dns-prefetch" href="https://cdn.bootcss.com"><link rel="dns-prefetch" href="https://creativecommons.org"><link rel="stylesheet" type="text/css" href="https://cdn.jsdelivr.net/npm/gitalk/dist/gitalk.min.css"><script src="https://cdn.jsdelivr.net/gh/upupming/gitalk@36368e5dffd049e956cdbbd751ff96c28d8255cf/dist/gitalk.min.js"></script><script src="https://cdn.jsdelivr.net/npm/blueimp-md5@2.10.0/js/md5.min.js"></script><script>var GLOBAL_CONFIG = { 
  root: '/',
  algolia: undefined,
  localSearch: {"path":"search.xml","languages":{"hits_empty":"找不到您查询的内容:${query}"}},
  copy: {
    success: '复制成功',
    error: '复制错误',
    noSupport: '浏览器不支持'
  }
} </script></head><body><canvas class="fireworks"></canvas><i class="fa fa-arrow-right" id="toggle-sidebar" aria-hidden="true"></i><div id="sidebar"><div class="toggle-sidebar-info text-center"><span data-toggle="切换文章详情">切换站点概览</span><hr></div><div class="sidebar-toc"><div class="sidebar-toc__title">目录</div><div class="sidebar-toc__progress"><span class="progress-notice">你已经读了</span><span class="progress-num">0</span><span class="progress-percentage">%</span><div class="sidebar-toc__progress-bar"></div></div><div class="sidebar-toc__content"><ol class="toc"><li class="toc-item toc-level-1"><a class="toc-link" href="#0-综述"><span class="toc-text">0 综述</span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#1-AppOpsService-checkOperation-检查操作权限"><span class="toc-text">1 AppOpsService.checkOperation - 检查操作权限</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#1-1-verifyIncomingUid"><span class="toc-text">1.1 verifyIncomingUid</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#1-2-verifyIncomingOp"><span class="toc-text">1.2 verifyIncomingOp</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#1-3-resolvePackageName"><span class="toc-text">1.3 resolvePackageName</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#1-4-isOpRestrictedLocked"><span class="toc-text">1.4 isOpRestrictedLocked</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#1-4-1-ClientRestrictionState-hasRestriction"><span class="toc-text">1.4.1 ClientRestrictionState.hasRestriction</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#1-4-2-getOpsRawLocked"><span class="toc-text">1.4.2 getOpsRawLocked</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#1-5-getUidStateLocked"><span class="toc-text">1.5 getUidStateLocked</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#1-6-getOpLocked"><span class="toc-text">1.6 getOpLocked</span></a></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#2-AppOpsService-noteOperation-检查操作权限"><span class="toc-text">2 AppOpsService.noteOperation - 检查操作权限</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#2-1-noteOperationUnchecked"><span class="toc-text">2.1 noteOperationUnchecked</span></a></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#3-AppOpsService-setUidMode-设置-uid-的-op-模式"><span class="toc-text">3 AppOpsService.setUidMode - 设置 uid 的 op 模式</span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#4-AppOpsService-setMode-设置-package-的-op-模式"><span class="toc-text">4 AppOpsService.setMode - 设置 package 的 op 模式</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#4-1-pruneOp"><span class="toc-text">4.1 pruneOp</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#4-2-scheduleFastWriteLocked"><span class="toc-text">4.2 scheduleFastWriteLocked</span></a></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#5-AppOpsService-startWatchingMode-监听-op-变化"><span class="toc-text">5 AppOpsService.startWatchingMode - 监听 op 变化</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#5-1-new-Callback"><span class="toc-text">5.1 new Callback</span></a></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#6-AppOpsService-stopWatchingMode-停止-op-监听"><span class="toc-text">6 AppOpsService.stopWatchingMode - 停止 op 监听</span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#7-AppOpsService-startOperation-开始监视操作"><span class="toc-text">7 AppOpsService.startOperation - 开始监视操作</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#7-1-AppOpsManager-getToken"><span class="toc-text">7.1 AppOpsManager.getToken</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#7-2-AppOpsService-getToken"><span class="toc-text">7.2 AppOpsService.getToken</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#7-2-1-new-ClientState-被监控的实体信息"><span class="toc-text">7.2.1 new ClientState - 被监控的实体信息</span></a></li></ol></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#8-AppOpsService-finishOperation-结束监视操作"><span class="toc-text">8 AppOpsService.finishOperation - 结束监视操作</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#8-1-finishOperationLocked"><span class="toc-text">8.1 finishOperationLocked</span></a></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#9-AppOpsService-setUserRestriction-设置用户限制"><span class="toc-text">9 AppOpsService.setUserRestriction - 设置用户限制</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#9-1-setUserRestrictionNoCheck"><span class="toc-text">9.1 setUserRestrictionNoCheck</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#9-2-new-ClientRestrictionState"><span class="toc-text">9.2 new ClientRestrictionState</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#9-3-ClientRestrictionState-setRestriction"><span class="toc-text">9.3 ClientRestrictionState.setRestriction</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#9-3-1-ClientRestrictionState-isDefault"><span class="toc-text">9.3.1 ClientRestrictionState.isDefault</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#9-4-notifyWatchersOfChange"><span class="toc-text">9.4 notifyWatchersOfChange</span></a></li></ol></li></ol></div></div><div class="author-info hide"><div class="author-info__avatar text-center"><img src="/img/avatar.png"></div><div class="author-info__name text-center">Coolqi.Li</div><div class="author-info__description text-center">“你好，我是李帅奇，Android 系统工程师，MineCraft 忠实玩家，设计和绘画爱好者，缺妹纸晚期患者，熬夜星人。”</div><hr><div class="author-info-articles"><a class="author-info-articles__archives article-meta" href="/archives"><span class="pull-left">文章</span><span class="pull-right">64</span></a><a class="author-info-articles__tags article-meta" href="/tags"><span class="pull-left">标签</span><span class="pull-right">14</span></a><a class="author-info-articles__categories article-meta" href="/categories"><span class="pull-left">分类</span><span class="pull-right">15</span></a></div><hr><div class="author-info-links"><div class="author-info-links__title text-center">Links</div><a class="author-info-links__name text-center" href="https://developer.android.google.cn/">AndroidDeveloper</a><a class="author-info-links__name text-center" href="http://www.android-studio.org/">AndroidStudio</a><a class="author-info-links__name text-center" href="https://www.jianshu.com/u/123a20a96441">简书</a><a class="author-info-links__name text-center" href="https://weibo.com/coolqiLi">微博</a></div></div></div><div id="content-outer"><div id="top-container" style="background-image: url(https://ws1.sinaimg.cn/large/8700af19ly1fvpabr30o6j22yo1o0q7i.jpg)"><div id="page-header"><span class="pull-left"> <a id="site-name" href="/">Coolqi`s Blog</a></span><i class="fa fa-bars toggle-menu pull-right" aria-hidden="true"></i><span class="pull-right menus"><a class="site-page social-icon search"><i class="fa fa-search"></i><span> 搜索</span></a><a class="site-page" href="/">Home</a><a class="site-page" href="/categories">Categories</a><a class="site-page" href="/tags">Tags</a><a class="site-page" href="/about">About</a><a class="site-page" href="/archives">Archives</a></span></div><div id="post-info"><div id="post-title">AppOps 第 3 篇 - AppOps 权限相关方法</div><div id="post-meta"><time class="post-meta__date"><i class="fa fa-calendar" aria-hidden="true"></i> 2017-09-10</time><span class="post-meta__separator">|</span><i class="fa fa-inbox post-meta__icon" aria-hidden="true"></i><a class="post-meta__categories" href="/categories/AndroidFramework源码分析/">AndroidFramework源码分析</a><i class="fa fa-angle-right" aria-hidden="true"></i><i class="fa fa-inbox post-meta__icon" aria-hidden="true"></i><a class="post-meta__categories" href="/categories/AndroidFramework源码分析/AppOps应用操作管理/">AppOps应用操作管理</a><div class="post-meta-wordcount"><span>字数总计: </span><span class="word-count">8.1k</span><span class="post-meta__separator">|</span><span>阅读时长: 36 分钟</span></div></div></div></div><div class="layout" id="content-inner"><article id="post"><div class="article-container" id="post-content"><p>本文基于 Android 7.1.1 源码分析，如有错误，欢迎指正，谢谢！</p>
<p>[toc]</p>
<h1 id="0-综述"><a href="#0-综述" class="headerlink" title="0 综述"></a>0 综述</h1><p>前面分析了 AppOpsManager 中的一些接口，最终都会调用 AppOpservice 中的相应接口，下面我们来看下 AppOpservice 中的权限操作！</p>
<p>涉及的类如下：</p>
<ul>
<li>Settings 上层应用入口：</li>
</ul>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">packages/apps/Settings/src/com/android/settings/applications/AppOpsCategory.java</span><br><span class="line">packages/apps/Settings/src/com/android/settings/applications/AppOpsDetails.java</span><br><span class="line">packages/apps/Settings/src/com/android/settings/applications/AppOpsState.java</span><br><span class="line">packages/apps/Settings/src/com/android/settings/applications/AppOpsSummary.java</span><br></pre></td></tr></table></figure>
<ul>
<li>appops 的可执行文件：</li>
</ul>
<p>位于 /system/bin/ 目录下！</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">frameworks/native/libs/binder/AppOpsManager.cpp</span><br><span class="line">frameworks/native/include/binder/AppOpsManager.h</span><br></pre></td></tr></table></figure>
<ul>
<li>框架层 AppOps 核心实现类：</li>
</ul>
<p>AppOpsService 是功能具体实现；AppOpsManager 是 AppOpsService 提供给其他进程的一个入口； AppOpsPolicy大概意思是，系统出厂时预制的系统 App(System-app)和用户 app（User-app）的一些默认的权限！<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">frameworks/base/services/core/java/com/android/server/AppOpsService.java</span><br><span class="line">frameworks/base/core/java/android/app/AppOpsManager.java</span><br></pre></td></tr></table></figure></p>
<p>这里我们重点关注核心服务 AppOpsService  的实现，下面分析下一些核心的方法接口！</p>
<h1 id="1-AppOpsService-checkOperation-检查操作权限"><a href="#1-AppOpsService-checkOperation-检查操作权限" class="headerlink" title="1 AppOpsService.checkOperation - 检查操作权限"></a>1 AppOpsService.checkOperation - 检查操作权限</h1><p>checkOperation 用于检查指定 package 是否有权限执行指定操作！</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">int</span> <span class="title">checkOperation</span><span class="params">(<span class="keyword">int</span> code, <span class="keyword">int</span> uid, String packageName)</span> </span>&#123;</span><br><span class="line">    <span class="comment">//【×1.1】校验 uid 是否有 UPDATE_APP_OPS_STATS 权限；</span></span><br><span class="line">    verifyIncomingUid(uid);</span><br><span class="line">    <span class="comment">//【×1.2】校验 op code 是否正确！</span></span><br><span class="line">    verifyIncomingOp(code);</span><br><span class="line">    <span class="comment">//【×1.3】处理包名！</span></span><br><span class="line">    String resolvedPackageName = resolvePackageName(uid, packageName);</span><br><span class="line">    <span class="keyword">if</span> (resolvedPackageName == <span class="keyword">null</span>) &#123;</span><br><span class="line">        <span class="keyword">return</span> AppOpsManager.MODE_IGNORED; <span class="comment">// 如果 package 为 null，返回 MODE_IGNORED！</span></span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">synchronized</span> (<span class="keyword">this</span>) &#123;</span><br><span class="line">        <span class="comment">//【×1.4】判断该 operation 是否收到用户限制，如果有，返回 MODE_IGNORED！</span></span><br><span class="line">        <span class="keyword">if</span> (isOpRestrictedLocked(uid, code, resolvedPackageName)) &#123;</span><br><span class="line">            <span class="keyword">return</span> AppOpsManager.MODE_IGNORED;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">//【2】获得决定 code 指定 op 的模式的 op，调用 AppOpsManager.opToSwitch 方法！</span></span><br><span class="line">        code = AppOpsManager.opToSwitch(code);</span><br><span class="line"></span><br><span class="line">        <span class="comment">//【×1.5】判断该 uid 是否允许执行该操作，如果不允许，返回已有的模式状态；</span></span><br><span class="line">        UidState uidState = getUidStateLocked(uid, <span class="keyword">false</span>);</span><br><span class="line">        <span class="keyword">if</span> (uidState != <span class="keyword">null</span> &amp;&amp; uidState.opModes != <span class="keyword">null</span>) &#123;</span><br><span class="line">            <span class="keyword">final</span> <span class="keyword">int</span> uidMode = uidState.opModes.get(code);</span><br><span class="line">            <span class="keyword">if</span> (uidMode != AppOpsManager.MODE_ALLOWED) &#123;</span><br><span class="line">                <span class="keyword">return</span> uidMode;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">//【×1.6】如果该 uid 允许执行该操作，那就进一步判断该 package 是否允许执行该操作，</span></span><br><span class="line">        <span class="comment">// 如果没有定义，返回默认状态；否则返回已有的模式状态；</span></span><br><span class="line">        Op op = getOpLocked(code, uid, resolvedPackageName, <span class="keyword">false</span>);</span><br><span class="line">        <span class="keyword">if</span> (op == <span class="keyword">null</span>) &#123;</span><br><span class="line">            <span class="keyword">return</span> AppOpsManager.opToDefaultMode(code);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> op.mode;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>其实我们知道，该方法返回值有如下几种：MODE_ALLOWED，MODE_IGNORED，MODE_ERRORED 和 MODE_DEFAULT！</p>
<h2 id="1-1-verifyIncomingUid"><a href="#1-1-verifyIncomingUid" class="headerlink" title="1.1 verifyIncomingUid"></a>1.1 verifyIncomingUid</h2><p>校验 uid 是否具有 android.Manifest.permission.UPDATE_APP_OPS_STATS 权限！</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">verifyIncomingUid</span><span class="params">(<span class="keyword">int</span> uid)</span> </span>&#123;</span><br><span class="line">    <span class="comment">//【1】如果是 uid 自身调用，不需要检验！</span></span><br><span class="line">    <span class="keyword">if</span> (uid == Binder.getCallingUid()) &#123;</span><br><span class="line">        <span class="keyword">return</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">//【2】如果是当前进程自己调用的，najiu</span></span><br><span class="line">    <span class="keyword">if</span> (Binder.getCallingPid() == Process.myPid()) &#123;</span><br><span class="line">        <span class="keyword">return</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    mContext.enforcePermission(android.Manifest.permission.UPDATE_APP_OPS_STATS,</span><br><span class="line">            Binder.getCallingPid(), Binder.getCallingUid(), <span class="keyword">null</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>如果 uid 没有 android.Manifest.permission.UPDATE_APP_OPS_STATS 权限，抛出异常！</p>
<h2 id="1-2-verifyIncomingOp"><a href="#1-2-verifyIncomingOp" class="headerlink" title="1.2 verifyIncomingOp"></a>1.2 verifyIncomingOp</h2><p>校验 op 是否正确！<br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">verifyIncomingOp</span><span class="params">(<span class="keyword">int</span> op)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">if</span> (op &gt;= <span class="number">0</span> &amp;&amp; op &lt; AppOpsManager._NUM_OP) &#123;</span><br><span class="line">        <span class="keyword">return</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">throw</span> <span class="keyword">new</span> IllegalArgumentException(<span class="string">"Bad operation #"</span> + op);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>如果 op 不在 [0， AppOpsManager._NUM_OP) 范围内，抛出异常；</p>
<h2 id="1-3-resolvePackageName"><a href="#1-3-resolvePackageName" class="headerlink" title="1.3 resolvePackageName"></a>1.3 resolvePackageName</h2><p>处理一些特殊 uid 所属包名！</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">static</span> String <span class="title">resolvePackageName</span><span class="params">(<span class="keyword">int</span> uid, String packageName)</span>  </span>&#123;</span><br><span class="line">    <span class="keyword">if</span> (uid == <span class="number">0</span>) &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="string">"root"</span>;</span><br><span class="line">    &#125; <span class="keyword">else</span> <span class="keyword">if</span> (uid == Process.SHELL_UID) &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="string">"com.android.shell"</span>;</span><br><span class="line">    &#125; <span class="keyword">else</span> <span class="keyword">if</span> (uid == Process.SYSTEM_UID &amp;&amp; packageName == <span class="keyword">null</span>) &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="string">"android"</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> packageName;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>不多说！</p>
<h2 id="1-4-isOpRestrictedLocked"><a href="#1-4-isOpRestrictedLocked" class="headerlink" title="1.4 isOpRestrictedLocked"></a>1.4 isOpRestrictedLocked</h2><p>判断该操作是否被用户限制！<br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">boolean</span> <span class="title">isOpRestrictedLocked</span><span class="params">(<span class="keyword">int</span> uid, <span class="keyword">int</span> code, String packageName)</span> </span>&#123;</span><br><span class="line">    <span class="comment">//【1】获得该 uid 所属的 userId！</span></span><br><span class="line">    <span class="keyword">int</span> userHandle = UserHandle.getUserId(uid);</span><br><span class="line">    <span class="keyword">final</span> <span class="keyword">int</span> restrictionSetCount = mOpUserRestrictions.size();</span><br><span class="line"></span><br><span class="line">    <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; restrictionSetCount; i++) &#123;</span><br><span class="line">        <span class="comment">//【2】遍历每一个 ClientRestrictionState，检查该 op 是否在 uid 所在的用户下被限制，同时也检查</span></span><br><span class="line">        <span class="comment">// 属于该 uid 的 package 是否在白名单中，如果在白名单中，那就不受限制！</span></span><br><span class="line">        ClientRestrictionState restrictionState = mOpUserRestrictions.valueAt(i);</span><br><span class="line">        <span class="comment">//【×1.4.1】校验该 package 的 op 在指定的 userid 下是否收到限制，如果有返回 true！</span></span><br><span class="line">        <span class="keyword">if</span> (restrictionState.hasRestriction(code, packageName, userHandle)) &#123;</span><br><span class="line">            <span class="comment">//【3】如果确实在该 userId 下受到限制，那就在判断下是否允许 system/system ui 绕过限制！</span></span><br><span class="line">            <span class="keyword">if</span> (AppOpsManager.opAllowSystemBypassRestriction(code)) &#123;</span><br><span class="line">                <span class="keyword">synchronized</span> (<span class="keyword">this</span>) &#123;</span><br><span class="line">                    <span class="comment">//【*1.4.2】获得该 package 的所有 op 操作</span></span><br><span class="line">                    Ops ops = getOpsRawLocked(uid, packageName, <span class="keyword">true</span>);</span><br><span class="line">                    <span class="keyword">if</span> ((ops != <span class="keyword">null</span>) &amp;&amp; ops.isPrivileged) &#123;</span><br><span class="line">                        <span class="comment">//【3.1】如果 ops.isPrivileged 为 true，说明该 package 是特权应用，要绕过用户限制！</span></span><br><span class="line">                        <span class="keyword">return</span> <span class="keyword">false</span>;</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="comment">//【3.2】受到限制但是不允许绕过！</span></span><br><span class="line">            <span class="keyword">return</span> <span class="keyword">true</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">false</span>; <span class="comment">// 不受限制返回 false；</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>AppOpsService 用一个 ArrayMap 保存所有的用户限制状态信息！<br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">private</span> <span class="keyword">final</span> ArrayMap&lt;IBinder, ClientRestrictionState&gt; mOpUserRestrictions = <span class="keyword">new</span> ArrayMap&lt;&gt;();</span><br></pre></td></tr></table></figure></p>
<h3 id="1-4-1-ClientRestrictionState-hasRestriction"><a href="#1-4-1-ClientRestrictionState-hasRestriction" class="headerlink" title="1.4.1 ClientRestrictionState.hasRestriction"></a>1.4.1 ClientRestrictionState.hasRestriction</h3><p>该方法用于判断指定 package 的指定 op 是否在 userId 下收到限制！<br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">boolean</span> <span class="title">hasRestriction</span><span class="params">(<span class="keyword">int</span> restriction, String packageName, <span class="keyword">int</span> userId)</span> </span>&#123;</span><br><span class="line">    <span class="comment">//【1】如果 perUserRestrictions 为 null，不受限制！</span></span><br><span class="line">    <span class="keyword">if</span> (perUserRestrictions == <span class="keyword">null</span>) &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">false</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">//【2】如果在 userId 下没有限制信息，不受限制！</span></span><br><span class="line">    <span class="keyword">boolean</span>[] restrictions = perUserRestrictions.get(userId);</span><br><span class="line">    <span class="keyword">if</span> (restrictions == <span class="keyword">null</span>) &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">false</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">//【3】如果在 userId 下，restrictions[restriction] 为 false，不受限制！</span></span><br><span class="line">    <span class="keyword">if</span> (!restrictions[restriction]) &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">false</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">//【4】如果在 userId 下，restrictions[restriction] 为 true，说明在该用户下，该 op 是受限制的</span></span><br><span class="line">    <span class="comment">// 那就要看下 package 是否在白名单中，如果没有白名单，那么就是首先的！</span></span><br><span class="line">    <span class="keyword">if</span> (perUserExcludedPackages == <span class="keyword">null</span>) &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">true</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    String[] perUserExclusions = perUserExcludedPackages.get(userId);</span><br><span class="line">    <span class="keyword">if</span> (perUserExclusions == <span class="keyword">null</span>) &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">true</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">//【5】如果该 package 是在白名单中，那么就是不受限的，返回 false；</span></span><br><span class="line">    <span class="keyword">return</span> !ArrayUtils.contains(perUserExclusions, packageName);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>方法很简单，不多说了！</p>
<h3 id="1-4-2-getOpsRawLocked"><a href="#1-4-2-getOpsRawLocked" class="headerlink" title="1.4.2 getOpsRawLocked"></a>1.4.2 getOpsRawLocked</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">private</span> Ops <span class="title">getOpsRawLocked</span><span class="params">(<span class="keyword">int</span> uid, String packageName, <span class="keyword">boolean</span> edit)</span> </span>&#123;</span><br><span class="line">    <span class="comment">//【*1.5】获得 uid 的 UidState 对象！</span></span><br><span class="line">    UidState uidState = getUidStateLocked(uid, edit);</span><br><span class="line">    <span class="keyword">if</span> (uidState == <span class="keyword">null</span>) &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">null</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (uidState.pkgOps == <span class="keyword">null</span>) &#123;</span><br><span class="line">        <span class="keyword">if</span> (!edit) &#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="keyword">null</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        uidState.pkgOps = <span class="keyword">new</span> ArrayMap&lt;&gt;();</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">//【1】获得 packageName 指定的应用的 op 限制！</span></span><br><span class="line">    Ops ops = uidState.pkgOps.get(packageName);</span><br><span class="line">    <span class="keyword">if</span> (ops == <span class="keyword">null</span>) &#123;</span><br><span class="line">        <span class="keyword">if</span> (!edit) &#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="keyword">null</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">boolean</span> isPrivileged = <span class="keyword">false</span>;</span><br><span class="line">        <span class="comment">//【2】下面会判断 package 和 uid 的对应关系是否有效！</span></span><br><span class="line">        <span class="keyword">if</span> (uid != <span class="number">0</span>) &#123;</span><br><span class="line">            <span class="keyword">final</span> <span class="keyword">long</span> ident = Binder.clearCallingIdentity();</span><br><span class="line">            <span class="keyword">try</span> &#123;</span><br><span class="line">                <span class="keyword">int</span> pkgUid = -<span class="number">1</span>;</span><br><span class="line">                <span class="keyword">try</span> &#123;</span><br><span class="line">                    <span class="comment">//【2.1】获得 packageName 对应的应用程序信息 ApplicationInfo！</span></span><br><span class="line">                    ApplicationInfo appInfo = ActivityThread.getPackageManager()</span><br><span class="line">                            .getApplicationInfo(packageName,</span><br><span class="line">                                    PackageManager.MATCH_DEBUG_TRIAGED_MISSING,</span><br><span class="line">                                    UserHandle.getUserId(uid));</span><br><span class="line">                    <span class="keyword">if</span> (appInfo != <span class="keyword">null</span>) &#123;</span><br><span class="line">                        <span class="comment">//【2.2】获得 package 的 uid，判断其是否是特权应用；</span></span><br><span class="line">                        pkgUid = appInfo.uid;</span><br><span class="line">                        isPrivileged = (appInfo.privateFlags</span><br><span class="line">                                &amp; ApplicationInfo.PRIVATE_FLAG_PRIVILEGED) != <span class="number">0</span>;</span><br><span class="line">                    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                        <span class="comment">//【2.3】针对一些特殊没有安装信息的 package，这里做一个处理！</span></span><br><span class="line">                        <span class="keyword">if</span> (<span class="string">"media"</span>.equals(packageName)) &#123;</span><br><span class="line">                            pkgUid = Process.MEDIA_UID;</span><br><span class="line">                            isPrivileged = <span class="keyword">false</span>;</span><br><span class="line">                        &#125; <span class="keyword">else</span> <span class="keyword">if</span> (<span class="string">"audioserver"</span>.equals(packageName)) &#123;</span><br><span class="line">                            pkgUid = Process.AUDIOSERVER_UID;</span><br><span class="line">                            isPrivileged = <span class="keyword">false</span>;</span><br><span class="line">                        &#125; <span class="keyword">else</span> <span class="keyword">if</span> (<span class="string">"cameraserver"</span>.equals(packageName)) &#123;</span><br><span class="line">                            pkgUid = Process.CAMERASERVER_UID;</span><br><span class="line">                            isPrivileged = <span class="keyword">false</span>;</span><br><span class="line">                        &#125;</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125; <span class="keyword">catch</span> (RemoteException e) &#123;</span><br><span class="line">                    Slog.w(TAG, <span class="string">"Could not contact PackageManager"</span>, e);</span><br><span class="line">                &#125;</span><br><span class="line">                <span class="comment">//【2.4】判读 package 和 uid 的对应关系是否有效，如果 package 现在的 uid 不是 AppOps</span></span><br><span class="line">                <span class="comment">// 中记录的 uid，那么输出异常，并返回；</span></span><br><span class="line">                <span class="keyword">if</span> (pkgUid != uid) &#123;</span><br><span class="line">                    RuntimeException ex = <span class="keyword">new</span> RuntimeException(<span class="string">"here"</span>);</span><br><span class="line">                    ex.fillInStackTrace();</span><br><span class="line">                    Slog.w(TAG, <span class="string">"Bad call: specified package "</span> + packageName</span><br><span class="line">                            + <span class="string">" under uid "</span> + uid + <span class="string">" but it is really "</span> + pkgUid, ex);</span><br><span class="line">                    <span class="keyword">return</span> <span class="keyword">null</span>;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">                Binder.restoreCallingIdentity(ident);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">//【3】对于 edit 为 true 的情况，会做初始化操作！！</span></span><br><span class="line">        ops = <span class="keyword">new</span> Ops(packageName, uidState, isPrivileged);</span><br><span class="line">        uidState.pkgOps.put(packageName, ops);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> ops;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>不多说了！</p>
<h2 id="1-5-getUidStateLocked"><a href="#1-5-getUidStateLocked" class="headerlink" title="1.5 getUidStateLocked"></a>1.5 getUidStateLocked</h2><p>获得 uid 的 op 管理信息：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">private</span> UidState <span class="title">getUidStateLocked</span><span class="params">(<span class="keyword">int</span> uid, <span class="keyword">boolean</span> edit)</span> </span>&#123;</span><br><span class="line">    UidState uidState = mUidStates.get(uid);</span><br><span class="line">    <span class="keyword">if</span> (uidState == <span class="keyword">null</span>) &#123;</span><br><span class="line">        <span class="keyword">if</span> (!edit) &#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="keyword">null</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        uidState = <span class="keyword">new</span> UidState(uid);</span><br><span class="line">        <span class="comment">//【1】从 mUidStates 获取！</span></span><br><span class="line">        mUidStates.put(uid, uidState);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> uidState;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>不多说！</p>
<h2 id="1-6-getOpLocked"><a href="#1-6-getOpLocked" class="headerlink" title="1.6 getOpLocked"></a>1.6 getOpLocked</h2><p>getOpLocked 用于获得指定 package 的特定 op 对应的 Op 对象，该 Op 对象封装了操作的模式等相关信息，参数 boolean edit 这里传入的是 true！</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">private</span> Op <span class="title">getOpLocked</span><span class="params">(<span class="keyword">int</span> code, <span class="keyword">int</span> uid, String packageName, <span class="keyword">boolean</span> edit)</span> </span>&#123;</span><br><span class="line">   <span class="comment">//【1】获得该 package 的所有的 op 信息，封装在 Ops 对象中！</span></span><br><span class="line">    Ops ops = getOpsRawLocked(uid, packageName, edit);</span><br><span class="line">    <span class="keyword">if</span> (ops == <span class="keyword">null</span>) &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">null</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">//【2】返回指定 op 对应的信息！</span></span><br><span class="line">    <span class="keyword">return</span> getOpLocked(ops, code, edit);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>调用了三参数函数 getOpLocked！<br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">private</span> Op <span class="title">getOpLocked</span><span class="params">(Ops ops, <span class="keyword">int</span> code, <span class="keyword">boolean</span> edit)</span> </span>&#123;</span><br><span class="line">    <span class="comment">//【1】获得 code 对应的 Op 对象！</span></span><br><span class="line">    Op op = ops.get(code);</span><br><span class="line">    <span class="keyword">if</span> (op == <span class="keyword">null</span>) &#123;</span><br><span class="line">        <span class="keyword">if</span> (!edit) &#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="keyword">null</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">// 如果没有，由于 edit 为 true，这里会默认初始化创建一个 Op 对象！</span></span><br><span class="line">        op = <span class="keyword">new</span> Op(ops.uidState.uid, ops.packageName, code);</span><br><span class="line">        ops.put(code, op);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span> (edit) &#123; <span class="comment">// 同时更新本地持久化文件！</span></span><br><span class="line">        scheduleWriteLocked();</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> op; <span class="comment">// 返回！</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<h1 id="2-AppOpsService-noteOperation-检查操作权限"><a href="#2-AppOpsService-noteOperation-检查操作权限" class="headerlink" title="2 AppOpsService.noteOperation - 检查操作权限"></a>2 AppOpsService.noteOperation - 检查操作权限</h1><p>检查指定的 package 是否允许执行 op 对应的操作，同时会更新 op 相关的信息！</p>
<p>noteOperation 用于短期权限的检查。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">int</span> <span class="title">noteOperation</span><span class="params">(<span class="keyword">int</span> code, <span class="keyword">int</span> uid, String packageName)</span> </span>&#123;</span><br><span class="line">    verifyIncomingUid(uid);</span><br><span class="line">    verifyIncomingOp(code);</span><br><span class="line">    String resolvedPackageName = resolvePackageName(uid, packageName);</span><br><span class="line">    <span class="keyword">if</span> (resolvedPackageName == <span class="keyword">null</span>) &#123;</span><br><span class="line">        <span class="keyword">return</span> AppOpsManager.MODE_IGNORED;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">//【*2.1】调用了 5 参函数！</span></span><br><span class="line">    <span class="keyword">return</span> noteOperationUnchecked(code, uid, resolvedPackageName, <span class="number">0</span>, <span class="keyword">null</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>继续分析：</p>
<h2 id="2-1-noteOperationUnchecked"><a href="#2-1-noteOperationUnchecked" class="headerlink" title="2.1 noteOperationUnchecked"></a>2.1 noteOperationUnchecked</h2><p>我们去看看 5 参函数：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">int</span> <span class="title">noteOperationUnchecked</span><span class="params">(<span class="keyword">int</span> code, <span class="keyword">int</span> uid, String packageName,</span></span></span><br><span class="line"><span class="function"><span class="params">        <span class="keyword">int</span> proxyUid, String proxyPackageName)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">synchronized</span> (<span class="keyword">this</span>) &#123;</span><br><span class="line">        <span class="comment">//【*1.4.2】获得该 package 的所有 Op 信息！</span></span><br><span class="line">        Ops ops = getOpsRawLocked(uid, packageName, <span class="keyword">true</span>);</span><br><span class="line">        <span class="keyword">if</span> (ops == <span class="keyword">null</span>) &#123;</span><br><span class="line">            <span class="keyword">if</span> (DEBUG) Log.d(TAG, <span class="string">"noteOperation: no op for code "</span> + code + <span class="string">" uid "</span> + uid</span><br><span class="line">                    + <span class="string">" package "</span> + packageName);</span><br><span class="line">            <span class="keyword">return</span> AppOpsManager.MODE_ERRORED;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">//【*1.5】获得 code 指定的 Op 信息！</span></span><br><span class="line">        Op op = getOpLocked(ops, code, <span class="keyword">true</span>);</span><br><span class="line"></span><br><span class="line">        <span class="comment">//【*1.4】如果该 op 在 uid 所在的用户下受限，返回 MODE_IGNORED ！</span></span><br><span class="line">        <span class="keyword">if</span> (isOpRestrictedLocked(uid, code, packageName)) &#123;</span><br><span class="line">            <span class="keyword">return</span> AppOpsManager.MODE_IGNORED;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">if</span> (op.duration == -<span class="number">1</span>) &#123;</span><br><span class="line">            Slog.w(TAG, <span class="string">"Noting op not finished: uid "</span> + uid + <span class="string">" pkg "</span> + packageName</span><br><span class="line">                    + <span class="string">" code "</span> + code + <span class="string">" time="</span> + op.time + <span class="string">" duration="</span> + op.duration);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        op.duration = <span class="number">0</span>;</span><br><span class="line"></span><br><span class="line">        <span class="comment">//【2】获得决定 code 指定 op 模式的 switchCode，其实是另外一个 op！</span></span><br><span class="line">        <span class="keyword">final</span> <span class="keyword">int</span> switchCode = AppOpsManager.opToSwitch(code);</span><br><span class="line">        <span class="comment">//【3】获得该 package 所属 uid 的 op 限制！</span></span><br><span class="line">        UidState uidState = ops.uidState;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (uidState.opModes != <span class="keyword">null</span> &amp;&amp; uidState.opModes.indexOfKey(switchCode) &gt;= <span class="number">0</span>) &#123;</span><br><span class="line">            <span class="comment">//【3.1】如果该 uid 有 switchCode，那么 uid 的 switchCode 模式优先级更高！</span></span><br><span class="line">            <span class="comment">// 如果 uid 不允许执行该操作，返回的是该 uid 的 switchCode 模式！</span></span><br><span class="line">            <span class="keyword">final</span> <span class="keyword">int</span> uidMode = uidState.opModes.get(switchCode);</span><br><span class="line">            <span class="keyword">if</span> (uidMode != AppOpsManager.MODE_ALLOWED) &#123;</span><br><span class="line">                <span class="keyword">if</span> (DEBUG) Log.d(TAG, <span class="string">"noteOperation: reject #"</span> + op.mode + <span class="string">" for code "</span></span><br><span class="line">                        + switchCode + <span class="string">" ("</span> + code + <span class="string">") uid "</span> + uid + <span class="string">" package "</span></span><br><span class="line">                        + packageName);</span><br><span class="line"></span><br><span class="line">                <span class="comment">//【3.1.1】uid 不被允许的执行该 switchCode 在指定的操作，</span></span><br><span class="line">                <span class="comment">// 那么更新 code 对应 op 的 rejectTime 值！</span></span><br><span class="line">                op.rejectTime = System.currentTimeMillis();</span><br><span class="line">                <span class="keyword">return</span> uidMode;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            <span class="comment">//【3.2】如果该 uid 没有该 switchCode，那就读取 package 的 switchCode 模式！</span></span><br><span class="line">            <span class="comment">//【×1.6】通过 getOpLocked 获得指定的 op 信息！</span></span><br><span class="line">            <span class="keyword">final</span> Op switchOp = switchCode != code ? getOpLocked(ops, switchCode, <span class="keyword">true</span>) : op;</span><br><span class="line">            <span class="keyword">if</span> (switchOp.mode != AppOpsManager.MODE_ALLOWED) &#123;</span><br><span class="line">                <span class="keyword">if</span> (DEBUG) Log.d(TAG, <span class="string">"noteOperation: reject #"</span> + op.mode + <span class="string">" for code "</span></span><br><span class="line">                        + switchCode + <span class="string">" ("</span> + code + <span class="string">") uid "</span> + uid + <span class="string">" package "</span></span><br><span class="line">                        + packageName);</span><br><span class="line">                <span class="comment">//【3.2.1】package 不被允许的执行该 switchCode 在指定的操作，</span></span><br><span class="line">                <span class="comment">// 那么更新 code 对应 op 的 rejectTime 值！</span></span><br><span class="line">                <span class="keyword">return</span> switchOp.mode;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (DEBUG) Log.d(TAG, <span class="string">"noteOperation: allowing code "</span> + code + <span class="string">" uid "</span> + uid</span><br><span class="line">                + <span class="string">" package "</span> + packageName);</span><br><span class="line"></span><br><span class="line">        <span class="comment">//【4】更新 code 对应的 op 的相关信息！</span></span><br><span class="line">        op.time = System.currentTimeMillis();</span><br><span class="line">        op.rejectTime = <span class="number">0</span>;</span><br><span class="line">        op.proxyUid = proxyUid;</span><br><span class="line">        op.proxyPackageName = proxyPackageName;</span><br><span class="line">        <span class="keyword">return</span> AppOpsManager.MODE_ALLOWED;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>方法很简单，不多说了！</p>
<h1 id="3-AppOpsService-setUidMode-设置-uid-的-op-模式"><a href="#3-AppOpsService-setUidMode-设置-uid-的-op-模式" class="headerlink" title="3 AppOpsService.setUidMode - 设置 uid 的 op 模式"></a>3 AppOpsService.setUidMode - 设置 uid 的 op 模式</h1><p>设置指定 uid 的相应 op 的模式，如果 uid 的 op 模式发生后，那么属于该 uid 的所有 package 也会受到影响！！</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">setUidMode</span><span class="params">(<span class="keyword">int</span> code, <span class="keyword">int</span> uid, <span class="keyword">int</span> mode)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">if</span> (Binder.getCallingPid() != Process.myPid()) &#123;</span><br><span class="line">        mContext.enforcePermission(android.Manifest.permission.UPDATE_APP_OPS_STATS,</span><br><span class="line">                Binder.getCallingPid(), Binder.getCallingUid(), <span class="keyword">null</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">//【×1.2】校验 op 是否有效！</span></span><br><span class="line">    verifyIncomingOp(code);</span><br><span class="line">    <span class="comment">//【1】获得决定 code 指定 op 模式的 switchCode，其实是另外一个 op！</span></span><br><span class="line">    code = AppOpsManager.opToSwitch(code);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">synchronized</span> (<span class="keyword">this</span>) &#123;</span><br><span class="line">        <span class="comment">//【2】首先，获得该 op 的默认模式 defaultMode！</span></span><br><span class="line">        <span class="keyword">final</span> <span class="keyword">int</span> defaultMode = AppOpsManager.opToDefaultMode(code);</span><br><span class="line"></span><br><span class="line">        <span class="comment">//【×1.5】获得该 uid 对应的 UidState 对象！</span></span><br><span class="line">        UidState uidState = getUidStateLocked(uid, <span class="keyword">false</span>);</span><br><span class="line">        <span class="keyword">if</span> (uidState == <span class="keyword">null</span>) &#123;</span><br><span class="line">            <span class="comment">//【2.1】如果该 uid 没有相关的记录，且本次设置的模式是默认模式，不处理。直接返回！</span></span><br><span class="line">            <span class="keyword">if</span> (mode == defaultMode) &#123;</span><br><span class="line">                <span class="keyword">return</span>;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="comment">// 否则，创建 UidState 对象，将 code 和 mode 的关系添加进去！</span></span><br><span class="line">            uidState = <span class="keyword">new</span> UidState(uid);</span><br><span class="line">            uidState.opModes = <span class="keyword">new</span> SparseIntArray();</span><br><span class="line">            uidState.opModes.put(code, mode);</span><br><span class="line">            mUidStates.put(uid, uidState);</span><br><span class="line">            <span class="comment">// 更新本地文件；</span></span><br><span class="line">            scheduleWriteLocked();</span><br><span class="line">            </span><br><span class="line">        &#125; <span class="keyword">else</span> <span class="keyword">if</span> (uidState.opModes == <span class="keyword">null</span>) &#123;</span><br><span class="line">            <span class="comment">//【2.2】如果该 uid 没有 op 相关的记录，且本次设置的模式是默认模式，不处理！</span></span><br><span class="line">            <span class="comment">// 否则初始化 uidState.opModes，将 code 和 mode 的关系添加进去！</span></span><br><span class="line">            <span class="keyword">if</span> (mode != defaultMode) &#123;</span><br><span class="line">                uidState.opModes = <span class="keyword">new</span> SparseIntArray();</span><br><span class="line">                uidState.opModes.put(code, mode);</span><br><span class="line">                <span class="comment">// 更新本地文件；</span></span><br><span class="line">                scheduleWriteLocked();</span><br><span class="line">            &#125;</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            <span class="comment">//【2.3】如果该 uid 下的 op 已有模式和本次设置的一样，不处理，直接返回！</span></span><br><span class="line">            <span class="keyword">if</span> (uidState.opModes.get(code) == mode) &#123;</span><br><span class="line">                <span class="keyword">return</span>;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="comment">// 如果该 uid 下的 op 已有模式不是默认模式，但是要设置为默认模式，直接从 uidState.opModes 中删除 op！</span></span><br><span class="line">            <span class="comment">// 否则，更新 mode 的值！</span></span><br><span class="line">            <span class="keyword">if</span> (mode == defaultMode) &#123;</span><br><span class="line">                uidState.opModes.delete(code);</span><br><span class="line">                <span class="keyword">if</span> (uidState.opModes.size() &lt;= <span class="number">0</span>) &#123;</span><br><span class="line">                    uidState.opModes = <span class="keyword">null</span>;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                uidState.opModes.put(code, mode);</span><br><span class="line">            &#125;</span><br><span class="line">            scheduleWriteLocked();  <span class="comment">// 更新本地文件；</span></span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">//【3】获得该 uid 下的所有 package！</span></span><br><span class="line">    String[] uidPackageNames = getPackagesForUid(uid);</span><br><span class="line">    ArrayMap&lt;Callback, ArraySet&lt;String&gt;&gt; callbackSpecs = <span class="keyword">null</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">synchronized</span> (<span class="keyword">this</span>) &#123;</span><br><span class="line">        <span class="comment">//【3.1】收集所有监听该 uid 下该 op 模式变化的 Callback，用于触发回调！！</span></span><br><span class="line">        ArrayList&lt;Callback&gt; callbacks = mOpModeWatchers.get(code);</span><br><span class="line">        <span class="keyword">if</span> (callbacks != <span class="keyword">null</span>) &#123;</span><br><span class="line">            <span class="keyword">final</span> <span class="keyword">int</span> callbackCount = callbacks.size();</span><br><span class="line">            <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; callbackCount; i++) &#123;</span><br><span class="line">                Callback callback = callbacks.get(i);</span><br><span class="line">                ArraySet&lt;String&gt; changedPackages = <span class="keyword">new</span> ArraySet&lt;&gt;();</span><br><span class="line">                </span><br><span class="line">                <span class="comment">//【3.1.1】将该 uid 下的所有 package 保存到 changedPackages 中，然后将</span></span><br><span class="line">                <span class="comment">// 每个 Callback 和 changedPackages 的映射关系保存到 callbackSpecs 中！</span></span><br><span class="line">                Collections.addAll(changedPackages, uidPackageNames);</span><br><span class="line">                callbackSpecs = <span class="keyword">new</span> ArrayMap&lt;&gt;();</span><br><span class="line">                callbackSpecs.put(callback, changedPackages);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">//【3.2】收集所有监听该 uid 下 package 的 op 模式变化的 Callback！</span></span><br><span class="line">        <span class="keyword">for</span> (String uidPackageName : uidPackageNames) &#123;</span><br><span class="line">            callbacks = mPackageModeWatchers.get(uidPackageName);</span><br><span class="line">            <span class="keyword">if</span> (callbacks != <span class="keyword">null</span>) &#123;</span><br><span class="line">                <span class="keyword">if</span> (callbackSpecs == <span class="keyword">null</span>) &#123;</span><br><span class="line">                    callbackSpecs = <span class="keyword">new</span> ArrayMap&lt;&gt;();</span><br><span class="line">                &#125;</span><br><span class="line">                <span class="keyword">final</span> <span class="keyword">int</span> callbackCount = callbacks.size();</span><br><span class="line">                <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; callbackCount; i++) &#123;</span><br><span class="line">                    Callback callback = callbacks.get(i);</span><br><span class="line">                    <span class="comment">//【3.2.1】获得之前已经添加的 packageName！！</span></span><br><span class="line">                    ArraySet&lt;String&gt; changedPackages = callbackSpecs.get(callback);</span><br><span class="line">                    <span class="keyword">if</span> (changedPackages == <span class="keyword">null</span>) &#123;</span><br><span class="line">                        changedPackages = <span class="keyword">new</span> ArraySet&lt;&gt;();</span><br><span class="line">                        callbackSpecs.put(callback, changedPackages);</span><br><span class="line">                    &#125;</span><br><span class="line">                    <span class="comment">//【3.2.2】将 package 添加到对应关系中！</span></span><br><span class="line">                    changedPackages.add(uidPackageName);</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (callbackSpecs == <span class="keyword">null</span>) &#123;</span><br><span class="line">        <span class="keyword">return</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">//【4】处理回调，通知该 uid 下的 op 发生了变化，如果 uid 下有 pkg，也会将 pkg 传递过去！！</span></span><br><span class="line">    <span class="keyword">final</span> <span class="keyword">long</span> identity = Binder.clearCallingIdentity();</span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">        <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; callbackSpecs.size(); i++) &#123;</span><br><span class="line">            Callback callback = callbackSpecs.keyAt(i);</span><br><span class="line">            ArraySet&lt;String&gt; reportedPackageNames = callbackSpecs.valueAt(i);</span><br><span class="line">            <span class="keyword">try</span> &#123;</span><br><span class="line">                <span class="keyword">if</span> (reportedPackageNames == <span class="keyword">null</span>) &#123;</span><br><span class="line">                    callback.mCallback.opChanged(code, uid, <span class="keyword">null</span>);</span><br><span class="line">                &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                    <span class="keyword">final</span> <span class="keyword">int</span> reportedPackageCount = reportedPackageNames.size();</span><br><span class="line">                    <span class="keyword">for</span> (<span class="keyword">int</span> j = <span class="number">0</span>; j &lt; reportedPackageCount; j++) &#123;</span><br><span class="line">                        String reportedPackageName = reportedPackageNames.valueAt(j);</span><br><span class="line">                        <span class="comment">//【4.1】触发回调！</span></span><br><span class="line">                        callback.mCallback.opChanged(code, uid, reportedPackageName);</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125; <span class="keyword">catch</span> (RemoteException e) &#123;</span><br><span class="line">                Log.w(TAG, <span class="string">"Error dispatching op op change"</span>, e);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">        Binder.restoreCallingIdentity(identity);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>设置完 uid 的 op 后，会触发那些监听 op 变化的回调！</p>
<h1 id="4-AppOpsService-setMode-设置-package-的-op-模式"><a href="#4-AppOpsService-setMode-设置-package-的-op-模式" class="headerlink" title="4 AppOpsService.setMode - 设置 package 的 op 模式"></a>4 AppOpsService.setMode - 设置 package 的 op 模式</h1><p>设置指定 package 的指定 op 的模式值，参数 int uid 是该 package 所属的 uid！<br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">setMode</span><span class="params">(<span class="keyword">int</span> code, <span class="keyword">int</span> uid, String packageName, <span class="keyword">int</span> mode)</span> </span>&#123;</span><br><span class="line">    <span class="comment">//【1】校验权限，因为 setMode 方法只能是系统调用，系统是默认有 UPDATE_APP_OPS_STATS 权限的！</span></span><br><span class="line">    <span class="keyword">if</span> (Binder.getCallingPid() != Process.myPid()) &#123;</span><br><span class="line">        mContext.enforcePermission(android.Manifest.permission.UPDATE_APP_OPS_STATS,</span><br><span class="line">                Binder.getCallingPid(), Binder.getCallingUid(), <span class="keyword">null</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    verifyIncomingOp(code);</span><br><span class="line">    ArrayList&lt;Callback&gt; repCbs = <span class="keyword">null</span>;</span><br><span class="line">    <span class="comment">//【2】获得决定 code 指定的 op 的模式的 op，调用 AppOpsManager.opToSwitch 方法！</span></span><br><span class="line">    code = AppOpsManager.opToSwitch(code);</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">synchronized</span> (<span class="keyword">this</span>) &#123;</span><br><span class="line">        <span class="comment">//【3】获得 uid 对应的 UidState 对象！</span></span><br><span class="line">        UidState uidState = getUidStateLocked(uid, <span class="keyword">false</span>);</span><br><span class="line">        <span class="comment">//【×1.5】获得 code（switch） 对应的 Op 对象！</span></span><br><span class="line">        Op op = getOpLocked(code, uid, packageName, <span class="keyword">true</span>);</span><br><span class="line">        <span class="keyword">if</span> (op != <span class="keyword">null</span>) &#123;</span><br><span class="line">            <span class="comment">//【5】如果 op 的现有模式和本次要设置的模式不同，更新模式值！</span></span><br><span class="line">            <span class="keyword">if</span> (op.mode != mode) &#123;</span><br><span class="line">                op.mode = mode;</span><br><span class="line">                <span class="comment">//【5.1】更新了模式值后，收集所有监听该 op 模式变化的观察者！</span></span><br><span class="line">                ArrayList&lt;Callback&gt; cbs = mOpModeWatchers.get(code);</span><br><span class="line">                <span class="keyword">if</span> (cbs != <span class="keyword">null</span>) &#123;</span><br><span class="line">                    <span class="keyword">if</span> (repCbs == <span class="keyword">null</span>) &#123;</span><br><span class="line">                        repCbs = <span class="keyword">new</span> ArrayList&lt;Callback&gt;();</span><br><span class="line">                    &#125;</span><br><span class="line">                    repCbs.addAll(cbs);</span><br><span class="line">                &#125;</span><br><span class="line">                <span class="comment">//【5.2】更新了模式值后，收集所有监听该 packageName 操作模式变化的观察者！</span></span><br><span class="line">                cbs = mPackageModeWatchers.get(packageName);</span><br><span class="line">                <span class="keyword">if</span> (cbs != <span class="keyword">null</span>) &#123;</span><br><span class="line">                    <span class="keyword">if</span> (repCbs == <span class="keyword">null</span>) &#123;</span><br><span class="line">                        repCbs = <span class="keyword">new</span> ArrayList&lt;Callback&gt;();</span><br><span class="line">                    &#125;</span><br><span class="line">                    repCbs.addAll(cbs);</span><br><span class="line">                &#125;</span><br><span class="line">                <span class="comment">//【×4.1】如果本次设置是恢复默认模式，那么就移除该 op；</span></span><br><span class="line">                <span class="keyword">if</span> (mode == AppOpsManager.opToDefaultMode(op.op)) &#123;</span><br><span class="line">                    pruneOp(op, uid, packageName);</span><br><span class="line">                &#125;</span><br><span class="line">                <span class="comment">//【×4.2】更新本地文件；</span></span><br><span class="line">                scheduleFastWriteLocked();</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">//【6】当 repCbs 不为 null，通知所有监听者！</span></span><br><span class="line">    <span class="keyword">if</span> (repCbs != <span class="keyword">null</span>) &#123;</span><br><span class="line">        <span class="comment">// 将远程调用者的 uid/pid 转为系统进程的 uid/pid 防止权限相关问题！</span></span><br><span class="line">        <span class="keyword">final</span> <span class="keyword">long</span> identity = Binder.clearCallingIdentity();</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; repCbs.size(); i++) &#123;</span><br><span class="line">                <span class="keyword">try</span> &#123;</span><br><span class="line">                    <span class="comment">//【6.1】触发 callback 的 opChanged 回调！</span></span><br><span class="line">                    repCbs.get(i).mCallback.opChanged(code, uid, packageName);</span><br><span class="line">                &#125; <span class="keyword">catch</span> (RemoteException e) &#123;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">            Binder.restoreCallingIdentity(identity);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>方法流程很简单，不多说了！</p>
<h2 id="4-1-pruneOp"><a href="#4-1-pruneOp" class="headerlink" title="4.1 pruneOp"></a>4.1 pruneOp</h2><p>移除指定的 Op！<br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">pruneOp</span><span class="params">(Op op, <span class="keyword">int</span> uid, String packageName)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">if</span> (op.time == <span class="number">0</span> &amp;&amp; op.rejectTime == <span class="number">0</span>) &#123;</span><br><span class="line">        <span class="comment">//【1】返回该 uid 下该 package 的所有 Op 信息！</span></span><br><span class="line">        Ops ops = getOpsRawLocked(uid, packageName, <span class="keyword">false</span>);</span><br><span class="line">        <span class="keyword">if</span> (ops != <span class="keyword">null</span>) &#123;</span><br><span class="line">            <span class="comment">//【2】从中移除该 op！</span></span><br><span class="line">            ops.remove(op.op);</span><br><span class="line">            <span class="comment">//【3】如果该 package 已经没有任何 Op，那就从所属于的 UidState 中移除相关记录！</span></span><br><span class="line">            <span class="keyword">if</span> (ops.size() &lt;= <span class="number">0</span>) &#123;</span><br><span class="line">                UidState uidState = ops.uidState;</span><br><span class="line">                ArrayMap&lt;String, Ops&gt; pkgOps = uidState.pkgOps;</span><br><span class="line">                <span class="keyword">if</span> (pkgOps != <span class="keyword">null</span>) &#123;</span><br><span class="line">                    pkgOps.remove(ops.packageName);</span><br><span class="line">                    <span class="keyword">if</span> (pkgOps.isEmpty()) &#123;</span><br><span class="line">                        uidState.pkgOps = <span class="keyword">null</span>;</span><br><span class="line">                    &#125;</span><br><span class="line">                    <span class="keyword">if</span> (uidState.isDefault()) &#123;</span><br><span class="line">                        mUidStates.remove(uid);</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>整个过程很简单，不多说了！</p>
<h2 id="4-2-scheduleFastWriteLocked"><a href="#4-2-scheduleFastWriteLocked" class="headerlink" title="4.2 scheduleFastWriteLocked"></a>4.2 scheduleFastWriteLocked</h2><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">scheduleFastWriteLocked</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    <span class="keyword">if</span> (!mFastWriteScheduled) &#123;</span><br><span class="line">        mWriteScheduled = <span class="keyword">true</span>;</span><br><span class="line">        mFastWriteScheduled = <span class="keyword">true</span>;</span><br><span class="line">        mHandler.removeCallbacks(mWriteRunner);</span><br><span class="line">        mHandler.postDelayed(mWriteRunner, <span class="number">10</span>*<span class="number">1000</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>更新本地持久化文件，执行一个 Runnable 对象 mWriteRunner，在启动篇的时候，我们看过了，这里就不再多说了！</p>
<h1 id="5-AppOpsService-startWatchingMode-监听-op-变化"><a href="#5-AppOpsService-startWatchingMode-监听-op-变化" class="headerlink" title="5 AppOpsService.startWatchingMode - 监听 op 变化"></a>5 AppOpsService.startWatchingMode - 监听 op 变化</h1><p>startWatchingMode 用于启动一个监听，他能够监听指定 package 的指定 op 操作的模式变化，当发生会变化后，会回调 callback！<br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">startWatchingMode</span><span class="params">(<span class="keyword">int</span> op, String packageName, IAppOpsCallback callback)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">if</span> (callback == <span class="keyword">null</span>) &#123;</span><br><span class="line">        <span class="keyword">return</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">synchronized</span> (<span class="keyword">this</span>) &#123;</span><br><span class="line">        <span class="comment">//【1】获得决定 op 模式的 op 操作！</span></span><br><span class="line">        op = (op != AppOpsManager.OP_NONE) ? AppOpsManager.opToSwitch(op) : op;</span><br><span class="line">        <span class="comment">//【3.1】将 callback 转为客户端代理，封装为一个 Callback 对象，添加到 mModeWatchers 中！</span></span><br><span class="line">        Callback cb = mModeWatchers.get(callback.asBinder());</span><br><span class="line">        <span class="keyword">if</span> (cb == <span class="keyword">null</span>) &#123;</span><br><span class="line">            <span class="comment">// 创建了一个 Callback 对象，用于监听远程 Binder 对象的死亡布告对象</span></span><br><span class="line">            <span class="comment">// 这样当 IAppOpsCallback.Stub 死亡后，可以停止监听！</span></span><br><span class="line">            cb = <span class="keyword">new</span> Callback(callback);</span><br><span class="line">            <span class="comment">// 将 IAppOpsCallback.Stub 和 Callback 的映射保存到 mModeWatchers 中！</span></span><br><span class="line">            mModeWatchers.put(callback.asBinder(), cb);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">//【3.2】将要监听的 op 操作和对应的监听回调 Callback 的映射关系保存到 mOpModeWatchers 中！</span></span><br><span class="line">        <span class="keyword">if</span> (op != AppOpsManager.OP_NONE) &#123;</span><br><span class="line">            ArrayList&lt;Callback&gt; cbs = mOpModeWatchers.get(op);</span><br><span class="line">            <span class="keyword">if</span> (cbs == <span class="keyword">null</span>) &#123;</span><br><span class="line">                cbs = <span class="keyword">new</span> ArrayList&lt;Callback&gt;();</span><br><span class="line">                mOpModeWatchers.put(op, cbs);</span><br><span class="line">            &#125;</span><br><span class="line">            cbs.add(cb);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">//【3.3】将要监听的 package 和对应的监听回调 Callback 的映射关系保存到 mPackageModeWatchers 中！</span></span><br><span class="line">        <span class="keyword">if</span> (packageName != <span class="keyword">null</span>) &#123;</span><br><span class="line">            ArrayList&lt;Callback&gt; cbs = mPackageModeWatchers.get(packageName);</span><br><span class="line">            <span class="keyword">if</span> (cbs == <span class="keyword">null</span>) &#123;</span><br><span class="line">                cbs = <span class="keyword">new</span> ArrayList&lt;Callback&gt;();</span><br><span class="line">                mPackageModeWatchers.put(packageName, cbs);</span><br><span class="line">            &#125;</span><br><span class="line">            cbs.add(cb);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>AppOpsService 内部有多个集合：<br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//【1】用与 IBinder 作和对应的回调 Callback 的映射关系！</span></span><br><span class="line"><span class="keyword">final</span> ArrayMap&lt;IBinder, Callback&gt; mModeWatchers</span><br><span class="line">        = <span class="keyword">new</span> ArrayMap&lt;IBinder, Callback&gt;();</span><br></pre></td></tr></table></figure></p>
<p>用于保存远程回调 IAppOpsCallback.Stub 和其对应的死亡仆告对象 Callback 的映射关系，当 IAppOpsCallback.Stub 死亡后，Callback.binderDied 会被触发！！</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//【2】用与保存 op 操作和对应的回调 Callback 的映射关系！</span></span><br><span class="line"><span class="keyword">final</span> SparseArray&lt;ArrayList&lt;Callback&gt;&gt; mOpModeWatchers</span><br><span class="line">        = <span class="keyword">new</span> SparseArray&lt;ArrayList&lt;Callback&gt;&gt;();</span><br><span class="line"><span class="comment">//【3】用与保存 package 和对应的回调 Callback 的映射关系！</span></span><br><span class="line"><span class="keyword">final</span> ArrayMap&lt;String, ArrayList&lt;Callback&gt;&gt; mPackageModeWatchers</span><br><span class="line">        = <span class="keyword">new</span> ArrayMap&lt;String, ArrayList&lt;Callback&gt;&gt;();</span><br></pre></td></tr></table></figure>
<p>而 mOpModeWatchers 和 mPackageModeWatchers 则是从不同的角度来建立监听关系：mOpModeWatchers 是从具体 op 的角度，而 mPackageModeWatchers 则是从 package 的角度！</p>
<p>可以看到 Callback 的作用是作为远程回调的死亡仆告对象，用于停止监听。</p>
<h2 id="5-1-new-Callback"><a href="#5-1-new-Callback" class="headerlink" title="5.1 new Callback"></a>5.1 new Callback</h2><p>我们来看下 Callback 对象的创建，Callback 是一个回调对象，用于处理 op 变化后的操作；同时又是一个 DeathRecipient 对象，用来监听远程 IAppOpsCallback 桩对象是否死亡！<br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">final</span> <span class="class"><span class="keyword">class</span> <span class="title">Callback</span> <span class="keyword">implements</span> <span class="title">DeathRecipient</span> </span>&#123;</span><br><span class="line">    <span class="keyword">final</span> IAppOpsCallback mCallback;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="title">Callback</span><span class="params">(IAppOpsCallback callback)</span> </span>&#123;</span><br><span class="line">        mCallback = callback;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            <span class="comment">//【1】将自身注册为一个死亡仆告对象！</span></span><br><span class="line">            mCallback.asBinder().linkToDeath(<span class="keyword">this</span>, <span class="number">0</span>);</span><br><span class="line">        &#125; <span class="keyword">catch</span> (RemoteException e) &#123;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">unlinkToDeath</span><span class="params">()</span> </span>&#123; <span class="comment">//【2】解除注册！</span></span><br><span class="line">        mCallback.asBinder().unlinkToDeath(<span class="keyword">this</span>, <span class="number">0</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">binderDied</span><span class="params">()</span> </span>&#123; <span class="comment">//【1.6】当远程桩对象死亡后，停止监听！</span></span><br><span class="line">        stopWatchingMode(mCallback);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>当远程的 IAppOpsCallback.Stub 死亡后，AppOpsService.stopWatchingMode 会被执行！</p>
<h1 id="6-AppOpsService-stopWatchingMode-停止-op-监听"><a href="#6-AppOpsService-stopWatchingMode-停止-op-监听" class="headerlink" title="6 AppOpsService.stopWatchingMode - 停止 op 监听"></a>6 AppOpsService.stopWatchingMode - 停止 op 监听</h1><p>startWatchingMode 用于停止一个监听！<br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">stopWatchingMode</span><span class="params">(IAppOpsCallback callback)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">if</span> (callback == <span class="keyword">null</span>) &#123;</span><br><span class="line">        <span class="keyword">return</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">synchronized</span> (<span class="keyword">this</span>) &#123;</span><br><span class="line">        <span class="comment">//【1】从 mModeWatchers 中移除 Callback！</span></span><br><span class="line">        Callback cb = mModeWatchers.remove(callback.asBinder());</span><br><span class="line">        <span class="keyword">if</span> (cb != <span class="keyword">null</span>) &#123;</span><br><span class="line">            <span class="comment">// 解除死亡仆告对象注册！</span></span><br><span class="line">            cb.unlinkToDeath();</span><br><span class="line">            <span class="comment">//【2】从 mOpModeWatchers 移除该 Callback！</span></span><br><span class="line">            <span class="keyword">for</span> (<span class="keyword">int</span> i=mOpModeWatchers.size()-<span class="number">1</span>; i&gt;=<span class="number">0</span>; i--) &#123;</span><br><span class="line">                ArrayList&lt;Callback&gt; cbs = mOpModeWatchers.valueAt(i);</span><br><span class="line">                cbs.remove(cb);</span><br><span class="line">                <span class="keyword">if</span> (cbs.size() &lt;= <span class="number">0</span>) &#123;</span><br><span class="line">                    mOpModeWatchers.removeAt(i);</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="comment">//【3】从 mPackageModeWatchers 移除该 Callback！</span></span><br><span class="line">            <span class="keyword">for</span> (<span class="keyword">int</span> i=mPackageModeWatchers.size()-<span class="number">1</span>; i&gt;=<span class="number">0</span>; i--) &#123;</span><br><span class="line">                ArrayList&lt;Callback&gt; cbs = mPackageModeWatchers.valueAt(i);</span><br><span class="line">                cbs.remove(cb);</span><br><span class="line">                <span class="keyword">if</span> (cbs.size() &lt;= <span class="number">0</span>) &#123;</span><br><span class="line">                    mPackageModeWatchers.removeAt(i);</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>方法很简单，就不多说了！</p>
<h1 id="7-AppOpsService-startOperation-开始监视操作"><a href="#7-AppOpsService-startOperation-开始监视操作" class="headerlink" title="7 AppOpsService.startOperation - 开始监视操作"></a>7 AppOpsService.startOperation - 开始监视操作</h1><p>startOperation 用于监控一些长时间工作的操作，比如 Gps，像 Vibrator 等等，可以使用 startOperation 开始监视权限，使用 finishOperation 结束监视，要监视 op 前提是被监视者有权限执行 op 操作！！</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">int</span> <span class="title">startOperation</span><span class="params">(IBinder token, <span class="keyword">int</span> code, <span class="keyword">int</span> uid, String packageName)</span> </span>&#123;</span><br><span class="line">    verifyIncomingUid(uid);</span><br><span class="line">    verifyIncomingOp(code);</span><br><span class="line">    <span class="comment">//【1】处理包名！</span></span><br><span class="line">    String resolvedPackageName = resolvePackageName(uid, packageName);</span><br><span class="line">    <span class="keyword">if</span> (resolvedPackageName == <span class="keyword">null</span>) &#123;</span><br><span class="line">        <span class="keyword">return</span>  AppOpsManager.MODE_IGNORED;</span><br><span class="line">    &#125;</span><br><span class="line">    ClientState client = (ClientState)token;</span><br><span class="line">    <span class="keyword">synchronized</span> (<span class="keyword">this</span>) &#123;</span><br><span class="line">        <span class="comment">//【*1.4.1】获得该 package 的所有 Op 信息！</span></span><br><span class="line">        Ops ops = getOpsRawLocked(uid, resolvedPackageName, <span class="keyword">true</span>);</span><br><span class="line">        <span class="keyword">if</span> (ops == <span class="keyword">null</span>) &#123;</span><br><span class="line">            <span class="keyword">if</span> (DEBUG) Log.d(TAG, <span class="string">"startOperation: no op for code "</span> + code + <span class="string">" uid "</span> + uid</span><br><span class="line">                    + <span class="string">" package "</span> + resolvedPackageName);</span><br><span class="line">            <span class="keyword">return</span> AppOpsManager.MODE_ERRORED;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">//【*1.5】获得 code 指定的 Op 信息！</span></span><br><span class="line">        Op op = getOpLocked(ops, code, <span class="keyword">true</span>);</span><br><span class="line"></span><br><span class="line">        <span class="comment">//【*1.4】如果该 op 在 uid 所在的用户下受限，返回 MODE_IGNORED ！</span></span><br><span class="line">        <span class="keyword">if</span> (isOpRestrictedLocked(uid, code, resolvedPackageName)) &#123;</span><br><span class="line">            <span class="keyword">return</span> AppOpsManager.MODE_IGNORED;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">//【2】获得决定 code 指定 op 模式的 switchCode，其实是另外一个 op！</span></span><br><span class="line">        <span class="keyword">final</span> <span class="keyword">int</span> switchCode = AppOpsManager.opToSwitch(code);</span><br><span class="line">        UidState uidState = ops.uidState;</span><br><span class="line">        <span class="keyword">if</span> (uidState.opModes != <span class="keyword">null</span>) &#123;</span><br><span class="line">            <span class="comment">//【3.1】如果该 uid 有 switchCode 对应的操作，那么 uid 的 switchCode 模式优先级更高！</span></span><br><span class="line">            <span class="comment">// 所以，最后返回的是该 uid 的 switchCode 模式！</span></span><br><span class="line">            <span class="keyword">final</span> <span class="keyword">int</span> uidMode = uidState.opModes.get(switchCode);</span><br><span class="line">            <span class="keyword">if</span> (uidMode != AppOpsManager.MODE_ALLOWED) &#123;</span><br><span class="line">                <span class="keyword">if</span> (DEBUG) Log.d(TAG, <span class="string">"noteOperation: reject #"</span> + op.mode + <span class="string">" for code "</span></span><br><span class="line">                        + switchCode + <span class="string">" ("</span> + code + <span class="string">") uid "</span> + uid + <span class="string">" package "</span></span><br><span class="line">                        + resolvedPackageName);</span><br><span class="line">                <span class="comment">//【3.1.1】uid 不被允许的执行该 switchCode 指定的操作，</span></span><br><span class="line">                <span class="comment">// 那么更新 code 对应 op 的 rejectTime 值！</span></span><br><span class="line">                op.rejectTime = System.currentTimeMillis();</span><br><span class="line">                <span class="keyword">return</span> uidMode;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">//【3.2】如果该 uid 没有该 switchCode 对应的操作，那就读取 package 的 switchCode 操作模式！</span></span><br><span class="line">        <span class="comment">// 所以，最后返回的是该 package 的 switchCode 模式！</span></span><br><span class="line">        <span class="keyword">final</span> Op switchOp = switchCode != code ? getOpLocked(ops, switchCode, <span class="keyword">true</span>) : op;</span><br><span class="line">        <span class="keyword">if</span> (switchOp.mode != AppOpsManager.MODE_ALLOWED) &#123;</span><br><span class="line">            <span class="keyword">if</span> (DEBUG) Log.d(TAG, <span class="string">"startOperation: reject #"</span> + op.mode + <span class="string">" for code "</span></span><br><span class="line">                    + switchCode + <span class="string">" ("</span> + code + <span class="string">") uid "</span> + uid + <span class="string">" package "</span></span><br><span class="line">                    + resolvedPackageName);</span><br><span class="line">            <span class="comment">//【3.2.1】package 不被允许的执行该 switchCode 在指定的操作，</span></span><br><span class="line">            <span class="comment">// 那么更新 code 对应 op 的 rejectTime 值！</span></span><br><span class="line">            op.rejectTime = System.currentTimeMillis();</span><br><span class="line">            <span class="keyword">return</span> switchOp.mode;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">if</span> (DEBUG) Log.d(TAG, <span class="string">"startOperation: allowing code "</span> + code + <span class="string">" uid "</span> + uid</span><br><span class="line">                + <span class="string">" package "</span> + resolvedPackageName);</span><br><span class="line">        </span><br><span class="line">        <span class="comment">// 进入到这里，表示该操作是被允许的，这里会更新 op 的数据，然后返回 MODE_ALLOWED！</span></span><br><span class="line">        <span class="keyword">if</span> (op.nesting == <span class="number">0</span>) &#123;</span><br><span class="line">            op.time = System.currentTimeMillis(); <span class="comment">// 更新允许时间</span></span><br><span class="line">            op.rejectTime = <span class="number">0</span>; <span class="comment">// 设置拒绝时间为 0；</span></span><br><span class="line">            op.duration = -<span class="number">1</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        op.nesting++; <span class="comment">// start 次数加 1；</span></span><br><span class="line">        <span class="keyword">if</span> (client.mStartedOps != <span class="keyword">null</span>) &#123;</span><br><span class="line">            client.mStartedOps.add(op); <span class="comment">// 将 start 的 Op 添加到 ClientState.mStartedOps 中监控！</span></span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> AppOpsManager.MODE_ALLOWED;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>startOperation 的第一个参数是一个 IBinder token，这个 token 通过如下方式获得：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">AppOpsManager.getToken(mAppOpsService)</span><br></pre></td></tr></table></figure>
<p>在 AppOpsManager 中我们有分析过这个方法，其返回的是一个 ClientState 对象！</p>
<h2 id="7-1-AppOpsManager-getToken"><a href="#7-1-AppOpsManager-getToken" class="headerlink" title="7.1 AppOpsManager.getToken"></a>7.1 AppOpsManager.getToken</h2><p>我们来看看 getToken 方法，传入的是 mService。mService 是 AppOpsManager 的成员变量：<br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">IAppOpsService mService;</span><br></pre></td></tr></table></figure></p>
<p>其实 mService 就是 AppOpsService 的 Proxy 对象！</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">/** @hide */</span><br><span class="line">public static IBinder getToken(IAppOpsService service) &#123;</span><br><span class="line">    synchronized (AppOpsManager.class) &#123;</span><br><span class="line">        if (sToken != null) &#123;</span><br><span class="line">            return sToken;</span><br><span class="line">        &#125;</span><br><span class="line">        try &#123;</span><br><span class="line">            //【1】这里创建了一个 new Binder 对象，同时调用 AppOpsService.getToken 方法！</span><br><span class="line">            // 该方法会返回一个 Binder 对象，保存到 AppOpsManager.sToken 变量中;</span><br><span class="line">            sToken = service.getToken(new Binder());</span><br><span class="line">        &#125; catch (RemoteException e) &#123;</span><br><span class="line">            throw e.rethrowFromSystemServer();</span><br><span class="line">        &#125;</span><br><span class="line">        return sToken;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>这里会创建一个 Binder 对象，表示当前进程实体！</p>
<p>sToken 也是一个 Binder 对象：<br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">static</span> IBinder sToken;</span><br></pre></td></tr></table></figure></p>
<p>用于保存 AppOpsService 返回的 ClientState 对象！</p>
<h2 id="7-2-AppOpsService-getToken"><a href="#7-2-AppOpsService-getToken" class="headerlink" title="7.2 AppOpsService.getToken"></a>7.2 AppOpsService.getToken</h2><p>通过 Binder 通信，AppOpsManager 创建的 Binder 对象，传递到了 AppOpsService.getToken 方法中！<br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> IBinder <span class="title">getToken</span><span class="params">(IBinder clientToken)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">synchronized</span> (<span class="keyword">this</span>) &#123;</span><br><span class="line">        ClientState cs = mClients.get(clientToken);</span><br><span class="line">        <span class="keyword">if</span> (cs == <span class="keyword">null</span>) &#123;</span><br><span class="line">            <span class="comment">//【×7.2.1】创建一个 ClientState 对象，保存到 mClients 中！</span></span><br><span class="line">            cs = <span class="keyword">new</span> ClientState(clientToken);</span><br><span class="line">            mClients.put(clientToken, cs);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> cs;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>这里的 ClientToken，就是前面 new Binder 创建的实体!</p>
<p>AppOpsService 内部有一个 mClients 变量，用于保存调用方进程的 Binder 对象和对应的 ClientState 的映射关系！<br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">final</span> ArrayMap&lt;IBinder, ClientState&gt; mClients = <span class="keyword">new</span> ArrayMap&lt;IBinder, ClientState&gt;();</span><br></pre></td></tr></table></figure></p>
<p>这个 ClientState 会记录调用方进程的 op 状态，同时其也实现了 DeathRecipient 接口，能够监听调用方进程的 Binder 对象是否死亡！</p>
<h3 id="7-2-1-new-ClientState-被监控的实体信息"><a href="#7-2-1-new-ClientState-被监控的实体信息" class="headerlink" title="7.2.1 new ClientState - 被监控的实体信息"></a>7.2.1 new ClientState - 被监控的实体信息</h3><p>我们来看下 ClientState 的结构！</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">final</span> <span class="class"><span class="keyword">class</span> <span class="title">ClientState</span> <span class="keyword">extends</span> <span class="title">Binder</span> <span class="keyword">implements</span> <span class="title">DeathRecipient</span> </span>&#123;</span><br><span class="line">    <span class="keyword">final</span> IBinder mAppToken; <span class="comment">// 调用方进程 token！</span></span><br><span class="line">    <span class="keyword">final</span> <span class="keyword">int</span> mPid; <span class="comment">// 调用方进程的 pid</span></span><br><span class="line">    <span class="keyword">final</span> ArrayList&lt;Op&gt; mStartedOps; <span class="comment">// 用于保存调用方被 start 的所有 Op 操作！</span></span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="title">ClientState</span><span class="params">(IBinder appToken)</span> </span>&#123;</span><br><span class="line">        mAppToken = appToken; <span class="comment">// 保存调用方的 Binder 对象！</span></span><br><span class="line">        mPid = Binder.getCallingPid(); <span class="comment">// 获得调用方进程的 pid！</span></span><br><span class="line">        <span class="keyword">if</span> (appToken <span class="keyword">instanceof</span> Binder) &#123;</span><br><span class="line">            <span class="comment">// 如果调用方传来的 appToken 是 Binder 的实例，那说明调用方就是系统进程内部的某个 client！</span></span><br><span class="line">            <span class="comment">// 这种中情况，无需监控被 start 的 op 操作！</span></span><br><span class="line">            mStartedOps = <span class="keyword">null</span>;</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            <span class="comment">// 如果调用方处于非系统进程，那么我们需要监控其 start 的 op 操作！</span></span><br><span class="line">            mStartedOps = <span class="keyword">new</span> ArrayList&lt;Op&gt;();</span><br><span class="line">            <span class="keyword">try</span> &#123;</span><br><span class="line">                mAppToken.linkToDeath(<span class="keyword">this</span>, <span class="number">0</span>);</span><br><span class="line">            &#125; <span class="keyword">catch</span> (RemoteException e) &#123;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">binderDied</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="comment">// 当远程调用进程死亡后，会调用 ClientState.binderDied 方法，该方法会 finish 掉远程进程</span></span><br><span class="line">        <span class="comment">// 持有的所有被 start 的 op 操作！</span></span><br><span class="line">        <span class="keyword">synchronized</span> (AppOpsService.<span class="keyword">this</span>) &#123;</span><br><span class="line">            <span class="keyword">for</span> (<span class="keyword">int</span> i=mStartedOps.size()-<span class="number">1</span>; i&gt;=<span class="number">0</span>; i--) &#123;</span><br><span class="line">                <span class="comment">//【*8.1】调用了 finishOperation 方法！</span></span><br><span class="line">                finishOperationLocked(mStartedOps.get(i));</span><br><span class="line">            &#125;</span><br><span class="line">            mClients.remove(mAppToken);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>对于 ClientState 的分析就到这里！</p>
<h1 id="8-AppOpsService-finishOperation-结束监视操作"><a href="#8-AppOpsService-finishOperation-结束监视操作" class="headerlink" title="8 AppOpsService.finishOperation - 结束监视操作"></a>8 AppOpsService.finishOperation - 结束监视操作</h1><p>finishOperation</p>
<p>第一个参数 IBinder token，必须是 ClientState 对象！也就是说，必须在调用了 startOperation 后，finishOperation 才有意义！</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">finishOperation</span><span class="params">(IBinder token, <span class="keyword">int</span> code, <span class="keyword">int</span> uid, String packageName)</span> </span>&#123;</span><br><span class="line">    verifyIncomingUid(uid);</span><br><span class="line">    verifyIncomingOp(code);</span><br><span class="line">    String resolvedPackageName = resolvePackageName(uid, packageName);</span><br><span class="line">    <span class="keyword">if</span> (resolvedPackageName == <span class="keyword">null</span>) &#123;</span><br><span class="line">        <span class="keyword">return</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span> (!(token <span class="keyword">instanceof</span> ClientState)) &#123;</span><br><span class="line">        <span class="keyword">return</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    ClientState client = (ClientState) token;</span><br><span class="line">    <span class="keyword">synchronized</span> (<span class="keyword">this</span>) &#123;</span><br><span class="line">        <span class="comment">//【×1.5】获得 uid 下该 package 的 code 操作对应的 Op 实例！</span></span><br><span class="line">        Op op = getOpLocked(code, uid, resolvedPackageName, <span class="keyword">true</span>);</span><br><span class="line">        <span class="keyword">if</span> (op == <span class="keyword">null</span>) &#123;</span><br><span class="line">            <span class="keyword">return</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">//【2】从 ClientState.mStartedOps 中移除该 Op！！</span></span><br><span class="line">        <span class="keyword">if</span> (client.mStartedOps != <span class="keyword">null</span>) &#123;</span><br><span class="line">            <span class="keyword">if</span> (!client.mStartedOps.remove(op)) &#123;</span><br><span class="line">                <span class="keyword">throw</span> <span class="keyword">new</span> IllegalStateException(<span class="string">"Operation not started: uid"</span> + op.uid</span><br><span class="line">                        + <span class="string">" pkg="</span> + op.packageName + <span class="string">" op="</span> + op.op);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">//【×8.1】调用了 finishOperationLocked 方法，继续处理！</span></span><br><span class="line">        finishOperationLocked(op);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>整个方法很简单，不所说了！</p>
<h2 id="8-1-finishOperationLocked"><a href="#8-1-finishOperationLocked" class="headerlink" title="8.1 finishOperationLocked"></a>8.1 finishOperationLocked</h2><p>finishOperationLocked 方法中会对该 Op 的属性进行更新！<br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">finishOperationLocked</span><span class="params">(Op op)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">if</span> (op.nesting &lt;= <span class="number">1</span>) &#123;</span><br><span class="line">        <span class="keyword">if</span> (op.nesting == <span class="number">1</span>) &#123;</span><br><span class="line">            <span class="comment">//【1】更新该操作的执行时长！</span></span><br><span class="line">            op.duration = (<span class="keyword">int</span>)(System.currentTimeMillis() - op.time);</span><br><span class="line">            <span class="comment">//【2】更新操作 op 的最新允许时间！</span></span><br><span class="line">            op.time += op.duration;</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            Slog.w(TAG, <span class="string">"Finishing op nesting under-run: uid "</span> + op.uid + <span class="string">" pkg "</span></span><br><span class="line">                    + op.packageName + <span class="string">" code "</span> + op.op + <span class="string">" time="</span> + op.time</span><br><span class="line">                    + <span class="string">" duration="</span> + op.duration + <span class="string">" nesting="</span> + op.nesting);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">// 将 op.nesting 置为 0，表示 Op 的 start 操作完全结束！</span></span><br><span class="line">        op.nesting = <span class="number">0</span>;</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        op.nesting--; <span class="comment">// start 次数减 1；</span></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<h1 id="9-AppOpsService-setUserRestriction-设置用户限制"><a href="#9-AppOpsService-setUserRestriction-设置用户限制" class="headerlink" title="9 AppOpsService.setUserRestriction - 设置用户限制"></a>9 AppOpsService.setUserRestriction - 设置用户限制</h1><p>setUserRestriction 主要是在 UserManagerService 方法中使用！</p>
<p>setUserRestriction 方法用于设置用户限制，他有 2 个重载函数，第一个 setUserRestriction 方法会设置所有 op 的用户限制！</p>
<p>参数 IBinder token 是一个 Binder 对象，用于表示远程调用者，UserManagerService 中直接传入的是一个 new Bindler 对象！<br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">setUserRestrictions</span><span class="params">(Bundle restrictions, IBinder token, <span class="keyword">int</span> userHandle)</span> </span>&#123;</span><br><span class="line">    checkSystemUid(<span class="string">"setUserRestrictions"</span>); / 如果不是系统进程调用会抛出异常！</span><br><span class="line">    Preconditions.checkNotNull(restrictions);</span><br><span class="line">    Preconditions.checkNotNull(token);</span><br><span class="line">    <span class="comment">//【1】处理定义的每一个 operation，获得其所受的用户限制！</span></span><br><span class="line">    <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; AppOpsManager._NUM_OP; i++) &#123;</span><br><span class="line">        String restriction = AppOpsManager.opToRestriction(i);</span><br><span class="line">        <span class="comment">// 如果该 op 确实会受到用户限制，继续处理！</span></span><br><span class="line">        <span class="keyword">if</span> (restriction != <span class="keyword">null</span>) &#123;</span><br><span class="line">            <span class="comment">//【×9.1】调用了 setUserRestrictionNoCheck 方法，进一步设置用户限制！</span></span><br><span class="line">            setUserRestrictionNoCheck(i, restrictions.getBoolean(restriction, <span class="keyword">false</span>), token,</span><br><span class="line">                    userHandle, <span class="keyword">null</span>);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>第二个 setUserRestriction 方法，第一个方法会设置指定 op 是否受到用户限制，同时额外传入了一个 String[] exceptionPackages，表示白名单，在该白名单中的 package 可以不受用户限制：<br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">setUserRestriction</span><span class="params">(<span class="keyword">int</span> code, <span class="keyword">boolean</span> restricted, IBinder token, <span class="keyword">int</span> userHandle,</span></span></span><br><span class="line"><span class="function"><span class="params">        String[] exceptionPackages)</span> </span>&#123;</span><br><span class="line">    <span class="comment">//【1】当不是当前进程调用，强制校验是否有 MANAGE_APP_OPS_RESTRICTIONS 权限！</span></span><br><span class="line">    <span class="keyword">if</span> (Binder.getCallingPid() != Process.myPid()) &#123;</span><br><span class="line">        mContext.enforcePermission(Manifest.permission.MANAGE_APP_OPS_RESTRICTIONS,</span><br><span class="line">                Binder.getCallingPid(), Binder.getCallingUid(), <span class="keyword">null</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">//【2】如果是跨用户调用，要校验是否有 INTERACT_ACROSS_USERS_FULL 和 INTERACT_ACROSS_USERS 权限！</span></span><br><span class="line">    <span class="keyword">if</span> (userHandle != UserHandle.getCallingUserId()) &#123;</span><br><span class="line">        <span class="keyword">if</span> (mContext.checkCallingOrSelfPermission(Manifest.permission</span><br><span class="line">                .INTERACT_ACROSS_USERS_FULL ) != PackageManager.PERMISSION_GRANTED</span><br><span class="line">            &amp;&amp; mContext.checkCallingOrSelfPermission(Manifest.permission</span><br><span class="line">                .INTERACT_ACROSS_USERS) != PackageManager.PERMISSION_GRANTED) &#123;</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> SecurityException(<span class="string">"Need INTERACT_ACROSS_USERS_FULL or"</span></span><br><span class="line">                    + <span class="string">" INTERACT_ACROSS_USERS to interact cross user "</span>);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    verifyIncomingOp(code);</span><br><span class="line">    Preconditions.checkNotNull(token);</span><br><span class="line">    <span class="comment">//【×9.1】调用了 setUserRestrictionNoCheck 方法，进一步设置用户限制！</span></span><br><span class="line">    setUserRestrictionNoCheck(code, restricted, token, userHandle, exceptionPackages);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<h2 id="9-1-setUserRestrictionNoCheck"><a href="#9-1-setUserRestrictionNoCheck" class="headerlink" title="9.1 setUserRestrictionNoCheck"></a>9.1 setUserRestrictionNoCheck</h2><p>参数 boolean restricted 表示是否限制，为 true 的话，表示打开限制！</p>
<p>这里的 token 来自 UserManagerService 中：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> IBinder mUserRestriconToken = <span class="keyword">new</span> Binder();</span><br></pre></td></tr></table></figure>
<p>本质上是一个 Binder 对象！！<br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">setUserRestrictionNoCheck</span><span class="params">(<span class="keyword">int</span> code, <span class="keyword">boolean</span> restricted, IBinder token,</span></span></span><br><span class="line"><span class="function"><span class="params">        <span class="keyword">int</span> userHandle, String[] exceptionPackages)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">boolean</span> notifyChange = <span class="keyword">false</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">synchronized</span> (AppOpsService.<span class="keyword">this</span>) &#123;</span><br><span class="line">        <span class="comment">//【×9.2】从 mOpUserRestrictions 获得 IBinder 对应的 ClientRestrictionState 对象！</span></span><br><span class="line">        <span class="comment">// 如果没有，就会创建一个新的实例，加入 mOpUserRestrictions！</span></span><br><span class="line">        ClientRestrictionState restrictionState = mOpUserRestrictions.get(token);</span><br><span class="line">        <span class="keyword">if</span> (restrictionState == <span class="keyword">null</span>) &#123;</span><br><span class="line">            <span class="keyword">try</span> &#123;</span><br><span class="line">                restrictionState = <span class="keyword">new</span> ClientRestrictionState(token);</span><br><span class="line">            &#125; <span class="keyword">catch</span> (RemoteException e) &#123;</span><br><span class="line">                <span class="keyword">return</span>;</span><br><span class="line">            &#125;</span><br><span class="line">            mOpUserRestrictions.put(token, restrictionState);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">//【×9.3】设置用户限制，如果有 op 的限制发生了变化，或者不受限制白名单发生了变化！</span></span><br><span class="line">        <span class="keyword">if</span> (restrictionState.setRestriction(code, restricted, exceptionPackages, userHandle)) &#123;</span><br><span class="line">            notifyChange = <span class="keyword">true</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">//【×9.3.1】如果该 bindler 对应的 ClientRestrictionState 恢复了默认状态，那就移除！</span></span><br><span class="line">        <span class="keyword">if</span> (restrictionState.isDefault()) &#123;</span><br><span class="line">            mOpUserRestrictions.remove(token);</span><br><span class="line">            restrictionState.destroy();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">//【×9.4】通知所有的监听者，该操作的用户限制状态发生了变化！</span></span><br><span class="line">    <span class="keyword">if</span> (notifyChange) &#123;</span><br><span class="line">        notifyWatchersOfChange(code);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>AppOpsService 有一个 mOpUserRestrictions 的哈希表，用与保存所有的用于限制信息！<br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">private</span> <span class="keyword">final</span> ArrayMap&lt;IBinder, ClientRestrictionState&gt; mOpUserRestrictions = <span class="keyword">new</span> ArrayMap&lt;&gt;();</span><br></pre></td></tr></table></figure></p>
<h2 id="9-2-new-ClientRestrictionState"><a href="#9-2-new-ClientRestrictionState" class="headerlink" title="9.2 new ClientRestrictionState"></a>9.2 new ClientRestrictionState</h2><p>当第一次设置用户限制时，会创建 ClientRestrictionState 对象。保存用户限制状态！<br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">private</span> <span class="keyword">final</span> <span class="class"><span class="keyword">class</span> <span class="title">ClientRestrictionState</span> <span class="keyword">implements</span> <span class="title">DeathRecipient</span> </span>&#123;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> IBinder token;</span><br><span class="line">    SparseArray&lt;<span class="keyword">boolean</span>[]&gt; perUserRestrictions; <span class="comment">// 见下面；</span></span><br><span class="line">    SparseArray&lt;String[]&gt; perUserExcludedPackages; <span class="comment">// 见下面；</span></span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="title">ClientRestrictionState</span><span class="params">(IBinder token)</span></span></span><br><span class="line"><span class="function">            <span class="keyword">throws</span> RemoteException </span>&#123;</span><br><span class="line">        <span class="comment">//【1】绑定远程进程的 Binder 对象！</span></span><br><span class="line">        token.linkToDeath(<span class="keyword">this</span>, <span class="number">0</span>);</span><br><span class="line">        <span class="keyword">this</span>.token = token;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">binderDied</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">synchronized</span> (AppOpsService.<span class="keyword">this</span>) &#123;</span><br><span class="line">            <span class="comment">//【2】从 mOpUserRestrictions 中该 token 相应关系，解除了用户限制！</span></span><br><span class="line">            mOpUserRestrictions.remove(token);</span><br><span class="line">            <span class="keyword">if</span> (perUserRestrictions == <span class="keyword">null</span>) &#123;</span><br><span class="line">                <span class="keyword">return</span>;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">final</span> <span class="keyword">int</span> userCount = perUserRestrictions.size();</span><br><span class="line">            <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; userCount; i++) &#123;</span><br><span class="line">                <span class="keyword">final</span> <span class="keyword">boolean</span>[] restrictions = perUserRestrictions.valueAt(i);</span><br><span class="line">                <span class="keyword">final</span> <span class="keyword">int</span> restrictionCount = restrictions.length;</span><br><span class="line">                <span class="keyword">for</span> (<span class="keyword">int</span> j = <span class="number">0</span>; j &lt; restrictionCount; j++) &#123;</span><br><span class="line">                    <span class="comment">//【1】如果有 op 之前是开启了用户限制，那么需要通知所有监听 op 状态变化的回调</span></span><br><span class="line">                    <span class="comment">//【1.9.4】调用了 notifyWatchersOfChange 方法！</span></span><br><span class="line">                    <span class="keyword">if</span> (restrictions[j]) &#123;</span><br><span class="line">                        <span class="keyword">final</span> <span class="keyword">int</span> changedCode = j;</span><br><span class="line">                        mHandler.post(() -&gt; notifyWatchersOfChange(changedCode));</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">            destroy();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>ClientRestrictionState 实现了 DeathRecipient 接口，当和其绑定的远程 Binder 对象死亡后会触发其 binderDied 方法！</p>
<ul>
<li><p><strong>perUserRestrictions</strong> 是一个 SparseArray，下标为 userId，而 SparseArray[i] 则是一个 boolean[] 数组，该数组长度为 AppOpsManager._NUM_OP 表示在 userId 下，每个 op 的限制情况，为 true 表示限制，为 false 表示不限制！</p>
</li>
<li><p><strong>perUserExcludedPackages</strong> 也是一个 SparseArray，下标为 userId，而 SparseArray[i] 则是一个 String[] 数组，该数字保存白名单，在该名单中的应用不会受到用户限制！</p>
</li>
</ul>
<p>当 token 对应的远程 Binder 对象死亡后，会触发 ClientRestrictionState.binderDied 方法</p>
<h2 id="9-3-ClientRestrictionState-setRestriction"><a href="#9-3-ClientRestrictionState-setRestriction" class="headerlink" title="9.3 ClientRestrictionState.setRestriction"></a>9.3 ClientRestrictionState.setRestriction</h2><p>设置用户限制，restricted 表示是否限制！<br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">boolean</span> <span class="title">setRestriction</span><span class="params">(<span class="keyword">int</span> code, <span class="keyword">boolean</span> restricted, String[] excludedPackages, <span class="keyword">int</span> userId)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">boolean</span> changed = <span class="keyword">false</span>;</span><br><span class="line">    <span class="keyword">if</span> (perUserRestrictions == <span class="keyword">null</span> &amp;&amp; restricted) &#123;</span><br><span class="line">        perUserRestrictions = <span class="keyword">new</span> SparseArray&lt;&gt;();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (perUserRestrictions != <span class="keyword">null</span>) &#123;</span><br><span class="line">        <span class="comment">//【1】获得 userId 下，所有 op 的限制情况！</span></span><br><span class="line">        <span class="keyword">boolean</span>[] userRestrictions = perUserRestrictions.get(userId);</span><br><span class="line">        <span class="keyword">if</span> (userRestrictions == <span class="keyword">null</span> &amp;&amp; restricted) &#123;</span><br><span class="line">            <span class="comment">//【1.1】如果 userRestrictions 为 null，且当前要设置为限制，那就会初始化 userRestrictions</span></span><br><span class="line">            <span class="comment">// 为一个 AppOpsManager._NUM_OP 大小的数组，添加到 perUserRestrictions 中！</span></span><br><span class="line">            userRestrictions = <span class="keyword">new</span> <span class="keyword">boolean</span>[AppOpsManager._NUM_OP];</span><br><span class="line">            perUserRestrictions.put(userId, userRestrictions);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">//【2】尝试更新 userRestrictions[code] 的值，userRestrictions[code] 表示的是 op 的限制状态！</span></span><br><span class="line">        <span class="comment">// 只有当限制状态变化时，才会更新！</span></span><br><span class="line">        <span class="keyword">if</span> (userRestrictions != <span class="keyword">null</span> &amp;&amp; userRestrictions[code] != restricted) &#123;</span><br><span class="line">            <span class="comment">// 更新 userRestrictions[code]；</span></span><br><span class="line">            userRestrictions[code] = restricted;</span><br><span class="line">            <span class="comment">//【×9.3.1】如果本次是取消用户限制，并且 userId 下的所有的 op 都是不开启限制的！</span></span><br><span class="line">            <span class="comment">// 那么从 perUserRestrictions 中移除该 userId 的记录！</span></span><br><span class="line">            <span class="keyword">if</span> (!restricted &amp;&amp; isDefault(userRestrictions)) &#123;</span><br><span class="line">                perUserRestrictions.remove(userId);</span><br><span class="line">                userRestrictions = <span class="keyword">null</span>;</span><br><span class="line">            &#125;</span><br><span class="line">            changed = <span class="keyword">true</span>; <span class="comment">// 表示发生了更新！</span></span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment">//【3】userRestrictions 不为 null，说明在该 userId 下对某些 op 进行了用户限制！</span></span><br><span class="line">        <span class="keyword">if</span> (userRestrictions != <span class="keyword">null</span>) &#123;</span><br><span class="line">            <span class="keyword">final</span> <span class="keyword">boolean</span> noExcludedPackages = ArrayUtils.isEmpty(excludedPackages);</span><br><span class="line">            <span class="keyword">if</span> (perUserExcludedPackages == <span class="keyword">null</span> &amp;&amp; !noExcludedPackages) &#123;</span><br><span class="line">                <span class="comment">//【3.1】如果本次指定了白名单，并且 perUserExcludedPackages 为 null</span></span><br><span class="line">                <span class="comment">// 那么会进行初始化；</span></span><br><span class="line">                perUserExcludedPackages = <span class="keyword">new</span> SparseArray&lt;&gt;();</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="comment">//【3.2】本次指定的白名单 excludedPackages 和该 userId 下已有的名单不一样！</span></span><br><span class="line">            <span class="comment">// 如果本次未指定白名单，那就移除该 userId 下已有的名单；</span></span><br><span class="line">            <span class="comment">// 如果本次指定了白名单，那就更新该 userId 下已有的名单；</span></span><br><span class="line">            <span class="keyword">if</span> (perUserExcludedPackages != <span class="keyword">null</span> &amp;&amp; !Arrays.equals(excludedPackages,</span><br><span class="line">                    perUserExcludedPackages.get(userId))) &#123;</span><br><span class="line">                <span class="keyword">if</span> (noExcludedPackages) &#123;</span><br><span class="line">                    perUserExcludedPackages.remove(userId);</span><br><span class="line">                    <span class="keyword">if</span> (perUserExcludedPackages.size() &lt;= <span class="number">0</span>) &#123;</span><br><span class="line">                        perUserExcludedPackages = <span class="keyword">null</span>;</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                    perUserExcludedPackages.put(userId, excludedPackages);</span><br><span class="line">                &#125;</span><br><span class="line">                <span class="comment">//【3.1】名单更新了，设置 changed 为 true！</span></span><br><span class="line">                changed = <span class="keyword">true</span>;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> changed;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>继续分析！</p>
<h3 id="9-3-1-ClientRestrictionState-isDefault"><a href="#9-3-1-ClientRestrictionState-isDefault" class="headerlink" title="9.3.1 ClientRestrictionState.isDefault"></a>9.3.1 ClientRestrictionState.isDefault</h3><p>有两个 default 方法：<br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">boolean</span> <span class="title">isDefault</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    <span class="keyword">return</span> perUserRestrictions == <span class="keyword">null</span> || perUserRestrictions.size() &lt;= <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>无参数 isDefault 方法用来判断该 ClientRestrictionState 对象是否是默认状态！</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">boolean</span> <span class="title">isDefault</span><span class="params">(<span class="keyword">boolean</span>[] array)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">if</span> (ArrayUtils.isEmpty(array)) &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">true</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">for</span> (<span class="keyword">boolean</span> value : array) &#123;</span><br><span class="line">        <span class="keyword">if</span> (value) &#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="keyword">false</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">true</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>一参数 isDefault 方法用来判断指定 ClientRestrictionState.perUserRestrictions 中指定 userId 下的用户限制是否是默认状态！</p>
<h2 id="9-4-notifyWatchersOfChange"><a href="#9-4-notifyWatchersOfChange" class="headerlink" title="9.4 notifyWatchersOfChange"></a>9.4 notifyWatchersOfChange</h2><p>当用户限制状态发生变化后，AppOpsService 会调用 notifyWatchersOfChange 通知所有监听 op 变化的监听者！</p>
<p>int code 参数表示用户限制状态发生变化的 op code！</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">notifyWatchersOfChange</span><span class="params">(<span class="keyword">int</span> code)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">final</span> ArrayList&lt;Callback&gt; clonedCallbacks;</span><br><span class="line">    <span class="comment">//【1】从 mOpModeWatchers 中获得该 op 变化后需要出发的回调列表！</span></span><br><span class="line">    <span class="keyword">synchronized</span> (<span class="keyword">this</span>) &#123;</span><br><span class="line">        ArrayList&lt;Callback&gt; callbacks = mOpModeWatchers.get(code);</span><br><span class="line">        <span class="keyword">if</span> (callbacks == <span class="keyword">null</span>) &#123;</span><br><span class="line">            <span class="keyword">return</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        clonedCallbacks = <span class="keyword">new</span> ArrayList&lt;&gt;(callbacks);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">final</span> <span class="keyword">long</span> identity = Binder.clearCallingIdentity();</span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">        <span class="keyword">final</span> <span class="keyword">int</span> callbackCount = clonedCallbacks.size();</span><br><span class="line">        <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; callbackCount; i++) &#123;</span><br><span class="line">            Callback callback = clonedCallbacks.get(i);</span><br><span class="line">            <span class="keyword">try</span> &#123;</span><br><span class="line">                <span class="comment">//【2】执行回调的 opChanged 方法！</span></span><br><span class="line">                callback.mCallback.opChanged(code, -<span class="number">1</span>, <span class="keyword">null</span>);</span><br><span class="line">            &#125; <span class="keyword">catch</span> (RemoteException e) &#123;</span><br><span class="line">                Log.w(TAG, <span class="string">"Error dispatching op op change"</span>, e);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">        Binder.restoreCallingIdentity(identity);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></div></article><div class="post-copyright"><div class="post-copyright__author"><span class="post-copyright-meta">文章作者: </span><span class="post-copyright-info"><a href="mailto:undefined">Coolqi.Li</a></span></div><div class="post-copyright__type"><span class="post-copyright-meta">文章链接: </span><span class="post-copyright-info"><a href="https://coolqi.top/2017/09/10/AppOps3-AppOpsWithMethods/">https://coolqi.top/2017/09/10/AppOps3-AppOpsWithMethods/</a></span></div><div class="post-copyright__notice"><span class="post-copyright-meta">版权声明: </span><span class="post-copyright-info">本博客所有文章除特别声明外，均采用 <a href="https://creativecommons.org/licenses/by-nc-sa/4.0/">CC BY-NC-SA 4.0</a> 许可协议。转载请注明来自 <a href="https://coolqi.top">Coolqi`s Blog</a>！</span></div></div><div class="post-meta__tag-list"><a class="post-meta__tags" href="/tags/AppOps应用操作管理/">AppOps应用操作管理</a></div><div class="post-qr-code"><div class="post-qr-code-item"><img class="post-qr-code__img" src="/img/zfb.jpg"><div class="post-qr-code__desc">支付宝打赏</div></div><div class="post-qr-code-item"><img class="post-qr-code__img" src="/img/wechat.jpg"><div class="post-qr-code__desc">微信打赏</div></div></div><nav id="pagination"><div class="prev-post pull-left"><a href="/2017/09/27/AlarmManager4-AlarmManagerServiceAttributeSummary/"><i class="fa fa-chevron-left">  </i><span>AlarmManager第 4 篇 - AlarmManagerService属性总结</span></a></div><div class="next-post pull-right"><a href="/2017/08/25/Permission第 5 篇 - grantPermission 权限授予/"><span>Permission第 5 篇 - grantPermission 权限授予</span><i class="fa fa-chevron-right"></i></a></div></nav><div class="post-adv"><a href="https://www.vultr.com/?ref=7231808"><img src="https://www.vultr.com/media/banner_1.png" width="728" height="90"></a></div><div id="gitalk-container"></div><script>var gitalk = new Gitalk({
  clientID: '2cd8921819db714376b8',
  clientSecret: '94b82090448833d5295bc0d210f9f0719b2f124d',
  repo: 'single-li.github.io',
  owner: 'single-li',
  admin: 'single-li',
  id: decodeURI(location.pathname),
  language: 'zh-CN'
})
gitalk.render('gitalk-container')</script></div></div><footer><div class="layout" id="footer"><div class="copyright">&copy;2015 - 2019 By Coolqi.Li</div><div class="framework-info"><span>驱动 - </span><a href="http://hexo.io"><span>Hexo</span></a><span class="footer-separator">|</span><span>主题 - </span><a href="https://github.com/Molunerfinn/hexo-theme-melody"><span>Melody</span></a></div><div class="footer_custom_text">Hi, welcome to my <a href="https://coolqi.top/">blog</a>!</div><div class="busuanzi"><script async src="https://busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script><span id="busuanzi_container_page_pv"><i class="fa fa-file-o"></i><span id="busuanzi_value_page_pv"></span><span></span></span></div></div></footer><i class="fa fa-arrow-up" id="go-up" aria-hidden="true"></i><script src="/js/third-party/anime.min.js"></script><script src="/js/third-party/jquery.min.js"></script><script src="/js/third-party/jquery.fancybox.min.js"></script><script src="/js/third-party/velocity.min.js"></script><script src="/js/third-party/velocity.ui.min.js"></script><script src="/js/utils.js?version=1.5.6"></script><script src="/js/fancybox.js?version=1.5.6"></script><script src="/js/sidebar.js?version=1.5.6"></script><script src="/js/copy.js?version=1.5.6"></script><script src="/js/fireworks.js?version=1.5.6"></script><script src="/js/transition.js?version=1.5.6"></script><script src="/js/scroll.js?version=1.5.6"></script><script src="/js/head.js?version=1.5.6"></script><script type="text/x-mathjax-config">MathJax.Hub.Config({
  tex2jax: {
    inlineMath: [ ['$','$'], ["\\(","\\)"]  ],
    processEscapes: true,
    skipTags: ['script', 'noscript', 'style', 'textarea', 'pre', 'code']
  },
  CommonHTML: {
    linebreaks: { automatic: true, width: "90% container" }
  },
  "HTML-CSS": { 
    linebreaks: { automatic: true, width: "90% container" }
  },
  "SVG": { 
    linebreaks: { automatic: true, width: "90% container" }
  }
});
</script><script type="text/x-mathjax-config">MathJax.Hub.Queue(function() {
  var all = MathJax.Hub.getAllJax(), i;
  for (i=0; i < all.length; i += 1) {
    all[i].SourceElement().parentNode.className += ' has-jax';
  }
});
</script><script src="https://cdn.jsdelivr.net/npm/mathjax/MathJax.js?config=TeX-AMS-MML_HTMLorMML"></script><script src="/js/search/local-search.js"></script><div class="search-dialog" id="local-search"><div class="search-dialog__title" id="local-search-title">本地搜索</div><div id="local-input-panel"><div id="local-search-input"><div class="local-search-box"><input class="local-search-box--input" placeholder="搜索文章"></div></div></div><hr><div id="local-search-results"><div id="local-hits"></div><div id="local-stats"><div class="local-search-stats__hr" id="hr"><span>由</span> <a href="https://github.com/wzpan/hexo-generator-search" style="color:#49B1F5;">hexo-generator-search</a>
 <span>提供支持</span></div></div></div><span class="search-close-button"><i class="fa fa-times"></i></span></div><div class="search-mask"></div><script src="/live2dw/lib/L2Dwidget.min.js?0c58a1486de42ac6cc1c59c7d98ae887"></script><script>L2Dwidget.init({"pluginRootPath":"live2dw/","pluginJsPath":"lib/","pluginModelPath":"assets/","tagMode":false,"debug":false,"model":{"jsonPath":"live2d-widget-model-hijiki"},"display":{"position":"right","width":110,"height":220},"mobile":{"show":false},"log":false});</script></body></html>
<!DOCTYPE html><html lang="zh-Hans"><head><meta charset="UTF-8"><meta http-equiv="X-UA-Compatible" content="IE=edge"><meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1"><meta name="description" content="PMS 第 6 篇 - PMS_READY 阶段"><meta name="keywords" content="PackageManager包管理"><meta name="author" content="Coolqi.Li,undefined"><meta name="copyright" content="Coolqi.Li"><title>PMS 第 6 篇 - PMS_READY 阶段 | Coolqi`s Blog</title><link rel="shortcut icon" href="/img/favicon.ico"><link rel="stylesheet" href="/css/index.css?version=1.5.6"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/font-awesome@4.7.0/css/font-awesome.min.css?version=1.5.6"><link rel="dns-prefetch" href="https://cdn.staticfile.org"><link rel="dns-prefetch" href="https://cdn.bootcss.com"><link rel="dns-prefetch" href="https://creativecommons.org"><script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script><script>(adsbygoogle = window.adsbygoogle || []).push({
  google_ad_client: 'ca-pub-6845729157331145',
  enable_page_level_ads: 'true'
});
</script><link rel="dns-prefetch" href="https://hm.baidu.com"><script>var _hmt = _hmt || [];
(function() {
  var hm = document.createElement("script");
  hm.src = "https://hm.baidu.com/hm.js?b7acef5306e54116ad8a99e8b753a92d";
  var s = document.getElementsByTagName("script")[0]; 
  s.parentNode.insertBefore(hm, s);
})();</script><script>var GLOBAL_CONFIG = { 
  root: '/',
  algolia: undefined,
  localSearch: {"path":"search.xml","languages":{"hits_empty":"找不到您查询的内容:${query}"}},
  copy: {
    success: '复制成功',
    error: '复制错误',
    noSupport: '浏览器不支持'
  }
} </script></head><body><i class="fa fa-arrow-right" id="toggle-sidebar" aria-hidden="true"></i><div id="sidebar"><div class="toggle-sidebar-info text-center"><span data-toggle="切换文章详情">切换站点概览</span><hr></div><div class="sidebar-toc"><div class="sidebar-toc__title">目录</div><div class="sidebar-toc__progress"><span class="progress-notice">你已经读了</span><span class="progress-num">0</span><span class="progress-percentage">%</span><div class="sidebar-toc__progress-bar"></div></div><div class="sidebar-toc__content"><ol class="toc"><li class="toc-item toc-level-1"><a class="toc-link" href="#0-综述"><span class="toc-text">0 综述</span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#1-获得一些-PMS-会用到的应用的包名"><span class="toc-text">1 获得一些 PMS 会用到的应用的包名</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#1-1-PackageMS-getRequiredButNotReallyRequiredVerifierLPr"><span class="toc-text">1.1 PackageMS.getRequiredButNotReallyRequiredVerifierLPr</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#1-2-PackageMS-getRequiredInstallerLPr"><span class="toc-text">1.2 PackageMS.getRequiredInstallerLPr</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#1-3-PackageMS-getRequiredUninstallerLPr"><span class="toc-text">1.3 PackageMS.getRequiredUninstallerLPr</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#1-4-PackageMS-getIntentFilterVerifierComponentNameLPr"><span class="toc-text">1.4 PackageMS.getIntentFilterVerifierComponentNameLPr</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#1-5-PackageMS-getRequiredSharedLibraryLPr"><span class="toc-text">1.5 PackageMS.getRequiredSharedLibraryLPr</span></a></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#2-new-PackageInstallerService-创建安装服务对象"><span class="toc-text">2 new PackageInstallerService - 创建安装服务对象</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#2-1-new-Callback"><span class="toc-text">2.1 new Callback</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#2-2-PackageInstallerService-readSessionsLocked-0"><span class="toc-text">2.2 PackageInstallerService.readSessionsLocked[0]</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#2-2-1-PackageInstallerService-readSessionsLocked-1"><span class="toc-text">2.2.1 PackageInstallerService.readSessionsLocked[1]</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#2-2-1-1-new-SessionParams"><span class="toc-text">2.2.1.1 new SessionParams</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#2-2-1-2-PackageInstallerService-readGrantedRuntimePermissions"><span class="toc-text">2.2.1.2 PackageInstallerService.readGrantedRuntimePermissions</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#2-2-1-3-new-PackageInstallerSession"><span class="toc-text">2.2.1.3 new PackageInstallerSession</span></a></li></ol></li></ol></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#3-new-PackageManagerInternalImpl-系统进程内部调用"><span class="toc-text">3 new PackageManagerInternalImpl - 系统进程内部调用</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#3-1-注册系统服务-provider"><span class="toc-text">3.1 注册系统服务 provider</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#3-2-授予默认权限接口"><span class="toc-text">3.2 授予默认权限接口</span></a></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#4-PackageMS-updatePackagesIfNeeded-执行-Odex-优化"><span class="toc-text">4 PackageMS.updatePackagesIfNeeded - 执行 Odex 优化</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#4-1-PackageManagerServiceUtils-getPackagesForDexopt"><span class="toc-text">4.1 PackageManagerServiceUtils.getPackagesForDexopt</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#4-1-1-PackageManagerServiceUtils-applyPackageFilter"><span class="toc-text">4.1.1 PackageManagerServiceUtils.applyPackageFilter</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#4-1-1-1-PackageManagerServiceUtils-sortPackagesByUsageDate"><span class="toc-text">4.1.1.1 PackageManagerServiceUtils.sortPackagesByUsageDate</span></a></li></ol></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#4-2-PackageMS-performDexOptUpgrade"><span class="toc-text">4.2 PackageMS.performDexOptUpgrade</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#4-2-1-PackageManagerServiceCompilerMapping-getCompilerFilterForReason"><span class="toc-text">4.2.1 PackageManagerServiceCompilerMapping.getCompilerFilterForReason</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#4-2-1-1-PackageManagerServiceCompilerMapping-getAndCheckValidity"><span class="toc-text">4.2.1.1 PackageManagerServiceCompilerMapping.getAndCheckValidity</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#4-2-2-PackageMS-performDexOptTraced"><span class="toc-text">4.2.2 PackageMS.performDexOptTraced</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#4-2-2-1-PackageMS-performDexOptTraced"><span class="toc-text">4.2.2.1 PackageMS.performDexOptTraced</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#4-2-2-2-PackageMS-performDexOptInternalWithDependenciesLI"><span class="toc-text">4.2.2.2 PackageMS.performDexOptInternalWithDependenciesLI</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#4-2-2-3-PackageDexOptimizer-performDexOpt"><span class="toc-text">4.2.2.3 PackageDexOptimizer.performDexOpt</span></a><ol class="toc-child"><li class="toc-item toc-level-5"><a class="toc-link" href="#4-2-2-3-1-PackageDexOptimizer-performDexOptLI"><span class="toc-text">4.2.2.3.1 PackageDexOptimizer.performDexOptLI</span></a><ol class="toc-child"><li class="toc-item toc-level-6"><a class="toc-link" href="#4-2-2-3-1-1-PackageDexOptimizer-createOatDirIfSupported"><span class="toc-text">4.2.2.3.1.1 PackageDexOptimizer.createOatDirIfSupported</span></a></li></ol></li></ol></li></ol></li></ol></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#5-PackageMS-systemReady-进入最终阶段"><span class="toc-text">5 PackageMS.systemReady - 进入最终阶段</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#5-1-DefaultPermissionGrantPolicy-grantDefaultPermissions-默认运行时权限授予"><span class="toc-text">5.1 DefaultPermissionGrantPolicy.grantDefaultPermissions - 默认运行时权限授予</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#5-1-1-DPGrantPolicy-grantPermissionsToSysComponentsAndPrivApps"><span class="toc-text">5.1.1 DPGrantPolicy.grantPermissionsToSysComponentsAndPrivApps</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#5-1-1-1-DPGrantPolicy-isSysComponentOrPersistentPlatformSignedPrivAppLPr"><span class="toc-text">5.1.1.1 DPGrantPolicy.isSysComponentOrPersistentPlatformSignedPrivAppLPr</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#5-1-1-2-DPGrantPolicy-doesPackageSupportRuntimePermissions"><span class="toc-text">5.1.1.2 DPGrantPolicy.doesPackageSupportRuntimePermissions</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#5-1-2-DPGrantPolicy-grantDefaultSystemHandlerPermissions"><span class="toc-text">5.1.2 DPGrantPolicy.grantDefaultSystemHandlerPermissions</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#5-1-2-1-权限集合"><span class="toc-text">5.1.2.1 权限集合</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#5-1-2-2-Settings-onDefaultRuntimePermissionsGrantedLPr"><span class="toc-text">5.1.2.2 Settings.onDefaultRuntimePermissionsGrantedLPr</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#5-1-3-DPGrantPolicy-grantDefaultPermissionExceptions"><span class="toc-text">5.1.3 DPGrantPolicy.grantDefaultPermissionExceptions</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#5-1-3-1-DPGrantPolicy-readDefaultPermissionExceptionsLPw"><span class="toc-text">5.1.3.1 DPGrantPolicy.readDefaultPermissionExceptionsLPw</span></a><ol class="toc-child"><li class="toc-item toc-level-5"><a class="toc-link" href="#5-1-3-1-1-DPGrantPolicy-parse"><span class="toc-text">5.1.3.1.1 DPGrantPolicy.parse</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#5-1-3-1-2-DPGrantPolicy-parseExceptions"><span class="toc-text">5.1.3.1.2 DPGrantPolicy.parseExceptions</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#5-1-3-1-3-DPGrantPolicy-parsePermission"><span class="toc-text">5.1.3.1.3 DPGrantPolicy.parsePermission</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#5-1-3-1-4-new-DefaultPermissionGrant"><span class="toc-text">5.1.3.1.4 new DefaultPermissionGrant</span></a></li></ol></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#5-1-4-DPGrantPolicy-grantRuntimePermissionsLPw-默认授予核心方法"><span class="toc-text">5.1.4 DPGrantPolicy.grantRuntimePermissionsLPw - 默认授予核心方法</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#5-1-4-1-PackageManagerS-getPermissionFlags"><span class="toc-text">5.1.4.1 PackageManagerS.getPermissionFlags</span></a><ol class="toc-child"><li class="toc-item toc-level-5"><a class="toc-link" href="#5-1-4-1-1-PermissionsState-getPermissionFlags"><span class="toc-text">5.1.4.1.1 PermissionsState.getPermissionFlags</span></a></li></ol></li></ol></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#5-2-清除那些陈旧不用的用户和应用"><span class="toc-text">5.2 清除那些陈旧不用的用户和应用</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#5-2-1-PackageManagerService-reconcileUsers"><span class="toc-text">5.2.1 PackageManagerService.reconcileUsers</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#5-2-1-1-PackageManagerService-destroyUserDataLI"><span class="toc-text">5.2.1.1 PackageManagerService.destroyUserDataLI</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#5-2-2-PackageManagerService-reconcileApps"><span class="toc-text">5.2.2 PackageManagerService.reconcileApps</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#5-2-2-1-PackageManagerService-assertPackageKnown"><span class="toc-text">5.2.2.1 PackageManagerService.assertPackageKnown</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#5-2-2-2-PackageManagerService-removeCodePathLI"><span class="toc-text">5.2.2.2 PackageManagerService.removeCodePathLI</span></a></li></ol></li></ol></li></ol></li></ol></div></div><div class="author-info hide"><div class="author-info__avatar text-center"><img src="/img/avatar.png"></div><div class="author-info__name text-center">Coolqi.Li</div><div class="author-info__description text-center">“Hi，我是李帅奇，Android 开发工程师，TeamLeader，熬夜星人，一个努力赚钱，积极向上的好人。”</div><div class="follow-button"><a href="https://github.com/single-li">Follow Me</a></div><hr><div class="author-info-articles"><a class="author-info-articles__archives article-meta" href="/archives"><span class="pull-left">文章</span><span class="pull-right">85</span></a><a class="author-info-articles__tags article-meta" href="/tags"><span class="pull-left">标签</span><span class="pull-right">20</span></a><a class="author-info-articles__categories article-meta" href="/categories"><span class="pull-left">分类</span><span class="pull-right">24</span></a></div><hr><div class="author-info-links"><div class="author-info-links__title text-center">Links</div><a class="author-info-links__name text-center" href="https://developer.android.google.cn/">AndroidDeveloper</a><a class="author-info-links__name text-center" href="http://www.android-studio.org/">AndroidStudio</a><a class="author-info-links__name text-center" href="https://www.jianshu.com/u/123a20a96441">简书</a><a class="author-info-links__name text-center" href="https://weibo.com/coolqiLi">微博</a></div></div></div><div id="content-outer"><div id="top-container" style="background-image: url(https://ws1.sinaimg.cn/large/8700af19ly1fvpabr30o6j22yo1o0q7i.jpg)"><div id="page-header"><span class="pull-left"> <a id="site-name" href="/">Coolqi`s Blog</a></span><i class="fa fa-bars toggle-menu pull-right" aria-hidden="true"></i><span class="pull-right menus"><a class="site-page social-icon search"><i class="fa fa-search"></i><span> 搜索</span></a><a class="site-page" href="/">Home</a><a class="site-page" href="/categories">Categories</a><a class="site-page" href="/tags">Tags</a><a class="site-page" href="/archives">Archives</a><a class="site-page" href="/about">About</a></span></div><div id="post-info"><div id="post-title">PMS 第 6 篇 - PMS_READY 阶段</div><div id="post-meta"><time class="post-meta__date"><i class="fa fa-calendar" aria-hidden="true"></i> 2018-04-28</time><span class="post-meta__separator">|</span><i class="fa fa-inbox post-meta__icon" aria-hidden="true"></i><a class="post-meta__categories" href="/categories/AndroidFramework源码分析/">AndroidFramework源码分析</a><i class="fa fa-angle-right" aria-hidden="true"></i><i class="fa fa-inbox post-meta__icon" aria-hidden="true"></i><a class="post-meta__categories" href="/categories/AndroidFramework源码分析/PackageManager包管理/">PackageManager包管理</a><div class="post-meta-wordcount"><span>字数总计: </span><span class="word-count">13.6k</span><span class="post-meta__separator">|</span><span>阅读时长: 68 分钟</span></div></div></div></div><div class="layout" id="content-inner"><article id="post"><div class="article-container" id="post-content"><p>[toc]</p>
<p>基于 Android 7.1.1 源码分析 PackageManagerService 的架构和逻辑实现，本文是作者原创，转载请说明出处！</p>
<h1 id="0-综述"><a href="#0-综述" class="headerlink" title="0 综述"></a>0 综述</h1><p>最后我们会进入 PMS 初始化的最后阶段：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br></pre></td><td class="code"><pre><span class="line">        ... ... ... ...<span class="comment">// 第五阶段</span></span><br><span class="line">        EventLog.writeEvent(EventLogTags.BOOT_PROGRESS_PMS_READY,</span><br><span class="line">                SystemClock.uptimeMillis());</span><br><span class="line">        </span><br><span class="line">        <span class="comment">//【1】获得 PMS 需要一些包名，比如 PackageInstaller，IntentFilterVerifier 等等！</span></span><br><span class="line">        <span class="keyword">if</span> (!mOnlyCore) &#123;</span><br><span class="line">            mRequiredVerifierPackage = getRequiredButNotReallyRequiredVerifierLPr();</span><br><span class="line">            mRequiredInstallerPackage = getRequiredInstallerLPr();</span><br><span class="line">            mRequiredUninstallerPackage = getRequiredUninstallerLPr();</span><br><span class="line">            mIntentFilterVerifierComponent = getIntentFilterVerifierComponentNameLPr();</span><br><span class="line">            mIntentFilterVerifier = <span class="keyword">new</span> IntentVerifierProxy(mContext,</span><br><span class="line">                    mIntentFilterVerifierComponent);</span><br><span class="line">            mServicesSystemSharedLibraryPackageName = getRequiredSharedLibraryLPr(</span><br><span class="line">                    PackageManager.SYSTEM_SHARED_LIBRARY_SERVICES);</span><br><span class="line">            mSharedSystemSharedLibraryPackageName = getRequiredSharedLibraryLPr(</span><br><span class="line">                    PackageManager.SYSTEM_SHARED_LIBRARY_SHARED);</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            mRequiredVerifierPackage = <span class="keyword">null</span>;</span><br><span class="line">            mRequiredInstallerPackage = <span class="keyword">null</span>;</span><br><span class="line">            mRequiredUninstallerPackage = <span class="keyword">null</span>;</span><br><span class="line">            mIntentFilterVerifierComponent = <span class="keyword">null</span>;</span><br><span class="line">            mIntentFilterVerifier = <span class="keyword">null</span>;</span><br><span class="line">            mServicesSystemSharedLibraryPackageName = <span class="keyword">null</span>;</span><br><span class="line">            mSharedSystemSharedLibraryPackageName = <span class="keyword">null</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        </span><br><span class="line">        <span class="comment">//【2】建立 PackageInstallerService 服务对象，用于 package 的安装！</span></span><br><span class="line">        mInstallerService = <span class="keyword">new</span> PackageInstallerService(context, <span class="keyword">this</span>);</span><br><span class="line"></span><br><span class="line">        <span class="keyword">final</span> ComponentName ephemeralResolverComponent = getEphemeralResolverLPr();</span><br><span class="line">        <span class="keyword">final</span> ComponentName ephemeralInstallerComponent = getEphemeralInstallerLPr();</span><br><span class="line">        <span class="comment">// both the installer and resolver must be present to enable ephemeral</span></span><br><span class="line">        <span class="keyword">if</span> (ephemeralInstallerComponent != <span class="keyword">null</span> &amp;&amp; ephemeralResolverComponent != <span class="keyword">null</span>) &#123;</span><br><span class="line">            <span class="keyword">if</span> (DEBUG_EPHEMERAL) &#123;</span><br><span class="line">                Slog.i(TAG, <span class="string">"Ephemeral activated; resolver: "</span> + ephemeralResolverComponent</span><br><span class="line">                        + <span class="string">" installer:"</span> + ephemeralInstallerComponent);</span><br><span class="line">            &#125;</span><br><span class="line">            mEphemeralResolverComponent = ephemeralResolverComponent;</span><br><span class="line">            mEphemeralInstallerComponent = ephemeralInstallerComponent;</span><br><span class="line">            setUpEphemeralInstallerActivityLP(mEphemeralInstallerComponent);</span><br><span class="line">            mEphemeralResolverConnection =</span><br><span class="line">                    <span class="keyword">new</span> EphemeralResolverConnection(mContext, mEphemeralResolverComponent);</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            <span class="keyword">if</span> (DEBUG_EPHEMERAL) &#123;</span><br><span class="line">                <span class="keyword">final</span> String missingComponent =</span><br><span class="line">                        (ephemeralResolverComponent == <span class="keyword">null</span>)</span><br><span class="line">                        ? (ephemeralInstallerComponent == <span class="keyword">null</span>)</span><br><span class="line">                                ? <span class="string">"resolver and installer"</span></span><br><span class="line">                                : <span class="string">"resolver"</span></span><br><span class="line">                        : <span class="string">"installer"</span>;</span><br><span class="line">                Slog.i(TAG, <span class="string">"Ephemeral deactivated; missing "</span> + missingComponent);</span><br><span class="line">            &#125;</span><br><span class="line">            mEphemeralResolverComponent = <span class="keyword">null</span>;</span><br><span class="line">            mEphemeralInstallerComponent = <span class="keyword">null</span>;</span><br><span class="line">            mEphemeralResolverConnection = <span class="keyword">null</span>;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        mEphemeralApplicationRegistry = <span class="keyword">new</span> EphemeralApplicationRegistry(<span class="keyword">this</span>);</span><br><span class="line">    &#125; <span class="comment">// synchronized (mPackages)</span></span><br><span class="line">    &#125; <span class="comment">// synchronized (mInstallLock)</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">// 执行 GC 操作，回收系统资源！</span></span><br><span class="line">    Runtime.getRuntime().gc();</span><br><span class="line"></span><br><span class="line">    <span class="comment">// The initial scanning above does many calls into installd while</span></span><br><span class="line">    <span class="comment">// holding the mPackages lock, but we're mostly interested in yelling</span></span><br><span class="line">    <span class="comment">// once we have a booted system.</span></span><br><span class="line">    mInstaller.setWarnIfHeld(mPackages);</span><br><span class="line"></span><br><span class="line">    <span class="comment">//【3】将自身加入本地服务管理中，方便系统自身访问！</span></span><br><span class="line">    LocalServices.addService(PackageManagerInternal.class, <span class="keyword">new</span> PackageManagerInternalImpl());</span><br><span class="line">    </span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>这个阶段逻辑很简单，我们不多分析！</p>
<h1 id="1-获得一些-PMS-会用到的应用的包名"><a href="#1-获得一些-PMS-会用到的应用的包名" class="headerlink" title="1 获得一些 PMS 会用到的应用的包名"></a>1 获得一些 PMS 会用到的应用的包名</h1><h2 id="1-1-PackageMS-getRequiredButNotReallyRequiredVerifierLPr"><a href="#1-1-PackageMS-getRequiredButNotReallyRequiredVerifierLPr" class="headerlink" title="1.1 PackageMS.getRequiredButNotReallyRequiredVerifierLPr"></a>1.1 PackageMS.getRequiredButNotReallyRequiredVerifierLPr</h2><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">private</span> <span class="meta">@Nullable</span> <span class="function">String <span class="title">getRequiredButNotReallyRequiredVerifierLPr</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    <span class="comment">// android.intent.action.PACKAGE_NEEDS_VERIFICATION</span></span><br><span class="line">    <span class="keyword">final</span> Intent intent = <span class="keyword">new</span> Intent(Intent.ACTION_PACKAGE_NEEDS_VERIFICATION);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">final</span> List&lt;ResolveInfo&gt; matches = queryIntentReceiversInternal(intent, PACKAGE_MIME_TYPE,</span><br><span class="line">            MATCH_SYSTEM_ONLY | MATCH_DIRECT_BOOT_AWARE | MATCH_DIRECT_BOOT_UNAWARE,</span><br><span class="line">            UserHandle.USER_SYSTEM);</span><br><span class="line">    <span class="keyword">if</span> (matches.size() == <span class="number">1</span>) &#123;</span><br><span class="line">        <span class="keyword">return</span> matches.get(<span class="number">0</span>).getComponentInfo().packageName;</span><br><span class="line">    &#125; <span class="keyword">else</span> <span class="keyword">if</span> (matches.size() == <span class="number">0</span>) &#123;</span><br><span class="line">        Log.e(TAG, <span class="string">"There should probably be a verifier, but, none were found"</span>);</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">null</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">throw</span> <span class="keyword">new</span> RuntimeException(<span class="string">"There must be exactly one verifier; found "</span> + matches);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h2 id="1-2-PackageMS-getRequiredInstallerLPr"><a href="#1-2-PackageMS-getRequiredInstallerLPr" class="headerlink" title="1.2 PackageMS.getRequiredInstallerLPr"></a>1.2 PackageMS.getRequiredInstallerLPr</h2><p>获得 packageInstaller 的包名！<br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">private</span> <span class="meta">@NonNull</span> <span class="function">String <span class="title">getRequiredInstallerLPr</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    <span class="keyword">final</span> Intent intent = <span class="keyword">new</span> Intent(Intent.ACTION_INSTALL_PACKAGE);</span><br><span class="line">    intent.addCategory(Intent.CATEGORY_DEFAULT);</span><br><span class="line">    intent.setDataAndType(Uri.fromFile(<span class="keyword">new</span> File(<span class="string">"foo.apk"</span>)), PACKAGE_MIME_TYPE);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">final</span> List&lt;ResolveInfo&gt; matches = queryIntentActivitiesInternal(intent, PACKAGE_MIME_TYPE,</span><br><span class="line">            MATCH_SYSTEM_ONLY | MATCH_DIRECT_BOOT_AWARE | MATCH_DIRECT_BOOT_UNAWARE,</span><br><span class="line">            UserHandle.USER_SYSTEM);</span><br><span class="line">    <span class="keyword">if</span> (matches.size() == <span class="number">1</span>) &#123;</span><br><span class="line">        ResolveInfo resolveInfo = matches.get(<span class="number">0</span>);</span><br><span class="line">        <span class="keyword">if</span> (!resolveInfo.activityInfo.applicationInfo.isPrivilegedApp()) &#123;</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> RuntimeException(<span class="string">"The installer must be a privileged app"</span>);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> matches.get(<span class="number">0</span>).getComponentInfo().packageName;</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        <span class="keyword">throw</span> <span class="keyword">new</span> RuntimeException(<span class="string">"There must be exactly one installer; found "</span> + matches);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<h2 id="1-3-PackageMS-getRequiredUninstallerLPr"><a href="#1-3-PackageMS-getRequiredUninstallerLPr" class="headerlink" title="1.3 PackageMS.getRequiredUninstallerLPr"></a>1.3 PackageMS.getRequiredUninstallerLPr</h2><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">private</span> <span class="meta">@NonNull</span> <span class="function">String <span class="title">getRequiredUninstallerLPr</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    <span class="keyword">final</span> Intent intent = <span class="keyword">new</span> Intent(Intent.ACTION_UNINSTALL_PACKAGE);</span><br><span class="line">    intent.addCategory(Intent.CATEGORY_DEFAULT);</span><br><span class="line">    intent.setData(Uri.fromParts(PACKAGE_SCHEME, <span class="string">"foo.bar"</span>, <span class="keyword">null</span>));</span><br><span class="line"></span><br><span class="line">    <span class="keyword">final</span> ResolveInfo resolveInfo = resolveIntent(intent, <span class="keyword">null</span>,</span><br><span class="line">            MATCH_SYSTEM_ONLY | MATCH_DIRECT_BOOT_AWARE | MATCH_DIRECT_BOOT_UNAWARE,</span><br><span class="line">            UserHandle.USER_SYSTEM);</span><br><span class="line">    <span class="keyword">if</span> (resolveInfo == <span class="keyword">null</span> ||</span><br><span class="line">            mResolveActivity.name.equals(resolveInfo.getComponentInfo().name)) &#123;</span><br><span class="line">        <span class="keyword">throw</span> <span class="keyword">new</span> RuntimeException(<span class="string">"There must be exactly one uninstaller; found "</span></span><br><span class="line">                + resolveInfo);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> resolveInfo.getComponentInfo().packageName;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h2 id="1-4-PackageMS-getIntentFilterVerifierComponentNameLPr"><a href="#1-4-PackageMS-getIntentFilterVerifierComponentNameLPr" class="headerlink" title="1.4 PackageMS.getIntentFilterVerifierComponentNameLPr"></a>1.4 PackageMS.getIntentFilterVerifierComponentNameLPr</h2><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">private</span> <span class="meta">@NonNull</span> <span class="function">ComponentName <span class="title">getIntentFilterVerifierComponentNameLPr</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    <span class="keyword">final</span> Intent intent = <span class="keyword">new</span> Intent(Intent.ACTION_INTENT_FILTER_NEEDS_VERIFICATION);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">final</span> List&lt;ResolveInfo&gt; matches = queryIntentReceiversInternal(intent, PACKAGE_MIME_TYPE,</span><br><span class="line">            MATCH_SYSTEM_ONLY | MATCH_DIRECT_BOOT_AWARE | MATCH_DIRECT_BOOT_UNAWARE,</span><br><span class="line">            UserHandle.USER_SYSTEM);</span><br><span class="line">    ResolveInfo best = <span class="keyword">null</span>;</span><br><span class="line">    <span class="keyword">final</span> <span class="keyword">int</span> N = matches.size();</span><br><span class="line">    <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; N; i++) &#123;</span><br><span class="line">        <span class="keyword">final</span> ResolveInfo cur = matches.get(i);</span><br><span class="line">        <span class="keyword">final</span> String packageName = cur.getComponentInfo().packageName;</span><br><span class="line">        <span class="keyword">if</span> (checkPermission(android.Manifest.permission.INTENT_FILTER_VERIFICATION_AGENT,</span><br><span class="line">                packageName, UserHandle.USER_SYSTEM) != PackageManager.PERMISSION_GRANTED) &#123;</span><br><span class="line">            <span class="keyword">continue</span>;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (best == <span class="keyword">null</span> || cur.priority &gt; best.priority) &#123;</span><br><span class="line">            best = cur;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (best != <span class="keyword">null</span>) &#123;</span><br><span class="line">        <span class="keyword">return</span> best.getComponentInfo().getComponentName();</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        <span class="keyword">throw</span> <span class="keyword">new</span> RuntimeException(<span class="string">"There must be at least one intent filter verifier"</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h2 id="1-5-PackageMS-getRequiredSharedLibraryLPr"><a href="#1-5-PackageMS-getRequiredSharedLibraryLPr" class="headerlink" title="1.5 PackageMS.getRequiredSharedLibraryLPr"></a>1.5 PackageMS.getRequiredSharedLibraryLPr</h2><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * This is a library that contains components apps can invoke. For</span></span><br><span class="line"><span class="comment"> * example, a services for apps to bind to, or standard chooser UI,</span></span><br><span class="line"><span class="comment"> * etc. This library is versioned and backwards compatible. Clients</span></span><br><span class="line"><span class="comment"> * should check its version via &#123;<span class="doctag">@link</span> android.ext.services.Version</span></span><br><span class="line"><span class="comment"> * #getVersionCode()&#125; and avoid calling APIs added in later versions.</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@hide</span></span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> String SYSTEM_SHARED_LIBRARY_SERVICES = <span class="string">"android.ext.services"</span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * This is a library that contains components apps can dynamically</span></span><br><span class="line"><span class="comment"> * load. For example, new widgets, helper classes, etc. This library</span></span><br><span class="line"><span class="comment"> * is versioned and backwards compatible. Clients should check its</span></span><br><span class="line"><span class="comment"> * version via &#123;<span class="doctag">@link</span> android.ext.shared.Version#getVersionCode()&#125;</span></span><br><span class="line"><span class="comment"> * and avoid calling APIs added in later versions.</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@hide</span></span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> String SYSTEM_SHARED_LIBRARY_SHARED = <span class="string">"android.ext.shared"</span>;</span><br></pre></td></tr></table></figure>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">    mServicesSystemSharedLibraryPackageName = getRequiredSharedLibraryLPr(</span><br><span class="line">            PackageManager.SYSTEM_SHARED_LIBRARY_SERVICES);</span><br><span class="line">    mSharedSystemSharedLibraryPackageName = getRequiredSharedLibraryLPr(</span><br><span class="line">            PackageManager.SYSTEM_SHARED_LIBRARY_SHARED);</span><br><span class="line">```                        </span><br><span class="line">```java</span><br><span class="line">    <span class="keyword">private</span> <span class="meta">@NonNull</span> <span class="function">String <span class="title">getRequiredSharedLibraryLPr</span><span class="params">(String libraryName)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">synchronized</span> (mPackages) &#123;</span><br><span class="line">            SharedLibraryEntry libraryEntry = mSharedLibraries.get(libraryName);</span><br><span class="line">            <span class="keyword">if</span> (libraryEntry == <span class="keyword">null</span>) &#123;</span><br><span class="line">                <span class="keyword">throw</span> <span class="keyword">new</span> IllegalStateException(<span class="string">"Missing required shared library:"</span> + libraryName);</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">return</span> libraryEntry.apk;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure>
<h1 id="2-new-PackageInstallerService-创建安装服务对象"><a href="#2-new-PackageInstallerService-创建安装服务对象" class="headerlink" title="2 new PackageInstallerService - 创建安装服务对象"></a>2 new PackageInstallerService - 创建安装服务对象</h1><p>创建 PackageInstallerService 服务对象，用于应用的安装，关于安装，这个我们先不关注！ </p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="title">PackageInstallerService</span><span class="params">(Context context, PackageManagerService pm)</span> </span>&#123;</span><br><span class="line">    mContext = context;</span><br><span class="line">    mPm = pm; <span class="comment">// pms 的应用！</span></span><br><span class="line"></span><br><span class="line">    mInstallThread = <span class="keyword">new</span> HandlerThread(TAG); <span class="comment">// 一个线程，用于处理 install 操作！</span></span><br><span class="line">    mInstallThread.start();</span><br><span class="line"></span><br><span class="line">    mInstallHandler = <span class="keyword">new</span> Handler(mInstallThread.getLooper()); <span class="comment">// 该线程的 Handler！</span></span><br><span class="line">    <span class="comment">//【2.1】创建了一个 Callbacks 回调对象，用于处理事务的变化，通知需要监听事务变化的远程对象！</span></span><br><span class="line">    mCallbacks = <span class="keyword">new</span> Callbacks(mInstallThread.getLooper());</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 用于保存安装事务项的文件对象！</span></span><br><span class="line">    mSessionsFile = <span class="keyword">new</span> AtomicFile(</span><br><span class="line">            <span class="keyword">new</span> File(Environment.getDataSystemDirectory(), <span class="string">"install_sessions.xml"</span>));</span><br><span class="line">    mSessionsDir = <span class="keyword">new</span> File(Environment.getDataSystemDirectory(), <span class="string">"install_sessions"</span>);</span><br><span class="line">    mSessionsDir.mkdirs();</span><br><span class="line"></span><br><span class="line">    <span class="keyword">synchronized</span> (mSessions) &#123;</span><br><span class="line">        <span class="comment">//【2.2】读取安装事务！</span></span><br><span class="line">        readSessionsLocked();</span><br><span class="line"></span><br><span class="line">        reconcileStagesLocked(StorageManager.UUID_PRIVATE_INTERNAL, <span class="keyword">false</span> <span class="comment">/*isEphemeral*/</span>);</span><br><span class="line">        reconcileStagesLocked(StorageManager.UUID_PRIVATE_INTERNAL, <span class="keyword">true</span> <span class="comment">/*isEphemeral*/</span>);</span><br><span class="line"></span><br><span class="line">        <span class="keyword">final</span> ArraySet&lt;File&gt; unclaimedIcons = newArraySet(</span><br><span class="line">                mSessionsDir.listFiles());</span><br><span class="line"></span><br><span class="line">        <span class="comment">// Ignore stages and icons claimed by active sessions</span></span><br><span class="line">        <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; mSessions.size(); i++) &#123;</span><br><span class="line">            <span class="keyword">final</span> PackageInstallerSession session = mSessions.valueAt(i);</span><br><span class="line">            unclaimedIcons.remove(buildAppIconFile(session.sessionId));</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// Clean up orphaned icons</span></span><br><span class="line">        <span class="keyword">for</span> (File icon : unclaimedIcons) &#123;</span><br><span class="line">            Slog.w(TAG, <span class="string">"Deleting orphan icon "</span> + icon);</span><br><span class="line">            icon.delete();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>在 PackageInstallerService 有如下的集合，来保存安装事务！<br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 所有的事务，有效和无效的</span></span><br><span class="line"><span class="meta">@GuardedBy</span>(<span class="string">"mSessions"</span>)</span><br><span class="line"><span class="keyword">private</span> <span class="keyword">final</span> SparseBooleanArray mAllocatedSessions = <span class="keyword">new</span> SparseBooleanArray();</span><br><span class="line"></span><br><span class="line"><span class="comment">// 用于保存那些有效的安装事务！</span></span><br><span class="line"><span class="meta">@GuardedBy</span>(<span class="string">"mSessions"</span>)</span><br><span class="line"><span class="keyword">private</span> <span class="keyword">final</span> SparseArray&lt;PackageInstallerSession&gt; mSessions = <span class="keyword">new</span> SparseArray&lt;&gt;();</span><br><span class="line"></span><br><span class="line"><span class="comment">// 用于保存那些无效的历史事务！</span></span><br><span class="line"><span class="meta">@GuardedBy</span>(<span class="string">"mSessions"</span>)</span><br><span class="line"><span class="keyword">private</span> <span class="keyword">final</span> SparseArray&lt;PackageInstallerSession&gt; mHistoricalSessions = <span class="keyword">new</span> SparseArray&lt;&gt;();</span><br></pre></td></tr></table></figure></p>
<p>在创建 PackageInstallerService 的时候会调用 readSessionsLocked 读取重启之前的所有安装事务！</p>
<h2 id="2-1-new-Callback"><a href="#2-1-new-Callback" class="headerlink" title="2.1 new Callback"></a>2.1 new Callback</h2><p>Callback 本质上也是一个 Handler 对象，其 Looper 对象来自 mInstallThread.getLooper()，用于处理耗时操作：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">private</span> <span class="keyword">static</span> <span class="class"><span class="keyword">class</span> <span class="title">Callbacks</span> <span class="keyword">extends</span> <span class="title">Handler</span> </span>&#123;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="title">Callbacks</span><span class="params">(Looper looper)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">super</span>(looper);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>Callback 用于处理和 session 相关的消息：<br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="keyword">int</span> MSG_SESSION_CREATED = <span class="number">1</span>;</span><br><span class="line"><span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="keyword">int</span> MSG_SESSION_BADGING_CHANGED = <span class="number">2</span>;</span><br><span class="line"><span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="keyword">int</span> MSG_SESSION_ACTIVE_CHANGED = <span class="number">3</span>;</span><br><span class="line"><span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="keyword">int</span> MSG_SESSION_PROGRESS_CHANGED = <span class="number">4</span>;</span><br><span class="line"><span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="keyword">int</span> MSG_SESSION_FINISHED = <span class="number">5</span>;</span><br></pre></td></tr></table></figure></p>
<p>本质上讲，Callback 只是这些消息的中转站，它会将消息发送给注册到其内部的远程回调接口：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">private</span> <span class="keyword">final</span> RemoteCallbackList&lt;IPackageInstallerCallback&gt;</span><br><span class="line">        mCallbacks = <span class="keyword">new</span> RemoteCallbackList&lt;&gt;();</span><br></pre></td></tr></table></figure>
<p>CallBack 内部提供了注册相关的接口：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">register</span><span class="params">(IPackageInstallerCallback callback, <span class="keyword">int</span> userId)</span> </span>&#123;</span><br><span class="line">    mCallbacks.register(callback, <span class="keyword">new</span> UserHandle(userId));</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">unregister</span><span class="params">(IPackageInstallerCallback callback)</span> </span>&#123;</span><br><span class="line">    mCallbacks.unregister(callback);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>我们来看下，其实如何处理回调的，当有 Session 发生变化后，下面的接口会被触发调用！<br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">notifySessionCreated</span><span class="params">(<span class="keyword">int</span> sessionId, <span class="keyword">int</span> userId)</span> </span>&#123;</span><br><span class="line">    obtainMessage(MSG_SESSION_CREATED, sessionId, userId).sendToTarget();</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">notifySessionBadgingChanged</span><span class="params">(<span class="keyword">int</span> sessionId, <span class="keyword">int</span> userId)</span> </span>&#123;</span><br><span class="line">    obtainMessage(MSG_SESSION_BADGING_CHANGED, sessionId, userId).sendToTarget();</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">notifySessionActiveChanged</span><span class="params">(<span class="keyword">int</span> sessionId, <span class="keyword">int</span> userId, <span class="keyword">boolean</span> active)</span> </span>&#123;</span><br><span class="line">    obtainMessage(MSG_SESSION_ACTIVE_CHANGED, sessionId, userId, active).sendToTarget();</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">notifySessionProgressChanged</span><span class="params">(<span class="keyword">int</span> sessionId, <span class="keyword">int</span> userId, <span class="keyword">float</span> progress)</span> </span>&#123;</span><br><span class="line">    obtainMessage(MSG_SESSION_PROGRESS_CHANGED, sessionId, userId, progress).sendToTarget();</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">notifySessionFinished</span><span class="params">(<span class="keyword">int</span> sessionId, <span class="keyword">int</span> userId, <span class="keyword">boolean</span> success)</span> </span>&#123;</span><br><span class="line">    obtainMessage(MSG_SESSION_FINISHED, sessionId, userId, success).sendToTarget();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>这些接口会发送消息，处理仍然是在 CallBack 中：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">handleMessage</span><span class="params">(Message msg)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">final</span> <span class="keyword">int</span> userId = msg.arg2;</span><br><span class="line">    <span class="keyword">final</span> <span class="keyword">int</span> n = mCallbacks.beginBroadcast();</span><br><span class="line">    <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; n; i++) &#123;</span><br><span class="line">        <span class="keyword">final</span> IPackageInstallerCallback callback = mCallbacks.getBroadcastItem(i);</span><br><span class="line">        <span class="keyword">final</span> UserHandle user = (UserHandle) mCallbacks.getBroadcastCookie(i);</span><br><span class="line">        <span class="comment">// <span class="doctag">TODO:</span> dispatch notifications for slave profiles</span></span><br><span class="line">        <span class="keyword">if</span> (userId == user.getIdentifier()) &#123;</span><br><span class="line">            <span class="keyword">try</span> &#123;</span><br><span class="line">                <span class="comment">// 调用 invokeCallback 分发 session 变化的消息！</span></span><br><span class="line">                invokeCallback(callback, msg);</span><br><span class="line">            &#125; <span class="keyword">catch</span> (RemoteException ignored) &#123;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    mCallbacks.finishBroadcast();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>invokeCallback 方法将 session 变化的消息会转发给所有注册到其内部的远程回调接口！<br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">invokeCallback</span><span class="params">(IPackageInstallerCallback callback, Message msg)</span></span></span><br><span class="line"><span class="function">        <span class="keyword">throws</span> RemoteException </span>&#123;</span><br><span class="line">    <span class="keyword">final</span> <span class="keyword">int</span> sessionId = msg.arg1;</span><br><span class="line">    <span class="keyword">switch</span> (msg.what) &#123;</span><br><span class="line">        <span class="keyword">case</span> MSG_SESSION_CREATED:</span><br><span class="line">            callback.onSessionCreated(sessionId);</span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line">        <span class="keyword">case</span> MSG_SESSION_BADGING_CHANGED:</span><br><span class="line">            callback.onSessionBadgingChanged(sessionId);</span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line">        <span class="keyword">case</span> MSG_SESSION_ACTIVE_CHANGED:</span><br><span class="line">            callback.onSessionActiveChanged(sessionId, (<span class="keyword">boolean</span>) msg.obj);</span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line">        <span class="keyword">case</span> MSG_SESSION_PROGRESS_CHANGED:</span><br><span class="line">            callback.onSessionProgressChanged(sessionId, (<span class="keyword">float</span>) msg.obj);</span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line">        <span class="keyword">case</span> MSG_SESSION_FINISHED:</span><br><span class="line">            callback.onSessionFinished(sessionId, (<span class="keyword">boolean</span>) msg.obj);</span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<h2 id="2-2-PackageInstallerService-readSessionsLocked-0"><a href="#2-2-PackageInstallerService-readSessionsLocked-0" class="headerlink" title="2.2 PackageInstallerService.readSessionsLocked[0]"></a>2.2 PackageInstallerService.readSessionsLocked[0]</h2><p>readSessionsLocked 用来读取事务！<br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">readSessionsLocked</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    <span class="keyword">if</span> (LOGD) Slog.v(TAG, <span class="string">"readSessionsLocked()"</span>);</span><br><span class="line"></span><br><span class="line">    mSessions.clear();</span><br><span class="line"></span><br><span class="line">    FileInputStream fis = <span class="keyword">null</span>;</span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">        fis = mSessionsFile.openRead();</span><br><span class="line">        <span class="keyword">final</span> XmlPullParser in = Xml.newPullParser();</span><br><span class="line">        in.setInput(fis, StandardCharsets.UTF_8.name());</span><br><span class="line"></span><br><span class="line">        <span class="keyword">int</span> type;</span><br><span class="line">        <span class="keyword">while</span> ((type = in.next()) != END_DOCUMENT) &#123;</span><br><span class="line">            <span class="keyword">if</span> (type == START_TAG) &#123;</span><br><span class="line">                <span class="keyword">final</span> String tag = in.getName();</span><br><span class="line">                <span class="keyword">if</span> (TAG_SESSION.equals(tag)) &#123; <span class="comment">// session 标签，用户封装指定的安装事务！</span></span><br><span class="line">                    <span class="comment">//【2.2】读取安装事务，返回 PackageInstallerSession 对象！</span></span><br><span class="line">                    <span class="keyword">final</span> PackageInstallerSession session = readSessionLocked(in);</span><br><span class="line"></span><br><span class="line">                    <span class="comment">// 计算事务的有效性！</span></span><br><span class="line">                    <span class="keyword">final</span> <span class="keyword">long</span> age = System.currentTimeMillis() - session.createdMillis;</span><br><span class="line">                    <span class="keyword">final</span> <span class="keyword">boolean</span> valid;</span><br><span class="line">                    <span class="comment">// 如果大于 MAX_AGE_MILLIS 3 天，那就是无效的，否则是有效的！</span></span><br><span class="line">                    <span class="keyword">if</span> (age &gt;= MAX_AGE_MILLIS) &#123;</span><br><span class="line">                        Slog.w(TAG, <span class="string">"Abandoning old session first created at "</span></span><br><span class="line">                                + session.createdMillis);</span><br><span class="line">                        valid = <span class="keyword">false</span>;</span><br><span class="line">                    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                        valid = <span class="keyword">true</span>;</span><br><span class="line">                    &#125;</span><br><span class="line"></span><br><span class="line">                    <span class="keyword">if</span> (valid) &#123;</span><br><span class="line">                        <span class="comment">// 有效的事务</span></span><br><span class="line">                        mSessions.put(session.sessionId, session);</span><br><span class="line">                    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                        <span class="comment">// 无效的事务，用于 debug，比如 dumpsys 等等！</span></span><br><span class="line">                        mHistoricalSessions.put(session.sessionId, session);</span><br><span class="line">                    &#125;</span><br><span class="line">                    <span class="comment">// 所有的事务！</span></span><br><span class="line">                    mAllocatedSessions.put(session.sessionId, <span class="keyword">true</span>);</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125; <span class="keyword">catch</span> (FileNotFoundException e) &#123;</span><br><span class="line">        <span class="comment">// Missing sessions are okay, probably first boot</span></span><br><span class="line">    &#125; <span class="keyword">catch</span> (IOException | XmlPullParserException e) &#123;</span><br><span class="line">        Slog.wtf(TAG, <span class="string">"Failed reading install sessions"</span>, e);</span><br><span class="line">    &#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">        IoUtils.closeQuietly(fis);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>判断一个事务是否有效的依据是，其实是否是在 3 天时间间隔之前创建的！<br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="keyword">long</span> MAX_AGE_MILLIS = <span class="number">3</span> * DateUtils.DAY_IN_MILLIS;</span><br></pre></td></tr></table></figure></p>
<h3 id="2-2-1-PackageInstallerService-readSessionsLocked-1"><a href="#2-2-1-PackageInstallerService-readSessionsLocked-1" class="headerlink" title="2.2.1 PackageInstallerService.readSessionsLocked[1]"></a>2.2.1 PackageInstallerService.readSessionsLocked[1]</h3><p>我们看下解析单个事务的具体过程！</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">private</span> PackageInstallerSession <span class="title">readSessionLocked</span><span class="params">(XmlPullParser in)</span> <span class="keyword">throws</span> IOException,</span></span><br><span class="line"><span class="function">        XmlPullParserException </span>&#123;</span><br><span class="line">    <span class="keyword">final</span> <span class="keyword">int</span> sessionId = readIntAttribute(in, ATTR_SESSION_ID); <span class="comment">// sessionId 属性</span></span><br><span class="line">    <span class="keyword">final</span> <span class="keyword">int</span> userId = readIntAttribute(in, ATTR_USER_ID); <span class="comment">// userId 属性 </span></span><br><span class="line">    <span class="keyword">final</span> String installerPackageName = readStringAttribute(in, ATTR_INSTALLER_PACKAGE_NAME); <span class="comment">// installerPackageName 属性</span></span><br><span class="line">    <span class="keyword">final</span> <span class="keyword">int</span> installerUid = readIntAttribute(in, ATTR_INSTALLER_UID, mPm.getPackageUid(</span><br><span class="line">            installerPackageName, PackageManager.MATCH_UNINSTALLED_PACKAGES, userId)); <span class="comment">// installerUid 属性</span></span><br><span class="line">    <span class="keyword">final</span> <span class="keyword">long</span> createdMillis = readLongAttribute(in, ATTR_CREATED_MILLIS); <span class="comment">// createdMillis 属性</span></span><br><span class="line">    <span class="keyword">final</span> String stageDirRaw = readStringAttribute(in, ATTR_SESSION_STAGE_DIR); <span class="comment">// sessionStageDir 属性</span></span><br><span class="line">    <span class="keyword">final</span> File stageDir = (stageDirRaw != <span class="keyword">null</span>) ? <span class="keyword">new</span> File(stageDirRaw) : <span class="keyword">null</span>; </span><br><span class="line">    <span class="keyword">final</span> String stageCid = readStringAttribute(in, ATTR_SESSION_STAGE_CID); <span class="comment">// sessionStageCid 属性</span></span><br><span class="line">    <span class="keyword">final</span> <span class="keyword">boolean</span> prepared = readBooleanAttribute(in, ATTR_PREPARED, <span class="keyword">true</span>); <span class="comment">// prepared 属性</span></span><br><span class="line">    <span class="keyword">final</span> <span class="keyword">boolean</span> sealed = readBooleanAttribute(in, ATTR_SEALED); <span class="comment">// sealed 属性</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">//【2.2.1】创建了一个 SessionParams 对象，封装事务详细参数</span></span><br><span class="line">    <span class="keyword">final</span> SessionParams params = <span class="keyword">new</span> SessionParams(</span><br><span class="line">            SessionParams.MODE_INVALID);</span><br><span class="line">    params.mode = readIntAttribute(in, ATTR_MODE); <span class="comment">// mode 属性</span></span><br><span class="line">    params.installFlags = readIntAttribute(in, ATTR_INSTALL_FLAGS); <span class="comment">// installFlags 属性</span></span><br><span class="line">    params.installLocation = readIntAttribute(in, ATTR_INSTALL_LOCATION); <span class="comment">// installLocation 属性</span></span><br><span class="line">    params.sizeBytes = readLongAttribute(in, ATTR_SIZE_BYTES); <span class="comment">// sizeBytes 属性</span></span><br><span class="line">    params.appPackageName = readStringAttribute(in, ATTR_APP_PACKAGE_NAME); <span class="comment">// appPackageName 属性</span></span><br><span class="line">    params.appIcon = readBitmapAttribute(in, ATTR_APP_ICON); <span class="comment">// appIcon 属性</span></span><br><span class="line">    params.appLabel = readStringAttribute(in, ATTR_APP_LABEL); <span class="comment">// appLabel 属性</span></span><br><span class="line">    params.originatingUri = readUriAttribute(in, ATTR_ORIGINATING_URI); <span class="comment">// originatingUri 属性</span></span><br><span class="line">    params.originatingUid =</span><br><span class="line">            readIntAttribute(in, ATTR_ORIGINATING_UID, SessionParams.UID_UNKNOWN); <span class="comment">// originatingUid 属性</span></span><br><span class="line">    params.referrerUri = readUriAttribute(in, ATTR_REFERRER_URI); <span class="comment">// referrerUri 属性</span></span><br><span class="line">    params.abiOverride = readStringAttribute(in, ATTR_ABI_OVERRIDE); <span class="comment">// abiOverride 属性</span></span><br><span class="line">    params.volumeUuid = readStringAttribute(in, ATTR_VOLUME_UUID); <span class="comment">// volumeUuid 属性</span></span><br><span class="line">    <span class="comment">//【2.2.2】读取授予的运行时权限！</span></span><br><span class="line">    params.grantedRuntimePermissions = readGrantedRuntimePermissions(in);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">final</span> File appIconFile = buildAppIconFile(sessionId);</span><br><span class="line">    <span class="keyword">if</span> (appIconFile.exists()) &#123;</span><br><span class="line">        params.appIcon = BitmapFactory.decodeFile(appIconFile.getAbsolutePath());</span><br><span class="line">        params.appIconLastModified = appIconFile.lastModified();</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">//【2.2.3】创建事务对象 PackageInstallerSession！</span></span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">new</span> PackageInstallerSession(mInternalCallback, mContext, mPm,</span><br><span class="line">            mInstallThread.getLooper(), sessionId, userId, installerPackageName, installerUid,</span><br><span class="line">            params, createdMillis, stageDir, stageCid, prepared, sealed);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>方法步骤：</p>
<ul>
<li>解析 xml；</li>
<li>创建事务对象 PackageInstallerSession；</li>
</ul>
<h4 id="2-2-1-1-new-SessionParams"><a href="#2-2-1-1-new-SessionParams" class="headerlink" title="2.2.1.1 new SessionParams"></a>2.2.1.1 new SessionParams</h4><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="title">SessionParams</span><span class="params">(<span class="keyword">int</span> mode)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">this</span>.mode = mode;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>创建了一个 SessionParams，用于封装事务参数！</p>
<h4 id="2-2-1-2-PackageInstallerService-readGrantedRuntimePermissions"><a href="#2-2-1-2-PackageInstallerService-readGrantedRuntimePermissions" class="headerlink" title="2.2.1.2 PackageInstallerService.readGrantedRuntimePermissions"></a>2.2.1.2 PackageInstallerService.readGrantedRuntimePermissions</h4><p>readGrantedRuntimePermissions 方法会读取授予的运行时权限！<br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">private</span> <span class="keyword">static</span> String[] readGrantedRuntimePermissions(XmlPullParser in)</span><br><span class="line">        <span class="keyword">throws</span> IOException, XmlPullParserException &#123;</span><br><span class="line">    List&lt;String&gt; permissions = <span class="keyword">null</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">final</span> <span class="keyword">int</span> outerDepth = in.getDepth();</span><br><span class="line">    <span class="keyword">int</span> type;</span><br><span class="line">    <span class="keyword">while</span> ((type = in.next()) != XmlPullParser.END_DOCUMENT</span><br><span class="line">            &amp;&amp; (type != XmlPullParser.END_TAG || in.getDepth() &gt; outerDepth)) &#123;</span><br><span class="line">        <span class="keyword">if</span> (type == XmlPullParser.END_TAG || type == XmlPullParser.TEXT) &#123;</span><br><span class="line">            <span class="keyword">continue</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">if</span> (TAG_GRANTED_RUNTIME_PERMISSION.equals(in.getName())) &#123; <span class="comment">// 读取 granted-runtime-permission 子标签！</span></span><br><span class="line">            String permission = readStringAttribute(in, ATTR_NAME); <span class="comment">// 读取 name 属性，即运行时权限名</span></span><br><span class="line">            <span class="keyword">if</span> (permissions == <span class="keyword">null</span>) &#123;</span><br><span class="line">                permissions = <span class="keyword">new</span> ArrayList&lt;&gt;();</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="comment">// 将权限名保存到 permissions，并返回！！</span></span><br><span class="line">            permissions.add(permission);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (permissions == <span class="keyword">null</span>) &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">null</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    String[] permissionsArray = <span class="keyword">new</span> String[permissions.size()];</span><br><span class="line">    permissions.toArray(permissionsArray);</span><br><span class="line">    <span class="keyword">return</span> permissionsArray;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>方法很简单，这就不多说了！</p>
<h4 id="2-2-1-3-new-PackageInstallerSession"><a href="#2-2-1-3-new-PackageInstallerSession" class="headerlink" title="2.2.1.3 new PackageInstallerSession"></a>2.2.1.3 new PackageInstallerSession</h4><p>创建一个 PackageInstallerSession，参数来自前面的解析！<br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="title">PackageInstallerSession</span><span class="params">(PackageInstallerService.InternalCallback callback,</span></span></span><br><span class="line"><span class="function"><span class="params">        Context context, PackageManagerService pm, Looper looper, <span class="keyword">int</span> sessionId, <span class="keyword">int</span> userId,</span></span></span><br><span class="line"><span class="function"><span class="params">        String installerPackageName, <span class="keyword">int</span> installerUid, SessionParams params, <span class="keyword">long</span> createdMillis,</span></span></span><br><span class="line"><span class="function"><span class="params">        File stageDir, String stageCid, <span class="keyword">boolean</span> prepared, <span class="keyword">boolean</span> sealed)</span> </span>&#123;</span><br><span class="line">    mCallback = callback; <span class="comment">// InternalCallback 对象，用于监听和相应 session 的变化！！</span></span><br><span class="line">    mContext = context;</span><br><span class="line">    mPm = pm;</span><br><span class="line">    mHandler = <span class="keyword">new</span> Handler(looper, mHandlerCallback);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">this</span>.sessionId = sessionId;</span><br><span class="line">    <span class="keyword">this</span>.userId = userId;</span><br><span class="line">    <span class="keyword">this</span>.installerPackageName = installerPackageName;</span><br><span class="line">    <span class="keyword">this</span>.installerUid = installerUid;</span><br><span class="line">    <span class="keyword">this</span>.params = params;</span><br><span class="line">    <span class="keyword">this</span>.createdMillis = createdMillis;</span><br><span class="line">    <span class="keyword">this</span>.stageDir = stageDir;</span><br><span class="line">    <span class="keyword">this</span>.stageCid = stageCid;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> ((stageDir == <span class="keyword">null</span>) == (stageCid == <span class="keyword">null</span>)) &#123;</span><br><span class="line">        <span class="keyword">throw</span> <span class="keyword">new</span> IllegalArgumentException(</span><br><span class="line">                <span class="string">"Exactly one of stageDir or stageCid stage must be set"</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    mPrepared = prepared;</span><br><span class="line">    mSealed = sealed;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// Device owners are allowed to silently install packages, so the permission check is</span></span><br><span class="line">    <span class="comment">// waived if the installer is the device owner.</span></span><br><span class="line">    DevicePolicyManager dpm = (DevicePolicyManager) mContext.getSystemService(</span><br><span class="line">            Context.DEVICE_POLICY_SERVICE);</span><br><span class="line">    <span class="keyword">final</span> <span class="keyword">boolean</span> isPermissionGranted =</span><br><span class="line">            (mPm.checkUidPermission(android.Manifest.permission.INSTALL_PACKAGES, installerUid)</span><br><span class="line">                    == PackageManager.PERMISSION_GRANTED);</span><br><span class="line">    <span class="keyword">final</span> <span class="keyword">boolean</span> isInstallerRoot = (installerUid == Process.ROOT_UID); <span class="comment">// 安装者是否是 root 级别！</span></span><br><span class="line">    <span class="keyword">final</span> <span class="keyword">boolean</span> forcePermissionPrompt =</span><br><span class="line">            (params.installFlags &amp; PackageManager.INSTALL_FORCE_PERMISSION_PROMPT) != <span class="number">0</span>;</span><br><span class="line">    mIsInstallerDeviceOwner = (dpm != <span class="keyword">null</span>) &amp;&amp; dpm.isDeviceOwnerAppOnCallingUser(</span><br><span class="line">            installerPackageName);</span><br><span class="line">    <span class="keyword">if</span> ((isPermissionGranted</span><br><span class="line">                    || isInstallerRoot</span><br><span class="line">                    || mIsInstallerDeviceOwner)</span><br><span class="line">            &amp;&amp; !forcePermissionPrompt) &#123;</span><br><span class="line">        mPermissionsAccepted = <span class="keyword">true</span>;</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        mPermissionsAccepted = <span class="keyword">false</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">final</span> <span class="keyword">long</span> identity = Binder.clearCallingIdentity();</span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">        <span class="keyword">final</span> <span class="keyword">int</span> uid = mPm.getPackageUid(PackageManagerService.DEFAULT_CONTAINER_PACKAGE,</span><br><span class="line">                PackageManager.MATCH_SYSTEM_ONLY, UserHandle.USER_SYSTEM);</span><br><span class="line">        defaultContainerGid = UserHandle.getSharedAppGid(uid);</span><br><span class="line">    &#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">        Binder.restoreCallingIdentity(identity);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>在创建 PackageInstallerSession 的时候，我们传入了一个 mInternalCallback，他是 PackageInstallerService 的成员变量：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">private</span> <span class="keyword">final</span> InternalCallback mInternalCallback = <span class="keyword">new</span> InternalCallback();</span><br></pre></td></tr></table></figure>
<p>这个接口用于监听和相应 Sessions 的变化，当 Sessions 发生变化后，会通过该接口，将相应的消息抓发给 Callback，Callback 会将消息再次转发给远程回调接口！<br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">InternalCallback</span> </span>&#123;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onSessionBadgingChanged</span><span class="params">(PackageInstallerSession session)</span> </span>&#123;</span><br><span class="line">        mCallbacks.notifySessionBadgingChanged(session.sessionId, session.userId);</span><br><span class="line">        writeSessionsAsync();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onSessionActiveChanged</span><span class="params">(PackageInstallerSession session, <span class="keyword">boolean</span> active)</span> </span>&#123;</span><br><span class="line">        mCallbacks.notifySessionActiveChanged(session.sessionId, session.userId, active);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 安装事务的进度发生变化！</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onSessionProgressChanged</span><span class="params">(PackageInstallerSession session, <span class="keyword">float</span> progress)</span> </span>&#123;</span><br><span class="line">        mCallbacks.notifySessionProgressChanged(session.sessionId, session.userId, progress);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 处理事务完成的消息！</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onSessionFinished</span><span class="params">(<span class="keyword">final</span> PackageInstallerSession session, <span class="keyword">boolean</span> success)</span> </span>&#123;</span><br><span class="line">        mCallbacks.notifySessionFinished(session.sessionId, session.userId, success);</span><br><span class="line"></span><br><span class="line">        mInstallHandler.post(<span class="keyword">new</span> Runnable() &#123;</span><br><span class="line">            <span class="meta">@Override</span></span><br><span class="line">            <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">run</span><span class="params">()</span> </span>&#123;</span><br><span class="line">                <span class="keyword">synchronized</span> (mSessions) &#123;</span><br><span class="line">                    <span class="comment">// 将已经完成的消息移除 mSessions，加入到 mHistoricalSessions 中！</span></span><br><span class="line">                    mSessions.remove(session.sessionId);</span><br><span class="line">                    mHistoricalSessions.put(session.sessionId, session);</span><br><span class="line"></span><br><span class="line">                    <span class="keyword">final</span> File appIconFile = buildAppIconFile(session.sessionId);</span><br><span class="line">                    <span class="keyword">if</span> (appIconFile.exists()) &#123;</span><br><span class="line">                        appIconFile.delete();</span><br><span class="line">                    &#125;</span><br><span class="line"></span><br><span class="line">                    writeSessionsLocked(); <span class="comment">// 更新 sessions 变化到本地文件中！</span></span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;);</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onSessionPrepared</span><span class="params">(PackageInstallerSession session)</span> </span>&#123;</span><br><span class="line">        <span class="comment">// We prepared the destination to write into; we want to persist</span></span><br><span class="line">        <span class="comment">// this, but it's not critical enough to block for.</span></span><br><span class="line">        writeSessionsAsync(); <span class="comment">// 将 sessions 数据写到本地文件中！</span></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onSessionSealedBlocking</span><span class="params">(PackageInstallerSession session)</span> </span>&#123;</span><br><span class="line">        <span class="comment">// It's very important that we block until we've recorded the</span></span><br><span class="line">        <span class="comment">// session as being sealed, since we never want to allow mutation</span></span><br><span class="line">        <span class="comment">// after sealing.</span></span><br><span class="line">        <span class="keyword">synchronized</span> (mSessions) &#123;</span><br><span class="line">            writeSessionsLocked();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>关于 Session，我们想讲这么多，在分析安装的过程中，我们在深入分析，我们只需要知道，每一个安装任务都会封装成一个 Session 即可！</p>
<h1 id="3-new-PackageManagerInternalImpl-系统进程内部调用"><a href="#3-new-PackageManagerInternalImpl-系统进程内部调用" class="headerlink" title="3 new PackageManagerInternalImpl - 系统进程内部调用"></a>3 new PackageManagerInternalImpl - 系统进程内部调用</h1><p>在 pms 的构造器结尾，调用了 LocalServices，将一个 PackageManagerInternalImpl 对象注册到本地服务管理中，这种方式用于系统进程内部服务间的通信，因为不需要使用 Binder 线程，所以效率更高！</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//【3】将自身加入本地服务管理中，方便系统自身访问！</span></span><br><span class="line">LocalServices.addService(PackageManagerInternal.class, <span class="keyword">new</span> PackageManagerInternalImpl());</span><br></pre></td></tr></table></figure>
<p>LocalServices 内部保存着一个静态的 ArrayMap 来保存所有注册到其内部的服务：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> ArrayMap&lt;Class&lt;?&gt;, Object&gt; sLocalServiceObjects =</span><br><span class="line">        <span class="keyword">new</span> ArrayMap&lt;Class&lt;?&gt;, Object&gt;();</span><br></pre></td></tr></table></figure>
<p>通过其内部的 addService 方法，将系统服务添加进来！<br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> &lt;T&gt; <span class="function"><span class="keyword">void</span> <span class="title">addService</span><span class="params">(Class&lt;T&gt; type, T service)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">synchronized</span> (sLocalServiceObjects) &#123;</span><br><span class="line">        <span class="keyword">if</span> (sLocalServiceObjects.containsKey(type)) &#123;</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> IllegalStateException(<span class="string">"Overriding service registration"</span>);</span><br><span class="line">        &#125;</span><br><span class="line">        sLocalServiceObjects.put(type, service);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>PackageManagerInternalImpl 对象继承了 PackageManagerInternal 并实现了其抽象方法，其内部有多个方案来供其他服务访问 PMS：</p>
<h2 id="3-1-注册系统服务-provider"><a href="#3-1-注册系统服务-provider" class="headerlink" title="3.1 注册系统服务 provider"></a>3.1 注册系统服务 provider</h2><p>后续会有其他的系统服务启动，他们会把自身的 provider 注册进入 PMS，后续 PMS 会授予他们权限！</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">private</span> <span class="class"><span class="keyword">class</span> <span class="title">PackageManagerInternalImpl</span> <span class="keyword">extends</span> <span class="title">PackageManagerInternal</span> </span>&#123;</span><br><span class="line">    <span class="comment">// 创建 LocationManagerService 时会调用该方法，LocationManagerService 会创建一个 PackagesProvider 对象！</span></span><br><span class="line">    <span class="comment">// 用于封装其 provider name！</span></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">setLocationPackagesProvider</span><span class="params">(PackagesProvider provider)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">synchronized</span> (mPackages) &#123;</span><br><span class="line">            <span class="comment">// 保存到 DefaultPermissionGrantPolicy.mLocationPackagesProvider 变量中！</span></span><br><span class="line">            mDefaultPermissionPolicy.setLocationPackagesProviderLPw(provider);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// 创建 VoiceInteractionManagerService 时会调用该方法！</span></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">setVoiceInteractionPackagesProvider</span><span class="params">(PackagesProvider provider)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">synchronized</span> (mPackages) &#123;</span><br><span class="line">            <span class="comment">// 保存到 DefaultPermissionGrantPolicy.mVoiceInteractionPackagesProvider 变量中！</span></span><br><span class="line">            mDefaultPermissionPolicy.setVoiceInteractionPackagesProviderLPw(provider);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 创建 TelecomLoaderService 时会调用该方法，TelecomLoaderService 创建时,</span></span><br><span class="line">    <span class="comment">// 会调用 registerDefaultAppProviders，该方法会触发注册 provider！</span></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">setSmsAppPackagesProvider</span><span class="params">(PackagesProvider provider)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">synchronized</span> (mPackages) &#123;</span><br><span class="line">            <span class="comment">// 保存到 DefaultPermissionGrantPolicy.mSmsAppPackagesProvider 变量中！</span></span><br><span class="line">            mDefaultPermissionPolicy.setSmsAppPackagesProviderLPw(provider);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 创建 TelecomLoaderService 时会调用该方法，同上！</span></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">setDialerAppPackagesProvider</span><span class="params">(PackagesProvider provider)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">synchronized</span> (mPackages) &#123;</span><br><span class="line">            <span class="comment">// 保存到 DefaultPermissionGrantPolicy.mDialerAppPackagesProvider 变量中！</span></span><br><span class="line">            mDefaultPermissionPolicy.setDialerAppPackagesProviderLPw(provider);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 创建 TelecomLoaderService 时会调用该方法，同上！</span></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">setSimCallManagerPackagesProvider</span><span class="params">(PackagesProvider provider)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">synchronized</span> (mPackages) &#123;</span><br><span class="line">            <span class="comment">// 保存到 DefaultPermissionGrantPolicy.mSimCallManagerPackagesProvider 变量中！</span></span><br><span class="line">            mDefaultPermissionPolicy.setSimCallManagerPackagesProviderLPw(provider);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 创建 ContentService 时会调用该方法，注册 provider！</span></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">setSyncAdapterPackagesprovider</span><span class="params">(SyncAdapterPackagesProvider provider)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">synchronized</span> (mPackages) &#123;</span><br><span class="line">            <span class="comment">// 保存到 DefaultPermissionGrantPolicy.mSyncAdapterPackagesProvider 变量中！</span></span><br><span class="line">            mDefaultPermissionPolicy.setSyncAdapterPackagesProviderLPw(provider);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    ... ... ... ...</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>上面的内容，后面会遇到！</p>
<h2 id="3-2-授予默认权限接口"><a href="#3-2-授予默认权限接口" class="headerlink" title="3.2 授予默认权限接口"></a>3.2 授予默认权限接口</h2><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">private</span> <span class="class"><span class="keyword">class</span> <span class="title">PackageManagerInternalImpl</span> <span class="keyword">extends</span> <span class="title">PackageManagerInternal</span> </span>&#123;</span><br><span class="line">    ... ... ... ...</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">grantDefaultPermissionsToDefaultSmsApp</span><span class="params">(String packageName, <span class="keyword">int</span> userId)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">synchronized</span> (mPackages) &#123;</span><br><span class="line">            mDefaultPermissionPolicy.grantDefaultPermissionsToDefaultSmsAppLPr(</span><br><span class="line">                    packageName, userId);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">grantDefaultPermissionsToDefaultDialerApp</span><span class="params">(String packageName, <span class="keyword">int</span> userId)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">synchronized</span> (mPackages) &#123;</span><br><span class="line">            mSettings.setDefaultDialerPackageNameLPw(packageName, userId);</span><br><span class="line">            mDefaultPermissionPolicy.grantDefaultPermissionsToDefaultDialerAppLPr(</span><br><span class="line">                    packageName, userId);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">grantDefaultPermissionsToDefaultSimCallManager</span><span class="params">(String packageName, <span class="keyword">int</span> userId)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">synchronized</span> (mPackages) &#123;</span><br><span class="line">            mDefaultPermissionPolicy.grantDefaultPermissionsToDefaultSimCallManagerLPr(</span><br><span class="line">                    packageName, userId);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    ... ... ... ...</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>以上方法都是在 TelecomLoaderService 服务中调用的！</p>
<h1 id="4-PackageMS-updatePackagesIfNeeded-执行-Odex-优化"><a href="#4-PackageMS-updatePackagesIfNeeded-执行-Odex-优化" class="headerlink" title="4 PackageMS.updatePackagesIfNeeded - 执行 Odex 优化"></a>4 PackageMS.updatePackagesIfNeeded - 执行 Odex 优化</h1><p>在 SystemServer.startOtherServices 中，会调用 updatePackagesIfNeeded 更新 package！</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">if</span> (!mOnlyCore) &#123;</span><br><span class="line">    Trace.traceBegin(Trace.TRACE_TAG_SYSTEM_SERVER, <span class="string">"UpdatePackagesIfNeeded"</span>);</span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">        mPackageManagerService.updatePackagesIfNeeded();</span><br><span class="line">    &#125; <span class="keyword">catch</span> (Throwable e) &#123;</span><br><span class="line">        reportWtf(<span class="string">"update packages"</span>, e);</span><br><span class="line">    &#125;</span><br><span class="line">    Trace.traceEnd(Trace.TRACE_TAG_SYSTEM_SERVER);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>我们去看看 updatePackagesIfNeeded 方法，该方法的主要作用是对应用进行 Odex 优化！<br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">updatePackagesIfNeeded</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    enforceSystemOrRoot(<span class="string">"Only the system can request package update"</span>);</span><br><span class="line">    </span><br><span class="line">    <span class="comment">//【1】是否是通过 OTA 升级的！</span></span><br><span class="line">    <span class="keyword">boolean</span> causeUpgrade = isUpgrade();</span><br><span class="line"></span><br><span class="line">    <span class="comment">//【2】是否是第一次启动，包括出场第一次开机，factory reset，如果是从 Android N 升级上来的，也看作是第一次启动！</span></span><br><span class="line">    <span class="keyword">boolean</span> causeFirstBoot = isFirstBoot() || mIsPreNUpgrade;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// We need to re-extract after a pruned cache, as AoT-ed files will be out of date.</span></span><br><span class="line">    <span class="keyword">boolean</span> causePrunedCache = VMRuntime.didPruneDalvikCache();</span><br><span class="line">    </span><br><span class="line">    <span class="comment">//【1】如果不是上面几种情况，不处理！</span></span><br><span class="line">    <span class="keyword">if</span> (!causeUpgrade &amp;&amp; !causeFirstBoot &amp;&amp; !causePrunedCache) &#123;</span><br><span class="line">        <span class="keyword">return</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">//【4.1】获得要执行 odex 优化的 package！</span></span><br><span class="line">    List&lt;PackageParser.Package&gt; pkgs;</span><br><span class="line">    <span class="keyword">synchronized</span> (mPackages) &#123;</span><br><span class="line">        pkgs = PackageManagerServiceUtils.getPackagesForDexopt(mPackages.values(), <span class="keyword">this</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">final</span> <span class="keyword">long</span> startTime = System.nanoTime();</span><br><span class="line">    <span class="comment">//【4.2】执行 odex 优化！</span></span><br><span class="line">    <span class="keyword">final</span> <span class="keyword">int</span>[] stats = performDexOptUpgrade(pkgs, mIsPreNUpgrade <span class="comment">/* showDialog */</span>,</span><br><span class="line">                getCompilerFilterForReason(causeFirstBoot ? REASON_FIRST_BOOT : REASON_BOOT));</span><br><span class="line"></span><br><span class="line">    <span class="keyword">final</span> <span class="keyword">int</span> elapsedTimeSeconds =</span><br><span class="line">            (<span class="keyword">int</span>) TimeUnit.NANOSECONDS.toSeconds(System.nanoTime() - startTime);</span><br><span class="line"></span><br><span class="line">    <span class="comment">//【4】记录执行结果！</span></span><br><span class="line">    MetricsLogger.histogram(mContext, <span class="string">"opt_dialog_num_dexopted"</span>, stats[<span class="number">0</span>]);</span><br><span class="line">    MetricsLogger.histogram(mContext, <span class="string">"opt_dialog_num_skipped"</span>, stats[<span class="number">1</span>]);</span><br><span class="line">    MetricsLogger.histogram(mContext, <span class="string">"opt_dialog_num_failed"</span>, stats[<span class="number">2</span>]);</span><br><span class="line">    MetricsLogger.histogram(mContext, <span class="string">"opt_dialog_num_total"</span>, getOptimizablePackages().size());</span><br><span class="line">    MetricsLogger.histogram(mContext, <span class="string">"opt_dialog_time_s"</span>, elapsedTimeSeconds);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>整个过程就是收集所有的 Pacakge，然后执行 Odex 优化！</p>
<p>可以看到，只有</p>
<h2 id="4-1-PackageManagerServiceUtils-getPackagesForDexopt"><a href="#4-1-PackageManagerServiceUtils-getPackagesForDexopt" class="headerlink" title="4.1 PackageManagerServiceUtils.getPackagesForDexopt"></a>4.1 PackageManagerServiceUtils.getPackagesForDexopt</h2><p>getPackagesForDexopt 会对系统中所有扫描到的 package 进行排序！<br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> List&lt;PackageParser.Package&gt; getPackagesForDexopt(</span><br><span class="line">        Collection&lt;PackageParser.Package&gt; packages,</span><br><span class="line">        PackageManagerService packageManagerService) &#123;</span><br><span class="line">    <span class="comment">//【1】result 用于保存排序后的所有结果，remainingPkgs 用于保存没有排序的 package</span></span><br><span class="line">    <span class="comment">// sortTemp 用于缓存排序的结果！</span></span><br><span class="line">    ArrayList&lt;PackageParser.Package&gt; remainingPkgs = <span class="keyword">new</span> ArrayList&lt;&gt;(packages); <span class="comment">// 初始化 remainingPkgs！</span></span><br><span class="line">    LinkedList&lt;PackageParser.Package&gt; result = <span class="keyword">new</span> LinkedList&lt;&gt;();</span><br><span class="line">    ArrayList&lt;PackageParser.Package&gt; sortTemp = <span class="keyword">new</span> ArrayList&lt;&gt;(remainingPkgs.size());</span><br><span class="line"></span><br><span class="line">    <span class="comment">//【4.1.1】调用 applyPackageFilter 设置优先级，然后排序！</span></span><br><span class="line">    <span class="comment">//【4.1.1.1】开始第一阶段排序，收集那些 pkg.coreApp 为 true 的应用，进行排序，然后添加到 result 中！</span></span><br><span class="line">    applyPackageFilter((pkg) -&gt; pkg.coreApp, result, remainingPkgs, sortTemp,</span><br><span class="line">            packageManagerService);</span><br><span class="line"></span><br><span class="line">    <span class="comment">//【4.1.1.2】开始第二个阶段排序，条件是是否监听 ACTION_PRE_BOOT_COMPLETED 这个广播！</span></span><br><span class="line">    <span class="comment">// 手机监听该广播的 package，进行排序，结果添加到 result 中！</span></span><br><span class="line">    Intent intent = <span class="keyword">new</span> Intent(Intent.ACTION_PRE_BOOT_COMPLETED);</span><br><span class="line">    <span class="keyword">final</span> ArraySet&lt;String&gt; pkgNames = getPackageNamesForIntent(intent, UserHandle.USER_SYSTEM);</span><br><span class="line">    applyPackageFilter((pkg) -&gt; pkgNames.contains(pkg.packageName), result, remainingPkgs,</span><br><span class="line">            sortTemp, packageManagerService);</span><br><span class="line"></span><br><span class="line">    <span class="comment">//【4.1.1.3】开始第三个阶段排序，条件是 package 是否被其他应用加载或使用，排序后结果添加到 result 中！</span></span><br><span class="line">    applyPackageFilter((pkg) -&gt; PackageDexOptimizer.isUsedByOtherApps(pkg), result,</span><br><span class="line">            remainingPkgs, sortTemp, packageManagerService);</span><br><span class="line"></span><br><span class="line">    <span class="comment">//【2】处理剩余的仍然没有被处理的 Package！</span></span><br><span class="line">    Predicate&lt;PackageParser.Package&gt; remainingPredicate;</span><br><span class="line">    <span class="keyword">if</span> (!remainingPkgs.isEmpty() &amp;&amp; packageManagerService.isHistoricalPackageUsageAvailable()) &#123;</span><br><span class="line">        <span class="keyword">if</span> (DEBUG_DEXOPT) &#123;</span><br><span class="line">            Log.i(TAG, <span class="string">"Looking at historical package use"</span>);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment">//【1】对剩余的 package 进行比较，找到最新使用时间最晚的那个 package！</span></span><br><span class="line">        PackageParser.Package lastUsed = Collections.max(remainingPkgs, (pkg1, pkg2) -&gt;</span><br><span class="line">                Long.compare(pkg1.getLatestForegroundPackageUseTimeInMills(),</span><br><span class="line">                        pkg2.getLatestForegroundPackageUseTimeInMills()));</span><br><span class="line">                        </span><br><span class="line">        <span class="keyword">if</span> (DEBUG_DEXOPT) &#123;</span><br><span class="line">            Log.i(TAG, <span class="string">"Taking package "</span> + lastUsed.packageName + <span class="string">" as reference in time use"</span>);</span><br><span class="line">        &#125;</span><br><span class="line">        </span><br><span class="line">        <span class="keyword">long</span> estimatedPreviousSystemUseTime =</span><br><span class="line">                lastUsed.getLatestForegroundPackageUseTimeInMills();</span><br><span class="line">        <span class="comment">//【2】确定过滤器</span></span><br><span class="line">        <span class="keyword">if</span> (estimatedPreviousSystemUseTime != <span class="number">0</span>) &#123;</span><br><span class="line">            <span class="comment">//【2.1】剩余 package 的排序条件为：该应用最新使用时间距离安装超过了 7 天！</span></span><br><span class="line">            <span class="keyword">final</span> <span class="keyword">long</span> cutoffTime = estimatedPreviousSystemUseTime - SEVEN_DAYS_IN_MILLISECONDS;</span><br><span class="line">            remainingPredicate =</span><br><span class="line">                    (pkg) -&gt; pkg.getLatestForegroundPackageUseTimeInMills() &gt;= cutoffTime;</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            <span class="comment">//【2.2】剩余 package 的排序条件为 true，即：不过滤，处理剩下的所有 package！</span></span><br><span class="line">            remainingPredicate = (pkg) -&gt; <span class="keyword">true</span>;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 先对剩余的 package 进行一次时间排序，目的是使用！</span></span><br><span class="line">        sortPackagesByUsageDate(remainingPkgs, packageManagerService);</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        <span class="comment">//【2.3】剩余 package 的排序条件为 true，即：不过滤，处理剩下的所有 package</span></span><br><span class="line">        remainingPredicate = (pkg) -&gt; <span class="keyword">true</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">//【4.1.1.4】最后一次排序，处理剩余的仍然没有被处理的 Package，满足上面条件的 package！！</span></span><br><span class="line">    applyPackageFilter(remainingPredicate, result, remainingPkgs, sortTemp,</span><br><span class="line">            packageManagerService);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (DEBUG_DEXOPT) &#123;</span><br><span class="line">        Log.i(TAG, <span class="string">"Packages to be dexopted: "</span> + packagesToString(result));</span><br><span class="line">        Log.i(TAG, <span class="string">"Packages skipped from dexopt: "</span> + packagesToString(remainingPkgs));</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">//【3】返回需要做 Odex 的排序过的 Package！</span></span><br><span class="line">    <span class="keyword">return</span> result;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>对于 getPackagesForDexopt 方法的分析就到这里！</p>
<h3 id="4-1-1-PackageManagerServiceUtils-applyPackageFilter"><a href="#4-1-1-PackageManagerServiceUtils-applyPackageFilter" class="headerlink" title="4.1.1 PackageManagerServiceUtils.applyPackageFilter"></a>4.1.1 PackageManagerServiceUtils.applyPackageFilter</h3><p>applyPackageFilter 方法通过传入的过滤条件，收集满足条件的 package，对其进行排序！<br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">applyPackageFilter</span><span class="params">(Predicate&lt;PackageParser.Package&gt; filter,</span></span></span><br><span class="line"><span class="function"><span class="params">        Collection&lt;PackageParser.Package&gt; result,</span></span></span><br><span class="line"><span class="function"><span class="params">        Collection&lt;PackageParser.Package&gt; packages,</span></span></span><br><span class="line"><span class="function"><span class="params">        @NonNull List&lt;PackageParser.Package&gt; sortTemp,</span></span></span><br><span class="line"><span class="function"><span class="params">        PackageManagerService packageManagerService)</span> </span>&#123;</span><br><span class="line">    <span class="comment">//【1】收集那些满足 filter 设定的条件的 package，添加到 sortTemp！</span></span><br><span class="line">    <span class="keyword">for</span> (PackageParser.Package pkg : packages) &#123;</span><br><span class="line">        <span class="keyword">if</span> (filter.test(pkg)) &#123;</span><br><span class="line">            sortTemp.add(pkg);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">//【4.1.1.1】对 sortTemp 中的 package 进行排序！</span></span><br><span class="line">    sortPackagesByUsageDate(sortTemp, packageManagerService);</span><br><span class="line">    </span><br><span class="line">    <span class="comment">//【2】从 packages （就是 remainingPkgs）中移除 sortTemp 包含的 pacakge！</span></span><br><span class="line">    packages.removeAll(sortTemp);</span><br><span class="line">    </span><br><span class="line">    <span class="comment">//【3】将 sortTemp 中排好序的所有 package，添加到 result 中！</span></span><br><span class="line">    <span class="keyword">for</span> (PackageParser.Package pkg : sortTemp) &#123;</span><br><span class="line">        result.add(pkg);</span><br><span class="line">        <span class="comment">//【3.1】找到和该 pkg 共享非系统库文件的 package，也添加到 result 中！</span></span><br><span class="line">        <span class="comment">// 同时从 packages （就是 remainingPkgs）中也移除这部分 package！</span></span><br><span class="line">        Collection&lt;PackageParser.Package&gt; deps =</span><br><span class="line">                packageManagerService.findSharedNonSystemLibraries(pkg);</span><br><span class="line">        <span class="keyword">if</span> (!deps.isEmpty()) &#123;</span><br><span class="line">            deps.removeAll(result);</span><br><span class="line">            result.addAll(deps);</span><br><span class="line">            packages.removeAll(deps);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    sortTemp.clear();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>过程很简单不多说了！</p>
<h4 id="4-1-1-1-PackageManagerServiceUtils-sortPackagesByUsageDate"><a href="#4-1-1-1-PackageManagerServiceUtils-sortPackagesByUsageDate" class="headerlink" title="4.1.1.1 PackageManagerServiceUtils.sortPackagesByUsageDate"></a>4.1.1.1 PackageManagerServiceUtils.sortPackagesByUsageDate</h4><p>该方法的作用是对 package 列表进行排序！<br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">sortPackagesByUsageDate</span><span class="params">(List&lt;PackageParser.Package&gt; pkgs,</span></span></span><br><span class="line"><span class="function"><span class="params">        PackageManagerService packageManagerService)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">if</span> (!packageManagerService.isHistoricalPackageUsageAvailable()) &#123;</span><br><span class="line">        <span class="keyword">return</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">//【1】排序依据是：package 在前台使用是时间！</span></span><br><span class="line">    Collections.sort(pkgs, (pkg1, pkg2) -&gt;</span><br><span class="line">            Long.compare(pkg2.getLatestForegroundPackageUseTimeInMills(),</span><br><span class="line">                    pkg1.getLatestForegroundPackageUseTimeInMills()));</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<h2 id="4-2-PackageMS-performDexOptUpgrade"><a href="#4-2-PackageMS-performDexOptUpgrade" class="headerlink" title="4.2 PackageMS.performDexOptUpgrade"></a>4.2 PackageMS.performDexOptUpgrade</h2><p>performDexOptUpgrade 用于执行 Odex 优化操作！</p>
<p>对于参数 showDialog：传入的是 mIsPreNUpgrade，表示是否是从 N 升级上来的！</p>
<p>对于参数 compilerFilter：传入的是 getCompilerFilterForReason(causeFirstBoot ? REASON_FIRST_BOOT : REASON_BOOT)!<br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">private</span> <span class="keyword">int</span>[] performDexOptUpgrade(List&lt;PackageParser.Package&gt; pkgs, <span class="keyword">boolean</span> showDialog,</span><br><span class="line">        String compilerFilter) &#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">int</span> numberOfPackagesVisited = <span class="number">0</span>;</span><br><span class="line">    <span class="keyword">int</span> numberOfPackagesOptimized = <span class="number">0</span>;</span><br><span class="line">    <span class="keyword">int</span> numberOfPackagesSkipped = <span class="number">0</span>;</span><br><span class="line">    <span class="keyword">int</span> numberOfPackagesFailed = <span class="number">0</span>;</span><br><span class="line">    <span class="keyword">final</span> <span class="keyword">int</span> numberOfPackagesToDexopt = pkgs.size();</span><br><span class="line"></span><br><span class="line">    <span class="comment">//【All】遍历所有要执行 Odex 的所有 Package！</span></span><br><span class="line">    <span class="keyword">for</span> (PackageParser.Package pkg : pkgs) &#123;</span><br><span class="line">        numberOfPackagesVisited++;</span><br><span class="line">        <span class="comment">//【1】跳过那些不能做 Odex 优化的 Package！</span></span><br><span class="line">        <span class="keyword">if</span> (!PackageDexOptimizer.canOptimizePackage(pkg)) &#123;</span><br><span class="line">            <span class="keyword">if</span> (DEBUG_DEXOPT) &#123;</span><br><span class="line">                Log.i(TAG, <span class="string">"Skipping update of of non-optimizable app "</span> + pkg.packageName);</span><br><span class="line">            &#125;</span><br><span class="line">            numberOfPackagesSkipped++;</span><br><span class="line">            <span class="keyword">continue</span>;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (DEBUG_DEXOPT) &#123;</span><br><span class="line">            Log.i(TAG, <span class="string">"Updating app "</span> + numberOfPackagesVisited + <span class="string">" of "</span> +</span><br><span class="line">                    numberOfPackagesToDexopt + <span class="string">": "</span> + pkg.packageName);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">//【2】在做 Odex 优化的时候，是否显示界面进行提示！</span></span><br><span class="line">        <span class="keyword">if</span> (showDialog) &#123;</span><br><span class="line">            <span class="keyword">try</span> &#123;</span><br><span class="line">                ActivityManagerNative.getDefault().showBootMessage(</span><br><span class="line">                        mContext.getResources().getString(R.string.android_upgrading_apk,</span><br><span class="line">                                numberOfPackagesVisited, numberOfPackagesToDexopt), <span class="keyword">true</span>);</span><br><span class="line">            &#125; <span class="keyword">catch</span> (RemoteException e) &#123;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">synchronized</span> (mPackages) &#123;</span><br><span class="line">                mDexOptDialogShown = <span class="keyword">true</span>;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// If the OTA updates a system app which was previously preopted to a non-preopted state</span></span><br><span class="line">        <span class="comment">// the app might end up being verified at runtime. That's because by default the apps</span></span><br><span class="line">        <span class="comment">// are verify-profile but for preopted apps there's no profile.</span></span><br><span class="line">        <span class="comment">// Do a hacky check to ensure that if we have no profiles (a reasonable indication</span></span><br><span class="line">        <span class="comment">// that before the OTA the app was preopted) the app gets compiled with a non-profile</span></span><br><span class="line">        <span class="comment">// filter (by default interpret-only).</span></span><br><span class="line">        <span class="comment">// Note that at this stage unused apps are already filtered.</span></span><br><span class="line">        <span class="comment">//【3】设置执行 Odex 优化的时候的 compilerFilter 类型！</span></span><br><span class="line">        <span class="keyword">if</span> (isSystemApp(pkg) &amp;&amp;</span><br><span class="line">                DexFile.isProfileGuidedCompilerFilter(compilerFilter) &amp;&amp;</span><br><span class="line">                !Environment.getReferenceProfile(pkg.packageName).exists()) &#123;</span><br><span class="line">            compilerFilter = getNonProfileGuidedCompilerFilter(compilerFilter);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// checkProfiles is false to avoid merging profiles during boot which</span></span><br><span class="line">        <span class="comment">// might interfere with background compilation (b/28612421).</span></span><br><span class="line">        <span class="comment">// Unfortunately this will also means that "pm.dexopt.boot=speed-profile" will</span></span><br><span class="line">        <span class="comment">// behave differently than "pm.dexopt.bg-dexopt=speed-profile" but that's a</span></span><br><span class="line">        <span class="comment">// trade-off worth doing to save boot time work.</span></span><br><span class="line">        <span class="comment">//【4.2.2】执行 Odex</span></span><br><span class="line">        <span class="keyword">int</span> dexOptStatus = performDexOptTraced(pkg.packageName,</span><br><span class="line">                <span class="keyword">false</span> <span class="comment">/* checkProfiles */</span>,</span><br><span class="line">                compilerFilter,</span><br><span class="line">                <span class="keyword">false</span> <span class="comment">/* force */</span>);</span><br><span class="line">        <span class="keyword">switch</span> (dexOptStatus) &#123;</span><br><span class="line">            <span class="keyword">case</span> PackageDexOptimizer.DEX_OPT_PERFORMED:</span><br><span class="line">                numberOfPackagesOptimized++;</span><br><span class="line">                <span class="keyword">break</span>;</span><br><span class="line">            <span class="keyword">case</span> PackageDexOptimizer.DEX_OPT_SKIPPED:</span><br><span class="line">                numberOfPackagesSkipped++;</span><br><span class="line">                <span class="keyword">break</span>;</span><br><span class="line">            <span class="keyword">case</span> PackageDexOptimizer.DEX_OPT_FAILED:</span><br><span class="line">                numberOfPackagesFailed++;</span><br><span class="line">                <span class="keyword">break</span>;</span><br><span class="line">            <span class="keyword">default</span>:</span><br><span class="line">                Log.e(TAG, <span class="string">"Unexpected dexopt return code "</span> + dexOptStatus);</span><br><span class="line">                <span class="keyword">break</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">new</span> <span class="keyword">int</span>[] &#123; numberOfPackagesOptimized, numberOfPackagesSkipped,</span><br><span class="line">            numberOfPackagesFailed &#125;;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<h3 id="4-2-1-PackageManagerServiceCompilerMapping-getCompilerFilterForReason"><a href="#4-2-1-PackageManagerServiceCompilerMapping-getCompilerFilterForReason" class="headerlink" title="4.2.1 PackageManagerServiceCompilerMapping.getCompilerFilterForReason"></a>4.2.1 PackageManagerServiceCompilerMapping.getCompilerFilterForReason</h3><p>这里调用了 getCompilerFilterForReason，根据执行的原因选择合适的 compileFilter：<br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">static</span> String <span class="title">getCompilerFilterForReason</span><span class="params">(<span class="keyword">int</span> reason)</span> </span>&#123;</span><br><span class="line">    <span class="comment">//【4.2.1.1】通过 reason 来获得 compileFilter</span></span><br><span class="line">    <span class="keyword">return</span> getAndCheckValidity(reason);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>如果是 first boot，则为 REASON_FIRST_BOOT，否则为 REASON_BOOT！</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// Compilation reasons.</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="keyword">int</span> REASON_FIRST_BOOT = <span class="number">0</span>;</span><br><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="keyword">int</span> REASON_BOOT = <span class="number">1</span>;</span><br><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="keyword">int</span> REASON_INSTALL = <span class="number">2</span>;</span><br><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="keyword">int</span> REASON_BACKGROUND_DEXOPT = <span class="number">3</span>;</span><br><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="keyword">int</span> REASON_AB_OTA = <span class="number">4</span>;</span><br><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="keyword">int</span> REASON_NON_SYSTEM_LIBRARY = <span class="number">5</span>;</span><br><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="keyword">int</span> REASON_SHARED_APK = <span class="number">6</span>;</span><br><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="keyword">int</span> REASON_FORCED_DEXOPT = <span class="number">7</span>;</span><br><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="keyword">int</span> REASON_CORE_APP = <span class="number">8</span>;</span><br></pre></td></tr></table></figure>
<p>对于 reason 的取值如上，其实通过名字，很容易就能看到，每种 reason 的使用类型！</p>
<h4 id="4-2-1-1-PackageManagerServiceCompilerMapping-getAndCheckValidity"><a href="#4-2-1-1-PackageManagerServiceCompilerMapping-getAndCheckValidity" class="headerlink" title="4.2.1.1 PackageManagerServiceCompilerMapping.getAndCheckValidity"></a>4.2.1.1 PackageManagerServiceCompilerMapping.getAndCheckValidity</h4><p>检查 reason 对应的有效性！</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">static</span> String <span class="title">getAndCheckValidity</span><span class="params">(<span class="keyword">int</span> reason)</span> </span>&#123;</span><br><span class="line">    <span class="comment">//【1】校验 reason 对应的 compileFilter 是否有效！</span></span><br><span class="line">    String sysPropValue = SystemProperties.get(getSystemPropertyName(reason));</span><br><span class="line">    <span class="keyword">if</span> (sysPropValue == <span class="keyword">null</span> || sysPropValue.isEmpty() ||</span><br><span class="line">            !DexFile.isValidCompilerFilter(sysPropValue)) &#123;</span><br><span class="line">        <span class="comment">//【1.1】这里会通过 DexFile.isValidCompilerFilter 校验！</span></span><br><span class="line">        <span class="keyword">throw</span> <span class="keyword">new</span> IllegalStateException(<span class="string">"Value \""</span> + sysPropValue +<span class="string">"\" not valid "</span></span><br><span class="line">                + <span class="string">"(reason "</span> + REASON_STRINGS[reason] + <span class="string">")"</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//【2】如果 reason 是 REASON_SHARED_APK 和 REASON_FORCED_DEXOPT，还要校验下其是否映射到一个 </span></span><br><span class="line">    <span class="comment">// profile-guided filter！</span></span><br><span class="line">    <span class="keyword">switch</span> (reason) &#123;</span><br><span class="line">        <span class="keyword">case</span> PackageManagerService.REASON_SHARED_APK:</span><br><span class="line">        <span class="keyword">case</span> PackageManagerService.REASON_FORCED_DEXOPT:</span><br><span class="line">            <span class="keyword">if</span> (DexFile.isProfileGuidedCompilerFilter(sysPropValue)) &#123;</span><br><span class="line">                <span class="keyword">throw</span> <span class="keyword">new</span> IllegalStateException(<span class="string">"\""</span> + sysPropValue + <span class="string">"\" is profile-guided, "</span></span><br><span class="line">                        + <span class="string">"but not allowed for "</span> + REASON_STRINGS[reason]);</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">//【3】返回我们需要的 compileFilter！</span></span><br><span class="line">    <span class="keyword">return</span> sysPropValue;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>每一个有效的 reason 都会对应一个系统属性名，PackageManagerServiceCompilerMapping 内置了如下的系统属性名关键字：<br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">static</span> <span class="keyword">final</span> String REASON_STRINGS[] = &#123;</span><br><span class="line">        <span class="string">"first-boot"</span>, <span class="string">"boot"</span>, <span class="string">"install"</span>, <span class="string">"bg-dexopt"</span>, <span class="string">"ab-ota"</span>, <span class="string">"nsys-library"</span>, <span class="string">"shared-apk"</span>,</span><br><span class="line">        <span class="string">"forced-dexopt"</span>, <span class="string">"core-app"</span></span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure></p>
<p>如果是 <strong>REASON_FIRST_BOOT</strong>，对应的关键字就是 “first-boot”，其他的以此类推！<br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">static</span> String <span class="title">getSystemPropertyName</span><span class="params">(<span class="keyword">int</span> reason)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">if</span> (reason &lt; <span class="number">0</span> || reason &gt;= REASON_STRINGS.length) &#123;</span><br><span class="line">        <span class="keyword">throw</span> <span class="keyword">new</span> IllegalArgumentException(<span class="string">"reason "</span> + reason + <span class="string">" invalid"</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> <span class="string">"pm.dexopt."</span> + REASON_STRINGS[reason];</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>然后，我们就可以获得系统属性名了，格式为：pm.dexopt.REASON_STRINGS[reason]，比如对于 REASON_FIRST_BOOT，对应的系统属性名为 ：pm.dexopt.first-boot！</p>
<p>然后我们通过该系统属性名，获得对应的属性 compileFilter！</p>
<h3 id="4-2-2-PackageMS-performDexOptTraced"><a href="#4-2-2-PackageMS-performDexOptTraced" class="headerlink" title="4.2.2 PackageMS.performDexOptTraced"></a>4.2.2 PackageMS.performDexOptTraced</h3><p>执行 Odex 优化操作！</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">int</span> <span class="title">performDexOptTraced</span><span class="params">(String packageName,</span></span></span><br><span class="line"><span class="function"><span class="params">            <span class="keyword">boolean</span> checkProfiles, String targetCompilerFilter, <span class="keyword">boolean</span> force)</span> </span>&#123;</span><br><span class="line">    Trace.traceBegin(TRACE_TAG_PACKAGE_MANAGER, <span class="string">"dexopt"</span>);</span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">        <span class="comment">//【4.2.2.1】执行 Odex 优化！</span></span><br><span class="line">        <span class="keyword">return</span> performDexOptInternal(packageName, checkProfiles,</span><br><span class="line">                targetCompilerFilter, force);</span><br><span class="line">    &#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">        Trace.traceEnd(TRACE_TAG_PACKAGE_MANAGER);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>继续调用 performDexOptTraced 方法！</p>
<h4 id="4-2-2-1-PackageMS-performDexOptTraced"><a href="#4-2-2-1-PackageMS-performDexOptTraced" class="headerlink" title="4.2.2.1 PackageMS.performDexOptTraced"></a>4.2.2.1 PackageMS.performDexOptTraced</h4><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">int</span> <span class="title">performDexOptInternal</span><span class="params">(String packageName,</span></span></span><br><span class="line"><span class="function"><span class="params">            <span class="keyword">boolean</span> checkProfiles, String targetCompilerFilter, <span class="keyword">boolean</span> force)</span> </span>&#123;</span><br><span class="line">    PackageParser.Package p;</span><br><span class="line">    <span class="keyword">synchronized</span> (mPackages) &#123;</span><br><span class="line">        <span class="comment">//【1】获得 package 对应的数据对象 PackageParser.Package！</span></span><br><span class="line">        <span class="comment">// 找不到，返回 PackageDexOptimizer.DEX_OPT_FAILED！</span></span><br><span class="line">        p = mPackages.get(packageName);</span><br><span class="line">        <span class="keyword">if</span> (p == <span class="keyword">null</span>) &#123;</span><br><span class="line">            <span class="comment">// Package could not be found. Report failure.</span></span><br><span class="line">            <span class="keyword">return</span> PackageDexOptimizer.DEX_OPT_FAILED;</span><br><span class="line">        &#125;</span><br><span class="line">        mPackageUsage.maybeWriteAsync(mPackages);</span><br><span class="line">        mCompilerStats.maybeWriteAsync();</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">long</span> callingId = Binder.clearCallingIdentity();</span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">        <span class="keyword">synchronized</span> (mInstallLock) &#123;</span><br><span class="line">            <span class="comment">//【4.2.2.2】调用 performDexOptInternalWithDependenciesLI 继续执行！</span></span><br><span class="line">            <span class="keyword">return</span> performDexOptInternalWithDependenciesLI(p, checkProfiles,</span><br><span class="line">                    targetCompilerFilter, force);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">        Binder.restoreCallingIdentity(callingId);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>继续调用 performDexOptInternalWithDependenciesLI</p>
<h4 id="4-2-2-2-PackageMS-performDexOptInternalWithDependenciesLI"><a href="#4-2-2-2-PackageMS-performDexOptInternalWithDependenciesLI" class="headerlink" title="4.2.2.2 PackageMS.performDexOptInternalWithDependenciesLI"></a>4.2.2.2 PackageMS.performDexOptInternalWithDependenciesLI</h4><p>根据前面的参数传递：checkProfiles 的值为 false；force 的值为 false：<br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">int</span> <span class="title">performDexOptInternalWithDependenciesLI</span><span class="params">(PackageParser.Package p,</span></span></span><br><span class="line"><span class="function"><span class="params">            <span class="keyword">boolean</span> checkProfiles, String targetCompilerFilter,</span></span></span><br><span class="line"><span class="function"><span class="params">        <span class="keyword">boolean</span> force)</span> </span>&#123;</span><br><span class="line">    <span class="comment">//【1】根据参数 force 的值，选择不同的 PackageDexOptimizer，绝大多数情况下，选择的是</span></span><br><span class="line">    <span class="comment">// PackageDexOptimizer！</span></span><br><span class="line">    PackageDexOptimizer pdo = force</span><br><span class="line">            ? <span class="keyword">new</span> PackageDexOptimizer.ForcedUpdatePackageDexOptimizer(mPackageDexOptimizer)</span><br><span class="line">            : mPackageDexOptimizer;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//【2】先对该 package 所依赖的共享库所属 pacakge 进行 Odex 优化！</span></span><br><span class="line">    Collection&lt;PackageParser.Package&gt; deps = findSharedNonSystemLibraries(p);</span><br><span class="line">    <span class="keyword">final</span> String[] instructionSets = getAppDexInstructionSets(p.applicationInfo);</span><br><span class="line">    <span class="keyword">if</span> (!deps.isEmpty()) &#123;</span><br><span class="line">        <span class="keyword">for</span> (PackageParser.Package depPackage : deps) &#123;</span><br><span class="line">            <span class="comment">// <span class="doctag">TODO:</span> Analyze and investigate if we (should) profile libraries.</span></span><br><span class="line">            <span class="comment">// Currently this will do a full compilation of the library by default.</span></span><br><span class="line">            pdo.performDexOpt(depPackage, <span class="keyword">null</span> <span class="comment">/* sharedLibraries */</span>, instructionSets,</span><br><span class="line">                    <span class="keyword">false</span> <span class="comment">/* checkProfiles */</span>,</span><br><span class="line">                    getCompilerFilterForReason(REASON_NON_SYSTEM_LIBRARY),</span><br><span class="line">                    getOrCreateCompilerPackageStats(depPackage));</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">//【4.2.2.3】对该 package 进行 Odex 优化！</span></span><br><span class="line">    <span class="keyword">return</span> pdo.performDexOpt(p, p.usesLibraryFiles, instructionSets, checkProfiles,</span><br><span class="line">            targetCompilerFilter, getOrCreateCompilerPackageStats(p));</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>如果 force 的值为 false，那么选择的是 mPackageDexOptimizer，mPackageDexOptimizer 我们都知道，在 PackageManagerService 的初始化的时候，会创建对应的 PackageDexOptimizer 对象！</p>
<p>绝大数情况，force 都是 false；为 true 的情况很少使用，主要用于 cmd test！</p>
<p>当然，最终调用了：<br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">PackageDexOptimizer.performDexOpt</span><br></pre></td></tr></table></figure></p>
<p>performDexOpt 方法进行 Odex 优化！</p>
<h4 id="4-2-2-3-PackageDexOptimizer-performDexOpt"><a href="#4-2-2-3-PackageDexOptimizer-performDexOpt" class="headerlink" title="4.2.2.3 PackageDexOptimizer.performDexOpt"></a>4.2.2.3 PackageDexOptimizer.performDexOpt</h4><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">performDexOpt</span><span class="params">(PackageParser.Package pkg, String[] sharedLibraries,</span></span></span><br><span class="line"><span class="function"><span class="params">        String[] instructionSets, <span class="keyword">boolean</span> checkProfiles, String targetCompilationFilter,</span></span></span><br><span class="line"><span class="function"><span class="params">        CompilerStats.PackageStats packageStats)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">synchronized</span> (mInstallLock) &#123;</span><br><span class="line">        <span class="comment">//【1】申请 WakeLock！</span></span><br><span class="line">        <span class="keyword">final</span> <span class="keyword">boolean</span> useLock = mSystemReady;</span><br><span class="line">        <span class="keyword">if</span> (useLock) &#123;</span><br><span class="line">            mDexoptWakeLock.setWorkSource(<span class="keyword">new</span> WorkSource(pkg.applicationInfo.uid));</span><br><span class="line">            mDexoptWakeLock.acquire();</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            <span class="comment">//【4.2.2.3.1】调用 performDexOptLI 执行 Odex 优化！</span></span><br><span class="line">            <span class="keyword">return</span> performDexOptLI(pkg, sharedLibraries, instructionSets, checkProfiles,</span><br><span class="line">                    targetCompilationFilter, packageStats);</span><br><span class="line">        &#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">            <span class="keyword">if</span> (useLock) &#123;</span><br><span class="line">                mDexoptWakeLock.release();</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h5 id="4-2-2-3-1-PackageDexOptimizer-performDexOptLI"><a href="#4-2-2-3-1-PackageDexOptimizer-performDexOptLI" class="headerlink" title="4.2.2.3.1 PackageDexOptimizer.performDexOptLI"></a>4.2.2.3.1 PackageDexOptimizer.performDexOptLI</h5><p>performDexOptLI 是执行 Odex 的重要方法：<br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">int</span> <span class="title">performDexOptLI</span><span class="params">(PackageParser.Package pkg, String[] sharedLibraries,</span></span></span><br><span class="line"><span class="function"><span class="params">        String[] targetInstructionSets, <span class="keyword">boolean</span> checkProfiles, String targetCompilerFilter,</span></span></span><br><span class="line"><span class="function"><span class="params">        CompilerStats.PackageStats packageStats)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">final</span> String[] instructionSets = targetInstructionSets != <span class="keyword">null</span> ?</span><br><span class="line">            targetInstructionSets : getAppDexInstructionSets(pkg.applicationInfo);</span><br><span class="line">    <span class="comment">//【1】如果该 package 没有 ApplicationInfo.FLAG_HAS_CODE 该标志，</span></span><br><span class="line">    <span class="comment">// 就不能执行 Odex 优化，返回 DEX_OPT_SKIPPED！</span></span><br><span class="line">    <span class="keyword">if</span> (!canOptimizePackage(pkg)) &#123;</span><br><span class="line">        <span class="keyword">return</span> DEX_OPT_SKIPPED;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">//【2】获得该应用的 apk 文件所在路径！</span></span><br><span class="line">    <span class="keyword">final</span> List&lt;String&gt; paths = pkg.getAllCodePathsExcludingResourceOnly();</span><br><span class="line">    <span class="keyword">final</span> <span class="keyword">int</span> sharedGid = UserHandle.getSharedAppGid(pkg.applicationInfo.uid);</span><br><span class="line"></span><br><span class="line">    <span class="comment">//【3】如果该应用被其他的应用使用，不能用 profile-guided</span></span><br><span class="line">    <span class="keyword">boolean</span> isProfileGuidedFilter = DexFile.isProfileGuidedCompilerFilter(targetCompilerFilter);</span><br><span class="line">    <span class="keyword">if</span> (isProfileGuidedFilter &amp;&amp; isUsedByOtherApps(pkg)) &#123;</span><br><span class="line">        checkProfiles = <span class="keyword">false</span>;</span><br><span class="line"></span><br><span class="line">        targetCompilerFilter = getNonProfileGuidedCompilerFilter(targetCompilerFilter);</span><br><span class="line">        <span class="keyword">if</span> (DexFile.isProfileGuidedCompilerFilter(targetCompilerFilter)) &#123;</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> IllegalStateException(targetCompilerFilter);</span><br><span class="line">        &#125;</span><br><span class="line">        isProfileGuidedFilter = <span class="keyword">false</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// If we're asked to take profile updates into account, check now.</span></span><br><span class="line">    <span class="keyword">boolean</span> newProfile = <span class="keyword">false</span>;</span><br><span class="line">    <span class="keyword">if</span> (checkProfiles &amp;&amp; isProfileGuidedFilter) &#123;</span><br><span class="line">        <span class="comment">// Merge profiles, see if we need to do anything.</span></span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            newProfile = mInstaller.mergeProfiles(sharedGid, pkg.packageName);</span><br><span class="line">        &#125; <span class="keyword">catch</span> (InstallerException e) &#123;</span><br><span class="line">            Slog.w(TAG, <span class="string">"Failed to merge profiles"</span>, e);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">final</span> <span class="keyword">boolean</span> vmSafeMode = (pkg.applicationInfo.flags &amp; ApplicationInfo.FLAG_VM_SAFE_MODE) != <span class="number">0</span>;</span><br><span class="line">    <span class="keyword">final</span> <span class="keyword">boolean</span> debuggable = (pkg.applicationInfo.flags &amp; ApplicationInfo.FLAG_DEBUGGABLE) != <span class="number">0</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">boolean</span> performedDexOpt = <span class="keyword">false</span>;</span><br><span class="line">    <span class="keyword">boolean</span> successfulDexOpt = <span class="keyword">true</span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//【5】处理所有指令集下的  Odex 优化！</span></span><br><span class="line">    <span class="keyword">final</span> String[] dexCodeInstructionSets = getDexCodeInstructionSets(instructionSets);</span><br><span class="line">    <span class="keyword">for</span> (String dexCodeInstructionSet : dexCodeInstructionSets) &#123;</span><br><span class="line">        <span class="keyword">for</span> (String path : paths) &#123;</span><br><span class="line">            <span class="keyword">int</span> dexoptNeeded;</span><br><span class="line">            <span class="keyword">try</span> &#123;</span><br><span class="line">                <span class="comment">//【5.1】判断是否有必要做 Odex 优化，结果保存到 dexoptNeeded！</span></span><br><span class="line">                dexoptNeeded = DexFile.getDexOptNeeded(path,</span><br><span class="line">                        dexCodeInstructionSet, targetCompilerFilter, newProfile);</span><br><span class="line">            &#125; <span class="keyword">catch</span> (IOException ioe) &#123;</span><br><span class="line">                Slog.w(TAG, <span class="string">"IOException reading apk: "</span> + path, ioe);</span><br><span class="line">                <span class="keyword">return</span> DEX_OPT_FAILED;</span><br><span class="line">            &#125;</span><br><span class="line">            dexoptNeeded = adjustDexoptNeeded(dexoptNeeded); <span class="comment">// 返回自身！</span></span><br><span class="line">            <span class="keyword">if</span> (PackageManagerService.DEBUG_DEXOPT) &#123;</span><br><span class="line">                Log.i(TAG, <span class="string">"DexoptNeeded for "</span> + path + <span class="string">"@"</span> + targetCompilerFilter + <span class="string">" is "</span> +</span><br><span class="line">                        dexoptNeeded);</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            <span class="keyword">final</span> String dexoptType;</span><br><span class="line">            String oatDir = <span class="keyword">null</span>;</span><br><span class="line">            <span class="comment">//【5.2】处理 dexoptNeeded 结果！</span></span><br><span class="line">            <span class="keyword">switch</span> (dexoptNeeded) &#123;</span><br><span class="line">                <span class="keyword">case</span> DexFile.NO_DEXOPT_NEEDED: </span><br><span class="line">                    <span class="comment">// 如果是 NO_DEXOPT_NEEDED，不需要优化，跳过；</span></span><br><span class="line">                    <span class="keyword">continue</span>;</span><br><span class="line">                <span class="keyword">case</span> DexFile.DEX2OAT_NEEDED: </span><br><span class="line">                    <span class="comment">// 如果是 DEX2OAT_NEEDED，需要优化，类型为 dex2oat！</span></span><br><span class="line">                    <span class="comment">//【4.2.2.3.1.1】并创建 oat 目标目录！ </span></span><br><span class="line">                    dexoptType = <span class="string">"dex2oat"</span>;</span><br><span class="line">                    oatDir = createOatDirIfSupported(pkg, dexCodeInstructionSet);</span><br><span class="line">                    <span class="keyword">break</span>;</span><br><span class="line">                <span class="keyword">case</span> DexFile.PATCHOAT_NEEDED:</span><br><span class="line">                    <span class="comment">// 如果是 PATCHOAT_NEEDED，需要优化，类型为 patchoat！</span></span><br><span class="line">                    dexoptType = <span class="string">"patchoat"</span>;</span><br><span class="line">                    <span class="keyword">break</span>;</span><br><span class="line">                <span class="keyword">case</span> DexFile.SELF_PATCHOAT_NEEDED:</span><br><span class="line">                    <span class="comment">// 如果是 SELF_PATCHOAT_NEEDED，需要优化，类型为 self patchoat！</span></span><br><span class="line">                    dexoptType = <span class="string">"self patchoat"</span>;</span><br><span class="line">                    <span class="keyword">break</span>;</span><br><span class="line">                <span class="keyword">default</span>:</span><br><span class="line">                    <span class="keyword">throw</span> <span class="keyword">new</span> IllegalStateException(<span class="string">"Invalid dexopt:"</span> + dexoptNeeded);</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            String sharedLibrariesPath = <span class="keyword">null</span>;</span><br><span class="line">            <span class="keyword">if</span> (sharedLibraries != <span class="keyword">null</span> &amp;&amp; sharedLibraries.length != <span class="number">0</span>) &#123;</span><br><span class="line">                StringBuilder sb = <span class="keyword">new</span> StringBuilder();</span><br><span class="line">                <span class="keyword">for</span> (String lib : sharedLibraries) &#123;</span><br><span class="line">                    <span class="keyword">if</span> (sb.length() != <span class="number">0</span>) &#123;</span><br><span class="line">                        sb.append(<span class="string">":"</span>);</span><br><span class="line">                    &#125;</span><br><span class="line">                    sb.append(lib);</span><br><span class="line">                &#125;</span><br><span class="line">                sharedLibrariesPath = sb.toString();</span><br><span class="line">            &#125;</span><br><span class="line">            </span><br><span class="line">            Log.i(TAG, <span class="string">"Running dexopt ("</span> + dexoptType + <span class="string">") on: "</span> + path + <span class="string">" pkg="</span></span><br><span class="line">                    + pkg.applicationInfo.packageName + <span class="string">" isa="</span> + dexCodeInstructionSet</span><br><span class="line">                    + <span class="string">" vmSafeMode="</span> + vmSafeMode + <span class="string">" debuggable="</span> + debuggable</span><br><span class="line">                    + <span class="string">" target-filter="</span> + targetCompilerFilter + <span class="string">" oatDir = "</span> + oatDir</span><br><span class="line">                    + <span class="string">" sharedLibraries="</span> + sharedLibrariesPath);</span><br><span class="line">                    </span><br><span class="line">            <span class="comment">// Profile guide compiled oat files should not be public.</span></span><br><span class="line">            <span class="keyword">final</span> <span class="keyword">boolean</span> isPublic = !pkg.isForwardLocked() &amp;&amp; !isProfileGuidedFilter;</span><br><span class="line">            <span class="keyword">final</span> <span class="keyword">int</span> profileFlag = isProfileGuidedFilter ? DEXOPT_PROFILE_GUIDED : <span class="number">0</span>;</span><br><span class="line">            <span class="keyword">final</span> <span class="keyword">int</span> dexFlags = adjustDexoptFlags(</span><br><span class="line">                    ( isPublic ? DEXOPT_PUBLIC : <span class="number">0</span>)</span><br><span class="line">                    | (vmSafeMode ? DEXOPT_SAFEMODE : <span class="number">0</span>)</span><br><span class="line">                    | (debuggable ? DEXOPT_DEBUGGABLE : <span class="number">0</span>)</span><br><span class="line">                    | profileFlag</span><br><span class="line">                    | DEXOPT_BOOTCOMPLETE);</span><br><span class="line"></span><br><span class="line">            <span class="keyword">try</span> &#123;</span><br><span class="line">                <span class="keyword">long</span> startTime = System.currentTimeMillis();</span><br><span class="line">                <span class="comment">//【5.3】执行 Odex 优化！</span></span><br><span class="line">                mInstaller.dexopt(path, sharedGid, pkg.packageName, dexCodeInstructionSet,</span><br><span class="line">                        dexoptNeeded, oatDir, dexFlags, targetCompilerFilter, pkg.volumeUuid,</span><br><span class="line">                        sharedLibrariesPath);</span><br><span class="line">                performedDexOpt = <span class="keyword">true</span>;</span><br><span class="line"></span><br><span class="line">                <span class="keyword">if</span> (packageStats != <span class="keyword">null</span>) &#123;</span><br><span class="line">                    <span class="keyword">long</span> endTime = System.currentTimeMillis();</span><br><span class="line">                    packageStats.setCompileTime(path, (<span class="keyword">int</span>)(endTime - startTime));</span><br><span class="line">                &#125;</span><br><span class="line">            &#125; <span class="keyword">catch</span> (InstallerException e) &#123;</span><br><span class="line">                Slog.w(TAG, <span class="string">"Failed to dexopt"</span>, e);</span><br><span class="line">                successfulDexOpt = <span class="keyword">false</span>; <span class="comment">// 如果有异常，successfulDexOpt 为 false！</span></span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">//【6】处理 Odex 优化结果，如果 successfulDexOpt 为 true，说明执行 Odex 的过程中没有发生错误！</span></span><br><span class="line">    <span class="comment">// 然后还要处理 performedDexOpt，如果为 true，表示 Odex 优化成功，返回 DEX_OPT_PERFORMED！</span></span><br><span class="line">    <span class="comment">// 否则，直接返回 DEX_OPT_SKIPPED 表示无需 Odex 优化，直接跳过！</span></span><br><span class="line">    <span class="keyword">if</span> (successfulDexOpt) &#123;</span><br><span class="line">        <span class="keyword">return</span> performedDexOpt ? DEX_OPT_PERFORMED : DEX_OPT_SKIPPED;</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> DEX_OPT_FAILED;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>整个流程很清晰，不多说！</p>
<h6 id="4-2-2-3-1-1-PackageDexOptimizer-createOatDirIfSupported"><a href="#4-2-2-3-1-1-PackageDexOptimizer-createOatDirIfSupported" class="headerlink" title="4.2.2.3.1.1 PackageDexOptimizer.createOatDirIfSupported"></a>4.2.2.3.1.1 PackageDexOptimizer.createOatDirIfSupported</h6><p>createOatDirIfSupported 方法用于创建 oat 目录！<br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Nullable</span></span><br><span class="line"><span class="function"><span class="keyword">private</span> String <span class="title">createOatDirIfSupported</span><span class="params">(PackageParser.Package pkg, String dexInstructionSet)</span> </span>&#123;</span><br><span class="line">    <span class="comment">//【1】如果应用不能有 oat 文件，返回 null！</span></span><br><span class="line">    <span class="keyword">if</span> (!pkg.canHaveOatDir()) &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">null</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    File codePath = <span class="keyword">new</span> File(pkg.codePath);</span><br><span class="line">    <span class="keyword">if</span> (codePath.isDirectory()) &#123;</span><br><span class="line">        <span class="comment">//【2】创建 oat 目录！</span></span><br><span class="line">        File oatDir = getOatDir(codePath);</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            <span class="comment">// 这里的 oatDir 为 /data/app/&lt;packageName&gt;/oat</span></span><br><span class="line">            <span class="comment">// 而 dexInstructionSet 为 arm/arm64</span></span><br><span class="line">            mInstaller.createOatDir(oatDir.getAbsolutePath(), dexInstructionSet);</span><br><span class="line">        &#125; <span class="keyword">catch</span> (InstallerException e) &#123;</span><br><span class="line">            Slog.w(TAG, <span class="string">"Failed to create oat dir"</span>, e);</span><br><span class="line">            <span class="keyword">return</span> <span class="keyword">null</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> oatDir.getAbsolutePath();</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">null</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>PackageParser.Package.canHaveOatDir 方法用于判断该应用是否能够有 oat 目录！<br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">boolean</span> <span class="title">canHaveOatDir</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    <span class="comment">// 要能有 oat 目录，必须要满足 2 个条件；</span></span><br><span class="line">    <span class="comment">// 1、不是 system app，或者是被更新过的 system app；</span></span><br><span class="line">    <span class="comment">// 2、同时不能是 forward-locked app，并且不能被安装在 external 上!</span></span><br><span class="line">    <span class="keyword">return</span> (!isSystemApp() || isUpdatedSystemApp())</span><br><span class="line">            &amp;&amp; !isForwardLocked() &amp;&amp; !applicationInfo.isExternalAsec();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<h1 id="5-PackageMS-systemReady-进入最终阶段"><a href="#5-PackageMS-systemReady-进入最终阶段" class="headerlink" title="5 PackageMS.systemReady - 进入最终阶段"></a>5 PackageMS.systemReady - 进入最终阶段</h1><p>在 SystemServer.startOtherServices 中，最后，会调用 systemReady 方法，进入 PackageManagerService 启动的最终阶段！<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">Trace.traceBegin(Trace.TRACE_TAG_SYSTEM_SERVER, &quot;MakePackageManagerServiceReady&quot;);</span><br><span class="line">try &#123;</span><br><span class="line">    mPackageManagerService.systemReady();</span><br><span class="line">&#125; catch (Throwable e) &#123;</span><br><span class="line">    reportWtf(&quot;making Package Manager Service ready&quot;, e);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>当系统准备完成后，会调用到 PackageManagerService 的 systemReady 方法！<br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">systemReady</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    mSystemReady = <span class="keyword">true</span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// Disable any carrier apps. We do this very early in boot to prevent the apps from being</span></span><br><span class="line">    <span class="comment">// disabled after already being started.</span></span><br><span class="line">    CarrierAppUtils.disableCarrierAppsUntilPrivileged(mContext.getOpPackageName(), <span class="keyword">this</span>,</span><br><span class="line">            mContext.getContentResolver(), UserHandle.USER_SYSTEM);</span><br><span class="line"></span><br><span class="line">    <span class="comment">// Read the compatibilty setting when the system is ready.</span></span><br><span class="line">    <span class="keyword">boolean</span> compatibilityModeEnabled = android.provider.Settings.Global.getInt(</span><br><span class="line">            mContext.getContentResolver(),</span><br><span class="line">            android.provider.Settings.Global.COMPATIBILITY_MODE, <span class="number">1</span>) == <span class="number">1</span>;</span><br><span class="line">    PackageParser.setCompatibilityModeEnabled(compatibilityModeEnabled);</span><br><span class="line">    <span class="keyword">if</span> (DEBUG_SETTINGS) &#123;</span><br><span class="line">        Log.d(TAG, <span class="string">"compatibility mode:"</span> + compatibilityModeEnabled);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">//【1】该集合表示需要默认授予运行时权限的 userId！</span></span><br><span class="line">    <span class="keyword">int</span>[] grantPermissionsUserIds = EMPTY_INT_ARRAY;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">synchronized</span> (mPackages) &#123;</span><br><span class="line">        <span class="comment">//【1】移除那些已经不存在的 preferred activity </span></span><br><span class="line">        ArrayList&lt;PreferredActivity&gt; removed = <span class="keyword">new</span> ArrayList&lt;PreferredActivity&gt;();</span><br><span class="line">        <span class="keyword">for</span> (<span class="keyword">int</span> i=<span class="number">0</span>; i&lt;mSettings.mPreferredActivities.size(); i++) &#123;</span><br><span class="line">            PreferredIntentResolver pir = mSettings.mPreferredActivities.valueAt(i);</span><br><span class="line">            removed.clear();</span><br><span class="line">            <span class="keyword">for</span> (PreferredActivity pa : pir.filterSet()) &#123;</span><br><span class="line">                <span class="keyword">if</span> (mActivities.mActivities.get(pa.mPref.mComponent) == <span class="keyword">null</span>) &#123;</span><br><span class="line">                    removed.add(pa);</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="comment">// 移除这些不存在的 preferred activity 在系统中的关联！</span></span><br><span class="line">            <span class="keyword">if</span> (removed.size() &gt; <span class="number">0</span>) &#123;</span><br><span class="line">                <span class="keyword">for</span> (<span class="keyword">int</span> r=<span class="number">0</span>; r&lt;removed.size(); r++) &#123;</span><br><span class="line">                    PreferredActivity pa = removed.get(r);</span><br><span class="line">                    Slog.w(TAG, <span class="string">"Removing dangling preferred activity: "</span></span><br><span class="line">                            + pa.mPref.mComponent);</span><br><span class="line">                    pir.removeFilter(pa);</span><br><span class="line">                &#125;</span><br><span class="line">                <span class="comment">// 更新偏好设置！</span></span><br><span class="line">                mSettings.writePackageRestrictionsLPr(</span><br><span class="line">                        mSettings.mPreferredActivities.keyAt(i));</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        </span><br><span class="line">        <span class="comment">// 返回需要授予默认权限的 userId 集合！，其实就是访问 mDefaultPermissionsGranted 在指定的 userId 下的值</span></span><br><span class="line">        <span class="comment">// 如果指定 userId 返回 false，表示发生了系统升级，那么我们会执行默认运行时权限授予！！</span></span><br><span class="line">        <span class="keyword">for</span> (<span class="keyword">int</span> userId : UserManagerService.getInstance().getUserIds()) &#123;</span><br><span class="line">            <span class="keyword">if</span> (!mSettings.areDefaultRuntimePermissionsGrantedLPr(userId)) &#123;</span><br><span class="line">                grantPermissionsUserIds = ArrayUtils.appendInt(</span><br><span class="line">                        grantPermissionsUserIds, userId);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// 通知 userManager 系统准备完毕！</span></span><br><span class="line">    sUserManager.systemReady();</span><br><span class="line"></span><br><span class="line">    <span class="comment">//【5.1】执行默认授予运行时权限的操作！</span></span><br><span class="line">    <span class="keyword">for</span> (<span class="keyword">int</span> userId : grantPermissionsUserIds) &#123;</span><br><span class="line">        mDefaultPermissionPolicy.grantDefaultPermissions(userId);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 如果没有默认授予运行时权限给指定的 userId，那么我们会直接读取 default-permissions 目录中的文件</span></span><br><span class="line">    <span class="comment">// 初始化 mGrantExceptions，和上面的过程类似，不关注！</span></span><br><span class="line">    <span class="keyword">if</span> (grantPermissionsUserIds == EMPTY_INT_ARRAY) &#123;</span><br><span class="line">        <span class="comment">// 该方法会发送 MSG_READ_DEFAULT_PERMISSION_EXCEPTIONS 消息给内部的 Handler</span></span><br><span class="line">        <span class="comment">// 然后会调用：readDefaultPermissionExceptionsLPw 方法！</span></span><br><span class="line">        mDefaultPermissionPolicy.scheduleReadDefaultPermissionExceptions();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 处理 mPostSystemReadyMessages 中的 START_CLEANING_PACKAGE 消息，这些消息是在 delete/remove package</span></span><br><span class="line">    <span class="comment">// 的时候添加进来的！！</span></span><br><span class="line">    <span class="keyword">if</span> (mPostSystemReadyMessages != <span class="keyword">null</span>) &#123;</span><br><span class="line">        <span class="keyword">for</span> (Message msg : mPostSystemReadyMessages) &#123;</span><br><span class="line">            msg.sendToTarget();</span><br><span class="line">        &#125;</span><br><span class="line">        mPostSystemReadyMessages = <span class="keyword">null</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 注册存储监听器，持续监听存储变化！</span></span><br><span class="line">    <span class="keyword">final</span> StorageManager storage = mContext.getSystemService(StorageManager.class);</span><br><span class="line">    storage.registerListener(mStorageListener);</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 通知 PackageInstallerService 和 PackageDexOptimizer 系统准备完成！</span></span><br><span class="line">    <span class="comment">// PackageDexOptimizer 是用于执行 odex 优化的，后续我们会看到！</span></span><br><span class="line">    mInstallerService.systemReady();</span><br><span class="line">    mPackageDexOptimizer.systemReady();</span><br><span class="line"></span><br><span class="line">    MountServiceInternal mountServiceInternal = LocalServices.getService(</span><br><span class="line">            MountServiceInternal.class);</span><br><span class="line">    mountServiceInternal.addExternalStoragePolicy(</span><br><span class="line">            <span class="keyword">new</span> MountServiceInternal.ExternalStorageMountPolicy() &#123;</span><br><span class="line">        <span class="meta">@Override</span></span><br><span class="line">        <span class="function"><span class="keyword">public</span> <span class="keyword">int</span> <span class="title">getMountMode</span><span class="params">(<span class="keyword">int</span> uid, String packageName)</span> </span>&#123;</span><br><span class="line">            <span class="keyword">if</span> (Process.isIsolated(uid)) &#123;</span><br><span class="line">                <span class="keyword">return</span> Zygote.MOUNT_EXTERNAL_NONE;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">if</span> (checkUidPermission(WRITE_MEDIA_STORAGE, uid) == PERMISSION_GRANTED) &#123;</span><br><span class="line">                <span class="keyword">return</span> Zygote.MOUNT_EXTERNAL_DEFAULT;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">if</span> (checkUidPermission(READ_EXTERNAL_STORAGE, uid) == PERMISSION_DENIED) &#123;</span><br><span class="line">                <span class="keyword">return</span> Zygote.MOUNT_EXTERNAL_DEFAULT;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">if</span> (checkUidPermission(WRITE_EXTERNAL_STORAGE, uid) == PERMISSION_DENIED) &#123;</span><br><span class="line">                <span class="keyword">return</span> Zygote.MOUNT_EXTERNAL_READ;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">return</span> Zygote.MOUNT_EXTERNAL_WRITE;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="meta">@Override</span></span><br><span class="line">        <span class="function"><span class="keyword">public</span> <span class="keyword">boolean</span> <span class="title">hasExternalStorage</span><span class="params">(<span class="keyword">int</span> uid, String packageName)</span> </span>&#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="keyword">true</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;);</span><br><span class="line"></span><br><span class="line">    <span class="comment">//【5.2】清楚哪些无效不用的用户和应用！</span></span><br><span class="line">    reconcileUsers(StorageManager.UUID_PRIVATE_INTERNAL);</span><br><span class="line">    reconcileApps(StorageManager.UUID_PRIVATE_INTERNAL);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<h2 id="5-1-DefaultPermissionGrantPolicy-grantDefaultPermissions-默认运行时权限授予"><a href="#5-1-DefaultPermissionGrantPolicy-grantDefaultPermissions-默认运行时权限授予" class="headerlink" title="5.1 DefaultPermissionGrantPolicy.grantDefaultPermissions - 默认运行时权限授予"></a>5.1 DefaultPermissionGrantPolicy.grantDefaultPermissions - 默认运行时权限授予</h2><p>前面有讲过 DefaultPermissionGrantPolicy 用来处理默认授予系统应用相应的运行时权限的！<br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">grantDefaultPermissions</span><span class="params">(<span class="keyword">int</span> userId)</span> </span>&#123;</span><br><span class="line">    <span class="comment">//【5.1.1】默认授予系统组件和 pri app 相应的运行时权限！</span></span><br><span class="line">    grantPermissionsToSysComponentsAndPrivApps(userId);</span><br><span class="line">    <span class="comment">//【5.1.2】默认授予系统中的一些重要应用包相应的运行时权限！</span></span><br><span class="line">    grantDefaultSystemHandlerPermissions(userId);</span><br><span class="line">    <span class="comment">//【5.1.3】处理之前授予异常的情况！</span></span><br><span class="line">    grantDefaultPermissionExceptions(userId);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>我们来一个一个分析！</p>
<p>下面分析过程中，我们把 DefaultPermissionGrantPolicy 简称为 DPGrantPolicy</p>
<h3 id="5-1-1-DPGrantPolicy-grantPermissionsToSysComponentsAndPrivApps"><a href="#5-1-1-DPGrantPolicy-grantPermissionsToSysComponentsAndPrivApps" class="headerlink" title="5.1.1 DPGrantPolicy.grantPermissionsToSysComponentsAndPrivApps"></a>5.1.1 DPGrantPolicy.grantPermissionsToSysComponentsAndPrivApps</h3><p>授予系统组件和私有应用默认权限！</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">grantPermissionsToSysComponentsAndPrivApps</span><span class="params">(<span class="keyword">int</span> userId)</span> </span>&#123;</span><br><span class="line">    Log.i(TAG, <span class="string">"Granting permissions to platform components for user "</span> + userId);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">synchronized</span> (mService.mPackages) &#123;</span><br><span class="line">        <span class="keyword">for</span> (PackageParser.Package pkg : mService.mPackages.values()) &#123;</span><br><span class="line">            <span class="comment">//【5.1.1.1/2】跳过那些非系统或者非私有应用，或者不支持运行时权限，或者没有请求运行时权限的应用</span></span><br><span class="line">            <span class="keyword">if</span> (!isSysComponentOrPersistentPlatformSignedPrivAppLPr(pkg)</span><br><span class="line">                    || !doesPackageSupportRuntimePermissions(pkg)</span><br><span class="line">                    || pkg.requestedPermissions.isEmpty()) &#123;</span><br><span class="line">                <span class="keyword">continue</span>;</span><br><span class="line">            &#125;</span><br><span class="line">            Set&lt;String&gt; permissions = <span class="keyword">new</span> ArraySet&lt;&gt;();</span><br><span class="line">            <span class="keyword">final</span> <span class="keyword">int</span> permissionCount = pkg.requestedPermissions.size();</span><br><span class="line">            <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; permissionCount; i++) &#123;</span><br><span class="line">                String permission = pkg.requestedPermissions.get(i);</span><br><span class="line">                BasePermission bp = mService.mSettings.mPermissions.get(permission);</span><br><span class="line">                <span class="comment">// 如果是运行时权限的话，添加到集合中！</span></span><br><span class="line">                <span class="keyword">if</span> (bp != <span class="keyword">null</span> &amp;&amp; bp.isRuntime()) &#123;</span><br><span class="line">                    permissions.add(permission);</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="comment">//【5.1.1.3】默认授予运行时权限，不需要请求！！</span></span><br><span class="line">            <span class="keyword">if</span> (!permissions.isEmpty()) &#123;</span><br><span class="line">                grantRuntimePermissionsLPw(pkg, permissions, <span class="keyword">true</span>, userId);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>直接授予权限即可！</p>
<h4 id="5-1-1-1-DPGrantPolicy-isSysComponentOrPersistentPlatformSignedPrivAppLPr"><a href="#5-1-1-1-DPGrantPolicy-isSysComponentOrPersistentPlatformSignedPrivAppLPr" class="headerlink" title="5.1.1.1 DPGrantPolicy.isSysComponentOrPersistentPlatformSignedPrivAppLPr"></a>5.1.1.1 DPGrantPolicy.isSysComponentOrPersistentPlatformSignedPrivAppLPr</h4><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">boolean</span> <span class="title">isSysComponentOrPersistentPlatformSignedPrivAppLPr</span><span class="params">(PackageParser.Package pkg)</span> </span>&#123;</span><br><span class="line">    <span class="comment">//【1】apk 的 uid 小于 FIRST_APPLICATION_UID，那么返回 true，不跳过！</span></span><br><span class="line">    <span class="keyword">if</span> (UserHandle.getAppId(pkg.applicationInfo.uid) &lt; FIRST_APPLICATION_UID) &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">true</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">//【2】如果不是 privileged App，返回 false，会跳过！</span></span><br><span class="line">    <span class="keyword">if</span> (!pkg.isPrivilegedApp()) &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">false</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">//【3】如果其没有 ApplicationInfo.FLAG_PERSISTENT 标志位，返回 false，会跳过！</span></span><br><span class="line">    PackageSetting sysPkg = mService.mSettings.getDisabledSystemPkgLPr(pkg.packageName);</span><br><span class="line">    <span class="keyword">if</span> (sysPkg != <span class="keyword">null</span> &amp;&amp; sysPkg.pkg != <span class="keyword">null</span>) &#123;</span><br><span class="line">        <span class="keyword">if</span> ((sysPkg.pkg.applicationInfo.flags &amp; ApplicationInfo.FLAG_PERSISTENT) == <span class="number">0</span>) &#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="keyword">false</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125; <span class="keyword">else</span> <span class="keyword">if</span> ((pkg.applicationInfo.flags &amp; ApplicationInfo.FLAG_PERSISTENT) == <span class="number">0</span>) &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">false</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// 最后，匹配签名，如果应用是系统平台签名，返回 true，不跳过！</span></span><br><span class="line">    <span class="keyword">return</span> PackageManagerService.compareSignatures(mService.mPlatformPackage.mSignatures,</span><br><span class="line">            pkg.mSignatures) == PackageManager.SIGNATURE_MATCH;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>上面的逻辑就不多说了！</p>
<h4 id="5-1-1-2-DPGrantPolicy-doesPackageSupportRuntimePermissions"><a href="#5-1-1-2-DPGrantPolicy-doesPackageSupportRuntimePermissions" class="headerlink" title="5.1.1.2 DPGrantPolicy.doesPackageSupportRuntimePermissions"></a>5.1.1.2 DPGrantPolicy.doesPackageSupportRuntimePermissions</h4><p>判断该 package 是否支持运行时权限！<br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">boolean</span> <span class="title">doesPackageSupportRuntimePermissions</span><span class="params">(PackageParser.Package pkg)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">return</span> pkg.applicationInfo.targetSdkVersion &gt; Build.VERSION_CODES.LOLLIPOP_MR1;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>即：如果目标 sdk 大于 Android5.1，那就是支持，返回 true！</p>
<h3 id="5-1-2-DPGrantPolicy-grantDefaultSystemHandlerPermissions"><a href="#5-1-2-DPGrantPolicy-grantDefaultSystemHandlerPermissions" class="headerlink" title="5.1.2 DPGrantPolicy.grantDefaultSystemHandlerPermissions"></a>5.1.2 DPGrantPolicy.grantDefaultSystemHandlerPermissions</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br><span class="line">212</span><br><span class="line">213</span><br><span class="line">214</span><br><span class="line">215</span><br><span class="line">216</span><br><span class="line">217</span><br><span class="line">218</span><br><span class="line">219</span><br><span class="line">220</span><br><span class="line">221</span><br><span class="line">222</span><br><span class="line">223</span><br><span class="line">224</span><br><span class="line">225</span><br><span class="line">226</span><br><span class="line">227</span><br><span class="line">228</span><br><span class="line">229</span><br><span class="line">230</span><br><span class="line">231</span><br><span class="line">232</span><br><span class="line">233</span><br><span class="line">234</span><br><span class="line">235</span><br><span class="line">236</span><br><span class="line">237</span><br><span class="line">238</span><br><span class="line">239</span><br><span class="line">240</span><br><span class="line">241</span><br><span class="line">242</span><br><span class="line">243</span><br><span class="line">244</span><br><span class="line">245</span><br><span class="line">246</span><br><span class="line">247</span><br><span class="line">248</span><br><span class="line">249</span><br><span class="line">250</span><br><span class="line">251</span><br><span class="line">252</span><br><span class="line">253</span><br><span class="line">254</span><br><span class="line">255</span><br><span class="line">256</span><br><span class="line">257</span><br><span class="line">258</span><br><span class="line">259</span><br><span class="line">260</span><br><span class="line">261</span><br><span class="line">262</span><br><span class="line">263</span><br><span class="line">264</span><br><span class="line">265</span><br><span class="line">266</span><br><span class="line">267</span><br><span class="line">268</span><br><span class="line">269</span><br><span class="line">270</span><br><span class="line">271</span><br><span class="line">272</span><br><span class="line">273</span><br><span class="line">274</span><br><span class="line">275</span><br><span class="line">276</span><br><span class="line">277</span><br><span class="line">278</span><br><span class="line">279</span><br><span class="line">280</span><br><span class="line">281</span><br><span class="line">282</span><br><span class="line">283</span><br><span class="line">284</span><br><span class="line">285</span><br><span class="line">286</span><br><span class="line">287</span><br><span class="line">288</span><br><span class="line">289</span><br><span class="line">290</span><br><span class="line">291</span><br><span class="line">292</span><br><span class="line">293</span><br><span class="line">294</span><br><span class="line">295</span><br><span class="line">296</span><br><span class="line">297</span><br><span class="line">298</span><br><span class="line">299</span><br><span class="line">300</span><br><span class="line">301</span><br><span class="line">302</span><br><span class="line">303</span><br><span class="line">304</span><br><span class="line">305</span><br><span class="line">306</span><br><span class="line">307</span><br><span class="line">308</span><br><span class="line">309</span><br><span class="line">310</span><br><span class="line">311</span><br><span class="line">312</span><br><span class="line">313</span><br><span class="line">314</span><br><span class="line">315</span><br><span class="line">316</span><br><span class="line">317</span><br><span class="line">318</span><br><span class="line">319</span><br><span class="line">320</span><br><span class="line">321</span><br><span class="line">322</span><br><span class="line">323</span><br><span class="line">324</span><br><span class="line">325</span><br><span class="line">326</span><br><span class="line">327</span><br><span class="line">328</span><br><span class="line">329</span><br><span class="line">330</span><br><span class="line">331</span><br><span class="line">332</span><br><span class="line">333</span><br><span class="line">334</span><br><span class="line">335</span><br><span class="line">336</span><br><span class="line">337</span><br><span class="line">338</span><br><span class="line">339</span><br><span class="line">340</span><br><span class="line">341</span><br><span class="line">342</span><br><span class="line">343</span><br><span class="line">344</span><br><span class="line">345</span><br><span class="line">346</span><br><span class="line">347</span><br><span class="line">348</span><br><span class="line">349</span><br><span class="line">350</span><br><span class="line">351</span><br><span class="line">352</span><br><span class="line">353</span><br><span class="line">354</span><br><span class="line">355</span><br><span class="line">356</span><br><span class="line">357</span><br><span class="line">358</span><br><span class="line">359</span><br><span class="line">360</span><br><span class="line">361</span><br><span class="line">362</span><br><span class="line">363</span><br><span class="line">364</span><br><span class="line">365</span><br><span class="line">366</span><br><span class="line">367</span><br><span class="line">368</span><br><span class="line">369</span><br><span class="line">370</span><br><span class="line">371</span><br><span class="line">372</span><br><span class="line">373</span><br><span class="line">374</span><br><span class="line">375</span><br><span class="line">376</span><br><span class="line">377</span><br><span class="line">378</span><br><span class="line">379</span><br><span class="line">380</span><br><span class="line">381</span><br><span class="line">382</span><br><span class="line">383</span><br><span class="line">384</span><br><span class="line">385</span><br><span class="line">386</span><br><span class="line">387</span><br><span class="line">388</span><br><span class="line">389</span><br><span class="line">390</span><br><span class="line">391</span><br><span class="line">392</span><br><span class="line">393</span><br><span class="line">394</span><br><span class="line">395</span><br><span class="line">396</span><br><span class="line">397</span><br><span class="line">398</span><br><span class="line">399</span><br><span class="line">400</span><br><span class="line">401</span><br><span class="line">402</span><br><span class="line">403</span><br><span class="line">404</span><br><span class="line">405</span><br><span class="line">406</span><br><span class="line">407</span><br><span class="line">408</span><br><span class="line">409</span><br><span class="line">410</span><br><span class="line">411</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">grantDefaultSystemHandlerPermissions</span><span class="params">(<span class="keyword">int</span> userId)</span> </span>&#123;</span><br><span class="line">    Log.i(TAG, <span class="string">"Granting permissions to default platform handlers for user "</span> + userId);</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// 这些 PackagesProvider 就是其他服务通过 PackageManagerInternalImpl 注册到 pms 内部的！</span></span><br><span class="line">    <span class="keyword">final</span> PackagesProvider locationPackagesProvider;</span><br><span class="line">    <span class="keyword">final</span> PackagesProvider voiceInteractionPackagesProvider;</span><br><span class="line">    <span class="keyword">final</span> PackagesProvider smsAppPackagesProvider;</span><br><span class="line">    <span class="keyword">final</span> PackagesProvider dialerAppPackagesProvider;</span><br><span class="line">    <span class="keyword">final</span> PackagesProvider simCallManagerPackagesProvider;</span><br><span class="line">    <span class="keyword">final</span> SyncAdapterPackagesProvider syncAdapterPackagesProvider;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">synchronized</span> (mService.mPackages) &#123;</span><br><span class="line">        locationPackagesProvider = mLocationPackagesProvider;</span><br><span class="line">        voiceInteractionPackagesProvider = mVoiceInteractionPackagesProvider;</span><br><span class="line">        smsAppPackagesProvider = mSmsAppPackagesProvider;</span><br><span class="line">        dialerAppPackagesProvider = mDialerAppPackagesProvider;</span><br><span class="line">        simCallManagerPackagesProvider = mSimCallManagerPackagesProvider;</span><br><span class="line">        syncAdapterPackagesProvider = mSyncAdapterPackagesProvider;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    String[] voiceInteractPackageNames = (voiceInteractionPackagesProvider != <span class="keyword">null</span>)</span><br><span class="line">            ? voiceInteractionPackagesProvider.getPackages(userId) : <span class="keyword">null</span>;</span><br><span class="line">    String[] locationPackageNames = (locationPackagesProvider != <span class="keyword">null</span>)</span><br><span class="line">            ? locationPackagesProvider.getPackages(userId) : <span class="keyword">null</span>;</span><br><span class="line">    String[] smsAppPackageNames = (smsAppPackagesProvider != <span class="keyword">null</span>)</span><br><span class="line">            ? smsAppPackagesProvider.getPackages(userId) : <span class="keyword">null</span>;</span><br><span class="line">    String[] dialerAppPackageNames = (dialerAppPackagesProvider != <span class="keyword">null</span>)</span><br><span class="line">            ? dialerAppPackagesProvider.getPackages(userId) : <span class="keyword">null</span>;</span><br><span class="line">    String[] simCallManagerPackageNames = (simCallManagerPackagesProvider != <span class="keyword">null</span>)</span><br><span class="line">            ? simCallManagerPackagesProvider.getPackages(userId) : <span class="keyword">null</span>;</span><br><span class="line">    String[] contactsSyncAdapterPackages = (syncAdapterPackagesProvider != <span class="keyword">null</span>) ?</span><br><span class="line">            syncAdapterPackagesProvider.getPackages(ContactsContract.AUTHORITY, userId) : <span class="keyword">null</span>;</span><br><span class="line">    String[] calendarSyncAdapterPackages = (syncAdapterPackagesProvider != <span class="keyword">null</span>) ?</span><br><span class="line">            syncAdapterPackagesProvider.getPackages(CalendarContract.AUTHORITY, userId) : <span class="keyword">null</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">synchronized</span> (mService.mPackages) &#123;</span><br><span class="line">        <span class="comment">//【2】默认授予 PackageInstaller STORAGE_PERMISSIONS 中的所有权限！</span></span><br><span class="line">        PackageParser.Package installerPackage = getSystemPackageLPr(</span><br><span class="line">                mService.mRequiredInstallerPackage);</span><br><span class="line">        <span class="keyword">if</span> (installerPackage != <span class="keyword">null</span></span><br><span class="line">                &amp;&amp; doesPackageSupportRuntimePermissions(installerPackage)) &#123;</span><br><span class="line">            grantRuntimePermissionsLPw(installerPackage, STORAGE_PERMISSIONS, <span class="keyword">true</span>, userId);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment">//【3】默认授予 PackageVerifier STORAGE_PERMISSIONS，PHONE_PERMISSIONS，SMS_PERMISSIONS 中的所有权限！</span></span><br><span class="line">        PackageParser.Package verifierPackage = getSystemPackageLPr(</span><br><span class="line">                mService.mRequiredVerifierPackage);</span><br><span class="line">        <span class="keyword">if</span> (verifierPackage != <span class="keyword">null</span></span><br><span class="line">                &amp;&amp; doesPackageSupportRuntimePermissions(verifierPackage)) &#123;</span><br><span class="line">            grantRuntimePermissionsLPw(verifierPackage, STORAGE_PERMISSIONS, <span class="keyword">true</span>, userId);</span><br><span class="line">            grantRuntimePermissionsLPw(verifierPackage, PHONE_PERMISSIONS, <span class="keyword">false</span>, userId);</span><br><span class="line">            grantRuntimePermissionsLPw(verifierPackage, SMS_PERMISSIONS, <span class="keyword">false</span>, userId);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">//【4】默认授予 SetupWizard PHONE_PERMISSIONS，CONTACTS_PERMISSIONS，LOCATION_PERMISSIONS </span></span><br><span class="line">        <span class="comment">// CAMERA_PERMISSIONS中的所有权限！</span></span><br><span class="line">        PackageParser.Package setupPackage = getSystemPackageLPr(</span><br><span class="line">                mService.mSetupWizardPackage);</span><br><span class="line">        <span class="keyword">if</span> (setupPackage != <span class="keyword">null</span></span><br><span class="line">                &amp;&amp; doesPackageSupportRuntimePermissions(setupPackage)) &#123;</span><br><span class="line">            grantRuntimePermissionsLPw(setupPackage, PHONE_PERMISSIONS, userId);</span><br><span class="line">            grantRuntimePermissionsLPw(setupPackage, CONTACTS_PERMISSIONS, userId);</span><br><span class="line">            grantRuntimePermissionsLPw(setupPackage, LOCATION_PERMISSIONS, userId);</span><br><span class="line">            grantRuntimePermissionsLPw(setupPackage, CAMERA_PERMISSIONS, userId);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment">//【5】默认授予 Camera CAMERA_PERMISSIONS，MICROPHONE_PERMISSIONS，STORAGE_PERMISSIONS 中的所有权限！</span></span><br><span class="line">        Intent cameraIntent = <span class="keyword">new</span> Intent(MediaStore.ACTION_IMAGE_CAPTURE);</span><br><span class="line">        PackageParser.Package cameraPackage = getDefaultSystemHandlerActivityPackageLPr(</span><br><span class="line">                cameraIntent, userId);</span><br><span class="line">        <span class="keyword">if</span> (cameraPackage != <span class="keyword">null</span></span><br><span class="line">                &amp;&amp; doesPackageSupportRuntimePermissions(cameraPackage)) &#123;</span><br><span class="line">            grantRuntimePermissionsLPw(cameraPackage, CAMERA_PERMISSIONS, userId);</span><br><span class="line">            grantRuntimePermissionsLPw(cameraPackage, MICROPHONE_PERMISSIONS, userId);</span><br><span class="line">            grantRuntimePermissionsLPw(cameraPackage, STORAGE_PERMISSIONS, userId);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment">//【6】默认授予 Media provier STORAGE_PERMISSIONS 中的所有权限！</span></span><br><span class="line">        PackageParser.Package mediaStorePackage = getDefaultProviderAuthorityPackageLPr(</span><br><span class="line">                MediaStore.AUTHORITY, userId);</span><br><span class="line">        <span class="keyword">if</span> (mediaStorePackage != <span class="keyword">null</span>) &#123;</span><br><span class="line">            grantRuntimePermissionsLPw(mediaStorePackage, STORAGE_PERMISSIONS, <span class="keyword">true</span>, userId);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment">//【7】默认授予 download provier STORAGE_PERMISSIONS 中的所有权限！</span></span><br><span class="line">        PackageParser.Package downloadsPackage = getDefaultProviderAuthorityPackageLPr(</span><br><span class="line">                <span class="string">"downloads"</span>, userId);</span><br><span class="line">        <span class="keyword">if</span> (downloadsPackage != <span class="keyword">null</span>) &#123;</span><br><span class="line">            grantRuntimePermissionsLPw(downloadsPackage, STORAGE_PERMISSIONS, <span class="keyword">true</span>, userId);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment">//【8】默认授予 Downloads UI STORAGE_PERMISSIONS 中的所有权限！</span></span><br><span class="line">        Intent downloadsUiIntent = <span class="keyword">new</span> Intent(DownloadManager.ACTION_VIEW_DOWNLOADS);</span><br><span class="line">        PackageParser.Package downloadsUiPackage = getDefaultSystemHandlerActivityPackageLPr(</span><br><span class="line">                downloadsUiIntent, userId);</span><br><span class="line">        <span class="keyword">if</span> (downloadsUiPackage != <span class="keyword">null</span></span><br><span class="line">                &amp;&amp; doesPackageSupportRuntimePermissions(downloadsUiPackage)) &#123;</span><br><span class="line">            grantRuntimePermissionsLPw(downloadsUiPackage, STORAGE_PERMISSIONS, <span class="keyword">true</span>, userId);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment">//【9】默认授予 Storage provider STORAGE_PERMISSIONS 中的所有权限！</span></span><br><span class="line">        PackageParser.Package storagePackage = getDefaultProviderAuthorityPackageLPr(</span><br><span class="line">                <span class="string">"com.android.externalstorage.documents"</span>, userId);</span><br><span class="line">        <span class="keyword">if</span> (storagePackage != <span class="keyword">null</span>) &#123;</span><br><span class="line">            grantRuntimePermissionsLPw(storagePackage, STORAGE_PERMISSIONS, <span class="keyword">true</span>, userId);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment">//【10】默认授予 CertInstaller STORAGE_PERMISSIONS 中的所有权限！</span></span><br><span class="line">        Intent certInstallerIntent = <span class="keyword">new</span> Intent(Credentials.INSTALL_ACTION);</span><br><span class="line">        PackageParser.Package certInstallerPackage = getDefaultSystemHandlerActivityPackageLPr(</span><br><span class="line">                certInstallerIntent, userId);</span><br><span class="line">        <span class="keyword">if</span> (certInstallerPackage != <span class="keyword">null</span></span><br><span class="line">                &amp;&amp; doesPackageSupportRuntimePermissions(certInstallerPackage)) &#123;</span><br><span class="line">            grantRuntimePermissionsLPw(certInstallerPackage, STORAGE_PERMISSIONS, <span class="keyword">true</span>, userId);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment">//【11】默认授予 dialer CONTACTS_PERMISSIONS，SMS_PERMISSIONS，</span></span><br><span class="line">        <span class="comment">// MICROPHONE_PERMISSIONS，CAMERA_PERMISSIONS中的所有权限！</span></span><br><span class="line">        <span class="keyword">if</span> (dialerAppPackageNames == <span class="keyword">null</span>) &#123;</span><br><span class="line">            Intent dialerIntent = <span class="keyword">new</span> Intent(Intent.ACTION_DIAL);</span><br><span class="line">            PackageParser.Package dialerPackage = getDefaultSystemHandlerActivityPackageLPr(</span><br><span class="line">                    dialerIntent, userId);</span><br><span class="line">            <span class="keyword">if</span> (dialerPackage != <span class="keyword">null</span>) &#123;</span><br><span class="line">                grantDefaultPermissionsToDefaultSystemDialerAppLPr(dialerPackage, userId);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            <span class="keyword">for</span> (String dialerAppPackageName : dialerAppPackageNames) &#123;</span><br><span class="line">                PackageParser.Package dialerPackage = getSystemPackageLPr(dialerAppPackageName);</span><br><span class="line">                <span class="keyword">if</span> (dialerPackage != <span class="keyword">null</span>) &#123;</span><br><span class="line">                    grantDefaultPermissionsToDefaultSystemDialerAppLPr(dialerPackage, userId);</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">//【12】默认授予 Sim call manager PHONE_PERMISSIONS，SMS_PERMISSIONS</span></span><br><span class="line">        <span class="comment">// MICROPHONE_PERMISSIONS，CAMERA_PERMISSIONS中的所有权限！</span></span><br><span class="line">        <span class="keyword">if</span> (simCallManagerPackageNames != <span class="keyword">null</span>) &#123;</span><br><span class="line">            <span class="keyword">for</span> (String simCallManagerPackageName : simCallManagerPackageNames) &#123;</span><br><span class="line">                PackageParser.Package simCallManagerPackage =</span><br><span class="line">                        getSystemPackageLPr(simCallManagerPackageName);</span><br><span class="line">                <span class="keyword">if</span> (simCallManagerPackage != <span class="keyword">null</span>) &#123;</span><br><span class="line">                    grantDefaultPermissionsToDefaultSimCallManagerLPr(simCallManagerPackage,</span><br><span class="line">                            userId);</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">//【13】默认授予 SMS PHONE_PERMISSIONS，CONTACTS_PERMISSIONS，SMS_PERMISSIONS 中的所有权限！</span></span><br><span class="line">        <span class="keyword">if</span> (smsAppPackageNames == <span class="keyword">null</span>) &#123;</span><br><span class="line">            Intent smsIntent = <span class="keyword">new</span> Intent(Intent.ACTION_MAIN);</span><br><span class="line">            smsIntent.addCategory(Intent.CATEGORY_APP_MESSAGING);</span><br><span class="line">            PackageParser.Package smsPackage = getDefaultSystemHandlerActivityPackageLPr(</span><br><span class="line">                    smsIntent, userId);</span><br><span class="line">            <span class="keyword">if</span> (smsPackage != <span class="keyword">null</span>) &#123;</span><br><span class="line">               grantDefaultPermissionsToDefaultSystemSmsAppLPr(smsPackage, userId);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            <span class="keyword">for</span> (String smsPackageName : smsAppPackageNames) &#123;</span><br><span class="line">                PackageParser.Package smsPackage = getSystemPackageLPr(smsPackageName);</span><br><span class="line">                <span class="keyword">if</span> (smsPackage != <span class="keyword">null</span>) &#123;</span><br><span class="line">                    grantDefaultPermissionsToDefaultSystemSmsAppLPr(smsPackage, userId);</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">//【14】默认授予 Cell Broadcast Receiver SMS_PERMISSIONS 中的所有权限！</span></span><br><span class="line">        Intent cbrIntent = <span class="keyword">new</span> Intent(Intents.SMS_CB_RECEIVED_ACTION);</span><br><span class="line">        PackageParser.Package cbrPackage =</span><br><span class="line">                getDefaultSystemHandlerActivityPackageLPr(cbrIntent, userId);</span><br><span class="line">        <span class="keyword">if</span> (cbrPackage != <span class="keyword">null</span> &amp;&amp; doesPackageSupportRuntimePermissions(cbrPackage)) &#123;</span><br><span class="line">            grantRuntimePermissionsLPw(cbrPackage, SMS_PERMISSIONS, userId);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">//【15】默认授予 Carrier Provisioning Service SMS_PERMISSIONS 中的所有权限！</span></span><br><span class="line">        Intent carrierProvIntent = <span class="keyword">new</span> Intent(Intents.SMS_CARRIER_PROVISION_ACTION);</span><br><span class="line">        PackageParser.Package carrierProvPackage =</span><br><span class="line">                getDefaultSystemHandlerServicePackageLPr(carrierProvIntent, userId);</span><br><span class="line">        <span class="keyword">if</span> (carrierProvPackage != <span class="keyword">null</span> &amp;&amp; doesPackageSupportRuntimePermissions(carrierProvPackage)) &#123;</span><br><span class="line">            grantRuntimePermissionsLPw(carrierProvPackage, SMS_PERMISSIONS, <span class="keyword">false</span>, userId);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">//【15】默认授予 Calendar CALENDAR_PERMISSIONS 中的所有权限！</span></span><br><span class="line">        Intent calendarIntent = <span class="keyword">new</span> Intent(Intent.ACTION_MAIN);</span><br><span class="line">        calendarIntent.addCategory(Intent.CATEGORY_APP_CALENDAR);</span><br><span class="line">        PackageParser.Package calendarPackage = getDefaultSystemHandlerActivityPackageLPr(</span><br><span class="line">                calendarIntent, userId);</span><br><span class="line">        <span class="keyword">if</span> (calendarPackage != <span class="keyword">null</span></span><br><span class="line">                &amp;&amp; doesPackageSupportRuntimePermissions(calendarPackage)) &#123;</span><br><span class="line">            grantRuntimePermissionsLPw(calendarPackage, CALENDAR_PERMISSIONS, userId);</span><br><span class="line">            grantRuntimePermissionsLPw(calendarPackage, CONTACTS_PERMISSIONS, userId);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">//【16】默认授予 Calendar provider CONTACTS_PERMISSIONS，CALENDAR_PERMISSIONS，</span></span><br><span class="line">        <span class="comment">// STORAGE_PERMISSIONS 中的所有权限！</span></span><br><span class="line">        PackageParser.Package calendarProviderPackage = getDefaultProviderAuthorityPackageLPr(</span><br><span class="line">                CalendarContract.AUTHORITY, userId);</span><br><span class="line">        <span class="keyword">if</span> (calendarProviderPackage != <span class="keyword">null</span>) &#123;</span><br><span class="line">            grantRuntimePermissionsLPw(calendarProviderPackage, CONTACTS_PERMISSIONS, userId);</span><br><span class="line">            grantRuntimePermissionsLPw(calendarProviderPackage, CALENDAR_PERMISSIONS,</span><br><span class="line">                    <span class="keyword">true</span>, userId);</span><br><span class="line">            grantRuntimePermissionsLPw(calendarProviderPackage, STORAGE_PERMISSIONS, userId);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">//【17】默认授予 Calendar provider sync adapters CALENDAR_PERMISSIONS 中的所有权限！</span></span><br><span class="line">        List&lt;PackageParser.Package&gt; calendarSyncAdapters = getHeadlessSyncAdapterPackagesLPr(</span><br><span class="line">                calendarSyncAdapterPackages, userId);</span><br><span class="line">        <span class="keyword">final</span> <span class="keyword">int</span> calendarSyncAdapterCount = calendarSyncAdapters.size();</span><br><span class="line">        <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; calendarSyncAdapterCount; i++) &#123;</span><br><span class="line">            PackageParser.Package calendarSyncAdapter = calendarSyncAdapters.get(i);</span><br><span class="line">            <span class="keyword">if</span> (doesPackageSupportRuntimePermissions(calendarSyncAdapter)) &#123;</span><br><span class="line">                grantRuntimePermissionsLPw(calendarSyncAdapter, CALENDAR_PERMISSIONS, userId);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">//【18】默认授予 Contacts CONTACTS_PERMISSIONS， PHONE_PERMISSIONS 中的所有权限！</span></span><br><span class="line">        Intent contactsIntent = <span class="keyword">new</span> Intent(Intent.ACTION_MAIN);</span><br><span class="line">        contactsIntent.addCategory(Intent.CATEGORY_APP_CONTACTS);</span><br><span class="line">        PackageParser.Package contactsPackage = getDefaultSystemHandlerActivityPackageLPr(</span><br><span class="line">                contactsIntent, userId);</span><br><span class="line">        <span class="keyword">if</span> (contactsPackage != <span class="keyword">null</span></span><br><span class="line">                &amp;&amp; doesPackageSupportRuntimePermissions(contactsPackage)) &#123;</span><br><span class="line">            grantRuntimePermissionsLPw(contactsPackage, CONTACTS_PERMISSIONS, userId);</span><br><span class="line">            grantRuntimePermissionsLPw(contactsPackage, PHONE_PERMISSIONS, userId);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">//【19】默认授予 Contacts provider sync adapters CONTACTS_PERMISSIONS 中的所有权限！</span></span><br><span class="line">        List&lt;PackageParser.Package&gt; contactsSyncAdapters = getHeadlessSyncAdapterPackagesLPr(</span><br><span class="line">                contactsSyncAdapterPackages, userId);</span><br><span class="line">        <span class="keyword">final</span> <span class="keyword">int</span> contactsSyncAdapterCount = contactsSyncAdapters.size();</span><br><span class="line">        <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; contactsSyncAdapterCount; i++) &#123;</span><br><span class="line">            PackageParser.Package contactsSyncAdapter = contactsSyncAdapters.get(i);</span><br><span class="line">            <span class="keyword">if</span> (doesPackageSupportRuntimePermissions(contactsSyncAdapter)) &#123;</span><br><span class="line">                grantRuntimePermissionsLPw(contactsSyncAdapter, CONTACTS_PERMISSIONS, userId);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">//【20】默认授予 Contacts provider CONTACTS_PERMISSIONS，PHONE_PERMISSIONS，</span></span><br><span class="line">        <span class="comment">// STORAGE_PERMISSIONS 中的所有权限！</span></span><br><span class="line">        PackageParser.Package contactsProviderPackage = getDefaultProviderAuthorityPackageLPr(</span><br><span class="line">                ContactsContract.AUTHORITY, userId);</span><br><span class="line">        <span class="keyword">if</span> (contactsProviderPackage != <span class="keyword">null</span>) &#123;</span><br><span class="line">            grantRuntimePermissionsLPw(contactsProviderPackage, CONTACTS_PERMISSIONS,</span><br><span class="line">                    <span class="keyword">true</span>, userId);</span><br><span class="line">            grantRuntimePermissionsLPw(contactsProviderPackage, PHONE_PERMISSIONS,</span><br><span class="line">                    <span class="keyword">true</span>, userId);</span><br><span class="line">            grantRuntimePermissionsLPw(contactsProviderPackage, STORAGE_PERMISSIONS, userId);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">//【21】默认授予 Device provisioning CONTACTS_PERMISSIONS 中的所有权限！</span></span><br><span class="line">        Intent deviceProvisionIntent = <span class="keyword">new</span> Intent(</span><br><span class="line">                DevicePolicyManager.ACTION_PROVISION_MANAGED_DEVICE);</span><br><span class="line">        PackageParser.Package deviceProvisionPackage =</span><br><span class="line">                getDefaultSystemHandlerActivityPackageLPr(deviceProvisionIntent, userId);</span><br><span class="line">        <span class="keyword">if</span> (deviceProvisionPackage != <span class="keyword">null</span></span><br><span class="line">                &amp;&amp; doesPackageSupportRuntimePermissions(deviceProvisionPackage)) &#123;</span><br><span class="line">            grantRuntimePermissionsLPw(deviceProvisionPackage, CONTACTS_PERMISSIONS, userId);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">//【22】默认授予 Maps App LOCATION_PERMISSIONS 中的所有权限！</span></span><br><span class="line">        Intent mapsIntent = <span class="keyword">new</span> Intent(Intent.ACTION_MAIN);</span><br><span class="line">        mapsIntent.addCategory(Intent.CATEGORY_APP_MAPS);</span><br><span class="line">        PackageParser.Package mapsPackage = getDefaultSystemHandlerActivityPackageLPr(</span><br><span class="line">                mapsIntent, userId);</span><br><span class="line">        <span class="keyword">if</span> (mapsPackage != <span class="keyword">null</span></span><br><span class="line">                &amp;&amp; doesPackageSupportRuntimePermissions(mapsPackage)) &#123;</span><br><span class="line">            grantRuntimePermissionsLPw(mapsPackage, LOCATION_PERMISSIONS, userId);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">//【23】默认授予 Gallery App STORAGE_PERMISSIONS 中的所有权限！</span></span><br><span class="line">        Intent galleryIntent = <span class="keyword">new</span> Intent(Intent.ACTION_MAIN);</span><br><span class="line">        galleryIntent.addCategory(Intent.CATEGORY_APP_GALLERY);</span><br><span class="line">        PackageParser.Package galleryPackage = getDefaultSystemHandlerActivityPackageLPr(</span><br><span class="line">                galleryIntent, userId);</span><br><span class="line">        <span class="keyword">if</span> (galleryPackage != <span class="keyword">null</span></span><br><span class="line">                &amp;&amp; doesPackageSupportRuntimePermissions(galleryPackage)) &#123;</span><br><span class="line">            grantRuntimePermissionsLPw(galleryPackage, STORAGE_PERMISSIONS, userId);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">//【24】默认授予 Email App CONTACTS_PERMISSIONS，CALENDAR_PERMISSIONS 中的所有权限！</span></span><br><span class="line">        Intent emailIntent = <span class="keyword">new</span> Intent(Intent.ACTION_MAIN);</span><br><span class="line">        emailIntent.addCategory(Intent.CATEGORY_APP_EMAIL);</span><br><span class="line">        PackageParser.Package emailPackage = getDefaultSystemHandlerActivityPackageLPr(</span><br><span class="line">                emailIntent, userId);</span><br><span class="line">        <span class="keyword">if</span> (emailPackage != <span class="keyword">null</span></span><br><span class="line">                &amp;&amp; doesPackageSupportRuntimePermissions(emailPackage)) &#123;</span><br><span class="line">            grantRuntimePermissionsLPw(emailPackage, CONTACTS_PERMISSIONS, userId);</span><br><span class="line">            grantRuntimePermissionsLPw(emailPackage, CALENDAR_PERMISSIONS, userId);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">//【25】默认授予 Browser App LOCATION_PERMISSIONS 中的所有权限！</span></span><br><span class="line">        PackageParser.Package browserPackage = <span class="keyword">null</span>;</span><br><span class="line">        String defaultBrowserPackage = mService.getDefaultBrowserPackageName(userId);</span><br><span class="line">        <span class="keyword">if</span> (defaultBrowserPackage != <span class="keyword">null</span>) &#123;</span><br><span class="line">            browserPackage = getPackageLPr(defaultBrowserPackage);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">if</span> (browserPackage == <span class="keyword">null</span>) &#123;</span><br><span class="line">            Intent browserIntent = <span class="keyword">new</span> Intent(Intent.ACTION_MAIN);</span><br><span class="line">            browserIntent.addCategory(Intent.CATEGORY_APP_BROWSER);</span><br><span class="line">            browserPackage = getDefaultSystemHandlerActivityPackageLPr(</span><br><span class="line">                    browserIntent, userId);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">if</span> (browserPackage != <span class="keyword">null</span></span><br><span class="line">                &amp;&amp; doesPackageSupportRuntimePermissions(browserPackage)) &#123;</span><br><span class="line">            grantRuntimePermissionsLPw(browserPackage, LOCATION_PERMISSIONS, userId);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">//【26】默认授予 Voice interaction CONTACTS_PERMISSIONS，CALENDAR_PERMISSIONS，MICROPHONE_PERMISSIONS</span></span><br><span class="line">        <span class="comment">// PHONE_PERMISSIONS，SMS_PERMISSIONS，LOCATION_PERMISSIONS 中的所有权限！</span></span><br><span class="line">        <span class="keyword">if</span> (voiceInteractPackageNames != <span class="keyword">null</span>) &#123;</span><br><span class="line">            <span class="keyword">for</span> (String voiceInteractPackageName : voiceInteractPackageNames) &#123;</span><br><span class="line">                PackageParser.Package voiceInteractPackage = getSystemPackageLPr(</span><br><span class="line">                        voiceInteractPackageName);</span><br><span class="line">                <span class="keyword">if</span> (voiceInteractPackage != <span class="keyword">null</span></span><br><span class="line">                        &amp;&amp; doesPackageSupportRuntimePermissions(voiceInteractPackage)) &#123;</span><br><span class="line">                    grantRuntimePermissionsLPw(voiceInteractPackage,</span><br><span class="line">                            CONTACTS_PERMISSIONS, userId);</span><br><span class="line">                    grantRuntimePermissionsLPw(voiceInteractPackage,</span><br><span class="line">                            CALENDAR_PERMISSIONS, userId);</span><br><span class="line">                    grantRuntimePermissionsLPw(voiceInteractPackage,</span><br><span class="line">                            MICROPHONE_PERMISSIONS, userId);</span><br><span class="line">                    grantRuntimePermissionsLPw(voiceInteractPackage,</span><br><span class="line">                            PHONE_PERMISSIONS, userId);</span><br><span class="line">                    grantRuntimePermissionsLPw(voiceInteractPackage,</span><br><span class="line">                            SMS_PERMISSIONS, userId);</span><br><span class="line">                    grantRuntimePermissionsLPw(voiceInteractPackage,</span><br><span class="line">                            LOCATION_PERMISSIONS, userId);</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">//【26】默认授予 Voice recognition MICROPHONE_PERMISSIONS 中的所有权限！</span></span><br><span class="line">        Intent voiceRecoIntent = <span class="keyword">new</span> Intent(<span class="string">"android.speech.RecognitionService"</span>);</span><br><span class="line">        voiceRecoIntent.addCategory(Intent.CATEGORY_DEFAULT);</span><br><span class="line">        PackageParser.Package voiceRecoPackage = getDefaultSystemHandlerServicePackageLPr(</span><br><span class="line">                voiceRecoIntent, userId);</span><br><span class="line">        <span class="keyword">if</span> (voiceRecoPackage != <span class="keyword">null</span></span><br><span class="line">                &amp;&amp; doesPackageSupportRuntimePermissions(voiceRecoPackage)) &#123;</span><br><span class="line">            grantRuntimePermissionsLPw(voiceRecoPackage, MICROPHONE_PERMISSIONS, userId);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">//【27】默认授予 Location CONTACTS_PERMISSIONS... 中的所有权限！</span></span><br><span class="line">        <span class="keyword">if</span> (locationPackageNames != <span class="keyword">null</span>) &#123;</span><br><span class="line">            <span class="keyword">for</span> (String packageName : locationPackageNames) &#123;</span><br><span class="line">                PackageParser.Package locationPackage = getSystemPackageLPr(packageName);</span><br><span class="line">                <span class="keyword">if</span> (locationPackage != <span class="keyword">null</span></span><br><span class="line">                        &amp;&amp; doesPackageSupportRuntimePermissions(locationPackage)) &#123;</span><br><span class="line">                    grantRuntimePermissionsLPw(locationPackage, CONTACTS_PERMISSIONS, userId);</span><br><span class="line">                    grantRuntimePermissionsLPw(locationPackage, CALENDAR_PERMISSIONS, userId);</span><br><span class="line">                    grantRuntimePermissionsLPw(locationPackage, MICROPHONE_PERMISSIONS, userId);</span><br><span class="line">                    grantRuntimePermissionsLPw(locationPackage, PHONE_PERMISSIONS, userId);</span><br><span class="line">                    grantRuntimePermissionsLPw(locationPackage, SMS_PERMISSIONS, userId);</span><br><span class="line">                    grantRuntimePermissionsLPw(locationPackage, LOCATION_PERMISSIONS,</span><br><span class="line">                            <span class="keyword">true</span>, userId);</span><br><span class="line">                    grantRuntimePermissionsLPw(locationPackage, CAMERA_PERMISSIONS, userId);</span><br><span class="line">                    grantRuntimePermissionsLPw(locationPackage, SENSORS_PERMISSIONS, userId);</span><br><span class="line">                    grantRuntimePermissionsLPw(locationPackage, STORAGE_PERMISSIONS, userId);</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">//【28】默认授予 Music STORAGE_PERMISSIONS 中的所有权限！</span></span><br><span class="line">        Intent musicIntent = <span class="keyword">new</span> Intent(Intent.ACTION_VIEW);</span><br><span class="line">        musicIntent.addCategory(Intent.CATEGORY_DEFAULT);</span><br><span class="line">        musicIntent.setDataAndType(Uri.fromFile(<span class="keyword">new</span> File(<span class="string">"foo.mp3"</span>)),</span><br><span class="line">                AUDIO_MIME_TYPE);</span><br><span class="line">        PackageParser.Package musicPackage = getDefaultSystemHandlerActivityPackageLPr(</span><br><span class="line">                musicIntent, userId);</span><br><span class="line">        <span class="keyword">if</span> (musicPackage != <span class="keyword">null</span></span><br><span class="line">                &amp;&amp; doesPackageSupportRuntimePermissions(musicPackage)) &#123;</span><br><span class="line">            grantRuntimePermissionsLPw(musicPackage, STORAGE_PERMISSIONS, userId);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 这里是针对于 Android Wear 设备的，不关注！</span></span><br><span class="line">        <span class="keyword">if</span> (mService.hasSystemFeature(PackageManager.FEATURE_WATCH, <span class="number">0</span>)) &#123;</span><br><span class="line">            Intent homeIntent = <span class="keyword">new</span> Intent(Intent.ACTION_MAIN);</span><br><span class="line">            homeIntent.addCategory(Intent.CATEGORY_HOME_MAIN);</span><br><span class="line"></span><br><span class="line">            PackageParser.Package wearHomePackage = getDefaultSystemHandlerActivityPackageLPr(</span><br><span class="line">                    homeIntent, userId);</span><br><span class="line"></span><br><span class="line">            <span class="keyword">if</span> (wearHomePackage != <span class="keyword">null</span></span><br><span class="line">                    &amp;&amp; doesPackageSupportRuntimePermissions(wearHomePackage)) &#123;</span><br><span class="line">                grantRuntimePermissionsLPw(wearHomePackage, CONTACTS_PERMISSIONS, <span class="keyword">false</span>,</span><br><span class="line">                        userId);</span><br><span class="line">                grantRuntimePermissionsLPw(wearHomePackage, PHONE_PERMISSIONS, <span class="keyword">true</span>, userId);</span><br><span class="line">                grantRuntimePermissionsLPw(wearHomePackage, MICROPHONE_PERMISSIONS, <span class="keyword">false</span>,</span><br><span class="line">                        userId);</span><br><span class="line">                grantRuntimePermissionsLPw(wearHomePackage, LOCATION_PERMISSIONS, <span class="keyword">false</span>,</span><br><span class="line">                        userId);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">//【29】默认授予 Print Spooler LOCATION_PERMISSIONS 中的所有权限！</span></span><br><span class="line">        PackageParser.Package printSpoolerPackage = getSystemPackageLPr(</span><br><span class="line">                PrintManager.PRINT_SPOOLER_PACKAGE_NAME);</span><br><span class="line">        <span class="keyword">if</span> (printSpoolerPackage != <span class="keyword">null</span></span><br><span class="line">                &amp;&amp; doesPackageSupportRuntimePermissions(printSpoolerPackage)) &#123;</span><br><span class="line">            grantRuntimePermissionsLPw(printSpoolerPackage, LOCATION_PERMISSIONS, <span class="keyword">true</span>, userId);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">//【30】默认授予 EmergencyInfo CONTACTS_PERMISSIONS, PHONE_PERMISSIONS 中的所有权限！</span></span><br><span class="line">        Intent emergencyInfoIntent = <span class="keyword">new</span> Intent(TelephonyManager.ACTION_EMERGENCY_ASSISTANCE);</span><br><span class="line">        PackageParser.Package emergencyInfoPckg = getDefaultSystemHandlerActivityPackageLPr(</span><br><span class="line">                emergencyInfoIntent, userId);</span><br><span class="line">        <span class="keyword">if</span> (emergencyInfoPckg != <span class="keyword">null</span></span><br><span class="line">                &amp;&amp; doesPackageSupportRuntimePermissions(emergencyInfoPckg)) &#123;</span><br><span class="line">            grantRuntimePermissionsLPw(emergencyInfoPckg, CONTACTS_PERMISSIONS, <span class="keyword">true</span>, userId);</span><br><span class="line">            grantRuntimePermissionsLPw(emergencyInfoPckg, PHONE_PERMISSIONS, <span class="keyword">true</span>, userId);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">//【31】默认授予 NFC CONTACTS_PERMISSIONS, PHONE_PERMISSIONS 中的所有权限！</span></span><br><span class="line">        Intent nfcTagIntent = <span class="keyword">new</span> Intent(Intent.ACTION_VIEW);</span><br><span class="line">        nfcTagIntent.setType(<span class="string">"vnd.android.cursor.item/ndef_msg"</span>);</span><br><span class="line">        PackageParser.Package nfcTagPkg = getDefaultSystemHandlerActivityPackageLPr(</span><br><span class="line">                nfcTagIntent, userId);</span><br><span class="line">        <span class="keyword">if</span> (nfcTagPkg != <span class="keyword">null</span></span><br><span class="line">                &amp;&amp; doesPackageSupportRuntimePermissions(nfcTagPkg)) &#123;</span><br><span class="line">            grantRuntimePermissionsLPw(nfcTagPkg, CONTACTS_PERMISSIONS, <span class="keyword">false</span>, userId);</span><br><span class="line">            grantRuntimePermissionsLPw(nfcTagPkg, PHONE_PERMISSIONS, <span class="keyword">false</span>, userId);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">//【32】默认授予 Storage Manager STORAGE_PERMISSIONS 中的所有权限！</span></span><br><span class="line">        Intent storageManagerIntent = <span class="keyword">new</span> Intent(StorageManager.ACTION_MANAGE_STORAGE);</span><br><span class="line">        PackageParser.Package storageManagerPckg = getDefaultSystemHandlerActivityPackageLPr(</span><br><span class="line">                storageManagerIntent, userId);</span><br><span class="line">        <span class="keyword">if</span> (storageManagerPckg != <span class="keyword">null</span></span><br><span class="line">                &amp;&amp; doesPackageSupportRuntimePermissions(storageManagerPckg)) &#123;</span><br><span class="line">            grantRuntimePermissionsLPw(storageManagerPckg, STORAGE_PERMISSIONS, <span class="keyword">true</span>, userId);</span><br><span class="line">        &#125;</span><br><span class="line">        </span><br><span class="line">        <span class="comment">//【5.1.2.2】最后调用了 Settings.onDefaultRuntimePermissionsGrantedLPr 方法，</span></span><br><span class="line">        <span class="comment">// 再次保存运行时权限授予情况！！！</span></span><br><span class="line">        mService.mSettings.onDefaultRuntimePermissionsGrantedLPr(userId);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>我们可以看到，这个阶段 DefaultPermissionGrantPolicy 默认授予了很多系统组件很多必须的运行时权限！</p>
<p>涉及到的 DefaultPermissionGrantPolicy 内部方法也很多，但是<strong>最终都是调用了其内部的 grantRuntimePermissionsLPw 方法</strong>，该方法，我们签名有分析过！</p>
<p>这里就不在跟踪了！</p>
<h4 id="5-1-2-1-权限集合"><a href="#5-1-2-1-权限集合" class="headerlink" title="5.1.2.1 权限集合"></a>5.1.2.1 权限集合</h4><p>DefaultPermissionGrantPolicy 内部有多个 Set 集合，保存了要默认授予给应用的运行时权限！<br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> Set&lt;String&gt; PHONE_PERMISSIONS = <span class="keyword">new</span> ArraySet&lt;&gt;();</span><br><span class="line"><span class="keyword">static</span> &#123;</span><br><span class="line">    PHONE_PERMISSIONS.add(Manifest.permission.READ_PHONE_STATE);</span><br><span class="line">    PHONE_PERMISSIONS.add(Manifest.permission.CALL_PHONE);</span><br><span class="line">    PHONE_PERMISSIONS.add(Manifest.permission.READ_CALL_LOG);</span><br><span class="line">    PHONE_PERMISSIONS.add(Manifest.permission.WRITE_CALL_LOG);</span><br><span class="line">    PHONE_PERMISSIONS.add(Manifest.permission.ADD_VOICEMAIL);</span><br><span class="line">    PHONE_PERMISSIONS.add(Manifest.permission.USE_SIP);</span><br><span class="line">    PHONE_PERMISSIONS.add(Manifest.permission.PROCESS_OUTGOING_CALLS);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> Set&lt;String&gt; CONTACTS_PERMISSIONS = <span class="keyword">new</span> ArraySet&lt;&gt;();</span><br><span class="line"><span class="keyword">static</span> &#123;</span><br><span class="line">    CONTACTS_PERMISSIONS.add(Manifest.permission.READ_CONTACTS);</span><br><span class="line">    CONTACTS_PERMISSIONS.add(Manifest.permission.WRITE_CONTACTS);</span><br><span class="line">    CONTACTS_PERMISSIONS.add(Manifest.permission.GET_ACCOUNTS);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> Set&lt;String&gt; LOCATION_PERMISSIONS = <span class="keyword">new</span> ArraySet&lt;&gt;();</span><br><span class="line"><span class="keyword">static</span> &#123;</span><br><span class="line">    LOCATION_PERMISSIONS.add(Manifest.permission.ACCESS_FINE_LOCATION);</span><br><span class="line">    LOCATION_PERMISSIONS.add(Manifest.permission.ACCESS_COARSE_LOCATION);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> Set&lt;String&gt; CALENDAR_PERMISSIONS = <span class="keyword">new</span> ArraySet&lt;&gt;();</span><br><span class="line"><span class="keyword">static</span> &#123;</span><br><span class="line">    CALENDAR_PERMISSIONS.add(Manifest.permission.READ_CALENDAR);</span><br><span class="line">    CALENDAR_PERMISSIONS.add(Manifest.permission.WRITE_CALENDAR);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> Set&lt;String&gt; SMS_PERMISSIONS = <span class="keyword">new</span> ArraySet&lt;&gt;();</span><br><span class="line"><span class="keyword">static</span> &#123;</span><br><span class="line">    SMS_PERMISSIONS.add(Manifest.permission.SEND_SMS);</span><br><span class="line">    SMS_PERMISSIONS.add(Manifest.permission.RECEIVE_SMS);</span><br><span class="line">    SMS_PERMISSIONS.add(Manifest.permission.READ_SMS);</span><br><span class="line">    SMS_PERMISSIONS.add(Manifest.permission.RECEIVE_WAP_PUSH);</span><br><span class="line">    SMS_PERMISSIONS.add(Manifest.permission.RECEIVE_MMS);</span><br><span class="line">    SMS_PERMISSIONS.add(Manifest.permission.READ_CELL_BROADCASTS);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> Set&lt;String&gt; MICROPHONE_PERMISSIONS = <span class="keyword">new</span> ArraySet&lt;&gt;();</span><br><span class="line"><span class="keyword">static</span> &#123;</span><br><span class="line">    MICROPHONE_PERMISSIONS.add(Manifest.permission.RECORD_AUDIO);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> Set&lt;String&gt; CAMERA_PERMISSIONS = <span class="keyword">new</span> ArraySet&lt;&gt;();</span><br><span class="line"><span class="keyword">static</span> &#123;</span><br><span class="line">    CAMERA_PERMISSIONS.add(Manifest.permission.CAMERA);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> Set&lt;String&gt; SENSORS_PERMISSIONS = <span class="keyword">new</span> ArraySet&lt;&gt;();</span><br><span class="line"><span class="keyword">static</span> &#123;</span><br><span class="line">    SENSORS_PERMISSIONS.add(Manifest.permission.BODY_SENSORS);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> Set&lt;String&gt; STORAGE_PERMISSIONS = <span class="keyword">new</span> ArraySet&lt;&gt;();</span><br><span class="line"><span class="keyword">static</span> &#123;</span><br><span class="line">    STORAGE_PERMISSIONS.add(Manifest.permission.READ_EXTERNAL_STORAGE);</span><br><span class="line">    STORAGE_PERMISSIONS.add(Manifest.permission.WRITE_EXTERNAL_STORAGE);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>这里只是简单的列举出来！</p>
<h4 id="5-1-2-2-Settings-onDefaultRuntimePermissionsGrantedLPr"><a href="#5-1-2-2-Settings-onDefaultRuntimePermissionsGrantedLPr" class="headerlink" title="5.1.2.2 Settings.onDefaultRuntimePermissionsGrantedLPr"></a>5.1.2.2 Settings.onDefaultRuntimePermissionsGrantedLPr</h4><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">onDefaultRuntimePermissionsGrantedLPr</span><span class="params">(<span class="keyword">int</span> userId)</span> </span>&#123;</span><br><span class="line">    mRuntimePermissionsPersistence</span><br><span class="line">            .onDefaultRuntimePermissionsGrantedLPr(userId);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>对于 RuntimePermissionsPersistence 我们前面有说过，这里会调用其 onDefaultRuntimePermissionsGrantedLPr 方法，重新保存一次运行时权限授予情况！</p>
<p>代码就不在跟踪了！</p>
<h3 id="5-1-3-DPGrantPolicy-grantDefaultPermissionExceptions"><a href="#5-1-3-DPGrantPolicy-grantDefaultPermissionExceptions" class="headerlink" title="5.1.3 DPGrantPolicy.grantDefaultPermissionExceptions"></a>5.1.3 DPGrantPolicy.grantDefaultPermissionExceptions</h3><p>grantDefaultPermissionExceptions 用于处理那些授予异常的情况，系统会将授予异常的权限保存到一个文件中！</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">grantDefaultPermissionExceptions</span><span class="params">(<span class="keyword">int</span> userId)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">synchronized</span> (mService.mPackages) &#123;</span><br><span class="line">        mHandler.removeMessages(MSG_READ_DEFAULT_PERMISSION_EXCEPTIONS);</span><br><span class="line">        <span class="comment">//【5.1.3.1】通过本地文件读取默认运行时权限的授予！</span></span><br><span class="line">        <span class="keyword">if</span> (mGrantExceptions == <span class="keyword">null</span>) &#123;</span><br><span class="line">            mGrantExceptions = readDefaultPermissionExceptionsLPw();</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">// mGrantExceptions 仅在第一次读取之前为空，然后它作为应为每个用户执行的默认授权的缓存。</span></span><br><span class="line">        <span class="comment">// 如果有条目，则应用程序位于系统映像上并支持运行时权限。</span></span><br><span class="line">        Set&lt;String&gt; permissions = <span class="keyword">null</span>;</span><br><span class="line">        <span class="keyword">final</span> <span class="keyword">int</span> exceptionCount = mGrantExceptions.size();</span><br><span class="line">        <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; exceptionCount; i++) &#123;</span><br><span class="line">            String packageName = mGrantExceptions.keyAt(i);</span><br><span class="line">            PackageParser.Package pkg = getSystemPackageLPr(packageName);</span><br><span class="line">            List&lt;DefaultPermissionGrant&gt; permissionGrants = mGrantExceptions.valueAt(i);</span><br><span class="line">            <span class="keyword">final</span> <span class="keyword">int</span> permissionGrantCount = permissionGrants.size();</span><br><span class="line">            <span class="keyword">for</span> (<span class="keyword">int</span> j = <span class="number">0</span>; j &lt; permissionGrantCount; j++) &#123;</span><br><span class="line">                DefaultPermissionGrant permissionGrant = permissionGrants.get(j);</span><br><span class="line">                <span class="keyword">if</span> (permissions == <span class="keyword">null</span>) &#123;</span><br><span class="line">                    permissions = <span class="keyword">new</span> ArraySet&lt;&gt;();</span><br><span class="line">                &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                    permissions.clear();</span><br><span class="line">                &#125;</span><br><span class="line">                permissions.add(permissionGrant.name);</span><br><span class="line">                <span class="comment">//【5.1.1.3】再次调用 grantRuntimePermissionsLPw 授予该运行时权限！</span></span><br><span class="line">                grantRuntimePermissionsLPw(pkg, permissions, <span class="keyword">false</span>,</span><br><span class="line">                        permissionGrant.fixed, userId);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h4 id="5-1-3-1-DPGrantPolicy-readDefaultPermissionExceptionsLPw"><a href="#5-1-3-1-DPGrantPolicy-readDefaultPermissionExceptionsLPw" class="headerlink" title="5.1.3.1 DPGrantPolicy.readDefaultPermissionExceptionsLPw"></a>5.1.3.1 DPGrantPolicy.readDefaultPermissionExceptionsLPw</h4><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">private</span> <span class="meta">@NonNull</span> ArrayMap&lt;String, List&lt;DefaultPermissionGrant&gt;&gt;</span><br><span class="line">        readDefaultPermissionExceptionsLPw() &#123;</span><br><span class="line">    <span class="comment">//【1】获得 /etc/default-permissions 文件目录对象！</span></span><br><span class="line">    File dir = <span class="keyword">new</span> File(Environment.getRootDirectory(), <span class="string">"etc/default-permissions"</span>);</span><br><span class="line">    <span class="keyword">if</span> (!dir.exists() || !dir.isDirectory() || !dir.canRead()) &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> ArrayMap&lt;&gt;(<span class="number">0</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    File[] files = dir.listFiles();</span><br><span class="line">    <span class="keyword">if</span> (files == <span class="keyword">null</span>) &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> ArrayMap&lt;&gt;(<span class="number">0</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    ArrayMap&lt;String, List&lt;DefaultPermissionGrant&gt;&gt; grantExceptions = <span class="keyword">new</span> ArrayMap&lt;&gt;();</span><br><span class="line"></span><br><span class="line">    <span class="keyword">for</span> (File file : files) &#123;</span><br><span class="line">        <span class="keyword">if</span> (!file.getPath().endsWith(<span class="string">".xml"</span>)) &#123;</span><br><span class="line">            Slog.i(TAG, <span class="string">"Non-xml file "</span> + file + <span class="string">" in "</span> + dir + <span class="string">" directory, ignoring"</span>);</span><br><span class="line">            <span class="keyword">continue</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">if</span> (!file.canRead()) &#123;</span><br><span class="line">            Slog.w(TAG, <span class="string">"Default permissions file "</span> + file + <span class="string">" cannot be read"</span>);</span><br><span class="line">            <span class="keyword">continue</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">try</span> (</span><br><span class="line">            InputStream str = <span class="keyword">new</span> BufferedInputStream(<span class="keyword">new</span> FileInputStream(file))</span><br><span class="line">        ) &#123;</span><br><span class="line">            XmlPullParser parser = Xml.newPullParser();</span><br><span class="line">            parser.setInput(str, <span class="keyword">null</span>);</span><br><span class="line">            <span class="comment">//【5.1.3.1.1】parse 解析该目录下的每一个 xml 文件，将结果保存到 grantExceptions 中！</span></span><br><span class="line">            parse(parser, grantExceptions);</span><br><span class="line">        &#125; <span class="keyword">catch</span> (XmlPullParserException | IOException e) &#123;</span><br><span class="line">            Slog.w(TAG, <span class="string">"Error reading default permissions file "</span> + file, e);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> grantExceptions;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h5 id="5-1-3-1-1-DPGrantPolicy-parse"><a href="#5-1-3-1-1-DPGrantPolicy-parse" class="headerlink" title="5.1.3.1.1 DPGrantPolicy.parse"></a>5.1.3.1.1 DPGrantPolicy.parse</h5><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">parse</span><span class="params">(XmlPullParser parser, Map&lt;String, List&lt;DefaultPermissionGrant&gt;&gt;</span></span></span><br><span class="line"><span class="function"><span class="params">        outGrantExceptions)</span> <span class="keyword">throws</span> IOException, XmlPullParserException </span>&#123;</span><br><span class="line">    <span class="keyword">final</span> <span class="keyword">int</span> outerDepth = parser.getDepth();</span><br><span class="line">    <span class="keyword">int</span> type;</span><br><span class="line">    <span class="keyword">while</span> ((type = parser.next()) != XmlPullParser.END_DOCUMENT</span><br><span class="line">            &amp;&amp; (type != XmlPullParser.END_TAG || parser.getDepth() &gt; outerDepth)) &#123;</span><br><span class="line">        <span class="keyword">if</span> (type == XmlPullParser.END_TAG || type == XmlPullParser.TEXT) &#123;</span><br><span class="line">            <span class="keyword">continue</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">if</span> (TAG_EXCEPTIONS.equals(parser.getName())) &#123; <span class="comment">// 标签 exceptions</span></span><br><span class="line">            <span class="comment">//【5.1.3.1.2】parseExceptions 继续解析</span></span><br><span class="line">            parseExceptions(parser, outGrantExceptions);</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            Log.e(TAG, <span class="string">"Unknown tag "</span> + parser.getName());</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h5 id="5-1-3-1-2-DPGrantPolicy-parseExceptions"><a href="#5-1-3-1-2-DPGrantPolicy-parseExceptions" class="headerlink" title="5.1.3.1.2 DPGrantPolicy.parseExceptions"></a>5.1.3.1.2 DPGrantPolicy.parseExceptions</h5><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">parseExceptions</span><span class="params">(XmlPullParser parser, Map&lt;String, List&lt;DefaultPermissionGrant&gt;&gt;</span></span></span><br><span class="line"><span class="function"><span class="params">        outGrantExceptions)</span> <span class="keyword">throws</span> IOException, XmlPullParserException </span>&#123;</span><br><span class="line">    <span class="keyword">final</span> <span class="keyword">int</span> outerDepth = parser.getDepth();</span><br><span class="line">    <span class="keyword">int</span> type;</span><br><span class="line">    <span class="keyword">while</span> ((type = parser.next()) != XmlPullParser.END_DOCUMENT</span><br><span class="line">            &amp;&amp; (type != XmlPullParser.END_TAG || parser.getDepth() &gt; outerDepth)) &#123;</span><br><span class="line">        <span class="keyword">if</span> (type == XmlPullParser.END_TAG || type == XmlPullParser.TEXT) &#123;</span><br><span class="line">            <span class="keyword">continue</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">if</span> (TAG_EXCEPTION.equals(parser.getName())) &#123; <span class="comment">// exception 标签名；</span></span><br><span class="line">            String packageName = parser.getAttributeValue(<span class="keyword">null</span>, ATTR_PACKAGE); <span class="comment">// package 属性名；</span></span><br><span class="line"></span><br><span class="line">            List&lt;DefaultPermissionGrant&gt; packageExceptions =</span><br><span class="line">                    outGrantExceptions.get(packageName);</span><br><span class="line">            <span class="keyword">if</span> (packageExceptions == <span class="keyword">null</span>) &#123;</span><br><span class="line">                <span class="comment">//【1】要处理的应用必须是 system app！</span></span><br><span class="line">                PackageParser.Package pkg = getSystemPackageLPr(packageName);</span><br><span class="line">                <span class="keyword">if</span> (pkg == <span class="keyword">null</span>) &#123;</span><br><span class="line">                    Log.w(TAG, <span class="string">"Unknown package:"</span> + packageName);</span><br><span class="line">                    XmlUtils.skipCurrentTag(parser);</span><br><span class="line">                    <span class="keyword">continue</span>;</span><br><span class="line">                &#125;</span><br><span class="line"></span><br><span class="line">                <span class="comment">//【2】必须支持运行时权限！</span></span><br><span class="line">                <span class="keyword">if</span> (!doesPackageSupportRuntimePermissions(pkg)) &#123;</span><br><span class="line">                    Log.w(TAG, <span class="string">"Skipping non supporting runtime permissions package:"</span></span><br><span class="line">                            + packageName);</span><br><span class="line">                    XmlUtils.skipCurrentTag(parser);</span><br><span class="line">                    <span class="keyword">continue</span>;</span><br><span class="line">                &#125;</span><br><span class="line">                <span class="comment">//【3】创建一个 list，保存权限信息！</span></span><br><span class="line">                packageExceptions = <span class="keyword">new</span> ArrayList&lt;&gt;();</span><br><span class="line">                outGrantExceptions.put(packageName, packageExceptions);</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="comment">//【5.1.3.1.3】调用 parsePermission 继续解析！</span></span><br><span class="line">            parsePermission(parser, packageExceptions);</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            Log.e(TAG, <span class="string">"Unknown tag "</span> + parser.getName() + <span class="string">"under &lt;exceptions&gt;"</span>);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h5 id="5-1-3-1-3-DPGrantPolicy-parsePermission"><a href="#5-1-3-1-3-DPGrantPolicy-parsePermission" class="headerlink" title="5.1.3.1.3 DPGrantPolicy.parsePermission"></a>5.1.3.1.3 DPGrantPolicy.parsePermission</h5><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">parsePermission</span><span class="params">(XmlPullParser parser, List&lt;DefaultPermissionGrant&gt;</span></span></span><br><span class="line"><span class="function"><span class="params">        outPackageExceptions)</span> <span class="keyword">throws</span> IOException, XmlPullParserException </span>&#123;</span><br><span class="line">    <span class="keyword">final</span> <span class="keyword">int</span> outerDepth = parser.getDepth();</span><br><span class="line">    <span class="keyword">int</span> type;</span><br><span class="line">    <span class="keyword">while</span> ((type = parser.next()) != XmlPullParser.END_DOCUMENT</span><br><span class="line">            &amp;&amp; (type != XmlPullParser.END_TAG || parser.getDepth() &gt; outerDepth)) &#123;</span><br><span class="line">        <span class="keyword">if</span> (type == XmlPullParser.END_TAG || type == XmlPullParser.TEXT) &#123;</span><br><span class="line">            <span class="keyword">continue</span>;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (TAG_PERMISSION.contains(parser.getName())) &#123; <span class="comment">// permission 标签！</span></span><br><span class="line">            String name = parser.getAttributeValue(<span class="keyword">null</span>, ATTR_NAME); <span class="comment">// name 属性</span></span><br><span class="line">            <span class="keyword">if</span> (name == <span class="keyword">null</span>) &#123;</span><br><span class="line">                Log.w(TAG, <span class="string">"Mandatory name attribute missing for permission tag"</span>);</span><br><span class="line">                XmlUtils.skipCurrentTag(parser);</span><br><span class="line">                <span class="keyword">continue</span>;</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            <span class="keyword">final</span> <span class="keyword">boolean</span> fixed = XmlUtils.readBooleanAttribute(parser, ATTR_FIXED); <span class="comment">// fixed 属性</span></span><br><span class="line"></span><br><span class="line">            <span class="comment">//【5.1.3.1.4】封装为一个 DefaultPermissionGrant 对象！</span></span><br><span class="line">            DefaultPermissionGrant exception = <span class="keyword">new</span> DefaultPermissionGrant(name, fixed);</span><br><span class="line">            outPackageExceptions.add(exception);</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            Log.e(TAG, <span class="string">"Unknown tag "</span> + parser.getName() + <span class="string">"under &lt;exception&gt;"</span>);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h5 id="5-1-3-1-4-new-DefaultPermissionGrant"><a href="#5-1-3-1-4-new-DefaultPermissionGrant" class="headerlink" title="5.1.3.1.4 new DefaultPermissionGrant"></a>5.1.3.1.4 new DefaultPermissionGrant</h5><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="class"><span class="keyword">class</span> <span class="title">DefaultPermissionGrant</span> </span>&#123;</span><br><span class="line">    <span class="keyword">final</span> String name;</span><br><span class="line">    <span class="keyword">final</span> <span class="keyword">boolean</span> fixed;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="title">DefaultPermissionGrant</span><span class="params">(String name, <span class="keyword">boolean</span> fixed)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">this</span>.name = name;</span><br><span class="line">        <span class="keyword">this</span>.fixed = fixed;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>DefaultPermissionGrant 对象的属性简单，这里不多看了！</p>
<h3 id="5-1-4-DPGrantPolicy-grantRuntimePermissionsLPw-默认授予核心方法"><a href="#5-1-4-DPGrantPolicy-grantRuntimePermissionsLPw-默认授予核心方法" class="headerlink" title="5.1.4 DPGrantPolicy.grantRuntimePermissionsLPw - 默认授予核心方法"></a>5.1.4 DPGrantPolicy.grantRuntimePermissionsLPw - 默认授予核心方法</h3><p>默认授予运行时权限，调用的是内部的两个 grantRuntimePermissionsLPw 方法：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">[<span class="number">1</span>]<span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">grantRuntimePermissionsLPw</span><span class="params">(PackageParser.Package pkg, Set&lt;String&gt; permissions,</span></span></span><br><span class="line"><span class="function"><span class="params">            <span class="keyword">boolean</span> systemFixed, <span class="keyword">int</span> userId)</span> </span>&#123;...&#125;</span><br><span class="line"></span><br><span class="line">[<span class="number">2</span>]<span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">grantRuntimePermissionsLPw</span><span class="params">(PackageParser.Package pkg, Set&lt;String&gt; permissions,</span></span></span><br><span class="line"><span class="function"><span class="params">            <span class="keyword">boolean</span> systemFixed, <span class="keyword">boolean</span> isDefaultPhoneOrSms, <span class="keyword">int</span> userId)</span> </span>&#123;...&#125;</span><br></pre></td></tr></table></figure>
<p>其中，方法一会调用方法二，这是参数 boolean systemFixed 设置的是 false！</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">grantRuntimePermissionsLPw</span><span class="params">(PackageParser.Package pkg, Set&lt;String&gt; permissions,</span></span></span><br><span class="line"><span class="function"><span class="params">        <span class="keyword">boolean</span> systemFixed, <span class="keyword">int</span> userId)</span> </span>&#123;</span><br><span class="line">    grantRuntimePermissionsLPw(pkg, permissions, systemFixed, <span class="keyword">false</span>, userId);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>最后调用的是五参的同名方法：systemFixed 表示是否设置 system fix，isDefaultPhoneOrSms 表示是否是默认的 phone or sms app，permissions 为该 package 要被默认授予的运行时权限集合：<br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">grantRuntimePermissionsLPw</span><span class="params">(PackageParser.Package pkg, Set&lt;String&gt; permissions,</span></span></span><br><span class="line"><span class="function"><span class="params">        <span class="keyword">boolean</span> systemFixed, <span class="keyword">boolean</span> isDefaultPhoneOrSms, <span class="keyword">int</span> userId)</span> </span>&#123;</span><br><span class="line">    <span class="comment">//【1】再次校验应用是否有请求权限！</span></span><br><span class="line">    <span class="keyword">if</span> (pkg.requestedPermissions.isEmpty()) &#123;</span><br><span class="line">        <span class="keyword">return</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">//【2】获得本次扫描的 system apk 的权限！</span></span><br><span class="line">    List&lt;String&gt; requestedPermissions = pkg.requestedPermissions;</span><br><span class="line">    Set&lt;String&gt; grantablePermissions = <span class="keyword">null</span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//【3】如果是默认的 phone app 或者 sms app，如果其更新过，我们会默认授予更新过的 app 申明的权限</span></span><br><span class="line">    <span class="comment">// 如果这是一个被更新过的其他类型的 system app，我们只会默认授予是那些 system 分区的被更新过得 app 申明过的权限！</span></span><br><span class="line">    <span class="keyword">if</span> (!isDefaultPhoneOrSms &amp;&amp; pkg.isUpdatedSystemApp()) &#123;</span><br><span class="line">        PackageSetting sysPs = mService.mSettings.getDisabledSystemPkgLPr(pkg.packageName);</span><br><span class="line">        <span class="keyword">if</span> (sysPs != <span class="keyword">null</span>) &#123;</span><br><span class="line">            <span class="keyword">if</span> (sysPs.pkg.requestedPermissions.isEmpty()) &#123;</span><br><span class="line">                <span class="keyword">return</span>;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">if</span> (!requestedPermissions.equals(sysPs.pkg.requestedPermissions)) &#123;</span><br><span class="line">                <span class="comment">// 表示本次扫描的 package 申明过的权限；</span></span><br><span class="line">                grantablePermissions = <span class="keyword">new</span> ArraySet&lt;&gt;(requestedPermissions);</span><br><span class="line">                <span class="comment">// 替换为被更新过的 system app 申明的权限！！</span></span><br><span class="line">                requestedPermissions = sysPs.pkg.requestedPermissions;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//【4】遍历该 package 申明过的所有权限；</span></span><br><span class="line">    <span class="keyword">final</span> <span class="keyword">int</span> grantablePermissionCount = requestedPermissions.size();</span><br><span class="line">    <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; grantablePermissionCount; i++) &#123;</span><br><span class="line">        String permission = requestedPermissions.get(i);</span><br><span class="line">        <span class="comment">//【4.1】如果这是一个被更新过的 system app，跳过那些 data 分区新 app 没有声明的权限！</span></span><br><span class="line">        <span class="keyword">if</span> (grantablePermissions != <span class="keyword">null</span> &amp;&amp; !grantablePermissions.contains(permission)) &#123;</span><br><span class="line">            <span class="keyword">continue</span>;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment">//【4.2】接下来，就是授予权限权限的过程了！</span></span><br><span class="line">        <span class="keyword">if</span> (permissions.contains(permission)) &#123;</span><br><span class="line">            <span class="comment">//【5.1.1.3.1】获得权限的 flags；</span></span><br><span class="line">            <span class="keyword">final</span> <span class="keyword">int</span> flags = mService.getPermissionFlags(permission, pkg.packageName, userId);</span><br><span class="line"></span><br><span class="line">            <span class="comment">// If any flags are set to the permission, then it is either set in</span></span><br><span class="line">            <span class="comment">// its current state by the system or device/profile owner or the user.</span></span><br><span class="line">            <span class="comment">// In all these cases we do not want to clobber the current state.</span></span><br><span class="line">            <span class="comment">// Unless the caller wants to override user choices. The override is</span></span><br><span class="line">            <span class="comment">// to make sure we can grant the needed permission to the default</span></span><br><span class="line">            <span class="comment">// sms and phone apps after the user chooses this in the UI.</span></span><br><span class="line">            <span class="comment">//【4.2.1】如果该权限的 flags 没有设置任何标志位，或者是默认的 phone app 或者 sms app 会进入 IF 分支！</span></span><br><span class="line">            <span class="keyword">if</span> (flags == <span class="number">0</span> || isDefaultPhoneOrSms) &#123;</span><br><span class="line">                <span class="comment">//【4.2.1.1】对于 isDefaultPhoneOrSms 我们会再判断下是否设置了 system fix 或者 policy fix 标志位!</span></span><br><span class="line">                <span class="comment">// 如果设置了，那么我们不会修改标志位！</span></span><br><span class="line">                <span class="keyword">final</span> <span class="keyword">int</span> fixedFlags = PackageManager.FLAG_PERMISSION_SYSTEM_FIXED</span><br><span class="line">                        | PackageManager.FLAG_PERMISSION_POLICY_FIXED;</span><br><span class="line">                <span class="keyword">if</span> ((flags &amp; fixedFlags) != <span class="number">0</span>) &#123;</span><br><span class="line">                    <span class="keyword">continue</span>;</span><br><span class="line">                &#125;</span><br><span class="line">                <span class="comment">//【4.2.1.2】这里调用了 PMS 的 grantRuntimePermission 方法，授予权限，不多说了！</span></span><br><span class="line">                mService.grantRuntimePermission(pkg.packageName, permission, userId);</span><br><span class="line">                <span class="keyword">if</span> (DEBUG) &#123;</span><br><span class="line">                    Log.i(TAG, <span class="string">"Granted "</span> + (systemFixed ? <span class="string">"fixed "</span> : <span class="string">"not fixed "</span>)</span><br><span class="line">                            + permission + <span class="string">" to default handler "</span> + pkg.packageName);</span><br><span class="line">                &#125;</span><br><span class="line">                </span><br><span class="line">                <span class="comment">//【4.2.1.3】更新该运行时权限的 flags，先只设置 FLAG_PERMISSION_GRANTED_BY_DEFAULT 标志位</span></span><br><span class="line">                <span class="comment">// 如果为 system fix，还会设置 FLAG_PERMISSION_SYSTEM_FIXED 位！</span></span><br><span class="line">                <span class="keyword">int</span> newFlags = PackageManager.FLAG_PERMISSION_GRANTED_BY_DEFAULT;</span><br><span class="line">                <span class="keyword">if</span> (systemFixed) &#123;</span><br><span class="line">                    newFlags |= PackageManager.FLAG_PERMISSION_SYSTEM_FIXED;</span><br><span class="line">                &#125;</span><br><span class="line">                <span class="comment">// 这里调用了 PMS 的 updatePermissionFlags 方法，更新权限的 flags 为 newFlags！</span></span><br><span class="line">                mService.updatePermissionFlags(permission, pkg.packageName,</span><br><span class="line">                        newFlags, newFlags, userId);</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            <span class="comment">//【4.2.2】如果权限被设置了 FLAG_PERMISSION_GRANTED_BY_DEFAULT 和 FLAG_PERMISSION_SYSTEM_FIXED 标志位</span></span><br><span class="line">            <span class="comment">// 但是本次授予是 no system fix，那么我们就要去掉 system fix 标志位！</span></span><br><span class="line">            <span class="keyword">if</span> ((flags &amp; PackageManager.FLAG_PERMISSION_GRANTED_BY_DEFAULT) != <span class="number">0</span></span><br><span class="line">                    &amp;&amp; (flags &amp; PackageManager.FLAG_PERMISSION_SYSTEM_FIXED) != <span class="number">0</span></span><br><span class="line">                    &amp;&amp; !systemFixed) &#123;</span><br><span class="line">                <span class="keyword">if</span> (DEBUG) &#123;</span><br><span class="line">                    Log.i(TAG, <span class="string">"Granted not fixed "</span> + permission + <span class="string">" to default handler "</span></span><br><span class="line">                            + pkg.packageName);</span><br><span class="line">                &#125;</span><br><span class="line">                <span class="comment">//【4.2.2.1】更新权限的 flags 去掉 system fix 标志位！</span></span><br><span class="line">                mService.updatePermissionFlags(permission, pkg.packageName,</span><br><span class="line">                        PackageManager.FLAG_PERMISSION_SYSTEM_FIXED, <span class="number">0</span>, userId);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>该方法我们就分析到这里！</p>
<h4 id="5-1-4-1-PackageManagerS-getPermissionFlags"><a href="#5-1-4-1-PackageManagerS-getPermissionFlags" class="headerlink" title="5.1.4.1 PackageManagerS.getPermissionFlags"></a>5.1.4.1 PackageManagerS.getPermissionFlags</h4><p>该方法用于获得权限的 flags；<br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">int</span> <span class="title">getPermissionFlags</span><span class="params">(String name, String packageName, <span class="keyword">int</span> userId)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">if</span> (!sUserManager.exists(userId)) &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">//【1】首先是校验是否具有相应的权限！</span></span><br><span class="line">    enforceGrantRevokeRuntimePermissionPermissions(<span class="string">"getPermissionFlags"</span>);</span><br><span class="line">    enforceCrossUserPermission(Binder.getCallingUid(), userId,</span><br><span class="line">            <span class="keyword">true</span> <span class="comment">/* requireFullPermission */</span>, <span class="keyword">false</span> <span class="comment">/* checkShell */</span>,</span><br><span class="line">            <span class="string">"getPermissionFlags"</span>);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">synchronized</span> (mPackages) &#123;</span><br><span class="line">        <span class="keyword">final</span> PackageParser.Package pkg = mPackages.get(packageName);</span><br><span class="line">        <span class="keyword">if</span> (pkg == <span class="keyword">null</span>) &#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">final</span> BasePermission bp = mSettings.mPermissions.get(name);</span><br><span class="line">        <span class="keyword">if</span> (bp == <span class="keyword">null</span>) &#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        SettingBase sb = (SettingBase) pkg.mExtras;</span><br><span class="line">        <span class="keyword">if</span> (sb == <span class="keyword">null</span>) &#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">//【2】查询权限的 Flags！</span></span><br><span class="line">        PermissionsState permissionsState = sb.getPermissionsState();</span><br><span class="line">        <span class="keyword">return</span> permissionsState.getPermissionFlags(name, userId);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<h5 id="5-1-4-1-1-PermissionsState-getPermissionFlags"><a href="#5-1-4-1-1-PermissionsState-getPermissionFlags" class="headerlink" title="5.1.4.1.1 PermissionsState.getPermissionFlags"></a>5.1.4.1.1 PermissionsState.getPermissionFlags</h5><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">int</span> <span class="title">getPermissionFlags</span><span class="params">(String name, <span class="keyword">int</span> userId)</span> </span>&#123;</span><br><span class="line">    <span class="comment">//【1】如果是运行时权限的话，那就返回运行时权限的 flags</span></span><br><span class="line">    PermissionState installPermState = getInstallPermissionState(name);</span><br><span class="line">    <span class="keyword">if</span> (installPermState != <span class="keyword">null</span>) &#123;</span><br><span class="line">        <span class="keyword">return</span> installPermState.getFlags();</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">//【2】如果是安装时权限的话，那就返回安装时权限的 flags</span></span><br><span class="line">    PermissionState runtimePermState = getRuntimePermissionState(name, userId);</span><br><span class="line">    <span class="keyword">if</span> (runtimePermState != <span class="keyword">null</span>) &#123;</span><br><span class="line">        <span class="keyword">return</span> runtimePermState.getFlags();</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>下面是具体的获取运行时权限或者安装时权限的权限状态的方法，很简单，不多说了！<br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> PermissionState <span class="title">getInstallPermissionState</span><span class="params">(String name)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">return</span> getPermissionState(name, UserHandle.USER_ALL);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">public</span> PermissionState <span class="title">getRuntimePermissionState</span><span class="params">(String name, <span class="keyword">int</span> userId)</span> </span>&#123;</span><br><span class="line">    enforceValidUserId(userId);</span><br><span class="line">    <span class="keyword">return</span> getPermissionState(name, userId);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<h2 id="5-2-清除那些陈旧不用的用户和应用"><a href="#5-2-清除那些陈旧不用的用户和应用" class="headerlink" title="5.2 清除那些陈旧不用的用户和应用"></a>5.2 清除那些陈旧不用的用户和应用</h2><p>代码段如下：<br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">reconcileUsers(StorageManager.UUID_PRIVATE_INTERNAL);</span><br><span class="line">reconcileApps(StorageManager.UUID_PRIVATE_INTERNAL);</span><br></pre></td></tr></table></figure></p>
<h3 id="5-2-1-PackageManagerService-reconcileUsers"><a href="#5-2-1-PackageManagerService-reconcileUsers" class="headerlink" title="5.2.1 PackageManagerService.reconcileUsers"></a>5.2.1 PackageManagerService.reconcileUsers</h3><p>该方法会检测清除不用的设备用户：<br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">reconcileUsers</span><span class="params">(String volumeUuid)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">final</span> List&lt;File&gt; files = <span class="keyword">new</span> ArrayList&lt;&gt;();</span><br><span class="line">    <span class="comment">// 收集 /data/user_de 目录下的所有文件；</span></span><br><span class="line">    Collections.addAll(files, FileUtils</span><br><span class="line">            .listFilesOrEmpty(Environment.getDataUserDeDirectory(volumeUuid)));</span><br><span class="line">    <span class="comment">// 收集 /data/user 目录下的所有文件；</span></span><br><span class="line">    Collections.addAll(files, FileUtils</span><br><span class="line">            .listFilesOrEmpty(Environment.getDataUserCeDirectory(volumeUuid)));</span><br><span class="line">    <span class="comment">// 收集 /data/system_de 目录下的所有文件；</span></span><br><span class="line">    Collections.addAll(files, FileUtils</span><br><span class="line">            .listFilesOrEmpty(Environment.getDataSystemDeDirectory()));</span><br><span class="line">    <span class="comment">// 收集 /data/system 目录下的所有文件；</span></span><br><span class="line">    Collections.addAll(files, FileUtils</span><br><span class="line">            .listFilesOrEmpty(Environment.getDataSystemCeDirectory()));</span><br><span class="line">    <span class="keyword">for</span> (File file : files) &#123;</span><br><span class="line">        <span class="keyword">if</span> (!file.isDirectory()) <span class="keyword">continue</span>;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">final</span> <span class="keyword">int</span> userId;</span><br><span class="line">        <span class="keyword">final</span> UserInfo info;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            userId = Integer.parseInt(file.getName());</span><br><span class="line">            <span class="comment">// 尝试获得设备用户对应的 UserInfo！</span></span><br><span class="line">            info = sUserManager.getUserInfo(userId);</span><br><span class="line">        &#125; <span class="keyword">catch</span> (NumberFormatException e) &#123;</span><br><span class="line">            Slog.w(TAG, <span class="string">"Invalid user directory "</span> + file);</span><br><span class="line">            <span class="keyword">continue</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">// 判断用户是否无效！</span></span><br><span class="line">        <span class="keyword">boolean</span> destroyUser = <span class="keyword">false</span>;</span><br><span class="line">        <span class="keyword">if</span> (info == <span class="keyword">null</span>) &#123;</span><br><span class="line">            logCriticalInfo(Log.WARN, <span class="string">"Destroying user directory "</span> + file</span><br><span class="line">                    + <span class="string">" because no matching user was found"</span>);</span><br><span class="line">            destroyUser = <span class="keyword">true</span>;</span><br><span class="line">        &#125; <span class="keyword">else</span> <span class="keyword">if</span> (!mOnlyCore) &#123;</span><br><span class="line">            <span class="keyword">try</span> &#123;</span><br><span class="line">                UserManagerService.enforceSerialNumber(file, info.serialNumber);</span><br><span class="line">            &#125; <span class="keyword">catch</span> (IOException e) &#123;</span><br><span class="line">                logCriticalInfo(Log.WARN, <span class="string">"Destroying user directory "</span> + file</span><br><span class="line">                        + <span class="string">" because we failed to enforce serial number: "</span> + e);</span><br><span class="line">                destroyUser = <span class="keyword">true</span>;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">//【5.2.1.1】如果设备用户无效了，清楚该用户的所有数据！</span></span><br><span class="line">        <span class="keyword">if</span> (destroyUser) &#123;</span><br><span class="line">            <span class="keyword">synchronized</span> (mInstallLock) &#123;</span><br><span class="line">                destroyUserDataLI(volumeUuid, userId,</span><br><span class="line">                        StorageManager.FLAG_STORAGE_DE | StorageManager.FLAG_STORAGE_CE);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>第一步，收集了 /data/user_de，/data/user，/data/system_de 和 /data/system 目录下的文件，这些文件的名字，都是以 userId 开头的！</p>
<h4 id="5-2-1-1-PackageManagerService-destroyUserDataLI"><a href="#5-2-1-1-PackageManagerService-destroyUserDataLI" class="headerlink" title="5.2.1.1 PackageManagerService.destroyUserDataLI"></a>5.2.1.1 PackageManagerService.destroyUserDataLI</h4><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">destroyUserDataLI</span><span class="params">(String volumeUuid, <span class="keyword">int</span> userId, <span class="keyword">int</span> flags)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">final</span> StorageManager storage = mContext.getSystemService(StorageManager.class);</span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">        <span class="comment">//【1】通过 Installer 来删除该用户下的 app data, profile data, and media data</span></span><br><span class="line">        mInstaller.destroyUserData(volumeUuid, userId, flags);</span><br><span class="line"></span><br><span class="line">        <span class="comment">//【2】删除 system data！</span></span><br><span class="line">        <span class="keyword">if</span> (Objects.equals(volumeUuid, StorageManager.UUID_PRIVATE_INTERNAL)) &#123;</span><br><span class="line">            <span class="keyword">if</span> ((flags &amp; StorageManager.FLAG_STORAGE_DE) != <span class="number">0</span>) &#123;</span><br><span class="line">                FileUtils.deleteContentsAndDir(Environment.getUserSystemDirectory(userId));</span><br><span class="line">                FileUtils.deleteContentsAndDir(Environment.getDataSystemDeDirectory(userId));</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">if</span> ((flags &amp; StorageManager.FLAG_STORAGE_CE) != <span class="number">0</span>) &#123;</span><br><span class="line">                FileUtils.deleteContentsAndDir(Environment.getDataSystemCeDirectory(userId));</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">//【3】取消挂载！</span></span><br><span class="line">        storage.destroyUserStorage(volumeUuid, userId, flags);</span><br><span class="line"></span><br><span class="line">    &#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">        logCriticalInfo(Log.WARN,</span><br><span class="line">                <span class="string">"Failed to destroy user "</span> + userId + <span class="string">" on volume "</span> + volumeUuid + <span class="string">": "</span> + e);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>该函数的作用很简单，不多说了！</p>
<h3 id="5-2-2-PackageManagerService-reconcileApps"><a href="#5-2-2-PackageManagerService-reconcileApps" class="headerlink" title="5.2.2 PackageManagerService.reconcileApps"></a>5.2.2 PackageManagerService.reconcileApps</h3><p>清除那些在该用户下已经卸载的，无效的应用！</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">reconcileApps</span><span class="params">(String volumeUuid)</span> </span>&#123;</span><br><span class="line">    <span class="comment">//【1】手机 /data/app 目录下的所有文件</span></span><br><span class="line">    <span class="keyword">final</span> File[] files = FileUtils</span><br><span class="line">            .listFilesOrEmpty(Environment.getDataAppDirectory(volumeUuid));</span><br><span class="line">    <span class="keyword">for</span> (File file : files) &#123;</span><br><span class="line">        <span class="keyword">final</span> <span class="keyword">boolean</span> isPackage = (isApkFile(file) || file.isDirectory())</span><br><span class="line">                &amp;&amp; !PackageInstallerService.isStageName(file.getName());</span><br><span class="line">        <span class="keyword">if</span> (!isPackage) &#123;</span><br><span class="line">            <span class="comment">// Ignore entries which are not packages</span></span><br><span class="line">            <span class="keyword">continue</span>;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            <span class="comment">// 再次解析该 package，返回 PackageLite 对象！</span></span><br><span class="line">            <span class="keyword">final</span> PackageLite pkg = PackageParser.parsePackageLite(file,</span><br><span class="line">                    PackageParser.PARSE_MUST_BE_APK);</span><br><span class="line">            <span class="comment">//【4.2.2.1】判断该 package 是否有效，无效会抛出一个异常！</span></span><br><span class="line">            assertPackageKnown(volumeUuid, pkg.packageName);</span><br><span class="line"></span><br><span class="line">        &#125; <span class="keyword">catch</span> (PackageParserException | PackageManagerException e) &#123;</span><br><span class="line">            logCriticalInfo(Log.WARN, <span class="string">"Destroying "</span> + file + <span class="string">" due to: "</span> + e);</span><br><span class="line">            <span class="keyword">synchronized</span> (mInstallLock) &#123;</span><br><span class="line">                <span class="comment">//【4.2.2.2】package 无效，删除该 apk！</span></span><br><span class="line">                removeCodePathLI(file);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h4 id="5-2-2-1-PackageManagerService-assertPackageKnown"><a href="#5-2-2-1-PackageManagerService-assertPackageKnown" class="headerlink" title="5.2.2.1 PackageManagerService.assertPackageKnown"></a>5.2.2.1 PackageManagerService.assertPackageKnown</h4><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">assertPackageKnown</span><span class="params">(String volumeUuid, String packageName)</span></span></span><br><span class="line"><span class="function">        <span class="keyword">throws</span> PackageManagerException </span>&#123;</span><br><span class="line">    <span class="keyword">synchronized</span> (mPackages) &#123;</span><br><span class="line">        <span class="comment">//【1】如果重命名过了，转为以前的名字；</span></span><br><span class="line">        packageName = normalizePackageNameLPr(packageName);</span><br><span class="line">        <span class="keyword">final</span> PackageSetting ps = mSettings.mPackages.get(packageName);</span><br><span class="line">        <span class="comment">//【2】如果系统中没有该 apk 的安装信息，或者其所处的 volume 异常，那么无效，抛出异常！</span></span><br><span class="line">        <span class="keyword">if</span> (ps == <span class="keyword">null</span>) &#123;</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> PackageManagerException(<span class="string">"Package "</span> + packageName + <span class="string">" is unknown"</span>);</span><br><span class="line">        &#125; <span class="keyword">else</span> <span class="keyword">if</span> (!TextUtils.equals(volumeUuid, ps.volumeUuid)) &#123;</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> PackageManagerException(</span><br><span class="line">                    <span class="string">"Package "</span> + packageName + <span class="string">" found on unknown volume "</span> + volumeUuid</span><br><span class="line">                            + <span class="string">"; expected volume "</span> + ps.volumeUuid);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>该方法用于判断 package 是否有效！</p>
<h4 id="5-2-2-2-PackageManagerService-removeCodePathLI"><a href="#5-2-2-2-PackageManagerService-removeCodePathLI" class="headerlink" title="5.2.2.2 PackageManagerService.removeCodePathLI"></a>5.2.2.2 PackageManagerService.removeCodePathLI</h4><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">removeCodePathLI</span><span class="params">(File codePath)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">if</span> (codePath.isDirectory()) &#123;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            mInstaller.rmPackageDir(codePath.getAbsolutePath());</span><br><span class="line">        &#125; <span class="keyword">catch</span> (InstallerException e) &#123;</span><br><span class="line">            Slog.w(TAG, <span class="string">"Failed to remove code path"</span>, e);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        codePath.delete();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>该方法删除指定的 apk 文件！</p>
</div></article><div class="post-copyright"><div class="post-copyright__author"><span class="post-copyright-meta">文章作者: </span><span class="post-copyright-info"><a href="mailto:undefined">Coolqi.Li</a></span></div><div class="post-copyright__type"><span class="post-copyright-meta">文章链接: </span><span class="post-copyright-info"><a href="https://coolqi.top/2018/04/28/PMS6-PMS_READY/">https://coolqi.top/2018/04/28/PMS6-PMS_READY/</a></span></div><div class="post-copyright__notice"><span class="post-copyright-meta">版权声明: </span><span class="post-copyright-info">本博客所有文章除特别声明外，均采用 <a href="https://creativecommons.org/licenses/by-nc-sa/4.0/">CC BY-NC-SA 4.0</a> 许可协议。转载请注明来自 <a href="https://coolqi.top">Coolqi`s Blog</a>！</span></div></div><div class="post-meta__tag-list"><a class="post-meta__tags" href="/tags/PackageManager包管理/">PackageManager包管理</a></div><div class="post-qr-code"><div class="post-qr-code-item"><img class="post-qr-code__img" src="/img/zfb.jpg"><div class="post-qr-code__desc">支付宝打赏</div></div><div class="post-qr-code-item"><img class="post-qr-code__img" src="/img/wechat.jpg"><div class="post-qr-code__desc">微信打赏</div></div></div><div class="social-share"></div><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/social-share.js@1.0.16/dist/css/share.min.css"><script src="https://cdn.jsdelivr.net/npm/social-share.js@1.0.16/dist/js/social-share.min.js"></script><nav id="pagination"><div class="prev-post pull-left"><a href="/2018/05/03/PMS7-installThroughAdb/"><i class="fa fa-chevron-left">  </i><span>PMS 第 7 篇 - 通过 pm 指令分析 Install 过程</span></a></div><div class="next-post pull-right"><a href="/2018/04/13/Javabase-1-SPI/"><span>Java 基础 - SPI 机制原理分析</span><i class="fa fa-chevron-right"></i></a></div></nav></div></div><footer><div class="layout" id="footer"><div class="copyright">&copy;2015 - 2020 By Coolqi.Li</div><div class="framework-info"><span>驱动 - </span><a href="http://hexo.io"><span>Hexo</span></a><span class="footer-separator">|</span><span>主题 - </span><a href="https://github.com/Molunerfinn/hexo-theme-melody"><span>Melody</span></a></div><div class="footer_custom_text">Hi, welcome to my <a href="https://lishuaiqi.top/">blog</a>!</div><div class="busuanzi"><script async src="https://busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script><span id="busuanzi_container_page_pv"><i class="fa fa-file-o"></i><span id="busuanzi_value_page_pv"></span><span></span></span></div></div></footer><i class="fa fa-arrow-up" id="go-up" aria-hidden="true"></i><script src="/js/third-party/anime.min.js"></script><script src="/js/third-party/jquery.min.js"></script><script src="/js/third-party/jquery.fancybox.min.js"></script><script src="/js/third-party/velocity.min.js"></script><script src="/js/third-party/velocity.ui.min.js"></script><script src="/js/utils.js?version=1.5.6"></script><script src="/js/fancybox.js?version=1.5.6"></script><script src="/js/sidebar.js?version=1.5.6"></script><script src="/js/copy.js?version=1.5.6"></script><script src="/js/fireworks.js?version=1.5.6"></script><script src="/js/transition.js?version=1.5.6"></script><script src="/js/scroll.js?version=1.5.6"></script><script src="/js/head.js?version=1.5.6"></script><script type="text/x-mathjax-config">MathJax.Hub.Config({
  tex2jax: {
    inlineMath: [ ['$','$'], ["\\(","\\)"]  ],
    processEscapes: true,
    skipTags: ['script', 'noscript', 'style', 'textarea', 'pre', 'code']
  },
  CommonHTML: {
    linebreaks: { automatic: true, width: "90% container" }
  },
  "HTML-CSS": { 
    linebreaks: { automatic: true, width: "90% container" }
  },
  "SVG": { 
    linebreaks: { automatic: true, width: "90% container" }
  }
});
</script><script type="text/x-mathjax-config">MathJax.Hub.Queue(function() {
  var all = MathJax.Hub.getAllJax(), i;
  for (i=0; i < all.length; i += 1) {
    all[i].SourceElement().parentNode.className += ' has-jax';
  }
});
</script><script src="https://cdn.jsdelivr.net/npm/mathjax/MathJax.js?config=TeX-AMS-MML_HTMLorMML"></script><script src="/js/search/local-search.js"></script><div class="search-dialog" id="local-search"><div class="search-dialog__title" id="local-search-title">本地搜索</div><div id="local-input-panel"><div id="local-search-input"><div class="local-search-box"><input class="local-search-box--input" placeholder="搜索文章"></div></div></div><hr><div id="local-search-results"><div id="local-hits"></div><div id="local-stats"><div class="local-search-stats__hr" id="hr"><span>由</span> <a href="https://github.com/wzpan/hexo-generator-search" style="color:#49B1F5;">hexo-generator-search</a>
 <span>提供支持</span></div></div></div><span class="search-close-button"><i class="fa fa-times"></i></span></div><div class="search-mask"></div></body></html>
<!DOCTYPE html><html lang="zh-Hans"><head><meta charset="UTF-8"><meta http-equiv="X-UA-Compatible" content="IE=edge"><meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1"><meta name="description" content="PMS 第 5 篇 - PMS_SCAN_END 阶段"><meta name="keywords" content="PackageManager包管理"><meta name="author" content="Coolqi.Li,undefined"><meta name="copyright" content="Coolqi.Li"><title>PMS 第 5 篇 - PMS_SCAN_END 阶段 | Coolqi`s Blog</title><link rel="shortcut icon" href="/img/favicon.ico"><link rel="stylesheet" href="/css/index.css?version=1.5.6"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/font-awesome@4.7.0/css/font-awesome.min.css?version=1.5.6"><link rel="dns-prefetch" href="https://cdn.staticfile.org"><link rel="dns-prefetch" href="https://cdn.bootcss.com"><link rel="dns-prefetch" href="https://creativecommons.org"><link rel="dns-prefetch" href="https://hm.baidu.com"><script>var _hmt = _hmt || [];
(function() {
  var hm = document.createElement("script");
  hm.src = "https://hm.baidu.com/hm.js?b7acef5306e54116ad8a99e8b753a92d";
  var s = document.getElementsByTagName("script")[0]; 
  s.parentNode.insertBefore(hm, s);
})();</script><script>var GLOBAL_CONFIG = { 
  root: '/',
  algolia: undefined,
  localSearch: {"path":"search.xml","languages":{"hits_empty":"找不到您查询的内容:${query}"}},
  copy: {
    success: '复制成功',
    error: '复制错误',
    noSupport: '浏览器不支持'
  }
} </script></head><body><i class="fa fa-arrow-right" id="toggle-sidebar" aria-hidden="true"></i><div id="sidebar"><div class="toggle-sidebar-info text-center"><span data-toggle="切换文章详情">切换站点概览</span><hr></div><div class="sidebar-toc"><div class="sidebar-toc__title">目录</div><div class="sidebar-toc__progress"><span class="progress-notice">你已经读了</span><span class="progress-num">0</span><span class="progress-percentage">%</span><div class="sidebar-toc__progress-bar"></div></div><div class="sidebar-toc__content"><ol class="toc"><li class="toc-item toc-level-1"><a class="toc-link" href="#0-综述"><span class="toc-text">0 综述</span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#1-PackageMS-updatePermissionsLPw-更新权限信息"><span class="toc-text">1 PackageMS.updatePermissionsLPw - 更新权限信息</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#1-1-PackageMS-findPermissionTreeLP"><span class="toc-text">1.1 PackageMS.findPermissionTreeLP</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#1-2-PackageMS-grantPermissionsLPw"><span class="toc-text">1.2 PackageMS.grantPermissionsLPw</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#1-2-1-PackageMS-revokeUnusedSharedUserPermissionsLPw"><span class="toc-text">1.2.1 PackageMS.revokeUnusedSharedUserPermissionsLPw</span></a></li></ol></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#2-Settings-applyDefaultPreferredAppsLPw-默认应用设置"><span class="toc-text">2 Settings.applyDefaultPreferredAppsLPw - 默认应用设置</span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#3-PMS-reconcileAppsDataLI-准备数据目录"><span class="toc-text">3 PMS.reconcileAppsDataLI - 准备数据目录</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#3-1-PMS-prepareAppDataLIF"><span class="toc-text">3.1 PMS.prepareAppDataLIF</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#3-2-PMS-prepareAppDataLeafLIF"><span class="toc-text">3.2 PMS.prepareAppDataLeafLIF</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#3-3-PMS-prepareAppDataContentsLeafLIF"><span class="toc-text">3.3 PMS.prepareAppDataContentsLeafLIF</span></a></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#4-PackageManagerService-clearAppDataLIF"><span class="toc-text">4 PackageManagerService.clearAppDataLIF</span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#5-Settings-writeLPr-持久化最新数据"><span class="toc-text">5 Settings.writeLPr - 持久化最新数据</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#5-1-Settings-writePermissionLPr-保存-“permission-trees”-“permission”"><span class="toc-text">5.1 Settings.writePermissionLPr - 保存 “permission-trees” / “permission”</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#5-2-Settings-writePackageLPr-保存-“package”"><span class="toc-text">5.2 Settings.writePackageLPr - 保存 “package”</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#5-3-Settings-writeDisabledSysPackageLPr-保存-“updated-package”"><span class="toc-text">5.3 Settings.writeDisabledSysPackageLPr - 保存 “updated-package”</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#5-4-Settings-writePackageListLPr-写入-“packages-list”"><span class="toc-text">5.4 Settings.writePackageListLPr - 写入 “packages.list”</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#5-5-Settings-writeAllUsersPackageRestrictionsLPr-保存偏好设置"><span class="toc-text">5.5 Settings.writeAllUsersPackageRestrictionsLPr - 保存偏好设置</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#5-6-Settings-writeAllRuntimePermissionsLPr-保存运行时权限授予信息"><span class="toc-text">5.6 Settings.writeAllRuntimePermissionsLPr - 保存运行时权限授予信息</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#5-6-1-RuntimePermissionsPersistence-writePermissionsForUserAsyncLPr"><span class="toc-text">5.6.1 RuntimePermissionsPersistence.writePermissionsForUserAsyncLPr</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#5-6-2-RuntimePermissionsPersistence-MyHandler-handleMessage"><span class="toc-text">5.6.2 RuntimePermissionsPersistence.MyHandler.handleMessage</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#5-6-3-RuntimePermissionsPersistence-writePermissionsSync"><span class="toc-text">5.6.3 RuntimePermissionsPersistence.writePermissionsSync</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#5-6-3-1-RuntimePermissionsPersistence-writePermissions"><span class="toc-text">5.6.3.1 RuntimePermissionsPersistence.writePermissions</span></a></li></ol></li></ol></li></ol></li></ol></div></div><div class="author-info hide"><div class="author-info__avatar text-center"><img src="/img/avatar.png"></div><div class="author-info__name text-center">Coolqi.Li</div><div class="author-info__description text-center">“你好，我是李帅奇，Android 系统工程师，MineCraft 忠实玩家，设计和绘画爱好者，缺妹纸晚期患者，熬夜星人。”</div><hr><div class="author-info-articles"><a class="author-info-articles__archives article-meta" href="/archives"><span class="pull-left">文章</span><span class="pull-right">71</span></a><a class="author-info-articles__tags article-meta" href="/tags"><span class="pull-left">标签</span><span class="pull-right">16</span></a><a class="author-info-articles__categories article-meta" href="/categories"><span class="pull-left">分类</span><span class="pull-right">18</span></a></div><hr><div class="author-info-links"><div class="author-info-links__title text-center">Links</div><a class="author-info-links__name text-center" href="https://developer.android.google.cn/">AndroidDeveloper</a><a class="author-info-links__name text-center" href="http://www.android-studio.org/">AndroidStudio</a><a class="author-info-links__name text-center" href="https://www.jianshu.com/u/123a20a96441">简书</a><a class="author-info-links__name text-center" href="https://weibo.com/coolqiLi">微博</a></div></div></div><div id="content-outer"><div id="top-container" style="background-image: url(https://ws1.sinaimg.cn/large/8700af19ly1fvpabr30o6j22yo1o0q7i.jpg)"><div id="page-header"><span class="pull-left"> <a id="site-name" href="/">Coolqi`s Blog</a></span><i class="fa fa-bars toggle-menu pull-right" aria-hidden="true"></i><span class="pull-right menus"><a class="site-page social-icon search"><i class="fa fa-search"></i><span> 搜索</span></a><a class="site-page" href="/">Home</a><a class="site-page" href="/categories">Categories</a><a class="site-page" href="/tags">Tags</a><a class="site-page" href="/archives">Archives</a><a class="site-page" href="/about">About</a></span></div><div id="post-info"><div id="post-title">PMS 第 5 篇 - PMS_SCAN_END 阶段</div><div id="post-meta"><time class="post-meta__date"><i class="fa fa-calendar" aria-hidden="true"></i> 2018-03-03</time><span class="post-meta__separator">|</span><i class="fa fa-inbox post-meta__icon" aria-hidden="true"></i><a class="post-meta__categories" href="/categories/AndroidFramework源码分析/">AndroidFramework源码分析</a><i class="fa fa-angle-right" aria-hidden="true"></i><i class="fa fa-inbox post-meta__icon" aria-hidden="true"></i><a class="post-meta__categories" href="/categories/AndroidFramework源码分析/PackageManager包管理/">PackageManager包管理</a><div class="post-meta-wordcount"><span>字数总计: </span><span class="word-count">11k</span><span class="post-meta__separator">|</span><span>阅读时长: 52 分钟</span></div></div></div></div><div class="layout" id="content-inner"><article id="post"><div class="article-container" id="post-content"><p>[toc]</p>
<p>基于 Android 7.1.1 源码分析 PackageManagerService 的架构和逻辑实现，本文是作者原创，转载请说明出处！</p>
<h1 id="0-综述"><a href="#0-综述" class="headerlink" title="0 综述"></a>0 综述</h1><p>system 分区和 data 分区的扫描过程到这里就结束了，下面我们来分析下：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br></pre></td><td class="code"><pre><span class="line">... ... ... ...<span class="comment">// 第四阶段</span></span><br><span class="line"></span><br><span class="line">EventLog.writeEvent(EventLogTags.BOOT_PROGRESS_PMS_SCAN_END,</span><br><span class="line">        SystemClock.uptimeMillis());</span><br><span class="line"></span><br><span class="line">Slog.i(TAG, <span class="string">"Time to scan packages: "</span></span><br><span class="line">        + ((SystemClock.uptimeMillis()-startTime)/<span class="number">1000f</span>)</span><br><span class="line">        + <span class="string">" seconds"</span>);</span><br><span class="line"></span><br><span class="line"><span class="comment">// 如果从我们上次启动，SDK 平台被改变了，我们需要重新授予应用程序权限。</span></span><br><span class="line"><span class="comment">// 这里会有一些安全问题，就是可能会有应用通过这种方式获取那些用户没有显式允许的权限</span></span><br><span class="line"><span class="comment">// 这里可能后续 google 会改善！</span></span><br><span class="line"><span class="keyword">int</span> updateFlags = UPDATE_PERMISSIONS_ALL;</span><br><span class="line"><span class="keyword">if</span> (ver.sdkVersion != mSdkVersion) &#123;</span><br><span class="line">    Slog.i(TAG, <span class="string">"Platform changed from "</span> + ver.sdkVersion + <span class="string">" to "</span></span><br><span class="line">            + mSdkVersion + <span class="string">"; regranting permissions for internal storage"</span>);</span><br><span class="line">    updateFlags |= UPDATE_PERMISSIONS_REPLACE_PKG | UPDATE_PERMISSIONS_REPLACE_ALL;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">//【1】更新系统中的权限和权限树，移除无效的权限和权限树，同时更新应用的权限授予情况！</span></span><br><span class="line">updatePermissionsLPw(<span class="keyword">null</span>, <span class="keyword">null</span>, StorageManager.UUID_PRIVATE_INTERNAL, updateFlags);</span><br><span class="line">ver.sdkVersion = mSdkVersion;</span><br><span class="line"></span><br><span class="line"><span class="comment">//【2】如果这是第一次开机或从 Anroid M之前的版本升级上来的，然后我们需要初始化默认应用程序给所有的系统用户！</span></span><br><span class="line"><span class="keyword">if</span> (!onlyCore &amp;&amp; (mPromoteSystemApps || mFirstBoot)) &#123;</span><br><span class="line">    <span class="keyword">for</span> (UserInfo user : sUserManager.getUsers(<span class="keyword">true</span>)) &#123;</span><br><span class="line">        mSettings.applyDefaultPreferredAppsLPw(<span class="keyword">this</span>, user.id);</span><br><span class="line">        applyFactoryDefaultBrowserLPw(user.id);</span><br><span class="line">        primeDomainVerificationsLPw(user.id);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">//【3】在启动完成前，为系统用户准备文件存储，因为很多核心的系统比如设置，系统界面等等会提前启动！</span></span><br><span class="line"><span class="keyword">final</span> <span class="keyword">int</span> storageFlags;</span><br><span class="line"><span class="keyword">if</span> (StorageManager.isFileEncryptedNativeOrEmulated()) &#123;</span><br><span class="line">    storageFlags = StorageManager.FLAG_STORAGE_DE;</span><br><span class="line">&#125; <span class="keyword">else</span> &#123;</span><br><span class="line">    storageFlags = StorageManager.FLAG_STORAGE_DE | StorageManager.FLAG_STORAGE_CE;</span><br><span class="line">&#125;</span><br><span class="line">reconcileAppsDataLI(StorageManager.UUID_PRIVATE_INTERNAL, UserHandle.USER_SYSTEM,</span><br><span class="line">        storageFlags);</span><br><span class="line"></span><br><span class="line"><span class="comment">//【4】如果这是在 OTA 升级后第一次正常启动，然后我们需要清除代码缓存目录。</span></span><br><span class="line"><span class="comment">// 我们这里使用了 Installer.FLAG_CLEAR_CODE_CACHE_ONLY 标志位；</span></span><br><span class="line"><span class="keyword">if</span> (mIsUpgrade &amp;&amp; !onlyCore) &#123;</span><br><span class="line">    Slog.i(TAG, <span class="string">"Build fingerprint changed; clearing code caches"</span>);</span><br><span class="line">    <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; mSettings.mPackages.size(); i++) &#123;</span><br><span class="line">        <span class="keyword">final</span> PackageSetting ps = mSettings.mPackages.valueAt(i);</span><br><span class="line">        <span class="keyword">if</span> (Objects.equals(StorageManager.UUID_PRIVATE_INTERNAL, ps.volumeUuid)) &#123;</span><br><span class="line">            clearAppDataLIF(ps.pkg, UserHandle.USER_ALL,</span><br><span class="line">                    StorageManager.FLAG_STORAGE_DE | StorageManager.FLAG_STORAGE_CE</span><br><span class="line">                            | Installer.FLAG_CLEAR_CODE_CACHE_ONLY);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    ver.fingerprint = Build.FINGERPRINT;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">checkDefaultBrowser(); <span class="comment">// 检查默认的浏览器</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// 当权限和其他默认设置被更新后，执行清除操作！</span></span><br><span class="line">mExistingSystemPackages.clear();</span><br><span class="line">mPromoteSystemApps = <span class="keyword">false</span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 更新系统数据库版本号！</span></span><br><span class="line">ver.databaseVersion = Settings.CURRENT_DATABASE_VERSION;</span><br><span class="line"></span><br><span class="line"><span class="comment">//【5】信息写回 packages.xml 等文件！</span></span><br><span class="line">mSettings.writeLPr();</span><br><span class="line"></span><br><span class="line"><span class="comment">//【6】如果是第一次开机，或者是系统升级，对核心的系统应用执行 odex 操作！</span></span><br><span class="line"><span class="keyword">if</span> ((isFirstBoot() || isUpgrade() || VMRuntime.didPruneDalvikCache()) &amp;&amp; !onlyCore) &#123;</span><br><span class="line">    <span class="keyword">long</span> start = System.nanoTime();</span><br><span class="line">    List&lt;PackageParser.Package&gt; coreApps = <span class="keyword">new</span> ArrayList&lt;&gt;();</span><br><span class="line">    <span class="keyword">for</span> (PackageParser.Package pkg : mPackages.values()) &#123;</span><br><span class="line">        <span class="keyword">if</span> (pkg.coreApp) &#123;</span><br><span class="line">            coreApps.add(pkg);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">int</span>[] stats = performDexOptUpgrade(coreApps, <span class="keyword">false</span>,</span><br><span class="line">            getCompilerFilterForReason(REASON_CORE_APP));</span><br><span class="line"></span><br><span class="line">    <span class="keyword">final</span> <span class="keyword">int</span> elapsedTimeSeconds =</span><br><span class="line">            (<span class="keyword">int</span>) TimeUnit.NANOSECONDS.toSeconds(System.nanoTime() - start);</span><br><span class="line">    MetricsLogger.histogram(mContext, <span class="string">"opt_coreapps_time_s"</span>, elapsedTimeSeconds);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (DEBUG_DEXOPT) &#123;</span><br><span class="line">        Slog.i(TAG, <span class="string">"Dex-opt core apps took : "</span> + elapsedTimeSeconds + <span class="string">" seconds ("</span> +</span><br><span class="line">                stats[<span class="number">0</span>] + <span class="string">", "</span> + stats[<span class="number">1</span>] + <span class="string">", "</span> + stats[<span class="number">2</span>] + <span class="string">")"</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="comment">// <span class="doctag">TODO:</span> Should we log these stats to tron too ?</span></span><br><span class="line">    <span class="comment">// MetricsLogger.histogram(mContext, "opt_coreapps_num_dexopted", stats[0]);</span></span><br><span class="line">    <span class="comment">// MetricsLogger.histogram(mContext, "opt_coreapps_num_skipped", stats[1]);</span></span><br><span class="line">    <span class="comment">// MetricsLogger.histogram(mContext, "opt_coreapps_num_failed", stats[2]);</span></span><br><span class="line">    <span class="comment">// MetricsLogger.histogram(mContext, "opt_coreapps_num_total", coreApps.size());</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">... ... ... ...<span class="comment">// 见，第五阶段</span></span><br></pre></td></tr></table></figure>
<p>下面我们来分析下这个过程！</p>
<h1 id="1-PackageMS-updatePermissionsLPw-更新权限信息"><a href="#1-PackageMS-updatePermissionsLPw-更新权限信息" class="headerlink" title="1 PackageMS.updatePermissionsLPw - 更新权限信息"></a>1 PackageMS.updatePermissionsLPw - 更新权限信息</h1><p>updatePermissionsLPw 方法用于更新应用的权限信息，首先我们来看看 updateFlags！</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">int</span> updateFlags = UPDATE_PERMISSIONS_ALL; <span class="comment">// 表示更新所有的权限信息；</span></span><br><span class="line"><span class="keyword">if</span> (ver.sdkVersion != mSdkVersion) &#123;</span><br><span class="line">    <span class="comment">// 如果 sdkVersion 发生了变化，还会额外的设置以下的 2 个权限！</span></span><br><span class="line">    <span class="comment">// sdkVersion 发生变化一般是在大版本系统升级时，比如 7.1 升级 8.0！</span></span><br><span class="line">    Slog.i(TAG, <span class="string">"Platform changed from "</span> + ver.sdkVersion + <span class="string">" to "</span></span><br><span class="line">            + mSdkVersion + <span class="string">"; regranting permissions for internal storage"</span>);</span><br><span class="line">    updateFlags |= UPDATE_PERMISSIONS_REPLACE_PKG | UPDATE_PERMISSIONS_REPLACE_ALL;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>updatePermissionsLPw 的逻辑如下，这里的 changingPkg 和 pkgInfo 均为 null；</p>
<p>replaceVolumeUuid 的值为：StorageManager.UUID_PRIVATE_INTERNAL，表示的是安装位置，这里传入的值表示内置存储；</p>
<p>（这里简单的说一下参数的意思：String changingPkg 指定了权限发生变化的包名，PackageParser.Package pkgInfo 表示的是 changingPkg 对应的应用的信息）</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">updatePermissionsLPw</span><span class="params">(String changingPkg,</span></span></span><br><span class="line"><span class="function"><span class="params">        PackageParser.Package pkgInfo, String replaceVolumeUuid, <span class="keyword">int</span> flags)</span> </span>&#123;</span><br><span class="line">    <span class="comment">//【1】确保系统中没有废弃的权限树；</span></span><br><span class="line">    Iterator&lt;BasePermission&gt; it = mSettings.mPermissionTrees.values().iterator();</span><br><span class="line">    <span class="keyword">while</span> (it.hasNext()) &#123;</span><br><span class="line">        <span class="keyword">final</span> BasePermission bp = it.next();</span><br><span class="line">        <span class="keyword">if</span> (bp.packageSetting == <span class="keyword">null</span>) &#123;</span><br><span class="line">            <span class="comment">//【1.1】如果 packageSetting 为 null，尝试查找定义的 package！</span></span><br><span class="line">            bp.packageSetting = mSettings.mPackages.get(bp.sourcePackage);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (bp.packageSetting == <span class="keyword">null</span>) &#123;</span><br><span class="line">            <span class="comment">//【1.2】如果找不到定义该权限的 package，那就移除该 permission-tree！</span></span><br><span class="line">            Slog.w(TAG, <span class="string">"Removing dangling permission tree: "</span> + bp.name</span><br><span class="line">                    + <span class="string">" from package "</span> + bp.sourcePackage);</span><br><span class="line">            it.remove();</span><br><span class="line"></span><br><span class="line">        &#125; <span class="keyword">else</span> <span class="keyword">if</span> (changingPkg != <span class="keyword">null</span> &amp;&amp; changingPkg.equals(bp.sourcePackage)) &#123;</span><br><span class="line">            <span class="comment">//【1.3】根据参数，不进入这里，但是我们来分析下这部分代码的意思</span></span><br><span class="line">            <span class="comment">// 如果权限的定义者不再定义这个权限了，那就移除该权限的上一次信息！</span></span><br><span class="line">            <span class="keyword">if</span> (pkgInfo == <span class="keyword">null</span> || !hasPermission(pkgInfo, bp.name)) &#123;</span><br><span class="line">                Slog.i(TAG, <span class="string">"Removing old permission tree: "</span> + bp.name</span><br><span class="line">                        + <span class="string">" from package "</span> + bp.sourcePackage);</span><br><span class="line">                <span class="comment">//【1.3.1】同时 flags 会被设置 UPDATE_PERMISSIONS_ALL 标志位！</span></span><br><span class="line">                flags |= UPDATE_PERMISSIONS_ALL;</span><br><span class="line">                it.remove();</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//【2】确保系统中所有的动态权限都已经分配给对应的 package，同时系统中也没有废弃的权限!</span></span><br><span class="line">    it = mSettings.mPermissions.values().iterator();</span><br><span class="line">    <span class="keyword">while</span> (it.hasNext()) &#123;</span><br><span class="line">        <span class="keyword">final</span> BasePermission bp = it.next();</span><br><span class="line">        <span class="comment">//【2.1】如果是动态权限，尝试找到其所属的 permission-tree，并绑定到定义 tree 的 package 上！</span></span><br><span class="line">        <span class="keyword">if</span> (bp.type == BasePermission.TYPE_DYNAMIC) &#123;</span><br><span class="line">            <span class="keyword">if</span> (DEBUG_SETTINGS) Log.v(TAG, <span class="string">"Dynamic permission: name="</span></span><br><span class="line">                    + bp.name + <span class="string">" pkg="</span> + bp.sourcePackage</span><br><span class="line">                    + <span class="string">" info="</span> + bp.pendingInfo);</span><br><span class="line"></span><br><span class="line">            <span class="keyword">if</span> (bp.packageSetting == <span class="keyword">null</span> &amp;&amp; bp.pendingInfo != <span class="keyword">null</span>) &#123;</span><br><span class="line">                <span class="keyword">final</span> BasePermission tree = findPermissionTreeLP(bp.name);</span><br><span class="line">                <span class="keyword">if</span> (tree != <span class="keyword">null</span> &amp;&amp; tree.perm != <span class="keyword">null</span>) &#123;</span><br><span class="line">                    bp.packageSetting = tree.packageSetting;</span><br><span class="line">                    bp.perm = <span class="keyword">new</span> PackageParser.Permission(tree.perm.owner,</span><br><span class="line">                            <span class="keyword">new</span> PermissionInfo(bp.pendingInfo));</span><br><span class="line">                    bp.perm.info.packageName = tree.perm.info.packageName;</span><br><span class="line">                    bp.perm.info.name = bp.name;</span><br><span class="line">                    bp.uid = tree.uid;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment">//【2.2】如果权限的定义者为 null，尝试在系统中找到定义者！</span></span><br><span class="line">        <span class="keyword">if</span> (bp.packageSetting == <span class="keyword">null</span>) &#123;</span><br><span class="line">            bp.packageSetting = mSettings.mPackages.get(bp.sourcePackage);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment">//【2.3】如果依然找不到定义该权限的 package，那就移除该 permission ！</span></span><br><span class="line">        <span class="keyword">if</span> (bp.packageSetting == <span class="keyword">null</span>) &#123; <span class="comment">// 该权限无效，移除它！</span></span><br><span class="line">            Slog.w(TAG, <span class="string">"Removing dangling permission: "</span> + bp.name</span><br><span class="line">                    + <span class="string">" from package "</span> + bp.sourcePackage);</span><br><span class="line">            it.remove();</span><br><span class="line"></span><br><span class="line">        &#125; <span class="keyword">else</span> <span class="keyword">if</span> (changingPkg != <span class="keyword">null</span> &amp;&amp; changingPkg.equals(bp.sourcePackage)) &#123;</span><br><span class="line">            <span class="comment">//【2.4】根据参数，不进入这里，但是我们来分析下这部分代码的意思</span></span><br><span class="line">            <span class="comment">// 如果权限的定义者不在定义这个权限了，那就移除该权限的上一次信息！</span></span><br><span class="line">            <span class="keyword">if</span> (pkgInfo == <span class="keyword">null</span> || !hasPermission(pkgInfo, bp.name)) &#123;</span><br><span class="line">                Slog.i(TAG, <span class="string">"Removing old permission: "</span> + bp.name</span><br><span class="line">                        + <span class="string">" from package "</span> + bp.sourcePackage);</span><br><span class="line">                <span class="comment">//【2.4.1】同时 flags 会被设置 UPDATE_PERMISSIONS_ALL 标志位！</span></span><br><span class="line">                flags |= UPDATE_PERMISSIONS_ALL;</span><br><span class="line">                it.remove();</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//【3】如果 flags 设置了 UPDATE_PERMISSIONS_ALL 标志位，那么就更新除了 changingPkg 以外的其他</span></span><br><span class="line">    <span class="comment">// 所有的 package 的权限授予信息 ，特别是替换系统包的授予权限！</span></span><br><span class="line">    <span class="keyword">if</span> ((flags &amp; UPDATE_PERMISSIONS_ALL) != <span class="number">0</span>) &#123;</span><br><span class="line">        <span class="keyword">for</span> (PackageParser.Package pkg : mPackages.values()) &#123;</span><br><span class="line">            <span class="keyword">if</span> (pkg != pkgInfo) &#123;</span><br><span class="line">                <span class="comment">//【3.1】获得该应用的安装位置，我们只会修改安装在 replaceVolumeUuid 指定的位置的应用的权限信息！</span></span><br><span class="line">                <span class="comment">// 当然默认是在内置存储，所以返回的是 UUID_PRIVATE_INTERNAL！</span></span><br><span class="line">                <span class="keyword">final</span> String volumeUuid = getVolumeUuidForPackage(pkg);</span><br><span class="line">                <span class="comment">// 如果 sdk 发生了变化，replace 为 true！</span></span><br><span class="line">                <span class="keyword">final</span> <span class="keyword">boolean</span> replace = ((flags &amp; UPDATE_PERMISSIONS_REPLACE_ALL) != <span class="number">0</span>)</span><br><span class="line">                        &amp;&amp; Objects.equals(replaceVolumeUuid, volumeUuid);</span><br><span class="line">                <span class="comment">//【×1.2】重新授予其他 pkg 权限！</span></span><br><span class="line">                grantPermissionsLPw(pkg, replace, changingPkg);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//【4】因为这里 pkgInfo 为 null，所以不进入这里！</span></span><br><span class="line">    <span class="comment">// 这里的逻辑是，如果 changingPkg 不为 null，最后也会更新其权限的授予信息！</span></span><br><span class="line">    <span class="keyword">if</span> (pkgInfo != <span class="keyword">null</span>) &#123; </span><br><span class="line">        <span class="comment">//【4.1】获得该应用的安装位置，我们只会修改安装在 replaceVolumeUuid 指定的位置的应用的权限信息！</span></span><br><span class="line">        <span class="comment">// 当然默认是在内置存储，所以返回的是 UUID_PRIVATE_INTERNAL！</span></span><br><span class="line">        <span class="keyword">final</span> String volumeUuid = getVolumeUuidForPackage(pkgInfo);</span><br><span class="line">        <span class="comment">// 如果 sdk 发生了变化，replace 为 true！</span></span><br><span class="line">        <span class="keyword">final</span> <span class="keyword">boolean</span> replace = ((flags &amp; UPDATE_PERMISSIONS_REPLACE_PKG) != <span class="number">0</span>)</span><br><span class="line">                &amp;&amp; Objects.equals(replaceVolumeUuid, volumeUuid);</span><br><span class="line">        <span class="comment">//【×1.2】重新授予发生 change 的 pkg 权限！</span></span><br><span class="line">        grantPermissionsLPw(pkgInfo, replace, changingPkg);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>由于这里的 changingPkg 和 pkgInfo 均为 null，所以不仅移除了无效的权限和权限树，而且更新了系统中所有应用的权限信息！</p>
<p>这里涉及到了 flags 标志位，可以取以下值：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">static</span> <span class="keyword">final</span> <span class="keyword">int</span> UPDATE_PERMISSIONS_ALL = <span class="number">1</span>&lt;&lt;<span class="number">0</span>; <span class="comment">// 更新所有应用的权限信息；</span></span><br><span class="line"><span class="keyword">static</span> <span class="keyword">final</span> <span class="keyword">int</span> UPDATE_PERMISSIONS_REPLACE_PKG = <span class="number">1</span>&lt;&lt;<span class="number">1</span>;</span><br><span class="line"><span class="keyword">static</span> <span class="keyword">final</span> <span class="keyword">int</span> UPDATE_PERMISSIONS_REPLACE_ALL = <span class="number">1</span>&lt;&lt;<span class="number">2</span>;</span><br></pre></td></tr></table></figure>
<p>下面的分析过程中会遇到：</p>
<p>我们继续分析！</p>
<h2 id="1-1-PackageMS-findPermissionTreeLP"><a href="#1-1-PackageMS-findPermissionTreeLP" class="headerlink" title="1.1 PackageMS.findPermissionTreeLP"></a>1.1 PackageMS.findPermissionTreeLP</h2><p>找到权限名所属的权限树！<br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">private</span> BasePermission <span class="title">findPermissionTreeLP</span><span class="params">(String permName)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">for</span>(BasePermission bp : mSettings.mPermissionTrees.values()) &#123;</span><br><span class="line">        <span class="keyword">if</span> (permName.startsWith(bp.name) &amp;&amp;</span><br><span class="line">                permName.length() &gt; bp.name.length() &amp;&amp;</span><br><span class="line">                permName.charAt(bp.name.length()) == <span class="string">'.'</span>) &#123;</span><br><span class="line">            <span class="keyword">return</span> bp;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">null</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<h2 id="1-2-PackageMS-grantPermissionsLPw"><a href="#1-2-PackageMS-grantPermissionsLPw" class="headerlink" title="1.2 PackageMS.grantPermissionsLPw"></a>1.2 PackageMS.grantPermissionsLPw</h2><p>在更新过权限后，会再次授予应用权限，因为可能有些权限已经失效并且被移除！</p>
<p>Android 系统有两种类型的权限：安装和运行时，dangerous 属于运行时权限，normal 和 signiture 属于安装时权限。 </p>
<p>正常和签名保护级别的权限是安装时权限。 而危险级别的权限是运行时权限！</p>
<p>如果应用的目标 SDK 为 Lollipop MR1 或更早版本，则运行时权限默认按照安装时权限处理。根据上面的代码跟踪</p>
<p>这里的 replace 为 true，由于我们是更新所有的 pacakge，所以 pkg 和 packageOfInterest 均为 null，参数 pkg 是需要更新权限授予信息的应用！</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br><span class="line">212</span><br><span class="line">213</span><br><span class="line">214</span><br><span class="line">215</span><br><span class="line">216</span><br><span class="line">217</span><br><span class="line">218</span><br><span class="line">219</span><br><span class="line">220</span><br><span class="line">221</span><br><span class="line">222</span><br><span class="line">223</span><br><span class="line">224</span><br><span class="line">225</span><br><span class="line">226</span><br><span class="line">227</span><br><span class="line">228</span><br><span class="line">229</span><br><span class="line">230</span><br><span class="line">231</span><br><span class="line">232</span><br><span class="line">233</span><br><span class="line">234</span><br><span class="line">235</span><br><span class="line">236</span><br><span class="line">237</span><br><span class="line">238</span><br><span class="line">239</span><br><span class="line">240</span><br><span class="line">241</span><br><span class="line">242</span><br><span class="line">243</span><br><span class="line">244</span><br><span class="line">245</span><br><span class="line">246</span><br><span class="line">247</span><br><span class="line">248</span><br><span class="line">249</span><br><span class="line">250</span><br><span class="line">251</span><br><span class="line">252</span><br><span class="line">253</span><br><span class="line">254</span><br><span class="line">255</span><br><span class="line">256</span><br><span class="line">257</span><br><span class="line">258</span><br><span class="line">259</span><br><span class="line">260</span><br><span class="line">261</span><br><span class="line">262</span><br><span class="line">263</span><br><span class="line">264</span><br><span class="line">265</span><br><span class="line">266</span><br><span class="line">267</span><br><span class="line">268</span><br><span class="line">269</span><br><span class="line">270</span><br><span class="line">271</span><br><span class="line">272</span><br><span class="line">273</span><br><span class="line">274</span><br><span class="line">275</span><br><span class="line">276</span><br><span class="line">277</span><br><span class="line">278</span><br><span class="line">279</span><br><span class="line">280</span><br><span class="line">281</span><br><span class="line">282</span><br><span class="line">283</span><br><span class="line">284</span><br><span class="line">285</span><br><span class="line">286</span><br><span class="line">287</span><br><span class="line">288</span><br><span class="line">289</span><br><span class="line">290</span><br><span class="line">291</span><br><span class="line">292</span><br><span class="line">293</span><br><span class="line">294</span><br><span class="line">295</span><br><span class="line">296</span><br><span class="line">297</span><br><span class="line">298</span><br><span class="line">299</span><br><span class="line">300</span><br><span class="line">301</span><br><span class="line">302</span><br><span class="line">303</span><br><span class="line">304</span><br><span class="line">305</span><br><span class="line">306</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">grantPermissionsLPw</span><span class="params">(PackageParser.Package pkg, <span class="keyword">boolean</span> replace,</span></span></span><br><span class="line"><span class="function"><span class="params">        String packageOfInterest)</span> </span>&#123;</span><br><span class="line">    <span class="comment">//【1】如果该应用的 PackageSetting 没有，那么不处理！</span></span><br><span class="line">    <span class="keyword">final</span> PackageSetting ps = (PackageSetting) pkg.mExtras;</span><br><span class="line">    <span class="keyword">if</span> (ps == <span class="keyword">null</span>) &#123;</span><br><span class="line">        <span class="keyword">return</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    Trace.traceBegin(TRACE_TAG_PACKAGE_MANAGER, <span class="string">"grantPermissions"</span>);</span><br><span class="line">    </span><br><span class="line">    <span class="comment">//【2】获得该 package 的权限管理对象，此时这个权限管理对象是解析上次安装信息时恢复的！</span></span><br><span class="line">    <span class="comment">// 我们将其保存到 origPermissions 中，作为原始数据！</span></span><br><span class="line">    PermissionsState permissionsState = ps.getPermissionsState();</span><br><span class="line">    PermissionsState origPermissions = permissionsState;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">final</span> <span class="keyword">int</span>[] currentUserIds = UserManagerService.getInstance().getUserIds();</span><br><span class="line"></span><br><span class="line">    <span class="keyword">boolean</span> runtimePermissionsRevoked = <span class="keyword">false</span>;</span><br><span class="line">    <span class="keyword">int</span>[] changedRuntimePermissionUserIds = EMPTY_INT_ARRAY;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">boolean</span> changedInstallPermission = <span class="keyword">false</span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//【3】如果 replace 的值为 true，进入这里！</span></span><br><span class="line">    <span class="keyword">if</span> (replace) &#123;</span><br><span class="line">        <span class="comment">// 设置 installPermissionsFixed 为 false，因为下面会对权限信息调整！</span></span><br><span class="line">        ps.installPermissionsFixed = <span class="keyword">false</span>;</span><br><span class="line">        <span class="keyword">if</span> (!ps.isSharedUser()) &#123;</span><br><span class="line">            <span class="comment">//【3.1】如果该 package 不是共享 uid 的，那就重置 permissionsState，但是会将</span></span><br><span class="line">            <span class="comment">// 原始信息 copy到 origPermissions 中！</span></span><br><span class="line">            origPermissions = <span class="keyword">new</span> PermissionsState(permissionsState);</span><br><span class="line">            permissionsState.reset();</span><br><span class="line"></span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            <span class="comment">//【3.2】如果该 package 是共享 uid 的，那么我们会拒绝那些不用的共享 uid 相关权限信息！</span></span><br><span class="line">            <span class="comment">// （我们只需要知道运行时权限更改，因为调用代码总是写入安装权限状态，但是运行时权限只有在更改时才写入。</span></span><br><span class="line">            <span class="comment">// 这里更改运行时权限的唯一情况是将安装提升到运行时并从共享用户撤消运行时。）</span></span><br><span class="line">            <span class="comment">// 上面这段文字是根据注释翻译的，生涩，目前我自己也不是很明白。。。</span></span><br><span class="line">            changedRuntimePermissionUserIds = revokeUnusedSharedUserPermissionsLPw(</span><br><span class="line">                    ps.sharedUser, UserManagerService.getInstance().getUserIds());</span><br><span class="line">            <span class="keyword">if</span> (!ArrayUtils.isEmpty(changedRuntimePermissionUserIds)) &#123;</span><br><span class="line">                runtimePermissionsRevoked = <span class="keyword">true</span>;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    permissionsState.setGlobalGids(mGlobalGids);</span><br><span class="line"></span><br><span class="line">    <span class="comment">//【4】处理该 package 请求的所有权限！</span></span><br><span class="line">    <span class="keyword">final</span> <span class="keyword">int</span> N = pkg.requestedPermissions.size();</span><br><span class="line">    <span class="keyword">for</span> (<span class="keyword">int</span> i=<span class="number">0</span>; i &lt; N; i++) &#123;</span><br><span class="line">        <span class="keyword">final</span> String name = pkg.requestedPermissions.get(i);</span><br><span class="line">        <span class="keyword">final</span> BasePermission bp = mSettings.mPermissions.get(name);</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (DEBUG_INSTALL) &#123;</span><br><span class="line">            Log.i(TAG, <span class="string">"Package "</span> + pkg.packageName + <span class="string">" checking "</span> + name + <span class="string">": "</span> + bp);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">//【4.1】如果该权限没有定义，那么跳过！！</span></span><br><span class="line">        <span class="keyword">if</span> (bp == <span class="keyword">null</span> || bp.packageSetting == <span class="keyword">null</span>) &#123;</span><br><span class="line">            <span class="keyword">if</span> (packageOfInterest == <span class="keyword">null</span> || packageOfInterest.equals(pkg.packageName)) &#123;</span><br><span class="line">                Slog.w(TAG, <span class="string">"Unknown permission "</span> + name</span><br><span class="line">                        + <span class="string">" in package "</span> + pkg.packageName);</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">continue</span>;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">final</span> String perm = bp.name;</span><br><span class="line">        <span class="keyword">boolean</span> allowedSig = <span class="keyword">false</span>;</span><br><span class="line">        <span class="keyword">int</span> grant = GRANT_DENIED; <span class="comment">// 用于保存每个权限的授予情况！</span></span><br><span class="line"></span><br><span class="line">        <span class="comment">//【4.2】如果申请的权限设置了 PROTECTION_FLAG_APPOP 标志位，</span></span><br><span class="line">        <span class="comment">// 我们会将其添加到 mAppOpPermissionPackages 进行监控！</span></span><br><span class="line">        <span class="keyword">if</span> ((bp.protectionLevel &amp; PermissionInfo.PROTECTION_FLAG_APPOP) != <span class="number">0</span>) &#123;</span><br><span class="line">            ArraySet&lt;String&gt; pkgs = mAppOpPermissionPackages.get(bp.name);</span><br><span class="line">            <span class="keyword">if</span> (pkgs == <span class="keyword">null</span>) &#123;</span><br><span class="line">                pkgs = <span class="keyword">new</span> ArraySet&lt;&gt;();</span><br><span class="line">                mAppOpPermissionPackages.put(bp.name, pkgs);</span><br><span class="line">            &#125;</span><br><span class="line">            pkgs.add(pkg.packageName);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment">//【4.3】计算权限的基本类型，并判断应用是否支持运行时权限！！！</span></span><br><span class="line">        <span class="keyword">final</span> <span class="keyword">int</span> level = bp.protectionLevel &amp; PermissionInfo.PROTECTION_MASK_BASE;</span><br><span class="line">        <span class="keyword">final</span> <span class="keyword">boolean</span> appSupportsRuntimePermissions = pkg.applicationInfo.targetSdkVersion</span><br><span class="line">                &gt;= Build.VERSION_CODES.M;</span><br><span class="line"></span><br><span class="line">        <span class="comment">//【4.4】根据权限的基本类型，判断权限的授予情况！！</span></span><br><span class="line">        <span class="keyword">switch</span> (level) &#123;</span><br><span class="line">            <span class="keyword">case</span> PermissionInfo.PROTECTION_NORMAL: &#123; </span><br><span class="line">                <span class="comment">//【4.4.1】基本类型为 normal，为安装时权限，默认授予！</span></span><br><span class="line">                grant = GRANT_INSTALL;</span><br><span class="line">            &#125; <span class="keyword">break</span>;</span><br><span class="line"></span><br><span class="line">            <span class="keyword">case</span> PermissionInfo.PROTECTION_DANGEROUS: &#123;</span><br><span class="line">                <span class="comment">//【4.4.2】基本类型为 dangerous，那么我们要分不同的情况！！</span></span><br><span class="line">                <span class="keyword">if</span> (!appSupportsRuntimePermissions &amp;&amp; !Build.PERMISSIONS_REVIEW_REQUIRED) &#123;</span><br><span class="line">                    <span class="comment">//【4.4.2.1】如果 legacy apps，同时也不需要在组件启动之前重新 review 权限</span></span><br><span class="line">                    <span class="comment">// 说明应用的 targetSDKVersion &lt; 23 是 legacy apps，那么运行时权限视为安装时权限；</span></span><br><span class="line">                    grant = GRANT_INSTALL;</span><br><span class="line">                    </span><br><span class="line">                &#125; <span class="keyword">else</span> <span class="keyword">if</span> (origPermissions.hasInstallPermission(bp.name)) &#123;</span><br><span class="line">                    <span class="comment">//【4.4.2.2】如果应用支持安装是权限，或者需要在组件启动之前重新 review 权限</span></span><br><span class="line">                    <span class="comment">// 并且该运行时权限之前是属于安装时权限，那么就要升级为运行时权限（系统升级会出现）</span></span><br><span class="line">                    grant = GRANT_UPGRADE;</span><br><span class="line">                    </span><br><span class="line">                &#125; <span class="keyword">else</span> <span class="keyword">if</span> (mPromoteSystemApps</span><br><span class="line">                        &amp;&amp; isSystemApp(ps)</span><br><span class="line">                        &amp;&amp; mExistingSystemPackages.contains(ps.name)) &#123;</span><br><span class="line">                    <span class="comment">//【4.4.2.3】如果是从 API 22 升级上来的话，对于 Promote System Apps，</span></span><br><span class="line">                    <span class="comment">// 那么安装时权限就要升级为运行时权限；</span></span><br><span class="line">                    grant = GRANT_UPGRADE;</span><br><span class="line">                    </span><br><span class="line">                &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                    <span class="comment">//【4.4.2.4】其他情况，直接视为安装时权限！</span></span><br><span class="line">                    grant = GRANT_RUNTIME;</span><br><span class="line">                    </span><br><span class="line">                &#125;</span><br><span class="line">            &#125; <span class="keyword">break</span>;</span><br><span class="line"></span><br><span class="line">            <span class="keyword">case</span> PermissionInfo.PROTECTION_SIGNATURE: &#123;</span><br><span class="line">                <span class="comment">//【4.4.3】基本类型为 signature 的权限，需要校验签名！！</span></span><br><span class="line">                <span class="comment">//【*1.2.2-important】校验签名是否匹配，如果是的话，是为安装时权限！</span></span><br><span class="line">                allowedSig = grantSignaturePermission(perm, pkg, bp, origPermissions);</span><br><span class="line">                <span class="keyword">if</span> (allowedSig) &#123;</span><br><span class="line">                    <span class="comment">// 如果签名校验通过，直接视为安装时权限！</span></span><br><span class="line">                    grant = GRANT_INSTALL;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125; <span class="keyword">break</span>;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (DEBUG_INSTALL) &#123;</span><br><span class="line">            Log.i(TAG, <span class="string">"Package "</span> + pkg.packageName + <span class="string">" granting "</span> + perm);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment">//【4.5】处理授予情况，如果授予情况不是拒绝 GRANT_DENIED，进入 IF 分支；</span></span><br><span class="line">        <span class="comment">// 如果授予情况是拒绝 GRANT_DENIED，进入 ELSE 分支！</span></span><br><span class="line">        <span class="keyword">if</span> (grant != GRANT_DENIED) &#123;</span><br><span class="line">            <span class="keyword">if</span> (!isSystemApp(ps) &amp;&amp; ps.installPermissionsFixed) &#123;</span><br><span class="line">                <span class="comment">//【4.5.1】如果这是一个已经被安装了的非系统的应用，同时本次申请的权限之前不属于安装时权限</span></span><br><span class="line">                <span class="comment">// 除非该权限属于 new platform permission 不然的话，我们是不会授予他这个权限的；</span></span><br><span class="line">                <span class="keyword">if</span> (!allowedSig &amp;&amp; !origPermissions.hasInstallPermission(perm)) &#123;</span><br><span class="line">                    <span class="keyword">if</span> (!isNewPlatformPermissionForPackage(perm, pkg)) &#123;</span><br><span class="line">                        grant = GRANT_DENIED;</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="comment">//【4.5.2】处理权限的授予状态！</span></span><br><span class="line">            <span class="keyword">switch</span> (grant) &#123;</span><br><span class="line">                <span class="keyword">case</span> GRANT_INSTALL: &#123; <span class="comment">// 处理安装时权限；</span></span><br><span class="line">                    <span class="comment">//【4.5.2.1.1】首先，判断该权限之前是否是运行时权限，如果是的话，那就要撤销之前的授予！</span></span><br><span class="line">                    <span class="keyword">for</span> (<span class="keyword">int</span> userId : UserManagerService.getInstance().getUserIds()) &#123;</span><br><span class="line">                        <span class="keyword">if</span> (origPermissions.getRuntimePermissionState(</span><br><span class="line">                                bp.name, userId) != <span class="keyword">null</span>) &#123;</span><br><span class="line">                            <span class="comment">// 撤销权限，并取消所有的标志位；</span></span><br><span class="line">                            origPermissions.revokeRuntimePermission(bp, userId);</span><br><span class="line">                            origPermissions.updatePermissionFlags(bp, userId,</span><br><span class="line">                                  PackageManager.MASK_PERMISSION_FLAGS, <span class="number">0</span>);</span><br><span class="line">                            <span class="comment">// 将运行时权限授予状态发生变化的 userId 记录下来，后面用于持久化数据！</span></span><br><span class="line">                            changedRuntimePermissionUserIds = ArrayUtils.appendInt(</span><br><span class="line">                                    changedRuntimePermissionUserIds, userId);</span><br><span class="line">                        &#125;</span><br><span class="line">                    &#125;</span><br><span class="line">                    <span class="comment">//【4.5.2.1.2】授予安装时权限；</span></span><br><span class="line">                    <span class="keyword">if</span> (permissionsState.grantInstallPermission(bp) !=</span><br><span class="line">                            PermissionsState.PERMISSION_OPERATION_FAILURE) &#123;</span><br><span class="line">                        changedInstallPermission = <span class="keyword">true</span>;</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125; <span class="keyword">break</span>;</span><br><span class="line"></span><br><span class="line">                <span class="keyword">case</span> GRANT_RUNTIME: &#123; <span class="comment">// 处理运行时权限；</span></span><br><span class="line">                    <span class="comment">//【4.5.2.1.3】授予之前被授予的运行时权限；</span></span><br><span class="line">                    <span class="keyword">for</span> (<span class="keyword">int</span> userId : UserManagerService.getInstance().getUserIds()) &#123;</span><br><span class="line">                        <span class="comment">//【4.5.2.1.3.1】获得每个 userId 下的该运行时权限对象和其 flags；</span></span><br><span class="line">                        PermissionState permissionState = origPermissions</span><br><span class="line">                                .getRuntimePermissionState(bp.name, userId);</span><br><span class="line">                        <span class="keyword">int</span> flags = permissionState != <span class="keyword">null</span></span><br><span class="line">                                ? permissionState.getFlags() : <span class="number">0</span>;</span><br><span class="line">                        </span><br><span class="line">                        <span class="comment">//【4.5.2.1.3.2】如果本次授予的权限是已经申请的，那么我们就再次授予！</span></span><br><span class="line">                        <span class="keyword">if</span> (origPermissions.hasRuntimePermission(bp.name, userId)) &#123;</span><br><span class="line">                            <span class="comment">//【4.5.2.1.3.2.1】授予运行时权限，如果失败的话，意味着本次无法授予，那就更新</span></span><br><span class="line">                            <span class="comment">// changedRuntimePermissionUserIds 列表；</span></span><br><span class="line">                            <span class="keyword">if</span> (permissionsState.grantRuntimePermission(bp, userId) ==</span><br><span class="line">                                    PermissionsState.PERMISSION_OPERATION_FAILURE) &#123;</span><br><span class="line">                                changedRuntimePermissionUserIds = ArrayUtils.appendInt(</span><br><span class="line">                                        changedRuntimePermissionUserIds, userId);</span><br><span class="line">                            &#125;</span><br><span class="line">                            <span class="comment">//【4.5.2.1.3.2.2】如果应用支持运行时权限，该权限之前是需要 review 的</span></span><br><span class="line">                            <span class="comment">// 那么这里会取消 review 的标志位！</span></span><br><span class="line">                            <span class="keyword">if</span> (Build.PERMISSIONS_REVIEW_REQUIRED</span><br><span class="line">                                    &amp;&amp; appSupportsRuntimePermissions</span><br><span class="line">                                    &amp;&amp; (flags &amp; PackageManager</span><br><span class="line">                                            .FLAG_PERMISSION_REVIEW_REQUIRED) != <span class="number">0</span>) &#123;</span><br><span class="line">                                flags &amp;= ~PackageManager.FLAG_PERMISSION_REVIEW_REQUIRED;</span><br><span class="line">                                <span class="comment">// 标志位变了，那就更新 changedRuntimePermissionUserIds 列表；</span></span><br><span class="line">                                changedRuntimePermissionUserIds = ArrayUtils.appendInt(</span><br><span class="line">                                        changedRuntimePermissionUserIds, userId);</span><br><span class="line">                            &#125;</span><br><span class="line"></span><br><span class="line">                        &#125; <span class="keyword">else</span> <span class="keyword">if</span> (Build.PERMISSIONS_REVIEW_REQUIRED</span><br><span class="line">                                &amp;&amp; !appSupportsRuntimePermissions) &#123;</span><br><span class="line">                            <span class="comment">//【4.5.2.1.3.2】如果应用不支持运行时权限，但是系统需要权限 review</span></span><br><span class="line">                            <span class="comment">// 每一个被授予的新的运行时权限，都要被 review！</span></span><br><span class="line">                            <span class="comment">// 如果是系统权限，强制增加 FLAG_PERMISSION_REVIEW_REQUIRED 标志位</span></span><br><span class="line">                            <span class="keyword">if</span> (PLATFORM_PACKAGE_NAME.equals(bp.sourcePackage)) &#123;</span><br><span class="line">                                <span class="keyword">if</span> ((flags &amp; FLAG_PERMISSION_REVIEW_REQUIRED) == <span class="number">0</span>) &#123;</span><br><span class="line">                                    flags |= FLAG_PERMISSION_REVIEW_REQUIRED;</span><br><span class="line">                                    <span class="comment">// 标志位变了，那就更新 changedRuntimePermissionUserIds 列表；</span></span><br><span class="line">                                    changedRuntimePermissionUserIds = ArrayUtils.appendInt(</span><br><span class="line">                                            changedRuntimePermissionUserIds, userId);</span><br><span class="line">                                &#125;</span><br><span class="line">                            &#125;</span><br><span class="line">                            <span class="comment">// 授予这个新的运行时权限，如果授予失败，更新 changedRuntimePermissionUserIds 列表；</span></span><br><span class="line">                            <span class="keyword">if</span> (permissionsState.grantRuntimePermission(bp, userId)</span><br><span class="line">                                    != PermissionsState.PERMISSION_OPERATION_FAILURE) &#123;</span><br><span class="line">                                changedRuntimePermissionUserIds = ArrayUtils.appendInt(</span><br><span class="line">                                        changedRuntimePermissionUserIds, userId);</span><br><span class="line">                            &#125;</span><br><span class="line">                        &#125;</span><br><span class="line">                        <span class="comment">//【4.5.2.1.3.2.1】更新权限的 flags！</span></span><br><span class="line">                        permissionsState.updatePermissionFlags(bp, userId, flags, flags);</span><br><span class="line"></span><br><span class="line">                    &#125;</span><br><span class="line">                &#125; <span class="keyword">break</span>;</span><br><span class="line"></span><br><span class="line">                <span class="keyword">case</span> GRANT_UPGRADE: &#123; <span class="comment">// 处理安装时权限升级为运行时权限</span></span><br><span class="line">                    <span class="comment">//【4.5.2.1.4】授予安装时升级为运行时的权限；</span></span><br><span class="line">                    <span class="comment">// 获得权限管理对象和 flags；</span></span><br><span class="line">                    PermissionState permissionState = origPermissions</span><br><span class="line">                            .getInstallPermissionState(bp.name);</span><br><span class="line">                    <span class="keyword">final</span> <span class="keyword">int</span> flags = permissionState != <span class="keyword">null</span> ? permissionState.getFlags() : <span class="number">0</span>;</span><br><span class="line"></span><br><span class="line">                    <span class="comment">//【4.5.2.1.4.1】撤销之前的安装时权限，并清空 flags；</span></span><br><span class="line">                    <span class="keyword">if</span> (origPermissions.revokeInstallPermission(bp)</span><br><span class="line">                            != PermissionsState.PERMISSION_OPERATION_FAILURE) &#123;</span><br><span class="line">                        origPermissions.updatePermissionFlags(bp, UserHandle.USER_ALL,</span><br><span class="line">                                PackageManager.MASK_PERMISSION_FLAGS, <span class="number">0</span>);</span><br><span class="line">                        changedInstallPermission = <span class="keyword">true</span>;</span><br><span class="line">                    &#125;</span><br><span class="line"></span><br><span class="line">                    <span class="comment">//【4.5.2.1.4.2】如果该权限没有设置 FLAG_PERMISSION_REVOKE_ON_UPGRADE，</span></span><br><span class="line">                    <span class="comment">// 表示在升级后可以授予，那么我们就授予运行时权限；</span></span><br><span class="line">                    <span class="keyword">if</span> ((flags &amp; PackageManager.FLAG_PERMISSION_REVOKE_ON_UPGRADE) == <span class="number">0</span>) &#123;</span><br><span class="line">                        <span class="keyword">for</span> (<span class="keyword">int</span> userId : currentUserIds) &#123;</span><br><span class="line">                            <span class="keyword">if</span> (permissionsState.grantRuntimePermission(bp, userId) !=</span><br><span class="line">                                    PermissionsState.PERMISSION_OPERATION_FAILURE) &#123;</span><br><span class="line">                                <span class="comment">// 将旧的 flags 更新到运行时权限；</span></span><br><span class="line">                                permissionsState.updatePermissionFlags(bp, userId,</span><br><span class="line">                                        flags, flags);</span><br><span class="line">                                <span class="comment">// 标志位变了，那就更新 changedRuntimePermissionUserIds 列表；</span></span><br><span class="line">                                changedRuntimePermissionUserIds = ArrayUtils.appendInt(</span><br><span class="line">                                        changedRuntimePermissionUserIds, userId);</span><br><span class="line">                            &#125;</span><br><span class="line">                        &#125;</span><br><span class="line">                    &#125;</span><br><span class="line"></span><br><span class="line">                &#125; <span class="keyword">break</span>;</span><br><span class="line"></span><br><span class="line">                <span class="keyword">default</span>: &#123;</span><br><span class="line">                    <span class="keyword">if</span> (packageOfInterest == <span class="keyword">null</span></span><br><span class="line">                            || packageOfInterest.equals(pkg.packageName)) &#123;</span><br><span class="line">                        Slog.w(TAG, <span class="string">"Not granting permission "</span> + perm</span><br><span class="line">                                + <span class="string">" to package "</span> + pkg.packageName</span><br><span class="line">                                + <span class="string">" because it was previously installed without"</span>);</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125; <span class="keyword">break</span>;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            <span class="comment">//【4.6】处理撤销情况，撤销该权限，同时清空所有的标志位；</span></span><br><span class="line">            <span class="keyword">if</span> (permissionsState.revokeInstallPermission(bp) !=</span><br><span class="line">                    PermissionsState.PERMISSION_OPERATION_FAILURE) &#123;</span><br><span class="line">                <span class="comment">// 清空标志位；</span></span><br><span class="line">                permissionsState.updatePermissionFlags(bp, UserHandle.USER_ALL,</span><br><span class="line">                        PackageManager.MASK_PERMISSION_FLAGS, <span class="number">0</span>);</span><br><span class="line">                changedInstallPermission = <span class="keyword">true</span>;</span><br><span class="line">                Slog.i(TAG, <span class="string">"Un-granting permission "</span> + perm</span><br><span class="line">                        + <span class="string">" from package "</span> + pkg.packageName</span><br><span class="line">                        + <span class="string">" (protectionLevel="</span> + bp.protectionLevel</span><br><span class="line">                        + <span class="string">" flags=0x"</span> + Integer.toHexString(pkg.applicationInfo.flags)</span><br><span class="line">                        + <span class="string">")"</span>);</span><br><span class="line">            &#125; <span class="keyword">else</span> <span class="keyword">if</span> ((bp.protectionLevel&amp;PermissionInfo.PROTECTION_FLAG_APPOP) == <span class="number">0</span>) &#123;</span><br><span class="line">                <span class="comment">//【4.6.1】如果撤销失败，但是该权限和一个 appOp 相关联，这种情况可以不处理。因为</span></span><br><span class="line">                <span class="comment">// 对于这类权限，我们不处理，因为我们会通过 appOps 进行控制，通过 ui 给用户选择；</span></span><br><span class="line">                <span class="keyword">if</span> (packageOfInterest == <span class="keyword">null</span> || packageOfInterest.equals(pkg.packageName)) &#123;</span><br><span class="line">                    Slog.w(TAG, <span class="string">"Not granting permission "</span> + perm</span><br><span class="line">                            + <span class="string">" to package "</span> + pkg.packageName</span><br><span class="line">                            + <span class="string">" (protectionLevel="</span> + bp.protectionLevel</span><br><span class="line">                            + <span class="string">" flags=0x"</span> + Integer.toHexString(pkg.applicationInfo.flags)</span><br><span class="line">                            + <span class="string">")"</span>);</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span> ((changedInstallPermission || replace) &amp;&amp; !ps.installPermissionsFixed &amp;&amp;</span><br><span class="line">            !isSystemApp(ps) || isUpdatedSystemApp(ps))&#123;</span><br><span class="line">        <span class="comment">// 这是我们第一次听说过这个包，所以我们现在选择的权限是固定的，直到明确更改为止。</span></span><br><span class="line">        <span class="comment">// （没看懂这段逻辑...）</span></span><br><span class="line">        ps.installPermissionsFixed = <span class="keyword">true</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//【5】持久化变化调整后的运行时权限数据！</span></span><br><span class="line">    <span class="keyword">for</span> (<span class="keyword">int</span> userId : changedRuntimePermissionUserIds) &#123;</span><br><span class="line">        mSettings.writeRuntimePermissionsForUserLPr(userId, runtimePermissionsRevoked);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    Trace.traceEnd(TRACE_TAG_PACKAGE_MANAGER);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h3 id="1-2-1-PackageMS-revokeUnusedSharedUserPermissionsLPw"><a href="#1-2-1-PackageMS-revokeUnusedSharedUserPermissionsLPw" class="headerlink" title="1.2.1 PackageMS.revokeUnusedSharedUserPermissionsLPw"></a>1.2.1 PackageMS.revokeUnusedSharedUserPermissionsLPw</h3><p>撤销不再使用的共享用户权限；</p>
<p>参数 SharedUserSetting su 表示的是共享 uid 的信息对象！<br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">private</span> <span class="keyword">int</span>[] revokeUnusedSharedUserPermissionsLPw(SharedUserSetting su, <span class="keyword">int</span>[] allUserIds) &#123;</span><br><span class="line">    <span class="comment">//【1】收集该 shared user 下的所有被请求的权限！</span></span><br><span class="line">    ArraySet&lt;String&gt; usedPermissions = <span class="keyword">new</span> ArraySet&lt;&gt;();</span><br><span class="line">    <span class="keyword">final</span> <span class="keyword">int</span> packageCount = su.packages.size();</span><br><span class="line">    <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; packageCount; i++) &#123;</span><br><span class="line">        PackageSetting ps = su.packages.valueAt(i);</span><br><span class="line">        <span class="keyword">if</span> (ps.pkg == <span class="keyword">null</span>) &#123;</span><br><span class="line">            <span class="keyword">continue</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">final</span> <span class="keyword">int</span> requestedPermCount = ps.pkg.requestedPermissions.size();</span><br><span class="line">        <span class="keyword">for</span> (<span class="keyword">int</span> j = <span class="number">0</span>; j &lt; requestedPermCount; j++) &#123;</span><br><span class="line">            String permission = ps.pkg.requestedPermissions.get(j);</span><br><span class="line">            BasePermission bp = mSettings.mPermissions.get(permission);</span><br><span class="line">            <span class="keyword">if</span> (bp != <span class="keyword">null</span>) &#123;</span><br><span class="line">                usedPermissions.add(permission);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">//【2】获得该 shared user 的权限管理对象！!</span></span><br><span class="line">    PermissionsState permissionsState = su.getPermissionsState();</span><br><span class="line"></span><br><span class="line">    <span class="comment">//【3】撤销那些本次不再申请，但是之前申请了的安装时权限！!</span></span><br><span class="line">    List&lt;PermissionState&gt; installPermStates = permissionsState.getInstallPermissionStates();</span><br><span class="line">    <span class="keyword">final</span> <span class="keyword">int</span> installPermCount = installPermStates.size();</span><br><span class="line">    <span class="keyword">for</span> (<span class="keyword">int</span> i = installPermCount - <span class="number">1</span>; i &gt;= <span class="number">0</span>;  i--) &#123;</span><br><span class="line">        PermissionState permissionState = installPermStates.get(i);</span><br><span class="line">        <span class="keyword">if</span> (!usedPermissions.contains(permissionState.getName())) &#123;</span><br><span class="line">            BasePermission bp = mSettings.mPermissions.get(permissionState.getName());</span><br><span class="line">            <span class="keyword">if</span> (bp != <span class="keyword">null</span>) &#123;</span><br><span class="line">                <span class="comment">//【3.1】撤销权限，移除所有标志位；</span></span><br><span class="line">                permissionsState.revokeInstallPermission(bp);</span><br><span class="line">                permissionsState.updatePermissionFlags(bp, UserHandle.USER_ALL,</span><br><span class="line">                        PackageManager.MASK_PERMISSION_FLAGS, <span class="number">0</span>);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">int</span>[] runtimePermissionChangedUserIds = EmptyArray.INT;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//【4】撤销那些本次不再申请，但是之前申请了的运行时权限！!</span></span><br><span class="line">    <span class="keyword">for</span> (<span class="keyword">int</span> userId : allUserIds) &#123;</span><br><span class="line">        List&lt;PermissionState&gt; runtimePermStates = permissionsState</span><br><span class="line">                .getRuntimePermissionStates(userId);</span><br><span class="line">        <span class="keyword">final</span> <span class="keyword">int</span> runtimePermCount = runtimePermStates.size();</span><br><span class="line">        <span class="keyword">for</span> (<span class="keyword">int</span> i = runtimePermCount - <span class="number">1</span>; i &gt;= <span class="number">0</span>; i--) &#123;</span><br><span class="line">            PermissionState permissionState = runtimePermStates.get(i);</span><br><span class="line">            <span class="keyword">if</span> (!usedPermissions.contains(permissionState.getName())) &#123;</span><br><span class="line">                BasePermission bp = mSettings.mPermissions.get(permissionState.getName());</span><br><span class="line">                <span class="keyword">if</span> (bp != <span class="keyword">null</span>) &#123;</span><br><span class="line">                    <span class="comment">//【4.1】撤销权限，移除所有标志位；</span></span><br><span class="line">                    permissionsState.revokeRuntimePermission(bp, userId);</span><br><span class="line">                    permissionsState.updatePermissionFlags(bp, userId,</span><br><span class="line">                            PackageManager.MASK_PERMISSION_FLAGS, <span class="number">0</span>);</span><br><span class="line">                    <span class="comment">//【4.2】返回该运行时权限所在的 userId；</span></span><br><span class="line">                    runtimePermissionChangedUserIds = ArrayUtils.appendInt(</span><br><span class="line">                            runtimePermissionChangedUserIds, userId);</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">//【5】返回该运行时权限所在的 userId；</span></span><br><span class="line">    <span class="keyword">return</span> runtimePermissionChangedUserIds;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>runtimePermissionChangedUserIds 用于持久化运行时数据库；</p>
<p>###1.2.2 PackageMS.grantSignaturePermission</p>
<p>grantSignaturePermission 方法用于判断签名是否能校验通过，我们在这里先忽略掉签名校验的过程，假设要么校验成功，要么校验失败！</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">boolean</span> <span class="title">grantSignaturePermission</span><span class="params">(String perm, PackageParser.Package pkg,</span></span></span><br><span class="line"><span class="function"><span class="params">        BasePermission bp, PermissionsState origPermissions)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">boolean</span> allowed;</span><br><span class="line">    <span class="comment">//【1】判断应用的签名和权限定义者签名或者平台签名是否匹配！</span></span><br><span class="line">    allowed = (compareSignatures(</span><br><span class="line">            bp.packageSetting.signatures.mSignatures, pkg.mSignatures)</span><br><span class="line">                    == PackageManager.SIGNATURE_MATCH)</span><br><span class="line">            || (compareSignatures(mPlatformPackage.mSignatures, pkg.mSignatures)</span><br><span class="line">                    == PackageManager.SIGNATURE_MATCH);</span><br><span class="line">                    </span><br><span class="line">    <span class="comment">//【2】如果和权限定义者签名或者平台签名不匹配，并且该权限是 PRIVILEGED 的，进行进一步的判断！</span></span><br><span class="line">    <span class="keyword">if</span> (!allowed &amp;&amp; (bp.protectionLevel</span><br><span class="line">            &amp; PermissionInfo.PROTECTION_FLAG_PRIVILEGED) != <span class="number">0</span>) &#123;</span><br><span class="line">        </span><br><span class="line">        <span class="keyword">if</span> (isSystemApp(pkg)) &#123; <span class="comment">// 对于 PRIVILEGED 类型的权限，首先必须是系统应用！</span></span><br><span class="line">            <span class="comment">//【2.1】如果该应用是一个被更新过的系统应用，那么只有更新前的旧 apk 被授予了这个权限，</span></span><br><span class="line">            <span class="comment">// 新的 apk 才能被授予这个权限！</span></span><br><span class="line">            <span class="keyword">if</span> (pkg.isUpdatedSystemApp()) &#123;</span><br><span class="line">                <span class="comment">// 获得更新前的安装数据(system)！</span></span><br><span class="line">                <span class="keyword">final</span> PackageSetting sysPs = mSettings</span><br><span class="line">                        .getDisabledSystemPkgLPr(pkg.packageName);</span><br><span class="line"></span><br><span class="line">                <span class="keyword">if</span> (sysPs != <span class="keyword">null</span> &amp;&amp; sysPs.getPermissionsState().hasInstallPermission(perm)) &#123;</span><br><span class="line">                    <span class="comment">//【2.1.1】如果更新前，其已经被授予了该权限，并且其是一个特权应用，</span></span><br><span class="line">                    <span class="comment">// 那么本次也允许授予！！</span></span><br><span class="line">                    <span class="keyword">if</span> (sysPs.isPrivileged()) &#123;</span><br><span class="line">                        allowed = <span class="keyword">true</span>;</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                    <span class="comment">//【2.1.2】如果更新前，并没有被授予该权限，该权限是更新后新申请的权限！</span></span><br><span class="line">                    <span class="comment">// 那就要看之前是否有请求该权限，只有请求了该权限，才允许授予；</span></span><br><span class="line">                    <span class="keyword">if</span> (sysPs != <span class="keyword">null</span> &amp;&amp; sysPs.pkg != <span class="keyword">null</span> &amp;&amp; sysPs.isPrivileged()) &#123;</span><br><span class="line">                        <span class="keyword">for</span> (<span class="keyword">int</span> j = <span class="number">0</span>; j &lt; sysPs.pkg.requestedPermissions.size(); j++) &#123;</span><br><span class="line">                            <span class="keyword">if</span> (perm.equals(sysPs.pkg.requestedPermissions.get(j))) &#123;</span><br><span class="line">                                allowed = <span class="keyword">true</span>;</span><br><span class="line">                                <span class="keyword">break</span>;</span><br><span class="line">                            &#125;</span><br><span class="line">                        &#125;</span><br><span class="line">                    &#125;</span><br><span class="line"></span><br><span class="line">                    <span class="comment">// 此外，如果系统映像上的特权父包或其父包任何子代请求特权权限，则更新的子包也可以获得该许可。</span></span><br><span class="line">                    <span class="keyword">if</span> (pkg.parentPackage != <span class="keyword">null</span>) &#123;</span><br><span class="line">                        <span class="keyword">final</span> PackageSetting disabledSysParentPs = mSettings</span><br><span class="line">                                .getDisabledSystemPkgLPr(pkg.parentPackage.packageName);</span><br><span class="line">                        <span class="keyword">if</span> (disabledSysParentPs != <span class="keyword">null</span> &amp;&amp; disabledSysParentPs.pkg != <span class="keyword">null</span></span><br><span class="line">                                &amp;&amp; disabledSysParentPs.isPrivileged()) &#123;</span><br><span class="line">                            <span class="keyword">if</span> (isPackageRequestingPermission(disabledSysParentPs.pkg, perm)) &#123;</span><br><span class="line">                                allowed = <span class="keyword">true</span>;</span><br><span class="line">                            &#125; <span class="keyword">else</span> <span class="keyword">if</span> (disabledSysParentPs.pkg.childPackages != <span class="keyword">null</span>) &#123;</span><br><span class="line">                                <span class="keyword">final</span> <span class="keyword">int</span> count = disabledSysParentPs.pkg.childPackages.size();</span><br><span class="line">                                <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; count; i++) &#123;</span><br><span class="line">                                    PackageParser.Package disabledSysChildPkg =</span><br><span class="line">                                            disabledSysParentPs.pkg.childPackages.get(i);</span><br><span class="line">                                    <span class="keyword">if</span> (isPackageRequestingPermission(disabledSysChildPkg,</span><br><span class="line">                                            perm)) &#123;</span><br><span class="line">                                        allowed = <span class="keyword">true</span>;</span><br><span class="line">                                        <span class="keyword">break</span>;</span><br><span class="line">                                    &#125;</span><br><span class="line">                                &#125;</span><br><span class="line">                            &#125;</span><br><span class="line">                        &#125;</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                <span class="comment">//【2.2】如果该应用是一个没有被更新过的系统应用，那就要判读其是否是特权应用！</span></span><br><span class="line">                allowed = isPrivilegedApp(pkg);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">//【3】经过了上面的判断，依然不允许，接着进行下一步的判断，下面会根据额外的标志位继续判断！</span></span><br><span class="line">    <span class="keyword">if</span> (!allowed) &#123;</span><br><span class="line">        <span class="keyword">if</span> (!allowed &amp;&amp; (bp.protectionLevel</span><br><span class="line">                &amp; PermissionInfo.PROTECTION_FLAG_PRE23) != <span class="number">0</span></span><br><span class="line">                &amp;&amp; pkg.applicationInfo.targetSdkVersion &lt; Build.VERSION_CODES.M) &#123;</span><br><span class="line">            <span class="comment">//【3.1】PROTECTION_FLAG_PRE23 指定此权限会自动授予低于 M（在引入运行时权限之前）的 API 级别的应用程序。</span></span><br><span class="line">            <span class="comment">// 如果应用的 targetSdkVersion 是小于 M 的，那么我们授予他签名权限！</span></span><br><span class="line">            allowed = <span class="keyword">true</span>;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (!allowed &amp;&amp; (bp.protectionLevel &amp; PermissionInfo.PROTECTION_FLAG_INSTALLER) != <span class="number">0</span></span><br><span class="line">                &amp;&amp; pkg.packageName.equals(mRequiredInstallerPackage)) &#123;</span><br><span class="line">            <span class="comment">//【3.2】PROTECTION_FLAG_INSTALLER 指定此权限可以自动授予包软件应用程序。</span></span><br><span class="line">            <span class="comment">// 而此时的 apk 就是 packageInstaller，那么授予他签名权限！</span></span><br><span class="line">            allowed = <span class="keyword">true</span>;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (!allowed &amp;&amp; (bp.protectionLevel &amp; PermissionInfo.PROTECTION_FLAG_VERIFIER) != <span class="number">0</span></span><br><span class="line">                &amp;&amp; pkg.packageName.equals(mRequiredVerifierPackage)) &#123;</span><br><span class="line">            <span class="comment">//【3.3】PROTECTION_FLAG_INSTALLER 指定此权限可以被自动授予给验证软件包的系统应用程序。</span></span><br><span class="line">            <span class="comment">// 而此时的 apk 就是 VerifierPackage，那么授予他签名权限！</span></span><br><span class="line">            allowed = <span class="keyword">true</span>;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (!allowed &amp;&amp; (bp.protectionLevel</span><br><span class="line">                &amp; PermissionInfo.PROTECTION_FLAG_PREINSTALLED) != <span class="number">0</span></span><br><span class="line">                &amp;&amp; isSystemApp(pkg)) &#123;</span><br><span class="line">            <span class="comment">//【3.4】PROTECTION_FLAG_PREINSTALLED 指定此权限可以自动授予 system 分区预先安装的任何应用程序</span></span><br><span class="line">            <span class="comment">// 而此时的 apk 就是 system app，那么授予他签名权限！</span></span><br><span class="line">            allowed = <span class="keyword">true</span>;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (!allowed &amp;&amp; (bp.protectionLevel</span><br><span class="line">                &amp; PermissionInfo.PROTECTION_FLAG_DEVELOPMENT) != <span class="number">0</span>) &#123;</span><br><span class="line">            <span class="comment">//【3.4】PROTECTION_FLAG_DEVELOPMENT 指定此权限可以授予（可选）给开发应用程序</span></span><br><span class="line">            <span class="comment">// 而上一次应用是被授予了这个权限，那么一次也不被授予</span></span><br><span class="line">            allowed = origPermissions.hasInstallPermission(perm);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (!allowed &amp;&amp; (bp.protectionLevel &amp; PermissionInfo.PROTECTION_FLAG_SETUP) != <span class="number">0</span></span><br><span class="line">                &amp;&amp; pkg.packageName.equals(mSetupWizardPackage)) &#123;</span><br><span class="line">            <span class="comment">//【3.5】PROTECTION_FLAG_SETUP 指定此权限可以被自动授予给开机向导应用程序</span></span><br><span class="line">            <span class="comment">// 而此时的 apk 就是开机向导，那么授予他签名权限！.</span></span><br><span class="line">            allowed = <span class="keyword">true</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> allowed;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>可以看到，这里对 Signature 类型的权限做了详细的处理！</p>
<h1 id="2-Settings-applyDefaultPreferredAppsLPw-默认应用设置"><a href="#2-Settings-applyDefaultPreferredAppsLPw-默认应用设置" class="headerlink" title="2 Settings.applyDefaultPreferredAppsLPw - 默认应用设置"></a>2 Settings.applyDefaultPreferredAppsLPw - 默认应用设置</h1><p>该方法用于设置默认应用！</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">applyDefaultPreferredAppsLPw</span><span class="params">(PackageManagerService service, <span class="keyword">int</span> userId)</span> </span>&#123;</span><br><span class="line">    <span class="comment">//【1】从之前安装过应用中设置默认应用；</span></span><br><span class="line">    <span class="keyword">for</span> (PackageSetting ps : mPackages.values()) &#123;</span><br><span class="line">        <span class="keyword">if</span> ((ps.pkgFlags&amp;ApplicationInfo.FLAG_SYSTEM) != <span class="number">0</span> &amp;&amp; ps.pkg != <span class="keyword">null</span></span><br><span class="line">                &amp;&amp; ps.pkg.preferredActivityFilters != <span class="keyword">null</span>) &#123;</span><br><span class="line">            ArrayList&lt;PackageParser.ActivityIntentInfo&gt; intents</span><br><span class="line">                    = ps.pkg.preferredActivityFilters;</span><br><span class="line">            <span class="keyword">for</span> (<span class="keyword">int</span> i=<span class="number">0</span>; i&lt;intents.size(); i++) &#123;</span><br><span class="line">                PackageParser.ActivityIntentInfo aii = intents.get(i);</span><br><span class="line">                applyDefaultPreferredActivityLPw(service, aii, <span class="keyword">new</span> ComponentName(</span><br><span class="line">                        ps.name, aii.activity.className), userId);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//【2】从 /etc/preferred-apps 目录下读取默认应用的配置！</span></span><br><span class="line">    File preferredDir = <span class="keyword">new</span> File(Environment.getRootDirectory(), <span class="string">"etc/preferred-apps"</span>);</span><br><span class="line">    <span class="keyword">if</span> (!preferredDir.exists() || !preferredDir.isDirectory()) &#123;</span><br><span class="line">        <span class="keyword">return</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span> (!preferredDir.canRead()) &#123;</span><br><span class="line">        Slog.w(TAG, <span class="string">"Directory "</span> + preferredDir + <span class="string">" cannot be read"</span>);</span><br><span class="line">        <span class="keyword">return</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// Iterate over the files in the directory and scan .xml files</span></span><br><span class="line">    <span class="keyword">for</span> (File f : preferredDir.listFiles()) &#123;</span><br><span class="line">        <span class="keyword">if</span> (!f.getPath().endsWith(<span class="string">".xml"</span>)) &#123;</span><br><span class="line">            Slog.i(TAG, <span class="string">"Non-xml file "</span> + f + <span class="string">" in "</span> + preferredDir + <span class="string">" directory, ignoring"</span>);</span><br><span class="line">            <span class="keyword">continue</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">if</span> (!f.canRead()) &#123;</span><br><span class="line">            Slog.w(TAG, <span class="string">"Preferred apps file "</span> + f + <span class="string">" cannot be read"</span>);</span><br><span class="line">            <span class="keyword">continue</span>;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (PackageManagerService.DEBUG_PREFERRED) Log.d(TAG, <span class="string">"Reading default preferred "</span> + f);</span><br><span class="line">        InputStream str = <span class="keyword">null</span>;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            str = <span class="keyword">new</span> BufferedInputStream(<span class="keyword">new</span> FileInputStream(f));</span><br><span class="line">            XmlPullParser parser = Xml.newPullParser();</span><br><span class="line">            parser.setInput(str, <span class="keyword">null</span>);</span><br><span class="line"></span><br><span class="line">            <span class="keyword">int</span> type;</span><br><span class="line">            <span class="keyword">while</span> ((type = parser.next()) != XmlPullParser.START_TAG</span><br><span class="line">                    &amp;&amp; type != XmlPullParser.END_DOCUMENT) &#123;</span><br><span class="line">                ;</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            <span class="keyword">if</span> (type != XmlPullParser.START_TAG) &#123;</span><br><span class="line">                Slog.w(TAG, <span class="string">"Preferred apps file "</span> + f + <span class="string">" does not have start tag"</span>);</span><br><span class="line">                <span class="keyword">continue</span>;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">if</span> (!<span class="string">"preferred-activities"</span>.equals(parser.getName())) &#123;</span><br><span class="line">                Slog.w(TAG, <span class="string">"Preferred apps file "</span> + f</span><br><span class="line">                        + <span class="string">" does not start with 'preferred-activities'"</span>);</span><br><span class="line">                <span class="keyword">continue</span>;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="comment">//【1】读取默认应用的配置信息！</span></span><br><span class="line">            readDefaultPreferredActivitiesLPw(service, parser, userId);</span><br><span class="line">        &#125; <span class="keyword">catch</span> (XmlPullParserException e) &#123;</span><br><span class="line">            Slog.w(TAG, <span class="string">"Error reading apps file "</span> + f, e);</span><br><span class="line">        &#125; <span class="keyword">catch</span> (IOException e) &#123;</span><br><span class="line">            Slog.w(TAG, <span class="string">"Error reading apps file "</span> + f, e);</span><br><span class="line">        &#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">            <span class="keyword">if</span> (str != <span class="keyword">null</span>) &#123;</span><br><span class="line">                <span class="keyword">try</span> &#123;</span><br><span class="line">                    str.close();</span><br><span class="line">                &#125; <span class="keyword">catch</span> (IOException e) &#123;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h1 id="3-PMS-reconcileAppsDataLI-准备数据目录"><a href="#3-PMS-reconcileAppsDataLI-准备数据目录" class="headerlink" title="3 PMS.reconcileAppsDataLI - 准备数据目录"></a>3 PMS.reconcileAppsDataLI - 准备数据目录</h1><p>reconcileAppsDataLI 方法用于调整所有应用的数据，该方法会清楚那些被卸载或者重新安装到其他分区上的应用的已有数据，同时也会校验应用对应的数据目录是否存在，不存在的话，会创建对应的目录！</p>
<p>StorageManager.isFileEncryptedNativeOrEmulated() 方法用于判断系统是否运行在文件加密模式，如果是文件加密模式的话，storageFlags 只有 StorageManager.FLAG_STORAGE_DE；</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">if</span> (StorageManager.isFileEncryptedNativeOrEmulated()) &#123;</span><br><span class="line">    storageFlags = StorageManager.FLAG_STORAGE_DE;</span><br><span class="line">&#125; <span class="keyword">else</span> &#123;</span><br><span class="line">    storageFlags = StorageManager.FLAG_STORAGE_DE | StorageManager.FLAG_STORAGE_CE;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>下面我们来看看 reconcileAppsDataLI 方法：<br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">reconcileAppsDataLI</span><span class="params">(String volumeUuid, <span class="keyword">int</span> userId, <span class="keyword">int</span> flags)</span> </span>&#123;</span><br><span class="line">    Slog.v(TAG, <span class="string">"reconcileAppsData for "</span> + volumeUuid + <span class="string">" u"</span> + userId + <span class="string">" 0x"</span></span><br><span class="line">            + Integer.toHexString(flags));</span><br><span class="line">    <span class="comment">// cdDir 文件对应的目录是：/data/user/&lt;userId&gt;，在默认用户下是 /data/user/0</span></span><br><span class="line">    <span class="comment">// deDir 文件对应的目录是：/data/user_de/&lt;userId&gt;，在默认用户下是 /data/user_de/0</span></span><br><span class="line">    <span class="keyword">final</span> File ceDir = Environment.getDataUserCeDirectory(volumeUuid, userId);</span><br><span class="line">    <span class="keyword">final</span> File deDir = Environment.getDataUserDeDirectory(volumeUuid, userId);</span><br><span class="line"></span><br><span class="line">    <span class="comment">//【1】系统运行在文件加密模式下，是不会就进入这里的，正常情况会进入这里；</span></span><br><span class="line">    <span class="keyword">if</span> ((flags &amp; StorageManager.FLAG_STORAGE_CE) != <span class="number">0</span>) &#123;</span><br><span class="line">        <span class="keyword">if</span> (StorageManager.isFileEncryptedNativeOrEmulated()</span><br><span class="line">                &amp;&amp; !StorageManager.isUserKeyUnlocked(userId)) &#123; <span class="comment">// 再次校验是否处于文件加密模式下！</span></span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> RuntimeException(</span><br><span class="line">                    <span class="string">"Yikes, someone asked us to reconcile CE storage while "</span> + userId</span><br><span class="line">                            + <span class="string">" was still locked; this would have caused massive data loss!"</span>);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">//【1.1】遍历 /data/user/0 目录，处理该目录下的每个文件！</span></span><br><span class="line">        <span class="keyword">final</span> File[] files = FileUtils.listFilesOrEmpty(ceDir);</span><br><span class="line">        <span class="keyword">for</span> (File file : files) &#123;</span><br><span class="line">            <span class="keyword">final</span> String packageName = file.getName();</span><br><span class="line">            <span class="keyword">try</span> &#123;</span><br><span class="line">                <span class="comment">//【1.2】校验所有已经安装的应用的数据</span></span><br><span class="line">                assertPackageKnownAndInstalled(volumeUuid, packageName, userId);</span><br><span class="line">            &#125; <span class="keyword">catch</span> (PackageManagerException e) &#123;</span><br><span class="line">                logCriticalInfo(Log.WARN, <span class="string">"Destroying "</span> + file + <span class="string">" due to: "</span> + e);</span><br><span class="line">                <span class="keyword">try</span> &#123;</span><br><span class="line">                    <span class="comment">// 通过 installd 删除该 package 的旧数据！</span></span><br><span class="line">                    mInstaller.destroyAppData(volumeUuid, packageName, userId,</span><br><span class="line">                            StorageManager.FLAG_STORAGE_CE, <span class="number">0</span>);</span><br><span class="line">                &#125; <span class="keyword">catch</span> (InstallerException e2) &#123;</span><br><span class="line">                    logCriticalInfo(Log.WARN, <span class="string">"Failed to destroy: "</span> + e2);</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">//【2】遍历 /data/user_de/0 目录，处理该目录下的每个文件！</span></span><br><span class="line">    <span class="keyword">if</span> ((flags &amp; StorageManager.FLAG_STORAGE_DE) != <span class="number">0</span>) &#123;</span><br><span class="line">        <span class="keyword">final</span> File[] files = FileUtils.listFilesOrEmpty(deDir);</span><br><span class="line">        <span class="keyword">for</span> (File file : files) &#123;</span><br><span class="line">            <span class="keyword">final</span> String packageName = file.getName();</span><br><span class="line">            <span class="keyword">try</span> &#123;</span><br><span class="line">                assertPackageKnownAndInstalled(volumeUuid, packageName, userId);</span><br><span class="line">            &#125; <span class="keyword">catch</span> (PackageManagerException e) &#123;</span><br><span class="line">                logCriticalInfo(Log.WARN, <span class="string">"Destroying "</span> + file + <span class="string">" due to: "</span> + e);</span><br><span class="line">                <span class="keyword">try</span> &#123;</span><br><span class="line">                    <span class="comment">// 通过 installd 删除该 package 的旧数据！</span></span><br><span class="line">                    mInstaller.destroyAppData(volumeUuid, packageName, userId,</span><br><span class="line">                            StorageManager.FLAG_STORAGE_DE, <span class="number">0</span>);</span><br><span class="line">                &#125; <span class="keyword">catch</span> (InstallerException e2) &#123;</span><br><span class="line">                    logCriticalInfo(Log.WARN, <span class="string">"Failed to destroy: "</span> + e2);</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//【3】确定系统中所有应用都有对应的 data 目录！</span></span><br><span class="line">    <span class="keyword">final</span> List&lt;PackageSetting&gt; packages;</span><br><span class="line">    <span class="keyword">synchronized</span> (mPackages) &#123;</span><br><span class="line">        packages = mSettings.getVolumePackagesLPr(volumeUuid);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">int</span> preparedCount = <span class="number">0</span>;</span><br><span class="line">    <span class="keyword">for</span> (PackageSetting ps : packages) &#123;</span><br><span class="line">        <span class="keyword">final</span> String packageName = ps.name;</span><br><span class="line">        <span class="keyword">if</span> (ps.pkg == <span class="keyword">null</span>) &#123;</span><br><span class="line">            Slog.w(TAG, <span class="string">"Odd, missing scanned package "</span> + packageName);</span><br><span class="line">            <span class="keyword">continue</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">//【3.1】如果 package 已经安装了，那么就会调用 prepareAppDataLIF 方法，准备数据目录！</span></span><br><span class="line">        <span class="keyword">if</span> (ps.getInstalled(userId)) &#123;</span><br><span class="line">            prepareAppDataLIF(ps.pkg, userId, flags);</span><br><span class="line"></span><br><span class="line">            <span class="keyword">if</span> (maybeMigrateAppDataLIF(ps.pkg, userId)) &#123;</span><br><span class="line">                prepareAppDataLIF(ps.pkg, userId, flags);</span><br><span class="line">            &#125;</span><br><span class="line">            preparedCount++;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    Slog.v(TAG, <span class="string">"reconcileAppsData finished "</span> + preparedCount + <span class="string">" packages"</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>这里想说下 /data/user/0 和 /data/user_de/0，其实它们是 /data/data 目录的 link 名称，本质上指向了一个目录！</p>
<p>这个过程如下：</p>
<ul>
<li>校验所有已经安装的应用，删除那些异常情况下的应用的数据，如果应用改了包名等等的情况，删除之前的数据；</li>
<li>为没有数据目录的应用创建目录；</li>
</ul>
<p>这个过程首先处理了 rename package 的情况，对于 rename package 的情况，重命名之前的数据是不可用的，所以这里会使用 assertPackageKnownAndInstalled 方法来进行处理！</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">assertPackageKnownAndInstalled</span><span class="params">(String volumeUuid, String packageName, <span class="keyword">int</span> userId)</span></span></span><br><span class="line"><span class="function">        <span class="keyword">throws</span> PackageManagerException </span>&#123;</span><br><span class="line">    <span class="keyword">synchronized</span> (mPackages) &#123;</span><br><span class="line">        <span class="comment">// 如果重命名过，会返回 oldName，不然则是当前的包名！</span></span><br><span class="line">        packageName = normalizePackageNameLPr(packageName);</span><br><span class="line">        <span class="comment">// 尝试在上次安装信息中，查找这个 package 对应的安装信息；</span></span><br><span class="line">        <span class="keyword">final</span> PackageSetting ps = mSettings.mPackages.get(packageName);</span><br><span class="line">        <span class="keyword">if</span> (ps == <span class="keyword">null</span>) &#123;</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> PackageManagerException(<span class="string">"Package "</span> + packageName + <span class="string">" is unknown"</span>);</span><br><span class="line">        &#125; <span class="keyword">else</span> <span class="keyword">if</span> (!TextUtils.equals(volumeUuid, ps.volumeUuid)) &#123;</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> PackageManagerException(</span><br><span class="line">                    <span class="string">"Package "</span> + packageName + <span class="string">" found on unknown volume "</span> + volumeUuid</span><br><span class="line">                            + <span class="string">"; expected volume "</span> + ps.volumeUuid);</span><br><span class="line">        &#125; <span class="keyword">else</span> <span class="keyword">if</span> (!ps.getInstalled(userId)) &#123;</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> PackageManagerException(</span><br><span class="line">                    <span class="string">"Package "</span> + packageName + <span class="string">" not installed for user "</span> + userId);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>如果查不到安装数据，或者 volumeUuid 不匹配，或者该应用在当前设备用户 id 下不存在了，那就会抛出异常，然后 pms 会删除掉之前的数据！</p>
<p>normalizePackageNameLPr 会根据传入的 packageName，在 mRenamedPackages 找到重命名前的 oldName，如果该 package 之前重命名过，那么其一定会有 old name；</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">private</span> String <span class="title">normalizePackageNameLPr</span><span class="params">(String packageName)</span> </span>&#123;</span><br><span class="line">    String normalizedPackageName = mSettings.mRenamedPackages.get(packageName);</span><br><span class="line">    <span class="keyword">return</span> normalizedPackageName != <span class="keyword">null</span> ? normalizedPackageName : packageName;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>方法逻辑很简单！</p>
<h2 id="3-1-PMS-prepareAppDataLIF"><a href="#3-1-PMS-prepareAppDataLIF" class="headerlink" title="3.1 PMS.prepareAppDataLIF"></a>3.1 PMS.prepareAppDataLIF</h2><p>prepareAppDataLIF 方法为应用准备数据目录！</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">prepareAppDataLIF</span><span class="params">(PackageParser.Package pkg, <span class="keyword">int</span> userId, <span class="keyword">int</span> flags)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">if</span> (pkg == <span class="keyword">null</span>) &#123;</span><br><span class="line">        Slog.wtf(TAG, <span class="string">"Package was null!"</span>, <span class="keyword">new</span> Throwable());</span><br><span class="line">        <span class="keyword">return</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//【3.2】为该应用准备数据目录！</span></span><br><span class="line">    prepareAppDataLeafLIF(pkg, userId, flags);</span><br><span class="line">    <span class="comment">// 为 childPackage 创建数据目录！</span></span><br><span class="line">    <span class="keyword">final</span> <span class="keyword">int</span> childCount = (pkg.childPackages != <span class="keyword">null</span>) ? pkg.childPackages.size() : <span class="number">0</span>;</span><br><span class="line">    <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; childCount; i++) &#123;</span><br><span class="line">        prepareAppDataLeafLIF(pkg.childPackages.get(i), userId, flags);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h2 id="3-2-PMS-prepareAppDataLeafLIF"><a href="#3-2-PMS-prepareAppDataLeafLIF" class="headerlink" title="3.2 PMS.prepareAppDataLeafLIF"></a>3.2 PMS.prepareAppDataLeafLIF</h2><p>prepareAppDataLeafLIF 方法会继续处理数据目录操作：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">prepareAppDataLeafLIF</span><span class="params">(PackageParser.Package pkg, <span class="keyword">int</span> userId, <span class="keyword">int</span> flags)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">if</span> (DEBUG_APP_DATA) &#123;</span><br><span class="line">        Slog.v(TAG, <span class="string">"prepareAppData for "</span> + pkg.packageName + <span class="string">" u"</span> + userId + <span class="string">" 0x"</span></span><br><span class="line">                + Integer.toHexString(flags));</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">final</span> String volumeUuid = pkg.volumeUuid;</span><br><span class="line">    <span class="keyword">final</span> String packageName = pkg.packageName;</span><br><span class="line">    <span class="keyword">final</span> ApplicationInfo app = pkg.applicationInfo;</span><br><span class="line">    <span class="keyword">final</span> <span class="keyword">int</span> appId = UserHandle.getAppId(app.uid);</span><br><span class="line"></span><br><span class="line">    Preconditions.checkNotNull(app.seinfo);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">        <span class="comment">// 通过 Installd 来创建应用的数据目录；</span></span><br><span class="line">        mInstaller.createAppData(volumeUuid, packageName, userId, flags,</span><br><span class="line">                appId, app.seinfo, app.targetSdkVersion);</span><br><span class="line">    &#125; <span class="keyword">catch</span> (InstallerException e) &#123;</span><br><span class="line">        <span class="comment">// 如果创建失败，那么如果该应用是系统 apk，pms 会尝试重新创建一次，如果再次失败，那就不会处理！</span></span><br><span class="line">        <span class="keyword">if</span> (app.isSystemApp()) &#123;</span><br><span class="line">            logCriticalInfo(Log.ERROR, <span class="string">"Failed to create app data for "</span> + packageName</span><br><span class="line">                    + <span class="string">", but trying to recover: "</span> + e);</span><br><span class="line">            destroyAppDataLeafLIF(pkg, userId, flags);</span><br><span class="line">            <span class="keyword">try</span> &#123;</span><br><span class="line">                mInstaller.createAppData(volumeUuid, packageName, userId, flags,</span><br><span class="line">                        appId, app.seinfo, app.targetSdkVersion);</span><br><span class="line">                logCriticalInfo(Log.DEBUG, <span class="string">"Recovery succeeded!"</span>);</span><br><span class="line">            &#125; <span class="keyword">catch</span> (InstallerException e2) &#123;</span><br><span class="line">                logCriticalInfo(Log.DEBUG, <span class="string">"Recovery failed!"</span>);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            Slog.e(TAG, <span class="string">"Failed to create app data for "</span> + packageName + <span class="string">": "</span> + e);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 系统运行在文件加密模式下，不会进入这里！</span></span><br><span class="line">    <span class="keyword">if</span> ((flags &amp; StorageManager.FLAG_STORAGE_CE) != <span class="number">0</span>) &#123;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            <span class="comment">// CE storage is unlocked right now, so read out the inode and</span></span><br><span class="line">            <span class="comment">// remember for use later when it's locked</span></span><br><span class="line">            <span class="comment">// <span class="doctag">TODO:</span> mark this structure as dirty so we persist it!</span></span><br><span class="line">            <span class="keyword">final</span> <span class="keyword">long</span> ceDataInode = mInstaller.getAppDataInode(volumeUuid, packageName, userId,</span><br><span class="line">                    StorageManager.FLAG_STORAGE_CE);</span><br><span class="line">            <span class="keyword">synchronized</span> (mPackages) &#123;</span><br><span class="line">                <span class="keyword">final</span> PackageSetting ps = mSettings.mPackages.get(packageName);</span><br><span class="line">                <span class="keyword">if</span> (ps != <span class="keyword">null</span>) &#123;</span><br><span class="line">                    ps.setCeDataInode(ceDataInode, userId);</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125; <span class="keyword">catch</span> (InstallerException e) &#123;</span><br><span class="line">            Slog.e(TAG, <span class="string">"Failed to find inode for "</span> + packageName + <span class="string">": "</span> + e);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">//【3.3】继续调用 prepareAppDataContentsLeafLIF 进入下一步；</span></span><br><span class="line">    prepareAppDataContentsLeafLIF(pkg, userId, flags);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h2 id="3-3-PMS-prepareAppDataContentsLeafLIF"><a href="#3-3-PMS-prepareAppDataContentsLeafLIF" class="headerlink" title="3.3 PMS.prepareAppDataContentsLeafLIF"></a>3.3 PMS.prepareAppDataContentsLeafLIF</h2><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">prepareAppDataContentsLeafLIF</span><span class="params">(PackageParser.Package pkg, <span class="keyword">int</span> userId, <span class="keyword">int</span> flags)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">final</span> String volumeUuid = pkg.volumeUuid;</span><br><span class="line">    <span class="keyword">final</span> String packageName = pkg.packageName;</span><br><span class="line">    <span class="keyword">final</span> ApplicationInfo app = pkg.applicationInfo;</span><br><span class="line"> </span><br><span class="line">    <span class="comment">// 系统运行在文件加密模式下，不会进入这里！</span></span><br><span class="line">    <span class="keyword">if</span> ((flags &amp; StorageManager.FLAG_STORAGE_CE) != <span class="number">0</span>) &#123;</span><br><span class="line">        <span class="comment">// 如果应用使用的是 32 位架构的话，为 23 位库建立本地库符号链接；</span></span><br><span class="line">        <span class="keyword">if</span> (app.primaryCpuAbi != <span class="keyword">null</span> &amp;&amp; !VMRuntime.is64BitAbi(app.primaryCpuAbi)) &#123;</span><br><span class="line">            <span class="keyword">final</span> String nativeLibPath = app.nativeLibraryDir;</span><br><span class="line">            <span class="keyword">try</span> &#123;</span><br><span class="line">                <span class="comment">// 同样的，通过 installd 来建立 </span></span><br><span class="line">                mInstaller.linkNativeLibraryDirectory(volumeUuid, packageName,</span><br><span class="line">                        nativeLibPath, userId);</span><br><span class="line">            &#125; <span class="keyword">catch</span> (InstallerException e) &#123;</span><br><span class="line">                Slog.e(TAG, <span class="string">"Failed to link native for "</span> + packageName + <span class="string">": "</span> + e);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>可以看到，PMS 对于应用的数据目录的一系列操作，都是通过 installd 来实现的，因为 pms 本身没有 selinux 权限，所以他必须将权限交给一个特权进程，也就是 installd 来做！</p>
<h1 id="4-PackageManagerService-clearAppDataLIF"><a href="#4-PackageManagerService-clearAppDataLIF" class="headerlink" title="4 PackageManagerService.clearAppDataLIF"></a>4 PackageManagerService.clearAppDataLIF</h1><p>清楚缓存数据的前提是：ps.volumeUuid == StorageManager.UUID_PRIVATE_INTERNAL</p>
<p>参数传递：flags 为  StorageManager.FLAG_STORAGE_DE | StorageManager.FLAG_STORAGE_CE | Installer.FLAG_CLEAR_CODE_CACHE_ONLY<br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">clearAppDataLIF</span><span class="params">(PackageParser.Package pkg, <span class="keyword">int</span> userId, <span class="keyword">int</span> flags)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">if</span> (pkg == <span class="keyword">null</span>) &#123;</span><br><span class="line">        Slog.wtf(TAG, <span class="string">"Package was null!"</span>, <span class="keyword">new</span> Throwable());</span><br><span class="line">        <span class="keyword">return</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    clearAppDataLeafLIF(pkg, userId, flags);</span><br><span class="line">    <span class="keyword">final</span> <span class="keyword">int</span> childCount = (pkg.childPackages != <span class="keyword">null</span>) ? pkg.childPackages.size() : <span class="number">0</span>;</span><br><span class="line">    <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; childCount; i++) &#123;</span><br><span class="line">        clearAppDataLeafLIF(pkg.childPackages.get(i), userId, flags);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>继续调用：<br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">clearAppDataLeafLIF</span><span class="params">(PackageParser.Package pkg, <span class="keyword">int</span> userId, <span class="keyword">int</span> flags)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">final</span> PackageSetting ps;</span><br><span class="line">    <span class="keyword">synchronized</span> (mPackages) &#123;</span><br><span class="line">        ps = mSettings.mPackages.get(pkg.packageName);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">for</span> (<span class="keyword">int</span> realUserId : resolveUserIds(userId)) &#123;</span><br><span class="line">        <span class="keyword">final</span> <span class="keyword">long</span> ceDataInode = (ps != <span class="keyword">null</span>) ? ps.getCeDataInode(realUserId) : <span class="number">0</span>;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            </span><br><span class="line">            mInstaller.clearAppData(pkg.volumeUuid, pkg.packageName, realUserId, flags,</span><br><span class="line">                    ceDataInode);</span><br><span class="line">        &#125; <span class="keyword">catch</span> (InstallerException e) &#123;</span><br><span class="line">            Slog.w(TAG, String.valueOf(e));</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>仍然是调用 mInstaller 来对用户的应用数据进行操作！</p>
<h1 id="5-Settings-writeLPr-持久化最新数据"><a href="#5-Settings-writeLPr-持久化最新数据" class="headerlink" title="5 Settings.writeLPr - 持久化最新数据"></a>5 Settings.writeLPr - 持久化最新数据</h1><p>将解析到的安装数据写回到 packages.xml 等文件中！<br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">writeLPr</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    Debug.startMethodTracing(<span class="string">"/data/system/packageprof"</span>, <span class="number">8</span> * <span class="number">1024</span> * <span class="number">1024</span>);</span><br><span class="line">    <span class="comment">//【1】下面会先将最新的数据写入到 packages-backup.xml 文件中！</span></span><br><span class="line">    <span class="keyword">if</span> (mSettingsFilename.exists()) &#123;</span><br><span class="line">        <span class="keyword">if</span> (!mBackupSettingsFilename.exists()) &#123;</span><br><span class="line">            <span class="keyword">if</span> (!mSettingsFilename.renameTo(mBackupSettingsFilename)) &#123;</span><br><span class="line">                Slog.wtf(PackageManagerService.TAG,</span><br><span class="line">                        <span class="string">"Unable to backup package manager settings, "</span></span><br><span class="line">                        + <span class="string">" current changes will be lost at reboot"</span>);</span><br><span class="line">                <span class="keyword">return</span>;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            mSettingsFilename.delete();</span><br><span class="line">            Slog.w(PackageManagerService.TAG, <span class="string">"Preserving older settings backup"</span>);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    mPastSignatures.clear();</span><br><span class="line"></span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">        FileOutputStream fstr = <span class="keyword">new</span> FileOutputStream(mSettingsFilename);</span><br><span class="line">        BufferedOutputStream str = <span class="keyword">new</span> BufferedOutputStream(fstr);</span><br><span class="line"></span><br><span class="line">        <span class="comment">//XmlSerializer serializer = XmlUtils.serializerInstance();</span></span><br><span class="line">        XmlSerializer serializer = <span class="keyword">new</span> FastXmlSerializer();</span><br><span class="line">        serializer.setOutput(str, StandardCharsets.UTF_8.name());</span><br><span class="line">        serializer.startDocument(<span class="keyword">null</span>, <span class="keyword">true</span>);</span><br><span class="line">        serializer.setFeature(<span class="string">"http://xmlpull.org/v1/doc/features.html#indent-output"</span>, <span class="keyword">true</span>);</span><br><span class="line"></span><br><span class="line">        serializer.startTag(<span class="keyword">null</span>, <span class="string">"packages"</span>); <span class="comment">//【2】写入 "packages"！</span></span><br><span class="line"></span><br><span class="line">        <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; mVersion.size(); i++) &#123; <span class="comment">//【3】写入 "version"</span></span><br><span class="line">            <span class="keyword">final</span> String volumeUuid = mVersion.keyAt(i);</span><br><span class="line">            <span class="keyword">final</span> VersionInfo ver = mVersion.valueAt(i);</span><br><span class="line"></span><br><span class="line">            serializer.startTag(<span class="keyword">null</span>, TAG_VERSION);</span><br><span class="line">            XmlUtils.writeStringAttribute(serializer, ATTR_VOLUME_UUID, volumeUuid);</span><br><span class="line">            XmlUtils.writeIntAttribute(serializer, ATTR_SDK_VERSION, ver.sdkVersion);</span><br><span class="line">            XmlUtils.writeIntAttribute(serializer, ATTR_DATABASE_VERSION, ver.databaseVersion);</span><br><span class="line">            XmlUtils.writeStringAttribute(serializer, ATTR_FINGERPRINT, ver.fingerprint);</span><br><span class="line">            serializer.endTag(<span class="keyword">null</span>, TAG_VERSION);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (mVerifierDeviceIdentity != <span class="keyword">null</span>) &#123; <span class="comment">//【4】写入 "verifier"</span></span><br><span class="line">            serializer.startTag(<span class="keyword">null</span>, <span class="string">"verifier"</span>);</span><br><span class="line">            serializer.attribute(<span class="keyword">null</span>, <span class="string">"device"</span>, mVerifierDeviceIdentity.toString());</span><br><span class="line">            serializer.endTag(<span class="keyword">null</span>, <span class="string">"verifier"</span>);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (mReadExternalStorageEnforced != <span class="keyword">null</span>) &#123;</span><br><span class="line">            serializer.startTag(<span class="keyword">null</span>, TAG_READ_EXTERNAL_STORAGE);</span><br><span class="line">            serializer.attribute(</span><br><span class="line">                    <span class="keyword">null</span>, ATTR_ENFORCEMENT, mReadExternalStorageEnforced ? <span class="string">"1"</span> : <span class="string">"0"</span>);</span><br><span class="line">            serializer.endTag(<span class="keyword">null</span>, TAG_READ_EXTERNAL_STORAGE);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        serializer.startTag(<span class="keyword">null</span>, <span class="string">"permission-trees"</span>); <span class="comment">//【4.1】写入 "permission-trees"</span></span><br><span class="line">        <span class="keyword">for</span> (BasePermission bp : mPermissionTrees.values()) &#123;</span><br><span class="line">            writePermissionLPr(serializer, bp);</span><br><span class="line">        &#125;</span><br><span class="line">        serializer.endTag(<span class="keyword">null</span>, <span class="string">"permission-trees"</span>);</span><br><span class="line"></span><br><span class="line">        serializer.startTag(<span class="keyword">null</span>, <span class="string">"permissions"</span>); <span class="comment">//【4.1】写入 "permissions"</span></span><br><span class="line">        <span class="keyword">for</span> (BasePermission bp : mPermissions.values()) &#123;</span><br><span class="line">            writePermissionLPr(serializer, bp);</span><br><span class="line">        &#125;</span><br><span class="line">        serializer.endTag(<span class="keyword">null</span>, <span class="string">"permissions"</span>);</span><br><span class="line"></span><br><span class="line">        <span class="keyword">for</span> (<span class="keyword">final</span> PackageSetting pkg : mPackages.values()) &#123; <span class="comment">// 写入 "package"</span></span><br><span class="line">            writePackageLPr(serializer, pkg);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">for</span> (<span class="keyword">final</span> PackageSetting pkg : mDisabledSysPackages.values()) &#123; <span class="comment">// 写入 "updated-package"</span></span><br><span class="line">            writeDisabledSysPackageLPr(serializer, pkg);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">for</span> (<span class="keyword">final</span> SharedUserSetting usr : mSharedUsers.values()) &#123; <span class="comment">// 写入 "shared-user"</span></span><br><span class="line">            serializer.startTag(<span class="keyword">null</span>, <span class="string">"shared-user"</span>);</span><br><span class="line">            serializer.attribute(<span class="keyword">null</span>, ATTR_NAME, usr.name);</span><br><span class="line">            serializer.attribute(<span class="keyword">null</span>, <span class="string">"userId"</span>,</span><br><span class="line">                    Integer.toString(usr.userId));</span><br><span class="line">            usr.signatures.writeXml(serializer, <span class="string">"sigs"</span>, mPastSignatures);</span><br><span class="line">            <span class="comment">// 写入 shared-user 的安装时权限！</span></span><br><span class="line">            writePermissionsLPr(serializer, usr.getPermissionsState()</span><br><span class="line">                    .getInstallPermissionStates());</span><br><span class="line">            serializer.endTag(<span class="keyword">null</span>, <span class="string">"shared-user"</span>);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (mPackagesToBeCleaned.size() &gt; <span class="number">0</span>) &#123; <span class="comment">// 写入 "cleaning-package"</span></span><br><span class="line">            <span class="keyword">for</span> (PackageCleanItem item : mPackagesToBeCleaned) &#123;</span><br><span class="line">                <span class="keyword">final</span> String userStr = Integer.toString(item.userId);</span><br><span class="line">                serializer.startTag(<span class="keyword">null</span>, <span class="string">"cleaning-package"</span>);</span><br><span class="line">                serializer.attribute(<span class="keyword">null</span>, ATTR_NAME, item.packageName);</span><br><span class="line">                serializer.attribute(<span class="keyword">null</span>, ATTR_CODE, item.andCode ? <span class="string">"true"</span> : <span class="string">"false"</span>);</span><br><span class="line">                serializer.attribute(<span class="keyword">null</span>, ATTR_USER, userStr);</span><br><span class="line">                serializer.endTag(<span class="keyword">null</span>, <span class="string">"cleaning-package"</span>);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (mRenamedPackages.size() &gt; <span class="number">0</span>) &#123; <span class="comment">// 写入 "renamed-package"</span></span><br><span class="line">            <span class="keyword">for</span> (Map.Entry&lt;String, String&gt; e : mRenamedPackages.entrySet()) &#123;</span><br><span class="line">                serializer.startTag(<span class="keyword">null</span>, <span class="string">"renamed-package"</span>);</span><br><span class="line">                serializer.attribute(<span class="keyword">null</span>, <span class="string">"new"</span>, e.getKey());</span><br><span class="line">                serializer.attribute(<span class="keyword">null</span>, <span class="string">"old"</span>, e.getValue());</span><br><span class="line">                serializer.endTag(<span class="keyword">null</span>, <span class="string">"renamed-package"</span>);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">final</span> <span class="keyword">int</span> numIVIs = mRestoredIntentFilterVerifications.size();</span><br><span class="line">        <span class="keyword">if</span> (numIVIs &gt; <span class="number">0</span>) &#123;</span><br><span class="line">            <span class="keyword">if</span> (DEBUG_DOMAIN_VERIFICATION) &#123;</span><br><span class="line">                Slog.i(TAG, <span class="string">"Writing restored-ivi entries to packages.xml"</span>);</span><br><span class="line">            &#125;</span><br><span class="line">            serializer.startTag(<span class="keyword">null</span>, <span class="string">"restored-ivi"</span>);</span><br><span class="line">            <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; numIVIs; i++) &#123;</span><br><span class="line">                IntentFilterVerificationInfo ivi = mRestoredIntentFilterVerifications.valueAt(i);</span><br><span class="line">                writeDomainVerificationsLPr(serializer, ivi);</span><br><span class="line">            &#125;</span><br><span class="line">            serializer.endTag(<span class="keyword">null</span>, <span class="string">"restored-ivi"</span>);</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            <span class="keyword">if</span> (DEBUG_DOMAIN_VERIFICATION) &#123;</span><br><span class="line">                Slog.i(TAG, <span class="string">"  no restored IVI entries to write"</span>);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        mKeySetManagerService.writeKeySetManagerServiceLPr(serializer);</span><br><span class="line"></span><br><span class="line">        serializer.endTag(<span class="keyword">null</span>, <span class="string">"packages"</span>); <span class="comment">// 结束 packages-backup.xml 文件的写入！</span></span><br><span class="line"></span><br><span class="line">        serializer.endDocument();</span><br><span class="line"></span><br><span class="line">        str.flush();</span><br><span class="line">        FileUtils.sync(fstr);</span><br><span class="line">        str.close();</span><br><span class="line"></span><br><span class="line">        <span class="comment">// New settings successfully written, old ones are no longer</span></span><br><span class="line">        <span class="comment">// needed.</span></span><br><span class="line">        mBackupSettingsFilename.delete();</span><br><span class="line">        FileUtils.setPermissions(mSettingsFilename.toString(),</span><br><span class="line">                FileUtils.S_IRUSR|FileUtils.S_IWUSR</span><br><span class="line">                |FileUtils.S_IRGRP|FileUtils.S_IWGRP,</span><br><span class="line">                -<span class="number">1</span>, -<span class="number">1</span>);</span><br><span class="line"></span><br><span class="line">        writeKernelMappingLPr();</span><br><span class="line">        writePackageListLPr(); <span class="comment">//【4.4】写入 packageslist 文件！</span></span><br><span class="line">        writeAllUsersPackageRestrictionsLPr(); <span class="comment">//【4.5】写入偏好设置信息；</span></span><br><span class="line">        writeAllRuntimePermissionsLPr(); <span class="comment">//【4.6】写入运行时权限授予信息！</span></span><br><span class="line">        <span class="keyword">return</span>;</span><br><span class="line"></span><br><span class="line">    &#125; <span class="keyword">catch</span>(XmlPullParserException e) &#123;</span><br><span class="line">        Slog.wtf(PackageManagerService.TAG, <span class="string">"Unable to write package manager settings, "</span></span><br><span class="line">                + <span class="string">"current changes will be lost at reboot"</span>, e);</span><br><span class="line">    &#125; <span class="keyword">catch</span>(java.io.IOException e) &#123;</span><br><span class="line">        Slog.wtf(PackageManagerService.TAG, <span class="string">"Unable to write package manager settings, "</span></span><br><span class="line">                + <span class="string">"current changes will be lost at reboot"</span>, e);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// Clean up partially written files</span></span><br><span class="line">    <span class="keyword">if</span> (mSettingsFilename.exists()) &#123;</span><br><span class="line">        <span class="keyword">if</span> (!mSettingsFilename.delete()) &#123;</span><br><span class="line">            Slog.wtf(PackageManagerService.TAG, <span class="string">"Failed to clean up mangled file: "</span></span><br><span class="line">                    + mSettingsFilename);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">//Debug.stopMethodTracing();</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<h2 id="5-1-Settings-writePermissionLPr-保存-“permission-trees”-“permission”"><a href="#5-1-Settings-writePermissionLPr-保存-“permission-trees”-“permission”" class="headerlink" title="5.1 Settings.writePermissionLPr - 保存 “permission-trees” / “permission”"></a>5.1 Settings.writePermissionLPr - 保存 “permission-trees” / “permission”</h2><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">writePermissionLPr</span><span class="params">(XmlSerializer serializer, BasePermission bp)</span></span></span><br><span class="line"><span class="function">        <span class="keyword">throws</span> XmlPullParserException, java.io.IOException </span>&#123;</span><br><span class="line">    <span class="keyword">if</span> (bp.sourcePackage != <span class="keyword">null</span>) &#123;</span><br><span class="line">        serializer.startTag(<span class="keyword">null</span>, TAG_ITEM); <span class="comment">// item 标签</span></span><br><span class="line">        serializer.attribute(<span class="keyword">null</span>, ATTR_NAME, bp.name); <span class="comment">// name 属性</span></span><br><span class="line">        serializer.attribute(<span class="keyword">null</span>, <span class="string">"package"</span>, bp.sourcePackage); <span class="comment">// package 属性，表示定义者 package</span></span><br><span class="line">        <span class="keyword">if</span> (bp.protectionLevel != PermissionInfo.PROTECTION_NORMAL) &#123; <span class="comment">// protection 属性，权限级别！</span></span><br><span class="line">            serializer.attribute(<span class="keyword">null</span>, <span class="string">"protection"</span>, Integer.toString(bp.protectionLevel));</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (PackageManagerService.DEBUG_SETTINGS)</span><br><span class="line">            Log.v(PackageManagerService.TAG, <span class="string">"Writing perm: name="</span> + bp.name + <span class="string">" type="</span></span><br><span class="line">                    + bp.type);</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (bp.type == BasePermission.TYPE_DYNAMIC) &#123; <span class="comment">// 如果是动态权限，这里是针对于权限树的操作！</span></span><br><span class="line">            <span class="keyword">final</span> PermissionInfo pi = bp.perm != <span class="keyword">null</span> ? bp.perm.info : bp.pendingInfo;</span><br><span class="line">            <span class="keyword">if</span> (pi != <span class="keyword">null</span>) &#123;</span><br><span class="line">                serializer.attribute(<span class="keyword">null</span>, <span class="string">"type"</span>, <span class="string">"dynamic"</span>);</span><br><span class="line">                <span class="keyword">if</span> (pi.icon != <span class="number">0</span>) &#123;</span><br><span class="line">                    serializer.attribute(<span class="keyword">null</span>, <span class="string">"icon"</span>, Integer.toString(pi.icon));</span><br><span class="line">                &#125;</span><br><span class="line">                <span class="keyword">if</span> (pi.nonLocalizedLabel != <span class="keyword">null</span>) &#123;</span><br><span class="line">                    serializer.attribute(<span class="keyword">null</span>, <span class="string">"label"</span>, pi.nonLocalizedLabel.toString());</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        serializer.endTag(<span class="keyword">null</span>, TAG_ITEM);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>权限树以 <code>&lt;permission-trees&gt; &lt;/permission-trees&gt;</code> 开始和结束，权限树以 <code>&lt;permissions&gt; &lt;/permissions&gt;</code> 开始和结束！</p>
<h2 id="5-2-Settings-writePackageLPr-保存-“package”"><a href="#5-2-Settings-writePackageLPr-保存-“package”" class="headerlink" title="5.2 Settings.writePackageLPr - 保存 “package”"></a>5.2 Settings.writePackageLPr - 保存 “package”</h2><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">writePackageLPr</span><span class="params">(XmlSerializer serializer, <span class="keyword">final</span> PackageSetting pkg)</span></span></span><br><span class="line"><span class="function">        <span class="keyword">throws</span> java.io.IOException </span>&#123;</span><br><span class="line">    serializer.startTag(<span class="keyword">null</span>, <span class="string">"package"</span>);</span><br><span class="line">    serializer.attribute(<span class="keyword">null</span>, ATTR_NAME, pkg.name); </span><br><span class="line">    <span class="keyword">if</span> (pkg.realName != <span class="keyword">null</span>) &#123;</span><br><span class="line">        serializer.attribute(<span class="keyword">null</span>, <span class="string">"realName"</span>, pkg.realName);</span><br><span class="line">    &#125;</span><br><span class="line">    serializer.attribute(<span class="keyword">null</span>, <span class="string">"codePath"</span>, pkg.codePathString);</span><br><span class="line">    <span class="keyword">if</span> (!pkg.resourcePathString.equals(pkg.codePathString)) &#123;</span><br><span class="line">        serializer.attribute(<span class="keyword">null</span>, <span class="string">"resourcePath"</span>, pkg.resourcePathString);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (pkg.legacyNativeLibraryPathString != <span class="keyword">null</span>) &#123;</span><br><span class="line">        serializer.attribute(<span class="keyword">null</span>, <span class="string">"nativeLibraryPath"</span>, pkg.legacyNativeLibraryPathString);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span> (pkg.primaryCpuAbiString != <span class="keyword">null</span>) &#123;</span><br><span class="line">        serializer.attribute(<span class="keyword">null</span>, <span class="string">"primaryCpuAbi"</span>, pkg.primaryCpuAbiString);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span> (pkg.secondaryCpuAbiString != <span class="keyword">null</span>) &#123;</span><br><span class="line">        serializer.attribute(<span class="keyword">null</span>, <span class="string">"secondaryCpuAbi"</span>, pkg.secondaryCpuAbiString);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span> (pkg.cpuAbiOverrideString != <span class="keyword">null</span>) &#123;</span><br><span class="line">        serializer.attribute(<span class="keyword">null</span>, <span class="string">"cpuAbiOverride"</span>, pkg.cpuAbiOverrideString);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    serializer.attribute(<span class="keyword">null</span>, <span class="string">"publicFlags"</span>, Integer.toString(pkg.pkgFlags));</span><br><span class="line">    serializer.attribute(<span class="keyword">null</span>, <span class="string">"privateFlags"</span>, Integer.toString(pkg.pkgPrivateFlags));</span><br><span class="line">    serializer.attribute(<span class="keyword">null</span>, <span class="string">"ft"</span>, Long.toHexString(pkg.timeStamp));</span><br><span class="line">    serializer.attribute(<span class="keyword">null</span>, <span class="string">"it"</span>, Long.toHexString(pkg.firstInstallTime));</span><br><span class="line">    serializer.attribute(<span class="keyword">null</span>, <span class="string">"ut"</span>, Long.toHexString(pkg.lastUpdateTime));</span><br><span class="line">    serializer.attribute(<span class="keyword">null</span>, <span class="string">"version"</span>, String.valueOf(pkg.versionCode));</span><br><span class="line">    <span class="keyword">if</span> (pkg.sharedUser == <span class="keyword">null</span>) &#123;</span><br><span class="line">        serializer.attribute(<span class="keyword">null</span>, <span class="string">"userId"</span>, Integer.toString(pkg.appId));</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        serializer.attribute(<span class="keyword">null</span>, <span class="string">"sharedUserId"</span>, Integer.toString(pkg.appId));</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span> (pkg.uidError) &#123;</span><br><span class="line">        serializer.attribute(<span class="keyword">null</span>, <span class="string">"uidError"</span>, <span class="string">"true"</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span> (pkg.installStatus == PackageSettingBase.PKG_INSTALL_INCOMPLETE) &#123;</span><br><span class="line">        serializer.attribute(<span class="keyword">null</span>, <span class="string">"installStatus"</span>, <span class="string">"false"</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span> (pkg.installerPackageName != <span class="keyword">null</span>) &#123;</span><br><span class="line">        serializer.attribute(<span class="keyword">null</span>, <span class="string">"installer"</span>, pkg.installerPackageName);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span> (pkg.isOrphaned) &#123;</span><br><span class="line">        serializer.attribute(<span class="keyword">null</span>, <span class="string">"isOrphaned"</span>, <span class="string">"true"</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span> (pkg.volumeUuid != <span class="keyword">null</span>) &#123;</span><br><span class="line">        serializer.attribute(<span class="keyword">null</span>, <span class="string">"volumeUuid"</span>, pkg.volumeUuid);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span> (pkg.parentPackageName != <span class="keyword">null</span>) &#123;</span><br><span class="line">        serializer.attribute(<span class="keyword">null</span>, <span class="string">"parentPackageName"</span>, pkg.parentPackageName);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    writeChildPackagesLPw(serializer, pkg.childPackageNames);</span><br><span class="line"></span><br><span class="line">    pkg.signatures.writeXml(serializer, <span class="string">"sigs"</span>, mPastSignatures);</span><br><span class="line">    <span class="comment">// 写入该 package 持有的安装时权限！</span></span><br><span class="line">    writePermissionsLPr(serializer, pkg.getPermissionsState()</span><br><span class="line">                .getInstallPermissionStates());</span><br><span class="line"></span><br><span class="line">    writeSigningKeySetLPr(serializer, pkg.keySetData);</span><br><span class="line">    writeUpgradeKeySetsLPr(serializer, pkg.keySetData);</span><br><span class="line">    writeKeySetAliasesLPr(serializer, pkg.keySetData);</span><br><span class="line">    writeDomainVerificationsLPr(serializer, pkg.verificationInfo);</span><br><span class="line"></span><br><span class="line">    serializer.endTag(<span class="keyword">null</span>, <span class="string">"package"</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>应用包信息以 <code>&lt;package&gt; &lt;/package&gt;</code> 开始和结束，不多说了！</p>
<h2 id="5-3-Settings-writeDisabledSysPackageLPr-保存-“updated-package”"><a href="#5-3-Settings-writeDisabledSysPackageLPr-保存-“updated-package”" class="headerlink" title="5.3 Settings.writeDisabledSysPackageLPr - 保存 “updated-package”"></a>5.3 Settings.writeDisabledSysPackageLPr - 保存 “updated-package”</h2><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">writeDisabledSysPackageLPr</span><span class="params">(XmlSerializer serializer, <span class="keyword">final</span> PackageSetting pkg)</span></span></span><br><span class="line"><span class="function">        <span class="keyword">throws</span> java.io.IOException </span>&#123;</span><br><span class="line">    serializer.startTag(<span class="keyword">null</span>, <span class="string">"updated-package"</span>);</span><br><span class="line">    serializer.attribute(<span class="keyword">null</span>, ATTR_NAME, pkg.name);</span><br><span class="line">    <span class="keyword">if</span> (pkg.realName != <span class="keyword">null</span>) &#123;</span><br><span class="line">        serializer.attribute(<span class="keyword">null</span>, <span class="string">"realName"</span>, pkg.realName);</span><br><span class="line">    &#125;</span><br><span class="line">    serializer.attribute(<span class="keyword">null</span>, <span class="string">"codePath"</span>, pkg.codePathString);</span><br><span class="line">    serializer.attribute(<span class="keyword">null</span>, <span class="string">"ft"</span>, Long.toHexString(pkg.timeStamp));</span><br><span class="line">    serializer.attribute(<span class="keyword">null</span>, <span class="string">"it"</span>, Long.toHexString(pkg.firstInstallTime));</span><br><span class="line">    serializer.attribute(<span class="keyword">null</span>, <span class="string">"ut"</span>, Long.toHexString(pkg.lastUpdateTime));</span><br><span class="line">    serializer.attribute(<span class="keyword">null</span>, <span class="string">"version"</span>, String.valueOf(pkg.versionCode));</span><br><span class="line">    <span class="keyword">if</span> (!pkg.resourcePathString.equals(pkg.codePathString)) &#123;</span><br><span class="line">        serializer.attribute(<span class="keyword">null</span>, <span class="string">"resourcePath"</span>, pkg.resourcePathString);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span> (pkg.legacyNativeLibraryPathString != <span class="keyword">null</span>) &#123;</span><br><span class="line">        serializer.attribute(<span class="keyword">null</span>, <span class="string">"nativeLibraryPath"</span>, pkg.legacyNativeLibraryPathString);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span> (pkg.primaryCpuAbiString != <span class="keyword">null</span>) &#123;</span><br><span class="line">       serializer.attribute(<span class="keyword">null</span>, <span class="string">"primaryCpuAbi"</span>, pkg.primaryCpuAbiString);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span> (pkg.secondaryCpuAbiString != <span class="keyword">null</span>) &#123;</span><br><span class="line">        serializer.attribute(<span class="keyword">null</span>, <span class="string">"secondaryCpuAbi"</span>, pkg.secondaryCpuAbiString);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span> (pkg.cpuAbiOverrideString != <span class="keyword">null</span>) &#123;</span><br><span class="line">        serializer.attribute(<span class="keyword">null</span>, <span class="string">"cpuAbiOverride"</span>, pkg.cpuAbiOverrideString);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (pkg.sharedUser == <span class="keyword">null</span>) &#123;</span><br><span class="line">        serializer.attribute(<span class="keyword">null</span>, <span class="string">"userId"</span>, Integer.toString(pkg.appId));</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        serializer.attribute(<span class="keyword">null</span>, <span class="string">"sharedUserId"</span>, Integer.toString(pkg.appId));</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (pkg.parentPackageName != <span class="keyword">null</span>) &#123;</span><br><span class="line">        serializer.attribute(<span class="keyword">null</span>, <span class="string">"parentPackageName"</span>, pkg.parentPackageName);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    writeChildPackagesLPw(serializer, pkg.childPackageNames);</span><br><span class="line"></span><br><span class="line">    <span class="comment">// If this is a shared user, the permissions will be written there.</span></span><br><span class="line">    <span class="keyword">if</span> (pkg.sharedUser == <span class="keyword">null</span>) &#123;</span><br><span class="line">        writePermissionsLPr(serializer, pkg.getPermissionsState()</span><br><span class="line">                .getInstallPermissionStates());</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    serializer.endTag(<span class="keyword">null</span>, <span class="string">"updated-package"</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>被更新过的应用的信息以 <code>&lt;updated-package&gt; &lt;/updated-package&gt;</code> 开始和结束，不多说了！</p>
<h2 id="5-4-Settings-writePackageListLPr-写入-“packages-list”"><a href="#5-4-Settings-writePackageListLPr-写入-“packages-list”" class="headerlink" title="5.4 Settings.writePackageListLPr - 写入 “packages.list”"></a>5.4 Settings.writePackageListLPr - 写入 “packages.list”</h2><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">writePackageListLPr</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    writePackageListLPr(-<span class="number">1</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>最后，调用的是 writePackageListLPr 一参数方法：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">writePackageListLPr</span><span class="params">(<span class="keyword">int</span> creatingUserId)</span> </span>&#123;</span><br><span class="line">    <span class="comment">//【1】首先获得所有的设备用户信息！</span></span><br><span class="line">    <span class="keyword">final</span> List&lt;UserInfo&gt; users = UserManagerService.getInstance().getUsers(<span class="keyword">true</span>);</span><br><span class="line">    <span class="keyword">int</span>[] userIds = <span class="keyword">new</span> <span class="keyword">int</span>[users.size()];</span><br><span class="line">    <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; userIds.length; i++) &#123;</span><br><span class="line">        userIds[i] = users.get(i).id;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span> (creatingUserId != -<span class="number">1</span>) &#123; <span class="comment">// 这里不进入！</span></span><br><span class="line">        userIds = ArrayUtils.appendInt(userIds, creatingUserId);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// Write package list file now, use a JournaledFile.</span></span><br><span class="line">    File tempFile = <span class="keyword">new</span> File(mPackageListFilename.getAbsolutePath() + <span class="string">".tmp"</span>);</span><br><span class="line">    JournaledFile journal = <span class="keyword">new</span> JournaledFile(mPackageListFilename, tempFile);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">final</span> File writeTarget = journal.chooseForWrite();</span><br><span class="line">    FileOutputStream fstr;</span><br><span class="line">    BufferedWriter writer = <span class="keyword">null</span>;</span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">        fstr = <span class="keyword">new</span> FileOutputStream(writeTarget);</span><br><span class="line">        writer = <span class="keyword">new</span> BufferedWriter(<span class="keyword">new</span> OutputStreamWriter(fstr, Charset.defaultCharset()));</span><br><span class="line">        FileUtils.setPermissions(fstr.getFD(), <span class="number">0640</span>, SYSTEM_UID, PACKAGE_INFO_GID);</span><br><span class="line"></span><br><span class="line">        StringBuilder sb = <span class="keyword">new</span> StringBuilder();</span><br><span class="line">        <span class="comment">//【2】遍历系统中所有被安装过的 package！</span></span><br><span class="line">        <span class="keyword">for</span> (<span class="keyword">final</span> PackageSetting pkg : mPackages.values()) &#123;</span><br><span class="line">            <span class="comment">//【2.1】跳过哪些异常的 package！</span></span><br><span class="line">            <span class="keyword">if</span> (pkg.pkg == <span class="keyword">null</span> || pkg.pkg.applicationInfo == <span class="keyword">null</span></span><br><span class="line">                    || pkg.pkg.applicationInfo.dataDir == <span class="keyword">null</span>) &#123;</span><br><span class="line">                <span class="keyword">if</span> (!<span class="string">"android"</span>.equals(pkg.name)) &#123;</span><br><span class="line">                    Slog.w(TAG, <span class="string">"Skipping "</span> + pkg + <span class="string">" due to missing metadata"</span>);</span><br><span class="line">                &#125;</span><br><span class="line">                <span class="keyword">continue</span>;</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            <span class="keyword">final</span> ApplicationInfo ai = pkg.pkg.applicationInfo;</span><br><span class="line">            <span class="keyword">final</span> String dataPath = ai.dataDir;</span><br><span class="line">            <span class="keyword">final</span> <span class="keyword">boolean</span> isDebug = (ai.flags &amp; ApplicationInfo.FLAG_DEBUGGABLE) != <span class="number">0</span>;</span><br><span class="line">            <span class="keyword">final</span> <span class="keyword">int</span>[] gids = pkg.getPermissionsState().computeGids(userIds);</span><br><span class="line"></span><br><span class="line">            <span class="comment">//【2.2】跳过哪些 dataPath 有空格的应用！</span></span><br><span class="line">            <span class="keyword">if</span> (dataPath.indexOf(<span class="string">' '</span>) &gt;= <span class="number">0</span>)</span><br><span class="line">                <span class="keyword">continue</span>;</span><br><span class="line"></span><br><span class="line">            <span class="comment">// we store on each line the following information for now:</span></span><br><span class="line">            <span class="comment">//</span></span><br><span class="line">            <span class="comment">// pkgName    - package name</span></span><br><span class="line">            <span class="comment">// userId     - application-specific user id</span></span><br><span class="line">            <span class="comment">// debugFlag  - 0 or 1 if the package is debuggable.</span></span><br><span class="line">            <span class="comment">// dataPath   - path to package's data path</span></span><br><span class="line">            <span class="comment">// seinfo     - seinfo label for the app (assigned at install time)</span></span><br><span class="line">            <span class="comment">// gids       - supplementary gids this app launches with</span></span><br><span class="line">            <span class="comment">//</span></span><br><span class="line">            <span class="comment">// <span class="doctag">NOTE:</span> We prefer not to expose all ApplicationInfo flags for now.</span></span><br><span class="line">            <span class="comment">//</span></span><br><span class="line">            <span class="comment">// DO NOT MODIFY THIS FORMAT UNLESS YOU CAN ALSO MODIFY ITS USERS</span></span><br><span class="line">            <span class="comment">// FROM NATIVE CODE. AT THE MOMENT, LOOK AT THE FOLLOWING SOURCES:</span></span><br><span class="line">            <span class="comment">//   frameworks/base/libs/packagelistparser</span></span><br><span class="line">            <span class="comment">//   system/core/run-as/run-as.c</span></span><br><span class="line">            <span class="comment">//</span></span><br><span class="line">            <span class="comment">//【2.3】根据指定的格式写入数据！</span></span><br><span class="line">            sb.setLength(<span class="number">0</span>);</span><br><span class="line">            sb.append(ai.packageName);</span><br><span class="line">            sb.append(<span class="string">" "</span>);</span><br><span class="line">            sb.append(ai.uid);</span><br><span class="line">            sb.append(isDebug ? <span class="string">" 1 "</span> : <span class="string">" 0 "</span>);</span><br><span class="line">            sb.append(dataPath);</span><br><span class="line">            sb.append(<span class="string">" "</span>);</span><br><span class="line">            sb.append(ai.seinfo);</span><br><span class="line">            sb.append(<span class="string">" "</span>);</span><br><span class="line">            <span class="keyword">if</span> (gids != <span class="keyword">null</span> &amp;&amp; gids.length &gt; <span class="number">0</span>) &#123;</span><br><span class="line">                sb.append(gids[<span class="number">0</span>]);</span><br><span class="line">                <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">1</span>; i &lt; gids.length; i++) &#123;</span><br><span class="line">                    sb.append(<span class="string">","</span>);</span><br><span class="line">                    sb.append(gids[i]);</span><br><span class="line">                &#125;</span><br><span class="line">            &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                sb.append(<span class="string">"none"</span>);</span><br><span class="line">            &#125;</span><br><span class="line">            sb.append(<span class="string">"\n"</span>);</span><br><span class="line">            writer.append(sb);</span><br><span class="line">        &#125;</span><br><span class="line">        writer.flush();</span><br><span class="line">        FileUtils.sync(fstr);</span><br><span class="line">        writer.close();</span><br><span class="line">        journal.commit();</span><br><span class="line">    &#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">        Slog.wtf(TAG, <span class="string">"Failed to write packages.list"</span>, e);</span><br><span class="line">        IoUtils.closeQuietly(writer);</span><br><span class="line">        journal.rollback();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>我们可以看到，在 packages.list 文件中，存储的格式为：<br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">pkgName userId debugFlag dataPath  seinfo gids</span><br></pre></td></tr></table></figure></p>
<p>大家可以去看那个文件内容！！</p>
<h2 id="5-5-Settings-writeAllUsersPackageRestrictionsLPr-保存偏好设置"><a href="#5-5-Settings-writeAllUsersPackageRestrictionsLPr-保存偏好设置" class="headerlink" title="5.5 Settings.writeAllUsersPackageRestrictionsLPr - 保存偏好设置"></a>5.5 Settings.writeAllUsersPackageRestrictionsLPr - 保存偏好设置</h2><p>接下来，写入最新的偏好设置！<br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">writeAllUsersPackageRestrictionsLPr</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    List&lt;UserInfo&gt; users = getAllUsers();</span><br><span class="line">    <span class="keyword">if</span> (users == <span class="keyword">null</span>) <span class="keyword">return</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">for</span> (UserInfo user : users) &#123;</span><br><span class="line">        writePackageRestrictionsLPr(user.id);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>接着，调用 writePackageRestrictionsLPr 方法！这个方法我们前面分析过，这里不处理！</p>
<h2 id="5-6-Settings-writeAllRuntimePermissionsLPr-保存运行时权限授予信息"><a href="#5-6-Settings-writeAllRuntimePermissionsLPr-保存运行时权限授予信息" class="headerlink" title="5.6 Settings.writeAllRuntimePermissionsLPr - 保存运行时权限授予信息"></a>5.6 Settings.writeAllRuntimePermissionsLPr - 保存运行时权限授予信息</h2><p>接下来，写入最新的运行时权限授予信息！<br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">writeAllRuntimePermissionsLPr</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    <span class="keyword">for</span> (<span class="keyword">int</span> userId : UserManagerService.getInstance().getUserIds()) &#123;</span><br><span class="line">        <span class="comment">//【5.6.1】对每一个设备用户，保存其运行时权限授予信息！</span></span><br><span class="line">        mRuntimePermissionsPersistence.writePermissionsForUserAsyncLPr(userId);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<h3 id="5-6-1-RuntimePermissionsPersistence-writePermissionsForUserAsyncLPr"><a href="#5-6-1-RuntimePermissionsPersistence-writePermissionsForUserAsyncLPr" class="headerlink" title="5.6.1 RuntimePermissionsPersistence.writePermissionsForUserAsyncLPr"></a>5.6.1 RuntimePermissionsPersistence.writePermissionsForUserAsyncLPr</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">writePermissionsForUserAsyncLPr</span><span class="params">(<span class="keyword">int</span> userId)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">final</span> <span class="keyword">long</span> currentTimeMillis = SystemClock.uptimeMillis();</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (mWriteScheduled.get(userId)) &#123;</span><br><span class="line">        mHandler.removeMessages(userId);</span><br><span class="line"></span><br><span class="line">        <span class="comment">// If enough time passed, write without holding off anymore.</span></span><br><span class="line">        <span class="keyword">final</span> <span class="keyword">long</span> lastNotWrittenMutationTimeMillis = mLastNotWrittenMutationTimesMillis</span><br><span class="line">                .get(userId);</span><br><span class="line">        <span class="keyword">final</span> <span class="keyword">long</span> timeSinceLastNotWrittenMutationMillis = currentTimeMillis</span><br><span class="line">                - lastNotWrittenMutationTimeMillis;</span><br><span class="line">        <span class="keyword">if</span> (timeSinceLastNotWrittenMutationMillis &gt;= MAX_WRITE_PERMISSIONS_DELAY_MILLIS) &#123;</span><br><span class="line">            mHandler.obtainMessage(userId).sendToTarget();</span><br><span class="line">            <span class="keyword">return</span>;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// Hold off a bit more as settings are frequently changing.</span></span><br><span class="line">        <span class="keyword">final</span> <span class="keyword">long</span> maxDelayMillis = Math.max(lastNotWrittenMutationTimeMillis</span><br><span class="line">                + MAX_WRITE_PERMISSIONS_DELAY_MILLIS - currentTimeMillis, <span class="number">0</span>);</span><br><span class="line">        <span class="keyword">final</span> <span class="keyword">long</span> writeDelayMillis = Math.min(WRITE_PERMISSIONS_DELAY_MILLIS,</span><br><span class="line">                maxDelayMillis);</span><br><span class="line"></span><br><span class="line">        Message message = mHandler.obtainMessage(userId);</span><br><span class="line">        mHandler.sendMessageDelayed(message, writeDelayMillis);</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        mLastNotWrittenMutationTimesMillis.put(userId, currentTimeMillis);</span><br><span class="line">        Message message = mHandler.obtainMessage(userId);</span><br><span class="line">        mHandler.sendMessageDelayed(message, WRITE_PERMISSIONS_DELAY_MILLIS);</span><br><span class="line">        mWriteScheduled.put(userId, <span class="keyword">true</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>就是发送消息给 MyHandler：</p>
<h3 id="5-6-2-RuntimePermissionsPersistence-MyHandler-handleMessage"><a href="#5-6-2-RuntimePermissionsPersistence-MyHandler-handleMessage" class="headerlink" title="5.6.2 RuntimePermissionsPersistence.MyHandler.handleMessage"></a>5.6.2 RuntimePermissionsPersistence.MyHandler.handleMessage</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">private</span> <span class="keyword">final</span> <span class="class"><span class="keyword">class</span> <span class="title">MyHandler</span> <span class="keyword">extends</span> <span class="title">Handler</span> </span>&#123;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="title">MyHandler</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">super</span>(BackgroundThread.getHandler().getLooper());</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">handleMessage</span><span class="params">(Message message)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">final</span> <span class="keyword">int</span> userId = message.what;</span><br><span class="line">        Runnable callback = (Runnable) message.obj;</span><br><span class="line">        <span class="comment">//【4.6.3】writePermissionsSync！</span></span><br><span class="line">        writePermissionsSync(userId);</span><br><span class="line">        <span class="keyword">if</span> (callback != <span class="keyword">null</span>) &#123;</span><br><span class="line">            callback.run();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h3 id="5-6-3-RuntimePermissionsPersistence-writePermissionsSync"><a href="#5-6-3-RuntimePermissionsPersistence-writePermissionsSync" class="headerlink" title="5.6.3 RuntimePermissionsPersistence.writePermissionsSync"></a>5.6.3 RuntimePermissionsPersistence.writePermissionsSync</h3><p>writePermissionsSync 会将上一次运行时权限的授予情况保存到文件中！<br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">writePermissionsSync</span><span class="params">(<span class="keyword">int</span> userId)</span> </span>&#123;</span><br><span class="line">    AtomicFile destination = <span class="keyword">new</span> AtomicFile(getUserRuntimePermissionsFile(userId));</span><br><span class="line">    <span class="comment">//【1】用于保存 package 和 SharedUser 运行时权限！</span></span><br><span class="line">    ArrayMap&lt;String, List&lt;PermissionState&gt;&gt; permissionsForPackage = <span class="keyword">new</span> ArrayMap&lt;&gt;();</span><br><span class="line">    ArrayMap&lt;String, List&lt;PermissionState&gt;&gt; permissionsForSharedUser = <span class="keyword">new</span> ArrayMap&lt;&gt;();</span><br><span class="line"></span><br><span class="line">    <span class="keyword">synchronized</span> (mLock) &#123;</span><br><span class="line">        mWriteScheduled.delete(userId);</span><br><span class="line">        <span class="comment">//【2】收集 package 运行时权限，保存到 permissionsForPackage！</span></span><br><span class="line">        <span class="keyword">final</span> <span class="keyword">int</span> packageCount = mPackages.size();</span><br><span class="line">        <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; packageCount; i++) &#123;</span><br><span class="line">            String packageName = mPackages.keyAt(i);</span><br><span class="line">            PackageSetting packageSetting = mPackages.valueAt(i);</span><br><span class="line">            <span class="keyword">if</span> (packageSetting.sharedUser == <span class="keyword">null</span>) &#123;</span><br><span class="line">                PermissionsState permissionsState = packageSetting.getPermissionsState();</span><br><span class="line">                List&lt;PermissionState&gt; permissionsStates = permissionsState</span><br><span class="line">                        .getRuntimePermissionStates(userId);</span><br><span class="line">                <span class="keyword">if</span> (!permissionsStates.isEmpty()) &#123;</span><br><span class="line">                    permissionsForPackage.put(packageName, permissionsStates);</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">//【3】收集 SharedUser 运行时权限，保存到 permissionsForSharedUser！</span></span><br><span class="line">        <span class="keyword">final</span> <span class="keyword">int</span> sharedUserCount = mSharedUsers.size();</span><br><span class="line">        <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; sharedUserCount; i++) &#123;</span><br><span class="line">            String sharedUserName = mSharedUsers.keyAt(i);</span><br><span class="line">            SharedUserSetting sharedUser = mSharedUsers.valueAt(i);</span><br><span class="line">            PermissionsState permissionsState = sharedUser.getPermissionsState();</span><br><span class="line">            List&lt;PermissionState&gt; permissionsStates = permissionsState</span><br><span class="line">                    .getRuntimePermissionStates(userId);</span><br><span class="line">            <span class="keyword">if</span> (!permissionsStates.isEmpty()) &#123;</span><br><span class="line">                permissionsForSharedUser.put(sharedUserName, permissionsStates);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    FileOutputStream out = <span class="keyword">null</span>;</span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">        out = destination.startWrite();</span><br><span class="line"></span><br><span class="line">        XmlSerializer serializer = Xml.newSerializer();</span><br><span class="line">        serializer.setOutput(out, StandardCharsets.UTF_8.name());</span><br><span class="line">        serializer.setFeature(</span><br><span class="line">                <span class="string">"http://xmlpull.org/v1/doc/features.html#indent-output"</span>, <span class="keyword">true</span>);</span><br><span class="line">        serializer.startDocument(<span class="keyword">null</span>, <span class="keyword">true</span>);</span><br><span class="line"></span><br><span class="line">        serializer.startTag(<span class="keyword">null</span>, TAG_RUNTIME_PERMISSIONS); <span class="comment">// 根标签 runtime-permissions！</span></span><br><span class="line"></span><br><span class="line">        String fingerprint = mFingerprints.get(userId);</span><br><span class="line">        <span class="keyword">if</span> (fingerprint != <span class="keyword">null</span>) &#123;</span><br><span class="line">            serializer.attribute(<span class="keyword">null</span>, ATTR_FINGERPRINT, fingerprint); <span class="comment">// 属性 fingerprint！</span></span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">// 写入 package 运行时权限！</span></span><br><span class="line">        <span class="keyword">final</span> <span class="keyword">int</span> packageCount = permissionsForPackage.size();</span><br><span class="line">        <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; packageCount; i++) &#123;</span><br><span class="line">            String packageName = permissionsForPackage.keyAt(i);</span><br><span class="line">            List&lt;PermissionState&gt; permissionStates = permissionsForPackage.valueAt(i);</span><br><span class="line">            serializer.startTag(<span class="keyword">null</span>, TAG_PACKAGE); <span class="comment">// pkg 标签</span></span><br><span class="line">            serializer.attribute(<span class="keyword">null</span>, ATTR_NAME, packageName); <span class="comment">// name 属性！</span></span><br><span class="line">            <span class="comment">//【4.6.3.1】写入运行时权限信息</span></span><br><span class="line">            writePermissions(serializer, permissionStates);</span><br><span class="line">            serializer.endTag(<span class="keyword">null</span>, TAG_PACKAGE);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 写入 SharedUser 运行时权限！</span></span><br><span class="line">        <span class="keyword">final</span> <span class="keyword">int</span> sharedUserCount = permissionsForSharedUser.size();</span><br><span class="line">        <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; sharedUserCount; i++) &#123;</span><br><span class="line">            String packageName = permissionsForSharedUser.keyAt(i);</span><br><span class="line">            List&lt;PermissionState&gt; permissionStates = permissionsForSharedUser.valueAt(i);</span><br><span class="line">            serializer.startTag(<span class="keyword">null</span>, TAG_SHARED_USER); <span class="comment">// shared-user 标签；</span></span><br><span class="line">            serializer.attribute(<span class="keyword">null</span>, ATTR_NAME, packageName); <span class="comment">// name 属性；</span></span><br><span class="line">            <span class="comment">//【4.6.3.1】写入运行时权限信息；</span></span><br><span class="line">            writePermissions(serializer, permissionStates);</span><br><span class="line">            serializer.endTag(<span class="keyword">null</span>, TAG_SHARED_USER);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        serializer.endTag(<span class="keyword">null</span>, TAG_RUNTIME_PERMISSIONS);</span><br><span class="line"></span><br><span class="line">        <span class="comment">// Now any restored permission grants that are waiting for the apps</span></span><br><span class="line">        <span class="comment">// in question to be installed.  These are stored as per-package</span></span><br><span class="line">        <span class="comment">// TAG_RESTORED_RUNTIME_PERMISSIONS blocks, each containing some</span></span><br><span class="line">        <span class="comment">// number of individual permission grant entities.</span></span><br><span class="line">        <span class="keyword">if</span> (mRestoredUserGrants.get(userId) != <span class="keyword">null</span>) &#123;</span><br><span class="line">            ArrayMap&lt;String, ArraySet&lt;RestoredPermissionGrant&gt;&gt; restoredGrants =</span><br><span class="line">                    mRestoredUserGrants.get(userId);</span><br><span class="line">            <span class="keyword">if</span> (restoredGrants != <span class="keyword">null</span>) &#123;</span><br><span class="line">                <span class="keyword">final</span> <span class="keyword">int</span> pkgCount = restoredGrants.size();</span><br><span class="line">                <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; pkgCount; i++) &#123;</span><br><span class="line">                    <span class="keyword">final</span> ArraySet&lt;RestoredPermissionGrant&gt; pkgGrants =</span><br><span class="line">                            restoredGrants.valueAt(i);</span><br><span class="line">                    <span class="keyword">if</span> (pkgGrants != <span class="keyword">null</span> &amp;&amp; pkgGrants.size() &gt; <span class="number">0</span>) &#123;</span><br><span class="line">                        <span class="keyword">final</span> String pkgName = restoredGrants.keyAt(i);</span><br><span class="line">                        serializer.startTag(<span class="keyword">null</span>, TAG_RESTORED_RUNTIME_PERMISSIONS); <span class="comment">// restored-perms 标签；</span></span><br><span class="line">                        serializer.attribute(<span class="keyword">null</span>, ATTR_PACKAGE_NAME, pkgName); <span class="comment">// packageName 属性；</span></span><br><span class="line"></span><br><span class="line">                        <span class="keyword">final</span> <span class="keyword">int</span> N = pkgGrants.size();</span><br><span class="line">                        <span class="keyword">for</span> (<span class="keyword">int</span> z = <span class="number">0</span>; z &lt; N; z++) &#123;</span><br><span class="line">                            RestoredPermissionGrant g = pkgGrants.valueAt(z);</span><br><span class="line">                            serializer.startTag(<span class="keyword">null</span>, TAG_PERMISSION_ENTRY); <span class="comment">// perm 标签；</span></span><br><span class="line">                            serializer.attribute(<span class="keyword">null</span>, ATTR_NAME, g.permissionName); <span class="comment">// name 属性；</span></span><br><span class="line"></span><br><span class="line">                            <span class="keyword">if</span> (g.granted) &#123;</span><br><span class="line">                                serializer.attribute(<span class="keyword">null</span>, ATTR_GRANTED, <span class="string">"true"</span>); <span class="comment">//  granted 属性</span></span><br><span class="line">                            &#125;</span><br><span class="line"></span><br><span class="line">                            <span class="keyword">if</span> ((g.grantBits&amp;FLAG_PERMISSION_USER_SET) != <span class="number">0</span>) &#123; <span class="comment">//  set 属性</span></span><br><span class="line">                                serializer.attribute(<span class="keyword">null</span>, ATTR_USER_SET, <span class="string">"true"</span>);</span><br><span class="line">                            &#125;</span><br><span class="line">                            <span class="keyword">if</span> ((g.grantBits&amp;FLAG_PERMISSION_USER_FIXED) != <span class="number">0</span>) &#123; <span class="comment">//  fixed 属性</span></span><br><span class="line">                                serializer.attribute(<span class="keyword">null</span>, ATTR_USER_FIXED, <span class="string">"true"</span>);</span><br><span class="line">                            &#125;</span><br><span class="line">                            <span class="keyword">if</span> ((g.grantBits&amp;FLAG_PERMISSION_REVOKE_ON_UPGRADE) != <span class="number">0</span>) &#123; <span class="comment">//  rou 属性</span></span><br><span class="line">                                serializer.attribute(<span class="keyword">null</span>, ATTR_REVOKE_ON_UPGRADE, <span class="string">"true"</span>);</span><br><span class="line">                            &#125;</span><br><span class="line">                            serializer.endTag(<span class="keyword">null</span>, TAG_PERMISSION_ENTRY);</span><br><span class="line">                        &#125;</span><br><span class="line">                        serializer.endTag(<span class="keyword">null</span>, TAG_RESTORED_RUNTIME_PERMISSIONS);</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        serializer.endDocument();</span><br><span class="line">        destination.finishWrite(out);</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (Build.FINGERPRINT.equals(fingerprint)) &#123; <span class="comment">// 如果</span></span><br><span class="line">            mDefaultPermissionsGranted.put(userId, <span class="keyword">true</span>);</span><br><span class="line">        &#125;</span><br><span class="line">    <span class="comment">// Any error while writing is fatal.</span></span><br><span class="line">    &#125; <span class="keyword">catch</span> (Throwable t) &#123;</span><br><span class="line">        Slog.wtf(PackageManagerService.TAG,</span><br><span class="line">                <span class="string">"Failed to write settings, restoring backup"</span>, t);</span><br><span class="line">        destination.failWrite(out);</span><br><span class="line">    &#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">        IoUtils.closeQuietly(out);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<h4 id="5-6-3-1-RuntimePermissionsPersistence-writePermissions"><a href="#5-6-3-1-RuntimePermissionsPersistence-writePermissions" class="headerlink" title="5.6.3.1 RuntimePermissionsPersistence.writePermissions"></a>5.6.3.1 RuntimePermissionsPersistence.writePermissions</h4><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">writePermissions</span><span class="params">(XmlSerializer serializer,</span></span></span><br><span class="line"><span class="function"><span class="params">        List&lt;PermissionState&gt; permissionStates)</span> <span class="keyword">throws</span> IOException </span>&#123;</span><br><span class="line">    <span class="keyword">for</span> (PermissionState permissionState : permissionStates) &#123;</span><br><span class="line">        serializer.startTag(<span class="keyword">null</span>, TAG_ITEM); <span class="comment">// item 标签</span></span><br><span class="line">        serializer.attribute(<span class="keyword">null</span>, ATTR_NAME,permissionState.getName()); <span class="comment">// name 属性</span></span><br><span class="line">        serializer.attribute(<span class="keyword">null</span>, ATTR_GRANTED,</span><br><span class="line">                String.valueOf(permissionState.isGranted())); <span class="comment">// graned 属性</span></span><br><span class="line">        serializer.attribute(<span class="keyword">null</span>, ATTR_FLAGS,</span><br><span class="line">                Integer.toHexString(permissionState.getFlags())); <span class="comment">// flags 属性</span></span><br><span class="line">        serializer.endTag(<span class="keyword">null</span>, TAG_ITEM);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>这里就不多说了！</p>
</div></article><div class="post-copyright"><div class="post-copyright__author"><span class="post-copyright-meta">文章作者: </span><span class="post-copyright-info"><a href="mailto:undefined">Coolqi.Li</a></span></div><div class="post-copyright__type"><span class="post-copyright-meta">文章链接: </span><span class="post-copyright-info"><a href="https://coolqi.top/2018/03/03/PMS5-PMS_SCAN_END/">https://coolqi.top/2018/03/03/PMS5-PMS_SCAN_END/</a></span></div><div class="post-copyright__notice"><span class="post-copyright-meta">版权声明: </span><span class="post-copyright-info">本博客所有文章除特别声明外，均采用 <a href="https://creativecommons.org/licenses/by-nc-sa/4.0/">CC BY-NC-SA 4.0</a> 许可协议。转载请注明来自 <a href="https://coolqi.top">Coolqi`s Blog</a>！</span></div></div><div class="post-meta__tag-list"><a class="post-meta__tags" href="/tags/PackageManager包管理/">PackageManager包管理</a></div><div class="post-qr-code"><div class="post-qr-code-item"><img class="post-qr-code__img" src="/img/zfb.jpg"><div class="post-qr-code__desc">支付宝打赏</div></div><div class="post-qr-code-item"><img class="post-qr-code__img" src="/img/wechat.jpg"><div class="post-qr-code__desc">微信打赏</div></div></div><div class="social-share"></div><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/social-share.js@1.0.16/dist/css/share.min.css"><script src="https://cdn.jsdelivr.net/npm/social-share.js@1.0.16/dist/js/social-share.min.js"></script><nav id="pagination"><div class="prev-post pull-left"><a href="/2018/04/13/ContentProvider2-contentProviderStartProcess/"><i class="fa fa-chevron-left">  </i><span>ContentProvider篇  2 - ContentProvider 的启动</span></a></div><div class="next-post pull-right"><a href="/2018/02/17/PMS4-PMS_DATA_SCAN_START/"><span>PMS 第 4 篇 - PMS_DATA_SCAN_START 阶段</span><i class="fa fa-chevron-right"></i></a></div></nav><div class="post-adv"><a href="https://www.vultr.com/?ref=7231808"><img src="https://www.vultr.com/media/banner_1.png" width="728" height="90"></a></div><div id="lv-container" data-id="city" data-uid="MTAyMC80NTc0My8yMjI1NA=="><script>(function(d, s) {
    var j, e = d.getElementsByTagName(s)[0];
    if (typeof LivereTower === 'function') { return; }
    j = d.createElement(s);
    j.src = 'https://cdn-city.livere.com/js/embed.dist.js';
    j.async = true;
    e.parentNode.insertBefore(j, e);
})(document, 'script');</script></div></div></div><footer><div class="layout" id="footer"><div class="copyright">&copy;2015 - 2019 By Coolqi.Li</div><div class="framework-info"><span>驱动 - </span><a href="http://hexo.io"><span>Hexo</span></a><span class="footer-separator">|</span><span>主题 - </span><a href="https://github.com/Molunerfinn/hexo-theme-melody"><span>Melody</span></a></div><div class="footer_custom_text">Hi, welcome to my <a href="https://coolqi.top/">blog</a>!</div><div class="busuanzi"><script async src="https://busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script><span id="busuanzi_container_page_pv"><i class="fa fa-file-o"></i><span id="busuanzi_value_page_pv"></span><span></span></span></div></div></footer><i class="fa fa-arrow-up" id="go-up" aria-hidden="true"></i><script src="/js/third-party/anime.min.js"></script><script src="/js/third-party/jquery.min.js"></script><script src="/js/third-party/jquery.fancybox.min.js"></script><script src="/js/third-party/velocity.min.js"></script><script src="/js/third-party/velocity.ui.min.js"></script><script src="/js/utils.js?version=1.5.6"></script><script src="/js/fancybox.js?version=1.5.6"></script><script src="/js/sidebar.js?version=1.5.6"></script><script src="/js/copy.js?version=1.5.6"></script><script src="/js/fireworks.js?version=1.5.6"></script><script src="/js/transition.js?version=1.5.6"></script><script src="/js/scroll.js?version=1.5.6"></script><script src="/js/head.js?version=1.5.6"></script><script type="text/x-mathjax-config">MathJax.Hub.Config({
  tex2jax: {
    inlineMath: [ ['$','$'], ["\\(","\\)"]  ],
    processEscapes: true,
    skipTags: ['script', 'noscript', 'style', 'textarea', 'pre', 'code']
  },
  CommonHTML: {
    linebreaks: { automatic: true, width: "90% container" }
  },
  "HTML-CSS": { 
    linebreaks: { automatic: true, width: "90% container" }
  },
  "SVG": { 
    linebreaks: { automatic: true, width: "90% container" }
  }
});
</script><script type="text/x-mathjax-config">MathJax.Hub.Queue(function() {
  var all = MathJax.Hub.getAllJax(), i;
  for (i=0; i < all.length; i += 1) {
    all[i].SourceElement().parentNode.className += ' has-jax';
  }
});
</script><script src="https://cdn.jsdelivr.net/npm/mathjax/MathJax.js?config=TeX-AMS-MML_HTMLorMML"></script><script src="/js/search/local-search.js"></script><div class="search-dialog" id="local-search"><div class="search-dialog__title" id="local-search-title">本地搜索</div><div id="local-input-panel"><div id="local-search-input"><div class="local-search-box"><input class="local-search-box--input" placeholder="搜索文章"></div></div></div><hr><div id="local-search-results"><div id="local-hits"></div><div id="local-stats"><div class="local-search-stats__hr" id="hr"><span>由</span> <a href="https://github.com/wzpan/hexo-generator-search" style="color:#49B1F5;">hexo-generator-search</a>
 <span>提供支持</span></div></div></div><span class="search-close-button"><i class="fa fa-times"></i></span></div><div class="search-mask"></div><script src="/live2dw/lib/L2Dwidget.min.js?0c58a1486de42ac6cc1c59c7d98ae887"></script><script>L2Dwidget.init({"pluginRootPath":"live2dw/","pluginJsPath":"lib/","pluginModelPath":"assets/","tagMode":false,"debug":false,"model":{"jsonPath":"live2d-widget-model-hijiki"},"display":{"position":"right","width":110,"height":220},"mobile":{"show":false},"log":false});</script></body></html>
<!DOCTYPE html><html lang="zh-Hans"><head><meta name="generator" content="Hexo 3.9.0"><meta charset="UTF-8"><meta http-equiv="X-UA-Compatible" content="IE=edge"><meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1"><meta name="description" content="ViewDraw 第一篇 setContentView 流程分析"><meta name="keywords" content="ViewDraw"><meta name="author" content="Coolqi.Li"><meta name="copyright" content="Coolqi.Li"><title>ViewDraw 第一篇 setContentView 流程分析 | Coolqi`s Blog</title><link rel="shortcut icon" href="/img/favicon.ico"><link rel="stylesheet" href="/css/index.css?version=1.7.0"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/font-awesome@4.7.0/css/font-awesome.min.css?version=1.7.0"><meta name="format-detection" content="telephone=no"><meta http-equiv="x-dns-prefetch-control" content="on"><link rel="dns-prefetch" href="https://cdn.jsdelivr.net"><script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script><script>(adsbygoogle = window.adsbygoogle || []).push({
  google_ad_client: 'ca-pub-6845729157331145',
  enable_page_level_ads: 'true'
});
</script><link rel="dns-prefetch" href="https://hm.baidu.com"><script>var _hmt = _hmt || [];
(function() {
  var hm = document.createElement("script");
  hm.src = "https://hm.baidu.com/hm.js?b7acef5306e54116ad8a99e8b753a92d";
  var s = document.getElementsByTagName("script")[0]; 
  s.parentNode.insertBefore(hm, s);
})();</script><script>var GLOBAL_CONFIG = { 
  root: '/',
  algolia: undefined,
  localSearch: {"path":"search.xml","languages":{"hits_empty":"找不到您查询的内容:${query}"}},
  copy: {
    success: '复制成功',
    error: '复制错误',
    noSupport: '浏览器不支持'
  }
} </script></head><body><i class="fa fa-arrow-right" id="toggle-sidebar" aria-hidden="true"></i><div id="sidebar" data-display="true"><div class="toggle-sidebar-info text-center"><span data-toggle="切换文章详情">切换站点概览</span><hr></div><div class="sidebar-toc"><div class="sidebar-toc__title">目录</div><div class="sidebar-toc__progress"><span class="progress-notice">你已经读了</span><span class="progress-num">0</span><span class="progress-percentage">%</span><div class="sidebar-toc__progress-bar"></div></div><div class="sidebar-toc__content"><ol class="toc"><li class="toc-item toc-level-1"><a class="toc-link" href="#1-概述"><span class="toc-text">1 概述</span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#2-启动流程回顾"><span class="toc-text">2 启动流程回顾</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#2-1-ActivityThread"><span class="toc-text">2.1 ActivityThread</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#2-1-1-handleLaunchActivity"><span class="toc-text">2.1.1 handleLaunchActivity</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#2-1-2-performLaunchActivity"><span class="toc-text">2.1.2 performLaunchActivity</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#2-2-Activity"><span class="toc-text">2.2 Activity</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#2-2-1-attach-核心方法"><span class="toc-text">2.2.1 attach - 核心方法</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#2-3-PhoneWindow"><span class="toc-text">2.3 PhoneWindow</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#2-3-1-new-PhoneWindow"><span class="toc-text">2.3.1 new PhoneWindow</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#2-4-Window"><span class="toc-text">2.4 Window</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#2-4-1-setWindowManager"><span class="toc-text">2.4.1 setWindowManager</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#2-5-WindowManagerImpl"><span class="toc-text">2.5 WindowManagerImpl</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#2-6-类图总结"><span class="toc-text">2.6 类图总结</span></a></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#3-Activity"><span class="toc-text">3 Activity</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#3-1-setContentView"><span class="toc-text">3.1 setContentView</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#3-2-getWindow"><span class="toc-text">3.2 getWindow</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#3-3-onWindowAttributesChanged"><span class="toc-text">3.3 onWindowAttributesChanged</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#3-4-initWindowDecorActionBar"><span class="toc-text">3.4 initWindowDecorActionBar</span></a></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#4-PhoneWindow"><span class="toc-text">4 PhoneWindow</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#4-1-setContentView"><span class="toc-text">4.1 setContentView</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#4-2-installDecor"><span class="toc-text">4.2 installDecor</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#4-2-1-generateDecor"><span class="toc-text">4.2.1 generateDecor</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#4-2-2-generateLayout"><span class="toc-text">4.2.2 generateLayout</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#4-2-2-1-requestFeature"><span class="toc-text">4.2.2.1 requestFeature</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#4-2-2-2-Root-布局分析"><span class="toc-text">4.2.2.2 Root 布局分析</span></a><ol class="toc-child"><li class="toc-item toc-level-5"><a class="toc-link" href="#4-2-2-2-1-默认布局（不使用-feature）"><span class="toc-text">4.2.2.2.1 默认布局（不使用 feature）</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#4-2-2-2-2-支持滑动退出的布局"><span class="toc-text">4.2.2.2.2 支持滑动退出的布局</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#4-2-2-2-3-只有一个进度条的布局"><span class="toc-text">4.2.2.2.3 只有一个进度条的布局</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#4-2-2-2-4-总结"><span class="toc-text">4.2.2.2.4 总结</span></a></li></ol></li></ol></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#4-2-dispatchWindowAttributesChanged"><span class="toc-text">4.2 dispatchWindowAttributesChanged</span></a></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#5-Window"><span class="toc-text">5 Window</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#5-1-new-Window"><span class="toc-text">5.1 new Window</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#5-1-1-内部接口"><span class="toc-text">5.1.1 内部接口</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#5-1-1-1-Callback"><span class="toc-text">5.1.1.1 Callback</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#5-1-1-2-WindowControllerCallback"><span class="toc-text">5.1.1.2 WindowControllerCallback</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#5-1-1-3-OnWindowDismissedCallback"><span class="toc-text">5.1.1.3 OnWindowDismissedCallback</span></a></li></ol></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#5-2-设置-window-回调"><span class="toc-text">5.2 设置 window 回调</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#5-2-1-setCallback"><span class="toc-text">5.2.1 setCallback</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#5-2-2-setWindowControllerCallback"><span class="toc-text">5.2.2 setWindowControllerCallback</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#5-2-3-setOnWindowDismissedCallback"><span class="toc-text">5.2.3 setOnWindowDismissedCallback</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#5-3-getAttributes"><span class="toc-text">5.3 getAttributes</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#5-4-setLayout"><span class="toc-text">5.4 setLayout</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#5-5-setFlags"><span class="toc-text">5.5 setFlags</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#5-6-dispatchWindowAttributesChanged"><span class="toc-text">5.6 dispatchWindowAttributesChanged</span></a></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#6-DecorView"><span class="toc-text">6 DecorView</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#6-1-new-DecorView"><span class="toc-text">6.1 new DecorView</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#6-2-setWindow"><span class="toc-text">6.2 setWindow</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#6-3-startChanging-finishChanging"><span class="toc-text">6.3 startChanging / finishChanging</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#6-4-onResourcesLoaded"><span class="toc-text">6.4 onResourcesLoaded</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#6-5-setWindowBackground-setWindowFrame"><span class="toc-text">6.5 setWindowBackground / setWindowFrame</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#6-6-drawableChanged"><span class="toc-text">6.6 drawableChanged</span></a></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#7-总结"><span class="toc-text">7 总结</span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#8-拓展分析"><span class="toc-text">8 拓展分析</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#8-1-requestFeature"><span class="toc-text">8.1 requestFeature</span></a></li></ol></li></ol></div></div><div class="author-info hide"><div class="author-info__avatar text-center"><img src="/img/avatar.jpg"></div><div class="author-info__name text-center">Coolqi.Li</div><div class="author-info__description text-center">“Hi，我是李帅奇，Android 开发工程师，TeamLeader，熬夜星人，一个努力赚钱，积极向上的好人。”</div><div class="follow-button"><a href="https://github.com/single-li">Follow Me</a></div><hr><div class="author-info-articles"><a class="author-info-articles__archives article-meta" href="/archives"><span class="pull-left">文章</span><span class="pull-right">86</span></a><a class="author-info-articles__tags article-meta" href="/tags"><span class="pull-left">标签</span><span class="pull-right">21</span></a><a class="author-info-articles__categories article-meta" href="/categories"><span class="pull-left">分类</span><span class="pull-right">26</span></a></div><hr><div class="author-info-links"><div class="author-info-links__title text-center">Links</div><a class="author-info-links__name text-center" href="https://developer.android.google.cn/">AndroidDeveloper</a><a class="author-info-links__name text-center" href="http://www.android-studio.org/">AndroidStudio</a><a class="author-info-links__name text-center" href="https://www.jianshu.com/u/123a20a96441">简书</a><a class="author-info-links__name text-center" href="https://weibo.com/coolqiLi">微博</a></div></div></div><div id="content-outer"><div id="top-container" style="background-image: url(/img/blog-bg.jpg)"><div id="page-header"><span class="pull-left"> <a id="site-name" href="/">Coolqi`s Blog</a></span><i class="fa fa-bars toggle-menu pull-right" aria-hidden="true"></i><span class="pull-right menus">   <a class="site-page" href="/">Home</a><a class="site-page" href="/categories">Categories</a><a class="site-page" href="/tags">Tags</a><a class="site-page" href="/archives">Archives</a><a class="site-page" href="/about">About</a></span><span class="pull-right"><a class="site-page social-icon search"><i class="fa fa-search"></i><span> 搜索</span></a></span></div><div id="post-info"><div id="post-title">ViewDraw 第一篇 setContentView 流程分析</div><div id="post-meta"><time class="post-meta__date"><i class="fa fa-calendar" aria-hidden="true"></i> 2018-06-01</time><span class="post-meta__separator">|</span><i class="fa fa-inbox post-meta__icon" aria-hidden="true"></i><a class="post-meta__categories" href="/categories/View-视图/">View 视图</a><i class="fa fa-angle-right" aria-hidden="true"></i><i class="fa fa-inbox post-meta__icon" aria-hidden="true"></i><a class="post-meta__categories" href="/categories/View-视图/View-的加载和绘制/">View 的加载和绘制</a><div class="post-meta-wordcount"><span>字数总计: </span><span class="word-count">9.2k</span><span class="post-meta__separator">|</span><span>阅读时长: 43 分钟</span></div></div></div></div><div class="layout" id="content-inner"><article id="post"><div class="article-container" id="post-content"><p>本篇文章基于 Android N（7.1.1）主要分析下 View 的加载 setContentView 的流程，以对 View 架构有更好的理解。</p>
<h1 id="1-概述"><a href="#1-概述" class="headerlink" title="1 概述"></a>1 概述</h1><p>setContentView 这个方法用于设置视图布局文件，在 Activity 的 onCreate 方法中，我们会通过该方法传入一个资源 id：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">SplashActivity</span> <span class="keyword">extends</span> <span class="title">AppCompatActivity</span> </span>&#123;</span><br><span class="line">    <span class="keyword">private</span> SplashHandler mSplashHandler;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">boolean</span> sendMsg = <span class="keyword">true</span>; <span class="comment">// 避免重复进入handleMessage处理逻辑</span></span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title">onCreate</span><span class="params">(@Nullable Bundle savedInstanceState)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">super</span>.onCreate(savedInstanceState);</span><br><span class="line">        <span class="comment">//【--&gt;2.1】核心方法，设置布局；</span></span><br><span class="line">        setContentView(R.layout.splash_layout);</span><br><span class="line">    &#125;</span><br><span class="line">  </span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>下面我们来一起跟踪下 setContentView 的流程!</p>
<h1 id="2-启动流程回顾"><a href="#2-启动流程回顾" class="headerlink" title="2 启动流程回顾"></a>2 启动流程回顾</h1><p>我们在之前分析 activity 启动的时候，应用进程的核心逻辑是在 ActivityThread 中，我们来去回顾下核心的代码：</p>
<h2 id="2-1-ActivityThread"><a href="#2-1-ActivityThread" class="headerlink" title="2.1 ActivityThread"></a>2.1 ActivityThread</h2><h3 id="2-1-1-handleLaunchActivity"><a href="#2-1-1-handleLaunchActivity" class="headerlink" title="2.1.1 handleLaunchActivity"></a>2.1.1 handleLaunchActivity</h3><p>这个方法是在主线程的 H 中调用的，H 会收到来自 Stub 的  LAUNCH_ACTIVITY 的消息：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">switch</span> (msg.what) &#123;</span><br><span class="line">  <span class="keyword">case</span> LAUNCH_ACTIVITY: &#123;</span><br><span class="line">    Trace.traceBegin(Trace.TRACE_TAG_ACTIVITY_MANAGER, <span class="string">"activityStart"</span>);</span><br><span class="line">    <span class="comment">//【1】获取到传递的 ActivityClientRecord 实例；</span></span><br><span class="line">    <span class="keyword">final</span> ActivityClientRecord r = (ActivityClientRecord) msg.obj;</span><br><span class="line"></span><br><span class="line">    r.packageInfo = getPackageInfoNoCheck(</span><br><span class="line">      r.activityInfo.applicationInfo, r.compatInfo);</span><br><span class="line">    <span class="comment">//【2】调用 handleLaunchActivity 方法；</span></span><br><span class="line">    handleLaunchActivity(r, <span class="keyword">null</span>, <span class="string">"LAUNCH_ACTIVITY"</span>);</span><br><span class="line">    Trace.traceEnd(Trace.TRACE_TAG_ACTIVITY_MANAGER);</span><br><span class="line">  &#125; <span class="keyword">break</span>;</span><br></pre></td></tr></table></figure>
<p>我们接着看：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">handleLaunchActivity</span><span class="params">(ActivityClientRecord r, Intent customIntent)</span> </span>&#123;</span><br><span class="line">    ... ... ...</span><br><span class="line"></span><br><span class="line">    <span class="comment">//【1】初始化 WindowManagerGlobal 实例；</span></span><br><span class="line">    WindowManagerGlobal.initialize();</span><br><span class="line">    <span class="comment">//【--&gt;2.1.2】调用另外一个方法;</span></span><br><span class="line">    Activity a = performLaunchActivity(r, customIntent);</span><br><span class="line">    	</span><br><span class="line">    ... ... ...</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<ul>
<li>当 ActivityManagerService 接收到启动 Activity 的请求之后会通过 binder 跨进程通信，通知 activity 所在进程的 ApplicationThread 对象，然后执行：handleLauncherActivity方法；</li>
<li>会初始化一个 <strong>WindowManagerGlobal 实例</strong>；</li>
<li>调用 <strong>performLaunchActivity 方法</strong>；</li>
</ul>
<h3 id="2-1-2-performLaunchActivity"><a href="#2-1-2-performLaunchActivity" class="headerlink" title="2.1.2 performLaunchActivity"></a>2.1.2 performLaunchActivity</h3><p>继续看：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">private</span> Activity <span class="title">performLaunchActivity</span><span class="params">(ActivityClientRecord r, Intent customIntent)</span> </span>&#123;</span><br><span class="line">    <span class="comment">// System.out.println("##### [" + System.currentTimeMillis() + </span></span><br><span class="line">    <span class="comment">// "] ActivityThread.performLaunchActivity(" + r + ")");</span></span><br><span class="line">    ... ... ...</span><br><span class="line"></span><br><span class="line">    Activity activity = <span class="keyword">null</span>;</span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">        <span class="comment">//【1】通过反射来创建 Activity 实例；</span></span><br><span class="line">        java.lang.ClassLoader cl = r.packageInfo.getClassLoader();</span><br><span class="line">        activity = mInstrumentation.newActivity(</span><br><span class="line">                cl, component.getClassName(), r.intent);</span><br><span class="line">        StrictMode.incrementExpectedActivityCount(activity.getClass());</span><br><span class="line">        r.intent.setExtrasClassLoader(cl);</span><br><span class="line">        r.intent.prepareToEnterProcess();</span><br><span class="line">        <span class="keyword">if</span> (r.state != <span class="keyword">null</span>) &#123;</span><br><span class="line">            r.state.setClassLoader(cl);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">        <span class="keyword">if</span> (!mInstrumentation.onException(activity, e)) &#123;</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> RuntimeException(</span><br><span class="line">                <span class="string">"Unable to instantiate activity "</span> + component</span><br><span class="line">                + <span class="string">": "</span> + e.toString(), e);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">        Application app = r.packageInfo.makeApplication(<span class="keyword">false</span>, mInstrumentation);</span><br><span class="line"></span><br><span class="line">        ... ... ...</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (activity != <span class="keyword">null</span>) &#123;</span><br><span class="line">            Context appContext = createBaseContextForActivity(r, activity);</span><br><span class="line">            CharSequence title = r.activityInfo.loadLabel(appContext.getPackageManager());</span><br><span class="line">            Configuration config = <span class="keyword">new</span> Configuration(mCompatConfiguration);</span><br><span class="line">            <span class="keyword">if</span> (r.overrideConfig != <span class="keyword">null</span>) &#123;</span><br><span class="line">                config.updateFrom(r.overrideConfig);</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">if</span> (DEBUG_CONFIGURATION) Slog.v(TAG, <span class="string">"Launching activity "</span></span><br><span class="line">                    + r.activityInfo.name + <span class="string">" with config "</span> + config);</span><br><span class="line">   </span><br><span class="line">            <span class="comment">//【1】尝试复用上一次的的 window 实例；</span></span><br><span class="line">            Window window = <span class="keyword">null</span>;</span><br><span class="line">            <span class="keyword">if</span> (r.mPendingRemoveWindow != <span class="keyword">null</span> &amp;&amp; r.mPreserveWindow) &#123;</span><br><span class="line">                window = r.mPendingRemoveWindow;</span><br><span class="line">                r.mPendingRemoveWindow = <span class="keyword">null</span>;</span><br><span class="line">                r.mPendingRemoveWindowManager = <span class="keyword">null</span>;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="comment">//【--&gt;2.2.1】执行 attach 绑定操作；</span></span><br><span class="line">            activity.attach(appContext, <span class="keyword">this</span>, getInstrumentation(), r.token,</span><br><span class="line">                    r.ident, app, r.intent, r.activityInfo, title, r.parent,</span><br><span class="line">                    r.embeddedID, r.lastNonConfigurationInstances, config,</span><br><span class="line">                    r.referrer, r.voiceInteractor, window);</span><br><span class="line"></span><br><span class="line">            <span class="keyword">if</span> (customIntent != <span class="keyword">null</span>) &#123;</span><br><span class="line">                activity.mIntent = customIntent;</span><br><span class="line">            &#125;</span><br><span class="line">            r.lastNonConfigurationInstances = <span class="keyword">null</span>;</span><br><span class="line">            activity.mStartedActivity = <span class="keyword">false</span>;</span><br><span class="line">            <span class="keyword">int</span> theme = r.activityInfo.getThemeResource();</span><br><span class="line">            <span class="keyword">if</span> (theme != <span class="number">0</span>) &#123;</span><br><span class="line">                activity.setTheme(theme);</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="comment">//【--&gt;3.1】这个方法会调用 activity 的 onCreate 方法；</span></span><br><span class="line">            <span class="comment">// 然后调用 setContextView 方法；</span></span><br><span class="line">            activity.mCalled = <span class="keyword">false</span>;</span><br><span class="line">            <span class="keyword">if</span> (r.isPersistable()) &#123;</span><br><span class="line">                mInstrumentation.callActivityOnCreate(activity, r.state, r.persistentState);</span><br><span class="line">            &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                mInstrumentation.callActivityOnCreate(activity, r.state);</span><br><span class="line">            &#125;</span><br><span class="line">            ... ... ...</span><br><span class="line">        &#125;</span><br><span class="line">        r.paused = <span class="keyword">true</span>;</span><br><span class="line"></span><br><span class="line">        mActivities.put(r.token, r);</span><br><span class="line"></span><br><span class="line">    &#125; <span class="keyword">catch</span> (SuperNotCalledException e) &#123;</span><br><span class="line">        <span class="keyword">throw</span> e;</span><br><span class="line"></span><br><span class="line">    &#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">        <span class="keyword">if</span> (!mInstrumentation.onException(activity, e)) &#123;</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> RuntimeException(</span><br><span class="line">                <span class="string">"Unable to start activity "</span> + component</span><br><span class="line">                + <span class="string">": "</span> + e.toString(), e);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> activity;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<ul>
<li>反射来创建 <strong>Activity</strong> 实例；</li>
<li>执行 <strong>activity.attach</strong> 方法；</li>
<li>调用 <strong>onCreate</strong> 方法，在 <strong>onCreate</strong> 方法中，会调用 <strong>setContextView</strong> 方法；</li>
</ul>
<p>这里涉及到 ActivityClientRecord.token 这个是怎么来的呢，我们简单回顾下：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// ActivityStackSupervisor --&gt; realStartActivityLocked 方法中：</span></span><br><span class="line">app.thread.scheduleLaunchActivity(<span class="keyword">new</span> Intent(r.intent), r.appToken,</span><br><span class="line">          System.identityHashCode(r), r.info, <span class="keyword">new</span> Configuration(mService.mConfiguration),</span><br><span class="line">          <span class="keyword">new</span> Configuration(task.mOverrideConfig), r.compat, r.launchedFromPackage,</span><br><span class="line">          task.voiceInteractor, app.repProcState, r.icicle, r.persistentState, results,</span><br><span class="line">          newIntents, !andResume, mService.isNextTransitionForward(), profilerInfo);</span><br></pre></td></tr></table></figure>
<p>可以看到传入的是 <strong>ActivityRecord.appToken</strong>，我们来看一个简单的调用栈：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">ActivityManagerService.startActivity(IApplicationThread, ....)   </span><br><span class="line">  -&gt;ActivityManagerService.startActivityAsUser(IApplicationThread, ...)    </span><br><span class="line">      --&gt;ActivityStack.startActivityMayWait(IApplicationThread, ...)</span><br><span class="line">          --&gt;ActivityStack.startActivityLocked(IApplicationThread, ...)</span><br></pre></td></tr></table></figure>
<p>这里会创建 ActivityRecord 实例，内部会创建一个 token 实例：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">ActivityRecord(ActivityManagerService _service, ProcessRecord _caller, ...) &#123;</span><br><span class="line">    service = _service;</span><br><span class="line">    appToken = <span class="keyword">new</span> Token(<span class="keyword">this</span>, service);</span><br><span class="line">    ... ... ... ...</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>这个 token 是 ActivityRecord 的内部类，继承了 <strong>IApplicationToken.Stub</strong> 类：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">static</span> <span class="class"><span class="keyword">class</span> <span class="title">Token</span> <span class="keyword">extends</span> <span class="title">IApplicationToken</span>.<span class="title">Stub</span> </span>&#123;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> WeakReference&lt;ActivityRecord&gt; weakActivity;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> ActivityManagerService mService;</span><br><span class="line"></span><br><span class="line">    Token(ActivityRecord activity, ActivityManagerService service) &#123;</span><br><span class="line">        weakActivity = <span class="keyword">new</span> WeakReference&lt;&gt;(activity);</span><br><span class="line">        mService = service;</span><br><span class="line">    &#125;</span><br><span class="line">    ... ... ...</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>这个 Token 会传递进入应用进程，保存到应用进程，然后在 addView 的时候再传递进系统进程的。</p>
<h2 id="2-2-Activity"><a href="#2-2-Activity" class="headerlink" title="2.2 Activity"></a>2.2 Activity</h2><h3 id="2-2-1-attach-核心方法"><a href="#2-2-1-attach-核心方法" class="headerlink" title="2.2.1 attach - 核心方法"></a>2.2.1 attach - 核心方法</h3><p>关键核心代码在 <strong>attach</strong>：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">final</span> <span class="keyword">void</span> <span class="title">attach</span><span class="params">(Context context, ActivityThread aThread,</span></span></span><br><span class="line"><span class="function"><span class="params">        Instrumentation instr, IBinder token, <span class="keyword">int</span> ident,</span></span></span><br><span class="line"><span class="function"><span class="params">        Application application, Intent intent, ActivityInfo info,</span></span></span><br><span class="line"><span class="function"><span class="params">        CharSequence title, Activity parent, String id,</span></span></span><br><span class="line"><span class="function"><span class="params">        NonConfigurationInstances lastNonConfigurationInstances,</span></span></span><br><span class="line"><span class="function"><span class="params">        Configuration config, String referrer, IVoiceInteractor voiceInteractor)</span> </span>&#123;</span><br><span class="line">    attachBaseContext(context);</span><br><span class="line"></span><br><span class="line">    mFragments.attachHost(<span class="keyword">null</span> <span class="comment">/*parent*/</span>);</span><br><span class="line"></span><br><span class="line">    <span class="comment">//【--&gt;2.3.1】创建了 PhoneWindow 实例;</span></span><br><span class="line">    mWindow = <span class="keyword">new</span> PhoneWindow(<span class="keyword">this</span>, window);</span><br><span class="line">    <span class="comment">//【--&gt;5.3.x】并设置 activity 为 callback；</span></span><br><span class="line">    mWindow.setWindowControllerCallback(<span class="keyword">this</span>);</span><br><span class="line">    mWindow.setCallback(<span class="keyword">this</span>);</span><br><span class="line">    mWindow.setOnWindowDismissedCallback(<span class="keyword">this</span>);</span><br><span class="line">    <span class="keyword">if</span> (info.softInputMode != WindowManager.LayoutParams.SOFT_INPUT_STATE_UNSPECIFIED) &#123;</span><br><span class="line">        mWindow.setSoftInputMode(info.softInputMode);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// 紧接着，设置了 uiOptions（包含动画等属性）;</span></span><br><span class="line">    <span class="keyword">if</span> (info.uiOptions != <span class="number">0</span>) &#123;</span><br><span class="line">        mWindow.setUiOptions(info.uiOptions);</span><br><span class="line">    &#125;</span><br><span class="line">    mUiThread = Thread.currentThread();</span><br><span class="line"></span><br><span class="line">    mMainThread = aThread;</span><br><span class="line">    mInstrumentation = instr;</span><br><span class="line">    mToken = token; <span class="comment">// 令牌 token；</span></span><br><span class="line">    mIdent = ident;</span><br><span class="line"></span><br><span class="line">    ... ... ...</span><br><span class="line"></span><br><span class="line">    <span class="comment">//【--&gt;2.4.1】设置 wms 的代理对象到 PhoneWindow 中；</span></span><br><span class="line">    mWindow.setWindowManager(</span><br><span class="line">            (WindowManager)context.getSystemService(Context.WINDOW_SERVICE),</span><br><span class="line">            mToken, mComponent.flattenToString(),</span><br><span class="line">            (info.flags &amp; ActivityInfo.FLAG_HARDWARE_ACCELERATED) != <span class="number">0</span>);</span><br><span class="line">    <span class="keyword">if</span> (mParent != <span class="keyword">null</span>) &#123;</span><br><span class="line">        mWindow.setContainer(mParent.getWindow());</span><br><span class="line">    &#125;</span><br><span class="line"> </span><br><span class="line">    <span class="comment">//【1】获得 wms 代理的应用；</span></span><br><span class="line">    mWindowManager = mWindow.getWindowManager();</span><br><span class="line">    mCurrentConfig = config;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>整体流程比较清晰，这里的 mToken 是一个 Binder 引用：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">private</span> IBinder mToken;</span><br></pre></td></tr></table></figure>
<p>继续！</p>
<h2 id="2-3-PhoneWindow"><a href="#2-3-PhoneWindow" class="headerlink" title="2.3 PhoneWindow"></a>2.3 PhoneWindow</h2><p>PhoneWindow 继承了 Window 抽象类，他也是 window 类的唯一实现！</p>
<p>PhoneWindow 将 DecorView 作为 root view，这里的 DecorView 实际上是一个 FrameLayout！</p>
<p>每一个 activity 都会有一个 PhoneWindow，他是 Activity 和 View 交互的中间层！</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">PhoneWindow</span> <span class="keyword">extends</span> <span class="title">Window</span> <span class="keyword">implements</span> <span class="title">MenuBuilder</span>.<span class="title">Callback</span> </span>&#123;</span><br><span class="line">	... ... ...</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h3 id="2-3-1-new-PhoneWindow"><a href="#2-3-1-new-PhoneWindow" class="headerlink" title="2.3.1 new PhoneWindow"></a>2.3.1 new PhoneWindow</h3><p>创建一个 PhoneWindow 实例，同时创建 LayoutInflater 实例，其用于加载布局文件！</p>
<p>参数：Context context 是所属的 activity；</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 这个构造器用于创建 activity 对应的 window；</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="title">PhoneWindow</span><span class="params">(Context context, Window preservedWindow)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">this</span>(context);</span><br><span class="line">    <span class="comment">//【1】mUseDecorContext 默认是 false，只有创建 activity 对应的 window，才会使用 decor context；</span></span><br><span class="line">    <span class="comment">// 其他的 window 都是直接使用传入的 context；</span></span><br><span class="line">    mUseDecorContext = <span class="keyword">true</span>;</span><br><span class="line">    <span class="keyword">if</span> (preservedWindow != <span class="keyword">null</span>) &#123;</span><br><span class="line">        mDecor = (DecorView) preservedWindow.getDecorView();</span><br><span class="line">        mElevation = preservedWindow.getElevation();</span><br><span class="line">        mLoadElevation = <span class="keyword">false</span>;</span><br><span class="line">        mForceDecorInstall = <span class="keyword">true</span>;</span><br><span class="line">        <span class="comment">// If we're preserving window, carry over the app token from the preserved</span></span><br><span class="line">        <span class="comment">// window, as we'll be skipping the addView in handleResumeActivity(), and</span></span><br><span class="line">        <span class="comment">// the token will not be updated as for a new window.</span></span><br><span class="line">        getAttributes().token = preservedWindow.getAttributes().token;</span><br><span class="line">    &#125;</span><br><span class="line"> </span><br><span class="line">    </span><br><span class="line">    <span class="comment">// 和画中画模式相关，即使系统不支持画中画模式，用于也可以通过开发者选项强行开启；</span></span><br><span class="line">    <span class="keyword">boolean</span> forceResizable = Settings.Global.getInt(context.getContentResolver(),</span><br><span class="line">                                                    DEVELOPMENT_FORCE_RESIZABLE_ACTIVITIES, <span class="number">0</span>) != <span class="number">0</span>;</span><br><span class="line">    mSupportsPictureInPicture = forceResizable || context.getPackageManager().hasSystemFeature(</span><br><span class="line">        PackageManager.FEATURE_PICTURE_IN_PICTURE);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>其实 PhoneWindow 里面有很多的成员，这里我们先不关注，因为太多了。。。</p>
<h2 id="2-4-Window"><a href="#2-4-Window" class="headerlink" title="2.4 Window"></a>2.4 Window</h2><p>Window 是一个抽象类，它提供了一系列窗口的接口，比如：<strong>setContentView</strong>、<strong>findViewById </strong>等等，而其唯一实现类则是 <strong>PhoneWindow</strong>。</p>
<p>也就是说，其内部的一些抽象方法的最终实现，均是由 PhoneWindow。</p>
<h3 id="2-4-1-setWindowManager"><a href="#2-4-1-setWindowManager" class="headerlink" title="2.4.1 setWindowManager"></a>2.4.1 setWindowManager</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">setWindowManager</span><span class="params">(WindowManager wm, IBinder appToken, String appName)</span> </span>&#123;</span><br><span class="line">    <span class="comment">//【1】调用了另外一个构造器；</span></span><br><span class="line">    setWindowManager(wm, appToken, appName, <span class="keyword">false</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">setWindowManager</span><span class="params">(WindowManager wm, IBinder appToken, String appName,</span></span></span><br><span class="line"><span class="function"><span class="params">                             <span class="keyword">boolean</span> hardwareAccelerated)</span> </span>&#123;</span><br><span class="line">    <span class="comment">//【2】记录下了令牌 token；</span></span><br><span class="line">    mAppToken = appToken;</span><br><span class="line">    mAppName = appName;</span><br><span class="line">    mHardwareAccelerated = hardwareAccelerated</span><br><span class="line">        || SystemProperties.getBoolean(PROPERTY_HARDWARE_UI, <span class="keyword">false</span>);</span><br><span class="line">    <span class="keyword">if</span> (wm == <span class="keyword">null</span>) &#123;</span><br><span class="line">        <span class="comment">//【2】如果 wm 为 null，那就获取 wms 的代理对象；</span></span><br><span class="line">        wm = (WindowManager)mContext.getSystemService(Context.WINDOW_SERVICE);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">//【--&gt;2.5】创建 wmImpl 实例；</span></span><br><span class="line">    mWindowManager = ((WindowManagerImpl)wm).createLocalWindowManager(<span class="keyword">this</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h2 id="2-5-WindowManagerImpl"><a href="#2-5-WindowManagerImpl" class="headerlink" title="2.5 WindowManagerImpl"></a>2.5 WindowManagerImpl</h2><p>WindowManagerImpl 实现了 WindowManager 接口，是对 wms 的代理的一个包装类：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">private</span> <span class="title">WindowManagerImpl</span><span class="params">(Context context, Window parentWindow)</span> </span>&#123;</span><br><span class="line">    mContext = context;</span><br><span class="line">    mParentWindow = parentWindow;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 参数是 PhoneWindow；</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> WindowManagerImpl <span class="title">createLocalWindowManager</span><span class="params">(Window parentWindow)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">new</span> WindowManagerImpl(mContext, parentWindow);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>该类用于和 wms 进行通信！！</p>
<p>可以看到，createLocalWindowManager 方法传入的 parentWindow 就是我们的 PhoneWindow；</p>
<h2 id="2-6-类图总结"><a href="#2-6-类图总结" class="headerlink" title="2.6 类图总结"></a>2.6 类图总结</h2><p>我们来通过类图看看整个流程中，这几个伙伴之间的关系，也便于对整体有个把握，方便后续的分析：</p>
<p><img src="http://assets.processon.com/chart_image/5d9e8a78e4b0c55535ead4ac.png" alt></p>
<h1 id="3-Activity"><a href="#3-Activity" class="headerlink" title="3 Activity"></a>3 Activity</h1><p>下面，我们就来从 activity 入手：</p>
<h2 id="3-1-setContentView"><a href="#3-1-setContentView" class="headerlink" title="3.1 setContentView"></a>3.1 setContentView</h2><p>setContextView 有三个重载方法，但是本质上是一样的：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">setContentView</span><span class="params">(@LayoutRes <span class="keyword">int</span> layoutResID)</span> </span>&#123;</span><br><span class="line">    <span class="comment">//【--&gt;3.2】返回 PhoneWindow，</span></span><br><span class="line">    <span class="comment">//【--&gt;4.1】调用其 setContextView 方法；</span></span><br><span class="line">  	getWindow().setContentView(layoutResID);</span><br><span class="line">    <span class="comment">//【3.4】设置 actionBar</span></span><br><span class="line">  	initWindowDecorActionBar();</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 下面两个方法如出一辙，不再关注；</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">setContentView</span><span class="params">(View view)</span> </span>&#123;</span><br><span class="line">  	getWindow().setContentView(view);</span><br><span class="line"> 	 	initWindowDecorActionBar();</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">setContentView</span><span class="params">(View view, ViewGroup.LayoutParams params)</span> </span>&#123;</span><br><span class="line">  	getWindow().setContentView(view, params);</span><br><span class="line">  	initWindowDecorActionBar();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h2 id="3-2-getWindow"><a href="#3-2-getWindow" class="headerlink" title="3.2 getWindow"></a>3.2 getWindow</h2><p>这里的 getWindow 返回的是什么呢，就是 PhoneWindow</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> Window <span class="title">getWindow</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    <span class="comment">//【--&gt;4.1】就是前面创建的 PhoneWindow</span></span><br><span class="line">    <span class="keyword">return</span> mWindow;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h2 id="3-3-onWindowAttributesChanged"><a href="#3-3-onWindowAttributesChanged" class="headerlink" title="3.3 onWindowAttributesChanged"></a>3.3 onWindowAttributesChanged</h2><p>通知 activity 窗口的属性发生变化了！</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onWindowAttributesChanged</span><span class="params">(WindowManager.LayoutParams params)</span> </span>&#123;</span><br><span class="line">    <span class="comment">// Update window manager if: we have a view, that view is</span></span><br><span class="line">    <span class="comment">// attached to its parent (which will be a RootView), and</span></span><br><span class="line">    <span class="comment">// this activity is not embedded.</span></span><br><span class="line">    <span class="keyword">if</span> (mParent == <span class="keyword">null</span>) &#123;</span><br><span class="line">        View decor = mDecor;</span><br><span class="line">        <span class="keyword">if</span> (decor != <span class="keyword">null</span> &amp;&amp; decor.getParent() != <span class="keyword">null</span>) &#123;</span><br><span class="line">            <span class="comment">//【1】通知 wms 更新 view 布局；</span></span><br><span class="line">            getWindowManager().updateViewLayout(decor, params);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>这里我们先不继续分析；</p>
<h2 id="3-4-initWindowDecorActionBar"><a href="#3-4-initWindowDecorActionBar" class="headerlink" title="3.4 initWindowDecorActionBar"></a>3.4 initWindowDecorActionBar</h2><p>设置 actionbar：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">initWindowDecorActionBar</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    <span class="comment">//【1】获得 PhoneWindow 实例；</span></span><br><span class="line">    Window window = getWindow();</span><br><span class="line"></span><br><span class="line">    window.getDecorView();</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (isChild() || !window.hasFeature(Window.FEATURE_ACTION_BAR) || mActionBar != <span class="keyword">null</span>) &#123;</span><br><span class="line">        <span class="keyword">return</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//【2】设置 actionBar；</span></span><br><span class="line">    mActionBar = <span class="keyword">new</span> WindowDecorActionBar(<span class="keyword">this</span>);</span><br><span class="line">    mActionBar.setDefaultDisplayHomeAsUpEnabled(mEnableDefaultActionBarUp);</span><br><span class="line"></span><br><span class="line">    mWindow.setDefaultIcon(mActivityInfo.getIconResource());</span><br><span class="line">    mWindow.setDefaultLogo(mActivityInfo.getLogoResource());</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>这里有一个 isChild() ：判断一个 activity 是否嵌入到另一个 activity 中，如果是一个 chile activity，mParent 不为 null，一般哦们不用这种特性：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">Activity mParent;   </span><br><span class="line"></span><br><span class="line"><span class="comment">/** Is this activity embedded inside of another activity? */</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">final</span> <span class="keyword">boolean</span> <span class="title">isChild</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    <span class="keyword">return</span> mParent != <span class="keyword">null</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>就不多说了！</p>
<h1 id="4-PhoneWindow"><a href="#4-PhoneWindow" class="headerlink" title="4 PhoneWindow"></a>4 PhoneWindow</h1><p>下面的逻辑就进入了 PhoneWindow 中了；</p>
<h2 id="4-1-setContentView"><a href="#4-1-setContentView" class="headerlink" title="4.1 setContentView"></a>4.1 setContentView</h2><p>我们在 activity 中一般是通过传入 layoutResID 来设置布局的：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">setContentView</span><span class="params">(<span class="keyword">int</span> layoutResID)</span> </span>&#123;</span><br><span class="line">    <span class="comment">// Note: FEATURE_CONTENT_TRANSITIONS may be set in the process of installing the window</span></span><br><span class="line">    <span class="comment">// decor, when theme attributes and the like are crystalized. Do not check the feature</span></span><br><span class="line">    <span class="comment">// before this happens.</span></span><br><span class="line">    <span class="comment">//【1】第一次进入的 mContentParent 肯定是 null 的，所以进入了 installDecor 方法中；</span></span><br><span class="line">    <span class="keyword">if</span> (mContentParent == <span class="keyword">null</span>) &#123;</span><br><span class="line">        <span class="comment">//【--&gt;4.2】创建 DecorView！</span></span><br><span class="line">        installDecor();</span><br><span class="line">    &#125; <span class="keyword">else</span> <span class="keyword">if</span> (!hasFeature(FEATURE_CONTENT_TRANSITIONS)) &#123;</span><br><span class="line">        mContentParent.removeAllViews();</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">//【2】这里和场景动画 Scene 有关系，这里先不关注；</span></span><br><span class="line">    <span class="keyword">if</span> (hasFeature(FEATURE_CONTENT_TRANSITIONS)) &#123;</span><br><span class="line">        <span class="keyword">final</span> Scene newScene = Scene.getSceneForLayout(mContentParent, layoutResID,</span><br><span class="line">                getContext());</span><br><span class="line">        transitionTo(newScene);</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        <span class="comment">//【*important 3】加载我们设置的布局到 mContentParent；</span></span><br><span class="line">        <span class="comment">// 这里又会调用 ViewGroup.addView 方法，涛声依旧了；</span></span><br><span class="line">        <span class="comment">// requestLayout(); --&gt; invalidate(true); --&gt; addViewInner(... ...)</span></span><br><span class="line">        mLayoutInflater.inflate(layoutResID, mContentParent);</span><br><span class="line">    &#125;</span><br><span class="line">    mContentParent.requestApplyInsets();</span><br><span class="line">    <span class="keyword">final</span> Callback cb = getCallback();</span><br><span class="line">    <span class="keyword">if</span> (cb != <span class="keyword">null</span> &amp;&amp; !isDestroyed()) &#123;</span><br><span class="line">        cb.onContentChanged();</span><br><span class="line">    &#125;</span><br><span class="line">    mContentParentExplicitlySet = <span class="keyword">true</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>可以看到，在将 setContentView 设置的 布局 加载到 mContentParent 之前，还是设置了很多的工作的：installDecor！</p>
<p>这里的对于 mLayoutInflater.inflate 的加载机制，就先不分析了，后面单独开一帖；</p>
<p>当然，<strong>PhoneWindow</strong> 也有其他两个 <strong>serContentView</strong> 方法：</p>
<ul>
<li><strong>setContentView(View view)</strong></li>
</ul>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">setContentView</span><span class="params">(View view)</span> </span>&#123;</span><br><span class="line">    <span class="comment">//【1】调用另外一个 set 方法，第二个参数表示布局属性；</span></span><br><span class="line">    setContentView(view, <span class="keyword">new</span> ViewGroup.LayoutParams(MATCH_PARENT, MATCH_PARENT));</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<ul>
<li><strong>setContentView(View view, ViewGroup.LayoutParams params)</strong></li>
</ul>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">setContentView</span><span class="params">(View view, ViewGroup.LayoutParams params)</span> </span>&#123;</span><br><span class="line">    <span class="comment">// Note: ... ...</span></span><br><span class="line">    <span class="keyword">if</span> (mContentParent == <span class="keyword">null</span>) &#123;</span><br><span class="line">        <span class="comment">//【--&gt;4.2】创建 DecorView！！</span></span><br><span class="line">        installDecor();</span><br><span class="line">    &#125; <span class="keyword">else</span> <span class="keyword">if</span> (!hasFeature(FEATURE_CONTENT_TRANSITIONS)) &#123;</span><br><span class="line">        mContentParent.removeAllViews();</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">//【2】这里和场景动画 Scene 有关系，这里先不关注；</span></span><br><span class="line">    <span class="keyword">if</span> (hasFeature(FEATURE_CONTENT_TRANSITIONS)) &#123;</span><br><span class="line">        view.setLayoutParams(params);</span><br><span class="line">        <span class="keyword">final</span> Scene newScene = <span class="keyword">new</span> Scene(mContentParent, view);</span><br><span class="line">        transitionTo(newScene);</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        <span class="comment">//【3】加载布局文件到 mContentParent；</span></span><br><span class="line">        mContentParent.addView(view, params);</span><br><span class="line">    &#125;</span><br><span class="line">    mContentParent.requestApplyInsets();</span><br><span class="line">    <span class="keyword">final</span> Callback cb = getCallback();</span><br><span class="line">    <span class="keyword">if</span> (cb != <span class="keyword">null</span> &amp;&amp; !isDestroyed()) &#123;</span><br><span class="line">        cb.onContentChanged();</span><br><span class="line">    &#125;</span><br><span class="line">    mContentParentExplicitlySet = <span class="keyword">true</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>这里的 mContentParent 是一个 ViewGroup 实例，很简单不多说；</p>
<h2 id="4-2-installDecor"><a href="#4-2-installDecor" class="headerlink" title="4.2 installDecor"></a>4.2 installDecor</h2><p>创建 DecorView：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">installDecor</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    mForceDecorInstall = <span class="keyword">false</span>;</span><br><span class="line">    <span class="comment">//【1】第一次的话，mDecor 肯定是 null 的，那么这里就会创建 DecorView 实例；</span></span><br><span class="line">    <span class="keyword">if</span> (mDecor == <span class="keyword">null</span>) &#123;</span><br><span class="line">        <span class="comment">//【--&gt;4.2.1】通过 generateDecor 方法创建 DecorView，参数为 -1；</span></span><br><span class="line">        mDecor = generateDecor(-<span class="number">1</span>);</span><br><span class="line">        mDecor.setDescendantFocusability(ViewGroup.FOCUS_AFTER_DESCENDANTS);</span><br><span class="line">        mDecor.setIsRootNamespace(<span class="keyword">true</span>);</span><br><span class="line">        <span class="keyword">if</span> (!mInvalidatePanelMenuPosted &amp;&amp; mInvalidatePanelMenuFeatures != <span class="number">0</span>) &#123;</span><br><span class="line">            mDecor.postOnAnimation(mInvalidatePanelMenuRunnable);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        mDecor.setWindow(<span class="keyword">this</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">//【2】同样的第一次，mContentParent 为 null；</span></span><br><span class="line">    <span class="keyword">if</span> (mContentParent == <span class="keyword">null</span>) &#123;</span><br><span class="line">        <span class="comment">//【--&gt;4.2.2】加载 content root 布局，并返回 view 实例；</span></span><br><span class="line">        mContentParent = generateLayout(mDecor);</span><br><span class="line"></span><br><span class="line">        <span class="comment">// Set up decor part of UI to ignore fitsSystemWindows if appropriate.</span></span><br><span class="line">        mDecor.makeOptionalFitsSystemWindows();</span><br><span class="line"></span><br><span class="line">        <span class="comment">//【2.1】 R.id.decor_content_parent 对应的 view 是 root view；</span></span><br><span class="line">        <span class="comment">// 这里尝试将获取的 view 转为一个 DecorContentParent 实例，实际上 R.id.decor_content_parent 对应的</span></span><br><span class="line">        <span class="comment">// view 是 ActionBarOverlayLayout，其实现了 DecorContentParent 接口；</span></span><br><span class="line">        <span class="comment">// 根据 root 布局文件，有这个 view 的只有：screen_toolbar.xml / screen_action_bar.xml</span></span><br><span class="line">        <span class="keyword">final</span> DecorContentParent decorContentParent = (DecorContentParent) mDecor.findViewById(</span><br><span class="line">                R.id.decor_content_parent);</span><br><span class="line">        <span class="comment">//【2.2】针对不同的情况，做不同的处理；</span></span><br><span class="line">        <span class="keyword">if</span> (decorContentParent != <span class="keyword">null</span>) &#123;</span><br><span class="line">            <span class="comment">//【2.2.1】将其保存到 PhoneWindow.DecorContentParent</span></span><br><span class="line">            mDecorContentParent = decorContentParent;</span><br><span class="line">            <span class="comment">//【2.2.2】给 PhoneWindow.DecorContentParent 设置 window callback(就是 acitivty)</span></span><br><span class="line">            mDecorContentParent.setWindowCallback(getCallback());</span><br><span class="line">            <span class="keyword">if</span> (mDecorContentParent.getTitle() == <span class="keyword">null</span>) &#123;</span><br><span class="line">                <span class="comment">// 设置了 title</span></span><br><span class="line">                mDecorContentParent.setWindowTitle(mTitle);</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            <span class="keyword">final</span> <span class="keyword">int</span> localFeatures = getLocalFeatures();</span><br><span class="line">            <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; FEATURE_MAX; i++) &#123;</span><br><span class="line">                <span class="keyword">if</span> ((localFeatures &amp; (<span class="number">1</span> &lt;&lt; i)) != <span class="number">0</span>) &#123;</span><br><span class="line">                    mDecorContentParent.initFeature(i);</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            mDecorContentParent.setUiOptions(mUiOptions);</span><br><span class="line">            <span class="comment">// 设置 icon；</span></span><br><span class="line">            <span class="keyword">if</span> ((mResourcesSetFlags &amp; FLAG_RESOURCE_SET_ICON) != <span class="number">0</span> ||</span><br><span class="line">                    (mIconRes != <span class="number">0</span> &amp;&amp; !mDecorContentParent.hasIcon())) &#123;</span><br><span class="line">                mDecorContentParent.setIcon(mIconRes);</span><br><span class="line">            &#125; <span class="keyword">else</span> <span class="keyword">if</span> ((mResourcesSetFlags &amp; FLAG_RESOURCE_SET_ICON) == <span class="number">0</span> &amp;&amp;</span><br><span class="line">                    mIconRes == <span class="number">0</span> &amp;&amp; !mDecorContentParent.hasIcon()) &#123;</span><br><span class="line">                mDecorContentParent.setIcon(</span><br><span class="line">                        getContext().getPackageManager().getDefaultActivityIcon());</span><br><span class="line">                mResourcesSetFlags |= FLAG_RESOURCE_SET_ICON_FALLBACK;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">if</span> ((mResourcesSetFlags &amp; FLAG_RESOURCE_SET_LOGO) != <span class="number">0</span> ||</span><br><span class="line">                    (mLogoRes != <span class="number">0</span> &amp;&amp; !mDecorContentParent.hasLogo())) &#123;</span><br><span class="line">                mDecorContentParent.setLogo(mLogoRes);</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            <span class="comment">// ... 这里我们不过多关注；</span></span><br><span class="line">            PanelFeatureState st = getPanelState(FEATURE_OPTIONS_PANEL, <span class="keyword">false</span>);</span><br><span class="line">            <span class="keyword">if</span> (!isDestroyed() &amp;&amp; (st == <span class="keyword">null</span> || st.menu == <span class="keyword">null</span>) &amp;&amp; !mIsStartingWindow) &#123;</span><br><span class="line">                invalidatePanelMenu(FEATURE_ACTION_BAR);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            <span class="comment">//【2.2.3】如果没有 R.id.decor_content_parent，那么肯定是其他的 root view</span></span><br><span class="line">            <span class="comment">// 这里尝试获取 R.id.title/R.id.title_container 然后设置可见性，标题等；</span></span><br><span class="line">            mTitleView = (TextView) findViewById(R.id.title);</span><br><span class="line">            <span class="keyword">if</span> (mTitleView != <span class="keyword">null</span>) &#123;</span><br><span class="line">                <span class="keyword">if</span> ((getLocalFeatures() &amp; (<span class="number">1</span> &lt;&lt; FEATURE_NO_TITLE)) != <span class="number">0</span>) &#123;</span><br><span class="line">                    <span class="keyword">final</span> View titleContainer = findViewById(R.id.title_container);</span><br><span class="line">                    <span class="keyword">if</span> (titleContainer != <span class="keyword">null</span>) &#123;</span><br><span class="line">                        titleContainer.setVisibility(View.GONE);</span><br><span class="line">                    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                        mTitleView.setVisibility(View.GONE);</span><br><span class="line">                    &#125;</span><br><span class="line">                    mContentParent.setForeground(<span class="keyword">null</span>);</span><br><span class="line">                &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                    mTitleView.setText(mTitle);</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (mDecor.getBackground() == <span class="keyword">null</span> &amp;&amp; mBackgroundFallbackResource != <span class="number">0</span>) &#123;</span><br><span class="line">            mDecor.setBackgroundFallback(mBackgroundFallbackResource);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 下面这部分和场景动画有关系，不再我们这篇文章的范围之内，省略掉先；</span></span><br><span class="line">        <span class="keyword">if</span> (hasFeature(FEATURE_ACTIVITY_TRANSITIONS)) &#123;</span><br><span class="line">          ... ... ...</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>这里的 mDecor 和 mContentParent 分别是如下的类型：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 表示当前 window 的 top level 的视图 view！</span></span><br><span class="line"><span class="keyword">private</span> DecorView mDecor;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 这个表示的是 @android:id/content 对应的 view，我们设置的 view 会被 add 到里面；</span></span><br><span class="line">ViewGroup mContentParent;</span><br></pre></td></tr></table></figure>
<h3 id="4-2-1-generateDecor"><a href="#4-2-1-generateDecor" class="headerlink" title="4.2.1 generateDecor"></a>4.2.1 generateDecor</h3><p>创建 DecorView 实例：</p>
<ul>
<li>参数 int featureId：用于表示是是否一个 activity 类型的 window（-1 表示是 activity 类型的 window）</li>
</ul>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">protected</span> DecorView <span class="title">generateDecor</span><span class="params">(<span class="keyword">int</span> featureId)</span> </span>&#123;</span><br><span class="line">    <span class="comment">// System process doesn't have application context and in that case we need to directly use</span></span><br><span class="line">    <span class="comment">// the context we have. Otherwise we want the application context, so we don't cling to the</span></span><br><span class="line">    <span class="comment">// activity.</span></span><br><span class="line">    <span class="comment">//【1】创建上下文；</span></span><br><span class="line">    Context context;</span><br><span class="line">    <span class="comment">//【2】mUseDecorContext 表示是否使用 decor context，默认是 false 的；</span></span><br><span class="line">    <span class="comment">// 但是如果我们启动的是 activity，那么 mUseDecorContext 为 true；</span></span><br><span class="line">    <span class="keyword">if</span> (mUseDecorContext) &#123;</span><br><span class="line">        Context applicationContext = getContext().getApplicationContext();</span><br><span class="line">        <span class="keyword">if</span> (applicationContext == <span class="keyword">null</span>) &#123;</span><br><span class="line">            context = getContext();</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            context = <span class="keyword">new</span> DecorContext(applicationContext, getContext().getResources());</span><br><span class="line">            <span class="keyword">if</span> (mTheme != -<span class="number">1</span>) &#123;</span><br><span class="line">                context.setTheme(mTheme);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        context = getContext();</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">//【--&gt;6.1】创建了 DecorView 实例；</span></span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">new</span> DecorView(context, featureId, <span class="keyword">this</span>, getAttributes());</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>对于创建 Context 这里，我们不过多关注！</p>
<h3 id="4-2-2-generateLayout"><a href="#4-2-2-generateLayout" class="headerlink" title="4.2.2 generateLayout"></a>4.2.2 generateLayout</h3><p>加载布局：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br><span class="line">212</span><br><span class="line">213</span><br><span class="line">214</span><br><span class="line">215</span><br><span class="line">216</span><br><span class="line">217</span><br><span class="line">218</span><br><span class="line">219</span><br><span class="line">220</span><br><span class="line">221</span><br><span class="line">222</span><br><span class="line">223</span><br><span class="line">224</span><br><span class="line">225</span><br><span class="line">226</span><br><span class="line">227</span><br><span class="line">228</span><br><span class="line">229</span><br><span class="line">230</span><br><span class="line">231</span><br><span class="line">232</span><br><span class="line">233</span><br><span class="line">234</span><br><span class="line">235</span><br><span class="line">236</span><br><span class="line">237</span><br><span class="line">238</span><br><span class="line">239</span><br><span class="line">240</span><br><span class="line">241</span><br><span class="line">242</span><br><span class="line">243</span><br><span class="line">244</span><br><span class="line">245</span><br><span class="line">246</span><br><span class="line">247</span><br><span class="line">248</span><br><span class="line">249</span><br><span class="line">250</span><br><span class="line">251</span><br><span class="line">252</span><br><span class="line">253</span><br><span class="line">254</span><br><span class="line">255</span><br><span class="line">256</span><br><span class="line">257</span><br><span class="line">258</span><br><span class="line">259</span><br><span class="line">260</span><br><span class="line">261</span><br><span class="line">262</span><br><span class="line">263</span><br><span class="line">264</span><br><span class="line">265</span><br><span class="line">266</span><br><span class="line">267</span><br><span class="line">268</span><br><span class="line">269</span><br><span class="line">270</span><br><span class="line">271</span><br><span class="line">272</span><br><span class="line">273</span><br><span class="line">274</span><br><span class="line">275</span><br><span class="line">276</span><br><span class="line">277</span><br><span class="line">278</span><br><span class="line">279</span><br><span class="line">280</span><br><span class="line">281</span><br><span class="line">282</span><br><span class="line">283</span><br><span class="line">284</span><br><span class="line">285</span><br><span class="line">286</span><br><span class="line">287</span><br><span class="line">288</span><br><span class="line">289</span><br><span class="line">290</span><br><span class="line">291</span><br><span class="line">292</span><br><span class="line">293</span><br><span class="line">294</span><br><span class="line">295</span><br><span class="line">296</span><br><span class="line">297</span><br><span class="line">298</span><br><span class="line">299</span><br><span class="line">300</span><br><span class="line">301</span><br><span class="line">302</span><br><span class="line">303</span><br><span class="line">304</span><br><span class="line">305</span><br><span class="line">306</span><br><span class="line">307</span><br><span class="line">308</span><br><span class="line">309</span><br><span class="line">310</span><br><span class="line">311</span><br><span class="line">312</span><br><span class="line">313</span><br><span class="line">314</span><br><span class="line">315</span><br><span class="line">316</span><br><span class="line">317</span><br><span class="line">318</span><br><span class="line">319</span><br><span class="line">320</span><br><span class="line">321</span><br><span class="line">322</span><br><span class="line">323</span><br><span class="line">324</span><br><span class="line">325</span><br><span class="line">326</span><br><span class="line">327</span><br><span class="line">328</span><br><span class="line">329</span><br><span class="line">330</span><br><span class="line">331</span><br><span class="line">332</span><br><span class="line">333</span><br><span class="line">334</span><br><span class="line">335</span><br><span class="line">336</span><br><span class="line">337</span><br><span class="line">338</span><br><span class="line">339</span><br><span class="line">340</span><br><span class="line">341</span><br><span class="line">342</span><br><span class="line">343</span><br><span class="line">344</span><br><span class="line">345</span><br><span class="line">346</span><br><span class="line">347</span><br><span class="line">348</span><br><span class="line">349</span><br><span class="line">350</span><br><span class="line">351</span><br><span class="line">352</span><br><span class="line">353</span><br><span class="line">354</span><br><span class="line">355</span><br><span class="line">356</span><br><span class="line">357</span><br><span class="line">358</span><br><span class="line">359</span><br><span class="line">360</span><br><span class="line">361</span><br><span class="line">362</span><br><span class="line">363</span><br><span class="line">364</span><br><span class="line">365</span><br><span class="line">366</span><br><span class="line">367</span><br><span class="line">368</span><br><span class="line">369</span><br><span class="line">370</span><br><span class="line">371</span><br><span class="line">372</span><br><span class="line">373</span><br><span class="line">374</span><br><span class="line">375</span><br><span class="line">376</span><br><span class="line">377</span><br><span class="line">378</span><br><span class="line">379</span><br><span class="line">380</span><br><span class="line">381</span><br><span class="line">382</span><br><span class="line">383</span><br></pre></td><td class="code"><pre><span class="line"> <span class="function"><span class="keyword">protected</span> ViewGroup <span class="title">generateLayout</span><span class="params">(DecorView decor)</span> </span>&#123;</span><br><span class="line">     <span class="comment">//【1】这里获取窗口的样式，读取的是 com.android.internal.R.styleable.Window 属性；</span></span><br><span class="line">     <span class="comment">// 其实就是 activity 的 theme 配置</span></span><br><span class="line">     TypedArray a = getWindowStyle();</span><br><span class="line"></span><br><span class="line">     <span class="keyword">if</span> (<span class="keyword">false</span>) &#123;</span><br><span class="line">         System.out.println(<span class="string">"From style:"</span>);</span><br><span class="line">         String s = <span class="string">"Attrs:"</span>;</span><br><span class="line">         <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; R.styleable.Window.length; i++) &#123;</span><br><span class="line">             s = s + <span class="string">" "</span> + Integer.toHexString(R.styleable.Window[i]) + <span class="string">"="</span></span><br><span class="line">                     + a.getString(i);</span><br><span class="line">         &#125;</span><br><span class="line">         System.out.println(s);</span><br><span class="line">     &#125;</span><br><span class="line">     <span class="comment">//【2】判断是否是悬浮的 window；</span></span><br><span class="line">     mIsFloating = a.getBoolean(R.styleable.Window_windowIsFloating, <span class="keyword">false</span>);</span><br><span class="line">     <span class="comment">//【2.1】获取要更新的 falags，其实就是 FLAG_LAYOUT_IN_SCREEN | FLAG_LAYOUT_INSET_DECOR；</span></span><br><span class="line">     <span class="keyword">int</span> flagsToUpdate = (FLAG_LAYOUT_IN_SCREEN | FLAG_LAYOUT_INSET_DECOR)</span><br><span class="line">             &amp; (~getForcedWindowFlags());</span><br><span class="line"></span><br><span class="line">     <span class="comment">//【3】针对悬浮属性做处理；</span></span><br><span class="line">     <span class="keyword">if</span> (mIsFloating) &#123;</span><br><span class="line">         <span class="comment">//【--&gt;5.4】如果是悬浮 window，那么肯定不是全屏的，这里会将默认的 MATCH_PARENT </span></span><br><span class="line">         <span class="comment">// 改为 WRAP_CONTENT；</span></span><br><span class="line">         setLayout(WRAP_CONTENT, WRAP_CONTENT);</span><br><span class="line">         <span class="comment">//【--&gt;5.5】设置 flags，去掉 flagsToUpdate；</span></span><br><span class="line">         setFlags(<span class="number">0</span>, flagsToUpdate);</span><br><span class="line"> </span><br><span class="line">     &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">         <span class="comment">//【--&gt;5.5】设置 flags，增加 FLAG_LAYOUT_IN_SCREEN | FLAG_LAYOUT_INSET_DECOR；</span></span><br><span class="line">         setFlags(FLAG_LAYOUT_IN_SCREEN | FLAG_LAYOUT_INSET_DECOR, flagsToUpdate);</span><br><span class="line">     &#125;</span><br><span class="line">     </span><br><span class="line">     <span class="comment">//【4】统一处理一些窗口特性；</span></span><br><span class="line">     <span class="comment">//【--&gt;4.2.1.1】设置 feture！</span></span><br><span class="line">     <span class="keyword">if</span> (a.getBoolean(R.styleable.Window_windowNoTitle, <span class="keyword">false</span>)) &#123;</span><br><span class="line">         <span class="comment">//【4.1】设置了 notitle；</span></span><br><span class="line">         requestFeature(FEATURE_NO_TITLE);</span><br><span class="line">         </span><br><span class="line">     &#125; <span class="keyword">else</span> <span class="keyword">if</span> (a.getBoolean(R.styleable.Window_windowActionBar, <span class="keyword">false</span>)) &#123;</span><br><span class="line">         <span class="comment">//【4.2】设置 actionbar！</span></span><br><span class="line">         requestFeature(FEATURE_ACTION_BAR);</span><br><span class="line">     &#125;</span><br><span class="line"></span><br><span class="line">     <span class="keyword">if</span> (a.getBoolean(R.styleable.Window_windowActionBarOverlay, <span class="keyword">false</span>)) &#123;</span><br><span class="line">         <span class="comment">//【4.3】设置覆盖模式，也就是说 actionbar 会覆盖在 window content 上；</span></span><br><span class="line">         <span class="comment">// 和 FEATURE_ACTION_BAR 一起使用；</span></span><br><span class="line">         requestFeature(FEATURE_ACTION_BAR_OVERLAY);</span><br><span class="line">     &#125;</span><br><span class="line"></span><br><span class="line">     <span class="keyword">if</span> (a.getBoolean(R.styleable.Window_windowActionModeOverlay, <span class="keyword">false</span>)) &#123;</span><br><span class="line">         <span class="comment">//【4.4】设置 FEATURE_ACTION_MODE_OVERLAY；</span></span><br><span class="line">         requestFeature(FEATURE_ACTION_MODE_OVERLAY);</span><br><span class="line">     &#125;</span><br><span class="line"></span><br><span class="line">     <span class="keyword">if</span> (a.getBoolean(R.styleable.Window_windowSwipeToDismiss, <span class="keyword">false</span>)) &#123;</span><br><span class="line">         <span class="comment">//【4.5】开启了滑动退出，那就设置 FEATURE_SWIPE_TO_DISMISS；</span></span><br><span class="line">         requestFeature(FEATURE_SWIPE_TO_DISMISS);</span><br><span class="line">     &#125;</span><br><span class="line">     </span><br><span class="line">     <span class="comment">//【5】处理一些 flags 设置；</span></span><br><span class="line">     <span class="comment">//【--&gt;5.4】设置 flags；</span></span><br><span class="line">     <span class="keyword">if</span> (a.getBoolean(R.styleable.Window_windowFullscreen, <span class="keyword">false</span>)) &#123;</span><br><span class="line">         <span class="comment">//【5.1】隐藏状态栏全屏显示 Window，设置 FLAG_FULLSCREEN 标志；</span></span><br><span class="line">         setFlags(FLAG_FULLSCREEN, FLAG_FULLSCREEN &amp; (~getForcedWindowFlags()));</span><br><span class="line">     &#125;</span><br><span class="line"></span><br><span class="line">     <span class="keyword">if</span> (a.getBoolean(R.styleable.Window_windowTranslucentStatus,</span><br><span class="line">             <span class="keyword">false</span>)) &#123;</span><br><span class="line">         <span class="comment">//【5.1】使状态栏透明同时会拉伸 window 到全屏的状态（保留 NavigationBar 高度），</span></span><br><span class="line">         <span class="comment">// 假如有 ActionBar，ActionBar 依旧会显示，设置 FLAG_FULLSCREEN 标志；</span></span><br><span class="line">         setFlags(FLAG_TRANSLUCENT_STATUS, FLAG_TRANSLUCENT_STATUS</span><br><span class="line">                 &amp; (~getForcedWindowFlags()));</span><br><span class="line">     &#125;</span><br><span class="line"></span><br><span class="line">     <span class="keyword">if</span> (a.getBoolean(R.styleable.Window_windowTranslucentNavigation,</span><br><span class="line">             <span class="keyword">false</span>)) &#123;</span><br><span class="line">         <span class="comment">//【5.2】NavigationBar 透明同时会拉伸 Window 到全屏，不保留 StatusBar 和 NavigationBar 的高度</span></span><br><span class="line">         <span class="comment">// 设置 FLAG_TRANSLUCENT_NAVIGATION 位；</span></span><br><span class="line">         setFlags(FLAG_TRANSLUCENT_NAVIGATION, FLAG_TRANSLUCENT_NAVIGATION</span><br><span class="line">                 &amp; (~getForcedWindowFlags()));</span><br><span class="line">     &#125;</span><br><span class="line"></span><br><span class="line">     <span class="keyword">if</span> (a.getBoolean(R.styleable.Window_windowOverscan, <span class="keyword">false</span>)) &#123;</span><br><span class="line">         <span class="comment">//【5.3】允许 window contents 扩展到屏幕中的缩放区域内，如果有缩放区域的话；</span></span><br><span class="line">         <span class="comment">// 设置 FLAG_LAYOUT_IN_OVERSCAN 位；</span></span><br><span class="line">         setFlags(FLAG_LAYOUT_IN_OVERSCAN, FLAG_LAYOUT_IN_OVERSCAN&amp;(~getForcedWindowFlags()));</span><br><span class="line">     &#125;</span><br><span class="line"></span><br><span class="line">     <span class="keyword">if</span> (a.getBoolean(R.styleable.Window_windowShowWallpaper, <span class="keyword">false</span>)) &#123;</span><br><span class="line">         <span class="comment">//【5.4】使用系统桌面背景作为应用的背景，设置 FLAG_SHOW_WALLPAPER 位；</span></span><br><span class="line">         setFlags(FLAG_SHOW_WALLPAPER, FLAG_SHOW_WALLPAPER&amp;(~getForcedWindowFlags()));</span><br><span class="line">     &#125;</span><br><span class="line"></span><br><span class="line">     <span class="keyword">if</span> (a.getBoolean(R.styleable.Window_windowEnableSplitTouch,</span><br><span class="line">             getContext().getApplicationInfo().targetSdkVersion</span><br><span class="line">                     &gt;= android.os.Build.VERSION_CODES.HONEYCOMB)) &#123;</span><br><span class="line">         <span class="comment">//【5.5】支持触摸事件序列的拆分，设置 FLAG_SPLIT_TOUCH 位；</span></span><br><span class="line">         setFlags(FLAG_SPLIT_TOUCH, FLAG_SPLIT_TOUCH&amp;(~getForcedWindowFlags()));</span><br><span class="line">     &#125;</span><br><span class="line"></span><br><span class="line">     <span class="comment">//【6】获取和 Width/Height 相关的属性；</span></span><br><span class="line">     a.getValue(R.styleable.Window_windowMinWidthMajor, mMinWidthMajor);</span><br><span class="line">     a.getValue(R.styleable.Window_windowMinWidthMinor, mMinWidthMinor);</span><br><span class="line">     <span class="keyword">if</span> (DEBUG) Log.d(TAG, <span class="string">"Min width minor: "</span> + mMinWidthMinor.coerceToString()</span><br><span class="line">             + <span class="string">", major: "</span> + mMinWidthMajor.coerceToString());</span><br><span class="line">     <span class="keyword">if</span> (a.hasValue(R.styleable.Window_windowFixedWidthMajor)) &#123;</span><br><span class="line">         <span class="keyword">if</span> (mFixedWidthMajor == <span class="keyword">null</span>) mFixedWidthMajor = <span class="keyword">new</span> TypedValue();</span><br><span class="line">         a.getValue(R.styleable.Window_windowFixedWidthMajor,</span><br><span class="line">                 mFixedWidthMajor);</span><br><span class="line">     &#125;</span><br><span class="line">     <span class="keyword">if</span> (a.hasValue(R.styleable.Window_windowFixedWidthMinor)) &#123;</span><br><span class="line">         <span class="keyword">if</span> (mFixedWidthMinor == <span class="keyword">null</span>) mFixedWidthMinor = <span class="keyword">new</span> TypedValue();</span><br><span class="line">         a.getValue(R.styleable.Window_windowFixedWidthMinor,</span><br><span class="line">                 mFixedWidthMinor);</span><br><span class="line">     &#125;</span><br><span class="line">     <span class="keyword">if</span> (a.hasValue(R.styleable.Window_windowFixedHeightMajor)) &#123;</span><br><span class="line">         <span class="keyword">if</span> (mFixedHeightMajor == <span class="keyword">null</span>) mFixedHeightMajor = <span class="keyword">new</span> TypedValue();</span><br><span class="line">         a.getValue(R.styleable.Window_windowFixedHeightMajor,</span><br><span class="line">                 mFixedHeightMajor);</span><br><span class="line">     &#125;</span><br><span class="line">     <span class="keyword">if</span> (a.hasValue(R.styleable.Window_windowFixedHeightMinor)) &#123;</span><br><span class="line">         <span class="keyword">if</span> (mFixedHeightMinor == <span class="keyword">null</span>) mFixedHeightMinor = <span class="keyword">new</span> TypedValue();</span><br><span class="line">         a.getValue(R.styleable.Window_windowFixedHeightMinor,</span><br><span class="line">                 mFixedHeightMinor);</span><br><span class="line">     &#125;</span><br><span class="line">     <span class="comment">//【7】又处理一些 flags 设置；</span></span><br><span class="line">     <span class="comment">//【--&gt;5.4】设置 flags；</span></span><br><span class="line">     <span class="keyword">if</span> (a.getBoolean(R.styleable.Window_windowContentTransitions, <span class="keyword">false</span>)) &#123;</span><br><span class="line">         <span class="comment">//【7.1】开启了 content 过渡(动画)，设置 FEATURE_CONTENT_TRANSITIONS</span></span><br><span class="line">         requestFeature(FEATURE_CONTENT_TRANSITIONS);</span><br><span class="line">     &#125;</span><br><span class="line">     <span class="keyword">if</span> (a.getBoolean(R.styleable.Window_windowActivityTransitions, <span class="keyword">false</span>)) &#123;</span><br><span class="line">         <span class="comment">//【7.2】开启了 acitivty 过渡(动画)，设置 FEATURE_ACTIVITY_TRANSITIONS</span></span><br><span class="line">         requestFeature(FEATURE_ACTIVITY_TRANSITIONS);</span><br><span class="line">     &#125;</span><br><span class="line"></span><br><span class="line">     mIsTranslucent = a.getBoolean(R.styleable.Window_windowIsTranslucent, <span class="keyword">false</span>);</span><br><span class="line"></span><br><span class="line">     <span class="keyword">final</span> Context context = getContext();</span><br><span class="line">     <span class="comment">//【8】获取和平台版本相关的属性；</span></span><br><span class="line">     <span class="keyword">final</span> <span class="keyword">int</span> targetSdk = context.getApplicationInfo().targetSdkVersion;</span><br><span class="line">     <span class="keyword">final</span> <span class="keyword">boolean</span> targetPreHoneycomb = targetSdk &lt; android.os.Build.VERSION_CODES.HONEYCOMB;</span><br><span class="line">     <span class="keyword">final</span> <span class="keyword">boolean</span> targetPreIcs = targetSdk &lt; android.os.Build.VERSION_CODES.ICE_CREAM_SANDWICH;</span><br><span class="line">     <span class="keyword">final</span> <span class="keyword">boolean</span> targetPreL = targetSdk &lt; android.os.Build.VERSION_CODES.LOLLIPOP;</span><br><span class="line">     <span class="keyword">final</span> <span class="keyword">boolean</span> targetHcNeedsOptions = context.getResources().getBoolean(</span><br><span class="line">             R.bool.target_honeycomb_needs_options_menu);</span><br><span class="line">     <span class="keyword">final</span> <span class="keyword">boolean</span> noActionBar = !hasFeature(FEATURE_ACTION_BAR) || hasFeature(FEATURE_NO_TITLE);</span><br><span class="line"></span><br><span class="line">     <span class="comment">//【9】根据当前 sdk 的版本判断需不需要加入 menukey</span></span><br><span class="line">     <span class="keyword">if</span> (targetPreHoneycomb || (targetPreIcs &amp;&amp; targetHcNeedsOptions &amp;&amp; noActionBar)) &#123;</span><br><span class="line">         setNeedsMenuKey(WindowManager.LayoutParams.NEEDS_MENU_SET_TRUE);</span><br><span class="line">     &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">         setNeedsMenuKey(WindowManager.LayoutParams.NEEDS_MENU_SET_FALSE);</span><br><span class="line">     &#125;</span><br><span class="line"></span><br><span class="line">     <span class="comment">//【10】如果应用没有强制设置 Status Bar 和 Navigation Bar 的颜色，那就使用默认颜色；</span></span><br><span class="line">     <span class="keyword">if</span> (!mForcedStatusBarColor) &#123;</span><br><span class="line">         mStatusBarColor = a.getColor(R.styleable.Window_statusBarColor, <span class="number">0xFF000000</span>);</span><br><span class="line">     &#125;</span><br><span class="line">     <span class="keyword">if</span> (!mForcedNavigationBarColor) &#123;</span><br><span class="line">         mNavigationBarColor = a.getColor(R.styleable.Window_navigationBarColor, <span class="number">0xFF000000</span>);</span><br><span class="line">     &#125;</span><br><span class="line">		</span><br><span class="line">     <span class="comment">//【11】获取 window 的布局参数；</span></span><br><span class="line">     WindowManager.LayoutParams params = getAttributes();</span><br><span class="line"></span><br><span class="line">     <span class="comment">//【12】如果不是浮动的 window 同时环视，如果 sdk 是 5.0 以上，同时 theme 设置了</span></span><br><span class="line">     <span class="comment">// 可绘制 sysetem bar 的背景，那就设置 FLAG_DRAWS_SYSTEM_BAR_BACKGROUNDS 标志位；</span></span><br><span class="line">     <span class="keyword">if</span> (!mIsFloating &amp;&amp; ActivityManager.isHighEndGfx()) &#123;</span><br><span class="line">         <span class="keyword">if</span> (!targetPreL &amp;&amp; a.getBoolean(</span><br><span class="line">                 R.styleable.Window_windowDrawsSystemBarBackgrounds,</span><br><span class="line">                 <span class="keyword">false</span>)) &#123;</span><br><span class="line">             setFlags(FLAG_DRAWS_SYSTEM_BAR_BACKGROUNDS,</span><br><span class="line">                     FLAG_DRAWS_SYSTEM_BAR_BACKGROUNDS &amp; ~getForcedWindowFlags());</span><br><span class="line">         &#125;</span><br><span class="line">         <span class="keyword">if</span> (mDecor.mForceWindowDrawsStatusBarBackground) &#123;</span><br><span class="line">             params.privateFlags |= PRIVATE_FLAG_FORCE_DRAW_STATUS_BAR_BACKGROUND;</span><br><span class="line">         &#125;</span><br><span class="line">     &#125;</span><br><span class="line">     <span class="comment">//【13】设置状态栏为浅色；</span></span><br><span class="line">     <span class="keyword">if</span> (a.getBoolean(R.styleable.Window_windowLightStatusBar, <span class="keyword">false</span>)) &#123;</span><br><span class="line">         decor.setSystemUiVisibility(</span><br><span class="line">                 decor.getSystemUiVisibility() | View.SYSTEM_UI_FLAG_LIGHT_STATUS_BAR);</span><br><span class="line">     &#125;</span><br><span class="line">     <span class="comment">//【14】设置点击 window 的外面，就关闭 window！</span></span><br><span class="line">     <span class="keyword">if</span> (mAlwaysReadCloseOnTouchAttr || getContext().getApplicationInfo().targetSdkVersion</span><br><span class="line">             &gt;= android.os.Build.VERSION_CODES.HONEYCOMB) &#123;</span><br><span class="line">         <span class="keyword">if</span> (a.getBoolean(</span><br><span class="line">                 R.styleable.Window_windowCloseOnTouchOutside,</span><br><span class="line">                 <span class="keyword">false</span>)) &#123;</span><br><span class="line">             setCloseOnTouchOutsideIfNotSet(<span class="keyword">true</span>);</span><br><span class="line">         &#125;</span><br><span class="line">     &#125;</span><br><span class="line">     <span class="comment">//【15】设置软键盘交互效果！</span></span><br><span class="line">     <span class="keyword">if</span> (!hasSoftInputMode()) &#123;</span><br><span class="line">         params.softInputMode = a.getInt(</span><br><span class="line">                 R.styleable.Window_windowSoftInputMode,</span><br><span class="line">                 params.softInputMode);</span><br><span class="line">     &#125;</span><br><span class="line"></span><br><span class="line">     <span class="comment">//【16】设置 window 的幕布，也就是背景层，dimAmount 在 0.0f 和 1.0f 之间，</span></span><br><span class="line">     <span class="comment">// 0.0f 完全不暗，即背景是可见的 ，1.0f 时候，背景全部变黑暗。</span></span><br><span class="line">     <span class="keyword">if</span> (a.getBoolean(R.styleable.Window_backgroundDimEnabled,</span><br><span class="line">             mIsFloating)) &#123;</span><br><span class="line">         <span class="comment">/* All dialogs should have the window dimmed */</span></span><br><span class="line">         <span class="keyword">if</span> ((getForcedWindowFlags()&amp;WindowManager.LayoutParams.FLAG_DIM_BEHIND) == <span class="number">0</span>) &#123;</span><br><span class="line">             <span class="comment">//【16.1】布局参数增加 FLAG_DIM_BEHIND 标志位；</span></span><br><span class="line">             params.flags |= WindowManager.LayoutParams.FLAG_DIM_BEHIND;</span><br><span class="line">         &#125;</span><br><span class="line">         <span class="keyword">if</span> (!haveDimAmount()) &#123;</span><br><span class="line">             params.dimAmount = a.getFloat(</span><br><span class="line">                     android.R.styleable.Window_backgroundDimAmount, <span class="number">0.5f</span>);</span><br><span class="line">         &#125;</span><br><span class="line">     &#125;</span><br><span class="line">     <span class="comment">//【17】设置窗口动画；</span></span><br><span class="line">     <span class="keyword">if</span> (params.windowAnimations == <span class="number">0</span>) &#123;</span><br><span class="line">         params.windowAnimations = a.getResourceId(</span><br><span class="line">                 R.styleable.Window_windowAnimationStyle, <span class="number">0</span>);</span><br><span class="line">     &#125;</span><br><span class="line"></span><br><span class="line">     <span class="comment">//【18】返回该 window 的容器，如果为 null，那么其是 top 级别的 window，也就是我们的 activity！</span></span><br><span class="line">     <span class="comment">// 这里主要是一些背景色的设置；</span></span><br><span class="line">     <span class="keyword">if</span> (getContainer() == <span class="keyword">null</span>) &#123;</span><br><span class="line">         <span class="keyword">if</span> (mBackgroundDrawable == <span class="keyword">null</span>) &#123;</span><br><span class="line">             <span class="keyword">if</span> (mBackgroundResource == <span class="number">0</span>) &#123;</span><br><span class="line">                 mBackgroundResource = a.getResourceId(</span><br><span class="line">                         R.styleable.Window_windowBackground, <span class="number">0</span>);</span><br><span class="line">             &#125;</span><br><span class="line">             <span class="keyword">if</span> (mFrameResource == <span class="number">0</span>) &#123;</span><br><span class="line">                 mFrameResource = a.getResourceId(R.styleable.Window_windowFrame, <span class="number">0</span>);</span><br><span class="line">             &#125;</span><br><span class="line">             mBackgroundFallbackResource = a.getResourceId(</span><br><span class="line">                     R.styleable.Window_windowBackgroundFallback, <span class="number">0</span>);</span><br><span class="line">             <span class="keyword">if</span> (<span class="keyword">false</span>) &#123;</span><br><span class="line">                 System.out.println(<span class="string">"Background: "</span></span><br><span class="line">                         + Integer.toHexString(mBackgroundResource) + <span class="string">" Frame: "</span></span><br><span class="line">                         + Integer.toHexString(mFrameResource));</span><br><span class="line">             &#125;</span><br><span class="line">         &#125;</span><br><span class="line">         <span class="keyword">if</span> (mLoadElevation) &#123;</span><br><span class="line">             mElevation = a.getDimension(R.styleable.Window_windowElevation, <span class="number">0</span>);</span><br><span class="line">         &#125;</span><br><span class="line">         mClipToOutline = a.getBoolean(R.styleable.Window_windowClipToOutline, <span class="keyword">false</span>);</span><br><span class="line">         mTextColor = a.getColor(R.styleable.Window_textColor, Color.TRANSPARENT);</span><br><span class="line">     &#125;</span><br><span class="line"></span><br><span class="line">     <span class="comment">//【19】核心代码：--&gt; 加载布局文件！</span></span><br><span class="line">     <span class="keyword">int</span> layoutResource;</span><br><span class="line">     <span class="keyword">int</span> features = getLocalFeatures();</span><br><span class="line">     <span class="comment">// 通过对 features 和 mIsFloating 的判断，为 layoutResource 进行赋值，</span></span><br><span class="line">     <span class="comment">// 所以 requestFeature 要在 setContentView 之前进行；</span></span><br><span class="line">     <span class="keyword">if</span> ((features &amp; (<span class="number">1</span> &lt;&lt; FEATURE_SWIPE_TO_DISMISS)) != <span class="number">0</span>) &#123;</span><br><span class="line">         <span class="comment">//【19.1】如果支持滑动退出，那么会加载 R.layout.screen_swipe_dismiss 这个布局文件；</span></span><br><span class="line">         layoutResource = R.layout.screen_swipe_dismiss;</span><br><span class="line"></span><br><span class="line">     &#125; <span class="keyword">else</span> <span class="keyword">if</span> ((features &amp; ((<span class="number">1</span> &lt;&lt; FEATURE_LEFT_ICON) | (<span class="number">1</span> &lt;&lt; FEATURE_RIGHT_ICON))) != <span class="number">0</span>) &#123;</span><br><span class="line">         <span class="comment">//【19.2】如果在标题栏显示左右的按钮，那么根据是否是浮动，加载不同的布局；</span></span><br><span class="line">         <span class="keyword">if</span> (mIsFloating) &#123;</span><br><span class="line">             TypedValue res = <span class="keyword">new</span> TypedValue();</span><br><span class="line">             getContext().getTheme().resolveAttribute(</span><br><span class="line">                     R.attr.dialogTitleIconsDecorLayout, res, <span class="keyword">true</span>);</span><br><span class="line">             layoutResource = res.resourceId;</span><br><span class="line">         &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">             <span class="comment">//【19.2.2】加载 R.layout.screen_title_icons 这个布局文件</span></span><br><span class="line">             layoutResource = R.layout.screen_title_icons;</span><br><span class="line">         &#125;</span><br><span class="line">         <span class="comment">//【19.2.2】移除 action bar 特性；</span></span><br><span class="line">         removeFeature(FEATURE_ACTION_BAR);</span><br><span class="line">         <span class="comment">// System.out.println("Title Icons!");</span></span><br><span class="line"></span><br><span class="line">     &#125; <span class="keyword">else</span> <span class="keyword">if</span> ((features &amp; ((<span class="number">1</span> &lt;&lt; FEATURE_PROGRESS) | (<span class="number">1</span> &lt;&lt; FEATURE_INDETERMINATE_PROGRESS))) != <span class="number">0</span></span><br><span class="line">             &amp;&amp; (features &amp; (<span class="number">1</span> &lt;&lt; FEATURE_ACTION_BAR)) == <span class="number">0</span>) &#123;</span><br><span class="line">         <span class="comment">//【19.3】如果 window 只设置了一个 progress bar</span></span><br><span class="line">         <span class="comment">// 那么加载 R.layout.screen_progress 布局；</span></span><br><span class="line">         layoutResource = R.layout.screen_progress;</span><br><span class="line"></span><br><span class="line">     &#125; <span class="keyword">else</span> <span class="keyword">if</span> ((features &amp; (<span class="number">1</span> &lt;&lt; FEATURE_CUSTOM_TITLE)) != <span class="number">0</span>) &#123;</span><br><span class="line"><span class="comment">//【19.4】如果 window 设置了定制的 title 特性，如果是悬浮的 window，那么会加载一个 dialog 的布局</span></span><br><span class="line">         <span class="comment">// 否则加载 R.layout.screen_custom_title 布局；</span></span><br><span class="line">         <span class="keyword">if</span> (mIsFloating) &#123;</span><br><span class="line">             TypedValue res = <span class="keyword">new</span> TypedValue();</span><br><span class="line">             getContext().getTheme().resolveAttribute(</span><br><span class="line">                     R.attr.dialogCustomTitleDecorLayout, res, <span class="keyword">true</span>);</span><br><span class="line">             layoutResource = res.resourceId;</span><br><span class="line">         &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">             layoutResource = R.layout.screen_custom_title;</span><br><span class="line">         &#125;</span><br><span class="line">         <span class="comment">// 移除 action bar 特性；</span></span><br><span class="line">         removeFeature(FEATURE_ACTION_BAR);</span><br><span class="line"></span><br><span class="line">     &#125; <span class="keyword">else</span> <span class="keyword">if</span> ((features &amp; (<span class="number">1</span> &lt;&lt; FEATURE_NO_TITLE)) == <span class="number">0</span>) &#123;</span><br><span class="line">         <span class="comment">//【19.5】如果 window 设置了 no title 特性，如果是悬浮的 window，那么会加载一个 dialog 的布局</span></span><br><span class="line">         <span class="comment">// 否则如果设置了 action bar 特性，那么就加载 R.layout.screen_action_bar 的布局；</span></span><br><span class="line">         <span class="comment">// 其他情况，加载 R.layout.screen_custom_title 布局；</span></span><br><span class="line">         <span class="keyword">if</span> (mIsFloating) &#123;</span><br><span class="line">             TypedValue res = <span class="keyword">new</span> TypedValue();</span><br><span class="line">             getContext().getTheme().resolveAttribute(</span><br><span class="line">                     R.attr.dialogTitleDecorLayout, res, <span class="keyword">true</span>);</span><br><span class="line">             layoutResource = res.resourceId;</span><br><span class="line">             </span><br><span class="line">         &#125; <span class="keyword">else</span> <span class="keyword">if</span> ((features &amp; (<span class="number">1</span> &lt;&lt; FEATURE_ACTION_BAR)) != <span class="number">0</span>) &#123;</span><br><span class="line">             layoutResource = a.getResourceId(</span><br><span class="line">                     R.styleable.Window_windowActionBarFullscreenDecorLayout,</span><br><span class="line">                     R.layout.screen_action_bar);</span><br><span class="line">             </span><br><span class="line">         &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">             layoutResource = R.layout.screen_title;</span><br><span class="line">         &#125;</span><br><span class="line"></span><br><span class="line">     &#125; <span class="keyword">else</span> <span class="keyword">if</span> ((features &amp; (<span class="number">1</span> &lt;&lt; FEATURE_ACTION_MODE_OVERLAY)) != <span class="number">0</span>) &#123;</span><br><span class="line">         <span class="comment">//【19.5】如果设置了 action mode overlay 特性，那么 action bar 会覆盖在 content 上面</span></span><br><span class="line">         <span class="comment">// 加载 R.layout.screen_simple_overlay_action_mode 布局；</span></span><br><span class="line">         layoutResource = R.layout.screen_simple_overlay_action_mode;</span><br><span class="line"></span><br><span class="line">     &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">         <span class="comment">//【19.6】在没有设置任何 feature（也就是装饰）时选用默认布局</span></span><br><span class="line">         layoutResource = R.layout.screen_simple;</span><br><span class="line"></span><br><span class="line">     &#125;</span><br><span class="line">     <span class="comment">//【--&gt;6.3】标记 DecorView 正准备加载；</span></span><br><span class="line">     mDecor.startChanging();</span><br><span class="line">     <span class="comment">//【--&gt;6.4】开始加载布局文件，</span></span><br><span class="line">     mDecor.onResourcesLoaded(mLayoutInflater, layoutResource);</span><br><span class="line"></span><br><span class="line">     <span class="comment">//【20】找到内置布局里面的 id 为 ID_ANDROID_CONTENT 的 ViewGroup，保存到 contentParent 临时变量中；</span></span><br><span class="line">     <span class="comment">// 目的很明显，要加载 setContentView 设置的布局了；</span></span><br><span class="line">     ViewGroup contentParent = (ViewGroup)findViewById(ID_ANDROID_CONTENT);</span><br><span class="line">     <span class="keyword">if</span> (contentParent == <span class="keyword">null</span>) &#123;</span><br><span class="line">         <span class="keyword">throw</span> <span class="keyword">new</span> RuntimeException(<span class="string">"Window couldn't find content container view"</span>);</span><br><span class="line">     &#125;</span><br><span class="line"></span><br><span class="line">     <span class="keyword">if</span> ((features &amp; (<span class="number">1</span> &lt;&lt; FEATURE_INDETERMINATE_PROGRESS)) != <span class="number">0</span>) &#123;</span><br><span class="line">         ProgressBar progress = getCircularProgressBar(<span class="keyword">false</span>);</span><br><span class="line">         <span class="keyword">if</span> (progress != <span class="keyword">null</span>) &#123;</span><br><span class="line">             progress.setIndeterminate(<span class="keyword">true</span>);</span><br><span class="line">         &#125;</span><br><span class="line">     &#125;</span><br><span class="line"></span><br><span class="line">     <span class="keyword">if</span> ((features &amp; (<span class="number">1</span> &lt;&lt; FEATURE_SWIPE_TO_DISMISS)) != <span class="number">0</span>) &#123;</span><br><span class="line">         registerSwipeCallbacks();</span><br><span class="line">     &#125;</span><br><span class="line"></span><br><span class="line">     <span class="comment">//【21】只针对于 top level 的 window 才会进行处理；</span></span><br><span class="line">     <span class="keyword">if</span> (getContainer() == <span class="keyword">null</span>) &#123;</span><br><span class="line">         <span class="keyword">final</span> Drawable background;</span><br><span class="line">         <span class="comment">//【21.1】PhoneWindow 有一个 setBackgroundDrawable 方法可以用来设置 mBackgroundResource；</span></span><br><span class="line">         <span class="keyword">if</span> (mBackgroundResource != <span class="number">0</span>) &#123;</span><br><span class="line">             background = getContext().getDrawable(mBackgroundResource);</span><br><span class="line">         &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">             background = mBackgroundDrawable;</span><br><span class="line">         &#125;</span><br><span class="line">         <span class="comment">//【--&gt;6.5】设置 window 背景，最终会触发 drawableChanged 方法；</span></span><br><span class="line">         mDecor.setWindowBackground(background);</span><br><span class="line"></span><br><span class="line">         <span class="keyword">final</span> Drawable frame;</span><br><span class="line">         <span class="keyword">if</span> (mFrameResource != <span class="number">0</span>) &#123;</span><br><span class="line">             frame = getContext().getDrawable(mFrameResource);</span><br><span class="line">         &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">             frame = <span class="keyword">null</span>;</span><br><span class="line">         &#125;</span><br><span class="line">         <span class="comment">//【--&gt;6.5】设置 window Frame，最终会触发 drawableChanged 方法；</span></span><br><span class="line">         mDecor.setWindowFrame(frame);</span><br><span class="line"></span><br><span class="line">         mDecor.setElevation(mElevation);</span><br><span class="line">         mDecor.setClipToOutline(mClipToOutline);</span><br><span class="line"></span><br><span class="line">         <span class="keyword">if</span> (mTitle != <span class="keyword">null</span>) &#123;</span><br><span class="line">             setTitle(mTitle);</span><br><span class="line">         &#125;</span><br><span class="line"></span><br><span class="line">         <span class="keyword">if</span> (mTitleColor == <span class="number">0</span>) &#123;</span><br><span class="line">             mTitleColor = mTextColor;</span><br><span class="line">         &#125;</span><br><span class="line">         setTitleColor(mTitleColor);</span><br><span class="line">     &#125;</span><br><span class="line"></span><br><span class="line">     <span class="comment">//【--&gt;6.3】此时，DecorView 中的 root view 已经加载完了</span></span><br><span class="line">     <span class="comment">// 包括背景，标题什么都已经设置完成了，这里会结束 changing，触发 drawableChanged 方法；</span></span><br><span class="line">     mDecor.finishChanging();</span><br><span class="line"></span><br><span class="line">     <span class="keyword">return</span> contentParent;</span><br><span class="line"> &#125;</span><br></pre></td></tr></table></figure>
<p>这里大家对下面的计算可能摸不着头脑：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">setFlags(FLAG_FULLSCREEN, FLAG_FULLSCREEN &amp; (~getForcedWindowFlags()));</span><br></pre></td></tr></table></figure>
<p>分情况下：</p>
<ul>
<li>如果 getForcedWindowFlags() 没有设置 FLAG_FULLSCREEN，那么 FLAG_FULLSCREEN &amp; (~getForcedWindowFlags()) 为 FLAG_FULLSCREEN</li>
<li>如果 getForcedWindowFlags() 设置了 FLAG_FULLSCREEN，那么 FLAG_FULLSCREEN &amp; (~getForcedWindowFlags()) 为 0；</li>
</ul>
<p>然后大家可以分析 setLayout 方法是如何处理的了；</p>
<p>其实，整个过程：</p>
<ul>
<li>第一个阶段，是在处理 window 的 theme 和 flags，因为这些设置会影响 window 的特性；</li>
<li>第二个阶段，是选择 root 布局，并加载到 DecorView；</li>
</ul>
<h4 id="4-2-2-1-requestFeature"><a href="#4-2-2-1-requestFeature" class="headerlink" title="4.2.2.1 requestFeature"></a>4.2.2.1 requestFeature</h4><p>应用窗口特性：</p>
<ul>
<li>参数 <strong>featureId</strong> 是特性的 <strong>id</strong>，需要将其转为对应的二进制序列：<strong>(1 &lt;&lt; featureId)</strong>；</li>
</ul>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">boolean</span> <span class="title">requestFeature</span><span class="params">(<span class="keyword">int</span> featureId)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">if</span> (mContentParentExplicitlySet) &#123;</span><br><span class="line">        <span class="keyword">throw</span> <span class="keyword">new</span> AndroidRuntimeException(<span class="string">"requestFeature() must be called before adding content"</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">//【1】获取默认的 feture！，getFeatures 返回的是 window.mFeatures，这就不再分析了；</span></span><br><span class="line">    <span class="keyword">final</span> <span class="keyword">int</span> features = getFeatures();</span><br><span class="line">    <span class="comment">//【2】设置新的 feature；</span></span><br><span class="line">    <span class="keyword">final</span> <span class="keyword">int</span> newFeatures = features | (<span class="number">1</span> &lt;&lt; featureId);</span><br><span class="line">    <span class="comment">//【3】然后做一些冲突判断；</span></span><br><span class="line">    <span class="keyword">if</span> ((newFeatures &amp; (<span class="number">1</span> &lt;&lt; FEATURE_CUSTOM_TITLE)) != <span class="number">0</span> &amp;&amp;</span><br><span class="line">            (newFeatures &amp; ~CUSTOM_TITLE_COMPATIBLE_FEATURES) != <span class="number">0</span>) &#123;</span><br><span class="line">        <span class="comment">//【3.1】如果设置了 FEATURE_CUSTOM_TITLE ，那么是不能设置其他和 title 类型不兼容的 feature 的！</span></span><br><span class="line">        <span class="keyword">throw</span> <span class="keyword">new</span> AndroidRuntimeException(</span><br><span class="line">                <span class="string">"You cannot combine custom titles with other title features"</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span> ((features &amp; (<span class="number">1</span> &lt;&lt; FEATURE_NO_TITLE)) != <span class="number">0</span> &amp;&amp; featureId == FEATURE_ACTION_BAR) &#123;</span><br><span class="line">        <span class="comment">//【3.2】如果要设置的是 action bar，然而 feature 已经设置了 no title，设置失败！</span></span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">false</span>; </span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span> ((features &amp; (<span class="number">1</span> &lt;&lt; FEATURE_ACTION_BAR)) != <span class="number">0</span> &amp;&amp; featureId == FEATURE_NO_TITLE) &#123;</span><br><span class="line">        <span class="comment">//【3.3】如果要设置的是 no title，然而 feature 已经设置了 actionbar，那就要去掉 actionbar；</span></span><br><span class="line">        removeFeature(FEATURE_ACTION_BAR);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> ((features &amp; (<span class="number">1</span> &lt;&lt; FEATURE_ACTION_BAR)) != <span class="number">0</span> &amp;&amp; featureId == FEATURE_SWIPE_TO_DISMISS) &#123;</span><br><span class="line">        <span class="comment">//【3.4】如果要设置的是右滑退出（swipe to dismiss），但是 feature 已经有 action bar 了</span></span><br><span class="line">        <span class="comment">// 这里会产生冲突；</span></span><br><span class="line">        <span class="keyword">throw</span> <span class="keyword">new</span> AndroidRuntimeException(</span><br><span class="line">                <span class="string">"You cannot combine swipe dismissal and the action bar."</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span> ((features &amp; (<span class="number">1</span> &lt;&lt; FEATURE_SWIPE_TO_DISMISS)) != <span class="number">0</span> &amp;&amp; featureId == FEATURE_ACTION_BAR) &#123;</span><br><span class="line">        <span class="comment">//【3.5】如果要设置的是 action bar ，但是 feature 已经有 右滑退出（swipe to dismiss）了</span></span><br><span class="line">        <span class="comment">// 冲突！！</span></span><br><span class="line">        <span class="keyword">throw</span> <span class="keyword">new</span> AndroidRuntimeException(</span><br><span class="line">                <span class="string">"You cannot combine swipe dismissal and the action bar."</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (featureId == FEATURE_INDETERMINATE_PROGRESS &amp;&amp;</span><br><span class="line">            getContext().getPackageManager().hasSystemFeature(PackageManager.FEATURE_WATCH)) &#123;</span><br><span class="line">        <span class="comment">//【3.6】如果要设置的是 不确定的进度 特性，且此时平台是 watch，那就会抛出异常；</span></span><br><span class="line">        <span class="keyword">throw</span> <span class="keyword">new</span> AndroidRuntimeException(<span class="string">"You cannot use indeterminate progress on a watch."</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">//【4】设置新的 feature 位到 mFeatures 和 mLocalFeatures！</span></span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">super</span>.requestFeature(featureId);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>这里就不再继续分析了～～</p>
<ul>
<li>下面是默认特性（DEFAULT_FEATURES）、和 CUSTOM_TITLE 特性兼容的特性的定义！</li>
</ul>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// --&gt; Window.java</span></span><br><span class="line"><span class="meta">@Deprecated</span></span><br><span class="line"><span class="meta">@SuppressWarnings</span>(&#123;<span class="string">"PointlessBitwiseExpression"</span>&#125;)</span><br><span class="line"><span class="keyword">protected</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="keyword">int</span> DEFAULT_FEATURES = (<span class="number">1</span> &lt;&lt; FEATURE_OPTIONS_PANEL) |</span><br><span class="line">    (<span class="number">1</span> &lt;&lt; FEATURE_CONTEXT_MENU);</span><br><span class="line"></span><br><span class="line"><span class="comment">// --&gt; PhoneWindow.java</span></span><br><span class="line"><span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="keyword">int</span> CUSTOM_TITLE_COMPATIBLE_FEATURES = DEFAULT_FEATURES |</span><br><span class="line">            (<span class="number">1</span> &lt;&lt; FEATURE_CUSTOM_TITLE) |</span><br><span class="line">            (<span class="number">1</span> &lt;&lt; FEATURE_CONTENT_TRANSITIONS) |</span><br><span class="line">            (<span class="number">1</span> &lt;&lt; FEATURE_ACTIVITY_TRANSITIONS) |</span><br><span class="line">            (<span class="number">1</span> &lt;&lt; FEATURE_ACTION_MODE_OVERLAY);</span><br></pre></td></tr></table></figure>
<p>关于上面的特性具体的意思，这里不在详细分析。</p>
<h4 id="4-2-2-2-Root-布局分析"><a href="#4-2-2-2-Root-布局分析" class="headerlink" title="4.2.2.2 Root 布局分析"></a>4.2.2.2 Root 布局分析</h4><p>上面的 xml 文件位于 frameworks/base/core/res/res/layout 下，我们选择几个来看看：</p>
<h5 id="4-2-2-2-1-默认布局（不使用-feature）"><a href="#4-2-2-2-1-默认布局（不使用-feature）" class="headerlink" title="4.2.2.2.1 默认布局（不使用 feature）"></a>4.2.2.2.1 默认布局（不使用 feature）</h5><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">LinearLayout</span> <span class="attr">xmlns:android</span>=<span class="string">"http://schemas.android.com/apk/res/android"</span></span></span><br><span class="line"><span class="tag">    <span class="attr">android:layout_width</span>=<span class="string">"match_parent"</span></span></span><br><span class="line"><span class="tag">    <span class="attr">android:layout_height</span>=<span class="string">"match_parent"</span></span></span><br><span class="line"><span class="tag">    <span class="attr">android:fitsSystemWindows</span>=<span class="string">"true"</span></span></span><br><span class="line"><span class="tag">    <span class="attr">android:orientation</span>=<span class="string">"vertical"</span>&gt;</span></span><br><span class="line">    <span class="comment">&lt;!--action bar--&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">ViewStub</span> <span class="attr">android:id</span>=<span class="string">"@+id/action_mode_bar_stub"</span></span></span><br><span class="line"><span class="tag">              <span class="attr">android:inflatedId</span>=<span class="string">"@+id/action_mode_bar"</span></span></span><br><span class="line"><span class="tag">              <span class="attr">android:layout</span>=<span class="string">"@layout/action_mode_bar"</span></span></span><br><span class="line"><span class="tag">              <span class="attr">android:layout_width</span>=<span class="string">"match_parent"</span></span></span><br><span class="line"><span class="tag">              <span class="attr">android:layout_height</span>=<span class="string">"wrap_content"</span></span></span><br><span class="line"><span class="tag">              <span class="attr">android:theme</span>=<span class="string">"?attr/actionBarTheme"</span> /&gt;</span></span><br><span class="line">    <span class="comment">&lt;!--content--&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">FrameLayout</span></span></span><br><span class="line"><span class="tag">         <span class="attr">android:id</span>=<span class="string">"@android:id/content"</span></span></span><br><span class="line"><span class="tag">         <span class="attr">android:layout_width</span>=<span class="string">"match_parent"</span></span></span><br><span class="line"><span class="tag">         <span class="attr">android:layout_height</span>=<span class="string">"match_parent"</span></span></span><br><span class="line"><span class="tag">         <span class="attr">android:foregroundInsidePadding</span>=<span class="string">"false"</span></span></span><br><span class="line"><span class="tag">         <span class="attr">android:foregroundGravity</span>=<span class="string">"fill_horizontal|top"</span></span></span><br><span class="line"><span class="tag">         <span class="attr">android:foreground</span>=<span class="string">"?android:attr/windowContentOverlay"</span> /&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">LinearLayout</span>&gt;</span></span><br></pre></td></tr></table></figure>
<h5 id="4-2-2-2-2-支持滑动退出的布局"><a href="#4-2-2-2-2-支持滑动退出的布局" class="headerlink" title="4.2.2.2.2 支持滑动退出的布局"></a>4.2.2.2.2 支持滑动退出的布局</h5><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">&lt;!--content--&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">com.android.internal.widget.SwipeDismissLayout</span></span></span><br><span class="line"><span class="tag">    <span class="attr">xmlns:android</span>=<span class="string">"http://schemas.android.com/apk/res/android"</span></span></span><br><span class="line"><span class="tag">    <span class="attr">android:id</span>=<span class="string">"@android:id/content"</span></span></span><br><span class="line"><span class="tag">    <span class="attr">android:fitsSystemWindows</span>=<span class="string">"true"</span></span></span><br><span class="line"><span class="tag">    <span class="attr">android:layout_width</span>=<span class="string">"match_parent"</span></span></span><br><span class="line"><span class="tag">    <span class="attr">android:layout_height</span>=<span class="string">"match_parent"</span></span></span><br><span class="line"><span class="tag">    /&gt;</span></span><br></pre></td></tr></table></figure>
<h5 id="4-2-2-2-3-只有一个进度条的布局"><a href="#4-2-2-2-3-只有一个进度条的布局" class="headerlink" title="4.2.2.2.3 只有一个进度条的布局"></a>4.2.2.2.3 只有一个进度条的布局</h5><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">FrameLayout</span> <span class="attr">xmlns:android</span>=<span class="string">"http://schemas.android.com/apk/res/android"</span></span></span><br><span class="line"><span class="tag">    <span class="attr">android:layout_width</span>=<span class="string">"match_parent"</span></span></span><br><span class="line"><span class="tag">    <span class="attr">android:layout_height</span>=<span class="string">"match_parent"</span></span></span><br><span class="line"><span class="tag">    <span class="attr">android:fitsSystemWindows</span>=<span class="string">"true"</span>&gt;</span></span><br><span class="line">    <span class="comment">&lt;!--content--&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">FrameLayout</span></span></span><br><span class="line"><span class="tag">         <span class="attr">android:id</span>=<span class="string">"@android:id/content"</span></span></span><br><span class="line"><span class="tag">         <span class="attr">android:layout_width</span>=<span class="string">"match_parent"</span></span></span><br><span class="line"><span class="tag">         <span class="attr">android:layout_height</span>=<span class="string">"match_parent"</span></span></span><br><span class="line"><span class="tag">         <span class="attr">android:foregroundInsidePadding</span>=<span class="string">"false"</span></span></span><br><span class="line"><span class="tag">         <span class="attr">android:foregroundGravity</span>=<span class="string">"fill_horizontal|top"</span></span></span><br><span class="line"><span class="tag">         <span class="attr">android:foreground</span>=<span class="string">"?android:attr/windowContentOverlay"</span> /&gt;</span></span><br><span class="line">    <span class="comment">&lt;!--action bar--&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">ViewStub</span> <span class="attr">android:id</span>=<span class="string">"@+id/action_mode_bar_stub"</span></span></span><br><span class="line"><span class="tag">              <span class="attr">android:inflatedId</span>=<span class="string">"@+id/action_mode_bar"</span></span></span><br><span class="line"><span class="tag">              <span class="attr">android:layout</span>=<span class="string">"@layout/action_mode_bar"</span></span></span><br><span class="line"><span class="tag">              <span class="attr">android:layout_width</span>=<span class="string">"match_parent"</span></span></span><br><span class="line"><span class="tag">              <span class="attr">android:layout_height</span>=<span class="string">"wrap_content"</span></span></span><br><span class="line"><span class="tag">              <span class="attr">android:theme</span>=<span class="string">"?attr/actionBarTheme"</span> /&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">FrameLayout</span>&gt;</span></span><br></pre></td></tr></table></figure>
<h5 id="4-2-2-2-4-总结"><a href="#4-2-2-2-4-总结" class="headerlink" title="4.2.2.2.4 总结"></a>4.2.2.2.4 总结</h5><p>通过布局的分析，我们可以知道：</p>
<ul>
<li>所有的布局都会有一个 id 为 “@android:id/content” 的 Layout，这个 Layout 就是用来放置我们 setContentView 设置的 content 的；</li>
</ul>
<h2 id="4-2-dispatchWindowAttributesChanged"><a href="#4-2-dispatchWindowAttributesChanged" class="headerlink" title="4.2 dispatchWindowAttributesChanged"></a>4.2 dispatchWindowAttributesChanged</h2><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="function"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title">dispatchWindowAttributesChanged</span><span class="params">(WindowManager.LayoutParams attrs)</span> </span>&#123;</span><br><span class="line">    <span class="comment">//【--&gt;5.6】先调用了父类的 dispatchWindowAttributesChanged 方法</span></span><br><span class="line">    <span class="keyword">super</span>.dispatchWindowAttributesChanged(attrs);</span><br><span class="line">    <span class="keyword">if</span> (mDecor != <span class="keyword">null</span>) &#123;</span><br><span class="line">        mDecor.updateColorViews(<span class="keyword">null</span> <span class="comment">/* insets */</span>, <span class="keyword">true</span> <span class="comment">/* animate */</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h1 id="5-Window"><a href="#5-Window" class="headerlink" title="5 Window"></a>5 Window</h1><p>是一个抽象类，定义了窗口的所有公共操作和属性，phoneWindow 是他的唯一实现类；</p>
<h2 id="5-1-new-Window"><a href="#5-1-new-Window" class="headerlink" title="5.1 new Window"></a>5.1 new Window</h2><p>由于 PhoneWindow 是其唯一的实现类，所以一般只有通过 new PhoneWindow 才能触发父类构造器：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="title">Window</span><span class="params">(Context context)</span> </span>&#123;</span><br><span class="line">    <span class="comment">//【1】就是 activity，不多说了！</span></span><br><span class="line">    mContext = context;</span><br><span class="line">    <span class="comment">//【2】获取默认的 feature！</span></span><br><span class="line">    mFeatures = mLocalFeatures = getDefaultFeatures(context);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>方法很简单，Window 内部也有很多的成员变量，这里我们不一一分析，我们后面会边跟代码，边分析内部的变量！</p>
<p>mFeatures 和 mLocalFeatures 是 window 内部的窗口特性，是一个二进制序列；</p>
<ul>
<li><strong>getDefaultFeatures</strong>：获取默认的 feature 配置，这个方法不太重要，就不单独列出来了！</li>
</ul>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">int</span> <span class="title">getDefaultFeatures</span><span class="params">(Context context)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">int</span> features = <span class="number">0</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">final</span> Resources res = context.getResources();</span><br><span class="line">    <span class="comment">//【1】是否启用 “选项面板” 功能，默认已启用，设置 FEATURE_OPTIONS_PANEL 位；</span></span><br><span class="line">    <span class="keyword">if</span> (res.getBoolean(com.android.internal.R.bool.config_defaultWindowFeatureOptionsPanel)) &#123;</span><br><span class="line">        features |= <span class="number">1</span> &lt;&lt; FEATURE_OPTIONS_PANEL;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (res.getBoolean(com.android.internal.R.bool.config_defaultWindowFeatureContextMenu)) &#123;</span><br><span class="line">        features |= <span class="number">1</span> &lt;&lt; FEATURE_CONTEXT_MENU;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> features;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>这里我们先来看看 Window 内部的几个接口，activity 都实现了这几个接口！</p>
<h3 id="5-1-1-内部接口"><a href="#5-1-1-内部接口" class="headerlink" title="5.1.1 内部接口"></a>5.1.1 内部接口</h3><h4 id="5-1-1-1-Callback"><a href="#5-1-1-1-Callback" class="headerlink" title="5.1.1.1 Callback"></a>5.1.1.1 Callback</h4><p>这个接口用于处理事件的分发，菜单操作，窗口属性变化等事件回调：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment">* API from a Window back to its caller.  This allows the client to</span></span><br><span class="line"><span class="comment">* intercept key dispatching, panels and menus, etc.</span></span><br><span class="line"><span class="comment">*/</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">interface</span> <span class="title">Callback</span> </span>&#123;</span><br><span class="line">    ... ... ...<span class="comment">// 先不关注，接口太多了：</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>下面是其内部的方法，具体实现都在 activity 里面：</p>
<p><img src="pic/ViewDraw-1-setContentView.asserts/View-Callback.png" alt="View-Callback" style="zoom:50%;"></p>
<p>其内部接口很多，我们这里不过多分析！！</p>
<h4 id="5-1-1-2-WindowControllerCallback"><a href="#5-1-1-2-WindowControllerCallback" class="headerlink" title="5.1.1.2 WindowControllerCallback"></a>5.1.1.2 WindowControllerCallback</h4><p>和窗口控制相关的回调接口：比如：退出 FreeForm 模式，进入画中画模式等等；</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/** <span class="doctag">@hide</span> */</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">interface</span> <span class="title">WindowControllerCallback</span> </span>&#123;  </span><br><span class="line">    <span class="comment">// 退出 freeform 模式，（翻译注释）其实就是将 activity 从 freeform stack 移动到 full screen stack</span></span><br><span class="line">    <span class="function"><span class="keyword">void</span> <span class="title">exitFreeformMode</span><span class="params">()</span> <span class="keyword">throws</span> RemoteException</span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 如果 acitivity 支持画中画模式，就进入画中画模式（@see android.R.attr#supportsPictureInPicture）</span></span><br><span class="line">    <span class="function"><span class="keyword">void</span> <span class="title">enterPictureInPictureModeIfPossible</span><span class="params">()</span></span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/** Returns the current stack Id for the window. */</span></span><br><span class="line">    <span class="function"><span class="keyword">int</span> <span class="title">getWindowStackId</span><span class="params">()</span> <span class="keyword">throws</span> RemoteException</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>不多说了！</p>
<h4 id="5-1-1-3-OnWindowDismissedCallback"><a href="#5-1-1-3-OnWindowDismissedCallback" class="headerlink" title="5.1.1.3 OnWindowDismissedCallback"></a>5.1.1.3 OnWindowDismissedCallback</h4><p>window 被销毁触发的回调：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/** <span class="doctag">@hide</span> */</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">interface</span> <span class="title">OnWindowDismissedCallback</span> </span>&#123;</span><br><span class="line">    <span class="comment">// window 被销毁触发，通知 activity finsh 掉自己，参数 finishTask 为 ture 表示同时清理掉所在的 task</span></span><br><span class="line">    <span class="function"><span class="keyword">void</span> <span class="title">onWindowDismissed</span><span class="params">(<span class="keyword">boolean</span> finishTask)</span></span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h2 id="5-2-设置-window-回调"><a href="#5-2-设置-window-回调" class="headerlink" title="5.2 设置 window 回调"></a>5.2 设置 window 回调</h2><p>window 有下面三个成员变量，其实都是所属的 activity，因为 activity 实现了这几个接口；</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">private</span> Callback mCallback;</span><br><span class="line"><span class="keyword">private</span> OnWindowDismissedCallback mOnWindowDismissedCallback;</span><br><span class="line"><span class="keyword">private</span> WindowControllerCallback mWindowControllerCallback;</span><br></pre></td></tr></table></figure>
<p>具体的作用我们后面再分析；</p>
<h3 id="5-2-1-setCallback"><a href="#5-2-1-setCallback" class="headerlink" title="5.2.1 setCallback"></a>5.2.1 setCallback</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">setCallback</span><span class="params">(Callback callback)</span> </span>&#123;</span><br><span class="line">    mCallback = callback;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h3 id="5-2-2-setWindowControllerCallback"><a href="#5-2-2-setWindowControllerCallback" class="headerlink" title="5.2.2 setWindowControllerCallback"></a>5.2.2 setWindowControllerCallback</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/** <span class="doctag">@hide</span> */</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">final</span> <span class="keyword">void</span> <span class="title">setWindowControllerCallback</span><span class="params">(WindowControllerCallback wccb)</span> </span>&#123;</span><br><span class="line">    mWindowControllerCallback = wccb;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h3 id="5-2-3-setOnWindowDismissedCallback"><a href="#5-2-3-setOnWindowDismissedCallback" class="headerlink" title="5.2.3 setOnWindowDismissedCallback"></a>5.2.3 setOnWindowDismissedCallback</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/** <span class="doctag">@hide</span> */</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">final</span> <span class="keyword">void</span> <span class="title">setOnWindowDismissedCallback</span><span class="params">(OnWindowDismissedCallback dcb)</span> </span>&#123;</span><br><span class="line">    mOnWindowDismissedCallback = dcb;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h2 id="5-3-getAttributes"><a href="#5-3-getAttributes" class="headerlink" title="5.3 getAttributes"></a>5.3 getAttributes</h2><p>获得当前的 activity 的 window 布局属性：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">final</span> WindowManager.<span class="function">LayoutParams <span class="title">getAttributes</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    <span class="keyword">return</span> mWindowAttributes;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>这里的 mWindowAttributes 是抽象类 Window 的内部属性，表示当前 window 的布局属性：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// --&gt; Window.java</span></span><br><span class="line"><span class="keyword">private</span> <span class="keyword">final</span> WindowManager.LayoutParams mWindowAttributes =</span><br><span class="line">        <span class="keyword">new</span> WindowManager.LayoutParams();</span><br></pre></td></tr></table></figure>
<p>不多说了！</p>
<h2 id="5-4-setLayout"><a href="#5-4-setLayout" class="headerlink" title="5.4 setLayout"></a>5.4 setLayout</h2><p>设置布局属性：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">setLayout</span><span class="params">(<span class="keyword">int</span> width, <span class="keyword">int</span> height)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">final</span> WindowManager.LayoutParams attrs = getAttributes();</span><br><span class="line">    attrs.width = width;</span><br><span class="line">    attrs.height = height;</span><br><span class="line">    <span class="comment">//【--&gt;4.2】分发 window 布局属性改变的消息；</span></span><br><span class="line">    dispatchWindowAttributesChanged(attrs);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>这个方法用于设置 window 的 width/height 布局属性，默认是 MATCH_PARENT，表示的是全屏的 window！！！</p>
<p>如果是 WRAP_CONTENT 的话，那就不是全屏（full-screen）的  window！！</p>
<p><strong>dispatchWindowAttributesChanged</strong> 方法，其子类 <strong>PhoneWindow</strong> 覆写了该方法！！</p>
<h2 id="5-5-setFlags"><a href="#5-5-setFlags" class="headerlink" title="5.5 setFlags"></a>5.5 setFlags</h2><p>用于设置窗口的 flags 位：</p>
<ul>
<li>int flags：表示新的 flags 位；</li>
<li>int mask：要修改的窗口标志位；</li>
</ul>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">setFlags</span><span class="params">(<span class="keyword">int</span> flags, <span class="keyword">int</span> mask)</span> </span>&#123;</span><br><span class="line">    <span class="comment">//【--&gt; 5.3】返回 window 的布局属性：</span></span><br><span class="line">    <span class="keyword">final</span> WindowManager.LayoutParams attrs = getAttributes();</span><br><span class="line">    <span class="comment">//【1】这里先是从 attrs.flags 中去掉 mask 中的标志，然后再加上了 flags 和 mask 相同的标志；</span></span><br><span class="line">    attrs.flags = (attrs.flags&amp;~mask) | (flags&amp;mask);</span><br><span class="line">    mForcedWindowFlags |= mask;</span><br><span class="line">    <span class="comment">//【--&gt;4.x】分发 window 布局属性改变的消息；</span></span><br><span class="line">    dispatchWindowAttributesChanged(attrs);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>我们看到，其实最终生效的 flags，是保存在 WindowManager.LayoutParams 中！</p>
<p>这里的 mForcedWindowFlags 用来保存：应用程序显式设置的 flags 标志位，默认值为 0；</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">private</span> <span class="keyword">int</span> mForcedWindowFlags = <span class="number">0</span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 该方法用于返回 mForcedWindowFlags；</span></span><br><span class="line"><span class="function"><span class="keyword">protected</span> <span class="keyword">final</span> <span class="keyword">int</span> <span class="title">getForcedWindowFlags</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    <span class="keyword">return</span> mForcedWindowFlags;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<ul>
<li>addFlags：增加一个标志位！</li>
</ul>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">addFlags</span><span class="params">(<span class="keyword">int</span> flags)</span> </span>&#123;</span><br><span class="line">    setFlags(flags, flags);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<ul>
<li>clearFlags：去掉一个标志位！</li>
</ul>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">clearFlags</span><span class="params">(<span class="keyword">int</span> flags)</span> </span>&#123;</span><br><span class="line">    setFlags(<span class="number">0</span>, flags);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h2 id="5-6-dispatchWindowAttributesChanged"><a href="#5-6-dispatchWindowAttributesChanged" class="headerlink" title="5.6 dispatchWindowAttributesChanged"></a>5.6 dispatchWindowAttributesChanged</h2><p>分发窗口属性变化的消息：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title">dispatchWindowAttributesChanged</span><span class="params">(WindowManager.LayoutParams attrs)</span> </span>&#123;</span><br><span class="line">    <span class="comment">//【1】这里的 mCallback 就是 activity；</span></span><br><span class="line">    <span class="keyword">if</span> (mCallback != <span class="keyword">null</span>) &#123;</span><br><span class="line">        <span class="comment">//【--&gt;3.2】回调 mCallback 的 onWindowAttributesChanged 方法：</span></span><br><span class="line">        mCallback.onWindowAttributesChanged(attrs);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>回调通知，不多说。</p>
<h1 id="6-DecorView"><a href="#6-DecorView" class="headerlink" title="6 DecorView"></a>6 DecorView</h1><p>可以看到 DecorView 本质上是一个 FrameLayout！</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/** <span class="doctag">@hide</span> */</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">DecorView</span> <span class="keyword">extends</span> <span class="title">FrameLayout</span> <span class="keyword">implements</span> <span class="title">RootViewSurfaceTaker</span>, <span class="title">WindowCallbacks</span> </span>&#123;</span><br><span class="line">    ... ... ...</span><br><span class="line">    <span class="comment">//【1】表示所属的 PhoneWindow；</span></span><br><span class="line">    <span class="keyword">private</span> PhoneWindow mWindow;</span><br><span class="line">    <span class="comment">//【2】我们通过 setContentView 设置的布局 view；</span></span><br><span class="line">    ViewGroup mContentRoot;</span><br><span class="line">    ... ... ...    </span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>同时他也实现了 RootViewSurfaceTaker 和 WindowCallbacks 接口！</p>
<p>当然，对于 DecorView 其内部成员也很多，这里也就不一一分析。。。</p>
<h2 id="6-1-new-DecorView"><a href="#6-1-new-DecorView" class="headerlink" title="6.1 new DecorView"></a>6.1 new DecorView</h2><p>我们来看看创建 DecorView 实例：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line">DecorView(Context context, <span class="keyword">int</span> featureId, PhoneWindow window,</span><br><span class="line">        WindowManager.LayoutParams params) &#123;</span><br><span class="line">    <span class="keyword">super</span>(context);</span><br><span class="line">    <span class="comment">//【1】用于指定 window 的类型，-1 表示是 activity 的 window； </span></span><br><span class="line">    mFeatureId = featureId;</span><br><span class="line">    <span class="comment">//【2】这一些是和系统特性，动画相关的一些成员，我们不关注；</span></span><br><span class="line">    mShowInterpolator = AnimationUtils.loadInterpolator(context,</span><br><span class="line">            android.R.interpolator.linear_out_slow_in);</span><br><span class="line">    mHideInterpolator = AnimationUtils.loadInterpolator(context,</span><br><span class="line">            android.R.interpolator.fast_out_linear_in);</span><br><span class="line"></span><br><span class="line">    mBarEnterExitDuration = context.getResources().getInteger(</span><br><span class="line">            R.integer.dock_enter_exit_duration);</span><br><span class="line">    mForceWindowDrawsStatusBarBackground = context.getResources().getBoolean(</span><br><span class="line">            R.bool.config_forceWindowDrawsStatusBarBackground)</span><br><span class="line">            &amp;&amp; context.getApplicationInfo().targetSdkVersion &gt;= N;</span><br><span class="line">    mSemiTransparentStatusBarColor = context.getResources().getColor(</span><br><span class="line">            R.color.system_bar_background_semi_transparent, <span class="keyword">null</span> <span class="comment">/* theme */</span>);</span><br><span class="line"> </span><br><span class="line">    <span class="comment">//【3】读取可用的屏幕宽度；</span></span><br><span class="line">    updateAvailableWidth();</span><br><span class="line">    <span class="comment">//【--&gt;6.2】设置所属 window；</span></span><br><span class="line">    setWindow(window);</span><br><span class="line"></span><br><span class="line">    updateLogTag(params);</span><br><span class="line"></span><br><span class="line">    mResizeShadowSize = context.getResources().getDimensionPixelSize(</span><br><span class="line">            R.dimen.resize_shadow_size);</span><br><span class="line">    initResizingPaints();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>这个 mFeatureId 是 DecorView 的成员：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/** The feature ID of the panel, or -1 if this is the application's DecorView */</span></span><br><span class="line"><span class="keyword">private</span> <span class="keyword">final</span> <span class="keyword">int</span> mFeatureId;</span><br></pre></td></tr></table></figure>
<h2 id="6-2-setWindow"><a href="#6-2-setWindow" class="headerlink" title="6.2 setWindow"></a>6.2 setWindow</h2><p>将 PhoneWindow 和 Context 的实例保存到 DecorView 中；</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">setWindow</span><span class="params">(PhoneWindow phoneWindow)</span> </span>&#123;</span><br><span class="line">    <span class="comment">//【1】保存 PhoneWindow ，Context 的实例到内部成员变量中；</span></span><br><span class="line">    mWindow = phoneWindow;</span><br><span class="line">    Context context = getContext();</span><br><span class="line">    <span class="comment">//【2】如果 Context 是 DecorContext 的实例，那么 DecorContext 也会持有 PhoneWindow 的引用；</span></span><br><span class="line">    <span class="keyword">if</span> (context <span class="keyword">instanceof</span> DecorContext) &#123;</span><br><span class="line">        DecorContext decorContext = (DecorContext) context;</span><br><span class="line">        decorContext.setPhoneWindow(mWindow);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>不多说了！</p>
<h2 id="6-3-startChanging-finishChanging"><a href="#6-3-startChanging-finishChanging" class="headerlink" title="6.3 startChanging / finishChanging"></a>6.3 startChanging / finishChanging</h2><p>用于（结束）标记 DecorView 正在加载：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">startChanging</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    mChanging = <span class="keyword">true</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">finishChanging</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    mChanging = <span class="keyword">false</span>;</span><br><span class="line">    <span class="comment">//【--&gt;6.5】可绘制的区域发生的变化；</span></span><br><span class="line">    drawableChanged();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h2 id="6-4-onResourcesLoaded"><a href="#6-4-onResourcesLoaded" class="headerlink" title="6.4 onResourcesLoaded"></a>6.4 onResourcesLoaded</h2><p>加载布局资源：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">onResourcesLoaded</span><span class="params">(LayoutInflater inflater, <span class="keyword">int</span> layoutResource)</span> </span>&#123;</span><br><span class="line">    <span class="comment">//【1】获取当前 window 所在的 stack！</span></span><br><span class="line">    mStackId = getStackId();</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (mBackdropFrameRenderer != <span class="keyword">null</span>) &#123;</span><br><span class="line">        loadBackgroundDrawablesIfNeeded();</span><br><span class="line">        mBackdropFrameRenderer.onResourcesLoaded(</span><br><span class="line">                <span class="keyword">this</span>, mResizingBackgroundDrawable, mCaptionBackgroundDrawable,</span><br><span class="line">                mUserCaptionBackgroundDrawable, getCurrentColor(mStatusColorViewState),</span><br><span class="line">                getCurrentColor(mNavigationColorViewState));</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">//【2】创建一个 DecorCaptionView，类似于是一个中间层的封装；</span></span><br><span class="line">    mDecorCaptionView = createDecorCaptionView(inflater);</span><br><span class="line">    <span class="comment">//【3】通过 LayoutInflater 加载 layoutResource 对应的布局文件！</span></span><br><span class="line">    <span class="keyword">final</span> View root = inflater.inflate(layoutResource, <span class="keyword">null</span>);</span><br><span class="line">    <span class="keyword">if</span> (mDecorCaptionView != <span class="keyword">null</span>) &#123;</span><br><span class="line">        <span class="comment">//【4】如果 mDecorCaptionView 不为 null，那么会先将 mDecorCaptionView 加入到  DecorView 中；</span></span><br><span class="line">        <span class="comment">// 最后将 root 加入到 mDecorCaptionView 中；</span></span><br><span class="line">        <span class="keyword">if</span> (mDecorCaptionView.getParent() == <span class="keyword">null</span>) &#123;</span><br><span class="line">            addView(mDecorCaptionView,</span><br><span class="line">                    <span class="keyword">new</span> ViewGroup.LayoutParams(MATCH_PARENT, MATCH_PARENT));</span><br><span class="line">        &#125;</span><br><span class="line">        mDecorCaptionView.addView(root,</span><br><span class="line">                <span class="keyword">new</span> ViewGroup.MarginLayoutParams(MATCH_PARENT, MATCH_PARENT));</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// Put it below the color views.</span></span><br><span class="line">        addView(root, <span class="number">0</span>, <span class="keyword">new</span> ViewGroup.LayoutParams(MATCH_PARENT, MATCH_PARENT));</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">//【4】设置 content root view！</span></span><br><span class="line">    mContentRoot = (ViewGroup) root;</span><br><span class="line">    initializeElevation();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>可以看到：</p>
<ul>
<li>主要流程就是加载 layoutResource 对应的布局文件（content root），加载的 view 会保存到 DecorView.mContentRoot 中；</li>
<li>然后通过 addView 将 content root 其加载到 DecorView 中去；</li>
</ul>
<p>我们去看看 ViewGroup 的 addView 方法，可以看到也调用了 requestLayout() 和 invalidate(true) 方法！</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">addView</span><span class="params">(View child, <span class="keyword">int</span> index, LayoutParams params)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">if</span> (DBG) &#123;</span><br><span class="line">        System.out.println(<span class="keyword">this</span> + <span class="string">" addView"</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (child == <span class="keyword">null</span>) &#123;</span><br><span class="line">        <span class="keyword">throw</span> <span class="keyword">new</span> IllegalArgumentException(<span class="string">"Cannot add a null child view to a ViewGroup"</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//【1】请求布局操作；</span></span><br><span class="line">    requestLayout();</span><br><span class="line">    <span class="comment">//【2】重绘；</span></span><br><span class="line">    invalidate(<span class="keyword">true</span>);</span><br><span class="line">    <span class="comment">//【3】会调用 child.requestLayout() 方法，因为设置了新的布局参数；</span></span><br><span class="line">    <span class="comment">// 必须要等到 DecorView 的 requestLayout 执行完成后才会执行；</span></span><br><span class="line">    addViewInner(child, index, params, <span class="keyword">false</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>这里虽然调用了 requestLayout 和 invalidate 实际上并没有开始布局和绘制，原因是 ViewRootImpl 还没有创建；</p>
<h2 id="6-5-setWindowBackground-setWindowFrame"><a href="#6-5-setWindowBackground-setWindowFrame" class="headerlink" title="6.5 setWindowBackground / setWindowFrame"></a>6.5 setWindowBackground / setWindowFrame</h2><p>设置 window 背景和 frame：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">setWindowBackground</span><span class="params">(Drawable drawable)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">if</span> (getBackground() != drawable) &#123;</span><br><span class="line">        setBackgroundDrawable(drawable);</span><br><span class="line">        <span class="keyword">if</span> (drawable != <span class="keyword">null</span>) &#123;</span><br><span class="line">            mResizingBackgroundDrawable = enforceNonTranslucentBackground(drawable,</span><br><span class="line">                    mWindow.isTranslucent() || mWindow.isShowingWallpaper());</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            mResizingBackgroundDrawable = getResizingBackgroundDrawable(</span><br><span class="line">                    getContext(), <span class="number">0</span>, mWindow.mBackgroundFallbackResource,</span><br><span class="line">                    mWindow.isTranslucent() || mWindow.isShowingWallpaper());</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">if</span> (mResizingBackgroundDrawable != <span class="keyword">null</span>) &#123;</span><br><span class="line">            mResizingBackgroundDrawable.getPadding(mBackgroundPadding);</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            mBackgroundPadding.setEmpty();</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">//【--&gt;6.6】可绘制的区域发生的变化</span></span><br><span class="line">        drawableChanged();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">setWindowFrame</span><span class="params">(Drawable drawable)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">if</span> (getForeground() != drawable) &#123;</span><br><span class="line">        setForeground(drawable);</span><br><span class="line">        <span class="keyword">if</span> (drawable != <span class="keyword">null</span>) &#123;</span><br><span class="line">            drawable.getPadding(mFramePadding);</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            mFramePadding.setEmpty();</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">//【--&gt;6.6】可绘制的区域发生的变化</span></span><br><span class="line">        drawableChanged();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>可以看到，这里都调用了 drawableChanged 方法：</p>
<h2 id="6-6-drawableChanged"><a href="#6-6-drawableChanged" class="headerlink" title="6.6 drawableChanged"></a>6.6 drawableChanged</h2><p>可绘制的区域发生的变化，实际上就是 window 的属性发生了变化：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">drawableChanged</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    <span class="keyword">if</span> (mChanging) &#123;</span><br><span class="line">        <span class="keyword">return</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">//【1】设置内容的 padding 距离；</span></span><br><span class="line">    setPadding(mFramePadding.left + mBackgroundPadding.left,</span><br><span class="line">            mFramePadding.top + mBackgroundPadding.top,</span><br><span class="line">            mFramePadding.right + mBackgroundPadding.right,</span><br><span class="line">            mFramePadding.bottom + mBackgroundPadding.bottom);</span><br><span class="line">    <span class="comment">//【2】请求布局；</span></span><br><span class="line">    requestLayout();</span><br><span class="line">    <span class="comment">//【3】触发绘制；</span></span><br><span class="line">    invalidate();</span><br><span class="line"></span><br><span class="line">    <span class="comment">//【4】根据 PixelFormat 类型设置窗口的默认格式，这里我们先不看；</span></span><br><span class="line">    <span class="keyword">int</span> opacity = PixelFormat.OPAQUE;</span><br><span class="line">    <span class="keyword">if</span> (StackId.hasWindowShadow(mStackId)) &#123;</span><br><span class="line">        <span class="comment">// If the window has a shadow, it must be translucent.</span></span><br><span class="line">        opacity = PixelFormat.TRANSLUCENT;</span><br><span class="line">    &#125; <span class="keyword">else</span>&#123;</span><br><span class="line">        <span class="comment">// Note: If there is no background, we will assume opaque. The</span></span><br><span class="line">        <span class="comment">// common case seems to be that an application sets there to be</span></span><br><span class="line">        <span class="comment">// no background so it can draw everything itself. For that,</span></span><br><span class="line">        <span class="comment">// we would like to assume OPAQUE and let the app force it to</span></span><br><span class="line">        <span class="comment">// the slower TRANSLUCENT mode if that is really what it wants.</span></span><br><span class="line">        Drawable bg = getBackground();</span><br><span class="line">        Drawable fg = getForeground();</span><br><span class="line">        <span class="keyword">if</span> (bg != <span class="keyword">null</span>) &#123;</span><br><span class="line">            <span class="keyword">if</span> (fg == <span class="keyword">null</span>) &#123;</span><br><span class="line">                opacity = bg.getOpacity();</span><br><span class="line">            &#125; <span class="keyword">else</span> <span class="keyword">if</span> (mFramePadding.left &lt;= <span class="number">0</span> &amp;&amp; mFramePadding.top &lt;= <span class="number">0</span></span><br><span class="line">                    &amp;&amp; mFramePadding.right &lt;= <span class="number">0</span> &amp;&amp; mFramePadding.bottom &lt;= <span class="number">0</span>) &#123;</span><br><span class="line">                <span class="comment">// If the frame padding is zero, then we can be opaque</span></span><br><span class="line">                <span class="comment">// if either the frame -or- the background is opaque.</span></span><br><span class="line">                <span class="keyword">int</span> fop = fg.getOpacity();</span><br><span class="line">                <span class="keyword">int</span> bop = bg.getOpacity();</span><br><span class="line">                <span class="keyword">if</span> (<span class="keyword">false</span>)</span><br><span class="line">                    Log.v(mLogTag, <span class="string">"Background opacity: "</span> + bop + <span class="string">", Frame opacity: "</span> + fop);</span><br><span class="line">                <span class="keyword">if</span> (fop == PixelFormat.OPAQUE || bop == PixelFormat.OPAQUE) &#123;</span><br><span class="line">                    opacity = PixelFormat.OPAQUE;</span><br><span class="line">                &#125; <span class="keyword">else</span> <span class="keyword">if</span> (fop == PixelFormat.UNKNOWN) &#123;</span><br><span class="line">                    opacity = bop;</span><br><span class="line">                &#125; <span class="keyword">else</span> <span class="keyword">if</span> (bop == PixelFormat.UNKNOWN) &#123;</span><br><span class="line">                    opacity = fop;</span><br><span class="line">                &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                    opacity = Drawable.resolveOpacity(fop, bop);</span><br><span class="line">                &#125;</span><br><span class="line">            &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                <span class="comment">// For now we have to assume translucent if there is a</span></span><br><span class="line">                <span class="comment">// frame with padding... there is no way to tell if the</span></span><br><span class="line">                <span class="comment">// frame and background together will draw all pixels.</span></span><br><span class="line">                <span class="keyword">if</span> (<span class="keyword">false</span>)</span><br><span class="line">                    Log.v(mLogTag, <span class="string">"Padding: "</span> + mFramePadding);</span><br><span class="line">                opacity = PixelFormat.TRANSLUCENT;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">if</span> (<span class="keyword">false</span>)</span><br><span class="line">            Log.v(mLogTag, <span class="string">"Background: "</span> + bg + <span class="string">", Frame: "</span> + fg);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (<span class="keyword">false</span>)</span><br><span class="line">        Log.v(mLogTag, <span class="string">"Selected default opacity: "</span> + opacity);</span><br><span class="line"></span><br><span class="line">    mDefaultOpacity = opacity;</span><br><span class="line">    <span class="keyword">if</span> (mFeatureId &lt; <span class="number">0</span>) &#123;</span><br><span class="line">        mWindow.setDefaultWindowFormat(opacity);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>这里核心的代码就是：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//【1】设置内容的 padding 距离；</span></span><br><span class="line">setPadding(mFramePadding.left + mBackgroundPadding.left,</span><br><span class="line">mFramePadding.top + mBackgroundPadding.top,</span><br><span class="line">mFramePadding.right + mBackgroundPadding.right,</span><br><span class="line">mFramePadding.bottom + mBackgroundPadding.bottom);</span><br><span class="line"></span><br><span class="line"><span class="comment">//【2】请求布局；</span></span><br><span class="line">requestLayout();</span><br><span class="line"><span class="comment">//【3】触发绘制；</span></span><br><span class="line">invalidate();</span><br></pre></td></tr></table></figure>
<p>这里就不再继续跟踪了，requestLayout 和 invalidate 后面再分析。</p>
<h1 id="7-总结"><a href="#7-总结" class="headerlink" title="7 总结"></a>7 总结</h1><p>我们来看下整个的流程吧：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><span class="line">ActivityThread -&gt; ActivityThread : 1.handleLaunchActivity</span><br><span class="line">ActivityThread -&gt; WindowManagerGlobal : 2.initialize（初始化 wmg 进程单例）</span><br><span class="line"></span><br><span class="line">ActivityThread -&gt; ActivityThread : 3.performLaunchActivity</span><br><span class="line">ActivityThread -&gt; Activity : 4.attach（开始绑定）</span><br><span class="line"></span><br><span class="line">Activity -&gt; PhoneWindow: 5.new PhoneWindow（创建 PhoneWindow 实例）</span><br><span class="line">PhoneWindow --&gt; Activity: 5.return mWindow: PhoneWindow</span><br><span class="line"></span><br><span class="line">Activity -&gt; PhoneWindow: 6.setWindowControllerCallback（设置回调）</span><br><span class="line">Activity -&gt; PhoneWindow: 7.setCallback</span><br><span class="line">Activity -&gt; PhoneWindow: 8.setOnWindowDismissedCallback</span><br><span class="line"></span><br><span class="line">Activity -&gt; PhoneWindow: 9.setWindowManager</span><br><span class="line"></span><br><span class="line">Activity -&gt; PhoneWindow: 10.getWindowManager</span><br><span class="line">PhoneWindow --&gt; Activity: 10.return WindowManagerImpl</span><br><span class="line"></span><br><span class="line">ActivityThread -&gt; Activity: 11.OnCreate</span><br><span class="line">Activity -&gt; Activity: 12.setContentView (设置 layout 布局资源)</span><br><span class="line">Activity -&gt; Activity: 13.getWindow</span><br><span class="line">Activity -&gt; PhoneWindow: 14.setContentView</span><br><span class="line"></span><br><span class="line">PhoneWindow -&gt; PhoneWindow: 15.installDecor</span><br><span class="line">PhoneWindow -&gt; PhoneWindow: 16.generateDecor</span><br><span class="line"></span><br><span class="line">PhoneWindow -&gt; DecorView: 17.new DecorView</span><br><span class="line">DecorView --&gt; PhoneWindow: 18.return DecorView</span><br><span class="line"></span><br><span class="line">DecorView -&gt; DecorView: 19.setWindow (设置 PhoneWindow)</span><br><span class="line">PhoneWindow -&gt; PhoneWindow: 20.generateLayout(加载布局文件) onResourcesLoaded</span><br><span class="line">PhoneWindow -&gt; DecorView: 21.onResourcesLoaded（该方法通过 LayoutInflater 加载布局，addView）</span><br></pre></td></tr></table></figure>
<p>我画出了整个的流程图，可以发现，其实逻辑不是很复杂；</p>
<h1 id="8-拓展分析"><a href="#8-拓展分析" class="headerlink" title="8 拓展分析"></a>8 拓展分析</h1><h2 id="8-1-requestFeature"><a href="#8-1-requestFeature" class="headerlink" title="8.1 requestFeature"></a>8.1 requestFeature</h2><p>前面我们分析了 window feature 的概念，其实我们也可以动态设置 feature，比如我们在自己的代码中这样：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">getWindow().requestFeature(..)</span><br></pre></td></tr></table></figure>
<p>这是通过 PhoneWindow 提供的如下方法来设置的：</p>
<p>注意：</p>
<ul>
<li>这个方法一定要在 setContentView 之前调用，可以调用多次！</li>
<li>一旦设置了 feature，那就不能关闭；</li>
<li>FEATURE_CUSTOM_TITLE 不能和其他的 title feature 一起使用；</li>
</ul>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">boolean</span> <span class="title">requestFeature</span><span class="params">(<span class="keyword">int</span> featureId)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">final</span> <span class="keyword">int</span> flag = <span class="number">1</span>&lt;&lt;featureId;</span><br><span class="line">    mFeatures |= flag;</span><br><span class="line">    mLocalFeatures |= mContainer != <span class="keyword">null</span> ? (flag&amp;~mContainer.mFeatures) : flag;</span><br><span class="line">    <span class="keyword">return</span> (mFeatures&amp;flag) != <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>其实就是在 mFeatures 和 mLocalFeatures 的基础上，增加了 featureId 的值；</p>
</div></article><script data-ad-client="ca-pub-6845729157331145" async src="https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script><div class="post-copyright"><div class="post-copyright__author"><span class="post-copyright-meta">文章作者: </span><span class="post-copyright-info"><a href="mailto:undefined">Coolqi.Li</a></span></div><div class="post-copyright__type"><span class="post-copyright-meta">文章链接: </span><span class="post-copyright-info"><a href="https://lishuaiqi.top/2018/06/01/ViewDraw-1-setContentView/">https://lishuaiqi.top/2018/06/01/ViewDraw-1-setContentView/</a></span></div><div class="post-copyright__notice"><span class="post-copyright-meta">版权声明: </span><span class="post-copyright-info">本博客所有文章除特别声明外，均采用 <a href="https://creativecommons.org/licenses/by-nc-sa/4.0/">CC BY-NC-SA 4.0</a> 许可协议。转载请注明来自 <a href="https://lishuaiqi.top">Coolqi`s Blog</a>！</span></div></div><div class="post-meta__tag-list"><a class="post-meta__tags" href="/tags/ViewDraw/">ViewDraw</a></div><div class="post-qr-code"><div class="post-qr-code-item"><img class="post-qr-code__img" src="/img/zfb.jpg"><div class="post-qr-code__desc">支付宝打赏</div></div><div class="post-qr-code-item"><img class="post-qr-code__img" src="/img/wechat.jpg"><div class="post-qr-code__desc">微信打赏</div></div></div><div class="social-share pull-right"></div><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/social-share.js@1.0.16/dist/css/share.min.css"><script src="https://cdn.jsdelivr.net/npm/social-share.js@1.0.16/dist/js/social-share.min.js"></script><nav id="pagination"><div class="prev-post pull-left"><a href="/2018/06/15/ViewDraw-2-newViewRootImpl/"><i class="fa fa-chevron-left">  </i><span>ViewDraw 第二篇 new ViewRootImpl 流程分析</span></a></div><div class="next-post pull-right"><a href="/2018/05/03/PMS7-installThroughAdb/"><span>PMS 第 7 篇 - 通过 pm 指令分析 Install 过程</span><i class="fa fa-chevron-right"></i></a></div></nav><div id="vcomment"></div><script src="https://cdn1.lncld.net/static/js/3.0.4/av-min.js"></script><script src="https://cdn.jsdelivr.net/npm/valine/dist/Valine.min.js"></script><script>var notify = 'false' == 'true';
var verify = 'false' == 'true';
var record_ip = '' == 'true';
var GUEST_INFO = ['nick','mail','link'];
var guest_info = ''.split(',').filter(function(item){
  return GUEST_INFO.indexOf(item) > -1
});
guest_info = guest_info.length == 0 ? GUEST_INFO :guest_info;
window.valine = new Valine({
  el:'#vcomment',
  notify:notify,
  verify:verify,
  recordIP:record_ip,
  appId:'eedJikU7JeDetXjbjw27DWBz-gzGzoHsz',
  appKey:'woFTBOpMKS9EASNUpbaA9Jvc',
  placeholder:'Just go go',
  avatar:'mm',
  guest_info:guest_info,
  pageSize:'10',
  lang: 'zh-cn'
})</script></div></div><footer class="footer-bg" style="background-image: url(/img/blog-bg.jpg)"><div class="layout" id="footer"><div class="copyright">&copy;2015 - 2020 By Coolqi.Li</div><div class="framework-info"><span>驱动 - </span><a href="http://hexo.io"><span>Hexo</span></a><span class="footer-separator">|</span><span>主题 - </span><a href="https://github.com/Molunerfinn/hexo-theme-melody"><span>Melody</span></a></div><div class="footer_custom_text">Hi, welcome to my <a href="https://lishuaiqi.top/">blog</a>!</div><div class="busuanzi"><script async src="//busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script><span id="busuanzi_container_page_pv"><i class="fa fa-file-o"></i><span id="busuanzi_value_page_pv"></span><span></span></span></div></div></footer><i class="fa fa-arrow-up" id="go-up" aria-hidden="true"></i><script src="/js/third-party/anime.min.js"></script><script src="/js/third-party/jquery.min.js"></script><script src="/js/third-party/jquery.fancybox.min.js"></script><script src="/js/third-party/velocity.min.js"></script><script src="/js/third-party/velocity.ui.min.js"></script><script src="/js/utils.js?version=1.7.0"></script><script src="/js/fancybox.js?version=1.7.0"></script><script src="/js/sidebar.js?version=1.7.0"></script><script src="/js/copy.js?version=1.7.0"></script><script src="/js/fireworks.js?version=1.7.0"></script><script src="/js/transition.js?version=1.7.0"></script><script src="/js/scroll.js?version=1.7.0"></script><script src="/js/head.js?version=1.7.0"></script><script type="text/x-mathjax-config">MathJax.Hub.Config({
  tex2jax: {
    inlineMath: [ ['$','$'], ["\\(","\\)"]  ],
    processEscapes: true,
    skipTags: ['script', 'noscript', 'style', 'textarea', 'pre', 'code']
  },
  CommonHTML: {
    linebreaks: { automatic: true, width: "90% container" }
  },
  "HTML-CSS": { 
    linebreaks: { automatic: true, width: "90% container" }
  },
  "SVG": { 
    linebreaks: { automatic: true, width: "90% container" }
  }
});
</script><script type="text/x-mathjax-config">MathJax.Hub.Queue(function() {
  var all = MathJax.Hub.getAllJax(), i;
  for (i=0; i < all.length; i += 1) {
    all[i].SourceElement().parentNode.className += ' has-jax';
  }
});
</script><script src="https://cdn.jsdelivr.net/npm/mathjax/MathJax.js?config=TeX-AMS-MML_HTMLorMML"></script><script src="/js/search/local-search.js"></script><script>if(/Android|webOS|iPhone|iPod|iPad|BlackBerry/i.test(navigator.userAgent)) {
  $('#nav').addClass('is-mobile')
  $('footer').addClass('is-mobile')
  $('#top-container').addClass('is-mobile')
}</script><div class="search-dialog" id="local-search"><div class="search-dialog__title" id="local-search-title">本地搜索</div><div id="local-input-panel"><div id="local-search-input"><div class="local-search-box"><input class="local-search-box--input" placeholder="搜索文章"></div></div></div><hr><div id="local-search-results"><div id="local-hits"></div><div id="local-stats"><div class="local-search-stats__hr" id="hr"><span>由</span> <a href="https://github.com/wzpan/hexo-generator-search" style="color:#49B1F5;">hexo-generator-search</a>
 <span>提供支持</span></div></div></div><span class="search-close-button"><i class="fa fa-times"></i></span></div><div class="search-mask"></div></body></html>
<!DOCTYPE html><html lang="zh-Hans"><head><meta name="generator" content="Hexo 3.9.0"><meta charset="UTF-8"><meta http-equiv="X-UA-Compatible" content="IE=edge"><meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1"><meta name="description" content="Permission第 6 篇 - permission info 的获取和更新"><meta name="keywords" content="Permission权限管理"><meta name="author" content="Coolqi.Li"><meta name="copyright" content="Coolqi.Li"><title>Permission第 6 篇 - permission info 的获取和更新 | Coolqi`s Blog</title><link rel="shortcut icon" href="/img/favicon.ico"><link rel="stylesheet" href="/css/index.css?version=1.7.0"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/font-awesome@latest/css/font-awesome.min.css?version=1.7.0"><link rel="stylesheet" href="https://use.fontawesome.com/releases/v5.7.2/css/all.css?version=1.7.0"><meta name="format-detection" content="telephone=no"><meta http-equiv="x-dns-prefetch-control" content="on"><link rel="dns-prefetch" href="https://cdn.jsdelivr.net"><script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script><script>(adsbygoogle = window.adsbygoogle || []).push({
  google_ad_client: 'ca-pub-6845729157331145',
  enable_page_level_ads: 'true'
});
</script><link rel="dns-prefetch" href="https://hm.baidu.com"><script>var _hmt = _hmt || [];
(function() {
  var hm = document.createElement("script");
  hm.src = "https://hm.baidu.com/hm.js?b7acef5306e54116ad8a99e8b753a92d";
  var s = document.getElementsByTagName("script")[0]; 
  s.parentNode.insertBefore(hm, s);
})();</script><script>var GLOBAL_CONFIG = { 
  root: '/',
  algolia: undefined,
  localSearch: {"path":"search.xml","languages":{"hits_empty":"找不到您查询的内容:${query}"}},
  copy: {
    success: '复制成功',
    error: '复制错误',
    noSupport: '浏览器不支持'
  }
} </script></head><body><i class="fa fa-arrow-right" id="toggle-sidebar" aria-hidden="true"></i><div id="sidebar" data-display="true"><div class="toggle-sidebar-info text-center"><span data-toggle="切换文章详情">切换站点概览</span><hr></div><div class="sidebar-toc"><div class="sidebar-toc__title">目录</div><div class="sidebar-toc__progress"><span class="progress-notice">你已经读了</span><span class="progress-num">0</span><span class="progress-percentage">%</span><div class="sidebar-toc__progress-bar"></div></div><div class="sidebar-toc__content"><ol class="toc"><li class="toc-item toc-level-1"><a class="toc-link" href="#0-综述"><span class="toc-text">0 综述</span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#1-获取权限组相关的信息！"><span class="toc-text">1 获取权限组相关的信息！</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#1-1-PackageManagerS-getAllPermissionGroups"><span class="toc-text">1.1 PackageManagerS.getAllPermissionGroups</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#1-2-PackageManagerS-getPermissionGroupInfo"><span class="toc-text">1.2 PackageManagerS.getPermissionGroupInfo</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#1-2-1-PackageParser-generatePermissionGroupInfo"><span class="toc-text">1.2.1 PackageParser.generatePermissionGroupInfo</span></a></li></ol></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#2-获取权限相关的信息！"><span class="toc-text">2 获取权限相关的信息！</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#2-1-PackageParser-getPermissionInfo"><span class="toc-text">2.1 PackageParser.getPermissionInfo</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#2-2-PackageParser-queryPermissionsByGroup"><span class="toc-text">2.2 PackageParser.queryPermissionsByGroup</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#2-2-1-PackageParser-generatePermissionInfo"><span class="toc-text">2.2.1 PackageParser.generatePermissionInfo</span></a></li></ol></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#3-获取权限标志位的信息！"><span class="toc-text">3 获取权限标志位的信息！</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#3-1-PackageManagerService-getPermissionFlags"><span class="toc-text">3.1 PackageManagerService.getPermissionFlags</span></a></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#4-更新权限标志位的信息！"><span class="toc-text">4 更新权限标志位的信息！</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#4-1-PackageManagerService-updatePermissionFlags"><span class="toc-text">4.1 PackageManagerService.updatePermissionFlags</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#4-1-1-PermissionsState-updatePermissionFlags"><span class="toc-text">4.1.1 PermissionsState.updatePermissionFlags</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#4-1-1-1-PermissionData-updateFlags"><span class="toc-text">4.1.1.1 PermissionData.updateFlags</span></a></li></ol></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#4-2-PackageManagerService-updatePermissionFlagsForAllApps"><span class="toc-text">4.2 PackageManagerService.updatePermissionFlagsForAllApps</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#4-2-1-PermissionsState-updatePermissionFlagsForAllPermissions"><span class="toc-text">4.2.1 PermissionsState.updatePermissionFlagsForAllPermissions</span></a></li></ol></li></ol></li></ol></div></div><div class="author-info hide"><div class="author-info__avatar text-center"><img src="/img/avatar.jpg"></div><div class="author-info__name text-center">Coolqi.Li</div><div class="author-info__description text-center">“Hi，我是李帅奇，Android 开发工程师，TeamLeader，熬夜星人，一个努力赚钱，积极向上的好人。”</div><div class="follow-button"><a href="https://github.com/single-li">Follow Me</a></div><hr><div class="author-info-articles"><a class="author-info-articles__archives article-meta" href="/archives"><span class="pull-left">文章</span><span class="pull-right">86</span></a><a class="author-info-articles__tags article-meta" href="/tags"><span class="pull-left">标签</span><span class="pull-right">21</span></a><a class="author-info-articles__categories article-meta" href="/categories"><span class="pull-left">分类</span><span class="pull-right">26</span></a></div><hr><div class="author-info-links"><div class="author-info-links__title text-center">Links</div><a class="author-info-links__name text-center" href="https://developer.android.google.cn/">AndroidDeveloper</a><a class="author-info-links__name text-center" href="http://www.android-studio.org/">AndroidStudio</a><a class="author-info-links__name text-center" href="https://www.jianshu.com/u/123a20a96441">简书</a><a class="author-info-links__name text-center" href="https://weibo.com/coolqiLi">微博</a></div></div></div><div id="content-outer"><div id="top-container" style="background-image: url(/img/blog-bg.jpg)"><div id="page-header"><span class="pull-left"> <a id="site-name" href="/">Coolqi`s Blog</a></span><i class="fa fa-bars toggle-menu pull-right" aria-hidden="true"></i><span class="pull-right menus">   <a class="site-page" href="/">Home</a><a class="site-page" href="/categories">Categories</a><a class="site-page" href="/tags">Tags</a><a class="site-page" href="/archives">Archives</a><a class="site-page" href="/about">About</a></span><span class="pull-right"><a class="site-page social-icon search"><i class="fa fa-search"></i><span> 搜索</span></a></span></div><div id="post-info"><div id="post-title">Permission第 6 篇 - permission info 的获取和更新</div><div id="post-meta"><time class="post-meta__date"><i class="fa fa-calendar" aria-hidden="true"></i> 2018-11-08</time><span class="post-meta__separator">|</span><i class="fa fa-inbox post-meta__icon" aria-hidden="true"></i><a class="post-meta__categories" href="/categories/AndroidFramework源码分析/">AndroidFramework源码分析</a><i class="fa fa-angle-right" aria-hidden="true"></i><i class="fa fa-inbox post-meta__icon" aria-hidden="true"></i><a class="post-meta__categories" href="/categories/AndroidFramework源码分析/Permission权限管理/">Permission权限管理</a><div class="post-meta-wordcount"><span>字数总计: </span><span class="word-count">2k</span><span class="post-meta__separator">|</span><span>阅读时长: 9 分钟</span></div></div></div></div><div class="layout" id="content-inner"><article id="post"><div class="article-container" id="post-content"><p>[toc]</p>
<h1 id="0-综述"><a href="#0-综述" class="headerlink" title="0 综述"></a>0 综述</h1><p>基于 Android 7.1.1，分析权限管理相关知识，本文权限信息的获取！</p>
<p>PackageManagerService 提供了很多个接口用于获取权限的信息！</p>
<h1 id="1-获取权限组相关的信息！"><a href="#1-获取权限组相关的信息！" class="headerlink" title="1 获取权限组相关的信息！"></a>1 获取权限组相关的信息！</h1><p>PackageManagerService.mPermissionGroups 保存了从所有 Application 中解析到的权限组信息！</p>
<p>PackageManagerService 提供了如下的两个接口来获得权限组的信息！</p>
<h2 id="1-1-PackageManagerS-getAllPermissionGroups"><a href="#1-1-PackageManagerS-getAllPermissionGroups" class="headerlink" title="1.1 PackageManagerS.getAllPermissionGroups"></a>1.1 PackageManagerS.getAllPermissionGroups</h2><p>获得所有的权限组<br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="keyword">public</span> <span class="meta">@NonNull</span> <span class="function">ParceledListSlice&lt;PermissionGroupInfo&gt; <span class="title">getAllPermissionGroups</span><span class="params">(<span class="keyword">int</span> flags)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">synchronized</span> (mPackages) &#123;</span><br><span class="line">        <span class="keyword">final</span> <span class="keyword">int</span> N = mPermissionGroups.size();</span><br><span class="line">        ArrayList&lt;PermissionGroupInfo&gt; out</span><br><span class="line">                = <span class="keyword">new</span> ArrayList&lt;PermissionGroupInfo&gt;(N);</span><br><span class="line">        <span class="keyword">for</span> (PackageParser.PermissionGroup pg : mPermissionGroups.values()) &#123;</span><br><span class="line">            <span class="comment">//【*1.2.1】调用了 PackageParser.generatePermissionGroupInfo 方法</span></span><br><span class="line">            out.add(PackageParser.generatePermissionGroupInfo(pg, flags));</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> ParceledListSlice&lt;&gt;(out);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<h2 id="1-2-PackageManagerS-getPermissionGroupInfo"><a href="#1-2-PackageManagerS-getPermissionGroupInfo" class="headerlink" title="1.2 PackageManagerS.getPermissionGroupInfo"></a>1.2 PackageManagerS.getPermissionGroupInfo</h2><p>获得指定的权限组信息</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> PermissionGroupInfo <span class="title">getPermissionGroupInfo</span><span class="params">(String name, <span class="keyword">int</span> flags)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">synchronized</span> (mPackages) &#123;</span><br><span class="line">        <span class="comment">//【*1.2.1】调用了 PackageParser.generatePermissionGroupInfo 方法</span></span><br><span class="line">        <span class="keyword">return</span> PackageParser.generatePermissionGroupInfo(</span><br><span class="line">                mPermissionGroups.get(name), flags);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h3 id="1-2-1-PackageParser-generatePermissionGroupInfo"><a href="#1-2-1-PackageParser-generatePermissionGroupInfo" class="headerlink" title="1.2.1 PackageParser.generatePermissionGroupInfo"></a>1.2.1 PackageParser.generatePermissionGroupInfo</h3><p>该方法会新创建的 PermissionGroupInfo 对象，作为解析数据 PermissionGroup.PermissionGroupInfo 的拷贝！！</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">public static final PermissionGroupInfo generatePermissionGroupInfo(</span><br><span class="line">        PermissionGroup pg, int flags) &#123;</span><br><span class="line">    if (pg == null) return null;</span><br><span class="line">    // 如果 flags 没有设置 PackageManager.GET_META_DATA，直接返回 PermissionGroup.PermissionGroupInfo</span><br><span class="line">    if ((flags &amp; PackageManager.GET_META_DATA) == 0) &#123;</span><br><span class="line">        return pg.info;</span><br><span class="line">    &#125;</span><br><span class="line">    // 如果 flags 设置了 PackageManager.GET_META_DATA，我们会新建一个 PermissionGroupInfo 对象，</span><br><span class="line">    // 将解析的数据拷贝进来！</span><br><span class="line">    PermissionGroupInfo pgi = new PermissionGroupInfo(pg.info);</span><br><span class="line">    pgi.metaData = pg.metaData;</span><br><span class="line">    return pgi;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h1 id="2-获取权限相关的信息！"><a href="#2-获取权限相关的信息！" class="headerlink" title="2 获取权限相关的信息！"></a>2 获取权限相关的信息！</h1><p>mSettings.mPermissions 保存了系统和应用定义的所有的权限信息！</p>
<p>PackageManagerService 提供了如下的两个接口来获得权限组的信息！</p>
<h2 id="2-1-PackageParser-getPermissionInfo"><a href="#2-1-PackageParser-getPermissionInfo" class="headerlink" title="2.1 PackageParser.getPermissionInfo"></a>2.1 PackageParser.getPermissionInfo</h2><p>获得指定 name 的权限信息！</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> PermissionInfo <span class="title">getPermissionInfo</span><span class="params">(String name, <span class="keyword">int</span> flags)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">synchronized</span> (mPackages) &#123;</span><br><span class="line">        <span class="keyword">final</span> BasePermission p = mSettings.mPermissions.get(name);</span><br><span class="line">        <span class="keyword">if</span> (p != <span class="keyword">null</span>) &#123;</span><br><span class="line">            <span class="comment">//【2.2.1】调用了 PackageParser.generatePermissionInfo 方法</span></span><br><span class="line">            <span class="keyword">return</span> generatePermissionInfo(p, flags);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">null</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h2 id="2-2-PackageParser-queryPermissionsByGroup"><a href="#2-2-PackageParser-queryPermissionsByGroup" class="headerlink" title="2.2 PackageParser.queryPermissionsByGroup"></a>2.2 PackageParser.queryPermissionsByGroup</h2><p>获得同一个 group 中的所有权限信息！</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="keyword">public</span> <span class="meta">@Nullable</span> <span class="function">ParceledListSlice&lt;PermissionInfo&gt; <span class="title">queryPermissionsByGroup</span><span class="params">(String group,</span></span></span><br><span class="line"><span class="function"><span class="params">        <span class="keyword">int</span> flags)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">synchronized</span> (mPackages) &#123;</span><br><span class="line">        <span class="comment">//【1】校验权限组是否存在！</span></span><br><span class="line">        <span class="keyword">if</span> (group != <span class="keyword">null</span> &amp;&amp; !mPermissionGroups.containsKey(group)) &#123;</span><br><span class="line">            <span class="comment">// This is thrown as NameNotFoundException</span></span><br><span class="line">            <span class="keyword">return</span> <span class="keyword">null</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">//【2.2.1】调用了 PackageParser.generatePermissionInfo 方法</span></span><br><span class="line">        ArrayList&lt;PermissionInfo&gt; out = <span class="keyword">new</span> ArrayList&lt;PermissionInfo&gt;(<span class="number">10</span>);</span><br><span class="line">        <span class="keyword">for</span> (BasePermission p : mSettings.mPermissions.values()) &#123;</span><br><span class="line">            <span class="keyword">if</span> (group == <span class="keyword">null</span>) &#123; <span class="comment">// 如果参数 group 为 null，只收集无 group 的权限！</span></span><br><span class="line">                <span class="keyword">if</span> (p.perm == <span class="keyword">null</span> || p.perm.info.group == <span class="keyword">null</span>) &#123;</span><br><span class="line">                    out.add(generatePermissionInfo(p, flags));</span><br><span class="line">                &#125;</span><br><span class="line">            &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                <span class="keyword">if</span> (p.perm != <span class="keyword">null</span> &amp;&amp; group.equals(p.perm.info.group)) &#123;</span><br><span class="line">                    out.add(PackageParser.generatePermissionInfo(p.perm, flags));</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> ParceledListSlice&lt;&gt;(out);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h3 id="2-2-1-PackageParser-generatePermissionInfo"><a href="#2-2-1-PackageParser-generatePermissionInfo" class="headerlink" title="2.2.1 PackageParser.generatePermissionInfo"></a>2.2.1 PackageParser.generatePermissionInfo</h3><p>该方法会新创建的 PermissionInfo 对象，拷贝 Permission 的数据！！</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> PermissionInfo <span class="title">generatePermissionInfo</span><span class="params">(</span></span></span><br><span class="line"><span class="function"><span class="params">        Permission p, <span class="keyword">int</span> flags)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">if</span> (p == <span class="keyword">null</span>) <span class="keyword">return</span> <span class="keyword">null</span>;</span><br><span class="line">    <span class="keyword">if</span> ((flags &amp; PackageManager.GET_META_DATA) == <span class="number">0</span>) &#123;</span><br><span class="line">        <span class="keyword">return</span> p.info;</span><br><span class="line">    &#125;</span><br><span class="line">    PermissionInfo pi = <span class="keyword">new</span> PermissionInfo(p.info);</span><br><span class="line">    pi.metaData = p.metaData;</span><br><span class="line">    <span class="keyword">return</span> pi;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>如果不需要 GET_META_DATA，那就直接返回解析得到的 PermissionInfo 对象！</p>
<h1 id="3-获取权限标志位的信息！"><a href="#3-获取权限标志位的信息！" class="headerlink" title="3 获取权限标志位的信息！"></a>3 获取权限标志位的信息！</h1><p>PackageManagerService 提供了如下接口来获得权限标志位组的信息！</p>
<p>PackageManagerService.mPackages 用于保存所有解析过的 Pacakge 信息！</p>
<p>mSettings.mPermissions 中保存了系统中所有的权限信息！</p>
<h2 id="3-1-PackageManagerService-getPermissionFlags"><a href="#3-1-PackageManagerService-getPermissionFlags" class="headerlink" title="3.1 PackageManagerService.getPermissionFlags"></a>3.1 PackageManagerService.getPermissionFlags</h2><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">int</span> <span class="title">getPermissionFlags</span><span class="params">(String name, String packageName, <span class="keyword">int</span> userId)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">if</span> (!sUserManager.exists(userId)) &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    enforceGrantRevokeRuntimePermissionPermissions(<span class="string">"getPermissionFlags"</span>);</span><br><span class="line"></span><br><span class="line">    enforceCrossUserPermission(Binder.getCallingUid(), userId,</span><br><span class="line">            <span class="keyword">true</span> <span class="comment">/* requireFullPermission */</span>, <span class="keyword">false</span> <span class="comment">/* checkShell */</span>,</span><br><span class="line">            <span class="string">"getPermissionFlags"</span>);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">synchronized</span> (mPackages) &#123;</span><br><span class="line">        <span class="comment">//【1】如果 packageName 不存在，返回 0；</span></span><br><span class="line">        <span class="keyword">final</span> PackageParser.Package pkg = mPackages.get(packageName);</span><br><span class="line">        <span class="keyword">if</span> (pkg == <span class="keyword">null</span>) &#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">//【2】如果权限不存在，返回 0；</span></span><br><span class="line">        <span class="keyword">final</span> BasePermission bp = mSettings.mPermissions.get(name);</span><br><span class="line">        <span class="keyword">if</span> (bp == <span class="keyword">null</span>) &#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">//【3】获得该 package 对应的 PackageSettings 或者 SharedUserSetting 对象！</span></span><br><span class="line">        SettingBase sb = (SettingBase) pkg.mExtras;</span><br><span class="line">        <span class="keyword">if</span> (sb == <span class="keyword">null</span>) &#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">//【4】获得权限的 flags</span></span><br><span class="line">        PermissionsState permissionsState = sb.getPermissionsState();</span><br><span class="line">        <span class="keyword">return</span> permissionsState.getPermissionFlags(name, userId);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>方法很简单，不多说了！</p>
<h1 id="4-更新权限标志位的信息！"><a href="#4-更新权限标志位的信息！" class="headerlink" title="4 更新权限标志位的信息！"></a>4 更新权限标志位的信息！</h1><p>PackageManagerService 提供了如下接口来更新权限标志位的信息！</p>
<h2 id="4-1-PackageManagerService-updatePermissionFlags"><a href="#4-1-PackageManagerService-updatePermissionFlags" class="headerlink" title="4.1 PackageManagerService.updatePermissionFlags"></a>4.1 PackageManagerService.updatePermissionFlags</h2><p>该方法更新指定权限的 flags，flagMask 表示的是 flags 的位掩码，用来屏蔽某些位；flagValues 表示新的标志位值！</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">updatePermissionFlags</span><span class="params">(String name, String packageName, <span class="keyword">int</span> flagMask,</span></span></span><br><span class="line"><span class="function"><span class="params">        <span class="keyword">int</span> flagValues, <span class="keyword">int</span> userId)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">if</span> (!sUserManager.exists(userId)) &#123;</span><br><span class="line">        <span class="keyword">return</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    enforceGrantRevokeRuntimePermissionPermissions(<span class="string">"updatePermissionFlags"</span>);</span><br><span class="line"></span><br><span class="line">    enforceCrossUserPermission(Binder.getCallingUid(), userId,</span><br><span class="line">            <span class="keyword">true</span> <span class="comment">/* requireFullPermission */</span>, <span class="keyword">true</span> <span class="comment">/* checkShell */</span>,</span><br><span class="line">            <span class="string">"updatePermissionFlags"</span>);</span><br><span class="line"></span><br><span class="line">    <span class="comment">//【1】如果调用者不是 system uid，不能改变以下标志位，flagMask  和 flagValues 需去掉对应标志位：</span></span><br><span class="line">    <span class="keyword">if</span> (getCallingUid() != Process.SYSTEM_UID) &#123;</span><br><span class="line">        flagMask &amp;= ~PackageManager.FLAG_PERMISSION_SYSTEM_FIXED;</span><br><span class="line">        flagValues &amp;= ~PackageManager.FLAG_PERMISSION_SYSTEM_FIXED;</span><br><span class="line">        flagMask &amp;= ~PackageManager.FLAG_PERMISSION_GRANTED_BY_DEFAULT;</span><br><span class="line">        flagValues &amp;= ~PackageManager.FLAG_PERMISSION_GRANTED_BY_DEFAULT;</span><br><span class="line">        flagValues &amp;= ~PackageManager.FLAG_PERMISSION_REVIEW_REQUIRED;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">synchronized</span> (mPackages) &#123;</span><br><span class="line">        <span class="comment">//【2】如果该 package 不存在，抛出异常！</span></span><br><span class="line">        <span class="keyword">final</span> PackageParser.Package pkg = mPackages.get(packageName);</span><br><span class="line">        <span class="keyword">if</span> (pkg == <span class="keyword">null</span>) &#123;</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> IllegalArgumentException(<span class="string">"Unknown package: "</span> + packageName);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">//【3】如果权限 name 不存在，抛出异常！</span></span><br><span class="line">        <span class="keyword">final</span> BasePermission bp = mSettings.mPermissions.get(name);</span><br><span class="line">        <span class="keyword">if</span> (bp == <span class="keyword">null</span>) &#123;</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> IllegalArgumentException(<span class="string">"Unknown permission: "</span> + name);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">//【4】如果该 package 没有安装记录，抛出异常！</span></span><br><span class="line">        SettingBase sb = (SettingBase) pkg.mExtras;</span><br><span class="line">        <span class="keyword">if</span> (sb == <span class="keyword">null</span>) &#123;</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> IllegalArgumentException(<span class="string">"Unknown package: "</span> + packageName);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">//【5】获得该 package 的权限状态管理对象！</span></span><br><span class="line">        PermissionsState permissionsState = sb.getPermissionsState();</span><br><span class="line"></span><br><span class="line">        <span class="comment">//【6】获得该应用程序的运行时权限状态信息，返回不为 null，说明其有运行时权限！</span></span><br><span class="line">        <span class="keyword">boolean</span> hadState = permissionsState.getRuntimePermissionState(name, userId) != <span class="keyword">null</span>;</span><br><span class="line"></span><br><span class="line">        <span class="comment">//【*4.1.1】更新该权限的标志位！</span></span><br><span class="line">        <span class="keyword">if</span> (permissionsState.updatePermissionFlags(bp, userId, flagMask, flagValues)) &#123;</span><br><span class="line">            <span class="comment">// 安装时权限和运行时权限保存在不同的目录下，所以要更新不同的文件</span></span><br><span class="line">            <span class="keyword">if</span> (permissionsState.getInstallPermissionState(name) != <span class="keyword">null</span>) &#123;</span><br><span class="line">                scheduleWriteSettingsLocked(); <span class="comment">// 更新运行时权限！</span></span><br><span class="line">                </span><br><span class="line">            &#125; <span class="keyword">else</span> <span class="keyword">if</span> (permissionsState.getRuntimePermissionState(name, userId) != <span class="keyword">null</span></span><br><span class="line">                    || hadState) &#123; <span class="comment">// 更新安装时权限！</span></span><br><span class="line">                mSettings.writeRuntimePermissionsForUserLPr(userId, <span class="keyword">false</span>);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>先会更新 flags，更新成功后，会根据权限的类型去，去更新对应的持久化文件！</p>
<h3 id="4-1-1-PermissionsState-updatePermissionFlags"><a href="#4-1-1-PermissionsState-updatePermissionFlags" class="headerlink" title="4.1.1 PermissionsState.updatePermissionFlags"></a>4.1.1 PermissionsState.updatePermissionFlags</h3><p>PermissionsState 用于管理 package 的权限状态!</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">boolean</span> <span class="title">updatePermissionFlags</span><span class="params">(BasePermission permission, <span class="keyword">int</span> userId,</span></span></span><br><span class="line"><span class="function"><span class="params">        <span class="keyword">int</span> flagMask, <span class="keyword">int</span> flagValues)</span> </span>&#123;</span><br><span class="line">    enforceValidUserId(userId);</span><br><span class="line">    <span class="comment">//【1】如果 flagValues 和 flagMask 有一个不为 0，那就需要更新 flags！</span></span><br><span class="line">    <span class="keyword">final</span> <span class="keyword">boolean</span> mayChangeFlags = flagValues != <span class="number">0</span> || flagMask != <span class="number">0</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (mPermissions == <span class="keyword">null</span>) &#123;</span><br><span class="line">        <span class="keyword">if</span> (!mayChangeFlags) &#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="keyword">false</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        ensurePermissionData(permission);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    PermissionData permissionData = mPermissions.get(permission.name);</span><br><span class="line">    <span class="keyword">if</span> (permissionData == <span class="keyword">null</span>) &#123;</span><br><span class="line">        <span class="keyword">if</span> (!mayChangeFlags) &#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="keyword">false</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        permissionData = ensurePermissionData(permission);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">//【2】获得旧的 flags！</span></span><br><span class="line">    <span class="keyword">final</span> <span class="keyword">int</span> oldFlags = permissionData.getFlags(userId);</span><br><span class="line">    </span><br><span class="line">    <span class="comment">//【*4.1.1.1】调用 PermissionData.updatePermissionFlags 更新权限的标志位：</span></span><br><span class="line">    <span class="keyword">final</span> <span class="keyword">boolean</span> updated = permissionData.updateFlags(userId, flagMask, flagValues);</span><br><span class="line"></span><br><span class="line">    <span class="comment">//【3】如果 flags 发生了更新，比较下，更新后是否需要再次 review！</span></span><br><span class="line">    <span class="keyword">if</span> (updated) &#123;</span><br><span class="line">        <span class="keyword">final</span> <span class="keyword">int</span> newFlags = permissionData.getFlags(userId); <span class="comment">// 获得新的 flags！</span></span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> ((oldFlags &amp; PackageManager.FLAG_PERMISSION_REVIEW_REQUIRED) == <span class="number">0</span></span><br><span class="line">                &amp;&amp; (newFlags &amp; PackageManager.FLAG_PERMISSION_REVIEW_REQUIRED) != <span class="number">0</span>) &#123;</span><br><span class="line"></span><br><span class="line">            <span class="keyword">if</span> (mPermissionReviewRequired == <span class="keyword">null</span>) &#123;</span><br><span class="line">                mPermissionReviewRequired = <span class="keyword">new</span> SparseBooleanArray();</span><br><span class="line">            &#125;</span><br><span class="line">            mPermissionReviewRequired.put(userId, <span class="keyword">true</span>);</span><br><span class="line"></span><br><span class="line">        &#125; <span class="keyword">else</span> <span class="keyword">if</span> ((oldFlags &amp; PackageManager.FLAG_PERMISSION_REVIEW_REQUIRED) != <span class="number">0</span></span><br><span class="line">                &amp;&amp; (newFlags &amp; PackageManager.FLAG_PERMISSION_REVIEW_REQUIRED) == <span class="number">0</span>) &#123;</span><br><span class="line"></span><br><span class="line">            <span class="keyword">if</span> (mPermissionReviewRequired != <span class="keyword">null</span>) &#123;</span><br><span class="line">                mPermissionReviewRequired.delete(userId);</span><br><span class="line">                <span class="keyword">if</span> (mPermissionReviewRequired.size() &lt;= <span class="number">0</span>) &#123;</span><br><span class="line">                    mPermissionReviewRequired = <span class="keyword">null</span>;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> updated;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>整个方法很简单，无需多说，前面分析过了，这里就不多说了！！</p>
<h4 id="4-1-1-1-PermissionData-updateFlags"><a href="#4-1-1-1-PermissionData-updateFlags" class="headerlink" title="4.1.1.1 PermissionData.updateFlags"></a>4.1.1.1 PermissionData.updateFlags</h4><p>PermissionData 用于封装指定权限的状态信息！</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">boolean</span> <span class="title">updateFlags</span><span class="params">(<span class="keyword">int</span> userId, <span class="keyword">int</span> flagMask, <span class="keyword">int</span> flagValues)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">if</span> (isInstallPermission()) &#123;</span><br><span class="line">        userId = UserHandle.USER_ALL;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (!isCompatibleUserId(userId)) &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">false</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//【1】新的 newFlags 取 flagValues 和 flagMask 相同的位值！</span></span><br><span class="line">    <span class="comment">// 就是说，新的 flags 要么是 0，要么只能取和 flagMask 相同的位值！</span></span><br><span class="line">    <span class="keyword">final</span> <span class="keyword">int</span> newFlags = flagValues &amp; flagMask;</span><br><span class="line"></span><br><span class="line">    PermissionState userState = mUserStates.get(userId);</span><br><span class="line">    <span class="keyword">if</span> (userState != <span class="keyword">null</span>) &#123;</span><br><span class="line">        <span class="keyword">final</span> <span class="keyword">int</span> oldFlags = userState.mFlags;</span><br><span class="line">        <span class="comment">//【2】最新的权限 flags 设置如下：</span></span><br><span class="line">        <span class="comment">// 先取 oldFlags 和 ~flagMask 相同的位值，然后加上 newFlags！</span></span><br><span class="line">        userState.mFlags = (userState.mFlags &amp; ~flagMask) | newFlags;</span><br><span class="line">        <span class="keyword">if</span> (userState.isDefault()) &#123;</span><br><span class="line">            mUserStates.remove(userId);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> userState.mFlags != oldFlags; <span class="comment">// 判断标志位是否变化！</span></span><br><span class="line"></span><br><span class="line">    &#125; <span class="keyword">else</span> <span class="keyword">if</span> (newFlags != <span class="number">0</span>) &#123;</span><br><span class="line">        userState = <span class="keyword">new</span> PermissionState(mPerm.name);</span><br><span class="line">        userState.mFlags = newFlags;</span><br><span class="line">        mUserStates.put(userId, userState);</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">true</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">false</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>这里首先，通过 flagValues &amp; flagMask 取其相同的位值为 newFlags！</p>
<p>设置最新的 flags 的时候，先是 oldFlags &amp; ~flagMask 取 oldFlags 和 ～flagMask 相同的位值，然后加上 newFlags！</p>
<h2 id="4-2-PackageManagerService-updatePermissionFlagsForAllApps"><a href="#4-2-PackageManagerService-updatePermissionFlagsForAllApps" class="headerlink" title="4.2 PackageManagerService.updatePermissionFlagsForAllApps"></a>4.2 PackageManagerService.updatePermissionFlagsForAllApps</h2><p>该方法更新指定所有权限的 flags！</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">updatePermissionFlagsForAllApps</span><span class="params">(<span class="keyword">int</span> flagMask, <span class="keyword">int</span> flagValues, <span class="keyword">int</span> userId)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">if</span> (!sUserManager.exists(userId)) &#123;</span><br><span class="line">        <span class="keyword">return</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    enforceGrantRevokeRuntimePermissionPermissions(<span class="string">"updatePermissionFlagsForAllApps"</span>);</span><br><span class="line"></span><br><span class="line">    enforceCrossUserPermission(Binder.getCallingUid(), userId,</span><br><span class="line">            <span class="keyword">true</span> <span class="comment">/* requireFullPermission */</span>, <span class="keyword">true</span> <span class="comment">/* checkShell */</span>,</span><br><span class="line">            <span class="string">"updatePermissionFlagsForAllApps"</span>);</span><br><span class="line"></span><br><span class="line">    <span class="comment">//【1】如果不是 system uid，不能修改 system fixed flags，从 flagMask 和 flagValues 中去掉该标志位！</span></span><br><span class="line">    <span class="comment">// 那么下面的调整中就不会涉及到 system fix 标志位！</span></span><br><span class="line">    <span class="keyword">if</span> (getCallingUid() != Process.SYSTEM_UID) &#123;</span><br><span class="line">        flagMask &amp;= ~PackageManager.FLAG_PERMISSION_SYSTEM_FIXED;</span><br><span class="line">        flagValues &amp;= ~PackageManager.FLAG_PERMISSION_SYSTEM_FIXED;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">synchronized</span> (mPackages) &#123;</span><br><span class="line">        <span class="keyword">boolean</span> changed = <span class="keyword">false</span>;</span><br><span class="line">        <span class="keyword">final</span> <span class="keyword">int</span> packageCount = mPackages.size();</span><br><span class="line">        <span class="keyword">for</span> (<span class="keyword">int</span> pkgIndex = <span class="number">0</span>; pkgIndex &lt; packageCount; pkgIndex++) &#123;</span><br><span class="line">            <span class="keyword">final</span> PackageParser.Package pkg = mPackages.valueAt(pkgIndex);</span><br><span class="line">            SettingBase sb = (SettingBase) pkg.mExtras;</span><br><span class="line">            <span class="keyword">if</span> (sb == <span class="keyword">null</span>) &#123;</span><br><span class="line">                <span class="keyword">continue</span>;</span><br><span class="line">            &#125;</span><br><span class="line">            PermissionsState permissionsState = sb.getPermissionsState();</span><br><span class="line">            <span class="comment">//【*4.2.1】调用了 updatePermissionFlagsForAllPermissions 方法，更新 flags！</span></span><br><span class="line">            changed |= permissionsState.updatePermissionFlagsForAllPermissions(</span><br><span class="line">                    userId, flagMask, flagValues);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">if</span> (changed) &#123; </span><br><span class="line">            <span class="comment">//【2】如果发生了改变，更新 rumtime-permissions.xml 文件！</span></span><br><span class="line">            mSettings.writeRuntimePermissionsForUserLPr(userId, <span class="keyword">false</span>);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h3 id="4-2-1-PermissionsState-updatePermissionFlagsForAllPermissions"><a href="#4-2-1-PermissionsState-updatePermissionFlagsForAllPermissions" class="headerlink" title="4.2.1 PermissionsState.updatePermissionFlagsForAllPermissions"></a>4.2.1 PermissionsState.updatePermissionFlagsForAllPermissions</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">boolean</span> <span class="title">updatePermissionFlagsForAllPermissions</span><span class="params">(</span></span></span><br><span class="line"><span class="function"><span class="params">        <span class="keyword">int</span> userId, <span class="keyword">int</span> flagMask, <span class="keyword">int</span> flagValues)</span> </span>&#123;</span><br><span class="line">    enforceValidUserId(userId);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (mPermissions == <span class="keyword">null</span>) &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">false</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">boolean</span> changed = <span class="keyword">false</span>;</span><br><span class="line">    <span class="keyword">final</span> <span class="keyword">int</span> permissionCount = mPermissions.size();</span><br><span class="line">    <span class="comment">//【*4.1.1.1】更新 PermissionsState 管理的所有权限的 flags！</span></span><br><span class="line">    <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; permissionCount; i++) &#123;</span><br><span class="line">        PermissionData permissionData = mPermissions.valueAt(i);</span><br><span class="line">        changed |= permissionData.updateFlags(userId, flagMask, flagValues);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> changed;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>流程很简单，不多说了！</p>
</div></article><script data-ad-client="ca-pub-6845729157331145" async src="https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script><div class="post-copyright"><div class="post-copyright__author"><span class="post-copyright-meta">文章作者: </span><span class="post-copyright-info"><a href="mailto:undefined">Coolqi.Li</a></span></div><div class="post-copyright__type"><span class="post-copyright-meta">文章链接: </span><span class="post-copyright-info"><a href="https://lishuaiqi.top/2018/11/08/Permission6-getAndUpdatePermissionInfo/">https://lishuaiqi.top/2018/11/08/Permission6-getAndUpdatePermissionInfo/</a></span></div><div class="post-copyright__notice"><span class="post-copyright-meta">版权声明: </span><span class="post-copyright-info">本博客所有文章除特别声明外，均采用 <a href="https://creativecommons.org/licenses/by-nc-sa/4.0/">CC BY-NC-SA 4.0</a> 许可协议。转载请注明来自 <a href="https://lishuaiqi.top">Coolqi`s Blog</a>！</span></div></div><div class="post-meta__tag-list"><a class="post-meta__tags" href="/tags/Permission权限管理/">Permission权限管理</a></div><div class="post-qr-code"><div class="post-qr-code-item"><img class="post-qr-code__img" src="/img/zfb.jpg"><div class="post-qr-code__desc">支付宝打赏</div></div><div class="post-qr-code-item"><img class="post-qr-code__img" src="/img/wechat.jpg"><div class="post-qr-code__desc">微信打赏</div></div></div><div class="social-share pull-right"></div><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/social-share.js@1.0.16/dist/css/share.min.css"><script src="https://cdn.jsdelivr.net/npm/social-share.js@1.0.16/dist/js/social-share.min.js"></script><nav id="pagination"><div class="prev-post pull-left"><a href="/2019/04/13/ARouter1-baseUsages/"><i class="fa fa-chevron-left">  </i><span>ARouter 第一篇 - 基本使用</span></a></div><div class="next-post pull-right"><a href="/2018/09/17/PMS12-enable_disableThroughAdb/"><span>PMS 第 12 篇 - 通过 adb 指令分析 enable/disable 过程</span><i class="fa fa-chevron-right"></i></a></div></nav><div id="vcomment"></div><script src="https://cdn1.lncld.net/static/js/3.0.4/av-min.js"></script><script src="https://cdn.jsdelivr.net/npm/valine/dist/Valine.min.js"></script><script>var notify = 'false' == 'true';
var verify = 'false' == 'true';
var record_ip = '' == 'true';
var GUEST_INFO = ['nick','mail','link'];
var guest_info = ''.split(',').filter(function(item){
  return GUEST_INFO.indexOf(item) > -1
});
guest_info = guest_info.length == 0 ? GUEST_INFO :guest_info;
window.valine = new Valine({
  el:'#vcomment',
  notify:notify,
  verify:verify,
  recordIP:record_ip,
  appId:'eedJikU7JeDetXjbjw27DWBz-gzGzoHsz',
  appKey:'woFTBOpMKS9EASNUpbaA9Jvc',
  placeholder:'Just go go',
  avatar:'mm',
  guest_info:guest_info,
  pageSize:'10',
  lang: 'zh-cn'
})</script></div></div><footer class="footer-bg" style="background-image: url(/img/blog-bg.jpg)"><div class="layout" id="footer"><div class="copyright">&copy;2015 - 2020 By Coolqi.Li</div><div class="framework-info"><span>驱动 - </span><a href="http://hexo.io"><span>Hexo</span></a><span class="footer-separator">|</span><span>主题 - </span><a href="https://github.com/Molunerfinn/hexo-theme-melody"><span>Melody</span></a></div><div class="footer_custom_text">Hi, welcome to my <a href="https://lishuaiqi.top/">blog</a>!</div><div class="busuanzi"><script async src="//busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script><span id="busuanzi_container_page_pv"><i class="fa fa-file-o"></i><span id="busuanzi_value_page_pv"></span><span></span></span></div></div></footer><i class="fa fa-arrow-up" id="go-up" aria-hidden="true"></i><script src="/js/third-party/anime.min.js"></script><script src="/js/third-party/jquery.min.js"></script><script src="/js/third-party/jquery.fancybox.min.js"></script><script src="/js/third-party/velocity.min.js"></script><script src="/js/third-party/velocity.ui.min.js"></script><script src="/js/utils.js?version=1.7.0"></script><script src="/js/fancybox.js?version=1.7.0"></script><script src="/js/sidebar.js?version=1.7.0"></script><script src="/js/copy.js?version=1.7.0"></script><script src="/js/fireworks.js?version=1.7.0"></script><script src="/js/transition.js?version=1.7.0"></script><script src="/js/scroll.js?version=1.7.0"></script><script src="/js/head.js?version=1.7.0"></script><script type="text/x-mathjax-config">MathJax.Hub.Config({
  tex2jax: {
    inlineMath: [ ['$','$'], ["\\(","\\)"]  ],
    processEscapes: true,
    skipTags: ['script', 'noscript', 'style', 'textarea', 'pre', 'code']
  },
  CommonHTML: {
    linebreaks: { automatic: true, width: "90% container" }
  },
  "HTML-CSS": { 
    linebreaks: { automatic: true, width: "90% container" }
  },
  "SVG": { 
    linebreaks: { automatic: true, width: "90% container" }
  }
});
</script><script type="text/x-mathjax-config">MathJax.Hub.Queue(function() {
  var all = MathJax.Hub.getAllJax(), i;
  for (i=0; i < all.length; i += 1) {
    all[i].SourceElement().parentNode.className += ' has-jax';
  }
});
</script><script src="https://cdn.jsdelivr.net/npm/mathjax/MathJax.js?config=TeX-AMS-MML_HTMLorMML"></script><script src="/js/search/local-search.js"></script><script>if(/Android|webOS|iPhone|iPod|iPad|BlackBerry/i.test(navigator.userAgent)) {
  $('#nav').addClass('is-mobile')
  $('footer').addClass('is-mobile')
  $('#top-container').addClass('is-mobile')
}</script><div class="search-dialog" id="local-search"><div class="search-dialog__title" id="local-search-title">本地搜索</div><div id="local-input-panel"><div id="local-search-input"><div class="local-search-box"><input class="local-search-box--input" placeholder="搜索文章"></div></div></div><hr><div id="local-search-results"><div id="local-hits"></div><div id="local-stats"><div class="local-search-stats__hr" id="hr"><span>由</span> <a href="https://github.com/wzpan/hexo-generator-search" style="color:#49B1F5;">hexo-generator-search</a>
 <span>提供支持</span></div></div></div><span class="search-close-button"><i class="fa fa-times"></i></span></div><div class="search-mask"></div></body></html>
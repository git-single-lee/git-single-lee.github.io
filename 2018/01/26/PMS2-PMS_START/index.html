<!DOCTYPE html><html lang="zh-Hans"><head><meta charset="UTF-8"><meta http-equiv="X-UA-Compatible" content="IE=edge"><meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1"><meta name="description" content="PMS 第 2 篇 - PMS_START 阶段"><meta name="keywords" content="PackageManager包管理"><meta name="author" content="Coolqi.Li,undefined"><meta name="copyright" content="Coolqi.Li"><title>PMS 第 2 篇 - PMS_START 阶段 | Coolqi`s Blog</title><link rel="shortcut icon" href="/img/favicon.ico"><link rel="stylesheet" href="/css/index.css?version=1.5.6"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/font-awesome@4.7.0/css/font-awesome.min.css?version=1.5.6"><link rel="dns-prefetch" href="https://cdn.staticfile.org"><link rel="dns-prefetch" href="https://cdn.bootcss.com"><link rel="dns-prefetch" href="https://creativecommons.org"><link rel="dns-prefetch" href="https://hm.baidu.com"><script>var _hmt = _hmt || [];
(function() {
  var hm = document.createElement("script");
  hm.src = "https://hm.baidu.com/hm.js?b7acef5306e54116ad8a99e8b753a92d";
  var s = document.getElementsByTagName("script")[0]; 
  s.parentNode.insertBefore(hm, s);
})();</script><script>var GLOBAL_CONFIG = { 
  root: '/',
  algolia: undefined,
  localSearch: {"path":"search.xml","languages":{"hits_empty":"找不到您查询的内容:${query}"}},
  copy: {
    success: '复制成功',
    error: '复制错误',
    noSupport: '浏览器不支持'
  }
} </script></head><body><i class="fa fa-arrow-right" id="toggle-sidebar" aria-hidden="true"></i><div id="sidebar"><div class="toggle-sidebar-info text-center"><span data-toggle="切换文章详情">切换站点概览</span><hr></div><div class="sidebar-toc"><div class="sidebar-toc__title">目录</div><div class="sidebar-toc__progress"><span class="progress-notice">你已经读了</span><span class="progress-num">0</span><span class="progress-percentage">%</span><div class="sidebar-toc__progress-bar"></div></div><div class="sidebar-toc__content"><ol class="toc"><li class="toc-item toc-level-1"><a class="toc-link" href="#0-综述"><span class="toc-text">0 综述</span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#1-Settings"><span class="toc-text">1 Settings</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#1-1-new-RuntimePermissionPersistence"><span class="toc-text">1.1 new RuntimePermissionPersistence</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#1-2-Settings-addSharedUserLPw"><span class="toc-text">1.2 Settings.addSharedUserLPw</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#1-2-1-SharedUserSetting"><span class="toc-text">1.2.1 SharedUserSetting</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#1-2-2-Settings-addUserIdLPw"><span class="toc-text">1.2.2 Settings.addUserIdLPw</span></a></li></ol></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#2-PackageDexOptimizer"><span class="toc-text">2 PackageDexOptimizer</span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#3-MoveCallbacks"><span class="toc-text">3 MoveCallbacks</span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#4-OnPermissionChangeListeners"><span class="toc-text">4 OnPermissionChangeListeners</span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#5-SystemConfig"><span class="toc-text">5 SystemConfig</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#2-1-SystemConfig-readPermissions"><span class="toc-text">2.1 SystemConfig.readPermissions</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#2-2-SystemConfig-readPermissionsFromXml"><span class="toc-text">2.2 SystemConfig.readPermissionsFromXml</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#2-2-1-解析-“group”-获得系统中的所有-gid"><span class="toc-text">2.2.1 解析 “group” - 获得系统中的所有 gid</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#2-2-2-解析-“permission”-获得系统权限和所属的-gid"><span class="toc-text">2.2.2 解析 “permission” - 获得系统权限和所属的 gid</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#2-2-3-解析-“assign-permission”-给指定的-uid-分配权限"><span class="toc-text">2.2.3 解析 “assign-permission” - 给指定的 uid 分配权限</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#2-2-4-解析-“library”-获得共享库信息"><span class="toc-text">2.2.4 解析 “library” - 获得共享库信息</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#2-2-5-解析-“feature”-获得系统特性配置信息"><span class="toc-text">2.2.5 解析 “feature” - 获得系统特性配置信息</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#2-2-6-解析其他的标签"><span class="toc-text">2.2.6 解析其他的标签</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#2-3-PMS-对于-SystemConfig-的后续处理"><span class="toc-text">2.3 PMS 对于 SystemConfig 的后续处理</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#2-4-阶段总结"><span class="toc-text">2.4 阶段总结</span></a></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#6-PackageHandler"><span class="toc-text">6 PackageHandler</span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#7-SELinuxMMAC-readInstallPolicy"><span class="toc-text">7 SELinuxMMAC.readInstallPolicy</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#7-1-SELinuxMMAC-readSignerOrThrow"><span class="toc-text">7.1 SELinuxMMAC.readSignerOrThrow</span></a></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#8-Settings-readLPw"><span class="toc-text">8 Settings.readLPw</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#8-1-读取-pacakges-xml-文件"><span class="toc-text">8.1 读取 pacakges.xml 文件</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#8-1-1-解析-“package”-标签"><span class="toc-text">8.1.1 解析 “package” 标签</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#8-1-1-1-Settings-readPackageLPw"><span class="toc-text">8.1.1.1 Settings.readPackageLPw</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#8-1-1-2-Settings-addPackageLPw"><span class="toc-text">8.1.1.2 Settings.addPackageLPw</span></a><ol class="toc-child"><li class="toc-item toc-level-5"><a class="toc-link" href="#8-1-1-2-1-Settings-addUserIdLPw"><span class="toc-text">8.1.1.2.1 Settings.addUserIdLPw</span></a></li></ol></li><li class="toc-item toc-level-4"><a class="toc-link" href="#8-1-1-3-解析-“disabled-components”-“enabled-component-子标签"><span class="toc-text">8.1.1.3 解析 “disabled-components” / “enabled-component 子标签</span></a><ol class="toc-child"><li class="toc-item toc-level-5"><a class="toc-link" href="#8-1-1-3-1-Settings-readDisabledComponentsLPw"><span class="toc-text">8.1.1.3.1 Settings.readDisabledComponentsLPw</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#8-1-1-3-2-Settings-readEnabledComponentsLPw"><span class="toc-text">8.1.1.3.2 Settings.readEnabledComponentsLPw</span></a></li></ol></li><li class="toc-item toc-level-4"><a class="toc-link" href="#8-1-1-4-解析-“perms”-子标签-解析安装时权限授予情况"><span class="toc-text">8.1.1.4 解析 “perms” 子标签 - 解析安装时权限授予情况</span></a><ol class="toc-child"><li class="toc-item toc-level-5"><a class="toc-link" href="#8-1-1-4-1-Setting-readInstallPermissionsLPr"><span class="toc-text">8.1.1.4.1 Setting.readInstallPermissionsLPr</span></a></li></ol></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#8-1-2-解析-“permissions”-“permission-trees”-标签"><span class="toc-text">8.1.2 解析 “permissions” “permission-trees” 标签</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#8-1-2-1-Settings-readPermissionsLPw"><span class="toc-text">8.1.2.1 Settings.readPermissionsLPw</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#8-1-3-解析-“shared-user”-标签"><span class="toc-text">8.1.3 解析 “shared-user” 标签</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#8-1-3-1-Settings-readSharedUserLPw"><span class="toc-text">8.1.3.1 Settings.readSharedUserLPw</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#8-1-3-2-Settings-addSharedUserLPw"><span class="toc-text">8.1.3.2 Settings.addSharedUserLPw</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#8-1-4-解析-“preferred-activities”-相关标签"><span class="toc-text">8.1.4 解析 “preferred-activities” 相关标签</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#8-1-4-1-Settings-readPreferredActivitiesLPw"><span class="toc-text">8.1.4.1 Settings.readPreferredActivitiesLPw</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#8-1-4-2-Settings-readPersistentPreferredActivitiesLPw"><span class="toc-text">8.1.4.2 Settings.readPersistentPreferredActivitiesLPw</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#8-1-5-解析-“updated-package”-标签"><span class="toc-text">8.1.5 解析 “updated-package” 标签</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#8-1-5-1-Settings-readDisabledSysPackageLPw"><span class="toc-text">8.1.5.1 Settings.readDisabledSysPackageLPw</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#8-1-6-解析-“cleaning-package”-标签"><span class="toc-text">8.1.6 解析 “cleaning-package” 标签</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#8-1-7-解析-“renamed-package”-标签"><span class="toc-text">8.1.7 解析 “renamed-package” 标签</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#8-1-8-阶段总结"><span class="toc-text">8.1.8 阶段总结</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#8-2-确定共享-uid-有效性"><span class="toc-text">8.2 确定共享 uid 有效性</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#8-2-1-Settings-getUserIdLPr"><span class="toc-text">8.2.1 Settings.getUserIdLPr</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#8-2-2-Settings-getPackageLPw"><span class="toc-text">8.2.2 Settings.getPackageLPw</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#8-2-2-1-Settings-addPackageSettingLPw"><span class="toc-text">8.2.2.1 Settings.addPackageSettingLPw</span></a></li></ol></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#8-3-读取-packages-stopped-xml-文件，偏好设置"><span class="toc-text">8.3 读取 packages_stopped.xml 文件，偏好设置</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#8-3-1-Settings-readStoppedLPw"><span class="toc-text">8.3.1 Settings.readStoppedLPw</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#8-3-2-Settings-writePackageRestrictionsLPr"><span class="toc-text">8.3.2 Settings.writePackageRestrictionsLPr</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#8-3-3-Settings-readPackageRestrictionsLPr"><span class="toc-text">8.3.3 Settings.readPackageRestrictionsLPr</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#8-4-读取运行时权限信息，并处理授予情况！"><span class="toc-text">8.4 读取运行时权限信息，并处理授予情况！</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#8-4-1-RuntimePermissionsPersistence-readStateForUserSyncLPr"><span class="toc-text">8.4.1 RuntimePermissionsPersistence.readStateForUserSyncLPr</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#8-4-2-Settings-parseRuntimePermissionsLPr"><span class="toc-text">8.4.2 Settings.parseRuntimePermissionsLPr</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#8-4-2-1-Settings-parsePermissionsLPr"><span class="toc-text">8.4.2.1 Settings.parsePermissionsLPr</span></a><ol class="toc-child"><li class="toc-item toc-level-5"><a class="toc-link" href="#8-4-2-1-1-Permissions-grantRuntimePermission"><span class="toc-text">8.4.2.1.1 Permissions.grantRuntimePermission</span></a></li></ol></li><li class="toc-item toc-level-4"><a class="toc-link" href="#8-4-2-2-Settings-parseRestoredRuntimePermissionsLPr"><span class="toc-text">8.4.2.2 Settings.parseRestoredRuntimePermissionsLPr</span></a></li></ol></li></ol></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#9-安装时权限处理过程分析-接-8-1-1-4"><span class="toc-text">9 安装时权限处理过程分析 - 接 8.1.1.4</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#9-1-PermissionsS-grantInstallPermission-处理授予情况"><span class="toc-text">9.1 PermissionsS.grantInstallPermission - 处理授予情况</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#9-1-1-PermissionsS-hasPermission"><span class="toc-text">9.1.1 PermissionsS.hasPermission</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#9-1-1-1-PermissionData-isGranted"><span class="toc-text">9.1.1.1 PermissionData.isGranted</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#9-1-2-BasePermission-computeGids"><span class="toc-text">9.1.2 BasePermission.computeGids</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#9-1-3-PermissionsS-computeGids"><span class="toc-text">9.1.3 PermissionsS.computeGids</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#9-1-3-1-PermissionData-computeGids"><span class="toc-text">9.1.3.1 PermissionData.computeGids</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#9-1-4-PermissionsS-ensurePermissionData"><span class="toc-text">9.1.4 PermissionsS.ensurePermissionData</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#9-1-4-1-new-PermissionData"><span class="toc-text">9.1.4.1 new PermissionData</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#9-1-5-PermissionData-grant"><span class="toc-text">9.1.5 PermissionData.grant</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#9-2-PermissionsS-revokeInstallPermission-处理不授予情况"><span class="toc-text">9.2 PermissionsS.revokeInstallPermission  - 处理不授予情况</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#9-2-1-PermissionData-revoke"><span class="toc-text">9.2.1 PermissionData.revoke</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#9-2-2-PermissionsS-ensureNoPermissionData"><span class="toc-text">9.2.2 PermissionsS.ensureNoPermissionData</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#9-3-PermissionsS-updatePermissionFlags-更新权限标志位"><span class="toc-text">9.3 PermissionsS.updatePermissionFlags  - 更新权限标志位</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#9-3-1-PermissionData-updateFlags"><span class="toc-text">9.3.1 PermissionData.updateFlags</span></a></li></ol></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#10-阶段总结"><span class="toc-text">10 阶段总结</span></a></li></ol></div></div><div class="author-info hide"><div class="author-info__avatar text-center"><img src="/img/avatar.jpg"></div><div class="author-info__name text-center">Coolqi.Li</div><div class="author-info__description text-center">“Hi，我是李帅奇，Android 开发工程师，TeamLeader，熬夜星人，一个努力赚钱，积极向上的好人。”</div><div class="follow-button"><a href="https://github.com/single-li">Follow Me</a></div><hr><div class="author-info-articles"><a class="author-info-articles__archives article-meta" href="/archives"><span class="pull-left">文章</span><span class="pull-right">86</span></a><a class="author-info-articles__tags article-meta" href="/tags"><span class="pull-left">标签</span><span class="pull-right">21</span></a><a class="author-info-articles__categories article-meta" href="/categories"><span class="pull-left">分类</span><span class="pull-right">26</span></a></div><hr><div class="author-info-links"><div class="author-info-links__title text-center">Links</div><a class="author-info-links__name text-center" href="https://developer.android.google.cn/">AndroidDeveloper</a><a class="author-info-links__name text-center" href="http://www.android-studio.org/">AndroidStudio</a><a class="author-info-links__name text-center" href="https://www.jianshu.com/u/123a20a96441">简书</a><a class="author-info-links__name text-center" href="https://weibo.com/coolqiLi">微博</a></div></div></div><div id="content-outer"><div id="top-container" style="background-image: url(/img/blog-bg.jpg)"><div id="page-header"><span class="pull-left"> <a id="site-name" href="/">Coolqi`s Blog</a></span><i class="fa fa-bars toggle-menu pull-right" aria-hidden="true"></i><span class="pull-right menus"><a class="site-page social-icon search"><i class="fa fa-search"></i><span> 搜索</span></a><a class="site-page" href="/">Home</a><a class="site-page" href="/categories">Categories</a><a class="site-page" href="/tags">Tags</a><a class="site-page" href="/archives">Archives</a><a class="site-page" href="/about">About</a></span></div><div id="post-info"><div id="post-title">PMS 第 2 篇 - PMS_START 阶段</div><div id="post-meta"><time class="post-meta__date"><i class="fa fa-calendar" aria-hidden="true"></i> 2018-01-26</time><span class="post-meta__separator">|</span><i class="fa fa-inbox post-meta__icon" aria-hidden="true"></i><a class="post-meta__categories" href="/categories/AndroidFramework源码分析/">AndroidFramework源码分析</a><i class="fa fa-angle-right" aria-hidden="true"></i><i class="fa fa-inbox post-meta__icon" aria-hidden="true"></i><a class="post-meta__categories" href="/categories/AndroidFramework源码分析/PackageManager包管理/">PackageManager包管理</a><div class="post-meta-wordcount"><span>字数总计: </span><span class="word-count">25.6k</span><span class="post-meta__separator">|</span><span>阅读时长: 127 分钟</span></div></div></div></div><div class="layout" id="content-inner"><article id="post"><div class="article-container" id="post-content"><p>[toc]</p>
<p>基于 Android 7.1.1 源码分析 PackageManagerService 的架构和逻辑实现，本文是作者原创，转载请说明出处！</p>
<h1 id="0-综述"><a href="#0-综述" class="headerlink" title="0 综述"></a>0 综述</h1><p>我们进入第一阶段来分析，代码比较长，我们先来个总体的阶段回顾：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="title">PackageManagerService</span><span class="params">(Context context, Installer installer,</span></span></span><br><span class="line"><span class="function"><span class="params">     <span class="keyword">boolean</span> factoryTest, <span class="keyword">boolean</span> onlyCore)</span> </span>&#123;</span><br><span class="line"> EventLog.writeEvent(EventLogTags.BOOT_PROGRESS_PMS_START,</span><br><span class="line">         SystemClock.uptimeMillis());</span><br><span class="line"></span><br><span class="line"> <span class="keyword">if</span> (mSdkVersion &lt;= <span class="number">0</span>) &#123;</span><br><span class="line">     <span class="comment">// mSdkVersion 是 PKMS 的成员变量，定义的时候进行赋值，</span></span><br><span class="line">     <span class="comment">// 其值取自系统属性 ro.build.version.sdk，即编译的 SDK 版本。</span></span><br><span class="line">     Slog.w(TAG, <span class="string">"**** ro.build.version.sdk not set!"</span>);</span><br><span class="line"> &#125;</span><br><span class="line"></span><br><span class="line"> mContext = context; <span class="comment">// 系统进程的上下文实例！</span></span><br><span class="line"> mFactoryTest = factoryTest; <span class="comment">// 默认为 false，即运行在非工厂模式下</span></span><br><span class="line"> mOnlyCore = onlyCore; <span class="comment">// 默认为 false，标记是否是只加载核心服务</span></span><br><span class="line"> </span><br><span class="line"> <span class="comment">// 用于存储与显示屏相关的一些属性，例如屏幕的宽 / 高尺寸，分辨率等信息。</span></span><br><span class="line"> mMetrics = <span class="keyword">new</span> DisplayMetrics(); </span><br><span class="line"></span><br><span class="line"> <span class="comment">//【1】在 Settings 中，创建 packages.xml、packages-backup.xml、packages.list 等文件对象</span></span><br><span class="line"> <span class="comment">// 并添加 system, phone, log, nfc, bluetooth, shell 这六种 shareUserId 到 mSettings，后面扫描和安装有用！</span></span><br><span class="line"> mSettings = <span class="keyword">new</span> Settings(mPackages);</span><br><span class="line"> mSettings.addSharedUserLPw(<span class="string">"android.uid.system"</span>, Process.SYSTEM_UID,</span><br><span class="line">         ApplicationInfo.FLAG_SYSTEM, ApplicationInfo.PRIVATE_FLAG_PRIVILEGED);</span><br><span class="line"> mSettings.addSharedUserLPw(<span class="string">"android.uid.phone"</span>, RADIO_UID,</span><br><span class="line">         ApplicationInfo.FLAG_SYSTEM, ApplicationInfo.PRIVATE_FLAG_PRIVILEGED);</span><br><span class="line"> mSettings.addSharedUserLPw(<span class="string">"android.uid.log"</span>, LOG_UID,</span><br><span class="line">         ApplicationInfo.FLAG_SYSTEM, ApplicationInfo.PRIVATE_FLAG_PRIVILEGED);</span><br><span class="line"> mSettings.addSharedUserLPw(<span class="string">"android.uid.nfc"</span>, NFC_UID,</span><br><span class="line">         ApplicationInfo.FLAG_SYSTEM, ApplicationInfo.PRIVATE_FLAG_PRIVILEGED);</span><br><span class="line"> mSettings.addSharedUserLPw(<span class="string">"android.uid.bluetooth"</span>, BLUETOOTH_UID,</span><br><span class="line">         ApplicationInfo.FLAG_SYSTEM, ApplicationInfo.PRIVATE_FLAG_PRIVILEGED);</span><br><span class="line"> mSettings.addSharedUserLPw(<span class="string">"android.uid.shell"</span>, SHELL_UID,</span><br><span class="line">         ApplicationInfo.FLAG_SYSTEM, ApplicationInfo.PRIVATE_FLAG_PRIVILEGED);</span><br><span class="line"></span><br><span class="line"> String separateProcesses = SystemProperties.get(<span class="string">"debug.separate_processes"</span>);</span><br><span class="line"> <span class="keyword">if</span> (separateProcesses != <span class="keyword">null</span> &amp;&amp; separateProcesses.length() &gt; <span class="number">0</span>) &#123;</span><br><span class="line">     <span class="keyword">if</span> (<span class="string">"*"</span>.equals(separateProcesses)) &#123;</span><br><span class="line">         mDefParseFlags = PackageParser.PARSE_IGNORE_PROCESSES;</span><br><span class="line">         mSeparateProcesses = <span class="keyword">null</span>;</span><br><span class="line">         Slog.w(TAG, <span class="string">"Running with debug.separate_processes: * (ALL)"</span>);</span><br><span class="line">     &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">         mDefParseFlags = <span class="number">0</span>;</span><br><span class="line">         mSeparateProcesses = separateProcesses.split(<span class="string">","</span>);</span><br><span class="line">         Slog.w(TAG, <span class="string">"Running with debug.separate_processes: "</span></span><br><span class="line">                 + separateProcesses);</span><br><span class="line">     &#125;</span><br><span class="line"> &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">     mDefParseFlags = <span class="number">0</span>;</span><br><span class="line">     mSeparateProcesses = <span class="keyword">null</span>;</span><br><span class="line"> &#125;</span><br><span class="line"></span><br><span class="line"> <span class="comment">// 初始化 mInstaller 对象，installer 对象和 Native 进程 installd 交互，以后分析 installd 时再来讨论它的作用！</span></span><br><span class="line"> mInstaller = installer;</span><br><span class="line"> </span><br><span class="line"> <span class="comment">//【2】创建 PackageDexOptimizer 对象，用于 dex 优化！</span></span><br><span class="line"> mPackageDexOptimizer = <span class="keyword">new</span> PackageDexOptimizer(installer, mInstallLock, context,</span><br><span class="line">         <span class="string">"*dexopt*"</span>);</span><br><span class="line">         </span><br><span class="line"> <span class="comment">//【3】创建 MoveCallbacks 对象，用于操作回滚！</span></span><br><span class="line"> mMoveCallbacks = <span class="keyword">new</span> MoveCallbacks(FgThread.get().getLooper());</span><br><span class="line"> </span><br><span class="line"> <span class="comment">//【4】创建 OnPermissionChangeListeners 对象，用于监听权限改变！</span></span><br><span class="line"> mOnPermissionChangeListeners = <span class="keyword">new</span> OnPermissionChangeListeners(</span><br><span class="line">         FgThread.get().getLooper());</span><br><span class="line"></span><br><span class="line"> getDefaultDisplayMetrics(context, mMetrics);</span><br><span class="line"></span><br><span class="line"> <span class="comment">//【5】创建 SystemConfig 对象，用于获取系统配置信息</span></span><br><span class="line"> <span class="comment">// 主要有 /system/etc/ 目录和 /system/etc/ 目录下的 sysconfig 和 permissions 文件夹中的 xml 文件</span></span><br><span class="line"> SystemConfig systemConfig = SystemConfig.getInstance();</span><br><span class="line"> mGlobalGids = systemConfig.getGlobalGids();</span><br><span class="line"> mSystemPermissions = systemConfig.getSystemPermissions();</span><br><span class="line"> mAvailableFeatures = systemConfig.getAvailableFeatures();</span><br><span class="line"></span><br><span class="line"> mProtectedPackages = <span class="keyword">new</span> ProtectedPackages(mContext);</span><br><span class="line"></span><br><span class="line"> <span class="keyword">synchronized</span> (mInstallLock) &#123;</span><br><span class="line"> <span class="comment">// writer</span></span><br><span class="line"> <span class="keyword">synchronized</span> (mPackages) &#123;</span><br><span class="line">     <span class="comment">//【6】建立并启动一个名为 “PackageManager” 的 HandlerThread，类型是 ServiceThread，处理安装卸载的消息！</span></span><br><span class="line">     mHandlerThread = <span class="keyword">new</span> ServiceThread(TAG,</span><br><span class="line">             Process.THREAD_PRIORITY_BACKGROUND, <span class="keyword">true</span> <span class="comment">/*allowIo*/</span>);</span><br><span class="line">     mHandlerThread.start();</span><br><span class="line">     </span><br><span class="line">     <span class="comment">//【7】创建一个 PackageHandler 对象，绑定前面创建的 HandlerThread！</span></span><br><span class="line">     mHandler = <span class="keyword">new</span> PackageHandler(mHandlerThread.getLooper());</span><br><span class="line"></span><br><span class="line">     mProcessLoggingHandler = <span class="keyword">new</span> ProcessLoggingHandler();</span><br><span class="line">     Watchdog.getInstance().addThread(mHandler, WATCHDOG_TIMEOUT);</span><br><span class="line">     </span><br><span class="line">     <span class="comment">//【8】创建默认权限管理对象，用于给某些预制的 apk 给予权限，也可以撤销！</span></span><br><span class="line">     mDefaultPermissionPolicy = <span class="keyword">new</span> DefaultPermissionGrantPolicy(<span class="keyword">this</span>);</span><br><span class="line">     </span><br><span class="line">     <span class="comment">// 创建需要扫描检测的目录文件对象，为扫描做准备！</span></span><br><span class="line">     File dataDir = Environment.getDataDirectory();</span><br><span class="line">     mAppInstallDir = <span class="keyword">new</span> File(dataDir, <span class="string">"app"</span>); <span class="comment">// /data/data，存放应用程序的数据</span></span><br><span class="line">     mAppLib32InstallDir = <span class="keyword">new</span> File(dataDir, <span class="string">"app-lib"</span>);  <span class="comment">// /data/app-lib，用于存放用户自己安装的第三方应用程序</span></span><br><span class="line">     mEphemeralInstallDir = <span class="keyword">new</span> File(dataDir, <span class="string">"app-ephemeral"</span>);  <span class="comment">// /data/app-ephemeral</span></span><br><span class="line">     mAsecInternalPath = <span class="keyword">new</span> File(dataDir, <span class="string">"app-asec"</span>).getPath();  <span class="comment">// /data/app-asec</span></span><br><span class="line">     mDrmAppPrivateInstallDir = <span class="keyword">new</span> File(dataDir, <span class="string">"app-private"</span>);  <span class="comment">// /data/app-private，存放私有应用程序！</span></span><br><span class="line"></span><br><span class="line">     <span class="comment">//【9】创建用户管理服务！    </span></span><br><span class="line">     sUserManager = <span class="keyword">new</span> UserManagerService(context, <span class="keyword">this</span>, mPackages);</span><br><span class="line"></span><br><span class="line">     <span class="comment">//【10】将前面 SystemConfig 获得的系统权限保存到 mSettings.mPermissions 中！</span></span><br><span class="line">     ArrayMap&lt;String, SystemConfig.PermissionEntry&gt; permConfig</span><br><span class="line">             = systemConfig.getPermissions();</span><br><span class="line">     <span class="keyword">for</span> (<span class="keyword">int</span> i=<span class="number">0</span>; i&lt;permConfig.size(); i++) &#123;</span><br><span class="line">         SystemConfig.PermissionEntry perm = permConfig.valueAt(i);</span><br><span class="line">         BasePermission bp = mSettings.mPermissions.get(perm.name);</span><br><span class="line"></span><br><span class="line">         <span class="keyword">if</span> (bp == <span class="keyword">null</span>) &#123;</span><br><span class="line">             bp = <span class="keyword">new</span> BasePermission(perm.name, <span class="string">"android"</span>, BasePermission.TYPE_BUILTIN);</span><br><span class="line">             mSettings.mPermissions.put(perm.name, bp);</span><br><span class="line">         &#125;</span><br><span class="line"></span><br><span class="line">         <span class="keyword">if</span> (perm.gids != <span class="keyword">null</span>) &#123;</span><br><span class="line">             bp.setGids(perm.gids, perm.perUser);</span><br><span class="line">         &#125;</span><br><span class="line">     &#125;</span><br><span class="line"></span><br><span class="line">     <span class="comment">//【11】处理共享库！</span></span><br><span class="line">     ArrayMap&lt;String, String&gt; libConfig = systemConfig.getSharedLibraries();</span><br><span class="line">     <span class="keyword">for</span> (<span class="keyword">int</span> i=<span class="number">0</span>; i&lt;libConfig.size(); i++) &#123;</span><br><span class="line">         mSharedLibraries.put(libConfig.keyAt(i),</span><br><span class="line">                 <span class="keyword">new</span> SharedLibraryEntry(libConfig.valueAt(i), <span class="keyword">null</span>));</span><br><span class="line">     &#125;</span><br><span class="line">     </span><br><span class="line">     <span class="comment">//【12】从 /etc/security/mac_permissions.xml 读取 SELinux 信息！</span></span><br><span class="line">     mFoundPolicyFile = SELinuxMMAC.readInstallPolicy();</span><br><span class="line">     </span><br><span class="line">     <span class="comment">//【13】解析 packages.xml 文件，获得上一次的安装信息。返回值表示是否是第一次开机！</span></span><br><span class="line">     <span class="comment">// 如果是第一次开机，那么是读不到上次的数据的！</span></span><br><span class="line">     mFirstBoot = !mSettings.readLPw(sUserManager.getUsers(<span class="keyword">false</span>));</span><br><span class="line"></span><br><span class="line">     <span class="comment">//【14】如果应用是被更新过的系统应用，且位于 data 分区的 apk 文件不存在了</span></span><br><span class="line">     <span class="comment">// 那就移除上一次的 data 分区的安装信息，恢复为 system 分区的安装信息！</span></span><br><span class="line">     <span class="comment">// 这里貌似是为了解决一个 bug:32321269!</span></span><br><span class="line">     <span class="keyword">final</span> <span class="keyword">int</span> packageSettingCount = mSettings.mPackages.size();</span><br><span class="line">     <span class="keyword">for</span> (<span class="keyword">int</span> i = packageSettingCount - <span class="number">1</span>; i &gt;= <span class="number">0</span>; i--) &#123;</span><br><span class="line">         PackageSetting ps = mSettings.mPackages.valueAt(i);</span><br><span class="line">         <span class="keyword">if</span> (!isExternal(ps) &amp;&amp; (ps.codePath == <span class="keyword">null</span> || !ps.codePath.exists())</span><br><span class="line">                 &amp;&amp; mSettings.getDisabledSystemPkgLPr(ps.name) != <span class="keyword">null</span>) &#123;</span><br><span class="line">             mSettings.mPackages.removeAt(i);</span><br><span class="line">             mSettings.enableSystemPackageLPw(ps.name);</span><br><span class="line">         &#125;</span><br><span class="line">     &#125;</span><br><span class="line"></span><br><span class="line">     <span class="keyword">if</span> (mFirstBoot) &#123;</span><br><span class="line">         <span class="comment">//【15】如果是第一次开机，从另外一个系统拷贝 odex 文件到当前系统的 data 分区</span></span><br><span class="line">         <span class="comment">// Android 7.1 引进了 AB 升级，这个是 AB 升级的特性，可以先不看！</span></span><br><span class="line">         requestCopyPreoptedFiles();</span><br><span class="line">     &#125;</span><br><span class="line"></span><br><span class="line">     String customResolverActivity = Resources.getSystem().getString(</span><br><span class="line">             R.string.config_customResolverActivity);</span><br><span class="line">     <span class="keyword">if</span> (TextUtils.isEmpty(customResolverActivity)) &#123;</span><br><span class="line">         customResolverActivity = <span class="keyword">null</span>;</span><br><span class="line">     &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">         mCustomResolverComponentName = ComponentName.unflattenFromString(</span><br><span class="line">                 customResolverActivity);</span><br><span class="line">     &#125;</span><br><span class="line">      </span><br><span class="line">     ... ... ... ...<span class="comment">// 见，第二阶段</span></span><br></pre></td></tr></table></figure>
<p>下面我们来逐一分析这个阶段的过程：</p>
<h1 id="1-Settings"><a href="#1-Settings" class="headerlink" title="1 Settings"></a>1 Settings</h1><p>首先，创建了 Settings 对象：！</p>
<p>参数传递：</p>
<ul>
<li>Object lock：mPackage 对象！</li>
</ul>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">Settings(Object lock) &#123;</span><br><span class="line">    <span class="comment">// 调用第二个构造器！</span></span><br><span class="line">    <span class="keyword">this</span>(Environment.getDataDirectory(), lock);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>接着调用第二个构造函数：<br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line">Settings(File dataDir, Object lock) &#123;</span><br><span class="line">    mLock = lock;</span><br><span class="line">    <span class="comment">// 用于处理运行时权限相关的操作！</span></span><br><span class="line">    mRuntimePermissionsPersistence = <span class="keyword">new</span> RuntimePermissionPersistence(mLock);</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// 创建 /data/system 目录，并设置该目录的权限！</span></span><br><span class="line">    mSystemDir = <span class="keyword">new</span> File(dataDir, <span class="string">"system"</span>);</span><br><span class="line">    mSystemDir.mkdirs();</span><br><span class="line">    FileUtils.setPermissions(mSystemDir.toString(),</span><br><span class="line">            FileUtils.S_IRWXU|FileUtils.S_IRWXG</span><br><span class="line">            |FileUtils.S_IROTH|FileUtils.S_IXOTH,</span><br><span class="line">            -<span class="number">1</span>, -<span class="number">1</span>);</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// 创建 packages.xml 和 packages-backup.xml 文件对象</span></span><br><span class="line">    mSettingsFilename = <span class="keyword">new</span> File(mSystemDir, <span class="string">"packages.xml"</span>);</span><br><span class="line">    mBackupSettingsFilename = <span class="keyword">new</span> File(mSystemDir, <span class="string">"packages-backup.xml"</span>);</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 创建 packages.list 文件对象，并设置权限信息！</span></span><br><span class="line">    mPackageListFilename = <span class="keyword">new</span> File(mSystemDir, <span class="string">"packages.list"</span>);</span><br><span class="line">    FileUtils.setPermissions(mPackageListFilename, <span class="number">0640</span>, SYSTEM_UID, PACKAGE_INFO_GID);</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 创建 sdcardfs 文件对象！</span></span><br><span class="line">    <span class="keyword">final</span> File kernelDir = <span class="keyword">new</span> File(<span class="string">"/config/sdcardfs"</span>);</span><br><span class="line">    mKernelMappingFilename = kernelDir.exists() ? kernelDir : <span class="keyword">null</span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 创建 packages-stopped.xml 和 packages-stopped-backup.xml 文件对象！</span></span><br><span class="line">    mStoppedPackagesFilename = <span class="keyword">new</span> File(mSystemDir, <span class="string">"packages-stopped.xml"</span>);</span><br><span class="line">    mBackupStoppedPackagesFilename = <span class="keyword">new</span> File(mSystemDir, <span class="string">"packages-stopped-backup.xml"</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>Settings 对象的构造器很简单，这里要重点说明一下；</p>
<ul>
<li>packages.xml 和 packages-backup.xml 文件是一组，用于描述系统中所安装的所有 Package 信息，PMS 会先把数据写入 packages-backup.xml，信息写成功后，再改名为 packages.xml ！</li>
<li>packages.list 文件同样保存了系统中所有的应用的信息！</li>
<li>packages-stopped.xml 和 packages-stopped-backup.xml 文件是一组，用于描述被强行停止运行的 package 信息！</li>
</ul>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">com.android.settings <span class="number">1000</span> <span class="number">0</span> /data/user_de/<span class="number">0</span>/com.android.settings platform:privapp <span class="number">2001</span>,<span class="number">3009</span>,<span class="number">3002</span>,<span class="number">1023</span>,<span class="number">1015</span>,<span class="number">3003</span>,<span class="number">3001</span>,<span class="number">1004</span>,<span class="number">2002</span>,<span class="number">1007</span>,<span class="number">3006</span>,<span class="number">3188</span></span><br></pre></td></tr></table></figure>
<h2 id="1-1-new-RuntimePermissionPersistence"><a href="#1-1-new-RuntimePermissionPersistence" class="headerlink" title="1.1 new RuntimePermissionPersistence"></a>1.1 new RuntimePermissionPersistence</h2><p>创建运行时权限管理对象！</p>
<h2 id="1-2-Settings-addSharedUserLPw"><a href="#1-2-Settings-addSharedUserLPw" class="headerlink" title="1.2 Settings.addSharedUserLPw"></a>1.2 Settings.addSharedUserLPw</h2><p>接着调用了 <strong>addSharedUserLPw</strong> 方法，添加了几个系统共享用户，参数传递：</p>
<ul>
<li><strong>String name：</strong>共享用户名，下面是传入的用户名：<ul>
<li>android.uid.system</li>
<li>android.uid.phone</li>
<li>android.uid.log</li>
<li>android.uid.nfc</li>
<li>android.uid.bluetooth</li>
<li>android.uid.shell</li>
</ul>
</li>
<li><strong>int uid：</strong>共享用户 id，下面的用户名和上面的 id 一一对应！<ul>
<li>Process.SYSTEM_UID</li>
<li>RADIO_UID</li>
<li>LOG_UID</li>
<li>NFC_UID</li>
<li>BLUETOOTH_UID</li>
<li>SHELL_UID</li>
</ul>
</li>
<li><strong>int pkgFlags：</strong><ul>
<li>ApplicationInfo.FLAG_SYSTEM </li>
</ul>
</li>
<li><strong>int pkgPrivateFlags：</strong><ul>
<li>ApplicationInfo.PRIVATE_FLAG_PRIVILEGED</li>
</ul>
</li>
</ul>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="function">SharedUserSetting <span class="title">addSharedUserLPw</span><span class="params">(String name, <span class="keyword">int</span> uid, <span class="keyword">int</span> pkgFlags, <span class="keyword">int</span> pkgPrivateFlags)</span> </span>&#123;</span><br><span class="line">    SharedUserSetting s = mSharedUsers.get(name);</span><br><span class="line">    <span class="keyword">if</span> (s != <span class="keyword">null</span>) &#123;</span><br><span class="line">        <span class="keyword">if</span> (s.userId == uid) &#123;</span><br><span class="line">            <span class="keyword">return</span> s;</span><br><span class="line">        &#125;</span><br><span class="line">        PackageManagerService.reportSettingsProblem(Log.ERROR,</span><br><span class="line">                <span class="string">"Adding duplicate shared user, keeping first: "</span> + name);</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">null</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//【1.1.1】创建 SharedUserSetting 对象，封装 SharedUserId！</span></span><br><span class="line">    s = <span class="keyword">new</span> SharedUserSetting(name, pkgFlags, pkgPrivateFlags);</span><br><span class="line">    s.userId = uid;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">//【1.1.2】根据 uid 的范围，保存到到 mUserIds 或 mOtherUserIds 中！</span></span><br><span class="line">    <span class="keyword">if</span> (addUserIdLPw(uid, s, name)) &#123;</span><br><span class="line">        <span class="comment">//【1.1.2.1】添加到 mSharedUsers 中！</span></span><br><span class="line">        mSharedUsers.put(name, s);</span><br><span class="line">        <span class="keyword">return</span> s;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">null</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h3 id="1-2-1-SharedUserSetting"><a href="#1-2-1-SharedUserSetting" class="headerlink" title="1.2.1 SharedUserSetting"></a>1.2.1 SharedUserSetting</h3><p>我们来看看 SharedUserSetting 这个对象：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">final</span> <span class="class"><span class="keyword">class</span> <span class="title">SharedUserSetting</span> <span class="keyword">extends</span> <span class="title">SettingBase</span> </span>&#123;</span><br><span class="line">    <span class="comment">// 共享 uid 的名称</span></span><br><span class="line">    <span class="keyword">final</span> String name;</span><br><span class="line">    <span class="comment">// uid 值</span></span><br><span class="line">    <span class="keyword">int</span> userId;</span><br><span class="line">    <span class="comment">// 和这个 sharedUserId 相关的 flags</span></span><br><span class="line">    <span class="keyword">int</span> uidFlags; <span class="comment">// 取值为 ApplicationInfo.FLAG_SYSTEM</span></span><br><span class="line">    <span class="keyword">int</span> uidPrivateFlags; <span class="comment">// 取值为 ApplicationInfo.FLAG_SYSTEM</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">// 使用这个共享 uid 的所有应用程序 package！</span></span><br><span class="line">    <span class="keyword">final</span> ArraySet&lt;PackageSetting&gt; packages = <span class="keyword">new</span> ArraySet&lt;PackageSetting&gt;();</span><br><span class="line"></span><br><span class="line">    <span class="keyword">final</span> PackageSignatures signatures = <span class="keyword">new</span> PackageSignatures();</span><br><span class="line"></span><br><span class="line">    SharedUserSetting(String _name, <span class="keyword">int</span> _pkgFlags, <span class="keyword">int</span> _pkgPrivateFlags) &#123;</span><br><span class="line">        <span class="keyword">super</span>(_pkgFlags, _pkgPrivateFlags);</span><br><span class="line">        uidFlags =  _pkgFlags;</span><br><span class="line">        uidPrivateFlags = _pkgPrivateFlags;</span><br><span class="line">        name = _name;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> String <span class="title">toString</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="string">"SharedUserSetting&#123;"</span> + Integer.toHexString(System.identityHashCode(<span class="keyword">this</span>)) + <span class="string">" "</span></span><br><span class="line">                + name + <span class="string">"/"</span> + userId + <span class="string">"&#125;"</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    ... ... ...</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>代码很简单，这里就不多说了！</p>
<h3 id="1-2-2-Settings-addUserIdLPw"><a href="#1-2-2-Settings-addUserIdLPw" class="headerlink" title="1.2.2 Settings.addUserIdLPw"></a>1.2.2 Settings.addUserIdLPw</h3><p>addUserIdLPw 用于将创建的 sharedUserId 对象根据其 uid 是系统 uid 还是非系统 uid ，添加到指定的集合中！</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">boolean</span> <span class="title">addUserIdLPw</span><span class="params">(<span class="keyword">int</span> uid, Object obj, Object name)</span> </span>&#123;</span><br><span class="line">    <span class="comment">// uid 不能超过限制！</span></span><br><span class="line">    <span class="keyword">if</span> (uid &gt; Process.LAST_APPLICATION_UID) &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">false</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//【1】如果 uid 属于非系统应用，将其加入到 mUserIds 集合中！</span></span><br><span class="line">    <span class="keyword">if</span> (uid &gt;= Process.FIRST_APPLICATION_UID) &#123;</span><br><span class="line">        <span class="keyword">int</span> N = mUserIds.size();</span><br><span class="line">        <span class="keyword">final</span> <span class="keyword">int</span> index = uid - Process.FIRST_APPLICATION_UID;</span><br><span class="line">        <span class="keyword">while</span> (index &gt;= N) &#123;</span><br><span class="line">            mUserIds.add(<span class="keyword">null</span>);</span><br><span class="line">            N++;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">if</span> (mUserIds.get(index) != <span class="keyword">null</span>) &#123;</span><br><span class="line">            PackageManagerService.reportSettingsProblem(Log.ERROR,</span><br><span class="line">                    <span class="string">"Adding duplicate user id: "</span> + uid</span><br><span class="line">                    + <span class="string">" name="</span> + name);</span><br><span class="line">            <span class="keyword">return</span> <span class="keyword">false</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        mUserIds.set(index, obj);</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">    </span><br><span class="line">        <span class="comment">//【2】如果 uid 属于系统应用，将其加入到 mOtherUserIds 集合中！</span></span><br><span class="line">        <span class="keyword">if</span> (mOtherUserIds.get(uid) != <span class="keyword">null</span>) &#123;</span><br><span class="line">            PackageManagerService.reportSettingsProblem(Log.ERROR,</span><br><span class="line">                    <span class="string">"Adding duplicate shared id: "</span> + uid</span><br><span class="line">                            + <span class="string">" name="</span> + name);</span><br><span class="line">            <span class="keyword">return</span> <span class="keyword">false</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        mOtherUserIds.put(uid, obj);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">true</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>这里来说明一下：</p>
<blockquote>
<p>涉及的常量</p>
</blockquote>
<ul>
<li>Process.FIRST_APPLICATION_UID：取值 10000，用来区分系统应用 uid 和非系统应用的 uid。非系统应用的 uid 大于等于 10000，小于等于 19999，系统应用的 uid 小于 10000；</li>
<li>Process.LAST_APPLICATION_UID：取值 19999，表示应用程序的 uid 最大为 19999！</li>
</ul>
<blockquote>
<p>总结</p>
</blockquote>
<ul>
<li>mSharedUsers 集合用来保存所有的共享用户id！</li>
<li>mUserIds 集合中会保存非系统应用的 uid，包括共享和非共享！</li>
<li>mOtherUserIds 集合中会保存系统应用的 uid，包括共享和非共享！</li>
</ul>
<h1 id="2-PackageDexOptimizer"><a href="#2-PackageDexOptimizer" class="headerlink" title="2 PackageDexOptimizer"></a>2 PackageDexOptimizer</h1><p>PackageDexOptimizer 用于进行 odex 优化，我们来先简单的看看代码，参数传递：</p>
<ul>
<li>Installer installer：installer 对象，用于安装程序；</li>
<li>Object installLock：Object() 锁对象！</li>
<li>Context context：系统进程上下文实例！</li>
<li>String wakeLockTag：传入”<em>dexopt</em>“</li>
</ul>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">PackageDexOptimizer</span> </span>&#123;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> String TAG = <span class="string">"PackageManager.DexOptimizer"</span>;</span><br><span class="line">    <span class="keyword">static</span> <span class="keyword">final</span> String OAT_DIR_NAME = <span class="string">"oat"</span>;</span><br><span class="line">    <span class="comment">// TODO b/19550105 Remove error codes and use exceptions</span></span><br><span class="line">    <span class="keyword">static</span> <span class="keyword">final</span> <span class="keyword">int</span> DEX_OPT_SKIPPED = <span class="number">0</span>;</span><br><span class="line">    <span class="keyword">static</span> <span class="keyword">final</span> <span class="keyword">int</span> DEX_OPT_PERFORMED = <span class="number">1</span>;</span><br><span class="line">    <span class="keyword">static</span> <span class="keyword">final</span> <span class="keyword">int</span> DEX_OPT_FAILED = -<span class="number">1</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> Installer mInstaller;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> Object mInstallLock;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> PowerManager.WakeLock mDexoptWakeLock;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">volatile</span> <span class="keyword">boolean</span> mSystemReady;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 调用的这个构造器！</span></span><br><span class="line">    PackageDexOptimizer(Installer installer, Object installLock, Context context,</span><br><span class="line">            String wakeLockTag) &#123;</span><br><span class="line">        <span class="keyword">this</span>.mInstaller = installer;</span><br><span class="line">        <span class="keyword">this</span>.mInstallLock = installLock;</span><br><span class="line"></span><br><span class="line">        PowerManager powerManager = (PowerManager)context.getSystemService(Context.POWER_SERVICE);</span><br><span class="line">        mDexoptWakeLock = powerManager.newWakeLock(PowerManager.PARTIAL_WAKE_LOCK, wakeLockTag);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">protected</span> <span class="title">PackageDexOptimizer</span><span class="params">(PackageDexOptimizer from)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">this</span>.mInstaller = from.mInstaller;</span><br><span class="line">        <span class="keyword">this</span>.mInstallLock = from.mInstallLock;</span><br><span class="line">        <span class="keyword">this</span>.mDexoptWakeLock = from.mDexoptWakeLock;</span><br><span class="line">        <span class="keyword">this</span>.mSystemReady = from.mSystemReady;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    ... ... ... ...</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>这里创建了 PackageDexOptimizer 对象，后续执行 odex 优化会用到！</p>
<h1 id="3-MoveCallbacks"><a href="#3-MoveCallbacks" class="headerlink" title="3 MoveCallbacks"></a>3 MoveCallbacks</h1><p>用于监听 package 的 move 操作！！</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">private</span> <span class="keyword">static</span> <span class="class"><span class="keyword">class</span> <span class="title">MoveCallbacks</span> <span class="keyword">extends</span> <span class="title">Handler</span> </span>&#123;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="keyword">int</span> MSG_CREATED = <span class="number">1</span>;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="keyword">int</span> MSG_STATUS_CHANGED = <span class="number">2</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> RemoteCallbackList&lt;IPackageMoveObserver&gt;</span><br><span class="line">            mCallbacks = <span class="keyword">new</span> RemoteCallbackList&lt;&gt;();</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> SparseIntArray mLastStatus = <span class="keyword">new</span> SparseIntArray();</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="title">MoveCallbacks</span><span class="params">(Looper looper)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">super</span>(looper);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">register</span><span class="params">(IPackageMoveObserver callback)</span> </span>&#123;</span><br><span class="line">        mCallbacks.register(callback);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">unregister</span><span class="params">(IPackageMoveObserver callback)</span> </span>&#123;</span><br><span class="line">        mCallbacks.unregister(callback);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">handleMessage</span><span class="params">(Message msg)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">final</span> SomeArgs args = (SomeArgs) msg.obj;</span><br><span class="line">        <span class="keyword">final</span> <span class="keyword">int</span> n = mCallbacks.beginBroadcast();</span><br><span class="line">        <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; n; i++) &#123;</span><br><span class="line">            <span class="keyword">final</span> IPackageMoveObserver callback = mCallbacks.getBroadcastItem(i);</span><br><span class="line">            <span class="keyword">try</span> &#123;</span><br><span class="line">                invokeCallback(callback, msg.what, args);</span><br><span class="line">            &#125; <span class="keyword">catch</span> (RemoteException ignored) &#123;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        mCallbacks.finishBroadcast();</span><br><span class="line">        args.recycle();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">invokeCallback</span><span class="params">(IPackageMoveObserver callback, <span class="keyword">int</span> what, SomeArgs args)</span></span></span><br><span class="line"><span class="function">            <span class="keyword">throws</span> RemoteException </span>&#123;</span><br><span class="line">        <span class="keyword">switch</span> (what) &#123;</span><br><span class="line">            <span class="keyword">case</span> MSG_CREATED: &#123;</span><br><span class="line">                callback.onCreated(args.argi1, (Bundle) args.arg2);</span><br><span class="line">                <span class="keyword">break</span>;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">case</span> MSG_STATUS_CHANGED: &#123;</span><br><span class="line">                callback.onStatusChanged(args.argi1, args.argi2, (<span class="keyword">long</span>) args.arg3);</span><br><span class="line">                <span class="keyword">break</span>;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">notifyCreated</span><span class="params">(<span class="keyword">int</span> moveId, Bundle extras)</span> </span>&#123;</span><br><span class="line">        Slog.v(TAG, <span class="string">"Move "</span> + moveId + <span class="string">" created "</span> + extras.toString());</span><br><span class="line"></span><br><span class="line">        <span class="keyword">final</span> SomeArgs args = SomeArgs.obtain();</span><br><span class="line">        args.argi1 = moveId;</span><br><span class="line">        args.arg2 = extras;</span><br><span class="line">        obtainMessage(MSG_CREATED, args).sendToTarget();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">notifyStatusChanged</span><span class="params">(<span class="keyword">int</span> moveId, <span class="keyword">int</span> status)</span> </span>&#123;</span><br><span class="line">        notifyStatusChanged(moveId, status, -<span class="number">1</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">notifyStatusChanged</span><span class="params">(<span class="keyword">int</span> moveId, <span class="keyword">int</span> status, <span class="keyword">long</span> estMillis)</span> </span>&#123;</span><br><span class="line">        Slog.v(TAG, <span class="string">"Move "</span> + moveId + <span class="string">" status "</span> + status);</span><br><span class="line"></span><br><span class="line">        <span class="keyword">final</span> SomeArgs args = SomeArgs.obtain();</span><br><span class="line">        args.argi1 = moveId;</span><br><span class="line">        args.argi2 = status;</span><br><span class="line">        args.arg3 = estMillis;</span><br><span class="line">        obtainMessage(MSG_STATUS_CHANGED, args).sendToTarget();</span><br><span class="line"></span><br><span class="line">        <span class="keyword">synchronized</span> (mLastStatus) &#123;</span><br><span class="line">            mLastStatus.put(moveId, status);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h1 id="4-OnPermissionChangeListeners"><a href="#4-OnPermissionChangeListeners" class="headerlink" title="4 OnPermissionChangeListeners"></a>4 OnPermissionChangeListeners</h1><p>创建 OnPermissionChangeListeners 对象！<br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 创建 OnPermissionChangeListeners 对象，用于监听权限改变！</span></span><br><span class="line">mOnPermissionChangeListeners = <span class="keyword">new</span> OnPermissionChangeListeners(</span><br><span class="line">        FgThread.get().getLooper());</span><br></pre></td></tr></table></figure></p>
<p>OnPermissionChangeListeners 用于监听权限的改变：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">private</span> <span class="keyword">final</span> <span class="keyword">static</span> <span class="class"><span class="keyword">class</span> <span class="title">OnPermissionChangeListeners</span> <span class="keyword">extends</span> <span class="title">Handler</span> </span>&#123;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="keyword">int</span> MSG_ON_PERMISSIONS_CHANGED = <span class="number">1</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> RemoteCallbackList&lt;IOnPermissionsChangeListener&gt; mPermissionListeners =</span><br><span class="line">            <span class="keyword">new</span> RemoteCallbackList&lt;&gt;();</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="title">OnPermissionChangeListeners</span><span class="params">(Looper looper)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">super</span>(looper);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">handleMessage</span><span class="params">(Message msg)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">switch</span> (msg.what) &#123;</span><br><span class="line">            <span class="comment">//【2】处理 MSG_ON_PERMISSIONS_CHANGED 消息！</span></span><br><span class="line">            <span class="keyword">case</span> MSG_ON_PERMISSIONS_CHANGED: &#123;</span><br><span class="line">                <span class="keyword">final</span> <span class="keyword">int</span> uid = msg.arg1;</span><br><span class="line">                handleOnPermissionsChanged(uid);</span><br><span class="line">            &#125; <span class="keyword">break</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 添加权限改变监听器！</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">addListenerLocked</span><span class="params">(IOnPermissionsChangeListener listener)</span> </span>&#123;</span><br><span class="line">        mPermissionListeners.register(listener);</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// 移除权限改变监听器！</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">removeListenerLocked</span><span class="params">(IOnPermissionsChangeListener listener)</span> </span>&#123;</span><br><span class="line">        mPermissionListeners.unregister(listener);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onPermissionsChanged</span><span class="params">(<span class="keyword">int</span> uid)</span> </span>&#123;</span><br><span class="line">        <span class="comment">//【1】uid 的权限改变后，会触发这个方法，发送 MSG_ON_PERMISSIONS_CHANGED 消息！</span></span><br><span class="line">        <span class="keyword">if</span> (mPermissionListeners.getRegisteredCallbackCount() &gt; <span class="number">0</span>) &#123;</span><br><span class="line">            obtainMessage(MSG_ON_PERMISSIONS_CHANGED, uid, <span class="number">0</span>).sendToTarget();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//【3】uid 对应的应用程序的权限发生了变化！</span></span><br><span class="line">    <span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">handleOnPermissionsChanged</span><span class="params">(<span class="keyword">int</span> uid)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">final</span> <span class="keyword">int</span> count = mPermissionListeners.beginBroadcast();</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; count; i++) &#123;</span><br><span class="line">                IOnPermissionsChangeListener callback = mPermissionListeners</span><br><span class="line">                        .getBroadcastItem(i);</span><br><span class="line">                <span class="keyword">try</span> &#123;</span><br><span class="line">                    callback.onPermissionsChanged(uid);</span><br><span class="line">                &#125; <span class="keyword">catch</span> (RemoteException e) &#123;</span><br><span class="line">                    Log.e(TAG, <span class="string">"Permission listener is dead"</span>, e);</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">            mPermissionListeners.finishBroadcast();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>当指定 uid 的权限发生变化后，会调用 IOnPermissionsChangeListener 的 onPermissionsChanged 方法，通过 Binder 机制，最终会调用 ApplicationPackageManager 的 OnPermissionsChangeListenerDelegate 中的 onPermissionsChanged 方法！<br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">OnPermissionsChangeListenerDelegate</span> <span class="keyword">extends</span> <span class="title">IOnPermissionsChangeListener</span>.<span class="title">Stub</span></span></span><br><span class="line"><span class="class">        <span class="keyword">implements</span> <span class="title">Handler</span>.<span class="title">Callback</span></span>&#123;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="keyword">int</span> MSG_PERMISSIONS_CHANGED = <span class="number">1</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> OnPermissionsChangedListener mListener;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> Handler mHandler;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="title">OnPermissionsChangeListenerDelegate</span><span class="params">(OnPermissionsChangedListener listener,</span></span></span><br><span class="line"><span class="function"><span class="params">            Looper looper)</span> </span>&#123;</span><br><span class="line">        mListener = listener;</span><br><span class="line">        mHandler = <span class="keyword">new</span> Handler(looper, <span class="keyword">this</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onPermissionsChanged</span><span class="params">(<span class="keyword">int</span> uid)</span> </span>&#123;</span><br><span class="line">        mHandler.obtainMessage(MSG_PERMISSIONS_CHANGED, uid, <span class="number">0</span>).sendToTarget();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">boolean</span> <span class="title">handleMessage</span><span class="params">(Message msg)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">switch</span> (msg.what) &#123;</span><br><span class="line">            <span class="keyword">case</span> MSG_PERMISSIONS_CHANGED: &#123;</span><br><span class="line">                <span class="keyword">final</span> <span class="keyword">int</span> uid = msg.arg1;</span><br><span class="line">                </span><br><span class="line">                <span class="comment">// 最后调用 OnPermissionsChangedListener 的 onPermissionsChanged 方法！</span></span><br><span class="line">                mListener.onPermissionsChanged(uid);</span><br><span class="line">                <span class="keyword">return</span> <span class="keyword">true</span>;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">false</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>OnPermissionsChangedListener 是一个接口，定义在 PackageManager 中：<br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@SystemApi</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">interface</span> <span class="title">OnPermissionsChangedListener</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * Called when the permissions for a UID change.</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> uid The UID with a change.</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onPermissionsChanged</span><span class="params">(<span class="keyword">int</span> uid)</span></span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>具体的实现是在 LocationManagerService 中：<br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">systemRunning</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    <span class="keyword">synchronized</span> (mLock) &#123;</span><br><span class="line">        <span class="keyword">if</span> (D) Log.d(TAG, <span class="string">"systemRunning()"</span>);</span><br><span class="line"></span><br><span class="line">        ... ... ... ...</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 这里创建了一个 OnPermissionsChangedListener 对象，并添加到 PackageManagerervice 中！</span></span><br><span class="line">        PackageManager.OnPermissionsChangedListener permissionListener</span><br><span class="line">                = <span class="keyword">new</span> PackageManager.OnPermissionsChangedListener() &#123;</span><br><span class="line">            <span class="meta">@Override</span></span><br><span class="line">            <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onPermissionsChanged</span><span class="params">(<span class="keyword">final</span> <span class="keyword">int</span> uid)</span> </span>&#123;</span><br><span class="line">                <span class="keyword">synchronized</span> (mLock) &#123;</span><br><span class="line">                    applyAllProviderRequirementsLocked();</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;;</span><br><span class="line">        mPackageManager.addOnPermissionsChangeListener(permissionListener);</span><br><span class="line"></span><br><span class="line">        ... ... ...</span><br><span class="line">        </span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure></p>
<p>进入 PackageManagerService 中：<br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">addOnPermissionsChangeListener</span><span class="params">(IOnPermissionsChangeListener listener)</span> </span>&#123;</span><br><span class="line">    mContext.enforceCallingOrSelfPermission(</span><br><span class="line">            Manifest.permission.OBSERVE_GRANT_REVOKE_PERMISSIONS,</span><br><span class="line">            <span class="string">"addOnPermissionsChangeListener"</span>);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">synchronized</span> (mPackages) &#123;</span><br><span class="line">        </span><br><span class="line">        <span class="comment">// 添加到 mOnPermissionChangeListeners 内部的集合中！</span></span><br><span class="line">        mOnPermissionChangeListeners.addListenerLocked(listener);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>这里先看到这里吧！</p>
<h1 id="5-SystemConfig"><a href="#5-SystemConfig" class="headerlink" title="5 SystemConfig"></a>5 SystemConfig</h1><p>SystemConfig 是用来存储系统全局的配置信息的数据结构，有系统配置信息，权限信息，Gid 等等！<br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 单例模式！</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">static</span> SystemConfig <span class="title">getInstance</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    <span class="keyword">synchronized</span> (SystemConfig.class) &#123;</span><br><span class="line">        <span class="keyword">if</span> (sInstance == <span class="keyword">null</span>) &#123;</span><br><span class="line">            sInstance = <span class="keyword">new</span> SystemConfig();</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> sInstance;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>下面我们来看看 SystemConfig 构造器中的相关方法：<br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 其构造器会调用方法读取系统配置信息！</span></span><br><span class="line">SystemConfig() &#123;</span><br><span class="line">    <span class="comment">// 读取配置信息：/etc/sysconfig</span></span><br><span class="line">    readPermissions(Environment.buildPath(</span><br><span class="line">            Environment.getRootDirectory(), <span class="string">"etc"</span>, <span class="string">"sysconfig"</span>), ALLOW_ALL);</span><br><span class="line">            </span><br><span class="line">    <span class="comment">// 读取配置信息：/etc/permissions</span></span><br><span class="line">    readPermissions(Environment.buildPath(</span><br><span class="line">            Environment.getRootDirectory(), <span class="string">"etc"</span>, <span class="string">"permissions"</span>), ALLOW_ALL);</span><br><span class="line">            </span><br><span class="line">    <span class="comment">// 读取配置信息：/odm/etc/sysconfig，/odm/etc/permissions</span></span><br><span class="line">    <span class="keyword">int</span> odmPermissionFlag = ALLOW_LIBS | ALLOW_FEATURES | ALLOW_APP_CONFIGS;</span><br><span class="line">    readPermissions(Environment.buildPath(</span><br><span class="line">            Environment.getOdmDirectory(), <span class="string">"etc"</span>, <span class="string">"sysconfig"</span>), odmPermissionFlag);</span><br><span class="line">    readPermissions(Environment.buildPath(</span><br><span class="line">            Environment.getOdmDirectory(), <span class="string">"etc"</span>, <span class="string">"permissions"</span>), odmPermissionFlag);</span><br><span class="line">            </span><br><span class="line">    <span class="comment">// 读取配置信息：/oem/etc/sysconfig，/oem/etc/permissions</span></span><br><span class="line">    readPermissions(Environment.buildPath(</span><br><span class="line">            Environment.getOemDirectory(), <span class="string">"etc"</span>, <span class="string">"sysconfig"</span>), ALLOW_FEATURES);</span><br><span class="line">    readPermissions(Environment.buildPath(</span><br><span class="line">            Environment.getOemDirectory(), <span class="string">"etc"</span>, <span class="string">"permissions"</span>), ALLOW_FEATURES);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>第一个参数，表示可以访问的目录，这些目录包括：</p>
<ul>
<li>/etc/sysconfig：ALLOW_ALL</li>
<li>/etc/permissions：ALLOW_ALL</li>
<li>/odm/etc/sysconfig：ALLOW_LIBS | ALLOW_FEATURES | ALLOW_APP_CONFIGS</li>
<li>/odm/etc/permissions：ALLOW_LIBS | ALLOW_FEATURES | ALLOW_APP_CONFIGS</li>
<li>/oem/etc/sysconfig：ALLOW_FEATURES</li>
<li>/oem/etc/permissions：ALLOW_FEATURES</li>
</ul>
<p>第二个参数，表示这个目录可以设置的配置信息的类型，同样的，PMS 在解析时，也只会解析和读取参数指定的配置属性：</p>
<ul>
<li>oem：只能设置 features！</li>
<li>odm：只能设置 libs，features 和 app configs！</li>
<li>/system/etc/sysconfig，/system/etc/permissions：可以设置所有的配置，libs，permissions，features，app configs 等等！</li>
</ul>
<p>下面是 flag 的取值：<br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="keyword">int</span> ALLOW_FEATURES = <span class="number">0x01</span>;</span><br><span class="line"><span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="keyword">int</span> ALLOW_LIBS = <span class="number">0x02</span>;</span><br><span class="line"><span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="keyword">int</span> ALLOW_PERMISSIONS = <span class="number">0x04</span>;</span><br><span class="line"><span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="keyword">int</span> ALLOW_APP_CONFIGS = <span class="number">0x08</span>;</span><br><span class="line"><span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="keyword">int</span> ALLOW_ALL = ~<span class="number">0</span>;</span><br></pre></td></tr></table></figure></p>
<p>继续看！</p>
<h2 id="2-1-SystemConfig-readPermissions"><a href="#2-1-SystemConfig-readPermissions" class="headerlink" title="2.1 SystemConfig.readPermissions"></a>2.1 SystemConfig.readPermissions</h2><p>我们来看看读取的过程：<br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">readPermissions</span><span class="params">(File libraryDir, <span class="keyword">int</span> permissionFlag)</span> </span>&#123;</span><br><span class="line">    <span class="comment">// 校验目录可读性！</span></span><br><span class="line">    <span class="keyword">if</span> (!libraryDir.exists() || !libraryDir.isDirectory()) &#123;</span><br><span class="line">        <span class="keyword">if</span> (permissionFlag == ALLOW_ALL) &#123;</span><br><span class="line">            Slog.w(TAG, <span class="string">"No directory "</span> + libraryDir + <span class="string">", skipping"</span>);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span> (!libraryDir.canRead()) &#123;</span><br><span class="line">        Slog.w(TAG, <span class="string">"Directory "</span> + libraryDir + <span class="string">" cannot be read"</span>);</span><br><span class="line">        <span class="keyword">return</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 遍历解析目录下的所有 .xml 文件！</span></span><br><span class="line">    File platformFile = <span class="keyword">null</span>;</span><br><span class="line">    <span class="keyword">for</span> (File f : libraryDir.listFiles()) &#123;</span><br><span class="line">        <span class="comment">//【1】对于 etc/permissions/platform.xml 文件，最后再处理！</span></span><br><span class="line">        <span class="keyword">if</span> (f.getPath().endsWith(<span class="string">"etc/permissions/platform.xml"</span>)) &#123;</span><br><span class="line">            platformFile = f;</span><br><span class="line">            <span class="keyword">continue</span>;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (!f.getPath().endsWith(<span class="string">".xml"</span>)) &#123;</span><br><span class="line">            Slog.i(TAG, <span class="string">"Non-xml file "</span> + f + <span class="string">" in "</span> + libraryDir + <span class="string">" directory, ignoring"</span>);</span><br><span class="line">            <span class="keyword">continue</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">if</span> (!f.canRead()) &#123;</span><br><span class="line">            Slog.w(TAG, <span class="string">"Permissions library file "</span> + f + <span class="string">" cannot be read"</span>);</span><br><span class="line">            <span class="keyword">continue</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        </span><br><span class="line">        <span class="comment">//【2】进一步解析文件！</span></span><br><span class="line">        readPermissionsFromXml(f, permissionFlag);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//【3】读取和解析 platform.xml 文件！</span></span><br><span class="line">    <span class="keyword">if</span> (platformFile != <span class="keyword">null</span>) &#123;</span><br><span class="line">        readPermissionsFromXml(platformFile, permissionFlag);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>这个方法的主要过程是：</p>
<ul>
<li>先解析该目录下的其他的 xml 文件；</li>
<li>最后解析 etc/permissions/platform.xml 文件（如果有）；</li>
</ul>
<h2 id="2-2-SystemConfig-readPermissionsFromXml"><a href="#2-2-SystemConfig-readPermissionsFromXml" class="headerlink" title="2.2 SystemConfig.readPermissionsFromXml"></a>2.2 SystemConfig.readPermissionsFromXml</h2><p>继续调用 readPermissionsFromXml 方法，这里我们重点看一些 tag：<br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br><span class="line">212</span><br><span class="line">213</span><br><span class="line">214</span><br><span class="line">215</span><br><span class="line">216</span><br><span class="line">217</span><br><span class="line">218</span><br><span class="line">219</span><br><span class="line">220</span><br><span class="line">221</span><br><span class="line">222</span><br><span class="line">223</span><br><span class="line">224</span><br><span class="line">225</span><br><span class="line">226</span><br><span class="line">227</span><br><span class="line">228</span><br><span class="line">229</span><br><span class="line">230</span><br><span class="line">231</span><br><span class="line">232</span><br><span class="line">233</span><br><span class="line">234</span><br><span class="line">235</span><br><span class="line">236</span><br><span class="line">237</span><br><span class="line">238</span><br><span class="line">239</span><br><span class="line">240</span><br><span class="line">241</span><br><span class="line">242</span><br><span class="line">243</span><br><span class="line">244</span><br><span class="line">245</span><br><span class="line">246</span><br><span class="line">247</span><br><span class="line">248</span><br><span class="line">249</span><br><span class="line">250</span><br><span class="line">251</span><br><span class="line">252</span><br><span class="line">253</span><br><span class="line">254</span><br><span class="line">255</span><br><span class="line">256</span><br><span class="line">257</span><br><span class="line">258</span><br><span class="line">259</span><br><span class="line">260</span><br><span class="line">261</span><br><span class="line">262</span><br><span class="line">263</span><br><span class="line">264</span><br><span class="line">265</span><br><span class="line">266</span><br><span class="line">267</span><br><span class="line">268</span><br><span class="line">269</span><br><span class="line">270</span><br><span class="line">271</span><br><span class="line">272</span><br><span class="line">273</span><br><span class="line">274</span><br><span class="line">275</span><br><span class="line">276</span><br><span class="line">277</span><br><span class="line">278</span><br><span class="line">279</span><br><span class="line">280</span><br><span class="line">281</span><br><span class="line">282</span><br><span class="line">283</span><br><span class="line">284</span><br><span class="line">285</span><br><span class="line">286</span><br><span class="line">287</span><br><span class="line">288</span><br><span class="line">289</span><br><span class="line">290</span><br><span class="line">291</span><br><span class="line">292</span><br><span class="line">293</span><br><span class="line">294</span><br><span class="line">295</span><br><span class="line">296</span><br><span class="line">297</span><br><span class="line">298</span><br><span class="line">299</span><br><span class="line">300</span><br><span class="line">301</span><br><span class="line">302</span><br><span class="line">303</span><br><span class="line">304</span><br><span class="line">305</span><br><span class="line">306</span><br><span class="line">307</span><br><span class="line">308</span><br><span class="line">309</span><br><span class="line">310</span><br><span class="line">311</span><br><span class="line">312</span><br><span class="line">313</span><br><span class="line">314</span><br><span class="line">315</span><br><span class="line">316</span><br><span class="line">317</span><br><span class="line">318</span><br><span class="line">319</span><br><span class="line">320</span><br><span class="line">321</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">readPermissionsFromXml</span><span class="params">(File permFile, <span class="keyword">int</span> permissionFlag)</span> </span>&#123;</span><br><span class="line">    FileReader permReader = <span class="keyword">null</span>;</span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">        permReader = <span class="keyword">new</span> FileReader(permFile);</span><br><span class="line">    &#125; <span class="keyword">catch</span> (FileNotFoundException e) &#123;</span><br><span class="line">        Slog.w(TAG, <span class="string">"Couldn't find or open permissions file "</span> + permFile);</span><br><span class="line">        <span class="keyword">return</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//【1】判读设备是否是低内存！</span></span><br><span class="line">    <span class="keyword">final</span> <span class="keyword">boolean</span> lowRam = ActivityManager.isLowRamDeviceStatic();</span><br><span class="line"></span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">        XmlPullParser parser = Xml.newPullParser();</span><br><span class="line">        parser.setInput(permReader);</span><br><span class="line"></span><br><span class="line">        <span class="keyword">int</span> type;</span><br><span class="line">        <span class="keyword">while</span> ((type=parser.next()) != parser.START_TAG</span><br><span class="line">                   &amp;&amp; type != parser.END_DOCUMENT) &#123;</span><br><span class="line">            ;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (type != parser.START_TAG) &#123;</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> XmlPullParserException(<span class="string">"No start tag found"</span>);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (!parser.getName().equals(<span class="string">"permissions"</span>) &amp;&amp; !parser.getName().equals(<span class="string">"config"</span>)) &#123;</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> XmlPullParserException(<span class="string">"Unexpected start tag in "</span> + permFile</span><br><span class="line">                    + <span class="string">": found "</span> + parser.getName() + <span class="string">", expected 'permissions' or 'config'"</span>);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment">//【2】解析 Flag，指定二进制位为 1 ，即表示该条件满足，如果 flag 是 ALLOW_ALL，</span></span><br><span class="line">        <span class="comment">// 那么其他的条件均满足！</span></span><br><span class="line">        <span class="keyword">boolean</span> allowAll = permissionFlag == ALLOW_ALL;</span><br><span class="line">        <span class="keyword">boolean</span> allowLibs = (permissionFlag &amp; ALLOW_LIBS) != <span class="number">0</span>;</span><br><span class="line">        <span class="keyword">boolean</span> allowFeatures = (permissionFlag &amp; ALLOW_FEATURES) != <span class="number">0</span>;</span><br><span class="line">        <span class="keyword">boolean</span> allowPermissions = (permissionFlag &amp; ALLOW_PERMISSIONS) != <span class="number">0</span>;</span><br><span class="line">        <span class="keyword">boolean</span> allowAppConfigs = (permissionFlag &amp; ALLOW_APP_CONFIGS) != <span class="number">0</span>;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">while</span> (<span class="keyword">true</span>) &#123;</span><br><span class="line">            <span class="comment">// 解析下一个标签！</span></span><br><span class="line">            XmlUtils.nextElement(parser);</span><br><span class="line">            <span class="keyword">if</span> (parser.getEventType() == XmlPullParser.END_DOCUMENT) &#123;</span><br><span class="line">                <span class="keyword">break</span>;</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            String name = parser.getName();</span><br><span class="line">            <span class="keyword">if</span> (<span class="string">"group"</span>.equals(name) &amp;&amp; allowAll) &#123; </span><br><span class="line">                <span class="comment">//【1】allowAll 为 true，解析 "group" 标签；</span></span><br><span class="line">                <span class="comment">// 解析系统中所有的 Gid 信息！</span></span><br><span class="line">                String gidStr = parser.getAttributeValue(<span class="keyword">null</span>, <span class="string">"gid"</span>);</span><br><span class="line">                <span class="keyword">if</span> (gidStr != <span class="keyword">null</span>) &#123;</span><br><span class="line">                    <span class="keyword">int</span> gid = android.os.Process.getGidForName(gidStr);</span><br><span class="line">                    mGlobalGids = appendInt(mGlobalGids, gid);</span><br><span class="line">                &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                    Slog.w(TAG, <span class="string">"&lt;group&gt; without gid in "</span> + permFile + <span class="string">" at "</span></span><br><span class="line">                            + parser.getPositionDescription());</span><br><span class="line">                &#125;</span><br><span class="line"></span><br><span class="line">                XmlUtils.skipCurrentTag(parser);</span><br><span class="line">                <span class="keyword">continue</span>;</span><br><span class="line">                </span><br><span class="line">            &#125; <span class="keyword">else</span> <span class="keyword">if</span> (<span class="string">"permission"</span>.equals(name) &amp;&amp; allowPermissions) &#123;  </span><br><span class="line">                <span class="comment">//【2】allowPermissions 为 true，解析 "permission" 标签</span></span><br><span class="line">                <span class="comment">// 解析系统中所有权限和其所属 gid 的信息！</span></span><br><span class="line">                String perm = parser.getAttributeValue(<span class="keyword">null</span>, <span class="string">"name"</span>);</span><br><span class="line">                <span class="keyword">if</span> (perm == <span class="keyword">null</span>) &#123;</span><br><span class="line">                    Slog.w(TAG, <span class="string">"&lt;permission&gt; without name in "</span> + permFile + <span class="string">" at "</span></span><br><span class="line">                            + parser.getPositionDescription());</span><br><span class="line">                    XmlUtils.skipCurrentTag(parser);</span><br><span class="line">                    <span class="keyword">continue</span>;</span><br><span class="line">                &#125;</span><br><span class="line">                perm = perm.intern();</span><br><span class="line">                readPermission(parser, perm); <span class="comment">// 调用 readPermission 继续解析权限</span></span><br><span class="line"></span><br><span class="line">            &#125; <span class="keyword">else</span> <span class="keyword">if</span> (<span class="string">"assign-permission"</span>.equals(name) &amp;&amp; allowPermissions) &#123; </span><br><span class="line">                <span class="comment">//【3】如果 allowPermissions 为 true，解析 "assign-permission" 标签</span></span><br><span class="line">                <span class="comment">// 解析系统中 uid 和其所持有的权限的关系！</span></span><br><span class="line">                String perm = parser.getAttributeValue(<span class="keyword">null</span>, <span class="string">"name"</span>); <span class="comment">// 权限名</span></span><br><span class="line">                <span class="keyword">if</span> (perm == <span class="keyword">null</span>) &#123;</span><br><span class="line">                    Slog.w(TAG, <span class="string">"&lt;assign-permission&gt; without name in "</span> + permFile + <span class="string">" at "</span></span><br><span class="line">                            + parser.getPositionDescription());</span><br><span class="line">                    XmlUtils.skipCurrentTag(parser);</span><br><span class="line">                    <span class="keyword">continue</span>;</span><br><span class="line">                &#125;</span><br><span class="line">                String uidStr = parser.getAttributeValue(<span class="keyword">null</span>, <span class="string">"uid"</span>); <span class="comment">// 拥有该权限的 uid</span></span><br><span class="line">                <span class="keyword">if</span> (uidStr == <span class="keyword">null</span>) &#123;</span><br><span class="line">                    Slog.w(TAG, <span class="string">"&lt;assign-permission&gt; without uid in "</span> + permFile + <span class="string">" at "</span></span><br><span class="line">                            + parser.getPositionDescription());</span><br><span class="line">                    XmlUtils.skipCurrentTag(parser);</span><br><span class="line">                    <span class="keyword">continue</span>;</span><br><span class="line">                &#125;</span><br><span class="line">                <span class="keyword">int</span> uid = Process.getUidForName(uidStr); <span class="comment">// 将 uid 转为 int 值！</span></span><br><span class="line">                <span class="keyword">if</span> (uid &lt; <span class="number">0</span>) &#123;</span><br><span class="line">                    Slog.w(TAG, <span class="string">"&lt;assign-permission&gt; with unknown uid \""</span></span><br><span class="line">                            + uidStr + <span class="string">"  in "</span> + permFile + <span class="string">" at "</span></span><br><span class="line">                            + parser.getPositionDescription());</span><br><span class="line">                    XmlUtils.skipCurrentTag(parser);</span><br><span class="line">                    <span class="keyword">continue</span>;</span><br><span class="line">                &#125;</span><br><span class="line">                perm = perm.intern();</span><br><span class="line">                ArraySet&lt;String&gt; perms = mSystemPermissions.get(uid);</span><br><span class="line">                <span class="keyword">if</span> (perms == <span class="keyword">null</span>) &#123;</span><br><span class="line">                    perms = <span class="keyword">new</span> ArraySet&lt;String&gt;();</span><br><span class="line">                    mSystemPermissions.put(uid, perms);</span><br><span class="line">                &#125;</span><br><span class="line">                perms.add(perm);</span><br><span class="line">                XmlUtils.skipCurrentTag(parser);</span><br><span class="line"></span><br><span class="line">            &#125; <span class="keyword">else</span> <span class="keyword">if</span> (<span class="string">"library"</span>.equals(name) &amp;&amp; allowLibs) &#123; </span><br><span class="line">                <span class="comment">//【4】如果 allowLibs 为 true，解析 "library" 标签</span></span><br><span class="line">                <span class="comment">// 获得系统中所有共享库的信息！</span></span><br><span class="line">                String lname = parser.getAttributeValue(<span class="keyword">null</span>, <span class="string">"name"</span>);</span><br><span class="line">                String lfile = parser.getAttributeValue(<span class="keyword">null</span>, <span class="string">"file"</span>);</span><br><span class="line">                <span class="keyword">if</span> (lname == <span class="keyword">null</span>) &#123;</span><br><span class="line">                    Slog.w(TAG, <span class="string">"&lt;library&gt; without name in "</span> + permFile + <span class="string">" at "</span></span><br><span class="line">                            + parser.getPositionDescription());</span><br><span class="line">                &#125; <span class="keyword">else</span> <span class="keyword">if</span> (lfile == <span class="keyword">null</span>) &#123;</span><br><span class="line">                    Slog.w(TAG, <span class="string">"&lt;library&gt; without file in "</span> + permFile + <span class="string">" at "</span></span><br><span class="line">                            + parser.getPositionDescription());</span><br><span class="line">                &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                    <span class="comment">//Log.i(TAG, "Got library " + lname + " in " + lfile);</span></span><br><span class="line">                    mSharedLibraries.put(lname, lfile);</span><br><span class="line">                &#125;</span><br><span class="line">                XmlUtils.skipCurrentTag(parser);</span><br><span class="line">                <span class="keyword">continue</span>;</span><br><span class="line"></span><br><span class="line">            &#125; <span class="keyword">else</span> <span class="keyword">if</span> (<span class="string">"feature"</span>.equals(name) &amp;&amp; allowFeatures) &#123; </span><br><span class="line">                <span class="comment">//【5】如果 allowFeatures 为 true，解析 "feature" 标签</span></span><br><span class="line">                <span class="comment">// 获得系统中所有可用特性的信息！</span></span><br><span class="line">                String fname = parser.getAttributeValue(<span class="keyword">null</span>, <span class="string">"name"</span>);</span><br><span class="line">                <span class="keyword">int</span> fversion = XmlUtils.readIntAttribute(parser, <span class="string">"version"</span>, <span class="number">0</span>);</span><br><span class="line">                <span class="keyword">boolean</span> allowed;</span><br><span class="line">                </span><br><span class="line">                <span class="keyword">if</span> (!lowRam) &#123;</span><br><span class="line">                    allowed = <span class="keyword">true</span>;</span><br><span class="line">                &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                    <span class="comment">// 内存不足时，配置了 notLowRam 的 feature 不会在加载！</span></span><br><span class="line">                    String notLowRam = parser.getAttributeValue(<span class="keyword">null</span>, <span class="string">"notLowRam"</span>);</span><br><span class="line">                    allowed = !<span class="string">"true"</span>.equals(notLowRam);</span><br><span class="line">                &#125;</span><br><span class="line">                <span class="keyword">if</span> (fname == <span class="keyword">null</span>) &#123;</span><br><span class="line">                    Slog.w(TAG, <span class="string">"&lt;feature&gt; without name in "</span> + permFile + <span class="string">" at "</span></span><br><span class="line">                            + parser.getPositionDescription());</span><br><span class="line">                &#125; <span class="keyword">else</span> <span class="keyword">if</span> (allowed) &#123;</span><br><span class="line">                    <span class="comment">// 将 feature 构造成 featureInfo，加入到 mAvailableFeatures 对象中！</span></span><br><span class="line">                    addFeature(fname, fversion);</span><br><span class="line">                &#125;</span><br><span class="line">                XmlUtils.skipCurrentTag(parser);</span><br><span class="line">                <span class="keyword">continue</span>;</span><br><span class="line"></span><br><span class="line">            &#125; <span class="keyword">else</span> <span class="keyword">if</span> (<span class="string">"unavailable-feature"</span>.equals(name) &amp;&amp; allowFeatures) &#123; </span><br><span class="line">                <span class="comment">//【6】如果 allowFeatures 为 true，解析 "unavailable-feature" 标签</span></span><br><span class="line">                <span class="comment">// 获得系统中所有不可用特性的信息！</span></span><br><span class="line">                String fname = parser.getAttributeValue(<span class="keyword">null</span>, <span class="string">"name"</span>);</span><br><span class="line">                <span class="keyword">if</span> (fname == <span class="keyword">null</span>) &#123;</span><br><span class="line">                    Slog.w(TAG, <span class="string">"&lt;unavailable-feature&gt; without name in "</span> + permFile + <span class="string">" at "</span></span><br><span class="line">                            + parser.getPositionDescription());</span><br><span class="line">                &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                    mUnavailableFeatures.add(fname);</span><br><span class="line">                &#125;</span><br><span class="line">                XmlUtils.skipCurrentTag(parser);</span><br><span class="line">                <span class="keyword">continue</span>;</span><br><span class="line"></span><br><span class="line">            &#125; <span class="keyword">else</span> <span class="keyword">if</span> (<span class="string">"allow-in-power-save-except-idle"</span>.equals(name) &amp;&amp; allowAll) &#123;</span><br><span class="line">                <span class="comment">//【7】解析 "allow-in-power-save-except-idle" 标签</span></span><br><span class="line">                <span class="comment">// 用于获得系统中处于省电模式白名单，而没有在 idle 模式白名单中的应用信息！</span></span><br><span class="line">                <span class="comment">// 这些应用可以在后台运行！</span></span><br><span class="line">                String pkgname = parser.getAttributeValue(<span class="keyword">null</span>, <span class="string">"package"</span>);</span><br><span class="line">                <span class="keyword">if</span> (pkgname == <span class="keyword">null</span>) &#123;</span><br><span class="line">                    Slog.w(TAG, <span class="string">"&lt;allow-in-power-save-except-idle&gt; without package in "</span></span><br><span class="line">                            + permFile + <span class="string">" at "</span> + parser.getPositionDescription());</span><br><span class="line">                &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                    mAllowInPowerSaveExceptIdle.add(pkgname);</span><br><span class="line">                &#125;</span><br><span class="line">                XmlUtils.skipCurrentTag(parser);</span><br><span class="line">                <span class="keyword">continue</span>;</span><br><span class="line"></span><br><span class="line">            &#125; <span class="keyword">else</span> <span class="keyword">if</span> (<span class="string">"allow-in-power-save"</span>.equals(name) &amp;&amp; allowAll) &#123; </span><br><span class="line">                <span class="comment">//【8】解析 "allow-in-power-save" 标签</span></span><br><span class="line">                <span class="comment">// 获得哪些处于 doze 模式白名单中的应用信息！</span></span><br><span class="line">                String pkgname = parser.getAttributeValue(<span class="keyword">null</span>, <span class="string">"package"</span>);</span><br><span class="line">                <span class="keyword">if</span> (pkgname == <span class="keyword">null</span>) &#123;</span><br><span class="line">                    Slog.w(TAG, <span class="string">"&lt;allow-in-power-save&gt; without package in "</span> + permFile + <span class="string">" at "</span></span><br><span class="line">                            + parser.getPositionDescription());</span><br><span class="line">                &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                    mAllowInPowerSave.add(pkgname);</span><br><span class="line">                &#125;</span><br><span class="line">                XmlUtils.skipCurrentTag(parser);</span><br><span class="line">                <span class="keyword">continue</span>;</span><br><span class="line"></span><br><span class="line">            &#125; <span class="keyword">else</span> <span class="keyword">if</span> (<span class="string">"allow-in-data-usage-save"</span>.equals(name) &amp;&amp; allowAll) &#123;  </span><br><span class="line">                <span class="comment">//【9】解析 "allow-in-data-usage-save" 标签，</span></span><br><span class="line">                <span class="comment">// 获得哪些处于流量节省模式白名单中的应用的信息，在白名单中的应用，当系统处于</span></span><br><span class="line">                <span class="comment">// 流量节省模式时，可以在后台运行！</span></span><br><span class="line">                String pkgname = parser.getAttributeValue(<span class="keyword">null</span>, <span class="string">"package"</span>);</span><br><span class="line">                <span class="keyword">if</span> (pkgname == <span class="keyword">null</span>) &#123;</span><br><span class="line">                    Slog.w(TAG, <span class="string">"&lt;allow-in-data-usage-save&gt; without package in "</span> + permFile</span><br><span class="line">                            + <span class="string">" at "</span> + parser.getPositionDescription());</span><br><span class="line">                &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                    mAllowInDataUsageSave.add(pkgname);</span><br><span class="line">                &#125;</span><br><span class="line">                XmlUtils.skipCurrentTag(parser);</span><br><span class="line">                <span class="keyword">continue</span>;</span><br><span class="line"></span><br><span class="line">            &#125; <span class="keyword">else</span> <span class="keyword">if</span> (<span class="string">"app-link"</span>.equals(name) &amp;&amp; allowAppConfigs) &#123;  </span><br><span class="line">                <span class="comment">//【10】解析 "app-link" 标签</span></span><br><span class="line">                String pkgname = parser.getAttributeValue(<span class="keyword">null</span>, <span class="string">"package"</span>);</span><br><span class="line">                <span class="keyword">if</span> (pkgname == <span class="keyword">null</span>) &#123;</span><br><span class="line">                    Slog.w(TAG, <span class="string">"&lt;app-link&gt; without package in "</span> + permFile + <span class="string">" at "</span></span><br><span class="line">                            + parser.getPositionDescription());</span><br><span class="line">                &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                    mLinkedApps.add(pkgname);</span><br><span class="line">                &#125;</span><br><span class="line">                XmlUtils.skipCurrentTag(parser);</span><br><span class="line"></span><br><span class="line">            &#125; <span class="keyword">else</span> <span class="keyword">if</span> (<span class="string">"system-user-whitelisted-app"</span>.equals(name) &amp;&amp; allowAppConfigs) &#123; </span><br><span class="line">                <span class="comment">//【11】解析 "system-user-whitelisted-app" 标签</span></span><br><span class="line">                <span class="comment">// 获得哪些在 system user 下可以运行的应用信息！</span></span><br><span class="line">                String pkgname = parser.getAttributeValue(<span class="keyword">null</span>, <span class="string">"package"</span>);</span><br><span class="line">                <span class="keyword">if</span> (pkgname == <span class="keyword">null</span>) &#123;</span><br><span class="line">                    Slog.w(TAG, <span class="string">"&lt;system-user-whitelisted-app&gt; without package in "</span></span><br><span class="line">                    + permFile + <span class="string">" at "</span> + parser.getPositionDescription());</span><br><span class="line">                &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                    mSystemUserWhitelistedApps.add(pkgname);</span><br><span class="line">                &#125;</span><br><span class="line">                XmlUtils.skipCurrentTag(parser);</span><br><span class="line"></span><br><span class="line">            &#125; <span class="keyword">else</span> <span class="keyword">if</span> (<span class="string">"system-user-blacklisted-app"</span>.equals(name) &amp;&amp; allowAppConfigs) &#123; </span><br><span class="line">                <span class="comment">//【12】解析 "system-user-blacklisted-app" 标签</span></span><br><span class="line">                <span class="comment">// 获得哪些在 system user 下不可以运行的应用信息！</span></span><br><span class="line">                String pkgname = parser.getAttributeValue(<span class="keyword">null</span>, <span class="string">"package"</span>);</span><br><span class="line">                <span class="keyword">if</span> (pkgname == <span class="keyword">null</span>) &#123;</span><br><span class="line">                    Slog.w(TAG, <span class="string">"&lt;system-user-blacklisted-app without package in "</span> + permFile</span><br><span class="line">                            + <span class="string">" at "</span> + parser.getPositionDescription());</span><br><span class="line">                &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                    mSystemUserBlacklistedApps.add(pkgname);</span><br><span class="line">                &#125;</span><br><span class="line">                XmlUtils.skipCurrentTag(parser);</span><br><span class="line"></span><br><span class="line">            &#125; <span class="keyword">else</span> <span class="keyword">if</span> (<span class="string">"default-enabled-vr-app"</span>.equals(name) &amp;&amp; allowAppConfigs) &#123; </span><br><span class="line">                <span class="comment">//【13】解析 "default-enabled-vr-app" 标签</span></span><br><span class="line">                String pkgname = parser.getAttributeValue(<span class="keyword">null</span>, <span class="string">"package"</span>);</span><br><span class="line">                String clsname = parser.getAttributeValue(<span class="keyword">null</span>, <span class="string">"class"</span>);</span><br><span class="line">                <span class="keyword">if</span> (pkgname == <span class="keyword">null</span>) &#123;</span><br><span class="line">                    Slog.w(TAG, <span class="string">"&lt;default-enabled-vr-app without package in "</span> + permFile</span><br><span class="line">                            + <span class="string">" at "</span> + parser.getPositionDescription());</span><br><span class="line">                &#125; <span class="keyword">else</span> <span class="keyword">if</span> (clsname == <span class="keyword">null</span>) &#123;</span><br><span class="line">                    Slog.w(TAG, <span class="string">"&lt;default-enabled-vr-app without class in "</span> + permFile</span><br><span class="line">                            + <span class="string">" at "</span> + parser.getPositionDescription());</span><br><span class="line">                &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                    mDefaultVrComponents.add(<span class="keyword">new</span> ComponentName(pkgname, clsname));</span><br><span class="line">                &#125;</span><br><span class="line">                XmlUtils.skipCurrentTag(parser);</span><br><span class="line"></span><br><span class="line">            &#125; <span class="keyword">else</span> <span class="keyword">if</span> (<span class="string">"backup-transport-whitelisted-service"</span>.equals(name) &amp;&amp; allowFeatures) &#123;  </span><br><span class="line">                <span class="comment">//【14】解析 "backup-transport-whitelisted-service" 标签</span></span><br><span class="line">                String serviceName = parser.getAttributeValue(<span class="keyword">null</span>, <span class="string">"service"</span>);</span><br><span class="line">                <span class="keyword">if</span> (serviceName == <span class="keyword">null</span>) &#123;</span><br><span class="line">                    Slog.w(TAG, <span class="string">"&lt;backup-transport-whitelisted-service&gt; without service in "</span></span><br><span class="line">                            + permFile + <span class="string">" at "</span> + parser.getPositionDescription());</span><br><span class="line">                &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                    ComponentName cn = ComponentName.unflattenFromString(serviceName);</span><br><span class="line">                    <span class="keyword">if</span> (cn == <span class="keyword">null</span>) &#123;</span><br><span class="line">                        Slog.w(TAG,</span><br><span class="line">                                <span class="string">"&lt;backup-transport-whitelisted-service&gt; with invalid service name "</span></span><br><span class="line">                                + serviceName + <span class="string">" in "</span>+ permFile</span><br><span class="line">                                + <span class="string">" at "</span> + parser.getPositionDescription());</span><br><span class="line">                    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                        mBackupTransportWhitelist.add(cn);</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;</span><br><span class="line">                XmlUtils.skipCurrentTag(parser);</span><br><span class="line"></span><br><span class="line">            &#125; <span class="keyword">else</span> <span class="keyword">if</span> (<span class="string">"disabled-until-used-preinstalled-carrier-associated-app"</span>.equals(name)</span><br><span class="line">                    &amp;&amp; allowAppConfigs) &#123;  </span><br><span class="line">                <span class="comment">//【15】解析 "disabled-until-used-preinstalled-carrier-associated-app" 标签</span></span><br><span class="line">                String pkgname = parser.getAttributeValue(<span class="keyword">null</span>, <span class="string">"package"</span>);</span><br><span class="line">                String carrierPkgname = parser.getAttributeValue(<span class="keyword">null</span>, <span class="string">"carrierAppPackage"</span>);</span><br><span class="line">                <span class="keyword">if</span> (pkgname == <span class="keyword">null</span> || carrierPkgname == <span class="keyword">null</span>) &#123;</span><br><span class="line">                    Slog.w(TAG, <span class="string">"&lt;disabled-until-used-preinstalled-carrier-associated-app"</span></span><br><span class="line">                            + <span class="string">" without package or carrierAppPackage in "</span> + permFile + <span class="string">" at "</span></span><br><span class="line">                            + parser.getPositionDescription());</span><br><span class="line">                &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                    List&lt;String&gt; associatedPkgs =</span><br><span class="line">                            mDisabledUntilUsedPreinstalledCarrierAssociatedApps.get(</span><br><span class="line">                                    carrierPkgname);</span><br><span class="line">                    <span class="keyword">if</span> (associatedPkgs == <span class="keyword">null</span>) &#123;</span><br><span class="line">                        associatedPkgs = <span class="keyword">new</span> ArrayList&lt;&gt;();</span><br><span class="line">                        mDisabledUntilUsedPreinstalledCarrierAssociatedApps.put(</span><br><span class="line">                                carrierPkgname, associatedPkgs);</span><br><span class="line">                    &#125;</span><br><span class="line">                    associatedPkgs.add(pkgname);</span><br><span class="line">                &#125;</span><br><span class="line">                XmlUtils.skipCurrentTag(parser);</span><br><span class="line">            &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                XmlUtils.skipCurrentTag(parser);</span><br><span class="line">                <span class="keyword">continue</span>;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125; <span class="keyword">catch</span> (XmlPullParserException e) &#123;</span><br><span class="line">        Slog.w(TAG, <span class="string">"Got exception parsing permissions."</span>, e);</span><br><span class="line">    &#125; <span class="keyword">catch</span> (IOException e) &#123;</span><br><span class="line">        Slog.w(TAG, <span class="string">"Got exception parsing permissions."</span>, e);</span><br><span class="line">    &#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">        IoUtils.closeQuietly(permReader);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// Some devices can be field-converted to FBE, so offer to splice in</span></span><br><span class="line">    <span class="comment">// those features if not already defined by the static config</span></span><br><span class="line">    <span class="comment">// 加密相关的 feature!</span></span><br><span class="line">    <span class="keyword">if</span> (StorageManager.isFileEncryptedNativeOnly()) &#123;</span><br><span class="line">        addFeature(PackageManager.FEATURE_FILE_BASED_ENCRYPTION, <span class="number">0</span>);</span><br><span class="line">        addFeature(PackageManager.FEATURE_SECURELY_REMOVES_USERS, <span class="number">0</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 从 mAvailableFeatures 移除不支持的 feature！</span></span><br><span class="line">    <span class="keyword">for</span> (String featureName : mUnavailableFeatures) &#123;</span><br><span class="line">        removeFeature(featureName);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>这个方法的流程如下：</p>
<ul>
<li>解析 “group” 标签；</li>
<li>解析 “permission” 标签；</li>
<li>解析 “assign-permission” 标签；</li>
<li>解析 “library” 标签 </li>
<li>解析 “feature” 标签 </li>
<li>解析 “unavailable-feature” 标签</li>
<li>解析 “allow-in-power-save-except-idle” 标签</li>
<li>解析 “allow-in-power-save” 标签</li>
<li>解析 “allow-in-data-usage-save” 标签</li>
<li>解析 “app-link” 标签</li>
<li>解析 “system-user-whitelisted-app” 标签</li>
<li>解析 “system-user-blacklisted-app” 标签</li>
<li>解析 “default-enabled-vr-app” 标签</li>
<li>解析 “backup-transport-whitelisted-service” 标签</li>
<li>解析 “disabled-until-used-preinstalled-carrier-associated-app” 标签</li>
</ul>
<p>这些解析后的数据都会保存到下面的集合中：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br></pre></td><td class="code"><pre><span class="line">public class SystemConfig &#123;</span><br><span class="line"></span><br><span class="line">    // 系统定义的所有的 gid！</span><br><span class="line">    int[] mGlobalGids;</span><br><span class="line"></span><br><span class="line">    // 保存了 uid 和其所有的权限信息的映射关系！</span><br><span class="line">    final SparseArray&lt;ArraySet&lt;String&gt;&gt; mSystemPermissions = new SparseArray&lt;&gt;();</span><br><span class="line"></span><br><span class="line">    // 系统所有的共享库信息，key 是 lib name，value 是 lib path！</span><br><span class="line">    final ArrayMap&lt;String, String&gt; mSharedLibraries  = new ArrayMap&lt;&gt;();</span><br><span class="line"></span><br><span class="line">    // 系统中可用的 feature！</span><br><span class="line">    final ArrayMap&lt;String, FeatureInfo&gt; mAvailableFeatures = new ArrayMap&lt;&gt;();</span><br><span class="line"></span><br><span class="line">    // 系统中不可用的 feature！</span><br><span class="line">    final ArraySet&lt;String&gt; mUnavailableFeatures = new ArraySet&lt;&gt;();</span><br><span class="line"></span><br><span class="line">    // 保存了 gid 和其所拥有的权限的映射关系！</span><br><span class="line">    final ArrayMap&lt;String, PermissionEntry&gt; mPermissions = new ArrayMap&lt;&gt;();</span><br><span class="line"></span><br><span class="line">    final ArraySet&lt;String&gt; mAllowInPowerSaveExceptIdle = new ArraySet&lt;&gt;();</span><br><span class="line">    final ArraySet&lt;String&gt; mAllowInPowerSave = new ArraySet&lt;&gt;();</span><br><span class="line">    final ArraySet&lt;String&gt; mAllowInDataUsageSave = new ArraySet&lt;&gt;();</span><br><span class="line"></span><br><span class="line">    final ArraySet&lt;String&gt; mLinkedApps = new ArraySet&lt;&gt;();</span><br><span class="line">    final ArraySet&lt;String&gt; mSystemUserWhitelistedApps = new ArraySet&lt;&gt;();</span><br><span class="line">    final ArraySet&lt;String&gt; mSystemUserBlacklistedApps = new ArraySet&lt;&gt;();</span><br><span class="line"></span><br><span class="line">    // 默认的 VR 组件信息！</span><br><span class="line">    final ArraySet&lt;ComponentName&gt; mDefaultVrComponents = new ArraySet&lt;&gt;();</span><br><span class="line">    final ArraySet&lt;ComponentName&gt; mBackupTransportWhitelist = new ArraySet&lt;&gt;();</span><br><span class="line">    final ArrayMap&lt;String, List&lt;String&gt;&gt; mDisabledUntilUsedPreinstalledCarrierAssociatedApps =</span><br><span class="line">            new ArrayMap&lt;&gt;();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>下面，我们重点分析几个配置解析，以 /system/etc/permissions 为例，该目录所有的 xml 文件的根节点都是：<br><figure class="highlight"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">&lt;permissions&gt;</span><br><span class="line"></span><br><span class="line">&lt;/permissions&gt;</span><br></pre></td></tr></table></figure></p>
<p>下面我们继续来看：</p>
<h3 id="2-2-1-解析-“group”-获得系统中的所有-gid"><a href="#2-2-1-解析-“group”-获得系统中的所有-gid" class="headerlink" title="2.2.1 解析 “group” - 获得系统中的所有 gid"></a>2.2.1 解析 “group” - 获得系统中的所有 gid</h3><p>和 “group” 相关的 xml 内容如下，可以看到  “group” 并不是单独存在的，而是和  “permission” 一起配合使用！</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">permissions</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">permission</span> <span class="attr">name</span>=<span class="string">"android.permission.BLUETOOTH_ADMIN"</span> &gt;</span></span><br><span class="line">        <span class="comment">&lt;!--解析 group 标签--&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">group</span> <span class="attr">gid</span>=<span class="string">"net_bt_admin"</span> /&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">permission</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">permissions</span>&gt;</span></span><br></pre></td></tr></table></figure>
<p>下面是解析过程：<br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">if</span> (<span class="string">"group"</span>.equals(name) &amp;&amp; allowAll) &#123; </span><br><span class="line">    <span class="comment">//【1】解析 "group" 标签</span></span><br><span class="line">    String gidStr = parser.getAttributeValue(<span class="keyword">null</span>, <span class="string">"gid"</span>);</span><br><span class="line">    <span class="keyword">if</span> (gidStr != <span class="keyword">null</span>) &#123;</span><br><span class="line">        <span class="comment">// 将 Gid 从字符串形式转为对应的 int 形式！</span></span><br><span class="line">        <span class="keyword">int</span> gid = android.os.Process.getGidForName(gidStr);</span><br><span class="line">        mGlobalGids = appendInt(mGlobalGids, gid);</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        Slog.w(TAG, <span class="string">"&lt;group&gt; without gid in "</span> + permFile + <span class="string">" at "</span></span><br><span class="line">                    + parser.getPositionDescription());</span><br><span class="line">    &#125;</span><br><span class="line">    XmlUtils.skipCurrentTag(parser);</span><br><span class="line">    <span class="keyword">continue</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>根据组名称，调用 android.os.Process.getGidForName 转为 gid，保存到 mGlobalGids！</p>
<h3 id="2-2-2-解析-“permission”-获得系统权限和所属的-gid"><a href="#2-2-2-解析-“permission”-获得系统权限和所属的-gid" class="headerlink" title="2.2.2 解析 “permission” - 获得系统权限和所属的 gid"></a>2.2.2 解析 “permission” - 获得系统权限和所属的 gid</h3><p>xml 信息如下：<br><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">permissions</span>&gt;</span></span><br><span class="line">    <span class="comment">&lt;!--解析 permission 标签--&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">permission</span> <span class="attr">name</span>=<span class="string">"android.permission.BLUETOOTH_ADMIN"</span> &gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">group</span> <span class="attr">gid</span>=<span class="string">"net_bt_admin"</span> /&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">permission</span>&gt;</span></span><br><span class="line"></span><br><span class="line">    <span class="tag">&lt;<span class="name">permission</span> <span class="attr">name</span>=<span class="string">"android.permission.BLUETOOTH"</span> &gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">group</span> <span class="attr">gid</span>=<span class="string">"net_bt"</span> /&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">permission</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">permissions</span>&gt;</span></span><br></pre></td></tr></table></figure></p>
<p>下面是解析过程：<br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"> &#125; <span class="keyword">else</span> <span class="keyword">if</span> (<span class="string">"permission"</span>.equals(name) &amp;&amp; allowPermissions) &#123; </span><br><span class="line">    <span class="comment">//【1】解析 "permission" 标签，获得权限的名称 perm！</span></span><br><span class="line">    String perm = parser.getAttributeValue(<span class="keyword">null</span>, <span class="string">"name"</span>);</span><br><span class="line">    <span class="keyword">if</span> (perm == <span class="keyword">null</span>) &#123;</span><br><span class="line">        Slog.w(TAG, <span class="string">"&lt;permission&gt; without name in "</span> + permFile + <span class="string">" at "</span></span><br><span class="line">                 + parser.getPositionDescription());</span><br><span class="line">        XmlUtils.skipCurrentTag(parser);</span><br><span class="line">        <span class="keyword">continue</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    perm = perm.intern();</span><br><span class="line">            </span><br><span class="line">    <span class="comment">//【2】调用 readPermission 继续解析权限</span></span><br><span class="line">    readPermission(parser, perm);</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>进一步调用 readPermission 方法：<br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">readPermission</span><span class="params">(XmlPullParser parser, String name)</span></span></span><br><span class="line"><span class="function">        <span class="keyword">throws</span> IOException, XmlPullParserException </span>&#123;</span><br><span class="line">    <span class="comment">//【1】如果 mPermissions 已经包含这个权限，解析冲突！</span></span><br><span class="line">    <span class="keyword">if</span> (mPermissions.containsKey(name)) &#123;</span><br><span class="line">        <span class="keyword">throw</span> <span class="keyword">new</span> IllegalStateException(<span class="string">"Duplicate permission definition for "</span> + name);</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">//【2】perUser 表示该权限的 gid 是否针对设备用户 id 进行调整，默认为 false！</span></span><br><span class="line">    <span class="keyword">final</span> <span class="keyword">boolean</span> perUser = XmlUtils.readBooleanAttribute(parser, <span class="string">"perUser"</span>, <span class="keyword">false</span>);</span><br><span class="line">    </span><br><span class="line">    <span class="comment">//【3】创建 PermissionEntry，并添加到 mPermissions 中！</span></span><br><span class="line">    <span class="keyword">final</span> PermissionEntry perm = <span class="keyword">new</span> PermissionEntry(name, perUser);</span><br><span class="line">    mPermissions.put(name, perm);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">int</span> outerDepth = parser.getDepth();</span><br><span class="line">    <span class="keyword">int</span> type;</span><br><span class="line">    <span class="keyword">while</span> ((type=parser.next()) != XmlPullParser.END_DOCUMENT</span><br><span class="line">           &amp;&amp; (type != XmlPullParser.END_TAG</span><br><span class="line">                   || parser.getDepth() &gt; outerDepth)) &#123;</span><br><span class="line">        <span class="keyword">if</span> (type == XmlPullParser.END_TAG</span><br><span class="line">                || type == XmlPullParser.TEXT) &#123;</span><br><span class="line">            <span class="keyword">continue</span>;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        String tagName = parser.getName();</span><br><span class="line"></span><br><span class="line">        <span class="comment">//【4】解析内部 "group" 标签，获得权限所属的 gid，将其添加到 PermissionEntry 的 gids 数组中！</span></span><br><span class="line">        <span class="keyword">if</span> (<span class="string">"group"</span>.equals(tagName)) &#123;</span><br><span class="line">            String gidStr = parser.getAttributeValue(<span class="keyword">null</span>, <span class="string">"gid"</span>);</span><br><span class="line">            <span class="keyword">if</span> (gidStr != <span class="keyword">null</span>) &#123;</span><br><span class="line">                <span class="keyword">int</span> gid = Process.getGidForName(gidStr);</span><br><span class="line">                perm.gids = appendInt(perm.gids, gid);</span><br><span class="line">            &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                Slog.w(TAG, <span class="string">"&lt;group&gt; without gid at "</span></span><br><span class="line">                        + parser.getPositionDescription());</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        XmlUtils.skipCurrentTag(parser);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>可以看到，解析 “permission” 标签以及其内部的标签 “group”，获得了 gid 和权限的映射关系，保存到了 mPermissions 中，一个权限可以对应多个 gid！</p>
<h3 id="2-2-3-解析-“assign-permission”-给指定的-uid-分配权限"><a href="#2-2-3-解析-“assign-permission”-给指定的-uid-分配权限" class="headerlink" title="2.2.3 解析 “assign-permission” - 给指定的 uid 分配权限"></a>2.2.3 解析 “assign-permission” - 给指定的 uid 分配权限</h3><p>“assign-permission” 的 xml 内容如下：<br><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">assign-permission</span> <span class="attr">name</span>=<span class="string">"android.permission.MODIFY_AUDIO_SETTINGS"</span> <span class="attr">uid</span>=<span class="string">"media"</span> /&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">assign-permission</span> <span class="attr">name</span>=<span class="string">"android.permission.ACCESS_SURFACE_FLINGER"</span> <span class="attr">uid</span>=<span class="string">"media"</span> /&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">assign-permission</span> <span class="attr">name</span>=<span class="string">"android.permission.WAKE_LOCK"</span> <span class="attr">uid</span>=<span class="string">"media"</span> /&gt;</span></span><br></pre></td></tr></table></figure></p>
<p>下面是解析过程：<br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br></pre></td><td class="code"><pre><span class="line">&#125; <span class="keyword">else</span> <span class="keyword">if</span> (<span class="string">"assign-permission"</span>.equals(name) &amp;&amp; allowPermissions) &#123; </span><br><span class="line">    <span class="comment">//【1】解析 "name" 属性，获得权限的名称！</span></span><br><span class="line">    String perm = parser.getAttributeValue(<span class="keyword">null</span>, <span class="string">"name"</span>);</span><br><span class="line">    <span class="keyword">if</span> (perm == <span class="keyword">null</span>) &#123;</span><br><span class="line">        Slog.w(TAG, <span class="string">"&lt;assign-permission&gt; without name in "</span> + permFile + <span class="string">" at "</span></span><br><span class="line">                        + parser.getPositionDescription());</span><br><span class="line">        XmlUtils.skipCurrentTag(parser);</span><br><span class="line">        <span class="keyword">continue</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">//【2】获得权限所属用户的名称！</span></span><br><span class="line">    String uidStr = parser.getAttributeValue(<span class="keyword">null</span>, <span class="string">"uid"</span>);</span><br><span class="line">    <span class="keyword">if</span> (uidStr == <span class="keyword">null</span>) &#123;</span><br><span class="line">        Slog.w(TAG, <span class="string">"&lt;assign-permission&gt; without uid in "</span> + permFile + <span class="string">" at "</span></span><br><span class="line">                    + parser.getPositionDescription());</span><br><span class="line">        XmlUtils.skipCurrentTag(parser);</span><br><span class="line">        <span class="keyword">continue</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">//【3】获得用户 uid！</span></span><br><span class="line">    <span class="keyword">int</span> uid = Process.getUidForName(uidStr);</span><br><span class="line">    <span class="keyword">if</span> (uid &lt; <span class="number">0</span>) &#123;</span><br><span class="line">        Slog.w(TAG, <span class="string">"&lt;assign-permission&gt; with unknown uid \""</span></span><br><span class="line">                + uidStr + <span class="string">"  in "</span> + permFile + <span class="string">" at "</span></span><br><span class="line">                + parser.getPositionDescription());</span><br><span class="line">        XmlUtils.skipCurrentTag(parser);</span><br><span class="line">        <span class="keyword">continue</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    perm = perm.intern();</span><br><span class="line">    ArraySet&lt;String&gt; perms = mSystemPermissions.get(uid);</span><br><span class="line">    <span class="keyword">if</span> (perms == <span class="keyword">null</span>) &#123;</span><br><span class="line">        perms = <span class="keyword">new</span> ArraySet&lt;String&gt;();</span><br><span class="line">        mSystemPermissions.put(uid, perms);</span><br><span class="line">    &#125;</span><br><span class="line">    perms.add(perm);</span><br><span class="line">    XmlUtils.skipCurrentTag(parser);</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>可以看到，解析 “assign-permission” 标签，获得了 uid 和权限的映射关系，保存到了 mSystemPermissions 中，一个 uid 可以对应多个权限！</p>
<h3 id="2-2-4-解析-“library”-获得共享库信息"><a href="#2-2-4-解析-“library”-获得共享库信息" class="headerlink" title="2.2.4 解析 “library” - 获得共享库信息"></a>2.2.4 解析 “library” - 获得共享库信息</h3><p>xml 信息如下：<br><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">library</span> <span class="attr">name</span>=<span class="string">"android.test.runner"</span></span></span><br><span class="line"><span class="tag">        <span class="attr">file</span>=<span class="string">"/system/framework/android.test.runner.jar"</span> /&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">library</span> <span class="attr">name</span>=<span class="string">"javax.obex"</span></span></span><br><span class="line"><span class="tag">        <span class="attr">file</span>=<span class="string">"/system/framework/javax.obex.jar"</span> /&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">library</span> <span class="attr">name</span>=<span class="string">"org.apache.http.legacy"</span></span></span><br><span class="line"><span class="tag">        <span class="attr">file</span>=<span class="string">"/system/framework/org.apache.http.legacy.jar"</span> /&gt;</span></span><br></pre></td></tr></table></figure></p>
<p>下面是解析过程：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line">&#125; <span class="keyword">else</span> <span class="keyword">if</span> (<span class="string">"library"</span>.equals(name) &amp;&amp; allowLibs) &#123; </span><br><span class="line">    <span class="comment">//【1】解析 "library" 标签</span></span><br><span class="line">    String lname = parser.getAttributeValue(<span class="keyword">null</span>, <span class="string">"name"</span>);</span><br><span class="line">    String lfile = parser.getAttributeValue(<span class="keyword">null</span>, <span class="string">"file"</span>);</span><br><span class="line">    <span class="keyword">if</span> (lname == <span class="keyword">null</span>) &#123;</span><br><span class="line">        Slog.w(TAG, <span class="string">"&lt;library&gt; without name in "</span> + permFile + <span class="string">" at "</span></span><br><span class="line">                + parser.getPositionDescription());</span><br><span class="line">    &#125; <span class="keyword">else</span> <span class="keyword">if</span> (lfile == <span class="keyword">null</span>) &#123;</span><br><span class="line">        Slog.w(TAG, <span class="string">"&lt;library&gt; without file in "</span> + permFile + <span class="string">" at "</span></span><br><span class="line">                + parser.getPositionDescription());</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        <span class="comment">//Log.i(TAG, "Got library " + lname + " in " + lfile);</span></span><br><span class="line">        mSharedLibraries.put(lname, lfile);</span><br><span class="line">    &#125;</span><br><span class="line">    XmlUtils.skipCurrentTag(parser);</span><br><span class="line">    <span class="keyword">continue</span>;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>解析共享库信息，保存到 mSharedLibraries 中，key 为 共享库名称，value 为共享库路径！</p>
<h3 id="2-2-5-解析-“feature”-获得系统特性配置信息"><a href="#2-2-5-解析-“feature”-获得系统特性配置信息" class="headerlink" title="2.2.5 解析 “feature” - 获得系统特性配置信息"></a>2.2.5 解析 “feature” - 获得系统特性配置信息</h3><p>“feature” 的 xml 内容如下：<br><figure class="highlight"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">&lt;permissions&gt;</span><br><span class="line">    &lt;feature name=<span class="string">"android.hardware.bluetooth"</span> /&gt;</span><br><span class="line">&lt;/permissions&gt;</span><br></pre></td></tr></table></figure></p>
<p>下面是解析过程：<br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br></pre></td><td class="code"><pre><span class="line">&#125; <span class="keyword">else</span> <span class="keyword">if</span> (<span class="string">"feature"</span>.equals(name) &amp;&amp; allowFeatures) &#123; </span><br><span class="line"></span><br><span class="line">    <span class="comment">//【1】解析 "feature" 标签</span></span><br><span class="line">    <span class="comment">// 获得 feature 的名称和版本号</span></span><br><span class="line">    String fname = parser.getAttributeValue(<span class="keyword">null</span>, <span class="string">"name"</span>);</span><br><span class="line">    <span class="keyword">int</span> fversion = XmlUtils.readIntAttribute(parser, <span class="string">"version"</span>, <span class="number">0</span>);</span><br><span class="line">    <span class="keyword">boolean</span> allowed;</span><br><span class="line">    <span class="keyword">if</span> (!lowRam) &#123;</span><br><span class="line">        allowed = <span class="keyword">true</span>;</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        String notLowRam = parser.getAttributeValue(<span class="keyword">null</span>, <span class="string">"notLowRam"</span>);</span><br><span class="line">        allowed = !<span class="string">"true"</span>.equals(notLowRam);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span> (fname == <span class="keyword">null</span>) &#123;</span><br><span class="line">        Slog.w(TAG, <span class="string">"&lt;feature&gt; without name in "</span> + permFile + <span class="string">" at "</span></span><br><span class="line">                + parser.getPositionDescription());</span><br><span class="line">    &#125; <span class="keyword">else</span> <span class="keyword">if</span> (allowed) &#123;</span><br><span class="line">        addFeature(fname, fversion);</span><br><span class="line">    &#125;</span><br><span class="line">    XmlUtils.skipCurrentTag(parser);</span><br><span class="line">    <span class="keyword">continue</span>;</span><br><span class="line"></span><br><span class="line">&#125; <span class="keyword">else</span> <span class="keyword">if</span> (<span class="string">"unavailable-feature"</span>.equals(name) &amp;&amp; allowFeatures) &#123;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//【2】解析 "unavailable-feature" 标签</span></span><br><span class="line">    String fname = parser.getAttributeValue(<span class="keyword">null</span>, <span class="string">"name"</span>);</span><br><span class="line">    <span class="keyword">if</span> (fname == <span class="keyword">null</span>) &#123;</span><br><span class="line">        Slog.w(TAG, <span class="string">"&lt;unavailable-feature&gt; without name in "</span> + permFile + <span class="string">" at "</span></span><br><span class="line">                + parser.getPositionDescription());</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        mUnavailableFeatures.add(fname);</span><br><span class="line">    &#125;</span><br><span class="line">    XmlUtils.skipCurrentTag(parser);</span><br><span class="line">    <span class="keyword">continue</span>;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>上面会把配置文件中的 feature 解析出来，可用 feature 会被添加到 mAvailableFeatures 中，不可用 feature 会被添加到 mUnavailableFeatures 中！</p>
<h3 id="2-2-6-解析其他的标签"><a href="#2-2-6-解析其他的标签" class="headerlink" title="2.2.6 解析其他的标签"></a>2.2.6 解析其他的标签</h3><p>其他的标签有如下几个:</p>
<ul>
<li>解析 <strong>“allow-in-power-save-except-idle”</strong>，这个是省电模式的白名单，该白名单不包括 idle 白名单！<ul>
<li>mAllowInPowerSaveExceptIdle.add(pkgname);</li>
</ul>
</li>
</ul>
<ul>
<li><p>解析 <strong>“allow-in-power-save”</strong>，这个是省电模式的白名单！</p>
<ul>
<li>mAllowInPowerSave.add(pkgname);</li>
</ul>
</li>
<li><p>解析 <strong>“allow-in-data-usage-save”</strong></p>
<ul>
<li>mAllowInDataUsageSave.add(pkgname);</li>
</ul>
</li>
<li><p>解析 <strong>“app-link”</strong></p>
<ul>
<li>mLinkedApps.add(pkgname);</li>
</ul>
</li>
<li><p>解析 <strong>“system-user-whitelisted-app”</strong></p>
<ul>
<li>mSystemUserWhitelistedApps.add(pkgname);</li>
</ul>
</li>
<li><p>解析 <strong>“default-enabled-vr-app”</strong></p>
<ul>
<li>mDefaultVrComponents.add(new ComponentName(pkgname, clsname));</li>
</ul>
</li>
<li><p>解析 <strong>“backup-transport-whitelisted-service”</strong></p>
<ul>
<li>ComponentName cn = ComponentName.unflattenFromString(serviceName);  </li>
<li>mBackupTransportWhitelist.add(cn);</li>
</ul>
</li>
<li><p>解析 <strong>“disabled-until-used-preinstalled-carrier-associated-app”</strong></p>
<ul>
<li>associatedPkgs = new ArrayList&lt;&gt;();</li>
<li>mDisabledUntilUsedPreinstalledCarrierAssociatedApps.put(carrierPkgname, associatedPkgs);</li>
<li>associatedPkgs.add(pkgname);</li>
</ul>
</li>
</ul>
<p>SystemConfig 内部的数据关系图：</p>
<p><img src="http://static.zybuluo.com/Coolqi/0g1rmxre4lcm4b8u2vg0wwv5/SystemConfig.png" alt="SystemConfig.png-199.2kB"></p>
<h2 id="2-3-PMS-对于-SystemConfig-的后续处理"><a href="#2-3-PMS-对于-SystemConfig-的后续处理" class="headerlink" title="2.3 PMS 对于 SystemConfig 的后续处理"></a>2.3 PMS 对于 SystemConfig 的后续处理</h2><p>然后，回到 PMS 的构造器中：<br>将 SystemConfig 中的 mGlobalGids，mSystemPermissions 和 mAvailableFeatures 拷贝一份保存到 PMS 中！<br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//【1】保存到 PMS 中！</span></span><br><span class="line">mGlobalGids = systemConfig.getGlobalGids();</span><br><span class="line">mSystemPermissions = systemConfig.getSystemPermissions();</span><br><span class="line">mAvailableFeatures = systemConfig.getAvailableFeatures();</span><br></pre></td></tr></table></figure></p>
<p>接着，处理权限信息和共享库信息，将解析出来的 mPermissions 信息保存到 Setting 的 mPermissions 中，权限所属的包名为 android !</p>
<p>因为 SystemConfig.mPermissions 保存的是系统中定义的权限和对应的 Gid 的关系！！<br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//【2】从获得 SystemConfig 加载的系统权限集合 mPermissions！</span></span><br><span class="line">ArrayMap&lt;String, SystemConfig.PermissionEntry&gt; permConfig</span><br><span class="line">        = systemConfig.getPermissions();</span><br><span class="line"></span><br><span class="line"><span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; permConfig.size(); i++) &#123;</span><br><span class="line">    SystemConfig.PermissionEntry perm = permConfig.valueAt(i);</span><br><span class="line">    BasePermission bp = mSettings.mPermissions.get(perm.name);</span><br><span class="line">    </span><br><span class="line">    <span class="comment">//【2】加入到 Settings 的 mPermissions 中，SystemConfig 解析的权限的包名都为 “android”！</span></span><br><span class="line">    <span class="keyword">if</span> (bp == <span class="keyword">null</span>) &#123;</span><br><span class="line">        <span class="comment">// BasePermission.TYPE_BUILTIN 表示的是在编译时期就确定好的，系统要提供的权限！</span></span><br><span class="line">        bp = <span class="keyword">new</span> BasePermission(perm.name, <span class="string">"android"</span>, BasePermission.TYPE_BUILTIN);</span><br><span class="line">        mSettings.mPermissions.put(perm.name, bp);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// 如果系统权限有所属的 gids，将其添加到 BasePermission 对象中！</span></span><br><span class="line">    <span class="keyword">if</span> (perm.gids != <span class="keyword">null</span>) &#123;</span><br><span class="line">        bp.setGids(perm.gids, perm.perUser);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">//【3】处理共享库，将共享库信息也保存一份在 PMS 中！</span></span><br><span class="line">ArrayMap&lt;String, String&gt; libConfig = systemConfig.getSharedLibraries();</span><br><span class="line"><span class="keyword">for</span> (<span class="keyword">int</span> i=<span class="number">0</span>; i&lt;libConfig.size(); i++) &#123;</span><br><span class="line">    mSharedLibraries.put(libConfig.keyAt(i),</span><br><span class="line">            <span class="keyword">new</span> SharedLibraryEntry(libConfig.valueAt(i), <span class="keyword">null</span>));</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>创建了一个 BasePermission 对象，封装系统权限！！<br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">BasePermission(String _name, String _sourcePackage, <span class="keyword">int</span> _type) &#123;</span><br><span class="line">    name = _name; <span class="comment">// 权限名；</span></span><br><span class="line">    sourcePackage = _sourcePackage; <span class="comment">// 定义权限的包名；</span></span><br><span class="line">    type = _type; <span class="comment">// 权限类型！</span></span><br><span class="line">    <span class="comment">// Default to most conservative protection level.</span></span><br><span class="line">    protectionLevel = PermissionInfo.PROTECTION_SIGNATURE; <span class="comment">// 权限界别！</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>同时设置系统权限的 gid：<br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">setGids</span><span class="params">(<span class="keyword">int</span>[] gids, <span class="keyword">boolean</span> perUser)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">this</span>.gids = gids; <span class="comment">// 设置 gids</span></span><br><span class="line">    <span class="keyword">this</span>.perUser = perUser;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>可以看到，SystemConfig 保存的均是和系统相关的属性信息，比如系统权限，系统特性， Gid 等等，而 Settings 中则保存的系统和和应用所有的信息，所以，这里需要将 SystemConfig 中的权限信息保存过来！</p>
<p>这里就先分析到这里，后面会继续补充！</p>
<h2 id="2-4-阶段总结"><a href="#2-4-阶段总结" class="headerlink" title="2.4 阶段总结"></a>2.4 阶段总结</h2><p>我们来总结一下，SystemConfig、Settings 以及 PackageManagerService 之间的数据关系：</p>
<p><img src="http://static.zybuluo.com/Coolqi/k8x8t2wuygcwxb03ecqvp29k/pic.png" alt="pic.png-81.1kB"></p>
<p>通过 SystemConfig 解析，我们可以系统定义的一些配置信息：</p>
<ul>
<li>系统定义的一些 gid；</li>
<li>系统定义的权限和 uid 的映射关系；</li>
<li>系统定义的权限和 gid 的映射关系；</li>
<li>系统共享库和feature；</li>
</ul>
<p>我们继续看！</p>
<h1 id="6-PackageHandler"><a href="#6-PackageHandler" class="headerlink" title="6 PackageHandler"></a>6 PackageHandler</h1><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 建立并启动一个名为 “PackageManager” 的 ServiceThread，用于处理一些耗时的操作！</span></span><br><span class="line">mHandlerThread = <span class="keyword">new</span> ServiceThread(TAG,</span><br><span class="line">            Process.THREAD_PRIORITY_BACKGROUND, <span class="keyword">true</span> <span class="comment">/*allowIo*/</span>);</span><br><span class="line">mHandlerThread.start();</span><br><span class="line"><span class="comment">// 创建一个 PackageHandler 对象，绑定前面创建的 HandlerThread！</span></span><br><span class="line">mHandler = <span class="keyword">new</span> PackageHandler(mHandlerThread.getLooper());</span><br></pre></td></tr></table></figure>
<p>这里的 ServiceThread 继承了 HandlerThread，专门为系统服务定义的！</p>
<p>PackageHandler 处理的 msg 有如下：<br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">static</span> <span class="keyword">final</span> <span class="keyword">int</span> SEND_PENDING_BROADCAST = <span class="number">1</span>;</span><br><span class="line"><span class="keyword">static</span> <span class="keyword">final</span> <span class="keyword">int</span> MCS_BOUND = <span class="number">3</span>;</span><br><span class="line"><span class="keyword">static</span> <span class="keyword">final</span> <span class="keyword">int</span> END_COPY = <span class="number">4</span>;</span><br><span class="line"><span class="keyword">static</span> <span class="keyword">final</span> <span class="keyword">int</span> INIT_COPY = <span class="number">5</span>;</span><br><span class="line"><span class="keyword">static</span> <span class="keyword">final</span> <span class="keyword">int</span> MCS_UNBIND = <span class="number">6</span>;</span><br><span class="line"><span class="keyword">static</span> <span class="keyword">final</span> <span class="keyword">int</span> START_CLEANING_PACKAGE = <span class="number">7</span>; <span class="comment">// 清楚 package</span></span><br><span class="line"><span class="keyword">static</span> <span class="keyword">final</span> <span class="keyword">int</span> FIND_INSTALL_LOC = <span class="number">8</span>;</span><br><span class="line"><span class="keyword">static</span> <span class="keyword">final</span> <span class="keyword">int</span> POST_INSTALL = <span class="number">9</span>; <span class="comment">// 安装 package</span></span><br><span class="line"><span class="keyword">static</span> <span class="keyword">final</span> <span class="keyword">int</span> MCS_RECONNECT = <span class="number">10</span>;</span><br><span class="line"><span class="keyword">static</span> <span class="keyword">final</span> <span class="keyword">int</span> MCS_GIVE_UP = <span class="number">11</span>;</span><br><span class="line"><span class="keyword">static</span> <span class="keyword">final</span> <span class="keyword">int</span> UPDATED_MEDIA_STATUS = <span class="number">12</span>;</span><br><span class="line"><span class="keyword">static</span> <span class="keyword">final</span> <span class="keyword">int</span> WRITE_SETTINGS = <span class="number">13</span>;</span><br><span class="line"><span class="keyword">static</span> <span class="keyword">final</span> <span class="keyword">int</span> WRITE_PACKAGE_RESTRICTIONS = <span class="number">14</span>;</span><br><span class="line"><span class="keyword">static</span> <span class="keyword">final</span> <span class="keyword">int</span> PACKAGE_VERIFIED = <span class="number">15</span>; <span class="comment">// 校验 package</span></span><br><span class="line"><span class="keyword">static</span> <span class="keyword">final</span> <span class="keyword">int</span> CHECK_PENDING_VERIFICATION = <span class="number">16</span>;</span><br><span class="line"><span class="keyword">static</span> <span class="keyword">final</span> <span class="keyword">int</span> START_INTENT_FILTER_VERIFICATIONS = <span class="number">17</span>;</span><br><span class="line"><span class="keyword">static</span> <span class="keyword">final</span> <span class="keyword">int</span> INTENT_FILTER_VERIFIED = <span class="number">18</span>;</span><br><span class="line"><span class="keyword">static</span> <span class="keyword">final</span> <span class="keyword">int</span> WRITE_PACKAGE_LIST = <span class="number">19</span>;</span><br></pre></td></tr></table></figure></p>
<p>一些耗时的操作，pms 都会交给 PackageHandler 去做，比如安装应用，卸载应用等等的操作，这个以后再分析！</p>
<h1 id="7-SELinuxMMAC-readInstallPolicy"><a href="#7-SELinuxMMAC-readInstallPolicy" class="headerlink" title="7 SELinuxMMAC.readInstallPolicy"></a>7 SELinuxMMAC.readInstallPolicy</h1><p>调用 SELinuxMMAC.readInstallPolicy 读取 /etc/security/mac_permissions.xml 文件中的 selinux 配置，设置应用程序的安全上下文！<br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">boolean</span> <span class="title">readInstallPolicy</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    <span class="comment">// Temp structure to hold the rules while we parse the xml file</span></span><br><span class="line">    List&lt;Policy&gt; policies = <span class="keyword">new</span> ArrayList&lt;&gt;();</span><br><span class="line"></span><br><span class="line">    FileReader policyFile = <span class="keyword">null</span>;</span><br><span class="line">    XmlPullParser parser = Xml.newPullParser();</span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">        <span class="comment">//【1】获得 /etc/security/mac_permissions.xml 文件引用！</span></span><br><span class="line">        policyFile = <span class="keyword">new</span> FileReader(MAC_PERMISSIONS);</span><br><span class="line">        Slog.d(TAG, <span class="string">"Using policy file "</span> + MAC_PERMISSIONS);</span><br><span class="line"></span><br><span class="line">        parser.setInput(policyFile);</span><br><span class="line">        parser.nextTag();</span><br><span class="line">        parser.require(XmlPullParser.START_TAG, <span class="keyword">null</span>, <span class="string">"policy"</span>);</span><br><span class="line"></span><br><span class="line">        <span class="keyword">while</span> (parser.next() != XmlPullParser.END_TAG) &#123;</span><br><span class="line">            <span class="keyword">if</span> (parser.getEventType() != XmlPullParser.START_TAG) &#123;</span><br><span class="line">                <span class="keyword">continue</span>;</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            <span class="keyword">switch</span> (parser.getName()) &#123;</span><br><span class="line">                <span class="keyword">case</span> <span class="string">"signer"</span>: <span class="comment">//【7.1】解析 "signer" 标签的内容，返回一个 Policy 对象！！</span></span><br><span class="line">                    policies.add(readSignerOrThrow(parser));</span><br><span class="line">                    <span class="keyword">break</span>;</span><br><span class="line">                <span class="keyword">default</span>:</span><br><span class="line">                    skip(parser);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125; <span class="keyword">catch</span> (IllegalStateException | IllegalArgumentException |</span><br><span class="line">            XmlPullParserException ex) &#123;</span><br><span class="line">        ... ... ... ...</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">false</span>;</span><br><span class="line">    &#125; <span class="keyword">catch</span> (IOException ioe) &#123;</span><br><span class="line">        Slog.w(TAG, <span class="string">"Exception parsing "</span> + MAC_PERMISSIONS, ioe);</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">false</span>;</span><br><span class="line">    &#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">        IoUtils.closeQuietly(policyFile);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//【3】使用比较器对其进行排序！</span></span><br><span class="line">    PolicyComparator policySort = <span class="keyword">new</span> PolicyComparator();</span><br><span class="line">    Collections.sort(policies, policySort);</span><br><span class="line">    <span class="keyword">if</span> (policySort.foundDuplicate()) &#123;</span><br><span class="line">        Slog.w(TAG, <span class="string">"ERROR! Duplicate entries found parsing "</span> + MAC_PERMISSIONS);</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">false</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    </span><br><span class="line">    <span class="keyword">synchronized</span> (sPolicies) &#123;</span><br><span class="line">        sPolicies = policies;</span><br><span class="line">        <span class="keyword">if</span> (DEBUG_POLICY_ORDER) &#123;</span><br><span class="line">            <span class="keyword">for</span> (Policy policy : sPolicies) &#123;</span><br><span class="line">                Slog.d(TAG, <span class="string">"Policy: "</span> + policy.toString());</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">true</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>这里用到了一个文件对象！<br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> File MAC_PERMISSIONS = <span class="keyword">new</span> File(Environment.getRootDirectory(),</span><br><span class="line">        <span class="string">"/etc/security/mac_permissions.xml"</span>);</span><br></pre></td></tr></table></figure></p>
<p>我们来看下该文件的内容；<br><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">policy</span>&gt;</span></span><br><span class="line">    <span class="comment">&lt;!-- Platform dev key in AOSP --&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">signer</span> <span class="attr">signature</span>=<span class="string">"@PLATFORM"</span> &gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">seinfo</span> <span class="attr">value</span>=<span class="string">"platform"</span> /&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">signer</span>&gt;</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">&lt;!-- Media key in AOSP --&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">signer</span> <span class="attr">signature</span>=<span class="string">"@MEDIA"</span> &gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">seinfo</span> <span class="attr">value</span>=<span class="string">"media"</span> /&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">signer</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">policy</span>&gt;</span></span><br></pre></td></tr></table></figure></p>
<p>在 Android 引入 SeLinux 以后，Android 会为每个文件打上 SE Label，对于 APK 而言，打 SE Label 的准则就是签名，即根据签名信息打上不同的 SE Label。</p>
<p>Android 将签名分类成为 platform，testkey，media等，签名与类别的映射关系就存在一个叫 mac_permission.xml 的文件中。</p>
<p>所以，需要读取该文件的内容。</p>
<p>根据 mac_permissions.xml 的定义，如果 App 是在 Android 源码编译环境下，其 Android.mk 中指定了 LOCAL_CERTIFICATE : = platform 的话，它的 seinfo 就是 platform。如果 Android.mk 中不进行对应的设置，setinfo 为默认值 default。</p>
<p>对于第三方 APK，其 seinfo 值通常为 default。</p>
<p>当 mac_permissions.xml 编译进 system/etc 目录时，@PLATFORM 将被实际的签名信息替换：</p>
<figure class="highlight"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">&lt;?xml version=<span class="string">"1.0"</span> encoding=<span class="string">"iso-8859-1"</span>?&gt;</span><br><span class="line">&lt;!-- AUTOGENERATED FILE DO NOT MODIFY --&gt;</span><br><span class="line">&lt;policy&gt;</span><br><span class="line">    &lt;signer signature=<span class="string">"308204......232e4fe9bd961394c6300e5138e3cfd285e6e4e483538cb8b1b357"</span>&gt;</span><br><span class="line">        &lt;seinfo value=<span class="string">"platform"</span>/&gt;</span><br><span class="line">    &lt;/signer&gt;</span><br><span class="line">    &lt;<span class="keyword">default</span>&gt;</span><br><span class="line">        &lt;seinfo value=<span class="string">"default"</span>/&gt;</span><br><span class="line">    &lt;/default&gt;</span><br><span class="line">&lt;/policy&gt;</span><br></pre></td></tr></table></figure>
<p>这里不多说了。</p>
<h2 id="7-1-SELinuxMMAC-readSignerOrThrow"><a href="#7-1-SELinuxMMAC-readSignerOrThrow" class="headerlink" title="7.1 SELinuxMMAC.readSignerOrThrow"></a>7.1 SELinuxMMAC.readSignerOrThrow</h2><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">static</span> Policy <span class="title">readSignerOrThrow</span><span class="params">(XmlPullParser parser)</span> <span class="keyword">throws</span> IOException,</span></span><br><span class="line"><span class="function">        XmlPullParserException </span>&#123;</span><br><span class="line">    parser.require(XmlPullParser.START_TAG, <span class="keyword">null</span>, <span class="string">"signer"</span>);</span><br><span class="line">    Policy.PolicyBuilder pb = <span class="keyword">new</span> Policy.PolicyBuilder();</span><br><span class="line">    <span class="comment">//【1】解析 signature 属性</span></span><br><span class="line">    String cert = parser.getAttributeValue(<span class="keyword">null</span>, <span class="string">"signature"</span>);</span><br><span class="line">    <span class="keyword">if</span> (cert != <span class="keyword">null</span>) &#123;</span><br><span class="line">        pb.addSignature(cert);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">while</span> (parser.next() != XmlPullParser.END_TAG) &#123;</span><br><span class="line">        <span class="keyword">if</span> (parser.getEventType() != XmlPullParser.START_TAG) &#123;</span><br><span class="line">            <span class="keyword">continue</span>;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        String tagName = parser.getName();</span><br><span class="line">        <span class="keyword">if</span> (<span class="string">"seinfo"</span>.equals(tagName)) &#123; <span class="comment">//【2】解析子标签 seinfo！</span></span><br><span class="line">            String seinfo = parser.getAttributeValue(<span class="keyword">null</span>, <span class="string">"value"</span>);</span><br><span class="line">            pb.setGlobalSeinfoOrThrow(seinfo);</span><br><span class="line">            readSeinfo(parser);</span><br><span class="line">        &#125; <span class="keyword">else</span> <span class="keyword">if</span> (<span class="string">"package"</span>.equals(tagName)) &#123; <span class="comment">//【3】解析子标签 package！</span></span><br><span class="line">            readPackageOrThrow(parser, pb);</span><br><span class="line">        &#125; <span class="keyword">else</span> <span class="keyword">if</span> (<span class="string">"cert"</span>.equals(tagName)) &#123; <span class="comment">//【4】解析子标签 cert！</span></span><br><span class="line">            String sig = parser.getAttributeValue(<span class="keyword">null</span>, <span class="string">"signature"</span>);</span><br><span class="line">            pb.addSignature(sig);</span><br><span class="line">            readCert(parser);</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            skip(parser);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> pb.build();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>可以看到，readSignerOrThrow 方法会解析 signer 标签和其子标签，然后将结果通过 buidler 模式，封装成一个 Policy 对象返回！</p>
<h1 id="8-Settings-readLPw"><a href="#8-Settings-readLPw" class="headerlink" title="8 Settings.readLPw"></a>8 Settings.readLPw</h1><p>继续看：<br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">mFirstBoot = !mSettings.readLPw(sUserManager.getUsers(<span class="keyword">false</span>));</span><br></pre></td></tr></table></figure></p>
<p>这个方法用来恢复上一次安装的信息，参数传递：</p>
<ul>
<li>List<userinfo> users：当前是设备用户 id！</userinfo></li>
</ul>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br><span class="line">212</span><br><span class="line">213</span><br><span class="line">214</span><br><span class="line">215</span><br><span class="line">216</span><br><span class="line">217</span><br><span class="line">218</span><br><span class="line">219</span><br><span class="line">220</span><br><span class="line">221</span><br><span class="line">222</span><br><span class="line">223</span><br><span class="line">224</span><br><span class="line">225</span><br><span class="line">226</span><br><span class="line">227</span><br><span class="line">228</span><br><span class="line">229</span><br><span class="line">230</span><br><span class="line">231</span><br><span class="line">232</span><br><span class="line">233</span><br><span class="line">234</span><br><span class="line">235</span><br><span class="line">236</span><br><span class="line">237</span><br><span class="line">238</span><br><span class="line">239</span><br><span class="line">240</span><br><span class="line">241</span><br><span class="line">242</span><br><span class="line">243</span><br><span class="line">244</span><br><span class="line">245</span><br><span class="line">246</span><br><span class="line">247</span><br><span class="line">248</span><br><span class="line">249</span><br><span class="line">250</span><br><span class="line">251</span><br><span class="line">252</span><br><span class="line">253</span><br><span class="line">254</span><br><span class="line">255</span><br><span class="line">256</span><br><span class="line">257</span><br><span class="line">258</span><br><span class="line">259</span><br><span class="line">260</span><br><span class="line">261</span><br><span class="line">262</span><br><span class="line">263</span><br><span class="line">264</span><br><span class="line">265</span><br><span class="line">266</span><br><span class="line">267</span><br><span class="line">268</span><br><span class="line">269</span><br><span class="line">270</span><br><span class="line">271</span><br><span class="line">272</span><br><span class="line">273</span><br><span class="line">274</span><br><span class="line">275</span><br><span class="line">276</span><br><span class="line">277</span><br><span class="line">278</span><br><span class="line">279</span><br><span class="line">280</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">boolean</span> <span class="title">readLPw</span><span class="params">(@NonNull List&lt;UserInfo&gt; users)</span> </span>&#123;</span><br><span class="line">    FileInputStream str = <span class="keyword">null</span>;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">//【1】如果 packages-backup.xml 存在，就从 packages-backup.xml 中读取</span></span><br><span class="line">    <span class="keyword">if</span> (mBackupSettingsFilename.exists()) &#123;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            str = <span class="keyword">new</span> FileInputStream(mBackupSettingsFilename);</span><br><span class="line">            mReadMessages.append(<span class="string">"Reading from backup settings file\n"</span>);</span><br><span class="line">            PackageManagerService.reportSettingsProblem(Log.INFO,</span><br><span class="line">                    <span class="string">"Need to read from backup settings file"</span>);</span><br><span class="line">            </span><br><span class="line">            <span class="comment">// 如果 packages.xml 存在，删除！</span></span><br><span class="line">            <span class="keyword">if</span> (mSettingsFilename.exists()) &#123;</span><br><span class="line">                Slog.w(PackageManagerService.TAG, <span class="string">"Cleaning up settings file "</span></span><br><span class="line">                        + mSettingsFilename);</span><br><span class="line">                mSettingsFilename.delete();</span><br><span class="line">            &#125;</span><br><span class="line">        &#125; <span class="keyword">catch</span> (java.io.IOException e) &#123;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 清空一些集合，防止异常问题！</span></span><br><span class="line">    mPendingPackages.clear();</span><br><span class="line">    mPastSignatures.clear();</span><br><span class="line">    mKeySetRefs.clear();</span><br><span class="line">    mInstallerPackages.clear();</span><br><span class="line"></span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">    </span><br><span class="line">        <span class="comment">//【2】如果 packages-backup.xml 不存在，就从 packages.xml 中读取！ </span></span><br><span class="line">        <span class="keyword">if</span> (str == <span class="keyword">null</span>) &#123;</span><br><span class="line">            <span class="keyword">if</span> (!mSettingsFilename.exists()) &#123;</span><br><span class="line">                mReadMessages.append(<span class="string">"No settings file found\n"</span>);</span><br><span class="line">                PackageManagerService.reportSettingsProblem(Log.INFO,</span><br><span class="line">                        <span class="string">"No settings file; creating initial state"</span>);</span><br><span class="line">                <span class="comment">// It's enough to just touch version details to create them</span></span><br><span class="line">                <span class="comment">// with default values</span></span><br><span class="line">                findOrCreateVersion(StorageManager.UUID_PRIVATE_INTERNAL);</span><br><span class="line">                findOrCreateVersion(StorageManager.UUID_PRIMARY_PHYSICAL);</span><br><span class="line">                <span class="keyword">return</span> <span class="keyword">false</span>;</span><br><span class="line">            &#125;</span><br><span class="line">            str = <span class="keyword">new</span> FileInputStream(mSettingsFilename);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        XmlPullParser parser = Xml.newPullParser();</span><br><span class="line">        parser.setInput(str, StandardCharsets.UTF_8.name());</span><br><span class="line"></span><br><span class="line">        <span class="keyword">int</span> type;</span><br><span class="line">        <span class="keyword">while</span> ((type = parser.next()) != XmlPullParser.START_TAG</span><br><span class="line">                &amp;&amp; type != XmlPullParser.END_DOCUMENT) &#123;</span><br><span class="line">            ;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (type != XmlPullParser.START_TAG) &#123;</span><br><span class="line">            mReadMessages.append(<span class="string">"No start tag found in settings file\n"</span>);</span><br><span class="line">            PackageManagerService.reportSettingsProblem(Log.WARN,</span><br><span class="line">                    <span class="string">"No start tag found in package manager settings"</span>);</span><br><span class="line">            Slog.wtf(PackageManagerService.TAG,</span><br><span class="line">                    <span class="string">"No start tag found in package manager settings"</span>);</span><br><span class="line">            <span class="keyword">return</span> <span class="keyword">false</span>;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">int</span> outerDepth = parser.getDepth();</span><br><span class="line">        <span class="keyword">while</span> ((type = parser.next()) != XmlPullParser.END_DOCUMENT</span><br><span class="line">                &amp;&amp; (type != XmlPullParser.END_TAG || parser.getDepth() &gt; outerDepth)) &#123;</span><br><span class="line">            <span class="keyword">if</span> (type == XmlPullParser.END_TAG || type == XmlPullParser.TEXT) &#123;</span><br><span class="line">                <span class="keyword">continue</span>;</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            String tagName = parser.getName();</span><br><span class="line">            <span class="keyword">if</span> (tagName.equals(<span class="string">"package"</span>)) &#123; <span class="comment">//【2.1】解析 "package"</span></span><br><span class="line">                readPackageLPw(parser);</span><br><span class="line">                </span><br><span class="line">            &#125; <span class="keyword">else</span> <span class="keyword">if</span> (tagName.equals(<span class="string">"permissions"</span>)) &#123; <span class="comment">//【2.2】解析 "permissions"</span></span><br><span class="line">                readPermissionsLPw(mPermissions, parser);</span><br><span class="line">                </span><br><span class="line">            &#125; <span class="keyword">else</span> <span class="keyword">if</span> (tagName.equals(<span class="string">"permission-trees"</span>)) &#123;  <span class="comment">//【2.3】解析 "permission-trees"</span></span><br><span class="line">                readPermissionsLPw(mPermissionTrees, parser);</span><br><span class="line">                </span><br><span class="line">            &#125; <span class="keyword">else</span> <span class="keyword">if</span> (tagName.equals(<span class="string">"shared-user"</span>)) &#123; <span class="comment">//【2.4】解析 "shared-user"</span></span><br><span class="line">                readSharedUserLPw(parser);</span><br><span class="line">                </span><br><span class="line">            &#125; <span class="keyword">else</span> <span class="keyword">if</span> (tagName.equals(<span class="string">"preferred-packages"</span>)) &#123; </span><br><span class="line">                <span class="comment">// no longer used.</span></span><br><span class="line"></span><br><span class="line">            &#125; <span class="keyword">else</span> <span class="keyword">if</span> (tagName.equals(<span class="string">"preferred-activities"</span>)) &#123; <span class="comment">//【2.5】解析 "preferred-activities"</span></span><br><span class="line">                readPreferredActivitiesLPw(parser, <span class="number">0</span>);</span><br><span class="line">                </span><br><span class="line">            &#125; <span class="keyword">else</span> <span class="keyword">if</span> (tagName.equals(TAG_PERSISTENT_PREFERRED_ACTIVITIES)) &#123; </span><br><span class="line">                <span class="comment">// 解析 "persistent-preferred-activities"</span></span><br><span class="line">                <span class="comment">// Android 7.1.1 的默认应用已经不在 packages.xml 中定义了！</span></span><br><span class="line">                <span class="comment">// 而是在 package-restrictions 文件中定义，这里是为了兼容以前的版本！</span></span><br><span class="line">                readPersistentPreferredActivitiesLPw(parser, <span class="number">0</span>); </span><br><span class="line">                </span><br><span class="line">            &#125; <span class="keyword">else</span> <span class="keyword">if</span> (tagName.equals(TAG_CROSS_PROFILE_INTENT_FILTERS)) &#123;</span><br><span class="line">                <span class="comment">// 解析 "crossProfile-intent-filters"</span></span><br><span class="line">                readCrossProfileIntentFiltersLPw(parser, <span class="number">0</span>);</span><br><span class="line">                </span><br><span class="line">            &#125; <span class="keyword">else</span> <span class="keyword">if</span> (tagName.equals(TAG_DEFAULT_BROWSER)) &#123; <span class="comment">//【2.6】解析 "default-browser"</span></span><br><span class="line">                readDefaultAppsLPw(parser, <span class="number">0</span>);</span><br><span class="line">                </span><br><span class="line">            &#125; <span class="keyword">else</span> <span class="keyword">if</span> (tagName.equals(<span class="string">"updated-package"</span>)) &#123; <span class="comment">//【2.7】解析 "updated-package"</span></span><br><span class="line">                readDisabledSysPackageLPw(parser);</span><br><span class="line">                </span><br><span class="line">            &#125; <span class="keyword">else</span> <span class="keyword">if</span> (tagName.equals(<span class="string">"cleaning-package"</span>)) &#123; <span class="comment">//【2.8】解析 "cleaning-package"</span></span><br><span class="line">                String name = parser.getAttributeValue(<span class="keyword">null</span>, ATTR_NAME);</span><br><span class="line">                String userStr = parser.getAttributeValue(<span class="keyword">null</span>, ATTR_USER);</span><br><span class="line">                String codeStr = parser.getAttributeValue(<span class="keyword">null</span>, ATTR_CODE);</span><br><span class="line">                <span class="keyword">if</span> (name != <span class="keyword">null</span>) &#123;</span><br><span class="line">                    <span class="keyword">int</span> userId = UserHandle.USER_SYSTEM;</span><br><span class="line">                    <span class="keyword">boolean</span> andCode = <span class="keyword">true</span>;</span><br><span class="line">                    <span class="keyword">try</span> &#123;</span><br><span class="line">                        <span class="keyword">if</span> (userStr != <span class="keyword">null</span>) &#123;</span><br><span class="line">                            userId = Integer.parseInt(userStr);</span><br><span class="line">                        &#125;</span><br><span class="line">                    &#125; <span class="keyword">catch</span> (NumberFormatException e) &#123;</span><br><span class="line">                    &#125;</span><br><span class="line">                    <span class="keyword">if</span> (codeStr != <span class="keyword">null</span>) &#123;</span><br><span class="line">                        andCode = Boolean.parseBoolean(codeStr);</span><br><span class="line">                    &#125;</span><br><span class="line">                    addPackageToCleanLPw(<span class="keyword">new</span> PackageCleanItem(userId, name, andCode));</span><br><span class="line">                &#125;</span><br><span class="line">                </span><br><span class="line">            &#125; <span class="keyword">else</span> <span class="keyword">if</span> (tagName.equals(<span class="string">"renamed-package"</span>)) &#123; <span class="comment">//【2.9】解析 "renamed-package"</span></span><br><span class="line">                String nname = parser.getAttributeValue(<span class="keyword">null</span>, <span class="string">"new"</span>);</span><br><span class="line">                String oname = parser.getAttributeValue(<span class="keyword">null</span>, <span class="string">"old"</span>);</span><br><span class="line">                <span class="keyword">if</span> (nname != <span class="keyword">null</span> &amp;&amp; oname != <span class="keyword">null</span>) &#123;</span><br><span class="line">                    mRenamedPackages.put(nname, oname);</span><br><span class="line">                &#125;</span><br><span class="line">                </span><br><span class="line">            &#125; <span class="keyword">else</span> <span class="keyword">if</span> (tagName.equals(<span class="string">"restored-ivi"</span>)) &#123; <span class="comment">// 解析 "restored-ivi"</span></span><br><span class="line">                readRestoredIntentFilterVerifications(parser);</span><br><span class="line">                </span><br><span class="line">            &#125; <span class="keyword">else</span> <span class="keyword">if</span> (tagName.equals(<span class="string">"last-platform-version"</span>)) &#123; <span class="comment">// 解析 "last-platform-version"</span></span><br><span class="line">                <span class="comment">// Upgrade from older XML schema</span></span><br><span class="line">                <span class="keyword">final</span> VersionInfo internal = findOrCreateVersion(</span><br><span class="line">                        StorageManager.UUID_PRIVATE_INTERNAL);</span><br><span class="line">                <span class="keyword">final</span> VersionInfo external = findOrCreateVersion(</span><br><span class="line">                        StorageManager.UUID_PRIMARY_PHYSICAL);</span><br><span class="line"></span><br><span class="line">                internal.sdkVersion = XmlUtils.readIntAttribute(parser, <span class="string">"internal"</span>, <span class="number">0</span>);</span><br><span class="line">                external.sdkVersion = XmlUtils.readIntAttribute(parser, <span class="string">"external"</span>, <span class="number">0</span>);</span><br><span class="line">                internal.fingerprint = external.fingerprint =</span><br><span class="line">                        XmlUtils.readStringAttribute(parser, <span class="string">"fingerprint"</span>);</span><br><span class="line"></span><br><span class="line">            &#125; <span class="keyword">else</span> <span class="keyword">if</span> (tagName.equals(<span class="string">"database-version"</span>)) &#123; <span class="comment">// 解析 "database-version"</span></span><br><span class="line">                <span class="comment">// Upgrade from older XML schema</span></span><br><span class="line">                <span class="keyword">final</span> VersionInfo internal = findOrCreateVersion(</span><br><span class="line">                        StorageManager.UUID_PRIVATE_INTERNAL);</span><br><span class="line">                <span class="keyword">final</span> VersionInfo external = findOrCreateVersion(</span><br><span class="line">                        StorageManager.UUID_PRIMARY_PHYSICAL);</span><br><span class="line"></span><br><span class="line">                internal.databaseVersion = XmlUtils.readIntAttribute(parser, <span class="string">"internal"</span>, <span class="number">0</span>);</span><br><span class="line">                external.databaseVersion = XmlUtils.readIntAttribute(parser, <span class="string">"external"</span>, <span class="number">0</span>);</span><br><span class="line"></span><br><span class="line">            &#125; <span class="keyword">else</span> <span class="keyword">if</span> (tagName.equals(<span class="string">"verifier"</span>)) &#123; <span class="comment">// 解析 "verifier"</span></span><br><span class="line">                <span class="keyword">final</span> String deviceIdentity = parser.getAttributeValue(<span class="keyword">null</span>, <span class="string">"device"</span>);</span><br><span class="line">                <span class="keyword">try</span> &#123;</span><br><span class="line">                    mVerifierDeviceIdentity = VerifierDeviceIdentity.parse(deviceIdentity);</span><br><span class="line">                &#125; <span class="keyword">catch</span> (IllegalArgumentException e) &#123;</span><br><span class="line">                    Slog.w(PackageManagerService.TAG, <span class="string">"Discard invalid verifier device id: "</span></span><br><span class="line">                            + e.getMessage());</span><br><span class="line">                &#125;</span><br><span class="line">                </span><br><span class="line">            &#125; <span class="keyword">else</span> <span class="keyword">if</span> (TAG_READ_EXTERNAL_STORAGE.equals(tagName)) &#123; <span class="comment">// 解析 "read-external-storage"</span></span><br><span class="line">                <span class="keyword">final</span> String enforcement = parser.getAttributeValue(<span class="keyword">null</span>, ATTR_ENFORCEMENT);</span><br><span class="line">                mReadExternalStorageEnforced = <span class="string">"1"</span>.equals(enforcement);</span><br><span class="line">                </span><br><span class="line">            &#125; <span class="keyword">else</span> <span class="keyword">if</span> (tagName.equals(<span class="string">"keyset-settings"</span>)) &#123; <span class="comment">// 解析 "keyset-settings"</span></span><br><span class="line">                mKeySetManagerService.readKeySetsLPw(parser, mKeySetRefs);</span><br><span class="line">                </span><br><span class="line">            &#125; <span class="keyword">else</span> <span class="keyword">if</span> (TAG_VERSION.equals(tagName)) &#123; <span class="comment">// 解析 "version"</span></span><br><span class="line">                <span class="keyword">final</span> String volumeUuid = XmlUtils.readStringAttribute(parser,</span><br><span class="line">                        ATTR_VOLUME_UUID);</span><br><span class="line">                <span class="keyword">final</span> VersionInfo ver = findOrCreateVersion(volumeUuid);</span><br><span class="line">                ver.sdkVersion = XmlUtils.readIntAttribute(parser, ATTR_SDK_VERSION);</span><br><span class="line">                ver.databaseVersion = XmlUtils.readIntAttribute(parser, ATTR_SDK_VERSION);</span><br><span class="line">                ver.fingerprint = XmlUtils.readStringAttribute(parser, ATTR_FINGERPRINT);</span><br><span class="line">                </span><br><span class="line">            &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                Slog.w(PackageManagerService.TAG, <span class="string">"Unknown element under &lt;packages&gt;: "</span></span><br><span class="line">                        + parser.getName());</span><br><span class="line">                XmlUtils.skipCurrentTag(parser);</span><br><span class="line">                </span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        str.close();</span><br><span class="line"></span><br><span class="line">    &#125; <span class="keyword">catch</span> (XmlPullParserException e) &#123;</span><br><span class="line">        ... ...</span><br><span class="line"></span><br><span class="line">    &#125; <span class="keyword">catch</span> (java.io.IOException e) &#123;</span><br><span class="line">        ... ...</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//【3】If the build is setup to drop runtime permissions</span></span><br><span class="line">    <span class="comment">// on update drop the files before loading them.</span></span><br><span class="line">    <span class="keyword">if</span> (PackageManagerService.CLEAR_RUNTIME_PERMISSIONS_ON_UPGRADE) &#123;</span><br><span class="line">        <span class="keyword">final</span> VersionInfo internal = getInternalVersion();</span><br><span class="line">        <span class="keyword">if</span> (!Build.FINGERPRINT.equals(internal.fingerprint)) &#123;</span><br><span class="line">            <span class="keyword">for</span> (UserInfo user : users) &#123;</span><br><span class="line">                mRuntimePermissionsPersistence.deleteUserRuntimePermissionsFile(user.id);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//【4】接着，对 mPendingPackages 集合中的需要验证共享用户 id 有效性的 package，进行共享用户 id 有效性的验证!</span></span><br><span class="line">    <span class="keyword">final</span> <span class="keyword">int</span> N = mPendingPackages.size();</span><br><span class="line">    <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; N; i++) &#123;</span><br><span class="line">        <span class="keyword">final</span> PendingPackage pp = mPendingPackages.get(i);</span><br><span class="line">        </span><br><span class="line">        <span class="comment">// 看 sharedId 是否能对应找到一个 ShardUserSetting 对象!</span></span><br><span class="line">        Object idObj = getUserIdLPr(pp.sharedId);</span><br><span class="line">        </span><br><span class="line">        <span class="keyword">if</span> (idObj != <span class="keyword">null</span> &amp;&amp; idObj <span class="keyword">instanceof</span> SharedUserSetting) &#123; <span class="comment">// 能找到，说明共享用户 ID 是有效的!</span></span><br><span class="line">            PackageSetting p = getPackageLPw(pp.name, <span class="keyword">null</span>, pp.realName,</span><br><span class="line">                    (SharedUserSetting) idObj, pp.codePath, pp.resourcePath,</span><br><span class="line">                    pp.legacyNativeLibraryPathString, pp.primaryCpuAbiString,</span><br><span class="line">                    pp.secondaryCpuAbiString, pp.versionCode, pp.pkgFlags, pp.pkgPrivateFlags,</span><br><span class="line">                    <span class="keyword">null</span>, <span class="keyword">true</span> <span class="comment">/* add */</span>, <span class="keyword">false</span> <span class="comment">/* allowInstall */</span>, pp.parentPackageName,</span><br><span class="line">                    pp.childPackageNames);</span><br><span class="line"></span><br><span class="line">            <span class="keyword">if</span> (p == <span class="keyword">null</span>) &#123;</span><br><span class="line">                PackageManagerService.reportSettingsProblem(Log.WARN,</span><br><span class="line">                        <span class="string">"Unable to create application package for "</span> + pp.name);</span><br><span class="line">                <span class="keyword">continue</span>;</span><br><span class="line">            &#125;</span><br><span class="line">            p.copyFrom(pp); <span class="comment">// 保存到 Settings.mPackages 对象中，表明 ID 有效，已经分配 ID 了！</span></span><br><span class="line"></span><br><span class="line">        &#125; <span class="keyword">else</span> <span class="keyword">if</span> (idObj != <span class="keyword">null</span>) &#123;</span><br><span class="line">            ... ... ... </span><br><span class="line"></span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            ... ... ...</span><br><span class="line"></span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    mPendingPackages.clear(); <span class="comment">// 清空 </span></span><br><span class="line"></span><br><span class="line">    <span class="comment">//【8.3】读取 packages-stopped-backup.xml 和 packages_stopped.xml 文件 ！</span></span><br><span class="line">    <span class="keyword">if</span> (mBackupStoppedPackagesFilename.exists()</span><br><span class="line">            || mStoppedPackagesFilename.exists()) &#123;</span><br><span class="line">        <span class="comment">//【8.3.1】如果 packages_stopped.xml 存在，我们先会读取文件数据，然后删除 packages_stopped.xml 相关文件！</span></span><br><span class="line">        readStoppedLPw();</span><br><span class="line">        mBackupStoppedPackagesFilename.delete();</span><br><span class="line">        mStoppedPackagesFilename.delete();</span><br><span class="line">        <span class="comment">//【8.3.2】然后用最新的数据更新偏好设置！</span></span><br><span class="line">        writePackageRestrictionsLPr(UserHandle.USER_SYSTEM);</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        <span class="comment">//【8.3.3】否则，我们直接读取已有的偏好设置，更新上次安装的信息！</span></span><br><span class="line">        <span class="keyword">for</span> (UserInfo user : users) &#123;</span><br><span class="line">            readPackageRestrictionsLPr(user.id);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//【8.4】读取每个 user 下的运行是权限信息！</span></span><br><span class="line">    <span class="keyword">for</span> (UserInfo user : users) &#123;</span><br><span class="line">        mRuntimePermissionsPersistence.readStateForUserSyncLPr(user.id);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// mDisabledSysPackages 里面保存着所有被替换的 Package 信息，如果这些 package 之前配置的是共享用户 uid</span></span><br><span class="line">    <span class="comment">// 那这里要建立 package 和 共享用户 id 的关联！</span></span><br><span class="line">    <span class="keyword">final</span> Iterator&lt;PackageSetting&gt; disabledIt = mDisabledSysPackages.values().iterator();</span><br><span class="line">    <span class="keyword">while</span> (disabledIt.hasNext()) &#123;</span><br><span class="line">        <span class="keyword">final</span> PackageSetting disabledPs = disabledIt.next();</span><br><span class="line">        <span class="keyword">final</span> Object id = getUserIdLPr(disabledPs.appId);</span><br><span class="line">        <span class="keyword">if</span> (id != <span class="keyword">null</span> &amp;&amp; id <span class="keyword">instanceof</span> SharedUserSetting) &#123;</span><br><span class="line">            disabledPs.sharedUser = (SharedUserSetting) id;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    mReadMessages.append(<span class="string">"Read completed successfully: "</span> + mPackages.size() + <span class="string">" packages, "</span></span><br><span class="line">            + mSharedUsers.size() + <span class="string">" shared uids\n"</span>);</span><br><span class="line"></span><br><span class="line">    writeKernelMappingLPr();</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">true</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>这个方法的主要流程是：</p>
<ul>
<li>读取 packages-backup.xml 或者 packages.xml 文件中的数据并解析，获得上一次应用的安装和使用信息！</li>
<li>校验共享用户id 的应用程序包的 uid 的有效性！</li>
<li>读取 packages-stopped-backup.xml 和 packages_stopped.xml 文件中的数据并解析！</li>
<li>处理被替换的系统应用的共享用户 id 和自身的关系！</li>
</ul>
<p>下面我们来看下重要的属性的解析：</p>
<h2 id="8-1-读取-pacakges-xml-文件"><a href="#8-1-读取-pacakges-xml-文件" class="headerlink" title="8.1 读取 pacakges.xml 文件"></a>8.1 读取 pacakges.xml 文件</h2><p>这个流程主要会解析如下的标签：</p>
<table>
<thead>
<tr>
<th style="text-align:left">标签</th>
<th style="text-align:left">标签解释</th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align:left">“package”</td>
<td style="text-align:left">系统中所有应用程序包的信息</td>
</tr>
<tr>
<td style="text-align:left">“permissions”</td>
<td style="text-align:left">系统中定义的所有的权限</td>
</tr>
<tr>
<td style="text-align:left">“permission-trees”</td>
<td style="text-align:left">系统中定义的权限树</td>
</tr>
<tr>
<td style="text-align:left">“shared-user”</td>
<td style="text-align:left">系统中定义的共享用户</td>
</tr>
<tr>
<td style="text-align:left">“preferred-activities”</td>
<td style="text-align:left">系统默认应用相关</td>
</tr>
<tr>
<td style="text-align:left">“persistent-preferred-activities”</td>
<td style="text-align:left">系统默认应用相关</td>
</tr>
<tr>
<td style="text-align:left">“crossProfile-intent-filters”</td>
<td style="text-align:left"></td>
</tr>
<tr>
<td style="text-align:left">“default-browser”</td>
<td style="text-align:left">默认的浏览器</td>
</tr>
<tr>
<td style="text-align:left">“updated-package”</td>
<td style="text-align:left">系统中被更新的应用程序包</td>
</tr>
<tr>
<td style="text-align:left">“cleaning-package”</td>
<td style="text-align:left">系统中被清除掉的应用程序包</td>
</tr>
<tr>
<td style="text-align:left">“renamed-package”</td>
<td style="text-align:left">系统中被重命名的应用程序包</td>
</tr>
<tr>
<td style="text-align:left">“restored-ivi”</td>
<td style="text-align:left"></td>
</tr>
<tr>
<td style="text-align:left">“last-platform-version”</td>
<td style="text-align:left">系统升级之前的版本</td>
</tr>
<tr>
<td style="text-align:left">“database-version”</td>
<td style="text-align:left">数据库版本</td>
</tr>
<tr>
<td style="text-align:left">“verifier”</td>
<td style="text-align:left"></td>
</tr>
<tr>
<td style="text-align:left">“read-external-storage”</td>
<td style="text-align:left"></td>
</tr>
<tr>
<td style="text-align:left">“keyset-settings”</td>
<td style="text-align:left"></td>
</tr>
<tr>
<td style="text-align:left">“version”</td>
<td style="text-align:left">当前系统的版本</td>
</tr>
</tbody>
</table>
<p>我们重点分析和 package、permission，shared-user 相关的内容，其他的内容我们后续接触到在分析！</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">packages</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">version</span> <span class="attr">sdkVersion</span>=<span class="string">"27"</span> <span class="attr">databaseVersion</span>=<span class="string">"3"</span> <span class="attr">fingerprint</span>=<span class="string">"../release-keys"</span> /&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">version</span> <span class="attr">volumeUuid</span>=<span class="string">"primary_physical"</span> <span class="attr">sdkVersion</span>=<span class="string">"27"</span> <span class="attr">databaseVersion</span>=<span class="string">"27"</span></span></span><br><span class="line"><span class="tag">             <span class="attr">fingerprint</span>=<span class="string">".../release-keys"</span> /&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">permission-trees</span> /&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">permissions</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">item</span> <span class="attr">name</span>=<span class="string">"android.permission.REAL_GET_TASKS"</span> <span class="attr">package</span>=<span class="string">"android"</span> <span class="attr">protection</span>=<span class="string">"18"</span> /&gt;</span></span><br><span class="line">        <span class="comment">&lt;!-- ... ... ...--&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">permissions</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">package</span> <span class="attr">name</span>=<span class="string">"com.android.providers.calendar"</span> <span class="attr">codePath</span>=<span class="string">"/system/priv-app/CalendarProvider"</span> </span></span><br><span class="line"><span class="tag">                    <span class="attr">nativeLibraryPath</span>=<span class="string">"/system/priv-app/CalendarProvider/lib"</span> </span></span><br><span class="line"><span class="tag">					<span class="attr">primaryCpuAbi</span>=<span class="string">"armeabi-v7a"</span> <span class="attr">publicFlags</span>=<span class="string">"940064325"</span> <span class="attr">privateFlags</span>=<span class="string">"8"</span> </span></span><br><span class="line"><span class="tag">					<span class="attr">ft</span>=<span class="string">"1624a4dcee0"</span> <span class="attr">it</span>=<span class="string">"1624a4dcee0"</span> <span class="attr">ut</span>=<span class="string">"1624a4dcee0"</span></span></span><br><span class="line"><span class="tag">					<span class="attr">version</span>=<span class="string">"0"</span> <span class="attr">sharedUserId</span>=<span class="string">"10006"</span> <span class="attr">isOrphaned</span>=<span class="string">"true"</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">sigs</span> <span class="attr">count</span>=<span class="string">"1"</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">cert</span> <span class="attr">index</span>=<span class="string">"0"</span> /&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">sigs</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">perms</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">item</span> <span class="attr">name</span>=<span class="string">"android.permission.WRITE_SETTINGS"</span> <span class="attr">granted</span>=<span class="string">"true"</span> <span class="attr">flags</span>=<span class="string">"0"</span> /&gt;</span></span><br><span class="line">			<span class="comment">&lt;!-- ... ... ...--&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">perms</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">proper-signing-keyset</span> <span class="attr">identifier</span>=<span class="string">"1"</span> /&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">package</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">updated-package</span> <span class="attr">name</span>=<span class="string">"com.coolqi.papapa"</span> <span class="attr">codePath</span>=<span class="string">"/system/app/papapa"</span> </span></span><br><span class="line"><span class="tag">					 <span class="attr">ft</span>=<span class="string">"1624a6f0ab0"</span> <span class="attr">it</span>=<span class="string">"1624a6f0ab0"</span> <span class="attr">ut</span>=<span class="string">"1624a6f0ab0"</span> <span class="attr">version</span>=<span class="string">"5023"</span> </span></span><br><span class="line"><span class="tag">					 <span class="attr">nativeLibraryPath</span>=<span class="string">"/system/app/papapa/lib"</span> <span class="attr">primaryCpuAbi</span>=<span class="string">"arm64-v8a"</span></span></span><br><span class="line"><span class="tag">					 <span class="attr">sharedUserId</span>=<span class="string">"1000"</span> /&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">shared-user</span> <span class="attr">name</span>=<span class="string">"android.uid.bluetooth"</span> <span class="attr">userId</span>=<span class="string">"1002"</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">sigs</span> <span class="attr">count</span>=<span class="string">"1"</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">cert</span> <span class="attr">index</span>=<span class="string">"0"</span> /&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">sigs</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">perms</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">item</span> <span class="attr">name</span>=<span class="string">"android.permission.REAL_GET_TASKS"</span> <span class="attr">granted</span>=<span class="string">"true"</span> <span class="attr">flags</span>=<span class="string">"0"</span> /&gt;</span></span><br><span class="line">			<span class="comment">&lt;!-- ... ... --&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">perms</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">shared-user</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">keyset-settings</span> <span class="attr">version</span>=<span class="string">"1"</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">keys</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">public-key</span> <span class="attr">identifier</span>=<span class="string">"1"</span> <span class="attr">value</span>=<span class="string">"MIIBIjjYLv....uhfiUDQIDAQAB"</span> /&gt;</span></span><br><span class="line">            <span class="comment">&lt;!-- ... ... --&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">keys</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">keysets</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">keyset</span> <span class="attr">identifier</span>=<span class="string">"1"</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">key-id</span> <span class="attr">identifier</span>=<span class="string">"1"</span> /&gt;</span></span><br><span class="line">            <span class="tag">&lt;/<span class="name">keyset</span>&gt;</span></span><br><span class="line">            <span class="comment">&lt;!-- ... ... --&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">keysets</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">lastIssuedKeyId</span> <span class="attr">value</span>=<span class="string">"16"</span> /&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">lastIssuedKeySetId</span> <span class="attr">value</span>=<span class="string">"16"</span> /&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">keyset-settings</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">packages</span>&gt;</span></span><br></pre></td></tr></table></figure>
<p>上面是 pacakges.xml 的主要内容！</p>
<h3 id="8-1-1-解析-“package”-标签"><a href="#8-1-1-解析-“package”-标签" class="headerlink" title="8.1.1 解析 “package” 标签"></a>8.1.1 解析 “package” 标签</h3><p>和 “package” 相关内容如下：<br><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">package</span> <span class="attr">name</span>=<span class="string">"com.qualcomm.qti.haven.telemetry.service"</span> <span class="attr">codePath</span>=<span class="string">"/system/app/TelemetryService"</span> </span></span><br><span class="line"><span class="tag">        <span class="attr">nativeLibraryPath</span>=<span class="string">"/system/app/TelemetryService/lib"</span> </span></span><br><span class="line"><span class="tag">        <span class="attr">publicFlags</span>=<span class="string">"940097093"</span> <span class="attr">privateFlags</span>=<span class="string">"0"</span> <span class="attr">ft</span>=<span class="string">"11e8dc5d800"</span> <span class="attr">it</span>=<span class="string">"11e8dc5d800"</span> <span class="attr">ut</span>=<span class="string">"11e8dc5d800"</span> </span></span><br><span class="line"><span class="tag">        <span class="attr">version</span>=<span class="string">"25"</span> <span class="attr">userId</span>=<span class="string">"10091"</span> <span class="attr">isOrphaned</span>=<span class="string">"true"</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">sigs</span> <span class="attr">count</span>=<span class="string">"1"</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">cert</span> <span class="attr">index</span>=<span class="string">"0"</span> /&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">sigs</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">perms</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">item</span> <span class="attr">name</span>=<span class="string">"android.permission.REAL_GET_TASKS"</span> <span class="attr">granted</span>=<span class="string">"true"</span> <span class="attr">flags</span>=<span class="string">"0"</span> /&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">item</span> <span class="attr">name</span>=<span class="string">"android.permission.RECEIVE_BOOT_COMPLETED"</span> <span class="attr">granted</span>=<span class="string">"true"</span> <span class="attr">flags</span>=<span class="string">"0"</span> /&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">item</span> <span class="attr">name</span>=<span class="string">"android.permission.INTERNET"</span> <span class="attr">granted</span>=<span class="string">"true"</span> <span class="attr">flags</span>=<span class="string">"0"</span> /&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">item</span> <span class="attr">name</span>=<span class="string">"android.permission.ACCESS_NETWORK_STATE"</span> <span class="attr">granted</span>=<span class="string">"true"</span> <span class="attr">flags</span>=<span class="string">"0"</span> /&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">perms</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">proper-signing-keyset</span> <span class="attr">identifier</span>=<span class="string">"1"</span> /&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">package</span>&gt;</span></span><br></pre></td></tr></table></figure></p>
<p>接下来，看看具体的解析过程：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">if</span> (tagName.equals(<span class="string">"package"</span>)) &#123;</span><br><span class="line">    readPackageLPw(parser);     </span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h4 id="8-1-1-1-Settings-readPackageLPw"><a href="#8-1-1-1-Settings-readPackageLPw" class="headerlink" title="8.1.1.1 Settings.readPackageLPw"></a>8.1.1.1 Settings.readPackageLPw</h4><p>调用 readPackageLPw 方法！<br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br><span class="line">212</span><br><span class="line">213</span><br><span class="line">214</span><br><span class="line">215</span><br><span class="line">216</span><br><span class="line">217</span><br><span class="line">218</span><br><span class="line">219</span><br><span class="line">220</span><br><span class="line">221</span><br><span class="line">222</span><br><span class="line">223</span><br><span class="line">224</span><br><span class="line">225</span><br><span class="line">226</span><br><span class="line">227</span><br><span class="line">228</span><br><span class="line">229</span><br><span class="line">230</span><br><span class="line">231</span><br><span class="line">232</span><br><span class="line">233</span><br><span class="line">234</span><br><span class="line">235</span><br><span class="line">236</span><br><span class="line">237</span><br><span class="line">238</span><br><span class="line">239</span><br><span class="line">240</span><br><span class="line">241</span><br><span class="line">242</span><br><span class="line">243</span><br><span class="line">244</span><br><span class="line">245</span><br><span class="line">246</span><br><span class="line">247</span><br><span class="line">248</span><br><span class="line">249</span><br><span class="line">250</span><br><span class="line">251</span><br><span class="line">252</span><br><span class="line">253</span><br><span class="line">254</span><br><span class="line">255</span><br><span class="line">256</span><br><span class="line">257</span><br><span class="line">258</span><br><span class="line">259</span><br><span class="line">260</span><br><span class="line">261</span><br><span class="line">262</span><br><span class="line">263</span><br><span class="line">264</span><br><span class="line">265</span><br><span class="line">266</span><br><span class="line">267</span><br><span class="line">268</span><br><span class="line">269</span><br><span class="line">270</span><br><span class="line">271</span><br><span class="line">272</span><br><span class="line">273</span><br><span class="line">274</span><br><span class="line">275</span><br><span class="line">276</span><br><span class="line">277</span><br><span class="line">278</span><br><span class="line">279</span><br><span class="line">280</span><br><span class="line">281</span><br><span class="line">282</span><br><span class="line">283</span><br><span class="line">284</span><br><span class="line">285</span><br><span class="line">286</span><br><span class="line">287</span><br><span class="line">288</span><br><span class="line">289</span><br><span class="line">290</span><br><span class="line">291</span><br><span class="line">292</span><br><span class="line">293</span><br><span class="line">294</span><br><span class="line">295</span><br><span class="line">296</span><br><span class="line">297</span><br><span class="line">298</span><br><span class="line">299</span><br><span class="line">300</span><br><span class="line">301</span><br><span class="line">302</span><br><span class="line">303</span><br><span class="line">304</span><br><span class="line">305</span><br><span class="line">306</span><br><span class="line">307</span><br><span class="line">308</span><br><span class="line">309</span><br><span class="line">310</span><br><span class="line">311</span><br><span class="line">312</span><br><span class="line">313</span><br><span class="line">314</span><br><span class="line">315</span><br><span class="line">316</span><br><span class="line">317</span><br><span class="line">318</span><br><span class="line">319</span><br><span class="line">320</span><br><span class="line">321</span><br><span class="line">322</span><br><span class="line">323</span><br><span class="line">324</span><br><span class="line">325</span><br><span class="line">326</span><br><span class="line">327</span><br><span class="line">328</span><br><span class="line">329</span><br><span class="line">330</span><br><span class="line">331</span><br><span class="line">332</span><br><span class="line">333</span><br><span class="line">334</span><br><span class="line">335</span><br><span class="line">336</span><br><span class="line">337</span><br><span class="line">338</span><br><span class="line">339</span><br><span class="line">340</span><br><span class="line">341</span><br><span class="line">342</span><br><span class="line">343</span><br><span class="line">344</span><br><span class="line">345</span><br><span class="line">346</span><br><span class="line">347</span><br><span class="line">348</span><br><span class="line">349</span><br><span class="line">350</span><br><span class="line">351</span><br><span class="line">352</span><br><span class="line">353</span><br><span class="line">354</span><br><span class="line">355</span><br><span class="line">356</span><br><span class="line">357</span><br><span class="line">358</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">readPackageLPw</span><span class="params">(XmlPullParser parser)</span> <span class="keyword">throws</span> XmlPullParserException, IOException </span>&#123;</span><br><span class="line">    <span class="comment">// 需要解析的属性</span></span><br><span class="line">    String name = <span class="keyword">null</span>;</span><br><span class="line">    String realName = <span class="keyword">null</span>;</span><br><span class="line">    String idStr = <span class="keyword">null</span>;</span><br><span class="line">    String sharedIdStr = <span class="keyword">null</span>;</span><br><span class="line">    String codePathStr = <span class="keyword">null</span>;</span><br><span class="line">    String resourcePathStr = <span class="keyword">null</span>;</span><br><span class="line">    String legacyCpuAbiString = <span class="keyword">null</span>;</span><br><span class="line">    String legacyNativeLibraryPathStr = <span class="keyword">null</span>;</span><br><span class="line">    String primaryCpuAbiString = <span class="keyword">null</span>;</span><br><span class="line">    String secondaryCpuAbiString = <span class="keyword">null</span>;</span><br><span class="line">    String cpuAbiOverrideString = <span class="keyword">null</span>;</span><br><span class="line">    String systemStr = <span class="keyword">null</span>;</span><br><span class="line">    String installerPackageName = <span class="keyword">null</span>;</span><br><span class="line">    String isOrphaned = <span class="keyword">null</span>;</span><br><span class="line">    String volumeUuid = <span class="keyword">null</span>;</span><br><span class="line">    String uidError = <span class="keyword">null</span>;</span><br><span class="line">    <span class="keyword">int</span> pkgFlags = <span class="number">0</span>;</span><br><span class="line">    <span class="keyword">int</span> pkgPrivateFlags = <span class="number">0</span>;</span><br><span class="line">    <span class="keyword">long</span> timeStamp = <span class="number">0</span>;</span><br><span class="line">    <span class="keyword">long</span> firstInstallTime = <span class="number">0</span>;</span><br><span class="line">    <span class="keyword">long</span> lastUpdateTime = <span class="number">0</span>;</span><br><span class="line">    PackageSettingBase packageSetting = <span class="keyword">null</span>;</span><br><span class="line">    String version = <span class="keyword">null</span>;</span><br><span class="line">    <span class="keyword">int</span> versionCode = <span class="number">0</span>;</span><br><span class="line">    String parentPackageName;</span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">        </span><br><span class="line">        <span class="comment">//【1】获得应用的 name！</span></span><br><span class="line">        name = parser.getAttributeValue(<span class="keyword">null</span>, ATTR_NAME);</span><br><span class="line">        realName = parser.getAttributeValue(<span class="keyword">null</span>, <span class="string">"realName"</span>);</span><br><span class="line">        </span><br><span class="line">        <span class="comment">//【2】获得 userId 和 sharedId 的名称, userId 和 sharedIdStr 不能同时存在！</span></span><br><span class="line">        idStr = parser.getAttributeValue(<span class="keyword">null</span>, <span class="string">"userId"</span>);</span><br><span class="line">        uidError = parser.getAttributeValue(<span class="keyword">null</span>, <span class="string">"uidError"</span>);</span><br><span class="line">        sharedIdStr = parser.getAttributeValue(<span class="keyword">null</span>, <span class="string">"sharedUserId"</span>);</span><br><span class="line">        </span><br><span class="line">        <span class="comment">//【3】获得应用程序包的路径，例如：/system/priv-app/CalendarProvider！</span></span><br><span class="line">        codePathStr = parser.getAttributeValue(<span class="keyword">null</span>, <span class="string">"codePath"</span>);</span><br><span class="line">        resourcePathStr = parser.getAttributeValue(<span class="keyword">null</span>, <span class="string">"resourcePath"</span>);</span><br><span class="line"></span><br><span class="line">        legacyCpuAbiString = parser.getAttributeValue(<span class="keyword">null</span>, <span class="string">"requiredCpuAbi"</span>);</span><br><span class="line"></span><br><span class="line">        parentPackageName = parser.getAttributeValue(<span class="keyword">null</span>, <span class="string">"parentPackageName"</span>);</span><br><span class="line"></span><br><span class="line">        legacyNativeLibraryPathStr = parser.getAttributeValue(<span class="keyword">null</span>, <span class="string">"nativeLibraryPath"</span>);</span><br><span class="line">        primaryCpuAbiString = parser.getAttributeValue(<span class="keyword">null</span>, <span class="string">"primaryCpuAbi"</span>);</span><br><span class="line">        secondaryCpuAbiString = parser.getAttributeValue(<span class="keyword">null</span>, <span class="string">"secondaryCpuAbi"</span>);</span><br><span class="line">        cpuAbiOverrideString = parser.getAttributeValue(<span class="keyword">null</span>, <span class="string">"cpuAbiOverride"</span>);</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (primaryCpuAbiString == <span class="keyword">null</span> &amp;&amp; legacyCpuAbiString != <span class="keyword">null</span>) &#123;</span><br><span class="line">            primaryCpuAbiString = legacyCpuAbiString;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment">//【4】获得版本号！</span></span><br><span class="line">        version = parser.getAttributeValue(<span class="keyword">null</span>, <span class="string">"version"</span>);</span><br><span class="line">        <span class="keyword">if</span> (version != <span class="keyword">null</span>) &#123;</span><br><span class="line">            <span class="keyword">try</span> &#123;</span><br><span class="line">                versionCode = Integer.parseInt(version);</span><br><span class="line">            &#125; <span class="keyword">catch</span> (NumberFormatException e) &#123;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 获得安装器的名称！</span></span><br><span class="line">        installerPackageName = parser.getAttributeValue(<span class="keyword">null</span>, <span class="string">"installer"</span>);</span><br><span class="line">        isOrphaned = parser.getAttributeValue(<span class="keyword">null</span>, <span class="string">"isOrphaned"</span>);</span><br><span class="line">        volumeUuid = parser.getAttributeValue(<span class="keyword">null</span>, <span class="string">"volumeUuid"</span>);</span><br><span class="line">        </span><br><span class="line">        <span class="comment">//【5】获得flags相关信息，读取顺序为：publicFlags 和 privateFlags、flags、system;</span></span><br><span class="line">        systemStr = parser.getAttributeValue(<span class="keyword">null</span>, <span class="string">"publicFlags"</span>);</span><br><span class="line">        <span class="keyword">if</span> (systemStr != <span class="keyword">null</span>) &#123;</span><br><span class="line">            <span class="keyword">try</span> &#123;</span><br><span class="line">                pkgFlags = Integer.parseInt(systemStr);</span><br><span class="line">            &#125; <span class="keyword">catch</span> (NumberFormatException e) &#123;</span><br><span class="line">            &#125;</span><br><span class="line">            systemStr = parser.getAttributeValue(<span class="keyword">null</span>, <span class="string">"privateFlags"</span>);</span><br><span class="line">            <span class="keyword">if</span> (systemStr != <span class="keyword">null</span>) &#123;</span><br><span class="line">                <span class="keyword">try</span> &#123;</span><br><span class="line">                    pkgPrivateFlags = Integer.parseInt(systemStr);</span><br><span class="line">                &#125; <span class="keyword">catch</span> (NumberFormatException e) &#123;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            <span class="comment">// 在 Android M 之前，是没有 publicFlags 和 privateFlags 之分的，所有的标志位都存放在 flags 中！</span></span><br><span class="line">            systemStr = parser.getAttributeValue(<span class="keyword">null</span>, <span class="string">"flags"</span>);</span><br><span class="line">            <span class="keyword">if</span> (systemStr != <span class="keyword">null</span>) &#123;</span><br><span class="line">                <span class="keyword">try</span> &#123;</span><br><span class="line">                    pkgFlags = Integer.parseInt(systemStr);</span><br><span class="line">                &#125; <span class="keyword">catch</span> (NumberFormatException e) &#123;</span><br><span class="line">                &#125;</span><br><span class="line">                <span class="keyword">if</span> ((pkgFlags &amp; PRE_M_APP_INFO_FLAG_HIDDEN) != <span class="number">0</span>) &#123;</span><br><span class="line">                    pkgPrivateFlags |= ApplicationInfo.PRIVATE_FLAG_HIDDEN;</span><br><span class="line">                &#125;</span><br><span class="line">                <span class="keyword">if</span> ((pkgFlags &amp; PRE_M_APP_INFO_FLAG_CANT_SAVE_STATE) != <span class="number">0</span>) &#123;</span><br><span class="line">                    pkgPrivateFlags |= ApplicationInfo.PRIVATE_FLAG_CANT_SAVE_STATE;</span><br><span class="line">                &#125;</span><br><span class="line">                <span class="keyword">if</span> ((pkgFlags &amp; PRE_M_APP_INFO_FLAG_FORWARD_LOCK) != <span class="number">0</span>) &#123;</span><br><span class="line">                    pkgPrivateFlags |= ApplicationInfo.PRIVATE_FLAG_FORWARD_LOCK;</span><br><span class="line">                &#125;</span><br><span class="line">                <span class="keyword">if</span> ((pkgFlags &amp; PRE_M_APP_INFO_FLAG_PRIVILEGED) != <span class="number">0</span>) &#123;</span><br><span class="line">                    pkgPrivateFlags |= ApplicationInfo.PRIVATE_FLAG_PRIVILEGED;</span><br><span class="line">                &#125;</span><br><span class="line">                pkgFlags &amp;= ~(PRE_M_APP_INFO_FLAG_HIDDEN</span><br><span class="line">                        | PRE_M_APP_INFO_FLAG_CANT_SAVE_STATE</span><br><span class="line">                        | PRE_M_APP_INFO_FLAG_FORWARD_LOCK</span><br><span class="line">                        | PRE_M_APP_INFO_FLAG_PRIVILEGED);</span><br><span class="line">            &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                <span class="comment">// For backward compatibility</span></span><br><span class="line">                systemStr = parser.getAttributeValue(<span class="keyword">null</span>, <span class="string">"system"</span>);</span><br><span class="line">                <span class="keyword">if</span> (systemStr != <span class="keyword">null</span>) &#123;</span><br><span class="line">                    pkgFlags |= (<span class="string">"true"</span>.equalsIgnoreCase(systemStr)) ? ApplicationInfo.FLAG_SYSTEM</span><br><span class="line">                            : <span class="number">0</span>;</span><br><span class="line">                &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                    <span class="comment">// Old settings that don't specify system... just treat</span></span><br><span class="line">                    <span class="comment">// them as system, good enough.</span></span><br><span class="line">                    pkgFlags |= ApplicationInfo.FLAG_SYSTEM;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        </span><br><span class="line">        <span class="comment">// 获得时间戳！</span></span><br><span class="line">        String timeStampStr = parser.getAttributeValue(<span class="keyword">null</span>, <span class="string">"ft"</span>);</span><br><span class="line">        <span class="keyword">if</span> (timeStampStr != <span class="keyword">null</span>) &#123;</span><br><span class="line">            <span class="keyword">try</span> &#123;</span><br><span class="line">                timeStamp = Long.parseLong(timeStampStr, <span class="number">16</span>);</span><br><span class="line">            &#125; <span class="keyword">catch</span> (NumberFormatException e) &#123;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            timeStampStr = parser.getAttributeValue(<span class="keyword">null</span>, <span class="string">"ts"</span>);</span><br><span class="line">            <span class="keyword">if</span> (timeStampStr != <span class="keyword">null</span>) &#123;</span><br><span class="line">                <span class="keyword">try</span> &#123;</span><br><span class="line">                    timeStamp = Long.parseLong(timeStampStr);</span><br><span class="line">                &#125; <span class="keyword">catch</span> (NumberFormatException e) &#123;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        </span><br><span class="line">        <span class="comment">//【6】获得第一次安装时间</span></span><br><span class="line">        timeStampStr = parser.getAttributeValue(<span class="keyword">null</span>, <span class="string">"it"</span>);</span><br><span class="line">        <span class="keyword">if</span> (timeStampStr != <span class="keyword">null</span>) &#123;</span><br><span class="line">            <span class="keyword">try</span> &#123;</span><br><span class="line">                firstInstallTime = Long.parseLong(timeStampStr, <span class="number">16</span>);</span><br><span class="line">            &#125; <span class="keyword">catch</span> (NumberFormatException e) &#123;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        </span><br><span class="line">        <span class="comment">//【7】获得最近更新时间！</span></span><br><span class="line">        timeStampStr = parser.getAttributeValue(<span class="keyword">null</span>, <span class="string">"ut"</span>);</span><br><span class="line">        <span class="keyword">if</span> (timeStampStr != <span class="keyword">null</span>) &#123;</span><br><span class="line">            <span class="keyword">try</span> &#123;</span><br><span class="line">                lastUpdateTime = Long.parseLong(timeStampStr, <span class="number">16</span>);</span><br><span class="line">            &#125; <span class="keyword">catch</span> (NumberFormatException e) &#123;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">if</span> (PackageManagerService.DEBUG_SETTINGS)</span><br><span class="line">            Log.v(PackageManagerService.TAG, <span class="string">"Reading package: "</span> + name + <span class="string">" userId="</span> + idStr</span><br><span class="line">                    + <span class="string">" sharedUserId="</span> + sharedIdStr);</span><br><span class="line">                    </span><br><span class="line">        <span class="comment">//【8】获得 userId 的 int 值，如果 AndroidManifest.xml 有设置 android:sharedUserId 属性，</span></span><br><span class="line">        <span class="comment">// 那么应用的 userId 就为 0！！</span></span><br><span class="line">        <span class="keyword">int</span> userId = idStr != <span class="keyword">null</span> ? Integer.parseInt(idStr) : <span class="number">0</span>;</span><br><span class="line">        <span class="keyword">if</span> (resourcePathStr == <span class="keyword">null</span>) &#123;</span><br><span class="line">            resourcePathStr = codePathStr;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">if</span> (realName != <span class="keyword">null</span>) &#123;</span><br><span class="line">            realName = realName.intern();</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">if</span> (name == <span class="keyword">null</span>) &#123;</span><br><span class="line">            PackageManagerService.reportSettingsProblem(Log.WARN,</span><br><span class="line">                    <span class="string">"Error in package manager settings: &lt;package&gt; has no name at "</span></span><br><span class="line">                            + parser.getPositionDescription());</span><br><span class="line">        &#125; <span class="keyword">else</span> <span class="keyword">if</span> (codePathStr == <span class="keyword">null</span>) &#123;</span><br><span class="line">            PackageManagerService.reportSettingsProblem(Log.WARN,</span><br><span class="line">                    <span class="string">"Error in package manager settings: &lt;package&gt; has no codePath at "</span></span><br><span class="line">                            + parser.getPositionDescription());</span><br><span class="line">        &#125; <span class="keyword">else</span> <span class="keyword">if</span> (userId &gt; <span class="number">0</span>) &#123;</span><br><span class="line">            <span class="comment">//【8.1】如果 userId 大于0，说明 package 是独立用户 id</span></span><br><span class="line">            <span class="comment">// 调用 addPackageLPw 方法保存这个有独立的 Linux 用户 ID 的 Package!</span></span><br><span class="line">            packageSetting = addPackageLPw(name.intern(), realName, <span class="keyword">new</span> File(codePathStr),</span><br><span class="line">                    <span class="keyword">new</span> File(resourcePathStr), legacyNativeLibraryPathStr, primaryCpuAbiString,</span><br><span class="line">                    secondaryCpuAbiString, cpuAbiOverrideString, userId, versionCode, pkgFlags,</span><br><span class="line">                    pkgPrivateFlags, parentPackageName, <span class="keyword">null</span>);</span><br><span class="line"></span><br><span class="line">            <span class="keyword">if</span> (PackageManagerService.DEBUG_SETTINGS)</span><br><span class="line">                Log.i(PackageManagerService.TAG, <span class="string">"Reading package "</span> + name + <span class="string">": userId="</span></span><br><span class="line">                        + userId + <span class="string">" pkg="</span> + packageSetting);</span><br><span class="line">            <span class="keyword">if</span> (packageSetting == <span class="keyword">null</span>) &#123;</span><br><span class="line">                PackageManagerService.reportSettingsProblem(Log.ERROR, <span class="string">"Failure adding uid "</span></span><br><span class="line">                        + userId + <span class="string">" while parsing settings at "</span></span><br><span class="line">                        + parser.getPositionDescription());</span><br><span class="line">            &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                <span class="comment">// 设置时间戳，第一次安装时间，最近更新时间</span></span><br><span class="line">                packageSetting.setTimeStamp(timeStamp);</span><br><span class="line">                packageSetting.firstInstallTime = firstInstallTime;</span><br><span class="line">                packageSetting.lastUpdateTime = lastUpdateTime;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125; <span class="keyword">else</span> <span class="keyword">if</span> (sharedIdStr != <span class="keyword">null</span>) &#123;</span><br><span class="line">        </span><br><span class="line">            <span class="comment">//【8.2】sharedIdStr 不为 null，说明 package 设置了共享用户 id！</span></span><br><span class="line">            userId = sharedIdStr != <span class="keyword">null</span> ? Integer.parseInt(sharedIdStr) : <span class="number">0</span>;</span><br><span class="line">            <span class="keyword">if</span> (userId &gt; <span class="number">0</span>) &#123;</span><br><span class="line">                <span class="comment">// 对于共享用户 ID 这种情况，还需要验证其有效性!</span></span><br><span class="line">                <span class="comment">// 创建一个 PendingPackage 对象，来封装这个有共享用户 ID 的 package 的信息!</span></span><br><span class="line">                packageSetting = <span class="keyword">new</span> PendingPackage(name.intern(), realName, <span class="keyword">new</span> File(</span><br><span class="line">                        codePathStr), <span class="keyword">new</span> File(resourcePathStr), legacyNativeLibraryPathStr,</span><br><span class="line">                        primaryCpuAbiString, secondaryCpuAbiString, cpuAbiOverrideString,</span><br><span class="line">                        userId, versionCode, pkgFlags, pkgPrivateFlags, parentPackageName,</span><br><span class="line">                        <span class="keyword">null</span>);</span><br><span class="line">                   </span><br><span class="line">                <span class="comment">// 设置时间戳，第一次安装时间，最近更新时间！     </span></span><br><span class="line">                packageSetting.setTimeStamp(timeStamp);</span><br><span class="line">                packageSetting.firstInstallTime = firstInstallTime;</span><br><span class="line">                packageSetting.lastUpdateTime = lastUpdateTime;</span><br><span class="line">                </span><br><span class="line">                <span class="comment">//【8.2.1】添加到 mPendingPackages 中，因为后续需要确定 shareUserId 的有效性！</span></span><br><span class="line">                mPendingPackages.add((PendingPackage) packageSetting);</span><br><span class="line">                </span><br><span class="line">                <span class="keyword">if</span> (PackageManagerService.DEBUG_SETTINGS)</span><br><span class="line">                    Log.i(PackageManagerService.TAG, <span class="string">"Reading package "</span> + name</span><br><span class="line">                            + <span class="string">": sharedUserId="</span> + userId + <span class="string">" pkg="</span> + packageSetting);</span><br><span class="line">            &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                PackageManagerService.reportSettingsProblem(Log.WARN,</span><br><span class="line">                        <span class="string">"Error in package manager settings: package "</span> + name</span><br><span class="line">                                + <span class="string">" has bad sharedId "</span> + sharedIdStr + <span class="string">" at "</span></span><br><span class="line">                                + parser.getPositionDescription());</span><br><span class="line">            &#125;</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            PackageManagerService.reportSettingsProblem(Log.WARN,</span><br><span class="line">                    <span class="string">"Error in package manager settings: package "</span> + name + <span class="string">" has bad userId "</span></span><br><span class="line">                            + idStr + <span class="string">" at "</span> + parser.getPositionDescription());</span><br><span class="line">        &#125;</span><br><span class="line">    &#125; <span class="keyword">catch</span> (NumberFormatException e) &#123;</span><br><span class="line">        PackageManagerService.reportSettingsProblem(Log.WARN,</span><br><span class="line">                <span class="string">"Error in package manager settings: package "</span> + name + <span class="string">" has bad userId "</span></span><br><span class="line">                        + idStr + <span class="string">" at "</span> + parser.getPositionDescription());</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">//【9】接下来设置其他的属性值。</span></span><br><span class="line">    <span class="keyword">if</span> (packageSetting != <span class="keyword">null</span>) &#123;</span><br><span class="line">        packageSetting.uidError = <span class="string">"true"</span>.equals(uidError);</span><br><span class="line">        packageSetting.installerPackageName = installerPackageName;</span><br><span class="line">        packageSetting.isOrphaned = <span class="string">"true"</span>.equals(isOrphaned);</span><br><span class="line">        packageSetting.volumeUuid = volumeUuid;</span><br><span class="line">        packageSetting.legacyNativeLibraryPathString = legacyNativeLibraryPathStr;</span><br><span class="line">        packageSetting.primaryCpuAbiString = primaryCpuAbiString;</span><br><span class="line">        packageSetting.secondaryCpuAbiString = secondaryCpuAbiString;</span><br><span class="line">        <span class="comment">// Handle legacy string here for single-user mode</span></span><br><span class="line">        <span class="keyword">final</span> String enabledStr = parser.getAttributeValue(<span class="keyword">null</span>, ATTR_ENABLED);</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (enabledStr != <span class="keyword">null</span>) &#123;</span><br><span class="line">            <span class="keyword">try</span> &#123;</span><br><span class="line">                packageSetting.setEnabled(Integer.parseInt(enabledStr), <span class="number">0</span> <span class="comment">/* userId */</span>, <span class="keyword">null</span>);</span><br><span class="line">            &#125; <span class="keyword">catch</span> (NumberFormatException e) &#123;</span><br><span class="line">                <span class="keyword">if</span> (enabledStr.equalsIgnoreCase(<span class="string">"true"</span>)) &#123;</span><br><span class="line">                    packageSetting.setEnabled(COMPONENT_ENABLED_STATE_ENABLED, <span class="number">0</span>, <span class="keyword">null</span>);</span><br><span class="line">                &#125; <span class="keyword">else</span> <span class="keyword">if</span> (enabledStr.equalsIgnoreCase(<span class="string">"false"</span>)) &#123;</span><br><span class="line">                    packageSetting.setEnabled(COMPONENT_ENABLED_STATE_DISABLED, <span class="number">0</span>, <span class="keyword">null</span>);</span><br><span class="line">                &#125; <span class="keyword">else</span> <span class="keyword">if</span> (enabledStr.equalsIgnoreCase(<span class="string">"default"</span>)) &#123;</span><br><span class="line">                    packageSetting.setEnabled(COMPONENT_ENABLED_STATE_DEFAULT, <span class="number">0</span>, <span class="keyword">null</span>);</span><br><span class="line">                &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                    PackageManagerService.reportSettingsProblem(Log.WARN,</span><br><span class="line">                            <span class="string">"Error in package manager settings: package "</span> + name</span><br><span class="line">                                    + <span class="string">" has bad enabled value: "</span> + idStr + <span class="string">" at "</span></span><br><span class="line">                                    + parser.getPositionDescription());</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            packageSetting.setEnabled(COMPONENT_ENABLED_STATE_DEFAULT, <span class="number">0</span>, <span class="keyword">null</span>);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (installerPackageName != <span class="keyword">null</span>) &#123;</span><br><span class="line">            mInstallerPackages.add(installerPackageName);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">// package 安装状态！</span></span><br><span class="line">        <span class="keyword">final</span> String installStatusStr = parser.getAttributeValue(<span class="keyword">null</span>, <span class="string">"installStatus"</span>);</span><br><span class="line">        <span class="keyword">if</span> (installStatusStr != <span class="keyword">null</span>) &#123;</span><br><span class="line">            <span class="keyword">if</span> (installStatusStr.equalsIgnoreCase(<span class="string">"false"</span>)) &#123;</span><br><span class="line">                packageSetting.installStatus = PackageSettingBase.PKG_INSTALL_INCOMPLETE;</span><br><span class="line">            &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                packageSetting.installStatus = PackageSettingBase.PKG_INSTALL_COMPLETE;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">int</span> outerDepth = parser.getDepth();</span><br><span class="line">        <span class="keyword">int</span> type;</span><br><span class="line">        <span class="keyword">while</span> ((type = parser.next()) != XmlPullParser.END_DOCUMENT</span><br><span class="line">                &amp;&amp; (type != XmlPullParser.END_TAG || parser.getDepth() &gt; outerDepth)) &#123;</span><br><span class="line">            <span class="keyword">if</span> (type == XmlPullParser.END_TAG || type == XmlPullParser.TEXT) &#123;</span><br><span class="line">                <span class="keyword">continue</span>;</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            String tagName = parser.getName();</span><br><span class="line">            <span class="comment">// Legacy</span></span><br><span class="line">            <span class="keyword">if</span> (tagName.equals(TAG_DISABLED_COMPONENTS)) &#123;</span><br><span class="line">                <span class="comment">//【8.1.1.3】解析 "disabled-components"</span></span><br><span class="line">                readDisabledComponentsLPw(packageSetting, parser, <span class="number">0</span>);</span><br><span class="line">                </span><br><span class="line">            &#125; <span class="keyword">else</span> <span class="keyword">if</span> (tagName.equals(TAG_ENABLED_COMPONENTS)) &#123;</span><br><span class="line">                <span class="comment">//【8.1.1.3】解析 "enabled-components"</span></span><br><span class="line">                readEnabledComponentsLPw(packageSetting, parser, <span class="number">0</span>);</span><br><span class="line">                </span><br><span class="line">            &#125; <span class="keyword">else</span> <span class="keyword">if</span> (tagName.equals(<span class="string">"sigs"</span>)) &#123; <span class="comment">// 解析 "sigs"</span></span><br><span class="line">                packageSetting.signatures.readXml(parser, mPastSignatures);</span><br><span class="line">                </span><br><span class="line">            &#125; <span class="keyword">else</span> <span class="keyword">if</span> (tagName.equals(TAG_PERMISSIONS)) &#123; <span class="comment">// 解析 perms</span></span><br><span class="line">                <span class="comment">//【8.1.1.4】解析 "perms" 获得这个 package 的权限管理对象！</span></span><br><span class="line">                readInstallPermissionsLPr(parser, packageSetting.getPermissionsState());</span><br><span class="line">                packageSetting.installPermissionsFixed = <span class="keyword">true</span>;</span><br><span class="line">                </span><br><span class="line">            &#125; <span class="keyword">else</span> <span class="keyword">if</span> (tagName.equals(<span class="string">"proper-signing-keyset"</span>)) &#123;</span><br><span class="line">                <span class="keyword">long</span> id = Long.parseLong(parser.getAttributeValue(<span class="keyword">null</span>, <span class="string">"identifier"</span>));</span><br><span class="line">                Integer refCt = mKeySetRefs.get(id);</span><br><span class="line">                <span class="keyword">if</span> (refCt != <span class="keyword">null</span>) &#123;</span><br><span class="line">                    mKeySetRefs.put(id, refCt + <span class="number">1</span>);</span><br><span class="line">                &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                    mKeySetRefs.put(id, <span class="number">1</span>);</span><br><span class="line">                &#125;</span><br><span class="line">                packageSetting.keySetData.setProperSigningKeySet(id);</span><br><span class="line">                </span><br><span class="line">            &#125; <span class="keyword">else</span> <span class="keyword">if</span> (tagName.equals(<span class="string">"signing-keyset"</span>)) &#123;</span><br><span class="line">                <span class="comment">// from v1 of keysetmanagerservice - no longer used</span></span><br><span class="line">            &#125; <span class="keyword">else</span> <span class="keyword">if</span> (tagName.equals(<span class="string">"upgrade-keyset"</span>)) &#123;</span><br><span class="line">                <span class="keyword">long</span> id = Long.parseLong(parser.getAttributeValue(<span class="keyword">null</span>, <span class="string">"identifier"</span>));</span><br><span class="line">                packageSetting.keySetData.addUpgradeKeySetById(id);</span><br><span class="line">                </span><br><span class="line">            &#125; <span class="keyword">else</span> <span class="keyword">if</span> (tagName.equals(<span class="string">"defined-keyset"</span>)) &#123;</span><br><span class="line">                <span class="keyword">long</span> id = Long.parseLong(parser.getAttributeValue(<span class="keyword">null</span>, <span class="string">"identifier"</span>));</span><br><span class="line">                String alias = parser.getAttributeValue(<span class="keyword">null</span>, <span class="string">"alias"</span>);</span><br><span class="line">                Integer refCt = mKeySetRefs.get(id);</span><br><span class="line">                <span class="keyword">if</span> (refCt != <span class="keyword">null</span>) &#123;</span><br><span class="line">                    mKeySetRefs.put(id, refCt + <span class="number">1</span>);</span><br><span class="line">                &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                    mKeySetRefs.put(id, <span class="number">1</span>);</span><br><span class="line">                &#125;</span><br><span class="line">                packageSetting.keySetData.addDefinedKeySet(id, alias);</span><br><span class="line">                </span><br><span class="line">            &#125; <span class="keyword">else</span> <span class="keyword">if</span> (tagName.equals(TAG_DOMAIN_VERIFICATION)) &#123; <span class="comment">// 解析 "domain-verification"</span></span><br><span class="line">                readDomainVerificationLPw(parser, packageSetting);</span><br><span class="line">                </span><br><span class="line">            &#125; <span class="keyword">else</span> <span class="keyword">if</span> (tagName.equals(TAG_CHILD_PACKAGE)) &#123; <span class="comment">// 解析 "child-package"</span></span><br><span class="line">                String childPackageName = parser.getAttributeValue(<span class="keyword">null</span>, ATTR_NAME);</span><br><span class="line">                <span class="keyword">if</span> (packageSetting.childPackageNames == <span class="keyword">null</span>) &#123;</span><br><span class="line">                    packageSetting.childPackageNames = <span class="keyword">new</span> ArrayList&lt;&gt;();</span><br><span class="line">                &#125;</span><br><span class="line">                packageSetting.childPackageNames.add(childPackageName);</span><br><span class="line">                </span><br><span class="line">            &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                PackageManagerService.reportSettingsProblem(Log.WARN,</span><br><span class="line">                        <span class="string">"Unknown element under &lt;package&gt;: "</span> + parser.getName());</span><br><span class="line">                XmlUtils.skipCurrentTag(parser);</span><br><span class="line">                </span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        XmlUtils.skipCurrentTag(parser);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>流程总结：</p>
<ul>
<li>对于分配了独立的 uid 的 package，创建 PackageSetting 对象，添加到 mPackage 中，并且将自身和 uid 的引用关心保存到 mUsersId 或者 mOthersId 中；</li>
<li>对于分配了共享的 uid 的 package，创建 PendingPackage 对象，添加到 mPendingPackages 中，后续会对其共享 uid 的有效性进行校验！</li>
</ul>
<h4 id="8-1-1-2-Settings-addPackageLPw"><a href="#8-1-1-2-Settings-addPackageLPw" class="headerlink" title="8.1.1.2 Settings.addPackageLPw"></a>8.1.1.2 Settings.addPackageLPw</h4><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br></pre></td><td class="code"><pre><span class="line"><span class="function">PackageSetting <span class="title">addPackageLPw</span><span class="params">(String name, String realName, File codePath, File resourcePath,</span></span></span><br><span class="line"><span class="function"><span class="params">        String legacyNativeLibraryPathString, String primaryCpuAbiString,</span></span></span><br><span class="line"><span class="function"><span class="params">        String secondaryCpuAbiString, String cpuAbiOverrideString, <span class="keyword">int</span> uid, <span class="keyword">int</span> vc, <span class="keyword">int</span></span></span></span><br><span class="line"><span class="function"><span class="params">        pkgFlags, <span class="keyword">int</span> pkgPrivateFlags, String parentPackageName,</span></span></span><br><span class="line"><span class="function"><span class="params">        List&lt;String&gt; childPackageNames)</span> </span>&#123;</span><br><span class="line">    <span class="comment">//【1】根据 name 值从 mPackage 集合中查询 name 对应的 PackageSettings 对象。</span></span><br><span class="line">    PackageSetting p = mPackages.get(name);</span><br><span class="line">    <span class="keyword">if</span> (p != <span class="keyword">null</span>) &#123;</span><br><span class="line">        <span class="comment">// 如果能得到，且两个 uid 相等，说明已经创建过了，那就直接返回！</span></span><br><span class="line">        <span class="keyword">if</span> (p.appId == uid) &#123;</span><br><span class="line">            <span class="keyword">return</span> p;</span><br><span class="line">        &#125;</span><br><span class="line">        PackageManagerService.reportSettingsProblem(Log.ERROR,</span><br><span class="line">                <span class="string">"Adding duplicate package, keeping first: "</span> + name);</span><br><span class="line">        <span class="comment">// 如果发现 uid 变化了，那就不会读取上一次的安装信息！</span></span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">null</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">//【2】否则，就创建一个 PackageSettings 对象来封装这个应用程序的信息。</span></span><br><span class="line">    p = <span class="keyword">new</span> PackageSetting(name, realName, codePath, resourcePath,</span><br><span class="line">            legacyNativeLibraryPathString, primaryCpuAbiString, secondaryCpuAbiString,</span><br><span class="line">            cpuAbiOverrideString, vc, pkgFlags, pkgPrivateFlags, parentPackageName,</span><br><span class="line">            childPackageNames);</span><br><span class="line">    </span><br><span class="line">    <span class="comment">//【3】他的 appid        </span></span><br><span class="line">    p.appId = uid;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">//【8.1.1.2.1】在系统中保留值为 uid 的 Linux 用户 ID，添加到 mUserIds 或者 mOtherUserIds 中！</span></span><br><span class="line">    <span class="keyword">if</span> (addUserIdLPw(uid, p, name)) &#123;</span><br><span class="line">    </span><br><span class="line">        <span class="comment">//【4.1】将这个 PackageSettings 对象保存在 Settings.mPackages 中！！</span></span><br><span class="line">        mPackages.put(name, p);</span><br><span class="line">        <span class="keyword">return</span> p;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">null</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>这里会调用 addUserIdLPw 方法，将 package 的 uid 进行封装，根据其范围，将其添加到 mUserIds 或者 mOtherUserIds 中！</p>
<h5 id="8-1-1-2-1-Settings-addUserIdLPw"><a href="#8-1-1-2-1-Settings-addUserIdLPw" class="headerlink" title="8.1.1.2.1 Settings.addUserIdLPw"></a>8.1.1.2.1 Settings.addUserIdLPw</h5><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">boolean</span> <span class="title">addUserIdLPw</span><span class="params">(<span class="keyword">int</span> uid, Object obj, Object name)</span> </span>&#123;</span><br><span class="line">    <span class="comment">//【1】当 uid &gt; Process.LAST_APPLICATION_UID 时，超过了系统给应用程序分配的 uid 的最大值，这是非法的 uid</span></span><br><span class="line">    <span class="keyword">if</span> (uid &gt; Process.LAST_APPLICATION_UID) &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">false</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//【2】当 uid 介于 Process.FIRST_APPLICATION_UID 和 Process.LAST_APPLICATION_UID 之间时，</span></span><br><span class="line">    <span class="comment">// 说明这是保留给应用程序使用的。</span></span><br><span class="line">    <span class="keyword">if</span> (uid &gt;= Process.FIRST_APPLICATION_UID) &#123;</span><br><span class="line">        <span class="keyword">int</span> N = mUserIds.size();</span><br><span class="line">        </span><br><span class="line">        <span class="comment">//【2.1】根据 uid 来计算在 idex！</span></span><br><span class="line">        <span class="keyword">final</span> <span class="keyword">int</span> index = uid - Process.FIRST_APPLICATION_UID;</span><br><span class="line">        <span class="keyword">while</span> (index &gt;= N) &#123;</span><br><span class="line">            mUserIds.add(<span class="keyword">null</span>);</span><br><span class="line">            N++;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">if</span> (mUserIds.get(index) != <span class="keyword">null</span>) &#123;</span><br><span class="line">            PackageManagerService.reportSettingsProblem(Log.ERROR,</span><br><span class="line">                    <span class="string">"Adding duplicate user id: "</span> + uid</span><br><span class="line">                    + <span class="string">" name="</span> + name);</span><br><span class="line">            <span class="keyword">return</span> <span class="keyword">false</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        </span><br><span class="line">        <span class="comment">//【2.2】把这个应用程序 PackageSettings 对象保存在这个列表中</span></span><br><span class="line">        mUserIds.set(index, obj);</span><br><span class="line">        </span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        <span class="comment">//【2.3】当 uid &lt; Process.FIRST_APPLICATION_UID，说明是给系统使用的用户 id。</span></span><br><span class="line">        <span class="keyword">if</span> (mOtherUserIds.get(uid) != <span class="keyword">null</span>) &#123;</span><br><span class="line">            PackageManagerService.reportSettingsProblem(Log.ERROR,</span><br><span class="line">                    <span class="string">"Adding duplicate shared id: "</span> + uid</span><br><span class="line">                            + <span class="string">" name="</span> + name);</span><br><span class="line">            <span class="keyword">return</span> <span class="keyword">false</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        </span><br><span class="line">        <span class="comment">//【2.4】同理</span></span><br><span class="line">        mOtherUserIds.put(uid, obj);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">true</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>到这里，我们解析 /data/system/packages.xml 里 “package” 标签对应的 xml 元素，对于 “package” 标签的子标签 “perms”，我们最后在再分析！</p>
<h4 id="8-1-1-3-解析-“disabled-components”-“enabled-component-子标签"><a href="#8-1-1-3-解析-“disabled-components”-“enabled-component-子标签" class="headerlink" title="8.1.1.3 解析 “disabled-components” / “enabled-component 子标签"></a>8.1.1.3 解析 “disabled-components” / “enabled-component 子标签</h4><p>下面是解析可用和不可用组件的过程：</p>
<h5 id="8-1-1-3-1-Settings-readDisabledComponentsLPw"><a href="#8-1-1-3-1-Settings-readDisabledComponentsLPw" class="headerlink" title="8.1.1.3.1 Settings.readDisabledComponentsLPw"></a>8.1.1.3.1 Settings.readDisabledComponentsLPw</h5><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">readDisabledComponentsLPw</span><span class="params">(PackageSettingBase packageSetting, XmlPullParser parser,</span></span></span><br><span class="line"><span class="function"><span class="params">        <span class="keyword">int</span> userId)</span> <span class="keyword">throws</span> IOException, XmlPullParserException </span>&#123;</span><br><span class="line">    <span class="keyword">int</span> outerDepth = parser.getDepth();</span><br><span class="line">    <span class="keyword">int</span> type;</span><br><span class="line">    <span class="keyword">while</span> ((type = parser.next()) != XmlPullParser.END_DOCUMENT</span><br><span class="line">            &amp;&amp; (type != XmlPullParser.END_TAG || parser.getDepth() &gt; outerDepth)) &#123;</span><br><span class="line">        <span class="keyword">if</span> (type == XmlPullParser.END_TAG || type == XmlPullParser.TEXT) &#123;</span><br><span class="line">            <span class="keyword">continue</span>;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        String tagName = parser.getName();</span><br><span class="line">        <span class="keyword">if</span> (tagName.equals(TAG_ITEM)) &#123; <span class="comment">// item 标签</span></span><br><span class="line">            String name = parser.getAttributeValue(<span class="keyword">null</span>, ATTR_NAME); <span class="comment">// 解析 name 属性</span></span><br><span class="line">            <span class="keyword">if</span> (name != <span class="keyword">null</span>) &#123;</span><br><span class="line">                packageSetting.addDisabledComponent(name.intern(), userId); </span><br><span class="line">            &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                PackageManagerService.reportSettingsProblem(Log.WARN,</span><br><span class="line">                        <span class="string">"Error in package manager settings: &lt;disabled-components&gt; has"</span></span><br><span class="line">                                + <span class="string">" no name at "</span> + parser.getPositionDescription());</span><br><span class="line">            &#125;</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            PackageManagerService.reportSettingsProblem(Log.WARN,</span><br><span class="line">                    <span class="string">"Unknown element under &lt;disabled-components&gt;: "</span> + parser.getName());</span><br><span class="line">        &#125;</span><br><span class="line">        XmlUtils.skipCurrentTag(parser);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>这里调用了 PackageSettingBase 的 addDisabledComponent 方法！<br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">addDisabledComponent</span><span class="params">(String componentClassName, <span class="keyword">int</span> userId)</span> </span>&#123;</span><br><span class="line">    modifyUserStateComponents(userId, <span class="keyword">true</span>, <span class="keyword">false</span>).disabledComponents.add(componentClassName);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>这里要看下 PackageSettingBase 的 modifyUserStateComponents 方法！</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="function">PackageUserState <span class="title">modifyUserStateComponents</span><span class="params">(<span class="keyword">int</span> userId, <span class="keyword">boolean</span> disabled, <span class="keyword">boolean</span> enabled)</span> </span>&#123;</span><br><span class="line">    <span class="comment">//【1】创建该 package 在当前 userId 下的 PackageUserState 对象！</span></span><br><span class="line">    PackageUserState state = modifyUserState(userId);</span><br><span class="line">    <span class="keyword">if</span> (disabled &amp;&amp; state.disabledComponents == <span class="keyword">null</span>) &#123;</span><br><span class="line">        state.disabledComponents = <span class="keyword">new</span> ArraySet&lt;String&gt;(<span class="number">1</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span> (enabled &amp;&amp; state.enabledComponents == <span class="keyword">null</span>) &#123;</span><br><span class="line">        state.enabledComponents = <span class="keyword">new</span> ArraySet&lt;String&gt;(<span class="number">1</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> state;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>PackageSettingBase 有一个 userState 成员变量，用于保存该 package 在不同 userId 下的使用情况！<br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">private</span> <span class="keyword">final</span> SparseArray&lt;PackageUserState&gt; userState = <span class="keyword">new</span> SparseArray&lt;PackageUserState&gt;();</span><br></pre></td></tr></table></figure></p>
<p>PackageSettingBase.modifyUserState 返回 userId 下该 package 的 PackageUserState 对象，若没还有就会创建新的！<br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">private</span> PackageUserState <span class="title">modifyUserState</span><span class="params">(<span class="keyword">int</span> userId)</span> </span>&#123;</span><br><span class="line">    PackageUserState state = userState.get(userId);</span><br><span class="line">    <span class="keyword">if</span> (state == <span class="keyword">null</span>) &#123;</span><br><span class="line">        state = <span class="keyword">new</span> PackageUserState();</span><br><span class="line">        userState.put(userId, state);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> state;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>PackageUserState 的属性如下，调用了默认的构造器，这里先不多说！<br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">PackageUserState</span> </span>&#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">long</span> ceDataInode;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">boolean</span> installed;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">boolean</span> stopped;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">boolean</span> notLaunched;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">boolean</span> hidden; <span class="comment">// Is the app restricted by owner / admin</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">boolean</span> suspended;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">boolean</span> blockUninstall;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">int</span> enabled;</span><br><span class="line">    <span class="keyword">public</span> String lastDisableAppCaller;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">int</span> domainVerificationStatus;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">int</span> appLinkGeneration;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> ArraySet&lt;String&gt; disabledComponents; <span class="comment">// 保存不可用的组件</span></span><br><span class="line">    <span class="keyword">public</span> ArraySet&lt;String&gt; enabledComponents; <span class="comment">// 保存可用组件！</span></span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="title">PackageUserState</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        installed = <span class="keyword">true</span>;</span><br><span class="line">        hidden = <span class="keyword">false</span>;</span><br><span class="line">        suspended = <span class="keyword">false</span>;</span><br><span class="line">        enabled = COMPONENT_ENABLED_STATE_DEFAULT;</span><br><span class="line">        domainVerificationStatus =</span><br><span class="line">                PackageManager.INTENT_FILTER_DOMAIN_VERIFICATION_STATUS_UNDEFINED;</span><br><span class="line">    &#125;</span><br><span class="line">    ... ... ... ...</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>解析不可用组件的过程到这里就结束了！</p>
<h5 id="8-1-1-3-2-Settings-readEnabledComponentsLPw"><a href="#8-1-1-3-2-Settings-readEnabledComponentsLPw" class="headerlink" title="8.1.1.3.2 Settings.readEnabledComponentsLPw"></a>8.1.1.3.2 Settings.readEnabledComponentsLPw</h5><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">readEnabledComponentsLPw</span><span class="params">(PackageSettingBase packageSetting, XmlPullParser parser,</span></span></span><br><span class="line"><span class="function"><span class="params">        <span class="keyword">int</span> userId)</span> <span class="keyword">throws</span> IOException, XmlPullParserException </span>&#123;</span><br><span class="line">    <span class="keyword">int</span> outerDepth = parser.getDepth();</span><br><span class="line">    <span class="keyword">int</span> type;</span><br><span class="line">    <span class="keyword">while</span> ((type = parser.next()) != XmlPullParser.END_DOCUMENT</span><br><span class="line">            &amp;&amp; (type != XmlPullParser.END_TAG || parser.getDepth() &gt; outerDepth)) &#123;</span><br><span class="line">        <span class="keyword">if</span> (type == XmlPullParser.END_TAG || type == XmlPullParser.TEXT) &#123;</span><br><span class="line">            <span class="keyword">continue</span>;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        String tagName = parser.getName();</span><br><span class="line">        <span class="keyword">if</span> (tagName.equals(TAG_ITEM)) &#123; <span class="comment">// item 标签</span></span><br><span class="line">            String name = parser.getAttributeValue(<span class="keyword">null</span>, ATTR_NAME); <span class="comment">// 解析 name 属性</span></span><br><span class="line">            <span class="keyword">if</span> (name != <span class="keyword">null</span>) &#123;</span><br><span class="line">                packageSetting.addEnabledComponent(name.intern(), userId);</span><br><span class="line">            &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                PackageManagerService.reportSettingsProblem(Log.WARN,</span><br><span class="line">                        <span class="string">"Error in package manager settings: &lt;enabled-components&gt; has"</span></span><br><span class="line">                                + <span class="string">" no name at "</span> + parser.getPositionDescription());</span><br><span class="line">            &#125;</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            PackageManagerService.reportSettingsProblem(Log.WARN,</span><br><span class="line">                    <span class="string">"Unknown element under &lt;enabled-components&gt;: "</span> + parser.getName());</span><br><span class="line">        &#125;</span><br><span class="line">        XmlUtils.skipCurrentTag(parser);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>同样的，这里调用了 PackageSettingBase 的 addEnabledComponent 方法：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">addEnabledComponent</span><span class="params">(String componentClassName, <span class="keyword">int</span> userId)</span> </span>&#123;</span><br><span class="line">    modifyUserStateComponents(userId, <span class="keyword">false</span>, <span class="keyword">true</span>).enabledComponents.add(componentClassName);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>这里就不在分析了！</p>
<h4 id="8-1-1-4-解析-“perms”-子标签-解析安装时权限授予情况"><a href="#8-1-1-4-解析-“perms”-子标签-解析安装时权限授予情况" class="headerlink" title="8.1.1.4 解析 “perms” 子标签 - 解析安装时权限授予情况"></a>8.1.1.4 解析 “perms” 子标签 - 解析安装时权限授予情况</h4><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">perms</span>&gt;</span></span><br><span class="line">     <span class="tag">&lt;<span class="name">item</span> <span class="attr">name</span>=<span class="string">"android.permission.REAL_GET_TASKS"</span> <span class="attr">granted</span>=<span class="string">"true"</span> <span class="attr">flags</span>=<span class="string">"0"</span> /&gt;</span></span><br><span class="line">     <span class="tag">&lt;<span class="name">item</span> <span class="attr">name</span>=<span class="string">"android.permission.RECEIVE_BOOT_COMPLETED"</span> <span class="attr">granted</span>=<span class="string">"true"</span> <span class="attr">flags</span>=<span class="string">"0"</span> /&gt;</span></span><br><span class="line">     <span class="tag">&lt;<span class="name">item</span> <span class="attr">name</span>=<span class="string">"android.permission.INTERNET"</span> <span class="attr">granted</span>=<span class="string">"true"</span> <span class="attr">flags</span>=<span class="string">"0"</span> /&gt;</span></span><br><span class="line">     <span class="tag">&lt;<span class="name">item</span> <span class="attr">name</span>=<span class="string">"android.permission.ACCESS_NETWORK_STATE"</span> <span class="attr">granted</span>=<span class="string">"true"</span> <span class="attr">flags</span>=<span class="string">"0"</span> /&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">perms</span>&gt;</span></span><br></pre></td></tr></table></figure>
<p>对于 PackageSetting 和 SharedUserSetting 都有自己的权限管理对象 PermissionsState，用于保存和管理 package 和 SharedUser 所有的权限，其权限通过解析子标签 “perms” 获得，具体的解析方法是 readInstallPermissionsLPr！</p>
<p>这里会涉及到一个对象，每一个 PackageSetting 对象都有一个 PermissionsState 对象，用于管理 package 的权限！<br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">PermissionsState</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="keyword">int</span> PERMISSION_OPERATION_FAILURE = -<span class="number">1</span>; <span class="comment">// 返回值：权限操作失败</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="keyword">int</span> PERMISSION_OPERATION_SUCCESS = <span class="number">0</span>; <span class="comment">// 返回值：权限操作成功，gid 没有改变！</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="keyword">int</span> PERMISSION_OPERATION_SUCCESS_GIDS_CHANGED = <span class="number">1</span>; <span class="comment">// 返回值：权限操作成功，gid 改变！</span></span><br><span class="line">    </span><br><span class="line">    <span class="keyword">private</span> ArrayMap&lt;String, PermissionData&gt; mPermissions; <span class="comment">// 用于封装这个应用程序的所有权限！</span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">int</span>[] mGlobalGids = NO_GIDS;  </span><br><span class="line">    </span><br><span class="line">    ... ... ...</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>我们继续分析：</p>
<h5 id="8-1-1-4-1-Setting-readInstallPermissionsLPr"><a href="#8-1-1-4-1-Setting-readInstallPermissionsLPr" class="headerlink" title="8.1.1.4.1 Setting.readInstallPermissionsLPr"></a>8.1.1.4.1 Setting.readInstallPermissionsLPr</h5><p>参数传递：</p>
<ul>
<li>XmlPullParser parser：xml解析类对象，指向子标签 “perms” </li>
<li>PermissionsState permissionsState：PackageSetting.getPermissionsState 或者 SharedUserSetting.getPermissionsState!</li>
</ul>
<p><br></p>
<p>接着，调用了 readInstallPermissionsLPr 来解析 package 所使用的权限和其授予情况！</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">readInstallPermissionsLPr</span><span class="params">(XmlPullParser parser,</span></span></span><br><span class="line"><span class="function"><span class="params">        PermissionsState permissionsState)</span> <span class="keyword">throws</span> IOException, XmlPullParserException </span>&#123;</span><br><span class="line">    <span class="keyword">int</span> outerDepth = parser.getDepth();</span><br><span class="line">    <span class="keyword">int</span> type;</span><br><span class="line">    <span class="keyword">while</span> ((type=parser.next()) != XmlPullParser.END_DOCUMENT</span><br><span class="line">            &amp;&amp; (type != XmlPullParser.END_TAG</span><br><span class="line">            || parser.getDepth() &gt; outerDepth)) &#123;</span><br><span class="line">        <span class="keyword">if</span> (type == XmlPullParser.END_TAG</span><br><span class="line">                || type == XmlPullParser.TEXT) &#123;</span><br><span class="line">            <span class="keyword">continue</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        String tagName = parser.getName();</span><br><span class="line">        <span class="keyword">if</span> (tagName.equals(TAG_ITEM)) &#123; <span class="comment">// 解析 "item"</span></span><br><span class="line">            String name = parser.getAttributeValue(<span class="keyword">null</span>, ATTR_NAME); <span class="comment">// 接续 "name"，权限名称！</span></span><br><span class="line">            <span class="comment">//【1】从之前解析的 Settings.mPermissions 获得对应的权限；</span></span><br><span class="line">            BasePermission bp = mPermissions.get(name);</span><br><span class="line">            <span class="keyword">if</span> (bp == <span class="keyword">null</span>) &#123;</span><br><span class="line">                Slog.w(PackageManagerService.TAG, <span class="string">"Unknown permission: "</span> + name);</span><br><span class="line">                XmlUtils.skipCurrentTag(parser);</span><br><span class="line">                <span class="keyword">continue</span>;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="comment">//【2】解析 "granted" 标签，获得授予情况，如果没有该属性或者设置为 true，那么表示授予！</span></span><br><span class="line">            String grantedStr = parser.getAttributeValue(<span class="keyword">null</span>, ATTR_GRANTED);</span><br><span class="line">            <span class="keyword">final</span> <span class="keyword">boolean</span> granted = grantedStr == <span class="keyword">null</span></span><br><span class="line">                    || Boolean.parseBoolean(grantedStr);</span><br><span class="line"></span><br><span class="line">            <span class="comment">//【3】解析 "flags"标签</span></span><br><span class="line">            String flagsStr = parser.getAttributeValue(<span class="keyword">null</span>, ATTR_FLAGS);</span><br><span class="line">            <span class="keyword">final</span> <span class="keyword">int</span> flags = (flagsStr != <span class="keyword">null</span>)</span><br><span class="line">                    ? Integer.parseInt(flagsStr, <span class="number">16</span>) : <span class="number">0</span>;</span><br><span class="line"></span><br><span class="line">            <span class="comment">//【4】处理权限授予情况！</span></span><br><span class="line">            <span class="keyword">if</span> (granted) &#123; </span><br><span class="line">                <span class="comment">//【9.1】默认授予的情况！</span></span><br><span class="line">                <span class="keyword">if</span> (permissionsState.grantInstallPermission(bp) ==</span><br><span class="line">                        PermissionsState.PERMISSION_OPERATION_FAILURE) &#123;</span><br><span class="line">                    Slog.w(PackageManagerService.TAG, <span class="string">"Permission already added: "</span> + name);</span><br><span class="line">                    XmlUtils.skipCurrentTag(parser);</span><br><span class="line">                &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                    permissionsState.updatePermissionFlags(bp, UserHandle.USER_ALL,</span><br><span class="line">                            PackageManager.MASK_PERMISSION_FLAGS, flags);</span><br><span class="line">                &#125;</span><br><span class="line">            &#125; <span class="keyword">else</span> &#123; </span><br><span class="line">                <span class="comment">//【9.2】默认不授予的情况！</span></span><br><span class="line">                <span class="keyword">if</span> (permissionsState.revokeInstallPermission(bp) ==</span><br><span class="line">                        PermissionsState.PERMISSION_OPERATION_FAILURE) &#123;</span><br><span class="line">                    Slog.w(PackageManagerService.TAG, <span class="string">"Permission already added: "</span> + name);</span><br><span class="line">                    XmlUtils.skipCurrentTag(parser);</span><br><span class="line">                &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                    <span class="comment">//【9.3】更新权限标志位！</span></span><br><span class="line">                    permissionsState.updatePermissionFlags(bp, UserHandle.USER_ALL,</span><br><span class="line">                            PackageManager.MASK_PERMISSION_FLAGS, flags);</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            Slog.w(PackageManagerService.TAG, <span class="string">"Unknown element under &lt;permissions&gt;: "</span></span><br><span class="line">                    + parser.getName());</span><br><span class="line">            XmlUtils.skipCurrentTag(parser);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>Settings.mPermissions 中保存的权限来自两部分，一个是 SystemConfig.mPermissions 中解析到了系统定义的权限，还有一部分，来自继续 packages.xml 中获得的权限信息！</p>
<p>这里要简答的说下 flags 属性，其可以取一下的几个或者多个值：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@SystemApi</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="keyword">int</span> FLAG_PERMISSION_USER_SET = <span class="number">1</span> &lt;&lt; <span class="number">0</span>;</span><br><span class="line"></span><br><span class="line"><span class="meta">@SystemApi</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="keyword">int</span> FLAG_PERMISSION_USER_FIXED =  <span class="number">1</span> &lt;&lt; <span class="number">1</span>;</span><br><span class="line"></span><br><span class="line"><span class="meta">@SystemApi</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="keyword">int</span> FLAG_PERMISSION_POLICY_FIXED =  <span class="number">1</span> &lt;&lt; <span class="number">2</span>;</span><br><span class="line"></span><br><span class="line"><span class="meta">@SystemApi</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="keyword">int</span> FLAG_PERMISSION_REVOKE_ON_UPGRADE =  <span class="number">1</span> &lt;&lt; <span class="number">3</span>;</span><br><span class="line"></span><br><span class="line"><span class="meta">@SystemApi</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="keyword">int</span> FLAG_PERMISSION_SYSTEM_FIXED =  <span class="number">1</span> &lt;&lt; <span class="number">4</span>;</span><br><span class="line"></span><br><span class="line"><span class="meta">@SystemApi</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="keyword">int</span> FLAG_PERMISSION_GRANTED_BY_DEFAULT =  <span class="number">1</span> &lt;&lt; <span class="number">5</span>;</span><br><span class="line"></span><br><span class="line"><span class="meta">@SystemApi</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="keyword">int</span> FLAG_PERMISSION_REVIEW_REQUIRED =  <span class="number">1</span> &lt;&lt; <span class="number">6</span>;</span><br></pre></td></tr></table></figure>
<p>这里简单的解释下这个这些 flags 的作用！</p>
<h3 id="8-1-2-解析-“permissions”-“permission-trees”-标签"><a href="#8-1-2-解析-“permissions”-“permission-trees”-标签" class="headerlink" title="8.1.2 解析 “permissions” “permission-trees” 标签"></a>8.1.2 解析 “permissions” “permission-trees” 标签</h3><p>我们先来看看 “permissions” 标签的内容，可以看到该标签的内容是：权限和定义权限的包名<br><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">permissions</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">item</span> <span class="attr">name</span>=<span class="string">"android.permission.REAL_GET_TASKS"</span> <span class="attr">package</span>=<span class="string">"android"</span> <span class="attr">protection</span>=<span class="string">"18"</span> /&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">item</span> <span class="attr">name</span>=<span class="string">"android.permission.SEND_RECEIVE_STK_INTENT"</span> <span class="attr">package</span>=<span class="string">"com.android.stk"</span> <span class="attr">protection</span>=<span class="string">"2"</span> /&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">item</span> <span class="attr">name</span>=<span class="string">"android.permission.ACCESS_CACHE_FILESYSTEM"</span> <span class="attr">package</span>=<span class="string">"android"</span> <span class="attr">protection</span>=<span class="string">"18"</span> /&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">item</span> <span class="attr">name</span>=<span class="string">"android.permission.REMOTE_AUDIO_PLAYBACK"</span> <span class="attr">package</span>=<span class="string">"android"</span> <span class="attr">protection</span>=<span class="string">"2"</span> /&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">item</span> <span class="attr">name</span>=<span class="string">"android.permission.DOWNLOAD_WITHOUT_NOTIFICATION"</span> <span class="attr">package</span>=<span class="string">"com.android.providers.downloads"</span> /&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">item</span> <span class="attr">name</span>=<span class="string">"android.permission.REGISTER_WINDOW_MANAGER_LISTENERS"</span> <span class="attr">package</span>=<span class="string">"android"</span> <span class="attr">protection</span>=<span class="string">"2"</span> /&gt;</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">&lt;!----&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">permissions</span>&gt;</span></span><br></pre></td></tr></table></figure></p>
<p>下面是具体的解析过程，<strong>注意 “permissions” 的内容是最先解析的</strong>！</p>
<p>对于 “permission-trees” 和 “permissions” 解析的方法都是 readPermissionsLPw，但是 permissions 的解析结果，会保存到 mPermissions 中，而 permission-trees 的解析结果，会保存到 mPermissionTrees 中；</p>
<h4 id="8-1-2-1-Settings-readPermissionsLPw"><a href="#8-1-2-1-Settings-readPermissionsLPw" class="headerlink" title="8.1.2.1 Settings.readPermissionsLPw"></a>8.1.2.1 Settings.readPermissionsLPw</h4><p>这里的 ArrayMap&lt;String, BasePermission&gt; out 分别是 Settings.permissions 和 Settings.mPermissionTrees：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">final</span> ArrayMap&lt;String, BasePermission&gt; mPermissions = <span class="keyword">new</span> ArrayMap&lt;String, BasePermission&gt;();</span><br><span class="line"><span class="keyword">final</span> ArrayMap&lt;String, BasePermission&gt; mPermissionTrees = <span class="keyword">new</span> ArrayMap&lt;String, BasePermission&gt;();</span><br></pre></td></tr></table></figure>
<p>下面我们来看看 readPermissionsLPw 方法的逻辑：<br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">readPermissionsLPw</span><span class="params">(ArrayMap&lt;String, BasePermission&gt; out, XmlPullParser parser)</span></span></span><br><span class="line"><span class="function">        <span class="keyword">throws</span> IOException, XmlPullParserException </span>&#123;</span><br><span class="line">    <span class="keyword">int</span> outerDepth = parser.getDepth();</span><br><span class="line">    <span class="keyword">int</span> type;</span><br><span class="line">    <span class="keyword">while</span> ((type = parser.next()) != XmlPullParser.END_DOCUMENT</span><br><span class="line">            &amp;&amp; (type != XmlPullParser.END_TAG || parser.getDepth() &gt; outerDepth)) &#123;</span><br><span class="line">        <span class="keyword">if</span> (type == XmlPullParser.END_TAG || type == XmlPullParser.TEXT) &#123;</span><br><span class="line">            <span class="keyword">continue</span>;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">final</span> String tagName = parser.getName();</span><br><span class="line">        <span class="keyword">if</span> (tagName.equals(TAG_ITEM)) &#123; <span class="comment">// 解析 item 标签</span></span><br><span class="line">            <span class="keyword">final</span> String name = parser.getAttributeValue(<span class="keyword">null</span>, ATTR_NAME); <span class="comment">// 获得 permission 的名称！</span></span><br><span class="line">            <span class="keyword">final</span> String sourcePackage = parser.getAttributeValue(<span class="keyword">null</span>, <span class="string">"package"</span>); <span class="comment">// 获得定义 permission 包名!</span></span><br><span class="line">            <span class="keyword">final</span> String ptype = parser.getAttributeValue(<span class="keyword">null</span>, <span class="string">"type"</span>); <span class="comment">// 解析 type 类型！</span></span><br><span class="line">            </span><br><span class="line">            <span class="keyword">if</span> (name != <span class="keyword">null</span> &amp;&amp; sourcePackage != <span class="keyword">null</span>) &#123;</span><br><span class="line">                <span class="keyword">final</span> <span class="keyword">boolean</span> dynamic = <span class="string">"dynamic"</span>.equals(ptype);</span><br><span class="line">                <span class="comment">//【1】尝试从 Settings 对应集合中获得权限 bp！</span></span><br><span class="line">                BasePermission bp = out.get(name);</span><br><span class="line"></span><br><span class="line">                <span class="comment">//【2】如果 bp 为 null 或者</span></span><br><span class="line">                <span class="comment">// bp 不为 null 且其类型不是 BasePermission.TYPE_BUILTIN，就创建一个新的！</span></span><br><span class="line">                <span class="comment">// BasePermission.TYPE_BUILTIN 类型的权限是系统权限，前面已经解析过！</span></span><br><span class="line">                <span class="comment">// BasePermission.TYPE_DYNAMIC 类型是针对于权限树的类型的！</span></span><br><span class="line">                <span class="keyword">if</span> (bp == <span class="keyword">null</span> || bp.type != BasePermission.TYPE_BUILTIN) &#123;</span><br><span class="line">                    bp = <span class="keyword">new</span> BasePermission(name.intern(), sourcePackage,</span><br><span class="line">                            dynamic ? BasePermission.TYPE_DYNAMIC : BasePermission.TYPE_NORMAL);</span><br><span class="line">                &#125;</span><br><span class="line"></span><br><span class="line">                <span class="comment">//【3】获得定义 permission 的级别，默认为 PROTECTION_NORMAL，然后对保护级别修正! </span></span><br><span class="line">                bp.protectionLevel = readInt(parser, <span class="keyword">null</span>, <span class="string">"protection"</span>, PermissionInfo.PROTECTION_NORMAL);</span><br><span class="line">                bp.protectionLevel = PermissionInfo.fixProtectionLevel(bp.protectionLevel);</span><br><span class="line"></span><br><span class="line">                <span class="keyword">if</span> (dynamic) &#123; </span><br><span class="line">                    <span class="comment">//【3.1】如果是动态权限，进一步处理，动态权限会封装为 PermissionInfo！</span></span><br><span class="line">                    <span class="comment">// 动态权限是可以动态添加和移除的权限！通过权限树指定！</span></span><br><span class="line">                    PermissionInfo pi = <span class="keyword">new</span> PermissionInfo();</span><br><span class="line">                    pi.packageName = sourcePackage.intern();</span><br><span class="line">                    pi.name = name.intern();</span><br><span class="line">                    pi.icon = readInt(parser, <span class="keyword">null</span>, <span class="string">"icon"</span>, <span class="number">0</span>);</span><br><span class="line">                    pi.nonLocalizedLabel = parser.getAttributeValue(<span class="keyword">null</span>, <span class="string">"label"</span>);</span><br><span class="line">                    pi.protectionLevel = bp.protectionLevel;</span><br><span class="line">                    bp.pendingInfo = pi;</span><br><span class="line">                &#125;</span><br><span class="line">                </span><br><span class="line">                <span class="comment">//【4】封装成 BasePermission 保存到 mPermissions 集合中!</span></span><br><span class="line">                out.put(bp.name, bp);</span><br><span class="line">            &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                ... ... ... ...</span><br><span class="line">            &#125;</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            ... ... ... ...</span><br><span class="line">        &#125;</span><br><span class="line">        XmlUtils.skipCurrentTag(parser);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>所有的非动态权限信息最终都会被解析保存到 Setting.mPermissions 中了！！</p>
<p>而动态权限信息会被保存在 Setting.mPermissionTrees 中了！！</p>
<h3 id="8-1-3-解析-“shared-user”-标签"><a href="#8-1-3-解析-“shared-user”-标签" class="headerlink" title="8.1.3 解析 “shared-user” 标签"></a>8.1.3 解析 “shared-user” 标签</h3><p>共享用户相关数据如下：<br><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">shared-user</span> <span class="attr">name</span>=<span class="string">"android.media"</span> <span class="attr">userId</span>=<span class="string">"10014"</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">sigs</span> <span class="attr">count</span>=<span class="string">"1"</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">cert</span> <span class="attr">index</span>=<span class="string">"3"</span> /&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">sigs</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">perms</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">item</span> <span class="attr">name</span>=<span class="string">"android.permission.WRITE_SETTINGS"</span> <span class="attr">granted</span>=<span class="string">"true"</span> <span class="attr">flags</span>=<span class="string">"0"</span> /&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">item</span> <span class="attr">name</span>=<span class="string">"android.permission.RECEIVE_BOOT_COMPLETED"</span> <span class="attr">granted</span>=<span class="string">"true"</span> <span class="attr">flags</span>=<span class="string">"0"</span> /&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">item</span> <span class="attr">name</span>=<span class="string">"android.permission.WRITE_MEDIA_STORAGE"</span> <span class="attr">granted</span>=<span class="string">"true"</span> <span class="attr">flags</span>=<span class="string">"0"</span> /&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">item</span> <span class="attr">name</span>=<span class="string">"android.permission.INTERNET"</span> <span class="attr">granted</span>=<span class="string">"true"</span> <span class="attr">flags</span>=<span class="string">"0"</span> /&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">item</span> <span class="attr">name</span>=<span class="string">"android.permission.MANAGE_USB"</span> <span class="attr">granted</span>=<span class="string">"true"</span> <span class="attr">flags</span>=<span class="string">"0"</span> /&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">item</span> <span class="attr">name</span>=<span class="string">"android.permission.MANAGE_USERS"</span> <span class="attr">granted</span>=<span class="string">"true"</span> <span class="attr">flags</span>=<span class="string">"0"</span> /&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">item</span> <span class="attr">name</span>=<span class="string">"android.permission.ACCESS_NETWORK_STATE"</span> <span class="attr">granted</span>=<span class="string">"true"</span> <span class="attr">flags</span>=<span class="string">"0"</span> /&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">item</span> <span class="attr">name</span>=<span class="string">"android.permission.ACCESS_MTP"</span> <span class="attr">granted</span>=<span class="string">"true"</span> <span class="attr">flags</span>=<span class="string">"0"</span> /&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">item</span> <span class="attr">name</span>=<span class="string">"android.permission.READ_LOGS"</span> <span class="attr">granted</span>=<span class="string">"true"</span> <span class="attr">flags</span>=<span class="string">"0"</span> /&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">item</span> <span class="attr">name</span>=<span class="string">"android.permission.INTERACT_ACROSS_USERS"</span> <span class="attr">granted</span>=<span class="string">"true"</span> <span class="attr">flags</span>=<span class="string">"0"</span> /&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">item</span> <span class="attr">name</span>=<span class="string">"android.permission.ACCESS_WIFI_STATE"</span> <span class="attr">granted</span>=<span class="string">"true"</span> <span class="attr">flags</span>=<span class="string">"0"</span> /&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">item</span> <span class="attr">name</span>=<span class="string">"oppo.permission.OPPO_COMPONENT_SAFE"</span> <span class="attr">granted</span>=<span class="string">"true"</span> <span class="attr">flags</span>=<span class="string">"0"</span> /&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">item</span> <span class="attr">name</span>=<span class="string">"android.permission.WAKE_LOCK"</span> <span class="attr">granted</span>=<span class="string">"true"</span> <span class="attr">flags</span>=<span class="string">"0"</span> /&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">perms</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">shared-user</span>&gt;</span></span><br></pre></td></tr></table></figure></p>
<h4 id="8-1-3-1-Settings-readSharedUserLPw"><a href="#8-1-3-1-Settings-readSharedUserLPw" class="headerlink" title="8.1.3.1 Settings.readSharedUserLPw"></a>8.1.3.1 Settings.readSharedUserLPw</h4><p>解析系统定义的共享用户 id：<br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">readSharedUserLPw</span><span class="params">(XmlPullParser parser)</span> <span class="keyword">throws</span> XmlPullParserException,IOException </span>&#123;</span><br><span class="line">    String name = <span class="keyword">null</span>;</span><br><span class="line">    String idStr = <span class="keyword">null</span>;</span><br><span class="line">    <span class="keyword">int</span> pkgFlags = <span class="number">0</span>;</span><br><span class="line">    <span class="keyword">int</span> pkgPrivateFlags = <span class="number">0</span>;</span><br><span class="line">    SharedUserSetting su = <span class="keyword">null</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">        name = parser.getAttributeValue(<span class="keyword">null</span>, ATTR_NAME); <span class="comment">// 获得共享用户的名称</span></span><br><span class="line">        idStr = parser.getAttributeValue(<span class="keyword">null</span>, <span class="string">"userId"</span>);  <span class="comment">// 获得共享用户的id</span></span><br><span class="line">        <span class="keyword">int</span> userId = idStr != <span class="keyword">null</span> ? Integer.parseInt(idStr) : <span class="number">0</span>;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (<span class="string">"true"</span>.equals(parser.getAttributeValue(<span class="keyword">null</span>, <span class="string">"system"</span>))) &#123; <span class="comment">// 是否是系统的用户 id！</span></span><br><span class="line">            pkgFlags |= ApplicationInfo.FLAG_SYSTEM;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (name == <span class="keyword">null</span>) &#123;</span><br><span class="line">            PackageManagerService.reportSettingsProblem(Log.WARN,</span><br><span class="line">                    <span class="string">"Error in package manager settings: &lt;shared-user&gt; has no name at "</span></span><br><span class="line">                            + parser.getPositionDescription());</span><br><span class="line">        &#125; <span class="keyword">else</span> <span class="keyword">if</span> (userId == <span class="number">0</span>) &#123;</span><br><span class="line">            PackageManagerService.reportSettingsProblem(Log.WARN,</span><br><span class="line">                    <span class="string">"Error in package manager settings: shared-user "</span> + name</span><br><span class="line">                            + <span class="string">" has bad userId "</span> + idStr + <span class="string">" at "</span></span><br><span class="line">                            + parser.getPositionDescription());</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line"></span><br><span class="line">            <span class="comment">//【8.1.3.2】调用 addSharedUserLPw 方法，将这个共享用户和对应的 uid 保存下来！</span></span><br><span class="line">            <span class="keyword">if</span> ((su = addSharedUserLPw(name.intern(), userId, pkgFlags, pkgPrivateFlags))</span><br><span class="line">                    == <span class="keyword">null</span>) &#123;</span><br><span class="line">                PackageManagerService</span><br><span class="line">                        .reportSettingsProblem(Log.ERROR, <span class="string">"Occurred while parsing settings at "</span></span><br><span class="line">                                + parser.getPositionDescription());</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125; <span class="keyword">catch</span> (NumberFormatException e) &#123;</span><br><span class="line">        PackageManagerService.reportSettingsProblem(Log.WARN,</span><br><span class="line">                <span class="string">"Error in package manager settings: package "</span> + name + <span class="string">" has bad userId "</span></span><br><span class="line">                        + idStr + <span class="string">" at "</span> + parser.getPositionDescription());</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (su != <span class="keyword">null</span>) &#123; <span class="comment">// 解析子标签！</span></span><br><span class="line">        <span class="keyword">int</span> outerDepth = parser.getDepth();</span><br><span class="line">        <span class="keyword">int</span> type;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">while</span> ((type = parser.next()) != XmlPullParser.END_DOCUMENT</span><br><span class="line">                &amp;&amp; (type != XmlPullParser.END_TAG || parser.getDepth() &gt; outerDepth)) &#123;</span><br><span class="line">            <span class="keyword">if</span> (type == XmlPullParser.END_TAG || type == XmlPullParser.TEXT) &#123;</span><br><span class="line">                <span class="keyword">continue</span>;</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            String tagName = parser.getName();</span><br><span class="line">            <span class="keyword">if</span> (tagName.equals(<span class="string">"sigs"</span>)) &#123;</span><br><span class="line">                su.signatures.readXml(parser, mPastSignatures);</span><br><span class="line">                </span><br><span class="line">            &#125; <span class="keyword">else</span> <span class="keyword">if</span> (tagName.equals(<span class="string">"perms"</span>)) &#123; <span class="comment">// 解析 "perms" 标签</span></span><br><span class="line">                <span class="comment">//【8.1.1.3.1】解析共享用户的权限信息！</span></span><br><span class="line">                readInstallPermissionsLPr(parser, su.getPermissionsState());</span><br><span class="line">                </span><br><span class="line">            &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                PackageManagerService.reportSettingsProblem(Log.WARN,</span><br><span class="line">                        <span class="string">"Unknown element under &lt;shared-user&gt;: "</span> + parser.getName());</span><br><span class="line">                XmlUtils.skipCurrentTag(parser);</span><br><span class="line"></span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        XmlUtils.skipCurrentTag(parser);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<h4 id="8-1-3-2-Settings-addSharedUserLPw"><a href="#8-1-3-2-Settings-addSharedUserLPw" class="headerlink" title="8.1.3.2 Settings.addSharedUserLPw"></a>8.1.3.2 Settings.addSharedUserLPw</h4><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="function">SharedUserSetting <span class="title">addSharedUserLPw</span><span class="params">(String name, <span class="keyword">int</span> uid, <span class="keyword">int</span> pkgFlags, <span class="keyword">int</span> pkgPrivateFlags)</span> </span>&#123;</span><br><span class="line">    <span class="comment">// 创建共享用户对应的 SharedUserSetting 对象！</span></span><br><span class="line">    SharedUserSetting s = mSharedUsers.get(name);</span><br><span class="line">    <span class="keyword">if</span> (s != <span class="keyword">null</span>) &#123;</span><br><span class="line">        <span class="keyword">if</span> (s.userId == uid) &#123;</span><br><span class="line">            <span class="keyword">return</span> s;</span><br><span class="line">        &#125;</span><br><span class="line">        PackageManagerService.reportSettingsProblem(Log.ERROR,</span><br><span class="line">                <span class="string">"Adding duplicate shared user, keeping first: "</span> + name);</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">null</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    s = <span class="keyword">new</span> SharedUserSetting(name, pkgFlags, pkgPrivateFlags);</span><br><span class="line">    s.userId = uid;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">//【8.1.1.2.1】根据 uid 的范围，保存到 mUsersId 和 mOthersId 中！</span></span><br><span class="line">    <span class="keyword">if</span> (addUserIdLPw(uid, s, name)) &#123;</span><br><span class="line">        <span class="comment">// 将其添加到 mSharedUsers 集合中！</span></span><br><span class="line">        mSharedUsers.put(name, s);</span><br><span class="line">        <span class="keyword">return</span> s;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">null</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>流程总结：</p>
<ul>
<li>解析 “shared-user” ，将其分装成 SharedUserSetting 对象，保存到 mSharedUsers，并根据 uid 的取值将其保存到 mUserIds 或者 mOtherIds 中！</li>
<li>解析 “shared-user” 子标签 “perm” 等等，解析共享用户的权限，每个权限对应一个 PermissionData 对象，保存进入 PermisssionState 中，用于管理共享用户的权限！</li>
</ul>
<h3 id="8-1-4-解析-“preferred-activities”-相关标签"><a href="#8-1-4-解析-“preferred-activities”-相关标签" class="headerlink" title="8.1.4 解析 “preferred-activities” 相关标签"></a>8.1.4 解析 “preferred-activities” 相关标签</h3><h4 id="8-1-4-1-Settings-readPreferredActivitiesLPw"><a href="#8-1-4-1-Settings-readPreferredActivitiesLPw" class="headerlink" title="8.1.4.1 Settings.readPreferredActivitiesLPw"></a>8.1.4.1 Settings.readPreferredActivitiesLPw</h4><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">readPreferredActivitiesLPw</span><span class="params">(XmlPullParser parser, <span class="keyword">int</span> userId)</span></span></span><br><span class="line"><span class="function">        <span class="keyword">throws</span> XmlPullParserException, IOException </span>&#123;</span><br><span class="line">    <span class="keyword">int</span> outerDepth = parser.getDepth();</span><br><span class="line">    <span class="keyword">int</span> type;</span><br><span class="line">    <span class="keyword">while</span> ((type = parser.next()) != XmlPullParser.END_DOCUMENT</span><br><span class="line">            &amp;&amp; (type != XmlPullParser.END_TAG || parser.getDepth() &gt; outerDepth)) &#123;</span><br><span class="line">        <span class="keyword">if</span> (type == XmlPullParser.END_TAG || type == XmlPullParser.TEXT) &#123;</span><br><span class="line">            <span class="keyword">continue</span>;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        String tagName = parser.getName();</span><br><span class="line">        <span class="keyword">if</span> (tagName.equals(TAG_ITEM)) &#123;</span><br><span class="line">        </span><br><span class="line">            <span class="comment">// 创建 PreferredActivity 对象！</span></span><br><span class="line">            PreferredActivity pa = <span class="keyword">new</span> PreferredActivity(parser);</span><br><span class="line">            <span class="keyword">if</span> (pa.mPref.getParseError() == <span class="keyword">null</span>) &#123;</span><br><span class="line">                editPreferredActivitiesLPw(userId).addFilter(pa);</span><br><span class="line">            &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                PackageManagerService.reportSettingsProblem(Log.WARN,</span><br><span class="line">                        <span class="string">"Error in package manager settings: &lt;preferred-activity&gt; "</span></span><br><span class="line">                                + pa.mPref.getParseError() + <span class="string">" at "</span></span><br><span class="line">                                + parser.getPositionDescription());</span><br><span class="line">            &#125;</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            PackageManagerService.reportSettingsProblem(Log.WARN,</span><br><span class="line">                    <span class="string">"Unknown element under &lt;preferred-activities&gt;: "</span> + parser.getName());</span><br><span class="line">            XmlUtils.skipCurrentTag(parser);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h4 id="8-1-4-2-Settings-readPersistentPreferredActivitiesLPw"><a href="#8-1-4-2-Settings-readPersistentPreferredActivitiesLPw" class="headerlink" title="8.1.4.2 Settings.readPersistentPreferredActivitiesLPw"></a>8.1.4.2 Settings.readPersistentPreferredActivitiesLPw</h4><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line">   <span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">readPersistentPreferredActivitiesLPw</span><span class="params">(XmlPullParser parser, <span class="keyword">int</span> userId)</span></span></span><br><span class="line"><span class="function">        <span class="keyword">throws</span> XmlPullParserException, IOException </span>&#123;</span><br><span class="line">    <span class="keyword">int</span> outerDepth = parser.getDepth();</span><br><span class="line">    <span class="keyword">int</span> type;</span><br><span class="line">    <span class="keyword">while</span> ((type = parser.next()) != XmlPullParser.END_DOCUMENT</span><br><span class="line">            &amp;&amp; (type != XmlPullParser.END_TAG || parser.getDepth() &gt; outerDepth)) &#123;</span><br><span class="line">        <span class="keyword">if</span> (type == XmlPullParser.END_TAG || type == XmlPullParser.TEXT) &#123;</span><br><span class="line">            <span class="keyword">continue</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        String tagName = parser.getName();</span><br><span class="line">        <span class="keyword">if</span> (tagName.equals(TAG_ITEM)) &#123;</span><br><span class="line">        </span><br><span class="line">            <span class="comment">//【1】创建 PersistentPreferredActivity 对象！</span></span><br><span class="line">            PersistentPreferredActivity ppa = <span class="keyword">new</span> PersistentPreferredActivity(parser);</span><br><span class="line">            editPersistentPreferredActivitiesLPw(userId).addFilter(ppa);</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            PackageManagerService.reportSettingsProblem(Log.WARN,</span><br><span class="line">                    <span class="string">"Unknown element under &lt;"</span> + TAG_PERSISTENT_PREFERRED_ACTIVITIES + <span class="string">"&gt;: "</span></span><br><span class="line">                    + parser.getName());</span><br><span class="line">            XmlUtils.skipCurrentTag(parser);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>不多说了！！</p>
<h3 id="8-1-5-解析-“updated-package”-标签"><a href="#8-1-5-解析-“updated-package”-标签" class="headerlink" title="8.1.5 解析 “updated-package” 标签"></a>8.1.5 解析 “updated-package” 标签</h3><p>我们来看看这个标签的内容，进行对比：<br><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">package</span> <span class="attr">name</span>=<span class="string">"com.android.xxxx"</span> </span></span><br><span class="line"><span class="tag">         <span class="attr">codePath</span>=<span class="string">"/data/app/com.android.xxxx-1"</span> </span></span><br><span class="line"><span class="tag">         <span class="attr">nativeLibraryPath</span>=<span class="string">"/data/app/com.android.xxxx-2/lib"</span> </span></span><br><span class="line"><span class="tag">         <span class="attr">publicFlags</span>=<span class="string">"944258757"</span> </span></span><br><span class="line"><span class="tag">         <span class="attr">privateFlags</span>=<span class="string">"0"</span> </span></span><br><span class="line"><span class="tag">         <span class="attr">ft</span>=<span class="string">"15920cea638"</span> <span class="attr">it</span>=<span class="string">"15920cea638"</span> <span class="attr">ut</span>=<span class="string">"15920cea638"</span> <span class="attr">version</span>=<span class="string">"1000"</span> <span class="attr">userId</span>=<span class="string">"10053"</span>  </span></span><br><span class="line"><span class="tag">         <span class="attr">installer</span>=<span class="string">"com.android.packageinstaller"</span>&gt;</span></span><br><span class="line">         <span class="tag">&lt;<span class="name">perms</span>&gt;</span></span><br><span class="line">            <span class="comment">&lt;!----&gt;</span></span><br><span class="line">         <span class="tag">&lt;/<span class="name">perms</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">package</span>&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="tag">&lt;<span class="name">updated-package</span> <span class="attr">name</span>=<span class="string">"com.android.xxxx"</span> </span></span><br><span class="line"><span class="tag">         <span class="attr">codePath</span>=<span class="string">"/data/app/com.android.xxxx-1"</span> </span></span><br><span class="line"><span class="tag">         <span class="attr">ft</span>=<span class="string">"158ff005268"</span> <span class="attr">it</span>=<span class="string">"158ff005268"</span> <span class="attr">ut</span>=<span class="string">"158ff005268"</span> <span class="attr">version</span>=<span class="string">"845"</span>         </span></span><br><span class="line"><span class="tag">         <span class="attr">nativeLibraryPath</span>=<span class="string">"/data/app/com.android.xxxx-1/lib"</span> <span class="attr">userId</span>=<span class="string">"10053"</span>&gt;</span></span><br><span class="line">         <span class="tag">&lt;<span class="name">perms</span>&gt;</span></span><br><span class="line">            <span class="comment">&lt;!----&gt;</span></span><br><span class="line">         <span class="tag">&lt;/<span class="name">perms</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">updated-package</span>&gt;</span></span><br></pre></td></tr></table></figure></p>
<p>接下里，我们去看看解析过程：</p>
<h4 id="8-1-5-1-Settings-readDisabledSysPackageLPw"><a href="#8-1-5-1-Settings-readDisabledSysPackageLPw" class="headerlink" title="8.1.5.1 Settings.readDisabledSysPackageLPw"></a>8.1.5.1 Settings.readDisabledSysPackageLPw</h4><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">readDisabledSysPackageLPw</span><span class="params">(XmlPullParser parser)</span> <span class="keyword">throws</span> XmlPullParserException,</span></span><br><span class="line"><span class="function">        IOException </span>&#123;</span><br><span class="line">    String name = parser.getAttributeValue(<span class="keyword">null</span>, ATTR_NAME);</span><br><span class="line">    String realName = parser.getAttributeValue(<span class="keyword">null</span>, <span class="string">"realName"</span>);</span><br><span class="line">    String codePathStr = parser.getAttributeValue(<span class="keyword">null</span>, <span class="string">"codePath"</span>);</span><br><span class="line">    String resourcePathStr = parser.getAttributeValue(<span class="keyword">null</span>, <span class="string">"resourcePath"</span>);</span><br><span class="line"></span><br><span class="line">    String legacyCpuAbiStr = parser.getAttributeValue(<span class="keyword">null</span>, <span class="string">"requiredCpuAbi"</span>);</span><br><span class="line">    String legacyNativeLibraryPathStr = parser.getAttributeValue(<span class="keyword">null</span>, <span class="string">"nativeLibraryPath"</span>);</span><br><span class="line"></span><br><span class="line">    String parentPackageName = parser.getAttributeValue(<span class="keyword">null</span>, <span class="string">"parentPackageName"</span>);</span><br><span class="line"></span><br><span class="line">    String primaryCpuAbiStr = parser.getAttributeValue(<span class="keyword">null</span>, <span class="string">"primaryCpuAbi"</span>);</span><br><span class="line">    String secondaryCpuAbiStr = parser.getAttributeValue(<span class="keyword">null</span>, <span class="string">"secondaryCpuAbi"</span>);</span><br><span class="line">    String cpuAbiOverrideStr = parser.getAttributeValue(<span class="keyword">null</span>, <span class="string">"cpuAbiOverride"</span>);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (primaryCpuAbiStr == <span class="keyword">null</span> &amp;&amp; legacyCpuAbiStr != <span class="keyword">null</span>) &#123;</span><br><span class="line">        primaryCpuAbiStr = legacyCpuAbiStr;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (resourcePathStr == <span class="keyword">null</span>) &#123;</span><br><span class="line">        resourcePathStr = codePathStr;</span><br><span class="line">    &#125;</span><br><span class="line">    String version = parser.getAttributeValue(<span class="keyword">null</span>, <span class="string">"version"</span>);</span><br><span class="line">    <span class="keyword">int</span> versionCode = <span class="number">0</span>;</span><br><span class="line">    <span class="keyword">if</span> (version != <span class="keyword">null</span>) &#123;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            versionCode = Integer.parseInt(version);</span><br><span class="line">        &#125; <span class="keyword">catch</span> (NumberFormatException e) &#123;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">int</span> pkgFlags = <span class="number">0</span>;</span><br><span class="line">    <span class="keyword">int</span> pkgPrivateFlags = <span class="number">0</span>;</span><br><span class="line">    pkgFlags |= ApplicationInfo.FLAG_SYSTEM;</span><br><span class="line">    <span class="keyword">final</span> File codePathFile = <span class="keyword">new</span> File(codePathStr);</span><br><span class="line">    <span class="keyword">if</span> (PackageManagerService.locationIsPrivileged(codePathFile)) &#123;</span><br><span class="line">        pkgPrivateFlags |= ApplicationInfo.PRIVATE_FLAG_PRIVILEGED;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// 封装成 PackageSetting 对象</span></span><br><span class="line">    PackageSetting ps = <span class="keyword">new</span> PackageSetting(name, realName, codePathFile,</span><br><span class="line">            <span class="keyword">new</span> File(resourcePathStr), legacyNativeLibraryPathStr, primaryCpuAbiStr,</span><br><span class="line">            secondaryCpuAbiStr, cpuAbiOverrideStr, versionCode, pkgFlags, pkgPrivateFlags,</span><br><span class="line">            parentPackageName, <span class="keyword">null</span>);</span><br><span class="line">            </span><br><span class="line">    <span class="comment">// 获得时间戳，第一次安装时间，最后一次更新时间，省略！</span></span><br><span class="line">    ... ... ... ...</span><br><span class="line"> </span><br><span class="line">    <span class="comment">// 处理其独立 uid 或者共享 uid 信息！</span></span><br><span class="line">    String idStr = parser.getAttributeValue(<span class="keyword">null</span>, <span class="string">"userId"</span>);</span><br><span class="line">    ps.appId = idStr != <span class="keyword">null</span> ? Integer.parseInt(idStr) : <span class="number">0</span>;</span><br><span class="line">    <span class="keyword">if</span> (ps.appId &lt;= <span class="number">0</span>) &#123;</span><br><span class="line">        String sharedIdStr = parser.getAttributeValue(<span class="keyword">null</span>, <span class="string">"sharedUserId"</span>);</span><br><span class="line">        ps.appId = sharedIdStr != <span class="keyword">null</span> ? Integer.parseInt(sharedIdStr) : <span class="number">0</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">int</span> outerDepth = parser.getDepth();</span><br><span class="line">    <span class="keyword">int</span> type;</span><br><span class="line">    <span class="keyword">while</span> ((type = parser.next()) != XmlPullParser.END_DOCUMENT</span><br><span class="line">            &amp;&amp; (type != XmlPullParser.END_TAG || parser.getDepth() &gt; outerDepth)) &#123;</span><br><span class="line">        <span class="keyword">if</span> (type == XmlPullParser.END_TAG || type == XmlPullParser.TEXT) &#123;</span><br><span class="line">            <span class="keyword">continue</span>;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (parser.getName().equals(TAG_PERMISSIONS)) &#123; <span class="comment">// 解析 "perms" 标签！</span></span><br><span class="line">            <span class="comment">// ps.getPermissionsState() 是 package 的权限管理对象！</span></span><br><span class="line">            readInstallPermissionsLPr(parser, ps.getPermissionsState());</span><br><span class="line">            </span><br><span class="line">        &#125; <span class="keyword">else</span> <span class="keyword">if</span> (parser.getName().equals(TAG_CHILD_PACKAGE)) &#123;</span><br><span class="line">            String childPackageName = parser.getAttributeValue(<span class="keyword">null</span>, ATTR_NAME);</span><br><span class="line">            <span class="keyword">if</span> (ps.childPackageNames == <span class="keyword">null</span>) &#123;</span><br><span class="line">                ps.childPackageNames = <span class="keyword">new</span> ArrayList&lt;&gt;();</span><br><span class="line">            &#125;</span><br><span class="line">            ps.childPackageNames.add(childPackageName);</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            PackageManagerService.reportSettingsProblem(Log.WARN,</span><br><span class="line">                    <span class="string">"Unknown element under &lt;updated-package&gt;: "</span> + parser.getName());</span><br><span class="line">            XmlUtils.skipCurrentTag(parser);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">//【1】保存到 mDisabledSysPackages 中！</span></span><br><span class="line">    mDisabledSysPackages.put(name, ps);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h3 id="8-1-6-解析-“cleaning-package”-标签"><a href="#8-1-6-解析-“cleaning-package”-标签" class="headerlink" title="8.1.6 解析 “cleaning-package” 标签"></a>8.1.6 解析 “cleaning-package” 标签</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line">&#125; <span class="keyword">else</span> <span class="keyword">if</span> (tagName.equals(<span class="string">"cleaning-package"</span>)) &#123;</span><br><span class="line">    String name = parser.getAttributeValue(<span class="keyword">null</span>, ATTR_NAME);</span><br><span class="line">    String userStr = parser.getAttributeValue(<span class="keyword">null</span>, ATTR_USER);</span><br><span class="line">    String codeStr = parser.getAttributeValue(<span class="keyword">null</span>, ATTR_CODE);</span><br><span class="line">    <span class="keyword">if</span> (name != <span class="keyword">null</span>) &#123;</span><br><span class="line">        <span class="keyword">int</span> userId = UserHandle.USER_SYSTEM;</span><br><span class="line">        <span class="keyword">boolean</span> andCode = <span class="keyword">true</span>;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            <span class="keyword">if</span> (userStr != <span class="keyword">null</span>) &#123;</span><br><span class="line">                userId = Integer.parseInt(userStr);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125; <span class="keyword">catch</span> (NumberFormatException e) &#123;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">if</span> (codeStr != <span class="keyword">null</span>) &#123;</span><br><span class="line">            andCode = Boolean.parseBoolean(codeStr);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">// 创建一个 PackageCleanItem 对象！</span></span><br><span class="line">        addPackageToCleanLPw(<span class="keyword">new</span> PackageCleanItem(userId, name, andCode));</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>调用 addPackageToCleanLPw 方法；<br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">addPackageToCleanLPw</span><span class="params">(PackageCleanItem pkg)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">if</span> (!mPackagesToBeCleaned.contains(pkg)) &#123;</span><br><span class="line">        </span><br><span class="line">        <span class="comment">//【1】添加到 mPackagesToBeCleaned！</span></span><br><span class="line">        mPackagesToBeCleaned.add(pkg);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>这个方法很简单！</p>
<h3 id="8-1-7-解析-“renamed-package”-标签"><a href="#8-1-7-解析-“renamed-package”-标签" class="headerlink" title="8.1.7 解析 “renamed-package” 标签"></a>8.1.7 解析 “renamed-package” 标签</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">else</span> <span class="keyword">if</span> (tagName.equals(<span class="string">"renamed-package"</span>)) &#123;</span><br><span class="line">    String nname = parser.getAttributeValue(<span class="keyword">null</span>, <span class="string">"new"</span>);</span><br><span class="line">    String oname = parser.getAttributeValue(<span class="keyword">null</span>, <span class="string">"old"</span>);</span><br><span class="line">    <span class="keyword">if</span> (nname != <span class="keyword">null</span> &amp;&amp; oname != <span class="keyword">null</span>) &#123;</span><br><span class="line">        mRenamedPackages.put(nname, oname);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>代码很简单，将重新命名的应用的数据，key 为 新名字。value 为旧名字，添加到 mRenamedPackages 中！</p>
<h3 id="8-1-8-阶段总结"><a href="#8-1-8-阶段总结" class="headerlink" title="8.1.8 阶段总结"></a>8.1.8 阶段总结</h3><p>我们来用一张图总结一下，PermissionsState 和 PackageSetting，SharedUserSetting 的关系！<br>![未命名文件.png-59.5kB][3]</p>
<ul>
<li>如果 pacakge 是共享用户 id，那么所有 uid 为共享用户 id 的 package，其权限是一样的，都是共享用户的权限;</li>
<li>如果 pacakge 是独立用户 id，那么这个 package 有自己独立的权限！</li>
</ul>
<h2 id="8-2-确定共享-uid-有效性"><a href="#8-2-确定共享-uid-有效性" class="headerlink" title="8.2 确定共享 uid 有效性"></a>8.2 确定共享 uid 有效性</h2><p>主要逻辑如下：<br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//【1】对 mPendingPackages 集合中的需要验证共享用户 id 有效性的 package，进行共享用户 id 有效性的验证!</span></span><br><span class="line"><span class="keyword">final</span> <span class="keyword">int</span> N = mPendingPackages.size();</span><br><span class="line"><span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; N; i++) &#123;</span><br><span class="line">    <span class="keyword">final</span> PendingPackage pp = mPendingPackages.get(i);</span><br><span class="line"></span><br><span class="line">    <span class="comment">//【8.2.1】看 sharedId 是否能对应找到一个 ShardUserSetting 对象!</span></span><br><span class="line">    Object idObj = getUserIdLPr(pp.sharedId);</span><br><span class="line">    <span class="keyword">if</span> (idObj != <span class="keyword">null</span> &amp;&amp; idObj <span class="keyword">instanceof</span> SharedUserSetting) &#123; <span class="comment">// 能找到，说明共享用户 ID 是有效的!</span></span><br><span class="line">    </span><br><span class="line">        <span class="comment">//【8.2.2】创建 PackageSetting！</span></span><br><span class="line">        PackageSetting p = getPackageLPw(pp.name, <span class="keyword">null</span>, pp.realName,</span><br><span class="line">                (SharedUserSetting) idObj, pp.codePath, pp.resourcePath,</span><br><span class="line">                pp.legacyNativeLibraryPathString, pp.primaryCpuAbiString,</span><br><span class="line">                pp.secondaryCpuAbiString, pp.versionCode, pp.pkgFlags, pp.pkgPrivateFlags,</span><br><span class="line">                <span class="keyword">null</span>, <span class="keyword">true</span> <span class="comment">/* add */</span>, <span class="keyword">false</span> <span class="comment">/* allowInstall */</span>, pp.parentPackageName,</span><br><span class="line">                pp.childPackageNames);</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (p == <span class="keyword">null</span>) &#123;</span><br><span class="line">            PackageManagerService.reportSettingsProblem(Log.WARN,</span><br><span class="line">                    <span class="string">"Unable to create application package for "</span> + pp.name);</span><br><span class="line">            <span class="keyword">continue</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        </span><br><span class="line">        <span class="comment">// 将 PendingPackage 的其他数据拷贝到 PackageSetting 中！</span></span><br><span class="line">        p.copyFrom(pp); </span><br><span class="line"></span><br><span class="line">    &#125; <span class="keyword">else</span> <span class="keyword">if</span> (idObj != <span class="keyword">null</span>) &#123;</span><br><span class="line">        String msg = <span class="string">"Bad package setting: package "</span> + pp.name + <span class="string">" has shared uid "</span></span><br><span class="line">                + pp.sharedId + <span class="string">" that is not a shared uid\n"</span>;</span><br><span class="line">        mReadMessages.append(msg);</span><br><span class="line">        PackageManagerService.reportSettingsProblem(Log.ERROR, msg);</span><br><span class="line"></span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        String msg = <span class="string">"Bad package setting: package "</span> + pp.name + <span class="string">" has shared uid "</span></span><br><span class="line">                + pp.sharedId + <span class="string">" that is not defined\n"</span>;</span><br><span class="line">        mReadMessages.append(msg);</span><br><span class="line">        PackageManagerService.reportSettingsProblem(Log.ERROR, msg);</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line">mPendingPackages.clear(); <span class="comment">// 清空 mPendingPackages</span></span><br></pre></td></tr></table></figure></p>
<p>这里调用 getUserIdLPr 来从 mUserIds 或 mOtherUserIds 中获得一个共享用户对象！</p>
<h3 id="8-2-1-Settings-getUserIdLPr"><a href="#8-2-1-Settings-getUserIdLPr" class="headerlink" title="8.2.1 Settings.getUserIdLPr"></a>8.2.1 Settings.getUserIdLPr</h3><p>获得指定 uid 对应的 Object，可能是一个 PackageSetting 或者是 SharedUserSetting！<br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> Object <span class="title">getUserIdLPr</span><span class="params">(<span class="keyword">int</span> uid)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">if</span> (uid &gt;= Process.FIRST_APPLICATION_UID) &#123;</span><br><span class="line">        <span class="keyword">final</span> <span class="keyword">int</span> N = mUserIds.size();</span><br><span class="line">        <span class="keyword">final</span> <span class="keyword">int</span> index = uid - Process.FIRST_APPLICATION_UID;</span><br><span class="line">        <span class="keyword">return</span> index &lt; N ? mUserIds.get(index) : <span class="keyword">null</span>;</span><br><span class="line"></span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> mOtherUserIds.get(uid);</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>之前在分析解析 “shared-user” 的时候，就知道 SharedUserSetting 会被保存到这两个几个当中的，这里就不多说了！</p>
<p>接着，调用 getPackageLPw 方法来创建这个 PendingPackage 对应的 PackageSetting 对象！</p>
<h3 id="8-2-2-Settings-getPackageLPw"><a href="#8-2-2-Settings-getPackageLPw" class="headerlink" title="8.2.2 Settings.getPackageLPw"></a>8.2.2 Settings.getPackageLPw</h3><p>参数传递：</p>
<ul>
<li>PackageSetting origPackage：表示源包，传入 null；</li>
<li>SharedUserSetting sharedUser：共享 uid 对象，这里是不为 null！</li>
<li>UserHandle installUser：为 null；</li>
<li>add：true；</li>
</ul>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">private</span> PackageSetting <span class="title">getPackageLPw</span><span class="params">(String name, PackageSetting origPackage,</span></span></span><br><span class="line"><span class="function"><span class="params">        String realName, SharedUserSetting sharedUser, File codePath, File resourcePath,</span></span></span><br><span class="line"><span class="function"><span class="params">        String legacyNativeLibraryPathString, String primaryCpuAbiString,</span></span></span><br><span class="line"><span class="function"><span class="params">        String secondaryCpuAbiString, <span class="keyword">int</span> vc, <span class="keyword">int</span> pkgFlags, <span class="keyword">int</span> pkgPrivateFlags,</span></span></span><br><span class="line"><span class="function"><span class="params">        UserHandle installUser, <span class="keyword">boolean</span> add, <span class="keyword">boolean</span> allowInstall, String parentPackage,</span></span></span><br><span class="line"><span class="function"><span class="params">        List&lt;String&gt; childPackageNames)</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    PackageSetting p = mPackages.get(name); <span class="comment">//【1】看是否之前有添加过这个包！</span></span><br><span class="line">    UserManagerService userManager = UserManagerService.getInstance();</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (p != <span class="keyword">null</span>) &#123; </span><br><span class="line">        ... ... ...<span class="comment">// 如果已经添加了，这显然是不可能的，这里不会走这个分支！</span></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (p == <span class="keyword">null</span>) &#123;  <span class="comment">//【2】之前没有添加过，那就需要创建新的 PackageSetting 对象!</span></span><br><span class="line">    </span><br><span class="line">        <span class="keyword">if</span> (origPackage != <span class="keyword">null</span>) &#123; </span><br><span class="line">        </span><br><span class="line">           ... ... ... ... ...<span class="comment">// 如果有原包的话，这里不进入这个发分支！</span></span><br><span class="line">            </span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        </span><br><span class="line">            <span class="comment">//【3】如果这个 package 没有原包的话，就以参数 name 为包名，创建 PackageSetting 对象。</span></span><br><span class="line">            p = <span class="keyword">new</span> PackageSetting(name, realName, codePath, resourcePath,</span><br><span class="line">                    legacyNativeLibraryPathString, primaryCpuAbiString, secondaryCpuAbiString,</span><br><span class="line">                    <span class="keyword">null</span> <span class="comment">/* cpuAbiOverrideString */</span>, vc, pkgFlags, pkgPrivateFlags,</span><br><span class="line">                    parentPackage, childPackageNames);</span><br><span class="line"></span><br><span class="line">            p.setTimeStamp(codePath.lastModified());</span><br><span class="line"></span><br><span class="line">            <span class="comment">//【4】设置其 sharedUser 属性，因为它是共享 uid 的！</span></span><br><span class="line">            p.sharedUser = sharedUser;</span><br><span class="line"></span><br><span class="line">            <span class="comment">//【5】如果是非系统的应用，设置他在每个设备用户下的安装状态！</span></span><br><span class="line">            <span class="keyword">if</span> ((pkgFlags &amp; ApplicationInfo.FLAG_SYSTEM) == <span class="number">0</span>) &#123;</span><br><span class="line">                <span class="keyword">if</span> (DEBUG_STOPPED) &#123;</span><br><span class="line">                    RuntimeException e = <span class="keyword">new</span> RuntimeException(<span class="string">"here"</span>);</span><br><span class="line">                    e.fillInStackTrace();</span><br><span class="line">                    Slog.i(PackageManagerService.TAG, <span class="string">"Stopping package "</span> + name, e);</span><br><span class="line">                &#125;</span><br><span class="line"></span><br><span class="line">                List&lt;UserInfo&gt; users = getAllUsers();</span><br><span class="line">                <span class="keyword">final</span> <span class="keyword">int</span> installUserId = installUser != <span class="keyword">null</span> ? installUser.getIdentifier() : <span class="number">0</span>;</span><br><span class="line">                </span><br><span class="line">                <span class="keyword">if</span> (users != <span class="keyword">null</span> &amp;&amp; allowInstall) &#123;</span><br><span class="line">                    <span class="keyword">for</span> (UserInfo user : users) &#123;</span><br><span class="line"></span><br><span class="line">                        <span class="keyword">final</span> <span class="keyword">boolean</span> installed = installUser == <span class="keyword">null</span></span><br><span class="line">                                || (installUserId == UserHandle.USER_ALL</span><br><span class="line">                                    &amp;&amp; !isAdbInstallDisallowed(userManager, user.id))</span><br><span class="line">                                || installUserId == user.id;</span><br><span class="line">                                </span><br><span class="line">                        p.setUserState(user.id, <span class="number">0</span>, COMPONENT_ENABLED_STATE_DEFAULT,</span><br><span class="line">                                installed,</span><br><span class="line">                                <span class="keyword">true</span>, <span class="comment">// stopped,</span></span><br><span class="line">                                <span class="keyword">true</span>, <span class="comment">// notLaunched</span></span><br><span class="line">                                <span class="keyword">false</span>, <span class="comment">// hidden</span></span><br><span class="line">                                <span class="keyword">false</span>, <span class="comment">// suspended</span></span><br><span class="line">                                <span class="keyword">null</span>, <span class="keyword">null</span>, <span class="keyword">null</span>,</span><br><span class="line">                                <span class="keyword">false</span>, <span class="comment">// blockUninstall</span></span><br><span class="line">                                INTENT_FILTER_DOMAIN_VERIFICATION_STATUS_UNDEFINED, <span class="number">0</span>);</span><br><span class="line">                            </span><br><span class="line">                        writePackageRestrictionsLPr(user.id);</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">            </span><br><span class="line">            <span class="comment">//【6】设置他的 appId，在默认设备用户下，appId 等于 uid！</span></span><br><span class="line">            <span class="keyword">if</span> (sharedUser != <span class="keyword">null</span>) &#123;</span><br><span class="line">                p.appId = sharedUser.userId;</span><br><span class="line"></span><br><span class="line">            &#125; <span class="keyword">else</span> &#123;</span><br><span class="line"></span><br><span class="line">                ... ... ... ...<span class="comment">// 根据前面的分析，显然 sharedUser 不为 null，不进入这个分支！</span></span><br><span class="line">            </span><br><span class="line">            &#125;</span><br><span class="line"> </span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (p.appId &lt; <span class="number">0</span>) &#123;</span><br><span class="line">            PackageManagerService.reportSettingsProblem(Log.WARN,</span><br><span class="line">                    <span class="string">"Package "</span> + name + <span class="string">" could not be assigned a valid uid"</span>);</span><br><span class="line">            <span class="keyword">return</span> <span class="keyword">null</span>;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (add) &#123; </span><br><span class="line"></span><br><span class="line">            <span class="comment">//【7】add 为 true，进入这个分支：</span></span><br><span class="line">            <span class="comment">// 将确定了共享用户 id 的 PackageSetting 对象，添加到 mPackages 中！</span></span><br><span class="line">            addPackageSettingLPw(p, name, sharedUser);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line"> </span><br><span class="line">        ... ... ... <span class="comment">// 这个分支也不走！</span></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> p;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>继续看：</p>
<h4 id="8-2-2-1-Settings-addPackageSettingLPw"><a href="#8-2-2-1-Settings-addPackageSettingLPw" class="headerlink" title="8.2.2.1 Settings.addPackageSettingLPw"></a>8.2.2.1 Settings.addPackageSettingLPw</h4><p>将确定了共享用户 id 的 PackageSetting 对象，添加到 mPackages 中！</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">addPackageSettingLPw</span><span class="params">(PackageSetting p, String name, SharedUserSetting sharedUser)</span> </span>&#123;</span><br><span class="line">    <span class="comment">//【1】添加到 mPackages 中！</span></span><br><span class="line">    mPackages.put(name, p);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (sharedUser != <span class="keyword">null</span>) &#123; <span class="comment">// 进入这里！</span></span><br><span class="line">        <span class="keyword">if</span> (p.sharedUser != <span class="keyword">null</span> &amp;&amp; p.sharedUser != sharedUser) &#123;</span><br><span class="line">            PackageManagerService.reportSettingsProblem(Log.ERROR,</span><br><span class="line">                    <span class="string">"Package "</span> + p.name + <span class="string">" was user "</span></span><br><span class="line">                    + p.sharedUser + <span class="string">" but is now "</span> + sharedUser</span><br><span class="line">                    + <span class="string">"; I am not changing its files so it will probably fail!"</span>);</span><br><span class="line">            p.sharedUser.removePackage(p);</span><br><span class="line"></span><br><span class="line">        &#125; <span class="keyword">else</span> <span class="keyword">if</span> (p.appId != sharedUser.userId) &#123;</span><br><span class="line">            PackageManagerService.reportSettingsProblem(Log.ERROR,</span><br><span class="line">                <span class="string">"Package "</span> + p.name + <span class="string">" was user id "</span> + p.appId</span><br><span class="line">                + <span class="string">" but is now user "</span> + sharedUser</span><br><span class="line">                + <span class="string">" with id "</span> + sharedUser.userId</span><br><span class="line">                + <span class="string">"; I am not changing its files so it will probably fail!"</span>);</span><br><span class="line">        &#125;</span><br><span class="line">        </span><br><span class="line">        <span class="comment">// 确保 sharedUser 和 PackageSetting 相互引用正确！</span></span><br><span class="line">        sharedUser.addPackage(p);</span><br><span class="line">        p.sharedUser = sharedUser;</span><br><span class="line">        p.appId = sharedUser.userId;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//【2】获得这个 package 对应的 SharedUserSetting 对象！</span></span><br><span class="line">    Object userIdPs = getUserIdLPr(p.appId);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (sharedUser == <span class="keyword">null</span>) &#123;</span><br><span class="line">        <span class="comment">//【2.1】如果 sharedUser 为 null，说明共享用户无效，那就将创建的 PackageSetting 添加进来！</span></span><br><span class="line">        <span class="keyword">if</span> (userIdPs != <span class="keyword">null</span> &amp;&amp; userIdPs != p) &#123;</span><br><span class="line">            replaceUserIdLPw(p.appId, p);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        <span class="comment">//【2.2】进入这个分支：</span></span><br><span class="line">        <span class="keyword">if</span> (userIdPs != <span class="keyword">null</span> &amp;&amp; userIdPs != sharedUser) &#123;</span><br><span class="line">            <span class="comment">// 更新 uid 和 SharedUserSetting 的关系！</span></span><br><span class="line">            replaceUserIdLPw(p.appId, sharedUser);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    IntentFilterVerificationInfo ivi = mRestoredIntentFilterVerifications.get(name);</span><br><span class="line">    <span class="keyword">if</span> (ivi != <span class="keyword">null</span>) &#123;</span><br><span class="line">        <span class="keyword">if</span> (DEBUG_DOMAIN_VERIFICATION) &#123;</span><br><span class="line">            Slog.i(TAG, <span class="string">"Applying restored IVI for "</span> + name + <span class="string">" : "</span> + ivi.getStatusString());</span><br><span class="line">        &#125;</span><br><span class="line">        mRestoredIntentFilterVerifications.remove(name);</span><br><span class="line">        p.setIntentFilterVerificationInfo(ivi);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>下面是 replaceUserIdLPw 方法：<br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"> <span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">replaceUserIdLPw</span><span class="params">(<span class="keyword">int</span> uid, Object obj)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">if</span> (uid &gt;= Process.FIRST_APPLICATION_UID) &#123;</span><br><span class="line">        <span class="keyword">final</span> <span class="keyword">int</span> N = mUserIds.size();</span><br><span class="line">        <span class="keyword">final</span> <span class="keyword">int</span> index = uid - Process.FIRST_APPLICATION_UID;</span><br><span class="line">        <span class="keyword">if</span> (index &lt; N) mUserIds.set(index, obj);</span><br><span class="line">        </span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        mOtherUserIds.put(uid, obj);</span><br><span class="line">        </span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<h2 id="8-3-读取-packages-stopped-xml-文件，偏好设置"><a href="#8-3-读取-packages-stopped-xml-文件，偏好设置" class="headerlink" title="8.3 读取 packages_stopped.xml 文件，偏好设置"></a>8.3 读取 packages_stopped.xml 文件，偏好设置</h2><p>代码段如下：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">if</span> (mBackupStoppedPackagesFilename.exists()</span><br><span class="line">        || mStoppedPackagesFilename.exists()) &#123;</span><br><span class="line">    <span class="comment">// Read old file</span></span><br><span class="line">    readStoppedLPw();</span><br><span class="line">    mBackupStoppedPackagesFilename.delete();</span><br><span class="line">    mStoppedPackagesFilename.delete();</span><br><span class="line">    <span class="comment">// Migrate to new file format</span></span><br><span class="line">    writePackageRestrictionsLPr(UserHandle.USER_SYSTEM);</span><br><span class="line">&#125; <span class="keyword">else</span> &#123;</span><br><span class="line">    <span class="keyword">for</span> (UserInfo user : users) &#123;</span><br><span class="line">        readPackageRestrictionsLPr(user.id);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>读取 packages_stopped.xml 文件调用的是 readStoppedLPw 方法：  </p>
<h3 id="8-3-1-Settings-readStoppedLPw"><a href="#8-3-1-Settings-readStoppedLPw" class="headerlink" title="8.3.1 Settings.readStoppedLPw"></a>8.3.1 Settings.readStoppedLPw</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">readStoppedLPw</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    FileInputStream str = <span class="keyword">null</span>;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">//【1】如果 packages-stopped-backup.xml 文件存在，就读取它！</span></span><br><span class="line">    <span class="keyword">if</span> (mBackupStoppedPackagesFilename.exists()) &#123;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            str = <span class="keyword">new</span> FileInputStream(mBackupStoppedPackagesFilename);</span><br><span class="line">            mReadMessages.append(<span class="string">"Reading from backup stopped packages file\n"</span>);</span><br><span class="line">            PackageManagerService.reportSettingsProblem(Log.INFO,</span><br><span class="line">                    <span class="string">"Need to read from backup stopped packages file"</span>);</span><br><span class="line">            <span class="keyword">if</span> (mSettingsFilename.exists()) &#123;</span><br><span class="line">                Slog.w(PackageManagerService.TAG, <span class="string">"Cleaning up stopped packages file "</span></span><br><span class="line">                        + mStoppedPackagesFilename);</span><br><span class="line">                        </span><br><span class="line">                <span class="comment">//【1.1】如果，两个文件都存在，使用 back_up 文件，删掉 packages-stopped.xml 文件！</span></span><br><span class="line">                mStoppedPackagesFilename.delete();</span><br><span class="line">            &#125;</span><br><span class="line">        &#125; <span class="keyword">catch</span> (java.io.IOException e) &#123;</span><br><span class="line">            <span class="comment">// We'll try for the normal settings file.</span></span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//【2】如果 packages-stopped-backup.xml 文件不存在，就读取 packages-stopped.xml 文件！</span></span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">        <span class="keyword">if</span> (str == <span class="keyword">null</span>) &#123;</span><br><span class="line">            <span class="keyword">if</span> (!mStoppedPackagesFilename.exists()) &#123;</span><br><span class="line">                ... ... ...<span class="comment">// log</span></span><br><span class="line">                </span><br><span class="line">                <span class="comment">//【2.1】如果  packages-stopped.xml 也不存在，说明没有 package 处于 stop 状态；</span></span><br><span class="line">                <span class="comment">// 同时，第一次开机，所有的 package 也都不会处于 stop 状态！</span></span><br><span class="line">                <span class="keyword">for</span> (PackageSetting pkg : mPackages.values()) &#123;</span><br><span class="line">                    pkg.setStopped(<span class="keyword">false</span>, <span class="number">0</span>); <span class="comment">// 没有被 stop！</span></span><br><span class="line">                    pkg.setNotLaunched(<span class="keyword">false</span>, <span class="number">0</span>); <span class="comment">// 也没有被启动过！</span></span><br><span class="line">                &#125;</span><br><span class="line">                <span class="keyword">return</span>;</span><br><span class="line">            &#125;</span><br><span class="line">            str = <span class="keyword">new</span> FileInputStream(mStoppedPackagesFilename);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">final</span> XmlPullParser parser = Xml.newPullParser();</span><br><span class="line">        parser.setInput(str, <span class="keyword">null</span>);</span><br><span class="line"></span><br><span class="line">        <span class="keyword">int</span> type;</span><br><span class="line">        <span class="keyword">while</span> ((type=parser.next()) != XmlPullParser.START_TAG</span><br><span class="line">                   &amp;&amp; type != XmlPullParser.END_DOCUMENT) &#123;</span><br><span class="line">            ;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (type != XmlPullParser.START_TAG) &#123;</span><br><span class="line">            mReadMessages.append(<span class="string">"No start tag found in stopped packages file\n"</span>);</span><br><span class="line">            PackageManagerService.reportSettingsProblem(Log.WARN,</span><br><span class="line">                    <span class="string">"No start tag found in package manager stopped packages"</span>);</span><br><span class="line">            <span class="keyword">return</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">//【3】开始解析！</span></span><br><span class="line">        <span class="keyword">int</span> outerDepth = parser.getDepth();</span><br><span class="line">        <span class="keyword">while</span> ((type=parser.next()) != XmlPullParser.END_DOCUMENT</span><br><span class="line">               &amp;&amp; (type != XmlPullParser.END_TAG</span><br><span class="line">                       || parser.getDepth() &gt; outerDepth)) &#123;</span><br><span class="line">            <span class="keyword">if</span> (type == XmlPullParser.END_TAG</span><br><span class="line">                    || type == XmlPullParser.TEXT) &#123;</span><br><span class="line">                <span class="keyword">continue</span>;</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            String tagName = parser.getName();</span><br><span class="line"></span><br><span class="line">            <span class="comment">//【3.1】解析 stop 的 package 数据！</span></span><br><span class="line">            <span class="keyword">if</span> (tagName.equals(TAG_PACKAGE)) &#123;</span><br><span class="line">                String name = parser.getAttributeValue(<span class="keyword">null</span>, ATTR_NAME); <span class="comment">// 解析 "name" 标签</span></span><br><span class="line">                </span><br><span class="line">                <span class="comment">// 从之前安装的 mPackages 中，获得包名为 name 的 package 数据！</span></span><br><span class="line">                PackageSetting ps = mPackages.get(name);</span><br><span class="line">                <span class="keyword">if</span> (ps != <span class="keyword">null</span>) &#123;</span><br><span class="line">                    <span class="comment">//【3.1.1】设置 stopped 属性！</span></span><br><span class="line">                    ps.setStopped(<span class="keyword">true</span>, <span class="number">0</span>);</span><br><span class="line">                    <span class="keyword">if</span> (<span class="string">"1"</span>.equals(parser.getAttributeValue(<span class="keyword">null</span>, ATTR_NOT_LAUNCHED))) &#123; <span class="comment">// 解析 "nl" 标签</span></span><br><span class="line">                        <span class="comment">//【3.1.2】设置 notLaunched 属性！</span></span><br><span class="line">                        ps.setNotLaunched(<span class="keyword">true</span>, <span class="number">0</span>);</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                    Slog.w(PackageManagerService.TAG,</span><br><span class="line">                            <span class="string">"No package known for stopped package "</span> + name);</span><br><span class="line">                &#125;</span><br><span class="line">                XmlUtils.skipCurrentTag(parser);</span><br><span class="line">            &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                Slog.w(PackageManagerService.TAG, <span class="string">"Unknown element under &lt;stopped-packages&gt;: "</span></span><br><span class="line">                      + parser.getName());</span><br><span class="line">                XmlUtils.skipCurrentTag(parser);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        str.close();</span><br><span class="line"></span><br><span class="line">    &#125; <span class="keyword">catch</span> (XmlPullParserException e) &#123;</span><br><span class="line">        ... ... ... ...</span><br><span class="line"></span><br><span class="line">    &#125; <span class="keyword">catch</span> (java.io.IOException e) &#123;</span><br><span class="line">        ... ... ... ...</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>这个过程很简单，解析 packages-stopped-backup.xml 或 packages-stopped.xml 文件，设置 package 的 stopped 和 notLaunched 属性！</p>
<h3 id="8-3-2-Settings-writePackageRestrictionsLPr"><a href="#8-3-2-Settings-writePackageRestrictionsLPr" class="headerlink" title="8.3.2 Settings.writePackageRestrictionsLPr"></a>8.3.2 Settings.writePackageRestrictionsLPr</h3><p>writePackageRestrictionsLPr 方法用户保存用户对于系统应用的一些偏好设置，通过获得 package 在指定用户下的状态信息，我们就知道那些应用被 stop，那些应用被 hidden 等等！</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">writePackageRestrictionsLPr</span><span class="params">(<span class="keyword">int</span> userId)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">if</span> (DEBUG_MU) &#123;</span><br><span class="line">        Log.i(TAG, <span class="string">"Writing package restrictions for user="</span> + userId);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 获得 data/system/users/0/package-restrictions.xml 文件对象！</span></span><br><span class="line">    File userPackagesStateFile = getUserPackagesStateFile(userId);</span><br><span class="line">    <span class="comment">// 获得 data/system/users/0/package-restrictions-backup.xml 文件对象！</span></span><br><span class="line">    File backupFile = getUserPackagesStateBackupFile(userId);</span><br><span class="line">    <span class="keyword">new</span> File(userPackagesStateFile.getParent()).mkdirs();</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// 如果备份文件不存在的话，那么我们会现将 package-restrictions.xml 备份再操作！</span></span><br><span class="line">    <span class="keyword">if</span> (userPackagesStateFile.exists()) &#123;</span><br><span class="line">        <span class="keyword">if</span> (!backupFile.exists()) &#123;</span><br><span class="line">            <span class="keyword">if</span> (!userPackagesStateFile.renameTo(backupFile)) &#123;</span><br><span class="line">                Slog.wtf(PackageManagerService.TAG,</span><br><span class="line">                        <span class="string">"Unable to backup user packages state file, "</span></span><br><span class="line">                        + <span class="string">"current changes will be lost at reboot"</span>);</span><br><span class="line">                <span class="keyword">return</span>;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            userPackagesStateFile.delete();</span><br><span class="line">            Slog.w(PackageManagerService.TAG, <span class="string">"Preserving older stopped packages backup"</span>);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// 开始解析 xml 文件！</span></span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">        <span class="keyword">final</span> FileOutputStream fstr = <span class="keyword">new</span> FileOutputStream(userPackagesStateFile);</span><br><span class="line">        <span class="keyword">final</span> BufferedOutputStream str = <span class="keyword">new</span> BufferedOutputStream(fstr);</span><br><span class="line"></span><br><span class="line">        <span class="keyword">final</span> XmlSerializer serializer = <span class="keyword">new</span> FastXmlSerializer();</span><br><span class="line">        serializer.setOutput(str, StandardCharsets.UTF_8.name());</span><br><span class="line">        serializer.startDocument(<span class="keyword">null</span>, <span class="keyword">true</span>);</span><br><span class="line">        serializer.setFeature(<span class="string">"http://xmlpull.org/v1/doc/features.html#indent-output"</span>, <span class="keyword">true</span>);</span><br><span class="line"></span><br><span class="line">        serializer.startTag(<span class="keyword">null</span>, TAG_PACKAGE_RESTRICTIONS); <span class="comment">// "package-restrictions" 标签</span></span><br><span class="line"></span><br><span class="line">        <span class="keyword">for</span> (<span class="keyword">final</span> PackageSetting pkg : mPackages.values()) &#123;</span><br><span class="line">            <span class="keyword">final</span> PackageUserState ustate = pkg.readUserState(userId);</span><br><span class="line">            <span class="keyword">if</span> (DEBUG_MU) Log.i(TAG, <span class="string">"  pkg="</span> + pkg.name + <span class="string">", state="</span> + ustate.enabled);</span><br><span class="line"></span><br><span class="line">            serializer.startTag(<span class="keyword">null</span>, TAG_PACKAGE); <span class="comment">// pkg 标签</span></span><br><span class="line">            serializer.attribute(<span class="keyword">null</span>, ATTR_NAME, pkg.name); <span class="comment">// name 属性</span></span><br><span class="line">            <span class="keyword">if</span> (ustate.ceDataInode != <span class="number">0</span>) &#123;</span><br><span class="line">                XmlUtils.writeLongAttribute(serializer, ATTR_CE_DATA_INODE, ustate.ceDataInode);</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">if</span> (!ustate.installed) &#123; </span><br><span class="line">                serializer.attribute(<span class="keyword">null</span>, ATTR_INSTALLED, <span class="string">"false"</span>); <span class="comment">// inst 属性</span></span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">if</span> (ustate.stopped) &#123;</span><br><span class="line">                serializer.attribute(<span class="keyword">null</span>, ATTR_STOPPED, <span class="string">"true"</span>); <span class="comment">// stopped 属性</span></span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">if</span> (ustate.notLaunched) &#123;</span><br><span class="line">                serializer.attribute(<span class="keyword">null</span>, ATTR_NOT_LAUNCHED, <span class="string">"true"</span>); <span class="comment">// nl 属性</span></span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">if</span> (ustate.hidden) &#123;</span><br><span class="line">                serializer.attribute(<span class="keyword">null</span>, ATTR_HIDDEN, <span class="string">"true"</span>); <span class="comment">// hidden 属性</span></span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">if</span> (ustate.suspended) &#123;</span><br><span class="line">                serializer.attribute(<span class="keyword">null</span>, ATTR_SUSPENDED, <span class="string">"true"</span>); <span class="comment">// suspended 属性</span></span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">if</span> (ustate.blockUninstall) &#123;</span><br><span class="line">                serializer.attribute(<span class="keyword">null</span>, ATTR_BLOCK_UNINSTALL, <span class="string">"true"</span>); <span class="comment">// blockUninstall 属性</span></span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">if</span> (ustate.enabled != COMPONENT_ENABLED_STATE_DEFAULT) &#123; <span class="comment">// 包默认是否可用</span></span><br><span class="line">                serializer.attribute(<span class="keyword">null</span>, ATTR_ENABLED, <span class="comment">// enabled 属性</span></span><br><span class="line">                        Integer.toString(ustate.enabled));</span><br><span class="line">                <span class="keyword">if</span> (ustate.lastDisableAppCaller != <span class="keyword">null</span>) &#123;</span><br><span class="line">                    serializer.attribute(<span class="keyword">null</span>, ATTR_ENABLED_CALLER, <span class="comment">// enabledCaller 属性</span></span><br><span class="line">                            ustate.lastDisableAppCaller);</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">if</span> (ustate.domainVerificationStatus !=</span><br><span class="line">                    PackageManager.INTENT_FILTER_DOMAIN_VERIFICATION_STATUS_UNDEFINED) &#123;</span><br><span class="line">                XmlUtils.writeIntAttribute(serializer, ATTR_DOMAIN_VERIFICATON_STATE,</span><br><span class="line">                        ustate.domainVerificationStatus);</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">if</span> (ustate.appLinkGeneration != <span class="number">0</span>) &#123;</span><br><span class="line">                XmlUtils.writeIntAttribute(serializer, ATTR_APP_LINK_GENERATION,</span><br><span class="line">                        ustate.appLinkGeneration);</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">if</span> (!ArrayUtils.isEmpty(ustate.enabledComponents)) &#123; <span class="comment">// 可用组件</span></span><br><span class="line">                serializer.startTag(<span class="keyword">null</span>, TAG_ENABLED_COMPONENTS);</span><br><span class="line">                <span class="keyword">for</span> (<span class="keyword">final</span> String name : ustate.enabledComponents) &#123;</span><br><span class="line">                    serializer.startTag(<span class="keyword">null</span>, TAG_ITEM);</span><br><span class="line">                    serializer.attribute(<span class="keyword">null</span>, ATTR_NAME, name);</span><br><span class="line">                    serializer.endTag(<span class="keyword">null</span>, TAG_ITEM);</span><br><span class="line">                &#125;</span><br><span class="line">                serializer.endTag(<span class="keyword">null</span>, TAG_ENABLED_COMPONENTS);</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">if</span> (!ArrayUtils.isEmpty(ustate.disabledComponents)) &#123; <span class="comment">// 不可用组件</span></span><br><span class="line">                serializer.startTag(<span class="keyword">null</span>, TAG_DISABLED_COMPONENTS);</span><br><span class="line">                <span class="keyword">for</span> (<span class="keyword">final</span> String name : ustate.disabledComponents) &#123;</span><br><span class="line">                    serializer.startTag(<span class="keyword">null</span>, TAG_ITEM);</span><br><span class="line">                    serializer.attribute(<span class="keyword">null</span>, ATTR_NAME, name);</span><br><span class="line">                    serializer.endTag(<span class="keyword">null</span>, TAG_ITEM);</span><br><span class="line">                &#125;</span><br><span class="line">                serializer.endTag(<span class="keyword">null</span>, TAG_DISABLED_COMPONENTS);</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            serializer.endTag(<span class="keyword">null</span>, TAG_PACKAGE);</span><br><span class="line">        &#125;</span><br><span class="line">        </span><br><span class="line">        <span class="comment">// 接下来会处理默认应用的处理，这里先不看！</span></span><br><span class="line">        writePreferredActivitiesLPr(serializer, userId, <span class="keyword">true</span>);</span><br><span class="line">        writePersistentPreferredActivitiesLPr(serializer, userId);</span><br><span class="line">        writeCrossProfileIntentFiltersLPr(serializer, userId);</span><br><span class="line">        writeDefaultAppsLPr(serializer, userId);</span><br><span class="line"></span><br><span class="line">        serializer.endTag(<span class="keyword">null</span>, TAG_PACKAGE_RESTRICTIONS);</span><br><span class="line"></span><br><span class="line">        serializer.endDocument();</span><br><span class="line"></span><br><span class="line">        str.flush();</span><br><span class="line">        FileUtils.sync(fstr);</span><br><span class="line">        str.close();</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 删除备份文件，并设置主文件的权限！</span></span><br><span class="line">        backupFile.delete();</span><br><span class="line">        FileUtils.setPermissions(userPackagesStateFile.toString(),</span><br><span class="line">                FileUtils.S_IRUSR|FileUtils.S_IWUSR</span><br><span class="line">                |FileUtils.S_IRGRP|FileUtils.S_IWGRP,</span><br><span class="line">                -<span class="number">1</span>, -<span class="number">1</span>);</span><br><span class="line"></span><br><span class="line">        <span class="comment">// Done, all is good!</span></span><br><span class="line">        <span class="keyword">return</span>;</span><br><span class="line">    &#125; <span class="keyword">catch</span>(java.io.IOException e) &#123;</span><br><span class="line">        Slog.wtf(PackageManagerService.TAG,</span><br><span class="line">                <span class="string">"Unable to write package manager user packages state, "</span></span><br><span class="line">                + <span class="string">" current changes will be lost at reboot"</span>, e);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 异常情况，清除偏好设置文件！</span></span><br><span class="line">    <span class="keyword">if</span> (userPackagesStateFile.exists()) &#123;</span><br><span class="line">        <span class="keyword">if</span> (!userPackagesStateFile.delete()) &#123;</span><br><span class="line">            Log.i(PackageManagerService.TAG, <span class="string">"Failed to clean up mangled file: "</span></span><br><span class="line">                    + mStoppedPackagesFilename);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>我们来看下偏好设置的 xml 的内容！</p>
<figure class="highlight"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line">&lt;?xml version=<span class="string">'1.0'</span> encoding=<span class="string">'utf-8'</span> standalone=<span class="string">'yes'</span> ?&gt;</span><br><span class="line">&lt;<span class="keyword">package</span>-restrictions&gt;</span><br><span class="line">    &lt;pkg name=<span class="string">"com.papapa.activation"</span> ceDataInode=<span class="string">"3940"</span>&gt;</span><br><span class="line">        &lt;disabled-components&gt;</span><br><span class="line">            &lt;item name=<span class="string">"com.papapa.activation.BootReceiver"</span> /&gt;</span><br><span class="line">        &lt;/disabled-components&gt;</span><br><span class="line">    &lt;/pkg&gt;</span><br><span class="line"></span><br><span class="line">    &lt;preferred-activities&gt;</span><br><span class="line">        &lt;item name=<span class="string">"com.android.mms/.ui.ComposeMessageActivity"</span> match=<span class="string">"200000"</span> always=<span class="string">"true"</span> set=<span class="string">"1"</span>&gt;</span><br><span class="line">            &lt;set name=<span class="string">"com.android.mms/.ui.ComposeMessageActivity"</span> /&gt;</span><br><span class="line">            &lt;filter&gt;</span><br><span class="line">                &lt;action name=<span class="string">"android.intent.action.SENDTO"</span> /&gt;</span><br><span class="line">                &lt;cat name=<span class="string">"android.intent.category.DEFAULT"</span> /&gt;</span><br><span class="line">                &lt;scheme name=<span class="string">"mmsto"</span> /&gt;</span><br><span class="line">            &lt;/filter&gt;</span><br><span class="line">        &lt;/item&gt;</span><br><span class="line">    &lt;/preferred-activities&gt;</span><br><span class="line">    &lt;persistent-preferred-activities /&gt;</span><br><span class="line">    &lt;crossProfile-intent-filters /&gt;</span><br><span class="line">    &lt;<span class="keyword">default</span>-apps&gt;</span><br><span class="line">        &lt;<span class="keyword">default</span>-dialer packageName=<span class="string">"com.android.contacts"</span> /&gt;</span><br><span class="line">    &lt;/default-apps&gt;</span><br><span class="line">&lt;/package-restrictions&gt;</span><br></pre></td></tr></table></figure>
<p>这里只列出了一部分的内容，其他的很类似，不再多说！</p>
<h3 id="8-3-3-Settings-readPackageRestrictionsLPr"><a href="#8-3-3-Settings-readPackageRestrictionsLPr" class="headerlink" title="8.3.3 Settings.readPackageRestrictionsLPr"></a>8.3.3 Settings.readPackageRestrictionsLPr</h3><p>该方法用于读取已有的偏好设置，更新 package 安装的信息！<br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">readPackageRestrictionsLPr</span><span class="params">(<span class="keyword">int</span> userId)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">if</span> (DEBUG_MU) &#123;</span><br><span class="line">        Log.i(TAG, <span class="string">"Reading package restrictions for user="</span> + userId);</span><br><span class="line">    &#125;</span><br><span class="line">    FileInputStream str = <span class="keyword">null</span>;</span><br><span class="line">    <span class="comment">// 同样的，获得 data/system/users/0/package-restrictions.xml 和 </span></span><br><span class="line">    <span class="comment">// data/system/users/0/package-restrictions-backup.xml 文件对象！</span></span><br><span class="line">    File userPackagesStateFile = getUserPackagesStateFile(userId);</span><br><span class="line">    File backupFile = getUserPackagesStateBackupFile(userId);</span><br><span class="line">    <span class="comment">// 优先从 backupFile 读取，如果两个文件都存在，那就会删除非备份文件！</span></span><br><span class="line">    <span class="keyword">if</span> (backupFile.exists()) &#123;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            str = <span class="keyword">new</span> FileInputStream(backupFile);</span><br><span class="line">            mReadMessages.append(<span class="string">"Reading from backup stopped packages file\n"</span>);</span><br><span class="line">            PackageManagerService.reportSettingsProblem(Log.INFO,</span><br><span class="line">                    <span class="string">"Need to read from backup stopped packages file"</span>);</span><br><span class="line">            <span class="keyword">if</span> (userPackagesStateFile.exists()) &#123;</span><br><span class="line">                Slog.w(PackageManagerService.TAG, <span class="string">"Cleaning up stopped packages file "</span></span><br><span class="line">                        + userPackagesStateFile);</span><br><span class="line">                userPackagesStateFile.delete();</span><br><span class="line">            &#125;</span><br><span class="line">        &#125; <span class="keyword">catch</span> (java.io.IOException e) &#123;</span><br><span class="line">            <span class="comment">// We'll try for the normal settings file.</span></span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">        <span class="keyword">if</span> (str == <span class="keyword">null</span>) &#123;</span><br><span class="line">            <span class="keyword">if</span> (!userPackagesStateFile.exists()) &#123;</span><br><span class="line">                mReadMessages.append(<span class="string">"No stopped packages file found\n"</span>);</span><br><span class="line">                PackageManagerService.reportSettingsProblem(Log.INFO,</span><br><span class="line">                        <span class="string">"No stopped packages file; "</span></span><br><span class="line">                        + <span class="string">"assuming all started"</span>);</span><br><span class="line">                <span class="comment">// 对于第一次启动，这里会初始化操作，并返回！！</span></span><br><span class="line">                <span class="keyword">for</span> (PackageSetting pkg : mPackages.values()) &#123;</span><br><span class="line">                    pkg.setUserState(userId, <span class="number">0</span>, COMPONENT_ENABLED_STATE_DEFAULT,</span><br><span class="line">                            <span class="keyword">true</span>,   <span class="comment">// installed</span></span><br><span class="line">                            <span class="keyword">false</span>,  <span class="comment">// stopped</span></span><br><span class="line">                            <span class="keyword">false</span>,  <span class="comment">// notLaunched</span></span><br><span class="line">                            <span class="keyword">false</span>,  <span class="comment">// hidden</span></span><br><span class="line">                            <span class="keyword">false</span>,  <span class="comment">// suspended</span></span><br><span class="line">                            <span class="keyword">null</span>, <span class="keyword">null</span>, <span class="keyword">null</span>,</span><br><span class="line">                            <span class="keyword">false</span>, <span class="comment">// blockUninstall</span></span><br><span class="line">                            INTENT_FILTER_DOMAIN_VERIFICATION_STATUS_UNDEFINED, <span class="number">0</span>);</span><br><span class="line">                &#125;</span><br><span class="line">                <span class="keyword">return</span>;</span><br><span class="line">            &#125;</span><br><span class="line">            str = <span class="keyword">new</span> FileInputStream(userPackagesStateFile);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">final</span> XmlPullParser parser = Xml.newPullParser();</span><br><span class="line">        parser.setInput(str, StandardCharsets.UTF_8.name());</span><br><span class="line"></span><br><span class="line">        <span class="keyword">int</span> type;</span><br><span class="line">        <span class="keyword">while</span> ((type=parser.next()) != XmlPullParser.START_TAG</span><br><span class="line">                   &amp;&amp; type != XmlPullParser.END_DOCUMENT) &#123;</span><br><span class="line">            ;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (type != XmlPullParser.START_TAG) &#123;</span><br><span class="line">            mReadMessages.append(<span class="string">"No start tag found in package restrictions file\n"</span>);</span><br><span class="line">            PackageManagerService.reportSettingsProblem(Log.WARN,</span><br><span class="line">                    <span class="string">"No start tag found in package manager stopped packages"</span>);</span><br><span class="line">            <span class="keyword">return</span>;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">int</span> maxAppLinkGeneration = <span class="number">0</span>;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">int</span> outerDepth = parser.getDepth();</span><br><span class="line">        PackageSetting ps = <span class="keyword">null</span>;</span><br><span class="line">        <span class="keyword">while</span> ((type=parser.next()) != XmlPullParser.END_DOCUMENT</span><br><span class="line">               &amp;&amp; (type != XmlPullParser.END_TAG</span><br><span class="line">                       || parser.getDepth() &gt; outerDepth)) &#123;</span><br><span class="line">            <span class="keyword">if</span> (type == XmlPullParser.END_TAG</span><br><span class="line">                    || type == XmlPullParser.TEXT) &#123;</span><br><span class="line">                <span class="keyword">continue</span>;</span><br><span class="line">            &#125;</span><br><span class="line">            </span><br><span class="line">            <span class="comment">//【1】解析 pkg 标签的属性！</span></span><br><span class="line">            String tagName = parser.getName();</span><br><span class="line">            <span class="keyword">if</span> (tagName.equals(TAG_PACKAGE)) &#123;</span><br><span class="line">                String name = parser.getAttributeValue(<span class="keyword">null</span>, ATTR_NAME);</span><br><span class="line">                ps = mPackages.get(name);</span><br><span class="line">                <span class="keyword">if</span> (ps == <span class="keyword">null</span>) &#123;</span><br><span class="line">                    Slog.w(PackageManagerService.TAG, <span class="string">"No package known for stopped package "</span></span><br><span class="line">                            + name);</span><br><span class="line">                    XmlUtils.skipCurrentTag(parser);</span><br><span class="line">                    <span class="keyword">continue</span>;</span><br><span class="line">                &#125;</span><br><span class="line"></span><br><span class="line">                <span class="keyword">final</span> <span class="keyword">long</span> ceDataInode = XmlUtils.readLongAttribute(parser, ATTR_CE_DATA_INODE,</span><br><span class="line">                        <span class="number">0</span>);</span><br><span class="line">                <span class="keyword">final</span> <span class="keyword">boolean</span> installed = XmlUtils.readBooleanAttribute(parser, ATTR_INSTALLED,</span><br><span class="line">                        <span class="keyword">true</span>);</span><br><span class="line">                <span class="keyword">final</span> <span class="keyword">boolean</span> stopped = XmlUtils.readBooleanAttribute(parser, ATTR_STOPPED,</span><br><span class="line">                        <span class="keyword">false</span>);</span><br><span class="line">                <span class="keyword">final</span> <span class="keyword">boolean</span> notLaunched = XmlUtils.readBooleanAttribute(parser,</span><br><span class="line">                        ATTR_NOT_LAUNCHED, <span class="keyword">false</span>);</span><br><span class="line"></span><br><span class="line">                <span class="comment">// For backwards compatibility with the previous name of "blocked", which</span></span><br><span class="line">                <span class="comment">// now means hidden, read the old attribute as well.</span></span><br><span class="line">                <span class="keyword">final</span> String blockedStr = parser.getAttributeValue(<span class="keyword">null</span>, ATTR_BLOCKED);</span><br><span class="line">                <span class="keyword">boolean</span> hidden = blockedStr == <span class="keyword">null</span></span><br><span class="line">                        ? <span class="keyword">false</span> : Boolean.parseBoolean(blockedStr);</span><br><span class="line">                <span class="keyword">final</span> String hiddenStr = parser.getAttributeValue(<span class="keyword">null</span>, ATTR_HIDDEN);</span><br><span class="line">                hidden = hiddenStr == <span class="keyword">null</span></span><br><span class="line">                        ? hidden : Boolean.parseBoolean(hiddenStr);</span><br><span class="line"></span><br><span class="line">                <span class="keyword">final</span> <span class="keyword">boolean</span> suspended = XmlUtils.readBooleanAttribute(parser, ATTR_SUSPENDED,</span><br><span class="line">                        <span class="keyword">false</span>);</span><br><span class="line">                <span class="keyword">final</span> <span class="keyword">boolean</span> blockUninstall = XmlUtils.readBooleanAttribute(parser,</span><br><span class="line">                        ATTR_BLOCK_UNINSTALL, <span class="keyword">false</span>);</span><br><span class="line">                <span class="keyword">final</span> <span class="keyword">int</span> enabled = XmlUtils.readIntAttribute(parser, ATTR_ENABLED,</span><br><span class="line">                        COMPONENT_ENABLED_STATE_DEFAULT);</span><br><span class="line">                <span class="keyword">final</span> String enabledCaller = parser.getAttributeValue(<span class="keyword">null</span>,</span><br><span class="line">                        ATTR_ENABLED_CALLER);</span><br><span class="line"></span><br><span class="line">                <span class="keyword">final</span> <span class="keyword">int</span> verifState = XmlUtils.readIntAttribute(parser,</span><br><span class="line">                        ATTR_DOMAIN_VERIFICATON_STATE,</span><br><span class="line">                        PackageManager.INTENT_FILTER_DOMAIN_VERIFICATION_STATUS_UNDEFINED);</span><br><span class="line">                <span class="keyword">final</span> <span class="keyword">int</span> linkGeneration = XmlUtils.readIntAttribute(parser,</span><br><span class="line">                        ATTR_APP_LINK_GENERATION, <span class="number">0</span>);</span><br><span class="line">                <span class="keyword">if</span> (linkGeneration &gt; maxAppLinkGeneration) &#123;</span><br><span class="line">                    maxAppLinkGeneration = linkGeneration;</span><br><span class="line">                &#125;</span><br><span class="line"></span><br><span class="line">                ArraySet&lt;String&gt; enabledComponents = <span class="keyword">null</span>;</span><br><span class="line">                ArraySet&lt;String&gt; disabledComponents = <span class="keyword">null</span>;</span><br><span class="line"></span><br><span class="line">                <span class="keyword">int</span> packageDepth = parser.getDepth();</span><br><span class="line">                <span class="keyword">while</span> ((type=parser.next()) != XmlPullParser.END_DOCUMENT</span><br><span class="line">                        &amp;&amp; (type != XmlPullParser.END_TAG</span><br><span class="line">                        || parser.getDepth() &gt; packageDepth)) &#123;</span><br><span class="line">                    <span class="keyword">if</span> (type == XmlPullParser.END_TAG</span><br><span class="line">                            || type == XmlPullParser.TEXT) &#123;</span><br><span class="line">                        <span class="keyword">continue</span>;</span><br><span class="line">                    &#125;</span><br><span class="line">                    tagName = parser.getName();</span><br><span class="line">                    <span class="keyword">if</span> (tagName.equals(TAG_ENABLED_COMPONENTS)) &#123;</span><br><span class="line">                        enabledComponents = readComponentsLPr(parser);</span><br><span class="line">                    &#125; <span class="keyword">else</span> <span class="keyword">if</span> (tagName.equals(TAG_DISABLED_COMPONENTS)) &#123;</span><br><span class="line">                        disabledComponents = readComponentsLPr(parser);</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;</span><br><span class="line">                <span class="comment">//【2】通过解析到的偏好设置，来更新安装的 package 的信息！</span></span><br><span class="line">                ps.setUserState(userId, ceDataInode, enabled, installed, stopped, notLaunched,</span><br><span class="line">                        hidden, suspended, enabledCaller, enabledComponents, disabledComponents,</span><br><span class="line">                        blockUninstall, verifState, linkGeneration);</span><br><span class="line">            &#125; <span class="keyword">else</span> <span class="keyword">if</span> (tagName.equals(<span class="string">"preferred-activities"</span>)) &#123; <span class="comment">// 解析默认应用的属性！</span></span><br><span class="line">                readPreferredActivitiesLPw(parser, userId);</span><br><span class="line">            &#125; <span class="keyword">else</span> <span class="keyword">if</span> (tagName.equals(TAG_PERSISTENT_PREFERRED_ACTIVITIES)) &#123;</span><br><span class="line">                readPersistentPreferredActivitiesLPw(parser, userId);</span><br><span class="line">            &#125; <span class="keyword">else</span> <span class="keyword">if</span> (tagName.equals(TAG_CROSS_PROFILE_INTENT_FILTERS)) &#123;</span><br><span class="line">                readCrossProfileIntentFiltersLPw(parser, userId);</span><br><span class="line">            &#125; <span class="keyword">else</span> <span class="keyword">if</span> (tagName.equals(TAG_DEFAULT_APPS)) &#123;</span><br><span class="line">                readDefaultAppsLPw(parser, userId);</span><br><span class="line">            &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                Slog.w(PackageManagerService.TAG, <span class="string">"Unknown element under &lt;stopped-packages&gt;: "</span></span><br><span class="line">                      + parser.getName());</span><br><span class="line">                XmlUtils.skipCurrentTag(parser);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        str.close();</span><br><span class="line"></span><br><span class="line">        mNextAppLinkGeneration.put(userId, maxAppLinkGeneration + <span class="number">1</span>);</span><br><span class="line"></span><br><span class="line">    &#125; <span class="keyword">catch</span> (XmlPullParserException e) &#123;</span><br><span class="line">        mReadMessages.append(<span class="string">"Error reading: "</span> + e.toString());</span><br><span class="line">        PackageManagerService.reportSettingsProblem(Log.ERROR,</span><br><span class="line">                <span class="string">"Error reading stopped packages: "</span> + e);</span><br><span class="line">        Slog.wtf(PackageManagerService.TAG, <span class="string">"Error reading package manager stopped packages"</span>,</span><br><span class="line">                e);</span><br><span class="line"></span><br><span class="line">    &#125; <span class="keyword">catch</span> (java.io.IOException e) &#123;</span><br><span class="line">        mReadMessages.append(<span class="string">"Error reading: "</span> + e.toString());</span><br><span class="line">        PackageManagerService.reportSettingsProblem(Log.ERROR, <span class="string">"Error reading settings: "</span> + e);</span><br><span class="line">        Slog.wtf(PackageManagerService.TAG, <span class="string">"Error reading package manager stopped packages"</span>,</span><br><span class="line">                e);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>逻辑很简单，我们就不多说了！</p>
<h2 id="8-4-读取运行时权限信息，并处理授予情况！"><a href="#8-4-读取运行时权限信息，并处理授予情况！" class="headerlink" title="8.4 读取运行时权限信息，并处理授予情况！"></a>8.4 读取运行时权限信息，并处理授予情况！</h2><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//【8.4】读取每个 user 下的运行是权限信息！</span></span><br><span class="line"><span class="keyword">for</span> (UserInfo user : users) &#123;</span><br><span class="line">    mRuntimePermissionsPersistence.readStateForUserSyncLPr(user.id);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>mRuntimePermissionsPersistence 对象我们前面介绍过，其专门用于处理运行时权限！</p>
<h3 id="8-4-1-RuntimePermissionsPersistence-readStateForUserSyncLPr"><a href="#8-4-1-RuntimePermissionsPersistence-readStateForUserSyncLPr" class="headerlink" title="8.4.1 RuntimePermissionsPersistence.readStateForUserSyncLPr"></a>8.4.1 RuntimePermissionsPersistence.readStateForUserSyncLPr</h3><p>该方法会读取指定的 userId 下的运行时权限信息！</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">readStateForUserSyncLPr</span><span class="params">(<span class="keyword">int</span> userId)</span> </span>&#123;</span><br><span class="line">    <span class="comment">//【1】获得运行时权限文件对象！</span></span><br><span class="line">    File permissionsFile = getUserRuntimePermissionsFile(userId);</span><br><span class="line">    <span class="keyword">if</span> (!permissionsFile.exists()) &#123;</span><br><span class="line">        <span class="keyword">return</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    FileInputStream in;</span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">        in = <span class="keyword">new</span> AtomicFile(permissionsFile).openRead();</span><br><span class="line">    &#125; <span class="keyword">catch</span> (FileNotFoundException fnfe) &#123;</span><br><span class="line">        Slog.i(PackageManagerService.TAG, <span class="string">"No permissions state"</span>);</span><br><span class="line">        <span class="keyword">return</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">        XmlPullParser parser = Xml.newPullParser();</span><br><span class="line">        parser.setInput(in, <span class="keyword">null</span>);</span><br><span class="line">        <span class="comment">// 解析运行时权限数据！</span></span><br><span class="line">        parseRuntimePermissionsLPr(parser, userId);</span><br><span class="line"></span><br><span class="line">    &#125; <span class="keyword">catch</span> (XmlPullParserException | IOException e) &#123;</span><br><span class="line">        <span class="keyword">throw</span> <span class="keyword">new</span> IllegalStateException(<span class="string">"Failed parsing permissions file: "</span></span><br><span class="line">                + permissionsFile , e);</span><br><span class="line">    &#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">        IoUtils.closeQuietly(in);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>首先，会获得保存了运行时权限的文件对象！<br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">private</span> File <span class="title">getUserRuntimePermissionsFile</span><span class="params">(<span class="keyword">int</span> userId)</span> </span>&#123;</span><br><span class="line">    File userDir = <span class="keyword">new</span> File(<span class="keyword">new</span> File(mSystemDir, <span class="string">"users"</span>), Integer.toString(userId));</span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">new</span> File(userDir, RUNTIME_PERMISSIONS_FILE_NAME);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>该文件位于 /data/system/users/0/runtime-permissions.xml，和偏好设置的文件位于同一个目录下，我们来简单的看下该文件的具体内容：</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">&lt;?xml version='1.0' encoding='UTF-8' standalone='yes' ?&gt;</span><br><span class="line"><span class="tag">&lt;<span class="name">runtime-permissions</span> <span class="attr">fingerprint</span>=<span class="string">"OPPO/R11s/R11s:8.1.0/OPM1.171019.011/1519198279:user/release-keys"</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">pkg</span> <span class="attr">name</span>=<span class="string">"com.sohu.inputmethod.sogouoem"</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">item</span> <span class="attr">name</span>=<span class="string">"android.permission.ACCESS_FINE_LOCATION"</span> <span class="attr">granted</span>=<span class="string">"true"</span> <span class="attr">flags</span>=<span class="string">"20"</span> /&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">item</span> <span class="attr">name</span>=<span class="string">"android.permission.READ_EXTERNAL_STORAGE"</span> <span class="attr">granted</span>=<span class="string">"true"</span> <span class="attr">flags</span>=<span class="string">"20"</span> /&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">item</span> <span class="attr">name</span>=<span class="string">"android.permission.ACCESS_COARSE_LOCATION"</span> <span class="attr">granted</span>=<span class="string">"true"</span> <span class="attr">flags</span>=<span class="string">"20"</span> /&gt;</span></span><br><span class="line">    ... ... ...</span><br><span class="line">  <span class="tag">&lt;/<span class="name">pkg</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">shared-user</span> <span class="attr">name</span>=<span class="string">"android.uid.calendar"</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">item</span> <span class="attr">name</span>=<span class="string">"android.permission.READ_CALENDAR"</span> <span class="attr">granted</span>=<span class="string">"true"</span> <span class="attr">flags</span>=<span class="string">"20"</span> /&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">item</span> <span class="attr">name</span>=<span class="string">"android.permission.ACCESS_FINE_LOCATION"</span> <span class="attr">granted</span>=<span class="string">"true"</span> <span class="attr">flags</span>=<span class="string">"20"</span> /&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">item</span> <span class="attr">name</span>=<span class="string">"android.permission.READ_EXTERNAL_STORAGE"</span> <span class="attr">granted</span>=<span class="string">"true"</span> <span class="attr">flags</span>=<span class="string">"20"</span> /&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">item</span> <span class="attr">name</span>=<span class="string">"android.permission.ACCESS_COARSE_LOCATION"</span> <span class="attr">granted</span>=<span class="string">"true"</span> <span class="attr">flags</span>=<span class="string">"20"</span> /&gt;</span></span><br><span class="line">    ... ... ...</span><br><span class="line"><span class="tag">&lt;/<span class="name">runtime-permissions</span>&gt;</span></span><br></pre></td></tr></table></figure>
<h3 id="8-4-2-Settings-parseRuntimePermissionsLPr"><a href="#8-4-2-Settings-parseRuntimePermissionsLPr" class="headerlink" title="8.4.2 Settings.parseRuntimePermissionsLPr"></a>8.4.2 Settings.parseRuntimePermissionsLPr</h3><p>用于解析运行时权限文件，获得运行时权限相关的信息！<br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">parseRuntimePermissionsLPr</span><span class="params">(XmlPullParser parser, <span class="keyword">int</span> userId)</span></span></span><br><span class="line"><span class="function">        <span class="keyword">throws</span> IOException, XmlPullParserException </span>&#123;</span><br><span class="line">    <span class="keyword">final</span> <span class="keyword">int</span> outerDepth = parser.getDepth();</span><br><span class="line">    <span class="keyword">int</span> type;</span><br><span class="line">    <span class="keyword">while</span> ((type = parser.next()) != XmlPullParser.END_DOCUMENT</span><br><span class="line">            &amp;&amp; (type != XmlPullParser.END_TAG || parser.getDepth() &gt; outerDepth)) &#123;</span><br><span class="line">        <span class="keyword">if</span> (type == XmlPullParser.END_TAG || type == XmlPullParser.TEXT) &#123;</span><br><span class="line">            <span class="keyword">continue</span>;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">switch</span> (parser.getName()) &#123;</span><br><span class="line">            <span class="keyword">case</span> TAG_RUNTIME_PERMISSIONS: &#123; <span class="comment">// runtime-permissions 标签</span></span><br><span class="line">                String fingerprint = parser.getAttributeValue(<span class="keyword">null</span>, ATTR_FINGERPRINT); <span class="comment">// fingerprint 属性</span></span><br><span class="line">                mFingerprints.put(userId, fingerprint); <span class="comment">// 保存 fingerprint 到 mFingerprints 中！</span></span><br><span class="line">                <span class="comment">// 然后判断是否对该设备用户授予默认的权限，添加到 mDefaultPermissionsGranted 中！</span></span><br><span class="line">                <span class="keyword">final</span> <span class="keyword">boolean</span> defaultsGranted = Build.FINGERPRINT.equals(fingerprint);</span><br><span class="line">                mDefaultPermissionsGranted.put(userId, defaultsGranted);</span><br><span class="line">            &#125; <span class="keyword">break</span>;</span><br><span class="line"></span><br><span class="line">            <span class="keyword">case</span> TAG_PACKAGE: &#123;  <span class="comment">//【1】pkg 标签</span></span><br><span class="line">                String name = parser.getAttributeValue(<span class="keyword">null</span>, ATTR_NAME);</span><br><span class="line">                PackageSetting ps = mPackages.get(name);</span><br><span class="line">                <span class="keyword">if</span> (ps == <span class="keyword">null</span>) &#123;</span><br><span class="line">                    Slog.w(PackageManagerService.TAG, <span class="string">"Unknown package:"</span> + name);</span><br><span class="line">                    XmlUtils.skipCurrentTag(parser);</span><br><span class="line">                    <span class="keyword">continue</span>;</span><br><span class="line">                &#125;</span><br><span class="line">                <span class="comment">//【8.4.2.1】解析并处理 package 的运行时权限授予情况！</span></span><br><span class="line">                parsePermissionsLPr(parser, ps.getPermissionsState(), userId);</span><br><span class="line">            &#125; <span class="keyword">break</span>;</span><br><span class="line"></span><br><span class="line">            <span class="keyword">case</span> TAG_SHARED_USER: &#123;   <span class="comment">//【2】shared-user 标签</span></span><br><span class="line">                String name = parser.getAttributeValue(<span class="keyword">null</span>, ATTR_NAME);</span><br><span class="line">                SharedUserSetting sus = mSharedUsers.get(name);</span><br><span class="line">                <span class="keyword">if</span> (sus == <span class="keyword">null</span>) &#123;</span><br><span class="line">                    Slog.w(PackageManagerService.TAG, <span class="string">"Unknown shared user:"</span> + name);</span><br><span class="line">                    XmlUtils.skipCurrentTag(parser);</span><br><span class="line">                    <span class="keyword">continue</span>;</span><br><span class="line">                &#125;</span><br><span class="line">                <span class="comment">//【8.4.2.1】解析并处理 shared-user 的运行时权限授予情况！</span></span><br><span class="line">                parsePermissionsLPr(parser, sus.getPermissionsState(), userId);</span><br><span class="line">            &#125; <span class="keyword">break</span>;</span><br><span class="line"></span><br><span class="line">            <span class="keyword">case</span> TAG_RESTORED_RUNTIME_PERMISSIONS: &#123; <span class="comment">//【3】restored-perms 标签</span></span><br><span class="line">                <span class="comment">//【3.1】解析要被恢复的权限所属的应用包名！</span></span><br><span class="line">                <span class="keyword">final</span> String pkgName = parser.getAttributeValue(<span class="keyword">null</span>, ATTR_PACKAGE_NAME);</span><br><span class="line">                <span class="comment">//【8.4.2.2】解析 restored-perms!</span></span><br><span class="line">                parseRestoredRuntimePermissionsLPr(parser, pkgName, userId);</span><br><span class="line">            &#125; <span class="keyword">break</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>这个过程主要工作：</p>
<ul>
<li>解析并处理 package 的运行时权限授予情况；</li>
<li>解析并处理 shared-user 的运行时权限授予情况；</li>
</ul>
<h4 id="8-4-2-1-Settings-parsePermissionsLPr"><a href="#8-4-2-1-Settings-parsePermissionsLPr" class="headerlink" title="8.4.2.1 Settings.parsePermissionsLPr"></a>8.4.2.1 Settings.parsePermissionsLPr</h4><p>我们来看下 parsePermissionsLPr 是如何解析和处理运行时权限的！<br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">parsePermissionsLPr</span><span class="params">(XmlPullParser parser, PermissionsState permissionsState,</span></span></span><br><span class="line"><span class="function"><span class="params">        <span class="keyword">int</span> userId)</span> <span class="keyword">throws</span> IOException, XmlPullParserException </span>&#123;</span><br><span class="line">    <span class="keyword">final</span> <span class="keyword">int</span> outerDepth = parser.getDepth();</span><br><span class="line">    <span class="keyword">int</span> type;</span><br><span class="line">    <span class="keyword">while</span> ((type = parser.next()) != XmlPullParser.END_DOCUMENT</span><br><span class="line">            &amp;&amp; (type != XmlPullParser.END_TAG || parser.getDepth() &gt; outerDepth)) &#123;</span><br><span class="line">        <span class="keyword">if</span> (type == XmlPullParser.END_TAG || type == XmlPullParser.TEXT) &#123;</span><br><span class="line">            <span class="keyword">continue</span>;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">switch</span> (parser.getName()) &#123;</span><br><span class="line">            <span class="keyword">case</span> TAG_ITEM: &#123;</span><br><span class="line">                String name = parser.getAttributeValue(<span class="keyword">null</span>, ATTR_NAME); <span class="comment">// name 属性！</span></span><br><span class="line">                BasePermission bp = mPermissions.get(name);</span><br><span class="line">                <span class="keyword">if</span> (bp == <span class="keyword">null</span>) &#123;</span><br><span class="line">                    Slog.w(PackageManagerService.TAG, <span class="string">"Unknown permission:"</span> + name);</span><br><span class="line">                    XmlUtils.skipCurrentTag(parser);</span><br><span class="line">                    <span class="keyword">continue</span>;</span><br><span class="line">                &#125;</span><br><span class="line"></span><br><span class="line">                String grantedStr = parser.getAttributeValue(<span class="keyword">null</span>, ATTR_GRANTED);  <span class="comment">// granted 属性！</span></span><br><span class="line">                <span class="keyword">final</span> <span class="keyword">boolean</span> granted = grantedStr == <span class="keyword">null</span></span><br><span class="line">                        || Boolean.parseBoolean(grantedStr);</span><br><span class="line"></span><br><span class="line">                String flagsStr = parser.getAttributeValue(<span class="keyword">null</span>, ATTR_FLAGS); <span class="comment">// flags 属性！</span></span><br><span class="line">                <span class="keyword">final</span> <span class="keyword">int</span> flags = (flagsStr != <span class="keyword">null</span>)</span><br><span class="line">                        ? Integer.parseInt(flagsStr, <span class="number">16</span>) : <span class="number">0</span>;</span><br><span class="line"></span><br><span class="line">                <span class="comment">//【8.4.2.1.1】处理运行时权限的授予情况，这里和处理安装时权限很类似！</span></span><br><span class="line">                <span class="keyword">if</span> (granted) &#123;</span><br><span class="line">                    <span class="comment">// 如果上次安装时，该运行时权限处于授予状态，接着更新 flags！</span></span><br><span class="line">                    permissionsState.grantRuntimePermission(bp, userId);</span><br><span class="line">                    permissionsState.updatePermissionFlags(bp, userId,</span><br><span class="line">                                PackageManager.MASK_PERMISSION_FLAGS, flags);</span><br><span class="line">                &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                    <span class="comment">// 如果上次安装时，该运行时权限处于未授予状态，只更新 flags！</span></span><br><span class="line">                    permissionsState.updatePermissionFlags(bp, userId,</span><br><span class="line">                            PackageManager.MASK_PERMISSION_FLAGS, flags);</span><br><span class="line">                &#125;</span><br><span class="line"></span><br><span class="line">            &#125; <span class="keyword">break</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>我们看到，对于运行时权限已授予的情况，我们会先进行一次运行时权限授予，然后更新权限的 flags；对于运行时权限未授予的情况，只是更新 flags 即可！</p>
<h5 id="8-4-2-1-1-Permissions-grantRuntimePermission"><a href="#8-4-2-1-1-Permissions-grantRuntimePermission" class="headerlink" title="8.4.2.1.1 Permissions.grantRuntimePermission"></a>8.4.2.1.1 Permissions.grantRuntimePermission</h5><p>处理运行时权限的授予！</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">int</span> <span class="title">grantRuntimePermission</span><span class="params">(BasePermission permission, <span class="keyword">int</span> userId)</span> </span>&#123;</span><br><span class="line">    enforceValidUserId(userId);</span><br><span class="line">    <span class="comment">//【1】可以看到，对于运行时权限，userId 只能为当前设备用户，不能为 USER_ALL</span></span><br><span class="line">    <span class="keyword">if</span> (userId == UserHandle.USER_ALL) &#123;</span><br><span class="line">        <span class="keyword">return</span> PERMISSION_OPERATION_FAILURE;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">//【2】接下来，就和处理安装时权限一样了！</span></span><br><span class="line">    <span class="keyword">return</span> grantPermission(permission, userId);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>这里不多说！</p>
<h4 id="8-4-2-2-Settings-parseRestoredRuntimePermissionsLPr"><a href="#8-4-2-2-Settings-parseRestoredRuntimePermissionsLPr" class="headerlink" title="8.4.2.2 Settings.parseRestoredRuntimePermissionsLPr"></a>8.4.2.2 Settings.parseRestoredRuntimePermissionsLPr</h4><p>解析那些需要恢复的权限信息：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">parseRestoredRuntimePermissionsLPr</span><span class="params">(XmlPullParser parser,</span></span></span><br><span class="line"><span class="function"><span class="params">        <span class="keyword">final</span> String pkgName, <span class="keyword">final</span> <span class="keyword">int</span> userId)</span> <span class="keyword">throws</span> IOException, XmlPullParserException </span>&#123;</span><br><span class="line">    <span class="keyword">final</span> <span class="keyword">int</span> outerDepth = parser.getDepth();</span><br><span class="line">    <span class="keyword">int</span> type;</span><br><span class="line">    <span class="keyword">while</span> ((type = parser.next()) != XmlPullParser.END_DOCUMENT</span><br><span class="line">            &amp;&amp; (type != XmlPullParser.END_TAG || parser.getDepth() &gt; outerDepth)) &#123;</span><br><span class="line">        <span class="keyword">if</span> (type == XmlPullParser.END_TAG || type == XmlPullParser.TEXT) &#123;</span><br><span class="line">            <span class="keyword">continue</span>;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">switch</span> (parser.getName()) &#123;</span><br><span class="line">            <span class="comment">//【1】解析 perm 标签！</span></span><br><span class="line">            <span class="keyword">case</span> TAG_PERMISSION_ENTRY: &#123;</span><br><span class="line">                <span class="comment">//【1.1】解析 name 属性，获得权限的名称；</span></span><br><span class="line">                <span class="keyword">final</span> String permName = parser.getAttributeValue(<span class="keyword">null</span>, ATTR_NAME);</span><br><span class="line">                <span class="comment">//【1.2】解析 granted 属性，获得权限的授予情况；</span></span><br><span class="line">                <span class="keyword">final</span> <span class="keyword">boolean</span> isGranted = <span class="string">"true"</span>.equals(</span><br><span class="line">                        parser.getAttributeValue(<span class="keyword">null</span>, ATTR_GRANTED));</span><br><span class="line">                <span class="comment">//【1.3】解析获得权限的 flags 设置！</span></span><br><span class="line">                <span class="keyword">int</span> permBits = <span class="number">0</span>;</span><br><span class="line">                <span class="keyword">if</span> (<span class="string">"true"</span>.equals(parser.getAttributeValue(<span class="keyword">null</span>, ATTR_USER_SET))) &#123;</span><br><span class="line">                    permBits |= FLAG_PERMISSION_USER_SET;</span><br><span class="line">                &#125;</span><br><span class="line">                <span class="keyword">if</span> (<span class="string">"true"</span>.equals(parser.getAttributeValue(<span class="keyword">null</span>, ATTR_USER_FIXED))) &#123;</span><br><span class="line">                    permBits |= FLAG_PERMISSION_USER_FIXED;</span><br><span class="line">                &#125;</span><br><span class="line">                <span class="keyword">if</span> (<span class="string">"true"</span>.equals(parser.getAttributeValue(<span class="keyword">null</span>, ATTR_REVOKE_ON_UPGRADE))) &#123;</span><br><span class="line">                    permBits |= FLAG_PERMISSION_REVOKE_ON_UPGRADE;</span><br><span class="line">                &#125;</span><br><span class="line">                <span class="keyword">if</span> (isGranted || permBits != <span class="number">0</span>) &#123;</span><br><span class="line">                    <span class="comment">//【8.4.2.2.1】如果权限是授予状态，或者其 flags 不为 null！</span></span><br><span class="line">                    <span class="comment">// 那么我们会将其记录到内充中！</span></span><br><span class="line">                    rememberRestoredUserGrantLPr(pkgName, permName, isGranted, permBits, userId);</span><br><span class="line">                &#125;</span><br><span class="line">            &#125; <span class="keyword">break</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>如果权限是被授予的状态，或者其 flags 不为 null，那么会调用 rememberRestoredUserGrantLPr 方法，保存到 Settings.mRestoredUserGrants 中！</p>
<p>#####8.4.2.2.1 Settings.rememberRestoredUserGrantLPr<br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">rememberRestoredUserGrantLPr</span><span class="params">(String pkgName, String permission,</span></span></span><br><span class="line"><span class="function"><span class="params">        <span class="keyword">boolean</span> isGranted, <span class="keyword">int</span> restoredFlagSet, <span class="keyword">int</span> userId)</span> </span>&#123;</span><br><span class="line">    <span class="comment">//【1】获得该 userId 下的 restore perms 数据集合，是一个 Map！</span></span><br><span class="line">    <span class="comment">// 如果为 null，就初始化！</span></span><br><span class="line">    ArrayMap&lt;String, ArraySet&lt;RestoredPermissionGrant&gt;&gt; grantsByPackage =</span><br><span class="line">            mRestoredUserGrants.get(userId);</span><br><span class="line">    <span class="keyword">if</span> (grantsByPackage == <span class="keyword">null</span>) &#123;</span><br><span class="line">        grantsByPackage = <span class="keyword">new</span> ArrayMap&lt;String, ArraySet&lt;RestoredPermissionGrant&gt;&gt;();</span><br><span class="line">        mRestoredUserGrants.put(userId, grantsByPackage);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">//【2】获得该 package 的 restore perms 数据集合，如果为 null，就初始化！</span></span><br><span class="line">    ArraySet&lt;RestoredPermissionGrant&gt; grants = grantsByPackage.get(pkgName);</span><br><span class="line">    <span class="keyword">if</span> (grants == <span class="keyword">null</span>) &#123;</span><br><span class="line">        grants = <span class="keyword">new</span> ArraySet&lt;RestoredPermissionGrant&gt;();</span><br><span class="line">        grantsByPackage.put(pkgName, grants);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">//【3】将 retore 的权限封装成一个 RestoredPermissionGrant，添加到集合中！</span></span><br><span class="line">    RestoredPermissionGrant grant = <span class="keyword">new</span> RestoredPermissionGrant(permission,</span><br><span class="line">            isGranted, restoredFlagSet);</span><br><span class="line">    grants.add(grant);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>Settings 内部有一个 SparseArray：<br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">private</span> <span class="keyword">final</span> SparseArray&lt;ArrayMap&lt;String, ArraySet&lt;RestoredPermissionGrant&gt;&gt;&gt;</span><br><span class="line">         mRestoredUserGrants =</span><br><span class="line">             <span class="keyword">new</span> SparseArray&lt;ArrayMap&lt;String, ArraySet&lt;RestoredPermissionGrant&gt;&gt;&gt;();</span><br></pre></td></tr></table></figure></p>
<p>下标是 userId，值是一个 ArrayMap&lt;String, ArraySet<restoredpermissiongrant>&gt;，封装了该 userId 下所有 package的 retore perms！</restoredpermissiongrant></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">final</span> <span class="class"><span class="keyword">class</span> <span class="title">RestoredPermissionGrant</span> </span>&#123;</span><br><span class="line">    String permissionName;</span><br><span class="line">    <span class="keyword">boolean</span> granted;</span><br><span class="line">    <span class="keyword">int</span> grantBits;</span><br><span class="line"></span><br><span class="line">    RestoredPermissionGrant(String name, <span class="keyword">boolean</span> isGranted, <span class="keyword">int</span> theGrantBits) &#123;</span><br><span class="line">        permissionName = name;</span><br><span class="line">        granted = isGranted;</span><br><span class="line">        grantBits = theGrantBits;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>RestoredPermissionGrant 内部的结构很简单，不多说了！！</p>
<h1 id="9-安装时权限处理过程分析-接-8-1-1-4"><a href="#9-安装时权限处理过程分析-接-8-1-1-4" class="headerlink" title="9 安装时权限处理过程分析 - 接 8.1.1.4"></a>9 安装时权限处理过程分析 - 接 8.1.1.4</h1><p>markdown 只支持 6 级标题，所以这里接 8.1.1.4 继续分析！</p>
<p>下面来较为深入的分析下解析 “perms” 标签，并通过解析结果授予安装时权限的过程：</p>
<figure class="highlight"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">&lt;perms&gt;</span><br><span class="line">     &lt;item name=<span class="string">"android.permission.REAL_GET_TASKS"</span> granted=<span class="string">"true"</span> flags=<span class="string">"0"</span> /&gt;</span><br><span class="line">     &lt;item name=<span class="string">"android.permission.RECEIVE_BOOT_COMPLETED"</span> granted=<span class="string">"true"</span> flags=<span class="string">"0"</span> /&gt;</span><br><span class="line">     &lt;item name=<span class="string">"android.permission.INTERNET"</span> granted=<span class="string">"true"</span> flags=<span class="string">"0"</span> /&gt;</span><br><span class="line">     &lt;item name=<span class="string">"android.permission.ACCESS_NETWORK_STATE"</span> granted=<span class="string">"true"</span> flags=<span class="string">"0"</span> /&gt;</span><br><span class="line">&lt;/perms&gt;</span><br></pre></td></tr></table></figure>
<p>回顾一下，Settings.readInstallPermissionsLPr 的方法：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">readInstallPermissionsLPr</span><span class="params">(XmlPullParser parser, PermissionsState permissionsState)</span> </span></span><br><span class="line"><span class="function">                                                    <span class="keyword">throws</span> IOException, XmlPullParserException </span>&#123;</span><br><span class="line">    <span class="keyword">int</span> outerDepth = parser.getDepth();</span><br><span class="line">    <span class="keyword">int</span> type;</span><br><span class="line">    <span class="keyword">while</span> ((type=parser.next()) != XmlPullParser.END_DOCUMENT</span><br><span class="line">            &amp;&amp; (type != XmlPullParser.END_TAG</span><br><span class="line">            || parser.getDepth() &gt; outerDepth)) &#123;</span><br><span class="line">        <span class="keyword">if</span> (type == XmlPullParser.END_TAG</span><br><span class="line">                || type == XmlPullParser.TEXT) &#123;</span><br><span class="line">            <span class="keyword">continue</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        String tagName = parser.getName();</span><br><span class="line">        <span class="keyword">if</span> (tagName.equals(TAG_ITEM)) &#123; <span class="comment">// 解析 "item"</span></span><br><span class="line">            String name = parser.getAttributeValue(<span class="keyword">null</span>, ATTR_NAME); <span class="comment">// 接续 "name"，权限名称！</span></span><br><span class="line">            <span class="comment">//【1】从之前解析的 Settings.mPermissions 获得对应的权限；</span></span><br><span class="line">            BasePermission bp = mPermissions.get(name);</span><br><span class="line">            <span class="keyword">if</span> (bp == <span class="keyword">null</span>) &#123;</span><br><span class="line">                Slog.w(PackageManagerService.TAG, <span class="string">"Unknown permission: "</span> + name);</span><br><span class="line">                XmlUtils.skipCurrentTag(parser);</span><br><span class="line">                <span class="keyword">continue</span>;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="comment">//【2】解析 "granted" 标签，获得授予情况！</span></span><br><span class="line">            String grantedStr = parser.getAttributeValue(<span class="keyword">null</span>, ATTR_GRANTED);</span><br><span class="line">            <span class="keyword">final</span> <span class="keyword">boolean</span> granted = grantedStr == <span class="keyword">null</span></span><br><span class="line">                    || Boolean.parseBoolean(grantedStr);</span><br><span class="line">            <span class="comment">// 解析 "flags"标签</span></span><br><span class="line">            String flagsStr = parser.getAttributeValue(<span class="keyword">null</span>, ATTR_FLAGS);</span><br><span class="line">            <span class="keyword">final</span> <span class="keyword">int</span> flags = (flagsStr != <span class="keyword">null</span>)</span><br><span class="line">                    ? Integer.parseInt(flagsStr, <span class="number">16</span>) : <span class="number">0</span>;</span><br><span class="line"></span><br><span class="line">            <span class="comment">//【3】处理权限授予的操作！</span></span><br><span class="line">            <span class="keyword">if</span> (granted) &#123; </span><br><span class="line">                <span class="comment">//【9.1】处理默认授予的情况！</span></span><br><span class="line">                <span class="keyword">if</span> (permissionsState.grantInstallPermission(bp) ==</span><br><span class="line">                        PermissionsState.PERMISSION_OPERATION_FAILURE) &#123;</span><br><span class="line">                    Slog.w(PackageManagerService.TAG, <span class="string">"Permission already added: "</span> + name);</span><br><span class="line">                    XmlUtils.skipCurrentTag(parser);</span><br><span class="line">                &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                    permissionsState.updatePermissionFlags(bp, UserHandle.USER_ALL,</span><br><span class="line">                            PackageManager.MASK_PERMISSION_FLAGS, flags);</span><br><span class="line">                &#125;</span><br><span class="line">            &#125; <span class="keyword">else</span> &#123; </span><br><span class="line">                <span class="comment">//【9.2】处理默认不授予的情况！</span></span><br><span class="line">                <span class="keyword">if</span> (permissionsState.revokeInstallPermission(bp) ==</span><br><span class="line">                        PermissionsState.PERMISSION_OPERATION_FAILURE) &#123;</span><br><span class="line">                    Slog.w(PackageManagerService.TAG, <span class="string">"Permission already added: "</span> + name);</span><br><span class="line">                    XmlUtils.skipCurrentTag(parser);</span><br><span class="line">                &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                    <span class="comment">//【9.3】更新应用权限信息！</span></span><br><span class="line">                    permissionsState.updatePermissionFlags(bp, UserHandle.USER_ALL,</span><br><span class="line">                            PackageManager.MASK_PERMISSION_FLAGS, flags);</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            Slog.w(PackageManagerService.TAG, <span class="string">"Unknown element under &lt;permissions&gt;: "</span></span><br><span class="line">                    + parser.getName());</span><br><span class="line">            XmlUtils.skipCurrentTag(parser);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>接下来，我们看一看，这个流程是如何处理权限的：</p>
<p>这里有涉及到 permissionsState 对象，每一个 PackageSetting 和 SharedUserSetting 都有一个 permissionsState 对象，用来保存其权限的状态信息！</p>
<p>在创建 PackageSetting 和 SharedUserSetting 的时候，都会默认创建一个 PermissionsState 对象！</p>
<p>PermissionsState 内部有一个 ArrayMap&lt;String, PermissionData&gt; mPermissions 用来保存权限名和其对应权限信息数据！</p>
<p>下面为了简化分析过程，PermissionsState 统一化为 PermissionsS</p>
<h2 id="9-1-PermissionsS-grantInstallPermission-处理授予情况"><a href="#9-1-PermissionsS-grantInstallPermission-处理授予情况" class="headerlink" title="9.1 PermissionsS.grantInstallPermission - 处理授予情况"></a>9.1 PermissionsS.grantInstallPermission - 处理授予情况</h2><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 授予一个安装时权限，可以看到，安装时权限是对所有用户都默认授予的！</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">int</span> <span class="title">grantInstallPermission</span><span class="params">(BasePermission permission)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">return</span> grantPermission(permission, UserHandle.USER_ALL);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>我们继续看，参数传入：</p>
<ul>
<li><strong>BasePermission permission</strong>：权限封装对象</li>
<li><strong>int userId</strong>：设备用户，因为是安装时权限，所以对所有设备用户都是一样，这里传入 <strong>UserHandle.USER_ALL</strong>！<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">int</span> <span class="title">grantPermission</span><span class="params">(BasePermission permission, <span class="keyword">int</span> userId)</span> </span>&#123;</span><br><span class="line">    <span class="comment">//【9.1.1】如果之前有权限，本次授予失败！</span></span><br><span class="line">    <span class="keyword">if</span> (hasPermission(permission.name, userId)) &#123;</span><br><span class="line">        <span class="keyword">return</span> PERMISSION_OPERATION_FAILURE;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">//【9.1.2】判断权限 BasePermission 在 userId 下是否有映射 gid，如果有，那 hasGids 为 true！</span></span><br><span class="line">    <span class="keyword">final</span> <span class="keyword">boolean</span> hasGids = !ArrayUtils.isEmpty(permission.computeGids(userId));</span><br><span class="line"></span><br><span class="line">    <span class="comment">//【9.1.3】如果权限 BasePermission 有映射的 gid，那就计算下该 package 的所属的 Gid 组！</span></span><br><span class="line">    <span class="keyword">final</span> <span class="keyword">int</span>[] oldGids = hasGids ? computeGids(userId) : NO_GIDS;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">//【9.1.4】创建权限的 permissionData 对象，并添加到 PermissionState.mPermissions 中！</span></span><br><span class="line">    PermissionData permissionData = ensurePermissionData(permission);</span><br><span class="line"></span><br><span class="line">    <span class="comment">//【9.1.5】授予权限！</span></span><br><span class="line">    <span class="keyword">if</span> (!permissionData.grant(userId)) &#123; <span class="comment">// 授权失败，就返回 PERMISSION_OPERATION_FAILURE！</span></span><br><span class="line">        <span class="keyword">return</span> PERMISSION_OPERATION_FAILURE;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 如果权限有映射的 gid，在授予权限后，再次计算该 package 的所有映射的 gid！</span></span><br><span class="line">    <span class="comment">// 比较授权前后，gid 组是否发生了变化，如果有，返回 PERMISSION_OPERATION_SUCCESS_GIDS_CHANGED！</span></span><br><span class="line">    <span class="keyword">if</span> (hasGids) &#123;</span><br><span class="line">        <span class="keyword">final</span> <span class="keyword">int</span>[] newGids = computeGids(userId);</span><br><span class="line">        <span class="keyword">if</span> (oldGids.length != newGids.length) &#123;</span><br><span class="line">            <span class="keyword">return</span> PERMISSION_OPERATION_SUCCESS_GIDS_CHANGED;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> PERMISSION_OPERATION_SUCCESS; <span class="comment">// 返回 PERMISSION_OPERATION_SUCCESS！</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
</li>
</ul>
<p>方法逻辑如下：</p>
<ul>
<li>如果已经授予权限，那就不处理，返回 PERMISSION_OPERATION_FAILURE；</li>
<li>如果授予权限失败，那就不处理，返回 PERMISSION_OPERATION_FAILURE；</li>
<li>如果授予权限成功，但是发现权限所属的 gid 发生了变化，返回 PERMISSION_OPERATION_SUCCESS_GIDS_CHANGED；</li>
<li>如果授予权限成功，但是发现权限所属的 gid 没有发生变化，返回 PERMISSION_OPERATION_SUCCESS；</li>
</ul>
<h3 id="9-1-1-PermissionsS-hasPermission"><a href="#9-1-1-PermissionsS-hasPermission" class="headerlink" title="9.1.1 PermissionsS.hasPermission"></a>9.1.1 PermissionsS.hasPermission</h3><p>hasPermission 用来判断是否已经授予的该权限！<br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">boolean</span> <span class="title">hasPermission</span><span class="params">(String name, <span class="keyword">int</span> userId)</span> </span>&#123;</span><br><span class="line">    <span class="comment">// 校验 uid 的有效性！</span></span><br><span class="line">    enforceValidUserId(userId);</span><br><span class="line">    <span class="keyword">if</span> (mPermissions == <span class="keyword">null</span>) &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">false</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">//【1】获得该权限对应的 permissionData 对象！</span></span><br><span class="line">    PermissionData permissionData = mPermissions.get(name);</span><br><span class="line">    <span class="comment">//【9.1.1.1】判断是否已经授予了该权限！</span></span><br><span class="line">    <span class="keyword">return</span> permissionData != <span class="keyword">null</span> &amp;&amp; permissionData.isGranted(userId);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>授予该权限的条件是，其对应的 PermissionData 不为 null，同时该权限属于已经授予的状态；</p>
<h4 id="9-1-1-1-PermissionData-isGranted"><a href="#9-1-1-1-PermissionData-isGranted" class="headerlink" title="9.1.1.1 PermissionData.isGranted"></a>9.1.1.1 PermissionData.isGranted</h4><p>PermissionData 的 isGranted 用于判断该权限在 userId 所在的设备用户下是否是授予状态！<br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">boolean</span> <span class="title">isGranted</span><span class="params">(<span class="keyword">int</span> userId)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">if</span> (isInstallPermission()) &#123; <span class="comment">// 如果是安装时权限，userId 即 key 为 USER_ALL！</span></span><br><span class="line">        userId = UserHandle.USER_ALL;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    PermissionState userState = mUserStates.get(userId);</span><br><span class="line">    <span class="keyword">if</span> (userState == <span class="keyword">null</span>) &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">false</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> userState.mGranted; <span class="comment">// 返回是否授予！</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>isInstallPermission 方法用来判断，该权限是否是一个安装时的权限：<br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">boolean</span> <span class="title">isInstallPermission</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    <span class="keyword">return</span> mUserStates.size() == <span class="number">1</span></span><br><span class="line">            &amp;&amp; mUserStates.get(UserHandle.USER_ALL) != <span class="keyword">null</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>判断依据很简单，对于安装时权限，所有的设备用户都一样，所以 mUserStates 大小为 1，且 key 为 UserHandle.USER_ALL！</p>
<h3 id="9-1-2-BasePermission-computeGids"><a href="#9-1-2-BasePermission-computeGids" class="headerlink" title="9.1.2 BasePermission.computeGids"></a>9.1.2 BasePermission.computeGids</h3><p>BasePermission 的 computeGids 方法用于通过 userId 来调整该权限所映射的 gids！</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">int</span>[] computeGids(<span class="keyword">int</span> userId) &#123;</span><br><span class="line">    <span class="keyword">if</span> (perUser) &#123;</span><br><span class="line">        <span class="keyword">final</span> <span class="keyword">int</span>[] userGids = <span class="keyword">new</span> <span class="keyword">int</span>[gids.length];</span><br><span class="line">        <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; gids.length; i++) &#123;</span><br><span class="line">            userGids[i] = UserHandle.getUid(userId, gids[i]);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> userGids;</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> gids;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>如果 perUser 为 true，表示需要根据当前应用所在的 userId，调整映射的 gid，那么会通过 UserHandle.getUid 方法计算出当前 userId 下的该权限所映射的 gid！</p>
<p>如果 perUser 为 false，那么该权限在所有的设备用户下映射的 gid 是一样的！</p>
<h3 id="9-1-3-PermissionsS-computeGids"><a href="#9-1-3-PermissionsS-computeGids" class="headerlink" title="9.1.3 PermissionsS.computeGids"></a>9.1.3 PermissionsS.computeGids</h3><p>返回指定设备用户 id 下，该 package 当前被授予的所有权限映射的 gid 数组！！<br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">int</span>[] computeGids(<span class="keyword">int</span> userId) &#123;</span><br><span class="line">    enforceValidUserId(userId);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">int</span>[] gids = mGlobalGids;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (mPermissions != <span class="keyword">null</span>) &#123;</span><br><span class="line">        <span class="keyword">final</span> <span class="keyword">int</span> permissionCount = mPermissions.size();</span><br><span class="line">        <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; permissionCount; i++) &#123;</span><br><span class="line">            <span class="comment">//【1】遍历该 package 的已经被授予的所有权限！</span></span><br><span class="line">            <span class="comment">// 没有授予就跳过！</span></span><br><span class="line">            String permission = mPermissions.keyAt(i);</span><br><span class="line">            <span class="keyword">if</span> (!hasPermission(permission, userId)) &#123;</span><br><span class="line">                <span class="keyword">continue</span>;</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            PermissionData permissionData = mPermissions.valueAt(i);</span><br><span class="line">            <span class="comment">//【9.1.3.1】计算该权限在当前设备用户下的 gid，将其添加到 gids！</span></span><br><span class="line">            <span class="keyword">final</span> <span class="keyword">int</span>[] permGids = permissionData.computeGids(userId);</span><br><span class="line">            <span class="keyword">if</span> (permGids != NO_GIDS) &#123;</span><br><span class="line">                gids = appendInts(gids, permGids);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// 并返回 gids！！</span></span><br><span class="line">    <span class="keyword">return</span> gids;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>mGlobalGids 是 PermissionsState 的成员变量，默认取值为：<br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="keyword">int</span>[] NO_GIDS = &#123;&#125;;</span><br><span class="line"><span class="keyword">private</span> <span class="keyword">int</span>[] mGlobalGids = NO_GIDS;</span><br></pre></td></tr></table></figure></p>
<h4 id="9-1-3-1-PermissionData-computeGids"><a href="#9-1-3-1-PermissionData-computeGids" class="headerlink" title="9.1.3.1 PermissionData.computeGids"></a>9.1.3.1 PermissionData.computeGids</h4><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="class"><span class="keyword">class</span> <span class="title">PermissionData</span> </span>&#123;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> BasePermission mPerm;</span><br><span class="line">    ... ... ...</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">int</span>[] computeGids(<span class="keyword">int</span> userId) &#123;</span><br><span class="line">        <span class="comment">// 计算该权限所属的 gid！</span></span><br><span class="line">        <span class="keyword">return</span> mPerm.computeGids(userId);</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure>
<p>PermissionData.computeGids 方法最后调用的是 BasePermission.computeGids 方法，这里不多说了。</p>
<h3 id="9-1-4-PermissionsS-ensurePermissionData"><a href="#9-1-4-PermissionsS-ensurePermissionData" class="headerlink" title="9.1.4 PermissionsS.ensurePermissionData"></a>9.1.4 PermissionsS.ensurePermissionData</h3><p>创建 PermissionData，并添加到 PermissionsState 内部的 mPermissions 集合中！<br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">private</span> PermissionData <span class="title">ensurePermissionData</span><span class="params">(BasePermission permission)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">if</span> (mPermissions == <span class="keyword">null</span>) &#123;</span><br><span class="line">        mPermissions = <span class="keyword">new</span> ArrayMap&lt;&gt;();</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">//【9.1.2.1】创建权限对应的 PermissionData 对象！</span></span><br><span class="line">    PermissionData permissionData = mPermissions.get(permission.name);</span><br><span class="line">    <span class="keyword">if</span> (permissionData == <span class="keyword">null</span>) &#123;</span><br><span class="line">        permissionData = <span class="keyword">new</span> PermissionData(permission);</span><br><span class="line">        mPermissions.put(permission.name, permissionData);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> permissionData;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>可以看到，在 PermissionsState 中有一个 mPermissions 表，保存了 permission.name 和 PermissionData 的映射关系，如果是第一次创建某个权限的 PermissionData，会创建 PermissionData 实例！</p>
<h4 id="9-1-4-1-new-PermissionData"><a href="#9-1-4-1-new-PermissionData" class="headerlink" title="9.1.4.1 new PermissionData"></a>9.1.4.1 new PermissionData</h4><p>创建 PermissionData 对象！</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="class"><span class="keyword">class</span> <span class="title">PermissionData</span> </span>&#123;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> BasePermission mPerm;</span><br><span class="line">    <span class="comment">//【1】用于保存该权限在不同 userId 下的授予情况！</span></span><br><span class="line">    <span class="keyword">private</span> SparseArray&lt;PermissionState&gt; mUserStates = <span class="keyword">new</span> SparseArray&lt;&gt;();</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="title">PermissionData</span><span class="params">(BasePermission perm)</span> </span>&#123;</span><br><span class="line">        mPerm = perm;</span><br><span class="line">    &#125;</span><br><span class="line">    ... ... ... ...</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>创建 PermissionData 对象！</p>
<p>mUserStates 是以 userId 为下标，存储了每个设备用户下该应用的这个权限的状态信息！</p>
<h3 id="9-1-5-PermissionData-grant"><a href="#9-1-5-PermissionData-grant" class="headerlink" title="9.1.5 PermissionData.grant"></a>9.1.5 PermissionData.grant</h3><p>下面我们来看看具体的权限授予过程！<br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">boolean</span> <span class="title">grant</span><span class="params">(<span class="keyword">int</span> userId)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">if</span> (!isCompatibleUserId(userId)) &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">false</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (isGranted(userId)) &#123; <span class="comment">// 如果已经授予，那就返回 false！</span></span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">false</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 获得该权限对应在 userId 下对应的 PermissionState 对象，没有的话就创建新的！</span></span><br><span class="line">    PermissionState userState = mUserStates.get(userId);</span><br><span class="line">    <span class="keyword">if</span> (userState == <span class="keyword">null</span>) &#123;</span><br><span class="line">        userState = <span class="keyword">new</span> PermissionState(mPerm.name);</span><br><span class="line">        mUserStates.put(userId, userState);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// 设置在该 userId 下的权限状态为 true！</span></span><br><span class="line">    userState.mGranted = <span class="keyword">true</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">true</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>首先，判断 userId 的兼容性！</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">boolean</span> <span class="title">isCompatibleUserId</span><span class="params">(<span class="keyword">int</span> userId)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">return</span> isDefault() || !(isInstallPermission() ^ isInstallPermissionKey(userId));</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>userId 要满足兼容性要求，需要至少满足其中之一条件：</p>
<ul>
<li>PermissionData.mUserStates 的大小 &lt;= 0，意味着该权限还没有初始化在该 userId 下的状态！</li>
</ul>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">boolean</span> <span class="title">isDefault</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    <span class="keyword">return</span> mUserStates.size() &lt;= <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<ul>
<li>要么，该权限是安装时权限，同时 userId 只能为 UserHandle.USER_ALL; 要么，该权限不是安装时权限，同时 userId 不能为 UserHandle.USER_ALL;</li>
</ul>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">boolean</span> <span class="title">isInstallPermissionKey</span><span class="params">(<span class="keyword">int</span> userId)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">return</span> userId == UserHandle.USER_ALL;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>对于 isInstallPermission 方法，前面已经分析了，不多说了！</p>
<h2 id="9-2-PermissionsS-revokeInstallPermission-处理不授予情况"><a href="#9-2-PermissionsS-revokeInstallPermission-处理不授予情况" class="headerlink" title="9.2 PermissionsS.revokeInstallPermission  - 处理不授予情况"></a>9.2 PermissionsS.revokeInstallPermission  - 处理不授予情况</h2><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">int</span> <span class="title">revokeInstallPermission</span><span class="params">(BasePermission permission)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">return</span> revokePermission(permission, UserHandle.USER_ALL);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>我们继续看，参数传入;</p>
<ul>
<li>BasePermission permission：权限封装对象</li>
<li>int userId：设备用户，因为是安装时权限，所以对所有设备用户都是一样，这里传入：UserHandle.USER_ALL</li>
</ul>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">int</span> <span class="title">revokePermission</span><span class="params">(BasePermission permission, <span class="keyword">int</span> userId)</span> </span>&#123;</span><br><span class="line">    <span class="comment">//【1】如果没有授予该权限，那就返回 PERMISSION_OPERATION_FAILURE！</span></span><br><span class="line">    <span class="keyword">if</span> (!hasPermission(permission.name, userId)) &#123;</span><br><span class="line">        <span class="keyword">return</span> PERMISSION_OPERATION_FAILURE;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//【2】同样，计算该权限是否有映射 gid，如果有 gid，计算当前 package 持有的权限映射的所有 gid！</span></span><br><span class="line">    <span class="comment">// 保存到 oldGids 中！</span></span><br><span class="line">    <span class="keyword">final</span> <span class="keyword">boolean</span> hasGids = !ArrayUtils.isEmpty(permission.computeGids(userId));</span><br><span class="line">    <span class="keyword">final</span> <span class="keyword">int</span>[] oldGids = hasGids ? computeGids(userId) : NO_GIDS;</span><br><span class="line"></span><br><span class="line">    PermissionData permissionData = mPermissions.get(permission.name);</span><br><span class="line"></span><br><span class="line">    <span class="comment">//【9.2.1】取消权限的授予！</span></span><br><span class="line">    <span class="keyword">if</span> (!permissionData.revoke(userId)) &#123;</span><br><span class="line">        <span class="keyword">return</span> PERMISSION_OPERATION_FAILURE;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//【9.2.2】如果该权限在所有设备用户下均没有授予该 package，即 mUserStates.size() &lt;= 0；</span></span><br><span class="line">    <span class="comment">// 那么我们要移除该权限！</span></span><br><span class="line">    <span class="keyword">if</span> (permissionData.isDefault()) &#123;</span><br><span class="line">        ensureNoPermissionData(permission.name);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//【3】这里是比较，在撤销安装时权限后，该 package 所持有的 gid 是否发生变化！</span></span><br><span class="line">    <span class="keyword">if</span> (hasGids) &#123;</span><br><span class="line">        <span class="keyword">final</span> <span class="keyword">int</span>[] newGids = computeGids(userId);</span><br><span class="line">        <span class="keyword">if</span> (oldGids.length != newGids.length) &#123;</span><br><span class="line">            <span class="keyword">return</span> PERMISSION_OPERATION_SUCCESS_GIDS_CHANGED;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> PERMISSION_OPERATION_SUCCESS;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>撤销安装时权限的过程，和授予有很多类似的地方，我们重点看那些不同的地方！</p>
<h3 id="9-2-1-PermissionData-revoke"><a href="#9-2-1-PermissionData-revoke" class="headerlink" title="9.2.1 PermissionData.revoke"></a>9.2.1 PermissionData.revoke</h3><p>接下来看看安装时权限撤销的过程！<br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">boolean</span> <span class="title">revoke</span><span class="params">(<span class="keyword">int</span> userId)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">if</span> (!isCompatibleUserId(userId)) &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">false</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// 如果权限还没有被授予，无法撤销！</span></span><br><span class="line">    <span class="keyword">if</span> (!isGranted(userId)) &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">false</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">//【1】将权限在该 userId 下的状态设置为非授予的情况！</span></span><br><span class="line">    PermissionState userState = mUserStates.get(userId);</span><br><span class="line">    userState.mGranted = <span class="keyword">false</span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 如果该权限恢复了默认状态，从 mUserStates 中移除掉它！</span></span><br><span class="line">    <span class="keyword">if</span> (userState.isDefault()) &#123;</span><br><span class="line">        mUserStates.remove(userId);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">true</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<h3 id="9-2-2-PermissionsS-ensureNoPermissionData"><a href="#9-2-2-PermissionsS-ensureNoPermissionData" class="headerlink" title="9.2.2 PermissionsS.ensureNoPermissionData"></a>9.2.2 PermissionsS.ensureNoPermissionData</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">ensureNoPermissionData</span><span class="params">(String name)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">if</span> (mPermissions == <span class="keyword">null</span>) &#123;</span><br><span class="line">        <span class="keyword">return</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    mPermissions.remove(name);</span><br><span class="line">    <span class="keyword">if</span> (mPermissions.isEmpty()) &#123;</span><br><span class="line">        mPermissions = <span class="keyword">null</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>ensureNoPermissionData 用于从当前的 package 中移除该权限数据！</p>
<h2 id="9-3-PermissionsS-updatePermissionFlags-更新权限标志位"><a href="#9-3-PermissionsS-updatePermissionFlags-更新权限标志位" class="headerlink" title="9.3 PermissionsS.updatePermissionFlags  - 更新权限标志位"></a>9.3 PermissionsS.updatePermissionFlags  - 更新权限标志位</h2><p>当 revokeInstallPermission 或者 grantInstallPermission 方法返回的是 PERMISSION_OPERATION_SUCCESS_GIDS_CHANGED 或者 PERMISSION_OPERATION_SUCCESS 的时候，我们需要更新权限的标志位！</p>
<p>参数传递：</p>
<ul>
<li>userId 传入的是 UserHandle.USER_ALL；</li>
<li>flagMask 传入的是 PackageManager.MASK_PERMISSION_FLAGS，取值为 0xFF，转为二进制就是 11111</li>
<li>flagValues 则是解析上次安装信息时，解析该 package 的 perms 标签时，每一个权限的 flags！</li>
</ul>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">boolean</span> <span class="title">updatePermissionFlags</span><span class="params">(BasePermission permission, <span class="keyword">int</span> userId,</span></span></span><br><span class="line"><span class="function"><span class="params">        <span class="keyword">int</span> flagMask, <span class="keyword">int</span> flagValues)</span> </span>&#123;</span><br><span class="line">    enforceValidUserId(userId);</span><br><span class="line">  </span><br><span class="line">    <span class="keyword">final</span> <span class="keyword">boolean</span> mayChangeFlags = flagValues != <span class="number">0</span> || flagMask != <span class="number">0</span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//【1】如果 mPermissions 为 null，且需要更新 flags，那么会初始化 mPermissions，将 permission 添加进入！</span></span><br><span class="line">    <span class="keyword">if</span> (mPermissions == <span class="keyword">null</span>) &#123;</span><br><span class="line">        <span class="keyword">if</span> (!mayChangeFlags) &#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="keyword">false</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        ensurePermissionData(permission);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">//【2】如果该权限 permission 没有对应的 PermissionData，且需要更新 flags，那么我们会创建 PermissionData 添加！</span></span><br><span class="line">    PermissionData permissionData = mPermissions.get(permission.name);</span><br><span class="line">    <span class="keyword">if</span> (permissionData == <span class="keyword">null</span>) &#123;</span><br><span class="line">        <span class="keyword">if</span> (!mayChangeFlags) &#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="keyword">false</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        permissionData = ensurePermissionData(permission);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//【3】获得该权限的旧的 flags，用于后续对比！</span></span><br><span class="line">    <span class="keyword">final</span> <span class="keyword">int</span> oldFlags = permissionData.getFlags(userId);</span><br><span class="line"> </span><br><span class="line">    <span class="comment">//【9.3.1】更新权限标志位！</span></span><br><span class="line">    <span class="keyword">final</span> <span class="keyword">boolean</span> updated = permissionData.updateFlags(userId, flagMask, flagValues);</span><br><span class="line"></span><br><span class="line">    <span class="comment">//【4】如果权限的状态发生了变化，那就判断是否需要重新申请！</span></span><br><span class="line">    <span class="keyword">if</span> (updated) &#123;</span><br><span class="line">        <span class="keyword">final</span> <span class="keyword">int</span> newFlags = permissionData.getFlags(userId);</span><br><span class="line">        <span class="keyword">if</span> ((oldFlags &amp; PackageManager.FLAG_PERMISSION_REVIEW_REQUIRED) == <span class="number">0</span></span><br><span class="line">                &amp;&amp; (newFlags &amp; PackageManager.FLAG_PERMISSION_REVIEW_REQUIRED) != <span class="number">0</span>) &#123;</span><br><span class="line">            <span class="keyword">if</span> (mPermissionReviewRequired == <span class="keyword">null</span>) &#123;</span><br><span class="line">                mPermissionReviewRequired = <span class="keyword">new</span> SparseBooleanArray();</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="comment">//【4.1】如果在该 userId 下需要重新申请，那么就将其添加到 mPermissionReviewRequired 中！</span></span><br><span class="line">            mPermissionReviewRequired.put(userId, <span class="keyword">true</span>);</span><br><span class="line">        &#125; <span class="keyword">else</span> <span class="keyword">if</span> ((oldFlags &amp; PackageManager.FLAG_PERMISSION_REVIEW_REQUIRED) != <span class="number">0</span></span><br><span class="line">                &amp;&amp; (newFlags &amp; PackageManager.FLAG_PERMISSION_REVIEW_REQUIRED) == <span class="number">0</span>) &#123;</span><br><span class="line">            <span class="comment">//【4.2】如果在该 userId 下不需要重新申请，那么就将其从 mPermissionReviewRequired 中移除！</span></span><br><span class="line">            <span class="keyword">if</span> (mPermissionReviewRequired != <span class="keyword">null</span>) &#123;</span><br><span class="line">                mPermissionReviewRequired.delete(userId);</span><br><span class="line">                <span class="keyword">if</span> (mPermissionReviewRequired.size() &lt;= <span class="number">0</span>) &#123;</span><br><span class="line">                    mPermissionReviewRequired = <span class="keyword">null</span>;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> updated;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>对于 mayChangeFlags，由于我们 flagMask 传入的是 PackageManager.MASK_PERMISSION_FLAGS，那就意味了需要更新 flags！</p>
<p>可以看到，如果 mayChangeFlags 为 true 的话，即使没有权限对应的 PermissionData 也会创建，因为这次会更新 flags！</p>
<p>PermissionData.getFlags 方法会获得权限旧的 flags！</p>
<p>重点的操作在 PermissionData.updateFlag 方法中：</p>
<h3 id="9-3-1-PermissionData-updateFlags"><a href="#9-3-1-PermissionData-updateFlags" class="headerlink" title="9.3.1 PermissionData.updateFlags"></a>9.3.1 PermissionData.updateFlags</h3><p>更新指定权限的 flags，flagValues 是本次解析获得的 flags！！</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">boolean</span> <span class="title">updateFlags</span><span class="params">(<span class="keyword">int</span> userId, <span class="keyword">int</span> flagMask, <span class="keyword">int</span> flagValues)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">if</span> (isInstallPermission()) &#123; <span class="comment">// 如果是安装时权限，那么 userId 为 UserHandle.USER_ALL;</span></span><br><span class="line">        userId = UserHandle.USER_ALL;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span> (!isCompatibleUserId(userId)) &#123; <span class="comment">// 如果 userId 不兼容，那么会直接返回！</span></span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">false</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">//【1】这里进行 &amp; 操作，保留了 flagValues 和 flagMask 相同的位！</span></span><br><span class="line">    <span class="keyword">final</span> <span class="keyword">int</span> newFlags = flagValues &amp; flagMask;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">//【2】获得该 userId 下的权限状态值！</span></span><br><span class="line">    PermissionState userState = mUserStates.get(userId);</span><br><span class="line">    <span class="keyword">if</span> (userState != <span class="keyword">null</span>) &#123;</span><br><span class="line">        <span class="keyword">final</span> <span class="keyword">int</span> oldFlags = userState.mFlags;</span><br><span class="line">        <span class="comment">// 取消旧的 flags，设置新的 flags！</span></span><br><span class="line">        userState.mFlags = (userState.mFlags &amp; ~flagMask) | newFlags;</span><br><span class="line">        <span class="keyword">if</span> (userState.isDefault()) &#123;</span><br><span class="line">            mUserStates.remove(userId);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">// 判断 flags 是否发生变化，如果发生了变化，那就返回 true！</span></span><br><span class="line">        <span class="keyword">return</span> userState.mFlags != oldFlags;</span><br><span class="line">    &#125; <span class="keyword">else</span> <span class="keyword">if</span> (newFlags != <span class="number">0</span>) &#123;</span><br><span class="line">        <span class="comment">// 如果该权限在该 userId 下没有状态信息，那就创建状态信息，直接设置新的 flags，返回 true！</span></span><br><span class="line">        userState = <span class="keyword">new</span> PermissionState(mPerm.name);</span><br><span class="line">        userState.mFlags = newFlags;</span><br><span class="line">        mUserStates.put(userId, userState);</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">true</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">false</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>这里有一个操作：</p>
<ul>
<li>首先，进行 &amp; 操作，保留了 flagValues 和 flagMask 相同的位，为 newFlags；</li>
<li>接着，userState.mFlags 表示旧的 flags，这里在 userState.mFlags 和 ~flagMask 中做了 &amp; 操作，等价于取了 userState.mFlags 和 flagMask 不同的位，然后加上 newFlags，作为新的 flags！</li>
</ul>
<h1 id="10-阶段总结"><a href="#10-阶段总结" class="headerlink" title="10 阶段总结"></a>10 阶段总结</h1><p>在这个阶段，PMS 主要完成了如下了几个过程：</p>
<p>一、解析 SystemConfig 系统配置，主要会解析一下系统属性：</p>
<p>1、group：系统中定义的 gid，保存到了 SystemConfig.mGlobalGids 中！</p>
<p>2、permission：系统权限，每一个权限都创建一个 PermissionEntry，保存到 SystemConfig.mPermissions 中；<br>               PermissionEntry 有如下属性：name 权限名：perUser：表示该权限的 gid 是否针对不同的 userId 做调整；gids：该权限所属 gid</p>
<p>3、assign-permission：系统 uid 和其具有的权限，保存到了 SystemConfig.mSystemPermissions 中！每一个 uid 都对应一个或多个权限；</p>
<p>4、library：共享库信息，保存到了 SystemConfig.mSharedLibraries 中！</p>
<p>5、feature：特性信息，保存到了 SystemConfig.mAvailableFeatures 和 SystemConfig.mUnavailableFeatures 中！</p>
<p>这里我们重点看一些属性的解析，其他的属性我们先不关注！</p>
<p>然后将 SystemConfig 中的一些解析结果保存到 Settings 中：</p>
<p>Settings.mGlobalGids = systemConfig.getGlobalGids();<br>Settings.mSystemPermissions = systemConfig.getSystemPermissions();<br>Settings.mAvailableFeatures = systemConfig.getAvailableFeatures();</p>
<p>接着处理 SystemConfig.mPermissions 中解析到的系统权限！</p>
<p>对于每一个 PermissionEntry 创建一个 BasePermission 对象：<br>    在创建时会设置 BasePermission.name 为权限名；<br>    设置 BasePermission.sourcePackage 为定义权限的源包，因为是系统权限，所以为 android；<br>    设置 BasePermission.type 权限类型为 BasePermission.TYPE_BUILTIN；<br>    设置 BasePermission.protectionLevel 权限级别默认为 PermissionInfo.PROTECTION_SIGNATURE;</p>
<p>同时会设置 BasePermission.perUser 为 PermissionEntry.perUser；<br>同时会设置 BasePermission.gids 为 PermissionEntry.gids；</p>
<p>最后新创建的 BasePermission，会添加到 Settings.mPermissions 集合中！</p>
<p>二、读取上一次的安装信息！</p>
</div></article><script data-ad-client="ca-pub-6845729157331145" async="" src="https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script><div class="post-copyright"><div class="post-copyright__author"><span class="post-copyright-meta">文章作者: </span><span class="post-copyright-info"><a href="mailto:undefined">Coolqi.Li</a></span></div><div class="post-copyright__type"><span class="post-copyright-meta">文章链接: </span><span class="post-copyright-info"><a href="https://lishuaiqi.top/2018/01/26/PMS2-PMS_START/">https://lishuaiqi.top/2018/01/26/PMS2-PMS_START/</a></span></div><div class="post-copyright__notice"><span class="post-copyright-meta">版权声明: </span><span class="post-copyright-info">本博客所有文章除特别声明外，均采用 <a href="https://creativecommons.org/licenses/by-nc-sa/4.0/">CC BY-NC-SA 4.0</a> 许可协议。转载请注明来自 <a href="https://lishuaiqi.top">Coolqi`s Blog</a>！</span></div></div><div class="post-meta__tag-list"><a class="post-meta__tags" href="/tags/PackageManager包管理/">PackageManager包管理</a></div><div class="post-qr-code"><div class="post-qr-code-item"><img class="post-qr-code__img" src="/img/zfb.jpg"><div class="post-qr-code__desc">支付宝打赏</div></div><div class="post-qr-code-item"><img class="post-qr-code__img" src="/img/wechat.jpg"><div class="post-qr-code__desc">微信打赏</div></div></div><div class="social-share"></div><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/social-share.js@1.0.16/dist/css/share.min.css"><script src="https://cdn.jsdelivr.net/npm/social-share.js@1.0.16/dist/js/social-share.min.js"></script><nav id="pagination"><div class="prev-post pull-left"><a href="/2018/02/05/PMS3-PMS_SYSTEM_SCAN_START/"><i class="fa fa-chevron-left">  </i><span>PMS 第 3 篇 - PMS_SYSTEM_SCAN_START 阶段</span></a></div><div class="next-post pull-right"><a href="/2018/01/03/PMS1-PackageManagerServiceInit/"><span>PMS 第 1 篇 - PackageManagerService 初始化</span><i class="fa fa-chevron-right"></i></a></div></nav></div></div><footer><div class="layout" id="footer"><div class="copyright">&copy;2015 - 2020 By Coolqi.Li</div><div class="framework-info"><span>驱动 - </span><a href="http://hexo.io"><span>Hexo</span></a><span class="footer-separator">|</span><span>主题 - </span><a href="https://github.com/Molunerfinn/hexo-theme-melody"><span>Melody</span></a></div><div class="footer_custom_text">Hi, welcome to my <a href="https://lishuaiqi.top/">blog</a>!</div><div class="busuanzi"><script async src="https://busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script><span id="busuanzi_container_page_pv"><i class="fa fa-file-o"></i><span id="busuanzi_value_page_pv"></span><span></span></span></div></div></footer><i class="fa fa-arrow-up" id="go-up" aria-hidden="true"></i><script src="/js/third-party/anime.min.js"></script><script src="/js/third-party/jquery.min.js"></script><script src="/js/third-party/jquery.fancybox.min.js"></script><script src="/js/third-party/velocity.min.js"></script><script src="/js/third-party/velocity.ui.min.js"></script><script src="/js/utils.js?version=1.5.6"></script><script src="/js/fancybox.js?version=1.5.6"></script><script src="/js/sidebar.js?version=1.5.6"></script><script src="/js/copy.js?version=1.5.6"></script><script src="/js/fireworks.js?version=1.5.6"></script><script src="/js/transition.js?version=1.5.6"></script><script src="/js/scroll.js?version=1.5.6"></script><script src="/js/head.js?version=1.5.6"></script><script type="text/x-mathjax-config">MathJax.Hub.Config({
  tex2jax: {
    inlineMath: [ ['$','$'], ["\\(","\\)"]  ],
    processEscapes: true,
    skipTags: ['script', 'noscript', 'style', 'textarea', 'pre', 'code']
  },
  CommonHTML: {
    linebreaks: { automatic: true, width: "90% container" }
  },
  "HTML-CSS": { 
    linebreaks: { automatic: true, width: "90% container" }
  },
  "SVG": { 
    linebreaks: { automatic: true, width: "90% container" }
  }
});
</script><script type="text/x-mathjax-config">MathJax.Hub.Queue(function() {
  var all = MathJax.Hub.getAllJax(), i;
  for (i=0; i < all.length; i += 1) {
    all[i].SourceElement().parentNode.className += ' has-jax';
  }
});
</script><script src="https://cdn.jsdelivr.net/npm/mathjax/MathJax.js?config=TeX-AMS-MML_HTMLorMML"></script><script src="/js/search/local-search.js"></script><div class="search-dialog" id="local-search"><div class="search-dialog__title" id="local-search-title">本地搜索</div><div id="local-input-panel"><div id="local-search-input"><div class="local-search-box"><input class="local-search-box--input" placeholder="搜索文章"></div></div></div><hr><div id="local-search-results"><div id="local-hits"></div><div id="local-stats"><div class="local-search-stats__hr" id="hr"><span>由</span> <a href="https://github.com/wzpan/hexo-generator-search" style="color:#49B1F5;">hexo-generator-search</a>
 <span>提供支持</span></div></div></div><span class="search-close-button"><i class="fa fa-times"></i></span></div><div class="search-mask"></div></body></html>
<!DOCTYPE html><html lang="zh-Hans"><head><meta charset="UTF-8"><meta http-equiv="X-UA-Compatible" content="IE=edge"><meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1"><meta name="description" content="PMS 第 8 篇 - 通过 PackageInstaller 分析 Install 过程"><meta name="keywords" content="PackageManager包管理"><meta name="author" content="Coolqi.Li,undefined"><meta name="copyright" content="Coolqi.Li"><title>PMS 第 8 篇 - 通过 PackageInstaller 分析 Install 过程 | Coolqi`s Blog</title><link rel="shortcut icon" href="/img/favicon.ico"><link rel="stylesheet" href="/css/index.css?version=1.5.6"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/font-awesome@4.7.0/css/font-awesome.min.css?version=1.5.6"><link rel="dns-prefetch" href="https://cdn.staticfile.org"><link rel="dns-prefetch" href="https://cdn.bootcss.com"><link rel="dns-prefetch" href="https://creativecommons.org"><script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script><script>(adsbygoogle = window.adsbygoogle || []).push({
  google_ad_client: 'ca-pub-6845729157331145',
  enable_page_level_ads: 'true'
});
</script><link rel="dns-prefetch" href="https://hm.baidu.com"><script>var _hmt = _hmt || [];
(function() {
  var hm = document.createElement("script");
  hm.src = "https://hm.baidu.com/hm.js?b7acef5306e54116ad8a99e8b753a92d";
  var s = document.getElementsByTagName("script")[0]; 
  s.parentNode.insertBefore(hm, s);
})();</script><script>var GLOBAL_CONFIG = { 
  root: '/',
  algolia: undefined,
  localSearch: {"path":"search.xml","languages":{"hits_empty":"找不到您查询的内容:${query}"}},
  copy: {
    success: '复制成功',
    error: '复制错误',
    noSupport: '浏览器不支持'
  }
} </script></head><body><i class="fa fa-arrow-right" id="toggle-sidebar" aria-hidden="true"></i><div id="sidebar"><div class="toggle-sidebar-info text-center"><span data-toggle="切换文章详情">切换站点概览</span><hr></div><div class="sidebar-toc"><div class="sidebar-toc__title">目录</div><div class="sidebar-toc__progress"><span class="progress-notice">你已经读了</span><span class="progress-num">0</span><span class="progress-percentage">%</span><div class="sidebar-toc__progress-bar"></div></div><div class="sidebar-toc__content"><ol class="toc"><li class="toc-item toc-level-1"><a class="toc-link" href="#0-综述"><span class="toc-text">0 综述</span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#1-PackageInstallerActivity-onCreate"><span class="toc-text">1 PackageInstallerActivity.onCreate</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#1-1-processPackageUri"><span class="toc-text">1.1 processPackageUri</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#1-1-1-PackageUtil-getPackageInfo"><span class="toc-text">1.1.1 PackageUtil.getPackageInfo</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#1-1-2-PackageParser-generatePackageInfo"><span class="toc-text">1.1.2 PackageParser.generatePackageInfo</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#1-1-3-PackageUtil-getAppSnippet"><span class="toc-text">1.1.3 PackageUtil.getAppSnippet</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#1-1-2-1-new-AppSnippet"><span class="toc-text">1.1.2.1 new AppSnippet</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#1-1-4-PackageUtil-initSnippetForNewApp"><span class="toc-text">1.1.4 PackageUtil.initSnippetForNewApp</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#1-2-checkIfAllowedAndInitiateInstall"><span class="toc-text">1.2 checkIfAllowedAndInitiateInstall</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#1-2-1-isInstallRequestFromUnknownSource"><span class="toc-text">1.2.1 isInstallRequestFromUnknownSource</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#1-2-2-isUnknownSourcesDisallowed"><span class="toc-text">1.2.2 isUnknownSourcesDisallowed</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#1-2-3-isUnknownSourcesEnabled"><span class="toc-text">1.2.3 isUnknownSourcesEnabled</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#1-2-6-initiateInstall"><span class="toc-text">1.2.6 initiateInstall</span></a></li></ol></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#2-PackageInstallerActivity-startInstallConfirm"><span class="toc-text">2 PackageInstallerActivity.startInstallConfirm</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#2-1-new-AppSecurityPermissions"><span class="toc-text">2.1 new AppSecurityPermissions</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#2-1-1-AppSecurityPermissions-extractPerms"><span class="toc-text">2.1.1 AppSecurityPermissions.extractPerms</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#2-1-1-1-AppSecurityPermissions-isDisplayablePermission"><span class="toc-text">2.1.1.1 AppSecurityPermissions.isDisplayablePermission</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#2-1-1-2-new-MyPermissionGroupInfo"><span class="toc-text">2.1.1.2 new MyPermissionGroupInfo</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#2-1-1-3-new-MyPermissionInfo"><span class="toc-text">2.1.1.3 new MyPermissionInfo</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#2-1-2-AppSecurityPermissions-getAllUsedPermissions"><span class="toc-text">2.1.2 AppSecurityPermissions.getAllUsedPermissions</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#2-1-2-1-AppSecurityPermissions-getPermissionsForPackage"><span class="toc-text">2.1.2.1 AppSecurityPermissions.getPermissionsForPackage</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#2-1-3-AppSecurityPermissions-setPermissions"><span class="toc-text">2.1.3 AppSecurityPermissions.setPermissions</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#2-1-3-1-AppSecurityPermissions-setPermissions"><span class="toc-text">2.1.3.1 AppSecurityPermissions.setPermissions</span></a></li></ol></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#2-2-AppSecurityPermissions-getPermissionCount"><span class="toc-text">2.2 AppSecurityPermissions.getPermissionCount</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#2-2-1-AppSecurityPermissions-getPermissionList"><span class="toc-text">2.2.1 AppSecurityPermissions.getPermissionList</span></a></li></ol></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#3-onClick-gt-trigger-to-install"><span class="toc-text">3 onClick -&gt; trigger to install</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#3-1-PackageInstallerService-setPermissionsResult"><span class="toc-text">3.1 PackageInstallerService.setPermissionsResult</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#3-2-PackageInstallerSession-setPermissionsResult"><span class="toc-text">3.2 PackageInstallerSession.setPermissionsResult</span></a></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#4-PackageInstallerActivity-startInstall"><span class="toc-text">4 PackageInstallerActivity.startInstall</span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#5-InstallAppProgress"><span class="toc-text">5 InstallAppProgress</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#5-1-onCreate"><span class="toc-text">5.1 onCreate</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#5-1-1-new-BroadcastReceiver"><span class="toc-text">5.1.1 new BroadcastReceiver</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#5-2-initView"><span class="toc-text">5.2 initView</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#5-2-1-getInstallFlags"><span class="toc-text">5.2.1 getInstallFlags</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#5-2-2-PackageManagerService-installExistingPackage"><span class="toc-text">5.2.2 PackageManagerService.installExistingPackage</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#5-2-3-onPackageInstalled"><span class="toc-text">5.2.3 onPackageInstalled</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#5-2-3-1-Handler-handleMessage-INSTALL-COMPLETE"><span class="toc-text">5.2.3.1 Handler.handleMessage[INSTALL_COMPLETE]</span></a></li></ol></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#5-3-doPackageStage"><span class="toc-text">5.3 doPackageStage</span></a></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#6-onCreateDialog-gt-notify-user"><span class="toc-text">6 onCreateDialog -&gt; notify user</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#6-1-launchSecuritySettings"><span class="toc-text">6.1 launchSecuritySettings</span></a></li></ol></li></ol></div></div><div class="author-info hide"><div class="author-info__avatar text-center"><img src="/img/avatar.png"></div><div class="author-info__name text-center">Coolqi.Li</div><div class="author-info__description text-center">“你好，我是李帅奇，Android 系统工程师，MineCraft 忠实玩家，设计和绘画爱好者，缺妹纸晚期患者，熬夜星人。”</div><hr><div class="author-info-articles"><a class="author-info-articles__archives article-meta" href="/archives"><span class="pull-left">文章</span><span class="pull-right">77</span></a><a class="author-info-articles__tags article-meta" href="/tags"><span class="pull-left">标签</span><span class="pull-right">17</span></a><a class="author-info-articles__categories article-meta" href="/categories"><span class="pull-left">分类</span><span class="pull-right">19</span></a></div><hr><div class="author-info-links"><div class="author-info-links__title text-center">Links</div><a class="author-info-links__name text-center" href="https://developer.android.google.cn/">AndroidDeveloper</a><a class="author-info-links__name text-center" href="http://www.android-studio.org/">AndroidStudio</a><a class="author-info-links__name text-center" href="https://www.jianshu.com/u/123a20a96441">简书</a><a class="author-info-links__name text-center" href="https://weibo.com/coolqiLi">微博</a></div></div></div><div id="content-outer"><div id="top-container" style="background-image: url(https://ws1.sinaimg.cn/large/8700af19ly1fvpabr30o6j22yo1o0q7i.jpg)"><div id="page-header"><span class="pull-left"> <a id="site-name" href="/">Coolqi`s Blog</a></span><i class="fa fa-bars toggle-menu pull-right" aria-hidden="true"></i><span class="pull-right menus"><a class="site-page social-icon search"><i class="fa fa-search"></i><span> 搜索</span></a><a class="site-page" href="/">Home</a><a class="site-page" href="/categories">Categories</a><a class="site-page" href="/tags">Tags</a><a class="site-page" href="/archives">Archives</a><a class="site-page" href="/about">About</a></span></div><div id="post-info"><div id="post-title">PMS 第 8 篇 - 通过 PackageInstaller 分析 Install 过程</div><div id="post-meta"><time class="post-meta__date"><i class="fa fa-calendar" aria-hidden="true"></i> 2018-07-23</time><span class="post-meta__separator">|</span><i class="fa fa-inbox post-meta__icon" aria-hidden="true"></i><a class="post-meta__categories" href="/categories/AndroidFramework源码分析/">AndroidFramework源码分析</a><i class="fa fa-angle-right" aria-hidden="true"></i><i class="fa fa-inbox post-meta__icon" aria-hidden="true"></i><a class="post-meta__categories" href="/categories/AndroidFramework源码分析/PackageManager包管理/">PackageManager包管理</a><div class="post-meta-wordcount"><span>字数总计: </span><span class="word-count">9.1k</span><span class="post-meta__separator">|</span><span>阅读时长: 42 分钟</span></div></div></div></div><div class="layout" id="content-inner"><article id="post"><div class="article-container" id="post-content"><p>[toc]</p>
<p>基于 Android7.1.1 分析 PackageManagerService 的逻辑，Android 版本虽然会不断更替，但是代码结构和思想史</p>
<h1 id="0-综述"><a href="#0-综述" class="headerlink" title="0 综述"></a>0 综述</h1><p>前面总结了通过 pm install 的方式来安装一个 apk，但是这种方式用户是不经常使用的，用户使用的安装途径主要如下：</p>
<ul>
<li>通过应用商店下载 apk，进行安装；</li>
<li>将 apk 文件移动到关键管理器，点击触发安装；</li>
</ul>
<p>这里我们来看看第二种情况！</p>
<p>对于第二种中情况，当我们触发安装的时候，实际上是发送了一个 intent，这个 intent 中携带了 apk 的文件路径等参数，在 sample 给出了如下的启动安装的方式：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">private</span> OnClickListener mUnknownSourceListener = <span class="keyword">new</span> OnClickListener() &#123;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onClick</span><span class="params">(View v)</span> </span>&#123;</span><br><span class="line">        Intent intent = <span class="keyword">new</span> Intent(Intent.ACTION_INSTALL_PACKAGE);</span><br><span class="line">        intent.setData(Uri.fromFile(prepareApk(<span class="string">"HelloActivity.apk"</span>)));</span><br><span class="line">        startActivity(intent);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="keyword">private</span> OnClickListener mMySourceListener = <span class="keyword">new</span> OnClickListener() &#123;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onClick</span><span class="params">(View v)</span> </span>&#123;</span><br><span class="line">        Intent intent = <span class="keyword">new</span> Intent(Intent.ACTION_INSTALL_PACKAGE);</span><br><span class="line">        intent.setData(Uri.fromFile(prepareApk(<span class="string">"HelloActivity.apk"</span>)));</span><br><span class="line">        intent.putExtra(Intent.EXTRA_NOT_UNKNOWN_SOURCE, <span class="keyword">true</span>);</span><br><span class="line">        intent.putExtra(Intent.EXTRA_RETURN_RESULT, <span class="keyword">true</span>);</span><br><span class="line">        intent.putExtra(Intent.EXTRA_INSTALLER_PACKAGE_NAME,</span><br><span class="line">                getApplicationInfo().packageName);</span><br><span class="line">        startActivityForResult(intent, REQUEST_INSTALL);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="keyword">private</span> OnClickListener mReplaceListener = <span class="keyword">new</span> OnClickListener() &#123;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onClick</span><span class="params">(View v)</span> </span>&#123;</span><br><span class="line">        Intent intent = <span class="keyword">new</span> Intent(Intent.ACTION_INSTALL_PACKAGE);</span><br><span class="line">        intent.setData(Uri.fromFile(prepareApk(<span class="string">"HelloActivity.apk"</span>)));</span><br><span class="line">        intent.putExtra(Intent.EXTRA_NOT_UNKNOWN_SOURCE, <span class="keyword">true</span>);</span><br><span class="line">        intent.putExtra(Intent.EXTRA_RETURN_RESULT, <span class="keyword">true</span>);</span><br><span class="line">        intent.putExtra(Intent.EXTRA_ALLOW_REPLACE, <span class="keyword">true</span>);</span><br><span class="line">        intent.putExtra(Intent.EXTRA_INSTALLER_PACKAGE_NAME,</span><br><span class="line">                getApplicationInfo().packageName);</span><br><span class="line">        startActivityForResult(intent, REQUEST_INSTALL);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>
<p>那谁来接收这个 intent 呢？显而易见，PacakgeInstaller，我们去其说明书中看看：</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">activity</span> <span class="attr">android:name</span>=<span class="string">".PackageInstallerActivity"</span></span></span><br><span class="line"><span class="tag">        <span class="attr">android:configChanges</span>=<span class="string">"orientation|keyboardHidden|screenSize"</span></span></span><br><span class="line"><span class="tag">        <span class="attr">android:excludeFromRecents</span>=<span class="string">"true"</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">intent-filter</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">action</span> <span class="attr">android:name</span>=<span class="string">"android.intent.action.VIEW"</span> /&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">action</span> <span class="attr">android:name</span>=<span class="string">"android.intent.action.INSTALL_PACKAGE"</span> /&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">category</span> <span class="attr">android:name</span>=<span class="string">"android.intent.category.DEFAULT"</span> /&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">data</span> <span class="attr">android:scheme</span>=<span class="string">"file"</span> /&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">data</span> <span class="attr">android:scheme</span>=<span class="string">"content"</span> /&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">data</span> <span class="attr">android:mimeType</span>=<span class="string">"application/vnd.android.package-archive"</span> /&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">intent-filter</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">intent-filter</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">action</span> <span class="attr">android:name</span>=<span class="string">"android.intent.action.INSTALL_PACKAGE"</span> /&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">category</span> <span class="attr">android:name</span>=<span class="string">"android.intent.category.DEFAULT"</span> /&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">data</span> <span class="attr">android:scheme</span>=<span class="string">"file"</span> /&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">data</span> <span class="attr">android:scheme</span>=<span class="string">"package"</span> /&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">data</span> <span class="attr">android:scheme</span>=<span class="string">"content"</span> /&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">intent-filter</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">intent-filter</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">action</span> <span class="attr">android:name</span>=<span class="string">"android.content.pm.action.CONFIRM_PERMISSIONS"</span> /&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">category</span> <span class="attr">android:name</span>=<span class="string">"android.intent.category.DEFAULT"</span> /&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">intent-filter</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">activity</span>&gt;</span></span><br></pre></td></tr></table></figure>
<p>我们看到 PackageInstallerActivity 接收了 android.intent.action.INSTALL_PACKAGE action！</p>
<p>下面我们来分析下整个流程：</p>
<h1 id="1-PackageInstallerActivity-onCreate"><a href="#1-PackageInstallerActivity-onCreate" class="headerlink" title="1 PackageInstallerActivity.onCreate"></a>1 PackageInstallerActivity.onCreate</h1><p>这里我们进入 PackageInstallerActivity，看看其做了什么处理：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">PackageInstallerActivity</span> <span class="keyword">extends</span> <span class="title">Activity</span> <span class="keyword">implements</span> <span class="title">OnCancelListener</span>, <span class="title">OnClickListener</span> </span>&#123;</span><br><span class="line">    ... ... ...</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title">onCreate</span><span class="params">(Bundle icicle)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">super</span>.onCreate(icicle);</span><br><span class="line"></span><br><span class="line">        mPm = getPackageManager();</span><br><span class="line">        mInstaller = mPm.getPackageInstaller();</span><br><span class="line">        mUserManager = (UserManager) getSystemService(Context.USER_SERVICE);</span><br><span class="line"></span><br><span class="line">        <span class="comment">//【1】获得安装传入的  Intent！</span></span><br><span class="line">        <span class="keyword">final</span> Intent intent = getIntent();</span><br><span class="line">        mOriginatingUid = getOriginatingUid(intent);</span><br><span class="line"></span><br><span class="line">        <span class="keyword">final</span> Uri packageUri;</span><br><span class="line">        </span><br><span class="line">        <span class="keyword">if</span> (PackageInstaller.ACTION_CONFIRM_PERMISSIONS.equals(intent.getAction())) &#123;</span><br><span class="line">            <span class="comment">//【2】这个广播我们在 pm install 中有见过，当 install 需要确认权限信息的时候，会发送 intent</span></span><br><span class="line">            <span class="comment">// 其实是最终发送了这个 action 给 PackageInstaller 中了，同时会把 sessionId 发过来！</span></span><br><span class="line">            <span class="keyword">final</span> <span class="keyword">int</span> sessionId = intent.getIntExtra(PackageInstaller.EXTRA_SESSION_ID, -<span class="number">1</span>);</span><br><span class="line">            <span class="keyword">final</span> PackageInstaller.SessionInfo info = mInstaller.getSessionInfo(sessionId);</span><br><span class="line">            <span class="keyword">if</span> (info == <span class="keyword">null</span> || !info.sealed || info.resolvedBaseCodePath == <span class="keyword">null</span>) &#123;</span><br><span class="line">                Log.w(TAG, <span class="string">"Session "</span> + mSessionId + <span class="string">" in funky state; ignoring"</span>);</span><br><span class="line">                finish();</span><br><span class="line">                <span class="keyword">return</span>;</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            mSessionId = sessionId;</span><br><span class="line">            packageUri = Uri.fromFile(<span class="keyword">new</span> File(info.resolvedBaseCodePath));</span><br><span class="line">            mOriginatingURI = <span class="keyword">null</span>;</span><br><span class="line">            mReferrerURI = <span class="keyword">null</span>;</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            <span class="comment">//【3】对于 install package 进入这里，会通过 getData 获得 packageUri！</span></span><br><span class="line">            mSessionId = -<span class="number">1</span>;</span><br><span class="line">            packageUri = intent.getData();</span><br><span class="line">            mOriginatingURI = intent.getParcelableExtra(Intent.EXTRA_ORIGINATING_URI);</span><br><span class="line">            mReferrerURI = intent.getParcelableExtra(Intent.EXTRA_REFERRER);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment">//【4】如果 packageUri 为 null，那么这里会返回结果给启动安装的界面：INVALID_URI！</span></span><br><span class="line">        <span class="keyword">if</span> (packageUri == <span class="keyword">null</span>) &#123;</span><br><span class="line">            Log.w(TAG, <span class="string">"Unspecified source"</span>);</span><br><span class="line">            setPmResult(PackageManager.INSTALL_FAILED_INVALID_URI);</span><br><span class="line">            finish();</span><br><span class="line">            <span class="keyword">return</span>;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (DeviceUtils.isWear(<span class="keyword">this</span>)) &#123; <span class="comment">// 可穿戴设备的逻辑，不关注！</span></span><br><span class="line">            showDialogInner(DLG_NOT_SUPPORTED_ON_WEAR);</span><br><span class="line">            <span class="keyword">return</span>;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment">//【5】初始化界面！</span></span><br><span class="line">        setContentView(R.layout.install_start);</span><br><span class="line">        mInstallConfirm = findViewById(R.id.install_confirm_panel);</span><br><span class="line">        mInstallConfirm.setVisibility(View.INVISIBLE);</span><br><span class="line">        mOk = (Button)findViewById(R.id.ok_button);</span><br><span class="line">        mCancel = (Button)findViewById(R.id.cancel_button);</span><br><span class="line">        mOk.setOnClickListener(<span class="keyword">this</span>);</span><br><span class="line">        mCancel.setOnClickListener(<span class="keyword">this</span>);</span><br><span class="line"></span><br><span class="line">        <span class="comment">//【*1.1】解析传入的 packageUri！</span></span><br><span class="line">        <span class="keyword">boolean</span> wasSetUp = processPackageUri(packageUri);</span><br><span class="line">        <span class="keyword">if</span> (!wasSetUp) &#123;</span><br><span class="line">            <span class="keyword">return</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">//【*1.2】解析传入的 packageUri！</span></span><br><span class="line">        checkIfAllowedAndInitiateInstall(<span class="keyword">false</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    ... ... ...</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>我们看到 PackageInstallerActivity 方法实现了 OnCancelListener, OnClickListener，用于响应界面事件。。。</p>
<h2 id="1-1-processPackageUri"><a href="#1-1-processPackageUri" class="headerlink" title="1.1 processPackageUri"></a>1.1 processPackageUri</h2><p>解析 Uri 被为要安装的 apk 设置合适的 installer，如果返回 true，表示设置成功了！</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">boolean</span> <span class="title">processPackageUri</span><span class="params">(<span class="keyword">final</span> Uri packageUri)</span> </span>&#123;</span><br><span class="line">    mPackageURI = packageUri;</span><br><span class="line">    <span class="comment">//【1】获得 scheme 属性，对应资源使用的协议！</span></span><br><span class="line">    <span class="keyword">final</span> String scheme = packageUri.getScheme();</span><br><span class="line">    <span class="keyword">final</span> PackageUtil.AppSnippet as;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">switch</span> (scheme) &#123;</span><br><span class="line">        <span class="keyword">case</span> SCHEME_PACKAGE: &#123; <span class="comment">//【1.1】package 类型!！</span></span><br><span class="line">            <span class="keyword">try</span> &#123;</span><br><span class="line">                mPkgInfo = mPm.getPackageInfo(packageUri.getSchemeSpecificPart(),</span><br><span class="line">                        PackageManager.GET_PERMISSIONS</span><br><span class="line">                                | PackageManager.GET_UNINSTALLED_PACKAGES);</span><br><span class="line">            &#125; <span class="keyword">catch</span> (NameNotFoundException e) &#123;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">if</span> (mPkgInfo == <span class="keyword">null</span>) &#123;</span><br><span class="line">                Log.w(TAG, <span class="string">"Requested package "</span> + packageUri.getScheme()</span><br><span class="line">                        + <span class="string">" not available. Discontinuing installation"</span>);</span><br><span class="line">                <span class="comment">//【*6/3】应用包异常，提示用户！</span></span><br><span class="line">                showDialogInner(DLG_PACKAGE_ERROR);</span><br><span class="line">                setPmResult(PackageManager.INSTALL_FAILED_INVALID_APK);</span><br><span class="line">                <span class="keyword">return</span> <span class="keyword">false</span>;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="comment">//【*1.1.2.1】创建 AppSnippet 实例！</span></span><br><span class="line">            as = <span class="keyword">new</span> PackageUtil.AppSnippet(mPm.getApplicationLabel(mPkgInfo.applicationInfo),</span><br><span class="line">                    mPm.getApplicationIcon(mPkgInfo.applicationInfo));</span><br><span class="line">        &#125; <span class="keyword">break</span>;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">case</span> SCHEME_FILE: &#123; <span class="comment">//【1.2】file 类型</span></span><br><span class="line">            File sourceFile = <span class="keyword">new</span> File(packageUri.getPath());</span><br><span class="line">            <span class="comment">//【*1.1.1】对 path 指定的 apk 进行解析，其实是创建了一个 PackageParser 对象，然后扫描 apk</span></span><br><span class="line">            <span class="comment">// 将结果封装为 PackageParser.Package 并返回！</span></span><br><span class="line">            PackageParser.Package parsed = PackageUtil.getPackageInfo(sourceFile);</span><br><span class="line"></span><br><span class="line">            <span class="keyword">if</span> (parsed == <span class="keyword">null</span>) &#123; <span class="comment">// 发生了 error！</span></span><br><span class="line">                Log.w(TAG, <span class="string">"Parse error when parsing manifest. Discontinuing installation"</span>);</span><br><span class="line">                <span class="comment">//【*6/3】应用包异常，提示用户！</span></span><br><span class="line">                showDialogInner(DLG_PACKAGE_ERROR);</span><br><span class="line">                setPmResult(PackageManager.INSTALL_FAILED_INVALID_APK);</span><br><span class="line">                <span class="keyword">return</span> <span class="keyword">false</span>;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="comment">//【*1.1.2】将解析到的 Package 转为 PackageInfo 对象！</span></span><br><span class="line">            <span class="comment">// 除了获取到了基本信息，这里还额外指定了获取该应用的定义的权限和申请的权限信息！</span></span><br><span class="line">            mPkgInfo = PackageParser.generatePackageInfo(parsed, <span class="keyword">null</span>,</span><br><span class="line">                    PackageManager.GET_PERMISSIONS, <span class="number">0</span>, <span class="number">0</span>, <span class="keyword">null</span>,</span><br><span class="line">                    <span class="keyword">new</span> PackageUserState());</span><br><span class="line">            <span class="comment">//【*1.1.3】获得 apk 的 AppSnippet 实例！</span></span><br><span class="line">            as = PackageUtil.getAppSnippet(<span class="keyword">this</span>, mPkgInfo.applicationInfo, sourceFile);</span><br><span class="line">        &#125; <span class="keyword">break</span>;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">case</span> SCHEME_CONTENT: &#123; <span class="comment">//【1.3】content 类型</span></span><br><span class="line">            mStagingAsynTask = <span class="keyword">new</span> StagingAsyncTask();</span><br><span class="line">            mStagingAsynTask.execute(packageUri);</span><br><span class="line">            <span class="keyword">return</span> <span class="keyword">false</span>;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">default</span>: &#123;</span><br><span class="line">            <span class="comment">//【1.4】不支持的资源协议，默认会进入这里！</span></span><br><span class="line">            Log.w(TAG, <span class="string">"Unsupported scheme "</span> + scheme);</span><br><span class="line">            setPmResult(PackageManager.INSTALL_FAILED_INVALID_URI);</span><br><span class="line">            clearCachedApkIfNeededAndFinish();</span><br><span class="line">            <span class="keyword">return</span> <span class="keyword">false</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">//【*1.1.4】继续处理 AppSnippet 实例！</span></span><br><span class="line">    PackageUtil.initSnippetForNewApp(<span class="keyword">this</span>, as, R.id.app_snippet);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">true</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>对于安装文件管理器的 apk 的方式，其 scheme 值为 file，所以这里</p>
<p>对于 package 的解析流程，这里就不再多说了；</p>
<p>而 generatePackageInfo 方法的逻辑也很简单，flags 可以通过设置指定的位来获取特定的数据！</p>
<h3 id="1-1-1-PackageUtil-getPackageInfo"><a href="#1-1-1-PackageUtil-getPackageInfo" class="headerlink" title="1.1.1 PackageUtil.getPackageInfo"></a>1.1.1 PackageUtil.getPackageInfo</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> PackageParser.<span class="function">Package <span class="title">getPackageInfo</span><span class="params">(File sourceFile)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">final</span> PackageParser parser = <span class="keyword">new</span> PackageParser();</span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> parser.parsePackage(sourceFile, <span class="number">0</span>);</span><br><span class="line">    &#125; <span class="keyword">catch</span> (PackageParserException e) &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">null</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h3 id="1-1-2-PackageParser-generatePackageInfo"><a href="#1-1-2-PackageParser-generatePackageInfo" class="headerlink" title="1.1.2 PackageParser.generatePackageInfo"></a>1.1.2 PackageParser.generatePackageInfo</h3><p>将解析到的 Package 封装为指定的 PackageInfo 对象，除了基本的信息之外，还有通过 flags 指定的额外信息！</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">static</span> PackageInfo <span class="title">generatePackageInfo</span><span class="params">(PackageParser.Package p,</span></span></span><br><span class="line"><span class="function"><span class="params">        <span class="keyword">int</span> gids[], <span class="keyword">int</span> flags, <span class="keyword">long</span> firstInstallTime, <span class="keyword">long</span> lastUpdateTime,</span></span></span><br><span class="line"><span class="function"><span class="params">        Set&lt;String&gt; grantedPermissions, PackageUserState state, <span class="keyword">int</span> userId)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">if</span> (!checkUseInstalledOrHidden(flags, state) || !p.isMatch(flags)) &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">null</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">//【1】创建一个 PackageInfo 实例！</span></span><br><span class="line">    PackageInfo pi = <span class="keyword">new</span> PackageInfo();</span><br><span class="line">    pi.packageName = p.packageName;</span><br><span class="line">    pi.splitNames = p.splitNames;</span><br><span class="line">    pi.versionCode = p.mVersionCode;</span><br><span class="line">    pi.baseRevisionCode = p.baseRevisionCode;</span><br><span class="line">    pi.splitRevisionCodes = p.splitRevisionCodes;</span><br><span class="line">    pi.versionName = p.mVersionName;</span><br><span class="line">    pi.sharedUserId = p.mSharedUserId;</span><br><span class="line">    pi.sharedUserLabel = p.mSharedUserLabel;</span><br><span class="line">    pi.applicationInfo = generateApplicationInfo(p, flags, state, userId);</span><br><span class="line">    pi.installLocation = p.installLocation;</span><br><span class="line">    pi.coreApp = p.coreApp;</span><br><span class="line">    <span class="keyword">if</span> ((pi.applicationInfo.flags&amp;ApplicationInfo.FLAG_SYSTEM) != <span class="number">0</span></span><br><span class="line">            || (pi.applicationInfo.flags&amp;ApplicationInfo.FLAG_UPDATED_SYSTEM_APP) != <span class="number">0</span>) &#123;</span><br><span class="line">        pi.requiredForAllUsers = p.mRequiredForAllUsers;</span><br><span class="line">    &#125;</span><br><span class="line">    pi.restrictedAccountType = p.mRestrictedAccountType;</span><br><span class="line">    pi.requiredAccountType = p.mRequiredAccountType;</span><br><span class="line">    pi.overlayTarget = p.mOverlayTarget;</span><br><span class="line">    pi.firstInstallTime = firstInstallTime;</span><br><span class="line">    pi.lastUpdateTime = lastUpdateTime;</span><br><span class="line"></span><br><span class="line">    ... ... ... ... <span class="comment">// 这里省略了其他的 flags 处理！</span></span><br><span class="line">    </span><br><span class="line">    <span class="comment">//【2】获得应用的权限信息 GET_PERMISSIONS！</span></span><br><span class="line">    <span class="keyword">if</span> ((flags&amp;PackageManager.GET_PERMISSIONS) != <span class="number">0</span>) &#123;</span><br><span class="line">        <span class="comment">//【2.1】获得其定义的权限；</span></span><br><span class="line">        <span class="keyword">int</span> N = p.permissions.size();</span><br><span class="line">        <span class="keyword">if</span> (N &gt; <span class="number">0</span>) &#123;</span><br><span class="line">            pi.permissions = <span class="keyword">new</span> PermissionInfo[N];</span><br><span class="line">            <span class="keyword">for</span> (<span class="keyword">int</span> i=<span class="number">0</span>; i&lt;N; i++) &#123;</span><br><span class="line">                pi.permissions[i] = generatePermissionInfo(p.permissions.get(i), flags);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">//【2.2】获得其申请的权限；</span></span><br><span class="line">        N = p.requestedPermissions.size();</span><br><span class="line">        <span class="keyword">if</span> (N &gt; <span class="number">0</span>) &#123;</span><br><span class="line">            pi.requestedPermissions = <span class="keyword">new</span> String[N];</span><br><span class="line">            pi.requestedPermissionsFlags = <span class="keyword">new</span> <span class="keyword">int</span>[N];</span><br><span class="line">            <span class="keyword">for</span> (<span class="keyword">int</span> i=<span class="number">0</span>; i&lt;N; i++) &#123;</span><br><span class="line">                <span class="keyword">final</span> String perm = p.requestedPermissions.get(i);</span><br><span class="line">                pi.requestedPermissions[i] = perm;</span><br><span class="line">                <span class="comment">//【2.2.1】更新申请的权限的 flags，设置 REQUESTED_PERMISSION_REQUIRED 标志位！</span></span><br><span class="line">                <span class="comment">// 如果该权限已经被授予，那么还会增加 REQUESTED_PERMISSION_GRANTED 标志位！</span></span><br><span class="line">                pi.requestedPermissionsFlags[i] |= PackageInfo.REQUESTED_PERMISSION_REQUIRED;</span><br><span class="line">                <span class="keyword">if</span> (grantedPermissions != <span class="keyword">null</span> &amp;&amp; grantedPermissions.contains(perm)) &#123;</span><br><span class="line">                    pi.requestedPermissionsFlags[i] |= PackageInfo.REQUESTED_PERMISSION_GRANTED;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    ... ... ...</span><br><span class="line">    <span class="keyword">return</span> pi;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>这里涉及到了几个标志位：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 表示该权限是应用程序运行必备的，用户不能 disable！</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="keyword">int</span> REQUESTED_PERMISSION_REQUIRED = <span class="number">1</span>&lt;&lt;<span class="number">0</span>;</span><br><span class="line"><span class="comment">// 权限是否已经授予！</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="keyword">int</span> REQUESTED_PERMISSION_GRANTED = <span class="number">1</span>&lt;&lt;<span class="number">1</span>;</span><br></pre></td></tr></table></figure>
<p>这两个标签都是在 generatePackageInfo 方法中，配合 GET_PERMISSIONS 方法使用！</p>
<h3 id="1-1-3-PackageUtil-getAppSnippet"><a href="#1-1-3-PackageUtil-getAppSnippet" class="headerlink" title="1.1.3 PackageUtil.getAppSnippet"></a>1.1.3 PackageUtil.getAppSnippet</h3><p>这个方法用于加载应用的 label 和 icon：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">static</span> AppSnippet <span class="title">getAppSnippet</span><span class="params">(</span></span></span><br><span class="line"><span class="function"><span class="params">        Activity pContext, ApplicationInfo appInfo, File sourceFile)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">final</span> String archiveFilePath = sourceFile.getAbsolutePath();</span><br><span class="line">    Resources pRes = pContext.getResources();</span><br><span class="line">    AssetManager assmgr = <span class="keyword">new</span> AssetManager();</span><br><span class="line">    <span class="comment">//【1】设置资源加载路径！</span></span><br><span class="line">    assmgr.addAssetPath(archiveFilePath);</span><br><span class="line">    Resources res = <span class="keyword">new</span> Resources(assmgr, pRes.getDisplayMetrics(), pRes.getConfiguration());</span><br><span class="line">    CharSequence label = <span class="keyword">null</span>;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">//【2】尝试先从资源文件中加载 label！</span></span><br><span class="line">    <span class="keyword">if</span> (appInfo.labelRes != <span class="number">0</span>) &#123;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            label = res.getText(appInfo.labelRes);</span><br><span class="line">        &#125; <span class="keyword">catch</span> (Resources.NotFoundException e) &#123;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">//【3】如果没有显式定义的话，那么就会使用包名；</span></span><br><span class="line">    <span class="keyword">if</span> (label == <span class="keyword">null</span>) &#123;</span><br><span class="line">        label = (appInfo.nonLocalizedLabel != <span class="keyword">null</span>) ?</span><br><span class="line">                appInfo.nonLocalizedLabel : appInfo.packageName;</span><br><span class="line">    &#125;</span><br><span class="line">    Drawable icon = <span class="keyword">null</span>;</span><br><span class="line">    <span class="comment">//【4】尝试从资源文件获取图标，如果没有定义，那么我们会从系统中获取默认图标！</span></span><br><span class="line">    <span class="keyword">if</span> (appInfo.icon != <span class="number">0</span>) &#123;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            icon = res.getDrawable(appInfo.icon);</span><br><span class="line">        &#125; <span class="keyword">catch</span> (Resources.NotFoundException e) &#123;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span> (icon == <span class="keyword">null</span>) &#123;</span><br><span class="line">        icon = pContext.getPackageManager().getDefaultActivityIcon();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//【*1.1.2.1】创建了一个 AppSnippet 对象！</span></span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">new</span> PackageUtil.AppSnippet(label, icon);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h4 id="1-1-2-1-new-AppSnippet"><a href="#1-1-2-1-new-AppSnippet" class="headerlink" title="1.1.2.1 new AppSnippet"></a>1.1.2.1 new AppSnippet</h4><p>AppSnippet 用于保存 apk 的 label 和 icon：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">static</span> <span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">AppSnippet</span> </span>&#123;</span><br><span class="line">    CharSequence label;</span><br><span class="line">    Drawable icon;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="title">AppSnippet</span><span class="params">(CharSequence label, Drawable icon)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">this</span>.label = label;</span><br><span class="line">        <span class="keyword">this</span>.icon = icon;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h3 id="1-1-4-PackageUtil-initSnippetForNewApp"><a href="#1-1-4-PackageUtil-initSnippetForNewApp" class="headerlink" title="1.1.4 PackageUtil.initSnippetForNewApp"></a>1.1.4 PackageUtil.initSnippetForNewApp</h3><p>根据返回的 AppSnippet，初始化界面，显示应用的名称和 label：<br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">static</span> View <span class="title">initSnippetForNewApp</span><span class="params">(Activity pContext, AppSnippet as,</span></span></span><br><span class="line"><span class="function"><span class="params">        <span class="keyword">int</span> snippetId)</span> </span>&#123;</span><br><span class="line">    View appSnippet = pContext.findViewById(snippetId);</span><br><span class="line">    ((ImageView)appSnippet.findViewById(R.id.app_icon)).setImageDrawable(as.icon);</span><br><span class="line">    ((TextView)appSnippet.findViewById(R.id.app_name)).setText(as.label);</span><br><span class="line">    <span class="keyword">return</span> appSnippet;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<h2 id="1-2-checkIfAllowedAndInitiateInstall"><a href="#1-2-checkIfAllowedAndInitiateInstall" class="headerlink" title="1.2 checkIfAllowedAndInitiateInstall"></a>1.2 checkIfAllowedAndInitiateInstall</h2><p>用于判断是否允许安装，如果允许安装，那就进行初始化；否则会弹出提示框，参数 ignoreUnknownSourcesSettings 表示是否忽视未知来源安装，这里我们传入的是 false；</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">checkIfAllowedAndInitiateInstall</span><span class="params">(<span class="keyword">boolean</span> ignoreUnknownSourcesSettings)</span> </span>&#123;</span><br><span class="line">    <span class="comment">//【*1.2.1】判断本次安装是否是来自未知来源！</span></span><br><span class="line">    <span class="keyword">final</span> <span class="keyword">boolean</span> requestFromUnknownSource = isInstallRequestFromUnknownSource(getIntent());</span><br><span class="line">    <span class="keyword">if</span> (!requestFromUnknownSource) &#123;</span><br><span class="line">        <span class="comment">//【*1.2.6】如果是特权应用发送的安装，那么就初始化安装！</span></span><br><span class="line">        initiateInstall();</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">//【1】判断当前所在 user 是否是在另外一个 user 的 profile 中！</span></span><br><span class="line">    <span class="keyword">final</span> <span class="keyword">boolean</span> isManagedProfile = mUserManager.isManagedProfile();</span><br><span class="line">    <span class="comment">//【*1.2.2】判断当前用户是否设置了不允许位置来源的用户限制！</span></span><br><span class="line">    <span class="keyword">if</span> (isUnknownSourcesDisallowed()) &#123;</span><br><span class="line">        <span class="keyword">if</span> ((mUserManager.getUserRestrictionSource(UserManager.DISALLOW_INSTALL_UNKNOWN_SOURCES,</span><br><span class="line">                Process.myUserHandle()) &amp; UserManager.RESTRICTION_SOURCE_SYSTEM) != <span class="number">0</span>) &#123;</span><br><span class="line">            <span class="keyword">if</span> (ignoreUnknownSourcesSettings) &#123;</span><br><span class="line">                <span class="comment">//【*1.2.6】如果忽视未知来源，初始化安装！</span></span><br><span class="line">                initiateInstall();</span><br><span class="line">            &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                <span class="comment">//【*6/1】显示 DLG_UNKNOWN_SOURCES 弹窗！</span></span><br><span class="line">                showDialogInner(DLG_UNKNOWN_SOURCES);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            startActivity(<span class="keyword">new</span> Intent(Settings.ACTION_SHOW_ADMIN_SUPPORT_DETAILS));</span><br><span class="line">            clearCachedApkIfNeededAndFinish();</span><br><span class="line">        &#125;</span><br><span class="line">        </span><br><span class="line">    &#125; <span class="keyword">else</span> <span class="keyword">if</span> (!isUnknownSourcesEnabled() &amp;&amp; isManagedProfile) &#123;</span><br><span class="line">        <span class="comment">//【*1.2.3】如果没有设置用户限制，但是用户关闭了设置中的可未知来源安装</span></span><br><span class="line">        <span class="comment">// 同时当前用户是在另外用户的 profile 中！</span></span><br><span class="line">        <span class="comment">// 显示 DLG_ADMIN_RESTRICTS_UNKNOWN_SOURCES 弹窗！</span></span><br><span class="line">        <span class="comment">//【*6/2】提示用户！</span></span><br><span class="line">        showDialogInner(DLG_ADMIN_RESTRICTS_UNKNOWN_SOURCES);</span><br><span class="line"></span><br><span class="line">    &#125; <span class="keyword">else</span> <span class="keyword">if</span> (!isUnknownSourcesEnabled()) &#123;</span><br><span class="line">        <span class="comment">//【*1.2.3】如果用户关闭了设置中的可未知来源安装，并且我们忽视位置来源</span></span><br><span class="line">        <span class="comment">// 那么就立刻初始化！</span></span><br><span class="line">        <span class="keyword">if</span> (ignoreUnknownSourcesSettings) &#123;</span><br><span class="line">            <span class="comment">//【*1.2.6】初始化安装！</span></span><br><span class="line">            initiateInstall();</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            <span class="comment">//【*6/1】显示 DLG_UNKNOWN_SOURCES 弹窗！</span></span><br><span class="line">            showDialogInner(DLG_UNKNOWN_SOURCES);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        <span class="comment">//【*1.2.6】如果不是来自未知来源的安装，那么就初始化安装！</span></span><br><span class="line">        initiateInstall();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h3 id="1-2-1-isInstallRequestFromUnknownSource"><a href="#1-2-1-isInstallRequestFromUnknownSource" class="headerlink" title="1.2.1 isInstallRequestFromUnknownSource"></a>1.2.1 isInstallRequestFromUnknownSource</h3><p>判断本次安装是否来自未知来源：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">boolean</span> <span class="title">isInstallRequestFromUnknownSource</span><span class="params">(Intent intent)</span> </span>&#123;</span><br><span class="line">    String callerPackage = getCallingPackage();</span><br><span class="line">    <span class="comment">//【1】判断 intent 是否设置 EXTRA_NOT_UNKNOWN_SOURCE 为 true！</span></span><br><span class="line">    <span class="keyword">if</span> (callerPackage != <span class="keyword">null</span> &amp;&amp; intent.getBooleanExtra(</span><br><span class="line">            Intent.EXTRA_NOT_UNKNOWN_SOURCE, <span class="keyword">false</span>)) &#123;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            mSourceInfo = mPm.getApplicationInfo(callerPackage, <span class="number">0</span>);</span><br><span class="line">            <span class="keyword">if</span> (mSourceInfo != <span class="keyword">null</span>) &#123;</span><br><span class="line">                <span class="keyword">if</span> ((mSourceInfo.privateFlags &amp; ApplicationInfo.PRIVATE_FLAG_PRIVILEGED)</span><br><span class="line">                        != <span class="number">0</span>) &#123;</span><br><span class="line">                    <span class="comment">//【1.1】如果设置了为 true，只有特权应用发起安装时才不会视为未知来源；</span></span><br><span class="line">                    <span class="keyword">return</span> <span class="keyword">false</span>;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125; <span class="keyword">catch</span> (NameNotFoundException e) &#123;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">//【2】其他情况，无论你是否设置，都会视为未知来源！</span></span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">true</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h3 id="1-2-2-isUnknownSourcesDisallowed"><a href="#1-2-2-isUnknownSourcesDisallowed" class="headerlink" title="1.2.2 isUnknownSourcesDisallowed"></a>1.2.2 isUnknownSourcesDisallowed</h3><p>判断下当前设备用户是否限制来自未知来源的安装，也就是是否设置了 DISALLOW_INSTALL_UNKNOWN_SOURCES 用户限制：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">boolean</span> <span class="title">isUnknownSourcesDisallowed</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    <span class="keyword">return</span> mUserManager.hasUserRestriction(UserManager.DISALLOW_INSTALL_UNKNOWN_SOURCES);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h3 id="1-2-3-isUnknownSourcesEnabled"><a href="#1-2-3-isUnknownSourcesEnabled" class="headerlink" title="1.2.3 isUnknownSourcesEnabled"></a>1.2.3 isUnknownSourcesEnabled</h3><p>判断用户是否在设置中打开了位置来源限制：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">boolean</span> <span class="title">isUnknownSourcesEnabled</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    <span class="keyword">return</span> Settings.Secure.getInt(getContentResolver(),</span><br><span class="line">            Settings.Secure.INSTALL_NON_MARKET_APPS, <span class="number">0</span>) &gt; <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h3 id="1-2-6-initiateInstall"><a href="#1-2-6-initiateInstall" class="headerlink" title="1.2.6 initiateInstall"></a>1.2.6 initiateInstall</h3><p>初始化安装：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">initiateInstall</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    <span class="comment">//【1】获得要安装的应用包名！</span></span><br><span class="line">    String pkgName = mPkgInfo.packageName;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">//【2】判断下系统中是否存在该 pkg，但是被改为了其他名称，如果有，这里要调整下！</span></span><br><span class="line">    String[] oldName = mPm.canonicalToCurrentPackageNames(<span class="keyword">new</span> String[] &#123; pkgName &#125;);</span><br><span class="line">    <span class="keyword">if</span> (oldName != <span class="keyword">null</span> &amp;&amp; oldName.length &gt; <span class="number">0</span> &amp;&amp; oldName[<span class="number">0</span>] != <span class="keyword">null</span>) &#123;</span><br><span class="line">        pkgName = oldName[<span class="number">0</span>];</span><br><span class="line">        mPkgInfo.packageName = pkgName;</span><br><span class="line">        mPkgInfo.applicationInfo.packageName = pkgName;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//【3】判断该 pkg 是否已经安装过，如果是，弹出 replace 的弹窗；</span></span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">        <span class="comment">//【3.1】这里通过 GET_UNINSTALLED_PACKAGES 标志为获得该应用的安装信息</span></span><br><span class="line">        <span class="comment">// 如果该应用在系统中只有 data 数据，我们也会将其视为已经安装！</span></span><br><span class="line">        mAppInfo = mPm.getApplicationInfo(pkgName,</span><br><span class="line">                PackageManager.GET_UNINSTALLED_PACKAGES);</span><br><span class="line">        <span class="comment">//【3.2】判断是否有 FLAG_INSTALLED 标志为，如果没有，那就是没有安装过！</span></span><br><span class="line">        <span class="keyword">if</span> ((mAppInfo.flags&amp;ApplicationInfo.FLAG_INSTALLED) == <span class="number">0</span>) &#123;</span><br><span class="line">            mAppInfo = <span class="keyword">null</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125; <span class="keyword">catch</span> (NameNotFoundException e) &#123;</span><br><span class="line">        mAppInfo = <span class="keyword">null</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">//【*2】继续处理：</span></span><br><span class="line">    startInstallConfirm();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h1 id="2-PackageInstallerActivity-startInstallConfirm"><a href="#2-PackageInstallerActivity-startInstallConfirm" class="headerlink" title="2 PackageInstallerActivity.startInstallConfirm"></a>2 PackageInstallerActivity.startInstallConfirm</h1><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">startInstallConfirm</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    <span class="comment">//【1】初始化界面；</span></span><br><span class="line">    ((TextView) findViewById(R.id.install_confirm_question))</span><br><span class="line">            .setText(R.string.install_confirm_question);</span><br><span class="line">    findViewById(R.id.spacer).setVisibility(View.GONE);</span><br><span class="line">    TabHost tabHost = (TabHost)findViewById(android.R.id.tabhost);</span><br><span class="line">    tabHost.setup();</span><br><span class="line">    tabHost.setVisibility(View.VISIBLE);</span><br><span class="line">    ViewPager viewPager = (ViewPager)findViewById(R.id.pager);</span><br><span class="line">    TabsAdapter adapter = <span class="keyword">new</span> TabsAdapter(<span class="keyword">this</span>, tabHost, viewPager);</span><br><span class="line">    </span><br><span class="line">    <span class="comment">//【2】判断应用是否支持运行时权限！</span></span><br><span class="line">    <span class="keyword">boolean</span> supportsRuntimePermissions = mPkgInfo.applicationInfo.targetSdkVersion</span><br><span class="line">            &gt;= Build.VERSION_CODES.M;</span><br><span class="line">    <span class="keyword">boolean</span> permVisible = <span class="keyword">false</span>;</span><br><span class="line">    mScrollView = <span class="keyword">null</span>;</span><br><span class="line">    mOkCanInstall = <span class="keyword">false</span>;</span><br><span class="line">    <span class="keyword">int</span> msg = <span class="number">0</span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//【*2.1】创建了一个 AppSecurityPermissions 实例，封装 apk 的权限</span></span><br><span class="line">    AppSecurityPermissions perms = <span class="keyword">new</span> AppSecurityPermissions(<span class="keyword">this</span>, mPkgInfo);</span><br><span class="line">    <span class="comment">//【*2.2】获得应用的申请的所有权限数量！</span></span><br><span class="line">    <span class="keyword">final</span> <span class="keyword">int</span> N = perms.getPermissionCount(AppSecurityPermissions.WHICH_ALL);</span><br><span class="line"></span><br><span class="line">    <span class="comment">//【3】初始化界面，这里会用 mScrollView 来显示所有的权限信息，mAppInfo 不为 null，说明应用</span></span><br><span class="line">    <span class="comment">// 之前安装过！</span></span><br><span class="line">    <span class="keyword">if</span> (mAppInfo != <span class="keyword">null</span>) &#123;</span><br><span class="line">        msg = (mAppInfo.flags &amp; ApplicationInfo.FLAG_SYSTEM) != <span class="number">0</span></span><br><span class="line">                ? R.string.install_confirm_question_update_system</span><br><span class="line">                : R.string.install_confirm_question_update;</span><br><span class="line">        mScrollView = <span class="keyword">new</span> CaffeinatedScrollView(<span class="keyword">this</span>);</span><br><span class="line">        mScrollView.setFillViewport(<span class="keyword">true</span>);</span><br><span class="line">        <span class="keyword">boolean</span> newPermissionsFound = <span class="keyword">false</span>;</span><br><span class="line"></span><br><span class="line">        <span class="comment">//【3.1】不支持运行时权限，这里会尝试先获取该应用的一些新的权限；</span></span><br><span class="line">        <span class="keyword">if</span> (!supportsRuntimePermissions) &#123;</span><br><span class="line">             <span class="comment">//【*2.2】获得应用的申请的所有被视为新的权限的数量！</span></span><br><span class="line">            newPermissionsFound =</span><br><span class="line">                    (perms.getPermissionCount(AppSecurityPermissions.WHICH_NEW) &gt; <span class="number">0</span>);</span><br><span class="line">            <span class="keyword">if</span> (newPermissionsFound) &#123;</span><br><span class="line">                permVisible = <span class="keyword">true</span>;</span><br><span class="line">                mScrollView.addView(perms.getPermissionsView(</span><br><span class="line">                        AppSecurityPermissions.WHICH_NEW));</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">//【3.2】不支持运行时权限，同时没有新的申请的权限；</span></span><br><span class="line">        <span class="keyword">if</span> (!supportsRuntimePermissions &amp;&amp; !newPermissionsFound) &#123;</span><br><span class="line">            LayoutInflater inflater = (LayoutInflater)getSystemService(</span><br><span class="line">                    Context.LAYOUT_INFLATER_SERVICE);</span><br><span class="line">            TextView label = (TextView)inflater.inflate(R.layout.label, <span class="keyword">null</span>);</span><br><span class="line">            label.setText(R.string.no_new_perms);</span><br><span class="line">            mScrollView.addView(label);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">//【3.3】这里会通过 tabHost 新增一个页面，用于显示申请的新增权限！</span></span><br><span class="line">        adapter.addTab(tabHost.newTabSpec(TAB_ID_NEW).setIndicator(</span><br><span class="line">                getText(R.string.newPerms)), mScrollView);</span><br><span class="line">    &#125; <span class="keyword">else</span>  &#123;</span><br><span class="line">        findViewById(R.id.tabscontainer).setVisibility(View.GONE);</span><br><span class="line">        findViewById(R.id.spacer).setVisibility(View.VISIBLE);</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">//【3】如果不支持运行时权限，那么这里会处理申请的所有的权限！</span></span><br><span class="line">    <span class="keyword">if</span> (!supportsRuntimePermissions &amp;&amp; N &gt; <span class="number">0</span>) &#123;</span><br><span class="line">        permVisible = <span class="keyword">true</span>;</span><br><span class="line">        LayoutInflater inflater = (LayoutInflater)getSystemService(</span><br><span class="line">                Context.LAYOUT_INFLATER_SERVICE);</span><br><span class="line">        View root = inflater.inflate(R.layout.permissions_list, <span class="keyword">null</span>);</span><br><span class="line">        <span class="keyword">if</span> (mScrollView == <span class="keyword">null</span>) &#123;</span><br><span class="line">            mScrollView = (CaffeinatedScrollView)root.findViewById(R.id.scrollview);</span><br><span class="line">        &#125;</span><br><span class="line">        ((ViewGroup)root.findViewById(R.id.permission_list)).addView(</span><br><span class="line">                    perms.getPermissionsView(AppSecurityPermissions.WHICH_ALL));</span><br><span class="line">        <span class="comment">//【4】这里会通过 tabHost 新增一个页面，用于显示申请的所有的权限！</span></span><br><span class="line">        adapter.addTab(tabHost.newTabSpec(TAB_ID_ALL).setIndicator(</span><br><span class="line">                getText(R.string.allPerms)), root);</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">//【4】如果 permVisible 说明该应用没有要显示给用户的权限；</span></span><br><span class="line">    <span class="keyword">if</span> (!permVisible) &#123;</span><br><span class="line">        <span class="keyword">if</span> (mAppInfo != <span class="keyword">null</span>) &#123;</span><br><span class="line">            <span class="comment">//【4.1】处理应用覆盖安装的情况，设置 msg 为没有 update_system_no_perms 或 update_no_perms！</span></span><br><span class="line">            <span class="comment">// 这是资源 id，会在界面显示！</span></span><br><span class="line">            msg = (mAppInfo.flags &amp; ApplicationInfo.FLAG_SYSTEM) != <span class="number">0</span></span><br><span class="line">                    ? R.string.install_confirm_question_update_system_no_perms</span><br><span class="line">                    : R.string.install_confirm_question_update_no_perms;</span><br><span class="line"></span><br><span class="line">            findViewById(R.id.spacer).setVisibility(View.VISIBLE);</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            <span class="comment">//【4.1】处理应用全新安装的情况，设置 msg 为 no_perms，同上！</span></span><br><span class="line">            msg = R.string.install_confirm_question_no_perms;</span><br><span class="line">        &#125;</span><br><span class="line">        tabHost.setVisibility(View.INVISIBLE);</span><br><span class="line">        mScrollView = <span class="keyword">null</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span> (msg != <span class="number">0</span>) &#123;</span><br><span class="line">        ((TextView)findViewById(R.id.install_confirm_question)).setText(msg);</span><br><span class="line">    &#125;</span><br><span class="line">    mInstallConfirm.setVisibility(View.VISIBLE);</span><br><span class="line">    </span><br><span class="line">    <span class="comment">//【6】设置安装 button 可以点击！</span></span><br><span class="line">    mOk.setEnabled(<span class="keyword">true</span>);</span><br><span class="line">    <span class="keyword">if</span> (mScrollView == <span class="keyword">null</span>) &#123;</span><br><span class="line">        <span class="comment">//【6.1】如果不需要用 mScrollView 显示内容，那就直接显示安装</span></span><br><span class="line">        mOk.setText(R.string.install);</span><br><span class="line">        mOkCanInstall = <span class="keyword">true</span>;</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        <span class="comment">//【6.2】如果要显示权限信息，那么需要用户滚动界面，看完所有的权限信息</span></span><br><span class="line">        <span class="comment">// 安装 button 才可用！</span></span><br><span class="line">        mScrollView.setFullScrollAction(<span class="keyword">new</span> Runnable() &#123;</span><br><span class="line">            <span class="meta">@Override</span></span><br><span class="line">            <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">run</span><span class="params">()</span> </span>&#123;</span><br><span class="line">                mOk.setText(R.string.install);</span><br><span class="line">                mOkCanInstall = <span class="keyword">true</span>;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>不多说了，继续看！</p>
<h2 id="2-1-new-AppSecurityPermissions"><a href="#2-1-new-AppSecurityPermissions" class="headerlink" title="2.1 new AppSecurityPermissions"></a>2.1 new AppSecurityPermissions</h2><p>AppSecurityPermissions 有多个构造器，这里调用了 AppSecurityPermissions 的双参构造函数，同时 AppSecurityPermissions 内部也有很多的成员变量，我们来分析下：</p>
<p>这里的 PackageInfo info 表示的是本次要安装的应用程序的 PackageInfo 实例！</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">AppSecurityPermissions</span> </span>&#123;</span><br><span class="line">    ... ... ...</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="title">AppSecurityPermissions</span><span class="params">(Context context, PackageInfo info)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">this</span>(context);</span><br><span class="line">        <span class="comment">//【1】创建了一个 Set 集合用于收集权限</span></span><br><span class="line">        Set&lt;MyPermissionInfo&gt; permSet = <span class="keyword">new</span> HashSet&lt;MyPermissionInfo&gt;();</span><br><span class="line">        <span class="keyword">if</span>(info == <span class="keyword">null</span>) &#123;</span><br><span class="line">            <span class="keyword">return</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        mPackageName = info.packageName;</span><br><span class="line"></span><br><span class="line">        <span class="comment">//【2】用于保存已经安装的相同包名应用的信息！</span></span><br><span class="line">        PackageInfo installedPkgInfo = <span class="keyword">null</span>;</span><br><span class="line"></span><br><span class="line">        <span class="comment">//【3】如果应用有申请权限，那么就查询已经安装的同名应用（如果有）</span></span><br><span class="line">        <span class="comment">// 对应的权限信息，收集到 installedPkgInfo 中！</span></span><br><span class="line">        <span class="keyword">if</span> (info.requestedPermissions != <span class="keyword">null</span>) &#123;</span><br><span class="line">            <span class="keyword">try</span> &#123;</span><br><span class="line">                installedPkgInfo = mPm.getPackageInfo(info.packageName,</span><br><span class="line">                        PackageManager.GET_PERMISSIONS);</span><br><span class="line">            &#125; <span class="keyword">catch</span> (NameNotFoundException e) &#123;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="comment">//【*2.1.1】这里会比较本次安装的应用和已经安装的旧应用（如果有）的权限，做相应处理</span></span><br><span class="line">            <span class="comment">// 最后将权限保存到 permSet 集合中！</span></span><br><span class="line">            extractPerms(info, permSet, installedPkgInfo);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment">//【4】如果其是共享 uid 的，那么就要获得该 uid 的所有权限！</span></span><br><span class="line">        <span class="keyword">if</span> (info.sharedUserId != <span class="keyword">null</span>) &#123;</span><br><span class="line">            <span class="keyword">int</span> sharedUid;</span><br><span class="line">            <span class="keyword">try</span> &#123;</span><br><span class="line">                sharedUid = mPm.getUidForSharedUser(info.sharedUserId);</span><br><span class="line">                <span class="comment">//【*2.1.2】获得该 shared uid 的权限信息！</span></span><br><span class="line">                getAllUsedPermissions(sharedUid, permSet);</span><br><span class="line">            &#125; <span class="keyword">catch</span> (NameNotFoundException e) &#123;</span><br><span class="line">                Log.w(TAG, <span class="string">"Couldn't retrieve shared user id for: "</span> + info.packageName);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment">//【5】将搜集到的权限 set 集合加到 mPermsList 中！</span></span><br><span class="line">        mPermsList.addAll(permSet);</span><br><span class="line">        <span class="comment">//【*2.1.3】进一步设置权限！</span></span><br><span class="line">        setPermissions(mPermsList);</span><br><span class="line">    &#125;</span><br><span class="line">    ... ... ...</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>AppSecurityPermissions 中有如下重要变量：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//【1】所属的所有的权限组，组名和 MyPermissionGroupInfo 的映射关系；</span></span><br><span class="line"><span class="keyword">private</span> <span class="keyword">final</span> Map&lt;String, MyPermissionGroupInfo&gt; mPermGroups</span><br><span class="line">        = <span class="keyword">new</span> HashMap&lt;String, MyPermissionGroupInfo&gt;();</span><br><span class="line"><span class="comment">//【2】所属的所有的权限组；</span></span><br><span class="line"><span class="keyword">private</span> <span class="keyword">final</span> List&lt;MyPermissionGroupInfo&gt; mPermGroupsList</span><br><span class="line">        = <span class="keyword">new</span> ArrayList&lt;MyPermissionGroupInfo&gt;();</span><br><span class="line"><span class="comment">//【3】用于给权限组排序；</span></span><br><span class="line"><span class="keyword">private</span> <span class="keyword">final</span> PermissionGroupInfoComparator mPermGroupComparator =</span><br><span class="line">        <span class="keyword">new</span> PermissionGroupInfoComparator();</span><br><span class="line"><span class="comment">//【4】用于给权限排序；</span></span><br><span class="line"><span class="keyword">private</span> <span class="keyword">final</span> PermissionInfoComparator mPermComparator = <span class="keyword">new</span> PermissionInfoComparator();</span><br><span class="line"><span class="comment">//【5】应用请求的权限信息！</span></span><br><span class="line"><span class="keyword">private</span> <span class="keyword">final</span> List&lt;MyPermissionInfo&gt; mPermsList = <span class="keyword">new</span> ArrayList&lt;MyPermissionInfo&gt;();</span><br><span class="line"><span class="keyword">private</span> <span class="keyword">final</span> CharSequence mNewPermPrefix;</span><br><span class="line"><span class="keyword">private</span> String mPackageName;</span><br></pre></td></tr></table></figure>
<p>我们后面分析的时候会遇到！</p>
<h3 id="2-1-1-AppSecurityPermissions-extractPerms"><a href="#2-1-1-AppSecurityPermissions-extractPerms" class="headerlink" title="2.1.1 AppSecurityPermissions.extractPerms"></a>2.1.1 AppSecurityPermissions.extractPerms</h3><p>这里会比较本次安装的应用和已经安装的旧应用（如果有）的权限，做相应处理：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">extractPerms</span><span class="params">(PackageInfo info, Set&lt;MyPermissionInfo&gt; permSet,</span></span></span><br><span class="line"><span class="function"><span class="params">        PackageInfo installedPkgInfo)</span> </span>&#123;</span><br><span class="line">    String[] strList = info.requestedPermissions;</span><br><span class="line">    <span class="keyword">int</span>[] flagsList = info.requestedPermissionsFlags;</span><br><span class="line">    <span class="keyword">if</span> ((strList == <span class="keyword">null</span>) || (strList.length == <span class="number">0</span>)) &#123;</span><br><span class="line">        <span class="keyword">return</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">//【1】遍历处理权限！</span></span><br><span class="line">    <span class="keyword">for</span> (<span class="keyword">int</span> i=<span class="number">0</span>; i&lt;strList.length; i++) &#123;</span><br><span class="line">        String permName = strList[i];</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            <span class="comment">//【1.1】获得权限对应的 PermissionInfo 对象 tmpPermInfo，如果为 null 跳过！</span></span><br><span class="line">            PermissionInfo tmpPermInfo = mPm.getPermissionInfo(permName, <span class="number">0</span>);</span><br><span class="line">            <span class="keyword">if</span> (tmpPermInfo == <span class="keyword">null</span>) &#123;</span><br><span class="line">                <span class="keyword">continue</span>;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="comment">//【1.2】判断新安装的应用的权限在已经安装的应用（如果有）中是否存在，如果有 existingIndex 不为 -1；</span></span><br><span class="line">            <span class="comment">// existingIndex 为其在已经安装的应用的权限列表中的下标！</span></span><br><span class="line">            <span class="keyword">int</span> existingIndex = -<span class="number">1</span>;</span><br><span class="line">            <span class="keyword">if</span> (installedPkgInfo != <span class="keyword">null</span></span><br><span class="line">                    &amp;&amp; installedPkgInfo.requestedPermissions != <span class="keyword">null</span>) &#123;</span><br><span class="line">                <span class="keyword">for</span> (<span class="keyword">int</span> j=<span class="number">0</span>; j&lt;installedPkgInfo.requestedPermissions.length; j++) &#123;</span><br><span class="line">                    <span class="keyword">if</span> (permName.equals(installedPkgInfo.requestedPermissions[j])) &#123;</span><br><span class="line">                        existingIndex = j;</span><br><span class="line">                        <span class="keyword">break</span>;</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="comment">//【1.3】判断下该权限在已经安装的应用中的权限标志位；</span></span><br><span class="line">            <span class="keyword">final</span> <span class="keyword">int</span> existingFlags = existingIndex &gt;= <span class="number">0</span> ?</span><br><span class="line">                    installedPkgInfo.requestedPermissionsFlags[existingIndex] : <span class="number">0</span>;</span><br><span class="line"></span><br><span class="line">            <span class="comment">//【*2.1.1.1】判断该权限是否需要在界面给用户显示出来，不需要的话那就跳过该权限；</span></span><br><span class="line">            <span class="keyword">if</span> (!isDisplayablePermission(tmpPermInfo, flagsList[i], existingFlags)) &#123;</span><br><span class="line">                <span class="keyword">continue</span>;</span><br><span class="line">            &#125;</span><br><span class="line">            </span><br><span class="line">            <span class="comment">//【1.4】处理权限组名，默认为包名！</span></span><br><span class="line">            <span class="keyword">final</span> String origGroupName = tmpPermInfo.group;</span><br><span class="line">            String groupName = origGroupName;</span><br><span class="line">            <span class="keyword">if</span> (groupName == <span class="keyword">null</span>) &#123;</span><br><span class="line">                groupName = tmpPermInfo.packageName;</span><br><span class="line">                tmpPermInfo.group = groupName;</span><br><span class="line">            &#125;</span><br><span class="line">            </span><br><span class="line">            <span class="comment">//【1.5】获得/创建权限所属的权限组！</span></span><br><span class="line">            MyPermissionGroupInfo group = mPermGroups.get(groupName);</span><br><span class="line">            <span class="keyword">if</span> (group == <span class="keyword">null</span>) &#123;</span><br><span class="line">                PermissionGroupInfo grp = <span class="keyword">null</span>;</span><br><span class="line">                <span class="keyword">if</span> (origGroupName != <span class="keyword">null</span>) &#123;</span><br><span class="line">                    grp = mPm.getPermissionGroupInfo(origGroupName, <span class="number">0</span>);</span><br><span class="line">                &#125;</span><br><span class="line">                <span class="keyword">if</span> (grp != <span class="keyword">null</span>) &#123;</span><br><span class="line">                    <span class="comment">//【1.5.1】如果权限指定了所属的组，那么我们就查询组信息</span></span><br><span class="line">                    <span class="comment">// 然后创建 MyPermissionGroupInfo 实例，祖名为定义权限的包名！！</span></span><br><span class="line">                    group = <span class="keyword">new</span> MyPermissionGroupInfo(grp);</span><br><span class="line">                &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                    <span class="comment">//【1.5.2】如果权限没有指定所属的组，或者组无法查到，那么我们就</span></span><br><span class="line">                    <span class="comment">// 新建 MyPermissionGroupInfo 实例.，默认权限组名为权限定义的包名！</span></span><br><span class="line">                    tmpPermInfo.group = tmpPermInfo.packageName;</span><br><span class="line">                    group = mPermGroups.get(tmpPermInfo.group);</span><br><span class="line">                    <span class="keyword">if</span> (group == <span class="keyword">null</span>) &#123;</span><br><span class="line">                        group = <span class="keyword">new</span> MyPermissionGroupInfo(tmpPermInfo);</span><br><span class="line">                    &#125;</span><br><span class="line">                    group = <span class="keyword">new</span> MyPermissionGroupInfo(tmpPermInfo);</span><br><span class="line">                &#125;</span><br><span class="line">                <span class="comment">//【1.5.3】将该组加入到内部集合 mPermGroups 中！</span></span><br><span class="line">                mPermGroups.put(tmpPermInfo.group, group);</span><br><span class="line">            &#125;</span><br><span class="line">            </span><br><span class="line">            <span class="comment">//【1.6】判断该权限是否是一个新的权限，如果应用已经被安装了，同时并没有被授予该权限！</span></span><br><span class="line">            <span class="keyword">final</span> <span class="keyword">boolean</span> newPerm = installedPkgInfo != <span class="keyword">null</span></span><br><span class="line">                    &amp;&amp; (existingFlags&amp;PackageInfo.REQUESTED_PERMISSION_GRANTED) == <span class="number">0</span>;</span><br><span class="line">            </span><br><span class="line">            <span class="comment">//【×2.1.1.3】创建一个 MyPermissionInfo 对象，封装该权限信息；</span></span><br><span class="line">            MyPermissionInfo myPerm = <span class="keyword">new</span> MyPermissionInfo(tmpPermInfo);</span><br><span class="line">            myPerm.mNewReqFlags = flagsList[i];</span><br><span class="line">            myPerm.mExistingReqFlags = existingFlags;</span><br><span class="line"></span><br><span class="line">            <span class="comment">// This is a new permission if the app is already installed and</span></span><br><span class="line">            <span class="comment">// doesn't currently hold this permission.</span></span><br><span class="line">            myPerm.mNew = newPerm;</span><br><span class="line">            </span><br><span class="line">            <span class="comment">//【1.7】将该权限加入到内部集合 permSet 中；</span></span><br><span class="line">            permSet.add(myPerm);</span><br><span class="line">        &#125; <span class="keyword">catch</span> (NameNotFoundException e) &#123;</span><br><span class="line">            Log.i(TAG, <span class="string">"Ignoring unknown permission:"</span>+permName);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>不多说了。。</p>
<h4 id="2-1-1-1-AppSecurityPermissions-isDisplayablePermission"><a href="#2-1-1-1-AppSecurityPermissions-isDisplayablePermission" class="headerlink" title="2.1.1.1 AppSecurityPermissions.isDisplayablePermission"></a>2.1.1.1 AppSecurityPermissions.isDisplayablePermission</h4><p>isDisplayablePermission 用于判断哪些权限会在界面中显示，那些不显示：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">boolean</span> <span class="title">isDisplayablePermission</span><span class="params">(PermissionInfo pInfo, <span class="keyword">int</span> newReqFlags,</span></span></span><br><span class="line"><span class="function"><span class="params">        <span class="keyword">int</span> existingReqFlags)</span> </span>&#123;</span><br><span class="line">    <span class="comment">//【1】获得基本权限类型；</span></span><br><span class="line">    <span class="keyword">final</span> <span class="keyword">int</span> base = pInfo.protectionLevel &amp; PermissionInfo.PROTECTION_MASK_BASE;</span><br><span class="line">    <span class="keyword">final</span> <span class="keyword">boolean</span> isNormal = (base == PermissionInfo.PROTECTION_NORMAL);</span><br><span class="line"></span><br><span class="line">    <span class="comment">//【2】如果是 normal 权限类型，那么我们不会在界面显示，返回 false；</span></span><br><span class="line">    <span class="keyword">if</span> (isNormal) &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">false</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">//【3】新应用的该权限是否是 dangerous 类型的权限；</span></span><br><span class="line">    <span class="keyword">final</span> <span class="keyword">boolean</span> isDangerous = (base == PermissionInfo.PROTECTION_DANGEROUS)</span><br><span class="line">            || ((pInfo.protectionLevel&amp;PermissionInfo.PROTECTION_FLAG_PRE23) != <span class="number">0</span>);</span><br><span class="line">    <span class="comment">//【3】新应用的该权限是否是运行必须的；</span></span><br><span class="line">    <span class="keyword">final</span> <span class="keyword">boolean</span> isRequired =</span><br><span class="line">            ((newReqFlags&amp;PackageInfo.REQUESTED_PERMISSION_REQUIRED) != <span class="number">0</span>);</span><br><span class="line">    <span class="comment">//【4】新应用的该权限是否是 development 的签名权限！</span></span><br><span class="line">    <span class="keyword">final</span> <span class="keyword">boolean</span> isDevelopment =</span><br><span class="line">            ((pInfo.protectionLevel&amp;PermissionInfo.PROTECTION_FLAG_DEVELOPMENT) != <span class="number">0</span>);</span><br><span class="line">    <span class="comment">//【5】已存在的应用的该权限是否是被授予的！</span></span><br><span class="line">    <span class="keyword">final</span> <span class="keyword">boolean</span> wasGranted =</span><br><span class="line">            ((existingReqFlags&amp;PackageInfo.REQUESTED_PERMISSION_GRANTED) != <span class="number">0</span>);</span><br><span class="line">    <span class="comment">//【6】新应用的该权限是否是授予的！</span></span><br><span class="line">    <span class="keyword">final</span> <span class="keyword">boolean</span> isGranted =</span><br><span class="line">            ((newReqFlags&amp;PackageInfo.REQUESTED_PERMISSION_GRANTED) != <span class="number">0</span>);</span><br><span class="line"></span><br><span class="line">    <span class="comment">//【7】如果该权限是 dangerous 的，那必须给用户显示出来！！</span></span><br><span class="line">    <span class="keyword">if</span> (isDangerous &amp;&amp; (isRequired || wasGranted || isGranted)) &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">true</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//【8】如果 development 的权限，并且已存在的应用的该权限是被授予的，</span></span><br><span class="line">    <span class="comment">// 那么我们会给用户显示出来！</span></span><br><span class="line">    <span class="keyword">if</span> (isDevelopment &amp;&amp; wasGranted) &#123;</span><br><span class="line">        <span class="keyword">if</span> (localLOGV) Log.i(TAG, <span class="string">"Special perm "</span> + pInfo.name</span><br><span class="line">                + <span class="string">": protlevel=0x"</span> + Integer.toHexString(pInfo.protectionLevel));</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">true</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">false</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>不多说了！</p>
<h4 id="2-1-1-2-new-MyPermissionGroupInfo"><a href="#2-1-1-2-new-MyPermissionGroupInfo" class="headerlink" title="2.1.1.2 new MyPermissionGroupInfo"></a>2.1.1.2 new MyPermissionGroupInfo</h4><p>创建一个权限组对象：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/** <span class="doctag">@hide</span> */</span></span><br><span class="line"><span class="keyword">static</span> <span class="class"><span class="keyword">class</span> <span class="title">MyPermissionGroupInfo</span> <span class="keyword">extends</span> <span class="title">PermissionGroupInfo</span> </span>&#123;</span><br><span class="line">    CharSequence mLabel;</span><br><span class="line">    <span class="comment">// 所有属于该权限组的该应用申请的被视为新的权限（很绕口我知道。。）</span></span><br><span class="line">    <span class="keyword">final</span> ArrayList&lt;MyPermissionInfo&gt; mNewPermissions = <span class="keyword">new</span> ArrayList&lt;MyPermissionInfo&gt;();</span><br><span class="line">    <span class="comment">// 所有属于该权限组的该应用申请的权限</span></span><br><span class="line">    <span class="keyword">final</span> ArrayList&lt;MyPermissionInfo&gt; mAllPermissions = <span class="keyword">new</span> ArrayList&lt;MyPermissionInfo&gt;();</span><br><span class="line"></span><br><span class="line">    MyPermissionGroupInfo(PermissionInfo perm) &#123;</span><br><span class="line">        name = perm.packageName; <span class="comment">// 权限组名；</span></span><br><span class="line">        packageName = perm.packageName; <span class="comment">// 所属包名；</span></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    MyPermissionGroupInfo(PermissionGroupInfo info) &#123;</span><br><span class="line">        <span class="keyword">super</span>(info);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> Drawable <span class="title">loadGroupIcon</span><span class="params">(Context context, PackageManager pm)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">if</span> (icon != <span class="number">0</span>) &#123;</span><br><span class="line">            <span class="keyword">return</span> loadUnbadgedIcon(pm);</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            <span class="keyword">return</span> context.getDrawable(R.drawable.ic_perm_device_info);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h4 id="2-1-1-3-new-MyPermissionInfo"><a href="#2-1-1-3-new-MyPermissionInfo" class="headerlink" title="2.1.1.3 new MyPermissionInfo"></a>2.1.1.3 new MyPermissionInfo</h4><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/** <span class="doctag">@hide</span> */</span></span><br><span class="line"><span class="keyword">private</span> <span class="keyword">static</span> <span class="class"><span class="keyword">class</span> <span class="title">MyPermissionInfo</span> <span class="keyword">extends</span> <span class="title">PermissionInfo</span> </span>&#123;</span><br><span class="line">    CharSequence mLabel;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 新安装的应用的该权限标志位，值来自 requestedPermissionsFlags</span></span><br><span class="line">    <span class="keyword">int</span> mNewReqFlags;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 已经被安装的应用（如果有）的该权限标志位，值来自 requestedPermissionsFlags</span></span><br><span class="line">    <span class="keyword">int</span> mExistingReqFlags;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 判断该应用是否被视为一个新的权限！</span></span><br><span class="line">    <span class="keyword">boolean</span> mNew;</span><br><span class="line"></span><br><span class="line">    MyPermissionInfo(PermissionInfo info) &#123;</span><br><span class="line">        <span class="keyword">super</span>(info);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h3 id="2-1-2-AppSecurityPermissions-getAllUsedPermissions"><a href="#2-1-2-AppSecurityPermissions-getAllUsedPermissions" class="headerlink" title="2.1.2 AppSecurityPermissions.getAllUsedPermissions"></a>2.1.2 AppSecurityPermissions.getAllUsedPermissions</h3><p>获得共享 uid 的权限！</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">getAllUsedPermissions</span><span class="params">(<span class="keyword">int</span> sharedUid, Set&lt;MyPermissionInfo&gt; permSet)</span> </span>&#123;</span><br><span class="line">    <span class="comment">//【1】获得所有共享了该 uid 的 pkg！</span></span><br><span class="line">    String sharedPkgList[] = mPm.getPackagesForUid(sharedUid);</span><br><span class="line">    <span class="keyword">if</span>(sharedPkgList == <span class="keyword">null</span> || (sharedPkgList.length == <span class="number">0</span>)) &#123;</span><br><span class="line">        <span class="keyword">return</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">//【*2.1.2.1】获得其 request 的权限！</span></span><br><span class="line">    <span class="keyword">for</span>(String sharedPkg : sharedPkgList) &#123;</span><br><span class="line">        getPermissionsForPackage(sharedPkg, permSet);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h4 id="2-1-2-1-AppSecurityPermissions-getPermissionsForPackage"><a href="#2-1-2-1-AppSecurityPermissions-getPermissionsForPackage" class="headerlink" title="2.1.2.1 AppSecurityPermissions.getPermissionsForPackage"></a>2.1.2.1 AppSecurityPermissions.getPermissionsForPackage</h4><p>继续处理：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">getPermissionsForPackage</span><span class="params">(String packageName, Set&lt;MyPermissionInfo&gt; permSet)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">        <span class="comment">//【1】获得该 packageName 对应的应用程序！</span></span><br><span class="line">        PackageInfo pkgInfo = mPm.getPackageInfo(packageName, PackageManager.GET_PERMISSIONS);</span><br><span class="line">        <span class="comment">//【*2.1.1】又调用了 extractPerms 方法！</span></span><br><span class="line">        extractPerms(pkgInfo, permSet, pkgInfo);</span><br><span class="line">    &#125; <span class="keyword">catch</span> (NameNotFoundException e) &#123;</span><br><span class="line">        Log.w(TAG, <span class="string">"Couldn't retrieve permissions for package: "</span> + packageName);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>不多说了！</p>
<h3 id="2-1-3-AppSecurityPermissions-setPermissions"><a href="#2-1-3-AppSecurityPermissions-setPermissions" class="headerlink" title="2.1.3 AppSecurityPermissions.setPermissions"></a>2.1.3 AppSecurityPermissions.setPermissions</h3><p>设置权限，将权限设置到对应的权限组中！</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">setPermissions</span><span class="params">(List&lt;MyPermissionInfo&gt; permList)</span> </span>&#123;</span><br><span class="line">    <span class="comment">//【1】将申请的权限加入对应的 group 中！</span></span><br><span class="line">    <span class="keyword">if</span> (permList != <span class="keyword">null</span>) &#123;</span><br><span class="line">        <span class="keyword">for</span> (MyPermissionInfo pInfo : permList) &#123;</span><br><span class="line">            <span class="keyword">if</span>(localLOGV) Log.i(TAG, <span class="string">"Processing permission:"</span>+pInfo.name);</span><br><span class="line">            <span class="comment">//【*2.1.1.1】调用 isDisplayablePermission 判断权限是否不用显示给用户！</span></span><br><span class="line">            <span class="keyword">if</span>(!isDisplayablePermission(pInfo, pInfo.mNewReqFlags, pInfo.mExistingReqFlags)) &#123;</span><br><span class="line">                <span class="keyword">if</span>(localLOGV) Log.i(TAG, <span class="string">"Permission:"</span>+pInfo.name+<span class="string">" is not displayable"</span>);</span><br><span class="line">                <span class="keyword">continue</span>;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="comment">//【1.2】将要申请的权限加入到对应的权限中！</span></span><br><span class="line">            MyPermissionGroupInfo group = mPermGroups.get(pInfo.group);</span><br><span class="line">            <span class="keyword">if</span> (group != <span class="keyword">null</span>) &#123;</span><br><span class="line">                pInfo.mLabel = pInfo.loadLabel(mPm);</span><br><span class="line">                <span class="comment">//【*2.1.3.1】添加到 group.mAllPermissions 内部集合中；</span></span><br><span class="line">                addPermToList(group.mAllPermissions, pInfo);</span><br><span class="line">                <span class="keyword">if</span> (pInfo.mNew) &#123;</span><br><span class="line">                    <span class="comment">//【*2.1.3.1】添加到 group.mNewPermissions 内部集合中；</span></span><br><span class="line">                    addPermToList(group.mNewPermissions, pInfo);</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">//【2】设置每个权限组的 label！</span></span><br><span class="line">    <span class="keyword">for</span> (MyPermissionGroupInfo pgrp : mPermGroups.values()) &#123;</span><br><span class="line">        <span class="keyword">if</span> (pgrp.labelRes != <span class="number">0</span> || pgrp.nonLocalizedLabel != <span class="keyword">null</span>) &#123;</span><br><span class="line">            pgrp.mLabel = pgrp.loadLabel(mPm);</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            ApplicationInfo app;</span><br><span class="line">            <span class="keyword">try</span> &#123;</span><br><span class="line">                app = mPm.getApplicationInfo(pgrp.packageName, <span class="number">0</span>);</span><br><span class="line">                pgrp.mLabel = app.loadLabel(mPm);</span><br><span class="line">            &#125; <span class="keyword">catch</span> (NameNotFoundException e) &#123;</span><br><span class="line">                pgrp.mLabel = pgrp.loadLabel(mPm);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">//【2.1】将权限添加到 mPermGroupsList 中！</span></span><br><span class="line">        mPermGroupsList.add(pgrp);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">//【3】对权限组进行排序！</span></span><br><span class="line">    Collections.sort(mPermGroupsList, mPermGroupComparator);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h4 id="2-1-3-1-AppSecurityPermissions-setPermissions"><a href="#2-1-3-1-AppSecurityPermissions-setPermissions" class="headerlink" title="2.1.3.1 AppSecurityPermissions.setPermissions"></a>2.1.3.1 AppSecurityPermissions.setPermissions</h4><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">addPermToList</span><span class="params">(List&lt;MyPermissionInfo&gt; permList,</span></span></span><br><span class="line"><span class="function"><span class="params">        MyPermissionInfo pInfo)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">if</span> (pInfo.mLabel == <span class="keyword">null</span>) &#123;</span><br><span class="line">        pInfo.mLabel = pInfo.loadLabel(mPm);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">//【1】这里会使用排序方式找到合适的位置，使用比较器是 mPermComparator！</span></span><br><span class="line">    <span class="keyword">int</span> idx = Collections.binarySearch(permList, pInfo, mPermComparator);</span><br><span class="line">    <span class="keyword">if</span>(localLOGV) Log.i(TAG, <span class="string">"idx="</span>+idx+<span class="string">", list.size="</span>+permList.size());</span><br><span class="line">    <span class="keyword">if</span> (idx &lt; <span class="number">0</span>) &#123;</span><br><span class="line">        idx = -idx-<span class="number">1</span>;</span><br><span class="line">        <span class="comment">//【1.1】插入到 permList 列表中；</span></span><br><span class="line">        permList.add(idx, pInfo);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h2 id="2-2-AppSecurityPermissions-getPermissionCount"><a href="#2-2-AppSecurityPermissions-getPermissionCount" class="headerlink" title="2.2 AppSecurityPermissions.getPermissionCount"></a>2.2 AppSecurityPermissions.getPermissionCount</h2><p>获得权限的数量：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">int</span> <span class="title">getPermissionCount</span><span class="params">(<span class="keyword">int</span> which)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">int</span> N = <span class="number">0</span>;</span><br><span class="line">    <span class="keyword">for</span> (<span class="keyword">int</span> i=<span class="number">0</span>; i&lt;mPermGroupsList.size(); i++) &#123;</span><br><span class="line">        <span class="comment">//【*2.2.1】返回每个 group 的权限个数！</span></span><br><span class="line">        N += getPermissionList(mPermGroupsList.get(i), which).size();</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> N;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>不多说了！</p>
<h3 id="2-2-1-AppSecurityPermissions-getPermissionList"><a href="#2-2-1-AppSecurityPermissions-getPermissionList" class="headerlink" title="2.2.1 AppSecurityPermissions.getPermissionList"></a>2.2.1 AppSecurityPermissions.getPermissionList</h3><p>根据 which 指定的标志，返回 grp.mNewPermissions 或者 grp.mAllPermissions<br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">private</span> List&lt;MyPermissionInfo&gt; <span class="title">getPermissionList</span><span class="params">(MyPermissionGroupInfo grp, <span class="keyword">int</span> which)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">if</span> (which == WHICH_NEW) &#123;</span><br><span class="line">        <span class="keyword">return</span> grp.mNewPermissions;</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> grp.mAllPermissions;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>具体的意思很简单了，就不多说了！</p>
<h1 id="3-onClick-gt-trigger-to-install"><a href="#3-onClick-gt-trigger-to-install" class="headerlink" title="3 onClick -&gt; trigger to install"></a>3 onClick -&gt; trigger to install</h1><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onClick</span><span class="params">(View v)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">if</span> (v == mOk) &#123;</span><br><span class="line">        <span class="keyword">if</span> (mOkCanInstall || mScrollView == <span class="keyword">null</span>) &#123;</span><br><span class="line">            <span class="keyword">if</span> (mSessionId != -<span class="number">1</span>) &#123;</span><br><span class="line">                <span class="comment">//【1】这里对应的是 onCreate 中的 confirm permission 的广播</span></span><br><span class="line">                <span class="comment">// 这里会进入系统进程，通知权限确认完成，继续下一阶段安装！</span></span><br><span class="line">                <span class="comment">//【*3.1】通知 PackageInstallerService 权限确认完成！</span></span><br><span class="line">                mInstaller.setPermissionsResult(mSessionId, <span class="keyword">true</span>);</span><br><span class="line">                clearCachedApkIfNeededAndFinish();</span><br><span class="line">            &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                <span class="comment">//【*4】正常情况会进入 startInstall 阶段！</span></span><br><span class="line">                startInstall();</span><br><span class="line">            &#125;</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            <span class="comment">//【2】强制滚动，让用户看完权限信息；</span></span><br><span class="line">            mScrollView.pageScroll(View.FOCUS_DOWN);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125; <span class="keyword">else</span> <span class="keyword">if</span> (v == mCancel) &#123;</span><br><span class="line">        <span class="comment">//【3】当然，如果用户点击了取消，如果 mSessionId 不为 -1，</span></span><br><span class="line">        <span class="comment">// 那么也需要进入系统进程，通知系统无需继续安装！</span></span><br><span class="line">        setResult(RESULT_CANCELED);</span><br><span class="line">        <span class="keyword">if</span> (mSessionId != -<span class="number">1</span>) &#123;</span><br><span class="line">            <span class="comment">//【*3.1】通知 PackageInstallerService 权限确认完成！</span></span><br><span class="line">            mInstaller.setPermissionsResult(mSessionId, <span class="keyword">false</span>);</span><br><span class="line">        &#125;</span><br><span class="line">        clearCachedApkIfNeededAndFinish();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h2 id="3-1-PackageInstallerService-setPermissionsResult"><a href="#3-1-PackageInstallerService-setPermissionsResult" class="headerlink" title="3.1 PackageInstallerService.setPermissionsResult"></a>3.1 PackageInstallerService.setPermissionsResult</h2><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">setPermissionsResult</span><span class="params">(<span class="keyword">int</span> sessionId, <span class="keyword">boolean</span> accepted)</span> </span>&#123;</span><br><span class="line">    mContext.enforceCallingOrSelfPermission(android.Manifest.permission.INSTALL_PACKAGES, TAG);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">synchronized</span> (mSessions) &#123;</span><br><span class="line">        PackageInstallerSession session = mSessions.get(sessionId);</span><br><span class="line">        <span class="keyword">if</span> (session != <span class="keyword">null</span>) &#123;</span><br><span class="line">            <span class="comment">//【*3.2】根据指定的 sessionId，找到对应的 PackageInstallerSession</span></span><br><span class="line">            session.setPermissionsResult(accepted);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h2 id="3-2-PackageInstallerSession-setPermissionsResult"><a href="#3-2-PackageInstallerSession-setPermissionsResult" class="headerlink" title="3.2 PackageInstallerSession.setPermissionsResult"></a>3.2 PackageInstallerSession.setPermissionsResult</h2><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">setPermissionsResult</span><span class="params">(<span class="keyword">boolean</span> accepted)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">if</span> (!mSealed) &#123;</span><br><span class="line">        <span class="keyword">throw</span> <span class="keyword">new</span> SecurityException(<span class="string">"Must be sealed to accept permissions"</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (accepted) &#123;</span><br><span class="line">        <span class="comment">//【1】这里设置了 mPermissionsAccepted 为 true，这样在下面的继续安装中，就不会重复确权了！</span></span><br><span class="line">        <span class="keyword">synchronized</span> (mLock) &#123;</span><br><span class="line">            mPermissionsAccepted = <span class="keyword">true</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">//【2】发送 MSG_COMMIT 消息，继续安装！</span></span><br><span class="line">        mHandler.obtainMessage(MSG_COMMIT).sendToTarget();</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        destroyInternal();</span><br><span class="line">        dispatchSessionFinished(INSTALL_FAILED_ABORTED, <span class="string">"User rejected permissions"</span>, <span class="keyword">null</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>下面，我们继续看 startInstall 方法：</p>
<h1 id="4-PackageInstallerActivity-startInstall"><a href="#4-PackageInstallerActivity-startInstall" class="headerlink" title="4 PackageInstallerActivity.startInstall"></a>4 PackageInstallerActivity.startInstall</h1><p>继续分析：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">startInstall</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    <span class="comment">//【1】创建了一个 intent，封装要安装的应用程序！</span></span><br><span class="line">    Intent newIntent = <span class="keyword">new</span> Intent();</span><br><span class="line">    <span class="comment">//【2】传递要安装的应用程序的 ApplicationInfo 实例；</span></span><br><span class="line">    newIntent.putExtra(PackageUtil.INTENT_ATTR_APPLICATION_INFO,</span><br><span class="line">            mPkgInfo.applicationInfo);</span><br><span class="line">    newIntent.setData(mPackageURI);</span><br><span class="line">    <span class="comment">//【2】目标组件 InstallAppProgress！</span></span><br><span class="line">    newIntent.setClass(<span class="keyword">this</span>, InstallAppProgress.class);</span><br><span class="line">    String installerPackageName = getIntent().getStringExtra(</span><br><span class="line">            Intent.EXTRA_INSTALLER_PACKAGE_NAME);</span><br><span class="line">    <span class="keyword">if</span> (mOriginatingURI != <span class="keyword">null</span>) &#123;</span><br><span class="line">        newIntent.putExtra(Intent.EXTRA_ORIGINATING_URI, mOriginatingURI);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span> (mReferrerURI != <span class="keyword">null</span>) &#123;</span><br><span class="line">        newIntent.putExtra(Intent.EXTRA_REFERRER, mReferrerURI);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span> (mOriginatingUid != VerificationParams.NO_UID) &#123;</span><br><span class="line">        newIntent.putExtra(Intent.EXTRA_ORIGINATING_UID, mOriginatingUid);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span> (installerPackageName != <span class="keyword">null</span>) &#123;</span><br><span class="line">        newIntent.putExtra(Intent.EXTRA_INSTALLER_PACKAGE_NAME,</span><br><span class="line">                installerPackageName);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">//【3】如果安装的启动者 start 的时候，指定了接收返回结果，此时我们启动了一个新的 activity</span></span><br><span class="line">    <span class="comment">// InstallAppProgress，所以这里指定 InstallAppProgress 会将安装结果返回给启动者！</span></span><br><span class="line">    <span class="comment">// 而不是启动 InstallAppProgress 的界面！</span></span><br><span class="line">    <span class="keyword">if</span> (getIntent().getBooleanExtra(Intent.EXTRA_RETURN_RESULT, <span class="keyword">false</span>)) &#123;</span><br><span class="line">        newIntent.putExtra(Intent.EXTRA_RETURN_RESULT, <span class="keyword">true</span>);</span><br><span class="line">        <span class="comment">//【3.1】这种效果是通过 FLAG_ACTIVITY_FORWARD_RESULT 标志位实现的！</span></span><br><span class="line">        newIntent.addFlags(Intent.FLAG_ACTIVITY_FORWARD_RESULT);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span>(localLOGV) Log.i(TAG, <span class="string">"downloaded app uri="</span>+mPackageURI);</span><br><span class="line">    startActivity(newIntent);</span><br><span class="line">    finish();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>关于 start activity，我们有在 ams 的相关内容中看到！</p>
<h1 id="5-InstallAppProgress"><a href="#5-InstallAppProgress" class="headerlink" title="5 InstallAppProgress"></a>5 InstallAppProgress</h1><h2 id="5-1-onCreate"><a href="#5-1-onCreate" class="headerlink" title="5.1 onCreate"></a>5.1 onCreate</h2><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onCreate</span><span class="params">(Bundle icicle)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">super</span>.onCreate(icicle);</span><br><span class="line">    Intent intent = getIntent();</span><br><span class="line">    mAppInfo = intent.getParcelableExtra(PackageUtil.INTENT_ATTR_APPLICATION_INFO);</span><br><span class="line">    mPackageURI = intent.getData();</span><br><span class="line"></span><br><span class="line">    <span class="keyword">final</span> String scheme = mPackageURI.getScheme();</span><br><span class="line">    <span class="keyword">if</span> (scheme != <span class="keyword">null</span> &amp;&amp; !<span class="string">"file"</span>.equals(scheme) &amp;&amp; !<span class="string">"package"</span>.equals(scheme)) &#123;</span><br><span class="line">        <span class="keyword">throw</span> <span class="keyword">new</span> IllegalArgumentException(<span class="string">"unexpected scheme "</span> + scheme);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">//【1】启动了一个 HandlerThread 用于安装；</span></span><br><span class="line">    mInstallThread = <span class="keyword">new</span> HandlerThread(<span class="string">"InstallThread"</span>);</span><br><span class="line">    mInstallThread.start();</span><br><span class="line">    mInstallHandler = <span class="keyword">new</span> Handler(mInstallThread.getLooper());</span><br><span class="line"></span><br><span class="line">    IntentFilter intentFilter = <span class="keyword">new</span> IntentFilter();</span><br><span class="line">    intentFilter.addAction(BROADCAST_ACTION);</span><br><span class="line">    <span class="comment">//【*5.1.1】动态注册了一个广播接收者，监听 ACTION_INSTALL_COMMIT 广播！</span></span><br><span class="line">    registerReceiver(</span><br><span class="line">            mBroadcastReceiver, intentFilter, BROADCAST_SENDER_PERMISSION, <span class="keyword">null</span> <span class="comment">/*scheduler*/</span>);</span><br><span class="line"></span><br><span class="line">    <span class="comment">//【*5.2】初始化界面！</span></span><br><span class="line">    initView();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>InstallAppProgress 显示后，会注册一个接收者，监听下面的广播：<br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> String BROADCAST_ACTION =</span><br><span class="line">        <span class="string">"com.android.packageinstaller.ACTION_INSTALL_COMMIT"</span>;</span><br></pre></td></tr></table></figure></p>
<p>并且发送者要具有这样的权限：<br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> String BROADCAST_SENDER_PERMISSION =</span><br><span class="line">        <span class="string">"android.permission.INSTALL_PACKAGES"</span>;</span><br></pre></td></tr></table></figure></p>
<h3 id="5-1-1-new-BroadcastReceiver"><a href="#5-1-1-new-BroadcastReceiver" class="headerlink" title="5.1.1 new BroadcastReceiver"></a>5.1.1 new BroadcastReceiver</h3><p>用于接收 com.android.packageinstaller.ACTION_INSTALL_COMMIT 广播！！</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">private</span> <span class="keyword">final</span> BroadcastReceiver mBroadcastReceiver = <span class="keyword">new</span> BroadcastReceiver() &#123;</span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onReceive</span><span class="params">(Context context, Intent intent)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">final</span> <span class="keyword">int</span> statusCode = intent.getIntExtra(</span><br><span class="line">                PackageInstaller.EXTRA_STATUS, PackageInstaller.STATUS_FAILURE);</span><br><span class="line">        <span class="keyword">if</span> (statusCode == PackageInstaller.STATUS_PENDING_USER_ACTION) &#123;</span><br><span class="line">            context.startActivity((Intent)intent.getParcelableExtra(Intent.EXTRA_INTENT));</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            onPackageInstalled(statusCode);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>
<p>我们在分析 pm install 的时候：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//【1】mPermissionsAccepted 为 true，那么用户就可以静默安装了，如果为 false，那么就需要用户确认权限！！</span></span><br><span class="line"><span class="keyword">if</span> (!mPermissionsAccepted) &#123;</span><br><span class="line">    <span class="comment">//【1.1】这里会创建一个 intent， action 为 PackageInstaller.ACTION_CONFIRM_PERMISSIONS</span></span><br><span class="line">    <span class="comment">// 目标应用是 PackageInstaller，这里会先进入 packageinstaller 中确认权限信息！</span></span><br><span class="line">    <span class="keyword">final</span> Intent intent = <span class="keyword">new</span> Intent(PackageInstaller.ACTION_CONFIRM_PERMISSIONS);</span><br><span class="line">    intent.setPackage(mContext.getPackageManager().getPermissionControllerPackageName());</span><br><span class="line">    intent.putExtra(PackageInstaller.EXTRA_SESSION_ID, sessionId); <span class="comment">// 事务 id 也要从传递过去！</span></span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">        <span class="comment">//【*4.1.1】回调了 PackageInstallObserverAdapter 的 onUserActionRequired 接口</span></span><br><span class="line">        <span class="comment">// 将 intent 传递过去！</span></span><br><span class="line">        mRemoteObserver.onUserActionRequired(intent);</span><br><span class="line">    &#125; <span class="keyword">catch</span> (RemoteException ignored) &#123;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">//【*4.3.3】关闭该事务，使其从 active 变为 idle 状态！！</span></span><br><span class="line">    close();</span><br><span class="line">    <span class="comment">// 停止安装，等待用户确认权限，用户在 PackageInstaller 点击安装，安装会继续！！</span></span><br><span class="line">    <span class="keyword">return</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>当我们需要用户确认权限的时候，会创建一个 intent，action 为 ACTION_CONFIRM_PERMISSIONS，这里的逻辑，然后会掉</p>
<p>RemoteObserver.onUserActionRequired 方法！</p>
<h2 id="5-2-initView"><a href="#5-2-initView" class="headerlink" title="5.2 initView"></a>5.2 initView</h2><p>继续来看：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">initView</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    setContentView(R.layout.op_progress);</span><br><span class="line">    <span class="comment">//【1】这里有要创建一个 AppSnippet 实例！</span></span><br><span class="line">    <span class="keyword">final</span> PackageUtil.AppSnippet as;</span><br><span class="line">    <span class="keyword">final</span> PackageManager pm = getPackageManager();</span><br><span class="line">    <span class="comment">//【*5.2.1】解析安装标志位， 主要作用是指定安装方式，是取代已经存在的，还是全新安装！</span></span><br><span class="line">    <span class="keyword">final</span> <span class="keyword">int</span> installFlags = getInstallFlags(mAppInfo.packageName);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span>((installFlags &amp; PackageManager.INSTALL_REPLACE_EXISTING )!= <span class="number">0</span>) &#123;</span><br><span class="line">        Log.w(TAG, <span class="string">"Replacing package:"</span> + mAppInfo.packageName);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span> (<span class="string">"package"</span>.equals(mPackageURI.getScheme())) &#123;</span><br><span class="line">        <span class="comment">//【*1.1.2.1】又创建了一个 AppSnippet 实例！</span></span><br><span class="line">        as = <span class="keyword">new</span> PackageUtil.AppSnippet(pm.getApplicationLabel(mAppInfo),</span><br><span class="line">                pm.getApplicationIcon(mAppInfo));</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        <span class="comment">//【*1.1.3】又创建了一个 AppSnippet 实例！</span></span><br><span class="line">        <span class="keyword">final</span> File sourceFile = <span class="keyword">new</span> File(mPackageURI.getPath());</span><br><span class="line">        as = PackageUtil.getAppSnippet(<span class="keyword">this</span>, mAppInfo, sourceFile);</span><br><span class="line">    &#125;</span><br><span class="line">    mLabel = as.label;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//【*1.1.4】初始化 AppSnippet 的相关属性，icon 等等！</span></span><br><span class="line">    PackageUtil.initSnippetForNewApp(<span class="keyword">this</span>, as, R.id.app_snippet);</span><br><span class="line">    </span><br><span class="line">    <span class="comment">//【2】初始化界面！</span></span><br><span class="line">    mStatusTextView = (TextView)findViewById(R.id.center_text);</span><br><span class="line">    mExplanationTextView = (TextView) findViewById(R.id.explanation);</span><br><span class="line">    mProgressBar = (ProgressBar) findViewById(R.id.progress_bar);</span><br><span class="line">    mProgressBar.setIndeterminate(<span class="keyword">true</span>);</span><br><span class="line">    <span class="comment">// Hide button till progress is being displayed</span></span><br><span class="line">    mOkPanel = findViewById(R.id.buttons_panel);</span><br><span class="line">    mDoneButton = (Button)findViewById(R.id.done_button);</span><br><span class="line">    mLaunchButton = (Button)findViewById(R.id.launch_button);</span><br><span class="line">    mOkPanel.setVisibility(View.INVISIBLE);</span><br><span class="line"></span><br><span class="line">    <span class="comment">//【3】如果 scheme 指定的是 package，这种情况是安装一个已经存在的 pkg，会进入 if 分支！</span></span><br><span class="line">    <span class="comment">// 如果是 file 类型，进入 else！</span></span><br><span class="line">    <span class="keyword">if</span> (<span class="string">"package"</span>.equals(mPackageURI.getScheme())) &#123;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            <span class="comment">//【×5.2.2】调用 pms 的 installExistingPackage 方法执行安装！</span></span><br><span class="line">            pm.installExistingPackage(mAppInfo.packageName);</span><br><span class="line">            <span class="comment">//【×5.2.3】通知安装结果！</span></span><br><span class="line">            onPackageInstalled(PackageInstaller.STATUS_SUCCESS);</span><br><span class="line">        &#125; <span class="keyword">catch</span> (PackageManager.NameNotFoundException e) &#123;</span><br><span class="line">            onPackageInstalled(PackageInstaller.STATUS_FAILURE_INVALID);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        <span class="comment">//【4】这里会创建一个 SessionParams 封装事务参数，这里在 pm install 中有讲过！</span></span><br><span class="line">        <span class="keyword">final</span> PackageInstaller.SessionParams params = <span class="keyword">new</span> PackageInstaller.SessionParams(</span><br><span class="line">                PackageInstaller.SessionParams.MODE_FULL_INSTALL);</span><br><span class="line">        params.referrerUri = getIntent().getParcelableExtra(Intent.EXTRA_REFERRER);</span><br><span class="line">        params.originatingUri = getIntent().getParcelableExtra(Intent.EXTRA_ORIGINATING_URI);</span><br><span class="line">        params.originatingUid = getIntent().getIntExtra(Intent.EXTRA_ORIGINATING_UID,</span><br><span class="line">                UID_UNKNOWN);</span><br><span class="line">        <span class="comment">//【5】创建一个 File 对象，指向 apk 的路径！</span></span><br><span class="line">        File file = <span class="keyword">new</span> File(mPackageURI.getPath());</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            <span class="comment">//【6】解析 package，获得 PackageLite 对象，parsePackageLite 我们在开机启动中有讲过，这里就不多说了！</span></span><br><span class="line">            PackageLite pkg = PackageParser.parsePackageLite(file, <span class="number">0</span>);</span><br><span class="line">            <span class="comment">//【7】设置包名，安装路径，大小到 SessionParams 中！</span></span><br><span class="line">            params.setAppPackageName(pkg.packageName);</span><br><span class="line">            params.setInstallLocation(pkg.installLocation);</span><br><span class="line">            params.setSize(</span><br><span class="line">                PackageHelper.calculateInstalledSize(pkg, <span class="keyword">false</span>, params.abiOverride));</span><br><span class="line">        &#125; <span class="keyword">catch</span> (PackageParser.PackageParserException e) &#123;</span><br><span class="line">            Log.e(TAG, <span class="string">"Cannot parse package "</span> + file + <span class="string">". Assuming defaults."</span>);</span><br><span class="line">            Log.e(TAG, <span class="string">"Cannot calculate installed size "</span> + file + <span class="string">". Try only apk size."</span>);</span><br><span class="line">            params.setSize(file.length());</span><br><span class="line">        &#125; <span class="keyword">catch</span> (IOException e) &#123;</span><br><span class="line">            Log.e(TAG, <span class="string">"Cannot calculate installed size "</span> + file + <span class="string">". Try only apk size."</span>);</span><br><span class="line">            params.setSize(file.length());</span><br><span class="line">        &#125;</span><br><span class="line">        </span><br><span class="line">        <span class="comment">//【8】在子线程中，执行安装！</span></span><br><span class="line">        mInstallHandler.post(<span class="keyword">new</span> Runnable() &#123;</span><br><span class="line">            <span class="meta">@Override</span></span><br><span class="line">            <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">run</span><span class="params">()</span> </span>&#123;</span><br><span class="line">                <span class="comment">//【×5.3】触发安装！</span></span><br><span class="line">                doPackageStage(pm, params);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h3 id="5-2-1-getInstallFlags"><a href="#5-2-1-getInstallFlags" class="headerlink" title="5.2.1 getInstallFlags"></a>5.2.1 getInstallFlags</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">getInstallFlags</span><span class="params">(String packageName)</span> </span>&#123;</span><br><span class="line">    PackageManager pm = getPackageManager();</span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">        <span class="comment">//【1】尝试获得包名为本次要安装的应用的安装信息!</span></span><br><span class="line">        PackageInfo pi =</span><br><span class="line">                pm.getPackageInfo(packageName, PackageManager.GET_UNINSTALLED_PACKAGES);</span><br><span class="line">        <span class="keyword">if</span> (pi != <span class="keyword">null</span>) &#123;</span><br><span class="line">            <span class="comment">//【2】如果已经安装了，那么会返回 INSTALL_REPLACE_EXISTING！</span></span><br><span class="line">            <span class="keyword">return</span> PackageManager.INSTALL_REPLACE_EXISTING;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125; <span class="keyword">catch</span> (NameNotFoundException e) &#123;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h3 id="5-2-2-PackageManagerService-installExistingPackage"><a href="#5-2-2-PackageManagerService-installExistingPackage" class="headerlink" title="5.2.2 PackageManagerService.installExistingPackage"></a>5.2.2 PackageManagerService.installExistingPackage</h3><p>安装一个系统中已存在的包，这是一个 hide 方法：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">int</span> <span class="title">installExistingPackageAsUser</span><span class="params">(String packageName, <span class="keyword">int</span> userId)</span> </span>&#123;</span><br><span class="line">    mContext.enforceCallingOrSelfPermission(android.Manifest.permission.INSTALL_PACKAGES,</span><br><span class="line">            <span class="keyword">null</span>);</span><br><span class="line">    PackageSetting pkgSetting;</span><br><span class="line">    <span class="keyword">final</span> <span class="keyword">int</span> uid = Binder.getCallingUid();</span><br><span class="line">    <span class="comment">//【1】校验权限！</span></span><br><span class="line">    enforceCrossUserPermission(uid, userId,</span><br><span class="line">            <span class="keyword">true</span> <span class="comment">/* requireFullPermission */</span>, <span class="keyword">true</span> <span class="comment">/* checkShell */</span>,</span><br><span class="line">            <span class="string">"installExistingPackage for user "</span> + userId);</span><br><span class="line">    <span class="comment">//【2】如果设置了不能安装应用的用户限制；</span></span><br><span class="line">    <span class="keyword">if</span> (isUserRestricted(userId, UserManager.DISALLOW_INSTALL_APPS)) &#123;</span><br><span class="line">        <span class="keyword">return</span> PackageManager.INSTALL_FAILED_USER_RESTRICTED;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">long</span> callingId = Binder.clearCallingIdentity();</span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">        <span class="keyword">boolean</span> installed = <span class="keyword">false</span>;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">synchronized</span> (mPackages) &#123;</span><br><span class="line">            <span class="comment">//【3】判断该应用是否存在，不存在的话，返回 INSTALL_FAILED_INVALID_URI！</span></span><br><span class="line">            pkgSetting = mSettings.mPackages.get(packageName);</span><br><span class="line">            <span class="keyword">if</span> (pkgSetting == <span class="keyword">null</span>) &#123;</span><br><span class="line">                <span class="keyword">return</span> PackageManager.INSTALL_FAILED_INVALID_URI;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="comment">//【4】更新 pkg 的 install 状态为 true，hide 状态为 false，并更新偏好设置！</span></span><br><span class="line">            <span class="keyword">if</span> (!pkgSetting.getInstalled(userId)) &#123;</span><br><span class="line">                pkgSetting.setInstalled(<span class="keyword">true</span>, userId);</span><br><span class="line">                pkgSetting.setHidden(<span class="keyword">false</span>, userId);</span><br><span class="line">                mSettings.writePackageRestrictionsLPr(userId);</span><br><span class="line">                installed = <span class="keyword">true</span>;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (installed) &#123;</span><br><span class="line">            <span class="keyword">if</span> (pkgSetting.pkg != <span class="keyword">null</span>) &#123;</span><br><span class="line">                <span class="keyword">synchronized</span> (mInstallLock) &#123;</span><br><span class="line">                    <span class="comment">//【4】准备数据目录！</span></span><br><span class="line">                    prepareAppDataAfterInstallLIF(pkgSetting.pkg);</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="comment">//【5】发送 Intent.ACTION_PACKAGE_ADDED 给所有的设备用户！！</span></span><br><span class="line">            sendPackageAddedForUser(packageName, pkgSetting, userId);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">        Binder.restoreCallingIdentity(callingId);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> PackageManager.INSTALL_SUCCEEDED;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>不多说了！</p>
<h3 id="5-2-3-onPackageInstalled"><a href="#5-2-3-onPackageInstalled" class="headerlink" title="5.2.3 onPackageInstalled"></a>5.2.3 onPackageInstalled</h3><p>发送 INSTALL_COMPLETE 消息给主线程的 Handler：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">onPackageInstalled</span><span class="params">(<span class="keyword">int</span> statusCode)</span> </span>&#123;</span><br><span class="line">    <span class="comment">//【*5.2.3.1】进入主线程的 handler！</span></span><br><span class="line">    Message msg = mHandler.obtainMessage(INSTALL_COMPLETE);</span><br><span class="line">    msg.arg1 = statusCode;</span><br><span class="line">    mHandler.sendMessage(msg);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h4 id="5-2-3-1-Handler-handleMessage-INSTALL-COMPLETE"><a href="#5-2-3-1-Handler-handleMessage-INSTALL-COMPLETE" class="headerlink" title="5.2.3.1 Handler.handleMessage[INSTALL_COMPLETE]"></a>5.2.3.1 Handler.handleMessage[INSTALL_COMPLETE]</h4><p>主要根据安装的结果！</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">private</span> Handler mHandler = <span class="keyword">new</span> Handler() &#123;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">handleMessage</span><span class="params">(Message msg)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">switch</span> (msg.what) &#123;</span><br><span class="line">            <span class="keyword">case</span> INSTALL_COMPLETE:</span><br><span class="line">                <span class="comment">//【1】判断下本次安装是否需要返回结果给启动安装的程序，如果需要，那就返回结果！</span></span><br><span class="line">                <span class="comment">// 返回！</span></span><br><span class="line">                <span class="keyword">if</span> (getIntent().getBooleanExtra(Intent.EXTRA_RETURN_RESULT, <span class="keyword">false</span>)) &#123;</span><br><span class="line">                    Intent result = <span class="keyword">new</span> Intent();</span><br><span class="line">                    result.putExtra(Intent.EXTRA_INSTALL_RESULT, msg.arg1);</span><br><span class="line">                    setResult(msg.arg1 == PackageInstaller.STATUS_SUCCESS</span><br><span class="line">                            ? Activity.RESULT_OK : Activity.RESULT_FIRST_USER,</span><br><span class="line">                                    result);</span><br><span class="line">                    clearCachedApkIfNeededAndFinish();</span><br><span class="line">                    <span class="keyword">return</span>;</span><br><span class="line">                &#125;</span><br><span class="line">                <span class="comment">//【2】更新界面显示！</span></span><br><span class="line">                mProgressBar.setVisibility(View.GONE);</span><br><span class="line">                <span class="comment">// Show the ok button</span></span><br><span class="line">                <span class="keyword">int</span> centerTextLabel;</span><br><span class="line">                <span class="keyword">int</span> centerExplanationLabel = -<span class="number">1</span>;</span><br><span class="line">                </span><br><span class="line">                <span class="comment">//【3】处理返回结果码！</span></span><br><span class="line">                <span class="keyword">if</span> (msg.arg1 == PackageInstaller.STATUS_SUCCESS) &#123;</span><br><span class="line">                    <span class="comment">//【3.1】安装成功的情况！</span></span><br><span class="line">                    mLaunchButton.setVisibility(View.VISIBLE);</span><br><span class="line">                    ((ImageView)findViewById(R.id.center_icon))</span><br><span class="line">                            .setImageDrawable(getDrawable(R.drawable.ic_done_92));</span><br><span class="line">                    centerTextLabel = R.string.install_done;</span><br><span class="line">                    <span class="comment">// Enable or disable launch button</span></span><br><span class="line">                    mLaunchIntent = getPackageManager().getLaunchIntentForPackage(</span><br><span class="line">                            mAppInfo.packageName);</span><br><span class="line">                    <span class="keyword">boolean</span> enabled = <span class="keyword">false</span>;</span><br><span class="line">                    <span class="keyword">if</span>(mLaunchIntent != <span class="keyword">null</span>) &#123;</span><br><span class="line">                        List&lt;ResolveInfo&gt; list = getPackageManager().</span><br><span class="line">                                queryIntentActivities(mLaunchIntent, <span class="number">0</span>);</span><br><span class="line">                        <span class="keyword">if</span> (list != <span class="keyword">null</span> &amp;&amp; list.size() &gt; <span class="number">0</span>) &#123;</span><br><span class="line">                            enabled = <span class="keyword">true</span>;</span><br><span class="line">                        &#125;</span><br><span class="line">                    &#125;</span><br><span class="line">                    <span class="keyword">if</span> (enabled) &#123;</span><br><span class="line">                        mLaunchButton.setOnClickListener(InstallAppProgress.<span class="keyword">this</span>);</span><br><span class="line">                    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                        mLaunchButton.setEnabled(<span class="keyword">false</span>);</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125; <span class="keyword">else</span> <span class="keyword">if</span> (msg.arg1 == PackageInstaller.STATUS_FAILURE_STORAGE)&#123;</span><br><span class="line">                    <span class="comment">//【3.2】空间不足安装失败！</span></span><br><span class="line">                    showDialogInner(DLG_OUT_OF_SPACE);</span><br><span class="line">                    <span class="keyword">return</span>;</span><br><span class="line">                &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                    <span class="comment">//【3.2】空间不足安装失败！</span></span><br><span class="line">                    ((ImageView)findViewById(R.id.center_icon))</span><br><span class="line">                            .setImageDrawable(getDrawable(R.drawable.ic_report_problem_92));</span><br><span class="line">                    centerExplanationLabel = getExplanationFromErrorCode(msg.arg1);</span><br><span class="line">                    centerTextLabel = R.string.install_failed;</span><br><span class="line">                    mLaunchButton.setVisibility(View.GONE);</span><br><span class="line">                &#125;</span><br><span class="line">                <span class="keyword">if</span> (centerExplanationLabel != -<span class="number">1</span>) &#123;</span><br><span class="line">                    mExplanationTextView.setText(centerExplanationLabel);</span><br><span class="line">                    findViewById(R.id.center_view).setVisibility(View.GONE);</span><br><span class="line">                    ((TextView)findViewById(R.id.explanation_status)).setText(centerTextLabel);</span><br><span class="line">                    findViewById(R.id.explanation_view).setVisibility(View.VISIBLE);</span><br><span class="line">                &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                    ((TextView)findViewById(R.id.center_text)).setText(centerTextLabel);</span><br><span class="line">                    findViewById(R.id.center_view).setVisibility(View.VISIBLE);</span><br><span class="line">                    findViewById(R.id.explanation_view).setVisibility(View.GONE);</span><br><span class="line">                &#125;</span><br><span class="line">                mDoneButton.setOnClickListener(InstallAppProgress.<span class="keyword">this</span>);</span><br><span class="line">                mOkPanel.setVisibility(View.VISIBLE);</span><br><span class="line">                <span class="keyword">break</span>;</span><br><span class="line">            <span class="keyword">default</span>:</span><br><span class="line">                <span class="keyword">break</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>
<p>不多说了！</p>
<h2 id="5-3-doPackageStage"><a href="#5-3-doPackageStage" class="headerlink" title="5.3 doPackageStage"></a>5.3 doPackageStage</h2><p>到这里，已经和 pm install 中很类似了：<br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">doPackageStage</span><span class="params">(PackageManager pm, PackageInstaller.SessionParams params)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">final</span> PackageInstaller packageInstaller = pm.getPackageInstaller();</span><br><span class="line">    PackageInstaller.Session session = <span class="keyword">null</span>;</span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">        <span class="keyword">final</span> String packageLocation = mPackageURI.getPath();</span><br><span class="line">        <span class="keyword">final</span> File file = <span class="keyword">new</span> File(packageLocation);</span><br><span class="line">        <span class="comment">//【1】这里奉陪了一个 sessionid 给本次安装，这个方法我们在 pm install 中分析过！</span></span><br><span class="line">        <span class="keyword">final</span> <span class="keyword">int</span> sessionId = packageInstaller.createSession(params);</span><br><span class="line">        <span class="keyword">final</span> <span class="keyword">byte</span>[] buffer = <span class="keyword">new</span> <span class="keyword">byte</span>[<span class="number">65536</span>];</span><br><span class="line">        </span><br><span class="line">        <span class="comment">//【2】这里根据上面分配的 sessionid，创建了一个 Session，这个方法我们在 pm install 中分析过！</span></span><br><span class="line">        session = packageInstaller.openSession(sessionId);</span><br><span class="line"></span><br><span class="line">        <span class="keyword">final</span> InputStream in = <span class="keyword">new</span> FileInputStream(file);</span><br><span class="line">        <span class="keyword">final</span> <span class="keyword">long</span> sizeBytes = file.length();</span><br><span class="line">        <span class="keyword">final</span> OutputStream out = session.openWrite(<span class="string">"PackageInstaller"</span>, <span class="number">0</span>, sizeBytes);</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            <span class="keyword">int</span> c;</span><br><span class="line">            <span class="keyword">while</span> ((c = in.read(buffer)) != -<span class="number">1</span>) &#123;</span><br><span class="line">                out.write(buffer, <span class="number">0</span>, c);</span><br><span class="line">                <span class="keyword">if</span> (sizeBytes &gt; <span class="number">0</span>) &#123;</span><br><span class="line">                    <span class="keyword">final</span> <span class="keyword">float</span> fraction = ((<span class="keyword">float</span>) c / (<span class="keyword">float</span>) sizeBytes);</span><br><span class="line">                    session.addProgress(fraction);</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">            session.fsync(out);</span><br><span class="line">        &#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">            IoUtils.closeQuietly(in);</span><br><span class="line">            IoUtils.closeQuietly(out);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment">//【2】创建了一个 PendingIntent 封装了上面的 action： com.android.packageinstaller.ACTION_INSTALL_COMMIT</span></span><br><span class="line">        Intent broadcastIntent = <span class="keyword">new</span> Intent(BROADCAST_ACTION);</span><br><span class="line">        PendingIntent pendingIntent = PendingIntent.getBroadcast(</span><br><span class="line">                InstallAppProgress.<span class="keyword">this</span> <span class="comment">/*context*/</span>,</span><br><span class="line">                sessionId,</span><br><span class="line">                broadcastIntent,</span><br><span class="line">                PendingIntent.FLAG_UPDATE_CURRENT);</span><br><span class="line"></span><br><span class="line">        <span class="comment">//【4】提交事务，触发安装，这个方法我们在 pm install 中分析过！</span></span><br><span class="line">        <span class="comment">// 这里将 PendingIntent 的 IntentSender 传递给了系统进程，后续系统进程会通过 binder 通信触发 intent！</span></span><br><span class="line">        session.commit(pendingIntent.getIntentSender());</span><br><span class="line">    &#125; <span class="keyword">catch</span> (IOException e) &#123;</span><br><span class="line">        <span class="comment">//【*5.2.3】异常情况，回调并结束！！</span></span><br><span class="line">        onPackageInstalled(PackageInstaller.STATUS_FAILURE);</span><br><span class="line">    &#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">        IoUtils.closeQuietly(session);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>按照结束后，pendingIntent 会被触发，然后发送 com.android.packageinstaller.ACTION_INSTALL_COMMIT 广播！</p>
<h1 id="6-onCreateDialog-gt-notify-user"><a href="#6-onCreateDialog-gt-notify-user" class="headerlink" title="6 onCreateDialog -&gt; notify user"></a>6 onCreateDialog -&gt; notify user</h1><p>下面我们来看下 onCreateDialog 的函数逻辑，这个会在安装过程中提示用户：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> Dialog <span class="title">onCreateDialog</span><span class="params">(<span class="keyword">int</span> id, Bundle bundle)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">switch</span> (id) &#123;</span><br><span class="line">    <span class="comment">//【1】提示本次安装了来自位置来源！</span></span><br><span class="line">    <span class="keyword">case</span> DLG_UNKNOWN_SOURCES:</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> AlertDialog.Builder(<span class="keyword">this</span>)</span><br><span class="line">                .setMessage(R.string.unknown_apps_dlg_text)</span><br><span class="line">                .setNegativeButton(R.string.cancel, <span class="keyword">new</span> DialogInterface.OnClickListener() &#123;</span><br><span class="line">                    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onClick</span><span class="params">(DialogInterface dialog, <span class="keyword">int</span> which)</span> </span>&#123;</span><br><span class="line">                        Log.i(TAG, <span class="string">"Finishing off activity so that user can navigate to settings manually"</span>);</span><br><span class="line">                        finishAffinity();</span><br><span class="line">                    &#125;&#125;)</span><br><span class="line">                .setPositiveButton(R.string.settings, <span class="keyword">new</span> DialogInterface.OnClickListener() &#123;</span><br><span class="line">                    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onClick</span><span class="params">(DialogInterface dialog, <span class="keyword">int</span> which)</span> </span>&#123;</span><br><span class="line">                        Log.i(TAG, <span class="string">"Launching settings"</span>);</span><br><span class="line">                        <span class="comment">//【6.1】设置未知来源开关！</span></span><br><span class="line">                        launchSecuritySettings();</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;)</span><br><span class="line">                .setOnCancelListener(<span class="keyword">this</span>)</span><br><span class="line">                .create();</span><br><span class="line">                </span><br><span class="line">    <span class="comment">//【2】当前用户是在另外用户的 profile 中，同时用户关闭了未知来源设置</span></span><br><span class="line">    <span class="comment">// 此时不能继续安装！</span></span><br><span class="line">    <span class="keyword">case</span> DLG_ADMIN_RESTRICTS_UNKNOWN_SOURCES:</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> AlertDialog.Builder(<span class="keyword">this</span>)</span><br><span class="line">                .setMessage(R.string.unknown_apps_admin_dlg_text)</span><br><span class="line">                .setPositiveButton(android.R.string.ok, <span class="keyword">new</span> DialogInterface.OnClickListener() &#123;</span><br><span class="line">                    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onClick</span><span class="params">(DialogInterface dialog, <span class="keyword">int</span> which)</span> </span>&#123;</span><br><span class="line">                        finish();</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;)</span><br><span class="line">                .setOnCancelListener(<span class="keyword">this</span>)</span><br><span class="line">                .create();</span><br><span class="line">    </span><br><span class="line">    <span class="comment">//【3】当前用户是在另外用户的 profile 中，同时用户关闭了未知来源设置</span></span><br><span class="line">    <span class="comment">// 此时不能继续安装！！</span></span><br><span class="line">    <span class="keyword">case</span> DLG_PACKAGE_ERROR :</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> AlertDialog.Builder(<span class="keyword">this</span>)</span><br><span class="line">                .setMessage(R.string.Parse_error_dlg_text)</span><br><span class="line">                .setPositiveButton(R.string.ok, <span class="keyword">new</span> DialogInterface.OnClickListener() &#123;</span><br><span class="line">                    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onClick</span><span class="params">(DialogInterface dialog, <span class="keyword">int</span> which)</span> </span>&#123;</span><br><span class="line">                        finish();</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;)</span><br><span class="line">                .setOnCancelListener(<span class="keyword">this</span>)</span><br><span class="line">                .create();</span><br><span class="line">                </span><br><span class="line">    <span class="comment">//【4】安装空间不足，此时不能继续安装！！</span></span><br><span class="line">    <span class="keyword">case</span> DLG_OUT_OF_SPACE:</span><br><span class="line">        CharSequence appTitle = mPm.getApplicationLabel(mPkgInfo.applicationInfo);</span><br><span class="line">        String dlgText = getString(R.string.out_of_space_dlg_text,</span><br><span class="line">                appTitle.toString());</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> AlertDialog.Builder(<span class="keyword">this</span>)</span><br><span class="line">                .setMessage(dlgText)</span><br><span class="line">                .setPositiveButton(R.string.manage_applications, <span class="keyword">new</span> DialogInterface.OnClickListener() &#123;</span><br><span class="line">                    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onClick</span><span class="params">(DialogInterface dialog, <span class="keyword">int</span> which)</span> </span>&#123;</span><br><span class="line">                        <span class="comment">//【4.1】进入空间管理界面，用户可以选择释放空间！</span></span><br><span class="line">                        Intent intent = <span class="keyword">new</span> Intent(<span class="string">"android.intent.action.MANAGE_PACKAGE_STORAGE"</span>);</span><br><span class="line">                        intent.setFlags(Intent.FLAG_ACTIVITY_NEW_TASK);</span><br><span class="line">                        startActivity(intent);</span><br><span class="line">                        finish();</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;)</span><br><span class="line">                .setNegativeButton(R.string.cancel, <span class="keyword">new</span> DialogInterface.OnClickListener() &#123;</span><br><span class="line">                    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onClick</span><span class="params">(DialogInterface dialog, <span class="keyword">int</span> which)</span> </span>&#123;</span><br><span class="line">                        Log.i(TAG, <span class="string">"Canceling installation"</span>);</span><br><span class="line">                        finish();</span><br><span class="line">                    &#125;</span><br><span class="line">            &#125;)</span><br><span class="line">              .setOnCancelListener(<span class="keyword">this</span>)</span><br><span class="line">              .create();</span><br><span class="line"></span><br><span class="line">    <span class="comment">//【5】安装失败！！</span></span><br><span class="line">    <span class="keyword">case</span> DLG_INSTALL_ERROR :</span><br><span class="line">        CharSequence appTitle1 = mPm.getApplicationLabel(mPkgInfo.applicationInfo);</span><br><span class="line">        String dlgText1 = getString(R.string.install_failed_msg,</span><br><span class="line">                appTitle1.toString());</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> AlertDialog.Builder(<span class="keyword">this</span>)</span><br><span class="line">                .setNeutralButton(R.string.ok, <span class="keyword">new</span> DialogInterface.OnClickListener() &#123;</span><br><span class="line">                    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onClick</span><span class="params">(DialogInterface dialog, <span class="keyword">int</span> which)</span> </span>&#123;</span><br><span class="line">                        finish();</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;)</span><br><span class="line">                .setMessage(dlgText1)</span><br><span class="line">                .setOnCancelListener(<span class="keyword">this</span>)</span><br><span class="line">                .create();</span><br><span class="line">                </span><br><span class="line">    <span class="comment">//【6】这个是 WEAR 可穿戴设备上的逻辑，这里不关注！</span></span><br><span class="line">    <span class="keyword">case</span> DLG_NOT_SUPPORTED_ON_WEAR:</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> AlertDialog.Builder(<span class="keyword">this</span>)</span><br><span class="line">                .setMessage(R.string.wear_not_allowed_dlg_text)</span><br><span class="line">                .setPositiveButton(R.string.ok, <span class="keyword">new</span> DialogInterface.OnClickListener() &#123;</span><br><span class="line">                    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onClick</span><span class="params">(DialogInterface dialog, <span class="keyword">int</span> which)</span> </span>&#123;</span><br><span class="line">                        setResult(RESULT_OK);</span><br><span class="line">                        clearCachedApkIfNeededAndFinish();</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;)</span><br><span class="line">                .setOnCancelListener(<span class="keyword">this</span>)</span><br><span class="line">                .create();</span><br><span class="line">   &#125;</span><br><span class="line">   <span class="keyword">return</span> <span class="keyword">null</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>不多说了！</p>
<h2 id="6-1-launchSecuritySettings"><a href="#6-1-launchSecuritySettings" class="headerlink" title="6.1 launchSecuritySettings"></a>6.1 launchSecuritySettings</h2><p>进入设置，让用户选择是否打开未知来源设置：<br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">launchSecuritySettings</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    Intent launchSettingsIntent = <span class="keyword">new</span> Intent(Settings.ACTION_SECURITY_SETTINGS);</span><br><span class="line">    startActivityForResult(launchSettingsIntent, REQUEST_ENABLE_UNKNOWN_SOURCES);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
</div></article><div class="post-copyright"><div class="post-copyright__author"><span class="post-copyright-meta">文章作者: </span><span class="post-copyright-info"><a href="mailto:undefined">Coolqi.Li</a></span></div><div class="post-copyright__type"><span class="post-copyright-meta">文章链接: </span><span class="post-copyright-info"><a href="https://coolqi.top/2018/07/23/PMS8-installThroughtPackageInstaller/">https://coolqi.top/2018/07/23/PMS8-installThroughtPackageInstaller/</a></span></div><div class="post-copyright__notice"><span class="post-copyright-meta">版权声明: </span><span class="post-copyright-info">本博客所有文章除特别声明外，均采用 <a href="https://creativecommons.org/licenses/by-nc-sa/4.0/">CC BY-NC-SA 4.0</a> 许可协议。转载请注明来自 <a href="https://coolqi.top">Coolqi`s Blog</a>！</span></div></div><div class="post-meta__tag-list"><a class="post-meta__tags" href="/tags/PackageManager包管理/">PackageManager包管理</a></div><div class="post-qr-code"><div class="post-qr-code-item"><img class="post-qr-code__img" src="/img/zfb.jpg"><div class="post-qr-code__desc">支付宝打赏</div></div><div class="post-qr-code-item"><img class="post-qr-code__img" src="/img/wechat.jpg"><div class="post-qr-code__desc">微信打赏</div></div></div><div class="social-share"></div><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/social-share.js@1.0.16/dist/css/share.min.css"><script src="https://cdn.jsdelivr.net/npm/social-share.js@1.0.16/dist/js/social-share.min.js"></script><nav id="pagination"><div class="prev-post pull-left"><a href="/2018/09/01/PMS9-uninstallThroughAdb/"><i class="fa fa-chevron-left">  </i><span>PMS 第 9 篇 - 通过 adb 指令分析 uninstall 过程</span></a></div><div class="next-post pull-right"><a href="/2018/05/03/PMS7-installThroughAdb/"><span>PMS 第 7 篇 - 通过 pm 指令分析 Install 过程</span><i class="fa fa-chevron-right"></i></a></div></nav></div></div><footer><div class="layout" id="footer"><div class="copyright">&copy;2015 - 2019 By Coolqi.Li</div><div class="framework-info"><span>驱动 - </span><a href="http://hexo.io"><span>Hexo</span></a><span class="footer-separator">|</span><span>主题 - </span><a href="https://github.com/Molunerfinn/hexo-theme-melody"><span>Melody</span></a></div><div class="footer_custom_text">Hi, welcome to my <a href="https://lishuaiqi.top/">blog</a>!</div><div class="busuanzi"><script async src="https://busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script><span id="busuanzi_container_page_pv"><i class="fa fa-file-o"></i><span id="busuanzi_value_page_pv"></span><span></span></span></div></div></footer><i class="fa fa-arrow-up" id="go-up" aria-hidden="true"></i><script src="/js/third-party/anime.min.js"></script><script src="/js/third-party/jquery.min.js"></script><script src="/js/third-party/jquery.fancybox.min.js"></script><script src="/js/third-party/velocity.min.js"></script><script src="/js/third-party/velocity.ui.min.js"></script><script src="/js/utils.js?version=1.5.6"></script><script src="/js/fancybox.js?version=1.5.6"></script><script src="/js/sidebar.js?version=1.5.6"></script><script src="/js/copy.js?version=1.5.6"></script><script src="/js/fireworks.js?version=1.5.6"></script><script src="/js/transition.js?version=1.5.6"></script><script src="/js/scroll.js?version=1.5.6"></script><script src="/js/head.js?version=1.5.6"></script><script type="text/x-mathjax-config">MathJax.Hub.Config({
  tex2jax: {
    inlineMath: [ ['$','$'], ["\\(","\\)"]  ],
    processEscapes: true,
    skipTags: ['script', 'noscript', 'style', 'textarea', 'pre', 'code']
  },
  CommonHTML: {
    linebreaks: { automatic: true, width: "90% container" }
  },
  "HTML-CSS": { 
    linebreaks: { automatic: true, width: "90% container" }
  },
  "SVG": { 
    linebreaks: { automatic: true, width: "90% container" }
  }
});
</script><script type="text/x-mathjax-config">MathJax.Hub.Queue(function() {
  var all = MathJax.Hub.getAllJax(), i;
  for (i=0; i < all.length; i += 1) {
    all[i].SourceElement().parentNode.className += ' has-jax';
  }
});
</script><script src="https://cdn.jsdelivr.net/npm/mathjax/MathJax.js?config=TeX-AMS-MML_HTMLorMML"></script><script src="/js/search/local-search.js"></script><div class="search-dialog" id="local-search"><div class="search-dialog__title" id="local-search-title">本地搜索</div><div id="local-input-panel"><div id="local-search-input"><div class="local-search-box"><input class="local-search-box--input" placeholder="搜索文章"></div></div></div><hr><div id="local-search-results"><div id="local-hits"></div><div id="local-stats"><div class="local-search-stats__hr" id="hr"><span>由</span> <a href="https://github.com/wzpan/hexo-generator-search" style="color:#49B1F5;">hexo-generator-search</a>
 <span>提供支持</span></div></div></div><span class="search-close-button"><i class="fa fa-times"></i></span></div><div class="search-mask"></div><script src="/live2dw/lib/L2Dwidget.min.js?0c58a1486de42ac6cc1c59c7d98ae887"></script><script>L2Dwidget.init({"pluginRootPath":"live2dw/","pluginJsPath":"lib/","pluginModelPath":"assets/","tagMode":false,"debug":false,"model":{"jsonPath":"live2d-widget-model-hijiki"},"display":{"position":"right","width":110,"height":220},"mobile":{"show":false},"log":false});</script></body></html>
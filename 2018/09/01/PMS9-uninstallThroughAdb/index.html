<!DOCTYPE html><html lang="zh-Hans"><head><meta charset="UTF-8"><meta http-equiv="X-UA-Compatible" content="IE=edge"><meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1"><meta name="description" content="PMS 第 9 篇 - 通过 adb 指令分析 uninstall 过程"><meta name="keywords" content="PackageManager包管理"><meta name="author" content="Coolqi.Li,undefined"><meta name="copyright" content="Coolqi.Li"><title>PMS 第 9 篇 - 通过 adb 指令分析 uninstall 过程 | Coolqi`s Blog</title><link rel="shortcut icon" href="/img/favicon.ico"><link rel="stylesheet" href="/css/index.css?version=1.5.6"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/font-awesome@4.7.0/css/font-awesome.min.css?version=1.5.6"><link rel="dns-prefetch" href="https://cdn.staticfile.org"><link rel="dns-prefetch" href="https://cdn.bootcss.com"><link rel="dns-prefetch" href="https://creativecommons.org"><link rel="dns-prefetch" href="https://hm.baidu.com"><script>var _hmt = _hmt || [];
(function() {
  var hm = document.createElement("script");
  hm.src = "https://hm.baidu.com/hm.js?b7acef5306e54116ad8a99e8b753a92d";
  var s = document.getElementsByTagName("script")[0]; 
  s.parentNode.insertBefore(hm, s);
})();</script><script>var GLOBAL_CONFIG = { 
  root: '/',
  algolia: undefined,
  localSearch: {"path":"search.xml","languages":{"hits_empty":"找不到您查询的内容:${query}"}},
  copy: {
    success: '复制成功',
    error: '复制错误',
    noSupport: '浏览器不支持'
  }
} </script></head><body><i class="fa fa-arrow-right" id="toggle-sidebar" aria-hidden="true"></i><div id="sidebar"><div class="toggle-sidebar-info text-center"><span data-toggle="切换文章详情">切换站点概览</span><hr></div><div class="sidebar-toc"><div class="sidebar-toc__title">目录</div><div class="sidebar-toc__progress"><span class="progress-notice">你已经读了</span><span class="progress-num">0</span><span class="progress-percentage">%</span><div class="sidebar-toc__progress-bar"></div></div><div class="sidebar-toc__content"><ol class="toc"><li class="toc-item toc-level-1"><a class="toc-link" href="#0-综述"><span class="toc-text">0 综述</span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#1-adb-uninstall-commandline-adb-commandline"><span class="toc-text">1 adb uninstall - commandline::adb_commandline</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#1-1-cmd-uninstall-支持-cmd-指令"><span class="toc-text">1.1 cmd uninstall - 支持 cmd 指令</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#1-1-1-commandline-uninstall-app"><span class="toc-text">1.1.1 commandline::uninstall_app</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#1-2-pm-uninstall-不支持-cmd-指令"><span class="toc-text">1.2 pm uninstall - 不支持 cmd 指令</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#1-2-1-commandline-uninstall-app-legacy"><span class="toc-text">1.2.1 commandline::uninstall_app_legacy</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#1-2-2-commandline-pm-command"><span class="toc-text">1.2.2 commandline::pm_command</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#1-2-3-commandline-send-shell-command"><span class="toc-text">1.2.3 commandline::send_shell_command</span></a></li></ol></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#2-Pm-install"><span class="toc-text">2 Pm install</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#2-1-runUninstall"><span class="toc-text">2.1 runUninstall</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#2-2-runShellCommand"><span class="toc-text">2.2 runShellCommand</span></a></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#3-PackageManagerShellCommand"><span class="toc-text">3 PackageManagerShellCommand</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#3-1-runUninstall"><span class="toc-text">3.1 runUninstall</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#3-1-1-translateUserId"><span class="toc-text">3.1.1 translateUserId</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#3-1-2-LocalIntentReceiver"><span class="toc-text">3.1.2 LocalIntentReceiver</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#3-1-2-1-new-LocalIntentReceiver"><span class="toc-text">3.1.2.1 new LocalIntentReceiver</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#3-1-2-2-getIntentSender"><span class="toc-text">3.1.2.2 getIntentSender</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#3-1-2-2-getResult"><span class="toc-text">3.1.2.2 getResult</span></a></li></ol></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#3-2-runRemoveSplit"><span class="toc-text">3.2 runRemoveSplit</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#3-2-1-doCreateSession"><span class="toc-text">3.2.1 doCreateSession</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#3-2-2-doRemoveSplit"><span class="toc-text">3.2.2 doRemoveSplit</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#3-2-3-doCommitSession"><span class="toc-text">3.2.3 doCommitSession</span></a></li></ol></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#4-PackageInstallerService"><span class="toc-text">4 PackageInstallerService</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#4-1-uninstall"><span class="toc-text">4.1 uninstall</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#4-1-1-PackageDeleteObserverAdapter"><span class="toc-text">4.1.1 PackageDeleteObserverAdapter</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#4-1-1-1-new-PackageInstallerService"><span class="toc-text">4.1.1.1 new PackageInstallerService</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#4-1-1-2-onUserActionRequired"><span class="toc-text">4.1.1.2 onUserActionRequired</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#4-1-1-3-onPackageDeleted"><span class="toc-text">4.1.1.3 onPackageDeleted</span></a></li></ol></li></ol></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#5-PackageManagerService"><span class="toc-text">5 PackageManagerService</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#5-1-deletePackage"><span class="toc-text">5.1 deletePackage</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#5-1-1-isOrphaned"><span class="toc-text">5.1.1 isOrphaned</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#5-1-1-1-Settings-isOrphaned"><span class="toc-text">5.1.1.1 Settings.isOrphaned</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#5-1-2-isCallerAllowedToSilentlyUninstall"><span class="toc-text">5.1.2 isCallerAllowedToSilentlyUninstall</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#5-1-2-1-getPackageUid"><span class="toc-text">5.1.2.1 getPackageUid</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#5-1-2-2-getInstallerPackageName"><span class="toc-text">5.1.2.2 getInstallerPackageName</span></a><ol class="toc-child"><li class="toc-item toc-level-5"><a class="toc-link" href="#5-1-2-2-1-Settings-getInstallerPackageNameLPr"><span class="toc-text">5.1.2.2.1 Settings.getInstallerPackageNameLPr</span></a></li></ol></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#5-1-3-isUserRestricted"><span class="toc-text">5.1.3 isUserRestricted</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#5-1-4-getBlockUninstallForUser"><span class="toc-text">5.1.4 getBlockUninstallForUser</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#5-1-4-1-PackageSettingBase-getBlockUninstall"><span class="toc-text">5.1.4.1 PackageSettingBase.getBlockUninstall</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#5-1-4-2-PackageSettingBase-readUserState"><span class="toc-text">5.1.4.2 PackageSettingBase.readUserState</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#5-1-5-getBlockUninstallForUsers"><span class="toc-text">5.1.5 getBlockUninstallForUsers</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#5-2-deletePackageX"><span class="toc-text">5.2 deletePackageX</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#5-2-1-PackageRemovedInfo"><span class="toc-text">5.2.1 PackageRemovedInfo</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#5-2-1-1-new-PackageRemovedInfo"><span class="toc-text">5.2.1.1 new PackageRemovedInfo</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#5-2-1-2-sendPackageRemovedBroadcasts"><span class="toc-text">5.2.1.2 sendPackageRemovedBroadcasts</span></a><ol class="toc-child"><li class="toc-item toc-level-5"><a class="toc-link" href="#5-2-1-2-1-sendPackageRemovedBroadcastInternal"><span class="toc-text">5.2.1.2.1 sendPackageRemovedBroadcastInternal</span></a></li></ol></li><li class="toc-item toc-level-4"><a class="toc-link" href="#5-2-1-3-sendSystemPackageUpdatedBroadcasts"><span class="toc-text">5.2.1.3 sendSystemPackageUpdatedBroadcasts</span></a><ol class="toc-child"><li class="toc-item toc-level-5"><a class="toc-link" href="#5-2-1-3-1-sendSystemPackageUpdatedBroadcastsInternal"><span class="toc-text">5.2.1.3.1 sendSystemPackageUpdatedBroadcastsInternal</span></a></li></ol></li><li class="toc-item toc-level-4"><a class="toc-link" href="#5-2-1-4-sendSystemPackageAppearedBroadcasts"><span class="toc-text">5.2.1.4 sendSystemPackageAppearedBroadcasts</span></a><ol class="toc-child"><li class="toc-item toc-level-5"><a class="toc-link" href="#5-2-1-4-1-sendPackageAddedForUser-of-pms"><span class="toc-text">5.2.1.4.1 sendPackageAddedForUser(of pms)</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#5-2-1-4-2-sendPackageAddedForUser-of-pms"><span class="toc-text">5.2.1.4.2 sendPackageAddedForUser(of pms)</span></a></li></ol></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#5-2-2-isPackageDeviceAdmin"><span class="toc-text">5.2.2 isPackageDeviceAdmin</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#5-2-3-isUpdatedSystemApp"><span class="toc-text">5.2.3 isUpdatedSystemApp</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#5-2-4-freezePackageForInstall"><span class="toc-text">5.2.4 freezePackageForInstall</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#5-2-4-1-freezePackage"><span class="toc-text">5.2.4.1 freezePackage</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#5-2-4-2-new-PackageFreezer"><span class="toc-text">5.2.4.2 new PackageFreezer</span></a></li></ol></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#5-3-deletePackageLIF"><span class="toc-text">5.3 deletePackageLIF</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#5-3-1-clearPackageStateForUserLIF"><span class="toc-text">5.3.1 clearPackageStateForUserLIF</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#5-3-2-markPackageUninstalledForUserLPw"><span class="toc-text">5.3.2 markPackageUninstalledForUserLPw</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#5-3-3-shouldKeepUninstalledPackageLPr"><span class="toc-text">5.3.3 shouldKeepUninstalledPackageLPr</span></a></li></ol></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#6-PackageManagerService"><span class="toc-text">6 PackageManagerService</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#6-1-deleteSystemPackageLIF"><span class="toc-text">6.1 deleteSystemPackageLIF</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#6-1-1-enableSystemPackageLPw"><span class="toc-text">6.1.1 enableSystemPackageLPw</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#6-1-1-1-Settings-enableSystemPackageLPw"><span class="toc-text">6.1.1.1 Settings.enableSystemPackageLPw</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#6-1-2-removeNativeBinariesLI"><span class="toc-text">6.1.2 removeNativeBinariesLI</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#6-1-3-locationIsPrivileged"><span class="toc-text">6.1.3 locationIsPrivileged</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#6-1-4-updateSharedLibrariesLPw"><span class="toc-text">6.1.4 updateSharedLibrariesLPw</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#6-1-4-1-addSharedLibraryLPw"><span class="toc-text">6.1.4.1 addSharedLibraryLPw</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#6-1-5-prepareAppDataAfterInstallLIF"><span class="toc-text">6.1.5 prepareAppDataAfterInstallLIF</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#6-1-5-1-prepareAppDataLIF"><span class="toc-text">6.1.5.1 prepareAppDataLIF</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#6-1-5-2-prepareAppDataLeafLIF"><span class="toc-text">6.1.5.2 prepareAppDataLeafLIF</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#6-1-5-3-prepareAppDataContentsLeafLIF"><span class="toc-text">6.1.5.3 prepareAppDataContentsLeafLIF</span></a></li></ol></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#6-2-deleteInstalledPackageLIF"><span class="toc-text">6.2 deleteInstalledPackageLIF</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#6-2-1-removePackageDataLIF"><span class="toc-text">6.2.1 removePackageDataLIF</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#6-2-1-1-removePackageLI"><span class="toc-text">6.2.1.1 removePackageLI</span></a><ol class="toc-child"><li class="toc-item toc-level-5"><a class="toc-link" href="#6-2-1-1-1-cleanPackageDataStructuresLILPw"><span class="toc-text">6.2.1.1.1 cleanPackageDataStructuresLILPw</span></a></li></ol></li><li class="toc-item toc-level-4"><a class="toc-link" href="#6-2-1-2-destroyAppDataLIF-gt-Leaf"><span class="toc-text">6.2.1.2 destroyAppDataLIF -&gt;[Leaf]</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#6-2-1-4-schedulePackageCleaning"><span class="toc-text">6.2.1.4 schedulePackageCleaning</span></a><ol class="toc-child"><li class="toc-item toc-level-5"><a class="toc-link" href="#6-2-1-4-1-Packagehandler-doHandleMessage-START-CLEANING-PACKAGE"><span class="toc-text">6.2.1.4.1 Packagehandler.doHandleMessage[START_CLEANING_PACKAGE]</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#6-2-1-4-2-startCleaningPackages"><span class="toc-text">6.2.1.4.2 startCleaningPackages</span></a></li></ol></li><li class="toc-item toc-level-4"><a class="toc-link" href="#6-2-1-5-Settings-removePackageLPw"><span class="toc-text">6.2.1.5 Settings.removePackageLPw</span></a><ol class="toc-child"><li class="toc-item toc-level-5"><a class="toc-link" href="#6-2-1-5-1-Settings-removeInstallerPackageStatus"><span class="toc-text">6.2.1.5.1 Settings.removeInstallerPackageStatus</span></a></li></ol></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#6-2-2-createInstallArgsForExisting-用于卸载-apk"><span class="toc-text">6.2.2 createInstallArgsForExisting - 用于卸载 apk</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#6-2-2-1-FileInstallArgs"><span class="toc-text">6.2.2.1 FileInstallArgs</span></a><ol class="toc-child"><li class="toc-item toc-level-5"><a class="toc-link" href="#6-2-2-1-1-new-FileInstallArgs"><span class="toc-text">6.2.2.1.1 new FileInstallArgs</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#6-2-2-1-2-doPostDeleteLI"><span class="toc-text">6.2.2.1.2 doPostDeleteLI</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#6-2-2-1-3-cleanUpResourcesLI"><span class="toc-text">6.2.2.1.3 cleanUpResourcesLI</span></a></li></ol></li></ol></li></ol></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#7-remove-split-apk-移除-split（模块）apk"><span class="toc-text">7 remove split apk - 移除 split（模块）apk</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#7-1-PackageInstallerService"><span class="toc-text">7.1 PackageInstallerService</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#7-1-1-createSession-Internal-创建事务"><span class="toc-text">7.1.1 createSession(Internal) - 创建事务</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#7-1-2-openSession-获得事务"><span class="toc-text">7.1.2 openSession - 获得事务</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#7-1-2-1-openSessionInternal"><span class="toc-text">7.1.2.1 openSessionInternal</span></a></li></ol></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#7-2-PackageInstallerSession"><span class="toc-text">7.2 PackageInstallerSession</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#7-2-1-new-PackageInstallerSession-事务实例"><span class="toc-text">7.2.1 new PackageInstallerSession - 事务实例</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#7-2-2-removeSplit"><span class="toc-text">7.2.2 removeSplit</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#7-2-3-createRemoveSplitMarker"><span class="toc-text">7.2.3 createRemoveSplitMarker</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#7-2-3-1-resolveStageDir"><span class="toc-text">7.2.3.1 resolveStageDir</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#7-2-4-commitLocked"><span class="toc-text">7.2.4 commitLocked</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#7-2-4-1-validateInstallLocked"><span class="toc-text">7.2.4.1 validateInstallLocked</span></a></li></ol></li></ol></li></ol></li></ol></div></div><div class="author-info hide"><div class="author-info__avatar text-center"><img src="/img/avatar.png"></div><div class="author-info__name text-center">Coolqi.Li</div><div class="author-info__description text-center">“你好，我是李帅奇，Android 系统工程师，MineCraft 忠实玩家，设计和绘画爱好者，缺妹纸晚期患者，熬夜星人。”</div><hr><div class="author-info-articles"><a class="author-info-articles__archives article-meta" href="/archives"><span class="pull-left">文章</span><span class="pull-right">72</span></a><a class="author-info-articles__tags article-meta" href="/tags"><span class="pull-left">标签</span><span class="pull-right">16</span></a><a class="author-info-articles__categories article-meta" href="/categories"><span class="pull-left">分类</span><span class="pull-right">18</span></a></div><hr><div class="author-info-links"><div class="author-info-links__title text-center">Links</div><a class="author-info-links__name text-center" href="https://developer.android.google.cn/">AndroidDeveloper</a><a class="author-info-links__name text-center" href="http://www.android-studio.org/">AndroidStudio</a><a class="author-info-links__name text-center" href="https://www.jianshu.com/u/123a20a96441">简书</a><a class="author-info-links__name text-center" href="https://weibo.com/coolqiLi">微博</a></div></div></div><div id="content-outer"><div id="top-container" style="background-image: url(https://ws1.sinaimg.cn/large/8700af19ly1fvpabr30o6j22yo1o0q7i.jpg)"><div id="page-header"><span class="pull-left"> <a id="site-name" href="/">Coolqi`s Blog</a></span><i class="fa fa-bars toggle-menu pull-right" aria-hidden="true"></i><span class="pull-right menus"><a class="site-page social-icon search"><i class="fa fa-search"></i><span> 搜索</span></a><a class="site-page" href="/">Home</a><a class="site-page" href="/categories">Categories</a><a class="site-page" href="/tags">Tags</a><a class="site-page" href="/archives">Archives</a><a class="site-page" href="/about">About</a></span></div><div id="post-info"><div id="post-title">PMS 第 9 篇 - 通过 adb 指令分析 uninstall 过程</div><div id="post-meta"><time class="post-meta__date"><i class="fa fa-calendar" aria-hidden="true"></i> 2018-09-01</time><span class="post-meta__separator">|</span><i class="fa fa-inbox post-meta__icon" aria-hidden="true"></i><a class="post-meta__categories" href="/categories/AndroidFramework源码分析/">AndroidFramework源码分析</a><i class="fa fa-angle-right" aria-hidden="true"></i><i class="fa fa-inbox post-meta__icon" aria-hidden="true"></i><a class="post-meta__categories" href="/categories/AndroidFramework源码分析/PackageManager包管理/">PackageManager包管理</a><div class="post-meta-wordcount"><span>字数总计: </span><span class="word-count">18.3k</span><span class="post-meta__separator">|</span><span>阅读时长: 89 分钟</span></div></div></div></div><div class="layout" id="content-inner"><article id="post"><div class="article-container" id="post-content"><p>[toc]</p>
<p>基于 Android 7.1.1 源码分析 PackageManagerService 的架构和逻辑实现！</p>
<h1 id="0-综述"><a href="#0-综述" class="headerlink" title="0 综述"></a>0 综述</h1><p>本篇文章总结下 uninstall package 的过程，一般来说，卸载一个应用有如下的方式：</p>
<ul>
<li>adb uninstall（最终调用的还是 pm uninstall/cmd package uninstall）；</li>
<li>adb cmd package uninstall;</li>
<li>adb shell pm uninstall;</li>
<li>进入应用管理器中，手动触发卸载（进入 packageInstaller）；</li>
</ul>
<p>这里我们先来看通过 adb 指令 uninstall 的过程：</p>
<h1 id="1-adb-uninstall-commandline-adb-commandline"><a href="#1-adb-uninstall-commandline-adb-commandline" class="headerlink" title="1 adb uninstall - commandline::adb_commandline"></a>1 adb uninstall - commandline::adb_commandline</h1><p>同样的 adb uninstall 的执行也是从 system/core/adb/commandline.cpp 开始：</p>
<p>adb_commandline 中会设置到大量的 adb 指令的处理，这里我们只关注 adb install 的处理：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">adb_commandline</span><span class="params">(<span class="keyword">int</span> argc, <span class="keyword">const</span> <span class="keyword">char</span> **argv)</span> </span>&#123;</span><br><span class="line">    ... ... ...</span><br><span class="line">    <span class="keyword">else</span> <span class="keyword">if</span> (!strcmp(argv[<span class="number">0</span>], <span class="string">"uninstall"</span>)) &#123; <span class="comment">// adb uninstall 命令!</span></span><br><span class="line">        <span class="keyword">if</span> (argc &lt; <span class="number">2</span>) <span class="keyword">return</span> usage();</span><br><span class="line">        <span class="keyword">if</span> (_use_legacy_install()) &#123;</span><br><span class="line">            <span class="comment">//【*1.2.2】不支持 cmd 使用 pm 安装！</span></span><br><span class="line">            <span class="keyword">return</span> uninstall_app_legacy(transport_type, serial, argc, argv);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">//【*1.2.1】支持 cmd 使用 cmd 安装！</span></span><br><span class="line">        <span class="keyword">return</span> uninstall_app(transport_type, serial, argc, argv);</span><br><span class="line">    &#125;</span><br><span class="line">    ... ... ...</span><br><span class="line">    usage();</span><br><span class="line">    <span class="keyword">return</span> <span class="number">1</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>这里看到，如果支持 cmd 命令的情况下，_use_legacy_install() 方法返回 false，会调用 uninstall_app；不支持的话，执行 uninstall_app_legacy 方法！</p>
<p>Android cmd 命令功能非常强大，包含了我们之前使用 am pm 等等的命令，这里我们不深入分析 cmd 的命令的实现，我们关注和 uninstall 相关的逻辑！</p>
<p>下面继续分析，进一步的安装过程：</p>
<h2 id="1-1-cmd-uninstall-支持-cmd-指令"><a href="#1-1-cmd-uninstall-支持-cmd-指令" class="headerlink" title="1.1 cmd uninstall - 支持 cmd 指令"></a>1.1 cmd uninstall - 支持 cmd 指令</h2><h3 id="1-1-1-commandline-uninstall-app"><a href="#1-1-1-commandline-uninstall-app" class="headerlink" title="1.1.1 commandline::uninstall_app"></a>1.1.1 commandline::uninstall_app</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">static</span> <span class="keyword">int</span> <span class="title">uninstall_app</span><span class="params">(TransportType transport, <span class="keyword">const</span> <span class="keyword">char</span>* serial, <span class="keyword">int</span> argc, <span class="keyword">const</span> <span class="keyword">char</span>** argv)</span> </span>&#123;</span><br><span class="line">    <span class="comment">//【1】adb uninstall 会转为 cmd package uninstall，参数相同；</span></span><br><span class="line">    std::string cmd = <span class="string">"cmd package"</span>;</span><br><span class="line">    <span class="keyword">while</span> (argc-- &gt; <span class="number">0</span>) &#123;</span><br><span class="line">        <span class="keyword">if</span> (strcmp(*argv, <span class="string">"-k"</span>) == <span class="number">0</span>) &#123;</span><br><span class="line">            printf(</span><br><span class="line">                <span class="string">"The -k option uninstalls the application while retaining the data/cache.\n"</span></span><br><span class="line">                <span class="string">"At the moment, there is no way to remove the remaining data.\n"</span></span><br><span class="line">                <span class="string">"You will have to reinstall the application with the same signature, and fully uninstall it.\n"</span></span><br><span class="line">                <span class="string">"If you truly wish to continue, execute 'adb shell cmd package uninstall -k'.\n"</span>);</span><br><span class="line">            <span class="keyword">return</span> EXIT_FAILURE;</span><br><span class="line">        &#125;</span><br><span class="line">        cmd += <span class="string">" "</span> + escape_arg(*argv++);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">//【*1.2.3】调用 send_shell_command 指令；</span></span><br><span class="line">    <span class="keyword">return</span> send_shell_command(transport, serial, cmd, <span class="keyword">false</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h2 id="1-2-pm-uninstall-不支持-cmd-指令"><a href="#1-2-pm-uninstall-不支持-cmd-指令" class="headerlink" title="1.2 pm uninstall - 不支持 cmd 指令"></a>1.2 pm uninstall - 不支持 cmd 指令</h2><h3 id="1-2-1-commandline-uninstall-app-legacy"><a href="#1-2-1-commandline-uninstall-app-legacy" class="headerlink" title="1.2.1 commandline::uninstall_app_legacy"></a>1.2.1 commandline::uninstall_app_legacy</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">static</span> <span class="keyword">int</span> <span class="title">uninstall_app_legacy</span><span class="params">(TransportType transport, <span class="keyword">const</span> <span class="keyword">char</span>* serial, <span class="keyword">int</span> argc, <span class="keyword">const</span> <span class="keyword">char</span>** argv)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">int</span> i;</span><br><span class="line">    <span class="keyword">for</span> (i = <span class="number">1</span>; i &lt; argc; i++) &#123;</span><br><span class="line">        <span class="keyword">if</span> (!strcmp(argv[i], <span class="string">"-k"</span>)) &#123;</span><br><span class="line">            printf(</span><br><span class="line">                <span class="string">"The -k option uninstalls the application while retaining the data/cache.\n"</span></span><br><span class="line">                <span class="string">"At the moment, there is no way to remove the remaining data.\n"</span></span><br><span class="line">                <span class="string">"You will have to reinstall the application with the same signature, and fully uninstall it.\n"</span></span><br><span class="line">                <span class="string">"If you truly wish to continue, execute 'adb shell pm uninstall -k'\n."</span>);</span><br><span class="line">            <span class="keyword">return</span> EXIT_FAILURE;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">//【*1.2.2】调用 pm_command 指令；</span></span><br><span class="line">    <span class="keyword">return</span> pm_command(transport, serial, argc, argv);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h3 id="1-2-2-commandline-pm-command"><a href="#1-2-2-commandline-pm-command" class="headerlink" title="1.2.2 commandline::pm_command"></a>1.2.2 commandline::pm_command</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">static</span> <span class="keyword">int</span> <span class="title">pm_command</span><span class="params">(TransportType transport, <span class="keyword">const</span> <span class="keyword">char</span>* serial, <span class="keyword">int</span> argc, <span class="keyword">const</span> <span class="keyword">char</span>** argv)</span> </span>&#123;</span><br><span class="line">   <span class="comment">//【1】adb uninstall 会转为 pm uninstall，参数相同；</span></span><br><span class="line">    std::string cmd = <span class="string">"pm"</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">while</span> (argc-- &gt; <span class="number">0</span>) &#123;</span><br><span class="line">        cmd += <span class="string">" "</span> + escape_arg(*argv++);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">//【*1.2.3】调用 send_shell_command 指令；</span></span><br><span class="line">    <span class="keyword">return</span> send_shell_command(transport, serial, cmd, <span class="keyword">false</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h3 id="1-2-3-commandline-send-shell-command"><a href="#1-2-3-commandline-send-shell-command" class="headerlink" title="1.2.3 commandline::send_shell_command"></a>1.2.3 commandline::send_shell_command</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">send_shell_command</span><span class="params">(TransportType transport_type, <span class="keyword">const</span> <span class="keyword">char</span>* serial, <span class="keyword">const</span> std::string&amp; command,</span></span></span><br><span class="line"><span class="function"><span class="params">                       bool disable_shell_protocol, StandardStreamsCallbackInterface* callback)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">int</span> fd;</span><br><span class="line">    bool use_shell_protocol = <span class="keyword">false</span>;</span><br><span class="line">    <span class="keyword">while</span> (<span class="keyword">true</span>) &#123;</span><br><span class="line">        bool attempt_connection = <span class="keyword">true</span>;</span><br><span class="line">        <span class="comment">// 使用 shell protocol</span></span><br><span class="line">        <span class="keyword">if</span> (!disable_shell_protocol) &#123;</span><br><span class="line">            FeatureSet features;</span><br><span class="line">            std::string error;</span><br><span class="line">            <span class="keyword">if</span> (adb_get_feature_set(&amp;features, &amp;error)) &#123;</span><br><span class="line">                <span class="comment">// 如果系统支持 shell_v2 的 feature，则使用 shell！！</span></span><br><span class="line">                use_shell_protocol = CanUseFeature(features, kFeatureShell2);</span><br><span class="line">            &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                attempt_connection = <span class="keyword">false</span>;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">if</span> (attempt_connection) &#123;</span><br><span class="line">            std::string error;</span><br><span class="line">            <span class="comment">// 如果是 pm uninstall 此时 command 中携带的就是以 pm 开头的命令；</span></span><br><span class="line">            <span class="comment">// 如果是 cmd package uninstall 此时 command 中携带的就是以 cmd 开头的命令；</span></span><br><span class="line">            std::string service_string = ShellServiceString(use_shell_protocol, <span class="string">""</span>, command);</span><br><span class="line">            <span class="comment">// 向 shell protocol 发送命令</span></span><br><span class="line">            fd = adb_connect(service_string, &amp;error);</span><br><span class="line">            <span class="keyword">if</span> (fd &gt;= <span class="number">0</span>) &#123;</span><br><span class="line">                <span class="keyword">break</span>;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        fprintf(stderr, <span class="string">"- waiting for device -\n"</span>);</span><br><span class="line">        <span class="keyword">if</span> (!wait_for_device(<span class="string">"wait-for-device"</span>, transport_type, serial)) &#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="number">1</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// 处理命令执行结果！</span></span><br><span class="line">    <span class="keyword">int</span> exit_code = read_and_dump(fd, use_shell_protocol, callback);</span><br><span class="line">    <span class="keyword">if</span> (adb_close(fd) &lt; <span class="number">0</span>) &#123;</span><br><span class="line">        PLOG(ERROR) &lt;&lt; <span class="string">"failure closing FD "</span> &lt;&lt; fd;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> exit_code;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>可以看到，最后都是调用 shell 执行相关指令！</p>
<p>前面我们有分析过：</p>
<ul>
<li>cmd package uninstall 最后调用的是 PackageManagerShellCommand 相关方法；</li>
<li>pm uninstall 最后调用的是 pm 相关方法；</li>
</ul>
<h1 id="2-Pm-install"><a href="#2-Pm-install" class="headerlink" title="2 Pm install"></a>2 Pm install</h1><p>对于 pm 命令的执行过程，我们不在过多分析，直接进入重点：</p>
<h2 id="2-1-runUninstall"><a href="#2-1-runUninstall" class="headerlink" title="2.1 runUninstall"></a>2.1 runUninstall</h2><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">int</span> <span class="title">runUninstall</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    <span class="comment">//【*2.2】继续处理！</span></span><br><span class="line">    <span class="keyword">return</span> runShellCommand(<span class="string">"package"</span>, mArgs);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h2 id="2-2-runShellCommand"><a href="#2-2-runShellCommand" class="headerlink" title="2.2 runShellCommand"></a>2.2 runShellCommand</h2><p>我们看到，我们传入的 Service name 是 “package”，其实看到这里，我们已经能猜到了，其和 cmd install 一样，最后会调用了 PackageManagerShellCommand 的 onCommand 方法！</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">int</span> <span class="title">runShellCommand</span><span class="params">(String serviceName, String[] args)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">final</span> HandlerThread handlerThread = <span class="keyword">new</span> HandlerThread(<span class="string">"results"</span>);</span><br><span class="line">    handlerThread.start();</span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">        <span class="comment">//【*3.1】通过 pms 触发 PackageManagerShellCommand 的 onCommand 方法，最后会根据参数</span></span><br><span class="line">        <span class="comment">// 最后会进入 runUninstall 方法中！</span></span><br><span class="line">        ServiceManager.getService(serviceName).shellCommand(</span><br><span class="line">                FileDescriptor.in, FileDescriptor.out, FileDescriptor.err,</span><br><span class="line">                args, <span class="keyword">new</span> ResultReceiver(<span class="keyword">new</span> Handler(handlerThread.getLooper())));</span><br><span class="line">        <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">    &#125; <span class="keyword">catch</span> (RemoteException e) &#123;</span><br><span class="line">        e.printStackTrace();</span><br><span class="line">    &#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">        handlerThread.quitSafely();</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> -<span class="number">1</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>我们可以去 pms 的代码中看到，pms 有如下的逻辑：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onShellCommand</span><span class="params">(FileDescriptor in, FileDescriptor out,</span></span></span><br><span class="line"><span class="function"><span class="params">        FileDescriptor err, String[] args, ResultReceiver resultReceiver)</span> </span>&#123;</span><br><span class="line">    <span class="comment">//【*3.1】调用了 PackageManagerShellCommand 的接口！！</span></span><br><span class="line">    (<span class="keyword">new</span> PackageManagerShellCommand(<span class="keyword">this</span>)).exec(</span><br><span class="line">            <span class="keyword">this</span>, in, out, err, args, resultReceiver);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>PackageManagerShellCommand 继承了 ShellCommand， exec 内部会触发 onCommand 方法，有兴趣大家可以去学习，这里不关注！！</p>
<h1 id="3-PackageManagerShellCommand"><a href="#3-PackageManagerShellCommand" class="headerlink" title="3 PackageManagerShellCommand"></a>3 PackageManagerShellCommand</h1><h2 id="3-1-runUninstall"><a href="#3-1-runUninstall" class="headerlink" title="3.1 runUninstall"></a>3.1 runUninstall</h2><p>我们来分析下 runUninstall 的逻辑：<br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">int</span> <span class="title">runUninstall</span><span class="params">()</span> <span class="keyword">throws</span> RemoteException </span>&#123;</span><br><span class="line">    <span class="keyword">final</span> PrintWriter pw = getOutPrintWriter();</span><br><span class="line">    <span class="keyword">int</span> flags = <span class="number">0</span>;</span><br><span class="line">    <span class="keyword">int</span> userId = UserHandle.USER_ALL; <span class="comment">// 默认所有用户！</span></span><br><span class="line"></span><br><span class="line">    String opt;</span><br><span class="line">    <span class="comment">//【1】读取额外参数</span></span><br><span class="line">    <span class="keyword">while</span> ((opt = getNextOption()) != <span class="keyword">null</span>) &#123;</span><br><span class="line">        <span class="keyword">switch</span> (opt) &#123;</span><br><span class="line">            <span class="keyword">case</span> <span class="string">"-k"</span>:</span><br><span class="line">                <span class="comment">//【1.1】是否再卸载后保留数据；</span></span><br><span class="line">                flags |= PackageManager.DELETE_KEEP_DATA;</span><br><span class="line">                <span class="keyword">break</span>;</span><br><span class="line">            <span class="keyword">case</span> <span class="string">"--user"</span>:</span><br><span class="line">                <span class="comment">//【1.1】是否指定 user！</span></span><br><span class="line">                userId = UserHandle.parseUserArg(getNextArgRequired());</span><br><span class="line">                <span class="keyword">break</span>;</span><br><span class="line">            <span class="keyword">default</span>:</span><br><span class="line">                pw.println(<span class="string">"Error: Unknown option: "</span> + opt);</span><br><span class="line">                <span class="keyword">return</span> <span class="number">1</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">//【3】获得要卸载的应用包名；</span></span><br><span class="line">    <span class="keyword">final</span> String packageName = getNextArg();</span><br><span class="line">    <span class="keyword">if</span> (packageName == <span class="keyword">null</span>) &#123;</span><br><span class="line">        pw.println(<span class="string">"Error: package name not specified"</span>);</span><br><span class="line">        <span class="keyword">return</span> <span class="number">1</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">//【4】获得要卸载的应用的 split apk 包名，如果指定的 split name，那就只卸载对应的 split apk！</span></span><br><span class="line">    <span class="keyword">final</span> String splitName = getNextArg();</span><br><span class="line">    <span class="keyword">if</span> (splitName != <span class="keyword">null</span>) &#123;</span><br><span class="line">        <span class="comment">//【*3.2】移除 split apk！</span></span><br><span class="line">        <span class="keyword">return</span> runRemoveSplit(packageName, splitName);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">//【*3.1.1】对 userId 做一个转换处理;</span></span><br><span class="line">    userId = translateUserId(userId, <span class="string">"runUninstall"</span>);</span><br><span class="line">    <span class="keyword">if</span> (userId == UserHandle.USER_ALL) &#123;</span><br><span class="line">        <span class="comment">//【5】如果是从所有用户下删除，那么 userId 变为 USER_SYSTEM；</span></span><br><span class="line">        <span class="comment">// flags 设置 DELETE_ALL_USERS 标志位；</span></span><br><span class="line">        userId = UserHandle.USER_SYSTEM;</span><br><span class="line">        flags |= PackageManager.DELETE_ALL_USERS;</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        <span class="comment">//【6】如果是从指定用户下删除，那么要判断在该 userId 下是否有安装信息；</span></span><br><span class="line">        <span class="keyword">final</span> PackageInfo info = mInterface.getPackageInfo(packageName, <span class="number">0</span>, userId);</span><br><span class="line">        <span class="keyword">if</span> (info == <span class="keyword">null</span>) &#123;</span><br><span class="line">            pw.println(<span class="string">"Failure [not installed for "</span> + userId + <span class="string">"]"</span>);</span><br><span class="line">            <span class="keyword">return</span> <span class="number">1</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">//【7】判断是否是 sys app，如果是的话 flags 增加 DELETE_SYSTEM_APP 标志位！</span></span><br><span class="line">        <span class="keyword">final</span> <span class="keyword">boolean</span> isSystem =</span><br><span class="line">                (info.applicationInfo.flags &amp; ApplicationInfo.FLAG_SYSTEM) != <span class="number">0</span>;</span><br><span class="line">        <span class="keyword">if</span> (isSystem) &#123;</span><br><span class="line">            flags |= PackageManager.DELETE_SYSTEM_APP;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//【*3.1.2.1】这里是注册可以了本地监听器 LocalIntentReceiver，监听卸载结果，在 install 我们</span></span><br><span class="line">    <span class="comment">// 有分析过，这里就不多说了！</span></span><br><span class="line">    <span class="keyword">final</span> LocalIntentReceiver receiver = <span class="keyword">new</span> LocalIntentReceiver();</span><br><span class="line"></span><br><span class="line">    <span class="comment">//【*4.1】触发卸载；</span></span><br><span class="line">    mInterface.getPackageInstaller().uninstall(packageName, <span class="keyword">null</span> <span class="comment">/*callerPackageName*/</span>, flags,</span><br><span class="line">            receiver.getIntentSender(), userId);</span><br><span class="line">    </span><br><span class="line">    <span class="comment">//【*3.1.2.2】接收卸载结果，就是前面分析时，创建的 intent fillIn！！</span></span><br><span class="line">    <span class="keyword">final</span> Intent result = receiver.getResult();</span><br><span class="line">    <span class="keyword">final</span> <span class="keyword">int</span> status = result.getIntExtra(PackageInstaller.EXTRA_STATUS,</span><br><span class="line">            PackageInstaller.STATUS_FAILURE);</span><br><span class="line">    <span class="keyword">if</span> (status == PackageInstaller.STATUS_SUCCESS) &#123;</span><br><span class="line">        pw.println(<span class="string">"Success"</span>);</span><br><span class="line">        <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        pw.println(<span class="string">"Failure ["</span></span><br><span class="line">                + result.getStringExtra(PackageInstaller.EXTRA_STATUS_MESSAGE) + <span class="string">"]"</span>);</span><br><span class="line">        <span class="keyword">return</span> <span class="number">1</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>这里的 mInterface.getPackageInstaller() 返回的是 PackageInstallerService，下面我们去 PackageInstallerService 中看看：</p>
<h3 id="3-1-1-translateUserId"><a href="#3-1-1-translateUserId" class="headerlink" title="3.1.1 translateUserId"></a>3.1.1 translateUserId</h3><p>如果 uninstall 指定的 user，那么这里会对 userId 做一个转换处理：<br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">int</span> <span class="title">translateUserId</span><span class="params">(<span class="keyword">int</span> userId, String logContext)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">return</span> ActivityManager.handleIncomingUser(Binder.getCallingPid(), Binder.getCallingUid(),</span><br><span class="line">            userId, <span class="keyword">true</span>, <span class="keyword">true</span>, logContext, <span class="string">"pm command"</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<h3 id="3-1-2-LocalIntentReceiver"><a href="#3-1-2-LocalIntentReceiver" class="headerlink" title="3.1.2 LocalIntentReceiver"></a>3.1.2 LocalIntentReceiver</h3><p>LocalIntentReceiver 主要用于接收最终的返回结果，以及和其他模块通信：</p>
<h4 id="3-1-2-1-new-LocalIntentReceiver"><a href="#3-1-2-1-new-LocalIntentReceiver" class="headerlink" title="3.1.2.1 new LocalIntentReceiver"></a>3.1.2.1 new LocalIntentReceiver</h4><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">private</span> <span class="keyword">static</span> <span class="class"><span class="keyword">class</span> <span class="title">LocalIntentReceiver</span> </span>&#123;</span><br><span class="line">    <span class="comment">//【1】内有一个阻塞队列，用于保存 intent！</span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> SynchronousQueue&lt;Intent&gt; mResult = <span class="keyword">new</span> SynchronousQueue&lt;&gt;();</span><br><span class="line"></span><br><span class="line">    <span class="comment">//【2】发送 intent 给其他模块：</span></span><br><span class="line">    <span class="keyword">private</span> IIntentSender.Stub mLocalSender = <span class="keyword">new</span> IIntentSender.Stub() &#123;</span><br><span class="line">        <span class="meta">@Override</span></span><br><span class="line">        <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">send</span><span class="params">(<span class="keyword">int</span> code, Intent intent, String resolvedType,</span></span></span><br><span class="line"><span class="function"><span class="params">                IIntentReceiver finishedReceiver, String requiredPermission, Bundle options)</span> </span>&#123;</span><br><span class="line">            <span class="keyword">try</span> &#123;</span><br><span class="line">                <span class="comment">//【2.1】将 Proxy 传来的 intent 加入的阻塞队列中！</span></span><br><span class="line">                mResult.offer(intent, <span class="number">5</span>, TimeUnit.SECONDS);</span><br><span class="line">            &#125; <span class="keyword">catch</span> (InterruptedException e) &#123;</span><br><span class="line">                <span class="keyword">throw</span> <span class="keyword">new</span> RuntimeException(e);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;;</span><br></pre></td></tr></table></figure>
<p>不多数说了！！</p>
<h4 id="3-1-2-2-getIntentSender"><a href="#3-1-2-2-getIntentSender" class="headerlink" title="3.1.2.2 getIntentSender"></a>3.1.2.2 getIntentSender</h4><p>返回代理对象，用于跨进程通信：<br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> IntentSender <span class="title">getIntentSender</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">new</span> IntentSender((IIntentSender) mLocalSender);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<h4 id="3-1-2-2-getResult"><a href="#3-1-2-2-getResult" class="headerlink" title="3.1.2.2 getResult"></a>3.1.2.2 getResult</h4><p>从内部的阻塞队列中返回结果！</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> Intent <span class="title">getResult</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> mResult.take();</span><br><span class="line">    &#125; <span class="keyword">catch</span> (InterruptedException e) &#123;</span><br><span class="line">        <span class="keyword">throw</span> <span class="keyword">new</span> RuntimeException(e);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h2 id="3-2-runRemoveSplit"><a href="#3-2-runRemoveSplit" class="headerlink" title="3.2 runRemoveSplit"></a>3.2 runRemoveSplit</h2><p>我们来看下删除 split apk 的逻辑！</p>
<p>参数 String packageName 是主 pkg，String splitName 则是 split apk 的包名！</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">int</span> <span class="title">runRemoveSplit</span><span class="params">(String packageName, String splitName)</span> <span class="keyword">throws</span> RemoteException </span>&#123;</span><br><span class="line">    <span class="keyword">final</span> PrintWriter pw = getOutPrintWriter();</span><br><span class="line">    <span class="comment">//【1-review】这边创建了一个 SessionParams 实例，封装卸载的事务参数！</span></span><br><span class="line">    <span class="comment">// 这里就不在分析了，前面看过！</span></span><br><span class="line">    <span class="keyword">final</span> SessionParams sessionParams = <span class="keyword">new</span> SessionParams(SessionParams.MODE_INHERIT_EXISTING);</span><br><span class="line">    sessionParams.installFlags |= PackageManager.INSTALL_REPLACE_EXISTING;</span><br><span class="line">    sessionParams.appPackageName = packageName;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//【*3.2.1】创建一个卸载事务！</span></span><br><span class="line">    <span class="keyword">final</span> <span class="keyword">int</span> sessionId =</span><br><span class="line">            doCreateSession(sessionParams, <span class="keyword">null</span> <span class="comment">/*installerPackageName*/</span>, UserHandle.USER_ALL);</span><br><span class="line">    <span class="keyword">boolean</span> abandonSession = <span class="keyword">true</span>;</span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">        <span class="comment">//【*3.2.2】移除 split apk！</span></span><br><span class="line">        <span class="keyword">if</span> (doRemoveSplit(sessionId, splitName, <span class="keyword">false</span> <span class="comment">/*logSuccess*/</span>)</span><br><span class="line">                != PackageInstaller.STATUS_SUCCESS) &#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="number">1</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">//【*3.2.3】提交事务</span></span><br><span class="line">        <span class="keyword">if</span> (doCommitSession(sessionId, <span class="keyword">false</span> <span class="comment">/*logSuccess*/</span>)</span><br><span class="line">                != PackageInstaller.STATUS_SUCCESS) &#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="number">1</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        abandonSession = <span class="keyword">false</span>;</span><br><span class="line">        pw.println(<span class="string">"Success"</span>);</span><br><span class="line">        <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line"></span><br><span class="line">    &#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">        <span class="keyword">if</span> (abandonSession) &#123;</span><br><span class="line">            <span class="keyword">try</span> &#123;</span><br><span class="line">                doAbandonSession(sessionId, <span class="keyword">false</span> <span class="comment">/*logSuccess*/</span>);</span><br><span class="line">            &#125; <span class="keyword">catch</span> (Exception ignore) &#123;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>这里先创建了一个 SessionParams，参数均是 @hide 的，这里我省略了！</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> <span class="class"><span class="keyword">class</span> <span class="title">SessionParams</span> <span class="keyword">implements</span> <span class="title">Parcelable</span> </span>&#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">int</span> mode = MODE_INVALID;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">int</span> installFlags;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">int</span> installLocation = PackageInfo.INSTALL_LOCATION_INTERNAL_ONLY; <span class="comment">// 默认为仅内置</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">long</span> sizeBytes = -<span class="number">1</span>;</span><br><span class="line">    <span class="keyword">public</span> String appPackageName; <span class="comment">// 这里其为主 pkg 的包名！</span></span><br><span class="line">    <span class="keyword">public</span> Bitmap appIcon;</span><br><span class="line">    <span class="keyword">public</span> String appLabel;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">long</span> appIconLastModified = -<span class="number">1</span>;</span><br><span class="line">    <span class="keyword">public</span> Uri originatingUri;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">int</span> originatingUid = UID_UNKNOWN;</span><br><span class="line">    <span class="keyword">public</span> Uri referrerUri;</span><br><span class="line">    <span class="keyword">public</span> String abiOverride;</span><br><span class="line">    <span class="keyword">public</span> String volumeUuid;</span><br><span class="line">    <span class="keyword">public</span> String[] grantedRuntimePermissions;</span><br><span class="line">    </span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="title">SessionParams</span><span class="params">(<span class="keyword">int</span> mode)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">this</span>.mode = mode;</span><br><span class="line">    &#125;</span><br><span class="line">    ... ... ...</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>可以看到，对于 remove split apk，其流程和 install 很类似！</p>
<h3 id="3-2-1-doCreateSession"><a href="#3-2-1-doCreateSession" class="headerlink" title="3.2.1 doCreateSession"></a>3.2.1 doCreateSession</h3><p>创建事务：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">int</span> <span class="title">doCreateSession</span><span class="params">(SessionParams params, String installerPackageName, <span class="keyword">int</span> userId)</span></span></span><br><span class="line"><span class="function">        <span class="keyword">throws</span> RemoteException </span>&#123;</span><br><span class="line">    <span class="comment">//【*3.1.1】对 user 进行一个转换；</span></span><br><span class="line">    userId = translateUserId(userId, <span class="string">"runInstallCreate"</span>);</span><br><span class="line">    <span class="keyword">if</span> (userId == UserHandle.USER_ALL) &#123;</span><br><span class="line">        userId = UserHandle.USER_SYSTEM;</span><br><span class="line">        params.installFlags |= PackageManager.INSTALL_ALL_USERS;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//【*7.1.1】调用 PackageInstallerService 的 createSession 创建一个新的事务！</span></span><br><span class="line">    <span class="keyword">final</span> <span class="keyword">int</span> sessionId = mInterface.getPackageInstaller()</span><br><span class="line">            .createSession(params, installerPackageName, userId);</span><br><span class="line">    <span class="keyword">return</span> sessionId;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>这里和 install 很类似！</p>
<h3 id="3-2-2-doRemoveSplit"><a href="#3-2-2-doRemoveSplit" class="headerlink" title="3.2.2 doRemoveSplit"></a>3.2.2 doRemoveSplit</h3><p>移除 split apk，这里是真正的对 split apk 做处理，前面只是创建了一个主 apk 的 install 食物：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">int</span> <span class="title">doRemoveSplit</span><span class="params">(<span class="keyword">int</span> sessionId, String splitName, <span class="keyword">boolean</span> logSuccess)</span></span></span><br><span class="line"><span class="function">        <span class="keyword">throws</span> RemoteException </span>&#123;</span><br><span class="line">    <span class="keyword">final</span> PrintWriter pw = getOutPrintWriter();</span><br><span class="line">    PackageInstaller.Session session = <span class="keyword">null</span>;</span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">        <span class="comment">//【1-review】返回之前创建的 PackageInstallerSession，将其封装为 PackageInstaller.Session 实例！</span></span><br><span class="line">        <span class="comment">//【*7.1.1.2】获得事务；</span></span><br><span class="line">        session = <span class="keyword">new</span> PackageInstaller.Session(</span><br><span class="line">                mInterface.getPackageInstaller().openSession(sessionId));</span><br><span class="line">                </span><br><span class="line">        <span class="comment">//【*7.2.2】这个地方我们知道，最后调用了 PackageInstallerSession 的 removeSplit 方法!</span></span><br><span class="line">        session.removeSplit(splitName);</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (logSuccess) &#123;</span><br><span class="line">            pw.println(<span class="string">"Success"</span>);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">    &#125; <span class="keyword">catch</span> (IOException e) &#123;</span><br><span class="line">        pw.println(<span class="string">"Error: failed to remove split; "</span> + e.getMessage());</span><br><span class="line">        <span class="keyword">return</span> <span class="number">1</span>;</span><br><span class="line">    &#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">        IoUtils.closeQuietly(session);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>Session 其实很简单：<br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> <span class="class"><span class="keyword">class</span> <span class="title">Session</span> <span class="keyword">implements</span> <span class="title">Closeable</span> </span>&#123;</span><br><span class="line">    <span class="keyword">private</span> IPackageInstallerSession mSession;</span><br><span class="line">    ... ... ...</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>不多数了！</p>
<p>继续分析，我们看看 removeSplit 发生了什么：</p>
<h3 id="3-2-3-doCommitSession"><a href="#3-2-3-doCommitSession" class="headerlink" title="3.2.3 doCommitSession"></a>3.2.3 doCommitSession</h3><p>提交事务：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">int</span> <span class="title">doCommitSession</span><span class="params">(<span class="keyword">int</span> sessionId, <span class="keyword">boolean</span> logSuccess)</span> <span class="keyword">throws</span> RemoteException </span>&#123;</span><br><span class="line">    <span class="keyword">final</span> PrintWriter pw = getOutPrintWriter();</span><br><span class="line">    PackageInstaller.Session session = <span class="keyword">null</span>;</span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">        session = <span class="keyword">new</span> PackageInstaller.Session(</span><br><span class="line">                mInterface.getPackageInstaller().openSession(sessionId));</span><br><span class="line"></span><br><span class="line">        <span class="comment">//【*3.1.2.1】这里是注册可以了本地监听器 LocalIntentReceiver，监听卸载结果，在 install 我们</span></span><br><span class="line">        <span class="comment">// 有分析过，这里就不多说了！</span></span><br><span class="line">        <span class="keyword">final</span> LocalIntentReceiver receiver = <span class="keyword">new</span> LocalIntentReceiver();</span><br><span class="line">        </span><br><span class="line">        <span class="comment">//【*7.2.4】提交事务</span></span><br><span class="line">        session.commit(receiver.getIntentSender());</span><br><span class="line"></span><br><span class="line">        <span class="keyword">final</span> Intent result = receiver.getResult();</span><br><span class="line">        <span class="keyword">final</span> <span class="keyword">int</span> status = result.getIntExtra(PackageInstaller.EXTRA_STATUS,</span><br><span class="line">                PackageInstaller.STATUS_FAILURE);</span><br><span class="line">        <span class="keyword">if</span> (status == PackageInstaller.STATUS_SUCCESS) &#123;</span><br><span class="line">            <span class="keyword">if</span> (logSuccess) &#123;</span><br><span class="line">                pw.println(<span class="string">"Success"</span>);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            pw.println(<span class="string">"Failure ["</span></span><br><span class="line">                    + result.getStringExtra(PackageInstaller.EXTRA_STATUS_MESSAGE) + <span class="string">"]"</span>);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> status;</span><br><span class="line">    &#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">        IoUtils.closeQuietly(session);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h1 id="4-PackageInstallerService"><a href="#4-PackageInstallerService" class="headerlink" title="4 PackageInstallerService"></a>4 PackageInstallerService</h1><h2 id="4-1-uninstall"><a href="#4-1-uninstall" class="headerlink" title="4.1 uninstall"></a>4.1 uninstall</h2><p>这里我们说一下参数 IntentSender statusReceiver，其是前面 LocalIntentReceiver.getIntentSender() 返回的 IntentSender 实例：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">uninstall</span><span class="params">(String packageName, String callerPackageName, <span class="keyword">int</span> flags,</span></span></span><br><span class="line"><span class="function"><span class="params">            IntentSender statusReceiver, <span class="keyword">int</span> userId)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">final</span> <span class="keyword">int</span> callingUid = Binder.getCallingUid();</span><br><span class="line">    <span class="comment">//【1】会校验调用者是否具有 across user 的权限，同时也会调用 appOps 去检查 callingUid 和 callerPackageName</span></span><br><span class="line">    <span class="comment">// 是否匹配！</span></span><br><span class="line">    mPm.enforceCrossUserPermission(callingUid, userId, <span class="keyword">true</span>, <span class="keyword">true</span>, <span class="string">"uninstall"</span>);</span><br><span class="line">    <span class="keyword">if</span> ((callingUid != Process.SHELL_UID) &amp;&amp; (callingUid != Process.ROOT_UID)) &#123;</span><br><span class="line">        mAppOps.checkPackage(callingUid, callerPackageName);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//【2】检查 caller 是否是设备用户自身！</span></span><br><span class="line">    DevicePolicyManager dpm = (DevicePolicyManager) mContext.getSystemService(</span><br><span class="line">            Context.DEVICE_POLICY_SERVICE);</span><br><span class="line">    <span class="keyword">boolean</span> isDeviceOwner = (dpm != <span class="keyword">null</span>) &amp;&amp; dpm.isDeviceOwnerAppOnCallingUser(</span><br><span class="line">            callerPackageName);</span><br><span class="line">    </span><br><span class="line">    <span class="comment">//【*4.1.1.1】创建一个 PackageDeleteObserverAdapter 监听卸载删除结果！</span></span><br><span class="line">    <span class="keyword">final</span> PackageDeleteObserverAdapter adapter = <span class="keyword">new</span> PackageDeleteObserverAdapter(mContext,</span><br><span class="line">            statusReceiver, packageName, isDeviceOwner, userId);</span><br><span class="line">            </span><br><span class="line">    <span class="comment">//【3】检查调用者是否有 DELETE_PACKAGES 的权限，如果有直接通过 pms 直接 deletePackage！</span></span><br><span class="line">    <span class="keyword">if</span> (mContext.checkCallingOrSelfPermission(android.Manifest.permission.DELETE_PACKAGES)</span><br><span class="line">                == PackageManager.PERMISSION_GRANTED) &#123;</span><br><span class="line">        <span class="comment">//【*5.1】继续卸载；</span></span><br><span class="line">        mPm.deletePackage(packageName, adapter.getBinder(), userId, flags);</span><br><span class="line"></span><br><span class="line">    &#125; <span class="keyword">else</span> <span class="keyword">if</span> (isDeviceOwner) &#123;</span><br><span class="line">        <span class="comment">//【4】检查调用者是否是 DeviceOwner，如果有直接通过 pms 直接 deletePackage！</span></span><br><span class="line">        <span class="comment">// 这里会将调用者转为系统进程，继续处理！</span></span><br><span class="line">        <span class="keyword">long</span> ident = Binder.clearCallingIdentity();</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            <span class="comment">//【*5.1】继续卸载；</span></span><br><span class="line">            mPm.deletePackage(packageName, adapter.getBinder(), userId, flags);</span><br><span class="line">        &#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">            Binder.restoreCallingIdentity(ident);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        <span class="comment">//【5】这种情况需要通知用户，让用户主动卸载，会发送 Intent.ACTION_UNINSTALL_PACKAGE 给 PackageInstaller！</span></span><br><span class="line">        <span class="keyword">final</span> Intent intent = <span class="keyword">new</span> Intent(Intent.ACTION_UNINSTALL_PACKAGE);</span><br><span class="line">        intent.setData(Uri.fromParts(<span class="string">"package"</span>, packageName, <span class="keyword">null</span>));</span><br><span class="line">        intent.putExtra(PackageInstaller.EXTRA_CALLBACK, adapter.getBinder().asBinder());</span><br><span class="line"></span><br><span class="line">        <span class="comment">//【*4.1.1.2】通知用户！</span></span><br><span class="line">        adapter.onUserActionRequired(intent);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>代码很简单，不多说了！</p>
<h3 id="4-1-1-PackageDeleteObserverAdapter"><a href="#4-1-1-PackageDeleteObserverAdapter" class="headerlink" title="4.1.1 PackageDeleteObserverAdapter"></a>4.1.1 PackageDeleteObserverAdapter</h3><h4 id="4-1-1-1-new-PackageInstallerService"><a href="#4-1-1-1-new-PackageInstallerService" class="headerlink" title="4.1.1.1 new PackageInstallerService"></a>4.1.1.1 new PackageInstallerService</h4><p>创建了一个 package delete 监听器！</p>
<p>boolean showNotification 表示是否需要显示通知，上面传入的是 isDeviceOwner，就是说如果是设备拥有者，那么一定会显示通知！</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">static</span> <span class="class"><span class="keyword">class</span> <span class="title">PackageDeleteObserverAdapter</span> <span class="keyword">extends</span> <span class="title">PackageDeleteObserver</span> </span>&#123;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> Context mContext;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> IntentSender mTarget; <span class="comment">// 对应的 LocalIntentReceiver.getIntentSender(！</span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> String mPackageName; <span class="comment">// 要卸载的 apk</span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> Notification mNotification; <span class="comment">// 显示的通知！</span></span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="title">PackageDeleteObserverAdapter</span><span class="params">(Context context, IntentSender target,</span></span></span><br><span class="line"><span class="function"><span class="params">            String packageName, <span class="keyword">boolean</span> showNotification, <span class="keyword">int</span> userId)</span> </span>&#123;</span><br><span class="line">        mContext = context;</span><br><span class="line">        mTarget = target;</span><br><span class="line">        mPackageName = packageName;</span><br><span class="line">        <span class="keyword">if</span> (showNotification) &#123;</span><br><span class="line">            mNotification = buildSuccessNotification(mContext,</span><br><span class="line">                    mContext.getResources().getString(R.string.package_deleted_device_owner),</span><br><span class="line">                    packageName,</span><br><span class="line">                    userId);</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            mNotification = <span class="keyword">null</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    ... ... ...</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>不多说了！</p>
<h4 id="4-1-1-2-onUserActionRequired"><a href="#4-1-1-2-onUserActionRequired" class="headerlink" title="4.1.1.2 onUserActionRequired"></a>4.1.1.2 onUserActionRequired</h4><p>当没有权限直接卸载时，需要用户参与卸载时，会触发该方法，可以看到，该方法最后会发送 Intent.ACTION_UNINSTALL_PACKAGE 到 PackageInstaller 中去！</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onUserActionRequired</span><span class="params">(Intent intent)</span> </span>&#123;</span><br><span class="line">    <span class="comment">//【1】创建了一个新的 Intent fillIn；</span></span><br><span class="line">    <span class="keyword">final</span> Intent fillIn = <span class="keyword">new</span> Intent();</span><br><span class="line">    <span class="comment">//【2】卸载的 apk 包名；</span></span><br><span class="line">    fillIn.putExtra(PackageInstaller.EXTRA_PACKAGE_NAME, mPackageName);</span><br><span class="line">    <span class="comment">//【3】卸载的结果 code！！</span></span><br><span class="line">    fillIn.putExtra(PackageInstaller.EXTRA_STATUS,</span><br><span class="line">            PackageInstaller.STATUS_PENDING_USER_ACTION);</span><br><span class="line">    <span class="comment">//【4】卸载后用于额外通信的的 Intent！！</span></span><br><span class="line">    fillIn.putExtra(Intent.EXTRA_INTENT, intent);</span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">        <span class="comment">//【5】发送结果 fillIn 到 3.1.2.1！</span></span><br><span class="line">        mTarget.sendIntent(mContext, <span class="number">0</span>, fillIn, <span class="keyword">null</span>, <span class="keyword">null</span>);</span><br><span class="line">    &#125; <span class="keyword">catch</span> (SendIntentException ignored) &#123;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>对于传入的参数 intent：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// action 是 Intent.ACTION_UNINSTALL_PACKAGE！</span></span><br><span class="line"><span class="keyword">final</span> Intent intent = <span class="keyword">new</span> Intent(Intent.ACTION_UNINSTALL_PACKAGE);</span><br><span class="line"><span class="comment">// 设置 data；</span></span><br><span class="line">intent.setData(Uri.fromParts(<span class="string">"package"</span>, packageName, <span class="keyword">null</span>));</span><br><span class="line"><span class="comment">// 设置额外的回调；</span></span><br><span class="line">intent.putExtra(PackageInstaller.EXTRA_CALLBACK, adapter.getBinder().asBinder());</span><br></pre></td></tr></table></figure>
<p>接着，在 onUserActionRequired 有对参数 intent 进行了进一步的安装！</p>
<p>关于 PackageInstaller.STATUS_PENDING_USER_ACTION 的广播，我们后面再分析，这里先不关注！</p>
<h4 id="4-1-1-3-onPackageDeleted"><a href="#4-1-1-3-onPackageDeleted" class="headerlink" title="4.1.1.3 onPackageDeleted"></a>4.1.1.3 onPackageDeleted</h4><p>卸载成功后回调该接口：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onPackageDeleted</span><span class="params">(String basePackageName, <span class="keyword">int</span> returnCode, String msg)</span> </span>&#123;</span><br><span class="line">    <span class="comment">//【1】如果安装成功的话，会有通知！！</span></span><br><span class="line">    <span class="keyword">if</span> (PackageManager.DELETE_SUCCEEDED == returnCode &amp;&amp; mNotification != <span class="keyword">null</span>) &#123;</span><br><span class="line">        NotificationManager notificationManager = (NotificationManager)</span><br><span class="line">                mContext.getSystemService(Context.NOTIFICATION_SERVICE);</span><br><span class="line">        notificationManager.notify(basePackageName, <span class="number">0</span>, mNotification);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">//【2】创建封装结果的 intent！</span></span><br><span class="line">    <span class="keyword">final</span> Intent fillIn = <span class="keyword">new</span> Intent();</span><br><span class="line">    <span class="comment">//【3】卸载的 apk！</span></span><br><span class="line">    fillIn.putExtra(PackageInstaller.EXTRA_PACKAGE_NAME, mPackageName);</span><br><span class="line">    <span class="comment">//【4】卸载的结果 code！！</span></span><br><span class="line">    fillIn.putExtra(PackageInstaller.EXTRA_STATUS,</span><br><span class="line">            PackageManager.deleteStatusToPublicStatus(returnCode));</span><br><span class="line">    <span class="comment">//【5】卸载的额外信息！！</span></span><br><span class="line">    fillIn.putExtra(PackageInstaller.EXTRA_STATUS_MESSAGE,</span><br><span class="line">            PackageManager.deleteStatusToString(returnCode, msg));</span><br><span class="line">    <span class="comment">//【4】卸载的原始结果 code！！</span></span><br><span class="line">    fillIn.putExtra(PackageInstaller.EXTRA_LEGACY_STATUS, returnCode);</span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">        <span class="comment">//【5】发送结果 fillIn 到 3.1.2.1！</span></span><br><span class="line">        mTarget.sendIntent(mContext, <span class="number">0</span>, fillIn, <span class="keyword">null</span>, <span class="keyword">null</span>);</span><br><span class="line">    &#125; <span class="keyword">catch</span> (SendIntentException ignored) &#123;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>不多说了！！</p>
<h1 id="5-PackageManagerService"><a href="#5-PackageManagerService" class="headerlink" title="5 PackageManagerService"></a>5 PackageManagerService</h1><p>卸载的核心接口在 PackageManagerService 中：</p>
<h2 id="5-1-deletePackage"><a href="#5-1-deletePackage" class="headerlink" title="5.1 deletePackage"></a>5.1 deletePackage</h2><p>开始卸载删除应用：</p>
<p>我们知道，在前面的时候，如果是从所有用户下卸载，那么 userId 和 flags 会有如下的变化：</p>
<p>userId = UserHandle.USER_SYSTEM;<br>flags |= PackageManager.DELETE_ALL_USERS;</p>
<p>如果是从指定用户下卸载，那么 userId 就是我们指定的用户！</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">deletePackage</span><span class="params">(<span class="keyword">final</span> String packageName,</span></span></span><br><span class="line"><span class="function"><span class="params">        <span class="keyword">final</span> IPackageDeleteObserver2 observer, <span class="keyword">final</span> <span class="keyword">int</span> userId, <span class="keyword">final</span> <span class="keyword">int</span> deleteFlags)</span> </span>&#123;</span><br><span class="line">    mContext.enforceCallingOrSelfPermission(</span><br><span class="line">            android.Manifest.permission.DELETE_PACKAGES, <span class="keyword">null</span>);</span><br><span class="line">    Preconditions.checkNotNull(packageName);</span><br><span class="line">    Preconditions.checkNotNull(observer);</span><br><span class="line">    <span class="keyword">final</span> <span class="keyword">int</span> uid = Binder.getCallingUid();</span><br><span class="line">    <span class="comment">//【*5.1.1】首先判断该 apk 是否是孤立的；</span></span><br><span class="line">    <span class="comment">//【*5.1.2】同时判断是否允许静默卸载！</span></span><br><span class="line">    <span class="comment">// 如果这个 apk 不是孤立的，并且不允许静默卸载，那么需要用户参与卸载，也就是通过 PackageInstaller</span></span><br><span class="line">    <span class="comment">// 这里会结束流程，同时调用 observer.onUserActionRequired 返回结果！</span></span><br><span class="line">    <span class="keyword">if</span> (!isOrphaned(packageName)</span><br><span class="line">            &amp;&amp; !isCallerAllowedToSilentlyUninstall(uid, packageName)) &#123;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            <span class="keyword">final</span> Intent intent = <span class="keyword">new</span> Intent(Intent.ACTION_UNINSTALL_PACKAGE);</span><br><span class="line">            intent.setData(Uri.fromParts(PACKAGE_SCHEME, packageName, <span class="keyword">null</span>));</span><br><span class="line">            intent.putExtra(PackageInstaller.EXTRA_CALLBACK, observer.asBinder());</span><br><span class="line"></span><br><span class="line">            <span class="comment">//【*4.1.1.2】通知用户参与安装！</span></span><br><span class="line">            observer.onUserActionRequired(intent);</span><br><span class="line">        &#125; <span class="keyword">catch</span> (RemoteException re) &#123;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">//【2】判断是否是从所有 user 下卸载该应用，如果需要同时校验是否有 INTERACT_ACROSS_USERS_FULL 的权限！！</span></span><br><span class="line">    <span class="keyword">final</span> <span class="keyword">boolean</span> deleteAllUsers = (deleteFlags &amp; PackageManager.DELETE_ALL_USERS) != <span class="number">0</span>;</span><br><span class="line">    <span class="keyword">final</span> <span class="keyword">int</span>[] users = deleteAllUsers ? sUserManager.getUserIds() : <span class="keyword">new</span> <span class="keyword">int</span>[]&#123; userId &#125;;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (UserHandle.getUserId(uid) != userId || (deleteAllUsers &amp;&amp; users.length &gt; <span class="number">1</span>)) &#123;</span><br><span class="line">        mContext.enforceCallingOrSelfPermission(</span><br><span class="line">                android.Manifest.permission.INTERACT_ACROSS_USERS_FULL,</span><br><span class="line">                <span class="string">"deletePackage for user "</span> + userId);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">//【*5.1.3】如果该用户下不允许卸载应用（用户限制）</span></span><br><span class="line">    <span class="keyword">if</span> (isUserRestricted(userId, UserManager.DISALLOW_UNINSTALL_APPS)) &#123;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            <span class="comment">//【*4.1.1.3】结束卸载，返回！</span></span><br><span class="line">            observer.onPackageDeleted(packageName,</span><br><span class="line">                    PackageManager.DELETE_FAILED_USER_RESTRICTED, <span class="keyword">null</span>);</span><br><span class="line">        &#125; <span class="keyword">catch</span> (RemoteException re) &#123;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">//【3】如果不是从所有的用户下卸载，并且该 apk 处于 BlockUninstall 状态</span></span><br><span class="line">    <span class="comment">// 那么不能卸载！</span></span><br><span class="line">    <span class="comment">//【*5.1.4】通过 getBlockUninstallForUser 来判断应用是否处于 Blockinstall 状态！</span></span><br><span class="line">    <span class="keyword">if</span> (!deleteAllUsers &amp;&amp; getBlockUninstallForUser(packageName, userId)) &#123;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            <span class="comment">//【*4.1.1.3】结束卸载，返回！</span></span><br><span class="line">            observer.onPackageDeleted(packageName,</span><br><span class="line">                    PackageManager.DELETE_FAILED_OWNER_BLOCKED, <span class="keyword">null</span>);</span><br><span class="line">        &#125; <span class="keyword">catch</span> (RemoteException re) &#123;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (DEBUG_REMOVE) &#123;</span><br><span class="line">        Slog.d(TAG, <span class="string">"deletePackageAsUser: pkg="</span> + packageName + <span class="string">" user="</span> + userId</span><br><span class="line">                + <span class="string">" deleteAllUsers: "</span> + deleteAllUsers );</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//【4】这里的 mHandler 我们在 pms 的启动的时候有分析过，其持有子线程的 looper！</span></span><br><span class="line">    mHandler.post(<span class="keyword">new</span> Runnable() &#123;</span><br><span class="line">        <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">run</span><span class="params">()</span> </span>&#123;</span><br><span class="line">            mHandler.removeCallbacks(<span class="keyword">this</span>);</span><br><span class="line">            <span class="keyword">int</span> returnCode;</span><br><span class="line">            </span><br><span class="line">            <span class="comment">//【4.1】如果不是从所有的 user 下卸载该 apk，进入 if 分支，否则，进入 else 分支！</span></span><br><span class="line">            <span class="keyword">if</span> (!deleteAllUsers) &#123;</span><br><span class="line">                <span class="comment">//【*5.2】调用 deletePackageX 继续卸载！</span></span><br><span class="line">                returnCode = deletePackageX(packageName, userId, deleteFlags);</span><br><span class="line"></span><br><span class="line">            &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                <span class="comment">//【*5.1.4】先获得 pkg 在所有 user 下的 block unistall 状态！</span></span><br><span class="line">                <span class="keyword">int</span>[] blockUninstallUserIds = getBlockUninstallForUsers(packageName, users);</span><br><span class="line">                </span><br><span class="line">                <span class="comment">//【4.2】如果都不处于 block unistall，那么就直接卸载！</span></span><br><span class="line">                <span class="keyword">if</span> (ArrayUtils.isEmpty(blockUninstallUserIds)) &#123;</span><br><span class="line">                    <span class="comment">//【*5.2】调用 deletePackageX 继续卸载！</span></span><br><span class="line">                    returnCode = deletePackageX(packageName, userId, deleteFlags);</span><br><span class="line"></span><br><span class="line">                &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                    <span class="comment">//【4.3】flags 取消 DELETE_ALL_USERS 标志位！</span></span><br><span class="line">                    <span class="keyword">final</span> <span class="keyword">int</span> userFlags = deleteFlags &amp; ~PackageManager.DELETE_ALL_USERS;</span><br><span class="line">                    <span class="keyword">for</span> (<span class="keyword">int</span> userId : users) &#123;</span><br><span class="line">                        <span class="comment">//【4.3.1】只会卸载那些不处于 block unistall 状态下的 user 中的 apk！</span></span><br><span class="line">                        <span class="keyword">if</span> (!ArrayUtils.contains(blockUninstallUserIds, userId)) &#123;</span><br><span class="line">                            <span class="comment">//【*5.2】调用 deletePackageX 继续卸载！</span></span><br><span class="line">                            returnCode = deletePackageX(packageName, userId, userFlags);</span><br><span class="line">                            <span class="keyword">if</span> (returnCode != PackageManager.DELETE_SUCCEEDED) &#123;</span><br><span class="line">                                Slog.w(TAG, <span class="string">"Package delete failed for user "</span> + userId</span><br><span class="line">                                        + <span class="string">", returnCode "</span> + returnCode);</span><br><span class="line">                            &#125;</span><br><span class="line">                        &#125;</span><br><span class="line">                    &#125;</span><br><span class="line">                    <span class="comment">//【4.4】由于在某些 user 下 pkg 处于 block uninstall 状态导致无法安装</span></span><br><span class="line">                    <span class="comment">// 所以需要返回给用户！</span></span><br><span class="line">                    returnCode = PackageManager.DELETE_FAILED_OWNER_BLOCKED;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">try</span> &#123;</span><br><span class="line">                <span class="comment">//【*4.1.1.3】返回结果！</span></span><br><span class="line">                observer.onPackageDeleted(packageName, returnCode, <span class="keyword">null</span>);</span><br><span class="line">            &#125; <span class="keyword">catch</span> (RemoteException e) &#123;</span><br><span class="line">                Log.i(TAG, <span class="string">"Observer no longer exists."</span>);</span><br><span class="line">            &#125; <span class="comment">//end catch</span></span><br><span class="line">        &#125; <span class="comment">//end run</span></span><br><span class="line">    &#125;);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>过程分析的很详细！</p>
<h3 id="5-1-1-isOrphaned"><a href="#5-1-1-isOrphaned" class="headerlink" title="5.1.1 isOrphaned"></a>5.1.1 isOrphaned</h3><p>判断该应用是否是孤立的：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">boolean</span> <span class="title">isOrphaned</span><span class="params">(String packageName)</span> </span>&#123;</span><br><span class="line">    <span class="comment">// reader</span></span><br><span class="line">    <span class="keyword">synchronized</span> (mPackages) &#123;</span><br><span class="line">        <span class="comment">//【*5.1.1.1】进一步判断！</span></span><br><span class="line">        <span class="keyword">return</span> mSettings.isOrphaned(packageName);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h4 id="5-1-1-1-Settings-isOrphaned"><a href="#5-1-1-1-Settings-isOrphaned" class="headerlink" title="5.1.1.1 Settings.isOrphaned"></a>5.1.1.1 Settings.isOrphaned</h4><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">boolean</span> <span class="title">isOrphaned</span><span class="params">(String packageName)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">final</span> PackageSetting pkg = mPackages.get(packageName);</span><br><span class="line">    <span class="keyword">if</span> (pkg == <span class="keyword">null</span>) &#123;</span><br><span class="line">        <span class="keyword">throw</span> <span class="keyword">new</span> IllegalArgumentException(<span class="string">"Unknown package: "</span> + packageName);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">//【1】通过 PackageSetting 的 isOrphaned 属性判断！</span></span><br><span class="line">    <span class="keyword">return</span> pkg.isOrphaned;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>不多数了！！</p>
<h3 id="5-1-2-isCallerAllowedToSilentlyUninstall"><a href="#5-1-2-isCallerAllowedToSilentlyUninstall" class="headerlink" title="5.1.2 isCallerAllowedToSilentlyUninstall"></a>5.1.2 isCallerAllowedToSilentlyUninstall</h3><p>判断是否允许静默卸载：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">boolean</span> <span class="title">isCallerAllowedToSilentlyUninstall</span><span class="params">(<span class="keyword">int</span> callingUid, String pkgName)</span> </span>&#123;</span><br><span class="line">    <span class="comment">//【1】如果 callingUid 是 shell，root 或者 system，那么是可以静默卸载的！</span></span><br><span class="line">    <span class="keyword">if</span> (callingUid == Process.SHELL_UID || callingUid == Process.ROOT_UID</span><br><span class="line">          || callingUid == Process.SYSTEM_UID) &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">true</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">final</span> <span class="keyword">int</span> callingUserId = UserHandle.getUserId(callingUid);</span><br><span class="line"></span><br><span class="line">    <span class="comment">//【2】如果 caller 就是安装该 apk 的 installer，那么支持静默卸载！</span></span><br><span class="line">    <span class="comment">//【*5.1.2.1】通过 getPackageUid 获得 package uid；</span></span><br><span class="line">    <span class="comment">//【*5.1.2.2】通过 getInstallerPackageName 获得 package 的安装者；</span></span><br><span class="line">    <span class="keyword">if</span> (callingUid == getPackageUid(getInstallerPackageName(pkgName), <span class="number">0</span>, callingUserId)) &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">true</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//【3】如果 caller 是 package verifier，那么允许静默卸载！</span></span><br><span class="line">    <span class="keyword">if</span> (mRequiredVerifierPackage != <span class="keyword">null</span> &amp;&amp;</span><br><span class="line">            callingUid == getPackageUid(mRequiredVerifierPackage, <span class="number">0</span>, callingUserId)) &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">true</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//【4】如果 caller 是 package unstaller，那么允许静默卸载！</span></span><br><span class="line">    <span class="keyword">if</span> (mRequiredUninstallerPackage != <span class="keyword">null</span> &amp;&amp;</span><br><span class="line">            callingUid == getPackageUid(mRequiredUninstallerPackage, <span class="number">0</span>, callingUserId)) &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">true</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//【5】如果 caller 是 storage manager，那么允许静默卸载！</span></span><br><span class="line">    <span class="keyword">if</span> (mStorageManagerPackage != <span class="keyword">null</span> &amp;&amp;</span><br><span class="line">            callingUid == getPackageUid(mStorageManagerPackage, <span class="number">0</span>, callingUserId)) &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">true</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">false</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h4 id="5-1-2-1-getPackageUid"><a href="#5-1-2-1-getPackageUid" class="headerlink" title="5.1.2.1 getPackageUid"></a>5.1.2.1 getPackageUid</h4><p>获得 pacakge 的 uid：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">int</span> <span class="title">getPackageUid</span><span class="params">(String packageName, <span class="keyword">int</span> flags, <span class="keyword">int</span> userId)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">if</span> (!sUserManager.exists(userId)) <span class="keyword">return</span> -<span class="number">1</span>;</span><br><span class="line">    flags = updateFlagsForPackage(flags, userId, packageName);</span><br><span class="line">    enforceCrossUserPermission(Binder.getCallingUid(), userId,</span><br><span class="line">            <span class="keyword">false</span> <span class="comment">/* requireFullPermission */</span>, <span class="keyword">false</span> <span class="comment">/* checkShell */</span>, <span class="string">"get package uid"</span>);</span><br><span class="line"></span><br><span class="line">    <span class="comment">// reader</span></span><br><span class="line">    <span class="keyword">synchronized</span> (mPackages) &#123;</span><br><span class="line">        <span class="keyword">final</span> PackageParser.Package p = mPackages.get(packageName);</span><br><span class="line">        <span class="keyword">if</span> (p != <span class="keyword">null</span> &amp;&amp; p.isMatch(flags)) &#123;</span><br><span class="line">            <span class="keyword">return</span> UserHandle.getUid(userId, p.applicationInfo.uid);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">if</span> ((flags &amp; MATCH_UNINSTALLED_PACKAGES) != <span class="number">0</span>) &#123;</span><br><span class="line">            <span class="keyword">final</span> PackageSetting ps = mSettings.mPackages.get(packageName);</span><br><span class="line">            <span class="keyword">if</span> (ps != <span class="keyword">null</span> &amp;&amp; ps.isMatch(flags)) &#123;</span><br><span class="line">                <span class="keyword">return</span> UserHandle.getUid(userId, ps.appId);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> -<span class="number">1</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h4 id="5-1-2-2-getInstallerPackageName"><a href="#5-1-2-2-getInstallerPackageName" class="headerlink" title="5.1.2.2 getInstallerPackageName"></a>5.1.2.2 getInstallerPackageName</h4><p>获得 package 的安装者：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> String <span class="title">getInstallerPackageName</span><span class="params">(String packageName)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">synchronized</span> (mPackages) &#123;</span><br><span class="line">        <span class="comment">//【*5.1.2.2.1】通过 Settings 获得该 pkg 的 installer！</span></span><br><span class="line">        <span class="keyword">return</span> mSettings.getInstallerPackageNameLPr(packageName);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h5 id="5-1-2-2-1-Settings-getInstallerPackageNameLPr"><a href="#5-1-2-2-1-Settings-getInstallerPackageNameLPr" class="headerlink" title="5.1.2.2.1 Settings.getInstallerPackageNameLPr"></a>5.1.2.2.1 Settings.getInstallerPackageNameLPr</h5><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="function">String <span class="title">getInstallerPackageNameLPr</span><span class="params">(String packageName)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">final</span> PackageSetting pkg = mPackages.get(packageName);</span><br><span class="line">    <span class="keyword">if</span> (pkg == <span class="keyword">null</span>) &#123;</span><br><span class="line">        <span class="keyword">throw</span> <span class="keyword">new</span> IllegalArgumentException(<span class="string">"Unknown package: "</span> + packageName);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">//【1】返回 PackageSetting 的属性 installerPackageName</span></span><br><span class="line">    <span class="keyword">return</span> pkg.installerPackageName;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>不多说了！</p>
<h3 id="5-1-3-isUserRestricted"><a href="#5-1-3-isUserRestricted" class="headerlink" title="5.1.3 isUserRestricted"></a>5.1.3 isUserRestricted</h3><p>判断在 userId 是否有用户限制，限制由 restrictionKey 指定：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">boolean</span> <span class="title">isUserRestricted</span><span class="params">(<span class="keyword">int</span> userId, String restrictionKey)</span> </span>&#123;</span><br><span class="line">    Bundle restrictions = sUserManager.getUserRestrictions(userId);</span><br><span class="line">    <span class="keyword">if</span> (restrictions.getBoolean(restrictionKey, <span class="keyword">false</span>)) &#123;</span><br><span class="line">        Log.w(TAG, <span class="string">"User is restricted: "</span> + restrictionKey);</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">true</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">false</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h3 id="5-1-4-getBlockUninstallForUser"><a href="#5-1-4-getBlockUninstallForUser" class="headerlink" title="5.1.4 getBlockUninstallForUser"></a>5.1.4 getBlockUninstallForUser</h3><p>判断该 package 是否处于 block uninstall 的状态：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">boolean</span> <span class="title">getBlockUninstallForUser</span><span class="params">(String packageName, <span class="keyword">int</span> userId)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">synchronized</span> (mPackages) &#123;</span><br><span class="line">        PackageSetting ps = mSettings.mPackages.get(packageName);</span><br><span class="line">        <span class="keyword">if</span> (ps == <span class="keyword">null</span>) &#123;</span><br><span class="line">            Log.i(TAG, <span class="string">"Package doesn't exist in get block uninstall "</span> + packageName);</span><br><span class="line">            <span class="keyword">return</span> <span class="keyword">false</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">//【*5.1.4.1】通过 PackageSetting 返回其 block uninstall 的状态！</span></span><br><span class="line">        <span class="keyword">return</span> ps.getBlockUninstall(userId);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h4 id="5-1-4-1-PackageSettingBase-getBlockUninstall"><a href="#5-1-4-1-PackageSettingBase-getBlockUninstall" class="headerlink" title="5.1.4.1 PackageSettingBase.getBlockUninstall"></a>5.1.4.1 PackageSettingBase.getBlockUninstall</h4><p>PackageSetting 继承了 PackageSettingBase，getBlockUninstall 方法是在父类中：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">boolean</span> <span class="title">getBlockUninstall</span><span class="params">(<span class="keyword">int</span> userId)</span> </span>&#123;</span><br><span class="line">    <span class="comment">//【*5.1.4.2】返回该 pkg 的使用状态对象：PackageUserState！</span></span><br><span class="line">    <span class="keyword">return</span> readUserState(userId).blockUninstall;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>PackageUserState 实例，表示每个 pkg 在对应的 user 下的使用状态，其在我们分析 pms 的启动时有分析过，这里不多说了！</p>
<h4 id="5-1-4-2-PackageSettingBase-readUserState"><a href="#5-1-4-2-PackageSettingBase-readUserState" class="headerlink" title="5.1.4.2 PackageSettingBase.readUserState"></a>5.1.4.2 PackageSettingBase.readUserState</h4><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> PackageUserState <span class="title">readUserState</span><span class="params">(<span class="keyword">int</span> userId)</span> </span>&#123;</span><br><span class="line">    PackageUserState state = userState.get(userId);</span><br><span class="line">    <span class="keyword">if</span> (state != <span class="keyword">null</span>) &#123;</span><br><span class="line">        <span class="comment">//【1】如果有的话，就返回这个 user 下的 PackageUserState 实例！</span></span><br><span class="line">        <span class="keyword">return</span> state;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">//【2】否则，返回默认的！</span></span><br><span class="line">    <span class="keyword">return</span> DEFAULT_USER_STATE;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>这里的 DEFAULT_USER_STATE 是一个 PackageUserState 对象！！</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> PackageUserState DEFAULT_USER_STATE = <span class="keyword">new</span> PackageUserState();</span><br></pre></td></tr></table></figure>
<h3 id="5-1-5-getBlockUninstallForUsers"><a href="#5-1-5-getBlockUninstallForUsers" class="headerlink" title="5.1.5 getBlockUninstallForUsers"></a>5.1.5 getBlockUninstallForUsers</h3><p>该方法用于获得该 package 在多个 user 下的 block uninstall 状态：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">private</span> <span class="keyword">int</span>[] getBlockUninstallForUsers(String packageName, <span class="keyword">int</span>[] userIds) &#123;</span><br><span class="line">    <span class="keyword">int</span>[] result = EMPTY_INT_ARRAY;</span><br><span class="line">    <span class="keyword">for</span> (<span class="keyword">int</span> userId : userIds) &#123;</span><br><span class="line">        <span class="comment">//【*5.1.4】获得单个 user 下的 pkg 的 block uninstall 状态，并将状态为 true 的 user！</span></span><br><span class="line">        <span class="comment">// 保存到数组中，返回！</span></span><br><span class="line">        <span class="keyword">if</span> (getBlockUninstallForUser(packageName, userId)) &#123;</span><br><span class="line">            result = ArrayUtils.appendInt(result, userId);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> result;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>不多说了！！</p>
<h2 id="5-2-deletePackageX"><a href="#5-2-deletePackageX" class="headerlink" title="5.2 deletePackageX"></a>5.2 deletePackageX</h2><p>接着是进入第二阶段的卸载：</p>
<ul>
<li>如果可以卸载所有 user 下的安装，那么 deleteFlags 会被设置为 PackageManager.DELETE_ALL_USERS; 而 user 则是每一个用户；</li>
<li>如果是卸载指定的 user 下的安装，那么 deleteFlags 不会设置为 PackageManager.DELETE_ALL_USERS；</li>
</ul>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">int</span> <span class="title">deletePackageX</span><span class="params">(String packageName, <span class="keyword">int</span> userId, <span class="keyword">int</span> deleteFlags)</span> </span>&#123;</span><br><span class="line">    <span class="comment">//【*5.2.1.1】创建一个 PackageRemovedInfo 对象！</span></span><br><span class="line">    <span class="keyword">final</span> PackageRemovedInfo info = <span class="keyword">new</span> PackageRemovedInfo();</span><br><span class="line">    <span class="keyword">final</span> <span class="keyword">boolean</span> res;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">//【1】这里对 user 又做了一次处理。如果是卸载所有用户下的安装，那么 removeUser 为 UserHandle.USER_ALL！</span></span><br><span class="line">    <span class="keyword">final</span> <span class="keyword">int</span> removeUser = (deleteFlags &amp; PackageManager.DELETE_ALL_USERS) != <span class="number">0</span></span><br><span class="line">            ? UserHandle.USER_ALL : userId;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//【*5.2.2】如果要卸载的 pkg 是用于设备管理的，那么禁止卸载，返回！</span></span><br><span class="line">    <span class="keyword">if</span> (isPackageDeviceAdmin(packageName, removeUser)) &#123;</span><br><span class="line">        Slog.w(TAG, <span class="string">"Not removing package "</span> + packageName + <span class="string">": has active device admin"</span>);</span><br><span class="line">        <span class="keyword">return</span> PackageManager.DELETE_FAILED_DEVICE_POLICY_MANAGER;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    PackageSetting uninstalledPs = <span class="keyword">null</span>; <span class="comment">// 要卸载的 apk 的安装信息！</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">int</span>[] allUsers;</span><br><span class="line">    <span class="keyword">synchronized</span> (mPackages) &#123;</span><br><span class="line">        <span class="comment">//【2】获得上一次的安装信息，如果为 null，直接返回！！</span></span><br><span class="line">        uninstalledPs = mSettings.mPackages.get(packageName);</span><br><span class="line">        <span class="keyword">if</span> (uninstalledPs == <span class="keyword">null</span>) &#123;</span><br><span class="line">            Slog.w(TAG, <span class="string">"Not removing non-existent package "</span> + packageName);</span><br><span class="line">            <span class="keyword">return</span> PackageManager.DELETE_FAILED_INTERNAL_ERROR;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">//【3】获得所用的 user，并判断 pkg 是安装在哪些 user 下的，返回这些 user 的数组！</span></span><br><span class="line">        allUsers = sUserManager.getUserIds();</span><br><span class="line">        info.origUsers = uninstalledPs.queryInstalledUsers(allUsers, <span class="keyword">true</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">final</span> <span class="keyword">int</span> freezeUser; <span class="comment">// 用于保存卸载前，应用在那个 user 下处于冻结状态！</span></span><br><span class="line">    </span><br><span class="line">    <span class="comment">//【4】如果这是要卸载的应用是一个被覆盖安装更新过的 sys apk，同时 deleteFlags 没有设置 DELETE_SYSTEM_APP 位</span></span><br><span class="line">    <span class="comment">// 那么，我们在所有用户下冻结，否则我们只在 removeUser 下冻结！</span></span><br><span class="line">    <span class="comment">//【*5.2.3】isUpdatedSystemApp 判断是否是被覆盖安装更新过的 sys apk！</span></span><br><span class="line">    <span class="keyword">if</span> (isUpdatedSystemApp(uninstalledPs)</span><br><span class="line">            &amp;&amp; ((deleteFlags &amp; PackageManager.DELETE_SYSTEM_APP) == <span class="number">0</span>)) &#123;</span><br><span class="line">        freezeUser = UserHandle.USER_ALL;</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        freezeUser = removeUser;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">synchronized</span> (mInstallLock) &#123;</span><br><span class="line">        <span class="keyword">if</span> (DEBUG_REMOVE) Slog.d(TAG, <span class="string">"deletePackageX: pkg="</span> + packageName + <span class="string">" user="</span> + userId);</span><br><span class="line">        <span class="comment">//【*5.2.4】在卸载前进入冻结状态！</span></span><br><span class="line">        <span class="keyword">try</span> (PackageFreezer freezer = freezePackageForDelete(packageName, freezeUser,</span><br><span class="line">                deleteFlags, <span class="string">"deletePackageX"</span>)) &#123;</span><br><span class="line"></span><br><span class="line">            <span class="comment">//【*5.3】继续卸载；</span></span><br><span class="line">            res = deletePackageLIF(packageName, UserHandle.of(removeUser), <span class="keyword">true</span>, allUsers,</span><br><span class="line">                    deleteFlags | REMOVE_CHATTY, info, <span class="keyword">true</span>, <span class="keyword">null</span>);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">synchronized</span> (mPackages) &#123;</span><br><span class="line">            <span class="keyword">if</span> (res) &#123;</span><br><span class="line">                mEphemeralApplicationRegistry.onPackageUninstalledLPw(uninstalledPs.pkg);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">//【5】res 为 true，表示卸载成功了，那么发送相关的广播！</span></span><br><span class="line">    <span class="keyword">if</span> (res) &#123;</span><br><span class="line">        <span class="keyword">final</span> <span class="keyword">boolean</span> killApp = (deleteFlags &amp; PackageManager.DELETE_DONT_KILL_APP) == <span class="number">0</span>;</span><br><span class="line">        <span class="comment">//【*5.2.1.2】发送 removed 广播；</span></span><br><span class="line">        info.sendPackageRemovedBroadcasts(killApp);</span><br><span class="line">        <span class="comment">//【*5.2.1.3】发送 updated 广播；</span></span><br><span class="line">        info.sendSystemPackageUpdatedBroadcasts();</span><br><span class="line">        <span class="comment">//【*5.2.1.4】发送 appeared广播；</span></span><br><span class="line">        info.sendSystemPackageAppearedBroadcasts();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    Runtime.getRuntime().gc(); <span class="comment">// gc 回收资源！！</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">// Delete the resources here after sending the broadcast to let</span></span><br><span class="line">    <span class="comment">// other processes clean up before deleting resources.</span></span><br><span class="line">    <span class="keyword">if</span> (info.args != <span class="keyword">null</span>) &#123;</span><br><span class="line">        <span class="keyword">synchronized</span> (mInstallLock) &#123;</span><br><span class="line">            <span class="comment">//【*6.2.2.1.2】执行删除 apk 的操作！！</span></span><br><span class="line">            info.args.doPostDeleteLI(<span class="keyword">true</span>);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> res ? PackageManager.DELETE_SUCCEEDED : PackageManager.DELETE_FAILED_INTERNAL_ERROR;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>流程已经分析的很详细了！！</p>
<h3 id="5-2-1-PackageRemovedInfo"><a href="#5-2-1-PackageRemovedInfo" class="headerlink" title="5.2.1 PackageRemovedInfo"></a>5.2.1 PackageRemovedInfo</h3><h4 id="5-2-1-1-new-PackageRemovedInfo"><a href="#5-2-1-1-new-PackageRemovedInfo" class="headerlink" title="5.2.1.1 new PackageRemovedInfo"></a>5.2.1.1 new PackageRemovedInfo</h4><p>创建一个 PackageRemovedInfo 实例，分装要卸载的 apk 的相关信息！</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">PackageRemovedInfo</span> </span>&#123;</span><br><span class="line">    String removedPackage;</span><br><span class="line">    <span class="keyword">int</span> uid = -<span class="number">1</span>;</span><br><span class="line">    <span class="keyword">int</span> removedAppId = -<span class="number">1</span>;</span><br><span class="line">    <span class="keyword">int</span>[] origUsers;</span><br><span class="line">    <span class="keyword">int</span>[] removedUsers = <span class="keyword">null</span>;</span><br><span class="line">    <span class="keyword">boolean</span> isRemovedPackageSystemUpdate = <span class="keyword">false</span>;</span><br><span class="line">    <span class="keyword">boolean</span> isUpdate;</span><br><span class="line">    <span class="keyword">boolean</span> dataRemoved;</span><br><span class="line">    <span class="keyword">boolean</span> removedForAllUsers;</span><br><span class="line">    InstallArgs args = <span class="keyword">null</span>; <span class="comment">// 参数实例，用于执行卸载，清理的操作，后面会分析到！</span></span><br><span class="line">    ArrayMap&lt;String, PackageRemovedInfo&gt; removedChildPackages;</span><br><span class="line">    ArrayMap&lt;String, PackageInstalledInfo&gt; appearedChildPackages;</span><br><span class="line"></span><br><span class="line">    ... ... ...</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>同时，PackageRemovedInfo 内部也有很多的方法，用于发送广播，这里我们先分析当前流程能用的到的!!</p>
<h4 id="5-2-1-2-sendPackageRemovedBroadcasts"><a href="#5-2-1-2-sendPackageRemovedBroadcasts" class="headerlink" title="5.2.1.2 sendPackageRemovedBroadcasts"></a>5.2.1.2 sendPackageRemovedBroadcasts</h4><p>发送升级包被移除的广播：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">sendPackageRemovedBroadcasts</span><span class="params">(<span class="keyword">boolean</span> killApp)</span> </span>&#123;</span><br><span class="line">     <span class="comment">//【*5.2.1.2.1】发送 removed 的广播；</span></span><br><span class="line">     sendPackageRemovedBroadcastInternal(killApp);</span><br><span class="line">     <span class="keyword">final</span> <span class="keyword">int</span> childCount = removedChildPackages != <span class="keyword">null</span> ? removedChildPackages.size() : <span class="number">0</span>;</span><br><span class="line">     <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; childCount; i++) &#123;</span><br><span class="line">         PackageRemovedInfo childInfo = removedChildPackages.valueAt(i);</span><br><span class="line">         <span class="comment">//【*5.2.1.2.1】对 child pkg 一样的处理；</span></span><br><span class="line">         childInfo.sendPackageRemovedBroadcastInternal(killApp);</span><br><span class="line">     &#125;</span><br><span class="line"> &#125;</span><br></pre></td></tr></table></figure>
<p>逻辑简单，不多说了！</p>
<h5 id="5-2-1-2-1-sendPackageRemovedBroadcastInternal"><a href="#5-2-1-2-1-sendPackageRemovedBroadcastInternal" class="headerlink" title="5.2.1.2.1 sendPackageRemovedBroadcastInternal"></a>5.2.1.2.1 sendPackageRemovedBroadcastInternal</h5><p>发送 removed 的广播：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">sendPackageRemovedBroadcastInternal</span><span class="params">(<span class="keyword">boolean</span> killApp)</span> </span>&#123;</span><br><span class="line">    Bundle extras = <span class="keyword">new</span> Bundle(<span class="number">2</span>);</span><br><span class="line">    extras.putInt(Intent.EXTRA_UID, removedAppId &gt;= <span class="number">0</span>  ? removedAppId : uid);</span><br><span class="line">    extras.putBoolean(Intent.EXTRA_DATA_REMOVED, dataRemoved);</span><br><span class="line">    extras.putBoolean(Intent.EXTRA_DONT_KILL_APP, !killApp);</span><br><span class="line">    <span class="keyword">if</span> (isUpdate || isRemovedPackageSystemUpdate) &#123;</span><br><span class="line">        extras.putBoolean(Intent.EXTRA_REPLACING, <span class="keyword">true</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    extras.putBoolean(Intent.EXTRA_REMOVED_FOR_ALL_USERS, removedForAllUsers);</span><br><span class="line">    <span class="keyword">if</span> (removedPackage != <span class="keyword">null</span>) &#123;</span><br><span class="line">        <span class="comment">//【1】首先会发送 Intent.ACTION_PACKAGE_REMOVED 的广播；</span></span><br><span class="line">        sendPackageBroadcast(Intent.ACTION_PACKAGE_REMOVED , removedPackage,</span><br><span class="line">                extras, <span class="number">0</span>, <span class="keyword">null</span>, <span class="keyword">null</span>, removedUsers);</span><br><span class="line">        <span class="comment">//【2】然后会发送 Intent.ACTION_PACKAGE_FULLY_REMOVED 的广播；</span></span><br><span class="line">        <span class="comment">// 但前提的是清楚了 data，并且本次是卸载的三方应用；</span></span><br><span class="line">        <span class="keyword">if</span> (dataRemoved &amp;&amp; !isRemovedPackageSystemUpdate) &#123;</span><br><span class="line">            sendPackageBroadcast(Intent.ACTION_PACKAGE_FULLY_REMOVED,</span><br><span class="line">                    removedPackage, extras, <span class="number">0</span>, <span class="keyword">null</span>, <span class="keyword">null</span>, removedUsers);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span> (removedAppId &gt;= <span class="number">0</span>) &#123;</span><br><span class="line">        <span class="comment">//【3】最后，发送 Intent.ACTION_UID_REMOVED 广播！</span></span><br><span class="line">        sendPackageBroadcast(Intent.ACTION_UID_REMOVED, <span class="keyword">null</span>, extras, <span class="number">0</span>, <span class="keyword">null</span>, <span class="keyword">null</span>,</span><br><span class="line">                removedUsers);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>这里就不不多说了！</p>
<h4 id="5-2-1-3-sendSystemPackageUpdatedBroadcasts"><a href="#5-2-1-3-sendSystemPackageUpdatedBroadcasts" class="headerlink" title="5.2.1.3 sendSystemPackageUpdatedBroadcasts"></a>5.2.1.3 sendSystemPackageUpdatedBroadcasts</h4><p>发送 system app updated 广播：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">sendSystemPackageUpdatedBroadcasts</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    <span class="keyword">if</span> (isRemovedPackageSystemUpdate) &#123;</span><br><span class="line">        <span class="comment">//【*5.2.1.3.1】发送 system app updated 广播；</span></span><br><span class="line">        sendSystemPackageUpdatedBroadcastsInternal();</span><br><span class="line">        <span class="keyword">final</span> <span class="keyword">int</span> childCount = (removedChildPackages != <span class="keyword">null</span>)</span><br><span class="line">                ? removedChildPackages.size() : <span class="number">0</span>;</span><br><span class="line">        <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; childCount; i++) &#123;</span><br><span class="line">            PackageRemovedInfo childInfo = removedChildPackages.valueAt(i);</span><br><span class="line">            <span class="keyword">if</span> (childInfo.isRemovedPackageSystemUpdate) &#123;</span><br><span class="line">                <span class="comment">//【*5.2.1.3.1】对 child pkg 一样的处理；</span></span><br><span class="line">                childInfo.sendSystemPackageUpdatedBroadcastsInternal();</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>逻辑简单，不多说了！</p>
<h5 id="5-2-1-3-1-sendSystemPackageUpdatedBroadcastsInternal"><a href="#5-2-1-3-1-sendSystemPackageUpdatedBroadcastsInternal" class="headerlink" title="5.2.1.3.1 sendSystemPackageUpdatedBroadcastsInternal"></a>5.2.1.3.1 sendSystemPackageUpdatedBroadcastsInternal</h5><p>核心方法：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">sendSystemPackageUpdatedBroadcastsInternal</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    Bundle extras = <span class="keyword">new</span> Bundle(<span class="number">2</span>);</span><br><span class="line">    extras.putInt(Intent.EXTRA_UID, removedAppId &gt;= <span class="number">0</span> ? removedAppId : uid);</span><br><span class="line">    extras.putBoolean(Intent.EXTRA_REPLACING, <span class="keyword">true</span>);</span><br><span class="line">    <span class="comment">//【1】依次发送如下的三个广播；</span></span><br><span class="line">    sendPackageBroadcast(Intent.ACTION_PACKAGE_ADDED, removedPackage,</span><br><span class="line">            extras, <span class="number">0</span>, <span class="keyword">null</span>, <span class="keyword">null</span>, <span class="keyword">null</span>);</span><br><span class="line">    sendPackageBroadcast(Intent.ACTION_PACKAGE_REPLACED, removedPackage,</span><br><span class="line">            extras, <span class="number">0</span>, <span class="keyword">null</span>, <span class="keyword">null</span>, <span class="keyword">null</span>);</span><br><span class="line">    sendPackageBroadcast(Intent.ACTION_MY_PACKAGE_REPLACED, <span class="keyword">null</span>,</span><br><span class="line">            <span class="keyword">null</span>, <span class="number">0</span>, removedPackage, <span class="keyword">null</span>, <span class="keyword">null</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>不多说了！</p>
<h4 id="5-2-1-4-sendSystemPackageAppearedBroadcasts"><a href="#5-2-1-4-sendSystemPackageAppearedBroadcasts" class="headerlink" title="5.2.1.4 sendSystemPackageAppearedBroadcasts"></a>5.2.1.4 sendSystemPackageAppearedBroadcasts</h4><p>发送 system app appeared 广播，针对于 child apk：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">sendSystemPackageAppearedBroadcasts</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    <span class="keyword">final</span> <span class="keyword">int</span> packageCount = (appearedChildPackages != <span class="keyword">null</span>)</span><br><span class="line">            ? appearedChildPackages.size() : <span class="number">0</span>;</span><br><span class="line">    <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; packageCount; i++) &#123;</span><br><span class="line">        PackageInstalledInfo installedInfo = appearedChildPackages.valueAt(i);</span><br><span class="line">        <span class="keyword">for</span> (<span class="keyword">int</span> userId : installedInfo.newUsers) &#123;</span><br><span class="line">            <span class="comment">//【*5.2.1.4.1】发送 child apk appeared 的广播！</span></span><br><span class="line">            sendPackageAddedForUser(installedInfo.name, <span class="keyword">true</span>,</span><br><span class="line">                    UserHandle.getAppId(installedInfo.uid), userId);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h5 id="5-2-1-4-1-sendPackageAddedForUser-of-pms"><a href="#5-2-1-4-1-sendPackageAddedForUser-of-pms" class="headerlink" title="5.2.1.4.1 sendPackageAddedForUser(of pms)"></a>5.2.1.4.1 sendPackageAddedForUser(of pms)</h5><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">sendPackageAddedForUser</span><span class="params">(String packageName, PackageSetting pkgSetting,</span></span></span><br><span class="line"><span class="function"><span class="params">        <span class="keyword">int</span> userId)</span> </span>&#123;</span><br><span class="line">    <span class="comment">//【1】判断是否是 sys app！</span></span><br><span class="line">    <span class="keyword">final</span> <span class="keyword">boolean</span> isSystem = isSystemApp(pkgSetting) || isUpdatedSystemApp(pkgSetting);</span><br><span class="line">    <span class="comment">//【*5.2.1.4.2】继续发送：</span></span><br><span class="line">    sendPackageAddedForUser(packageName, isSystem, pkgSetting.appId, userId);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h5 id="5-2-1-4-2-sendPackageAddedForUser-of-pms"><a href="#5-2-1-4-2-sendPackageAddedForUser-of-pms" class="headerlink" title="5.2.1.4.2 sendPackageAddedForUser(of pms)"></a>5.2.1.4.2 sendPackageAddedForUser(of pms)</h5><p>核心方法，这里的 boolean isSystem 传入的是 true：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">sendPackageAddedForUser</span><span class="params">(String packageName, <span class="keyword">boolean</span> isSystem,</span></span></span><br><span class="line"><span class="function"><span class="params">        <span class="keyword">int</span> appId, <span class="keyword">int</span> userId)</span> </span>&#123;</span><br><span class="line">    Bundle extras = <span class="keyword">new</span> Bundle(<span class="number">1</span>);</span><br><span class="line">    extras.putInt(Intent.EXTRA_UID, UserHandle.getUid(userId, appId));</span><br><span class="line">    <span class="comment">//【1】发送 Intent.ACTION_PACKAGE_ADDED 广播！！</span></span><br><span class="line">    sendPackageBroadcast(Intent.ACTION_PACKAGE_ADDED,</span><br><span class="line">            packageName, extras, <span class="number">0</span>, <span class="keyword">null</span>, <span class="keyword">null</span>, <span class="keyword">new</span> <span class="keyword">int</span>[] &#123;userId&#125;);</span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">        IActivityManager am = ActivityManagerNative.getDefault();</span><br><span class="line">        <span class="keyword">if</span> (isSystem &amp;&amp; am.isUserRunning(userId, <span class="number">0</span>)) &#123;</span><br><span class="line">            <span class="comment">// The just-installed/enabled app is bundled on the system, so presumed</span></span><br><span class="line">            <span class="comment">// to be able to run automatically without needing an explicit launch.</span></span><br><span class="line">            <span class="comment">// Send it a BOOT_COMPLETED if it would ordinarily have gotten one.</span></span><br><span class="line">            Intent bcIntent = <span class="keyword">new</span> Intent(Intent.ACTION_BOOT_COMPLETED)</span><br><span class="line">                    .addFlags(Intent.FLAG_INCLUDE_STOPPED_PACKAGES)</span><br><span class="line">                    .setPackage(packageName);</span><br><span class="line">            am.broadcastIntent(<span class="keyword">null</span>, bcIntent, <span class="keyword">null</span>, <span class="keyword">null</span>, <span class="number">0</span>, <span class="keyword">null</span>, <span class="keyword">null</span>, <span class="keyword">null</span>,</span><br><span class="line">                    android.app.AppOpsManager.OP_NONE, <span class="keyword">null</span>, <span class="keyword">false</span>, <span class="keyword">false</span>, userId);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125; <span class="keyword">catch</span> (RemoteException e) &#123;</span><br><span class="line">        <span class="comment">// shouldn't happen</span></span><br><span class="line">        Slog.w(TAG, <span class="string">"Unable to bootstrap installed package"</span>, e);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h3 id="5-2-2-isPackageDeviceAdmin"><a href="#5-2-2-isPackageDeviceAdmin" class="headerlink" title="5.2.2 isPackageDeviceAdmin"></a>5.2.2 isPackageDeviceAdmin</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">boolean</span> <span class="title">isPackageDeviceAdmin</span><span class="params">(String packageName, <span class="keyword">int</span> userId)</span> </span>&#123;</span><br><span class="line">    IDevicePolicyManager dpm = IDevicePolicyManager.Stub.asInterface(</span><br><span class="line">            ServiceManager.getService(Context.DEVICE_POLICY_SERVICE));</span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">        <span class="keyword">if</span> (dpm != <span class="keyword">null</span>) &#123;</span><br><span class="line">            <span class="keyword">final</span> ComponentName deviceOwnerComponentName = dpm.getDeviceOwnerComponent(</span><br><span class="line">                    <span class="comment">/* callingUserOnly =*/</span> <span class="keyword">false</span>);</span><br><span class="line">            <span class="keyword">final</span> String deviceOwnerPackageName = deviceOwnerComponentName == <span class="keyword">null</span> ? <span class="keyword">null</span></span><br><span class="line">                    : deviceOwnerComponentName.getPackageName();</span><br><span class="line">            <span class="comment">// Does the package contains the device owner?</span></span><br><span class="line">            <span class="comment">// TODO Do we have to do it even if userId != UserHandle.USER_ALL?  Otherwise,</span></span><br><span class="line">            <span class="comment">// this check is probably not needed, since DO should be registered as a device</span></span><br><span class="line">            <span class="comment">// admin on some user too. (Original bug for this: b/17657954)</span></span><br><span class="line">            <span class="keyword">if</span> (packageName.equals(deviceOwnerPackageName)) &#123;</span><br><span class="line">                <span class="keyword">return</span> <span class="keyword">true</span>;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="comment">// Does it contain a device admin for any user?</span></span><br><span class="line">            <span class="keyword">int</span>[] users;</span><br><span class="line">            <span class="keyword">if</span> (userId == UserHandle.USER_ALL) &#123;</span><br><span class="line">                users = sUserManager.getUserIds();</span><br><span class="line">            &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                users = <span class="keyword">new</span> <span class="keyword">int</span>[]&#123;userId&#125;;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; users.length; ++i) &#123;</span><br><span class="line">                <span class="keyword">if</span> (dpm.packageHasActiveAdmins(packageName, users[i])) &#123;</span><br><span class="line">                    <span class="keyword">return</span> <span class="keyword">true</span>;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125; <span class="keyword">catch</span> (RemoteException e) &#123;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">false</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h3 id="5-2-3-isUpdatedSystemApp"><a href="#5-2-3-isUpdatedSystemApp" class="headerlink" title="5.2.3 isUpdatedSystemApp"></a>5.2.3 isUpdatedSystemApp</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">boolean</span> <span class="title">isUpdatedSystemApp</span><span class="params">(PackageSetting ps)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">return</span> (ps.pkgFlags &amp; ApplicationInfo.FLAG_UPDATED_SYSTEM_APP) != <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h3 id="5-2-4-freezePackageForInstall"><a href="#5-2-4-freezePackageForInstall" class="headerlink" title="5.2.4 freezePackageForInstall"></a>5.2.4 freezePackageForInstall</h3><p>进入冻结状态！<br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> PackageFreezer <span class="title">freezePackageForInstall</span><span class="params">(String packageName, <span class="keyword">int</span> userId, <span class="keyword">int</span> installFlags,</span></span></span><br><span class="line"><span class="function"><span class="params">        String killReason)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">if</span> ((installFlags &amp; PackageManager.INSTALL_DONT_KILL_APP) != <span class="number">0</span>) &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> PackageFreezer();</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        <span class="comment">//【*5.2.4.1】对于卸载的情况，是进入这里的！</span></span><br><span class="line">        <span class="keyword">return</span> freezePackage(packageName, userId, killReason);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<h4 id="5-2-4-1-freezePackage"><a href="#5-2-4-1-freezePackage" class="headerlink" title="5.2.4.1 freezePackage"></a>5.2.4.1 freezePackage</h4><p>看代码是创建了一个 PackageFreezer 实例：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> PackageFreezer <span class="title">freezePackage</span><span class="params">(String packageName, <span class="keyword">int</span> userId, String killReason)</span> </span>&#123;</span><br><span class="line">    <span class="comment">//【*5.2.4.2】创建一个 PackageFreezer 实例！</span></span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">new</span> PackageFreezer(packageName, userId, killReason);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h4 id="5-2-4-2-new-PackageFreezer"><a href="#5-2-4-2-new-PackageFreezer" class="headerlink" title="5.2.4.2 new PackageFreezer"></a>5.2.4.2 new PackageFreezer</h4><p>PackageFreezer 是一个冻结对象，在创建它的时候就会执行冻结操作！</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">private</span> <span class="class"><span class="keyword">class</span> <span class="title">PackageFreezer</span> <span class="keyword">implements</span> <span class="title">AutoCloseable</span> </span>&#123;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> String mPackageName; <span class="comment">// 要被冻结的 pkg</span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> PackageFreezer[] mChildren; <span class="comment">// 要被冻结的 child pkg</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> <span class="keyword">boolean</span> mWeFroze;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> AtomicBoolean mClosed = <span class="keyword">new</span> AtomicBoolean();</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> CloseGuard mCloseGuard = CloseGuard.get();</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="title">PackageFreezer</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        mPackageName = <span class="keyword">null</span>;</span><br><span class="line">        mChildren = <span class="keyword">null</span>;</span><br><span class="line">        mWeFroze = <span class="keyword">false</span>;</span><br><span class="line">        mCloseGuard.open(<span class="string">"close"</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="title">PackageFreezer</span><span class="params">(String packageName, <span class="keyword">int</span> userId, String killReason)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">synchronized</span> (mPackages) &#123;</span><br><span class="line">            mPackageName = packageName;</span><br><span class="line">            <span class="comment">//【1】将该 pkg 添加到 pms 的内部 mFrozenPackages 集合中！</span></span><br><span class="line">            mWeFroze = mFrozenPackages.add(mPackageName);</span><br><span class="line"></span><br><span class="line">            <span class="comment">//【2】返回 pkg 的安装信息，如果不会 null，那就 kill 掉该进程！</span></span><br><span class="line">            <span class="keyword">final</span> PackageSetting ps = mSettings.mPackages.get(mPackageName);</span><br><span class="line">            <span class="keyword">if</span> (ps != <span class="keyword">null</span>) &#123;</span><br><span class="line">                <span class="comment">//【2.1】kill app 进程，这里不过多关注！</span></span><br><span class="line">                killApplication(ps.name, ps.appId, userId, killReason);</span><br><span class="line">            &#125;</span><br><span class="line">            </span><br><span class="line">            <span class="comment">//【3】如果该 package 有 child package，做同样的处理！</span></span><br><span class="line">            <span class="keyword">final</span> PackageParser.Package p = mPackages.get(packageName);</span><br><span class="line">            <span class="keyword">if</span> (p != <span class="keyword">null</span> &amp;&amp; p.childPackages != <span class="keyword">null</span>) &#123;</span><br><span class="line">                <span class="keyword">final</span> <span class="keyword">int</span> N = p.childPackages.size();</span><br><span class="line">                mChildren = <span class="keyword">new</span> PackageFreezer[N];</span><br><span class="line">                <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; N; i++) &#123;</span><br><span class="line">                    mChildren[i] = <span class="keyword">new</span> PackageFreezer(p.childPackages.get(i).packageName,</span><br><span class="line">                            userId, killReason);</span><br><span class="line">                &#125;</span><br><span class="line">            &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                mChildren = <span class="keyword">null</span>;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        mCloseGuard.open(<span class="string">"close"</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    ... ... ...</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>在 pms 的内部，有一个集合：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@GuardedBy</span>(<span class="string">"mPackages"</span>)</span><br><span class="line"><span class="keyword">final</span> ArraySet&lt;String&gt; mFrozenPackages = <span class="keyword">new</span> ArraySet&lt;&gt;();</span><br></pre></td></tr></table></figure>
<p>用于保存所有的处于冻结状态的 package！</p>
<h2 id="5-3-deletePackageLIF"><a href="#5-3-deletePackageLIF" class="headerlink" title="5.3 deletePackageLIF"></a>5.3 deletePackageLIF</h2><p>接着进入卸载的第三个阶段，我们来回归下参数：</p>
<ul>
<li>boolean deleteCodeAndResources：表示是否删除 apk 和资源，这里传入的是 true；</li>
<li>int flags：卸载的 flags，传入 deleteFlags | REMOVE_CHATTY；</li>
<li>boolean writeSettings：是否持久化处理的数据，这里传入的是 true；</li>
<li>PackageParser.Package replacingPackage：用于取代的 pkg，这里传入的是 null；</li>
</ul>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">boolean</span> <span class="title">deletePackageLIF</span><span class="params">(String packageName, UserHandle user,</span></span></span><br><span class="line"><span class="function"><span class="params">        <span class="keyword">boolean</span> deleteCodeAndResources, <span class="keyword">int</span>[] allUserHandles, <span class="keyword">int</span> flags,</span></span></span><br><span class="line"><span class="function"><span class="params">        PackageRemovedInfo outInfo, <span class="keyword">boolean</span> writeSettings,</span></span></span><br><span class="line"><span class="function"><span class="params">        PackageParser.Package replacingPackage)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">if</span> (packageName == <span class="keyword">null</span>) &#123;</span><br><span class="line">        Slog.w(TAG, <span class="string">"Attempt to delete null packageName."</span>);</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">false</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (DEBUG_REMOVE) Slog.d(TAG, <span class="string">"deletePackageLI: "</span> + packageName + <span class="string">" user "</span> + user);</span><br><span class="line"></span><br><span class="line">    PackageSetting ps;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">synchronized</span> (mPackages) &#123;</span><br><span class="line">        <span class="comment">//【1】获得上一次的安装信息！</span></span><br><span class="line">        ps = mSettings.mPackages.get(packageName);</span><br><span class="line">        <span class="keyword">if</span> (ps == <span class="keyword">null</span>) &#123;</span><br><span class="line">            Slog.w(TAG, <span class="string">"Package named '"</span> + packageName + <span class="string">"' doesn't exist."</span>);</span><br><span class="line">            <span class="keyword">return</span> <span class="keyword">false</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">//【2】如果卸载的是 child package，并且</span></span><br><span class="line">        <span class="comment">// 其不是 sys app（无 FLAG_SYSTEM 标志位），或者是 sys app，且卸载 flags 设置了 DELETE_SYSTEM_APP 位！</span></span><br><span class="line">        <span class="comment">// 那么这里立刻执行卸载！</span></span><br><span class="line">        <span class="keyword">if</span> (ps.parentPackageName != <span class="keyword">null</span> &amp;&amp; (!isSystemApp(ps)</span><br><span class="line">                || (flags &amp; PackageManager.DELETE_SYSTEM_APP) != <span class="number">0</span>)) &#123;</span><br><span class="line">            <span class="keyword">if</span> (DEBUG_REMOVE) &#123;</span><br><span class="line">                Slog.d(TAG, <span class="string">"Uninstalled child package:"</span> + packageName + <span class="string">" for user:"</span></span><br><span class="line">                        + ((user == <span class="keyword">null</span>) ? UserHandle.USER_ALL : user));</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">final</span> <span class="keyword">int</span> removedUserId = (user != <span class="keyword">null</span>) ? user.getIdentifier()</span><br><span class="line">                    : UserHandle.USER_ALL;</span><br><span class="line">                    </span><br><span class="line">            <span class="comment">//【*5.3.1】清理该 pkg 在 removedUserId 下的数据！</span></span><br><span class="line">            <span class="keyword">if</span> (!clearPackageStateForUserLIF(ps, removedUserId, outInfo)) &#123;</span><br><span class="line">                <span class="keyword">return</span> <span class="keyword">false</span>;</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            <span class="comment">//【*5.3.2】设置该 pkg 的使用状态信息！</span></span><br><span class="line">            markPackageUninstalledForUserLPw(ps, user);</span><br><span class="line"></span><br><span class="line">            <span class="comment">// 更新应用的偏好设置，这里我们就先不分析，有时间了加进去！</span></span><br><span class="line">            scheduleWritePackageRestrictionsLocked(user);</span><br><span class="line">            <span class="keyword">return</span> <span class="keyword">true</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//【2】如果卸载的不是 sys app（无 FLAG_SYSTEM 标志位），或者卸载 flags 设置了 DELETE_SYSTEM_APP 位！</span></span><br><span class="line">    <span class="comment">// 同时，只是在某个用户下卸载该 apk，进入下面的逻辑</span></span><br><span class="line">    <span class="comment">// 可以看到：如果 apk 是 sys，那么还必须要设置 DELETE_SYSTEM_APP 标志位才行！</span></span><br><span class="line">    <span class="keyword">if</span> (((!isSystemApp(ps) || (flags&amp;PackageManager.DELETE_SYSTEM_APP) != <span class="number">0</span>) &amp;&amp; user != <span class="keyword">null</span></span><br><span class="line">            &amp;&amp; user.getIdentifier() != UserHandle.USER_ALL)) &#123;</span><br><span class="line"></span><br><span class="line">        <span class="comment">//【*5.3.2】设置该 pkg 的使用状态信息！</span></span><br><span class="line">        markPackageUninstalledForUserLPw(ps, user);</span><br><span class="line"></span><br><span class="line">        <span class="comment">//【2.1】如果是 data app，进入 if 分支，而 sys app 进入 else 分支！</span></span><br><span class="line">        <span class="keyword">if</span> (!isSystemApp(ps)) &#123;</span><br><span class="line">            <span class="comment">//【*5.3.3】判断下该应用是否需要被缓存下来！！</span></span><br><span class="line">            <span class="keyword">boolean</span> keepUninstalledPackage = shouldKeepUninstalledPackageLPr(packageName);</span><br><span class="line">            </span><br><span class="line">            <span class="comment">//【2.1.1】该 apk 在一些用户下处于 install 状态，或者该 pkg 需要被 keep！</span></span><br><span class="line">            <span class="keyword">if</span> (ps.isAnyInstalled(sUserManager.getUserIds()) || keepUninstalledPackage) &#123;</span><br><span class="line">                <span class="keyword">if</span> (DEBUG_REMOVE) Slog.d(TAG, <span class="string">"Still installed by other users"</span>);</span><br><span class="line">                </span><br><span class="line">                <span class="comment">//【*5.3.1】清理该 pkg 在 user 下的数据，清楚shibai！</span></span><br><span class="line">                <span class="keyword">if</span> (!clearPackageStateForUserLIF(ps, user.getIdentifier(), outInfo)) &#123;</span><br><span class="line">                    <span class="keyword">return</span> <span class="keyword">false</span>;</span><br><span class="line">                &#125;</span><br><span class="line">                </span><br><span class="line">                <span class="comment">// 更新应用的偏好设置，这里我们就先不分析，有时间了加进去！</span></span><br><span class="line">                scheduleWritePackageRestrictionsLocked(user);</span><br><span class="line">                <span class="keyword">return</span> <span class="keyword">true</span>;</span><br><span class="line">                </span><br><span class="line">            &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                <span class="keyword">if</span> (DEBUG_REMOVE) Slog.d(TAG, <span class="string">"Not installed by other users, full delete"</span>);</span><br><span class="line">                <span class="comment">//【2.1.1】该 apk 没有在任何 user 下安装，同时也不需要 keep，那么这里会将其在该 user 下的</span></span><br><span class="line">                <span class="comment">// 的安装状态设置为 true，这样卸载广播就能正确的发出了（感觉像是解决一个 bug）</span></span><br><span class="line">                ps.setInstalled(<span class="keyword">true</span>, user.getIdentifier());</span><br><span class="line">            &#125;</span><br><span class="line">            </span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            <span class="keyword">if</span> (DEBUG_REMOVE) Slog.d(TAG, <span class="string">"Deleting system app"</span>);</span><br><span class="line">            <span class="comment">//【2.2】对于 sys app，所有用户都会有该 app，所以这里我们会清楚在该 user 下的数据！</span></span><br><span class="line">            <span class="comment">//【*5.3.1】清理该 pkg 在 user 下的数据，清楚shibai！</span></span><br><span class="line">            <span class="keyword">if</span> (!clearPackageStateForUserLIF(ps, user.getIdentifier(), outInfo)) &#123;</span><br><span class="line">                <span class="keyword">return</span> <span class="keyword">false</span>;</span><br><span class="line">            &#125;</span><br><span class="line">            </span><br><span class="line">            <span class="comment">// 更新应用的偏好设置，这里我们就先不分析，有时间了加进去！</span></span><br><span class="line">            scheduleWritePackageRestrictionsLocked(user);</span><br><span class="line">            <span class="keyword">return</span> <span class="keyword">true</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//【3】如果要卸载的 apk 是一个复合 apk，有 split apk，那么这里会对其 child pkg 做同样的处理！！</span></span><br><span class="line">    <span class="keyword">if</span> (ps.childPackageNames != <span class="keyword">null</span> &amp;&amp; outInfo != <span class="keyword">null</span>) &#123;</span><br><span class="line">        <span class="keyword">synchronized</span> (mPackages) &#123;</span><br><span class="line">            <span class="keyword">final</span> <span class="keyword">int</span> childCount = ps.childPackageNames.size();</span><br><span class="line">            <span class="comment">//【*5.2.1】将每一个 child pkg 都封装成一个 PackageRemovedInfo 实例，并计算其 origUsers</span></span><br><span class="line">            <span class="comment">// 加到 parent pkg 的 outInfo.removedChildPackages 中！</span></span><br><span class="line">            outInfo.removedChildPackages = <span class="keyword">new</span> ArrayMap&lt;&gt;(childCount);</span><br><span class="line">            <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; childCount; i++) &#123;</span><br><span class="line">                String childPackageName = ps.childPackageNames.get(i);</span><br><span class="line">                PackageRemovedInfo childInfo = <span class="keyword">new</span> PackageRemovedInfo();</span><br><span class="line">                childInfo.removedPackage = childPackageName;</span><br><span class="line">                outInfo.removedChildPackages.put(childPackageName, childInfo);</span><br><span class="line">                PackageSetting childPs = mSettings.peekPackageLPr(childPackageName);</span><br><span class="line">                <span class="keyword">if</span> (childPs != <span class="keyword">null</span>) &#123;</span><br><span class="line">                    childInfo.origUsers = childPs.queryInstalledUsers(allUserHandles, <span class="keyword">true</span>);</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">boolean</span> ret = <span class="keyword">false</span>;</span><br><span class="line">    <span class="comment">//【4】进入核心的卸载阶段，这个阶段在返回后，会创建一个 InstallArgs 对象！！</span></span><br><span class="line">    <span class="keyword">if</span> (isSystemApp(ps)) &#123;</span><br><span class="line">        <span class="keyword">if</span> (DEBUG_REMOVE) Slog.d(TAG, <span class="string">"Removing system package: "</span> + ps.name);</span><br><span class="line">        <span class="comment">//【*6.1】卸载 sys app，如果 sys app 被覆盖安装过，那么会 fall back 回 sys app！</span></span><br><span class="line">        ret = deleteSystemPackageLIF(ps.pkg, ps, allUserHandles, flags, outInfo, writeSettings);</span><br><span class="line">        </span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        <span class="keyword">if</span> (DEBUG_REMOVE) Slog.d(TAG, <span class="string">"Removing non-system package: "</span> + ps.name);</span><br><span class="line">        <span class="comment">//【*6.1】卸载 data app!</span></span><br><span class="line">        ret = deleteInstalledPackageLIF(ps, deleteCodeAndResources, flags, allUserHandles,</span><br><span class="line">                outInfo, writeSettings, replacingPackage);</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//【5】这里是记录下我们是否是在所有用户下移除 pkg，对 child apk 也做同样的处理！</span></span><br><span class="line">    <span class="keyword">if</span> (outInfo != <span class="keyword">null</span>) &#123;</span><br><span class="line">        outInfo.removedForAllUsers = mPackages.get(ps.name) == <span class="keyword">null</span>;</span><br><span class="line">        <span class="keyword">if</span> (outInfo.removedChildPackages != <span class="keyword">null</span>) &#123;</span><br><span class="line">            <span class="keyword">synchronized</span> (mPackages) &#123;</span><br><span class="line">                <span class="keyword">final</span> <span class="keyword">int</span> childCount = outInfo.removedChildPackages.size();</span><br><span class="line">                <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; childCount; i++) &#123;</span><br><span class="line">                    PackageRemovedInfo childInfo = outInfo.removedChildPackages.valueAt(i);</span><br><span class="line">                    <span class="keyword">if</span> (childInfo != <span class="keyword">null</span>) &#123;</span><br><span class="line">                        childInfo.removedForAllUsers = mPackages.get(</span><br><span class="line">                                childInfo.removedPackage) == <span class="keyword">null</span>;</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment">//【5.1】这里对被覆盖安装过的 sys app 又做了特殊处理！！我们知道当我们删除了位于 data 的 app 数据后</span></span><br><span class="line">        <span class="comment">// 我们会恢复 sys app 的安装数据！这里主要是处理如下情况：</span></span><br><span class="line">        <span class="comment">// 如果 sys app 有 child pkg，但是可能有一些 child pkg 只申明在了 sys app 中，没有在 updated app 中</span></span><br><span class="line">        <span class="comment">// 此时我们会重新创建 child pkg 的 PackageInstalledInfo，保存到 outInfo 中！</span></span><br><span class="line">        <span class="keyword">if</span> (isSystemApp(ps)) &#123;</span><br><span class="line">            <span class="keyword">synchronized</span> (mPackages) &#123;</span><br><span class="line">                PackageSetting updatedPs = mSettings.peekPackageLPr(ps.name);</span><br><span class="line">                <span class="keyword">final</span> <span class="keyword">int</span> childCount = (updatedPs.childPackageNames != <span class="keyword">null</span>)</span><br><span class="line">                        ? updatedPs.childPackageNames.size() : <span class="number">0</span>;</span><br><span class="line">                <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; childCount; i++) &#123;</span><br><span class="line">                    String childPackageName = updatedPs.childPackageNames.get(i);</span><br><span class="line">                    <span class="comment">//【5.1.1】如果 outInfo 没有保存该 child pkg，进行以下逻辑：</span></span><br><span class="line">                    <span class="keyword">if</span> (outInfo.removedChildPackages == <span class="keyword">null</span></span><br><span class="line">                            || outInfo.removedChildPackages.indexOfKey(childPackageName) &lt; <span class="number">0</span>) &#123;</span><br><span class="line">                        PackageSetting childPs = mSettings.peekPackageLPr(childPackageName);</span><br><span class="line">                        <span class="keyword">if</span> (childPs == <span class="keyword">null</span>) &#123;</span><br><span class="line">                            <span class="keyword">continue</span>;</span><br><span class="line">                        &#125;</span><br><span class="line">                        <span class="comment">//【5.1.1】为该 child 创建一个 PackageInstalledInfo 实例，记录相关属性</span></span><br><span class="line">                        <span class="comment">// 保存到 outInfo.appearedChildPackages 集合中！</span></span><br><span class="line">                        PackageInstalledInfo installRes = <span class="keyword">new</span> PackageInstalledInfo();</span><br><span class="line">                        installRes.name = childPackageName;</span><br><span class="line">                        installRes.newUsers = childPs.queryInstalledUsers(allUserHandles, <span class="keyword">true</span>);</span><br><span class="line">                        installRes.pkg = mPackages.get(childPackageName);</span><br><span class="line">                        installRes.uid = childPs.pkg.applicationInfo.uid;</span><br><span class="line">                        <span class="keyword">if</span> (outInfo.appearedChildPackages == <span class="keyword">null</span>) &#123;</span><br><span class="line">                            outInfo.appearedChildPackages = <span class="keyword">new</span> ArrayMap&lt;&gt;();</span><br><span class="line">                        &#125;</span><br><span class="line">                        outInfo.appearedChildPackages.put(childPackageName, installRes);</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> ret;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>到这里，这一阶段就分析结束了！</p>
<h3 id="5-3-1-clearPackageStateForUserLIF"><a href="#5-3-1-clearPackageStateForUserLIF" class="headerlink" title="5.3.1 clearPackageStateForUserLIF"></a>5.3.1 clearPackageStateForUserLIF</h3><p>清理数据，可以看到这个方法里面执行的操作有很多：清楚数据等等：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">boolean</span> <span class="title">clearPackageStateForUserLIF</span><span class="params">(PackageSetting ps, <span class="keyword">int</span> userId,</span></span></span><br><span class="line"><span class="function"><span class="params">        PackageRemovedInfo outInfo)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">final</span> PackageParser.Package pkg;</span><br><span class="line">    <span class="keyword">synchronized</span> (mPackages) &#123;</span><br><span class="line">        pkg = mPackages.get(ps.name);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">//【1】如果是 UserHandle.USER_ALL，那么这里会返回当前的所有 user id！！</span></span><br><span class="line">    <span class="keyword">final</span> <span class="keyword">int</span>[] userIds = (userId == UserHandle.USER_ALL) ? sUserManager.getUserIds()</span><br><span class="line">            : <span class="keyword">new</span> <span class="keyword">int</span>[] &#123;userId&#125;;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//【2】遍历执行删除操作：</span></span><br><span class="line">    <span class="keyword">for</span> (<span class="keyword">int</span> nextUserId : userIds) &#123;</span><br><span class="line">        <span class="keyword">if</span> (DEBUG_REMOVE) &#123;</span><br><span class="line">            Slog.d(TAG, <span class="string">"Updating package:"</span> + ps.name + <span class="string">" install state for user:"</span></span><br><span class="line">                    + nextUserId);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        destroyAppDataLIF(pkg, userId,</span><br><span class="line">                StorageManager.FLAG_STORAGE_DE | StorageManager.FLAG_STORAGE_CE);</span><br><span class="line">        destroyAppProfilesLIF(pkg, userId);</span><br><span class="line">        removeKeystoreDataIfNeeded(nextUserId, ps.appId);</span><br><span class="line">        schedulePackageCleaning(ps.name, nextUserId, <span class="keyword">false</span>);</span><br><span class="line">        <span class="keyword">synchronized</span> (mPackages) &#123;</span><br><span class="line">            <span class="keyword">if</span> (clearPackagePreferredActivitiesLPw(ps.name, nextUserId)) &#123;</span><br><span class="line">                scheduleWritePackageRestrictionsLocked(nextUserId);</span><br><span class="line">            &#125;</span><br><span class="line">            resetUserChangesToRuntimePermissionsAndFlagsLPw(ps, nextUserId);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (outInfo != <span class="keyword">null</span>) &#123;</span><br><span class="line">        outInfo.removedPackage = ps.name;</span><br><span class="line">        outInfo.removedAppId = ps.appId;</span><br><span class="line">        outInfo.removedUsers = userIds;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">true</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h3 id="5-3-2-markPackageUninstalledForUserLPw"><a href="#5-3-2-markPackageUninstalledForUserLPw" class="headerlink" title="5.3.2 markPackageUninstalledForUserLPw"></a>5.3.2 markPackageUninstalledForUserLPw</h3><p>修改在该 user 下的使用状态为 no install 的状态：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">markPackageUninstalledForUserLPw</span><span class="params">(PackageSetting ps, UserHandle user)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">final</span> <span class="keyword">int</span>[] userIds = (user == <span class="keyword">null</span> || user.getIdentifier() == UserHandle.USER_ALL)</span><br><span class="line">            ? sUserManager.getUserIds() : <span class="keyword">new</span> <span class="keyword">int</span>[] &#123;user.getIdentifier()&#125;;</span><br><span class="line">    <span class="keyword">for</span> (<span class="keyword">int</span> nextUserId : userIds) &#123;</span><br><span class="line">        <span class="keyword">if</span> (DEBUG_REMOVE) &#123;</span><br><span class="line">            Slog.d(TAG, <span class="string">"Marking package:"</span> + ps.name + <span class="string">" uninstalled for user:"</span> + nextUserId);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">//【1】设置对应的 PackageUserState 中的状态！</span></span><br><span class="line">        ps.setUserState(nextUserId, <span class="number">0</span>, COMPONENT_ENABLED_STATE_DEFAULT,</span><br><span class="line">                <span class="keyword">false</span> <span class="comment">/*installed*/</span>, <span class="keyword">true</span> <span class="comment">/*stopped*/</span>, <span class="keyword">true</span> <span class="comment">/*notLaunched*/</span>,</span><br><span class="line">                <span class="keyword">false</span> <span class="comment">/*hidden*/</span>, <span class="keyword">false</span> <span class="comment">/*suspended*/</span>, <span class="keyword">null</span>, <span class="keyword">null</span>, <span class="keyword">null</span>,</span><br><span class="line">                <span class="keyword">false</span> <span class="comment">/*blockUninstall*/</span>,</span><br><span class="line">                ps.readUserState(nextUserId).domainVerificationStatus, <span class="number">0</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>方法很简单，就不多说了！</p>
<h3 id="5-3-3-shouldKeepUninstalledPackageLPr"><a href="#5-3-3-shouldKeepUninstalledPackageLPr" class="headerlink" title="5.3.3 shouldKeepUninstalledPackageLPr"></a>5.3.3 shouldKeepUninstalledPackageLPr</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">boolean</span> <span class="title">shouldKeepUninstalledPackageLPr</span><span class="params">(String packageName)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">return</span> mKeepUninstalledPackages != <span class="keyword">null</span> &amp;&amp; mKeepUninstalledPackages.contains(packageName);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h1 id="6-PackageManagerService"><a href="#6-PackageManagerService" class="headerlink" title="6 PackageManagerService"></a>6 PackageManagerService</h1><p>接下来，我们分别分析下 sys app 和 data app 的卸载过程：</p>
<h2 id="6-1-deleteSystemPackageLIF"><a href="#6-1-deleteSystemPackageLIF" class="headerlink" title="6.1 deleteSystemPackageLIF"></a>6.1 deleteSystemPackageLIF</h2><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">boolean</span> <span class="title">deleteSystemPackageLIF</span><span class="params">(PackageParser.Package deletedPkg,</span></span></span><br><span class="line"><span class="function"><span class="params">        PackageSetting deletedPs, <span class="keyword">int</span>[] allUserHandles, <span class="keyword">int</span> flags, PackageRemovedInfo outInfo,</span></span></span><br><span class="line"><span class="function"><span class="params">        <span class="keyword">boolean</span> writeSettings)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">if</span> (deletedPs.parentPackageName != <span class="keyword">null</span>) &#123;</span><br><span class="line">        Slog.w(TAG, <span class="string">"Attempt to delete child system package "</span> + deletedPkg.packageName);</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">false</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">//【1】判断是否考虑用户限制！</span></span><br><span class="line">    <span class="keyword">final</span> <span class="keyword">boolean</span> applyUserRestrictions</span><br><span class="line">            = (allUserHandles != <span class="keyword">null</span>) &amp;&amp; (outInfo.origUsers != <span class="keyword">null</span>);</span><br><span class="line">    <span class="keyword">final</span> PackageSetting disabledPs;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//【2】判断该应用是否是一个被覆盖安装更新过的 sys app!!</span></span><br><span class="line">    <span class="keyword">synchronized</span> (mPackages) &#123;</span><br><span class="line">        disabledPs = mSettings.getDisabledSystemPkgLPr(deletedPs.name);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (DEBUG_REMOVE) Slog.d(TAG, <span class="string">"deleteSystemPackageLI: newPs="</span> + deletedPkg.packageName</span><br><span class="line">            + <span class="string">" disabledPs="</span> + disabledPs);</span><br><span class="line">    </span><br><span class="line">    <span class="comment">//【3】只有覆盖安装过的 sys app 才能被卸载，实际上卸载的是处于 data 的那个 apk！</span></span><br><span class="line">    <span class="keyword">if</span> (disabledPs == <span class="keyword">null</span>) &#123;</span><br><span class="line">        Slog.w(TAG, <span class="string">"Attempt to delete unknown system package "</span>+ deletedPkg.packageName);</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">false</span>;</span><br><span class="line">    &#125; <span class="keyword">else</span> <span class="keyword">if</span> (DEBUG_REMOVE) &#123;</span><br><span class="line">        Slog.d(TAG, <span class="string">"Deleting system pkg from data partition"</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (DEBUG_REMOVE) &#123;</span><br><span class="line">        <span class="keyword">if</span> (applyUserRestrictions) &#123;</span><br><span class="line">            Slog.d(TAG, <span class="string">"Remembering install states:"</span>);</span><br><span class="line">            <span class="keyword">for</span> (<span class="keyword">int</span> userId : allUserHandles) &#123;</span><br><span class="line">                <span class="keyword">final</span> <span class="keyword">boolean</span> finstalled = ArrayUtils.contains(outInfo.origUsers, userId);</span><br><span class="line">                Slog.d(TAG, <span class="string">"   u="</span> + userId + <span class="string">" inst="</span> + finstalled);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//【4】设置 pkg 对应的 outInfo 的 isRemovedPackageSystemUpdate 为 true，表示移除的是更新！</span></span><br><span class="line">    <span class="comment">// 如果 pkg 有 child pkg，也要设置其对应的属性！</span></span><br><span class="line">    outInfo.isRemovedPackageSystemUpdate = <span class="keyword">true</span>;</span><br><span class="line">    <span class="keyword">if</span> (outInfo.removedChildPackages != <span class="keyword">null</span>) &#123;</span><br><span class="line">        <span class="keyword">final</span> <span class="keyword">int</span> childCount = (deletedPs.childPackageNames != <span class="keyword">null</span>)</span><br><span class="line">                ? deletedPs.childPackageNames.size() : <span class="number">0</span>;</span><br><span class="line">        <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; childCount; i++) &#123;</span><br><span class="line">            String childPackageName = deletedPs.childPackageNames.get(i);</span><br><span class="line">            <span class="keyword">if</span> (disabledPs.childPackageNames != <span class="keyword">null</span> &amp;&amp; disabledPs.childPackageNames</span><br><span class="line">                    .contains(childPackageName)) &#123;</span><br><span class="line">                PackageRemovedInfo childInfo = outInfo.removedChildPackages.get(</span><br><span class="line">                        childPackageName);</span><br><span class="line">                <span class="keyword">if</span> (childInfo != <span class="keyword">null</span>) &#123;</span><br><span class="line">                    childInfo.isRemovedPackageSystemUpdate = <span class="keyword">true</span>;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//【5】判断下覆盖安装前后的 versioncode，如果覆盖前的小，那么本次卸载后，数据也会被清除；</span></span><br><span class="line">    <span class="comment">// 如果相等，那么就保留数据！</span></span><br><span class="line">    <span class="keyword">if</span> (disabledPs.versionCode &lt; deletedPs.versionCode) &#123;</span><br><span class="line">        flags &amp;= ~PackageManager.DELETE_KEEP_DATA;</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        flags |= PackageManager.DELETE_KEEP_DATA;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//【*6.2】继续处理卸载，可以看到，此时和卸载 data app 的一样的了！</span></span><br><span class="line">    <span class="keyword">boolean</span> ret = deleteInstalledPackageLIF(deletedPs, <span class="keyword">true</span>, flags, allUserHandles,</span><br><span class="line">            outInfo, writeSettings, disabledPs.pkg);</span><br><span class="line">    <span class="keyword">if</span> (!ret) &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">false</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//【6】接着，需要恢复 sys app！</span></span><br><span class="line">    <span class="keyword">synchronized</span> (mPackages) &#123;</span><br><span class="line">        <span class="comment">// Reinstate the old system package</span></span><br><span class="line">        <span class="comment">//【*6.1.1】恢复 sys app 的安装数据！</span></span><br><span class="line">        enableSystemPackageLPw(disabledPs.pkg);</span><br><span class="line">        <span class="comment">//【*6.1.2】移除所有的本地库！</span></span><br><span class="line">        removeNativeBinariesLI(deletedPs);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//【7】准备重新扫描 sys app，首先会设置基本的扫描参数！</span></span><br><span class="line">    <span class="comment">// 如果是 pri app，还要设置 PARSE_IS_PRIVILEGED 标志位！</span></span><br><span class="line">    <span class="keyword">if</span> (DEBUG_REMOVE) Slog.d(TAG, <span class="string">"Re-installing system package: "</span> + disabledPs);</span><br><span class="line">    <span class="keyword">int</span> parseFlags = mDefParseFlags</span><br><span class="line">            | PackageParser.PARSE_MUST_BE_APK</span><br><span class="line">            | PackageParser.PARSE_IS_SYSTEM</span><br><span class="line">            | PackageParser.PARSE_IS_SYSTEM_DIR;</span><br><span class="line">    <span class="comment">//【*6.1.3】判断是否是 pri app！</span></span><br><span class="line">    <span class="keyword">if</span> (locationIsPrivileged(disabledPs.codePath)) &#123;</span><br><span class="line">        parseFlags |= PackageParser.PARSE_IS_PRIVILEGED;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">final</span> PackageParser.Package newPkg;</span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">        <span class="comment">//【8】重新扫描 sys app，这里我们在开机扫描的时候有分析过，不多说了！！</span></span><br><span class="line">        newPkg = scanPackageTracedLI(disabledPs.codePath, parseFlags, SCAN_NO_PATHS, <span class="number">0</span>, <span class="keyword">null</span>);</span><br><span class="line">    &#125; <span class="keyword">catch</span> (PackageManagerException e) &#123;</span><br><span class="line">        Slog.w(TAG, <span class="string">"Failed to restore system package:"</span> + deletedPkg.packageName + <span class="string">": "</span></span><br><span class="line">                + e.getMessage());</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">false</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">        <span class="comment">//【*6.1.4】更新共享库！</span></span><br><span class="line">        updateSharedLibrariesLPw(newPkg, <span class="keyword">null</span>);</span><br><span class="line">    &#125; <span class="keyword">catch</span> (PackageManagerException e) &#123;</span><br><span class="line">        Slog.e(TAG, <span class="string">"updateAllSharedLibrariesLPw failed: "</span> + e.getMessage());</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">//【*6.1.5】准备应用的数据目录！</span></span><br><span class="line">    prepareAppDataAfterInstallLIF(newPkg);</span><br><span class="line"></span><br><span class="line">    <span class="comment">//【9】最后就是要想最新的信息持久化到本地文件：包括安装信息，偏好设置，权限等等！</span></span><br><span class="line">    <span class="keyword">synchronized</span> (mPackages) &#123;</span><br><span class="line">        <span class="comment">//【9.1】读取最新的安装信息！</span></span><br><span class="line">        PackageSetting ps = mSettings.mPackages.get(newPkg.packageName);</span><br><span class="line"></span><br><span class="line">        <span class="comment">//【9.2】将卸载前的权限授予信息拷贝到本次新安装的信息中！！</span></span><br><span class="line">        ps.getPermissionsState().copyFrom(deletedPs.getPermissionsState());</span><br><span class="line">        </span><br><span class="line">        <span class="comment">//【9.3-review】更新权限信息，这里我们在 pms 的启动时分析过，这里就不再细说了！</span></span><br><span class="line">        <span class="comment">// 这里会更新所有应用的权限信息，移除过时的运行时权限，自动授予安装时权限等！</span></span><br><span class="line">        updatePermissionsLPw(newPkg.packageName, newPkg,</span><br><span class="line">                UPDATE_PERMISSIONS_ALL | UPDATE_PERMISSIONS_REPLACE_PKG);</span><br><span class="line">        </span><br><span class="line">        <span class="comment">//【9.4】如果需要应用用户限制，会进入这个分支！</span></span><br><span class="line">        <span class="keyword">if</span> (applyUserRestrictions) &#123;</span><br><span class="line">            <span class="keyword">if</span> (DEBUG_REMOVE) &#123;</span><br><span class="line">                Slog.d(TAG, <span class="string">"Propagating install state across reinstall"</span>);</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">for</span> (<span class="keyword">int</span> userId : allUserHandles) &#123;</span><br><span class="line">                <span class="keyword">final</span> <span class="keyword">boolean</span> installed = ArrayUtils.contains(outInfo.origUsers, userId);</span><br><span class="line">                <span class="keyword">if</span> (DEBUG_REMOVE) &#123;</span><br><span class="line">                    Slog.d(TAG, <span class="string">"    user "</span> + userId + <span class="string">" =&gt; "</span> + installed);</span><br><span class="line">                &#125;</span><br><span class="line">                <span class="comment">//【9.4.1】重新设置在每个用户下的 install 状态！</span></span><br><span class="line">                ps.setInstalled(installed, userId);</span><br><span class="line">                </span><br><span class="line">                <span class="comment">//【9.4.2】持久化所有用户下的运行时权限信息！</span></span><br><span class="line">                mSettings.writeRuntimePermissionsForUserLPr(userId, <span class="keyword">false</span>);</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="comment">//【9.4.3】持久化所有用户下的应用偏好设置！</span></span><br><span class="line">            mSettings.writeAllUsersPackageRestrictionsLPr();</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">//【9.5】持久化 Settings 中的数据，包括 packages.xml，packages.list 等等！</span></span><br><span class="line">        <span class="keyword">if</span> (writeSettings) &#123;</span><br><span class="line">            mSettings.writeLPr();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">true</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>整个逻辑很详细了，不多说了！！</p>
<h3 id="6-1-1-enableSystemPackageLPw"><a href="#6-1-1-enableSystemPackageLPw" class="headerlink" title="6.1.1 enableSystemPackageLPw"></a>6.1.1 enableSystemPackageLPw</h3><p>恢复 sys app 的安装信息！</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">enableSystemPackageLPw</span><span class="params">(PackageParser.Package pkg)</span> </span>&#123;</span><br><span class="line">    <span class="comment">//【*6.1.1.1】恢复 pkg 的安装信息！</span></span><br><span class="line">    mSettings.enableSystemPackageLPw(pkg.packageName);</span><br><span class="line">    <span class="comment">//【*6.1.1.1】恢复 pkg 的 child pkg 的安装信息！</span></span><br><span class="line">    <span class="keyword">final</span> <span class="keyword">int</span> childCount = (pkg.childPackages != <span class="keyword">null</span>) ? pkg.childPackages.size() : <span class="number">0</span>;</span><br><span class="line">    <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; childCount; i++) &#123;</span><br><span class="line">        PackageParser.Package childPkg = pkg.childPackages.get(i);</span><br><span class="line">        mSettings.enableSystemPackageLPw(childPkg.packageName);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>不多说了！</p>
<h4 id="6-1-1-1-Settings-enableSystemPackageLPw"><a href="#6-1-1-1-Settings-enableSystemPackageLPw" class="headerlink" title="6.1.1.1 Settings.enableSystemPackageLPw"></a>6.1.1.1 Settings.enableSystemPackageLPw</h4><p>核心方法是在 Settings 中：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="function">PackageSetting <span class="title">enableSystemPackageLPw</span><span class="params">(String name)</span> </span>&#123;</span><br><span class="line">    <span class="comment">//【1】判断下是否被覆盖安装过！</span></span><br><span class="line">    PackageSetting p = mDisabledSysPackages.get(name);</span><br><span class="line">    <span class="keyword">if</span>(p == <span class="keyword">null</span>) &#123;</span><br><span class="line">        Log.w(PackageManagerService.TAG, <span class="string">"Package "</span> + name + <span class="string">" is not disabled"</span>);</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">null</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">//【2】取消掉 FLAG_UPDATED_SYSTEM_APP 标志位！</span></span><br><span class="line">    <span class="keyword">if</span>((p.pkg != <span class="keyword">null</span>) &amp;&amp; (p.pkg.applicationInfo != <span class="keyword">null</span>)) &#123;</span><br><span class="line">        p.pkg.applicationInfo.flags &amp;= ~ApplicationInfo.FLAG_UPDATED_SYSTEM_APP;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">//【3-review】创建一个新的 PackageSetting 实例，同时将其添加到 Settings 内部的集合中！</span></span><br><span class="line">    <span class="comment">// 这个我们在 pms 开机中分析过！</span></span><br><span class="line">    PackageSetting ret = addPackageLPw(name, p.realName, p.codePath, p.resourcePath,</span><br><span class="line">            p.legacyNativeLibraryPathString, p.primaryCpuAbiString,</span><br><span class="line">            p.secondaryCpuAbiString, p.cpuAbiOverrideString,</span><br><span class="line">            p.appId, p.versionCode, p.pkgFlags, p.pkgPrivateFlags,</span><br><span class="line">            p.parentPackageName, p.childPackageNames);</span><br><span class="line"></span><br><span class="line">    <span class="comment">//【4】从 mDisabledSysPackages 删除信息！</span></span><br><span class="line">    mDisabledSysPackages.remove(name);</span><br><span class="line">    <span class="keyword">return</span> ret;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>继续分析！</p>
<h3 id="6-1-2-removeNativeBinariesLI"><a href="#6-1-2-removeNativeBinariesLI" class="headerlink" title="6.1.2 removeNativeBinariesLI"></a>6.1.2 removeNativeBinariesLI</h3><p>移除本地库：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">removeNativeBinariesLI</span><span class="params">(PackageSetting ps)</span> </span>&#123;</span><br><span class="line">    <span class="comment">//【1】移除 pkg 的本地库！</span></span><br><span class="line">    <span class="keyword">if</span> (ps != <span class="keyword">null</span>) &#123;</span><br><span class="line">        NativeLibraryHelper.removeNativeBinariesLI(ps.legacyNativeLibraryPathString);</span><br><span class="line">        <span class="comment">//【1.1】移除 pkg 的 child pkg 的本地库！</span></span><br><span class="line">        <span class="keyword">final</span> <span class="keyword">int</span> childCount = (ps.childPackageNames != <span class="keyword">null</span>) ? ps.childPackageNames.size() : <span class="number">0</span>;</span><br><span class="line">        <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; childCount; i++) &#123;</span><br><span class="line">            PackageSetting childPs = <span class="keyword">null</span>;</span><br><span class="line">            <span class="keyword">synchronized</span> (mPackages) &#123;</span><br><span class="line">                childPs = mSettings.peekPackageLPr(ps.childPackageNames.get(i));</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">if</span> (childPs != <span class="keyword">null</span>) &#123;</span><br><span class="line">                NativeLibraryHelper.removeNativeBinariesLI(childPs</span><br><span class="line">                        .legacyNativeLibraryPathString);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>核心是通过 NativeLibraryHelper 的相关接口来移除的，这里就不过多分析了！</p>
<h3 id="6-1-3-locationIsPrivileged"><a href="#6-1-3-locationIsPrivileged" class="headerlink" title="6.1.3 locationIsPrivileged"></a>6.1.3 locationIsPrivileged</h3><p>判断是否是 pri app：<br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">static</span> <span class="keyword">boolean</span> <span class="title">locationIsPrivileged</span><span class="params">(File path)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">        <span class="keyword">final</span> String privilegedAppDir = <span class="keyword">new</span> File(Environment.getRootDirectory(), <span class="string">"priv-app"</span>)</span><br><span class="line">                .getCanonicalPath();</span><br><span class="line">        <span class="comment">//【1】核心逻辑，是否是以 /system/priv-app 开头的！</span></span><br><span class="line">        <span class="keyword">return</span> path.getCanonicalPath().startsWith(privilegedAppDir);</span><br><span class="line">    &#125; <span class="keyword">catch</span> (IOException e) &#123;</span><br><span class="line">        Slog.e(TAG, <span class="string">"Unable to access code path "</span> + path);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">false</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>不多说了！！</p>
<h3 id="6-1-4-updateSharedLibrariesLPw"><a href="#6-1-4-updateSharedLibrariesLPw" class="headerlink" title="6.1.4 updateSharedLibrariesLPw"></a>6.1.4 updateSharedLibrariesLPw</h3><p>更新共享库文件：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">updateSharedLibrariesLPw</span><span class="params">(PackageParser.Package pkg,</span></span></span><br><span class="line"><span class="function"><span class="params">        PackageParser.Package changingLib)</span> <span class="keyword">throws</span> PackageManagerException </span>&#123;</span><br><span class="line">    <span class="keyword">if</span> (pkg.usesLibraries != <span class="keyword">null</span> || pkg.usesOptionalLibraries != <span class="keyword">null</span>) &#123;</span><br><span class="line">        <span class="comment">//【1】用于手机该 pkg 需要的所有共享库！</span></span><br><span class="line">        <span class="keyword">final</span> ArraySet&lt;String&gt; usesLibraryFiles = <span class="keyword">new</span> ArraySet&lt;&gt;();</span><br><span class="line">        <span class="comment">//【2】处理 pkg.usesLibraries 指定依赖的库</span></span><br><span class="line">        <span class="keyword">int</span> N = pkg.usesLibraries != <span class="keyword">null</span> ? pkg.usesLibraries.size() : <span class="number">0</span>;</span><br><span class="line">        <span class="keyword">for</span> (<span class="keyword">int</span> i=<span class="number">0</span>; i&lt;N; i++) &#123;</span><br><span class="line">            <span class="comment">//【2.1】要尝试在系统已有的共享库中找到对应的库！</span></span><br><span class="line">            <span class="keyword">final</span> SharedLibraryEntry file = mSharedLibraries.get(pkg.usesLibraries.get(i));</span><br><span class="line">            <span class="keyword">if</span> (file == <span class="keyword">null</span>) &#123;</span><br><span class="line">                <span class="keyword">throw</span> <span class="keyword">new</span> PackageManagerException(INSTALL_FAILED_MISSING_SHARED_LIBRARY,</span><br><span class="line">                        <span class="string">"Package "</span> + pkg.packageName + <span class="string">" requires unavailable shared library "</span></span><br><span class="line">                        + pkg.usesLibraries.get(i) + <span class="string">"; failing!"</span>);</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="comment">//【*6.1.4.1】将依赖的库加入到 usesLibraryFiles 中！</span></span><br><span class="line">            addSharedLibraryLPw(usesLibraryFiles, file, changingLib);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">//【3】处理 pkg.usesOptionalLibraries 指定依赖的库</span></span><br><span class="line">        N = pkg.usesOptionalLibraries != <span class="keyword">null</span> ? pkg.usesOptionalLibraries.size() : <span class="number">0</span>;</span><br><span class="line">        <span class="keyword">for</span> (<span class="keyword">int</span> i=<span class="number">0</span>; i&lt;N; i++) &#123;</span><br><span class="line">            <span class="keyword">final</span> SharedLibraryEntry file = mSharedLibraries.get(pkg.usesOptionalLibraries.get(i));</span><br><span class="line">            <span class="keyword">if</span> (file == <span class="keyword">null</span>) &#123;</span><br><span class="line">                Slog.w(TAG, <span class="string">"Package "</span> + pkg.packageName</span><br><span class="line">                        + <span class="string">" desires unavailable shared library "</span></span><br><span class="line">                        + pkg.usesOptionalLibraries.get(i) + <span class="string">"; ignoring!"</span>);</span><br><span class="line">            &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                <span class="comment">//【*6.1.4.1】将依赖的库加入到 usesLibraryFiles 中！</span></span><br><span class="line">                addSharedLibraryLPw(usesLibraryFiles, file, changingLib);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">//【4】最后将收集到的共享库文件路径保存到 pkg.usesLibraryFiles 中！</span></span><br><span class="line">        N = usesLibraryFiles.size();</span><br><span class="line">        <span class="keyword">if</span> (N &gt; <span class="number">0</span>) &#123;</span><br><span class="line">            pkg.usesLibraryFiles = usesLibraryFiles.toArray(<span class="keyword">new</span> String[N]);</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            pkg.usesLibraryFiles = <span class="keyword">null</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>PackageParser.Package 内有如下的集合，表示该 pkg 依赖的共享库的名称：<br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> ArrayList&lt;String&gt; usesLibraries = <span class="keyword">null</span>;</span><br><span class="line"><span class="keyword">public</span> ArrayList&lt;String&gt; usesOptionalLibraries = <span class="keyword">null</span>;</span><br></pre></td></tr></table></figure></p>
<p>同时也有下面的集合，保存了依赖的所有的共享库的路径：<br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> String[] usesLibraryFiles = <span class="keyword">null</span>;</span><br></pre></td></tr></table></figure></p>
<p>不多说了！</p>
<h4 id="6-1-4-1-addSharedLibraryLPw"><a href="#6-1-4-1-addSharedLibraryLPw" class="headerlink" title="6.1.4.1 addSharedLibraryLPw"></a>6.1.4.1 addSharedLibraryLPw</h4><p>参数 PackageParser.Package changingLib 表示我们改变了共享库的定义 apk，那么我们要将新的 apk 传进来，作为新的依赖！</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">addSharedLibraryLPw</span><span class="params">(ArraySet&lt;String&gt; usesLibraryFiles, SharedLibraryEntry file,</span></span></span><br><span class="line"><span class="function"><span class="params">        PackageParser.Package changingLib)</span> </span>&#123;</span><br><span class="line">    <span class="comment">//【1】如果共享库的 path 不为 null，那就直接加入到 usesLibraryFiles 中！</span></span><br><span class="line">    <span class="keyword">if</span> (file.path != <span class="keyword">null</span>) &#123;</span><br><span class="line">        usesLibraryFiles.add(file.path);</span><br><span class="line">        <span class="keyword">return</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">//【2】否则就找到定义共享库的 apk！</span></span><br><span class="line">    PackageParser.Package p = mPackages.get(file.apk);</span><br><span class="line">    <span class="keyword">if</span> (changingLib != <span class="keyword">null</span> &amp;&amp; changingLib.packageName.equals(file.apk)) &#123;</span><br><span class="line">        <span class="comment">//【2.1】如果此时 changingLib 不为 null，同时匹配，那么我们就依赖这个 changingLib！</span></span><br><span class="line">        <span class="keyword">if</span> (p == <span class="keyword">null</span> || p.packageName.equals(changingLib.packageName)) &#123;</span><br><span class="line">            p = changingLib;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">//【3】依赖定义 lib 的 apk！</span></span><br><span class="line">    <span class="keyword">if</span> (p != <span class="keyword">null</span>) &#123;</span><br><span class="line">        usesLibraryFiles.addAll(p.getAllCodePaths());</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>不多说了！</p>
<h3 id="6-1-5-prepareAppDataAfterInstallLIF"><a href="#6-1-5-prepareAppDataAfterInstallLIF" class="headerlink" title="6.1.5 prepareAppDataAfterInstallLIF"></a>6.1.5 prepareAppDataAfterInstallLIF</h3><p>准备数据目录！<br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">prepareAppDataAfterInstallLIF</span><span class="params">(PackageParser.Package pkg)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">final</span> PackageSetting ps;</span><br><span class="line">    <span class="keyword">synchronized</span> (mPackages) &#123;</span><br><span class="line">        <span class="comment">//【1】保存 Kernel Map 数据！</span></span><br><span class="line">        ps = mSettings.mPackages.get(pkg.packageName);</span><br><span class="line">        mSettings.writeKernelMappingLPr(ps);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">final</span> UserManager um = mContext.getSystemService(UserManager.class);</span><br><span class="line">    UserManagerInternal umInternal = getUserManagerInternal();</span><br><span class="line">    <span class="keyword">for</span> (UserInfo user : um.getUsers()) &#123;</span><br><span class="line">        <span class="keyword">final</span> <span class="keyword">int</span> flags;</span><br><span class="line">        <span class="keyword">if</span> (umInternal.isUserUnlockingOrUnlocked(user.id)) &#123;</span><br><span class="line">            flags = StorageManager.FLAG_STORAGE_DE | StorageManager.FLAG_STORAGE_CE;</span><br><span class="line">        &#125; <span class="keyword">else</span> <span class="keyword">if</span> (umInternal.isUserRunning(user.id)) &#123;</span><br><span class="line">            flags = StorageManager.FLAG_STORAGE_DE;</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            <span class="keyword">continue</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">//【2】如果在该 user 下是安装状态，那就在该设备用户下准备数据目录！</span></span><br><span class="line">        <span class="keyword">if</span> (ps.getInstalled(user.id)) &#123;</span><br><span class="line">            <span class="comment">//【*6.1.5.1】准备数据目录！</span></span><br><span class="line">            prepareAppDataLIF(pkg, user.id, flags);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>继续分析：</p>
<h4 id="6-1-5-1-prepareAppDataLIF"><a href="#6-1-5-1-prepareAppDataLIF" class="headerlink" title="6.1.5.1 prepareAppDataLIF"></a>6.1.5.1 prepareAppDataLIF</h4><p>这个方法会对 pkg 以及其 child pkg 准备目录：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">prepareAppDataLIF</span><span class="params">(PackageParser.Package pkg, <span class="keyword">int</span> userId, <span class="keyword">int</span> flags)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">if</span> (pkg == <span class="keyword">null</span>) &#123;</span><br><span class="line">        Slog.wtf(TAG, <span class="string">"Package was null!"</span>, <span class="keyword">new</span> Throwable());</span><br><span class="line">        <span class="keyword">return</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">//【*6.1.5.2】准备父包的数据目录</span></span><br><span class="line">    prepareAppDataLeafLIF(pkg, userId, flags);</span><br><span class="line">    <span class="keyword">final</span> <span class="keyword">int</span> childCount = (pkg.childPackages != <span class="keyword">null</span>) ? pkg.childPackages.size() : <span class="number">0</span>;</span><br><span class="line">    <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; childCount; i++) &#123;</span><br><span class="line">        <span class="comment">//【*6.1.5.2】准备子包的数据目录</span></span><br><span class="line">        prepareAppDataLeafLIF(pkg.childPackages.get(i), userId, flags);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>继续分析：</p>
<h4 id="6-1-5-2-prepareAppDataLeafLIF"><a href="#6-1-5-2-prepareAppDataLeafLIF" class="headerlink" title="6.1.5.2 prepareAppDataLeafLIF"></a>6.1.5.2 prepareAppDataLeafLIF</h4><p>该方法是核心的方法：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">prepareAppDataLeafLIF</span><span class="params">(PackageParser.Package pkg, <span class="keyword">int</span> userId, <span class="keyword">int</span> flags)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">if</span> (DEBUG_APP_DATA) &#123;</span><br><span class="line">        Slog.v(TAG, <span class="string">"prepareAppData for "</span> + pkg.packageName + <span class="string">" u"</span> + userId + <span class="string">" 0x"</span></span><br><span class="line">                + Integer.toHexString(flags));</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">final</span> String volumeUuid = pkg.volumeUuid;</span><br><span class="line">    <span class="keyword">final</span> String packageName = pkg.packageName;</span><br><span class="line">    <span class="keyword">final</span> ApplicationInfo app = pkg.applicationInfo;</span><br><span class="line">    <span class="keyword">final</span> <span class="keyword">int</span> appId = UserHandle.getAppId(app.uid);</span><br><span class="line">    Preconditions.checkNotNull(app.seinfo);</span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">        <span class="comment">//【1】通过 installd 来准备数据目录！</span></span><br><span class="line">        mInstaller.createAppData(volumeUuid, packageName, userId, flags,</span><br><span class="line">                appId, app.seinfo, app.targetSdkVersion);</span><br><span class="line">    &#125; <span class="keyword">catch</span> (InstallerException e) &#123;</span><br><span class="line">        <span class="comment">//【2】如果是系统应用，第一次准备失败后，还会在尝试一次！</span></span><br><span class="line">        <span class="keyword">if</span> (app.isSystemApp()) &#123;</span><br><span class="line">            logCriticalInfo(Log.ERROR, <span class="string">"Failed to create app data for "</span> + packageName</span><br><span class="line">                    + <span class="string">", but trying to recover: "</span> + e);</span><br><span class="line">            <span class="comment">//【2.1】先删除之前创建的脏目录！</span></span><br><span class="line">            destroyAppDataLeafLIF(pkg, userId, flags);</span><br><span class="line">            <span class="keyword">try</span> &#123;</span><br><span class="line">                <span class="comment">//【2.2】再次创建数据目录；</span></span><br><span class="line">                mInstaller.createAppData(volumeUuid, packageName, userId, flags,</span><br><span class="line">                        appId, app.seinfo, app.targetSdkVersion);</span><br><span class="line">                logCriticalInfo(Log.DEBUG, <span class="string">"Recovery succeeded!"</span>);</span><br><span class="line">            &#125; <span class="keyword">catch</span> (InstallerException e2) &#123;</span><br><span class="line">                logCriticalInfo(Log.DEBUG, <span class="string">"Recovery failed!"</span>);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            Slog.e(TAG, <span class="string">"Failed to create app data for "</span> + packageName + <span class="string">": "</span> + e);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span> ((flags &amp; StorageManager.FLAG_STORAGE_CE) != <span class="number">0</span>) &#123;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            <span class="comment">// CE storage is unlocked right now, so read out the inode and</span></span><br><span class="line">            <span class="comment">// remember for use later when it's locked</span></span><br><span class="line">            <span class="comment">// <span class="doctag">TODO:</span> mark this structure as dirty so we persist it!</span></span><br><span class="line">            <span class="keyword">final</span> <span class="keyword">long</span> ceDataInode = mInstaller.getAppDataInode(volumeUuid, packageName, userId,</span><br><span class="line">                    StorageManager.FLAG_STORAGE_CE);</span><br><span class="line">            <span class="keyword">synchronized</span> (mPackages) &#123;</span><br><span class="line">                <span class="keyword">final</span> PackageSetting ps = mSettings.mPackages.get(packageName);</span><br><span class="line">                <span class="keyword">if</span> (ps != <span class="keyword">null</span>) &#123;</span><br><span class="line">                    ps.setCeDataInode(ceDataInode, userId);</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125; <span class="keyword">catch</span> (InstallerException e) &#123;</span><br><span class="line">            Slog.e(TAG, <span class="string">"Failed to find inode for "</span> + packageName + <span class="string">": "</span> + e);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">//【*6.1.5.2】为 native libs 创建链接！</span></span><br><span class="line">    prepareAppDataContentsLeafLIF(pkg, userId, flags);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>继续分析：</p>
<h4 id="6-1-5-3-prepareAppDataContentsLeafLIF"><a href="#6-1-5-3-prepareAppDataContentsLeafLIF" class="headerlink" title="6.1.5.3 prepareAppDataContentsLeafLIF"></a>6.1.5.3 prepareAppDataContentsLeafLIF</h4><p>为 native libs 创建链接：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">prepareAppDataContentsLeafLIF</span><span class="params">(PackageParser.Package pkg, <span class="keyword">int</span> userId, <span class="keyword">int</span> flags)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">final</span> String volumeUuid = pkg.volumeUuid;</span><br><span class="line">    <span class="keyword">final</span> String packageName = pkg.packageName;</span><br><span class="line">    <span class="keyword">final</span> ApplicationInfo app = pkg.applicationInfo;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> ((flags &amp; StorageManager.FLAG_STORAGE_CE) != <span class="number">0</span>) &#123;</span><br><span class="line">        <span class="comment">//【1】只为 32 位的 native libs 创建 link！</span></span><br><span class="line">        <span class="keyword">if</span> (app.primaryCpuAbi != <span class="keyword">null</span> &amp;&amp; !VMRuntime.is64BitAbi(app.primaryCpuAbi)) &#123;</span><br><span class="line">            <span class="keyword">final</span> String nativeLibPath = app.nativeLibraryDir;</span><br><span class="line">            <span class="keyword">try</span> &#123;</span><br><span class="line">                mInstaller.linkNativeLibraryDirectory(volumeUuid, packageName,</span><br><span class="line">                        nativeLibPath, userId);</span><br><span class="line">            &#125; <span class="keyword">catch</span> (InstallerException e) &#123;</span><br><span class="line">                Slog.e(TAG, <span class="string">"Failed to link native for "</span> + packageName + <span class="string">": "</span> + e);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>先分析到这里！</p>
<h2 id="6-2-deleteInstalledPackageLIF"><a href="#6-2-deleteInstalledPackageLIF" class="headerlink" title="6.2 deleteInstalledPackageLIF"></a>6.2 deleteInstalledPackageLIF</h2><p>卸载三方应用，或者覆盖更新的 sys app，那么我们调用的是该方法：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">boolean</span> <span class="title">deleteInstalledPackageLIF</span><span class="params">(PackageSetting ps,</span></span></span><br><span class="line"><span class="function"><span class="params">        <span class="keyword">boolean</span> deleteCodeAndResources, <span class="keyword">int</span> flags, <span class="keyword">int</span>[] allUserHandles,</span></span></span><br><span class="line"><span class="function"><span class="params">        PackageRemovedInfo outInfo, <span class="keyword">boolean</span> writeSettings,</span></span></span><br><span class="line"><span class="function"><span class="params">        PackageParser.Package replacingPackage)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">synchronized</span> (mPackages) &#123;</span><br><span class="line">    </span><br><span class="line">        <span class="comment">//【1】将要卸载的 apk 的 appid 保存到 PackageRemovedInfo 的 uid 属性中</span></span><br><span class="line">        <span class="comment">// 如果有 child pkg，对其也这样处理！</span></span><br><span class="line">        <span class="keyword">if</span> (outInfo != <span class="keyword">null</span>) &#123;</span><br><span class="line">            outInfo.uid = ps.appId;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">if</span> (outInfo != <span class="keyword">null</span> &amp;&amp; outInfo.removedChildPackages != <span class="keyword">null</span>) &#123;</span><br><span class="line">            <span class="keyword">final</span> <span class="keyword">int</span> childCount = (ps.childPackageNames != <span class="keyword">null</span>)</span><br><span class="line">                    ? ps.childPackageNames.size() : <span class="number">0</span>;</span><br><span class="line">            <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; childCount; i++) &#123;</span><br><span class="line">                String childPackageName = ps.childPackageNames.get(i);</span><br><span class="line">                PackageSetting childPs = mSettings.mPackages.get(childPackageName);</span><br><span class="line">                <span class="keyword">if</span> (childPs == <span class="keyword">null</span>) &#123;</span><br><span class="line">                    <span class="keyword">return</span> <span class="keyword">false</span>;</span><br><span class="line">                &#125;</span><br><span class="line">                PackageRemovedInfo childInfo = outInfo.removedChildPackages.get(</span><br><span class="line">                        childPackageName);</span><br><span class="line">                <span class="keyword">if</span> (childInfo != <span class="keyword">null</span>) &#123;</span><br><span class="line">                    childInfo.uid = childPs.appId;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//【*6.2.1】删除 apk 的使用数据，如果有 child pkg，对其也这样处理！！</span></span><br><span class="line">    removePackageDataLIF(ps, allUserHandles, outInfo, flags, writeSettings);</span><br><span class="line">    <span class="keyword">final</span> <span class="keyword">int</span> childCount = (ps.childPackageNames != <span class="keyword">null</span>) ? ps.childPackageNames.size() : <span class="number">0</span>;</span><br><span class="line">    <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; childCount; i++) &#123;</span><br><span class="line">        PackageSetting childPs;</span><br><span class="line">        <span class="keyword">synchronized</span> (mPackages) &#123;</span><br><span class="line">            childPs = mSettings.peekPackageLPr(ps.childPackageNames.get(i));</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">if</span> (childPs != <span class="keyword">null</span>) &#123;</span><br><span class="line">            PackageRemovedInfo childOutInfo = (outInfo != <span class="keyword">null</span></span><br><span class="line">                    &amp;&amp; outInfo.removedChildPackages != <span class="keyword">null</span>)</span><br><span class="line">                    ? outInfo.removedChildPackages.get(childPs.name) : <span class="keyword">null</span>;</span><br><span class="line">            <span class="comment">//【2.1】对于 child pkg，这里的卸载 flags 比较特殊，如果 flags 设置了 DELETE_KEEP_DATA</span></span><br><span class="line">            <span class="comment">// 同时指定了 replacingPackage，而 replacingPackage 并不是其 parent pkg，这种情况，</span></span><br><span class="line">            <span class="comment">// 不需要保留数据，去掉 DELETE_KEEP_DATA 标志位；</span></span><br><span class="line">            <span class="keyword">final</span> <span class="keyword">int</span> deleteFlags = (flags &amp; DELETE_KEEP_DATA) != <span class="number">0</span></span><br><span class="line">                    &amp;&amp; (replacingPackage != <span class="keyword">null</span></span><br><span class="line">                    &amp;&amp; !replacingPackage.hasChildPackage(childPs.name))</span><br><span class="line">                    ? flags &amp; ~DELETE_KEEP_DATA : flags;</span><br><span class="line">             <span class="comment">//【*6.2.1】删除 child apk 的使用数据！</span></span><br><span class="line">            removePackageDataLIF(childPs, allUserHandles, childOutInfo,</span><br><span class="line">                    deleteFlags, writeSettings);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//【2】只删除 pkg 的 apk 文件（child pkg 并不会被删除）</span></span><br><span class="line">    <span class="keyword">if</span> (ps.parentPackageName == <span class="keyword">null</span>) &#123;</span><br><span class="line">        <span class="keyword">if</span> (deleteCodeAndResources &amp;&amp; (outInfo != <span class="keyword">null</span>)) &#123;</span><br><span class="line">            <span class="comment">//【*6.2.2】创建一个 intallArgs，用于卸载！</span></span><br><span class="line">            outInfo.args = createInstallArgsForExisting(packageFlagsToInstallFlags(ps),</span><br><span class="line">                    ps.codePathString, ps.resourcePathString, getAppDexInstructionSets(ps));</span><br><span class="line">            <span class="keyword">if</span> (DEBUG_SD_INSTALL) Slog.i(TAG, <span class="string">"args="</span> + outInfo.args);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">true</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h3 id="6-2-1-removePackageDataLIF"><a href="#6-2-1-removePackageDataLIF" class="headerlink" title="6.2.1 removePackageDataLIF"></a>6.2.1 removePackageDataLIF</h3><p>删除 package 的数据！</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">removePackageDataLIF</span><span class="params">(PackageSetting ps, <span class="keyword">int</span>[] allUserHandles,</span></span></span><br><span class="line"><span class="function"><span class="params">        PackageRemovedInfo outInfo, <span class="keyword">int</span> flags, <span class="keyword">boolean</span> writeSettings)</span> </span>&#123;</span><br><span class="line">    String packageName = ps.name;</span><br><span class="line">    <span class="keyword">if</span> (DEBUG_REMOVE) Slog.d(TAG, <span class="string">"removePackageDataLI: "</span> + ps);</span><br><span class="line">    <span class="keyword">final</span> PackageParser.Package deletedPkg;</span><br><span class="line">    <span class="keyword">final</span> PackageSetting deletedPs;</span><br><span class="line">    <span class="keyword">synchronized</span> (mPackages) &#123;</span><br><span class="line">        <span class="comment">//【1】获得要被删除的 apk 的 PackageSetting 和 PackageParser.Package 对象！</span></span><br><span class="line">        deletedPkg = mPackages.get(packageName);</span><br><span class="line">        deletedPs = mSettings.mPackages.get(packageName);</span><br><span class="line">        <span class="keyword">if</span> (outInfo != <span class="keyword">null</span>) &#123;</span><br><span class="line">            outInfo.removedPackage = packageName;</span><br><span class="line">            outInfo.removedUsers = deletedPs != <span class="keyword">null</span></span><br><span class="line">                    ? deletedPs.queryInstalledUsers(sUserManager.getUserIds(), <span class="keyword">true</span>)</span><br><span class="line">                    : <span class="keyword">null</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">//【*6.2.1.1】第一部移除，扫描的四大组件信息！</span></span><br><span class="line">    removePackageLI(ps, (flags &amp; REMOVE_CHATTY) != <span class="number">0</span>);</span><br><span class="line">    </span><br><span class="line">    <span class="comment">//【2】如果 flags 没有设置 DELETE_KEEP_DATA，那么会清楚 apk 的数据！！</span></span><br><span class="line">    <span class="keyword">if</span> ((flags &amp; PackageManager.DELETE_KEEP_DATA) == <span class="number">0</span>) &#123;</span><br><span class="line">        <span class="keyword">final</span> PackageParser.Package resolvedPkg;</span><br><span class="line">        <span class="keyword">if</span> (deletedPkg != <span class="keyword">null</span>) &#123;</span><br><span class="line">            resolvedPkg = deletedPkg;</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            resolvedPkg = <span class="keyword">new</span> PackageParser.Package(ps.name);</span><br><span class="line">            resolvedPkg.setVolumeUuid(ps.volumeUuid);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">//【*6.2.1.2】删除 apk 的 data 数据！！</span></span><br><span class="line">        destroyAppDataLIF(resolvedPkg, UserHandle.USER_ALL,</span><br><span class="line">                StorageManager.FLAG_STORAGE_DE | StorageManager.FLAG_STORAGE_CE);</span><br><span class="line">                </span><br><span class="line">        <span class="comment">//【*6.2.1.3】删除 apk 的 profiles 数据！！</span></span><br><span class="line">        destroyAppProfilesLIF(resolvedPkg, UserHandle.USER_ALL);</span><br><span class="line">        <span class="keyword">if</span> (outInfo != <span class="keyword">null</span>) &#123;</span><br><span class="line">            outInfo.dataRemoved = <span class="keyword">true</span>; <span class="comment">// 表示数据移除了；</span></span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">//【*6.2.1.4】执行 package 清除！！</span></span><br><span class="line">        schedulePackageCleaning(packageName, UserHandle.USER_ALL, <span class="keyword">true</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">//【3】进一步处理！</span></span><br><span class="line">    <span class="keyword">synchronized</span> (mPackages) &#123;</span><br><span class="line">        <span class="keyword">if</span> (deletedPs != <span class="keyword">null</span>) &#123;</span><br><span class="line">            <span class="comment">//【3.1】如果 flags 没有设置 DELETE_KEEP_DATA 标志位，那么执行其他的清楚操作！</span></span><br><span class="line">            <span class="keyword">if</span> ((flags &amp; PackageManager.DELETE_KEEP_DATA) == <span class="number">0</span>) &#123;</span><br><span class="line">            </span><br><span class="line">                <span class="comment">//【3.1.1】清楚 intentfilter verify 和 默认浏览器的设置数据！</span></span><br><span class="line">                clearIntentFilterVerificationsLPw(deletedPs.name, UserHandle.USER_ALL);</span><br><span class="line">                clearDefaultBrowserIfNeeded(packageName);</span><br><span class="line">                <span class="keyword">if</span> (outInfo != <span class="keyword">null</span>) &#123;</span><br><span class="line">                    <span class="comment">//【3.1.1.1】移除 key set 信息！</span></span><br><span class="line">                    mSettings.mKeySetManagerService.removeAppKeySetDataLPw(packageName);</span><br><span class="line"></span><br><span class="line">                    <span class="comment">//【*6.2.1.5】删除 pkg 的 PackageSetting 数据！</span></span><br><span class="line">                    outInfo.removedAppId = mSettings.removePackageLPw(packageName);</span><br><span class="line">                &#125;</span><br><span class="line">                </span><br><span class="line">                <span class="comment">//【3.1.2-review】更新权限信息，这里我们在 pms 的启动时分析过，这里就不再细说了！</span></span><br><span class="line">                <span class="comment">// 这里会更新所有应用的权限信息，移除过时的运行时权限，自动授予安装时权限等！</span></span><br><span class="line">                updatePermissionsLPw(deletedPs.name, <span class="keyword">null</span>, <span class="number">0</span>);</span><br><span class="line">                </span><br><span class="line">                <span class="comment">//【3.1.3】如果该应用是共享 shared user 的，进入这里！</span></span><br><span class="line">                <span class="keyword">if</span> (deletedPs.sharedUser != <span class="keyword">null</span>) &#123;</span><br><span class="line">                    <span class="keyword">for</span> (<span class="keyword">int</span> userId : UserManagerService.getInstance().getUserIds()) &#123;</span><br><span class="line">                    </span><br><span class="line">                        <span class="comment">//【3.1.3.1】更新该共享 shared uid 的权限，该 package 被移除掉，会导致和该</span></span><br><span class="line">                        <span class="comment">// 应用相关连的权限的变化，从而导致共享 shared uid 的 gids 发生变化！</span></span><br><span class="line">                        <span class="keyword">final</span> <span class="keyword">int</span> userIdToKill = mSettings.updateSharedUserPermsLPw(deletedPs,</span><br><span class="line">                                userId);</span><br><span class="line">                                </span><br><span class="line">                        <span class="keyword">if</span> (userIdToKill == UserHandle.USER_ALL</span><br><span class="line">                                || userIdToKill &gt;= UserHandle.USER_SYSTEM) &#123;</span><br><span class="line">                            <span class="comment">//【3.1.3.1】如果共享 shared uid 的 gids 发生变化，杀掉该 uid 下的</span></span><br><span class="line">                            <span class="comment">// 所有的 app 进程！</span></span><br><span class="line">                            mHandler.post(<span class="keyword">new</span> Runnable() &#123;</span><br><span class="line">                                <span class="meta">@Override</span></span><br><span class="line">                                <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">run</span><span class="params">()</span> </span>&#123;</span><br><span class="line">                                    killApplication(deletedPs.name, deletedPs.appId,</span><br><span class="line">                                            KILL_APP_REASON_GIDS_CHANGED);</span><br><span class="line">                                &#125;</span><br><span class="line">                            &#125;);</span><br><span class="line">                            <span class="keyword">break</span>;</span><br><span class="line">                        &#125;</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;</span><br><span class="line">                <span class="comment">//【3.1.4】清除默认应用的数据，先不关注；</span></span><br><span class="line">                clearPackagePreferredActivitiesLPw(deletedPs.name, UserHandle.USER_ALL);</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="comment">//【3.4】更新下在每个 user 下的安装状态！</span></span><br><span class="line">            <span class="keyword">if</span> (allUserHandles != <span class="keyword">null</span> &amp;&amp; outInfo != <span class="keyword">null</span> &amp;&amp; outInfo.origUsers != <span class="keyword">null</span>) &#123;</span><br><span class="line">                <span class="keyword">if</span> (DEBUG_REMOVE) &#123;</span><br><span class="line">                    Slog.d(TAG, <span class="string">"Propagating install state across downgrade"</span>);</span><br><span class="line">                &#125;</span><br><span class="line">                <span class="keyword">for</span> (<span class="keyword">int</span> userId : allUserHandles) &#123;</span><br><span class="line">                    <span class="keyword">final</span> <span class="keyword">boolean</span> installed = ArrayUtils.contains(outInfo.origUsers, userId);</span><br><span class="line">                    <span class="keyword">if</span> (DEBUG_REMOVE) &#123;</span><br><span class="line">                        Slog.d(TAG, <span class="string">"    user "</span> + userId + <span class="string">" =&gt; "</span> + installed);</span><br><span class="line">                    &#125;</span><br><span class="line">                    ps.setInstalled(installed, userId);</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">//【3.5】持久化 Settings 中的数据！！</span></span><br><span class="line">        <span class="keyword">if</span> (writeSettings) &#123;</span><br><span class="line">            mSettings.writeLPr();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span> (outInfo != <span class="keyword">null</span>) &#123;</span><br><span class="line">        <span class="comment">//【4】移除 key-store！</span></span><br><span class="line">        removeKeystoreDataIfNeeded(UserHandle.USER_ALL, outInfo.removedAppId);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>这里我们详细的分析了整个流程！！</p>
<h4 id="6-2-1-1-removePackageLI"><a href="#6-2-1-1-removePackageLI" class="headerlink" title="6.2.1.1 removePackageLI"></a>6.2.1.1 removePackageLI</h4><p>移除 PackageSetting 对应的扫描数据：<br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">removePackageLI</span><span class="params">(PackageSetting ps, <span class="keyword">boolean</span> chatty)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">if</span> (DEBUG_INSTALL) &#123;</span><br><span class="line">        <span class="keyword">if</span> (chatty)</span><br><span class="line">            Log.d(TAG, <span class="string">"Removing package "</span> + ps.name);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">synchronized</span> (mPackages) &#123;</span><br><span class="line">        <span class="comment">//【1】移除扫描信息！</span></span><br><span class="line">        mPackages.remove(ps.name);</span><br><span class="line">        <span class="keyword">final</span> PackageParser.Package pkg = ps.pkg;</span><br><span class="line">        <span class="keyword">if</span> (pkg != <span class="keyword">null</span>) &#123;</span><br><span class="line">            <span class="comment">//【*6.2.1.1.1】移除四大组件，共享库解析对象！</span></span><br><span class="line">            cleanPackageDataStructuresLILPw(pkg, chatty);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>这个就不多说了！！</p>
<h5 id="6-2-1-1-1-cleanPackageDataStructuresLILPw"><a href="#6-2-1-1-1-cleanPackageDataStructuresLILPw" class="headerlink" title="6.2.1.1.1 cleanPackageDataStructuresLILPw"></a>6.2.1.1.1 cleanPackageDataStructuresLILPw</h5><p>用于删除 apk 的四大组件和共享库数据：<br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">cleanPackageDataStructuresLILPw</span><span class="params">(PackageParser.Package pkg, <span class="keyword">boolean</span> chatty)</span> </span>&#123;</span><br><span class="line">    <span class="comment">//【1】移除 provider！</span></span><br><span class="line">    <span class="keyword">int</span> N = pkg.providers.size();</span><br><span class="line">    StringBuilder r = <span class="keyword">null</span>;</span><br><span class="line">    <span class="keyword">int</span> i;</span><br><span class="line">    <span class="keyword">for</span> (i=<span class="number">0</span>; i&lt;N; i++) &#123;</span><br><span class="line">        PackageParser.Provider p = pkg.providers.get(i);</span><br><span class="line">        mProviders.removeProvider(p);</span><br><span class="line">        <span class="keyword">if</span> (p.info.authority == <span class="keyword">null</span>) &#123;</span><br><span class="line">            <span class="comment">//【1.1】表示系统之前已经有相同 authority 的 provider，那么这个应用的 provider 是不会注册的！</span></span><br><span class="line">            <span class="comment">// 对于没有注册的 provider 不处理！</span></span><br><span class="line">            <span class="keyword">continue</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        String names[] = p.info.authority.split(<span class="string">";"</span>);</span><br><span class="line">        <span class="keyword">for</span> (<span class="keyword">int</span> j = <span class="number">0</span>; j &lt; names.length; j++) &#123;</span><br><span class="line">            <span class="keyword">if</span> (mProvidersByAuthority.get(names[j]) == p) &#123;</span><br><span class="line">                mProvidersByAuthority.remove(names[j]);</span><br><span class="line">                <span class="keyword">if</span> (DEBUG_REMOVE) &#123;</span><br><span class="line">                    <span class="keyword">if</span> (chatty)</span><br><span class="line">                        Log.d(TAG, <span class="string">"Unregistered content provider: "</span> + names[j]</span><br><span class="line">                                + <span class="string">", className = "</span> + p.info.name + <span class="string">", isSyncable = "</span></span><br><span class="line">                                + p.info.isSyncable);</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">if</span> (DEBUG_REMOVE &amp;&amp; chatty) &#123;</span><br><span class="line">            <span class="keyword">if</span> (r == <span class="keyword">null</span>) &#123;</span><br><span class="line">                r = <span class="keyword">new</span> StringBuilder(<span class="number">256</span>);</span><br><span class="line">            &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                r.append(<span class="string">' '</span>);</span><br><span class="line">            &#125;</span><br><span class="line">            r.append(p.info.name);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span> (r != <span class="keyword">null</span>) &#123;</span><br><span class="line">        <span class="keyword">if</span> (DEBUG_REMOVE) Log.d(TAG, <span class="string">"  Providers: "</span> + r);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">//【2】移除 service！</span></span><br><span class="line">    N = pkg.services.size();</span><br><span class="line">    r = <span class="keyword">null</span>;</span><br><span class="line">    <span class="keyword">for</span> (i=<span class="number">0</span>; i&lt;N; i++) &#123;</span><br><span class="line">        PackageParser.Service s = pkg.services.get(i);</span><br><span class="line">        mServices.removeService(s);</span><br><span class="line">        <span class="keyword">if</span> (chatty) &#123;</span><br><span class="line">            <span class="keyword">if</span> (r == <span class="keyword">null</span>) &#123;</span><br><span class="line">                r = <span class="keyword">new</span> StringBuilder(<span class="number">256</span>);</span><br><span class="line">            &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                r.append(<span class="string">' '</span>);</span><br><span class="line">            &#125;</span><br><span class="line">            r.append(s.info.name);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span> (r != <span class="keyword">null</span>) &#123;</span><br><span class="line">        <span class="keyword">if</span> (DEBUG_REMOVE) Log.d(TAG, <span class="string">"  Services: "</span> + r);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">//【3】移除 receiver！</span></span><br><span class="line">    N = pkg.receivers.size();</span><br><span class="line">    r = <span class="keyword">null</span>;</span><br><span class="line">    <span class="keyword">for</span> (i=<span class="number">0</span>; i&lt;N; i++) &#123;</span><br><span class="line">        PackageParser.Activity a = pkg.receivers.get(i);</span><br><span class="line">        mReceivers.removeActivity(a, <span class="string">"receiver"</span>);</span><br><span class="line">        <span class="keyword">if</span> (DEBUG_REMOVE &amp;&amp; chatty) &#123;</span><br><span class="line">            <span class="keyword">if</span> (r == <span class="keyword">null</span>) &#123;</span><br><span class="line">                r = <span class="keyword">new</span> StringBuilder(<span class="number">256</span>);</span><br><span class="line">            &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                r.append(<span class="string">' '</span>);</span><br><span class="line">            &#125;</span><br><span class="line">            r.append(a.info.name);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span> (r != <span class="keyword">null</span>) &#123;</span><br><span class="line">        <span class="keyword">if</span> (DEBUG_REMOVE) Log.d(TAG, <span class="string">"  Receivers: "</span> + r);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">//【4】移除 activity！</span></span><br><span class="line">    N = pkg.activities.size();</span><br><span class="line">    r = <span class="keyword">null</span>;</span><br><span class="line">    <span class="keyword">for</span> (i=<span class="number">0</span>; i&lt;N; i++) &#123;</span><br><span class="line">        PackageParser.Activity a = pkg.activities.get(i);</span><br><span class="line">        mActivities.removeActivity(a, <span class="string">"activity"</span>);</span><br><span class="line">        <span class="keyword">if</span> (DEBUG_REMOVE &amp;&amp; chatty) &#123;</span><br><span class="line">            <span class="keyword">if</span> (r == <span class="keyword">null</span>) &#123;</span><br><span class="line">                r = <span class="keyword">new</span> StringBuilder(<span class="number">256</span>);</span><br><span class="line">            &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                r.append(<span class="string">' '</span>);</span><br><span class="line">            &#125;</span><br><span class="line">            r.append(a.info.name);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span> (r != <span class="keyword">null</span>) &#123;</span><br><span class="line">        <span class="keyword">if</span> (DEBUG_REMOVE) Log.d(TAG, <span class="string">"  Activities: "</span> + r);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">//【5】移除定义的 permission，设置了 appop 标志为的权限，从 mAppOpPermissionPackages 也要移除！</span></span><br><span class="line">    N = pkg.permissions.size();</span><br><span class="line">    r = <span class="keyword">null</span>;</span><br><span class="line">    <span class="keyword">for</span> (i=<span class="number">0</span>; i&lt;N; i++) &#123;</span><br><span class="line">        PackageParser.Permission p = pkg.permissions.get(i);</span><br><span class="line">        BasePermission bp = mSettings.mPermissions.get(p.info.name);</span><br><span class="line">        <span class="keyword">if</span> (bp == <span class="keyword">null</span>) &#123;</span><br><span class="line">            bp = mSettings.mPermissionTrees.get(p.info.name);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">if</span> (bp != <span class="keyword">null</span> &amp;&amp; bp.perm == p) &#123;</span><br><span class="line">            bp.perm = <span class="keyword">null</span>;</span><br><span class="line">            <span class="keyword">if</span> (DEBUG_REMOVE &amp;&amp; chatty) &#123;</span><br><span class="line">                <span class="keyword">if</span> (r == <span class="keyword">null</span>) &#123;</span><br><span class="line">                    r = <span class="keyword">new</span> StringBuilder(<span class="number">256</span>);</span><br><span class="line">                &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                    r.append(<span class="string">' '</span>);</span><br><span class="line">                &#125;</span><br><span class="line">                r.append(p.info.name);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">if</span> ((p.info.protectionLevel&amp;PermissionInfo.PROTECTION_FLAG_APPOP) != <span class="number">0</span>) &#123;</span><br><span class="line">            ArraySet&lt;String&gt; appOpPkgs = mAppOpPermissionPackages.get(p.info.name);</span><br><span class="line">            <span class="keyword">if</span> (appOpPkgs != <span class="keyword">null</span>) &#123;</span><br><span class="line">                appOpPkgs.remove(pkg.packageName);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span> (r != <span class="keyword">null</span>) &#123;</span><br><span class="line">        <span class="keyword">if</span> (DEBUG_REMOVE) Log.d(TAG, <span class="string">"  Permissions: "</span> + r);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">//【6】移除请求的 permission，设置了 appop 标志为的权限，从 mAppOpPermissionPackages 也要移除！！</span></span><br><span class="line">    N = pkg.requestedPermissions.size();</span><br><span class="line">    r = <span class="keyword">null</span>;</span><br><span class="line">    <span class="keyword">for</span> (i=<span class="number">0</span>; i&lt;N; i++) &#123;</span><br><span class="line">        String perm = pkg.requestedPermissions.get(i);</span><br><span class="line">        BasePermission bp = mSettings.mPermissions.get(perm);</span><br><span class="line">        <span class="keyword">if</span> (bp != <span class="keyword">null</span> &amp;&amp; (bp.protectionLevel&amp;PermissionInfo.PROTECTION_FLAG_APPOP) != <span class="number">0</span>) &#123;</span><br><span class="line">            ArraySet&lt;String&gt; appOpPkgs = mAppOpPermissionPackages.get(perm);</span><br><span class="line">            <span class="keyword">if</span> (appOpPkgs != <span class="keyword">null</span>) &#123;</span><br><span class="line">                appOpPkgs.remove(pkg.packageName);</span><br><span class="line">                <span class="keyword">if</span> (appOpPkgs.isEmpty()) &#123;</span><br><span class="line">                    mAppOpPermissionPackages.remove(perm);</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span> (r != <span class="keyword">null</span>) &#123;</span><br><span class="line">        <span class="keyword">if</span> (DEBUG_REMOVE) Log.d(TAG, <span class="string">"  Permissions: "</span> + r);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">//【7】移除请求的 instrumentation！</span></span><br><span class="line">    N = pkg.instrumentation.size();</span><br><span class="line">    r = <span class="keyword">null</span>;</span><br><span class="line">    <span class="keyword">for</span> (i=<span class="number">0</span>; i&lt;N; i++) &#123;</span><br><span class="line">        PackageParser.Instrumentation a = pkg.instrumentation.get(i);</span><br><span class="line">        mInstrumentation.remove(a.getComponentName());</span><br><span class="line">        <span class="keyword">if</span> (DEBUG_REMOVE &amp;&amp; chatty) &#123;</span><br><span class="line">            <span class="keyword">if</span> (r == <span class="keyword">null</span>) &#123;</span><br><span class="line">                r = <span class="keyword">new</span> StringBuilder(<span class="number">256</span>);</span><br><span class="line">            &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                r.append(<span class="string">' '</span>);</span><br><span class="line">            &#125;</span><br><span class="line">            r.append(a.info.name);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span> (r != <span class="keyword">null</span>) &#123;</span><br><span class="line">        <span class="keyword">if</span> (DEBUG_REMOVE) Log.d(TAG, <span class="string">"  Instrumentation: "</span> + r);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">//【8】移除 SharedLibraries！</span></span><br><span class="line">    r = <span class="keyword">null</span>;</span><br><span class="line">    <span class="keyword">if</span> ((pkg.applicationInfo.flags&amp;ApplicationInfo.FLAG_SYSTEM) != <span class="number">0</span>) &#123;</span><br><span class="line">        <span class="comment">// Only system apps can hold shared libraries.</span></span><br><span class="line">        <span class="keyword">if</span> (pkg.libraryNames != <span class="keyword">null</span>) &#123;</span><br><span class="line">            <span class="keyword">for</span> (i=<span class="number">0</span>; i&lt;pkg.libraryNames.size(); i++) &#123;</span><br><span class="line">                String name = pkg.libraryNames.get(i);</span><br><span class="line">                SharedLibraryEntry cur = mSharedLibraries.get(name);</span><br><span class="line">                <span class="keyword">if</span> (cur != <span class="keyword">null</span> &amp;&amp; cur.apk != <span class="keyword">null</span> &amp;&amp; cur.apk.equals(pkg.packageName)) &#123;</span><br><span class="line">                    mSharedLibraries.remove(name);</span><br><span class="line">                    <span class="keyword">if</span> (DEBUG_REMOVE &amp;&amp; chatty) &#123;</span><br><span class="line">                        <span class="keyword">if</span> (r == <span class="keyword">null</span>) &#123;</span><br><span class="line">                            r = <span class="keyword">new</span> StringBuilder(<span class="number">256</span>);</span><br><span class="line">                        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                            r.append(<span class="string">' '</span>);</span><br><span class="line">                        &#125;</span><br><span class="line">                        r.append(name);</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span> (r != <span class="keyword">null</span>) &#123;</span><br><span class="line">        <span class="keyword">if</span> (DEBUG_REMOVE) Log.d(TAG, <span class="string">"  Libraries: "</span> + r);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>该阶段的逻辑比较简单，不多说了！</p>
<h4 id="6-2-1-2-destroyAppDataLIF-gt-Leaf"><a href="#6-2-1-2-destroyAppDataLIF-gt-Leaf" class="headerlink" title="6.2.1.2 destroyAppDataLIF -&gt;[Leaf]"></a>6.2.1.2 destroyAppDataLIF -&gt;[Leaf]</h4><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">destroyAppDataLIF</span><span class="params">(PackageParser.Package pkg, <span class="keyword">int</span> userId, <span class="keyword">int</span> flags)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">if</span> (pkg == <span class="keyword">null</span>) &#123;</span><br><span class="line">        Slog.wtf(TAG, <span class="string">"Package was null!"</span>, <span class="keyword">new</span> Throwable());</span><br><span class="line">        <span class="keyword">return</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">//【1】删除父包的数据！！</span></span><br><span class="line">    destroyAppDataLeafLIF(pkg, userId, flags);</span><br><span class="line">    <span class="keyword">final</span> <span class="keyword">int</span> childCount = (pkg.childPackages != <span class="keyword">null</span>) ? pkg.childPackages.size() : <span class="number">0</span>;</span><br><span class="line">    <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; childCount; i++) &#123;</span><br><span class="line">        <span class="comment">//【2】删除子包的数据！</span></span><br><span class="line">        destroyAppDataLeafLIF(pkg.childPackages.get(i), userId, flags);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>继续看：<br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">destroyAppDataLeafLIF</span><span class="params">(PackageParser.Package pkg, <span class="keyword">int</span> userId, <span class="keyword">int</span> flags)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">final</span> PackageSetting ps;</span><br><span class="line">    <span class="keyword">synchronized</span> (mPackages) &#123;</span><br><span class="line">        <span class="comment">//【1】获得该应用的安装信息 PackageSetting ！</span></span><br><span class="line">        ps = mSettings.mPackages.get(pkg.packageName);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">for</span> (<span class="keyword">int</span> realUserId : resolveUserIds(userId)) &#123;</span><br><span class="line">        <span class="comment">//【2】获得要删除的状态信息目录：</span></span><br><span class="line">        <span class="keyword">final</span> <span class="keyword">long</span> ceDataInode = (ps != <span class="keyword">null</span>) ? ps.getCeDataInode(realUserId) : <span class="number">0</span>;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            <span class="comment">//【3】调用了 Installd 删除指定目录！</span></span><br><span class="line">            mInstaller.destroyAppData(pkg.volumeUuid, pkg.packageName, realUserId, flags,</span><br><span class="line">                    ceDataInode);</span><br><span class="line">        &#125; <span class="keyword">catch</span> (InstallerException e) &#123;</span><br><span class="line">            Slog.w(TAG, String.valueOf(e));</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>这里使用了 PackageSetting.getCeDataInode 方法：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">long</span> <span class="title">getCeDataInode</span><span class="params">(<span class="keyword">int</span> userId)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">return</span> readUserState(userId).ceDataInode;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>该方法返回的是 PackageUserState.ceDataInode 的值！</p>
<h4 id="6-2-1-4-schedulePackageCleaning"><a href="#6-2-1-4-schedulePackageCleaning" class="headerlink" title="6.2.1.4 schedulePackageCleaning"></a>6.2.1.4 schedulePackageCleaning</h4><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">schedulePackageCleaning</span><span class="params">(String packageName, <span class="keyword">int</span> userId, <span class="keyword">boolean</span> andCode)</span> </span>&#123;</span><br><span class="line">    <span class="comment">//【*6.2.1.1.3.1】这里会发送一个 START_CLEANING_PACKAGE 的消息给 PackageHandler ！</span></span><br><span class="line">    <span class="keyword">final</span> Message msg = mHandler.obtainMessage(START_CLEANING_PACKAGE,</span><br><span class="line">            userId, andCode ? <span class="number">1</span> : <span class="number">0</span>, packageName);</span><br><span class="line">    <span class="keyword">if</span> (mSystemReady) &#123;</span><br><span class="line">        msg.sendToTarget();</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        <span class="keyword">if</span> (mPostSystemReadyMessages == <span class="keyword">null</span>) &#123;</span><br><span class="line">            mPostSystemReadyMessages = <span class="keyword">new</span> ArrayList&lt;&gt;();</span><br><span class="line">        &#125;</span><br><span class="line">        mPostSystemReadyMessages.add(msg);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h5 id="6-2-1-4-1-Packagehandler-doHandleMessage-START-CLEANING-PACKAGE"><a href="#6-2-1-4-1-Packagehandler-doHandleMessage-START-CLEANING-PACKAGE" class="headerlink" title="6.2.1.4.1 Packagehandler.doHandleMessage[START_CLEANING_PACKAGE]"></a>6.2.1.4.1 Packagehandler.doHandleMessage[START_CLEANING_PACKAGE]</h5><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">case</span> START_CLEANING_PACKAGE: &#123;</span><br><span class="line">    Process.setThreadPriority(Process.THREAD_PRIORITY_DEFAULT);</span><br><span class="line">    <span class="keyword">final</span> String packageName = (String)msg.obj;</span><br><span class="line">    <span class="keyword">final</span> <span class="keyword">int</span> userId = msg.arg1;</span><br><span class="line">    <span class="keyword">final</span> <span class="keyword">boolean</span> andCode = msg.arg2 != <span class="number">0</span>;</span><br><span class="line">    <span class="keyword">synchronized</span> (mPackages) &#123;</span><br><span class="line">        <span class="keyword">if</span> (userId == UserHandle.USER_ALL) &#123;</span><br><span class="line">            <span class="keyword">int</span>[] users = sUserManager.getUserIds();</span><br><span class="line">            <span class="keyword">for</span> (<span class="keyword">int</span> user : users) &#123;</span><br><span class="line">                <span class="comment">//【1】将 package 加入到 Settings 内部的 mPackagesToBeCleaned 集合中！</span></span><br><span class="line">                mSettings.addPackageToCleanLPw(</span><br><span class="line">                        <span class="keyword">new</span> PackageCleanItem(user, packageName, andCode));</span><br><span class="line">            &#125;</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            mSettings.addPackageToCleanLPw(</span><br><span class="line">                    <span class="keyword">new</span> PackageCleanItem(userId, packageName, andCode));</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    Process.setThreadPriority(Process.THREAD_PRIORITY_BACKGROUND);</span><br><span class="line">    <span class="comment">//【*6.2.1.4.2】开始清理操作！</span></span><br><span class="line">    startCleaningPackages();</span><br><span class="line">&#125; <span class="keyword">break</span>;</span><br></pre></td></tr></table></figure>
<h5 id="6-2-1-4-2-startCleaningPackages"><a href="#6-2-1-4-2-startCleaningPackages" class="headerlink" title="6.2.1.4.2 startCleaningPackages"></a>6.2.1.4.2 startCleaningPackages</h5><p>执行扩展存储清理操作：<br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">startCleaningPackages</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    <span class="comment">// reader</span></span><br><span class="line">    <span class="keyword">if</span> (!isExternalMediaAvailable()) &#123;</span><br><span class="line">        <span class="keyword">return</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">synchronized</span> (mPackages) &#123;</span><br><span class="line">        <span class="keyword">if</span> (mSettings.mPackagesToBeCleaned.isEmpty()) &#123;</span><br><span class="line">            <span class="keyword">return</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">//【1】发送 action PackageManager.ACTION_CLEAN_EXTERNAL_STORAGE！</span></span><br><span class="line">    Intent intent = <span class="keyword">new</span> Intent(PackageManager.ACTION_CLEAN_EXTERNAL_STORAGE);</span><br><span class="line">    <span class="comment">//【2】目标组件服务：DefaultContainerService</span></span><br><span class="line">    intent.setComponent(DEFAULT_CONTAINER_COMPONENT);</span><br><span class="line">    IActivityManager am = ActivityManagerNative.getDefault();</span><br><span class="line">    <span class="keyword">if</span> (am != <span class="keyword">null</span>) &#123;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            <span class="comment">//【2.1】启动服务！</span></span><br><span class="line">            am.startService(<span class="keyword">null</span>, intent, <span class="keyword">null</span>, mContext.getOpPackageName(),</span><br><span class="line">                    UserHandle.USER_SYSTEM);</span><br><span class="line">        &#125; <span class="keyword">catch</span> (RemoteException e) &#123;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>进入 DefaultContainerService.onHandleIntent 方法：<br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="function"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title">onHandleIntent</span><span class="params">(Intent intent)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">if</span> (PackageManager.ACTION_CLEAN_EXTERNAL_STORAGE.equals(intent.getAction())) &#123;</span><br><span class="line">        <span class="keyword">final</span> IPackageManager pm = IPackageManager.Stub.asInterface(</span><br><span class="line">                ServiceManager.getService(<span class="string">"package"</span>));</span><br><span class="line">        PackageCleanItem item = <span class="keyword">null</span>;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            <span class="keyword">while</span> ((item = pm.nextPackageToClean(item)) != <span class="keyword">null</span>) &#123;</span><br><span class="line">                <span class="keyword">final</span> UserEnvironment userEnv = <span class="keyword">new</span> UserEnvironment(item.userId);</span><br><span class="line">                eraseFiles(userEnv.buildExternalStorageAppDataDirs(item.packageName));</span><br><span class="line">                eraseFiles(userEnv.buildExternalStorageAppMediaDirs(item.packageName));</span><br><span class="line">                <span class="keyword">if</span> (item.andCode) &#123;</span><br><span class="line">                    eraseFiles(userEnv.buildExternalStorageAppObbDirs(item.packageName));</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125; <span class="keyword">catch</span> (RemoteException e) &#123;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>这里的逻辑就不多说了！</p>
<h4 id="6-2-1-5-Settings-removePackageLPw"><a href="#6-2-1-5-Settings-removePackageLPw" class="headerlink" title="6.2.1.5 Settings.removePackageLPw"></a>6.2.1.5 Settings.removePackageLPw</h4><p>移除该 pkg 的安装信息：PackageSetting！<br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">removePackageLPw</span><span class="params">(String name)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">final</span> PackageSetting p = mPackages.get(name);</span><br><span class="line">    <span class="keyword">if</span> (p != <span class="keyword">null</span>) &#123;</span><br><span class="line">        <span class="comment">//【1】从 mPackages 中移除该 PackageSetting！！</span></span><br><span class="line">        mPackages .remove(name);</span><br><span class="line">        <span class="comment">//【*6.2.1.5.1】如果其实 installer，还要修改和其相关的其他 pkg 的属性！</span></span><br><span class="line">        removeInstallerPackageStatus(name);</span><br><span class="line">        <span class="comment">//【3】如果 pkg 是共享 uid，要解除相互引用！</span></span><br><span class="line">        <span class="keyword">if</span> (p.sharedUser != <span class="keyword">null</span>) &#123;</span><br><span class="line">            p.sharedUser.removePackage(p);</span><br><span class="line">            <span class="keyword">if</span> (p.sharedUser.packages.size() == <span class="number">0</span>) &#123;</span><br><span class="line">                mSharedUsers.remove(p.sharedUser.name);</span><br><span class="line">                <span class="comment">//【3.1-review】从相关集合中删除该 ps！</span></span><br><span class="line">                removeUserIdLPw(p.sharedUser.userId);</span><br><span class="line">                <span class="keyword">return</span> p.sharedUser.userId;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            <span class="comment">//【3.1-review】从相关集合中删除该 ps！</span></span><br><span class="line">            removeUserIdLPw(p.appId);</span><br><span class="line">            <span class="keyword">return</span> p.appId;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> -<span class="number">1</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>该方法最后会返回 pkg 的 appID!</p>
<h5 id="6-2-1-5-1-Settings-removeInstallerPackageStatus"><a href="#6-2-1-5-1-Settings-removeInstallerPackageStatus" class="headerlink" title="6.2.1.5.1 Settings.removeInstallerPackageStatus"></a>6.2.1.5.1 Settings.removeInstallerPackageStatus</h5><p>如果该 pkg 是 installer，那么<br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">removeInstallerPackageStatus</span><span class="params">(String packageName)</span> </span>&#123;</span><br><span class="line">    <span class="comment">//【1】如果岂不是 installer，返回！</span></span><br><span class="line">    <span class="keyword">if</span> (!mInstallerPackages.contains(packageName)) &#123;</span><br><span class="line">        <span class="keyword">return</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">//【2】如果其是 installer，那么需要找到所有由其安装的 pkg，设置其属性！</span></span><br><span class="line">    <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; mPackages.size(); i++) &#123;</span><br><span class="line">        <span class="keyword">final</span> PackageSetting ps = mPackages.valueAt(i);</span><br><span class="line">        <span class="keyword">final</span> String installerPackageName = ps.getInstallerPackageName();</span><br><span class="line">        <span class="keyword">if</span> (installerPackageName != <span class="keyword">null</span></span><br><span class="line">                &amp;&amp; installerPackageName.equals(packageName)) &#123;</span><br><span class="line">            <span class="comment">//【2.1】置空其 InstallerPackageName 属性，同时设置 ps.isOrphaned 为 ture！ </span></span><br><span class="line">            ps.setInstallerPackageName(<span class="keyword">null</span>);</span><br><span class="line">            ps.isOrphaned = <span class="keyword">true</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">//【3】从 mInstallerPackages 中移除该 pkg！</span></span><br><span class="line">    mInstallerPackages.remove(packageName);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>不多说了！！</p>
<h3 id="6-2-2-createInstallArgsForExisting-用于卸载-apk"><a href="#6-2-2-createInstallArgsForExisting-用于卸载-apk" class="headerlink" title="6.2.2 createInstallArgsForExisting - 用于卸载 apk"></a>6.2.2 createInstallArgsForExisting - 用于卸载 apk</h3><p>这里是针对已存在的应用创建一个 InstallArgs</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">private</span> InstallArgs <span class="title">createInstallArgsForExisting</span><span class="params">(<span class="keyword">int</span> installFlags, String codePath,</span></span></span><br><span class="line"><span class="function"><span class="params">        String resourcePath, String[] instructionSets)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">final</span> <span class="keyword">boolean</span> isInAsec;</span><br><span class="line">    <span class="keyword">if</span> (installOnExternalAsec(installFlags)) &#123;</span><br><span class="line">        <span class="comment">//【1】如果是安装到外置的，那就创建 AsecInstallArgs！</span></span><br><span class="line">        isInAsec = <span class="keyword">true</span>;</span><br><span class="line">    &#125; <span class="keyword">else</span> <span class="keyword">if</span> (installForwardLocked(installFlags)</span><br><span class="line">            &amp;&amp; !codePath.startsWith(mDrmAppPrivateInstallDir.getAbsolutePath())) &#123;</span><br><span class="line">        <span class="comment">//【2】对于 forward lock 安装，如果目录是 drm app pri</span></span><br><span class="line">        <span class="comment">// 那就创建 AsecInstallArgs！</span></span><br><span class="line">        isInAsec = <span class="keyword">true</span>;</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        isInAsec = <span class="keyword">false</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span> (isInAsec) &#123;</span><br><span class="line">        <span class="comment">//【3】创建 AsecInstallArgs 安装参数</span></span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> AsecInstallArgs(codePath, instructionSets,</span><br><span class="line">                installOnExternalAsec(installFlags), installForwardLocked(installFlags));</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        <span class="comment">//【*6.2.2.1.1】一般情况下，会创建 FileInstallArgs，这里通过 FileInstallArgs 的另一构造器</span></span><br><span class="line">        <span class="comment">// 创建了实例，描述一个已经存在的 app！</span></span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> FileInstallArgs(codePath, resourcePath, instructionSets);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>这里又回到了 5.5.3.1 的 FileInstallArgs 的相关创建！</p>
<h4 id="6-2-2-1-FileInstallArgs"><a href="#6-2-2-1-FileInstallArgs" class="headerlink" title="6.2.2.1 FileInstallArgs"></a>6.2.2.1 FileInstallArgs</h4><h5 id="6-2-2-1-1-new-FileInstallArgs"><a href="#6-2-2-1-1-new-FileInstallArgs" class="headerlink" title="6.2.2.1.1 new FileInstallArgs"></a>6.2.2.1.1 new FileInstallArgs</h5><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">FileInstallArgs</span> <span class="keyword">extends</span> <span class="title">InstallArgs</span> </span>&#123;</span><br><span class="line">    <span class="keyword">private</span> File codeFile;</span><br><span class="line">    <span class="keyword">private</span> File resourceFile;</span><br><span class="line">    <span class="comment">// Example topology:</span></span><br><span class="line">    <span class="comment">// /data/app/com.example/base.apk</span></span><br><span class="line">    <span class="comment">// /data/app/com.example/split_foo.apk</span></span><br><span class="line">    <span class="comment">// /data/app/com.example/lib/arm/libfoo.so</span></span><br><span class="line">    <span class="comment">// /data/app/com.example/lib/arm64/libfoo.so</span></span><br><span class="line">    <span class="comment">// /data/app/com.example/dalvik/arm/base.apk@classes.dex</span></span><br><span class="line">    <span class="comment">//【1】安装一个新的 apk！</span></span><br><span class="line">    FileInstallArgs(InstallParams params) &#123;</span><br><span class="line">        <span class="keyword">super</span>(params.origin, params.move, params.observer, params.installFlags,</span><br><span class="line">                params.installerPackageName, params.volumeUuid,</span><br><span class="line">                params.getUser(), <span class="keyword">null</span> <span class="comment">/*instructionSets*/</span>, params.packageAbiOverride,</span><br><span class="line">                params.grantedRuntimePermissions,</span><br><span class="line">                params.traceMethod, params.traceCookie, params.certificates);</span><br><span class="line">        <span class="comment">//【1.1】这里校验了下是否是  Forward Locked 的！</span></span><br><span class="line">        <span class="keyword">if</span> (isFwdLocked()) &#123;</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> IllegalArgumentException(<span class="string">"Forward locking only supported in ASEC"</span>);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">//【2】用于描述已存在的一个安装，显然，这里调用的是这个构造器！</span></span><br><span class="line">    FileInstallArgs(String codePath, String resourcePath, String[] instructionSets) &#123;</span><br><span class="line">        <span class="keyword">super</span>(OriginInfo.fromNothing(), <span class="keyword">null</span>, <span class="keyword">null</span>, <span class="number">0</span>, <span class="keyword">null</span>, <span class="keyword">null</span>, <span class="keyword">null</span>, instructionSets,</span><br><span class="line">                <span class="keyword">null</span>, <span class="keyword">null</span>, <span class="keyword">null</span>, <span class="number">0</span>, <span class="keyword">null</span> <span class="comment">/*certificates*/</span>);</span><br><span class="line">        <span class="keyword">this</span>.codeFile = (codePath != <span class="keyword">null</span>) ? <span class="keyword">new</span> File(codePath) : <span class="keyword">null</span>;</span><br><span class="line">        <span class="keyword">this</span>.resourceFile = (resourcePath != <span class="keyword">null</span>) ? <span class="keyword">new</span> File(resourcePath) : <span class="keyword">null</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    ... ... ...</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>我们看到 FileInstallArgs 有两个构造器！</p>
<p>一参数构造器用于创建安装过程中的 InstallArgs！</p>
<p>三参数构造器，用于描述一个已存在的安装，主要用于清除旧的安装，或者作为移动应用的时候的源数据，我们在 pms 开机初始化的过程中就已经看到过了！</p>
<h5 id="6-2-2-1-2-doPostDeleteLI"><a href="#6-2-2-1-2-doPostDeleteLI" class="headerlink" title="6.2.2.1.2 doPostDeleteLI"></a>6.2.2.1.2 doPostDeleteLI</h5><p>继续来看：<br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">boolean</span> <span class="title">doPostDeleteLI</span><span class="params">(<span class="keyword">boolean</span> delete)</span> </span>&#123;</span><br><span class="line">    <span class="comment">//【*6.2.2.1.3】清楚 apk 文件 和 dex 文件！</span></span><br><span class="line">    cleanUpResourcesLI();</span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">true</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>继续分析：</p>
<h5 id="6-2-2-1-3-cleanUpResourcesLI"><a href="#6-2-2-1-3-cleanUpResourcesLI" class="headerlink" title="6.2.2.1.3 cleanUpResourcesLI"></a>6.2.2.1.3 cleanUpResourcesLI</h5><p>继续分析：<br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">cleanUpResourcesLI</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    List&lt;String&gt; allCodePaths = Collections.EMPTY_LIST;</span><br><span class="line">    <span class="keyword">if</span> (codeFile != <span class="keyword">null</span> &amp;&amp; codeFile.exists()) &#123;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            <span class="comment">//【1】收集 apk path！</span></span><br><span class="line">            <span class="keyword">final</span> PackageLite pkg = PackageParser.parsePackageLite(codeFile, <span class="number">0</span>);</span><br><span class="line">            allCodePaths = pkg.getAllCodePaths();</span><br><span class="line">        &#125; <span class="keyword">catch</span> (PackageParserException e) &#123;</span><br><span class="line">            <span class="comment">// Ignored; we tried our best</span></span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">//【2】清除 apk 文件，调用 mInstaller.rmPackageDir 删除！</span></span><br><span class="line">    cleanUp();</span><br><span class="line">    <span class="comment">//【3】清除 dex files，调用 mInstaller.rmdex 删除！</span></span><br><span class="line">    removeDexFiles(allCodePaths, instructionSets);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<h1 id="7-remove-split-apk-移除-split（模块）apk"><a href="#7-remove-split-apk-移除-split（模块）apk" class="headerlink" title="7 remove split apk - 移除 split（模块）apk"></a>7 remove split apk - 移除 split（模块）apk</h1><p>在最上面的分析中，我们知道，如果要删除的是 split apk，那么会进入另外一个接口，这个接口和 install 的流程很类似，我们在这里做一下分析：</p>
<p>因为和 install 有很多相似之处，所以我省略掉一些无关紧要的代码段！！</p>
<h2 id="7-1-PackageInstallerService"><a href="#7-1-PackageInstallerService" class="headerlink" title="7.1 PackageInstallerService"></a>7.1 PackageInstallerService</h2><h3 id="7-1-1-createSession-Internal-创建事务"><a href="#7-1-1-createSession-Internal-创建事务" class="headerlink" title="7.1.1 createSession(Internal) - 创建事务"></a>7.1.1 createSession(Internal) - 创建事务</h3><p>创建事务：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">int</span> <span class="title">createSession</span><span class="params">(SessionParams params, String installerPackageName, <span class="keyword">int</span> userId)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">        <span class="comment">//【1】继续来看！</span></span><br><span class="line">        <span class="keyword">return</span> createSessionInternal(params, installerPackageName, userId);</span><br><span class="line">    &#125; <span class="keyword">catch</span> (IOException e) &#123;</span><br><span class="line">        <span class="keyword">throw</span> ExceptionUtils.wrap(e);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>createSession 方法调用了 createSessionInternal 方法：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">int</span> <span class="title">createSessionInternal</span><span class="params">(SessionParams params, String installerPackageName, <span class="keyword">int</span> userId)</span></span></span><br><span class="line"><span class="function">        <span class="keyword">throws</span> IOException </span>&#123;</span><br><span class="line">    <span class="keyword">final</span> <span class="keyword">int</span> callingUid = Binder.getCallingUid();</span><br><span class="line">    <span class="comment">//【1】权限检查！</span></span><br><span class="line">    mPm.enforceCrossUserPermission(callingUid, userId, <span class="keyword">true</span>, <span class="keyword">true</span>, <span class="string">"createSession"</span>);</span><br><span class="line"></span><br><span class="line">    <span class="comment">//【2】用户操作检查！</span></span><br><span class="line">    <span class="keyword">if</span> (mPm.isUserRestricted(userId, UserManager.DISALLOW_INSTALL_APPS)) &#123;</span><br><span class="line">        <span class="keyword">throw</span> <span class="keyword">new</span> SecurityException(<span class="string">"User restriction prevents installing"</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//【3】如果调用进程的 uid 是 SHELL_UID 或者 ROOT_UID，那么 installFlags 增加爱你 INSTALL_FROM_ADB</span></span><br><span class="line">    <span class="comment">// 表示通过 adb 进行安装！</span></span><br><span class="line">    <span class="keyword">if</span> ((callingUid == Process.SHELL_UID) || (callingUid == Process.ROOT_UID)) &#123;</span><br><span class="line">        params.installFlags |= PackageManager.INSTALL_FROM_ADB;</span><br><span class="line"></span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        <span class="comment">// 如果不是 shell or root，校验下 package 是否属于 uid，</span></span><br><span class="line">        mAppOps.checkPackage(callingUid, installerPackageName);</span><br><span class="line">        </span><br><span class="line">        <span class="comment">// 取消 INSTALL_FROM_ADB 和 INSTALL_ALL_USERS 标志位，设置 INSTALL_REPLACE_EXISTING 标志位！</span></span><br><span class="line">        params.installFlags &amp;= ~PackageManager.INSTALL_FROM_ADB;</span><br><span class="line">        params.installFlags &amp;= ~PackageManager.INSTALL_ALL_USERS;</span><br><span class="line">        params.installFlags |= PackageManager.INSTALL_REPLACE_EXISTING;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//【4】如果 installFlags 设置了 INSTALL_GRANT_RUNTIME_PERMISSIONS 标志位，那需要判断调用者是否有 </span></span><br><span class="line">    <span class="comment">// INSTALL_GRANT_RUNTIME_PERMISSIONS 权限！</span></span><br><span class="line">    <span class="keyword">if</span> ((params.installFlags &amp; PackageManager.INSTALL_GRANT_RUNTIME_PERMISSIONS) != <span class="number">0</span></span><br><span class="line">            &amp;&amp; mContext.checkCallingOrSelfPermission(Manifest.permission</span><br><span class="line">            .INSTALL_GRANT_RUNTIME_PERMISSIONS) == PackageManager.PERMISSION_DENIED) &#123;</span><br><span class="line">        <span class="keyword">throw</span> <span class="keyword">new</span> SecurityException(<span class="string">"You need the "</span></span><br><span class="line">                + <span class="string">"android.permission.INSTALL_GRANT_RUNTIME_PERMISSIONS permission "</span></span><br><span class="line">                + <span class="string">"to use the PackageManager.INSTALL_GRANT_RUNTIME_PERMISSIONS flag"</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//【5】调整应用的 icon 图标！</span></span><br><span class="line">    <span class="keyword">if</span> (params.appIcon != <span class="keyword">null</span>) &#123;</span><br><span class="line">        <span class="keyword">final</span> ActivityManager am = (ActivityManager) mContext.getSystemService(</span><br><span class="line">                Context.ACTIVITY_SERVICE);</span><br><span class="line">        <span class="keyword">final</span> <span class="keyword">int</span> iconSize = am.getLauncherLargeIconSize();</span><br><span class="line">        <span class="keyword">if</span> ((params.appIcon.getWidth() &gt; iconSize * <span class="number">2</span>)</span><br><span class="line">                || (params.appIcon.getHeight() &gt; iconSize * <span class="number">2</span>)) &#123;</span><br><span class="line">            params.appIcon = Bitmap.createScaledBitmap(params.appIcon, iconSize, iconSize,</span><br><span class="line">                    <span class="keyword">true</span>);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">//【6】检查 mode 取值是否正确！</span></span><br><span class="line">    <span class="keyword">switch</span> (params.mode) &#123;</span><br><span class="line">        <span class="keyword">case</span> SessionParams.MODE_FULL_INSTALL:</span><br><span class="line">        <span class="keyword">case</span> SessionParams.MODE_INHERIT_EXISTING:</span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line">        <span class="keyword">default</span>:</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> IllegalArgumentException(<span class="string">"Invalid install mode: "</span> + params.mode);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//【7】根据 installFlags 设置，调整安装位置，如果用户显示设置了位置，系统会对其进行检查，否则</span></span><br><span class="line">    <span class="comment">// 系统会选择合适的位置！</span></span><br><span class="line">    <span class="keyword">if</span> ((params.installFlags &amp; PackageManager.INSTALL_INTERNAL) != <span class="number">0</span>) &#123;</span><br><span class="line">        <span class="comment">//【7.1】如果显式指定内置，判断是否合适安装！</span></span><br><span class="line">        <span class="keyword">if</span> (!PackageHelper.fitsOnInternal(mContext, params.sizeBytes)) &#123;</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> IOException(<span class="string">"No suitable internal storage available"</span>);</span><br><span class="line">        &#125;</span><br><span class="line">        </span><br><span class="line">    &#125; <span class="keyword">else</span> <span class="keyword">if</span> ((params.installFlags &amp; PackageManager.INSTALL_EXTERNAL) != <span class="number">0</span>) &#123;</span><br><span class="line">        <span class="comment">//【7.2】如果显式指定外置，判断是否合适安装！</span></span><br><span class="line">        <span class="keyword">if</span> (!PackageHelper.fitsOnExternal(mContext, params.sizeBytes)) &#123;</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> IOException(<span class="string">"No suitable external storage available"</span>);</span><br><span class="line">        &#125;</span><br><span class="line">        </span><br><span class="line">    &#125; <span class="keyword">else</span> <span class="keyword">if</span> ((params.installFlags &amp; PackageManager.INSTALL_FORCE_VOLUME_UUID) != <span class="number">0</span>) &#123;</span><br><span class="line">        params.setInstallFlagsInternal();</span><br><span class="line">        </span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        <span class="comment">//【7.4】默认情况下，进入这里，setInstallFlagsInternal 方法会设置 INSTALL_INTERNAL 标志位</span></span><br><span class="line">        <span class="comment">// 取消 INSTALL_EXTERNAL 标志位！</span></span><br><span class="line">        params.setInstallFlagsInternal();</span><br><span class="line">        <span class="comment">// 选择最好的位置来安装！</span></span><br><span class="line">        <span class="keyword">final</span> <span class="keyword">long</span> ident = Binder.clearCallingIdentity();</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            params.volumeUuid = PackageHelper.resolveInstallVolume(mContext,</span><br><span class="line">                    params.appPackageName, params.installLocation, params.sizeBytes);</span><br><span class="line">        &#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">            Binder.restoreCallingIdentity(ident);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">final</span> <span class="keyword">int</span> sessionId;</span><br><span class="line">    <span class="keyword">final</span> PackageInstallerSession session;</span><br><span class="line">    <span class="keyword">synchronized</span> (mSessions) &#123;</span><br><span class="line">        <span class="comment">//【7.5-review】判断，同一个 uid 是否有过多的正在处理的 Session，如果超过了 1024 个，那就不能安装！</span></span><br><span class="line">        <span class="keyword">final</span> <span class="keyword">int</span> activeCount = getSessionCount(mSessions, callingUid);</span><br><span class="line">        <span class="keyword">if</span> (activeCount &gt;= MAX_ACTIVE_SESSIONS) &#123;</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> IllegalStateException(</span><br><span class="line">                    <span class="string">"Too many active sessions for UID "</span> + callingUid);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">// 同样，判断同一个 uid，是否已经提交了过多的 Session，如果超过了 1048576 个，那当前就不能执行安装！</span></span><br><span class="line">        <span class="keyword">final</span> <span class="keyword">int</span> historicalCount = getSessionCount(mHistoricalSessions, callingUid);</span><br><span class="line">        <span class="keyword">if</span> (historicalCount &gt;= MAX_HISTORICAL_SESSIONS) &#123;</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> IllegalStateException(</span><br><span class="line">                    <span class="string">"Too many historical sessions for UID "</span> + callingUid);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment">//【7.6-review】给本次安装分配一个事务 id！</span></span><br><span class="line">        sessionId = allocateSessionIdLocked();</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">final</span> <span class="keyword">long</span> createdMillis = System.currentTimeMillis();</span><br><span class="line"></span><br><span class="line">    <span class="comment">//【8】决定安装目录，因为默认是内置空间，这里会直接进入 buildStageDir 方法！</span></span><br><span class="line">    File stageDir = <span class="keyword">null</span>;</span><br><span class="line">    String stageCid = <span class="keyword">null</span>;</span><br><span class="line">    <span class="keyword">if</span> ((params.installFlags &amp; PackageManager.INSTALL_INTERNAL) != <span class="number">0</span>) &#123;</span><br><span class="line">        <span class="keyword">final</span> <span class="keyword">boolean</span> isEphemeral =</span><br><span class="line">                (params.installFlags &amp; PackageManager.INSTALL_EPHEMERAL) != <span class="number">0</span>;</span><br><span class="line">        <span class="comment">//【8.1-review】创建文件临时目录；/data/app/vmdl[sessionId].tmp！</span></span><br><span class="line">        stageDir = buildStageDir(params.volumeUuid, sessionId, isEphemeral);</span><br><span class="line"></span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        <span class="comment">// 如果是外置，会直接返回 "smdl" + sessionId + ".tmp"</span></span><br><span class="line">        stageCid = buildExternalStageCid(sessionId);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//【*7.2.1-review】创建 PackageInstallerSession 对象！</span></span><br><span class="line">    session = <span class="keyword">new</span> PackageInstallerSession(mInternalCallback, mContext, mPm,</span><br><span class="line">            mInstallThread.getLooper(), sessionId, userId, installerPackageName, callingUid,</span><br><span class="line">            params, createdMillis, stageDir, stageCid, <span class="keyword">false</span>, <span class="keyword">false</span>);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">synchronized</span> (mSessions) &#123;</span><br><span class="line">        <span class="comment">//【8】将新创建的 PackageInstallerSession 添加到 mSessions 集合中！</span></span><br><span class="line">        mSessions.put(sessionId, session);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//【*9-review】通知有新的事务创建了，这里是直接回调 Callback 的接口！！</span></span><br><span class="line">    mCallbacks.notifySessionCreated(session.sessionId, session.userId);</span><br><span class="line"></span><br><span class="line">    <span class="comment">//【*10-review】持久化事务 Session！</span></span><br><span class="line">    writeSessionsAsync();</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> sessionId;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>整个流程和 install 很像，我们可以大胆推测，其在移除了 split apk 后，还会把主 apk 再 install 一次！！</p>
<h3 id="7-1-2-openSession-获得事务"><a href="#7-1-2-openSession-获得事务" class="headerlink" title="7.1.2 openSession - 获得事务"></a>7.1.2 openSession - 获得事务</h3><p>openSession 方法可以获得 id 对应的 PackageInstallerSession！<br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> IPackageInstallerSession <span class="title">openSession</span><span class="params">(<span class="keyword">int</span> sessionId)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">        <span class="comment">//【×7.1.2.1】调用另外一个方法！</span></span><br><span class="line">        <span class="keyword">return</span> openSessionInternal(sessionId);</span><br><span class="line">    &#125; <span class="keyword">catch</span> (IOException e) &#123;</span><br><span class="line">        <span class="keyword">throw</span> ExceptionUtils.wrap(e);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<h4 id="7-1-2-1-openSessionInternal"><a href="#7-1-2-1-openSessionInternal" class="headerlink" title="7.1.2.1 openSessionInternal"></a>7.1.2.1 openSessionInternal</h4><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">private</span> IPackageInstallerSession <span class="title">openSessionInternal</span><span class="params">(<span class="keyword">int</span> sessionId)</span> <span class="keyword">throws</span> IOException </span>&#123;</span><br><span class="line">    <span class="keyword">synchronized</span> (mSessions) &#123;</span><br><span class="line">        <span class="keyword">final</span> PackageInstallerSession session = mSessions.get(sessionId);</span><br><span class="line">        <span class="comment">//【1-review】判断 uid 是否被允许获得该事务！</span></span><br><span class="line">        <span class="keyword">if</span> (session == <span class="keyword">null</span> || !isCallingUidOwner(session)) &#123;</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> SecurityException(<span class="string">"Caller has no access to session "</span> + sessionId);</span><br><span class="line">        &#125;</span><br><span class="line">        session.open();</span><br><span class="line">        <span class="keyword">return</span> session;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h2 id="7-2-PackageInstallerSession"><a href="#7-2-PackageInstallerSession" class="headerlink" title="7.2 PackageInstallerSession"></a>7.2 PackageInstallerSession</h2><h3 id="7-2-1-new-PackageInstallerSession-事务实例"><a href="#7-2-1-new-PackageInstallerSession-事务实例" class="headerlink" title="7.2.1 new PackageInstallerSession - 事务实例"></a>7.2.1 new PackageInstallerSession - 事务实例</h3><p>创建 PackageInstallerSession，对前面的 SessionParams 再次封装！</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">PackageInstallerSession</span> <span class="keyword">extends</span> <span class="title">IPackageInstallerSession</span>.<span class="title">Stub</span> </span>&#123;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="title">PackageInstallerSession</span><span class="params">(PackageInstallerService.InternalCallback callback,</span></span></span><br><span class="line"><span class="function"><span class="params">            Context context, PackageManagerService pm, Looper looper, <span class="keyword">int</span> sessionId, <span class="keyword">int</span> userId,</span></span></span><br><span class="line"><span class="function"><span class="params">            String installerPackageName, <span class="keyword">int</span> installerUid, SessionParams params, <span class="keyword">long</span> createdMillis,</span></span></span><br><span class="line"><span class="function"><span class="params">            File stageDir, String stageCid, <span class="keyword">boolean</span> prepared, <span class="keyword">boolean</span> sealed)</span> </span>&#123;</span><br><span class="line">        <span class="comment">//【1-review】InternalCallback 回调！</span></span><br><span class="line">        mCallback = callback;</span><br><span class="line">        mContext = context;</span><br><span class="line">        mPm = pm;</span><br><span class="line">        <span class="comment">//【2】创建 Handler 绑定到子线程 mInstallThread，该子线程是在 PackageInstallerService 构造器中创建的！</span></span><br><span class="line">        <span class="comment">//【2.1-review】这里通过 mHandlerCallback 指定了一个回调函数！</span></span><br><span class="line">        mHandler = <span class="keyword">new</span> Handler(looper, mHandlerCallback);</span><br><span class="line">        <span class="comment">//【3】基本属性保存</span></span><br><span class="line">        <span class="keyword">this</span>.sessionId = sessionId;</span><br><span class="line">        <span class="keyword">this</span>.userId = userId;</span><br><span class="line">        <span class="keyword">this</span>.installerPackageName = installerPackageName;</span><br><span class="line">        <span class="keyword">this</span>.installerUid = installerUid;</span><br><span class="line">        <span class="keyword">this</span>.params = params;</span><br><span class="line">        <span class="keyword">this</span>.createdMillis = createdMillis;</span><br><span class="line">        <span class="keyword">this</span>.stageDir = stageDir; <span class="comment">// 内置临时目录：/data/app/vmdl[sessionId].tmp；</span></span><br><span class="line">        <span class="keyword">this</span>.stageCid = stageCid; <span class="comment">// 默认为 null；</span></span><br><span class="line">        <span class="keyword">if</span> ((stageDir == <span class="keyword">null</span>) == (stageCid == <span class="keyword">null</span>)) &#123;</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> IllegalArgumentException(</span><br><span class="line">                    <span class="string">"Exactly one of stageDir or stageCid stage must be set"</span>);</span><br><span class="line">        &#125;</span><br><span class="line">        mPrepared = prepared; <span class="comment">// 传入 false；</span></span><br><span class="line">        mSealed = sealed; <span class="comment">// 传入 false；</span></span><br><span class="line">        <span class="comment">//【4】获得 DevicePolicyManager 对象，用于静默安装相关的判断，如果是安装者是设备拥有者，</span></span><br><span class="line">        <span class="comment">// 可以不检查权限，直接静默安装！</span></span><br><span class="line">        DevicePolicyManager dpm = (DevicePolicyManager) mContext.getSystemService(</span><br><span class="line">                Context.DEVICE_POLICY_SERVICE);</span><br><span class="line">        <span class="comment">//【5】校验安装者 uid 是否有 INSTALL_PACKAGES 权限！</span></span><br><span class="line">        <span class="keyword">final</span> <span class="keyword">boolean</span> isPermissionGranted =</span><br><span class="line">                (mPm.checkUidPermission(android.Manifest.permission.INSTALL_PACKAGES, installerUid)</span><br><span class="line">                        == PackageManager.PERMISSION_GRANTED);</span><br><span class="line">        <span class="comment">//【6】安装者是否是 root 用户！</span></span><br><span class="line">        <span class="keyword">final</span> <span class="keyword">boolean</span> isInstallerRoot = (installerUid == Process.ROOT_UID);</span><br><span class="line">        <span class="comment">//【7】是否强制提醒！</span></span><br><span class="line">        <span class="keyword">final</span> <span class="keyword">boolean</span> forcePermissionPrompt =</span><br><span class="line">                (params.installFlags &amp; PackageManager.INSTALL_FORCE_PERMISSION_PROMPT) != <span class="number">0</span>;</span><br><span class="line">        <span class="comment">//【8】安装者是否是设备拥有者自身！</span></span><br><span class="line">        mIsInstallerDeviceOwner = (dpm != <span class="keyword">null</span>) &amp;&amp; dpm.isDeviceOwnerAppOnCallingUser(</span><br><span class="line">                installerPackageName);</span><br><span class="line">        <span class="comment">//【8】如果 mPermissionsAccepted 为 true，那么我们就可以静默安装！</span></span><br><span class="line">        <span class="keyword">if</span> ((isPermissionGranted</span><br><span class="line">                        || isInstallerRoot</span><br><span class="line">                        || mIsInstallerDeviceOwner)</span><br><span class="line">                &amp;&amp; !forcePermissionPrompt) &#123;</span><br><span class="line">            mPermissionsAccepted = <span class="keyword">true</span>;</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            mPermissionsAccepted = <span class="keyword">false</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">final</span> <span class="keyword">long</span> identity = Binder.clearCallingIdentity();</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            <span class="keyword">final</span> <span class="keyword">int</span> uid = mPm.getPackageUid(PackageManagerService.DEFAULT_CONTAINER_PACKAGE,</span><br><span class="line">                    PackageManager.MATCH_SYSTEM_ONLY, UserHandle.USER_SYSTEM);</span><br><span class="line">            defaultContainerGid = UserHandle.getSharedAppGid(uid);</span><br><span class="line">        &#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">            Binder.restoreCallingIdentity(identity);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure>
<p>可以看到 PackageInstallerSession 除了用来表示一个 Session 之外，由于继承了 IPackageInstallerSession.Stub，因此其还可以作为服务端的桩对象，进行跨进程的通信！</p>
<h3 id="7-2-2-removeSplit"><a href="#7-2-2-removeSplit" class="headerlink" title="7.2.2 removeSplit"></a>7.2.2 removeSplit</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">removeSplit</span><span class="params">(String splitName)</span> </span>&#123;</span><br><span class="line">    <span class="comment">//【1】首先如果要卸载 split apk，必须指定 parent pkg！</span></span><br><span class="line">    <span class="keyword">if</span> (TextUtils.isEmpty(params.appPackageName)) &#123;</span><br><span class="line">        <span class="keyword">throw</span> <span class="keyword">new</span> IllegalStateException(<span class="string">"Must specify package name to remove a split"</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">        <span class="comment">//【*7.2.3】创建一个 mark 标记，来记录那些需要被移除的 split apk！！</span></span><br><span class="line">        createRemoveSplitMarker(splitName);</span><br><span class="line">    &#125; <span class="keyword">catch</span> (IOException e) &#123;</span><br><span class="line">        <span class="keyword">throw</span> ExceptionUtils.wrap(e);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h3 id="7-2-3-createRemoveSplitMarker"><a href="#7-2-3-createRemoveSplitMarker" class="headerlink" title="7.2.3 createRemoveSplitMarker"></a>7.2.3 createRemoveSplitMarker</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">createRemoveSplitMarker</span><span class="params">(String splitName)</span> <span class="keyword">throws</span> IOException </span>&#123;</span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">        <span class="comment">//【1】创建了一个标记名称：</span></span><br><span class="line">        <span class="keyword">final</span> String markerName = splitName + REMOVE_SPLIT_MARKER_EXTENSION;</span><br><span class="line">        <span class="keyword">if</span> (!FileUtils.isValidExtFilename(markerName)) &#123;</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> IllegalArgumentException(<span class="string">"Invalid marker: "</span> + markerName);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">//【2】在临时目录下创建创建了一个 "splitName".removed 的文件！</span></span><br><span class="line">        <span class="keyword">final</span> File target = <span class="keyword">new</span> File(resolveStageDir(), markerName);</span><br><span class="line">        target.createNewFile();</span><br><span class="line">        Os.chmod(target.getAbsolutePath(), <span class="number">0</span> <span class="comment">/*mode*/</span>);</span><br><span class="line">    &#125; <span class="keyword">catch</span> (ErrnoException e) &#123;</span><br><span class="line">        <span class="keyword">throw</span> e.rethrowAsIOException();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>这里的 REMOVE_SPLIT_MARKER_EXTENSION 是一个字符串后缀：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> String REMOVE_SPLIT_MARKER_EXTENSION = <span class="string">".removed"</span>;</span><br></pre></td></tr></table></figure>
<h4 id="7-2-3-1-resolveStageDir"><a href="#7-2-3-1-resolveStageDir" class="headerlink" title="7.2.3.1 resolveStageDir"></a>7.2.3.1 resolveStageDir</h4><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">private</span> File <span class="title">resolveStageDir</span><span class="params">()</span> <span class="keyword">throws</span> IOException </span>&#123;</span><br><span class="line">    <span class="keyword">synchronized</span> (mLock) &#123;</span><br><span class="line">        <span class="keyword">if</span> (mResolvedStageDir == <span class="keyword">null</span>) &#123;</span><br><span class="line">            <span class="keyword">if</span> (stageDir != <span class="keyword">null</span>) &#123;</span><br><span class="line">                <span class="comment">//【1】返回的就是前面的 stageDir！</span></span><br><span class="line">                mResolvedStageDir = stageDir;</span><br><span class="line">            &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                <span class="keyword">final</span> String path = PackageHelper.getSdDir(stageCid);</span><br><span class="line">                <span class="keyword">if</span> (path != <span class="keyword">null</span>) &#123;</span><br><span class="line">                    mResolvedStageDir = <span class="keyword">new</span> File(path);</span><br><span class="line">                &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                    <span class="keyword">throw</span> <span class="keyword">new</span> IOException(<span class="string">"Failed to resolve path to container "</span> + stageCid);</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> mResolvedStageDir;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h3 id="7-2-4-commitLocked"><a href="#7-2-4-commitLocked" class="headerlink" title="7.2.4 commitLocked"></a>7.2.4 commitLocked</h3><p>按照流程，我们进入了 commitLocked 中：</p>
<p>参数 PackageInfo pkgInfo 和 ApplicationInfo appInfo 分别表示已经安装的主 apk 的信息对象！</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">commitLocked</span><span class="params">(PackageInfo pkgInfo, ApplicationInfo appInfo)</span></span></span><br><span class="line"><span class="function">        <span class="keyword">throws</span> PackageManagerException </span>&#123;</span><br><span class="line">    <span class="keyword">if</span> (mDestroyed) &#123;</span><br><span class="line">        <span class="keyword">throw</span> <span class="keyword">new</span> PackageManagerException(INSTALL_FAILED_INTERNAL_ERROR, <span class="string">"Session destroyed"</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span> (!mSealed) &#123;</span><br><span class="line">        <span class="keyword">throw</span> <span class="keyword">new</span> PackageManagerException(INSTALL_FAILED_INTERNAL_ERROR, <span class="string">"Session not sealed"</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">        <span class="comment">//【*7.2.3.1】获得 tmp 目录，也就是前面我们的 .removed 文件所在的目录；</span></span><br><span class="line">        resolveStageDir();</span><br><span class="line">    &#125; <span class="keyword">catch</span> (IOException e) &#123;</span><br><span class="line">        <span class="keyword">throw</span> <span class="keyword">new</span> PackageManagerException(INSTALL_FAILED_CONTAINER_ERROR,</span><br><span class="line">                <span class="string">"Failed to resolve stage location"</span>, e);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//【*7.2.4.1】校验安装有效性！</span></span><br><span class="line">    validateInstallLocked(pkgInfo, appInfo);</span><br><span class="line"></span><br><span class="line">    Preconditions.checkNotNull(mPackageName);</span><br><span class="line">    Preconditions.checkNotNull(mSignatures);</span><br><span class="line">    Preconditions.checkNotNull(mResolvedBaseFile);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (!mPermissionsAccepted) &#123; <span class="comment">// 这里我们就跳过，不分析，install 的时候分析过！</span></span><br><span class="line">        <span class="keyword">final</span> Intent intent = <span class="keyword">new</span> Intent(PackageInstaller.ACTION_CONFIRM_PERMISSIONS);</span><br><span class="line">        intent.setPackage(mContext.getPackageManager().getPermissionControllerPackageName());</span><br><span class="line">        intent.putExtra(PackageInstaller.EXTRA_SESSION_ID, sessionId);</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            mRemoteObserver.onUserActionRequired(intent);</span><br><span class="line">        &#125; <span class="keyword">catch</span> (RemoteException ignored) &#123;</span><br><span class="line">        &#125;</span><br><span class="line">        close();</span><br><span class="line">        <span class="keyword">return</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span> (stageCid != <span class="keyword">null</span>) &#123;</span><br><span class="line">        <span class="keyword">final</span> <span class="keyword">long</span> finalSize = calculateInstalledSize();</span><br><span class="line">        resizeContainer(stageCid, finalSize);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//【1】如果安装方式是继承已存在的 apk，那我们要尝试继承！！</span></span><br><span class="line">    <span class="comment">// 显然，对于卸载 split apk 肯定是会走这一步的！！</span></span><br><span class="line">    <span class="keyword">if</span> (params.mode == SessionParams.MODE_INHERIT_EXISTING) &#123;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            <span class="comment">//【1.1】mResolvedInheritedFiles 中都是需要从之前安装的目录下继承过来的 apk 和 odex 文件；</span></span><br><span class="line">            <span class="keyword">final</span> List&lt;File&gt; fromFiles = mResolvedInheritedFiles;</span><br><span class="line">            <span class="comment">//【1.2】这是我们本次安装的目录；</span></span><br><span class="line">            <span class="keyword">final</span> File toDir = resolveStageDir();</span><br><span class="line">            <span class="keyword">if</span> (LOGD) Slog.d(TAG, <span class="string">"Inherited files: "</span> + mResolvedInheritedFiles);</span><br><span class="line">            <span class="keyword">if</span> (!mResolvedInheritedFiles.isEmpty() &amp;&amp; mInheritedFilesBase == <span class="keyword">null</span>) &#123;</span><br><span class="line">                <span class="keyword">throw</span> <span class="keyword">new</span> IllegalStateException(<span class="string">"mInheritedFilesBase == null"</span>);</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="comment">//【1.3】如果可以直接建立 link 的话，不行的话，就 copy！</span></span><br><span class="line">            <span class="keyword">if</span> (isLinkPossible(fromFiles, toDir)) &#123;</span><br><span class="line">                <span class="keyword">if</span> (!mResolvedInstructionSets.isEmpty()) &#123;</span><br><span class="line">                    <span class="keyword">final</span> File oatDir = <span class="keyword">new</span> File(toDir, <span class="string">"oat"</span>);</span><br><span class="line">                    createOatDirs(mResolvedInstructionSets, oatDir);</span><br><span class="line">                &#125;</span><br><span class="line">                linkFiles(fromFiles, toDir, mInheritedFilesBase);</span><br><span class="line">            &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                <span class="comment">//【1.4】拷贝已经安装的 apk 到新目录下！</span></span><br><span class="line">                copyFiles(fromFiles, toDir);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125; <span class="keyword">catch</span> (IOException e) &#123;</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> PackageManagerException(INSTALL_FAILED_INSUFFICIENT_STORAGE,</span><br><span class="line">                    <span class="string">"Failed to inherit existing install"</span>, e);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    mInternalProgress = <span class="number">0.5f</span>;</span><br><span class="line">    computeProgressLocked(<span class="keyword">true</span>);</span><br><span class="line">    extractNativeLibraries(mResolvedStageDir, params.abiOverride);</span><br><span class="line">    <span class="keyword">if</span> (stageCid != <span class="keyword">null</span>) &#123;</span><br><span class="line">        finalizeAndFixContainer(stageCid);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">final</span> IPackageInstallObserver2 localObserver = <span class="keyword">new</span> IPackageInstallObserver2.Stub() &#123;</span><br><span class="line">        <span class="meta">@Override</span></span><br><span class="line">        <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onUserActionRequired</span><span class="params">(Intent intent)</span> </span>&#123;</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> IllegalStateException();</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="meta">@Override</span></span><br><span class="line">        <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onPackageInstalled</span><span class="params">(String basePackageName, <span class="keyword">int</span> returnCode, String msg,</span></span></span><br><span class="line"><span class="function"><span class="params">                Bundle extras)</span> </span>&#123;；</span><br><span class="line">            destroyInternal();</span><br><span class="line">            dispatchSessionFinished(returnCode, msg, extras);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;;</span><br><span class="line">    <span class="keyword">final</span> UserHandle user;</span><br><span class="line">    <span class="keyword">if</span> ((params.installFlags &amp; PackageManager.INSTALL_ALL_USERS) != <span class="number">0</span>) &#123;</span><br><span class="line">        user = UserHandle.ALL;</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        user = <span class="keyword">new</span> UserHandle(userId);</span><br><span class="line">    &#125;</span><br><span class="line">    mRelinquished = <span class="keyword">true</span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//【2】开始安装！</span></span><br><span class="line">    mPm.installStage(mPackageName, stageDir, stageCid, localObserver, params,</span><br><span class="line">            installerPackageName, installerUid, user, mCertificates);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>对于卸载 split apk 的情况：</p>
<p>可以看到和 install 是一样的，唯独不一样的是，会将之前已经安装的 /data/app/package-Name/ 中除了要卸载的 split apk 以外的其他 apk 拷贝到新创建的目录下，重新安装；</p>
<h4 id="7-2-4-1-validateInstallLocked"><a href="#7-2-4-1-validateInstallLocked" class="headerlink" title="7.2.4.1 validateInstallLocked"></a>7.2.4.1 validateInstallLocked</h4><p>校验安装有效性，这里的 mResolvedStageDir 就是前面的 /data/app/vmdl[sessionId].tmp 目录！</p>
<p>removeSplitList 用于表示要删除的 split apk 列表：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">validateInstallLocked</span><span class="params">(PackageInfo pkgInfo, ApplicationInfo appInfo)</span></span></span><br><span class="line"><span class="function">        <span class="keyword">throws</span> PackageManagerException </span>&#123;</span><br><span class="line">    mPackageName = <span class="keyword">null</span>;</span><br><span class="line">    mVersionCode = -<span class="number">1</span>;</span><br><span class="line">    mSignatures = <span class="keyword">null</span>;</span><br><span class="line">    mResolvedBaseFile = <span class="keyword">null</span>;</span><br><span class="line">    mResolvedStagedFiles.clear();</span><br><span class="line">    mResolvedInheritedFiles.clear();</span><br><span class="line"></span><br><span class="line">    <span class="comment">//【1】返回 /data/app/vmdl[sessionId].tmp 目录下所有的 .removed 文件！</span></span><br><span class="line">    <span class="comment">// 去除后缀，将前缀名保存到 removeSplitList！</span></span><br><span class="line">    <span class="keyword">final</span> File[] removedFiles = mResolvedStageDir.listFiles(sRemovedFilter);</span><br><span class="line">    <span class="keyword">final</span> List&lt;String&gt; removeSplitList = <span class="keyword">new</span> ArrayList&lt;&gt;();</span><br><span class="line">    <span class="keyword">if</span> (!ArrayUtils.isEmpty(removedFiles)) &#123;</span><br><span class="line">        <span class="keyword">for</span> (File removedFile : removedFiles) &#123;</span><br><span class="line">            <span class="keyword">final</span> String fileName = removedFile.getName();</span><br><span class="line">            <span class="keyword">final</span> String splitName = fileName.substring(</span><br><span class="line">                    <span class="number">0</span>, fileName.length() - REMOVE_SPLIT_MARKER_EXTENSION.length());</span><br><span class="line">            removeSplitList.add(splitName);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">//【2】返回 /data/app/vmdl[sessionId].tmp 目录下所有的非 .removed 文件！</span></span><br><span class="line">    <span class="comment">// 并判断是否正常，如果该目录下没有任何 apk 和 .removed 文件，那么抛出异常！</span></span><br><span class="line">    <span class="keyword">final</span> File[] addedFiles = mResolvedStageDir.listFiles(sAddedFilter);</span><br><span class="line">    <span class="keyword">if</span> (ArrayUtils.isEmpty(addedFiles) &amp;&amp; removeSplitList.size() == <span class="number">0</span>) &#123;</span><br><span class="line">        <span class="keyword">throw</span> <span class="keyword">new</span> PackageManagerException(INSTALL_FAILED_INVALID_APK, <span class="string">"No packages staged"</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">//【3】遍历该目录下的非 .removed 文件，解析其中的 apk 文件，也就是我们之前 copy 到这里的目标文件！</span></span><br><span class="line">    <span class="comment">// 对于卸载 split apk 的情况，显然这里不会进入，因为我们的目录里面只有 .removed 文件！</span></span><br><span class="line">    <span class="keyword">final</span> ArraySet&lt;String&gt; stagedSplits = <span class="keyword">new</span> ArraySet&lt;&gt;();</span><br><span class="line">    <span class="keyword">for</span> (File addedFile : addedFiles) &#123;</span><br><span class="line">        <span class="keyword">final</span> ApkLite apk;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            <span class="comment">//【3.1】解析要安装的 apk，具体的流程这里就不分析了！</span></span><br><span class="line">            apk = PackageParser.parseApkLite(</span><br><span class="line">                    addedFile, PackageParser.PARSE_COLLECT_CERTIFICATES);</span><br><span class="line">        &#125; <span class="keyword">catch</span> (PackageParserException e) &#123;</span><br><span class="line">            <span class="keyword">throw</span> PackageManagerException.from(e);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">//【3.2】将其添加到 stagedSplits 中，注意 base.apk 的 apk.splitName 为 null！</span></span><br><span class="line">        <span class="keyword">if</span> (!stagedSplits.add(apk.splitName)) &#123;</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> PackageManagerException(INSTALL_FAILED_INVALID_APK,</span><br><span class="line">                    <span class="string">"Split "</span> + apk.splitName + <span class="string">" was defined multiple times"</span>);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">//【3.3】将第一个被解析 apk 的包名，版本号，签名，证书保存下载，这个目录下的其他 apk </span></span><br><span class="line">        <span class="comment">// 的这几项要和其保持一致！</span></span><br><span class="line">        <span class="keyword">if</span> (mPackageName == <span class="keyword">null</span>) &#123;</span><br><span class="line">            mPackageName = apk.packageName;</span><br><span class="line">            mVersionCode = apk.versionCode;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">if</span> (mSignatures == <span class="keyword">null</span>) &#123;</span><br><span class="line">            mSignatures = apk.signatures;</span><br><span class="line">            mCertificates = apk.certificates;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">//【3.4】校验 apk 关联性，校验包名。版本号，签名；</span></span><br><span class="line">        assertApkConsistent(String.valueOf(addedFile), apk);</span><br><span class="line">        <span class="comment">//【3.5】设置 apk 文件的目标名称！</span></span><br><span class="line">        <span class="keyword">final</span> String targetName;</span><br><span class="line">        <span class="keyword">if</span> (apk.splitName == <span class="keyword">null</span>) &#123;</span><br><span class="line">            targetName = <span class="string">"base.apk"</span>; <span class="comment">// 一般情况下！</span></span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            targetName = <span class="string">"split_"</span> + apk.splitName + <span class="string">".apk"</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">if</span> (!FileUtils.isValidExtFilename(targetName)) &#123;</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> PackageManagerException(INSTALL_FAILED_INVALID_APK,</span><br><span class="line">                    <span class="string">"Invalid filename: "</span> + targetName);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">//【3.6】当 addedFile 命名不标准的话，会改名;</span></span><br><span class="line">        <span class="keyword">final</span> File targetFile = <span class="keyword">new</span> File(mResolvedStageDir, targetName);</span><br><span class="line">        <span class="keyword">if</span> (!addedFile.equals(targetFile)) &#123;</span><br><span class="line">            addedFile.renameTo(targetFile);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">//【3.7】找到了 base apk，将其保存到 mResolvedBaseFile！</span></span><br><span class="line">        <span class="comment">// 同时将其添加到 mResolvedStagedFiles 中！</span></span><br><span class="line">        <span class="keyword">if</span> (apk.splitName == <span class="keyword">null</span>) &#123;</span><br><span class="line">            mResolvedBaseFile = targetFile;</span><br><span class="line">        &#125;</span><br><span class="line">        mResolvedStagedFiles.add(targetFile);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">//【4】处理 .removed 文件，此时我们正在卸载 split apk，所以会进入这里！！</span></span><br><span class="line">    <span class="keyword">if</span> (removeSplitList.size() &gt; <span class="number">0</span>) &#123;</span><br><span class="line">        <span class="comment">//【4.1】如果找不到该 split apk 文件的话，抛出异常！</span></span><br><span class="line">        <span class="keyword">for</span> (String splitName : removeSplitList) &#123;</span><br><span class="line">            <span class="keyword">if</span> (!ArrayUtils.contains(pkgInfo.splitNames, splitName)) &#123;</span><br><span class="line">                <span class="keyword">throw</span> <span class="keyword">new</span> PackageManagerException(INSTALL_FAILED_INVALID_APK,</span><br><span class="line">                        <span class="string">"Split not found: "</span> + splitName);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">//【4.2】再次获得要安装的应用的包名，版本号，签名！</span></span><br><span class="line">        <span class="keyword">if</span> (mPackageName == <span class="keyword">null</span>) &#123;</span><br><span class="line">            mPackageName = pkgInfo.packageName;</span><br><span class="line">            mVersionCode = pkgInfo.versionCode;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">if</span> (mSignatures == <span class="keyword">null</span>) &#123;</span><br><span class="line">            mSignatures = pkgInfo.signatures;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">//【5】处理安装模式！</span></span><br><span class="line">    <span class="keyword">if</span> (params.mode == SessionParams.MODE_FULL_INSTALL) &#123;</span><br><span class="line">        <span class="comment">//【5.1】全量安装必须要有 base.apk</span></span><br><span class="line">        <span class="keyword">if</span> (!stagedSplits.contains(<span class="keyword">null</span>)) &#123;</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> PackageManagerException(INSTALL_FAILED_INVALID_APK,</span><br><span class="line">                    <span class="string">"Full install must include a base package"</span>);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        <span class="comment">//【5.2】部分安装必须基于现有的安装！</span></span><br><span class="line">        <span class="keyword">if</span> (appInfo == <span class="keyword">null</span>) &#123;</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> PackageManagerException(INSTALL_FAILED_INVALID_APK,</span><br><span class="line">                    <span class="string">"Missing existing base package for "</span> + mPackageName);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">//【5.3】获得已存在的 apk 安装信息！</span></span><br><span class="line">        <span class="keyword">final</span> PackageLite existing;</span><br><span class="line">        <span class="keyword">final</span> ApkLite existingBase;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            <span class="comment">//【5.3.1】对于安装 split apk，我们会解析下已存在的 split apk！！</span></span><br><span class="line">            existing = PackageParser.parsePackageLite(<span class="keyword">new</span> File(appInfo.getCodePath()), <span class="number">0</span>);</span><br><span class="line">            existingBase = PackageParser.parseApkLite(<span class="keyword">new</span> File(appInfo.getBaseCodePath()),</span><br><span class="line">                    PackageParser.PARSE_COLLECT_CERTIFICATES);</span><br><span class="line">        &#125; <span class="keyword">catch</span> (PackageParserException e) &#123;</span><br><span class="line">            <span class="keyword">throw</span> PackageManagerException.from(e);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">//【*4.3.2.1】再次校验要本次要安装的 apk 和已存在的 apk 是有关联，包括包名，签名，版本号！</span></span><br><span class="line">        assertApkConsistent(<span class="string">"Existing base"</span>, existingBase);</span><br><span class="line">        <span class="comment">//【5.4】继承已有的 base apk，如果没有指定安装的 apk！！</span></span><br><span class="line">        <span class="keyword">if</span> (mResolvedBaseFile == <span class="keyword">null</span>) &#123;</span><br><span class="line">            mResolvedBaseFile = <span class="keyword">new</span> File(appInfo.getBaseCodePath());</span><br><span class="line">            mResolvedInheritedFiles.add(mResolvedBaseFile);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">//【5.5】继承已有的 split apk！！</span></span><br><span class="line">        <span class="keyword">if</span> (!ArrayUtils.isEmpty(existing.splitNames)) &#123;</span><br><span class="line">            <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; existing.splitNames.length; i++) &#123;</span><br><span class="line">                <span class="keyword">final</span> String splitName = existing.splitNames[i];</span><br><span class="line">                <span class="keyword">final</span> File splitFile = <span class="keyword">new</span> File(existing.splitCodePaths[i]);</span><br><span class="line">                <span class="keyword">final</span> <span class="keyword">boolean</span> splitRemoved = removeSplitList.contains(splitName);</span><br><span class="line">                <span class="keyword">if</span> (!stagedSplits.contains(splitName) &amp;&amp; !splitRemoved) &#123;</span><br><span class="line">                    mResolvedInheritedFiles.add(splitFile);</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">//【5.6】继承已有的 oat 相关文件！！</span></span><br><span class="line">        <span class="keyword">final</span> File packageInstallDir = (<span class="keyword">new</span> File(appInfo.getBaseCodePath())).getParentFile();</span><br><span class="line">        mInheritedFilesBase = packageInstallDir;</span><br><span class="line">        <span class="keyword">final</span> File oatDir = <span class="keyword">new</span> File(packageInstallDir, <span class="string">"oat"</span>);</span><br><span class="line">        <span class="keyword">if</span> (oatDir.exists()) &#123;</span><br><span class="line">            <span class="keyword">final</span> File[] archSubdirs = oatDir.listFiles();</span><br><span class="line">            <span class="keyword">if</span> (archSubdirs != <span class="keyword">null</span> &amp;&amp; archSubdirs.length &gt; <span class="number">0</span>) &#123;</span><br><span class="line">                <span class="keyword">final</span> String[] instructionSets = InstructionSets.getAllDexCodeInstructionSets();</span><br><span class="line">                <span class="keyword">for</span> (File archSubDir : archSubdirs) &#123;</span><br><span class="line">                    <span class="comment">// Skip any directory that isn't an ISA subdir.</span></span><br><span class="line">                    <span class="keyword">if</span> (!ArrayUtils.contains(instructionSets, archSubDir.getName())) &#123;</span><br><span class="line">                        <span class="keyword">continue</span>;</span><br><span class="line">                    &#125;</span><br><span class="line">                    <span class="comment">// 将要继承的 oat 目录文件名添加到 mResolvedInstructionSets！</span></span><br><span class="line">                    mResolvedInstructionSets.add(archSubDir.getName());</span><br><span class="line">                    List&lt;File&gt; oatFiles = Arrays.asList(archSubDir.listFiles());</span><br><span class="line">                    <span class="keyword">if</span> (!oatFiles.isEmpty()) &#123;</span><br><span class="line">                        <span class="comment">// 将要继承的 odex 相关文件添加到 mResolvedInheritedFiles！</span></span><br><span class="line">                        mResolvedInheritedFiles.addAll(oatFiles);</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>其实这里，我们可以看到。对于卸载 split apk 的情况，我们会收集之前安装的目录下的所有不再 remove 列表中的 apk 文件到 mResolvedInheritedFiles 集合中！</p>
</div></article><div class="post-copyright"><div class="post-copyright__author"><span class="post-copyright-meta">文章作者: </span><span class="post-copyright-info"><a href="mailto:undefined">Coolqi.Li</a></span></div><div class="post-copyright__type"><span class="post-copyright-meta">文章链接: </span><span class="post-copyright-info"><a href="https://coolqi.top/2018/09/01/PMS9-uninstallThroughAdb/">https://coolqi.top/2018/09/01/PMS9-uninstallThroughAdb/</a></span></div><div class="post-copyright__notice"><span class="post-copyright-meta">版权声明: </span><span class="post-copyright-info">本博客所有文章除特别声明外，均采用 <a href="https://creativecommons.org/licenses/by-nc-sa/4.0/">CC BY-NC-SA 4.0</a> 许可协议。转载请注明来自 <a href="https://coolqi.top">Coolqi`s Blog</a>！</span></div></div><div class="post-meta__tag-list"><a class="post-meta__tags" href="/tags/PackageManager包管理/">PackageManager包管理</a></div><div class="post-qr-code"><div class="post-qr-code-item"><img class="post-qr-code__img" src="/img/zfb.jpg"><div class="post-qr-code__desc">支付宝打赏</div></div><div class="post-qr-code-item"><img class="post-qr-code__img" src="/img/wechat.jpg"><div class="post-qr-code__desc">微信打赏</div></div></div><div class="social-share"></div><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/social-share.js@1.0.16/dist/css/share.min.css"><script src="https://cdn.jsdelivr.net/npm/social-share.js@1.0.16/dist/js/social-share.min.js"></script><nav id="pagination"><div class="prev-post pull-left"><a href="/2018/09/10/PMS10-unisntallThroughPackageInstaller/"><i class="fa fa-chevron-left">  </i><span>PMS 第 10 篇 - 通过 PackageInstaller 分析 uninstall 过程</span></a></div><div class="next-post pull-right"><a href="/2018/07/23/PMS8-installThroughtPackageInstaller/"><span>PMS 第 8 篇 - 通过 PackageInstaller 分析 Install 过程</span><i class="fa fa-chevron-right"></i></a></div></nav><div class="post-adv"><a href="https://www.vultr.com/?ref=7231808"><img src="https://www.vultr.com/media/banner_1.png" width="728" height="90"></a></div></div></div><footer><div class="layout" id="footer"><div class="copyright">&copy;2015 - 2019 By Coolqi.Li</div><div class="framework-info"><span>驱动 - </span><a href="http://hexo.io"><span>Hexo</span></a><span class="footer-separator">|</span><span>主题 - </span><a href="https://github.com/Molunerfinn/hexo-theme-melody"><span>Melody</span></a></div><div class="footer_custom_text">Hi, welcome to my <a href="https://lishuaiqi.top/">blog</a>!</div><div class="busuanzi"><script async src="https://busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script><span id="busuanzi_container_page_pv"><i class="fa fa-file-o"></i><span id="busuanzi_value_page_pv"></span><span></span></span></div></div></footer><i class="fa fa-arrow-up" id="go-up" aria-hidden="true"></i><script src="/js/third-party/anime.min.js"></script><script src="/js/third-party/jquery.min.js"></script><script src="/js/third-party/jquery.fancybox.min.js"></script><script src="/js/third-party/velocity.min.js"></script><script src="/js/third-party/velocity.ui.min.js"></script><script src="/js/utils.js?version=1.5.6"></script><script src="/js/fancybox.js?version=1.5.6"></script><script src="/js/sidebar.js?version=1.5.6"></script><script src="/js/copy.js?version=1.5.6"></script><script src="/js/fireworks.js?version=1.5.6"></script><script src="/js/transition.js?version=1.5.6"></script><script src="/js/scroll.js?version=1.5.6"></script><script src="/js/head.js?version=1.5.6"></script><script type="text/x-mathjax-config">MathJax.Hub.Config({
  tex2jax: {
    inlineMath: [ ['$','$'], ["\\(","\\)"]  ],
    processEscapes: true,
    skipTags: ['script', 'noscript', 'style', 'textarea', 'pre', 'code']
  },
  CommonHTML: {
    linebreaks: { automatic: true, width: "90% container" }
  },
  "HTML-CSS": { 
    linebreaks: { automatic: true, width: "90% container" }
  },
  "SVG": { 
    linebreaks: { automatic: true, width: "90% container" }
  }
});
</script><script type="text/x-mathjax-config">MathJax.Hub.Queue(function() {
  var all = MathJax.Hub.getAllJax(), i;
  for (i=0; i < all.length; i += 1) {
    all[i].SourceElement().parentNode.className += ' has-jax';
  }
});
</script><script src="https://cdn.jsdelivr.net/npm/mathjax/MathJax.js?config=TeX-AMS-MML_HTMLorMML"></script><script src="/js/search/local-search.js"></script><div class="search-dialog" id="local-search"><div class="search-dialog__title" id="local-search-title">本地搜索</div><div id="local-input-panel"><div id="local-search-input"><div class="local-search-box"><input class="local-search-box--input" placeholder="搜索文章"></div></div></div><hr><div id="local-search-results"><div id="local-hits"></div><div id="local-stats"><div class="local-search-stats__hr" id="hr"><span>由</span> <a href="https://github.com/wzpan/hexo-generator-search" style="color:#49B1F5;">hexo-generator-search</a>
 <span>提供支持</span></div></div></div><span class="search-close-button"><i class="fa fa-times"></i></span></div><div class="search-mask"></div><script src="/live2dw/lib/L2Dwidget.min.js?0c58a1486de42ac6cc1c59c7d98ae887"></script><script>L2Dwidget.init({"pluginRootPath":"live2dw/","pluginJsPath":"lib/","pluginModelPath":"assets/","tagMode":false,"debug":false,"model":{"jsonPath":"live2d-widget-model-hijiki"},"display":{"position":"right","width":110,"height":220},"mobile":{"show":false},"log":false});</script></body></html>
<!DOCTYPE html><html lang="zh-Hans"><head><meta charset="UTF-8"><meta http-equiv="X-UA-Compatible" content="IE=edge"><meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1"><meta name="description" content="PMS 第 3 篇 - PMS_SYSTEM_SCAN_START 阶段"><meta name="keywords" content="PackageManager包管理"><meta name="author" content="Coolqi.Li,undefined"><meta name="copyright" content="Coolqi.Li"><title>PMS 第 3 篇 - PMS_SYSTEM_SCAN_START 阶段 | Coolqi`s Blog</title><link rel="shortcut icon" href="/img/favicon.ico"><link rel="stylesheet" href="/css/index.css?version=1.5.6"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/font-awesome@4.7.0/css/font-awesome.min.css?version=1.5.6"><link rel="dns-prefetch" href="https://cdn.staticfile.org"><link rel="dns-prefetch" href="https://cdn.bootcss.com"><link rel="dns-prefetch" href="https://creativecommons.org"><script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script><script>(adsbygoogle = window.adsbygoogle || []).push({
  google_ad_client: 'ca-pub-6845729157331145',
  enable_page_level_ads: 'true'
});
</script><link rel="dns-prefetch" href="https://hm.baidu.com"><script>var _hmt = _hmt || [];
(function() {
  var hm = document.createElement("script");
  hm.src = "https://hm.baidu.com/hm.js?b7acef5306e54116ad8a99e8b753a92d";
  var s = document.getElementsByTagName("script")[0]; 
  s.parentNode.insertBefore(hm, s);
})();</script><script>var GLOBAL_CONFIG = { 
  root: '/',
  algolia: undefined,
  localSearch: {"path":"search.xml","languages":{"hits_empty":"找不到您查询的内容:${query}"}},
  copy: {
    success: '复制成功',
    error: '复制错误',
    noSupport: '浏览器不支持'
  }
} </script></head><body><i class="fa fa-arrow-right" id="toggle-sidebar" aria-hidden="true"></i><div id="sidebar"><div class="toggle-sidebar-info text-center"><span data-toggle="切换文章详情">切换站点概览</span><hr></div><div class="sidebar-toc"><div class="sidebar-toc__title">目录</div><div class="sidebar-toc__progress"><span class="progress-notice">你已经读了</span><span class="progress-num">0</span><span class="progress-percentage">%</span><div class="sidebar-toc__progress-bar"></div></div><div class="sidebar-toc__content"><ol class="toc"><li class="toc-item toc-level-1"><a class="toc-link" href="#0-综述"><span class="toc-text">0 综述</span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#1-对共享库执行-odex-操作"><span class="toc-text">1 对共享库执行 odex 操作</span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#2-系统目录扫描-开始阶段"><span class="toc-text">2 系统目录扫描 - 开始阶段</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#2-1-PMS-scanDirTracedLI"><span class="toc-text">2.1 PMS.scanDirTracedLI</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#2-2-PMS-scanDirLI"><span class="toc-text">2.2 PMS.scanDirLI</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#2-3-PMS-scanPackageTracedLI"><span class="toc-text">2.3 PMS.scanPackageTracedLI</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#2-4-PMS-scanPackageLI"><span class="toc-text">2.4 PMS.scanPackageLI</span></a></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#3-系统目录扫描-扫描阶段"><span class="toc-text">3 系统目录扫描 - 扫描阶段</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#3-1-PParser-parsePackage"><span class="toc-text">3.1 PParser.parsePackage</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#3-1-1-PParser-parseClusterPackage"><span class="toc-text">3.1.1 PParser.parseClusterPackage</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#3-1-1-1-PParser-parseClusterPackageLite"><span class="toc-text">3.1.1.1 PParser.parseClusterPackageLite</span></a><ol class="toc-child"><li class="toc-item toc-level-5"><a class="toc-link" href="#3-1-1-1-1-PParser-parseApkLite-2"><span class="toc-text">3.1.1.1.1 PParser.parseApkLite[2]</span></a><ol class="toc-child"><li class="toc-item toc-level-6"><a class="toc-link" href="#3-1-1-1-1-1-PParser-parseApkLite-7"><span class="toc-text">3.1.1.1.1.1 PParser.parseApkLite[7]</span></a></li><li class="toc-item toc-level-6"><a class="toc-link" href="#3-1-1-1-1-2-PParser-parsePackageSplitNames"><span class="toc-text">3.1.1.1.1.2 PParser.parsePackageSplitNames</span></a></li><li class="toc-item toc-level-6"><a class="toc-link" href="#3-1-1-1-1-3-new-ApkLite"><span class="toc-text">3.1.1.1.1.3 new ApkLite</span></a></li></ol></li><li class="toc-item toc-level-5"><a class="toc-link" href="#3-1-1-1-2-new-PackageLite"><span class="toc-text">3.1.1.1.2 new PackageLite</span></a></li></ol></li><li class="toc-item toc-level-4"><a class="toc-link" href="#3-1-1-2-PParser-parseBaseApk-3"><span class="toc-text">3.1.1.2 PParser.parseBaseApk[3]</span></a><ol class="toc-child"><li class="toc-item toc-level-5"><a class="toc-link" href="#3-1-1-2-1-PParser-parseBaseApk-4"><span class="toc-text">3.1.1.2.1 PParser.parseBaseApk[4]</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#3-1-1-2-2-PParser-parseBaseApkCommon-6"><span class="toc-text">3.1.1.2.2 PParser.parseBaseApkCommon [6]</span></a><ol class="toc-child"><li class="toc-item toc-level-6"><a class="toc-link" href="#3-1-1-2-2-1-PParser-parsePermissionGroup-解析-permission-group"><span class="toc-text">3.1.1.2.2.1 PParser.parsePermissionGroup - 解析 permission-group</span></a></li><li class="toc-item toc-level-6"><a class="toc-link" href="#3-1-1-2-2-2-PParser-parsePermission-解析-permission"><span class="toc-text">3.1.1.2.2.2 PParser.parsePermission - 解析 permission</span></a></li><li class="toc-item toc-level-6"><a class="toc-link" href="#3-1-1-2-2-3-PParser-parsePermissionTree-解析-permission-tree"><span class="toc-text">3.1.1.2.2.3 PParser.parsePermissionTree - 解析 permission-tree</span></a></li><li class="toc-item toc-level-6"><a class="toc-link" href="#3-1-1-2-2-4-PParser-parseUsesPermission-解析-uses-permission"><span class="toc-text">3.1.1.2.2.4 PParser.parseUsesPermission - 解析 uses-permission</span></a></li></ol></li><li class="toc-item toc-level-5"><a class="toc-link" href="#3-1-1-2-3-PParser-parseBaseApplication"><span class="toc-text">3.1.1.2.3 PParser.parseBaseApplication</span></a><ol class="toc-child"><li class="toc-item toc-level-6"><a class="toc-link" href="#3-1-1-2-3-1-PParser-parseActivity-解析-activity-和-receiver"><span class="toc-text">3.1.1.2.3.1 PParser.parseActivity - 解析 activity 和 receiver</span></a></li><li class="toc-item toc-level-6"><a class="toc-link" href="#3-1-1-2-3-4-PParser-parseIntent-解析-intent-filter"><span class="toc-text">3.1.1.2.3.4 PParser.parseIntent - 解析 intent-filter</span></a></li></ol></li></ol></li><li class="toc-item toc-level-4"><a class="toc-link" href="#3-1-1-3-PParser-parseSplitApk-4"><span class="toc-text">3.1.1.3 PParser.parseSplitApk[4]</span></a><ol class="toc-child"><li class="toc-item toc-level-5"><a class="toc-link" href="#3-1-1-3-1-PParser-parseSplitApk-5"><span class="toc-text">3.1.1.3.1 PParser.parseSplitApk[5]</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#3-1-1-3-2-PParser-parseSplitApplication"><span class="toc-text">3.1.1.3.2 PParser.parseSplitApplication</span></a></li></ol></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#3-1-2-PParser-parseMonolithicPackage"><span class="toc-text">3.1.2 PParser.parseMonolithicPackage</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#3-1-2-1-PParser-parseMonolithicPackageLite"><span class="toc-text">3.1.2.1 PParser.parseMonolithicPackageLite</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#3-1-3-Package"><span class="toc-text">3.1.3 Package</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#3-2-PMS-scanPackageLI"><span class="toc-text">3.2 PMS.scanPackageLI</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#3-2-1-PMS-scanPackageInternalLI"><span class="toc-text">3.2.1 PMS.scanPackageInternalLI</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#3-2-1-1-Settings-peekPackageLPr"><span class="toc-text">3.2.1.1 Settings.peekPackageLPr</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#3-2-1-2-Settings-getDisabledSystemPkgLPr"><span class="toc-text">3.2.1.2 Settings.getDisabledSystemPkgLPr</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#3-2-1-3-Settings-removeDisabledSystemPackageLPw"><span class="toc-text">3.2.1.3 Settings.removeDisabledSystemPackageLPw</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#3-2-1-4-Settings-enableSystemPackageLPw"><span class="toc-text">3.2.1.4 Settings.enableSystemPackageLPw</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#3-2-1-6-PMS-deletePackageLIF"><span class="toc-text">3.2.1.6 PMS.deletePackageLIF</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#3-2-1-7-PMS-scanPackageLI"><span class="toc-text">3.2.1.7 PMS.scanPackageLI</span></a><ol class="toc-child"><li class="toc-item toc-level-5"><a class="toc-link" href="#3-2-1-7-1-PMS-scanPackageDirtyLI"><span class="toc-text">3.2.1.7.1 *PMS.scanPackageDirtyLI</span></a><ol class="toc-child"><li class="toc-item toc-level-6"><a class="toc-link" href="#3-2-1-7-1-1-Settings-getPackageLPw"><span class="toc-text">3.2.1.7.1.1 Settings.getPackageLPw</span></a></li><li class="toc-item toc-level-6"><a class="toc-link" href="#3-2-1-7-1-2-Settings-insertPackageSettingLPw"><span class="toc-text">3.2.1.7.1.2 Settings.insertPackageSettingLPw</span></a></li></ol></li></ol></li><li class="toc-item toc-level-4"><a class="toc-link" href="#3-2-1-8-Settings-disableSystemPackageLPw"><span class="toc-text">3.2.1.8 Settings.disableSystemPackageLPw</span></a><ol class="toc-child"><li class="toc-item toc-level-5"><a class="toc-link" href="#3-2-1-8-1-Settings-replacePackageLPw"><span class="toc-text">3.2.1.8.1 Settings.replacePackageLPw</span></a><ol class="toc-child"><li class="toc-item toc-level-6"><a class="toc-link" href="#3-2-1-8-1-1-Settings-replaceUserIdLPw"><span class="toc-text">3.2.1.8.1.1 Settings.replaceUserIdLPw</span></a></li></ol></li></ol></li></ol></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#3-3-扫描总结"><span class="toc-text">3.3 扫描总结</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#3-3-1-扫描过程总结"><span class="toc-text">3.3.1 扫描过程总结</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#3-3-2-数据关系总结"><span class="toc-text">3.3.2 数据关系总结</span></a></li></ol></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#4-系统目录扫描-收尾阶段"><span class="toc-text">4 系统目录扫描 - 收尾阶段</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#4-1-PMS-isDisabledSystemPackageLPr"><span class="toc-text">4.1 PMS.isDisabledSystemPackageLPr</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#4-2-PMS-removePackageLI"><span class="toc-text">4.2 PMS.removePackageLI</span></a></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#5-总结"><span class="toc-text">5 总结</span></a></li></ol></div></div><div class="author-info hide"><div class="author-info__avatar text-center"><img src="/img/avatar.jpg"></div><div class="author-info__name text-center">Coolqi.Li</div><div class="author-info__description text-center">“Hi，我是李帅奇，Android 开发工程师，TeamLeader，熬夜星人，一个努力赚钱，积极向上的好人。”</div><div class="follow-button"><a href="https://github.com/single-li">Follow Me</a></div><hr><div class="author-info-articles"><a class="author-info-articles__archives article-meta" href="/archives"><span class="pull-left">文章</span><span class="pull-right">86</span></a><a class="author-info-articles__tags article-meta" href="/tags"><span class="pull-left">标签</span><span class="pull-right">21</span></a><a class="author-info-articles__categories article-meta" href="/categories"><span class="pull-left">分类</span><span class="pull-right">26</span></a></div><hr><div class="author-info-links"><div class="author-info-links__title text-center">Links</div><a class="author-info-links__name text-center" href="https://developer.android.google.cn/">AndroidDeveloper</a><a class="author-info-links__name text-center" href="http://www.android-studio.org/">AndroidStudio</a><a class="author-info-links__name text-center" href="https://www.jianshu.com/u/123a20a96441">简书</a><a class="author-info-links__name text-center" href="https://weibo.com/coolqiLi">微博</a></div></div></div><div id="content-outer"><div id="top-container" style="background-image: url(https://ws1.sinaimg.cn/large/8700af19ly1fvpabr30o6j22yo1o0q7i.jpg)"><div id="page-header"><span class="pull-left"> <a id="site-name" href="/">Coolqi`s Blog</a></span><i class="fa fa-bars toggle-menu pull-right" aria-hidden="true"></i><span class="pull-right menus"><a class="site-page social-icon search"><i class="fa fa-search"></i><span> 搜索</span></a><a class="site-page" href="/">Home</a><a class="site-page" href="/categories">Categories</a><a class="site-page" href="/tags">Tags</a><a class="site-page" href="/archives">Archives</a><a class="site-page" href="/about">About</a></span></div><div id="post-info"><div id="post-title">PMS 第 3 篇 - PMS_SYSTEM_SCAN_START 阶段</div><div id="post-meta"><time class="post-meta__date"><i class="fa fa-calendar" aria-hidden="true"></i> 2018-02-05</time><span class="post-meta__separator">|</span><i class="fa fa-inbox post-meta__icon" aria-hidden="true"></i><a class="post-meta__categories" href="/categories/AndroidFramework源码分析/">AndroidFramework源码分析</a><i class="fa fa-angle-right" aria-hidden="true"></i><i class="fa fa-inbox post-meta__icon" aria-hidden="true"></i><a class="post-meta__categories" href="/categories/AndroidFramework源码分析/PackageManager包管理/">PackageManager包管理</a><div class="post-meta-wordcount"><span>字数总计: </span><span class="word-count">28.2k</span><span class="post-meta__separator">|</span><span>阅读时长: 146 分钟</span></div></div></div></div><div class="layout" id="content-inner"><article id="post"><div class="article-container" id="post-content"><p>[toc]</p>
<p>基于 Android 7.1.1 源码分析 PackageManagerService 的架构和逻辑实现，本文是作者原创，转载请说明出处！</p>
<h1 id="0-综述"><a href="#0-综述" class="headerlink" title="0 综述"></a>0 综述</h1><p>我们进入第二阶段系统目录扫描来分析，代码比较长，我们来回顾下该阶段的流程：<br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br><span class="line">212</span><br><span class="line">213</span><br></pre></td><td class="code"><pre><span class="line">... ... ... ...<span class="comment">// 接上面</span></span><br><span class="line"><span class="keyword">long</span> startTime = SystemClock.uptimeMillis();</span><br><span class="line"> </span><br><span class="line">EventLog.writeEvent(EventLogTags.BOOT_PROGRESS_PMS_SYSTEM_SCAN_START,</span><br><span class="line">        startTime);</span><br><span class="line"></span><br><span class="line"><span class="comment">// 设置扫描参数！</span></span><br><span class="line"><span class="keyword">final</span> <span class="keyword">int</span> scanFlags = SCAN_NO_PATHS | SCAN_DEFER_DEX | SCAN_BOOTING | SCAN_INITIAL;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 获得环境变量：BOOTCLASSPATH 和 SYSTEMSERVERCLASSPATH！</span></span><br><span class="line"><span class="keyword">final</span> String bootClassPath = System.getenv(<span class="string">"BOOTCLASSPATH"</span>);</span><br><span class="line"><span class="keyword">final</span> String systemServerClassPath = System.getenv(<span class="string">"SYSTEMSERVERCLASSPATH"</span>);</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> (bootClassPath == <span class="keyword">null</span>) &#123;</span><br><span class="line">    Slog.w(TAG, <span class="string">"No BOOTCLASSPATH found!"</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> (systemServerClassPath == <span class="keyword">null</span>) &#123;</span><br><span class="line">    Slog.w(TAG, <span class="string">"No SYSTEMSERVERCLASSPATH found!"</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 获得系统指令集合！</span></span><br><span class="line"><span class="keyword">final</span> List&lt;String&gt; allInstructionSets = InstructionSets.getAllInstructionSets();</span><br><span class="line"><span class="keyword">final</span> String[] dexCodeInstructionSets =</span><br><span class="line">        getDexCodeInstructionSets(</span><br><span class="line">                allInstructionSets.toArray(<span class="keyword">new</span> String[allInstructionSets.size()]));</span><br><span class="line"></span><br><span class="line"><span class="comment">// 对所有的共享库执行 odex 操作！</span></span><br><span class="line"><span class="keyword">if</span> (mSharedLibraries.size() &gt; <span class="number">0</span>) &#123;</span><br><span class="line">    <span class="keyword">for</span> (String dexCodeInstructionSet : dexCodeInstructionSets) &#123;</span><br><span class="line">        <span class="keyword">for</span> (SharedLibraryEntry libEntry : mSharedLibraries.values()) &#123;</span><br><span class="line">            <span class="keyword">final</span> String lib = libEntry.path;</span><br><span class="line">            <span class="keyword">if</span> (lib == <span class="keyword">null</span>) &#123;</span><br><span class="line">                <span class="keyword">continue</span>;</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            <span class="keyword">try</span> &#123;</span><br><span class="line">                <span class="comment">// Shared libraries do not have profiles so we perform a full</span></span><br><span class="line">                <span class="comment">// AOT compilation (if needed).</span></span><br><span class="line">                <span class="keyword">int</span> dexoptNeeded = DexFile.getDexOptNeeded(</span><br><span class="line">                        lib, dexCodeInstructionSet,</span><br><span class="line">                        getCompilerFilterForReason(REASON_SHARED_APK),</span><br><span class="line">                        <span class="keyword">false</span> <span class="comment">/* newProfile */</span>);</span><br><span class="line"></span><br><span class="line">                <span class="keyword">if</span> (dexoptNeeded != DexFile.NO_DEXOPT_NEEDED) &#123;</span><br><span class="line">                    mInstaller.dexopt(lib, Process.SYSTEM_UID, dexCodeInstructionSet,</span><br><span class="line">                            dexoptNeeded, DEXOPT_PUBLIC <span class="comment">/*dexFlags*/</span>,</span><br><span class="line">                            getCompilerFilterForReason(REASON_SHARED_APK),</span><br><span class="line">                            StorageManager.UUID_PRIVATE_INTERNAL,</span><br><span class="line">                            SKIP_SHARED_LIBRARY_CHECK);</span><br><span class="line">                &#125;</span><br><span class="line">            &#125; <span class="keyword">catch</span> (FileNotFoundException e) &#123;</span><br><span class="line">                Slog.w(TAG, <span class="string">"Library not found: "</span> + lib);</span><br><span class="line">            &#125; <span class="keyword">catch</span> (IOException | InstallerException e) &#123;</span><br><span class="line">                Slog.w(TAG, <span class="string">"Cannot dexopt "</span> + lib + <span class="string">"; is it an APK or JAR? "</span></span><br><span class="line">                        + e.getMessage());</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 获得目录 /system/framework，对其目录下的文件进行优化 !</span></span><br><span class="line">File frameworkDir = <span class="keyword">new</span> File(Environment.getRootDirectory(), <span class="string">"framework"</span>);</span><br><span class="line"></span><br><span class="line"><span class="comment">// 获得系统版本信息</span></span><br><span class="line"><span class="keyword">final</span> VersionInfo ver = mSettings.getInternalVersion();</span><br><span class="line"></span><br><span class="line"><span class="comment">// 判断是否是 OTA 升级，如果当前版本的指纹与历史版本的指纹信息不一致，表示当前版本是一次 OTA 升级上来更新版本！</span></span><br><span class="line">mIsUpgrade = !Build.FINGERPRINT.equals(ver.fingerprint);</span><br><span class="line"></span><br><span class="line"><span class="comment">// 判断是否是从 Android M 之前的版本升级过来的，如果是就需要把系统 app 的权限从安装时提高到运行时！</span></span><br><span class="line">mPromoteSystemApps =</span><br><span class="line">        mIsUpgrade &amp;&amp; ver.sdkVersion &lt;= Build.VERSION_CODES.LOLLIPOP_MR1;</span><br><span class="line"></span><br><span class="line"><span class="comment">// When upgrading from pre-N, we need to handle package extraction like first boot,</span></span><br><span class="line"><span class="comment">// as there is no profiling data available.</span></span><br><span class="line"><span class="comment">// 判断是否是从 Android 7.0 升级过来的！</span></span><br><span class="line">mIsPreNUpgrade = mIsUpgrade &amp;&amp; ver.sdkVersion &lt; Build.VERSION_CODES.N;</span><br><span class="line"></span><br><span class="line">mIsPreNMR1Upgrade = mIsUpgrade &amp;&amp; ver.sdkVersion &lt; Build.VERSION_CODES.N_MR1;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 保存从 Android 6.0 升级前已经存在的系统应用，并对他们进行优先扫描！</span></span><br><span class="line"><span class="comment">// 扫描过程会将安装时权限变为运行时权限！</span></span><br><span class="line"><span class="keyword">if</span> (mPromoteSystemApps) &#123;</span><br><span class="line">    Iterator&lt;PackageSetting&gt; pkgSettingIter = mSettings.mPackages.values().iterator();</span><br><span class="line">    <span class="keyword">while</span> (pkgSettingIter.hasNext()) &#123;</span><br><span class="line">        PackageSetting ps = pkgSettingIter.next();</span><br><span class="line">        <span class="keyword">if</span> (isSystemApp(ps)) &#123;</span><br><span class="line">            mExistingSystemPackages.add(ps.name);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">//【1】扫描收集目录 /vendor/overlay 下的供应商应用包！</span></span><br><span class="line">File vendorOverlayDir = <span class="keyword">new</span> File(VENDOR_OVERLAY_DIR);</span><br><span class="line">scanDirTracedLI(vendorOverlayDir, mDefParseFlags</span><br><span class="line">        | PackageParser.PARSE_IS_SYSTEM</span><br><span class="line">        | PackageParser.PARSE_IS_SYSTEM_DIR</span><br><span class="line">        | PackageParser.PARSE_TRUSTED_OVERLAY, scanFlags | SCAN_TRUSTED_OVERLAY, <span class="number">0</span>);</span><br><span class="line"></span><br><span class="line"><span class="comment">// Find base frameworks (resource packages without code).</span></span><br><span class="line"><span class="comment">//【2】扫描收集目录 /system/framework 下的应用包！ </span></span><br><span class="line">scanDirTracedLI(frameworkDir, mDefParseFlags</span><br><span class="line">        | PackageParser.PARSE_IS_SYSTEM</span><br><span class="line">        | PackageParser.PARSE_IS_SYSTEM_DIR</span><br><span class="line">        | PackageParser.PARSE_IS_PRIVILEGED,</span><br><span class="line">        scanFlags | SCAN_NO_DEX, <span class="number">0</span>);</span><br><span class="line"></span><br><span class="line"><span class="comment">//【3】扫描收集目录 /system/priv-app 下的应用包！ </span></span><br><span class="line"><span class="keyword">final</span> File privilegedAppDir = <span class="keyword">new</span> File(Environment.getRootDirectory(), <span class="string">"priv-app"</span>);</span><br><span class="line">scanDirTracedLI(privilegedAppDir, mDefParseFlags</span><br><span class="line">        | PackageParser.PARSE_IS_SYSTEM</span><br><span class="line">        | PackageParser.PARSE_IS_SYSTEM_DIR</span><br><span class="line">        | PackageParser.PARSE_IS_PRIVILEGED, scanFlags, <span class="number">0</span>);</span><br><span class="line"></span><br><span class="line"><span class="comment">//【4】扫描收集目录 /system/app 下的应用包！ </span></span><br><span class="line"><span class="keyword">final</span> File systemAppDir = <span class="keyword">new</span> File(Environment.getRootDirectory(), <span class="string">"app"</span>);</span><br><span class="line">scanDirTracedLI(systemAppDir, mDefParseFlags</span><br><span class="line">        | PackageParser.PARSE_IS_SYSTEM</span><br><span class="line">        | PackageParser.PARSE_IS_SYSTEM_DIR, scanFlags, <span class="number">0</span>);</span><br><span class="line"></span><br><span class="line"><span class="comment">//【5】扫描收集目录 /vendor/app 下的应用包！ </span></span><br><span class="line">File vendorAppDir = <span class="keyword">new</span> File(<span class="string">"/vendor/app"</span>);</span><br><span class="line"><span class="keyword">try</span> &#123;</span><br><span class="line">    vendorAppDir = vendorAppDir.getCanonicalFile();</span><br><span class="line">&#125; <span class="keyword">catch</span> (IOException e) &#123;</span><br><span class="line">    <span class="comment">// failed to look up canonical path, continue with original one</span></span><br><span class="line">&#125;</span><br><span class="line">scanDirTracedLI(vendorAppDir, mDefParseFlags</span><br><span class="line">        | PackageParser.PARSE_IS_SYSTEM</span><br><span class="line">        | PackageParser.PARSE_IS_SYSTEM_DIR, scanFlags, <span class="number">0</span>);</span><br><span class="line"></span><br><span class="line"><span class="comment">//【6】扫描收集目录 /oem/app 下的应用包！ </span></span><br><span class="line"><span class="keyword">final</span> File oemAppDir = <span class="keyword">new</span> File(Environment.getOemDirectory(), <span class="string">"app"</span>);</span><br><span class="line">scanDirTracedLI(oemAppDir, mDefParseFlags</span><br><span class="line">        | PackageParser.PARSE_IS_SYSTEM</span><br><span class="line">        | PackageParser.PARSE_IS_SYSTEM_DIR, scanFlags, <span class="number">0</span>);</span><br><span class="line"></span><br><span class="line"><span class="comment">// 收集可能已经被删掉的系统应用包！</span></span><br><span class="line"><span class="keyword">final</span> List&lt;String&gt; possiblyDeletedUpdatedSystemApps = <span class="keyword">new</span> ArrayList&lt;String&gt;();</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> (!mOnlyCore) &#123;</span><br><span class="line">    <span class="comment">// 遍历上一次安装的信息！</span></span><br><span class="line">    Iterator&lt;PackageSetting&gt; psit = mSettings.mPackages.values().iterator();</span><br><span class="line">    <span class="keyword">while</span> (psit.hasNext()) &#123;</span><br><span class="line">        PackageSetting ps = psit.next();</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 如果不是系统应用，跳过！</span></span><br><span class="line">        <span class="keyword">if</span> ((ps.pkgFlags &amp; ApplicationInfo.FLAG_SYSTEM) == <span class="number">0</span>) &#123;</span><br><span class="line">            <span class="keyword">continue</span>;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">final</span> PackageParser.Package scannedPkg = mPackages.get(ps.name);</span><br><span class="line">        <span class="keyword">if</span> (scannedPkg != <span class="keyword">null</span>) &#123;</span><br><span class="line">            <span class="comment">// 如果系统应用包不仅被扫描过（在mPackages中），并且在不可用列表中！</span></span><br><span class="line">            <span class="comment">// 说明一定是通过覆盖更新的，移除之前扫描的结果，保证之前用户安装的应用能够被扫描！</span></span><br><span class="line">            <span class="keyword">if</span> (mSettings.isDisabledSystemPackageLPr(ps.name)) &#123;</span><br><span class="line">                logCriticalInfo(Log.WARN, <span class="string">"Expecting better updated system app for "</span></span><br><span class="line">                        + ps.name + <span class="string">"; removing system app.  Last known codePath="</span></span><br><span class="line">                        + ps.codePathString + <span class="string">", installStatus="</span> + ps.installStatus</span><br><span class="line">                        + <span class="string">", versionCode="</span> + ps.versionCode + <span class="string">"; scanned versionCode="</span></span><br><span class="line">                        + scannedPkg.mVersionCode);</span><br><span class="line">                </span><br><span class="line">                <span class="comment">// 将之前的扫描结果移除！</span></span><br><span class="line">                removePackageLI(scannedPkg, <span class="keyword">true</span>);</span><br><span class="line">                <span class="comment">// 将这包添加到 mExpectingBetter 列表中！</span></span><br><span class="line">                mExpectingBetter.put(ps.name, ps.codePath);</span><br><span class="line">            &#125;</span><br><span class="line">            </span><br><span class="line">            <span class="comment">// 跳出循环，确保不会被删掉！</span></span><br><span class="line">            <span class="keyword">continue</span>;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 如果系统应用包没有被扫描，并且他也不在不可用的列表中，移除它，这个包不存在！</span></span><br><span class="line">        <span class="keyword">if</span> (!mSettings.isDisabledSystemPackageLPr(ps.name)) &#123;</span><br><span class="line">            psit.remove();</span><br><span class="line">            logCriticalInfo(Log.WARN, <span class="string">"System package "</span> + ps.name</span><br><span class="line">                    + <span class="string">" no longer exists; it's data will be wiped"</span>);</span><br><span class="line">            <span class="comment">// Actual deletion of code and data will be handled by later</span></span><br><span class="line">            <span class="comment">// reconciliation step</span></span><br><span class="line"></span><br><span class="line">        &#125; <span class="keyword">else</span> &#123; </span><br><span class="line">            </span><br><span class="line">            <span class="comment">// 如果系统应用包没有被扫描，却在不可用的列表中，就将他加入到 </span></span><br><span class="line">            <span class="comment">// possiblyDeletedUpdatedSystemApps 集合中，需要被删除！</span></span><br><span class="line">            <span class="keyword">final</span> PackageSetting disabledPs = mSettings.getDisabledSystemPkgLPr(ps.name);</span><br><span class="line">            <span class="keyword">if</span> (disabledPs.codePath == <span class="keyword">null</span> || !disabledPs.codePath.exists()) &#123;</span><br><span class="line">                possiblyDeletedUpdatedSystemApps.add(ps.name);</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 清理所有安装不完全的应用包！</span></span><br><span class="line">ArrayList&lt;PackageSetting&gt; deletePkgsList = mSettings.getListOfIncompleteInstallPackagesLPr();</span><br><span class="line"><span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; deletePkgsList.size(); i++) &#123;</span><br><span class="line">    <span class="comment">// Actual deletion of code and data will be handled by later</span></span><br><span class="line">    <span class="comment">// reconciliation step</span></span><br><span class="line">    <span class="keyword">final</span> String packageName = deletePkgsList.get(i).name;</span><br><span class="line">    logCriticalInfo(Log.WARN, <span class="string">"Cleaning up incompletely installed app: "</span> + packageName);</span><br><span class="line">    <span class="keyword">synchronized</span> (mPackages) &#123;</span><br><span class="line">        mSettings.removePackageLPw(packageName);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 移除临时文件</span></span><br><span class="line">deleteTempPackageFiles();</span><br><span class="line"></span><br><span class="line"><span class="comment">// 移除没有和应用程序包相关联的共享用户 id！</span></span><br><span class="line">mSettings.pruneSharedUsersLPw();</span><br><span class="line"> </span><br><span class="line">... ... ... ...<span class="comment">// 见，第三阶段</span></span><br></pre></td></tr></table></figure></p>
<p>主要流程如下：</p>
<ul>
<li>对所有的共享库执行 odex 操作！</li>
<li>扫描手机系统目录信息！</li>
<li>收集那些可能已经不存在的系统应用包，在扫描完 data 分区后再处理！</li>
<li>清理所有安装不完全的应用包！</li>
</ul>
<p>我们接下来继续分析：</p>
<h1 id="1-对共享库执行-odex-操作"><a href="#1-对共享库执行-odex-操作" class="headerlink" title="1 对共享库执行 odex 操作"></a>1 对共享库执行 odex 操作</h1><p>主要代码块如下：<br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 对所有的共享库执行 odex 操作！</span></span><br><span class="line"><span class="keyword">if</span> (mSharedLibraries.size() &gt; <span class="number">0</span>) &#123;</span><br><span class="line">    <span class="keyword">for</span> (String dexCodeInstructionSet : dexCodeInstructionSets) &#123;</span><br><span class="line">        <span class="keyword">for</span> (SharedLibraryEntry libEntry : mSharedLibraries.values()) &#123;</span><br><span class="line">            <span class="keyword">final</span> String lib = libEntry.path;</span><br><span class="line">            <span class="keyword">if</span> (lib == <span class="keyword">null</span>) &#123;</span><br><span class="line">                <span class="keyword">continue</span>;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">try</span> &#123;</span><br><span class="line">                <span class="comment">// Shared libraries do not have profiles so we perform a full</span></span><br><span class="line">                <span class="comment">// AOT compilation (if needed).</span></span><br><span class="line"></span><br><span class="line">                <span class="comment">// 判断共享库是否需要执行 odex 操作</span></span><br><span class="line">                <span class="keyword">int</span> dexoptNeeded = DexFile.getDexOptNeeded(</span><br><span class="line">                        lib, dexCodeInstructionSet,</span><br><span class="line">                        getCompilerFilterForReason(REASON_SHARED_APK),</span><br><span class="line">                        <span class="keyword">false</span> <span class="comment">/* newProfile */</span>);</span><br><span class="line">                </span><br><span class="line">                <span class="comment">// 如果需要 odex 操作，对共享库进行一次预编译（AOT）</span></span><br><span class="line">                <span class="keyword">if</span> (dexoptNeeded != DexFile.NO_DEXOPT_NEEDED) &#123;</span><br><span class="line">                    mInstaller.dexopt(lib, Process.SYSTEM_UID, dexCodeInstructionSet,</span><br><span class="line">                            dexoptNeeded, DEXOPT_PUBLIC <span class="comment">/*dexFlags*/</span>,</span><br><span class="line">                            getCompilerFilterForReason(REASON_SHARED_APK),</span><br><span class="line">                            StorageManager.UUID_PRIVATE_INTERNAL,</span><br><span class="line">                            SKIP_SHARED_LIBRARY_CHECK);</span><br><span class="line">                &#125;</span><br><span class="line">            &#125; <span class="keyword">catch</span> (FileNotFoundException e) &#123;</span><br><span class="line">                Slog.w(TAG, <span class="string">"Library not found: "</span> + lib);</span><br><span class="line">            &#125; <span class="keyword">catch</span> (IOException | InstallerException e) &#123;</span><br><span class="line">                Slog.w(TAG, <span class="string">"Cannot dexopt "</span> + lib + <span class="string">"; is it an APK or JAR? "</span></span><br><span class="line">                        + e.getMessage());</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>主要流程：</p>
<ul>
<li>判断共享库是否需要执行 odex 操作;</li>
<li>如果需要执行 odex 操作，就对共享库进行预（AOT）处理;</li>
</ul>
<h1 id="2-系统目录扫描-开始阶段"><a href="#2-系统目录扫描-开始阶段" class="headerlink" title="2 系统目录扫描 - 开始阶段"></a>2 系统目录扫描 - 开始阶段</h1><p>主要代码如下：<br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 设置扫描参数！</span></span><br><span class="line"><span class="keyword">final</span> <span class="keyword">int</span> scanFlags = SCAN_NO_PATHS | SCAN_DEFER_DEX | SCAN_BOOTING | SCAN_INITIAL;</span><br><span class="line"></span><br><span class="line">... ... ... ...</span><br><span class="line"></span><br><span class="line"><span class="comment">// 扫描收集目录 /vendor/overlay 下的供应商应用包，用于资源替换！！</span></span><br><span class="line">File vendorOverlayDir = <span class="keyword">new</span> File(VENDOR_OVERLAY_DIR);</span><br><span class="line">scanDirTracedLI(vendorOverlayDir, mDefParseFlags</span><br><span class="line">        | PackageParser.PARSE_IS_SYSTEM</span><br><span class="line">        | PackageParser.PARSE_IS_SYSTEM_DIR</span><br><span class="line">        | PackageParser.PARSE_TRUSTED_OVERLAY, scanFlags | SCAN_TRUSTED_OVERLAY, <span class="number">0</span>);</span><br><span class="line"></span><br><span class="line"><span class="comment">// Find base frameworks (resource packages without code).</span></span><br><span class="line"><span class="comment">// 扫描收集目录 /system/framework 下的应用包！ </span></span><br><span class="line">scanDirTracedLI(frameworkDir, mDefParseFlags</span><br><span class="line">        | PackageParser.PARSE_IS_SYSTEM</span><br><span class="line">        | PackageParser.PARSE_IS_SYSTEM_DIR</span><br><span class="line">        | PackageParser.PARSE_IS_PRIVILEGED,</span><br><span class="line">        scanFlags | SCAN_NO_DEX, <span class="number">0</span>);</span><br><span class="line"></span><br><span class="line"><span class="comment">// 扫描收集目录 /system/priv-app 下的应用包！ </span></span><br><span class="line"><span class="keyword">final</span> File privilegedAppDir = <span class="keyword">new</span> File(Environment.getRootDirectory(), <span class="string">"priv-app"</span>);</span><br><span class="line">scanDirTracedLI(privilegedAppDir, mDefParseFlags</span><br><span class="line">        | PackageParser.PARSE_IS_SYSTEM</span><br><span class="line">        | PackageParser.PARSE_IS_SYSTEM_DIR</span><br><span class="line">        | PackageParser.PARSE_IS_PRIVILEGED, scanFlags, <span class="number">0</span>);</span><br><span class="line"></span><br><span class="line"><span class="comment">// 扫描收集目录 /system/app 下的应用包！ </span></span><br><span class="line"><span class="keyword">final</span> File systemAppDir = <span class="keyword">new</span> File(Environment.getRootDirectory(), <span class="string">"app"</span>);</span><br><span class="line">scanDirTracedLI(systemAppDir, mDefParseFlags</span><br><span class="line">        | PackageParser.PARSE_IS_SYSTEM</span><br><span class="line">        | PackageParser.PARSE_IS_SYSTEM_DIR, scanFlags, <span class="number">0</span>);</span><br><span class="line"></span><br><span class="line"><span class="comment">// 扫描收集目录 /vendor/app 下的应用包！ </span></span><br><span class="line">File vendorAppDir = <span class="keyword">new</span> File(<span class="string">"/vendor/app"</span>);</span><br><span class="line"><span class="keyword">try</span> &#123;</span><br><span class="line">    vendorAppDir = vendorAppDir.getCanonicalFile();</span><br><span class="line">&#125; <span class="keyword">catch</span> (IOException e) &#123;</span><br><span class="line">    <span class="comment">// failed to look up canonical path, continue with original one</span></span><br><span class="line">&#125;</span><br><span class="line">scanDirTracedLI(vendorAppDir, mDefParseFlags</span><br><span class="line">        | PackageParser.PARSE_IS_SYSTEM</span><br><span class="line">        | PackageParser.PARSE_IS_SYSTEM_DIR, scanFlags, <span class="number">0</span>);</span><br><span class="line">        </span><br><span class="line"><span class="comment">// 扫描收集目录 /oem/app 下的应用包！ </span></span><br><span class="line"><span class="keyword">final</span> File oemAppDir = <span class="keyword">new</span> File(Environment.getOemDirectory(), <span class="string">"app"</span>);</span><br><span class="line">scanDirTracedLI(oemAppDir, mDefParseFlags</span><br><span class="line">        | PackageParser.PARSE_IS_SYSTEM</span><br><span class="line">        | PackageParser.PARSE_IS_SYSTEM_DIR, scanFlags, <span class="number">0</span>);</span><br></pre></td></tr></table></figure></p>
<p>扫描参数的设置为：int scanFlags = SCAN_NO_PATHS | SCAN_DEFER_DEX | SCAN_BOOTING | SCAN_INITIAL;</p>
<p>按照顺序扫描的目录有：</p>
<ul>
<li><strong>/vendor/overlay</strong></li>
<li><strong>/system/framework</strong></li>
<li><strong>/system/priv-app</strong></li>
<li><strong>/system/app</strong></li>
<li><strong>/vendor/app</strong></li>
<li><strong>/oem/app</strong></li>
</ul>
<p>调用 PMS.scanDirTracedLI 进行扫描，需要注意的是被扫描目录的顺序，这个顺序意味着：先被扫描到的文件，就是最终被用到的文件。</p>
<p>下面我们以 /system/app 目录为例，跟踪系统路径扫描的全过程！！</p>
<h2 id="2-1-PMS-scanDirTracedLI"><a href="#2-1-PMS-scanDirTracedLI" class="headerlink" title="2.1 PMS.scanDirTracedLI"></a>2.1 PMS.scanDirTracedLI</h2><p>调用 scanDirTracedLI 方法进行目录扫描：<br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">scanDirTracedLI</span><span class="params">(File dir, <span class="keyword">final</span> <span class="keyword">int</span> parseFlags, <span class="keyword">int</span> scanFlags, <span class="keyword">long</span> currentTime)</span> </span>&#123;</span><br><span class="line">    Trace.traceBegin(TRACE_TAG_PACKAGE_MANAGER, <span class="string">"scanDir"</span>);</span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">        </span><br><span class="line">        <span class="comment">//【2.2】进一步调用 scanDirLI 方法！</span></span><br><span class="line">        scanDirLI(dir, parseFlags, scanFlags, currentTime);</span><br><span class="line"></span><br><span class="line">    &#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">        Trace.traceEnd(TRACE_TAG_PACKAGE_MANAGER);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<h2 id="2-2-PMS-scanDirLI"><a href="#2-2-PMS-scanDirLI" class="headerlink" title="2.2 PMS.scanDirLI"></a>2.2 PMS.scanDirLI</h2><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">scanDirLI</span><span class="params">(File dir, <span class="keyword">final</span> <span class="keyword">int</span> parseFlags, <span class="keyword">int</span> scanFlags, <span class="keyword">long</span> currentTime)</span> </span>&#123;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// 获得 dir 目录中的文件集合！</span></span><br><span class="line">    <span class="keyword">final</span> File[] files = dir.listFiles();</span><br><span class="line">    <span class="keyword">if</span> (ArrayUtils.isEmpty(files)) &#123;</span><br><span class="line">        Log.d(TAG, <span class="string">"No files in app dir "</span> + dir);</span><br><span class="line">        <span class="keyword">return</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (DEBUG_PACKAGE_SCANNING) &#123;</span><br><span class="line">        Log.d(TAG, <span class="string">"Scanning app dir "</span> + dir + <span class="string">" scanFlags="</span> + scanFlags</span><br><span class="line">                + <span class="string">" flags=0x"</span> + Integer.toHexString(parseFlags));</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// 遍历 dir 目录下的所有文件！</span></span><br><span class="line">    <span class="keyword">for</span> (File file : files) &#123;</span><br><span class="line">        <span class="comment">//【1】判断 file 是否是 Package，必须要同时满足下面 2 个条件：</span></span><br><span class="line">        <span class="comment">// 1、file 以 ".apk" 结尾或者 file 是一个目录；</span></span><br><span class="line">        <span class="comment">// 2、file 不是存储类型的文件；</span></span><br><span class="line">        <span class="keyword">final</span> <span class="keyword">boolean</span> isPackage = (isApkFile(file) || file.isDirectory())</span><br><span class="line">                &amp;&amp; !PackageInstallerService.isStageName(file.getName());</span><br><span class="line">        <span class="keyword">if</span> (!isPackage) &#123;</span><br><span class="line">            <span class="keyword">continue</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">        </span><br><span class="line">            <span class="comment">//【2.3】如果 file 是 package 类型，继续调用 scanPackageTracedLI 进行扫描！</span></span><br><span class="line">            <span class="comment">// 解析参数增加：必须是 apk！</span></span><br><span class="line">            scanPackageTracedLI(file, parseFlags | PackageParser.PARSE_MUST_BE_APK,</span><br><span class="line">                    scanFlags, currentTime, <span class="keyword">null</span>);</span><br><span class="line"> </span><br><span class="line">        &#125; <span class="keyword">catch</span> (PackageManagerException e) &#123;</span><br><span class="line">            Slog.w(TAG, <span class="string">"Failed to parse "</span> + file + <span class="string">": "</span> + e.getMessage());</span><br><span class="line"></span><br><span class="line">             <span class="comment">// 如果扫描 data 分区的 Apk 失败，则删除 data 分区扫描失败的文件</span></span><br><span class="line">            <span class="keyword">if</span> ((parseFlags &amp; PackageParser.PARSE_IS_SYSTEM) == <span class="number">0</span> &amp;&amp;</span><br><span class="line">                    e.error == PackageManager.INSTALL_FAILED_INVALID_APK) &#123;</span><br><span class="line">                logCriticalInfo(Log.WARN, <span class="string">"Deleting invalid package at "</span> + file);</span><br><span class="line">                removeCodePathLI(file);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>注意这里的 try catch 语句，后面方法抛出的异常都是在这个进行 catch 的！</p>
<p>判断 file 是否是 Package，必须要同时满足下面 2 个条件：</p>
<ul>
<li>file 以 “.apk” 结尾或者 file 是一个目录；</li>
<li>file 不是存储类型的文件：<ul>
<li>file 不以 vmdl 开头且不以 .tmp 结尾；</li>
<li>file 不以 smdl 开头且不以 .tmp 结尾；</li>
<li>file 不以 smdl2tmp 开头；</li>
</ul>
</li>
</ul>
<h2 id="2-3-PMS-scanPackageTracedLI"><a href="#2-3-PMS-scanPackageTracedLI" class="headerlink" title="2.3 PMS.scanPackageTracedLI"></a>2.3 PMS.scanPackageTracedLI</h2><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">private</span> PackageParser.<span class="function">Package <span class="title">scanPackageTracedLI</span><span class="params">(File scanFile, <span class="keyword">final</span> <span class="keyword">int</span> parseFlags,</span></span></span><br><span class="line"><span class="function"><span class="params">        <span class="keyword">int</span> scanFlags, <span class="keyword">long</span> currentTime, UserHandle user)</span> <span class="keyword">throws</span> PackageManagerException </span>&#123;</span><br><span class="line">    Trace.traceBegin(TRACE_TAG_PACKAGE_MANAGER, <span class="string">"scanPackage"</span>);</span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line"></span><br><span class="line">        <span class="comment">//【2.4】继续调用 scanPackageLI，执行扫描解析！</span></span><br><span class="line">        <span class="keyword">return</span> scanPackageLI(scanFile, parseFlags, scanFlags, currentTime, user);</span><br><span class="line">    &#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">        Trace.traceEnd(TRACE_TAG_PACKAGE_MANAGER);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>继续：</p>
<h2 id="2-4-PMS-scanPackageLI"><a href="#2-4-PMS-scanPackageLI" class="headerlink" title="2.4 PMS.scanPackageLI"></a>2.4 PMS.scanPackageLI</h2><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">private</span> PackageParser.<span class="function">Package <span class="title">scanPackageLI</span><span class="params">(File scanFile, <span class="keyword">int</span> parseFlags, <span class="keyword">int</span> scanFlags,</span></span></span><br><span class="line"><span class="function"><span class="params">        <span class="keyword">long</span> currentTime, UserHandle user)</span> <span class="keyword">throws</span> PackageManagerException </span>&#123;</span><br><span class="line">    <span class="keyword">if</span> (DEBUG_INSTALL) Slog.d(TAG, <span class="string">"Parsing: "</span> + scanFile);</span><br><span class="line">    </span><br><span class="line">    <span class="comment">//【1】创建一个 PackageParser 对象，用来执行解析操作！</span></span><br><span class="line">    PackageParser pp = <span class="keyword">new</span> PackageParser();</span><br><span class="line">    pp.setSeparateProcesses(mSeparateProcesses);</span><br><span class="line">    pp.setOnlyCoreApps(mOnlyCore); <span class="comment">// mOnlyCore 为 false！</span></span><br><span class="line">    pp.setDisplayMetrics(mMetrics);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> ((scanFlags &amp; SCAN_TRUSTED_OVERLAY) != <span class="number">0</span>) &#123;</span><br><span class="line">        parseFlags |= PackageParser.PARSE_TRUSTED_OVERLAY;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    Trace.traceBegin(TRACE_TAG_PACKAGE_MANAGER, <span class="string">"parsePackage"</span>);</span><br><span class="line">    </span><br><span class="line">    <span class="comment">//【2】PackageParser.Package 用来保存解析结果！</span></span><br><span class="line">    <span class="keyword">final</span> PackageParser.Package pkg;</span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">        </span><br><span class="line">        <span class="comment">//【3.1】开始扫描解析 scanFile，返回解析结果！</span></span><br><span class="line">        pkg = pp.parsePackage(scanFile, parseFlags);</span><br><span class="line">        </span><br><span class="line">    &#125; <span class="keyword">catch</span> (PackageParserException e) &#123;</span><br><span class="line">        <span class="keyword">throw</span> PackageManagerException.from(e);</span><br><span class="line">    &#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">        Trace.traceEnd(TRACE_TAG_PACKAGE_MANAGER);</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">//【3.2】继续扫描！</span></span><br><span class="line">    <span class="keyword">return</span> scanPackageLI(pkg, scanFile, paraseFlags, scanFlags, currentTime, user);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>下面我们来分析扫描的过程！</p>
<h1 id="3-系统目录扫描-扫描阶段"><a href="#3-系统目录扫描-扫描阶段" class="headerlink" title="3 系统目录扫描 - 扫描阶段"></a>3 系统目录扫描 - 扫描阶段</h1><p>下面，我把 PackageParser 简称为 PParser！</p>
<h2 id="3-1-PParser-parsePackage"><a href="#3-1-PParser-parsePackage" class="headerlink" title="3.1 PParser.parsePackage"></a>3.1 PParser.parsePackage</h2><p>参数 flags 为 parseFlags，不同的目录取值不同：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> Package <span class="title">parsePackage</span><span class="params">(File packageFile, <span class="keyword">int</span> flags)</span> <span class="keyword">throws</span> PackageParserException </span>&#123;</span><br><span class="line">    <span class="keyword">if</span> (packageFile.isDirectory()) &#123;</span><br><span class="line">        <span class="comment">//【3.1.1】Android 5.0 以后进入下面的分支！</span></span><br><span class="line">        <span class="keyword">return</span> parseClusterPackage(packageFile, flags);</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;  </span><br><span class="line">        <span class="comment">//【3.1.2】Android 5.0 以前进入下面的分支！</span></span><br><span class="line">        <span class="keyword">return</span> parseMonolithicPackage(packageFile, flags);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>这里有 2 中解析方式：</p>
<ul>
<li>如果 packageFile 是一个目录的话，比如 /system/app/TimeService，那就采用第一种解析方式！</li>
<li>如果 packageFile 是一个非目录文件的话，比如 /system/app/MyService.apk，那就采用第二种解析方式！</li>
</ul>
<p>这里给大家解释一下：</p>
<p>Android 5.0 以前，apk 都是直接位于 app 目录下的，比如：/system/app/MyService.apk；</p>
<p>从 5.0 以后，谷歌引入了 apk 拆分机制，就是支持将一个 apk 拆分成很多个具有相同签名的子 apk，为了支持 apk 拆分，谷歌增加了一级目录：/system/app/MyService/，这个目录里会存放一到多个 apk，比如 base.apk，split.apk；</p>
<p>pms 在解析 package 时，会把多个 apk 的数据封装成一个 Package，加载到内存中！！</p>
<h3 id="3-1-1-PParser-parseClusterPackage"><a href="#3-1-1-PParser-parseClusterPackage" class="headerlink" title="3.1.1 PParser.parseClusterPackage"></a>3.1.1 PParser.parseClusterPackage</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">private</span> Package <span class="title">parseClusterPackage</span><span class="params">(File packageDir, <span class="keyword">int</span> flags)</span> <span class="keyword">throws</span> PackageParserException </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//【3.1.1.1】继续调用 parseClusterPackageLite 对 packageDir 目录下的！</span></span><br><span class="line">    <span class="keyword">final</span> PackageLite lite = parseClusterPackageLite(packageDir, <span class="number">0</span>);</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 根据前面的解析结果，判断是否有核心的应用，如果 lite 中没有核心应用，退出！</span></span><br><span class="line">    <span class="keyword">if</span> (mOnlyCoreApps &amp;&amp; !lite.coreApp) &#123;</span><br><span class="line">        <span class="keyword">throw</span> <span class="keyword">new</span> PackageParserException(INSTALL_PARSE_FAILED_MANIFEST_MALFORMED,</span><br><span class="line">                <span class="string">"Not a coreApp: "</span> + packageDir);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">final</span> AssetManager assets = <span class="keyword">new</span> AssetManager();</span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 装载应用程序的资源到 AssetManager！</span></span><br><span class="line">        loadApkIntoAssetManager(assets, lite.baseCodePath, flags);</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (!ArrayUtils.isEmpty(lite.splitCodePaths)) &#123; <span class="comment">// 如果 apk 被拆分了，加载子 apk 的资源！</span></span><br><span class="line">            <span class="keyword">for</span> (String path : lite.splitCodePaths) &#123;</span><br><span class="line">                loadApkIntoAssetManager(assets, path, flags);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        </span><br><span class="line">        <span class="comment">//【3.1.1.2】对核心 apk 解析，返回封装核心 apk 信息的 Package 对象 pkg!</span></span><br><span class="line">        <span class="keyword">final</span> File baseApk = <span class="keyword">new</span> File(lite.baseCodePath);</span><br><span class="line">        <span class="keyword">final</span> Package pkg = parseBaseApk(baseApk, assets, flags);</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (pkg == <span class="keyword">null</span>) &#123;</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> PackageParserException(INSTALL_PARSE_FAILED_NOT_APK,</span><br><span class="line">                    <span class="string">"Failed to parse base APK: "</span> + baseApk);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 如果 apk 被拆分了，那就对非核心 apk 也进行处理！</span></span><br><span class="line">        <span class="keyword">if</span> (!ArrayUtils.isEmpty(lite.splitNames)) &#123;</span><br><span class="line">            <span class="keyword">final</span> <span class="keyword">int</span> num = lite.splitNames.length;</span><br><span class="line">            pkg.splitNames = lite.splitNames;</span><br><span class="line">            pkg.splitCodePaths = lite.splitCodePaths;</span><br><span class="line">            pkg.splitRevisionCodes = lite.splitRevisionCodes;</span><br><span class="line">            pkg.splitFlags = <span class="keyword">new</span> <span class="keyword">int</span>[num];</span><br><span class="line">            pkg.splitPrivateFlags = <span class="keyword">new</span> <span class="keyword">int</span>[num];</span><br><span class="line"></span><br><span class="line">            <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; num; i++) &#123;</span><br><span class="line">                <span class="comment">//【3.1.1.3】对拆分后的非核心 apk 也进行解析！</span></span><br><span class="line">                parseSplitApk(pkg, i, assets, flags);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        pkg.setCodePath(packageDir.getAbsolutePath()); <span class="comment">// 设置 package 的 codePath！</span></span><br><span class="line">        pkg.setUse32bitAbi(lite.use32bitAbi);</span><br><span class="line">        </span><br><span class="line">        <span class="comment">// 返回解析对象！</span></span><br><span class="line">        <span class="keyword">return</span> pkg;</span><br><span class="line">    &#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">        IoUtils.closeQuietly(assets);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>这里我们分为 3 个阶段来看：</p>
<ul>
<li>对目录下的所有 apk 进行整体解析；</li>
<li>对目录中的核心 apk 进行解析；</li>
<li>如果 apk 被拆分了，对非核心应用进行解析；</li>
</ul>
<h4 id="3-1-1-1-PParser-parseClusterPackageLite"><a href="#3-1-1-1-PParser-parseClusterPackageLite" class="headerlink" title="3.1.1.1 PParser.parseClusterPackageLite"></a>3.1.1.1 PParser.parseClusterPackageLite</h4><p>首先，对目录下的所有 apk 进行整体解析：<br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">static</span> PackageLite <span class="title">parseClusterPackageLite</span><span class="params">(File packageDir, <span class="keyword">int</span> flags)</span></span></span><br><span class="line"><span class="function">        <span class="keyword">throws</span> PackageParserException </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">final</span> File[] files = packageDir.listFiles();</span><br><span class="line">    <span class="keyword">if</span> (ArrayUtils.isEmpty(files)) &#123;</span><br><span class="line">        <span class="keyword">throw</span> <span class="keyword">new</span> PackageParserException(INSTALL_PARSE_FAILED_NOT_APK,</span><br><span class="line">                <span class="string">"No packages found in split"</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    String packageName = <span class="keyword">null</span>;</span><br><span class="line">    <span class="keyword">int</span> versionCode = <span class="number">0</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">final</span> ArrayMap&lt;String, ApkLite&gt; apks = <span class="keyword">new</span> ArrayMap&lt;&gt;();</span><br><span class="line">    </span><br><span class="line">    <span class="comment">//【1】遍历目录下的所有 apk 文件，包括主 apk 和子 apk！</span></span><br><span class="line">    <span class="keyword">for</span> (File file : files) &#123;</span><br><span class="line">        <span class="keyword">if</span> (isApkFile(file)) &#123;</span><br><span class="line">            </span><br><span class="line">            <span class="comment">//【3.1.1.1.1】解析 apk，将解析数据保存到 ApkLite 中！</span></span><br><span class="line">            <span class="keyword">final</span> ApkLite lite = parseApkLite(file, flags);</span><br><span class="line"></span><br><span class="line">            <span class="keyword">if</span> (packageName == <span class="keyword">null</span>) &#123;</span><br><span class="line">                packageName = lite.packageName;</span><br><span class="line">                versionCode = lite.versionCode;</span><br><span class="line"></span><br><span class="line">            &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                <span class="keyword">if</span> (!packageName.equals(lite.packageName)) &#123;</span><br><span class="line">                    <span class="keyword">throw</span> <span class="keyword">new</span> PackageParserException(INSTALL_PARSE_FAILED_BAD_MANIFEST,</span><br><span class="line">                            <span class="string">"Inconsistent package "</span> + lite.packageName + <span class="string">" in "</span> + file</span><br><span class="line">                            + <span class="string">"; expected "</span> + packageName);</span><br><span class="line">                &#125;</span><br><span class="line">                <span class="keyword">if</span> (versionCode != lite.versionCode) &#123;</span><br><span class="line">                    <span class="keyword">throw</span> <span class="keyword">new</span> PackageParserException(INSTALL_PARSE_FAILED_BAD_MANIFEST,</span><br><span class="line">                            <span class="string">"Inconsistent version "</span> + lite.versionCode + <span class="string">" in "</span> + file</span><br><span class="line">                            + <span class="string">"; expected "</span> + versionCode);</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            <span class="comment">// 将解析得到的 ApkLite 对象添加到一个 ArrayMap 集合中！</span></span><br><span class="line">            <span class="comment">// 注意：对于核心 apk，splitName 为 null！</span></span><br><span class="line">            <span class="keyword">if</span> (apks.put(lite.splitName, lite) != <span class="keyword">null</span>) &#123;</span><br><span class="line">                <span class="keyword">throw</span> <span class="keyword">new</span> PackageParserException(INSTALL_PARSE_FAILED_BAD_MANIFEST,</span><br><span class="line">                        <span class="string">"Split name "</span> + lite.splitName</span><br><span class="line">                        + <span class="string">" defined more than once; most recent was "</span> + file);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//【2】从列表中移除核心 apk，保存到 baseApk 中，之所以 remove null，是因为 base apk 的 splitName 为 null！</span></span><br><span class="line">    <span class="comment">// 如果没有 base apk，那就报错！！</span></span><br><span class="line">    <span class="keyword">final</span> ApkLite baseApk = apks.remove(<span class="keyword">null</span>);</span><br><span class="line">    <span class="keyword">if</span> (baseApk == <span class="keyword">null</span>) &#123;</span><br><span class="line">        <span class="keyword">throw</span> <span class="keyword">new</span> PackageParserException(INSTALL_PARSE_FAILED_BAD_MANIFEST,</span><br><span class="line">                <span class="string">"Missing base APK in "</span> + packageDir);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//【3】处理非核心的 apk！</span></span><br><span class="line">    <span class="keyword">final</span> <span class="keyword">int</span> size = apks.size();</span><br><span class="line">    String[] splitNames = <span class="keyword">null</span>;</span><br><span class="line">    String[] splitCodePaths = <span class="keyword">null</span>;</span><br><span class="line">    <span class="keyword">int</span>[] splitRevisionCodes = <span class="keyword">null</span>;</span><br><span class="line">    <span class="keyword">if</span> (size &gt; <span class="number">0</span>) &#123;</span><br><span class="line">    </span><br><span class="line">        <span class="comment">//【3.1】获得非核心 apk 的 splitName，codePath 和 splitRevisionCodes！</span></span><br><span class="line">        splitNames = <span class="keyword">new</span> String[size];</span><br><span class="line">        splitCodePaths = <span class="keyword">new</span> String[size];</span><br><span class="line">        splitRevisionCodes = <span class="keyword">new</span> <span class="keyword">int</span>[size];</span><br><span class="line"></span><br><span class="line">        splitNames = apks.keySet().toArray(splitNames);</span><br><span class="line">        Arrays.sort(splitNames, sSplitNameComparator);</span><br><span class="line"></span><br><span class="line">        <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; size; i++) &#123;</span><br><span class="line">            splitCodePaths[i] = apks.get(splitNames[i]).codePath;</span><br><span class="line">            splitRevisionCodes[i] = apks.get(splitNames[i]).revisionCode;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">final</span> String codePath = packageDir.getAbsolutePath();</span><br><span class="line">    </span><br><span class="line">    <span class="comment">//【3.1.1.1.2】创建所有应用的 PackageLite 解析对象，返回！</span></span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">new</span> PackageLite(codePath, baseApk, splitNames, splitCodePaths,</span><br><span class="line">            splitRevisionCodes);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>这里调用了 parseApkLite 方法，解析 dir 下的核心 apk 和非核心 apk（如果有），然后获得非核心 apk 的 splitNames、splitCodePaths 和 splitRevisionCodes，最后创建 package 的 PackageLite 对象，并返回！</p>
<h5 id="3-1-1-1-1-PParser-parseApkLite-2"><a href="#3-1-1-1-1-PParser-parseApkLite-2" class="headerlink" title="3.1.1.1.1 PParser.parseApkLite[2]"></a>3.1.1.1.1 PParser.parseApkLite[2]</h5><p>解析 apk 文件！<br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">static</span> ApkLite <span class="title">parseApkLite</span><span class="params">(File apkFile, <span class="keyword">int</span> flags)</span></span></span><br><span class="line"><span class="function">        <span class="keyword">throws</span> PackageParserException </span>&#123;</span><br><span class="line">    <span class="keyword">final</span> String apkPath = apkFile.getAbsolutePath();</span><br><span class="line"></span><br><span class="line">    AssetManager assets = <span class="keyword">null</span>;</span><br><span class="line">    XmlResourceParser parser = <span class="keyword">null</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">    </span><br><span class="line">        <span class="comment">// 创建资源管理器</span></span><br><span class="line">        assets = <span class="keyword">new</span> AssetManager(); </span><br><span class="line">        assets.setConfiguration(<span class="number">0</span>, <span class="number">0</span>, <span class="keyword">null</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>,</span><br><span class="line">                Build.VERSION.RESOURCES_SDK_INT);</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 首先将 apk 中的资源加载到资源管理器 asserts 中。 </span></span><br><span class="line">        <span class="keyword">int</span> cookie = assets.addAssetPath(apkPath);</span><br><span class="line">        <span class="keyword">if</span> (cookie == <span class="number">0</span>) &#123;</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> PackageParserException(INSTALL_PARSE_FAILED_NOT_APK,</span><br><span class="line">                    <span class="string">"Failed to parse "</span> + apkPath);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">final</span> DisplayMetrics metrics = <span class="keyword">new</span> DisplayMetrics();</span><br><span class="line">        metrics.setToDefaults();</span><br><span class="line"></span><br><span class="line">        <span class="keyword">final</span> Resources res = <span class="keyword">new</span> Resources(assets, metrics, <span class="keyword">null</span>);</span><br><span class="line">        </span><br><span class="line">        <span class="comment">//【1】创建解析器，用来解析 apk 的 AndroidMenifest.xml 文件。</span></span><br><span class="line">        parser = assets.openXmlResourceParser(cookie, ANDROID_MANIFEST_FILENAME);</span><br><span class="line"></span><br><span class="line">        <span class="keyword">final</span> Signature[] signatures;</span><br><span class="line">        <span class="keyword">final</span> Certificate[][] certificates;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> ((flags &amp; PARSE_COLLECT_CERTIFICATES) != <span class="number">0</span>) &#123;</span><br><span class="line">            <span class="comment">// <span class="doctag">TODO:</span> factor signature related items out of Package object</span></span><br><span class="line">            <span class="keyword">final</span> Package tempPkg = <span class="keyword">new</span> Package(<span class="keyword">null</span>);</span><br><span class="line">            Trace.traceBegin(TRACE_TAG_PACKAGE_MANAGER, <span class="string">"collectCertificates"</span>);</span><br><span class="line">            <span class="keyword">try</span> &#123;</span><br><span class="line">                </span><br><span class="line">                <span class="comment">// 进行签名验证，并将签名保存在 signatures 中。</span></span><br><span class="line">                collectCertificates(tempPkg, apkFile, <span class="number">0</span> <span class="comment">/*parseFlags*/</span>);</span><br><span class="line">            &#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">                Trace.traceEnd(TRACE_TAG_PACKAGE_MANAGER);</span><br><span class="line">            &#125;</span><br><span class="line">            signatures = tempPkg.mSignatures;</span><br><span class="line">            certificates = tempPkg.mCertificates;</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            signatures = <span class="keyword">null</span>;</span><br><span class="line">            certificates = <span class="keyword">null</span>;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 将 &lt;manifest&gt; 标签的属性付给 attrs！</span></span><br><span class="line">        <span class="keyword">final</span> AttributeSet attrs = parser;</span><br><span class="line">        </span><br><span class="line">        <span class="comment">//【3.1.1.1.1.1】接着调用 parseApkLite 继续解析！</span></span><br><span class="line">        <span class="keyword">return</span> parseApkLite(apkPath, res, parser, attrs, flags, signatures, certificates);</span><br><span class="line"></span><br><span class="line">    &#125; <span class="keyword">catch</span> (XmlPullParserException | IOException | RuntimeException e) &#123;</span><br><span class="line">        <span class="keyword">throw</span> <span class="keyword">new</span> PackageParserException(INSTALL_PARSE_FAILED_UNEXPECTED_EXCEPTION,</span><br><span class="line">                <span class="string">"Failed to parse "</span> + apkPath, e);</span><br><span class="line">    &#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">        IoUtils.closeQuietly(parser);</span><br><span class="line">        IoUtils.closeQuietly(assets);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>调用重载函数 parseApkLite 函数，继续解析，参数传递：</p>
<h6 id="3-1-1-1-1-1-PParser-parseApkLite-7"><a href="#3-1-1-1-1-1-PParser-parseApkLite-7" class="headerlink" title="3.1.1.1.1.1 PParser.parseApkLite[7]"></a>3.1.1.1.1.1 PParser.parseApkLite[7]</h6><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">static</span> ApkLite <span class="title">parseApkLite</span><span class="params">(String codePath, Resources res, XmlPullParser parser,</span></span></span><br><span class="line"><span class="function"><span class="params">                AttributeSet attrs, <span class="keyword">int</span> flags, Signature[] signatures, Certificate[][] certificates)</span></span></span><br><span class="line"><span class="function">                <span class="keyword">throws</span> IOException, XmlPullParserException, PackageParserException </span>&#123;</span><br><span class="line">    <span class="comment">//【3.1.1.1.1.2】解析获得应用的 </span></span><br><span class="line">    <span class="keyword">final</span> Pair&lt;String, String&gt; packageSplit = parsePackageSplitNames(parser, attrs);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">int</span> installLocation = PARSE_DEFAULT_INSTALL_LOCATION;</span><br><span class="line">    <span class="keyword">int</span> versionCode = <span class="number">0</span>;</span><br><span class="line">    <span class="keyword">int</span> revisionCode = <span class="number">0</span>;</span><br><span class="line">    <span class="keyword">boolean</span> coreApp = <span class="keyword">false</span>;</span><br><span class="line">    <span class="keyword">boolean</span> multiArch = <span class="keyword">false</span>;</span><br><span class="line">    <span class="keyword">boolean</span> use32bitAbi = <span class="keyword">false</span>;</span><br><span class="line">    <span class="keyword">boolean</span> extractNativeLibs = <span class="keyword">true</span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//【1】解析 &lt;manifest&gt; 标签的属性！</span></span><br><span class="line">    <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; attrs.getAttributeCount(); i++) &#123;</span><br><span class="line">        <span class="keyword">final</span> String attr = attrs.getAttributeName(i);</span><br><span class="line">        <span class="comment">// 解析 android:installLocation 属性，表示安装位置，取值为 auto|internalOnly|preferExternal</span></span><br><span class="line">        <span class="keyword">if</span> (attr.equals(<span class="string">"installLocation"</span>)) &#123;</span><br><span class="line">            installLocation = attrs.getAttributeIntValue(i,</span><br><span class="line">                    PARSE_DEFAULT_INSTALL_LOCATION);</span><br><span class="line"></span><br><span class="line">        &#125; <span class="keyword">else</span> <span class="keyword">if</span> (attr.equals(<span class="string">"versionCode"</span>)) &#123; <span class="comment">// 解析版本号 versionCode！</span></span><br><span class="line">            versionCode = attrs.getAttributeIntValue(i, <span class="number">0</span>);</span><br><span class="line"></span><br><span class="line">        &#125; <span class="keyword">else</span> <span class="keyword">if</span> (attr.equals(<span class="string">"revisionCode"</span>)) &#123;</span><br><span class="line">            revisionCode = attrs.getAttributeIntValue(i, <span class="number">0</span>);</span><br><span class="line"></span><br><span class="line">        &#125; <span class="keyword">else</span> <span class="keyword">if</span> (attr.equals(<span class="string">"coreApp"</span>)) &#123; <span class="comment">// 是否是核心 apk</span></span><br><span class="line">            coreApp = attrs.getAttributeBooleanValue(i, <span class="keyword">false</span>);</span><br><span class="line"></span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//【2】接着，解析 manifest 标签的直接子标签！</span></span><br><span class="line">    <span class="keyword">int</span> type;</span><br><span class="line">    <span class="keyword">final</span> <span class="keyword">int</span> searchDepth = parser.getDepth() + <span class="number">1</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">final</span> List&lt;VerifierInfo&gt; verifiers = <span class="keyword">new</span> ArrayList&lt;VerifierInfo&gt;();</span><br><span class="line"></span><br><span class="line">    <span class="keyword">while</span> ((type = parser.next()) != XmlPullParser.END_DOCUMENT</span><br><span class="line">            &amp;&amp; (type != XmlPullParser.END_TAG || parser.getDepth() &gt;= searchDepth)) &#123;</span><br><span class="line">        <span class="keyword">if</span> (type == XmlPullParser.END_TAG || type == XmlPullParser.TEXT) &#123;</span><br><span class="line">            <span class="keyword">continue</span>;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment">//【2.1】解析 &lt;package-verifier&gt; 标签的属性！</span></span><br><span class="line">        <span class="keyword">if</span> (parser.getDepth() == searchDepth &amp;&amp; <span class="string">"package-verifier"</span>.equals(parser.getName())) &#123;</span><br><span class="line">            <span class="keyword">final</span> VerifierInfo verifier = parseVerifier(res, parser, attrs, flags);</span><br><span class="line">            <span class="keyword">if</span> (verifier != <span class="keyword">null</span>) &#123;</span><br><span class="line">                verifiers.add(verifier);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment">//【2.2】解析 &lt;application&gt; 标签的属性！</span></span><br><span class="line">        <span class="keyword">if</span> (parser.getDepth() == searchDepth &amp;&amp; <span class="string">"application"</span>.equals(parser.getName())) &#123;</span><br><span class="line">            <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; attrs.getAttributeCount(); ++i) &#123;</span><br><span class="line">                <span class="keyword">final</span> String attr = attrs.getAttributeName(i);</span><br><span class="line">                <span class="keyword">if</span> (<span class="string">"multiArch"</span>.equals(attr)) &#123;</span><br><span class="line">                    multiArch = attrs.getAttributeBooleanValue(i, <span class="keyword">false</span>);</span><br><span class="line">                &#125;</span><br><span class="line">                <span class="keyword">if</span> (<span class="string">"use32bitAbi"</span>.equals(attr)) &#123;</span><br><span class="line">                    use32bitAbi = attrs.getAttributeBooleanValue(i, <span class="keyword">false</span>);</span><br><span class="line">                &#125;</span><br><span class="line">                <span class="keyword">if</span> (<span class="string">"extractNativeLibs"</span>.equals(attr)) &#123;</span><br><span class="line">                    extractNativeLibs = attrs.getAttributeBooleanValue(i, <span class="keyword">true</span>);</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//【3.1.1.1.1.3】创建 apk 对应的 ApkLite 对象！！</span></span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">new</span> ApkLite(codePath, packageSplit.first, packageSplit.second, versionCode,</span><br><span class="line">            revisionCode, installLocation, verifiers, signatures, certificates, coreApp,</span><br><span class="line">            multiArch, use32bitAbi, extractNativeLibs);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h6 id="3-1-1-1-1-2-PParser-parsePackageSplitNames"><a href="#3-1-1-1-1-2-PParser-parsePackageSplitNames" class="headerlink" title="3.1.1.1.1.2 PParser.parsePackageSplitNames"></a>3.1.1.1.1.2 PParser.parsePackageSplitNames</h6><p>该方法用于解析 apk 的 “manifest” 标签的 package 属性和 split 属性！<br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">static</span> Pair&lt;String, String&gt; <span class="title">parsePackageSplitNames</span><span class="params">(XmlPullParser parser,</span></span></span><br><span class="line"><span class="function"><span class="params">        AttributeSet attrs)</span> <span class="keyword">throws</span> IOException, XmlPullParserException,</span></span><br><span class="line"><span class="function">        PackageParserException </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">int</span> type;</span><br><span class="line">    <span class="keyword">while</span> ((type = parser.next()) != XmlPullParser.START_TAG</span><br><span class="line">            &amp;&amp; type != XmlPullParser.END_DOCUMENT) &#123;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (type != XmlPullParser.START_TAG) &#123;</span><br><span class="line">        <span class="keyword">throw</span> <span class="keyword">new</span> PackageParserException(INSTALL_PARSE_FAILED_MANIFEST_MALFORMED,</span><br><span class="line">                <span class="string">"No start tag found"</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span> (!parser.getName().equals(TAG_MANIFEST)) &#123; <span class="comment">// 如果不是 manifest 标签！</span></span><br><span class="line">        <span class="keyword">throw</span> <span class="keyword">new</span> PackageParserException(INSTALL_PARSE_FAILED_MANIFEST_MALFORMED,</span><br><span class="line">                <span class="string">"No &lt;manifest&gt; tag"</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//【1】解析 manifest 标签的 package 属性！</span></span><br><span class="line">    <span class="keyword">final</span> String packageName = attrs.getAttributeValue(<span class="keyword">null</span>, <span class="string">"package"</span>);</span><br><span class="line">    <span class="keyword">if</span> (!<span class="string">"android"</span>.equals(packageName)) &#123;</span><br><span class="line">         <span class="comment">// 如果 package 不是 android，那需要校验格式！</span></span><br><span class="line">        <span class="keyword">final</span> String error = validateName(packageName, <span class="keyword">true</span>, <span class="keyword">true</span>);</span><br><span class="line">        <span class="keyword">if</span> (error != <span class="keyword">null</span>) &#123;</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> PackageParserException(INSTALL_PARSE_FAILED_BAD_PACKAGE_NAME,</span><br><span class="line">                    <span class="string">"Invalid manifest package: "</span> + error);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//【2】解析 manifest 标签的 split 属性！</span></span><br><span class="line">    String splitName = attrs.getAttributeValue(<span class="keyword">null</span>, <span class="string">"split"</span>);</span><br><span class="line">    <span class="keyword">if</span> (splitName != <span class="keyword">null</span>) &#123;</span><br><span class="line">        <span class="keyword">if</span> (splitName.length() == <span class="number">0</span>) &#123;</span><br><span class="line">            splitName = <span class="keyword">null</span>;</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            <span class="keyword">final</span> String error = validateName(splitName, <span class="keyword">false</span>, <span class="keyword">false</span>);</span><br><span class="line">            <span class="keyword">if</span> (error != <span class="keyword">null</span>) &#123;</span><br><span class="line">                <span class="keyword">throw</span> <span class="keyword">new</span> PackageParserException(INSTALL_PARSE_FAILED_BAD_PACKAGE_NAME,</span><br><span class="line">                        <span class="string">"Invalid manifest split: "</span> + error);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">//【3】返回 packageName 和 splitName 的 Pair 对象！</span></span><br><span class="line">    <span class="keyword">return</span> Pair.create(packageName.intern(),</span><br><span class="line">            (splitName != <span class="keyword">null</span>) ? splitName.intern() : splitName);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>接着创建一个 ApkLite 对象，用来封装 apk 的解析信息！</p>
<h6 id="3-1-1-1-1-3-new-ApkLite"><a href="#3-1-1-1-1-3-new-ApkLite" class="headerlink" title="3.1.1.1.1.3 new ApkLite"></a>3.1.1.1.1.3 new ApkLite</h6><p>最后，将结果封装为一个 ApkLite 对象，并返回！<br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> <span class="class"><span class="keyword">class</span> <span class="title">ApkLite</span> </span>&#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">final</span> String codePath;     <span class="comment">// apk 路径，就是 apk 文件的绝对路径！</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">final</span> String packageName;  <span class="comment">// 应用程序包名</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">final</span> String splitName;    <span class="comment">// 非核心 apk 包名</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">final</span> <span class="keyword">int</span> versionCode;     <span class="comment">// 版本号</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">final</span> <span class="keyword">int</span> revisionCode;    <span class="comment">// 修订版本号</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">final</span> <span class="keyword">int</span> installLocation; <span class="comment">// 安装位置</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">final</span> VerifierInfo[] verifiers; <span class="comment">// 校验信息</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">final</span> Signature[] signatures;  <span class="comment">// 签名信息</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">final</span> Certificate[][] certificates; <span class="comment">// 证书信息</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">final</span> <span class="keyword">boolean</span> coreApp;     <span class="comment">// 是否是核心应用</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">final</span> <span class="keyword">boolean</span> multiArch;   <span class="comment">// 是否支持多软件架构</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">final</span> <span class="keyword">boolean</span> use32bitAbi; <span class="comment">// 是否使用 32 位系统指令集</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">final</span> <span class="keyword">boolean</span> extractNativeLibs; <span class="comment">// 是否依赖额外的本地库</span></span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="title">ApkLite</span><span class="params">(String codePath, String packageName, String splitName, <span class="keyword">int</span> versionCode,</span></span></span><br><span class="line"><span class="function"><span class="params">            <span class="keyword">int</span> revisionCode, <span class="keyword">int</span> installLocation, List&lt;VerifierInfo&gt; verifiers,</span></span></span><br><span class="line"><span class="function"><span class="params">            Signature[] signatures, Certificate[][] certificates, <span class="keyword">boolean</span> coreApp,</span></span></span><br><span class="line"><span class="function"><span class="params">            <span class="keyword">boolean</span> multiArch, <span class="keyword">boolean</span> use32bitAbi, <span class="keyword">boolean</span> extractNativeLibs)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">this</span>.codePath = codePath;</span><br><span class="line">        <span class="keyword">this</span>.packageName = packageName;</span><br><span class="line">        <span class="keyword">this</span>.splitName = splitName;</span><br><span class="line">        <span class="keyword">this</span>.versionCode = versionCode;</span><br><span class="line">        <span class="keyword">this</span>.revisionCode = revisionCode;</span><br><span class="line">        <span class="keyword">this</span>.installLocation = installLocation;</span><br><span class="line">        <span class="keyword">this</span>.verifiers = verifiers.toArray(<span class="keyword">new</span> VerifierInfo[verifiers.size()]);</span><br><span class="line">        <span class="keyword">this</span>.signatures = signatures;</span><br><span class="line">        <span class="keyword">this</span>.certificates = certificates;</span><br><span class="line">        <span class="keyword">this</span>.coreApp = coreApp;</span><br><span class="line">        <span class="keyword">this</span>.multiArch = multiArch;</span><br><span class="line">        <span class="keyword">this</span>.use32bitAbi = use32bitAbi;</span><br><span class="line">        <span class="keyword">this</span>.extractNativeLibs = extractNativeLibs;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>然后返回，回到 PP.parseClusterPackageLite 函数中，根据解析的结果，创建 PackageLite 对象：</p>
<h5 id="3-1-1-1-2-new-PackageLite"><a href="#3-1-1-1-2-new-PackageLite" class="headerlink" title="3.1.1.1.2 new PackageLite"></a>3.1.1.1.2 new PackageLite</h5><p>PackageLite 用来封装一个应用程序包的信息，PackageLite 的构造器如下：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> <span class="class"><span class="keyword">class</span> <span class="title">PackageLite</span> </span>&#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">final</span> String packageName; <span class="comment">// base apk 应用程序包名；</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">final</span> <span class="keyword">int</span> versionCode;    <span class="comment">// base apk 的版本号；</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">final</span> <span class="keyword">int</span> installLocation;  <span class="comment">// base apk 的安装位置；</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">final</span> VerifierInfo[] verifiers; <span class="comment">// base apk 的安装位置；</span></span><br><span class="line">    </span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">final</span> String[] splitNames; <span class="comment">// 非核心 apk 的名称；</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">final</span> String codePath;  <span class="comment">// 应用程序包的绝对路径，/system/app/com.coolqi.papapa</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">final</span> String baseCodePath;   <span class="comment">// base apk 的路径，/system/app/com.coolqi.papapa/base.apk</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">final</span> String[] splitCodePaths;  <span class="comment">//非核心 apk 的路径</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">final</span> <span class="keyword">int</span> baseRevisionCode; <span class="comment">// 核心 apk 的修订版版本号</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">final</span> <span class="keyword">int</span>[] splitRevisionCodes; <span class="comment">// 非核心 apk 的修订版版本号</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">final</span> <span class="keyword">boolean</span> coreApp; <span class="comment">// 是否有核心 apk！</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">final</span> <span class="keyword">boolean</span> multiArch; <span class="comment">// 是否支持多软件平台架构！</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">final</span> <span class="keyword">boolean</span> use32bitAbi; <span class="comment">// 是否使用 23 位的系统指令集！</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">final</span> <span class="keyword">boolean</span> extractNativeLibs; <span class="comment">// 是否支持！</span></span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="title">PackageLite</span><span class="params">(String codePath, ApkLite baseApk, String[] splitNames,</span></span></span><br><span class="line"><span class="function"><span class="params">            String[] splitCodePaths, <span class="keyword">int</span>[] splitRevisionCodes)</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">this</span>.packageName = baseApk.packageName;</span><br><span class="line">        <span class="keyword">this</span>.versionCode = baseApk.versionCode;</span><br><span class="line">        <span class="keyword">this</span>.installLocation = baseApk.installLocation;</span><br><span class="line">        <span class="keyword">this</span>.verifiers = baseApk.verifiers;</span><br><span class="line">        <span class="keyword">this</span>.splitNames = splitNames;</span><br><span class="line">        <span class="keyword">this</span>.codePath = codePath;</span><br><span class="line">        <span class="keyword">this</span>.baseCodePath = baseApk.codePath;</span><br><span class="line">        <span class="keyword">this</span>.splitCodePaths = splitCodePaths;</span><br><span class="line">        <span class="keyword">this</span>.baseRevisionCode = baseApk.revisionCode;</span><br><span class="line">        <span class="keyword">this</span>.splitRevisionCodes = splitRevisionCodes;</span><br><span class="line">        <span class="keyword">this</span>.coreApp = baseApk.coreApp;</span><br><span class="line">        <span class="keyword">this</span>.multiArch = baseApk.multiArch;</span><br><span class="line">        <span class="keyword">this</span>.use32bitAbi = baseApk.use32bitAbi;</span><br><span class="line">        <span class="keyword">this</span>.extractNativeLibs = baseApk.extractNativeLibs;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>这里我们不在过多分析！！</p>
<h4 id="3-1-1-2-PParser-parseBaseApk-3"><a href="#3-1-1-2-PParser-parseBaseApk-3" class="headerlink" title="3.1.1.2 PParser.parseBaseApk[3]"></a>3.1.1.2 PParser.parseBaseApk[3]</h4><p>解析 base apk：<br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">private</span> Package <span class="title">parseBaseApk</span><span class="params">(File apkFile, AssetManager assets, <span class="keyword">int</span> flags)</span></span></span><br><span class="line"><span class="function">        <span class="keyword">throws</span> PackageParserException </span>&#123;</span><br><span class="line">    <span class="keyword">final</span> String apkPath = apkFile.getAbsolutePath();</span><br><span class="line"></span><br><span class="line">    String volumeUuid = <span class="keyword">null</span>;</span><br><span class="line">    <span class="keyword">if</span> (apkPath.startsWith(MNT_EXPAND)) &#123; <span class="comment">// 解析 /mnt/expand/</span></span><br><span class="line">        <span class="keyword">final</span> <span class="keyword">int</span> end = apkPath.indexOf(<span class="string">'/'</span>, MNT_EXPAND.length());</span><br><span class="line">        volumeUuid = apkPath.substring(MNT_EXPAND.length(), end);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    mParseError = PackageManager.INSTALL_SUCCEEDED;</span><br><span class="line">    mArchiveSourcePath = apkFile.getAbsolutePath();</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (DEBUG_JAR) Slog.d(TAG, <span class="string">"Scanning base APK: "</span> + apkPath);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">final</span> <span class="keyword">int</span> cookie = loadApkIntoAssetManager(assets, apkPath, flags);</span><br><span class="line"></span><br><span class="line">    Resources res = <span class="keyword">null</span>;</span><br><span class="line">    XmlResourceParser parser = <span class="keyword">null</span>;</span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">        res = <span class="keyword">new</span> Resources(assets, mMetrics, <span class="keyword">null</span>);</span><br><span class="line">        assets.setConfiguration(<span class="number">0</span>, <span class="number">0</span>, <span class="keyword">null</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>,</span><br><span class="line">                Build.VERSION.RESOURCES_SDK_INT);</span><br><span class="line"></span><br><span class="line">        <span class="comment">//【1】用于解析 AndroidManifest.xml 文件！      </span></span><br><span class="line">        parser = assets.openXmlResourceParser(cookie, ANDROID_MANIFEST_FILENAME);</span><br><span class="line"></span><br><span class="line">        <span class="keyword">final</span> String[] outError = <span class="keyword">new</span> String[<span class="number">1</span>];</span><br><span class="line">        </span><br><span class="line">        <span class="comment">//【3.1.1.2】解析核心 apk！</span></span><br><span class="line">        <span class="keyword">final</span> Package pkg = parseBaseApk(res, parser, flags, outError);</span><br><span class="line">        <span class="keyword">if</span> (pkg == <span class="keyword">null</span>) &#123;</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> PackageParserException(mParseError,</span><br><span class="line">                    apkPath + <span class="string">" (at "</span> + parser.getPositionDescription() + <span class="string">"): "</span> + outError[<span class="number">0</span>]);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        pkg.setVolumeUuid(volumeUuid);</span><br><span class="line">        pkg.setApplicationVolumeUuid(volumeUuid);</span><br><span class="line">        pkg.setBaseCodePath(apkPath);</span><br><span class="line">        pkg.setSignatures(<span class="keyword">null</span>);</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> pkg;</span><br><span class="line"></span><br><span class="line">    &#125; <span class="keyword">catch</span> (PackageParserException e) &#123;</span><br><span class="line">        <span class="keyword">throw</span> e;</span><br><span class="line">    &#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">        <span class="keyword">throw</span> <span class="keyword">new</span> PackageParserException(INSTALL_PARSE_FAILED_UNEXPECTED_EXCEPTION,</span><br><span class="line">                <span class="string">"Failed to read manifest from "</span> + apkPath, e);</span><br><span class="line">    &#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">        IoUtils.closeQuietly(parser);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>接着，调用重载 parseBaseApk 方法：</p>
<h5 id="3-1-1-2-1-PParser-parseBaseApk-4"><a href="#3-1-1-2-1-PParser-parseBaseApk-4" class="headerlink" title="3.1.1.2.1 PParser.parseBaseApk[4]"></a>3.1.1.2.1 PParser.parseBaseApk[4]</h5><p>我们继续来看：<br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">private</span> Package <span class="title">parseBaseApk</span><span class="params">(Resources res, XmlResourceParser parser, <span class="keyword">int</span> flags,</span></span></span><br><span class="line"><span class="function"><span class="params">        String[] outError)</span> <span class="keyword">throws</span> XmlPullParserException, IOException </span>&#123;</span><br><span class="line">    <span class="keyword">final</span> String splitName;</span><br><span class="line">    <span class="keyword">final</span> String pkgName;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">        <span class="comment">//【3.1.1.1.1.2】解析 &lt;manifest&gt; 标签，获得 packageName 和 splitName，</span></span><br><span class="line">        <span class="comment">// 以 Pair&lt;packageName, splitName&gt; 的形式返回！</span></span><br><span class="line">        Pair&lt;String, String&gt; packageSplit = parsePackageSplitNames(parser, parser);</span><br><span class="line">        pkgName = packageSplit.first;</span><br><span class="line">        splitName = packageSplit.second;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (!TextUtils.isEmpty(splitName)) &#123;</span><br><span class="line">            outError[<span class="number">0</span>] = <span class="string">"Expected base APK, but found split "</span> + splitName;</span><br><span class="line">            mParseError = PackageManager.INSTALL_PARSE_FAILED_BAD_PACKAGE_NAME;</span><br><span class="line">            <span class="keyword">return</span> <span class="keyword">null</span>;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">    &#125; <span class="keyword">catch</span> (PackageParserException e) &#123;</span><br><span class="line"></span><br><span class="line">        mParseError = PackageManager.INSTALL_PARSE_FAILED_BAD_PACKAGE_NAME;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">null</span>;</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//【3.1.3】创建一个 Package 对象，用于保存最终的解析信息！</span></span><br><span class="line">    <span class="keyword">final</span> Package pkg = <span class="keyword">new</span> Package(pkgName);</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 解析 &lt;manifest&gt; 标签，获得 versionCode、revisionCode、versionName、coreApp 值！</span></span><br><span class="line">    TypedArray sa = res.obtainAttributes(parser,</span><br><span class="line">            com.android.internal.R.styleable.AndroidManifest);</span><br><span class="line">            </span><br><span class="line">    pkg.mVersionCode = pkg.applicationInfo.versionCode = sa.getInteger(</span><br><span class="line">            com.android.internal.R.styleable.AndroidManifest_versionCode, <span class="number">0</span>);</span><br><span class="line">            </span><br><span class="line">    pkg.baseRevisionCode = sa.getInteger(</span><br><span class="line">            com.android.internal.R.styleable.AndroidManifest_revisionCode, <span class="number">0</span>);</span><br><span class="line">            </span><br><span class="line">    pkg.mVersionName = sa.getNonConfigurationString(</span><br><span class="line">            com.android.internal.R.styleable.AndroidManifest_versionName, <span class="number">0</span>);</span><br><span class="line">            </span><br><span class="line">    <span class="keyword">if</span> (pkg.mVersionName != <span class="keyword">null</span>) &#123;</span><br><span class="line">        pkg.mVersionName = pkg.mVersionName.intern();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    pkg.coreApp = parser.getAttributeBooleanValue(<span class="keyword">null</span>, <span class="string">"coreApp"</span>, <span class="keyword">false</span>);</span><br><span class="line"></span><br><span class="line">    sa.recycle();</span><br><span class="line"></span><br><span class="line">    <span class="comment">//【3.1.1.2.2】接着，调用 parseBaseApkCommon 方法，继续解析！</span></span><br><span class="line">    <span class="keyword">return</span> parseBaseApkCommon(pkg, <span class="keyword">null</span>, res, parser, flags, outError);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<h5 id="3-1-1-2-2-PParser-parseBaseApkCommon-6"><a href="#3-1-1-2-2-PParser-parseBaseApkCommon-6" class="headerlink" title="3.1.1.2.2 PParser.parseBaseApkCommon [6]"></a>3.1.1.2.2 PParser.parseBaseApkCommon [6]</h5><p>进入最终的解析方法中：</p>
<ul>
<li>Package pkg：应用程序的信息封装对象；</li>
<li>Set<string> acceptedTags：需要解析的标签，如果传入 null ，表示解析所有，这里传入 null；</string></li>
<li>Resources res：</li>
<li>XmlResourceParser parser：</li>
<li>int flags：</li>
<li>String[] outError：用于保存解析过程中的错误信息；</li>
</ul>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br><span class="line">212</span><br><span class="line">213</span><br><span class="line">214</span><br><span class="line">215</span><br><span class="line">216</span><br><span class="line">217</span><br><span class="line">218</span><br><span class="line">219</span><br><span class="line">220</span><br><span class="line">221</span><br><span class="line">222</span><br><span class="line">223</span><br><span class="line">224</span><br><span class="line">225</span><br><span class="line">226</span><br><span class="line">227</span><br><span class="line">228</span><br><span class="line">229</span><br><span class="line">230</span><br><span class="line">231</span><br><span class="line">232</span><br><span class="line">233</span><br><span class="line">234</span><br><span class="line">235</span><br><span class="line">236</span><br><span class="line">237</span><br><span class="line">238</span><br><span class="line">239</span><br><span class="line">240</span><br><span class="line">241</span><br><span class="line">242</span><br><span class="line">243</span><br><span class="line">244</span><br><span class="line">245</span><br><span class="line">246</span><br><span class="line">247</span><br><span class="line">248</span><br><span class="line">249</span><br><span class="line">250</span><br><span class="line">251</span><br><span class="line">252</span><br><span class="line">253</span><br><span class="line">254</span><br><span class="line">255</span><br><span class="line">256</span><br><span class="line">257</span><br><span class="line">258</span><br><span class="line">259</span><br><span class="line">260</span><br><span class="line">261</span><br><span class="line">262</span><br><span class="line">263</span><br><span class="line">264</span><br><span class="line">265</span><br><span class="line">266</span><br><span class="line">267</span><br><span class="line">268</span><br><span class="line">269</span><br><span class="line">270</span><br><span class="line">271</span><br><span class="line">272</span><br><span class="line">273</span><br><span class="line">274</span><br><span class="line">275</span><br><span class="line">276</span><br><span class="line">277</span><br><span class="line">278</span><br><span class="line">279</span><br><span class="line">280</span><br><span class="line">281</span><br><span class="line">282</span><br><span class="line">283</span><br><span class="line">284</span><br><span class="line">285</span><br><span class="line">286</span><br><span class="line">287</span><br><span class="line">288</span><br><span class="line">289</span><br><span class="line">290</span><br><span class="line">291</span><br><span class="line">292</span><br><span class="line">293</span><br><span class="line">294</span><br><span class="line">295</span><br><span class="line">296</span><br><span class="line">297</span><br><span class="line">298</span><br><span class="line">299</span><br><span class="line">300</span><br><span class="line">301</span><br><span class="line">302</span><br><span class="line">303</span><br><span class="line">304</span><br><span class="line">305</span><br><span class="line">306</span><br><span class="line">307</span><br><span class="line">308</span><br><span class="line">309</span><br><span class="line">310</span><br><span class="line">311</span><br><span class="line">312</span><br><span class="line">313</span><br><span class="line">314</span><br><span class="line">315</span><br><span class="line">316</span><br><span class="line">317</span><br><span class="line">318</span><br><span class="line">319</span><br><span class="line">320</span><br><span class="line">321</span><br><span class="line">322</span><br><span class="line">323</span><br><span class="line">324</span><br><span class="line">325</span><br><span class="line">326</span><br><span class="line">327</span><br><span class="line">328</span><br><span class="line">329</span><br><span class="line">330</span><br><span class="line">331</span><br><span class="line">332</span><br><span class="line">333</span><br><span class="line">334</span><br><span class="line">335</span><br><span class="line">336</span><br><span class="line">337</span><br><span class="line">338</span><br><span class="line">339</span><br><span class="line">340</span><br><span class="line">341</span><br><span class="line">342</span><br><span class="line">343</span><br><span class="line">344</span><br><span class="line">345</span><br><span class="line">346</span><br><span class="line">347</span><br><span class="line">348</span><br><span class="line">349</span><br><span class="line">350</span><br><span class="line">351</span><br><span class="line">352</span><br><span class="line">353</span><br><span class="line">354</span><br><span class="line">355</span><br><span class="line">356</span><br><span class="line">357</span><br><span class="line">358</span><br><span class="line">359</span><br><span class="line">360</span><br><span class="line">361</span><br><span class="line">362</span><br><span class="line">363</span><br><span class="line">364</span><br><span class="line">365</span><br><span class="line">366</span><br><span class="line">367</span><br><span class="line">368</span><br><span class="line">369</span><br><span class="line">370</span><br><span class="line">371</span><br><span class="line">372</span><br><span class="line">373</span><br><span class="line">374</span><br><span class="line">375</span><br><span class="line">376</span><br><span class="line">377</span><br><span class="line">378</span><br><span class="line">379</span><br><span class="line">380</span><br><span class="line">381</span><br><span class="line">382</span><br><span class="line">383</span><br><span class="line">384</span><br><span class="line">385</span><br><span class="line">386</span><br><span class="line">387</span><br><span class="line">388</span><br><span class="line">389</span><br><span class="line">390</span><br><span class="line">391</span><br><span class="line">392</span><br><span class="line">393</span><br><span class="line">394</span><br><span class="line">395</span><br><span class="line">396</span><br><span class="line">397</span><br><span class="line">398</span><br><span class="line">399</span><br><span class="line">400</span><br><span class="line">401</span><br><span class="line">402</span><br><span class="line">403</span><br><span class="line">404</span><br><span class="line">405</span><br><span class="line">406</span><br><span class="line">407</span><br><span class="line">408</span><br><span class="line">409</span><br><span class="line">410</span><br><span class="line">411</span><br><span class="line">412</span><br><span class="line">413</span><br><span class="line">414</span><br><span class="line">415</span><br><span class="line">416</span><br><span class="line">417</span><br><span class="line">418</span><br><span class="line">419</span><br><span class="line">420</span><br><span class="line">421</span><br><span class="line">422</span><br><span class="line">423</span><br><span class="line">424</span><br><span class="line">425</span><br><span class="line">426</span><br><span class="line">427</span><br><span class="line">428</span><br><span class="line">429</span><br><span class="line">430</span><br><span class="line">431</span><br><span class="line">432</span><br><span class="line">433</span><br><span class="line">434</span><br><span class="line">435</span><br><span class="line">436</span><br><span class="line">437</span><br><span class="line">438</span><br><span class="line">439</span><br><span class="line">440</span><br><span class="line">441</span><br><span class="line">442</span><br><span class="line">443</span><br><span class="line">444</span><br><span class="line">445</span><br><span class="line">446</span><br><span class="line">447</span><br><span class="line">448</span><br><span class="line">449</span><br><span class="line">450</span><br><span class="line">451</span><br><span class="line">452</span><br><span class="line">453</span><br><span class="line">454</span><br><span class="line">455</span><br><span class="line">456</span><br><span class="line">457</span><br><span class="line">458</span><br><span class="line">459</span><br><span class="line">460</span><br><span class="line">461</span><br><span class="line">462</span><br><span class="line">463</span><br><span class="line">464</span><br><span class="line">465</span><br><span class="line">466</span><br><span class="line">467</span><br><span class="line">468</span><br><span class="line">469</span><br><span class="line">470</span><br><span class="line">471</span><br><span class="line">472</span><br><span class="line">473</span><br><span class="line">474</span><br><span class="line">475</span><br><span class="line">476</span><br><span class="line">477</span><br><span class="line">478</span><br><span class="line">479</span><br><span class="line">480</span><br><span class="line">481</span><br><span class="line">482</span><br><span class="line">483</span><br><span class="line">484</span><br><span class="line">485</span><br><span class="line">486</span><br><span class="line">487</span><br><span class="line">488</span><br><span class="line">489</span><br><span class="line">490</span><br><span class="line">491</span><br><span class="line">492</span><br><span class="line">493</span><br><span class="line">494</span><br><span class="line">495</span><br><span class="line">496</span><br><span class="line">497</span><br><span class="line">498</span><br><span class="line">499</span><br><span class="line">500</span><br><span class="line">501</span><br><span class="line">502</span><br><span class="line">503</span><br><span class="line">504</span><br><span class="line">505</span><br><span class="line">506</span><br><span class="line">507</span><br><span class="line">508</span><br><span class="line">509</span><br><span class="line">510</span><br><span class="line">511</span><br><span class="line">512</span><br><span class="line">513</span><br><span class="line">514</span><br><span class="line">515</span><br><span class="line">516</span><br><span class="line">517</span><br><span class="line">518</span><br><span class="line">519</span><br><span class="line">520</span><br><span class="line">521</span><br><span class="line">522</span><br><span class="line">523</span><br><span class="line">524</span><br><span class="line">525</span><br><span class="line">526</span><br><span class="line">527</span><br><span class="line">528</span><br><span class="line">529</span><br><span class="line">530</span><br><span class="line">531</span><br><span class="line">532</span><br><span class="line">533</span><br><span class="line">534</span><br><span class="line">535</span><br><span class="line">536</span><br><span class="line">537</span><br><span class="line">538</span><br><span class="line">539</span><br><span class="line">540</span><br><span class="line">541</span><br><span class="line">542</span><br><span class="line">543</span><br><span class="line">544</span><br><span class="line">545</span><br><span class="line">546</span><br><span class="line">547</span><br><span class="line">548</span><br><span class="line">549</span><br><span class="line">550</span><br><span class="line">551</span><br><span class="line">552</span><br><span class="line">553</span><br><span class="line">554</span><br><span class="line">555</span><br><span class="line">556</span><br><span class="line">557</span><br><span class="line">558</span><br><span class="line">559</span><br><span class="line">560</span><br><span class="line">561</span><br><span class="line">562</span><br><span class="line">563</span><br><span class="line">564</span><br><span class="line">565</span><br><span class="line">566</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">private</span> Package <span class="title">parseBaseApkCommon</span><span class="params">(Package pkg, Set&lt;String&gt; acceptedTags, Resources res,</span></span></span><br><span class="line"><span class="function"><span class="params">        XmlResourceParser parser, <span class="keyword">int</span> flags, String[] outError)</span> <span class="keyword">throws</span> XmlPullParserException,</span></span><br><span class="line"><span class="function">        IOException </span>&#123;</span><br><span class="line">    mParseInstrumentationArgs = <span class="keyword">null</span>;</span><br><span class="line">    mParseActivityArgs = <span class="keyword">null</span>;</span><br><span class="line">    mParseServiceArgs = <span class="keyword">null</span>;</span><br><span class="line">    mParseProviderArgs = <span class="keyword">null</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">int</span> type;</span><br><span class="line">    <span class="keyword">boolean</span> foundApp = <span class="keyword">false</span>;</span><br><span class="line"></span><br><span class="line">    TypedArray sa = res.obtainAttributes(parser,</span><br><span class="line">            com.android.internal.R.styleable.AndroidManifest);</span><br><span class="line">    </span><br><span class="line">    <span class="comment">//【1】获得 sharedUserId 属性！</span></span><br><span class="line">    String str = sa.getNonConfigurationString(</span><br><span class="line">            com.android.internal.R.styleable.AndroidManifest_sharedUserId, <span class="number">0</span>);</span><br><span class="line">    <span class="keyword">if</span> (str != <span class="keyword">null</span> &amp;&amp; str.length() &gt; <span class="number">0</span>) &#123;</span><br><span class="line">        String nameError = validateName(str, <span class="keyword">true</span>, <span class="keyword">false</span>);</span><br><span class="line">        <span class="keyword">if</span> (nameError != <span class="keyword">null</span> &amp;&amp; !<span class="string">"android"</span>.equals(pkg.packageName)) &#123;</span><br><span class="line">            outError[<span class="number">0</span>] = <span class="string">"&lt;manifest&gt; specifies bad sharedUserId name \""</span></span><br><span class="line">                + str + <span class="string">"\": "</span> + nameError;</span><br><span class="line">            mParseError = PackageManager.INSTALL_PARSE_FAILED_BAD_SHARED_USER_ID;</span><br><span class="line">            <span class="keyword">return</span> <span class="keyword">null</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        pkg.mSharedUserId = str.intern();</span><br><span class="line">        pkg.mSharedUserLabel = sa.getResourceId(</span><br><span class="line">                com.android.internal.R.styleable.AndroidManifest_sharedUserLabel, <span class="number">0</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//【2】获得 installLocation 属性！</span></span><br><span class="line">    pkg.installLocation = sa.getInteger(</span><br><span class="line">            com.android.internal.R.styleable.AndroidManifest_installLocation,</span><br><span class="line">            PARSE_DEFAULT_INSTALL_LOCATION);</span><br><span class="line">    pkg.applicationInfo.installLocation = pkg.installLocation;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="comment">/* Set the global "forward lock" flag */</span></span><br><span class="line">    <span class="keyword">if</span> ((flags &amp; PARSE_FORWARD_LOCK) != <span class="number">0</span>) &#123;</span><br><span class="line">        pkg.applicationInfo.privateFlags |= ApplicationInfo.PRIVATE_FLAG_FORWARD_LOCK;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/* Set the global "on SD card" flag */</span></span><br><span class="line">    <span class="keyword">if</span> ((flags &amp; PARSE_EXTERNAL_STORAGE) != <span class="number">0</span>) &#123;</span><br><span class="line">        pkg.applicationInfo.flags |= ApplicationInfo.FLAG_EXTERNAL_STORAGE;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> ((flags &amp; PARSE_IS_EPHEMERAL) != <span class="number">0</span>) &#123;</span><br><span class="line">        pkg.applicationInfo.privateFlags |= ApplicationInfo.PRIVATE_FLAG_EPHEMERAL;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// Resource boolean are -1, so 1 means we don't know the value.</span></span><br><span class="line">    <span class="keyword">int</span> supportsSmallScreens = <span class="number">1</span>;</span><br><span class="line">    <span class="keyword">int</span> supportsNormalScreens = <span class="number">1</span>;</span><br><span class="line">    <span class="keyword">int</span> supportsLargeScreens = <span class="number">1</span>;</span><br><span class="line">    <span class="keyword">int</span> supportsXLargeScreens = <span class="number">1</span>;</span><br><span class="line">    <span class="keyword">int</span> resizeable = <span class="number">1</span>;</span><br><span class="line">    <span class="keyword">int</span> anyDensity = <span class="number">1</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">int</span> outerDepth = parser.getDepth();</span><br><span class="line">    <span class="keyword">while</span> ((type = parser.next()) != XmlPullParser.END_DOCUMENT</span><br><span class="line">            &amp;&amp; (type != XmlPullParser.END_TAG || parser.getDepth() &gt; outerDepth)) &#123;</span><br><span class="line">        <span class="keyword">if</span> (type == XmlPullParser.END_TAG || type == XmlPullParser.TEXT) &#123;</span><br><span class="line">            <span class="keyword">continue</span>;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        String tagName = parser.getName();</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (acceptedTags != <span class="keyword">null</span> &amp;&amp; !acceptedTags.contains(tagName)) &#123;</span><br><span class="line">            Slog.w(TAG, <span class="string">"Skipping unsupported element under &lt;manifest&gt;: "</span></span><br><span class="line">                    + tagName + <span class="string">" at "</span> + mArchiveSourcePath + <span class="string">" "</span></span><br><span class="line">                    + parser.getPositionDescription());</span><br><span class="line">            XmlUtils.skipCurrentTag(parser);</span><br><span class="line">            <span class="keyword">continue</span>;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (tagName.equals(TAG_APPLICATION)) &#123; <span class="comment">// 解析 "application" 标签</span></span><br><span class="line">            <span class="keyword">if</span> (foundApp) &#123; </span><br><span class="line">                <span class="keyword">if</span> (RIGID_PARSER) &#123;</span><br><span class="line">                    outError[<span class="number">0</span>] = <span class="string">"&lt;manifest&gt; has more than one &lt;application&gt;"</span>;</span><br><span class="line">                    mParseError = PackageManager.INSTALL_PARSE_FAILED_MANIFEST_MALFORMED;</span><br><span class="line">                    <span class="keyword">return</span> <span class="keyword">null</span>;</span><br><span class="line">                &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                    Slog.w(TAG, <span class="string">"&lt;manifest&gt; has more than one &lt;application&gt;"</span>);</span><br><span class="line">                    XmlUtils.skipCurrentTag(parser);</span><br><span class="line">                    <span class="keyword">continue</span>;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            foundApp = <span class="keyword">true</span>;</span><br><span class="line">            </span><br><span class="line">            <span class="comment">//【3.1.1.2.3】接着调用 parseBaseApplication 方法解析 "application" 标签的属性以及四大组件的信息！</span></span><br><span class="line">            <span class="keyword">if</span> (!parseBaseApplication(pkg, res, parser, flags, outError)) &#123;</span><br><span class="line">                <span class="keyword">return</span> <span class="keyword">null</span>;</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">        &#125; <span class="keyword">else</span> <span class="keyword">if</span> (tagName.equals(TAG_OVERLAY)) &#123; <span class="comment">// 解析 "overlay" 标签</span></span><br><span class="line">            sa = res.obtainAttributes(parser,</span><br><span class="line">                    com.android.internal.R.styleable.AndroidManifestResourceOverlay);</span><br><span class="line">            pkg.mOverlayTarget = sa.getString(</span><br><span class="line">                    com.android.internal.R.styleable.AndroidManifestResourceOverlay_targetPackage);</span><br><span class="line">            pkg.mOverlayPriority = sa.getInt(</span><br><span class="line">                    com.android.internal.R.styleable.AndroidManifestResourceOverlay_priority,</span><br><span class="line">                    -<span class="number">1</span>);</span><br><span class="line">            sa.recycle();</span><br><span class="line"></span><br><span class="line">            <span class="keyword">if</span> (pkg.mOverlayTarget == <span class="keyword">null</span>) &#123;</span><br><span class="line">                outError[<span class="number">0</span>] = <span class="string">"&lt;overlay&gt; does not specify a target package"</span>;</span><br><span class="line">                mParseError = PackageManager.INSTALL_PARSE_FAILED_MANIFEST_MALFORMED;</span><br><span class="line">                <span class="keyword">return</span> <span class="keyword">null</span>;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">if</span> (pkg.mOverlayPriority &lt; <span class="number">0</span> || pkg.mOverlayPriority &gt; <span class="number">9999</span>) &#123;</span><br><span class="line">                outError[<span class="number">0</span>] = <span class="string">"&lt;overlay&gt; priority must be between 0 and 9999"</span>;</span><br><span class="line">                mParseError =</span><br><span class="line">                    PackageManager.INSTALL_PARSE_FAILED_MANIFEST_MALFORMED;</span><br><span class="line">                <span class="keyword">return</span> <span class="keyword">null</span>;</span><br><span class="line">            &#125;</span><br><span class="line">            XmlUtils.skipCurrentTag(parser);</span><br><span class="line"></span><br><span class="line">        &#125; <span class="keyword">else</span> <span class="keyword">if</span> (tagName.equals(TAG_KEY_SETS)) &#123; <span class="comment">// 解析 'key-sets" 标签</span></span><br><span class="line">            <span class="keyword">if</span> (!parseKeySets(pkg, res, parser, outError)) &#123;</span><br><span class="line">                <span class="keyword">return</span> <span class="keyword">null</span>;</span><br><span class="line">            &#125;</span><br><span class="line">            </span><br><span class="line">        &#125; <span class="keyword">else</span> <span class="keyword">if</span> (tagName.equals(TAG_PERMISSION_GROUP)) &#123; <span class="comment">//【3.1.1.2.2.1】解析 'permission-group" 标签</span></span><br><span class="line">            <span class="keyword">if</span> (parsePermissionGroup(pkg, flags, res, parser, outError) == <span class="keyword">null</span>) &#123;</span><br><span class="line">                <span class="keyword">return</span> <span class="keyword">null</span>;</span><br><span class="line">            &#125;</span><br><span class="line">            </span><br><span class="line">        &#125; <span class="keyword">else</span> <span class="keyword">if</span> (tagName.equals(TAG_PERMISSION)) &#123; <span class="comment">//【3.1.1.2.2.2】解析 'permission" 标签</span></span><br><span class="line">            <span class="keyword">if</span> (parsePermission(pkg, res, parser, outError) == <span class="keyword">null</span>) &#123;</span><br><span class="line">                <span class="keyword">return</span> <span class="keyword">null</span>;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125; <span class="keyword">else</span> <span class="keyword">if</span> (tagName.equals(TAG_PERMISSION_TREE)) &#123; <span class="comment">//【3.1.1.2.2.3】解析 'permission-tree" 标签</span></span><br><span class="line">            <span class="keyword">if</span> (parsePermissionTree(pkg, res, parser, outError) == <span class="keyword">null</span>) &#123;</span><br><span class="line">                <span class="keyword">return</span> <span class="keyword">null</span>;</span><br><span class="line">            &#125;</span><br><span class="line">            </span><br><span class="line">        &#125; <span class="keyword">else</span> <span class="keyword">if</span> (tagName.equals(TAG_USES_PERMISSION)) &#123; <span class="comment">//【3.1.1.2.2.4】解析 'uses-permission" 标签</span></span><br><span class="line">            <span class="keyword">if</span> (!parseUsesPermission(pkg, res, parser)) &#123;</span><br><span class="line">                <span class="keyword">return</span> <span class="keyword">null</span>;</span><br><span class="line">            &#125;</span><br><span class="line">            </span><br><span class="line">        &#125; <span class="keyword">else</span> <span class="keyword">if</span> (tagName.equals(TAG_USES_PERMISSION_SDK_M)</span><br><span class="line">                || tagName.equals(TAG_USES_PERMISSION_SDK_23)) &#123; </span><br><span class="line">                </span><br><span class="line">            <span class="comment">// 解析 'uses-permission-sdk-m" 或 "uses-permission-sdk-23" 标签</span></span><br><span class="line">            <span class="keyword">if</span> (!parseUsesPermission(pkg, res, parser)) &#123;</span><br><span class="line">                <span class="keyword">return</span> <span class="keyword">null</span>;</span><br><span class="line">            &#125;</span><br><span class="line">            </span><br><span class="line">        &#125; <span class="keyword">else</span> <span class="keyword">if</span> (tagName.equals(TAG_USES_CONFIGURATION)) &#123; <span class="comment">// 解析 "uses-configuration" 标签</span></span><br><span class="line">            ConfigurationInfo cPref = <span class="keyword">new</span> ConfigurationInfo();</span><br><span class="line">            sa = res.obtainAttributes(parser,</span><br><span class="line">                    com.android.internal.R.styleable.AndroidManifestUsesConfiguration);</span><br><span class="line">            cPref.reqTouchScreen = sa.getInt(</span><br><span class="line">                    com.android.internal.R.styleable.AndroidManifestUsesConfiguration_reqTouchScreen,</span><br><span class="line">                    Configuration.TOUCHSCREEN_UNDEFINED);</span><br><span class="line">            cPref.reqKeyboardType = sa.getInt(</span><br><span class="line">                    com.android.internal.R.styleable.AndroidManifestUsesConfiguration_reqKeyboardType,</span><br><span class="line">                    Configuration.KEYBOARD_UNDEFINED);</span><br><span class="line">            <span class="keyword">if</span> (sa.getBoolean(</span><br><span class="line">                    com.android.internal.R.styleable.AndroidManifestUsesConfiguration_reqHardKeyboard,</span><br><span class="line">                    <span class="keyword">false</span>)) &#123;</span><br><span class="line">                cPref.reqInputFeatures |= ConfigurationInfo.INPUT_FEATURE_HARD_KEYBOARD;</span><br><span class="line">            &#125;</span><br><span class="line">            cPref.reqNavigation = sa.getInt(</span><br><span class="line">                    com.android.internal.R.styleable.AndroidManifestUsesConfiguration_reqNavigation,</span><br><span class="line">                    Configuration.NAVIGATION_UNDEFINED);</span><br><span class="line">            <span class="keyword">if</span> (sa.getBoolean(</span><br><span class="line">                    com.android.internal.R.styleable.AndroidManifestUsesConfiguration_reqFiveWayNav,</span><br><span class="line">                    <span class="keyword">false</span>)) &#123;</span><br><span class="line">                cPref.reqInputFeatures |= ConfigurationInfo.INPUT_FEATURE_FIVE_WAY_NAV;</span><br><span class="line">            &#125;</span><br><span class="line">            sa.recycle();</span><br><span class="line">            pkg.configPreferences = ArrayUtils.add(pkg.configPreferences, cPref);</span><br><span class="line"></span><br><span class="line">            XmlUtils.skipCurrentTag(parser);</span><br><span class="line"></span><br><span class="line">        &#125; <span class="keyword">else</span> <span class="keyword">if</span> (tagName.equals(TAG_USES_FEATURE)) &#123; <span class="comment">// 解析 "uses-feature" 标签</span></span><br><span class="line">            FeatureInfo fi = parseUsesFeature(res, parser);</span><br><span class="line">            pkg.reqFeatures = ArrayUtils.add(pkg.reqFeatures, fi);</span><br><span class="line"></span><br><span class="line">            <span class="keyword">if</span> (fi.name == <span class="keyword">null</span>) &#123;</span><br><span class="line">                ConfigurationInfo cPref = <span class="keyword">new</span> ConfigurationInfo();</span><br><span class="line">                cPref.reqGlEsVersion = fi.reqGlEsVersion;</span><br><span class="line">                pkg.configPreferences = ArrayUtils.add(pkg.configPreferences, cPref);</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            XmlUtils.skipCurrentTag(parser);</span><br><span class="line"></span><br><span class="line">        &#125; <span class="keyword">else</span> <span class="keyword">if</span> (tagName.equals(TAG_FEATURE_GROUP)) &#123;  <span class="comment">// 解析 "feature-group" 标签</span></span><br><span class="line">            FeatureGroupInfo group = <span class="keyword">new</span> FeatureGroupInfo();</span><br><span class="line">            ArrayList&lt;FeatureInfo&gt; features = <span class="keyword">null</span>;</span><br><span class="line">            <span class="keyword">final</span> <span class="keyword">int</span> innerDepth = parser.getDepth();</span><br><span class="line">            <span class="keyword">while</span> ((type = parser.next()) != XmlPullParser.END_DOCUMENT</span><br><span class="line">                    &amp;&amp; (type != XmlPullParser.END_TAG || parser.getDepth() &gt; innerDepth)) &#123;</span><br><span class="line">                <span class="keyword">if</span> (type == XmlPullParser.END_TAG || type == XmlPullParser.TEXT) &#123;</span><br><span class="line">                    <span class="keyword">continue</span>;</span><br><span class="line">                &#125;</span><br><span class="line"></span><br><span class="line">                <span class="keyword">final</span> String innerTagName = parser.getName();</span><br><span class="line">                <span class="keyword">if</span> (innerTagName.equals(<span class="string">"uses-feature"</span>)) &#123;</span><br><span class="line">                    FeatureInfo featureInfo = parseUsesFeature(res, parser);</span><br><span class="line">                    <span class="comment">// FeatureGroups are stricter and mandate that</span></span><br><span class="line">                    <span class="comment">// any &lt;uses-feature&gt; declared are mandatory.</span></span><br><span class="line">                    featureInfo.flags |= FeatureInfo.FLAG_REQUIRED;</span><br><span class="line">                    features = ArrayUtils.add(features, featureInfo);</span><br><span class="line">                &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                    Slog.w(TAG, <span class="string">"Unknown element under &lt;feature-group&gt;: "</span> + innerTagName +</span><br><span class="line">                            <span class="string">" at "</span> + mArchiveSourcePath + <span class="string">" "</span> +</span><br><span class="line">                            parser.getPositionDescription());</span><br><span class="line">                &#125;</span><br><span class="line">                XmlUtils.skipCurrentTag(parser);</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            <span class="keyword">if</span> (features != <span class="keyword">null</span>) &#123;</span><br><span class="line">                group.features = <span class="keyword">new</span> FeatureInfo[features.size()];</span><br><span class="line">                group.features = features.toArray(group.features);</span><br><span class="line">            &#125;</span><br><span class="line">            pkg.featureGroups = ArrayUtils.add(pkg.featureGroups, group);</span><br><span class="line"></span><br><span class="line">        &#125; <span class="keyword">else</span> <span class="keyword">if</span> (tagName.equals(TAG_USES_SDK)) &#123;  <span class="comment">// 解析 "uses-sdk" 标签</span></span><br><span class="line">            <span class="keyword">if</span> (SDK_VERSION &gt; <span class="number">0</span>) &#123;</span><br><span class="line">                sa = res.obtainAttributes(parser,</span><br><span class="line">                        com.android.internal.R.styleable.AndroidManifestUsesSdk);</span><br><span class="line"></span><br><span class="line">                <span class="keyword">int</span> minVers = <span class="number">1</span>;</span><br><span class="line">                String minCode = <span class="keyword">null</span>;</span><br><span class="line">                <span class="keyword">int</span> targetVers = <span class="number">0</span>;</span><br><span class="line">                String targetCode = <span class="keyword">null</span>;</span><br><span class="line"></span><br><span class="line">                TypedValue val = sa.peekValue(</span><br><span class="line">                        com.android.internal.R.styleable.AndroidManifestUsesSdk_minSdkVersion);</span><br><span class="line">                <span class="keyword">if</span> (val != <span class="keyword">null</span>) &#123;</span><br><span class="line">                    <span class="keyword">if</span> (val.type == TypedValue.TYPE_STRING &amp;&amp; val.string != <span class="keyword">null</span>) &#123;</span><br><span class="line">                        targetCode = minCode = val.string.toString();</span><br><span class="line">                    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                        <span class="comment">// If it's not a string, it's an integer.</span></span><br><span class="line">                        targetVers = minVers = val.data;</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;</span><br><span class="line"></span><br><span class="line">                val = sa.peekValue(</span><br><span class="line">                        com.android.internal.R.styleable.AndroidManifestUsesSdk_targetSdkVersion);</span><br><span class="line">                <span class="keyword">if</span> (val != <span class="keyword">null</span>) &#123;</span><br><span class="line">                    <span class="keyword">if</span> (val.type == TypedValue.TYPE_STRING &amp;&amp; val.string != <span class="keyword">null</span>) &#123;</span><br><span class="line">                        targetCode = val.string.toString();</span><br><span class="line">                        <span class="keyword">if</span> (minCode == <span class="keyword">null</span>) &#123;</span><br><span class="line">                            minCode = targetCode;</span><br><span class="line">                        &#125;</span><br><span class="line">                    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                        <span class="comment">// If it's not a string, it's an integer.</span></span><br><span class="line">                        targetVers = val.data;</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;</span><br><span class="line"></span><br><span class="line">                sa.recycle();</span><br><span class="line"></span><br><span class="line">                <span class="keyword">if</span> (minCode != <span class="keyword">null</span>) &#123;</span><br><span class="line">                    <span class="keyword">boolean</span> allowedCodename = <span class="keyword">false</span>;</span><br><span class="line">                    <span class="keyword">for</span> (String codename : SDK_CODENAMES) &#123;</span><br><span class="line">                        <span class="keyword">if</span> (minCode.equals(codename)) &#123;</span><br><span class="line">                            allowedCodename = <span class="keyword">true</span>;</span><br><span class="line">                            <span class="keyword">break</span>;</span><br><span class="line">                        &#125;</span><br><span class="line">                    &#125;</span><br><span class="line">                    <span class="keyword">if</span> (!allowedCodename) &#123;</span><br><span class="line">                        <span class="keyword">if</span> (SDK_CODENAMES.length &gt; <span class="number">0</span>) &#123;</span><br><span class="line">                            outError[<span class="number">0</span>] = <span class="string">"Requires development platform "</span> + minCode</span><br><span class="line">                                    + <span class="string">" (current platform is any of "</span></span><br><span class="line">                                    + Arrays.toString(SDK_CODENAMES) + <span class="string">")"</span>;</span><br><span class="line">                        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                            outError[<span class="number">0</span>] = <span class="string">"Requires development platform "</span> + minCode</span><br><span class="line">                                    + <span class="string">" but this is a release platform."</span>;</span><br><span class="line">                        &#125;</span><br><span class="line">                        mParseError = PackageManager.INSTALL_FAILED_OLDER_SDK;</span><br><span class="line">                        <span class="keyword">return</span> <span class="keyword">null</span>;</span><br><span class="line">                    &#125;</span><br><span class="line">                    pkg.applicationInfo.minSdkVersion =</span><br><span class="line">                            android.os.Build.VERSION_CODES.CUR_DEVELOPMENT;</span><br><span class="line">                &#125; <span class="keyword">else</span> <span class="keyword">if</span> (minVers &gt; SDK_VERSION) &#123;</span><br><span class="line">                    outError[<span class="number">0</span>] = <span class="string">"Requires newer sdk version #"</span> + minVers</span><br><span class="line">                            + <span class="string">" (current version is #"</span> + SDK_VERSION + <span class="string">")"</span>;</span><br><span class="line">                    mParseError = PackageManager.INSTALL_FAILED_OLDER_SDK;</span><br><span class="line">                    <span class="keyword">return</span> <span class="keyword">null</span>;</span><br><span class="line">                &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                    pkg.applicationInfo.minSdkVersion = minVers;</span><br><span class="line">                &#125;</span><br><span class="line"></span><br><span class="line">                <span class="keyword">if</span> (targetCode != <span class="keyword">null</span>) &#123;</span><br><span class="line">                    <span class="keyword">boolean</span> allowedCodename = <span class="keyword">false</span>;</span><br><span class="line">                    <span class="keyword">for</span> (String codename : SDK_CODENAMES) &#123;</span><br><span class="line">                        <span class="keyword">if</span> (targetCode.equals(codename)) &#123;</span><br><span class="line">                            allowedCodename = <span class="keyword">true</span>;</span><br><span class="line">                            <span class="keyword">break</span>;</span><br><span class="line">                        &#125;</span><br><span class="line">                    &#125;</span><br><span class="line">                    <span class="keyword">if</span> (!allowedCodename) &#123;</span><br><span class="line">                        <span class="keyword">if</span> (SDK_CODENAMES.length &gt; <span class="number">0</span>) &#123;</span><br><span class="line">                            outError[<span class="number">0</span>] = <span class="string">"Requires development platform "</span> + targetCode</span><br><span class="line">                                    + <span class="string">" (current platform is any of "</span></span><br><span class="line">                                    + Arrays.toString(SDK_CODENAMES) + <span class="string">")"</span>;</span><br><span class="line">                        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                            outError[<span class="number">0</span>] = <span class="string">"Requires development platform "</span> + targetCode</span><br><span class="line">                                    + <span class="string">" but this is a release platform."</span>;</span><br><span class="line">                        &#125;</span><br><span class="line">                        mParseError = PackageManager.INSTALL_FAILED_OLDER_SDK;</span><br><span class="line">                        <span class="keyword">return</span> <span class="keyword">null</span>;</span><br><span class="line">                    &#125;</span><br><span class="line">                    <span class="comment">// If the code matches, it definitely targets this SDK.</span></span><br><span class="line">                    pkg.applicationInfo.targetSdkVersion</span><br><span class="line">                            = android.os.Build.VERSION_CODES.CUR_DEVELOPMENT;</span><br><span class="line">                &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                    pkg.applicationInfo.targetSdkVersion = targetVers;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            XmlUtils.skipCurrentTag(parser);</span><br><span class="line"></span><br><span class="line">        &#125; <span class="keyword">else</span> <span class="keyword">if</span> (tagName.equals(TAG_SUPPORT_SCREENS)) &#123;  <span class="comment">// 解析 "supports-screens" 标签</span></span><br><span class="line">            sa = res.obtainAttributes(parser,</span><br><span class="line">                    com.android.internal.R.styleable.AndroidManifestSupportsScreens);</span><br><span class="line"></span><br><span class="line">            pkg.applicationInfo.requiresSmallestWidthDp = sa.getInteger(</span><br><span class="line">                    com.android.internal.R.styleable.AndroidManifestSupportsScreens_requiresSmallestWidthDp,</span><br><span class="line">                    <span class="number">0</span>);</span><br><span class="line">            pkg.applicationInfo.compatibleWidthLimitDp = sa.getInteger(</span><br><span class="line">                    com.android.internal.R.styleable.AndroidManifestSupportsScreens_compatibleWidthLimitDp,</span><br><span class="line">                    <span class="number">0</span>);</span><br><span class="line">            pkg.applicationInfo.largestWidthLimitDp = sa.getInteger(</span><br><span class="line">                    com.android.internal.R.styleable.AndroidManifestSupportsScreens_largestWidthLimitDp,</span><br><span class="line">                    <span class="number">0</span>);</span><br><span class="line"></span><br><span class="line">            <span class="comment">// 和屏幕相关的参数解析，屏幕大小等等！</span></span><br><span class="line">            supportsSmallScreens = sa.getInteger(</span><br><span class="line">                    com.android.internal.R.styleable.AndroidManifestSupportsScreens_smallScreens,</span><br><span class="line">                    supportsSmallScreens);</span><br><span class="line">            supportsNormalScreens = sa.getInteger(</span><br><span class="line">                    com.android.internal.R.styleable.AndroidManifestSupportsScreens_normalScreens,</span><br><span class="line">                    supportsNormalScreens);</span><br><span class="line">            supportsLargeScreens = sa.getInteger(</span><br><span class="line">                    com.android.internal.R.styleable.AndroidManifestSupportsScreens_largeScreens,</span><br><span class="line">                    supportsLargeScreens);</span><br><span class="line">            supportsXLargeScreens = sa.getInteger(</span><br><span class="line">                    com.android.internal.R.styleable.AndroidManifestSupportsScreens_xlargeScreens,</span><br><span class="line">                    supportsXLargeScreens);</span><br><span class="line">            resizeable = sa.getInteger(</span><br><span class="line">                    com.android.internal.R.styleable.AndroidManifestSupportsScreens_resizeable,</span><br><span class="line">                    resizeable);</span><br><span class="line">            anyDensity = sa.getInteger(</span><br><span class="line">                    com.android.internal.R.styleable.AndroidManifestSupportsScreens_anyDensity,</span><br><span class="line">                    anyDensity);</span><br><span class="line"></span><br><span class="line">            sa.recycle();</span><br><span class="line"></span><br><span class="line">            XmlUtils.skipCurrentTag(parser);</span><br><span class="line"></span><br><span class="line">        &#125; <span class="keyword">else</span> <span class="keyword">if</span> (tagName.equals(TAG_PROTECTED_BROADCAST)) &#123; <span class="comment">// 解析 "protected-broadcast" 标签</span></span><br><span class="line">            sa = res.obtainAttributes(parser,</span><br><span class="line">                    com.android.internal.R.styleable.AndroidManifestProtectedBroadcast);</span><br><span class="line"></span><br><span class="line">            <span class="comment">// Note: don't allow this value to be a reference to a resource</span></span><br><span class="line">            <span class="comment">// that may change.</span></span><br><span class="line">            String name = sa.getNonResourceString(</span><br><span class="line">                    com.android.internal.R.styleable.AndroidManifestProtectedBroadcast_name);</span><br><span class="line"></span><br><span class="line">            sa.recycle();</span><br><span class="line"></span><br><span class="line">            <span class="keyword">if</span> (name != <span class="keyword">null</span> &amp;&amp; (flags&amp;PARSE_IS_SYSTEM) != <span class="number">0</span>) &#123;</span><br><span class="line">                <span class="keyword">if</span> (pkg.protectedBroadcasts == <span class="keyword">null</span>) &#123;</span><br><span class="line">                    pkg.protectedBroadcasts = <span class="keyword">new</span> ArrayList&lt;String&gt;();</span><br><span class="line">                &#125;</span><br><span class="line">                <span class="keyword">if</span> (!pkg.protectedBroadcasts.contains(name)) &#123;</span><br><span class="line">                    pkg.protectedBroadcasts.add(name.intern());</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            XmlUtils.skipCurrentTag(parser);</span><br><span class="line"></span><br><span class="line">        &#125; <span class="keyword">else</span> <span class="keyword">if</span> (tagName.equals(TAG_INSTRUMENTATION)) &#123;  <span class="comment">// 解析 "instrumentation" 标签</span></span><br><span class="line">            <span class="keyword">if</span> (parseInstrumentation(pkg, res, parser, outError) == <span class="keyword">null</span>) &#123;</span><br><span class="line">                <span class="keyword">return</span> <span class="keyword">null</span>;</span><br><span class="line">            &#125;</span><br><span class="line">        </span><br><span class="line">        &#125; <span class="keyword">else</span> <span class="keyword">if</span> (tagName.equals(TAG_ORIGINAL_PACKAGE)) &#123; <span class="comment">// 解析 "original-package" 标签</span></span><br><span class="line">            sa = res.obtainAttributes(parser,</span><br><span class="line">                    com.android.internal.R.styleable.AndroidManifestOriginalPackage);</span><br><span class="line"></span><br><span class="line">            String orig =sa.getNonConfigurationString(</span><br><span class="line">                    com.android.internal.R.styleable.AndroidManifestOriginalPackage_name, <span class="number">0</span>);</span><br><span class="line">            <span class="keyword">if</span> (!pkg.packageName.equals(orig)) &#123;</span><br><span class="line">                <span class="keyword">if</span> (pkg.mOriginalPackages == <span class="keyword">null</span>) &#123;</span><br><span class="line">                    pkg.mOriginalPackages = <span class="keyword">new</span> ArrayList&lt;String&gt;();</span><br><span class="line">                    pkg.mRealPackage = pkg.packageName;</span><br><span class="line">                &#125;</span><br><span class="line">                pkg.mOriginalPackages.add(orig);</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            sa.recycle();</span><br><span class="line"></span><br><span class="line">            XmlUtils.skipCurrentTag(parser);</span><br><span class="line"></span><br><span class="line">        &#125; <span class="keyword">else</span> <span class="keyword">if</span> (tagName.equals(TAG_ADOPT_PERMISSIONS)) &#123; <span class="comment">// 解析 "adopt-permissions" 标签</span></span><br><span class="line">            sa = res.obtainAttributes(parser,</span><br><span class="line">                    com.android.internal.R.styleable.AndroidManifestOriginalPackage);</span><br><span class="line"></span><br><span class="line">            String name = sa.getNonConfigurationString(</span><br><span class="line">                    com.android.internal.R.styleable.AndroidManifestOriginalPackage_name, <span class="number">0</span>);</span><br><span class="line"></span><br><span class="line">            sa.recycle();</span><br><span class="line"></span><br><span class="line">            <span class="keyword">if</span> (name != <span class="keyword">null</span>) &#123;</span><br><span class="line">                <span class="keyword">if</span> (pkg.mAdoptPermissions == <span class="keyword">null</span>) &#123;</span><br><span class="line">                    pkg.mAdoptPermissions = <span class="keyword">new</span> ArrayList&lt;String&gt;();</span><br><span class="line">                &#125;</span><br><span class="line">                pkg.mAdoptPermissions.add(name);</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            XmlUtils.skipCurrentTag(parser);</span><br><span class="line"></span><br><span class="line">        &#125; <span class="keyword">else</span> <span class="keyword">if</span> (tagName.equals(TAG_USES_GL_TEXTURE)) &#123;  <span class="comment">// 跳过一下标签！</span></span><br><span class="line">            <span class="comment">// Just skip this tag</span></span><br><span class="line">            XmlUtils.skipCurrentTag(parser);</span><br><span class="line">            <span class="keyword">continue</span>;</span><br><span class="line"></span><br><span class="line">        &#125; <span class="keyword">else</span> <span class="keyword">if</span> (tagName.equals(TAG_COMPATIBLE_SCREENS)) &#123;</span><br><span class="line">            <span class="comment">// Just skip this tag</span></span><br><span class="line">            XmlUtils.skipCurrentTag(parser);</span><br><span class="line">            <span class="keyword">continue</span>;</span><br><span class="line">            </span><br><span class="line">        &#125; <span class="keyword">else</span> <span class="keyword">if</span> (tagName.equals(TAG_SUPPORTS_INPUT)) &#123; </span><br><span class="line">            XmlUtils.skipCurrentTag(parser);</span><br><span class="line">            <span class="keyword">continue</span>;</span><br><span class="line"></span><br><span class="line">        &#125; <span class="keyword">else</span> <span class="keyword">if</span> (tagName.equals(TAG_EAT_COMMENT)) &#123; </span><br><span class="line">            <span class="comment">// Just skip this tag</span></span><br><span class="line">            XmlUtils.skipCurrentTag(parser);</span><br><span class="line">            <span class="keyword">continue</span>;</span><br><span class="line"></span><br><span class="line">        &#125; <span class="keyword">else</span> <span class="keyword">if</span> (tagName.equals(TAG_PACKAGE)) &#123; <span class="comment">// 解析 "package" 标签，该标签表示应用的子包！</span></span><br><span class="line">            <span class="keyword">if</span> (!MULTI_PACKAGE_APK_ENABLED) &#123;</span><br><span class="line">                XmlUtils.skipCurrentTag(parser);</span><br><span class="line">                <span class="keyword">continue</span>;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="comment">// 所有的子包都会解析保存到 ArrayList&lt;Package&gt; childPackages 集合中！</span></span><br><span class="line">            <span class="keyword">if</span> (!parseBaseApkChild(pkg, res, parser, flags, outError)) &#123;</span><br><span class="line">                <span class="comment">// If parsing a child failed the error is already set</span></span><br><span class="line">                <span class="keyword">return</span> <span class="keyword">null</span>;</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">        &#125; <span class="keyword">else</span> <span class="keyword">if</span> (tagName.equals(TAG_RESTRICT_UPDATE)) &#123;  <span class="comment">// 解析 "restrict-update" 标签</span></span><br><span class="line">            <span class="keyword">if</span> ((flags &amp; PARSE_IS_SYSTEM_DIR) != <span class="number">0</span>) &#123;</span><br><span class="line">                sa = res.obtainAttributes(parser,</span><br><span class="line">                        com.android.internal.R.styleable.AndroidManifestRestrictUpdate);</span><br><span class="line">                <span class="keyword">final</span> String hash = sa.getNonConfigurationString(</span><br><span class="line">                        com.android.internal.R.styleable.AndroidManifestRestrictUpdate_hash, <span class="number">0</span>);</span><br><span class="line">                sa.recycle();</span><br><span class="line"></span><br><span class="line">                pkg.restrictUpdateHash = <span class="keyword">null</span>;</span><br><span class="line">                <span class="keyword">if</span> (hash != <span class="keyword">null</span>) &#123;</span><br><span class="line">                    <span class="keyword">final</span> <span class="keyword">int</span> hashLength = hash.length();</span><br><span class="line">                    <span class="keyword">final</span> <span class="keyword">byte</span>[] hashBytes = <span class="keyword">new</span> <span class="keyword">byte</span>[hashLength / <span class="number">2</span>];</span><br><span class="line">                    <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; hashLength; i += <span class="number">2</span>)&#123;</span><br><span class="line">                        hashBytes[i/<span class="number">2</span>] = (<span class="keyword">byte</span>) ((Character.digit(hash.charAt(i), <span class="number">16</span>) &lt;&lt; <span class="number">4</span>)</span><br><span class="line">                                + Character.digit(hash.charAt(i + <span class="number">1</span>), <span class="number">16</span>));</span><br><span class="line">                    &#125;</span><br><span class="line">                    pkg.restrictUpdateHash = hashBytes;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            XmlUtils.skipCurrentTag(parser);</span><br><span class="line"></span><br><span class="line">        &#125; <span class="keyword">else</span> <span class="keyword">if</span> (RIGID_PARSER) &#123;</span><br><span class="line">            outError[<span class="number">0</span>] = <span class="string">"Bad element under &lt;manifest&gt;: "</span></span><br><span class="line">                + parser.getName();</span><br><span class="line">            mParseError = PackageManager.INSTALL_PARSE_FAILED_MANIFEST_MALFORMED;</span><br><span class="line">            <span class="keyword">return</span> <span class="keyword">null</span>;</span><br><span class="line"></span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            Slog.w(TAG, <span class="string">"Unknown element under &lt;manifest&gt;: "</span> + parser.getName()</span><br><span class="line">                    + <span class="string">" at "</span> + mArchiveSourcePath + <span class="string">" "</span></span><br><span class="line">                    + parser.getPositionDescription());</span><br><span class="line">            XmlUtils.skipCurrentTag(parser);</span><br><span class="line">            <span class="keyword">continue</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (!foundApp &amp;&amp; pkg.instrumentation.size() == <span class="number">0</span>) &#123;</span><br><span class="line">        outError[<span class="number">0</span>] = <span class="string">"&lt;manifest&gt; does not contain an &lt;application&gt; or &lt;instrumentation&gt;"</span>;</span><br><span class="line">        mParseError = PackageManager.INSTALL_PARSE_FAILED_MANIFEST_EMPTY;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">final</span> <span class="keyword">int</span> NP = PackageParser.NEW_PERMISSIONS.length;</span><br><span class="line">    StringBuilder implicitPerms = <span class="keyword">null</span>;</span><br><span class="line">    <span class="keyword">for</span> (<span class="keyword">int</span> ip=<span class="number">0</span>; ip&lt;NP; ip++) &#123;</span><br><span class="line">        <span class="keyword">final</span> PackageParser.NewPermissionInfo npi</span><br><span class="line">                = PackageParser.NEW_PERMISSIONS[ip];</span><br><span class="line">        <span class="keyword">if</span> (pkg.applicationInfo.targetSdkVersion &gt;= npi.sdkVersion) &#123;</span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">if</span> (!pkg.requestedPermissions.contains(npi.name)) &#123;</span><br><span class="line">            <span class="keyword">if</span> (implicitPerms == <span class="keyword">null</span>) &#123;</span><br><span class="line">                implicitPerms = <span class="keyword">new</span> StringBuilder(<span class="number">128</span>);</span><br><span class="line">                implicitPerms.append(pkg.packageName);</span><br><span class="line">                implicitPerms.append(<span class="string">": compat added "</span>);</span><br><span class="line">            &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                implicitPerms.append(<span class="string">' '</span>);</span><br><span class="line">            &#125;</span><br><span class="line">            implicitPerms.append(npi.name);</span><br><span class="line">            pkg.requestedPermissions.add(npi.name);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span> (implicitPerms != <span class="keyword">null</span>) &#123;</span><br><span class="line">        Slog.i(TAG, implicitPerms.toString());</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">final</span> <span class="keyword">int</span> NS = PackageParser.SPLIT_PERMISSIONS.length;</span><br><span class="line">    <span class="keyword">for</span> (<span class="keyword">int</span> is=<span class="number">0</span>; is&lt;NS; is++) &#123;</span><br><span class="line">        <span class="keyword">final</span> PackageParser.SplitPermissionInfo spi</span><br><span class="line">                = PackageParser.SPLIT_PERMISSIONS[is];</span><br><span class="line">        <span class="keyword">if</span> (pkg.applicationInfo.targetSdkVersion &gt;= spi.targetSdk</span><br><span class="line">                || !pkg.requestedPermissions.contains(spi.rootPerm)) &#123;</span><br><span class="line">            <span class="keyword">continue</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">for</span> (<span class="keyword">int</span> in=<span class="number">0</span>; in&lt;spi.newPerms.length; in++) &#123;</span><br><span class="line">            <span class="keyword">final</span> String perm = spi.newPerms[in];</span><br><span class="line">            <span class="keyword">if</span> (!pkg.requestedPermissions.contains(perm)) &#123;</span><br><span class="line">                pkg.requestedPermissions.add(perm);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 解析屏幕大小、像素密度相关的属性！</span></span><br><span class="line">    <span class="keyword">if</span> (supportsSmallScreens &lt; <span class="number">0</span> || (supportsSmallScreens &gt; <span class="number">0</span></span><br><span class="line">            &amp;&amp; pkg.applicationInfo.targetSdkVersion</span><br><span class="line">                    &gt;= android.os.Build.VERSION_CODES.DONUT)) &#123;</span><br><span class="line">        pkg.applicationInfo.flags |= ApplicationInfo.FLAG_SUPPORTS_SMALL_SCREENS;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span> (supportsNormalScreens != <span class="number">0</span>) &#123;</span><br><span class="line">        pkg.applicationInfo.flags |= ApplicationInfo.FLAG_SUPPORTS_NORMAL_SCREENS;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span> (supportsLargeScreens &lt; <span class="number">0</span> || (supportsLargeScreens &gt; <span class="number">0</span></span><br><span class="line">            &amp;&amp; pkg.applicationInfo.targetSdkVersion</span><br><span class="line">                    &gt;= android.os.Build.VERSION_CODES.DONUT)) &#123;</span><br><span class="line">        pkg.applicationInfo.flags |= ApplicationInfo.FLAG_SUPPORTS_LARGE_SCREENS;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span> (supportsXLargeScreens &lt; <span class="number">0</span> || (supportsXLargeScreens &gt; <span class="number">0</span></span><br><span class="line">            &amp;&amp; pkg.applicationInfo.targetSdkVersion</span><br><span class="line">                    &gt;= android.os.Build.VERSION_CODES.GINGERBREAD)) &#123;</span><br><span class="line">        pkg.applicationInfo.flags |= ApplicationInfo.FLAG_SUPPORTS_XLARGE_SCREENS;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span> (resizeable &lt; <span class="number">0</span> || (resizeable &gt; <span class="number">0</span></span><br><span class="line">            &amp;&amp; pkg.applicationInfo.targetSdkVersion</span><br><span class="line">                    &gt;= android.os.Build.VERSION_CODES.DONUT)) &#123;</span><br><span class="line">        pkg.applicationInfo.flags |= ApplicationInfo.FLAG_RESIZEABLE_FOR_SCREENS;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span> (anyDensity &lt; <span class="number">0</span> || (anyDensity &gt; <span class="number">0</span></span><br><span class="line">            &amp;&amp; pkg.applicationInfo.targetSdkVersion</span><br><span class="line">                    &gt;= android.os.Build.VERSION_CODES.DONUT)) &#123;</span><br><span class="line">        pkg.applicationInfo.flags |= ApplicationInfo.FLAG_SUPPORTS_SCREEN_DENSITIES;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// 返回 Package 对象！</span></span><br><span class="line">    <span class="keyword">return</span> pkg;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>在这个方法中，解析 apk 中的四大组件，权限等信息，核心 apk 解析到此为止！</p>
<h6 id="3-1-1-2-2-1-PParser-parsePermissionGroup-解析-permission-group"><a href="#3-1-1-2-2-1-PParser-parsePermissionGroup-解析-permission-group" class="headerlink" title="3.1.1.2.2.1 PParser.parsePermissionGroup - 解析 permission-group"></a>3.1.1.2.2.1 PParser.parsePermissionGroup - 解析 permission-group</h6><p>parsePermissionGroup 用于解析该应用所使用到的 permission-group：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">private</span> PermissionGroup <span class="title">parsePermissionGroup</span><span class="params">(Package owner, <span class="keyword">int</span> flags, Resources res,</span></span></span><br><span class="line"><span class="function"><span class="params">        XmlResourceParser parser, String[] outError)</span></span></span><br><span class="line"><span class="function">        <span class="keyword">throws</span> XmlPullParserException, IOException </span>&#123;</span><br><span class="line">    <span class="comment">//【1】对于权限组，创建了 PermissionGroup 对象！</span></span><br><span class="line">    PermissionGroup perm = <span class="keyword">new</span> PermissionGroup(owner);</span><br><span class="line"></span><br><span class="line">    TypedArray sa = res.obtainAttributes(parser,</span><br><span class="line">            com.android.internal.R.styleable.AndroidManifestPermissionGroup);</span><br><span class="line">    <span class="keyword">if</span> (!parsePackageItemInfo(owner, perm.info, outError,</span><br><span class="line">            <span class="string">"&lt;permission-group&gt;"</span>, sa, <span class="keyword">true</span> <span class="comment">/*nameRequired*/</span>,</span><br><span class="line">            com.android.internal.R.styleable.AndroidManifestPermissionGroup_name,</span><br><span class="line">            com.android.internal.R.styleable.AndroidManifestPermissionGroup_label,</span><br><span class="line">            com.android.internal.R.styleable.AndroidManifestPermissionGroup_icon,</span><br><span class="line">            com.android.internal.R.styleable.AndroidManifestPermissionGroup_roundIcon,</span><br><span class="line">            com.android.internal.R.styleable.AndroidManifestPermissionGroup_logo,</span><br><span class="line">            com.android.internal.R.styleable.AndroidManifestPermissionGroup_banner)) &#123;</span><br><span class="line">        sa.recycle();</span><br><span class="line">        mParseError = PackageManager.INSTALL_PARSE_FAILED_MANIFEST_MALFORMED;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">null</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">//【2】解析相关的属性</span></span><br><span class="line">    perm.info.descriptionRes = sa.getResourceId(</span><br><span class="line">            com.android.internal.R.styleable.AndroidManifestPermissionGroup_description,</span><br><span class="line">            <span class="number">0</span>);</span><br><span class="line">    perm.info.flags = sa.getInt(</span><br><span class="line">            com.android.internal.R.styleable.AndroidManifestPermissionGroup_permissionGroupFlags, <span class="number">0</span>);</span><br><span class="line">    perm.info.priority = sa.getInt(</span><br><span class="line">            com.android.internal.R.styleable.AndroidManifestPermissionGroup_priority, <span class="number">0</span>);</span><br><span class="line">    <span class="keyword">if</span> (perm.info.priority &gt; <span class="number">0</span> &amp;&amp; (flags&amp;PARSE_IS_SYSTEM) == <span class="number">0</span>) &#123;</span><br><span class="line">        perm.info.priority = <span class="number">0</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    sa.recycle();</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (!parseAllMetaData(res, parser, <span class="string">"&lt;permission-group&gt;"</span>, perm,</span><br><span class="line">            outError)) &#123;</span><br><span class="line">        mParseError = PackageManager.INSTALL_PARSE_FAILED_MANIFEST_MALFORMED;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">null</span>;</span><br><span class="line">    &#125;</span><br><span class="line">     <span class="comment">//【3】保存到 owner.permissionGroups 中！</span></span><br><span class="line">    owner.permissionGroups.add(perm);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> perm;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>这里就不多说了！</p>
<h6 id="3-1-1-2-2-2-PParser-parsePermission-解析-permission"><a href="#3-1-1-2-2-2-PParser-parsePermission-解析-permission" class="headerlink" title="3.1.1.2.2.2 PParser.parsePermission - 解析 permission"></a>3.1.1.2.2.2 PParser.parsePermission - 解析 permission</h6><p>parsePermission 解析该应用中定义的权限！<br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">private</span> Permission <span class="title">parsePermission</span><span class="params">(Package owner, Resources res,</span></span></span><br><span class="line"><span class="function"><span class="params">        XmlResourceParser parser, String[] outError)</span></span></span><br><span class="line"><span class="function">    <span class="keyword">throws</span> XmlPullParserException, IOException </span>&#123;</span><br><span class="line">    <span class="comment">//【1】创建 Permission 对象</span></span><br><span class="line">    Permission perm = <span class="keyword">new</span> Permission(owner);</span><br><span class="line"></span><br><span class="line">    TypedArray sa = res.obtainAttributes(parser,</span><br><span class="line">            com.android.internal.R.styleable.AndroidManifestPermission);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (!parsePackageItemInfo(owner, perm.info, outError,</span><br><span class="line">            <span class="string">"&lt;permission&gt;"</span>, sa, <span class="keyword">true</span> <span class="comment">/*nameRequired*/</span>,</span><br><span class="line">            com.android.internal.R.styleable.AndroidManifestPermission_name,</span><br><span class="line">            com.android.internal.R.styleable.AndroidManifestPermission_label,</span><br><span class="line">            com.android.internal.R.styleable.AndroidManifestPermission_icon,</span><br><span class="line">            com.android.internal.R.styleable.AndroidManifestPermission_roundIcon,</span><br><span class="line">            com.android.internal.R.styleable.AndroidManifestPermission_logo,</span><br><span class="line">            com.android.internal.R.styleable.AndroidManifestPermission_banner)) &#123;</span><br><span class="line">        sa.recycle();</span><br><span class="line">        mParseError = PackageManager.INSTALL_PARSE_FAILED_MANIFEST_MALFORMED;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">null</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 解析 android:permissionGroup 属性</span></span><br><span class="line">    perm.info.group = sa.getNonResourceString(</span><br><span class="line">            com.android.internal.R.styleable.AndroidManifestPermission_permissionGroup);</span><br><span class="line">    <span class="keyword">if</span> (perm.info.group != <span class="keyword">null</span>) &#123;</span><br><span class="line">        perm.info.group = perm.info.group.intern();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    perm.info.descriptionRes = sa.getResourceId(</span><br><span class="line">            com.android.internal.R.styleable.AndroidManifestPermission_description,</span><br><span class="line">            <span class="number">0</span>);</span><br><span class="line">    <span class="comment">// 解析 android:protectionLevel 属性</span></span><br><span class="line">    perm.info.protectionLevel = sa.getInt(</span><br><span class="line">            com.android.internal.R.styleable.AndroidManifestPermission_protectionLevel,</span><br><span class="line">            PermissionInfo.PROTECTION_NORMAL);</span><br><span class="line">    <span class="comment">// 解析 android:permissionFlags 属性</span></span><br><span class="line">    perm.info.flags = sa.getInt(</span><br><span class="line">            com.android.internal.R.styleable.AndroidManifestPermission_permissionFlags, <span class="number">0</span>);</span><br><span class="line"></span><br><span class="line">    sa.recycle();</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (perm.info.protectionLevel == -<span class="number">1</span>) &#123;</span><br><span class="line">        outError[<span class="number">0</span>] = <span class="string">"&lt;permission&gt; does not specify protectionLevel"</span>;</span><br><span class="line">        mParseError = PackageManager.INSTALL_PARSE_FAILED_MANIFEST_MALFORMED;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">null</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    perm.info.protectionLevel = PermissionInfo.fixProtectionLevel(perm.info.protectionLevel);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> ((perm.info.protectionLevel&amp;PermissionInfo.PROTECTION_MASK_FLAGS) != <span class="number">0</span>) &#123;</span><br><span class="line">        <span class="keyword">if</span> ((perm.info.protectionLevel&amp;PermissionInfo.PROTECTION_MASK_BASE) !=</span><br><span class="line">                PermissionInfo.PROTECTION_SIGNATURE) &#123;</span><br><span class="line">            outError[<span class="number">0</span>] = <span class="string">"&lt;permission&gt;  protectionLevel specifies a flag but is "</span></span><br><span class="line">                    + <span class="string">"not based on signature type"</span>;</span><br><span class="line">            mParseError = PackageManager.INSTALL_PARSE_FAILED_MANIFEST_MALFORMED;</span><br><span class="line">            <span class="keyword">return</span> <span class="keyword">null</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (!parseAllMetaData(res, parser, <span class="string">"&lt;permission&gt;"</span>, perm, outError)) &#123;</span><br><span class="line">        mParseError = PackageManager.INSTALL_PARSE_FAILED_MANIFEST_MALFORMED;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">null</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// 将解析的权限信息保存到 owner.permissions 中！</span></span><br><span class="line">    owner.permissions.add(perm);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> perm;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>解析很简单，不多说了！</p>
<h6 id="3-1-1-2-2-3-PParser-parsePermissionTree-解析-permission-tree"><a href="#3-1-1-2-2-3-PParser-parsePermissionTree-解析-permission-tree" class="headerlink" title="3.1.1.2.2.3 PParser.parsePermissionTree - 解析 permission-tree"></a>3.1.1.2.2.3 PParser.parsePermissionTree - 解析 permission-tree</h6><p>parsePermissionTree 用于解析该应用所使用到的 permission-tree：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">private</span> Permission <span class="title">parsePermissionTree</span><span class="params">(Package owner, Resources res,</span></span></span><br><span class="line"><span class="function"><span class="params">        XmlResourceParser parser, String[] outError)</span></span></span><br><span class="line"><span class="function">    <span class="keyword">throws</span> XmlPullParserException, IOException </span>&#123; </span><br><span class="line">    <span class="comment">//【1】可以看到对于 permission-tree，依然是会创建一个 Permission 对象！</span></span><br><span class="line">    Permission perm = <span class="keyword">new</span> Permission(owner);</span><br><span class="line"></span><br><span class="line">    TypedArray sa = res.obtainAttributes(parser,</span><br><span class="line">            com.android.internal.R.styleable.AndroidManifestPermissionTree);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (!parsePackageItemInfo(owner, perm.info, outError,</span><br><span class="line">            <span class="string">"&lt;permission-tree&gt;"</span>, sa, <span class="keyword">true</span> <span class="comment">/*nameRequired*/</span>,</span><br><span class="line">            com.android.internal.R.styleable.AndroidManifestPermissionTree_name,</span><br><span class="line">            com.android.internal.R.styleable.AndroidManifestPermissionTree_label,</span><br><span class="line">            com.android.internal.R.styleable.AndroidManifestPermissionTree_icon,</span><br><span class="line">            com.android.internal.R.styleable.AndroidManifestPermissionTree_roundIcon,</span><br><span class="line">            com.android.internal.R.styleable.AndroidManifestPermissionTree_logo,</span><br><span class="line">            com.android.internal.R.styleable.AndroidManifestPermissionTree_banner)) &#123;</span><br><span class="line">        sa.recycle();</span><br><span class="line">        mParseError = PackageManager.INSTALL_PARSE_FAILED_MANIFEST_MALFORMED;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">null</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    sa.recycle();</span><br><span class="line"></span><br><span class="line">    <span class="comment">//【2】解析权限的属性；</span></span><br><span class="line">    <span class="keyword">int</span> index = perm.info.name.indexOf(<span class="string">'.'</span>);</span><br><span class="line">    <span class="keyword">if</span> (index &gt; <span class="number">0</span>) &#123;</span><br><span class="line">        index = perm.info.name.indexOf(<span class="string">'.'</span>, index+<span class="number">1</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span> (index &lt; <span class="number">0</span>) &#123;</span><br><span class="line">        outError[<span class="number">0</span>] = <span class="string">"&lt;permission-tree&gt; name has less than three segments: "</span></span><br><span class="line">            + perm.info.name;</span><br><span class="line">        mParseError = PackageManager.INSTALL_PARSE_FAILED_MANIFEST_MALFORMED;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">null</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    perm.info.descriptionRes = <span class="number">0</span>;</span><br><span class="line">    perm.info.protectionLevel = PermissionInfo.PROTECTION_NORMAL;</span><br><span class="line">    perm.tree = <span class="keyword">true</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (!parseAllMetaData(res, parser, <span class="string">"&lt;permission-tree&gt;"</span>, perm,</span><br><span class="line">            outError)) &#123; <span class="comment">// 解析 meta-data，这里不关注！</span></span><br><span class="line">        mParseError = PackageManager.INSTALL_PARSE_FAILED_MANIFEST_MALFORMED;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">null</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">//【3】将该 Permission 对象添加到 owner.permissions 中！</span></span><br><span class="line">    owner.permissions.add(perm);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> perm;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h6 id="3-1-1-2-2-4-PParser-parseUsesPermission-解析-uses-permission"><a href="#3-1-1-2-2-4-PParser-parseUsesPermission-解析-uses-permission" class="headerlink" title="3.1.1.2.2.4 PParser.parseUsesPermission - 解析 uses-permission"></a>3.1.1.2.2.4 PParser.parseUsesPermission - 解析 uses-permission</h6><p>parseUsesPermission 解析该应用所使用的权限！</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">boolean</span> <span class="title">parseUsesPermission</span><span class="params">(Package pkg, Resources res, XmlResourceParser parser)</span></span></span><br><span class="line"><span class="function">        <span class="keyword">throws</span> XmlPullParserException, IOException </span>&#123;</span><br><span class="line">    TypedArray sa = res.obtainAttributes(parser,</span><br><span class="line">            com.android.internal.R.styleable.AndroidManifestUsesPermission);</span><br><span class="line"></span><br><span class="line">    String name = sa.getNonResourceString(</span><br><span class="line">            com.android.internal.R.styleable.AndroidManifestUsesPermission_name);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">int</span> maxSdkVersion = <span class="number">0</span>;</span><br><span class="line">    TypedValue val = sa.peekValue(</span><br><span class="line">            com.android.internal.R.styleable.AndroidManifestUsesPermission_maxSdkVersion);</span><br><span class="line">    <span class="keyword">if</span> (val != <span class="keyword">null</span>) &#123;</span><br><span class="line">        <span class="keyword">if</span> (val.type &gt;= TypedValue.TYPE_FIRST_INT &amp;&amp; val.type &lt;= TypedValue.TYPE_LAST_INT) &#123;</span><br><span class="line">            maxSdkVersion = val.data;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    sa.recycle();</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> ((maxSdkVersion == <span class="number">0</span>) || (maxSdkVersion &gt;= Build.VERSION.RESOURCES_SDK_INT)) &#123;</span><br><span class="line">        <span class="keyword">if</span> (name != <span class="keyword">null</span>) &#123;</span><br><span class="line">            <span class="keyword">int</span> index = pkg.requestedPermissions.indexOf(name);</span><br><span class="line">            <span class="keyword">if</span> (index == -<span class="number">1</span>) &#123;</span><br><span class="line">                <span class="comment">//【1】将权限添加到 pkg.requestedPermissions 中去！</span></span><br><span class="line">                pkg.requestedPermissions.add(name.intern());</span><br><span class="line">            &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                Slog.w(TAG, <span class="string">"Ignoring duplicate uses-permissions/uses-permissions-sdk-m: "</span></span><br><span class="line">                        + name + <span class="string">" in package: "</span> + pkg.packageName + <span class="string">" at: "</span></span><br><span class="line">                        + parser.getPositionDescription());</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    XmlUtils.skipCurrentTag(parser);</span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">true</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>解析很简单，不多说了！</p>
<h5 id="3-1-1-2-3-PParser-parseBaseApplication"><a href="#3-1-1-2-3-PParser-parseBaseApplication" class="headerlink" title="3.1.1.2.3 PParser.parseBaseApplication"></a>3.1.1.2.3 PParser.parseBaseApplication</h5><p>调用 parseBaseApplication 方法来解析核心 apk 的 applicaiton 标签和内部的四大组件信息！！<br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br><span class="line">212</span><br><span class="line">213</span><br><span class="line">214</span><br><span class="line">215</span><br><span class="line">216</span><br><span class="line">217</span><br><span class="line">218</span><br><span class="line">219</span><br><span class="line">220</span><br><span class="line">221</span><br><span class="line">222</span><br><span class="line">223</span><br><span class="line">224</span><br><span class="line">225</span><br><span class="line">226</span><br><span class="line">227</span><br><span class="line">228</span><br><span class="line">229</span><br><span class="line">230</span><br><span class="line">231</span><br><span class="line">232</span><br><span class="line">233</span><br><span class="line">234</span><br><span class="line">235</span><br><span class="line">236</span><br><span class="line">237</span><br><span class="line">238</span><br><span class="line">239</span><br><span class="line">240</span><br><span class="line">241</span><br><span class="line">242</span><br><span class="line">243</span><br><span class="line">244</span><br><span class="line">245</span><br><span class="line">246</span><br><span class="line">247</span><br><span class="line">248</span><br><span class="line">249</span><br><span class="line">250</span><br><span class="line">251</span><br><span class="line">252</span><br><span class="line">253</span><br><span class="line">254</span><br><span class="line">255</span><br><span class="line">256</span><br><span class="line">257</span><br><span class="line">258</span><br><span class="line">259</span><br><span class="line">260</span><br><span class="line">261</span><br><span class="line">262</span><br><span class="line">263</span><br><span class="line">264</span><br><span class="line">265</span><br><span class="line">266</span><br><span class="line">267</span><br><span class="line">268</span><br><span class="line">269</span><br><span class="line">270</span><br><span class="line">271</span><br><span class="line">272</span><br><span class="line">273</span><br><span class="line">274</span><br><span class="line">275</span><br><span class="line">276</span><br><span class="line">277</span><br><span class="line">278</span><br><span class="line">279</span><br><span class="line">280</span><br><span class="line">281</span><br><span class="line">282</span><br><span class="line">283</span><br><span class="line">284</span><br><span class="line">285</span><br><span class="line">286</span><br><span class="line">287</span><br><span class="line">288</span><br><span class="line">289</span><br><span class="line">290</span><br><span class="line">291</span><br><span class="line">292</span><br><span class="line">293</span><br><span class="line">294</span><br><span class="line">295</span><br><span class="line">296</span><br><span class="line">297</span><br><span class="line">298</span><br><span class="line">299</span><br><span class="line">300</span><br><span class="line">301</span><br><span class="line">302</span><br><span class="line">303</span><br><span class="line">304</span><br><span class="line">305</span><br><span class="line">306</span><br><span class="line">307</span><br><span class="line">308</span><br><span class="line">309</span><br><span class="line">310</span><br><span class="line">311</span><br><span class="line">312</span><br><span class="line">313</span><br><span class="line">314</span><br><span class="line">315</span><br><span class="line">316</span><br><span class="line">317</span><br><span class="line">318</span><br><span class="line">319</span><br><span class="line">320</span><br><span class="line">321</span><br><span class="line">322</span><br><span class="line">323</span><br><span class="line">324</span><br><span class="line">325</span><br><span class="line">326</span><br><span class="line">327</span><br><span class="line">328</span><br><span class="line">329</span><br><span class="line">330</span><br><span class="line">331</span><br><span class="line">332</span><br><span class="line">333</span><br><span class="line">334</span><br><span class="line">335</span><br><span class="line">336</span><br><span class="line">337</span><br><span class="line">338</span><br><span class="line">339</span><br><span class="line">340</span><br><span class="line">341</span><br><span class="line">342</span><br><span class="line">343</span><br><span class="line">344</span><br><span class="line">345</span><br><span class="line">346</span><br><span class="line">347</span><br><span class="line">348</span><br><span class="line">349</span><br><span class="line">350</span><br><span class="line">351</span><br><span class="line">352</span><br><span class="line">353</span><br><span class="line">354</span><br><span class="line">355</span><br><span class="line">356</span><br><span class="line">357</span><br><span class="line">358</span><br><span class="line">359</span><br><span class="line">360</span><br><span class="line">361</span><br><span class="line">362</span><br><span class="line">363</span><br><span class="line">364</span><br><span class="line">365</span><br><span class="line">366</span><br><span class="line">367</span><br><span class="line">368</span><br><span class="line">369</span><br><span class="line">370</span><br><span class="line">371</span><br><span class="line">372</span><br><span class="line">373</span><br><span class="line">374</span><br><span class="line">375</span><br><span class="line">376</span><br><span class="line">377</span><br><span class="line">378</span><br><span class="line">379</span><br><span class="line">380</span><br><span class="line">381</span><br><span class="line">382</span><br><span class="line">383</span><br><span class="line">384</span><br><span class="line">385</span><br><span class="line">386</span><br><span class="line">387</span><br><span class="line">388</span><br><span class="line">389</span><br><span class="line">390</span><br><span class="line">391</span><br><span class="line">392</span><br><span class="line">393</span><br><span class="line">394</span><br><span class="line">395</span><br><span class="line">396</span><br><span class="line">397</span><br><span class="line">398</span><br><span class="line">399</span><br><span class="line">400</span><br><span class="line">401</span><br><span class="line">402</span><br><span class="line">403</span><br><span class="line">404</span><br><span class="line">405</span><br><span class="line">406</span><br><span class="line">407</span><br><span class="line">408</span><br><span class="line">409</span><br><span class="line">410</span><br><span class="line">411</span><br><span class="line">412</span><br><span class="line">413</span><br><span class="line">414</span><br><span class="line">415</span><br><span class="line">416</span><br><span class="line">417</span><br><span class="line">418</span><br><span class="line">419</span><br><span class="line">420</span><br><span class="line">421</span><br><span class="line">422</span><br><span class="line">423</span><br><span class="line">424</span><br><span class="line">425</span><br><span class="line">426</span><br><span class="line">427</span><br><span class="line">428</span><br><span class="line">429</span><br><span class="line">430</span><br><span class="line">431</span><br><span class="line">432</span><br><span class="line">433</span><br><span class="line">434</span><br><span class="line">435</span><br><span class="line">436</span><br><span class="line">437</span><br><span class="line">438</span><br><span class="line">439</span><br><span class="line">440</span><br><span class="line">441</span><br><span class="line">442</span><br><span class="line">443</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">boolean</span> <span class="title">parseBaseApplication</span><span class="params">(Package owner, Resources res,</span></span></span><br><span class="line"><span class="function"><span class="params">        XmlResourceParser parser, <span class="keyword">int</span> flags, String[] outError)</span></span></span><br><span class="line"><span class="function">    <span class="keyword">throws</span> XmlPullParserException, IOException </span>&#123;</span><br><span class="line">    <span class="comment">//【1】解析 application 标签的属性！</span></span><br><span class="line">    <span class="keyword">final</span> ApplicationInfo ai = owner.applicationInfo;</span><br><span class="line">    <span class="keyword">final</span> String pkgName = owner.applicationInfo.packageName;</span><br><span class="line"></span><br><span class="line">    TypedArray sa = res.obtainAttributes(parser,</span><br><span class="line">            com.android.internal.R.styleable.AndroidManifestApplication);</span><br><span class="line">   </span><br><span class="line">    <span class="comment">// 解析 android:name android:label android:icon android:roundIcon android:logo android:banner 属性！</span></span><br><span class="line">    <span class="keyword">if</span> (!parsePackageItemInfo(owner, ai, outError,</span><br><span class="line">            <span class="string">"&lt;application&gt;"</span>, sa, <span class="keyword">false</span> <span class="comment">/*nameRequired*/</span>,</span><br><span class="line">            com.android.internal.R.styleable.AndroidManifestApplication_name,</span><br><span class="line">            com.android.internal.R.styleable.AndroidManifestApplication_label,</span><br><span class="line">            com.android.internal.R.styleable.AndroidManifestApplication_icon,</span><br><span class="line">            com.android.internal.R.styleable.AndroidManifestApplication_roundIcon,</span><br><span class="line">            com.android.internal.R.styleable.AndroidManifestApplication_logo,</span><br><span class="line">            com.android.internal.R.styleable.AndroidManifestApplication_banner)) &#123;</span><br><span class="line">        sa.recycle();</span><br><span class="line">        mParseError = PackageManager.INSTALL_PARSE_FAILED_MANIFEST_MALFORMED;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">false</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (ai.name != <span class="keyword">null</span>) &#123;</span><br><span class="line">        ai.className = ai.name;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// 解析 android:manageSpaceActivity 属性！</span></span><br><span class="line">    String manageSpaceActivity = sa.getNonConfigurationString(</span><br><span class="line">            com.android.internal.R.styleable.AndroidManifestApplication_manageSpaceActivity,</span><br><span class="line">            Configuration.NATIVE_CONFIG_VERSION);</span><br><span class="line">    <span class="keyword">if</span> (manageSpaceActivity != <span class="keyword">null</span>) &#123;</span><br><span class="line">        ai.manageSpaceActivityName = buildClassName(pkgName, manageSpaceActivity,</span><br><span class="line">                outError);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//【1】解析 android:allowBackup 属性，为 true 表示应用允许备份！</span></span><br><span class="line">    <span class="keyword">boolean</span> allowBackup = sa.getBoolean(</span><br><span class="line">            com.android.internal.R.styleable.AndroidManifestApplication_allowBackup, <span class="keyword">true</span>);</span><br><span class="line">    <span class="keyword">if</span> (allowBackup) &#123;</span><br><span class="line">        ai.flags |= ApplicationInfo.FLAG_ALLOW_BACKUP; <span class="comment">// 如果为 true，设置 FLAG_ALLOW_BACKUP 标志位</span></span><br><span class="line">        </span><br><span class="line">        <span class="comment">// 解析 android:backupAgent 属性！</span></span><br><span class="line">        String backupAgent = sa.getNonConfigurationString(</span><br><span class="line">                com.android.internal.R.styleable.AndroidManifestApplication_backupAgent,</span><br><span class="line">                Configuration.NATIVE_CONFIG_VERSION);</span><br><span class="line">        <span class="keyword">if</span> (backupAgent != <span class="keyword">null</span>) &#123;</span><br><span class="line">            ai.backupAgentName = buildClassName(pkgName, backupAgent, outError);</span><br><span class="line">            <span class="keyword">if</span> (DEBUG_BACKUP) &#123;</span><br><span class="line">                Slog.v(TAG, <span class="string">"android:backupAgent = "</span> + ai.backupAgentName</span><br><span class="line">                        + <span class="string">" from "</span> + pkgName + <span class="string">"+"</span> + backupAgent);</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            <span class="keyword">if</span> (sa.getBoolean(</span><br><span class="line">                    com.android.internal.R.styleable.AndroidManifestApplication_killAfterRestore,</span><br><span class="line">                    <span class="keyword">true</span>)) &#123;</span><br><span class="line">                <span class="comment">// 解析 android:killAfterRestore 属性，为 true 设置 FLAG_KILL_AFTER_RESTORE 标志位</span></span><br><span class="line">                ai.flags |= ApplicationInfo.FLAG_KILL_AFTER_RESTORE;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">if</span> (sa.getBoolean(</span><br><span class="line">                    com.android.internal.R.styleable.AndroidManifestApplication_restoreAnyVersion,</span><br><span class="line">                    <span class="keyword">false</span>)) &#123;</span><br><span class="line">                <span class="comment">// 解析 android:restoreAnyVersion 属性，为 true 设置 FLAG_RESTORE_ANY_VERSION 标志位</span></span><br><span class="line">                ai.flags |= ApplicationInfo.FLAG_RESTORE_ANY_VERSION;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">if</span> (sa.getBoolean(</span><br><span class="line">                    com.android.internal.R.styleable.AndroidManifestApplication_fullBackupOnly,</span><br><span class="line">                    <span class="keyword">false</span>)) &#123;</span><br><span class="line">                <span class="comment">// 解析 android:fullBackupOnly 属性，为 true 设置 FLAG_FULL_BACKUP_ONLY 标志位</span></span><br><span class="line">                ai.flags |= ApplicationInfo.FLAG_FULL_BACKUP_ONLY;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">if</span> (sa.getBoolean(</span><br><span class="line">                    com.android.internal.R.styleable.AndroidManifestApplication_backupInForeground,</span><br><span class="line">                    <span class="keyword">false</span>)) &#123;</span><br><span class="line">                <span class="comment">// 解析 android:backupInForeground 属性，为 true 设置 PRIVATE_FLAG_BACKUP_IN_FOREGROUND 标志位</span></span><br><span class="line">                ai.privateFlags |= ApplicationInfo.PRIVATE_FLAG_BACKUP_IN_FOREGROUND;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        </span><br><span class="line">        <span class="comment">// 解析 android:fullBackupContent 属性！</span></span><br><span class="line">        TypedValue v = sa.peekValue(</span><br><span class="line">                com.android.internal.R.styleable.AndroidManifestApplication_fullBackupContent);</span><br><span class="line">        <span class="keyword">if</span> (v != <span class="keyword">null</span> &amp;&amp; (ai.fullBackupContent = v.resourceId) == <span class="number">0</span>) &#123;</span><br><span class="line">            <span class="keyword">if</span> (DEBUG_BACKUP) &#123;</span><br><span class="line">                Slog.v(TAG, <span class="string">"fullBackupContent specified as boolean="</span> +</span><br><span class="line">                        (v.data == <span class="number">0</span> ? <span class="string">"false"</span> : <span class="string">"true"</span>));</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="comment">// "false" =&gt; -1, "true" =&gt; 0</span></span><br><span class="line">            ai.fullBackupContent = (v.data == <span class="number">0</span> ? -<span class="number">1</span> : <span class="number">0</span>);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">if</span> (DEBUG_BACKUP) &#123;</span><br><span class="line">            Slog.v(TAG, <span class="string">"fullBackupContent="</span> + ai.fullBackupContent + <span class="string">" for "</span> + pkgName);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 解析 android:theme android:description 属性！</span></span><br><span class="line">    ai.theme = sa.getResourceId(</span><br><span class="line">            com.android.internal.R.styleable.AndroidManifestApplication_theme, <span class="number">0</span>);</span><br><span class="line">    ai.descriptionRes = sa.getResourceId(</span><br><span class="line">            com.android.internal.R.styleable.AndroidManifestApplication_description, <span class="number">0</span>);</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 如果设置了 PARSE_IS_SYSTEM，并且 android:persistent 为 true</span></span><br><span class="line">    <span class="comment">// 那么 ai.flags 设置 ApplicationInfo.FLAG_PERSISTENT 标志位，其为 persistent 属性！</span></span><br><span class="line">    <span class="keyword">if</span> ((flags&amp;PARSE_IS_SYSTEM) != <span class="number">0</span>) &#123;</span><br><span class="line">        <span class="keyword">if</span> (sa.getBoolean(</span><br><span class="line">                com.android.internal.R.styleable.AndroidManifestApplication_persistent,</span><br><span class="line">                <span class="keyword">false</span>)) &#123;</span><br><span class="line">            ai.flags |= ApplicationInfo.FLAG_PERSISTENT;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// 解析 android:requiredForAllUsers 属性，为true，表示该应用在所有 user 下都可用！</span></span><br><span class="line">    <span class="keyword">if</span> (sa.getBoolean(</span><br><span class="line">            com.android.internal.R.styleable.AndroidManifestApplication_requiredForAllUsers,</span><br><span class="line">            <span class="keyword">false</span>)) &#123;</span><br><span class="line">        owner.mRequiredForAllUsers = <span class="keyword">true</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 解析 android:requiredAccountType android:restrictedAccountType 的属性！</span></span><br><span class="line">    String restrictedAccountType = sa.getString(com.android.internal.R.styleable</span><br><span class="line">            .AndroidManifestApplication_restrictedAccountType);</span><br><span class="line">    <span class="keyword">if</span> (restrictedAccountType != <span class="keyword">null</span> &amp;&amp; restrictedAccountType.length() &gt; <span class="number">0</span>) &#123;</span><br><span class="line">        owner.mRestrictedAccountType = restrictedAccountType;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    String requiredAccountType = sa.getString(com.android.internal.R.styleable</span><br><span class="line">            .AndroidManifestApplication_requiredAccountType);</span><br><span class="line">    <span class="keyword">if</span> (requiredAccountType != <span class="keyword">null</span> &amp;&amp; requiredAccountType.length() &gt; <span class="number">0</span>) &#123;</span><br><span class="line">        owner.mRequiredAccountType = requiredAccountType;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 解析 android:debuggable android:vmSafeMode 属性！</span></span><br><span class="line">    <span class="keyword">if</span> (sa.getBoolean(</span><br><span class="line">            com.android.internal.R.styleable.AndroidManifestApplication_debuggable,</span><br><span class="line">            <span class="keyword">false</span>)) &#123;</span><br><span class="line">        ai.flags |= ApplicationInfo.FLAG_DEBUGGABLE;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (sa.getBoolean(</span><br><span class="line">            com.android.internal.R.styleable.AndroidManifestApplication_vmSafeMode,</span><br><span class="line">            <span class="keyword">false</span>)) &#123;</span><br><span class="line">        ai.flags |= ApplicationInfo.FLAG_VM_SAFE_MODE;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// 解析 android:hardwareAccelerated 属性！</span></span><br><span class="line">    owner.baseHardwareAccelerated = sa.getBoolean(</span><br><span class="line">            com.android.internal.R.styleable.AndroidManifestApplication_hardwareAccelerated,</span><br><span class="line">            owner.applicationInfo.targetSdkVersion &gt;= Build.VERSION_CODES.ICE_CREAM_SANDWICH);</span><br><span class="line">    <span class="keyword">if</span> (owner.baseHardwareAccelerated) &#123;</span><br><span class="line">        ai.flags |= ApplicationInfo.FLAG_HARDWARE_ACCELERATED;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// 解析 android:hasCode 属性！</span></span><br><span class="line">    <span class="keyword">if</span> (sa.getBoolean(</span><br><span class="line">            com.android.internal.R.styleable.AndroidManifestApplication_hasCode,</span><br><span class="line">            <span class="keyword">true</span>)) &#123;</span><br><span class="line">        ai.flags |= ApplicationInfo.FLAG_HAS_CODE;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 解析 android:allowTaskReparenting 属性，这个属性很重要，决定了 acivity 和 task 的关系</span></span><br><span class="line">    <span class="comment">// 在 application 标签上设置该属性对内部的所有 activity 生效！</span></span><br><span class="line">    <span class="keyword">if</span> (sa.getBoolean(</span><br><span class="line">            com.android.internal.R.styleable.AndroidManifestApplication_allowTaskReparenting,</span><br><span class="line">            <span class="keyword">false</span>)) &#123;</span><br><span class="line">        ai.flags |= ApplicationInfo.FLAG_ALLOW_TASK_REPARENTING;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// 解析 android:allowClearUserData 属性！</span></span><br><span class="line">    <span class="keyword">if</span> (sa.getBoolean(</span><br><span class="line">            com.android.internal.R.styleable.AndroidManifestApplication_allowClearUserData,</span><br><span class="line">            <span class="keyword">true</span>)) &#123;</span><br><span class="line">        ai.flags |= ApplicationInfo.FLAG_ALLOW_CLEAR_USER_DATA;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// The parent package controls installation, hence specify test only installs.</span></span><br><span class="line">    <span class="keyword">if</span> (owner.parentPackage == <span class="keyword">null</span>) &#123;</span><br><span class="line">        <span class="keyword">if</span> (sa.getBoolean(</span><br><span class="line">                com.android.internal.R.styleable.AndroidManifestApplication_testOnly,</span><br><span class="line">                <span class="keyword">false</span>)) &#123;</span><br><span class="line">            ai.flags |= ApplicationInfo.FLAG_TEST_ONLY;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// 解析 android:largeHeap 属性！</span></span><br><span class="line">    <span class="keyword">if</span> (sa.getBoolean(</span><br><span class="line">            com.android.internal.R.styleable.AndroidManifestApplication_largeHeap,</span><br><span class="line">            <span class="keyword">false</span>)) &#123;</span><br><span class="line">        ai.flags |= ApplicationInfo.FLAG_LARGE_HEAP;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// 解析 android:usesCleartextTraffic 属性！</span></span><br><span class="line">    <span class="keyword">if</span> (sa.getBoolean(</span><br><span class="line">            com.android.internal.R.styleable.AndroidManifestApplication_usesCleartextTraffic,</span><br><span class="line">            <span class="keyword">true</span>)) &#123;</span><br><span class="line">        ai.flags |= ApplicationInfo.FLAG_USES_CLEARTEXT_TRAFFIC;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// 解析 android:supportsRtl 属性！</span></span><br><span class="line">    <span class="keyword">if</span> (sa.getBoolean(</span><br><span class="line">            com.android.internal.R.styleable.AndroidManifestApplication_supportsRtl,</span><br><span class="line">            <span class="keyword">false</span> <span class="comment">/* default is no RTL support*/</span>)) &#123;</span><br><span class="line">        ai.flags |= ApplicationInfo.FLAG_SUPPORTS_RTL;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// 解析 android:multiArch 属性！</span></span><br><span class="line">    <span class="keyword">if</span> (sa.getBoolean(</span><br><span class="line">            com.android.internal.R.styleable.AndroidManifestApplication_multiArch,</span><br><span class="line">            <span class="keyword">false</span>)) &#123;</span><br><span class="line">        ai.flags |= ApplicationInfo.FLAG_MULTIARCH;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// 解析 android:extractNativeLibs 属性！</span></span><br><span class="line">    <span class="keyword">if</span> (sa.getBoolean(</span><br><span class="line">            com.android.internal.R.styleable.AndroidManifestApplication_extractNativeLibs,</span><br><span class="line">            <span class="keyword">true</span>)) &#123;</span><br><span class="line">        ai.flags |= ApplicationInfo.FLAG_EXTRACT_NATIVE_LIBS;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// 解析 android:defaultToDeviceProtectedStorage 属性！</span></span><br><span class="line">    <span class="keyword">if</span> (sa.getBoolean(</span><br><span class="line">            R.styleable.AndroidManifestApplication_defaultToDeviceProtectedStorage,</span><br><span class="line">            <span class="keyword">false</span>)) &#123;</span><br><span class="line">        ai.privateFlags |= ApplicationInfo.PRIVATE_FLAG_DEFAULT_TO_DEVICE_PROTECTED_STORAGE;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// 解析 android:directBootAware 属性！</span></span><br><span class="line">    <span class="keyword">if</span> (sa.getBoolean(</span><br><span class="line">            R.styleable.AndroidManifestApplication_directBootAware,</span><br><span class="line">            <span class="keyword">false</span>)) &#123;</span><br><span class="line">        ai.privateFlags |= ApplicationInfo.PRIVATE_FLAG_DIRECT_BOOT_AWARE;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// 解析 android:resizeableActivity 属性！</span></span><br><span class="line">    <span class="keyword">if</span> (sa.getBoolean(R.styleable.AndroidManifestApplication_resizeableActivity,</span><br><span class="line">            owner.applicationInfo.targetSdkVersion &gt;= Build.VERSION_CODES.N)) &#123;</span><br><span class="line">        ai.privateFlags |= PRIVATE_FLAG_RESIZEABLE_ACTIVITIES;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// 解析 android:networkSecurityConfig 属性！</span></span><br><span class="line">    ai.networkSecurityConfigRes = sa.getResourceId(</span><br><span class="line">            com.android.internal.R.styleable.AndroidManifestApplication_networkSecurityConfig,</span><br><span class="line">            <span class="number">0</span>);</span><br><span class="line">    <span class="comment">// 解析 android:permission 属性！</span></span><br><span class="line">    String str;</span><br><span class="line">    str = sa.getNonConfigurationString(</span><br><span class="line">            com.android.internal.R.styleable.AndroidManifestApplication_permission, <span class="number">0</span>);</span><br><span class="line">    ai.permission = (str != <span class="keyword">null</span> &amp;&amp; str.length() &gt; <span class="number">0</span>) ? str.intern() : <span class="keyword">null</span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 解析 android:taskAffinity 属性，这个属性很重要，决定了 acivity 和 task 的关系</span></span><br><span class="line">    <span class="comment">// 在 application 标签上设置该属性对内部的所有 activity 生效！</span></span><br><span class="line">    <span class="keyword">if</span> (owner.applicationInfo.targetSdkVersion &gt;= Build.VERSION_CODES.FROYO) &#123;</span><br><span class="line">        str = sa.getNonConfigurationString(</span><br><span class="line">                com.android.internal.R.styleable.AndroidManifestApplication_taskAffinity,</span><br><span class="line">                Configuration.NATIVE_CONFIG_VERSION);</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        str = sa.getNonResourceString(</span><br><span class="line">                com.android.internal.R.styleable.AndroidManifestApplication_taskAffinity);</span><br><span class="line">    &#125;</span><br><span class="line">    ai.taskAffinity = buildTaskAffinityName(ai.packageName, ai.packageName,</span><br><span class="line">            str, outError);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (outError[<span class="number">0</span>] == <span class="keyword">null</span>) &#123;</span><br><span class="line">        CharSequence pname;</span><br><span class="line">        <span class="comment">// 解析 android:process 属性，这个属性很重要，决定了组件运行所在的进程名</span></span><br><span class="line">        <span class="comment">// 在 application 标签上设置该属性对内部的所有组件生效！</span></span><br><span class="line">        <span class="keyword">if</span> (owner.applicationInfo.targetSdkVersion &gt;= Build.VERSION_CODES.FROYO) &#123;</span><br><span class="line">            pname = sa.getNonConfigurationString(</span><br><span class="line">                    com.android.internal.R.styleable.AndroidManifestApplication_process,</span><br><span class="line">                    Configuration.NATIVE_CONFIG_VERSION);</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">         </span><br><span class="line">            pname = sa.getNonResourceString(</span><br><span class="line">                    com.android.internal.R.styleable.AndroidManifestApplication_process);</span><br><span class="line">        &#125;</span><br><span class="line">        ai.processName = buildProcessName(ai.packageName, <span class="keyword">null</span>, pname,</span><br><span class="line">                flags, mSeparateProcesses, outError);</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 解析 android:isGame android:enabled 属性，</span></span><br><span class="line">        ai.enabled = sa.getBoolean(</span><br><span class="line">                com.android.internal.R.styleable.AndroidManifestApplication_enabled, <span class="keyword">true</span>);</span><br><span class="line">        <span class="keyword">if</span> (sa.getBoolean(</span><br><span class="line">                com.android.internal.R.styleable.AndroidManifestApplication_isGame, <span class="keyword">false</span>)) &#123;</span><br><span class="line">            ai.flags |= ApplicationInfo.FLAG_IS_GAME;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (<span class="keyword">false</span>) &#123;</span><br><span class="line">            <span class="comment">// 解析 android:cantSaveState 属性，这里由于 if 为 false，所以不会解析！</span></span><br><span class="line">            <span class="comment">// 主要用于 height-weight 类型的应用！</span></span><br><span class="line">            <span class="keyword">if</span> (sa.getBoolean(</span><br><span class="line">                    com.android.internal.R.styleable.AndroidManifestApplication_cantSaveState,</span><br><span class="line">                    <span class="keyword">false</span>)) &#123;</span><br><span class="line">                ai.privateFlags |= ApplicationInfo.PRIVATE_FLAG_CANT_SAVE_STATE;</span><br><span class="line"></span><br><span class="line">                <span class="comment">// 对于 height-weight 类型的应用，其所在进程的进程名只能是包名，我们无法自定义其进程名！</span></span><br><span class="line">                <span class="keyword">if</span> (ai.processName != <span class="keyword">null</span> &amp;&amp; ai.processName != ai.packageName) &#123;</span><br><span class="line">                    outError[<span class="number">0</span>] = <span class="string">"cantSaveState applications can not use custom processes"</span>;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// 解析 android:uiOptions 属性！</span></span><br><span class="line">    ai.uiOptions = sa.getInt(</span><br><span class="line">            com.android.internal.R.styleable.AndroidManifestApplication_uiOptions, <span class="number">0</span>);</span><br><span class="line"></span><br><span class="line">    sa.recycle();</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (outError[<span class="number">0</span>] != <span class="keyword">null</span>) &#123;</span><br><span class="line">        mParseError = PackageManager.INSTALL_PARSE_FAILED_MANIFEST_MALFORMED;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">false</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">//【2】解析四大组件！</span></span><br><span class="line">    <span class="keyword">final</span> <span class="keyword">int</span> innerDepth = parser.getDepth();</span><br><span class="line">    <span class="keyword">int</span> type;</span><br><span class="line">    <span class="keyword">while</span> ((type = parser.next()) != XmlPullParser.END_DOCUMENT</span><br><span class="line">            &amp;&amp; (type != XmlPullParser.END_TAG || parser.getDepth() &gt; innerDepth)) &#123;</span><br><span class="line">        <span class="keyword">if</span> (type == XmlPullParser.END_TAG || type == XmlPullParser.TEXT) &#123;</span><br><span class="line">            <span class="keyword">continue</span>;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        String tagName = parser.getName();</span><br><span class="line"></span><br><span class="line">        <span class="comment">//【2.1】解析 "activity" 组件</span></span><br><span class="line">        <span class="keyword">if</span> (tagName.equals(<span class="string">"activity"</span>)) &#123;</span><br><span class="line">            Activity a = parseActivity(owner, res, parser, flags, outError, <span class="keyword">false</span>,</span><br><span class="line">                    owner.baseHardwareAccelerated);</span><br><span class="line">            <span class="keyword">if</span> (a == <span class="keyword">null</span>) &#123;</span><br><span class="line">                mParseError = PackageManager.INSTALL_PARSE_FAILED_MANIFEST_MALFORMED;</span><br><span class="line">                <span class="keyword">return</span> <span class="keyword">false</span>;</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            owner.activities.add(a);</span><br><span class="line"></span><br><span class="line">        <span class="comment">//【2.2】解析 "receiver" 组件</span></span><br><span class="line">        &#125; <span class="keyword">else</span> <span class="keyword">if</span> (tagName.equals(<span class="string">"receiver"</span>)) &#123;</span><br><span class="line">            Activity a = parseActivity(owner, res, parser, flags, outError, <span class="keyword">true</span>, <span class="keyword">false</span>);</span><br><span class="line">            <span class="keyword">if</span> (a == <span class="keyword">null</span>) &#123;</span><br><span class="line">                mParseError = PackageManager.INSTALL_PARSE_FAILED_MANIFEST_MALFORMED;</span><br><span class="line">                <span class="keyword">return</span> <span class="keyword">false</span>;</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            owner.receivers.add(a);</span><br><span class="line"></span><br><span class="line">        <span class="comment">//【2.3】解析 "service" 组件</span></span><br><span class="line">        &#125; <span class="keyword">else</span> <span class="keyword">if</span> (tagName.equals(<span class="string">"service"</span>)) &#123;</span><br><span class="line">            Service s = parseService(owner, res, parser, flags, outError);</span><br><span class="line">            <span class="keyword">if</span> (s == <span class="keyword">null</span>) &#123;</span><br><span class="line">                mParseError = PackageManager.INSTALL_PARSE_FAILED_MANIFEST_MALFORMED;</span><br><span class="line">                <span class="keyword">return</span> <span class="keyword">false</span>;</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            owner.services.add(s);</span><br><span class="line"></span><br><span class="line">        <span class="comment">//【2.4】解析 "provider" 组件</span></span><br><span class="line">        &#125; <span class="keyword">else</span> <span class="keyword">if</span> (tagName.equals(<span class="string">"provider"</span>)) &#123;</span><br><span class="line">            Provider p = parseProvider(owner, res, parser, flags, outError);</span><br><span class="line">            <span class="keyword">if</span> (p == <span class="keyword">null</span>) &#123;</span><br><span class="line">                mParseError = PackageManager.INSTALL_PARSE_FAILED_MANIFEST_MALFORMED;</span><br><span class="line">                <span class="keyword">return</span> <span class="keyword">false</span>;</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            owner.providers.add(p);</span><br><span class="line"></span><br><span class="line">        &#125; <span class="keyword">else</span> <span class="keyword">if</span> (tagName.equals(<span class="string">"activity-alias"</span>)) &#123; </span><br><span class="line">            <span class="comment">//【2.5】解析 "activity-alias" 组件</span></span><br><span class="line">            Activity a = parseActivityAlias(owner, res, parser, flags, outError);</span><br><span class="line">            <span class="keyword">if</span> (a == <span class="keyword">null</span>) &#123;</span><br><span class="line">                mParseError = PackageManager.INSTALL_PARSE_FAILED_MANIFEST_MALFORMED;</span><br><span class="line">                <span class="keyword">return</span> <span class="keyword">false</span>;</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            owner.activities.add(a);</span><br><span class="line"></span><br><span class="line">        &#125; <span class="keyword">else</span> <span class="keyword">if</span> (parser.getName().equals(<span class="string">"meta-data"</span>)) &#123;</span><br><span class="line">            <span class="comment">//【2.6】解析 "meta-data" 组件</span></span><br><span class="line">            <span class="keyword">if</span> ((owner.mAppMetaData = parseMetaData(res, parser, owner.mAppMetaData,</span><br><span class="line">                    outError)) == <span class="keyword">null</span>) &#123;</span><br><span class="line">                mParseError = PackageManager.INSTALL_PARSE_FAILED_MANIFEST_MALFORMED;</span><br><span class="line">                <span class="keyword">return</span> <span class="keyword">false</span>;</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">        &#125; <span class="keyword">else</span> <span class="keyword">if</span> (tagName.equals(<span class="string">"library"</span>)) &#123;</span><br><span class="line">            <span class="comment">//【2.6】解析 "library" 组件</span></span><br><span class="line">            sa = res.obtainAttributes(parser,</span><br><span class="line">                    com.android.internal.R.styleable.AndroidManifestLibrary);</span><br><span class="line">            String lname = sa.getNonResourceString(</span><br><span class="line">                    com.android.internal.R.styleable.AndroidManifestLibrary_name);</span><br><span class="line"></span><br><span class="line">            sa.recycle();</span><br><span class="line"></span><br><span class="line">            <span class="keyword">if</span> (lname != <span class="keyword">null</span>) &#123;</span><br><span class="line">                lname = lname.intern();</span><br><span class="line">                <span class="keyword">if</span> (!ArrayUtils.contains(owner.libraryNames, lname)) &#123;</span><br><span class="line">                    owner.libraryNames = ArrayUtils.add(owner.libraryNames, lname);</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            XmlUtils.skipCurrentTag(parser);</span><br><span class="line"></span><br><span class="line">        &#125; <span class="keyword">else</span> <span class="keyword">if</span> (tagName.equals(<span class="string">"uses-library"</span>)) &#123;</span><br><span class="line">            <span class="comment">//【2.7】解析 "uses-library" 组件</span></span><br><span class="line">            sa = res.obtainAttributes(parser,</span><br><span class="line">                    com.android.internal.R.styleable.AndroidManifestUsesLibrary);</span><br><span class="line"></span><br><span class="line">            <span class="comment">// Note: don't allow this value to be a reference to a resource</span></span><br><span class="line">            <span class="comment">// that may change.</span></span><br><span class="line">            String lname = sa.getNonResourceString(</span><br><span class="line">                    com.android.internal.R.styleable.AndroidManifestUsesLibrary_name);</span><br><span class="line">            <span class="keyword">boolean</span> req = sa.getBoolean(</span><br><span class="line">                    com.android.internal.R.styleable.AndroidManifestUsesLibrary_required,</span><br><span class="line">                    <span class="keyword">true</span>);</span><br><span class="line"></span><br><span class="line">            sa.recycle();</span><br><span class="line"></span><br><span class="line">            <span class="keyword">if</span> (lname != <span class="keyword">null</span>) &#123;</span><br><span class="line">                lname = lname.intern();</span><br><span class="line">                <span class="keyword">if</span> (req) &#123;</span><br><span class="line">                    owner.usesLibraries = ArrayUtils.add(owner.usesLibraries, lname);</span><br><span class="line">                &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                    owner.usesOptionalLibraries = ArrayUtils.add(</span><br><span class="line">                            owner.usesOptionalLibraries, lname);</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            XmlUtils.skipCurrentTag(parser);</span><br><span class="line"></span><br><span class="line">        &#125; <span class="keyword">else</span> <span class="keyword">if</span> (tagName.equals(<span class="string">"uses-package"</span>)) &#123;</span><br><span class="line">            <span class="comment">// Dependencies for app installers; we don't currently try to</span></span><br><span class="line">            <span class="comment">// enforce this.</span></span><br><span class="line">            XmlUtils.skipCurrentTag(parser);</span><br><span class="line"></span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            <span class="keyword">if</span> (!RIGID_PARSER) &#123;</span><br><span class="line">                Slog.w(TAG, <span class="string">"Unknown element under &lt;application&gt;: "</span> + tagName</span><br><span class="line">                        + <span class="string">" at "</span> + mArchiveSourcePath + <span class="string">" "</span></span><br><span class="line">                        + parser.getPositionDescription());</span><br><span class="line">                XmlUtils.skipCurrentTag(parser);</span><br><span class="line">                <span class="keyword">continue</span>;</span><br><span class="line">            &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                outError[<span class="number">0</span>] = <span class="string">"Bad element under &lt;application&gt;: "</span> + tagName;</span><br><span class="line">                mParseError = PackageManager.INSTALL_PARSE_FAILED_MANIFEST_MALFORMED;</span><br><span class="line">                <span class="keyword">return</span> <span class="keyword">false</span>;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    modifySharedLibrariesForBackwardCompatibility(owner);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (hasDomainURLs(owner)) &#123;</span><br><span class="line">        owner.applicationInfo.privateFlags |= ApplicationInfo.PRIVATE_FLAG_HAS_DOMAIN_URLS;</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        owner.applicationInfo.privateFlags &amp;= ~ApplicationInfo.PRIVATE_FLAG_HAS_DOMAIN_URLS;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">true</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>这里重点的是四大组件的解析：</p>
<h6 id="3-1-1-2-3-1-PParser-parseActivity-解析-activity-和-receiver"><a href="#3-1-1-2-3-1-PParser-parseActivity-解析-activity-和-receiver" class="headerlink" title="3.1.1.2.3.1 PParser.parseActivity - 解析 activity 和 receiver"></a>3.1.1.2.3.1 PParser.parseActivity - 解析 activity 和 receiver</h6><p>我们来看看 activity 的解析过程：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br><span class="line">212</span><br><span class="line">213</span><br><span class="line">214</span><br><span class="line">215</span><br><span class="line">216</span><br><span class="line">217</span><br><span class="line">218</span><br><span class="line">219</span><br><span class="line">220</span><br><span class="line">221</span><br><span class="line">222</span><br><span class="line">223</span><br><span class="line">224</span><br><span class="line">225</span><br><span class="line">226</span><br><span class="line">227</span><br><span class="line">228</span><br><span class="line">229</span><br><span class="line">230</span><br><span class="line">231</span><br><span class="line">232</span><br><span class="line">233</span><br><span class="line">234</span><br><span class="line">235</span><br><span class="line">236</span><br><span class="line">237</span><br><span class="line">238</span><br><span class="line">239</span><br><span class="line">240</span><br><span class="line">241</span><br><span class="line">242</span><br><span class="line">243</span><br><span class="line">244</span><br><span class="line">245</span><br><span class="line">246</span><br><span class="line">247</span><br><span class="line">248</span><br><span class="line">249</span><br><span class="line">250</span><br><span class="line">251</span><br><span class="line">252</span><br><span class="line">253</span><br><span class="line">254</span><br><span class="line">255</span><br><span class="line">256</span><br><span class="line">257</span><br><span class="line">258</span><br><span class="line">259</span><br><span class="line">260</span><br><span class="line">261</span><br><span class="line">262</span><br><span class="line">263</span><br><span class="line">264</span><br><span class="line">265</span><br><span class="line">266</span><br><span class="line">267</span><br><span class="line">268</span><br><span class="line">269</span><br><span class="line">270</span><br><span class="line">271</span><br><span class="line">272</span><br><span class="line">273</span><br><span class="line">274</span><br><span class="line">275</span><br><span class="line">276</span><br><span class="line">277</span><br><span class="line">278</span><br><span class="line">279</span><br><span class="line">280</span><br><span class="line">281</span><br><span class="line">282</span><br><span class="line">283</span><br><span class="line">284</span><br><span class="line">285</span><br><span class="line">286</span><br><span class="line">287</span><br><span class="line">288</span><br><span class="line">289</span><br><span class="line">290</span><br><span class="line">291</span><br><span class="line">292</span><br><span class="line">293</span><br><span class="line">294</span><br><span class="line">295</span><br><span class="line">296</span><br><span class="line">297</span><br><span class="line">298</span><br><span class="line">299</span><br><span class="line">300</span><br><span class="line">301</span><br><span class="line">302</span><br><span class="line">303</span><br><span class="line">304</span><br><span class="line">305</span><br><span class="line">306</span><br><span class="line">307</span><br><span class="line">308</span><br><span class="line">309</span><br><span class="line">310</span><br><span class="line">311</span><br><span class="line">312</span><br><span class="line">313</span><br><span class="line">314</span><br><span class="line">315</span><br><span class="line">316</span><br><span class="line">317</span><br><span class="line">318</span><br><span class="line">319</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">private</span> Activity <span class="title">parseActivity</span><span class="params">(Package owner, Resources res,</span></span></span><br><span class="line"><span class="function"><span class="params">        XmlResourceParser parser, <span class="keyword">int</span> flags, String[] outError,</span></span></span><br><span class="line"><span class="function"><span class="params">        <span class="keyword">boolean</span> receiver, <span class="keyword">boolean</span> hardwareAccelerated)</span></span></span><br><span class="line"><span class="function">        <span class="keyword">throws</span> XmlPullParserException, IOException </span>&#123;</span><br><span class="line">    TypedArray sa = res.obtainAttributes(parser, R.styleable.AndroidManifestActivity);</span><br><span class="line">    <span class="comment">// 解析 android:name android:label android:icon android:roundIcon android:logo android:banner 属性！</span></span><br><span class="line">    <span class="keyword">if</span> (mParseActivityArgs == <span class="keyword">null</span>) &#123;</span><br><span class="line">        mParseActivityArgs = <span class="keyword">new</span> ParseComponentArgs(owner, outError,</span><br><span class="line">                R.styleable.AndroidManifestActivity_name,</span><br><span class="line">                R.styleable.AndroidManifestActivity_label,</span><br><span class="line">                R.styleable.AndroidManifestActivity_icon,</span><br><span class="line">                R.styleable.AndroidManifestActivity_roundIcon,</span><br><span class="line">                R.styleable.AndroidManifestActivity_logo,</span><br><span class="line">                R.styleable.AndroidManifestActivity_banner,</span><br><span class="line">                mSeparateProcesses,</span><br><span class="line">                R.styleable.AndroidManifestActivity_process,</span><br><span class="line">                R.styleable.AndroidManifestActivity_description,</span><br><span class="line">                R.styleable.AndroidManifestActivity_enabled);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// 由于 activty 和 receiver 使用的同一个方法，所以需要区分解析的是哪个，此时 receiver 为 false！</span></span><br><span class="line">    mParseActivityArgs.tag = receiver ? <span class="string">"&lt;receiver&gt;"</span> : <span class="string">"&lt;activity&gt;"</span>;</span><br><span class="line">    mParseActivityArgs.sa = sa;</span><br><span class="line">    mParseActivityArgs.flags = flags;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//【2】创建了一个 Activity 对象！</span></span><br><span class="line">    Activity a = <span class="keyword">new</span> Activity(mParseActivityArgs, <span class="keyword">new</span> ActivityInfo());</span><br><span class="line">    <span class="keyword">if</span> (outError[<span class="number">0</span>] != <span class="keyword">null</span>) &#123;</span><br><span class="line">        sa.recycle();</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">null</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// 解析 android:exported 属性！</span></span><br><span class="line">    <span class="keyword">boolean</span> setExported = sa.hasValue(R.styleable.AndroidManifestActivity_exported);</span><br><span class="line">    <span class="keyword">if</span> (setExported) &#123;</span><br><span class="line">        a.info.exported = sa.getBoolean(R.styleable.AndroidManifestActivity_exported, <span class="keyword">false</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// 解析 android:theme 属性！</span></span><br><span class="line">    a.info.theme = sa.getResourceId(R.styleable.AndroidManifestActivity_theme, <span class="number">0</span>);</span><br><span class="line">    <span class="comment">// 解析 android:uiOptions 属性！</span></span><br><span class="line">    a.info.uiOptions = sa.getInt(R.styleable.AndroidManifestActivity_uiOptions,</span><br><span class="line">            a.info.applicationInfo.uiOptions);</span><br><span class="line">    <span class="comment">// 解析 android:parentActivityName 属性！</span></span><br><span class="line">    String parentName = sa.getNonConfigurationString(</span><br><span class="line">            R.styleable.AndroidManifestActivity_parentActivityName,</span><br><span class="line">            Configuration.NATIVE_CONFIG_VERSION);</span><br><span class="line">    <span class="keyword">if</span> (parentName != <span class="keyword">null</span>) &#123;</span><br><span class="line">        String parentClassName = buildClassName(a.info.packageName, parentName, outError);</span><br><span class="line">        <span class="keyword">if</span> (outError[<span class="number">0</span>] == <span class="keyword">null</span>) &#123;</span><br><span class="line">            a.info.parentActivityName = parentClassName;</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            Log.e(TAG, <span class="string">"Activity "</span> + a.info.name + <span class="string">" specified invalid parentActivityName "</span> +</span><br><span class="line">                    parentName);</span><br><span class="line">            outError[<span class="number">0</span>] = <span class="keyword">null</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// 解析 android:permission 属性！</span></span><br><span class="line">    String str;</span><br><span class="line">    str = sa.getNonConfigurationString(R.styleable.AndroidManifestActivity_permission, <span class="number">0</span>);</span><br><span class="line">    <span class="keyword">if</span> (str == <span class="keyword">null</span>) &#123;</span><br><span class="line">        a.info.permission = owner.applicationInfo.permission;</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        a.info.permission = str.length() &gt; <span class="number">0</span> ? str.toString().intern() : <span class="keyword">null</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// 解析 android:taskAffinity 属性，这个属性真重要，能决定该 acitivty 和 task 的关系！！</span></span><br><span class="line">    str = sa.getNonConfigurationString(</span><br><span class="line">            R.styleable.AndroidManifestActivity_taskAffinity,</span><br><span class="line">            Configuration.NATIVE_CONFIG_VERSION);</span><br><span class="line">    a.info.taskAffinity = buildTaskAffinityName(owner.applicationInfo.packageName,</span><br><span class="line">            owner.applicationInfo.taskAffinity, str, outError);</span><br><span class="line"></span><br><span class="line">    a.info.flags = <span class="number">0</span>;</span><br><span class="line">    <span class="comment">// 解析 android:multiprocess 属性</span></span><br><span class="line">    <span class="keyword">if</span> (sa.getBoolean(</span><br><span class="line">            R.styleable.AndroidManifestActivity_multiprocess, <span class="keyword">false</span>)) &#123;</span><br><span class="line">        a.info.flags |= ActivityInfo.FLAG_MULTIPROCESS;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// 解析 android:finishOnTaskLaunch 属性，这个属性真重要，能决定该 acitivty 和 task 的关系！！</span></span><br><span class="line">    <span class="keyword">if</span> (sa.getBoolean(R.styleable.AndroidManifestActivity_finishOnTaskLaunch, <span class="keyword">false</span>)) &#123;</span><br><span class="line">        a.info.flags |= ActivityInfo.FLAG_FINISH_ON_TASK_LAUNCH;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// 解析 android:clearTaskOnLaunch 属性，这个属性真重要，能决定该 acitivty 和 task 的关系！</span></span><br><span class="line">    <span class="keyword">if</span> (sa.getBoolean(R.styleable.AndroidManifestActivity_clearTaskOnLaunch, <span class="keyword">false</span>)) &#123;</span><br><span class="line">        a.info.flags |= ActivityInfo.FLAG_CLEAR_TASK_ON_LAUNCH;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// 解析 android:noHistory 属性，这个属性真重要，能决定该 acitivty 和 task 的关系！</span></span><br><span class="line">    <span class="keyword">if</span> (sa.getBoolean(R.styleable.AndroidManifestActivity_noHistory, <span class="keyword">false</span>)) &#123;</span><br><span class="line">        a.info.flags |= ActivityInfo.FLAG_NO_HISTORY;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// 解析 android:alwaysRetainTaskState 属性，这个属性真重要，能决定该 acitivty 和 task 的关系！</span></span><br><span class="line">    <span class="keyword">if</span> (sa.getBoolean(R.styleable.AndroidManifestActivity_alwaysRetainTaskState, <span class="keyword">false</span>)) &#123;</span><br><span class="line">        a.info.flags |= ActivityInfo.FLAG_ALWAYS_RETAIN_TASK_STATE;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// 解析 android:stateNotNeeded 属性</span></span><br><span class="line">    <span class="keyword">if</span> (sa.getBoolean(R.styleable.AndroidManifestActivity_stateNotNeeded, <span class="keyword">false</span>)) &#123;</span><br><span class="line">        a.info.flags |= ActivityInfo.FLAG_STATE_NOT_NEEDED;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// 解析 android:excludeFromRecents 属性，不再最近任务显示</span></span><br><span class="line">    <span class="keyword">if</span> (sa.getBoolean(R.styleable.AndroidManifestActivity_excludeFromRecents, <span class="keyword">false</span>)) &#123;</span><br><span class="line">        a.info.flags |= ActivityInfo.FLAG_EXCLUDE_FROM_RECENTS;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// 解析 android:allowTaskReparenting 属性，这个属性真重要，能决定该 acitivty 和 task 的关系！</span></span><br><span class="line">    <span class="keyword">if</span> (sa.getBoolean(R.styleable.AndroidManifestActivity_allowTaskReparenting,</span><br><span class="line">            (owner.applicationInfo.flags&amp;ApplicationInfo.FLAG_ALLOW_TASK_REPARENTING) != <span class="number">0</span>)) &#123;</span><br><span class="line">        a.info.flags |= ActivityInfo.FLAG_ALLOW_TASK_REPARENTING;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// 解析 android:finishOnCloseSystemDialogs 属性</span></span><br><span class="line">    <span class="keyword">if</span> (sa.getBoolean(R.styleable.AndroidManifestActivity_finishOnCloseSystemDialogs, <span class="keyword">false</span>)) &#123;</span><br><span class="line">        a.info.flags |= ActivityInfo.FLAG_FINISH_ON_CLOSE_SYSTEM_DIALOGS;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// 解析 android:showOnLockScreen 属性</span></span><br><span class="line">    <span class="keyword">if</span> (sa.getBoolean(R.styleable.AndroidManifestActivity_showOnLockScreen, <span class="keyword">false</span>)</span><br><span class="line">            || sa.getBoolean(R.styleable.AndroidManifestActivity_showForAllUsers, <span class="keyword">false</span>)) &#123;</span><br><span class="line">        a.info.flags |= ActivityInfo.FLAG_SHOW_FOR_ALL_USERS;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// 解析 android:immersive 属性</span></span><br><span class="line">    <span class="keyword">if</span> (sa.getBoolean(R.styleable.AndroidManifestActivity_immersive, <span class="keyword">false</span>)) &#123;</span><br><span class="line">        a.info.flags |= ActivityInfo.FLAG_IMMERSIVE;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// 解析 android:systemUserOnly 属性</span></span><br><span class="line">    <span class="keyword">if</span> (sa.getBoolean(R.styleable.AndroidManifestActivity_systemUserOnly, <span class="keyword">false</span>)) &#123;</span><br><span class="line">        a.info.flags |= ActivityInfo.FLAG_SYSTEM_USER_ONLY;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// 接下来，对于 activity 和 receiver 解析不同的属性！</span></span><br><span class="line">    <span class="keyword">if</span> (!receiver) &#123;</span><br><span class="line">        <span class="comment">// 对于 activity 进入这个！</span></span><br><span class="line">        <span class="comment">// 解析 android:hardwareAccelerated 属性</span></span><br><span class="line">        <span class="keyword">if</span> (sa.getBoolean(R.styleable.AndroidManifestActivity_hardwareAccelerated,</span><br><span class="line">                hardwareAccelerated)) &#123;</span><br><span class="line">            a.info.flags |= ActivityInfo.FLAG_HARDWARE_ACCELERATED;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">// 解析 android:launchMode 属性</span></span><br><span class="line">        a.info.launchMode = sa.getInt(</span><br><span class="line">                R.styleable.AndroidManifestActivity_launchMode, ActivityInfo.LAUNCH_MULTIPLE);</span><br><span class="line">        <span class="comment">// 解析 android:documentLaunchMode 属性</span></span><br><span class="line">        a.info.documentLaunchMode = sa.getInt(</span><br><span class="line">                R.styleable.AndroidManifestActivity_documentLaunchMode,</span><br><span class="line">                ActivityInfo.DOCUMENT_LAUNCH_NONE);</span><br><span class="line">        <span class="comment">// 解析 android:maxRecents 属性</span></span><br><span class="line">        a.info.maxRecents = sa.getInt(</span><br><span class="line">                R.styleable.AndroidManifestActivity_maxRecents,</span><br><span class="line">                ActivityManager.getDefaultAppRecentsLimitStatic());</span><br><span class="line">        <span class="comment">// 解析 android:configChanges 属性</span></span><br><span class="line">        a.info.configChanges = sa.getInt(R.styleable.AndroidManifestActivity_configChanges, <span class="number">0</span>);</span><br><span class="line">        <span class="comment">// 解析 android:windowSoftInputMode 属性</span></span><br><span class="line">        a.info.softInputMode = sa.getInt(</span><br><span class="line">                R.styleable.AndroidManifestActivity_windowSoftInputMode, <span class="number">0</span>);</span><br><span class="line">        <span class="comment">// 解析 android:persistableMode 属性</span></span><br><span class="line">        a.info.persistableMode = sa.getInteger(</span><br><span class="line">                R.styleable.AndroidManifestActivity_persistableMode,</span><br><span class="line">                ActivityInfo.PERSIST_ROOT_ONLY);</span><br><span class="line">        <span class="comment">// 解析 android:allowEmbedded 属性</span></span><br><span class="line">        <span class="keyword">if</span> (sa.getBoolean(R.styleable.AndroidManifestActivity_allowEmbedded, <span class="keyword">false</span>)) &#123;</span><br><span class="line">            a.info.flags |= ActivityInfo.FLAG_ALLOW_EMBEDDED;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">// 解析 android:autoRemoveFromRecents 属性</span></span><br><span class="line">        <span class="keyword">if</span> (sa.getBoolean(R.styleable.AndroidManifestActivity_autoRemoveFromRecents, <span class="keyword">false</span>)) &#123;</span><br><span class="line">            a.info.flags |= ActivityInfo.FLAG_AUTO_REMOVE_FROM_RECENTS;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">// 解析 android:relinquishTaskIdentity 属性</span></span><br><span class="line">        <span class="keyword">if</span> (sa.getBoolean(R.styleable.AndroidManifestActivity_relinquishTaskIdentity, <span class="keyword">false</span>)) &#123;</span><br><span class="line">            a.info.flags |= ActivityInfo.FLAG_RELINQUISH_TASK_IDENTITY;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">// 解析 android:resumeWhilePausing 属性</span></span><br><span class="line">        <span class="keyword">if</span> (sa.getBoolean(R.styleable.AndroidManifestActivity_resumeWhilePausing, <span class="keyword">false</span>)) &#123;</span><br><span class="line">            a.info.flags |= ActivityInfo.FLAG_RESUME_WHILE_PAUSING;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">// 解析 android:screenOrientation 属性</span></span><br><span class="line">        a.info.screenOrientation = sa.getInt(</span><br><span class="line">                R.styleable.AndroidManifestActivity_screenOrientation,</span><br><span class="line">                SCREEN_ORIENTATION_UNSPECIFIED);</span><br><span class="line">        <span class="comment">// 解析 android:resizeableActivity android:supportsPictureInPicture 属性</span></span><br><span class="line">        a.info.resizeMode = RESIZE_MODE_UNRESIZEABLE;</span><br><span class="line">        <span class="keyword">final</span> <span class="keyword">boolean</span> appDefault = (owner.applicationInfo.privateFlags</span><br><span class="line">                &amp; PRIVATE_FLAG_RESIZEABLE_ACTIVITIES) != <span class="number">0</span>;</span><br><span class="line">        <span class="keyword">final</span> <span class="keyword">boolean</span> resizeableSetExplicitly</span><br><span class="line">                = sa.hasValue(R.styleable.AndroidManifestActivity_resizeableActivity);</span><br><span class="line">        <span class="keyword">final</span> <span class="keyword">boolean</span> resizeable = sa.getBoolean(</span><br><span class="line">                R.styleable.AndroidManifestActivity_resizeableActivity, appDefault);</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (resizeable) &#123;</span><br><span class="line">            <span class="keyword">if</span> (sa.getBoolean(R.styleable.AndroidManifestActivity_supportsPictureInPicture,</span><br><span class="line">                    <span class="keyword">false</span>)) &#123;</span><br><span class="line">                a.info.resizeMode = RESIZE_MODE_RESIZEABLE_AND_PIPABLE;</span><br><span class="line">            &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                a.info.resizeMode = RESIZE_MODE_RESIZEABLE;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125; <span class="keyword">else</span> <span class="keyword">if</span> (owner.applicationInfo.targetSdkVersion &gt;= Build.VERSION_CODES.N</span><br><span class="line">                || resizeableSetExplicitly) &#123;</span><br><span class="line">            a.info.resizeMode = RESIZE_MODE_UNRESIZEABLE;</span><br><span class="line">        &#125; <span class="keyword">else</span> <span class="keyword">if</span> (!a.info.isFixedOrientation() &amp;&amp; (a.info.flags &amp; FLAG_IMMERSIVE) == <span class="number">0</span>) &#123;</span><br><span class="line">            a.info.resizeMode = RESIZE_MODE_FORCE_RESIZEABLE;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">// 解析 android:alwaysFocusable 属性</span></span><br><span class="line">        <span class="keyword">if</span> (sa.getBoolean(R.styleable.AndroidManifestActivity_alwaysFocusable, <span class="keyword">false</span>)) &#123;</span><br><span class="line">            a.info.flags |= FLAG_ALWAYS_FOCUSABLE;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">// 解析 android:lockTaskMode 属性</span></span><br><span class="line">        a.info.lockTaskLaunchMode =</span><br><span class="line">                sa.getInt(R.styleable.AndroidManifestActivity_lockTaskMode, <span class="number">0</span>);</span><br><span class="line">        <span class="comment">// 解析 android:directBootAware 属性</span></span><br><span class="line">        a.info.encryptionAware = a.info.directBootAware = sa.getBoolean(</span><br><span class="line">                R.styleable.AndroidManifestActivity_directBootAware,</span><br><span class="line">                <span class="keyword">false</span>);</span><br><span class="line">        <span class="comment">// 解析 android:enableVrMode 属性</span></span><br><span class="line">        a.info.requestedVrComponent =</span><br><span class="line">            sa.getString(R.styleable.AndroidManifestActivity_enableVrMode);</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        <span class="comment">// 对于 receiver，会进入这里！</span></span><br><span class="line">        a.info.launchMode = ActivityInfo.LAUNCH_MULTIPLE;</span><br><span class="line">        a.info.configChanges = <span class="number">0</span>;</span><br><span class="line">        <span class="comment">// 解析 android:singleUser 属性</span></span><br><span class="line">        <span class="keyword">if</span> (sa.getBoolean(R.styleable.AndroidManifestActivity_singleUser, <span class="keyword">false</span>)) &#123;</span><br><span class="line">            a.info.flags |= ActivityInfo.FLAG_SINGLE_USER;</span><br><span class="line">            <span class="keyword">if</span> (a.info.exported &amp;&amp; (flags &amp; PARSE_IS_PRIVILEGED) == <span class="number">0</span>) &#123;</span><br><span class="line">                Slog.w(TAG, <span class="string">"Activity exported request ignored due to singleUser: "</span></span><br><span class="line">                        + a.className + <span class="string">" at "</span> + mArchiveSourcePath + <span class="string">" "</span></span><br><span class="line">                        + parser.getPositionDescription());</span><br><span class="line">                a.info.exported = <span class="keyword">false</span>;</span><br><span class="line">                setExported = <span class="keyword">true</span>;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">// 解析 android:directBootAware 属性</span></span><br><span class="line">        a.info.encryptionAware = a.info.directBootAware = sa.getBoolean(</span><br><span class="line">                R.styleable.AndroidManifestActivity_directBootAware,</span><br><span class="line">                <span class="keyword">false</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (a.info.directBootAware) &#123;</span><br><span class="line">        owner.applicationInfo.privateFlags |=</span><br><span class="line">                ApplicationInfo.PRIVATE_FLAG_PARTIALLY_DIRECT_BOOT_AWARE;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    sa.recycle();</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 如果解析的是 receiver，针对 height-weight 类型的进程做处理</span></span><br><span class="line">    <span class="keyword">if</span> (receiver &amp;&amp; (owner.applicationInfo.privateFlags</span><br><span class="line">            &amp;ApplicationInfo.PRIVATE_FLAG_CANT_SAVE_STATE) != <span class="number">0</span>) &#123;</span><br><span class="line">        <span class="keyword">if</span> (a.info.processName == owner.packageName) &#123;</span><br><span class="line">            outError[<span class="number">0</span>] = <span class="string">"Heavy-weight applications can not have receivers in main process"</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (outError[<span class="number">0</span>] != <span class="keyword">null</span>) &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">null</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">int</span> outerDepth = parser.getDepth();</span><br><span class="line">    <span class="keyword">int</span> type;</span><br><span class="line">    <span class="keyword">while</span> ((type=parser.next()) != XmlPullParser.END_DOCUMENT</span><br><span class="line">           &amp;&amp; (type != XmlPullParser.END_TAG</span><br><span class="line">                   || parser.getDepth() &gt; outerDepth)) &#123;</span><br><span class="line">        <span class="keyword">if</span> (type == XmlPullParser.END_TAG || type == XmlPullParser.TEXT) &#123;</span><br><span class="line">            <span class="keyword">continue</span>;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (parser.getName().equals(<span class="string">"intent-filter"</span>)) &#123; <span class="comment">// 解析 "intent-filter"</span></span><br><span class="line">            ActivityIntentInfo intent = <span class="keyword">new</span> ActivityIntentInfo(a);</span><br><span class="line">            <span class="keyword">if</span> (!parseIntent(res, parser, <span class="keyword">true</span>, <span class="keyword">true</span>, intent, outError)) &#123;</span><br><span class="line">                <span class="keyword">return</span> <span class="keyword">null</span>;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">if</span> (intent.countActions() == <span class="number">0</span>) &#123;</span><br><span class="line">                Slog.w(TAG, <span class="string">"No actions in intent filter at "</span></span><br><span class="line">                        + mArchiveSourcePath + <span class="string">" "</span></span><br><span class="line">                        + parser.getPositionDescription());</span><br><span class="line">            &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                a.intents.add(intent);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125; <span class="keyword">else</span> <span class="keyword">if</span> (!receiver &amp;&amp; parser.getName().equals(<span class="string">"preferred"</span>)) &#123; <span class="comment">// 解析 "preferred"</span></span><br><span class="line">            ActivityIntentInfo intent = <span class="keyword">new</span> ActivityIntentInfo(a);</span><br><span class="line">            <span class="keyword">if</span> (!parseIntent(res, parser, <span class="keyword">false</span>, <span class="keyword">false</span>, intent, outError)) &#123;</span><br><span class="line">                <span class="keyword">return</span> <span class="keyword">null</span>;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">if</span> (intent.countActions() == <span class="number">0</span>) &#123;</span><br><span class="line">                Slog.w(TAG, <span class="string">"No actions in preferred at "</span></span><br><span class="line">                        + mArchiveSourcePath + <span class="string">" "</span></span><br><span class="line">                        + parser.getPositionDescription());</span><br><span class="line">            &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                <span class="keyword">if</span> (owner.preferredActivityFilters == <span class="keyword">null</span>) &#123;</span><br><span class="line">                    owner.preferredActivityFilters = <span class="keyword">new</span> ArrayList&lt;ActivityIntentInfo&gt;();</span><br><span class="line">                &#125;</span><br><span class="line">                owner.preferredActivityFilters.add(intent);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125; <span class="keyword">else</span> <span class="keyword">if</span> (parser.getName().equals(<span class="string">"meta-data"</span>)) &#123; <span class="comment">// 解析 "meta-data"</span></span><br><span class="line">            <span class="keyword">if</span> ((a.metaData = parseMetaData(res, parser, a.metaData,</span><br><span class="line">                    outError)) == <span class="keyword">null</span>) &#123;</span><br><span class="line">                <span class="keyword">return</span> <span class="keyword">null</span>;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125; <span class="keyword">else</span> <span class="keyword">if</span> (!receiver &amp;&amp; parser.getName().equals(<span class="string">"layout"</span>)) &#123; <span class="comment">// 解析 "layout"</span></span><br><span class="line">            parseLayout(res, parser, a);</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            <span class="keyword">if</span> (!RIGID_PARSER) &#123;</span><br><span class="line">                Slog.w(TAG, <span class="string">"Problem in package "</span> + mArchiveSourcePath + <span class="string">":"</span>);</span><br><span class="line">                <span class="keyword">if</span> (receiver) &#123;</span><br><span class="line">                    Slog.w(TAG, <span class="string">"Unknown element under &lt;receiver&gt;: "</span> + parser.getName()</span><br><span class="line">                            + <span class="string">" at "</span> + mArchiveSourcePath + <span class="string">" "</span></span><br><span class="line">                            + parser.getPositionDescription());</span><br><span class="line">                &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                    Slog.w(TAG, <span class="string">"Unknown element under &lt;activity&gt;: "</span> + parser.getName()</span><br><span class="line">                            + <span class="string">" at "</span> + mArchiveSourcePath + <span class="string">" "</span></span><br><span class="line">                            + parser.getPositionDescription());</span><br><span class="line">                &#125;</span><br><span class="line">                XmlUtils.skipCurrentTag(parser);</span><br><span class="line">                <span class="keyword">continue</span>;</span><br><span class="line">            &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                <span class="keyword">if</span> (receiver) &#123;</span><br><span class="line">                    outError[<span class="number">0</span>] = <span class="string">"Bad element under &lt;receiver&gt;: "</span> + parser.getName();</span><br><span class="line">                &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                    outError[<span class="number">0</span>] = <span class="string">"Bad element under &lt;activity&gt;: "</span> + parser.getName();</span><br><span class="line">                &#125;</span><br><span class="line">                <span class="keyword">return</span> <span class="keyword">null</span>;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (!setExported) &#123;</span><br><span class="line">        a.info.exported = a.intents.size() &gt; <span class="number">0</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> a;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>整个解析过程很清晰，就是不断读取对应标签的属性，然后设置 Activity 的属性和标志位！</p>
<p>######3.1.1.2.3.2 PParser.parseService - 解析 service</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br></pre></td><td class="code"><pre><span class="line">private Service parseService(Package owner, Resources res,</span><br><span class="line">        XmlResourceParser parser, int flags, String[] outError)</span><br><span class="line">        throws XmlPullParserException, IOException &#123;</span><br><span class="line">    TypedArray sa = res.obtainAttributes(parser,</span><br><span class="line">            com.android.internal.R.styleable.AndroidManifestService);</span><br><span class="line">    // 解析 android:name android:label android:icon android:roundIcon android:logo android:banner 属性！</span><br><span class="line">    if (mParseServiceArgs == null) &#123;</span><br><span class="line">        mParseServiceArgs = new ParseComponentArgs(owner, outError,</span><br><span class="line">                com.android.internal.R.styleable.AndroidManifestService_name,</span><br><span class="line">                com.android.internal.R.styleable.AndroidManifestService_label,</span><br><span class="line">                com.android.internal.R.styleable.AndroidManifestService_icon,</span><br><span class="line">                com.android.internal.R.styleable.AndroidManifestService_roundIcon,</span><br><span class="line">                com.android.internal.R.styleable.AndroidManifestService_logo,</span><br><span class="line">                com.android.internal.R.styleable.AndroidManifestService_banner,</span><br><span class="line">                mSeparateProcesses,</span><br><span class="line">                com.android.internal.R.styleable.AndroidManifestService_process,</span><br><span class="line">                com.android.internal.R.styleable.AndroidManifestService_description,</span><br><span class="line">                com.android.internal.R.styleable.AndroidManifestService_enabled);</span><br><span class="line">        mParseServiceArgs.tag = &quot;&lt;service&gt;&quot;;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    mParseServiceArgs.sa = sa;</span><br><span class="line">    mParseServiceArgs.flags = flags;</span><br><span class="line">    // 创建 Service 对象！</span><br><span class="line">    Service s = new Service(mParseServiceArgs, new ServiceInfo());</span><br><span class="line">    if (outError[0] != null) &#123;</span><br><span class="line">        sa.recycle();</span><br><span class="line">        return null;</span><br><span class="line">    &#125;</span><br><span class="line">    // 解析 android:exported 属性！</span><br><span class="line">    boolean setExported = sa.hasValue(</span><br><span class="line">            com.android.internal.R.styleable.AndroidManifestService_exported);</span><br><span class="line">    if (setExported) &#123;</span><br><span class="line">        s.info.exported = sa.getBoolean(</span><br><span class="line">                com.android.internal.R.styleable.AndroidManifestService_exported, false);</span><br><span class="line">    &#125;</span><br><span class="line">    // 解析 android:permission 属性！</span><br><span class="line">    String str = sa.getNonConfigurationString(</span><br><span class="line">            com.android.internal.R.styleable.AndroidManifestService_permission, 0);</span><br><span class="line">    if (str == null) &#123;</span><br><span class="line">        s.info.permission = owner.applicationInfo.permission;</span><br><span class="line">    &#125; else &#123;</span><br><span class="line">        s.info.permission = str.length() &gt; 0 ? str.toString().intern() : null;</span><br><span class="line">    &#125;</span><br><span class="line">    // 解析 android:stopWithTask 属性！</span><br><span class="line">    s.info.flags = 0;</span><br><span class="line">    if (sa.getBoolean(</span><br><span class="line">            com.android.internal.R.styleable.AndroidManifestService_stopWithTask,</span><br><span class="line">            false)) &#123;</span><br><span class="line">        s.info.flags |= ServiceInfo.FLAG_STOP_WITH_TASK;</span><br><span class="line">    &#125;</span><br><span class="line">    // 解析 android:isolatedProcess 属性！</span><br><span class="line">    if (sa.getBoolean(</span><br><span class="line">            com.android.internal.R.styleable.AndroidManifestService_isolatedProcess,</span><br><span class="line">            false)) &#123;</span><br><span class="line">        s.info.flags |= ServiceInfo.FLAG_ISOLATED_PROCESS;</span><br><span class="line">    &#125;</span><br><span class="line">    // 解析 android:externalService 属性！</span><br><span class="line">    if (sa.getBoolean(</span><br><span class="line">            com.android.internal.R.styleable.AndroidManifestService_externalService,</span><br><span class="line">            false)) &#123;</span><br><span class="line">        s.info.flags |= ServiceInfo.FLAG_EXTERNAL_SERVICE;</span><br><span class="line">    &#125;</span><br><span class="line">    // 解析 android:singleUser 属性！</span><br><span class="line">    if (sa.getBoolean(</span><br><span class="line">            com.android.internal.R.styleable.AndroidManifestService_singleUser,</span><br><span class="line">            false)) &#123;</span><br><span class="line">        s.info.flags |= ServiceInfo.FLAG_SINGLE_USER;</span><br><span class="line">        if (s.info.exported &amp;&amp; (flags &amp; PARSE_IS_PRIVILEGED) == 0) &#123;</span><br><span class="line">            Slog.w(TAG, &quot;Service exported request ignored due to singleUser: &quot;</span><br><span class="line">                    + s.className + &quot; at &quot; + mArchiveSourcePath + &quot; &quot;</span><br><span class="line">                    + parser.getPositionDescription());</span><br><span class="line">            s.info.exported = false;</span><br><span class="line">            setExported = true;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    // 解析 android:directBootAware 属性！</span><br><span class="line">    s.info.encryptionAware = s.info.directBootAware = sa.getBoolean(</span><br><span class="line">            R.styleable.AndroidManifestService_directBootAware,</span><br><span class="line">            false);</span><br><span class="line">    if (s.info.directBootAware) &#123;</span><br><span class="line">        owner.applicationInfo.privateFlags |=</span><br><span class="line">                ApplicationInfo.PRIVATE_FLAG_PARTIALLY_DIRECT_BOOT_AWARE;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    sa.recycle();</span><br><span class="line">    // 如果应用属于 height-weight 类型的进程，要对进程名做处理！</span><br><span class="line">    if ((owner.applicationInfo.privateFlags&amp;ApplicationInfo.PRIVATE_FLAG_CANT_SAVE_STATE)</span><br><span class="line">            != 0) &#123;</span><br><span class="line">        if (s.info.processName == owner.packageName) &#123;</span><br><span class="line">            outError[0] = &quot;Heavy-weight applications can not have services in main process&quot;;</span><br><span class="line">            return null;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    int outerDepth = parser.getDepth();</span><br><span class="line">    int type;</span><br><span class="line">    while ((type=parser.next()) != XmlPullParser.END_DOCUMENT</span><br><span class="line">           &amp;&amp; (type != XmlPullParser.END_TAG</span><br><span class="line">                   || parser.getDepth() &gt; outerDepth)) &#123;</span><br><span class="line">        if (type == XmlPullParser.END_TAG || type == XmlPullParser.TEXT) &#123;</span><br><span class="line">            continue;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        if (parser.getName().equals(&quot;intent-filter&quot;)) &#123; // 解析 &quot;intent-filter&quot;！</span><br><span class="line">            ServiceIntentInfo intent = new ServiceIntentInfo(s);</span><br><span class="line">            if (!parseIntent(res, parser, true, false, intent, outError)) &#123;</span><br><span class="line">                return null;</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            s.intents.add(intent);</span><br><span class="line">        &#125; else if (parser.getName().equals(&quot;meta-data&quot;)) &#123;</span><br><span class="line">            if ((s.metaData=parseMetaData(res, parser, s.metaData,</span><br><span class="line">                    outError)) == null) &#123;</span><br><span class="line">                return null;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125; else &#123;</span><br><span class="line">            if (!RIGID_PARSER) &#123;</span><br><span class="line">                Slog.w(TAG, &quot;Unknown element under &lt;service&gt;: &quot;</span><br><span class="line">                        + parser.getName() + &quot; at &quot; + mArchiveSourcePath + &quot; &quot;</span><br><span class="line">                        + parser.getPositionDescription());</span><br><span class="line">                XmlUtils.skipCurrentTag(parser);</span><br><span class="line">                continue;</span><br><span class="line">            &#125; else &#123;</span><br><span class="line">                outError[0] = &quot;Bad element under &lt;service&gt;: &quot; + parser.getName();</span><br><span class="line">                return null;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    if (!setExported) &#123;</span><br><span class="line">        s.info.exported = s.intents.size() &gt; 0;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    return s;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>######3.1.1.2.3.3 PParser.parseProvider - 解析 parseProvider</p>
<p>接下来是解析 provider：<br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">private</span> Provider <span class="title">parseProvider</span><span class="params">(Package owner, Resources res,</span></span></span><br><span class="line"><span class="function"><span class="params">        XmlResourceParser parser, <span class="keyword">int</span> flags, String[] outError)</span></span></span><br><span class="line"><span class="function">        <span class="keyword">throws</span> XmlPullParserException, IOException </span>&#123;</span><br><span class="line">    TypedArray sa = res.obtainAttributes(parser,</span><br><span class="line">            com.android.internal.R.styleable.AndroidManifestProvider);</span><br><span class="line">    <span class="comment">// 解析 android:name android:label android:icon android:roundIcon android:logo android:banner 属性！</span></span><br><span class="line">    <span class="keyword">if</span> (mParseProviderArgs == <span class="keyword">null</span>) &#123;</span><br><span class="line">        mParseProviderArgs = <span class="keyword">new</span> ParseComponentArgs(owner, outError,</span><br><span class="line">                com.android.internal.R.styleable.AndroidManifestProvider_name,</span><br><span class="line">                com.android.internal.R.styleable.AndroidManifestProvider_label,</span><br><span class="line">                com.android.internal.R.styleable.AndroidManifestProvider_icon,</span><br><span class="line">                com.android.internal.R.styleable.AndroidManifestProvider_roundIcon,</span><br><span class="line">                com.android.internal.R.styleable.AndroidManifestProvider_logo,</span><br><span class="line">                com.android.internal.R.styleable.AndroidManifestProvider_banner,</span><br><span class="line">                mSeparateProcesses,</span><br><span class="line">                com.android.internal.R.styleable.AndroidManifestProvider_process,</span><br><span class="line">                com.android.internal.R.styleable.AndroidManifestProvider_description,</span><br><span class="line">                com.android.internal.R.styleable.AndroidManifestProvider_enabled);</span><br><span class="line">        mParseProviderArgs.tag = <span class="string">"&lt;provider&gt;"</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    mParseProviderArgs.sa = sa;</span><br><span class="line">    mParseProviderArgs.flags = flags;</span><br><span class="line">    <span class="comment">// 创建一个 Provider 对象！</span></span><br><span class="line">    Provider p = <span class="keyword">new</span> Provider(mParseProviderArgs, <span class="keyword">new</span> ProviderInfo());</span><br><span class="line">    <span class="keyword">if</span> (outError[<span class="number">0</span>] != <span class="keyword">null</span>) &#123;</span><br><span class="line">        sa.recycle();</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">null</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">boolean</span> providerExportedDefault = <span class="keyword">false</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (owner.applicationInfo.targetSdkVersion &lt; Build.VERSION_CODES.JELLY_BEAN_MR1) &#123;</span><br><span class="line">        <span class="comment">// For compatibility, applications targeting API level 16 or lower</span></span><br><span class="line">        <span class="comment">// should have their content providers exported by default, unless they</span></span><br><span class="line">        <span class="comment">// specify otherwise.</span></span><br><span class="line">        providerExportedDefault = <span class="keyword">true</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// 解析 android:exported 属性！</span></span><br><span class="line">    p.info.exported = sa.getBoolean(</span><br><span class="line">            com.android.internal.R.styleable.AndroidManifestProvider_exported,</span><br><span class="line">            providerExportedDefault);</span><br><span class="line">    <span class="comment">// 解析 android:authorities 属性！</span></span><br><span class="line">    String cpname = sa.getNonConfigurationString(</span><br><span class="line">            com.android.internal.R.styleable.AndroidManifestProvider_authorities, <span class="number">0</span>);</span><br><span class="line">    <span class="comment">// 解析 android:syncable 属性！</span></span><br><span class="line">    p.info.isSyncable = sa.getBoolean(</span><br><span class="line">            com.android.internal.R.styleable.AndroidManifestProvider_syncable,</span><br><span class="line">            <span class="keyword">false</span>);</span><br><span class="line">    <span class="comment">// 解析 android:permission 属性！</span></span><br><span class="line">    String permission = sa.getNonConfigurationString(</span><br><span class="line">            com.android.internal.R.styleable.AndroidManifestProvider_permission, <span class="number">0</span>);</span><br><span class="line">    <span class="comment">// 解析 android:readPermission 属性！</span></span><br><span class="line">    String str = sa.getNonConfigurationString(</span><br><span class="line">            com.android.internal.R.styleable.AndroidManifestProvider_readPermission, <span class="number">0</span>);</span><br><span class="line">    <span class="keyword">if</span> (str == <span class="keyword">null</span>) &#123;</span><br><span class="line">        str = permission;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span> (str == <span class="keyword">null</span>) &#123;</span><br><span class="line">        p.info.readPermission = owner.applicationInfo.permission;</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        p.info.readPermission =</span><br><span class="line">            str.length() &gt; <span class="number">0</span> ? str.toString().intern() : <span class="keyword">null</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// 解析 android:writePermission 属性！</span></span><br><span class="line">    str = sa.getNonConfigurationString(</span><br><span class="line">            com.android.internal.R.styleable.AndroidManifestProvider_writePermission, <span class="number">0</span>);</span><br><span class="line">    <span class="keyword">if</span> (str == <span class="keyword">null</span>) &#123;</span><br><span class="line">        str = permission;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span> (str == <span class="keyword">null</span>) &#123;</span><br><span class="line">        p.info.writePermission = owner.applicationInfo.permission;</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        p.info.writePermission =</span><br><span class="line">            str.length() &gt; <span class="number">0</span> ? str.toString().intern() : <span class="keyword">null</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// 解析 android:grantUriPermissions 属性！</span></span><br><span class="line">    p.info.grantUriPermissions = sa.getBoolean(</span><br><span class="line">            com.android.internal.R.styleable.AndroidManifestProvider_grantUriPermissions,</span><br><span class="line">            <span class="keyword">false</span>);</span><br><span class="line">    <span class="comment">// 解析 android:multiprocess 属性！</span></span><br><span class="line">    p.info.multiprocess = sa.getBoolean(</span><br><span class="line">            com.android.internal.R.styleable.AndroidManifestProvider_multiprocess,</span><br><span class="line">            <span class="keyword">false</span>);</span><br><span class="line">    <span class="comment">// 解析 android:initOrder 属性！</span></span><br><span class="line">    p.info.initOrder = sa.getInt(</span><br><span class="line">            com.android.internal.R.styleable.AndroidManifestProvider_initOrder,</span><br><span class="line">            <span class="number">0</span>);</span><br><span class="line"></span><br><span class="line">    p.info.flags = <span class="number">0</span>;</span><br><span class="line">    <span class="comment">// 解析 android:singleUser 属性！</span></span><br><span class="line">    <span class="keyword">if</span> (sa.getBoolean(</span><br><span class="line">            com.android.internal.R.styleable.AndroidManifestProvider_singleUser,</span><br><span class="line">            <span class="keyword">false</span>)) &#123;</span><br><span class="line">        p.info.flags |= ProviderInfo.FLAG_SINGLE_USER;</span><br><span class="line">        <span class="keyword">if</span> (p.info.exported &amp;&amp; (flags &amp; PARSE_IS_PRIVILEGED) == <span class="number">0</span>) &#123;</span><br><span class="line">            Slog.w(TAG, <span class="string">"Provider exported request ignored due to singleUser: "</span></span><br><span class="line">                    + p.className + <span class="string">" at "</span> + mArchiveSourcePath + <span class="string">" "</span></span><br><span class="line">                    + parser.getPositionDescription());</span><br><span class="line">            p.info.exported = <span class="keyword">false</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// 解析 android:directBootAware 属性！</span></span><br><span class="line">    p.info.encryptionAware = p.info.directBootAware = sa.getBoolean(</span><br><span class="line">            R.styleable.AndroidManifestProvider_directBootAware,</span><br><span class="line">            <span class="keyword">false</span>);</span><br><span class="line">    <span class="keyword">if</span> (p.info.directBootAware) &#123;</span><br><span class="line">        owner.applicationInfo.privateFlags |=</span><br><span class="line">                ApplicationInfo.PRIVATE_FLAG_PARTIALLY_DIRECT_BOOT_AWARE;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    sa.recycle();</span><br><span class="line">    <span class="comment">// 如果应用设置为 height-weight 类型的应用，对进程名要做校验！</span></span><br><span class="line">    <span class="keyword">if</span> ((owner.applicationInfo.privateFlags&amp;ApplicationInfo.PRIVATE_FLAG_CANT_SAVE_STATE)</span><br><span class="line">            != <span class="number">0</span>) &#123;</span><br><span class="line">        <span class="keyword">if</span> (p.info.processName == owner.packageName) &#123;</span><br><span class="line">            outError[<span class="number">0</span>] = <span class="string">"Heavy-weight applications can not have providers in main process"</span>;</span><br><span class="line">            <span class="keyword">return</span> <span class="keyword">null</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (cpname == <span class="keyword">null</span>) &#123;</span><br><span class="line">        outError[<span class="number">0</span>] = <span class="string">"&lt;provider&gt; does not include authorities attribute"</span>;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">null</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span> (cpname.length() &lt;= <span class="number">0</span>) &#123;</span><br><span class="line">        outError[<span class="number">0</span>] = <span class="string">"&lt;provider&gt; has empty authorities attribute"</span>;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">null</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    p.info.authority = cpname.intern();</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (!parseProviderTags(res, parser, p, outError)) &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">null</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> p;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>对 provider 的解析就分析到这里！</p>
<h6 id="3-1-1-2-3-4-PParser-parseIntent-解析-intent-filter"><a href="#3-1-1-2-3-4-PParser-parseIntent-解析-intent-filter" class="headerlink" title="3.1.1.2.3.4 PParser.parseIntent - 解析 intent-filter"></a>3.1.1.2.3.4 PParser.parseIntent - 解析 intent-filter</h6><p>接下来，我们来看看对 activity receiver provider 的 intent-filter 的解析！</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">boolean</span> <span class="title">parseIntent</span><span class="params">(Resources res, XmlResourceParser parser,</span></span></span><br><span class="line"><span class="function"><span class="params">        <span class="keyword">boolean</span> allowGlobs, <span class="keyword">boolean</span> allowAutoVerify, IntentInfo outInfo, String[] outError)</span></span></span><br><span class="line"><span class="function">        <span class="keyword">throws</span> XmlPullParserException, IOException </span>&#123;</span><br><span class="line"></span><br><span class="line">    TypedArray sa = res.obtainAttributes(parser,</span><br><span class="line">            com.android.internal.R.styleable.AndroidManifestIntentFilter);</span><br><span class="line">    <span class="comment">// 解析 android:priority 属性！</span></span><br><span class="line">    <span class="keyword">int</span> priority = sa.getInt(</span><br><span class="line">            com.android.internal.R.styleable.AndroidManifestIntentFilter_priority, <span class="number">0</span>);</span><br><span class="line">    outInfo.setPriority(priority);</span><br><span class="line">    <span class="comment">// 解析 android:label 属性！</span></span><br><span class="line">    TypedValue v = sa.peekValue(</span><br><span class="line">            com.android.internal.R.styleable.AndroidManifestIntentFilter_label);</span><br><span class="line">    <span class="keyword">if</span> (v != <span class="keyword">null</span> &amp;&amp; (outInfo.labelRes=v.resourceId) == <span class="number">0</span>) &#123;</span><br><span class="line">        outInfo.nonLocalizedLabel = v.coerceToString();</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// 解析 android:useRoundIcon 属性！</span></span><br><span class="line">    <span class="keyword">final</span> <span class="keyword">boolean</span> useRoundIcon =</span><br><span class="line">            Resources.getSystem().getBoolean(com.android.internal.R.bool.config_useRoundIcon);</span><br><span class="line">    <span class="comment">// 解析 android:roundIcon android:icon 属性！</span></span><br><span class="line">    <span class="keyword">int</span> roundIconVal = useRoundIcon ? sa.getResourceId(</span><br><span class="line">            com.android.internal.R.styleable.AndroidManifestIntentFilter_roundIcon, <span class="number">0</span>) : <span class="number">0</span>;</span><br><span class="line">    <span class="keyword">if</span> (roundIconVal != <span class="number">0</span>) &#123;</span><br><span class="line">        outInfo.icon = roundIconVal;</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        outInfo.icon = sa.getResourceId(</span><br><span class="line">                com.android.internal.R.styleable.AndroidManifestIntentFilter_icon, <span class="number">0</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// 解析 android:logo 属性！</span></span><br><span class="line">    outInfo.logo = sa.getResourceId(</span><br><span class="line">            com.android.internal.R.styleable.AndroidManifestIntentFilter_logo, <span class="number">0</span>);</span><br><span class="line">    <span class="comment">// 解析 android:banner 属性！</span></span><br><span class="line">    outInfo.banner = sa.getResourceId(</span><br><span class="line">            com.android.internal.R.styleable.AndroidManifestIntentFilter_banner, <span class="number">0</span>);</span><br><span class="line">    <span class="comment">// 解析 android:autoVerify 属性！</span></span><br><span class="line">    <span class="keyword">if</span> (allowAutoVerify) &#123;</span><br><span class="line">        outInfo.setAutoVerify(sa.getBoolean(</span><br><span class="line">                com.android.internal.R.styleable.AndroidManifestIntentFilter_autoVerify,</span><br><span class="line">                <span class="keyword">false</span>));</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    sa.recycle();</span><br><span class="line"></span><br><span class="line">    <span class="keyword">int</span> outerDepth = parser.getDepth();</span><br><span class="line">    <span class="keyword">int</span> type;</span><br><span class="line">    <span class="keyword">while</span> ((type = parser.next()) != XmlPullParser.END_DOCUMENT</span><br><span class="line">            &amp;&amp; (type != XmlPullParser.END_TAG || parser.getDepth() &gt; outerDepth)) &#123;</span><br><span class="line">        <span class="keyword">if</span> (type == XmlPullParser.END_TAG || type == XmlPullParser.TEXT) &#123;</span><br><span class="line">            <span class="keyword">continue</span>;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        String nodeName = parser.getName();</span><br><span class="line">        <span class="keyword">if</span> (nodeName.equals(<span class="string">"action"</span>)) &#123; <span class="comment">// 解析 "action" 标签！</span></span><br><span class="line">            String value = parser.getAttributeValue(</span><br><span class="line">                    ANDROID_RESOURCES, <span class="string">"name"</span>);</span><br><span class="line">            <span class="keyword">if</span> (value == <span class="keyword">null</span> || value == <span class="string">""</span>) &#123;</span><br><span class="line">                outError[<span class="number">0</span>] = <span class="string">"No value supplied for &lt;android:name&gt;"</span>;</span><br><span class="line">                <span class="keyword">return</span> <span class="keyword">false</span>;</span><br><span class="line">            &#125;</span><br><span class="line">            XmlUtils.skipCurrentTag(parser);</span><br><span class="line"></span><br><span class="line">            outInfo.addAction(value);</span><br><span class="line">        &#125; <span class="keyword">else</span> <span class="keyword">if</span> (nodeName.equals(<span class="string">"category"</span>)) &#123; <span class="comment">// 解析 "category" 标签！</span></span><br><span class="line">            String value = parser.getAttributeValue(</span><br><span class="line">                    ANDROID_RESOURCES, <span class="string">"name"</span>);</span><br><span class="line">            <span class="keyword">if</span> (value == <span class="keyword">null</span> || value == <span class="string">""</span>) &#123;</span><br><span class="line">                outError[<span class="number">0</span>] = <span class="string">"No value supplied for &lt;android:name&gt;"</span>;</span><br><span class="line">                <span class="keyword">return</span> <span class="keyword">false</span>;</span><br><span class="line">            &#125;</span><br><span class="line">            XmlUtils.skipCurrentTag(parser);</span><br><span class="line"></span><br><span class="line">            outInfo.addCategory(value);</span><br><span class="line"></span><br><span class="line">        &#125; <span class="keyword">else</span> <span class="keyword">if</span> (nodeName.equals(<span class="string">"data"</span>)) &#123;  <span class="comment">// 解析 "data" 标签！</span></span><br><span class="line">            sa = res.obtainAttributes(parser,</span><br><span class="line">                    com.android.internal.R.styleable.AndroidManifestData);</span><br><span class="line">            <span class="comment">// 解析 android:mimeType 属性！</span></span><br><span class="line">            String str = sa.getNonConfigurationString(</span><br><span class="line">                    com.android.internal.R.styleable.AndroidManifestData_mimeType, <span class="number">0</span>);</span><br><span class="line">            <span class="keyword">if</span> (str != <span class="keyword">null</span>) &#123;</span><br><span class="line">                <span class="keyword">try</span> &#123;</span><br><span class="line">                    outInfo.addDataType(str);</span><br><span class="line">                &#125; <span class="keyword">catch</span> (IntentFilter.MalformedMimeTypeException e) &#123;</span><br><span class="line">                    outError[<span class="number">0</span>] = e.toString();</span><br><span class="line">                    sa.recycle();</span><br><span class="line">                    <span class="keyword">return</span> <span class="keyword">false</span>;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="comment">// 解析 android:scheme 属性！</span></span><br><span class="line">            str = sa.getNonConfigurationString(</span><br><span class="line">                    com.android.internal.R.styleable.AndroidManifestData_scheme, <span class="number">0</span>);</span><br><span class="line">            <span class="keyword">if</span> (str != <span class="keyword">null</span>) &#123;</span><br><span class="line">                outInfo.addDataScheme(str);</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="comment">// 解析 android:ssp 属性！</span></span><br><span class="line">            str = sa.getNonConfigurationString(</span><br><span class="line">                    com.android.internal.R.styleable.AndroidManifestData_ssp, <span class="number">0</span>);</span><br><span class="line">            <span class="keyword">if</span> (str != <span class="keyword">null</span>) &#123;</span><br><span class="line">                outInfo.addDataSchemeSpecificPart(str, PatternMatcher.PATTERN_LITERAL);</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="comment">// 解析 android:sspPrefix 属性！</span></span><br><span class="line">            str = sa.getNonConfigurationString(</span><br><span class="line">                    com.android.internal.R.styleable.AndroidManifestData_sspPrefix, <span class="number">0</span>);</span><br><span class="line">            <span class="keyword">if</span> (str != <span class="keyword">null</span>) &#123;</span><br><span class="line">                outInfo.addDataSchemeSpecificPart(str, PatternMatcher.PATTERN_PREFIX);</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="comment">// 解析 android:sspPattern 属性！</span></span><br><span class="line">            str = sa.getNonConfigurationString(</span><br><span class="line">                    com.android.internal.R.styleable.AndroidManifestData_sspPattern, <span class="number">0</span>);</span><br><span class="line">            <span class="keyword">if</span> (str != <span class="keyword">null</span>) &#123;</span><br><span class="line">                <span class="keyword">if</span> (!allowGlobs) &#123;</span><br><span class="line">                    outError[<span class="number">0</span>] = <span class="string">"sspPattern not allowed here; ssp must be literal"</span>;</span><br><span class="line">                    <span class="keyword">return</span> <span class="keyword">false</span>;</span><br><span class="line">                &#125;</span><br><span class="line">                outInfo.addDataSchemeSpecificPart(str, PatternMatcher.PATTERN_SIMPLE_GLOB);</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="comment">// 解析 android:host android:port 属性！</span></span><br><span class="line">            String host = sa.getNonConfigurationString(</span><br><span class="line">                    com.android.internal.R.styleable.AndroidManifestData_host, <span class="number">0</span>);</span><br><span class="line">            String port = sa.getNonConfigurationString(</span><br><span class="line">                    com.android.internal.R.styleable.AndroidManifestData_port, <span class="number">0</span>);</span><br><span class="line">            <span class="keyword">if</span> (host != <span class="keyword">null</span>) &#123;</span><br><span class="line">                outInfo.addDataAuthority(host, port);</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="comment">// 解析 android:path 属性！</span></span><br><span class="line">            str = sa.getNonConfigurationString(</span><br><span class="line">                    com.android.internal.R.styleable.AndroidManifestData_path, <span class="number">0</span>);</span><br><span class="line">            <span class="keyword">if</span> (str != <span class="keyword">null</span>) &#123;</span><br><span class="line">                outInfo.addDataPath(str, PatternMatcher.PATTERN_LITERAL);</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="comment">// 解析 android:pathPrefix 属性！</span></span><br><span class="line">            str = sa.getNonConfigurationString(</span><br><span class="line">                    com.android.internal.R.styleable.AndroidManifestData_pathPrefix, <span class="number">0</span>);</span><br><span class="line">            <span class="keyword">if</span> (str != <span class="keyword">null</span>) &#123;</span><br><span class="line">                outInfo.addDataPath(str, PatternMatcher.PATTERN_PREFIX);</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="comment">// 解析 android:pathPattern 属性！</span></span><br><span class="line">            str = sa.getNonConfigurationString(</span><br><span class="line">                    com.android.internal.R.styleable.AndroidManifestData_pathPattern, <span class="number">0</span>);</span><br><span class="line">            <span class="keyword">if</span> (str != <span class="keyword">null</span>) &#123;</span><br><span class="line">                <span class="keyword">if</span> (!allowGlobs) &#123;</span><br><span class="line">                    outError[<span class="number">0</span>] = <span class="string">"pathPattern not allowed here; path must be literal"</span>;</span><br><span class="line">                    <span class="keyword">return</span> <span class="keyword">false</span>;</span><br><span class="line">                &#125;</span><br><span class="line">                outInfo.addDataPath(str, PatternMatcher.PATTERN_SIMPLE_GLOB);</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            sa.recycle();</span><br><span class="line">            XmlUtils.skipCurrentTag(parser);</span><br><span class="line">        &#125; <span class="keyword">else</span> <span class="keyword">if</span> (!RIGID_PARSER) &#123;</span><br><span class="line">            Slog.w(TAG, <span class="string">"Unknown element under &lt;intent-filter&gt;: "</span></span><br><span class="line">                    + parser.getName() + <span class="string">" at "</span> + mArchiveSourcePath + <span class="string">" "</span></span><br><span class="line">                    + parser.getPositionDescription());</span><br><span class="line">            XmlUtils.skipCurrentTag(parser);</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            outError[<span class="number">0</span>] = <span class="string">"Bad element under &lt;intent-filter&gt;: "</span> + parser.getName();</span><br><span class="line">            <span class="keyword">return</span> <span class="keyword">false</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    outInfo.hasDefault = outInfo.hasCategory(Intent.CATEGORY_DEFAULT);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (DEBUG_PARSER) &#123;</span><br><span class="line">        <span class="keyword">final</span> StringBuilder cats = <span class="keyword">new</span> StringBuilder(<span class="string">"Intent d="</span>);</span><br><span class="line">        cats.append(outInfo.hasDefault);</span><br><span class="line">        cats.append(<span class="string">", cat="</span>);</span><br><span class="line"></span><br><span class="line">        <span class="keyword">final</span> Iterator&lt;String&gt; it = outInfo.categoriesIterator();</span><br><span class="line">        <span class="keyword">if</span> (it != <span class="keyword">null</span>) &#123;</span><br><span class="line">            <span class="keyword">while</span> (it.hasNext()) &#123;</span><br><span class="line">                cats.append(<span class="string">' '</span>);</span><br><span class="line">                cats.append(it.next());</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        Slog.d(TAG, cats.toString());</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">true</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>对 intent-filter 的解析就到这里！</p>
<h4 id="3-1-1-3-PParser-parseSplitApk-4"><a href="#3-1-1-3-PParser-parseSplitApk-4" class="headerlink" title="3.1.1.3 PParser.parseSplitApk[4]"></a>3.1.1.3 PParser.parseSplitApk[4]</h4><p>核心 apk 解析完成后，会返回一个 Package 对象，传入 parseSplitApk，用于解析非核心 apk：<br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">parseSplitApk</span><span class="params">(Package pkg, <span class="keyword">int</span> splitIndex, AssetManager assets, <span class="keyword">int</span> flags)</span></span></span><br><span class="line"><span class="function">        <span class="keyword">throws</span> PackageParserException </span>&#123;</span><br><span class="line">    <span class="keyword">final</span> String apkPath = pkg.splitCodePaths[splitIndex];</span><br><span class="line"></span><br><span class="line">    mParseError = PackageManager.INSTALL_SUCCEEDED;</span><br><span class="line">    mArchiveSourcePath = apkPath;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (DEBUG_JAR) Slog.d(TAG, <span class="string">"Scanning split APK: "</span> + apkPath);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">final</span> <span class="keyword">int</span> cookie = loadApkIntoAssetManager(assets, apkPath, flags);</span><br><span class="line"></span><br><span class="line">    Resources res = <span class="keyword">null</span>;</span><br><span class="line">    XmlResourceParser parser = <span class="keyword">null</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">        res = <span class="keyword">new</span> Resources(assets, mMetrics, <span class="keyword">null</span>);</span><br><span class="line">        assets.setConfiguration(<span class="number">0</span>, <span class="number">0</span>, <span class="keyword">null</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>,</span><br><span class="line">                Build.VERSION.RESOURCES_SDK_INT);</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 用于解析 AndroidManifest.xml 文件！</span></span><br><span class="line">        parser = assets.openXmlResourceParser(cookie, ANDROID_MANIFEST_FILENAME);</span><br><span class="line"></span><br><span class="line">        <span class="keyword">final</span> String[] outError = <span class="keyword">new</span> String[<span class="number">1</span>];</span><br><span class="line">        </span><br><span class="line">        <span class="comment">//【3.1.1.3.1】解析非核心 apk！</span></span><br><span class="line">        pkg = parseSplitApk(pkg, res, parser, flags, splitIndex, outError);</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (pkg == <span class="keyword">null</span>) &#123;</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> PackageParserException(mParseError,</span><br><span class="line">                    apkPath + <span class="string">" (at "</span> + parser.getPositionDescription() + <span class="string">"): "</span> + outError[<span class="number">0</span>]);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">    &#125; <span class="keyword">catch</span> (PackageParserException e) &#123;</span><br><span class="line">        <span class="keyword">throw</span> e;</span><br><span class="line">    &#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">        <span class="keyword">throw</span> <span class="keyword">new</span> PackageParserException(INSTALL_PARSE_FAILED_UNEXPECTED_EXCEPTION,</span><br><span class="line">                <span class="string">"Failed to read manifest from "</span> + apkPath, e);</span><br><span class="line">    &#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">        IoUtils.closeQuietly(parser);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>这个过程个解析 base apk 一样，我们不多关注！</p>
<h5 id="3-1-1-3-1-PParser-parseSplitApk-5"><a href="#3-1-1-3-1-PParser-parseSplitApk-5" class="headerlink" title="3.1.1.3.1 PParser.parseSplitApk[5]"></a>3.1.1.3.1 PParser.parseSplitApk[5]</h5><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">private</span> Package <span class="title">parseSplitApk</span><span class="params">(Package pkg, Resources res, XmlResourceParser parser, <span class="keyword">int</span> flags,</span></span></span><br><span class="line"><span class="function"><span class="params">        <span class="keyword">int</span> splitIndex, String[] outError)</span> <span class="keyword">throws</span> XmlPullParserException, IOException,</span></span><br><span class="line"><span class="function">        PackageParserException </span>&#123;</span><br><span class="line"></span><br><span class="line">    AttributeSet attrs = parser;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//【3.1.1.1.1.2】解析 package 和 sliptName 属性！</span></span><br><span class="line">    parsePackageSplitNames(parser, attrs);</span><br><span class="line"></span><br><span class="line">    mParseInstrumentationArgs = <span class="keyword">null</span>;</span><br><span class="line">    mParseActivityArgs = <span class="keyword">null</span>;</span><br><span class="line">    mParseServiceArgs = <span class="keyword">null</span>;</span><br><span class="line">    mParseProviderArgs = <span class="keyword">null</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">int</span> type;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">boolean</span> foundApp = <span class="keyword">false</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">int</span> outerDepth = parser.getDepth();</span><br><span class="line">    <span class="keyword">while</span> ((type = parser.next()) != XmlPullParser.END_DOCUMENT</span><br><span class="line">            &amp;&amp; (type != XmlPullParser.END_TAG || parser.getDepth() &gt; outerDepth)) &#123;</span><br><span class="line">        <span class="keyword">if</span> (type == XmlPullParser.END_TAG || type == XmlPullParser.TEXT) &#123;</span><br><span class="line">            <span class="keyword">continue</span>;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        String tagName = parser.getName();</span><br><span class="line">        <span class="keyword">if</span> (tagName.equals(<span class="string">"application"</span>)) &#123; <span class="comment">// 解析非核心 apk 的 "application" 标签！</span></span><br><span class="line">            <span class="keyword">if</span> (foundApp) &#123;</span><br><span class="line">                <span class="keyword">if</span> (RIGID_PARSER) &#123;</span><br><span class="line">                    outError[<span class="number">0</span>] = <span class="string">"&lt;manifest&gt; has more than one &lt;application&gt;"</span>;</span><br><span class="line">                    mParseError = PackageManager.INSTALL_PARSE_FAILED_MANIFEST_MALFORMED;</span><br><span class="line">                    <span class="keyword">return</span> <span class="keyword">null</span>;</span><br><span class="line">                &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                    Slog.w(TAG, <span class="string">"&lt;manifest&gt; has more than one &lt;application&gt;"</span>);</span><br><span class="line">                    XmlUtils.skipCurrentTag(parser);</span><br><span class="line">                    <span class="keyword">continue</span>;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            foundApp = <span class="keyword">true</span>;</span><br><span class="line">            </span><br><span class="line">            <span class="comment">//【3.1.1.3.2】调用 parseSplitApplication 方法继续解析！</span></span><br><span class="line">            <span class="keyword">if</span> (!parseSplitApplication(pkg, res, parser, flags, splitIndex, outError)) &#123;</span><br><span class="line">                <span class="keyword">return</span> <span class="keyword">null</span>;</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">        &#125; <span class="keyword">else</span> <span class="keyword">if</span> (RIGID_PARSER) &#123;</span><br><span class="line">            outError[<span class="number">0</span>] = <span class="string">"Bad element under &lt;manifest&gt;: "</span></span><br><span class="line">                + parser.getName();</span><br><span class="line">            mParseError = PackageManager.INSTALL_PARSE_FAILED_MANIFEST_MALFORMED;</span><br><span class="line">            <span class="keyword">return</span> <span class="keyword">null</span>;</span><br><span class="line"></span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            Slog.w(TAG, <span class="string">"Unknown element under &lt;manifest&gt;: "</span> + parser.getName()</span><br><span class="line">                    + <span class="string">" at "</span> + mArchiveSourcePath + <span class="string">" "</span></span><br><span class="line">                    + parser.getPositionDescription());</span><br><span class="line">            XmlUtils.skipCurrentTag(parser);</span><br><span class="line">            <span class="keyword">continue</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (!foundApp) &#123;</span><br><span class="line">        outError[<span class="number">0</span>] = <span class="string">"&lt;manifest&gt; does not contain an &lt;application&gt;"</span>;</span><br><span class="line">        mParseError = PackageManager.INSTALL_PARSE_FAILED_MANIFEST_EMPTY;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">//【3】返回最终的 Package 对象！</span></span><br><span class="line">    <span class="keyword">return</span> pkg;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>进入 parseSplitApplication 方法！</p>
<h5 id="3-1-1-3-2-PParser-parseSplitApplication"><a href="#3-1-1-3-2-PParser-parseSplitApplication" class="headerlink" title="3.1.1.3.2 PParser.parseSplitApplication"></a>3.1.1.3.2 PParser.parseSplitApplication</h5><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">boolean</span> <span class="title">parseSplitApplication</span><span class="params">(Package owner, Resources res, XmlResourceParser parser,</span></span></span><br><span class="line"><span class="function"><span class="params">        <span class="keyword">int</span> flags, <span class="keyword">int</span> splitIndex, String[] outError)</span></span></span><br><span class="line"><span class="function">        <span class="keyword">throws</span> XmlPullParserException, IOException </span>&#123;</span><br><span class="line">        </span><br><span class="line">    <span class="comment">// 获得 "application" 标签的属性，保存到 TypedArray 对象 sa 中！</span></span><br><span class="line">    TypedArray sa = res.obtainAttributes(parser,</span><br><span class="line">            com.android.internal.R.styleable.AndroidManifestApplication);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (sa.getBoolean(</span><br><span class="line">            com.android.internal.R.styleable.AndroidManifestApplication_hasCode, <span class="keyword">true</span>)) &#123;</span><br><span class="line">        owner.splitFlags[splitIndex] |= ApplicationInfo.FLAG_HAS_CODE;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">final</span> <span class="keyword">int</span> innerDepth = parser.getDepth();</span><br><span class="line">    <span class="keyword">int</span> type;</span><br><span class="line">    <span class="keyword">while</span> ((type = parser.next()) != XmlPullParser.END_DOCUMENT</span><br><span class="line">            &amp;&amp; (type != XmlPullParser.END_TAG || parser.getDepth() &gt; innerDepth)) &#123;</span><br><span class="line">        <span class="keyword">if</span> (type == XmlPullParser.END_TAG || type == XmlPullParser.TEXT) &#123;</span><br><span class="line">            <span class="keyword">continue</span>;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        String tagName = parser.getName();</span><br><span class="line">        <span class="keyword">if</span> (tagName.equals(<span class="string">"activity"</span>)) &#123; <span class="comment">// 解析非核心 apk 的 "activity"</span></span><br><span class="line">        </span><br><span class="line">            <span class="comment">//【1】调用 parseActivity</span></span><br><span class="line">            Activity a = parseActivity(owner, res, parser, flags, outError, <span class="keyword">false</span>,</span><br><span class="line">                    owner.baseHardwareAccelerated);</span><br><span class="line">            <span class="keyword">if</span> (a == <span class="keyword">null</span>) &#123;</span><br><span class="line">                mParseError = PackageManager.INSTALL_PARSE_FAILED_MANIFEST_MALFORMED;</span><br><span class="line">                <span class="keyword">return</span> <span class="keyword">false</span>;</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            owner.activities.add(a);</span><br><span class="line"></span><br><span class="line">        &#125; <span class="keyword">else</span> <span class="keyword">if</span> (tagName.equals(<span class="string">"receiver"</span>)) &#123; <span class="comment">// 解析非核心 apk 的 "receiver"</span></span><br><span class="line">        </span><br><span class="line">            <span class="comment">//【2】调用 parseReceiver</span></span><br><span class="line">            Activity a = parseActivity(owner, res, parser, flags, outError, <span class="keyword">true</span>, <span class="keyword">false</span>);</span><br><span class="line">            <span class="keyword">if</span> (a == <span class="keyword">null</span>) &#123;</span><br><span class="line">                mParseError = PackageManager.INSTALL_PARSE_FAILED_MANIFEST_MALFORMED;</span><br><span class="line">                <span class="keyword">return</span> <span class="keyword">false</span>;</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            owner.receivers.add(a);</span><br><span class="line"></span><br><span class="line">        &#125; <span class="keyword">else</span> <span class="keyword">if</span> (tagName.equals(<span class="string">"service"</span>)) &#123;  <span class="comment">// 解析非核心 apk 的 "service"</span></span><br><span class="line">        </span><br><span class="line">            <span class="comment">//【3】调用 parseService</span></span><br><span class="line">            Service s = parseService(owner, res, parser, flags, outError);</span><br><span class="line">            <span class="keyword">if</span> (s == <span class="keyword">null</span>) &#123;</span><br><span class="line">                mParseError = PackageManager.INSTALL_PARSE_FAILED_MANIFEST_MALFORMED;</span><br><span class="line">                <span class="keyword">return</span> <span class="keyword">false</span>;</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            owner.services.add(s);</span><br><span class="line"></span><br><span class="line">        &#125; <span class="keyword">else</span> <span class="keyword">if</span> (tagName.equals(<span class="string">"provider"</span>)) &#123;  <span class="comment">// 解析非核心 apk 的 "provider"</span></span><br><span class="line">            <span class="comment">//【4】调用 parseProvider</span></span><br><span class="line">            Provider p = parseProvider(owner, res, parser, flags, outError);</span><br><span class="line">            <span class="keyword">if</span> (p == <span class="keyword">null</span>) &#123;</span><br><span class="line">                mParseError = PackageManager.INSTALL_PARSE_FAILED_MANIFEST_MALFORMED;</span><br><span class="line">                <span class="keyword">return</span> <span class="keyword">false</span>;</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            owner.providers.add(p);</span><br><span class="line"></span><br><span class="line">        &#125; <span class="keyword">else</span> <span class="keyword">if</span> (tagName.equals(<span class="string">"activity-alias"</span>)) &#123;  <span class="comment">// 解析非核心 apk 的 "activity-alias"</span></span><br><span class="line">            <span class="comment">//【5】调用 parseActivityAlias</span></span><br><span class="line">            Activity a = parseActivityAlias(owner, res, parser, flags, outError);</span><br><span class="line">            <span class="keyword">if</span> (a == <span class="keyword">null</span>) &#123;</span><br><span class="line">                mParseError = PackageManager.INSTALL_PARSE_FAILED_MANIFEST_MALFORMED;</span><br><span class="line">                <span class="keyword">return</span> <span class="keyword">false</span>;</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            owner.activities.add(a);</span><br><span class="line"></span><br><span class="line">        &#125; <span class="keyword">else</span> <span class="keyword">if</span> (parser.getName().equals(<span class="string">"meta-data"</span>)) &#123;  <span class="comment">// 解析非核心 apk 的 "meta-data"</span></span><br><span class="line">            <span class="comment">//【6】调用 parseMetaData</span></span><br><span class="line">            <span class="keyword">if</span> ((owner.mAppMetaData = parseMetaData(res, parser, owner.mAppMetaData,</span><br><span class="line">                    outError)) == <span class="keyword">null</span>) &#123;</span><br><span class="line">                mParseError = PackageManager.INSTALL_PARSE_FAILED_MANIFEST_MALFORMED;</span><br><span class="line">                <span class="keyword">return</span> <span class="keyword">false</span>;</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">        &#125; <span class="keyword">else</span> <span class="keyword">if</span> (tagName.equals(<span class="string">"uses-library"</span>)) &#123;  <span class="comment">// 解析非核心 apk 的 "uses-library"</span></span><br><span class="line">            sa = res.obtainAttributes(parser,</span><br><span class="line">                    com.android.internal.R.styleable.AndroidManifestUsesLibrary);</span><br><span class="line"></span><br><span class="line">            <span class="comment">// lib 库名称！</span></span><br><span class="line">            String lname = sa.getNonResourceString(</span><br><span class="line">                    com.android.internal.R.styleable.AndroidManifestUsesLibrary_name);</span><br><span class="line">            <span class="comment">// lib 库是否强制被使用！</span></span><br><span class="line">            <span class="keyword">boolean</span> req = sa.getBoolean(</span><br><span class="line">                    com.android.internal.R.styleable.AndroidManifestUsesLibrary_required,</span><br><span class="line">                    <span class="keyword">true</span>);</span><br><span class="line"></span><br><span class="line">            sa.recycle();</span><br><span class="line">            </span><br><span class="line">            <span class="comment">// 将 lib 库信息添加到 usesLibraries 或者 usesOptionalLibraries 中！</span></span><br><span class="line">            <span class="keyword">if</span> (lname != <span class="keyword">null</span>) &#123;</span><br><span class="line">                lname = lname.intern();</span><br><span class="line">                <span class="keyword">if</span> (req) &#123;</span><br><span class="line">                    <span class="comment">// Upgrade to treat as stronger constraint</span></span><br><span class="line">                    owner.usesLibraries = ArrayUtils.add(owner.usesLibraries, lname);</span><br><span class="line">                    owner.usesOptionalLibraries = ArrayUtils.remove(</span><br><span class="line">                            owner.usesOptionalLibraries, lname);</span><br><span class="line">                &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                    <span class="comment">// Ignore if someone already defined as required</span></span><br><span class="line">                    <span class="keyword">if</span> (!ArrayUtils.contains(owner.usesLibraries, lname)) &#123;</span><br><span class="line">                        owner.usesOptionalLibraries = ArrayUtils.add(</span><br><span class="line">                                owner.usesOptionalLibraries, lname);</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            XmlUtils.skipCurrentTag(parser);</span><br><span class="line"></span><br><span class="line">        &#125; <span class="keyword">else</span> <span class="keyword">if</span> (tagName.equals(<span class="string">"uses-package"</span>)) &#123; <span class="comment">// 解析非核心 apk 的 "uses-package"，不处理！</span></span><br><span class="line">            <span class="comment">// Dependencies for app installers; we don't currently try to</span></span><br><span class="line">            <span class="comment">// enforce this.</span></span><br><span class="line">            XmlUtils.skipCurrentTag(parser);</span><br><span class="line"></span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            <span class="keyword">if</span> (!RIGID_PARSER) &#123;</span><br><span class="line">                Slog.w(TAG, <span class="string">"Unknown element under &lt;application&gt;: "</span> + tagName</span><br><span class="line">                        + <span class="string">" at "</span> + mArchiveSourcePath + <span class="string">" "</span></span><br><span class="line">                        + parser.getPositionDescription());</span><br><span class="line">                XmlUtils.skipCurrentTag(parser);</span><br><span class="line">                <span class="keyword">continue</span>;</span><br><span class="line">            &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                outError[<span class="number">0</span>] = <span class="string">"Bad element under &lt;application&gt;: "</span> + tagName;</span><br><span class="line">                mParseError = PackageManager.INSTALL_PARSE_FAILED_MANIFEST_MALFORMED;</span><br><span class="line">                <span class="keyword">return</span> <span class="keyword">false</span>;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">true</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>到这里，应用程序包就已经被解析完了，最终，所有 apk 的数据都会封装到一个 Package 对象中返回！</p>
<h3 id="3-1-2-PParser-parseMonolithicPackage"><a href="#3-1-2-PParser-parseMonolithicPackage" class="headerlink" title="3.1.2 PParser.parseMonolithicPackage"></a>3.1.2 PParser.parseMonolithicPackage</h3><p>对于不支持 apk 拆分的 package，PMS 使用 parseMonolithicPackage 进行解析，典型的不支持拆分的 apk，是 /system/framework/framework-res.apk，下面我们来看看这个方法：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Deprecated</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> Package <span class="title">parseMonolithicPackage</span><span class="params">(File apkFile, <span class="keyword">int</span> flags)</span> <span class="keyword">throws</span> PackageParserException </span>&#123;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">//【3.1.2.1】同样的，先对 apk 进行一次整体解析！</span></span><br><span class="line">    <span class="keyword">final</span> PackageLite lite = parseMonolithicPackageLite(apkFile, flags);</span><br><span class="line">    <span class="keyword">if</span> (mOnlyCoreApps) &#123;</span><br><span class="line">        <span class="keyword">if</span> (!lite.coreApp) &#123;</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> PackageParserException(INSTALL_PARSE_FAILED_MANIFEST_MALFORMED,</span><br><span class="line">                    <span class="string">"Not a coreApp: "</span> + apkFile);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">final</span> AssetManager assets = <span class="keyword">new</span> AssetManager();</span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">        </span><br><span class="line">        <span class="comment">//【3.1.1.2】再次调用 parseBaseApk 进行二次解析！</span></span><br><span class="line">        <span class="keyword">final</span> Package pkg = parseBaseApk(apkFile, assets, flags);</span><br><span class="line">        pkg.setCodePath(apkFile.getAbsolutePath());</span><br><span class="line">        pkg.setUse32bitAbi(lite.use32bitAbi);</span><br><span class="line">        <span class="keyword">return</span> pkg;</span><br><span class="line">    &#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">        IoUtils.closeQuietly(assets);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h4 id="3-1-2-1-PParser-parseMonolithicPackageLite"><a href="#3-1-2-1-PParser-parseMonolithicPackageLite" class="headerlink" title="3.1.2.1 PParser.parseMonolithicPackageLite"></a>3.1.2.1 PParser.parseMonolithicPackageLite</h4><p>继续调用 parseMonolithicPackageLite 方法：<br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">static</span> PackageLite <span class="title">parseMonolithicPackageLite</span><span class="params">(File packageFile, <span class="keyword">int</span> flags)</span></span></span><br><span class="line"><span class="function">        <span class="keyword">throws</span> PackageParserException </span>&#123;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// 同样的，调用 parseApkLite 直接对 apk 进行解析，返回 ApkLite 对象！</span></span><br><span class="line">    <span class="keyword">final</span> ApkLite baseApk = parseApkLite(packageFile, flags);</span><br><span class="line">    <span class="keyword">final</span> String packagePath = packageFile.getAbsolutePath();</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// 创建 PackageLite 对象！</span></span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">new</span> PackageLite(packagePath, baseApk, <span class="keyword">null</span>, <span class="keyword">null</span>, <span class="keyword">null</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>最后，同样的，还是返回一个 PackageParser.Package 对象！</p>
<p>这里就不多说了！</p>
<h3 id="3-1-3-Package"><a href="#3-1-3-Package" class="headerlink" title="3.1.3 Package"></a>3.1.3 Package</h3><p>我们来看看 Pacakge 结构体，他用来分装一个应用程序包的完整信息：<br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">final</span> <span class="keyword">static</span> <span class="class"><span class="keyword">class</span> <span class="title">Package</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> String packageName; <span class="comment">// 应用程序包名</span></span><br><span class="line">    <span class="keyword">public</span> String[] splitNames; <span class="comment">// 非核心 apk 的名称</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> String volumeUuid;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> String codePath; <span class="comment">// 应用程序包的路径</span></span><br><span class="line">    <span class="keyword">public</span> String baseCodePath; <span class="comment">// 核心 apk 的路径</span></span><br><span class="line">    <span class="keyword">public</span> String[] splitCodePaths; <span class="comment">// 非核心 apk 的路径</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">int</span> baseRevisionCode; <span class="comment">// 核心 apk </span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">int</span>[] splitRevisionCodes;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">int</span>[] splitFlags;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">int</span>[] splitPrivateFlags;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">boolean</span> baseHardwareAccelerated;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// For now we only support one application per package.</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">final</span> ApplicationInfo applicationInfo = <span class="keyword">new</span> ApplicationInfo(); <span class="comment">// 核心 apk 的 application 对象！</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">final</span> ArrayList&lt;Permission&gt; permissions = <span class="keyword">new</span> ArrayList&lt;Permission&gt;(<span class="number">0</span>);</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">final</span> ArrayList&lt;PermissionGroup&gt; permissionGroups = <span class="keyword">new</span> ArrayList&lt;PermissionGroup&gt;(<span class="number">0</span>);</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">final</span> ArrayList&lt;Activity&gt; activities = <span class="keyword">new</span> ArrayList&lt;Activity&gt;(<span class="number">0</span>);</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">final</span> ArrayList&lt;Activity&gt; receivers = <span class="keyword">new</span> ArrayList&lt;Activity&gt;(<span class="number">0</span>);</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">final</span> ArrayList&lt;Provider&gt; providers = <span class="keyword">new</span> ArrayList&lt;Provider&gt;(<span class="number">0</span>);</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">final</span> ArrayList&lt;Service&gt; services = <span class="keyword">new</span> ArrayList&lt;Service&gt;(<span class="number">0</span>);</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">final</span> ArrayList&lt;Instrumentation&gt; instrumentation = <span class="keyword">new</span> ArrayList&lt;Instrumentation&gt;(<span class="number">0</span>);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">final</span> ArrayList&lt;String&gt; requestedPermissions = <span class="keyword">new</span> ArrayList&lt;String&gt;();</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> ArrayList&lt;String&gt; protectedBroadcasts;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> Package parentPackage;</span><br><span class="line">    <span class="keyword">public</span> ArrayList&lt;Package&gt; childPackages;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> ArrayList&lt;String&gt; libraryNames = <span class="keyword">null</span>;</span><br><span class="line">    <span class="keyword">public</span> ArrayList&lt;String&gt; usesLibraries = <span class="keyword">null</span>;</span><br><span class="line">    <span class="keyword">public</span> ArrayList&lt;String&gt; usesOptionalLibraries = <span class="keyword">null</span>;</span><br><span class="line">    <span class="keyword">public</span> String[] usesLibraryFiles = <span class="keyword">null</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> ArrayList&lt;ActivityIntentInfo&gt; preferredActivityFilters = <span class="keyword">null</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> ArrayList&lt;String&gt; mOriginalPackages = <span class="keyword">null</span>;</span><br><span class="line">    <span class="keyword">public</span> String mRealPackage = <span class="keyword">null</span>;</span><br><span class="line">    <span class="keyword">public</span> ArrayList&lt;String&gt; mAdoptPermissions = <span class="keyword">null</span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// We store the application meta-data independently to avoid multiple unwanted references</span></span><br><span class="line">    <span class="keyword">public</span> Bundle mAppMetaData = <span class="keyword">null</span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// The version code declared for this package.</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">int</span> mVersionCode;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// The version name declared for this package.</span></span><br><span class="line">    <span class="keyword">public</span> String mVersionName;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// The shared user id that this package wants to use.</span></span><br><span class="line">    <span class="keyword">public</span> String mSharedUserId;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// The shared user label that this package wants to use.</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">int</span> mSharedUserLabel;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// Signatures that were read from the package.</span></span><br><span class="line">    <span class="keyword">public</span> Signature[] mSignatures;</span><br><span class="line">    <span class="keyword">public</span> Certificate[][] mCertificates;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// For use by package manager service for quick lookup of</span></span><br><span class="line">    <span class="comment">// preferred up order.</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">int</span> mPreferredOrder = <span class="number">0</span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// For use by package manager to keep track of when a package was last used.</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">long</span>[] mLastPackageUsageTimeInMills =</span><br><span class="line">            <span class="keyword">new</span> <span class="keyword">long</span>[PackageManager.NOTIFY_PACKAGE_USE_REASONS_COUNT];</span><br><span class="line"></span><br><span class="line">    <span class="comment">// // User set enabled state.</span></span><br><span class="line">    <span class="comment">// public int mSetEnabled = PackageManager.COMPONENT_ENABLED_STATE_DEFAULT;</span></span><br><span class="line">    <span class="comment">//</span></span><br><span class="line">    <span class="comment">// // Whether the package has been stopped.</span></span><br><span class="line">    <span class="comment">// public boolean mSetStopped = false;</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">// Additional data supplied by callers.</span></span><br><span class="line">    <span class="keyword">public</span> Object mExtras;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// Applications hardware preferences</span></span><br><span class="line">    <span class="keyword">public</span> ArrayList&lt;ConfigurationInfo&gt; configPreferences = <span class="keyword">null</span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// Applications requested features</span></span><br><span class="line">    <span class="keyword">public</span> ArrayList&lt;FeatureInfo&gt; reqFeatures = <span class="keyword">null</span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// Applications requested feature groups</span></span><br><span class="line">    <span class="keyword">public</span> ArrayList&lt;FeatureGroupInfo&gt; featureGroups = <span class="keyword">null</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">int</span> installLocation;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">boolean</span> coreApp;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/* An app that's required for all users and cannot be uninstalled for a user */</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">boolean</span> mRequiredForAllUsers;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/* The restricted account authenticator type that is used by this application */</span></span><br><span class="line">    <span class="keyword">public</span> String mRestrictedAccountType;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/* The required account type without which this application will not function */</span></span><br><span class="line">    <span class="keyword">public</span> String mRequiredAccountType;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> String mOverlayTarget;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">int</span> mOverlayPriority;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">boolean</span> mTrustedOverlay;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> ArraySet&lt;PublicKey&gt; mSigningKeys;</span><br><span class="line">    <span class="keyword">public</span> ArraySet&lt;String&gt; mUpgradeKeySets;</span><br><span class="line">    <span class="keyword">public</span> ArrayMap&lt;String, ArraySet&lt;PublicKey&gt;&gt; mKeySetMapping;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> String cpuAbiOverride;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">boolean</span> use32bitAbi;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">byte</span>[] restrictUpdateHash;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="title">Package</span><span class="params">(String packageName)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">this</span>.packageName = packageName;</span><br><span class="line">        applicationInfo.packageName = packageName;</span><br><span class="line">        applicationInfo.uid = -<span class="number">1</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    ... ... ... ...</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>通过 PParser.parsePackage 方法，最终会返回一个 Package 对象，封装了应用程序包的所有信息！！</p>
<h2 id="3-2-PMS-scanPackageLI"><a href="#3-2-PMS-scanPackageLI" class="headerlink" title="3.2 PMS.scanPackageLI"></a>3.2 PMS.scanPackageLI</h2><p>参数 policyFlags 为 paraseFlags！</p>
<p>前一个阶段，通过解析获得了 package 的信息，接着继续扫描：<br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">private</span> PackageParser.<span class="function">Package <span class="title">scanPackageLI</span><span class="params">(PackageParser.Package pkg, File scanFile,</span></span></span><br><span class="line"><span class="function"><span class="params">        <span class="keyword">final</span> <span class="keyword">int</span> policyFlags, <span class="keyword">int</span> scanFlags, <span class="keyword">long</span> currentTime, UserHandle user)</span></span></span><br><span class="line"><span class="function">        <span class="keyword">throws</span> PackageManagerException </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//【1】SCAN_CHECK_ONLY 标签是为了检测是否所有的包（parent 和 child）都可以被成功的扫描到！</span></span><br><span class="line">    <span class="keyword">if</span> ((scanFlags &amp; SCAN_CHECK_ONLY) == <span class="number">0</span>) &#123; </span><br><span class="line">        <span class="keyword">if</span> (pkg.childPackages != <span class="keyword">null</span> &amp;&amp; pkg.childPackages.size() &gt; <span class="number">0</span>) &#123;</span><br><span class="line">            scanFlags |= SCAN_CHECK_ONLY;  <span class="comment">// 设置 SCAN_CHECK_ONLY 位！</span></span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        scanFlags &amp;= ~SCAN_CHECK_ONLY; <span class="comment">// 取消 SCAN_CHECK_ONLY 位！</span></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//【3.2.1】继续扫描当前 package，返回扫描结果 scannedPkg！</span></span><br><span class="line">    PackageParser.Package scannedPkg = scanPackageInternalLI(pkg, scanFile, policyFlags,</span><br><span class="line">            scanFlags, currentTime, user);</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 扫描当前 package 的子 pacakge（如果有）</span></span><br><span class="line">    <span class="keyword">final</span> <span class="keyword">int</span> childCount = (pkg.childPackages != <span class="keyword">null</span>) ? pkg.childPackages.size() : <span class="number">0</span>;</span><br><span class="line">    <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; childCount; i++) &#123;</span><br><span class="line">        PackageParser.Package childPackage = pkg.childPackages.get(i);</span><br><span class="line">        <span class="comment">// 解析子包！</span></span><br><span class="line">        scanPackageInternalLI(childPackage, scanFile, policyFlags, scanFlags,</span><br><span class="line">                currentTime, user);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> ((scanFlags &amp; SCAN_CHECK_ONLY) != <span class="number">0</span>) &#123;</span><br><span class="line">        <span class="comment">// 如果设置了 SCAN_CHECK_ONLY 位， 就调用自身，再次处理！</span></span><br><span class="line">        <span class="keyword">return</span> scanPackageLI(pkg, scanFile, policyFlags, scanFlags, currentTime, user);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> scannedPkg;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>如果被扫描的 package 有 child package，并且是第一次进入该方法的话，就需要检测是否所有的包（parent 和 child）都可以被成功的扫描到，scanFlags 本来是没有 SCAN_CHECK_ONLY 位的，所以这里会将其 SCAN_CHECK_ONLY 置为 1，这样在方法的最后，又会调用自身，这次又会将 SCAN_CHECK_ONLY 位置为 0！</p>
<p>继续看：</p>
<h3 id="3-2-1-PMS-scanPackageInternalLI"><a href="#3-2-1-PMS-scanPackageInternalLI" class="headerlink" title="3.2.1 PMS.scanPackageInternalLI"></a>3.2.1 PMS.scanPackageInternalLI</h3><p>我们继续来看，通过前面的扫描解析，我们获得了应用程序的 PackageParser.Package 对象，同时，我们也已经获得了上一次的安装信息，接下来，就是要处理解析获得的数据：<br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br><span class="line">212</span><br><span class="line">213</span><br><span class="line">214</span><br><span class="line">215</span><br><span class="line">216</span><br><span class="line">217</span><br><span class="line">218</span><br><span class="line">219</span><br><span class="line">220</span><br><span class="line">221</span><br><span class="line">222</span><br><span class="line">223</span><br><span class="line">224</span><br><span class="line">225</span><br><span class="line">226</span><br><span class="line">227</span><br><span class="line">228</span><br><span class="line">229</span><br><span class="line">230</span><br><span class="line">231</span><br><span class="line">232</span><br><span class="line">233</span><br><span class="line">234</span><br><span class="line">235</span><br><span class="line">236</span><br><span class="line">237</span><br><span class="line">238</span><br><span class="line">239</span><br><span class="line">240</span><br><span class="line">241</span><br><span class="line">242</span><br><span class="line">243</span><br><span class="line">244</span><br><span class="line">245</span><br><span class="line">246</span><br><span class="line">247</span><br><span class="line">248</span><br><span class="line">249</span><br><span class="line">250</span><br><span class="line">251</span><br><span class="line">252</span><br><span class="line">253</span><br><span class="line">254</span><br><span class="line">255</span><br><span class="line">256</span><br><span class="line">257</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">private</span> PackageParser.<span class="function">Package <span class="title">scanPackageInternalLI</span><span class="params">(PackageParser.Package pkg, File scanFile,</span></span></span><br><span class="line"><span class="function"><span class="params">        <span class="keyword">int</span> policyFlags, <span class="keyword">int</span> scanFlags, <span class="keyword">long</span> currentTime, UserHandle user)</span></span></span><br><span class="line"><span class="function">        <span class="keyword">throws</span> PackageManagerException </span>&#123;</span><br><span class="line"></span><br><span class="line">    PackageSetting ps = <span class="keyword">null</span>;</span><br><span class="line">    PackageSetting updatedPkg;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">synchronized</span> (mPackages) &#123;</span><br><span class="line">        <span class="comment">// package 是否被重命名过，有的话，获得其 oldName！</span></span><br><span class="line">        String oldName = mSettings.mRenamedPackages.get(pkg.packageName);</span><br><span class="line">        </span><br><span class="line">        <span class="comment">//【3.2.1.1】如果 package 有源包，并且源包的名字是当前扫描的 package 的旧名字，</span></span><br><span class="line">        <span class="comment">// 那就用源包的 PackageSetting 作为当前 package 的数据！</span></span><br><span class="line">        <span class="keyword">if</span> (pkg.mOriginalPackages != <span class="keyword">null</span> &amp;&amp; pkg.mOriginalPackages.contains(oldName)) &#123;</span><br><span class="line">            ps = mSettings.peekPackageLPr(oldName);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 如果没有源包，就用当前 package 的包名查找一个已的 PackageSetting！</span></span><br><span class="line">        <span class="keyword">if</span> (ps == <span class="keyword">null</span>) &#123;</span><br><span class="line">            ps = mSettings.peekPackageLPr(pkg.packageName);</span><br><span class="line">        &#125;</span><br><span class="line">    </span><br><span class="line">        <span class="comment">//【3.2.1.2】如果当前系统 package 被更新过，就查找到被更新之前的 PackageSetting！</span></span><br><span class="line">        updatedPkg = mSettings.getDisabledSystemPkgLPr(ps != <span class="keyword">null</span> ? ps.name : pkg.packageName);</span><br><span class="line">        <span class="keyword">if</span> (DEBUG_INSTALL &amp;&amp; updatedPkg != <span class="keyword">null</span>) Slog.d(TAG, <span class="string">"updatedPkg = "</span> + updatedPkg);</span><br><span class="line">        </span><br><span class="line">        <span class="comment">// 如果系统 package，并且被更新过，需要处理新旧 child package 的差异！</span></span><br><span class="line">        <span class="comment">// 比较更新后的 child package 和更新前的 child package，如果更新前的 child package 不存在了；</span></span><br><span class="line">        <span class="comment">// 就要移除！</span></span><br><span class="line">        <span class="keyword">if</span> ((policyFlags &amp; PackageParser.PARSE_IS_SYSTEM) != <span class="number">0</span>) &#123; </span><br><span class="line">            PackageSetting disabledPs = mSettings.getDisabledSystemPkgLPr(pkg.packageName);</span><br><span class="line">            <span class="keyword">if</span> (disabledPs != <span class="keyword">null</span>) &#123;</span><br><span class="line">                <span class="comment">// 当前 package 的 child package 个数！</span></span><br><span class="line">                <span class="keyword">final</span> <span class="keyword">int</span> scannedChildCount = (pkg.childPackages != <span class="keyword">null</span>)</span><br><span class="line">                        ? pkg.childPackages.size() : <span class="number">0</span>;</span><br><span class="line">                <span class="comment">// 更新之前的 child package 个数！</span></span><br><span class="line">                <span class="keyword">final</span> <span class="keyword">int</span> disabledChildCount = disabledPs.childPackageNames != <span class="keyword">null</span></span><br><span class="line">                        ? disabledPs.childPackageNames.size() : <span class="number">0</span>;</span><br><span class="line"></span><br><span class="line">                <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; disabledChildCount; i++) &#123;</span><br><span class="line">                    String disabledChildPackageName = disabledPs.childPackageNames.get(i);</span><br><span class="line">                    <span class="keyword">boolean</span> disabledPackageAvailable = <span class="keyword">false</span>;</span><br><span class="line">                    </span><br><span class="line">                    <span class="keyword">for</span> (<span class="keyword">int</span> j = <span class="number">0</span>; j &lt; scannedChildCount; j++) &#123;</span><br><span class="line">                        PackageParser.Package childPkg = pkg.childPackages.get(j);</span><br><span class="line">                        <span class="keyword">if</span> (childPkg.packageName.equals(disabledChildPackageName)) &#123;</span><br><span class="line">                        </span><br><span class="line">                            disabledPackageAvailable = <span class="keyword">true</span>;</span><br><span class="line">                            <span class="keyword">break</span>;</span><br><span class="line">                        &#125;</span><br><span class="line">                     &#125;</span><br><span class="line">    </span><br><span class="line">                     <span class="keyword">if</span> (!disabledPackageAvailable) &#123;</span><br><span class="line">                         <span class="comment">//【3.2.1.3】更新前的 child package，不包含在更新后的 child package 中，无效，</span></span><br><span class="line">                         <span class="comment">// 就从 mDisabledSysPackages 中删除掉！</span></span><br><span class="line">                         mSettings.removeDisabledSystemPackageLPw(disabledChildPackageName);</span><br><span class="line">                     &#125;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">boolean</span> updatedPkgBetter = <span class="keyword">false</span>; </span><br><span class="line"></span><br><span class="line">    <span class="comment">//【A】处理覆盖更新的情况！</span></span><br><span class="line">    <span class="comment">// 如果当前解析的系统 apk，并且他之前被覆盖更新过！</span></span><br><span class="line">    <span class="comment">// 注意：ps 是上次安装的信息，updatedPkg 是由于覆盖安装更新前的信息！，pkg 则是本次扫描的 system app 的信息！</span></span><br><span class="line">    <span class="keyword">if</span> (updatedPkg != <span class="keyword">null</span> &amp;&amp; (policyFlags &amp; PackageParser.PARSE_IS_SYSTEM) != <span class="number">0</span>) &#123;</span><br><span class="line">        <span class="keyword">if</span> (locationIsPrivileged(scanFile)) &#123; </span><br><span class="line">            <span class="comment">// 对于 /system/priv-app 目录下的 app，需要增加 ApplicationInfo.PRIVATE_FLAG_PRIVILEGED 的 flag！</span></span><br><span class="line">            updatedPkg.pkgPrivateFlags |= ApplicationInfo.PRIVATE_FLAG_PRIVILEGED;</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            updatedPkg.pkgPrivateFlags &amp;= ~ApplicationInfo.PRIVATE_FLAG_PRIVILEGED;</span><br><span class="line">        &#125;</span><br><span class="line">        </span><br><span class="line">        <span class="comment">// 上次更新后的应用路径和这次扫描解析的路径不一样，上次更新到了 data 分区，而这次扫描的是 system 分区，</span></span><br><span class="line">        <span class="comment">// 就需要比较一下 versionCode 的大小，</span></span><br><span class="line">        <span class="keyword">if</span> (ps != <span class="keyword">null</span> &amp;&amp; !ps.codePath.equals(scanFile)) &#123;</span><br><span class="line">            <span class="keyword">if</span> (DEBUG_INSTALL) Slog.d(TAG, <span class="string">"Path changing from "</span> + ps.codePath);</span><br><span class="line">            <span class="comment">// pkg 的 versioncode 小于等于上次更新后的 versioncode，说明 data 分区的 apk 仍然是最新的</span></span><br><span class="line">            <span class="comment">// 那就用本次扫描解析的数据，来更新上次更新前的旧数据！</span></span><br><span class="line">            <span class="keyword">if</span> (pkg.mVersionCode &lt;= ps.versionCode) &#123;</span><br><span class="line"></span><br><span class="line">                <span class="keyword">if</span> (DEBUG_INSTALL) Slog.i(TAG, <span class="string">"Package "</span> + ps.name + <span class="string">" at "</span> + scanFile</span><br><span class="line">                        + <span class="string">" ignored: updated version "</span> + ps.versionCode</span><br><span class="line">                        + <span class="string">" better than this "</span> + pkg.mVersionCode);</span><br><span class="line"></span><br><span class="line">                <span class="comment">// updatedPkg.codePath 不等于当前的扫描目录，说明该 system app 目录发生了变化！</span></span><br><span class="line">                <span class="comment">// 而该 system apk 是被覆盖更新了，所以也需要更新 updatedPkg 的数据～</span></span><br><span class="line">                <span class="keyword">if</span> (!updatedPkg.codePath.equals(scanFile)) &#123;</span><br><span class="line">                    Slog.w(PackageManagerService.TAG, <span class="string">"Code path for hidden system pkg "</span></span><br><span class="line">                            + ps.name + <span class="string">" changing from "</span> + updatedPkg.codePathString</span><br><span class="line">                            + <span class="string">" to "</span> + scanFile);</span><br><span class="line"></span><br><span class="line">                    updatedPkg.codePath = scanFile;</span><br><span class="line">                    updatedPkg.codePathString = scanFile.toString();</span><br><span class="line">                    updatedPkg.resourcePath = scanFile;</span><br><span class="line">                    updatedPkg.resourcePathString = scanFile.toString();</span><br><span class="line">                &#125;</span><br><span class="line">                </span><br><span class="line">                updatedPkg.pkg = pkg;</span><br><span class="line">                updatedPkg.versionCode = pkg.mVersionCode;</span><br><span class="line"></span><br><span class="line">                <span class="keyword">final</span> <span class="keyword">int</span> childCount = updatedPkg.childPackageNames != <span class="keyword">null</span></span><br><span class="line">                        ? updatedPkg.childPackageNames.size() : <span class="number">0</span>;</span><br><span class="line"></span><br><span class="line">                <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; childCount; i++) &#123;</span><br><span class="line">                    String childPackageName = updatedPkg.childPackageNames.get(i);</span><br><span class="line">                    PackageSetting updatedChildPkg = mSettings.getDisabledSystemPkgLPr(</span><br><span class="line">                            childPackageName);</span><br><span class="line"></span><br><span class="line">                    <span class="keyword">if</span> (updatedChildPkg != <span class="keyword">null</span>) &#123;</span><br><span class="line">                        updatedChildPkg.pkg = pkg;</span><br><span class="line">                        updatedChildPkg.versionCode = pkg.mVersionCode;</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;</span><br><span class="line"></span><br><span class="line">                <span class="keyword">throw</span> <span class="keyword">new</span> PackageManagerException(Log.WARN, <span class="string">"Package "</span> + ps.name + <span class="string">" at "</span></span><br><span class="line">                        + scanFile + <span class="string">" ignored: updated version "</span> + ps.versionCode</span><br><span class="line">                        + <span class="string">" better than this "</span> + pkg.mVersionCode);</span><br><span class="line">            &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                <span class="comment">// pkg 的 versioncode 大于上次更新后的 versioncode，</span></span><br><span class="line">                <span class="comment">// 说明当前在 system 分区的 apk 要比 data 分区的新，这说明 system app 又通过 OTA 升级更新了</span></span><br><span class="line">                <span class="comment">// 那就要保留本次扫描解析的数据，删除上一次更新的数据！</span></span><br><span class="line">                <span class="keyword">synchronized</span> (mPackages) &#123;</span><br><span class="line">                    <span class="comment">// 从 PMS.mPackages 中删除上一次的扫描数据！</span></span><br><span class="line">                    mPackages.remove(ps.name);</span><br><span class="line">                &#125;</span><br><span class="line"></span><br><span class="line">                logCriticalInfo(Log.WARN, <span class="string">"Package "</span> + ps.name + <span class="string">" at "</span> + scanFile</span><br><span class="line">                        + <span class="string">" reverting from "</span> + ps.codePathString</span><br><span class="line">                        + <span class="string">": new version "</span> + pkg.mVersionCode</span><br><span class="line">                        + <span class="string">" better than installed "</span> + ps.versionCode);</span><br><span class="line">                </span><br><span class="line">                <span class="comment">// 创建一个安装参数对象，封装了上次安装的信息！！</span></span><br><span class="line">                InstallArgs args = createInstallArgsForExisting(packageFlagsToInstallFlags(ps),</span><br><span class="line">                        ps.codePathString, ps.resourcePathString, getAppDexInstructionSets(ps));</span><br><span class="line"></span><br><span class="line">                <span class="keyword">synchronized</span> (mInstallLock) &#123;</span><br><span class="line">                    <span class="comment">// 移除 data 分区的 apk 和 相应的 dex 文件！</span></span><br><span class="line">                    args.cleanUpResourcesLI();</span><br><span class="line">                &#125;</span><br><span class="line">                </span><br><span class="line">                <span class="keyword">synchronized</span> (mPackages) &#123;</span><br><span class="line">                    <span class="comment">//【3.2.1.4】将更新前的旧数据 PackageSetting ，从 mDisabledSysPackages 中移除，</span></span><br><span class="line">                    <span class="comment">// 并复用旧数据，创建一个新的PackageSetting，添加到 Setting 的 mPackage 中！</span></span><br><span class="line">                    mSettings.enableSystemPackageLPw(ps.name);</span><br><span class="line">                &#125;</span><br><span class="line">                </span><br><span class="line">                updatedPkgBetter = <span class="keyword">true</span>; <span class="comment">// 设置 updatedPkgBetter 为 true！</span></span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (updatedPkg != <span class="keyword">null</span>) &#123; <span class="comment">// 对于被更新的系统 app 的 flag 进行设置！</span></span><br><span class="line">        policyFlags |= PackageParser.PARSE_IS_SYSTEM;</span><br><span class="line">        <span class="keyword">if</span> ((updatedPkg.pkgPrivateFlags &amp; ApplicationInfo.PRIVATE_FLAG_PRIVILEGED) != <span class="number">0</span>) &#123;</span><br><span class="line">            policyFlags |= PackageParser.PARSE_IS_PRIVILEGED;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    collectCertificatesLI(ps, pkg, scanFile, policyFlags);</span><br><span class="line"></span><br><span class="line">    <span class="comment">//【B】处理没有覆盖，但是 data 和 system 分区出现了相同的 apk 的情况！</span></span><br><span class="line">    <span class="comment">// package 并没有发生覆盖更新，但之前 apk 是安装在 data 分区，而后来出现了相同包名的新 apk 安装在了 system 分区</span></span><br><span class="line">    <span class="comment">//（比如系统 OTA 升级导致的 apk 分区改变，或者 root 后 push 一个相同 apk 到 system 分区然后重启）！</span></span><br><span class="line">    <span class="comment">// 或者还有一种是之前安装在 data 分区，然后应用移动到了 system 分区！</span></span><br><span class="line">    <span class="comment">// 那就要判断是否隐藏 system 分区的这个 apk 了！</span></span><br><span class="line">    <span class="keyword">boolean</span> shouldHideSystemApp = <span class="keyword">false</span>; </span><br><span class="line">    <span class="keyword">if</span> (updatedPkg == <span class="keyword">null</span> &amp;&amp; ps != <span class="keyword">null</span></span><br><span class="line">            &amp;&amp; (policyFlags &amp; PackageParser.PARSE_IS_SYSTEM_DIR) != <span class="number">0</span> &amp;&amp; !isSystemApp(ps)) &#123;</span><br><span class="line">        <span class="comment">// 校验签名，如果不匹配的话，就冻结掉安装在 system 分区的 apk，并清除数据！</span></span><br><span class="line">        <span class="keyword">if</span> (compareSignatures(ps.signatures.mSignatures, pkg.mSignatures)</span><br><span class="line">                != PackageManager.SIGNATURE_MATCH) &#123;</span><br><span class="line">                </span><br><span class="line">            logCriticalInfo(Log.WARN, <span class="string">"Package "</span> + ps.name + <span class="string">" appeared on system, but"</span></span><br><span class="line">                    + <span class="string">" signatures don't match existing userdata copy; removing"</span>);</span><br><span class="line">            </span><br><span class="line">            <span class="comment">// 创建一个 PackageFreezer 用来冻结指定的 package！</span></span><br><span class="line">            <span class="keyword">try</span> (PackageFreezer freezer = freezePackage(pkg.packageName,</span><br><span class="line">                    <span class="string">"scanPackageInternalLI"</span>)) &#123;</span><br><span class="line">                deletePackageLIF(pkg.packageName, <span class="keyword">null</span>, <span class="keyword">true</span>, <span class="keyword">null</span>, <span class="number">0</span>, <span class="keyword">null</span>, <span class="keyword">false</span>, <span class="keyword">null</span>);</span><br><span class="line">            &#125;</span><br><span class="line">            ps = <span class="keyword">null</span>;</span><br><span class="line"></span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            <span class="comment">// 如果新添加的位于 system 分区的 apk 的版本号小于等于位于 data 分区的 apk；</span></span><br><span class="line">            <span class="comment">// 那就要隐藏 system 分区的 apk；</span></span><br><span class="line">            <span class="keyword">if</span> (pkg.mVersionCode &lt;= ps.versionCode) &#123;</span><br><span class="line">                shouldHideSystemApp = <span class="keyword">true</span>; <span class="comment">// 设置 shouldHideSystemApp 为 true！</span></span><br><span class="line">                logCriticalInfo(Log.INFO, <span class="string">"Package "</span> + ps.name + <span class="string">" appeared at "</span> + scanFile</span><br><span class="line">                        + <span class="string">" but new version "</span> + pkg.mVersionCode + <span class="string">" better than installed "</span></span><br><span class="line">                        + ps.versionCode + <span class="string">"; hiding system"</span>);</span><br><span class="line">            &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                <span class="comment">// system 分区的应用版本更高，删除 data 分区的 apk，同时保留数据！</span></span><br><span class="line">                logCriticalInfo(Log.WARN, <span class="string">"Package "</span> + ps.name + <span class="string">" at "</span> + scanFile</span><br><span class="line">                        + <span class="string">" reverting from "</span> + ps.codePathString + <span class="string">": new version "</span></span><br><span class="line">                        + pkg.mVersionCode + <span class="string">" better than installed "</span> + ps.versionCode);</span><br><span class="line">                        </span><br><span class="line">                <span class="comment">// 创建一个安装参数！        </span></span><br><span class="line">                InstallArgs args = createInstallArgsForExisting(packageFlagsToInstallFlags(ps),</span><br><span class="line">                        ps.codePathString, ps.resourcePathString, getAppDexInstructionSets(ps));</span><br><span class="line">                        </span><br><span class="line">                <span class="keyword">synchronized</span> (mInstallLock) &#123;</span><br><span class="line">                    <span class="comment">// 删除 data 分区的 apk，并保留用户数据！</span></span><br><span class="line">                    args.cleanUpResourcesLI();</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 系统 apk 不进入！</span></span><br><span class="line">    <span class="keyword">if</span> ((policyFlags &amp; PackageParser.PARSE_IS_SYSTEM_DIR) == <span class="number">0</span>) &#123;</span><br><span class="line">        <span class="keyword">if</span> (ps != <span class="keyword">null</span> &amp;&amp; !ps.codePath.equals(ps.resourcePath)) &#123;</span><br><span class="line">            policyFlags |= PackageParser.PARSE_FORWARD_LOCK;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    String resourcePath = <span class="keyword">null</span>;</span><br><span class="line">    String baseResourcePath = <span class="keyword">null</span>;</span><br><span class="line">    <span class="keyword">if</span> ((policyFlags &amp; PackageParser.PARSE_FORWARD_LOCK) != <span class="number">0</span> &amp;&amp; !updatedPkgBetter) &#123;</span><br><span class="line">        <span class="keyword">if</span> (ps != <span class="keyword">null</span> &amp;&amp; ps.resourcePathString != <span class="keyword">null</span>) &#123;</span><br><span class="line">            resourcePath = ps.resourcePathString;</span><br><span class="line">            baseResourcePath = ps.resourcePathString;</span><br><span class="line"></span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            Slog.e(TAG, <span class="string">"Resource path not set for package "</span> + pkg.packageName);</span><br><span class="line"></span><br><span class="line">        &#125;</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        resourcePath = pkg.codePath;</span><br><span class="line">        baseResourcePath = pkg.baseCodePath;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 设置 Package.ApplicationInfo 对象的 path 属性！</span></span><br><span class="line">    pkg.setApplicationVolumeUuid(pkg.volumeUuid);</span><br><span class="line">    pkg.setApplicationInfoCodePath(pkg.codePath);</span><br><span class="line">    pkg.setApplicationInfoBaseCodePath(pkg.baseCodePath);</span><br><span class="line">    pkg.setApplicationInfoSplitCodePaths(pkg.splitCodePaths);</span><br><span class="line">    pkg.setApplicationInfoResourcePath(resourcePath);</span><br><span class="line">    pkg.setApplicationInfoBaseResourcePath(baseResourcePath);</span><br><span class="line">    pkg.setApplicationInfoSplitResourcePaths(pkg.splitCodePaths);</span><br><span class="line"></span><br><span class="line">    <span class="comment">//【3.2.1.7】接着调用 scanPackageLI，继续处理扫描数据！</span></span><br><span class="line">    PackageParser.Package scannedPkg = scanPackageLI(pkg, policyFlags, scanFlags</span><br><span class="line">            | SCAN_UPDATE_SIGNATURE, currentTime, user);</span><br><span class="line"></span><br><span class="line">    <span class="comment">//【3.2.1.8】如果确认 data 分区的 apk 版本比 system 分区的版本高</span></span><br><span class="line">    <span class="comment">// 就隐藏 system 分区的 app，让 data 分区的 apk 显示出来！</span></span><br><span class="line">    <span class="keyword">if</span> (shouldHideSystemApp) &#123;</span><br><span class="line">        <span class="keyword">synchronized</span> (mPackages) &#123;</span><br><span class="line">            mSettings.disableSystemPackageLPw(pkg.packageName, <span class="keyword">true</span>);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> scannedPkg;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>到这里，我们先来总结一下，对于一个系统 app 而言， app 升级有如下两种途径：</p>
<ul>
<li>覆盖安装：这种方式 PMS 会动态修改 packages.xml 文件！</li>
<li>OTA 升级方式：这种方式并不会动态修改 package.xml 文件！</li>
</ul>
<p>下面我们来分开分析一下：</p>
<ul>
<li>覆盖安装<ul>
<li>对于系统 app，覆盖安装的话，新的 app 会安装到 data 分区，packages.xml 中相应数据会发生如下变化：<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"> <span class="tag">&lt;<span class="name">package</span> <span class="attr">name</span>=<span class="string">"com.android.pic"</span> <span class="attr">codePath</span>=<span class="string">"/data/app/com.android.pic-1"</span> <span class="attr">nativeLibraryPath</span>=<span class="string">"/data/app/com.android.pic-1/lib"</span></span></span><br><span class="line"><span class="tag">          <span class="attr">primaryCpuAbi</span>=<span class="string">"arm64-v8a"</span> <span class="attr">publicFlags</span>=<span class="string">"944258757"</span> <span class="attr">privateFlags</span>=<span class="string">"0"</span> <span class="attr">ft</span>=<span class="string">"15c38695c40"</span> <span class="attr">it</span>=<span class="string">"15baf6278f0"</span> </span></span><br><span class="line"><span class="tag">          <span class="attr">ut</span>=<span class="string">"15c38695e98"</span> <span class="attr">version</span>=<span class="string">"3002"</span> <span class="attr">sharedUserId</span>=<span class="string">"1000"</span> <span class="attr">installer</span>=<span class="string">"com.android.packageinstaller"</span> <span class="attr">isOrphaned</span>=<span class="string">"true"</span>&gt;</span></span><br><span class="line"> <span class="tag">&lt;/<span class="name">package</span>&gt;</span></span><br><span class="line">        </span><br><span class="line"><span class="tag">&lt;<span class="name">updated-package</span> <span class="attr">name</span>=<span class="string">"com.android.pic"</span> <span class="attr">codePath</span>=<span class="string">"/system/app/pic"</span> </span></span><br><span class="line"><span class="tag">          <span class="attr">ft</span>=<span class="string">"15baf6278f0"</span> <span class="attr">it</span>=<span class="string">"15baf6278f0"</span> <span class="attr">ut</span>=<span class="string">"15baf6278f0"</span> <span class="attr">version</span>=<span class="string">"3002"</span> </span></span><br><span class="line"><span class="tag">          <span class="attr">nativeLibraryPath</span>=<span class="string">"/system/app/pic/lib"</span> <span class="attr">primaryCpuAbi</span>=<span class="string">"arm64-v8a"</span> <span class="attr">sharedUserId</span>=<span class="string">"1000"</span> /&gt;</span></span><br></pre></td></tr></table></figure>
</li>
</ul>
</li>
</ul>
<p>可以看到，package 的 codePath、nativeLibraryPath 都发生了变化，根据上面的解析过程，data 分区的覆盖安装的 apk 将被保存到 mPackages 中，system 分区原来的旧 apk 将被保存到 mDisablePackage 中！</p>
<ul>
<li>OTA 升级方式<ul>
<li>这种方式是通过进入 Recovery 升级（或者是 A/B 升级方式），通过 patch 和文件覆盖方式来升级，这种方式不会即时更改 Packages.xml 文件，真正的修改是在重启后的 PMS 中去做的！</li>
</ul>
</li>
</ul>
<h4 id="3-2-1-1-Settings-peekPackageLPr"><a href="#3-2-1-1-Settings-peekPackageLPr" class="headerlink" title="3.2.1.1 Settings.peekPackageLPr"></a>3.2.1.1 Settings.peekPackageLPr</h4><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="function">PackageSetting <span class="title">peekPackageLPr</span><span class="params">(String name)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">return</span> mPackages.get(name);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>该方法用于获得 packageName 对应的 PackageSetting 对象！</p>
<h4 id="3-2-1-2-Settings-getDisabledSystemPkgLPr"><a href="#3-2-1-2-Settings-getDisabledSystemPkgLPr" class="headerlink" title="3.2.1.2 Settings.getDisabledSystemPkgLPr"></a>3.2.1.2 Settings.getDisabledSystemPkgLPr</h4><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> PackageSetting <span class="title">getDisabledSystemPkgLPr</span><span class="params">(String name)</span> </span>&#123;</span><br><span class="line">    PackageSetting ps = mDisabledSysPackages.get(name);</span><br><span class="line">    <span class="keyword">return</span> ps;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>我们知道 mDisabledSysPackages 中的数据来自 updated-package 标签！</p>
<h4 id="3-2-1-3-Settings-removeDisabledSystemPackageLPw"><a href="#3-2-1-3-Settings-removeDisabledSystemPackageLPw" class="headerlink" title="3.2.1.3 Settings.removeDisabledSystemPackageLPw"></a>3.2.1.3 Settings.removeDisabledSystemPackageLPw</h4><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">removeDisabledSystemPackageLPw</span><span class="params">(String name)</span> </span>&#123;</span><br><span class="line">    mDisabledSysPackages.remove(name);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h4 id="3-2-1-4-Settings-enableSystemPackageLPw"><a href="#3-2-1-4-Settings-enableSystemPackageLPw" class="headerlink" title="3.2.1.4 Settings.enableSystemPackageLPw"></a>3.2.1.4 Settings.enableSystemPackageLPw</h4><p>这里用于恢复一个 system pacakge！</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="function">PackageSetting <span class="title">enableSystemPackageLPw</span><span class="params">(String name)</span> </span>&#123;</span><br><span class="line">    <span class="comment">// 从 mDisabledSysPackages 中获得被更新前的 PackageSettings！</span></span><br><span class="line">    PackageSetting p = mDisabledSysPackages.get(name);</span><br><span class="line">    <span class="keyword">if</span>(p == <span class="keyword">null</span>) &#123;</span><br><span class="line">        Log.w(PackageManagerService.TAG, <span class="string">"Package "</span> + name + <span class="string">" is not disabled"</span>);</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">null</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// 去掉 ApplicationInfo.FLAG_UPDATED_SYSTEM_APP 标志位！</span></span><br><span class="line">    <span class="keyword">if</span>((p.pkg != <span class="keyword">null</span>) &amp;&amp; (p.pkg.applicationInfo != <span class="keyword">null</span>)) &#123;</span><br><span class="line">        p.pkg.applicationInfo.flags &amp;= ~ApplicationInfo.FLAG_UPDATED_SYSTEM_APP;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// 复用数据，创建一个新的 PackageSetting，并根据 uid 添加到指定集合中！ </span></span><br><span class="line">    PackageSetting ret = addPackageLPw(name, p.realName, p.codePath, p.resourcePath,</span><br><span class="line">            p.legacyNativeLibraryPathString, p.primaryCpuAbiString,</span><br><span class="line">            p.secondaryCpuAbiString, p.cpuAbiOverrideString,</span><br><span class="line">            p.appId, p.versionCode, p.pkgFlags, p.pkgPrivateFlags,</span><br><span class="line">            p.parentPackageName, p.childPackageNames);</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 从 mDisabledSysPackages 移除这个 package</span></span><br><span class="line">    mDisabledSysPackages.remove(name);</span><br><span class="line">    <span class="keyword">return</span> ret;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>方法的流程很简单，不多说了！</p>
<h4 id="3-2-1-6-PMS-deletePackageLIF"><a href="#3-2-1-6-PMS-deletePackageLIF" class="headerlink" title="3.2.1.6 PMS.deletePackageLIF"></a>3.2.1.6 PMS.deletePackageLIF</h4><p>对于之前 apk 是安装在 data 分区，而后来出现了相同包名的新 apk 安装在了 system 分区这种情况，需要校验签名，如果不匹配的话，就要删掉 data 分区的 apk！</p>
<p>首先创建了一个 PackageFreezer 对象，用来冻结这个应用！<br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="title">PackageFreezer</span><span class="params">(String packageName, <span class="keyword">int</span> userId, String killReason)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">synchronized</span> (mPackages) &#123;</span><br><span class="line">        <span class="comment">// 添加到 mFrozenPackages 集合中！</span></span><br><span class="line">        mPackageName = packageName;</span><br><span class="line">        mWeFroze = mFrozenPackages.add(mPackageName);</span><br><span class="line"></span><br><span class="line">        <span class="keyword">final</span> PackageSetting ps = mSettings.mPackages.get(mPackageName);</span><br><span class="line">        <span class="keyword">if</span> (ps != <span class="keyword">null</span>) &#123;</span><br><span class="line">            <span class="comment">// 杀掉应用的进程</span></span><br><span class="line">            killApplication(ps.name, ps.appId, userId, killReason);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 对子包进行相同的操作！</span></span><br><span class="line">        <span class="keyword">final</span> PackageParser.Package p = mPackages.get(packageName);</span><br><span class="line">        <span class="keyword">if</span> (p != <span class="keyword">null</span> &amp;&amp; p.childPackages != <span class="keyword">null</span>) &#123;</span><br><span class="line"></span><br><span class="line">            <span class="keyword">final</span> <span class="keyword">int</span> N = p.childPackages.size();</span><br><span class="line">            mChildren = <span class="keyword">new</span> PackageFreezer[N];</span><br><span class="line">            <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; N; i++) &#123;</span><br><span class="line">                mChildren[i] = <span class="keyword">new</span> PackageFreezer(p.childPackages.get(i).packageName,</span><br><span class="line">                        userId, killReason);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            mChildren = <span class="keyword">null</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    mCloseGuard.open(<span class="string">"close"</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>接着，调用 deletePackageLIF 方法来处理这个 package，传入参数：</p>
<ul>
<li>String packageName：传入 pkg.packageName；</li>
<li>UserHandle user：传入 null；</li>
<li>boolean deleteCodeAndResources：传入 true；</li>
<li>int[] allUserHandles：传入 null；</li>
<li>int flags：传入 0；</li>
<li>PackageRemovedInfo outInfo：传入 null；</li>
<li>boolean writeSettings：传入 false；</li>
<li>PackageParser.Package replacingPackage：传入 null;</li>
</ul>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">boolean</span> <span class="title">deletePackageLIF</span><span class="params">(String packageName, UserHandle user,</span></span></span><br><span class="line"><span class="function"><span class="params">        <span class="keyword">boolean</span> deleteCodeAndResources, <span class="keyword">int</span>[] allUserHandles, <span class="keyword">int</span> flags,</span></span></span><br><span class="line"><span class="function"><span class="params">        PackageRemovedInfo outInfo, <span class="keyword">boolean</span> writeSettings,</span></span></span><br><span class="line"><span class="function"><span class="params">        PackageParser.Package replacingPackage)</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (packageName == <span class="keyword">null</span>) &#123;</span><br><span class="line">        Slog.w(TAG, <span class="string">"Attempt to delete null packageName."</span>);</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">false</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (DEBUG_REMOVE) Slog.d(TAG, <span class="string">"deletePackageLI: "</span> + packageName + <span class="string">" user "</span> + user);</span><br><span class="line"></span><br><span class="line">    PackageSetting ps;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">synchronized</span> (mPackages) &#123;</span><br><span class="line">        </span><br><span class="line">        <span class="comment">// 获得之前安装的信息，如果为 null，谁明这个</span></span><br><span class="line">        ps = mSettings.mPackages.get(packageName);</span><br><span class="line">        <span class="keyword">if</span> (ps == <span class="keyword">null</span>) &#123;</span><br><span class="line">            Slog.w(TAG, <span class="string">"Package named '"</span> + packageName + <span class="string">"' doesn't exist."</span>);</span><br><span class="line">            <span class="keyword">return</span> <span class="keyword">false</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        </span><br><span class="line">        <span class="comment">// 如果当前的 package 是 child package，且不是系统 apk 的话，进入这个分支！</span></span><br><span class="line">        <span class="keyword">if</span> (ps.parentPackageName != <span class="keyword">null</span> &amp;&amp; (!isSystemApp(ps)</span><br><span class="line">                || (flags &amp; PackageManager.DELETE_SYSTEM_APP) != <span class="number">0</span>)) &#123;</span><br><span class="line"></span><br><span class="line">            <span class="keyword">if</span> (DEBUG_REMOVE) &#123;</span><br><span class="line">                Slog.d(TAG, <span class="string">"Uninstalled child package:"</span> + packageName + <span class="string">" for user:"</span></span><br><span class="line">                        + ((user == <span class="keyword">null</span>) ? UserHandle.USER_ALL : user));</span><br><span class="line">            &#125;</span><br><span class="line">            </span><br><span class="line">            <span class="comment">// 根据参数传递，removedUserId 的值为 UserHandle.USER_ALL；</span></span><br><span class="line">            <span class="keyword">final</span> <span class="keyword">int</span> removedUserId = (user != <span class="keyword">null</span>) ? user.getIdentifier()</span><br><span class="line">                    : UserHandle.USER_ALL;</span><br><span class="line"></span><br><span class="line">            <span class="keyword">if</span> (!clearPackageStateForUserLIF(ps, removedUserId, outInfo)) &#123;</span><br><span class="line">                <span class="keyword">return</span> <span class="keyword">false</span>;</span><br><span class="line">            &#125;</span><br><span class="line">            </span><br><span class="line">            markPackageUninstalledForUserLPw(ps, user);</span><br><span class="line">            scheduleWritePackageRestrictionsLocked(user);</span><br><span class="line">            </span><br><span class="line">            <span class="keyword">return</span> <span class="keyword">true</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 当 user 不为 null 才会进入这里，表示为指定的设备用户删除该 apk！</span></span><br><span class="line">    <span class="keyword">if</span> (((!isSystemApp(ps) || (flags&amp;PackageManager.DELETE_SYSTEM_APP) != <span class="number">0</span>) &amp;&amp; user != <span class="keyword">null</span></span><br><span class="line">            &amp;&amp; user.getIdentifier() != UserHandle.USER_ALL)) &#123;</span><br><span class="line">        ... ... ... ...</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 这里也不进入！</span></span><br><span class="line">    <span class="keyword">if</span> (ps.childPackageNames != <span class="keyword">null</span> &amp;&amp; outInfo != <span class="keyword">null</span>) &#123;</span><br><span class="line">        ... ... ... ...</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">boolean</span> ret = <span class="keyword">false</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (isSystemApp(ps)) &#123;</span><br><span class="line">        <span class="keyword">if</span> (DEBUG_REMOVE) Slog.d(TAG, <span class="string">"Removing system package: "</span> + ps.name);</span><br><span class="line">        <span class="comment">// When an updated system application is deleted we delete the existing resources</span></span><br><span class="line">        <span class="comment">// as well and fall back to existing code in system partition</span></span><br><span class="line">        ret = deleteSystemPackageLIF(ps.pkg, ps, allUserHandles, flags, outInfo, writeSettings);</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        <span class="keyword">if</span> (DEBUG_REMOVE) Slog.d(TAG, <span class="string">"Removing non-system package: "</span> + ps.name);</span><br><span class="line">        </span><br><span class="line">        <span class="comment">// 进入这个分支，因为 data 分区的 apk 已经存在，所以进入这个分支，删除掉非系统 apk！</span></span><br><span class="line">        ret = deleteInstalledPackageLIF(ps, deleteCodeAndResources, flags, allUserHandles,</span><br><span class="line">                outInfo, writeSettings, replacingPackage);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 根据参数，不会进入这个分支</span></span><br><span class="line">    <span class="keyword">if</span> (outInfo != <span class="keyword">null</span>) &#123;</span><br><span class="line">        ... ... ... </span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> ret;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>关于 apk 删除的逻辑，我们在另开一篇讲解，这个的逻辑是会删掉之前已经安装的 data 分区的 apk 的！</p>
<p>继续看：</p>
<h4 id="3-2-1-7-PMS-scanPackageLI"><a href="#3-2-1-7-PMS-scanPackageLI" class="headerlink" title="3.2.1.7 PMS.scanPackageLI"></a>3.2.1.7 PMS.scanPackageLI</h4><p>接下来，进一步的扫描：<br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">private</span> PackageParser.<span class="function">Package <span class="title">scanPackageLI</span><span class="params">(PackageParser.Package pkg, <span class="keyword">final</span> <span class="keyword">int</span> policyFlags,</span></span></span><br><span class="line"><span class="function"><span class="params">        <span class="keyword">int</span> scanFlags, <span class="keyword">long</span> currentTime, UserHandle user)</span> <span class="keyword">throws</span> PackageManagerException </span>&#123;</span><br><span class="line">    <span class="keyword">boolean</span> success = <span class="keyword">false</span>;</span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">    </span><br><span class="line">        <span class="comment">//【3.2.1.7.1】继续调用 scanPackageDirtyLI 处理扫描数据！</span></span><br><span class="line">        <span class="keyword">final</span> PackageParser.Package res = scanPackageDirtyLI(pkg, policyFlags, scanFlags,</span><br><span class="line">                currentTime, user);</span><br><span class="line">                </span><br><span class="line">        success = <span class="keyword">true</span>;</span><br><span class="line">        <span class="keyword">return</span> res;</span><br><span class="line">    &#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">        <span class="keyword">if</span> (!success &amp;&amp; (scanFlags &amp; SCAN_DELETE_DATA_ON_FAILURES) != <span class="number">0</span>) &#123;</span><br><span class="line">            <span class="comment">// DELETE_DATA_ON_FAILURES is only used by frozen paths</span></span><br><span class="line">            <span class="comment">// 失败了就清楚掉数据！</span></span><br><span class="line">            destroyAppDataLIF(pkg, UserHandle.USER_ALL,</span><br><span class="line">                    StorageManager.FLAG_STORAGE_DE | StorageManager.FLAG_STORAGE_CE);</span><br><span class="line">            destroyAppProfilesLIF(pkg, UserHandle.USER_ALL);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>下面，我们继续看 scanPackageDirtyLI 方法中的逻辑！</p>
<h5 id="3-2-1-7-1-PMS-scanPackageDirtyLI"><a href="#3-2-1-7-1-PMS-scanPackageDirtyLI" class="headerlink" title="3.2.1.7.1 *PMS.scanPackageDirtyLI"></a>3.2.1.7.1 *PMS.scanPackageDirtyLI</h5><p>最终调用 scanPackageDirtyLI 方法处理扫描得到的数据：</p>
<p>因为我们本次扫描的是 system app，所以 PackageParser.Package pkg 分装了扫描的结果信息！<br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br><span class="line">212</span><br><span class="line">213</span><br><span class="line">214</span><br><span class="line">215</span><br><span class="line">216</span><br><span class="line">217</span><br><span class="line">218</span><br><span class="line">219</span><br><span class="line">220</span><br><span class="line">221</span><br><span class="line">222</span><br><span class="line">223</span><br><span class="line">224</span><br><span class="line">225</span><br><span class="line">226</span><br><span class="line">227</span><br><span class="line">228</span><br><span class="line">229</span><br><span class="line">230</span><br><span class="line">231</span><br><span class="line">232</span><br><span class="line">233</span><br><span class="line">234</span><br><span class="line">235</span><br><span class="line">236</span><br><span class="line">237</span><br><span class="line">238</span><br><span class="line">239</span><br><span class="line">240</span><br><span class="line">241</span><br><span class="line">242</span><br><span class="line">243</span><br><span class="line">244</span><br><span class="line">245</span><br><span class="line">246</span><br><span class="line">247</span><br><span class="line">248</span><br><span class="line">249</span><br><span class="line">250</span><br><span class="line">251</span><br><span class="line">252</span><br><span class="line">253</span><br><span class="line">254</span><br><span class="line">255</span><br><span class="line">256</span><br><span class="line">257</span><br><span class="line">258</span><br><span class="line">259</span><br><span class="line">260</span><br><span class="line">261</span><br><span class="line">262</span><br><span class="line">263</span><br><span class="line">264</span><br><span class="line">265</span><br><span class="line">266</span><br><span class="line">267</span><br><span class="line">268</span><br><span class="line">269</span><br><span class="line">270</span><br><span class="line">271</span><br><span class="line">272</span><br><span class="line">273</span><br><span class="line">274</span><br><span class="line">275</span><br><span class="line">276</span><br><span class="line">277</span><br><span class="line">278</span><br><span class="line">279</span><br><span class="line">280</span><br><span class="line">281</span><br><span class="line">282</span><br><span class="line">283</span><br><span class="line">284</span><br><span class="line">285</span><br><span class="line">286</span><br><span class="line">287</span><br><span class="line">288</span><br><span class="line">289</span><br><span class="line">290</span><br><span class="line">291</span><br><span class="line">292</span><br><span class="line">293</span><br><span class="line">294</span><br><span class="line">295</span><br><span class="line">296</span><br><span class="line">297</span><br><span class="line">298</span><br><span class="line">299</span><br><span class="line">300</span><br><span class="line">301</span><br><span class="line">302</span><br><span class="line">303</span><br><span class="line">304</span><br><span class="line">305</span><br><span class="line">306</span><br><span class="line">307</span><br><span class="line">308</span><br><span class="line">309</span><br><span class="line">310</span><br><span class="line">311</span><br><span class="line">312</span><br><span class="line">313</span><br><span class="line">314</span><br><span class="line">315</span><br><span class="line">316</span><br><span class="line">317</span><br><span class="line">318</span><br><span class="line">319</span><br><span class="line">320</span><br><span class="line">321</span><br><span class="line">322</span><br><span class="line">323</span><br><span class="line">324</span><br><span class="line">325</span><br><span class="line">326</span><br><span class="line">327</span><br><span class="line">328</span><br><span class="line">329</span><br><span class="line">330</span><br><span class="line">331</span><br><span class="line">332</span><br><span class="line">333</span><br><span class="line">334</span><br><span class="line">335</span><br><span class="line">336</span><br><span class="line">337</span><br><span class="line">338</span><br><span class="line">339</span><br><span class="line">340</span><br><span class="line">341</span><br><span class="line">342</span><br><span class="line">343</span><br><span class="line">344</span><br><span class="line">345</span><br><span class="line">346</span><br><span class="line">347</span><br><span class="line">348</span><br><span class="line">349</span><br><span class="line">350</span><br><span class="line">351</span><br><span class="line">352</span><br><span class="line">353</span><br><span class="line">354</span><br><span class="line">355</span><br><span class="line">356</span><br><span class="line">357</span><br><span class="line">358</span><br><span class="line">359</span><br><span class="line">360</span><br><span class="line">361</span><br><span class="line">362</span><br><span class="line">363</span><br><span class="line">364</span><br><span class="line">365</span><br><span class="line">366</span><br><span class="line">367</span><br><span class="line">368</span><br><span class="line">369</span><br><span class="line">370</span><br><span class="line">371</span><br><span class="line">372</span><br><span class="line">373</span><br><span class="line">374</span><br><span class="line">375</span><br><span class="line">376</span><br><span class="line">377</span><br><span class="line">378</span><br><span class="line">379</span><br><span class="line">380</span><br><span class="line">381</span><br><span class="line">382</span><br><span class="line">383</span><br><span class="line">384</span><br><span class="line">385</span><br><span class="line">386</span><br><span class="line">387</span><br><span class="line">388</span><br><span class="line">389</span><br><span class="line">390</span><br><span class="line">391</span><br><span class="line">392</span><br><span class="line">393</span><br><span class="line">394</span><br><span class="line">395</span><br><span class="line">396</span><br><span class="line">397</span><br><span class="line">398</span><br><span class="line">399</span><br><span class="line">400</span><br><span class="line">401</span><br><span class="line">402</span><br><span class="line">403</span><br><span class="line">404</span><br><span class="line">405</span><br><span class="line">406</span><br><span class="line">407</span><br><span class="line">408</span><br><span class="line">409</span><br><span class="line">410</span><br><span class="line">411</span><br><span class="line">412</span><br><span class="line">413</span><br><span class="line">414</span><br><span class="line">415</span><br><span class="line">416</span><br><span class="line">417</span><br><span class="line">418</span><br><span class="line">419</span><br><span class="line">420</span><br><span class="line">421</span><br><span class="line">422</span><br><span class="line">423</span><br><span class="line">424</span><br><span class="line">425</span><br><span class="line">426</span><br><span class="line">427</span><br><span class="line">428</span><br><span class="line">429</span><br><span class="line">430</span><br><span class="line">431</span><br><span class="line">432</span><br><span class="line">433</span><br><span class="line">434</span><br><span class="line">435</span><br><span class="line">436</span><br><span class="line">437</span><br><span class="line">438</span><br><span class="line">439</span><br><span class="line">440</span><br><span class="line">441</span><br><span class="line">442</span><br><span class="line">443</span><br><span class="line">444</span><br><span class="line">445</span><br><span class="line">446</span><br><span class="line">447</span><br><span class="line">448</span><br><span class="line">449</span><br><span class="line">450</span><br><span class="line">451</span><br><span class="line">452</span><br><span class="line">453</span><br><span class="line">454</span><br><span class="line">455</span><br><span class="line">456</span><br><span class="line">457</span><br><span class="line">458</span><br><span class="line">459</span><br><span class="line">460</span><br><span class="line">461</span><br><span class="line">462</span><br><span class="line">463</span><br><span class="line">464</span><br><span class="line">465</span><br><span class="line">466</span><br><span class="line">467</span><br><span class="line">468</span><br><span class="line">469</span><br><span class="line">470</span><br><span class="line">471</span><br><span class="line">472</span><br><span class="line">473</span><br><span class="line">474</span><br><span class="line">475</span><br><span class="line">476</span><br><span class="line">477</span><br><span class="line">478</span><br><span class="line">479</span><br><span class="line">480</span><br><span class="line">481</span><br><span class="line">482</span><br><span class="line">483</span><br><span class="line">484</span><br><span class="line">485</span><br><span class="line">486</span><br><span class="line">487</span><br><span class="line">488</span><br><span class="line">489</span><br><span class="line">490</span><br><span class="line">491</span><br><span class="line">492</span><br><span class="line">493</span><br><span class="line">494</span><br><span class="line">495</span><br><span class="line">496</span><br><span class="line">497</span><br><span class="line">498</span><br><span class="line">499</span><br><span class="line">500</span><br><span class="line">501</span><br><span class="line">502</span><br><span class="line">503</span><br><span class="line">504</span><br><span class="line">505</span><br><span class="line">506</span><br><span class="line">507</span><br><span class="line">508</span><br><span class="line">509</span><br><span class="line">510</span><br><span class="line">511</span><br><span class="line">512</span><br><span class="line">513</span><br><span class="line">514</span><br><span class="line">515</span><br><span class="line">516</span><br><span class="line">517</span><br><span class="line">518</span><br><span class="line">519</span><br><span class="line">520</span><br><span class="line">521</span><br><span class="line">522</span><br><span class="line">523</span><br><span class="line">524</span><br><span class="line">525</span><br><span class="line">526</span><br><span class="line">527</span><br><span class="line">528</span><br><span class="line">529</span><br><span class="line">530</span><br><span class="line">531</span><br><span class="line">532</span><br><span class="line">533</span><br><span class="line">534</span><br><span class="line">535</span><br><span class="line">536</span><br><span class="line">537</span><br><span class="line">538</span><br><span class="line">539</span><br><span class="line">540</span><br><span class="line">541</span><br><span class="line">542</span><br><span class="line">543</span><br><span class="line">544</span><br><span class="line">545</span><br><span class="line">546</span><br><span class="line">547</span><br><span class="line">548</span><br><span class="line">549</span><br><span class="line">550</span><br><span class="line">551</span><br><span class="line">552</span><br><span class="line">553</span><br><span class="line">554</span><br><span class="line">555</span><br><span class="line">556</span><br><span class="line">557</span><br><span class="line">558</span><br><span class="line">559</span><br><span class="line">560</span><br><span class="line">561</span><br><span class="line">562</span><br><span class="line">563</span><br><span class="line">564</span><br><span class="line">565</span><br><span class="line">566</span><br><span class="line">567</span><br><span class="line">568</span><br><span class="line">569</span><br><span class="line">570</span><br><span class="line">571</span><br><span class="line">572</span><br><span class="line">573</span><br><span class="line">574</span><br><span class="line">575</span><br><span class="line">576</span><br><span class="line">577</span><br><span class="line">578</span><br><span class="line">579</span><br><span class="line">580</span><br><span class="line">581</span><br><span class="line">582</span><br><span class="line">583</span><br><span class="line">584</span><br><span class="line">585</span><br><span class="line">586</span><br><span class="line">587</span><br><span class="line">588</span><br><span class="line">589</span><br><span class="line">590</span><br><span class="line">591</span><br><span class="line">592</span><br><span class="line">593</span><br><span class="line">594</span><br><span class="line">595</span><br><span class="line">596</span><br><span class="line">597</span><br><span class="line">598</span><br><span class="line">599</span><br><span class="line">600</span><br><span class="line">601</span><br><span class="line">602</span><br><span class="line">603</span><br><span class="line">604</span><br><span class="line">605</span><br><span class="line">606</span><br><span class="line">607</span><br><span class="line">608</span><br><span class="line">609</span><br><span class="line">610</span><br><span class="line">611</span><br><span class="line">612</span><br><span class="line">613</span><br><span class="line">614</span><br><span class="line">615</span><br><span class="line">616</span><br><span class="line">617</span><br><span class="line">618</span><br><span class="line">619</span><br><span class="line">620</span><br><span class="line">621</span><br><span class="line">622</span><br><span class="line">623</span><br><span class="line">624</span><br><span class="line">625</span><br><span class="line">626</span><br><span class="line">627</span><br><span class="line">628</span><br><span class="line">629</span><br><span class="line">630</span><br><span class="line">631</span><br><span class="line">632</span><br><span class="line">633</span><br><span class="line">634</span><br><span class="line">635</span><br><span class="line">636</span><br><span class="line">637</span><br><span class="line">638</span><br><span class="line">639</span><br><span class="line">640</span><br><span class="line">641</span><br><span class="line">642</span><br><span class="line">643</span><br><span class="line">644</span><br><span class="line">645</span><br><span class="line">646</span><br><span class="line">647</span><br><span class="line">648</span><br><span class="line">649</span><br><span class="line">650</span><br><span class="line">651</span><br><span class="line">652</span><br><span class="line">653</span><br><span class="line">654</span><br><span class="line">655</span><br><span class="line">656</span><br><span class="line">657</span><br><span class="line">658</span><br><span class="line">659</span><br><span class="line">660</span><br><span class="line">661</span><br><span class="line">662</span><br><span class="line">663</span><br><span class="line">664</span><br><span class="line">665</span><br><span class="line">666</span><br><span class="line">667</span><br><span class="line">668</span><br><span class="line">669</span><br><span class="line">670</span><br><span class="line">671</span><br><span class="line">672</span><br><span class="line">673</span><br><span class="line">674</span><br><span class="line">675</span><br><span class="line">676</span><br><span class="line">677</span><br><span class="line">678</span><br><span class="line">679</span><br><span class="line">680</span><br><span class="line">681</span><br><span class="line">682</span><br><span class="line">683</span><br><span class="line">684</span><br><span class="line">685</span><br><span class="line">686</span><br><span class="line">687</span><br><span class="line">688</span><br><span class="line">689</span><br><span class="line">690</span><br><span class="line">691</span><br><span class="line">692</span><br><span class="line">693</span><br><span class="line">694</span><br><span class="line">695</span><br><span class="line">696</span><br><span class="line">697</span><br><span class="line">698</span><br><span class="line">699</span><br><span class="line">700</span><br><span class="line">701</span><br><span class="line">702</span><br><span class="line">703</span><br><span class="line">704</span><br><span class="line">705</span><br><span class="line">706</span><br><span class="line">707</span><br><span class="line">708</span><br><span class="line">709</span><br><span class="line">710</span><br><span class="line">711</span><br><span class="line">712</span><br><span class="line">713</span><br><span class="line">714</span><br><span class="line">715</span><br><span class="line">716</span><br><span class="line">717</span><br><span class="line">718</span><br><span class="line">719</span><br><span class="line">720</span><br><span class="line">721</span><br><span class="line">722</span><br><span class="line">723</span><br><span class="line">724</span><br><span class="line">725</span><br><span class="line">726</span><br><span class="line">727</span><br><span class="line">728</span><br><span class="line">729</span><br><span class="line">730</span><br><span class="line">731</span><br><span class="line">732</span><br><span class="line">733</span><br><span class="line">734</span><br><span class="line">735</span><br><span class="line">736</span><br><span class="line">737</span><br><span class="line">738</span><br><span class="line">739</span><br><span class="line">740</span><br><span class="line">741</span><br><span class="line">742</span><br><span class="line">743</span><br><span class="line">744</span><br><span class="line">745</span><br><span class="line">746</span><br><span class="line">747</span><br><span class="line">748</span><br><span class="line">749</span><br><span class="line">750</span><br><span class="line">751</span><br><span class="line">752</span><br><span class="line">753</span><br><span class="line">754</span><br><span class="line">755</span><br><span class="line">756</span><br><span class="line">757</span><br><span class="line">758</span><br><span class="line">759</span><br><span class="line">760</span><br><span class="line">761</span><br><span class="line">762</span><br><span class="line">763</span><br><span class="line">764</span><br><span class="line">765</span><br><span class="line">766</span><br><span class="line">767</span><br><span class="line">768</span><br><span class="line">769</span><br><span class="line">770</span><br><span class="line">771</span><br><span class="line">772</span><br><span class="line">773</span><br><span class="line">774</span><br><span class="line">775</span><br><span class="line">776</span><br><span class="line">777</span><br><span class="line">778</span><br><span class="line">779</span><br><span class="line">780</span><br><span class="line">781</span><br><span class="line">782</span><br><span class="line">783</span><br><span class="line">784</span><br><span class="line">785</span><br><span class="line">786</span><br><span class="line">787</span><br><span class="line">788</span><br><span class="line">789</span><br><span class="line">790</span><br><span class="line">791</span><br><span class="line">792</span><br><span class="line">793</span><br><span class="line">794</span><br><span class="line">795</span><br><span class="line">796</span><br><span class="line">797</span><br><span class="line">798</span><br><span class="line">799</span><br><span class="line">800</span><br><span class="line">801</span><br><span class="line">802</span><br><span class="line">803</span><br><span class="line">804</span><br><span class="line">805</span><br><span class="line">806</span><br><span class="line">807</span><br><span class="line">808</span><br><span class="line">809</span><br><span class="line">810</span><br><span class="line">811</span><br><span class="line">812</span><br><span class="line">813</span><br><span class="line">814</span><br><span class="line">815</span><br><span class="line">816</span><br><span class="line">817</span><br><span class="line">818</span><br><span class="line">819</span><br><span class="line">820</span><br><span class="line">821</span><br><span class="line">822</span><br><span class="line">823</span><br><span class="line">824</span><br><span class="line">825</span><br><span class="line">826</span><br><span class="line">827</span><br><span class="line">828</span><br><span class="line">829</span><br><span class="line">830</span><br><span class="line">831</span><br><span class="line">832</span><br><span class="line">833</span><br><span class="line">834</span><br><span class="line">835</span><br><span class="line">836</span><br><span class="line">837</span><br><span class="line">838</span><br><span class="line">839</span><br><span class="line">840</span><br><span class="line">841</span><br><span class="line">842</span><br><span class="line">843</span><br><span class="line">844</span><br><span class="line">845</span><br><span class="line">846</span><br><span class="line">847</span><br><span class="line">848</span><br><span class="line">849</span><br><span class="line">850</span><br><span class="line">851</span><br><span class="line">852</span><br><span class="line">853</span><br><span class="line">854</span><br><span class="line">855</span><br><span class="line">856</span><br><span class="line">857</span><br><span class="line">858</span><br><span class="line">859</span><br><span class="line">860</span><br><span class="line">861</span><br><span class="line">862</span><br><span class="line">863</span><br><span class="line">864</span><br><span class="line">865</span><br><span class="line">866</span><br><span class="line">867</span><br><span class="line">868</span><br><span class="line">869</span><br><span class="line">870</span><br><span class="line">871</span><br><span class="line">872</span><br><span class="line">873</span><br><span class="line">874</span><br><span class="line">875</span><br><span class="line">876</span><br><span class="line">877</span><br><span class="line">878</span><br><span class="line">879</span><br><span class="line">880</span><br><span class="line">881</span><br><span class="line">882</span><br><span class="line">883</span><br><span class="line">884</span><br><span class="line">885</span><br><span class="line">886</span><br><span class="line">887</span><br><span class="line">888</span><br><span class="line">889</span><br><span class="line">890</span><br><span class="line">891</span><br><span class="line">892</span><br><span class="line">893</span><br><span class="line">894</span><br><span class="line">895</span><br><span class="line">896</span><br><span class="line">897</span><br><span class="line">898</span><br><span class="line">899</span><br><span class="line">900</span><br><span class="line">901</span><br><span class="line">902</span><br><span class="line">903</span><br><span class="line">904</span><br><span class="line">905</span><br><span class="line">906</span><br><span class="line">907</span><br><span class="line">908</span><br><span class="line">909</span><br><span class="line">910</span><br><span class="line">911</span><br><span class="line">912</span><br><span class="line">913</span><br><span class="line">914</span><br><span class="line">915</span><br><span class="line">916</span><br><span class="line">917</span><br><span class="line">918</span><br><span class="line">919</span><br><span class="line">920</span><br><span class="line">921</span><br><span class="line">922</span><br><span class="line">923</span><br><span class="line">924</span><br><span class="line">925</span><br><span class="line">926</span><br><span class="line">927</span><br><span class="line">928</span><br><span class="line">929</span><br><span class="line">930</span><br><span class="line">931</span><br><span class="line">932</span><br><span class="line">933</span><br><span class="line">934</span><br><span class="line">935</span><br><span class="line">936</span><br><span class="line">937</span><br><span class="line">938</span><br><span class="line">939</span><br><span class="line">940</span><br><span class="line">941</span><br><span class="line">942</span><br><span class="line">943</span><br><span class="line">944</span><br><span class="line">945</span><br><span class="line">946</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">private</span> PackageParser.<span class="function">Package <span class="title">scanPackageDirtyLI</span><span class="params">(PackageParser.Package pkg,</span></span></span><br><span class="line"><span class="function"><span class="params">        <span class="keyword">final</span> <span class="keyword">int</span> policyFlags, <span class="keyword">final</span> <span class="keyword">int</span> scanFlags, <span class="keyword">long</span> currentTime, UserHandle user)</span></span></span><br><span class="line"><span class="function">        <span class="keyword">throws</span> PackageManagerException </span>&#123;</span><br><span class="line">    <span class="keyword">final</span> File scanFile = <span class="keyword">new</span> File(pkg.codePath);</span><br><span class="line">    <span class="keyword">if</span> (pkg.applicationInfo.getCodePath() == <span class="keyword">null</span> ||</span><br><span class="line">            pkg.applicationInfo.getResourcePath() == <span class="keyword">null</span>) &#123;</span><br><span class="line">        <span class="keyword">throw</span> <span class="keyword">new</span> PackageManagerException(INSTALL_FAILED_INVALID_APK,</span><br><span class="line">                <span class="string">"Code and resource paths haven't been set correctly"</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//【1】处理系统 apk 标志位；</span></span><br><span class="line">    <span class="keyword">if</span> ((policyFlags &amp; PackageParser.PARSE_IS_SYSTEM) != <span class="number">0</span>) &#123; </span><br><span class="line">        <span class="comment">// 对于系统 app，增加 ApplicationInfo.FLAG_SYSTEM 的 flags，表示是系统 apk！</span></span><br><span class="line">        <span class="comment">//【1.1】注意系统和非系统的区别是，apk 所在的目录！</span></span><br><span class="line">        pkg.applicationInfo.flags |= ApplicationInfo.FLAG_SYSTEM;</span><br><span class="line">        <span class="comment">// 处理 Direct Boot Mode 属性，设备启动后进入的一个新模式，直到用户解锁（unlock）设备此阶段结束！</span></span><br><span class="line">        <span class="keyword">if</span> (pkg.applicationInfo.isDirectBootAware()) &#123;</span><br><span class="line">            <span class="keyword">for</span> (PackageParser.Service s : pkg.services) &#123;</span><br><span class="line">                s.info.encryptionAware = s.info.directBootAware = <span class="keyword">true</span>;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">for</span> (PackageParser.Provider p : pkg.providers) &#123;</span><br><span class="line">                p.info.encryptionAware = p.info.directBootAware = <span class="keyword">true</span>;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">for</span> (PackageParser.Activity a : pkg.activities) &#123;</span><br><span class="line">                a.info.encryptionAware = a.info.directBootAware = <span class="keyword">true</span>;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">for</span> (PackageParser.Activity r : pkg.receivers) &#123;</span><br><span class="line">                r.info.encryptionAware = r.info.directBootAware = <span class="keyword">true</span>;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        pkg.coreApp = <span class="keyword">false</span>;</span><br><span class="line">        pkg.applicationInfo.privateFlags &amp;=</span><br><span class="line">                ~ApplicationInfo.PRIVATE_FLAG_DEFAULT_TO_DEVICE_PROTECTED_STORAGE;</span><br><span class="line">        pkg.applicationInfo.privateFlags &amp;=</span><br><span class="line">                ~ApplicationInfo.PRIVATE_FLAG_DIRECT_BOOT_AWARE;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    pkg.mTrustedOverlay = (policyFlags&amp;PackageParser.PARSE_TRUSTED_OVERLAY) != <span class="number">0</span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//【2】设置 ApplicationInfo.PRIVATE_FLAG_PRIVILEGED 标记位，说明这个 apk 是特权 apk！</span></span><br><span class="line">    <span class="keyword">if</span> ((policyFlags&amp;PackageParser.PARSE_IS_PRIVILEGED) != <span class="number">0</span>) &#123;</span><br><span class="line">        pkg.applicationInfo.privateFlags |= ApplicationInfo.PRIVATE_FLAG_PRIVILEGED;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> ((policyFlags &amp; PackageParser.PARSE_ENFORCE_CODE) != <span class="number">0</span>) &#123;</span><br><span class="line">        enforceCodePolicy(pkg);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (mCustomResolverComponentName != <span class="keyword">null</span> &amp;&amp;</span><br><span class="line">            mCustomResolverComponentName.getPackageName().equals(pkg.packageName)) &#123;</span><br><span class="line">        setUpCustomResolverActivity(pkg);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//【3】处理包名为 "android" 的 apk，也就是 framework-res.apk，属于系统平台包！</span></span><br><span class="line">    <span class="keyword">if</span> (pkg.packageName.equals(<span class="string">"android"</span>)) &#123;</span><br><span class="line">        <span class="keyword">synchronized</span> (mPackages) &#123;</span><br><span class="line">            <span class="keyword">if</span> (mAndroidApplication != <span class="keyword">null</span>) &#123;</span><br><span class="line">                Slog.w(TAG, <span class="string">"*************************************************"</span>);</span><br><span class="line">                Slog.w(TAG, <span class="string">"Core android package being redefined.  Skipping."</span>);</span><br><span class="line">                Slog.w(TAG, <span class="string">" file="</span> + scanFile);</span><br><span class="line">                Slog.w(TAG, <span class="string">"*************************************************"</span>);</span><br><span class="line">                <span class="keyword">throw</span> <span class="keyword">new</span> PackageManagerException(INSTALL_FAILED_DUPLICATE_PACKAGE,</span><br><span class="line">                        <span class="string">"Core android package being redefined.  Skipping."</span>);</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            <span class="keyword">if</span> ((scanFlags &amp; SCAN_CHECK_ONLY) == <span class="number">0</span>) &#123; <span class="comment">// 进入该分支，设置系统平台包相关的属性！</span></span><br><span class="line">                <span class="comment">// Set up information for our fall-back user intent resolution activity.</span></span><br><span class="line">                mPlatformPackage = pkg;</span><br><span class="line">                pkg.mVersionCode = mSdkVersion;</span><br><span class="line">                mAndroidApplication = pkg.applicationInfo;</span><br><span class="line"></span><br><span class="line">                <span class="keyword">if</span> (!mResolverReplaced) &#123; <span class="comment">// 建立 ResolverActivity 的内存对象。</span></span><br><span class="line">                    mResolveActivity.applicationInfo = mAndroidApplication;</span><br><span class="line">                    mResolveActivity.name = ResolverActivity.class.getName();</span><br><span class="line">                    mResolveActivity.packageName = mAndroidApplication.packageName;</span><br><span class="line">                    mResolveActivity.processName = <span class="string">"system:ui"</span>;</span><br><span class="line">                    mResolveActivity.launchMode = ActivityInfo.LAUNCH_MULTIPLE;</span><br><span class="line">                    mResolveActivity.documentLaunchMode = ActivityInfo.DOCUMENT_LAUNCH_NEVER;</span><br><span class="line">                    mResolveActivity.flags = ActivityInfo.FLAG_EXCLUDE_FROM_RECENTS;</span><br><span class="line">                    mResolveActivity.theme = R.style.Theme_Material_Dialog_Alert;</span><br><span class="line">                    mResolveActivity.exported = <span class="keyword">true</span>;</span><br><span class="line">                    mResolveActivity.enabled = <span class="keyword">true</span>;</span><br><span class="line">                    mResolveActivity.resizeMode = ActivityInfo.RESIZE_MODE_RESIZEABLE;</span><br><span class="line">                    mResolveActivity.configChanges = ActivityInfo.CONFIG_SCREEN_SIZE</span><br><span class="line">                            | ActivityInfo.CONFIG_SMALLEST_SCREEN_SIZE</span><br><span class="line">                            | ActivityInfo.CONFIG_SCREEN_LAYOUT</span><br><span class="line">                            | ActivityInfo.CONFIG_ORIENTATION</span><br><span class="line">                            | ActivityInfo.CONFIG_KEYBOARD</span><br><span class="line">                            | ActivityInfo.CONFIG_KEYBOARD_HIDDEN;</span><br><span class="line">                    mResolveInfo.activityInfo = mResolveActivity;</span><br><span class="line">                    mResolveInfo.priority = <span class="number">0</span>;</span><br><span class="line">                    mResolveInfo.preferredOrder = <span class="number">0</span>;</span><br><span class="line">                    mResolveInfo.match = <span class="number">0</span>;</span><br><span class="line">                    mResolveComponentName = <span class="keyword">new</span> ComponentName(</span><br><span class="line">                            mAndroidApplication.packageName, mResolveActivity.name);</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (DEBUG_PACKAGE_SCANNING) &#123;</span><br><span class="line">        <span class="keyword">if</span> ((policyFlags &amp; PackageParser.PARSE_CHATTY) != <span class="number">0</span>)</span><br><span class="line">            Log.d(TAG, <span class="string">"Scanning package "</span> + pkg.packageName);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">synchronized</span> (mPackages) &#123;</span><br><span class="line">        <span class="comment">//【4】如果 PMS.mPackages 已经包含当前的 Package，说明这个包已经被扫描过了，抛异常，不继续处理！</span></span><br><span class="line">        <span class="keyword">if</span> (mPackages.containsKey(pkg.packageName)</span><br><span class="line">                || mSharedLibraries.containsKey(pkg.packageName)) &#123;</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> PackageManagerException(INSTALL_FAILED_DUPLICATE_PACKAGE,</span><br><span class="line">                    <span class="string">"Application package "</span> + pkg.packageName</span><br><span class="line">                            + <span class="string">" already installed.  Skipping duplicate."</span>);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">        <span class="comment">//【5】系统 apk 不进入这个分支，SCAN_REQUIRE_KNOWN 只有在扫描 data 分区是才会被设置！！</span></span><br><span class="line">        <span class="keyword">if</span> ((scanFlags &amp; SCAN_REQUIRE_KNOWN) != <span class="number">0</span>) &#123;</span><br><span class="line">            <span class="comment">//【5.1】扫描 data 分区时，会判断 mExpectingBetter 中是否包含该 package！</span></span><br><span class="line">            <span class="keyword">if</span> (mExpectingBetter.containsKey(pkg.packageName)) &#123;</span><br><span class="line">                logCriticalInfo(Log.WARN,</span><br><span class="line">                        <span class="string">"Relax SCAN_REQUIRE_KNOWN requirement for package "</span> + pkg.packageName);</span><br><span class="line">            &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                PackageSetting known = mSettings.peekPackageLPr(pkg.packageName);</span><br><span class="line">                <span class="keyword">if</span> (known != <span class="keyword">null</span>) &#123;</span><br><span class="line">                    <span class="keyword">if</span> (DEBUG_PACKAGE_SCANNING) &#123;</span><br><span class="line">                        Log.d(TAG, <span class="string">"Examining "</span> + pkg.codePath</span><br><span class="line">                                + <span class="string">" and requiring known paths "</span> + known.codePathString</span><br><span class="line">                                + <span class="string">" &amp; "</span> + known.resourcePathString);</span><br><span class="line">                    &#125;</span><br><span class="line">                    <span class="keyword">if</span> (!pkg.applicationInfo.getCodePath().equals(known.codePathString)</span><br><span class="line">                            || !pkg.applicationInfo.getResourcePath().equals(</span><br><span class="line">                            known.resourcePathString)) &#123;</span><br><span class="line">                        <span class="keyword">throw</span> <span class="keyword">new</span> PackageManagerException(INSTALL_FAILED_PACKAGE_CHANGED,</span><br><span class="line">                                <span class="string">"Application package "</span> + pkg.packageName</span><br><span class="line">                                        + <span class="string">" found at "</span> + pkg.applicationInfo.getCodePath()</span><br><span class="line">                                        + <span class="string">" but expected at "</span> + known.codePathString</span><br><span class="line">                                        + <span class="string">"; ignoring."</span>);</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//【6】获得扫描到的 apk 和资源的路径，下面会用到！</span></span><br><span class="line">    File destCodeFile = <span class="keyword">new</span> File(pkg.applicationInfo.getCodePath());</span><br><span class="line">    File destResourceFile = <span class="keyword">new</span> File(pkg.applicationInfo.getResourcePath());</span><br><span class="line"></span><br><span class="line">    SharedUserSetting suid = <span class="keyword">null</span>;</span><br><span class="line">    PackageSetting pkgSetting = <span class="keyword">null</span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//【7】系统 apk 才能有 mOriginalPackages，mRealPackage 和 mAdoptPermissions！</span></span><br><span class="line">    <span class="keyword">if</span> (!isSystemApp(pkg)) &#123;</span><br><span class="line">        pkg.mOriginalPackages = <span class="keyword">null</span>;</span><br><span class="line">        pkg.mRealPackage = <span class="keyword">null</span>;</span><br><span class="line">        pkg.mAdoptPermissions = <span class="keyword">null</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// Getting the package setting may have a side-effect, so if we</span></span><br><span class="line">    <span class="comment">// are only checking if scan would succeed, stash a copy of the</span></span><br><span class="line">    <span class="comment">// old setting to restore at the end.</span></span><br><span class="line">    PackageSetting nonMutatedPs = <span class="keyword">null</span>;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="keyword">synchronized</span> (mPackages) &#123;</span><br><span class="line">        <span class="comment">//【8】当前的系统（三方） package 是共享 uid 的，要判断其对应的共享 uid 是否存在，</span></span><br><span class="line">        <span class="comment">// 不存在就抛出异常！</span></span><br><span class="line">        <span class="keyword">if</span> (pkg.mSharedUserId != <span class="keyword">null</span>) &#123;</span><br><span class="line">            suid = mSettings.getSharedUserLPw(pkg.mSharedUserId, <span class="number">0</span>, <span class="number">0</span>, <span class="keyword">true</span>);</span><br><span class="line">            <span class="keyword">if</span> (suid == <span class="keyword">null</span>) &#123;</span><br><span class="line">                <span class="keyword">throw</span> <span class="keyword">new</span> PackageManagerException(INSTALL_FAILED_INSUFFICIENT_STORAGE,</span><br><span class="line">                        <span class="string">"Creating application package "</span> + pkg.packageName</span><br><span class="line">                        + <span class="string">" for shared user failed"</span>);</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            <span class="keyword">if</span> (DEBUG_PACKAGE_SCANNING) &#123;</span><br><span class="line">                <span class="keyword">if</span> ((policyFlags &amp; PackageParser.PARSE_CHATTY) != <span class="number">0</span>)</span><br><span class="line">                    Log.d(TAG, <span class="string">"Shared UserID "</span> + pkg.mSharedUserId + <span class="string">" (uid="</span> + suid.userId</span><br><span class="line">                            + <span class="string">"): packages="</span> + suid.packages);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">        <span class="comment">//【9】对于系统 package，如果有源包，那就要尝试将 package 的名字改为源包的名字！</span></span><br><span class="line">        <span class="comment">// 需要找到一个合适的源包，用来改名！</span></span><br><span class="line">        PackageSetting origPackage = <span class="keyword">null</span>;</span><br><span class="line">        String realName = <span class="keyword">null</span></span><br><span class="line">        <span class="keyword">if</span> (pkg.mOriginalPackages != <span class="keyword">null</span>) &#123;</span><br><span class="line">            <span class="keyword">final</span> String renamed = mSettings.mRenamedPackages.get(pkg.mRealPackage);</span><br><span class="line">            <span class="comment">//【9.1】如果当前 package 被重命名过，并且有源包的名字是重命名前的名字，就将 package 的名字改为以前的！</span></span><br><span class="line">            <span class="keyword">if</span> (pkg.mOriginalPackages.contains(renamed)) &#123;</span><br><span class="line">                realName = pkg.mRealPackage;</span><br><span class="line">                <span class="keyword">if</span> (!pkg.packageName.equals(renamed)) &#123;</span><br><span class="line">                    pkg.setPackageName(renamed);</span><br><span class="line">                &#125;</span><br><span class="line"></span><br><span class="line">            &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                <span class="keyword">for</span> (<span class="keyword">int</span> i=pkg.mOriginalPackages.size()-<span class="number">1</span>; i&gt;=<span class="number">0</span>; i--) &#123;</span><br><span class="line">                    <span class="keyword">if</span> ((origPackage = mSettings.peekPackageLPr(</span><br><span class="line">                            pkg.mOriginalPackages.get(i))) != <span class="keyword">null</span>) &#123;</span><br><span class="line">                        <span class="comment">//【9.2】对当前 package 和其源包进行校验</span></span><br><span class="line">                        <span class="comment">// 如果源包是非系统 package，不是同一分区，无法重命名为源包名，返回 false；</span></span><br><span class="line">                        <span class="comment">// 或者源包是系统 package，但是 PMS.mPackage 中仍然有其扫描数据，源包仍然存在，返回 false；</span></span><br><span class="line">                        <span class="keyword">if</span> (!verifyPackageUpdateLPr(origPackage, pkg)) &#123;</span><br><span class="line">                            origPackage = <span class="keyword">null</span>;</span><br><span class="line">                            <span class="keyword">continue</span>;</span><br><span class="line">                            </span><br><span class="line">                        &#125; <span class="keyword">else</span> <span class="keyword">if</span> (origPackage.sharedUser != <span class="keyword">null</span>) &#123;</span><br><span class="line">                            <span class="comment">//【9.3】源包是系统 package，并且共享用户 uid；</span></span><br><span class="line">                            <span class="comment">// 如果当前的 package 和源包的共享 uid 不匹配，也会返回 false！</span></span><br><span class="line">                            <span class="comment">// 表示无法迁移数据；</span></span><br><span class="line">                            <span class="keyword">if</span> (!origPackage.sharedUser.name.equals(pkg.mSharedUserId)) &#123;</span><br><span class="line">                                Slog.w(TAG, <span class="string">"Unable to migrate data from "</span> + origPackage.name</span><br><span class="line">                                        + <span class="string">" to "</span> + pkg.packageName + <span class="string">": old uid "</span></span><br><span class="line">                                        + origPackage.sharedUser.name</span><br><span class="line">                                        + <span class="string">" differs from "</span> + pkg.mSharedUserId);</span><br><span class="line">                                origPackage = <span class="keyword">null</span>;</span><br><span class="line">                                <span class="keyword">continue</span>;</span><br><span class="line">                            &#125;</span><br><span class="line">                        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                            <span class="comment">// 可以看到，如果找到用于重命名的源包，origPackage 不会为 null！</span></span><br><span class="line">                            <span class="keyword">if</span> (DEBUG_UPGRADE) Log.v(TAG, <span class="string">"Renaming new package "</span></span><br><span class="line">                                    + pkg.packageName + <span class="string">" to old name "</span> + origPackage.name);</span><br><span class="line">                        &#125;</span><br><span class="line">                        <span class="keyword">break</span>;</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">   </span><br><span class="line">        <span class="comment">// mTransferedPackages 用于保存那些自身数据已经被转移到其他 package 的 package！</span></span><br><span class="line">        <span class="keyword">if</span> (mTransferedPackages.contains(pkg.packageName)) &#123;</span><br><span class="line">            Slog.w(TAG, <span class="string">"Package "</span> + pkg.packageName</span><br><span class="line">                    + <span class="string">" was transferred to another, but its .apk remains"</span>);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// See comments in nonMutatedPs declaration</span></span><br><span class="line">        <span class="keyword">if</span> ((scanFlags &amp; SCAN_CHECK_ONLY) != <span class="number">0</span>) &#123;</span><br><span class="line">            PackageSetting foundPs = mSettings.peekPackageLPr(pkg.packageName);</span><br><span class="line">            <span class="keyword">if</span> (foundPs != <span class="keyword">null</span>) &#123;</span><br><span class="line">                nonMutatedPs = <span class="keyword">new</span> PackageSetting(foundPs);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        </span><br><span class="line">        <span class="comment">//【3.2.1.7.1.1】获得当前扫描的这个 package 对应的 packageSetting 对象，如果已经存在就直接返回，</span></span><br><span class="line">        <span class="comment">// 不存在就创建！如果 origPackage 不为 null，创建新的需要重命名为源包的名字！</span></span><br><span class="line">        pkgSetting = mSettings.getPackageLPw(pkg, origPackage, realName, suid, destCodeFile,</span><br><span class="line">                destResourceFile, pkg.applicationInfo.nativeLibraryRootDir,</span><br><span class="line">                pkg.applicationInfo.primaryCpuAbi,</span><br><span class="line">                pkg.applicationInfo.secondaryCpuAbi,</span><br><span class="line">                pkg.applicationInfo.flags, pkg.applicationInfo.privateFlags,</span><br><span class="line">                user, <span class="keyword">false</span>);</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (pkgSetting == <span class="keyword">null</span>) &#123;</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> PackageManagerException(INSTALL_FAILED_INSUFFICIENT_STORAGE,</span><br><span class="line">                    <span class="string">"Creating application package "</span> + pkg.packageName + <span class="string">" failed"</span>);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment">//【11】对于系统 package，如果 origPackage 不为 null，改名为源包的名字！</span></span><br><span class="line">        <span class="keyword">if</span> (pkgSetting.origPackage != <span class="keyword">null</span>) &#123;</span><br><span class="line">            pkg.setPackageName(origPackage.name);</span><br><span class="line"></span><br><span class="line">            String msg = <span class="string">"New package "</span> + pkgSetting.realName</span><br><span class="line">                    + <span class="string">" renamed to replace old package "</span> + pkgSetting.name;</span><br><span class="line">            reportSettingsProblem(Log.WARN, msg);</span><br><span class="line"></span><br><span class="line">            <span class="keyword">if</span> ((scanFlags &amp; SCAN_CHECK_ONLY) == <span class="number">0</span>) &#123; </span><br><span class="line">                <span class="comment">// 如果没有设置 SCAN_CHECK_ONLY，并且源包是存在的，就将源包添加到 mTransferedPackages 中！</span></span><br><span class="line">                mTransferedPackages.add(origPackage.name);</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            <span class="comment">// 清空 originPackage 属性！</span></span><br><span class="line">            pkgSetting.origPackage = <span class="keyword">null</span>;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> ((scanFlags &amp; SCAN_CHECK_ONLY) == <span class="number">0</span> &amp;&amp; realName != <span class="keyword">null</span>) &#123;</span><br><span class="line">            mTransferedPackages.add(pkg.packageName);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment">//【12】如果当前的系统 apk 被覆盖更新过，就添加 ApplicationInfo.FLAG_UPDATED_SYSTEM_APP 标签！</span></span><br><span class="line">        <span class="keyword">if</span> (mSettings.isDisabledSystemPackageLPr(pkg.packageName)) &#123; </span><br><span class="line">            pkg.applicationInfo.flags |= ApplicationInfo.FLAG_UPDATED_SYSTEM_APP;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> ((policyFlags &amp; PackageParser.PARSE_IS_SYSTEM_DIR) == <span class="number">0</span>) &#123;</span><br><span class="line">            updateSharedLibrariesLPw(pkg, <span class="keyword">null</span>);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (mFoundPolicyFile) &#123;</span><br><span class="line">            <span class="comment">//【13】给当前的 Package 分配一个标签，用于 seLinux！</span></span><br><span class="line">            SELinuxMMAC.assignSeinfoValue(pkg);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        pkg.applicationInfo.uid = pkgSetting.appId;</span><br><span class="line">        pkg.mExtras = pkgSetting;</span><br><span class="line"></span><br><span class="line">        <span class="comment">//【13】处理 keySet 更新和签名校验！</span></span><br><span class="line">        <span class="keyword">if</span> (shouldCheckUpgradeKeySetLP(pkgSetting, scanFlags)) &#123;</span><br><span class="line">            <span class="keyword">if</span> (checkUpgradeKeySetLP(pkgSetting, pkg)) &#123;</span><br><span class="line">                <span class="comment">// 签名正确，更新本地的签名信息！</span></span><br><span class="line">                pkgSetting.signatures.mSignatures = pkg.mSignatures;</span><br><span class="line">            &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                <span class="comment">// 签名异常处理</span></span><br><span class="line">                <span class="keyword">if</span> ((policyFlags &amp; PackageParser.PARSE_IS_SYSTEM_DIR) == <span class="number">0</span>) &#123;</span><br><span class="line">                    <span class="keyword">throw</span> <span class="keyword">new</span> PackageManagerException(INSTALL_FAILED_UPDATE_INCOMPATIBLE,</span><br><span class="line">                            <span class="string">"Package "</span> + pkg.packageName + <span class="string">" upgrade keys do not match the "</span></span><br><span class="line">                            + <span class="string">"previously installed version"</span>);</span><br><span class="line">                &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                    pkgSetting.signatures.mSignatures = pkg.mSignatures;</span><br><span class="line">                    String msg = <span class="string">"System package "</span> + pkg.packageName</span><br><span class="line">                        + <span class="string">" signature changed; retaining data."</span>;</span><br><span class="line">                    reportSettingsProblem(Log.WARN, msg);</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            <span class="comment">// 如果不检查 KetSet 更新的话，就直接校验签名！</span></span><br><span class="line">            <span class="keyword">try</span> &#123;</span><br><span class="line">                verifySignaturesLP(pkgSetting, pkg);</span><br><span class="line">                pkgSetting.signatures.mSignatures = pkg.mSignatures;</span><br><span class="line">                </span><br><span class="line">            &#125; <span class="keyword">catch</span> (PackageManagerException e) &#123;</span><br><span class="line">                <span class="keyword">if</span> ((policyFlags &amp; PackageParser.PARSE_IS_SYSTEM_DIR) == <span class="number">0</span>) &#123;</span><br><span class="line">                    <span class="keyword">throw</span> e;</span><br><span class="line">                &#125;</span><br><span class="line">                <span class="comment">// 如果签名校验出现问题，这里会先恢复成本次解析的签名！</span></span><br><span class="line">                pkgSetting.signatures.mSignatures = pkg.mSignatures;</span><br><span class="line">                <span class="comment">// 但是如果是 sharedUser 的情况，就会报错！</span></span><br><span class="line">                <span class="keyword">if</span> (pkgSetting.sharedUser != <span class="keyword">null</span>) &#123;</span><br><span class="line">                    <span class="keyword">if</span> (compareSignatures(pkgSetting.sharedUser.signatures.mSignatures,</span><br><span class="line">                                          pkg.mSignatures) != PackageManager.SIGNATURE_MATCH) &#123;</span><br><span class="line">                        <span class="keyword">throw</span> <span class="keyword">new</span> PackageManagerException(</span><br><span class="line">                                INSTALL_PARSE_FAILED_INCONSISTENT_CERTIFICATES,</span><br><span class="line">                                        <span class="string">"Signature mismatch for shared user: "</span></span><br><span class="line">                                        + pkgSetting.sharedUser);</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;</span><br><span class="line">                String msg = <span class="string">"System package "</span> + pkg.packageName</span><br><span class="line">                    + <span class="string">" signature changed; retaining data."</span>;</span><br><span class="line">                reportSettingsProblem(Log.WARN, msg);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment">//【14】安装的时候才会进入这个分支，这里不看！</span></span><br><span class="line">        <span class="comment">// 判断这个 package 使用的 content providers 是否和已经存在 package 冲突！</span></span><br><span class="line">        <span class="keyword">if</span> ((scanFlags &amp; SCAN_NEW_INSTALL) != <span class="number">0</span>) &#123; </span><br><span class="line">            <span class="keyword">final</span> <span class="keyword">int</span> N = pkg.providers.size();</span><br><span class="line">            <span class="keyword">int</span> i;</span><br><span class="line">            <span class="keyword">for</span> (i=<span class="number">0</span>; i&lt;N; i++) &#123;</span><br><span class="line">                PackageParser.Provider p = pkg.providers.get(i);</span><br><span class="line">                <span class="keyword">if</span> (p.info.authority != <span class="keyword">null</span>) &#123;</span><br><span class="line">                    String names[] = p.info.authority.split(<span class="string">";"</span>);</span><br><span class="line">                    <span class="keyword">for</span> (<span class="keyword">int</span> j = <span class="number">0</span>; j &lt; names.length; j++) &#123;</span><br><span class="line">                        <span class="keyword">if</span> (mProvidersByAuthority.containsKey(names[j])) &#123;</span><br><span class="line">                            PackageParser.Provider other = mProvidersByAuthority.get(names[j]);</span><br><span class="line">                            <span class="keyword">final</span> String otherPackageName =</span><br><span class="line">                                    ((other != <span class="keyword">null</span> &amp;&amp; other.getComponentName() != <span class="keyword">null</span>) ?</span><br><span class="line">                                            other.getComponentName().getPackageName() : <span class="string">"?"</span>);</span><br><span class="line">                            <span class="keyword">throw</span> <span class="keyword">new</span> PackageManagerException(</span><br><span class="line">                                    INSTALL_FAILED_CONFLICTING_PROVIDER,</span><br><span class="line">                                            <span class="string">"Can't install because provider name "</span> + names[j]</span><br><span class="line">                                            + <span class="string">" (in package "</span> + pkg.applicationInfo.packageName</span><br><span class="line">                                            + <span class="string">") is already used by "</span> + otherPackageName);</span><br><span class="line">                        &#125;</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment">//【15】同样的，只有系统 apk 才能进入该分支，用于权限继承！</span></span><br><span class="line">        <span class="keyword">if</span> ((scanFlags &amp; SCAN_CHECK_ONLY) == <span class="number">0</span> &amp;&amp; pkg.mAdoptPermissions != <span class="keyword">null</span>) &#123;</span><br><span class="line">            <span class="keyword">for</span> (<span class="keyword">int</span> i = pkg.mAdoptPermissions.size() - <span class="number">1</span>; i &gt;= <span class="number">0</span>; i--) &#123;</span><br><span class="line">                <span class="keyword">final</span> String origName = pkg.mAdoptPermissions.get(i);</span><br><span class="line">                <span class="keyword">final</span> PackageSetting orig = mSettings.peekPackageLPr(origName);</span><br><span class="line">                <span class="keyword">if</span> (orig != <span class="keyword">null</span>) &#123;</span><br><span class="line">                    <span class="comment">//【15.1】校验要被继承权限的 package 一是否存在，二是否是系统应用！</span></span><br><span class="line">                    <span class="comment">// 条件不满足，无法权限继承！</span></span><br><span class="line">                    <span class="keyword">if</span> (verifyPackageUpdateLPr(orig, pkg)) &#123;</span><br><span class="line">                        Slog.i(TAG, <span class="string">"Adopting permissions from "</span> + origName + <span class="string">" to "</span></span><br><span class="line">                                + pkg.packageName);</span><br><span class="line">                        mSettings.transferPermissionsLPw(origName, pkg.packageName);</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">final</span> String pkgName = pkg.packageName;</span><br><span class="line">    <span class="comment">// 从 base.apk 和其 split.apk（如果有）中选择修改时间最晚的作为扫描时间！</span></span><br><span class="line">    <span class="keyword">final</span> <span class="keyword">long</span> scanFileTime = getLastModifiedTime(pkg, scanFile);</span><br><span class="line">    <span class="keyword">final</span> <span class="keyword">boolean</span> forceDex = (scanFlags &amp; SCAN_FORCE_DEX) != <span class="number">0</span>; <span class="comment">// 没用到，应该是废弃代码！</span></span><br><span class="line">    </span><br><span class="line">    <span class="comment">//【16】设置 pacakge 对应的进程名，如果 processName 为 null，默认进程名为包名！</span></span><br><span class="line">    pkg.applicationInfo.processName = fixProcessName(</span><br><span class="line">            pkg.applicationInfo.packageName,</span><br><span class="line">            pkg.applicationInfo.processName,</span><br><span class="line">            pkg.applicationInfo.uid);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (pkg != mPlatformPackage) &#123;</span><br><span class="line">        <span class="comment">// Get all of our default paths setup</span></span><br><span class="line">        pkg.applicationInfo.initForUser(UserHandle.USER_SYSTEM);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">final</span> String path = scanFile.getPath();</span><br><span class="line">    <span class="keyword">final</span> String cpuAbiOverride = deriveAbiOverride(pkg.cpuAbiOverride, pkgSetting);</span><br><span class="line"></span><br><span class="line">    <span class="comment">//【17】下面是设置本地库和系统平台相关的属性！！</span></span><br><span class="line">    <span class="keyword">if</span> ((scanFlags &amp; SCAN_NEW_INSTALL) == <span class="number">0</span>) &#123;</span><br><span class="line">        derivePackageAbi(pkg, scanFile, cpuAbiOverride, <span class="keyword">true</span> <span class="comment">/* extract libs */</span>);</span><br><span class="line">        <span class="keyword">if</span> (isSystemApp(pkg) &amp;&amp; !pkg.isUpdatedSystemApp() &amp;&amp;</span><br><span class="line">                pkg.applicationInfo.primaryCpuAbi == <span class="keyword">null</span>) &#123;</span><br><span class="line">            setBundledAppAbisAndRoots(pkg, pkgSetting);</span><br><span class="line">            setNativeLibraryPaths(pkg);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        <span class="keyword">if</span> ((scanFlags &amp; SCAN_MOVE) != <span class="number">0</span>) &#123;</span><br><span class="line">            pkg.applicationInfo.primaryCpuAbi = pkgSetting.primaryCpuAbiString;</span><br><span class="line">            pkg.applicationInfo.secondaryCpuAbi = pkgSetting.secondaryCpuAbiString;</span><br><span class="line">        &#125;</span><br><span class="line">        setNativeLibraryPaths(pkg);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (mPlatformPackage == pkg) &#123;</span><br><span class="line">        pkg.applicationInfo.primaryCpuAbi = VMRuntime.getRuntime().is64Bit() ?</span><br><span class="line">                Build.SUPPORTED_64_BIT_ABIS[<span class="number">0</span>] : Build.SUPPORTED_32_BIT_ABIS[<span class="number">0</span>];</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> ((scanFlags &amp; SCAN_NO_DEX) == <span class="number">0</span> &amp;&amp; (scanFlags &amp; SCAN_NEW_INSTALL) != <span class="number">0</span>) &#123;</span><br><span class="line">        <span class="keyword">if</span> (cpuAbiOverride == <span class="keyword">null</span> &amp;&amp; pkgSetting.cpuAbiOverrideString != <span class="keyword">null</span>) &#123;</span><br><span class="line">            Slog.w(TAG, <span class="string">"Ignoring persisted ABI override "</span> + cpuAbiOverride +</span><br><span class="line">                    <span class="string">" for package "</span> + pkg.packageName);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    pkgSetting.primaryCpuAbiString = pkg.applicationInfo.primaryCpuAbi;</span><br><span class="line">    pkgSetting.secondaryCpuAbiString = pkg.applicationInfo.secondaryCpuAbi;</span><br><span class="line">    pkgSetting.cpuAbiOverrideString = cpuAbiOverride;</span><br><span class="line"></span><br><span class="line">    pkg.cpuAbiOverride = cpuAbiOverride;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (DEBUG_ABI_SELECTION) &#123;</span><br><span class="line">        Slog.d(TAG, <span class="string">"Resolved nativeLibraryRoot for "</span> + pkg.applicationInfo.packageName</span><br><span class="line">                + <span class="string">" to root="</span> + pkg.applicationInfo.nativeLibraryRootDir + <span class="string">", isa="</span></span><br><span class="line">                + pkg.applicationInfo.nativeLibraryRootRequiresIsa);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    pkgSetting.legacyNativeLibraryPathString = pkg.applicationInfo.nativeLibraryRootDir;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (DEBUG_ABI_SELECTION) &#123;</span><br><span class="line">        Log.d(TAG, <span class="string">"Abis for package["</span> + pkg.packageName + <span class="string">"] are"</span> +</span><br><span class="line">                <span class="string">" primary="</span> + pkg.applicationInfo.primaryCpuAbi +</span><br><span class="line">                <span class="string">" secondary="</span> + pkg.applicationInfo.secondaryCpuAbi);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> ((scanFlags &amp; SCAN_BOOTING) == <span class="number">0</span> &amp;&amp; pkgSetting.sharedUser != <span class="keyword">null</span>) &#123;</span><br><span class="line">        adjustCpuAbisForSharedUserLPw(pkgSetting.sharedUser.packages,</span><br><span class="line">                pkg, <span class="keyword">true</span> <span class="comment">/* boot complete */</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (mFactoryTest &amp;&amp; pkg.requestedPermissions.contains(</span><br><span class="line">            android.Manifest.permission.FACTORY_TEST)) &#123;</span><br><span class="line">        pkg.applicationInfo.flags |= ApplicationInfo.FLAG_FACTORY_TEST;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 如果是系统 package，设置 isOrphaned 的属性为 true！</span></span><br><span class="line">    <span class="keyword">if</span> (isSystemApp(pkg)) &#123;</span><br><span class="line">        pkgSetting.isOrphaned = <span class="keyword">true</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    ArrayList&lt;PackageParser.Package&gt; clientLibPkgs = <span class="keyword">null</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> ((scanFlags &amp; SCAN_CHECK_ONLY) != <span class="number">0</span>) &#123;</span><br><span class="line">        <span class="keyword">if</span> (nonMutatedPs != <span class="keyword">null</span>) &#123;</span><br><span class="line">            <span class="keyword">synchronized</span> (mPackages) &#123;</span><br><span class="line">                mSettings.mPackages.put(nonMutatedPs.name, nonMutatedPs);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> pkg;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//【18】处理特权 apk 的子包，只有特权 apk 才能添加子包；</span></span><br><span class="line">    <span class="comment">// 特权 apk 包括两部分：</span></span><br><span class="line">    <span class="comment">// 1、特定 uid 的 app</span></span><br><span class="line">    <span class="comment">// 2、framework-res.apk 和 system/priv-app 目录下的 apk！</span></span><br><span class="line">    <span class="keyword">if</span> (pkg.childPackages != <span class="keyword">null</span> &amp;&amp; !pkg.childPackages.isEmpty()) &#123;</span><br><span class="line">        <span class="keyword">if</span> ((policyFlags &amp; PARSE_IS_PRIVILEGED) == <span class="number">0</span>) &#123;</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> PackageManagerException(<span class="string">"Only privileged apps and updated "</span></span><br><span class="line">                    + <span class="string">"privileged apps can add child packages. Ignoring package "</span></span><br><span class="line">                    + pkg.packageName);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">final</span> <span class="keyword">int</span> childCount = pkg.childPackages.size();</span><br><span class="line">        <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; childCount; i++) &#123;</span><br><span class="line">            PackageParser.Package childPkg = pkg.childPackages.get(i);</span><br><span class="line">            <span class="keyword">if</span> (mSettings.hasOtherDisabledSystemPkgWithChildLPr(pkg.packageName,</span><br><span class="line">                    childPkg.packageName)) &#123;</span><br><span class="line">                <span class="keyword">throw</span> <span class="keyword">new</span> PackageManagerException(<span class="string">"Cannot override a child package of "</span></span><br><span class="line">                        + <span class="string">"another disabled system app. Ignoring package "</span> + pkg.packageName);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">synchronized</span> (mPackages) &#123;</span><br><span class="line">        <span class="comment">//【19】如果是系统 package，并且他之前更新过，就要尝试对共享库 lib 进行更新！</span></span><br><span class="line">        <span class="comment">// 只有系统 package 才能添加共享 lib</span></span><br><span class="line">        <span class="keyword">if</span> ((pkg.applicationInfo.flags &amp; ApplicationInfo.FLAG_SYSTEM) != <span class="number">0</span>) &#123;</span><br><span class="line">            <span class="keyword">if</span> (pkg.libraryNames != <span class="keyword">null</span>) &#123;</span><br><span class="line">                <span class="keyword">for</span> (<span class="keyword">int</span> i=<span class="number">0</span>; i&lt;pkg.libraryNames.size(); i++) &#123;</span><br><span class="line">                    String name = pkg.libraryNames.get(i);</span><br><span class="line">                    <span class="keyword">boolean</span> allowed = <span class="keyword">false</span>;</span><br><span class="line">                    <span class="keyword">if</span> (pkg.isUpdatedSystemApp()) &#123;</span><br><span class="line">                        <span class="keyword">final</span> PackageSetting sysPs = mSettings</span><br><span class="line">                                .getDisabledSystemPkgLPr(pkg.packageName);</span><br><span class="line">                        <span class="keyword">if</span> (sysPs.pkg != <span class="keyword">null</span> &amp;&amp; sysPs.pkg.libraryNames != <span class="keyword">null</span>) &#123;</span><br><span class="line">                            <span class="keyword">for</span> (<span class="keyword">int</span> j=<span class="number">0</span>; j&lt;sysPs.pkg.libraryNames.size(); j++) &#123;</span><br><span class="line">                                <span class="keyword">if</span> (name.equals(sysPs.pkg.libraryNames.get(j))) &#123;</span><br><span class="line">                                    allowed = <span class="keyword">true</span>;</span><br><span class="line">                                    <span class="keyword">break</span>;</span><br><span class="line">                                &#125;</span><br><span class="line">                            &#125;</span><br><span class="line">                        &#125;</span><br><span class="line">                    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                        allowed = <span class="keyword">true</span>;</span><br><span class="line">                    &#125;</span><br><span class="line">                    <span class="keyword">if</span> (allowed) &#123;</span><br><span class="line">                        <span class="keyword">if</span> (!mSharedLibraries.containsKey(name)) &#123;</span><br><span class="line">                            mSharedLibraries.put(name, <span class="keyword">new</span> SharedLibraryEntry(<span class="keyword">null</span>, pkg.packageName));</span><br><span class="line">                            </span><br><span class="line">                        &#125; <span class="keyword">else</span> <span class="keyword">if</span> (!name.equals(pkg.packageName)) &#123;</span><br><span class="line">                            Slog.w(TAG, <span class="string">"Package "</span> + pkg.packageName + <span class="string">" library "</span></span><br><span class="line">                                    + name + <span class="string">" already exists; skipping"</span>);</span><br><span class="line">                        &#125;</span><br><span class="line">                    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                        Slog.w(TAG, <span class="string">"Package "</span> + pkg.packageName + <span class="string">" declares lib "</span></span><br><span class="line">                                + name + <span class="string">" that is not declared on system image; skipping"</span>);</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;</span><br><span class="line">                <span class="keyword">if</span> ((scanFlags &amp; SCAN_BOOTING) == <span class="number">0</span>) &#123;</span><br><span class="line">                    <span class="comment">// 如果不是开机扫描，我们需要更新下该应用的共享库，对于开机扫描的情况，我们会在扫描完成后自动更新</span></span><br><span class="line">                    clientLibPkgs = updateAllSharedLibrariesLPw(pkg);</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//【20】处理和冻结相关的逻辑</span></span><br><span class="line">    <span class="keyword">if</span> ((scanFlags &amp; SCAN_BOOTING) != <span class="number">0</span>) &#123;</span><br><span class="line">        <span class="comment">// 如果是开机扫描，不需要冻结，因为没有应用在此时可以运行！</span></span><br><span class="line">    &#125; <span class="keyword">else</span> <span class="keyword">if</span> ((scanFlags &amp; SCAN_DONT_KILL_APP) != <span class="number">0</span>) &#123;</span><br><span class="line">        <span class="comment">// 如果扫描过程中不允许 kill app，那就不会冻结！</span></span><br><span class="line">    &#125; <span class="keyword">else</span> <span class="keyword">if</span> ((scanFlags &amp; SCAN_IGNORE_FROZEN) != <span class="number">0</span>) &#123;</span><br><span class="line">        <span class="comment">// 如果扫描过程中显式指定忽略冻结，那就不会冻结！</span></span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        <span class="comment">// 其他情况，我们会默认冻结该应用，防止其启动！</span></span><br><span class="line">        checkPackageFrozen(pkgName);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//【21】杀掉所以依赖于库文件的应用，因为库发生了更新！</span></span><br><span class="line">    <span class="keyword">if</span> (clientLibPkgs != <span class="keyword">null</span>) &#123;</span><br><span class="line">        <span class="keyword">for</span> (<span class="keyword">int</span> i=<span class="number">0</span>; i&lt;clientLibPkgs.size(); i++) &#123;</span><br><span class="line">            PackageParser.Package clientPkg = clientLibPkgs.get(i);</span><br><span class="line">            killApplication(clientPkg.applicationInfo.packageName,</span><br><span class="line">                    clientPkg.applicationInfo.uid, <span class="string">"update lib"</span>);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    KeySetManagerService ksms = mSettings.mKeySetManagerService; <span class="comment">// 校验 keyset 的真实性</span></span><br><span class="line">    ksms.assertScannedPackageValid(pkg);</span><br><span class="line"></span><br><span class="line">    Trace.traceBegin(TRACE_TAG_PACKAGE_MANAGER, <span class="string">"updateSettings"</span>); <span class="comment">// 记录 trace 事件！</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">boolean</span> createIdmapFailed = <span class="keyword">false</span>;</span><br><span class="line">    <span class="keyword">synchronized</span> (mPackages) &#123;</span><br><span class="line">        <span class="comment">// We don't expect installation to fail beyond this point</span></span><br><span class="line">        <span class="keyword">if</span> (pkgSetting.pkg != <span class="keyword">null</span>) &#123;</span><br><span class="line">            <span class="comment">// Note that |user| might be null during the initial boot scan. If a codePath</span></span><br><span class="line">            <span class="comment">// for an app has changed during a boot scan, it's due to an app update that's</span></span><br><span class="line">            <span class="comment">// part of the system partition and marker changes must be applied to all users.</span></span><br><span class="line">            maybeRenameForeignDexMarkers(pkgSetting.pkg, pkg,</span><br><span class="line">                (user != <span class="keyword">null</span>) ? user : UserHandle.ALL);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment">//【3.2.1.7.1.2 important】将新创建或者更新后的 PackageSetting 重新添加到 mSettings 中！</span></span><br><span class="line">        mSettings.insertPackageSettingLPw(pkgSetting, pkg);</span><br><span class="line">        </span><br><span class="line">        <span class="comment">//【important】将本次扫描的 Package 添加到 PMS.mPackages 中去！</span></span><br><span class="line">        mPackages.put(pkg.applicationInfo.packageName, pkg);</span><br><span class="line">        </span><br><span class="line">        <span class="comment">//【22】将当前的 package 从 mSettings.mPackagesToBeCleaned 中移除，防止被清除！</span></span><br><span class="line">        <span class="keyword">final</span> Iterator&lt;PackageCleanItem&gt; iter = mSettings.mPackagesToBeCleaned.iterator();</span><br><span class="line">        <span class="keyword">while</span> (iter.hasNext()) &#123;</span><br><span class="line">            PackageCleanItem item = iter.next();</span><br><span class="line">            <span class="keyword">if</span> (pkgName.equals(item.packageName)) &#123;</span><br><span class="line">                iter.remove();</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment">//【23】处理 package 的第一次安装时间和最近更新时间！</span></span><br><span class="line">        <span class="keyword">if</span> (currentTime != <span class="number">0</span>) &#123;</span><br><span class="line">            <span class="keyword">if</span> (pkgSetting.firstInstallTime == <span class="number">0</span>) &#123;</span><br><span class="line">                pkgSetting.firstInstallTime = pkgSetting.lastUpdateTime = currentTime;</span><br><span class="line"></span><br><span class="line">            &#125; <span class="keyword">else</span> <span class="keyword">if</span> ((scanFlags &amp; SCAN_UPDATE_TIME) != <span class="number">0</span>) &#123;</span><br><span class="line">                pkgSetting.lastUpdateTime = currentTime;</span><br><span class="line"></span><br><span class="line">            &#125;</span><br><span class="line">        &#125; <span class="keyword">else</span> <span class="keyword">if</span> (pkgSetting.firstInstallTime == <span class="number">0</span>) &#123;</span><br><span class="line">            pkgSetting.firstInstallTime = pkgSetting.lastUpdateTime = scanFileTime;</span><br><span class="line">            </span><br><span class="line">        &#125; <span class="keyword">else</span> <span class="keyword">if</span> ((policyFlags &amp; PackageParser.PARSE_IS_SYSTEM_DIR) != <span class="number">0</span>) &#123;</span><br><span class="line">            <span class="keyword">if</span> (scanFileTime != pkgSetting.timeStamp) &#123;</span><br><span class="line">                pkgSetting.lastUpdateTime = scanFileTime;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        ksms.addScannedPackageLPw(pkg); <span class="comment">// 将 package 的 KeySets 添加到 KeySetManagerService 中！</span></span><br><span class="line">       </span><br><span class="line">        <span class="comment">//【24】处理四大组件！ </span></span><br><span class="line">        <span class="comment">//【24.1】处理该 Package 中 的 Provider 信息，添加到 PMS.mProviders 中！</span></span><br><span class="line">        <span class="keyword">int</span> N = pkg.providers.size();</span><br><span class="line">        StringBuilder r = <span class="keyword">null</span>;</span><br><span class="line">        <span class="keyword">int</span> i;</span><br><span class="line">        <span class="keyword">for</span> (i=<span class="number">0</span>; i&lt;N; i++) &#123;</span><br><span class="line">            PackageParser.Provider p = pkg.providers.get(i);</span><br><span class="line">            p.info.processName = fixProcessName(pkg.applicationInfo.processName,</span><br><span class="line">                    p.info.processName, pkg.applicationInfo.uid);</span><br><span class="line">            mProviders.addProvider(p); <span class="comment">// 添加到 PMS.mProviders 中！</span></span><br><span class="line">            p.syncable = p.info.isSyncable;</span><br><span class="line">            <span class="keyword">if</span> (p.info.authority != <span class="keyword">null</span>) &#123;</span><br><span class="line">                String names[] = p.info.authority.split(<span class="string">";"</span>);</span><br><span class="line">                p.info.authority = <span class="keyword">null</span>;</span><br><span class="line">                <span class="keyword">for</span> (<span class="keyword">int</span> j = <span class="number">0</span>; j &lt; names.length; j++) &#123;</span><br><span class="line">                    <span class="keyword">if</span> (j == <span class="number">1</span> &amp;&amp; p.syncable) &#123;</span><br><span class="line">                        <span class="comment">// We only want the first authority for a provider to possibly be</span></span><br><span class="line">                        <span class="comment">// syncable, so if we already added this provider using a different</span></span><br><span class="line">                        <span class="comment">// authority clear the syncable flag. We copy the provider before</span></span><br><span class="line">                        <span class="comment">// changing it because the mProviders object contains a reference</span></span><br><span class="line">                        <span class="comment">// to a provider that we don't want to change.</span></span><br><span class="line">                        <span class="comment">// Only do this for the second authority since the resulting provider</span></span><br><span class="line">                        <span class="comment">// object can be the same for all future authorities for this provider.</span></span><br><span class="line">                        p = <span class="keyword">new</span> PackageParser.Provider(p);</span><br><span class="line">                        p.syncable = <span class="keyword">false</span>;</span><br><span class="line">                    &#125;</span><br><span class="line">                    <span class="keyword">if</span> (!mProvidersByAuthority.containsKey(names[j])) &#123;</span><br><span class="line">                        mProvidersByAuthority.put(names[j], p);</span><br><span class="line">                        <span class="keyword">if</span> (p.info.authority == <span class="keyword">null</span>) &#123;</span><br><span class="line">                            p.info.authority = names[j];</span><br><span class="line">                        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                            p.info.authority = p.info.authority + <span class="string">";"</span> + names[j];</span><br><span class="line">                        &#125;</span><br><span class="line">                        <span class="keyword">if</span> (DEBUG_PACKAGE_SCANNING) &#123;</span><br><span class="line">                            <span class="keyword">if</span> ((policyFlags &amp; PackageParser.PARSE_CHATTY) != <span class="number">0</span>)</span><br><span class="line">                                Log.d(TAG, <span class="string">"Registered content provider: "</span> + names[j]</span><br><span class="line">                                        + <span class="string">", className = "</span> + p.info.name + <span class="string">", isSyncable = "</span></span><br><span class="line">                                        + p.info.isSyncable);</span><br><span class="line">                        &#125;</span><br><span class="line">                    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                        PackageParser.Provider other = mProvidersByAuthority.get(names[j]);</span><br><span class="line">                        Slog.w(TAG, <span class="string">"Skipping provider name "</span> + names[j] +</span><br><span class="line">                                <span class="string">" (in package "</span> + pkg.applicationInfo.packageName +</span><br><span class="line">                                <span class="string">"): name already used by "</span></span><br><span class="line">                                + ((other != <span class="keyword">null</span> &amp;&amp; other.getComponentName() != <span class="keyword">null</span>)</span><br><span class="line">                                        ? other.getComponentName().getPackageName() : <span class="string">"?"</span>));</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">if</span> ((policyFlags&amp;PackageParser.PARSE_CHATTY) != <span class="number">0</span>) &#123;</span><br><span class="line">                <span class="keyword">if</span> (r == <span class="keyword">null</span>) &#123;</span><br><span class="line">                    r = <span class="keyword">new</span> StringBuilder(<span class="number">256</span>);</span><br><span class="line">                &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                    r.append(<span class="string">' '</span>);</span><br><span class="line">                &#125;</span><br><span class="line">                r.append(p.info.name);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">if</span> (r != <span class="keyword">null</span>) &#123;</span><br><span class="line">            <span class="keyword">if</span> (DEBUG_PACKAGE_SCANNING) Log.d(TAG, <span class="string">"  Providers: "</span> + r);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment">//【24.2】处理该 Package 中的 Service 信息，添加到 PMS.mService 中！</span></span><br><span class="line">        N = pkg.services.size();</span><br><span class="line">        r = <span class="keyword">null</span>;</span><br><span class="line">        <span class="keyword">for</span> (i=<span class="number">0</span>; i&lt;N; i++) &#123;</span><br><span class="line">            PackageParser.Service s = pkg.services.get(i);</span><br><span class="line">            s.info.processName = fixProcessName(pkg.applicationInfo.processName,</span><br><span class="line">                    s.info.processName, pkg.applicationInfo.uid);</span><br><span class="line">            mServices.addService(s); <span class="comment">// 添加到 PMS.mServices 中！</span></span><br><span class="line">            <span class="keyword">if</span> ((policyFlags&amp;PackageParser.PARSE_CHATTY) != <span class="number">0</span>) &#123;</span><br><span class="line">                <span class="keyword">if</span> (r == <span class="keyword">null</span>) &#123;</span><br><span class="line">                    r = <span class="keyword">new</span> StringBuilder(<span class="number">256</span>);</span><br><span class="line">                &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                    r.append(<span class="string">' '</span>);</span><br><span class="line">                &#125;</span><br><span class="line">                r.append(s.info.name);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">if</span> (r != <span class="keyword">null</span>) &#123;</span><br><span class="line">            <span class="keyword">if</span> (DEBUG_PACKAGE_SCANNING) Log.d(TAG, <span class="string">"  Services: "</span> + r);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment">//【24.3】处理该 Package 中的 BroadcastReceiver 信息,添加到 PMS.mReceivers 中。</span></span><br><span class="line">        N = pkg.receivers.size();</span><br><span class="line">        r = <span class="keyword">null</span>;</span><br><span class="line">        <span class="keyword">for</span> (i=<span class="number">0</span>; i&lt;N; i++) &#123;</span><br><span class="line">            PackageParser.Activity a = pkg.receivers.get(i);</span><br><span class="line">            a.info.processName = fixProcessName(pkg.applicationInfo.processName,</span><br><span class="line">                    a.info.processName, pkg.applicationInfo.uid);</span><br><span class="line">            mReceivers.addActivity(a, <span class="string">"receiver"</span>); <span class="comment">// 添加到 PMS.mReceivers 中！</span></span><br><span class="line">            <span class="keyword">if</span> ((policyFlags&amp;PackageParser.PARSE_CHATTY) != <span class="number">0</span>) &#123;</span><br><span class="line">                <span class="keyword">if</span> (r == <span class="keyword">null</span>) &#123;</span><br><span class="line">                    r = <span class="keyword">new</span> StringBuilder(<span class="number">256</span>);</span><br><span class="line">                &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                    r.append(<span class="string">' '</span>);</span><br><span class="line">                &#125;</span><br><span class="line">                r.append(a.info.name);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">if</span> (r != <span class="keyword">null</span>) &#123;</span><br><span class="line">            <span class="keyword">if</span> (DEBUG_PACKAGE_SCANNING) Log.d(TAG, <span class="string">"  Receivers: "</span> + r);</span><br><span class="line">        &#125;</span><br><span class="line">        </span><br><span class="line">        <span class="comment">//【24.4】处理该 Package 中的 activity 信息，添加到 PMS.mActivities 中！</span></span><br><span class="line">        N = pkg.activities.size();</span><br><span class="line">        r = <span class="keyword">null</span>;</span><br><span class="line">        <span class="keyword">for</span> (i=<span class="number">0</span>; i&lt;N; i++) &#123;</span><br><span class="line">            PackageParser.Activity a = pkg.activities.get(i);</span><br><span class="line">            a.info.processName = fixProcessName(pkg.applicationInfo.processName,</span><br><span class="line">                    a.info.processName, pkg.applicationInfo.uid);</span><br><span class="line">            mActivities.addActivity(a, <span class="string">"activity"</span>); <span class="comment">// 添加到 PMS.mActivities 中！</span></span><br><span class="line">            <span class="keyword">if</span> ((policyFlags&amp;PackageParser.PARSE_CHATTY) != <span class="number">0</span>) &#123;</span><br><span class="line">                <span class="keyword">if</span> (r == <span class="keyword">null</span>) &#123;</span><br><span class="line">                    r = <span class="keyword">new</span> StringBuilder(<span class="number">256</span>);</span><br><span class="line">                &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                    r.append(<span class="string">' '</span>);</span><br><span class="line">                &#125;</span><br><span class="line">                r.append(a.info.name);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">if</span> (r != <span class="keyword">null</span>) &#123;</span><br><span class="line">            <span class="keyword">if</span> (DEBUG_PACKAGE_SCANNING) Log.d(TAG, <span class="string">"  Activities: "</span> + r);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment">//【24.5】处理该 Package 中的 PermissionGroups 信息，添加到 PMS.mPermissionGroups 中！</span></span><br><span class="line">        N = pkg.permissionGroups.size();</span><br><span class="line">        r = <span class="keyword">null</span>;</span><br><span class="line">        <span class="keyword">for</span> (i=<span class="number">0</span>; i&lt;N; i++) &#123;</span><br><span class="line">            PackageParser.PermissionGroup pg = pkg.permissionGroups.get(i);</span><br><span class="line">            PackageParser.PermissionGroup cur = mPermissionGroups.get(pg.info.name);</span><br><span class="line">            <span class="keyword">final</span> String curPackageName = cur == <span class="keyword">null</span> ? <span class="keyword">null</span> : cur.info.packageName;</span><br><span class="line">            <span class="comment">//【5.1】如果 isPackageUpdate 为 true，说明要更新权限组的信息！</span></span><br><span class="line">            <span class="comment">// 如果 cur 为 null，说明是新添加的权限组信息！</span></span><br><span class="line">            <span class="keyword">final</span> <span class="keyword">boolean</span> isPackageUpdate = pg.info.packageName.equals(curPackageName);</span><br><span class="line">            <span class="keyword">if</span> (cur == <span class="keyword">null</span> || isPackageUpdate) &#123;</span><br><span class="line">                mPermissionGroups.put(pg.info.name, pg); <span class="comment">// 添加到 PMS.mPermissionGroups 中！</span></span><br><span class="line">                <span class="keyword">if</span> ((policyFlags&amp;PackageParser.PARSE_CHATTY) != <span class="number">0</span>) &#123;</span><br><span class="line">                    <span class="keyword">if</span> (r == <span class="keyword">null</span>) &#123;</span><br><span class="line">                        r = <span class="keyword">new</span> StringBuilder(<span class="number">256</span>);</span><br><span class="line">                    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                        r.append(<span class="string">' '</span>);</span><br><span class="line">                    &#125;</span><br><span class="line">                    <span class="keyword">if</span> (isPackageUpdate) &#123;</span><br><span class="line">                        r.append(<span class="string">"UPD:"</span>);</span><br><span class="line">                    &#125;</span><br><span class="line">                    r.append(pg.info.name);</span><br><span class="line">                &#125;</span><br><span class="line">            &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                Slog.w(TAG, <span class="string">"Permission group "</span> + pg.info.name + <span class="string">" from package "</span></span><br><span class="line">                        + pg.info.packageName + <span class="string">" ignored: original from "</span></span><br><span class="line">                        + cur.info.packageName);</span><br><span class="line">                <span class="keyword">if</span> ((policyFlags&amp;PackageParser.PARSE_CHATTY) != <span class="number">0</span>) &#123;</span><br><span class="line">                    <span class="keyword">if</span> (r == <span class="keyword">null</span>) &#123;</span><br><span class="line">                        r = <span class="keyword">new</span> StringBuilder(<span class="number">256</span>);</span><br><span class="line">                    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                        r.append(<span class="string">' '</span>);</span><br><span class="line">                    &#125;</span><br><span class="line">                    r.append(<span class="string">"DUP:"</span>);</span><br><span class="line">                    r.append(pg.info.name);</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">if</span> (r != <span class="keyword">null</span>) &#123;</span><br><span class="line">            <span class="keyword">if</span> (DEBUG_PACKAGE_SCANNING) Log.d(TAG, <span class="string">"  Permission Groups: "</span> + r);</span><br><span class="line">        &#125;</span><br><span class="line">        </span><br><span class="line">        <span class="comment">//【24.6】处理该 Package 中的定义 Permission 和 Permission-tree 信息！</span></span><br><span class="line">        N = pkg.permissions.size();</span><br><span class="line">        r = <span class="keyword">null</span>;</span><br><span class="line">        <span class="keyword">for</span> (i=<span class="number">0</span>; i&lt;N; i++) &#123;</span><br><span class="line">            PackageParser.Permission p = pkg.permissions.get(i);</span><br><span class="line">            <span class="comment">// 默认取消掉 PermissionInfo.FLAG_INSTALLED 标志位！</span></span><br><span class="line">            p.info.flags &amp;= ~PermissionInfo.FLAG_INSTALLED;</span><br><span class="line"></span><br><span class="line">            <span class="comment">//【6.1】设置权限所属的 group，前提是只有 Android5.1 以后才支持 Permission Groups！</span></span><br><span class="line">            <span class="keyword">if</span> (pkg.applicationInfo.targetSdkVersion &gt; Build.VERSION_CODES.LOLLIPOP_MR1) &#123;</span><br><span class="line">                p.group = mPermissionGroups.get(p.info.group);</span><br><span class="line">                <span class="keyword">if</span> (p.info.group != <span class="keyword">null</span> &amp;&amp; p.group == <span class="keyword">null</span>) &#123;</span><br><span class="line">                    Slog.w(TAG, <span class="string">"Permission "</span> + p.info.name + <span class="string">" from package "</span></span><br><span class="line">                            + p.info.packageName + <span class="string">" in an unknown group "</span> + p.info.group);</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            <span class="comment">//【6.2】从 Settings 中获得权限管理集合，如果该权限是一个 Permission-tree，</span></span><br><span class="line">            <span class="comment">// 那就返回 mSettings.mPermissionTrees；否则，返回 mSettings.mPermissions！</span></span><br><span class="line">            ArrayMap&lt;String, BasePermission&gt; permissionMap =</span><br><span class="line">                    p.tree ? mSettings.mPermissionTrees</span><br><span class="line">                            : mSettings.mPermissions;</span><br><span class="line"></span><br><span class="line">            <span class="comment">//【6.3】尝试获得上次安装时该权限对应的 BasePermission 对象！</span></span><br><span class="line">            BasePermission bp = permissionMap.get(p.info.name);</span><br><span class="line"></span><br><span class="line">            <span class="comment">//【6.4】允许系统应用来重新定义非系统权限！</span></span><br><span class="line">            <span class="comment">// 如果上次安装时的 BasePermission 不为 null，但是当前解析的 package 不是上次安装时该权限的定义者！</span></span><br><span class="line">            <span class="keyword">if</span> (bp != <span class="keyword">null</span> &amp;&amp; !Objects.equals(bp.sourcePackage, p.info.packageName)) &#123;</span><br><span class="line">                <span class="comment">//【6.4.1】判断上一次安装时，定义该权限的 package 是否是系统应用！</span></span><br><span class="line">                <span class="comment">// 如果是 currentOwnerIsSystem 为 true！</span></span><br><span class="line">                <span class="keyword">final</span> <span class="keyword">boolean</span> currentOwnerIsSystem = (bp.perm != <span class="keyword">null</span></span><br><span class="line">                        &amp;&amp; isSystemApp(bp.perm.owner));</span><br><span class="line">                </span><br><span class="line">                <span class="comment">// 如果当前解析的定义了该权限的 package 是系统 app，那么进入这里！     </span></span><br><span class="line">                <span class="keyword">if</span> (isSystemApp(p.owner)) &#123;</span><br><span class="line">                    <span class="comment">// 如果上次安装时，该权限是一个 BasePermission.TYPE_BUILTIN 系统权限，且 bp.perm 为 null，</span></span><br><span class="line">                    <span class="comment">// 即：拥有者未知，那么这里我们将这个 system package 分配给这个权限！</span></span><br><span class="line">                    <span class="keyword">if</span> (bp.type == BasePermission.TYPE_BUILTIN &amp;&amp; bp.perm == <span class="keyword">null</span>) &#123;</span><br><span class="line">                        bp.packageSetting = pkgSetting;</span><br><span class="line">                        bp.perm = p;</span><br><span class="line">                        bp.uid = pkg.applicationInfo.uid;</span><br><span class="line">                        bp.sourcePackage = p.info.packageName;</span><br><span class="line">                        p.info.flags |= PermissionInfo.FLAG_INSTALLED;</span><br><span class="line">                    </span><br><span class="line">                    <span class="comment">// 判断上一次安装时，定义该权限的 package 不是系统应用，而定义相同权限的</span></span><br><span class="line">                    <span class="comment">// 本次解析的 package 是系统应用，那么该权限会被系统应用重新定义！</span></span><br><span class="line">                    &#125; <span class="keyword">else</span> <span class="keyword">if</span> (!currentOwnerIsSystem) &#123;</span><br><span class="line">                        String msg = <span class="string">"New decl "</span> + p.owner + <span class="string">" of permission  "</span></span><br><span class="line">                                + p.info.name + <span class="string">" is system; overriding "</span> + bp.sourcePackage;</span><br><span class="line">                        reportSettingsProblem(Log.WARN, msg);</span><br><span class="line">                        <span class="comment">// 设置 bp 为 null！</span></span><br><span class="line">                        bp = <span class="keyword">null</span>;</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            <span class="comment">// 因为 bp 为 null，所谓我们会使用系统应用重新定义权限，如果是 permission-tree，会被添加到 </span></span><br><span class="line">            <span class="comment">// mSettings.mPermissionTrees 中！</span></span><br><span class="line">            <span class="keyword">if</span> (bp == <span class="keyword">null</span>) &#123;</span><br><span class="line">                bp = <span class="keyword">new</span> BasePermission(p.info.name, p.info.packageName,</span><br><span class="line">                        BasePermission.TYPE_NORMAL);</span><br><span class="line">                permissionMap.put(p.info.name, bp);</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="comment">// 重新分配拥有者为该系统应用！</span></span><br><span class="line">            <span class="keyword">if</span> (bp.perm == <span class="keyword">null</span>) &#123;</span><br><span class="line">                <span class="keyword">if</span> (bp.sourcePackage == <span class="keyword">null</span></span><br><span class="line">                        || bp.sourcePackage.equals(p.info.packageName)) &#123;</span><br><span class="line">                    BasePermission tree = findPermissionTreeLP(p.info.name);</span><br><span class="line">                    <span class="keyword">if</span> (tree == <span class="keyword">null</span></span><br><span class="line">                            || tree.sourcePackage.equals(p.info.packageName)) &#123;</span><br><span class="line">                        bp.packageSetting = pkgSetting;</span><br><span class="line">                        bp.perm = p;</span><br><span class="line">                        bp.uid = pkg.applicationInfo.uid;</span><br><span class="line">                        bp.sourcePackage = p.info.packageName;</span><br><span class="line">                        p.info.flags |= PermissionInfo.FLAG_INSTALLED;</span><br><span class="line">                        <span class="keyword">if</span> ((policyFlags&amp;PackageParser.PARSE_CHATTY) != <span class="number">0</span>) &#123;</span><br><span class="line">                            <span class="keyword">if</span> (r == <span class="keyword">null</span>) &#123;</span><br><span class="line">                                r = <span class="keyword">new</span> StringBuilder(<span class="number">256</span>);</span><br><span class="line">                            &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                                r.append(<span class="string">' '</span>);</span><br><span class="line">                            &#125;</span><br><span class="line">                            r.append(p.info.name);</span><br><span class="line">                        &#125;</span><br><span class="line">                    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                        Slog.w(TAG, <span class="string">"Permission "</span> + p.info.name + <span class="string">" from package "</span></span><br><span class="line">                                + p.info.packageName + <span class="string">" ignored: base tree "</span></span><br><span class="line">                                + tree.name + <span class="string">" is from package "</span></span><br><span class="line">                                + tree.sourcePackage);</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                    Slog.w(TAG, <span class="string">"Permission "</span> + p.info.name + <span class="string">" from package "</span></span><br><span class="line">                            + p.info.packageName + <span class="string">" ignored: original from "</span></span><br><span class="line">                            + bp.sourcePackage);</span><br><span class="line">                &#125;</span><br><span class="line">            &#125; <span class="keyword">else</span> <span class="keyword">if</span> ((policyFlags&amp;PackageParser.PARSE_CHATTY) != <span class="number">0</span>) &#123;</span><br><span class="line">                <span class="keyword">if</span> (r == <span class="keyword">null</span>) &#123;</span><br><span class="line">                    r = <span class="keyword">new</span> StringBuilder(<span class="number">256</span>);</span><br><span class="line">                &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                    r.append(<span class="string">' '</span>);</span><br><span class="line">                &#125;</span><br><span class="line">                r.append(<span class="string">"DUP:"</span>);</span><br><span class="line">                r.append(p.info.name);</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="comment">// 如果上次安装时的权限的定义者，就是本次解析的 package，设置 protectionLevel！</span></span><br><span class="line">            <span class="keyword">if</span> (bp.perm == p) &#123;</span><br><span class="line">                bp.protectionLevel = p.info.protectionLevel;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (r != <span class="keyword">null</span>) &#123;</span><br><span class="line">            <span class="keyword">if</span> (DEBUG_PACKAGE_SCANNING) Log.d(TAG, <span class="string">"  Permissions: "</span> + r);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        N = pkg.instrumentation.size();</span><br><span class="line">        r = <span class="keyword">null</span>;</span><br><span class="line">        <span class="keyword">for</span> (i=<span class="number">0</span>; i&lt;N; i++) &#123;</span><br><span class="line">            ... ... ... ...<span class="comment">// 这里省略掉，暂时不看！</span></span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">if</span> (r != <span class="keyword">null</span>) &#123;</span><br><span class="line">            <span class="keyword">if</span> (DEBUG_PACKAGE_SCANNING) Log.d(TAG, <span class="string">"  Instrumentation: "</span> + r);</span><br><span class="line">        &#125;</span><br><span class="line">        </span><br><span class="line">        <span class="comment">//【25】处理该 Package 中的 protectedBroadcasts 信息！</span></span><br><span class="line">        <span class="keyword">if</span> (pkg.protectedBroadcasts != <span class="keyword">null</span>) &#123;</span><br><span class="line">            N = pkg.protectedBroadcasts.size();</span><br><span class="line">            <span class="keyword">for</span> (i=<span class="number">0</span>; i&lt;N; i++) &#123;</span><br><span class="line">                mProtectedBroadcasts.add(pkg.protectedBroadcasts.get(i));</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">//【27】更新 PackageSettings 中的时间戳！</span></span><br><span class="line">        pkgSetting.setTimeStamp(scanFileTime);</span><br><span class="line"></span><br><span class="line">        <span class="comment">// Create idmap files for pairs of (packages, overlay packages).</span></span><br><span class="line">        <span class="comment">// Note: "android", ie framework-res.apk, is handled by native layers.</span></span><br><span class="line">        <span class="keyword">if</span> (pkg.mOverlayTarget != <span class="keyword">null</span>) &#123;</span><br><span class="line">            <span class="comment">// This is an overlay package.</span></span><br><span class="line">            <span class="keyword">if</span> (pkg.mOverlayTarget != <span class="keyword">null</span> &amp;&amp; !pkg.mOverlayTarget.equals(<span class="string">"android"</span>)) &#123;</span><br><span class="line">                <span class="keyword">if</span> (!mOverlays.containsKey(pkg.mOverlayTarget)) &#123;</span><br><span class="line">                    mOverlays.put(pkg.mOverlayTarget,</span><br><span class="line">                            <span class="keyword">new</span> ArrayMap&lt;String, PackageParser.Package&gt;());</span><br><span class="line">                &#125;</span><br><span class="line">                ArrayMap&lt;String, PackageParser.Package&gt; map = mOverlays.get(pkg.mOverlayTarget);</span><br><span class="line">                map.put(pkg.packageName, pkg);</span><br><span class="line">                PackageParser.Package orig = mPackages.get(pkg.mOverlayTarget);</span><br><span class="line">                <span class="keyword">if</span> (orig != <span class="keyword">null</span> &amp;&amp; !createIdmapForPackagePairLI(orig, pkg)) &#123;</span><br><span class="line">                    createIdmapFailed = <span class="keyword">true</span>;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125; <span class="keyword">else</span> <span class="keyword">if</span> (mOverlays.containsKey(pkg.packageName) &amp;&amp;</span><br><span class="line">                !pkg.packageName.equals(<span class="string">"android"</span>)) &#123;</span><br><span class="line">            <span class="comment">// This is a regular package, with one or more known overlay packages.</span></span><br><span class="line">            createIdmapsForPackageLI(pkg);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    Trace.traceEnd(TRACE_TAG_PACKAGE_MANAGER);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (createIdmapFailed) &#123;</span><br><span class="line">        <span class="keyword">throw</span> <span class="keyword">new</span> PackageManagerException(INSTALL_FAILED_UPDATE_INCOMPATIBLE,</span><br><span class="line">                <span class="string">"scanPackageLI failed to createIdmap"</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> pkg;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>到这里，对于扫描的 package 的数据就处理完了！</p>
<h6 id="3-2-1-7-1-1-Settings-getPackageLPw"><a href="#3-2-1-7-1-1-Settings-getPackageLPw" class="headerlink" title="3.2.1.7.1.1 Settings.getPackageLPw"></a>3.2.1.7.1.1 Settings.getPackageLPw</h6><p>上面又再次调用了 getPackageLPw 方法，注意根据参数传递：</p>
<ul>
<li>boolean add：传入的值为 false！</li>
<li>boolean allowInstall：传入的值为 true；</li>
</ul>
<p>该方法传入的参数的是本次扫描解析获得的 apk 的数据！</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 最终进入这个方法！</span></span><br><span class="line"><span class="function"><span class="keyword">private</span> PackageSetting <span class="title">getPackageLPw</span><span class="params">(String name, PackageSetting origPackage,</span></span></span><br><span class="line"><span class="function"><span class="params">        String realName, SharedUserSetting sharedUser, File codePath, File resourcePath,</span></span></span><br><span class="line"><span class="function"><span class="params">        String legacyNativeLibraryPathString, String primaryCpuAbiString,</span></span></span><br><span class="line"><span class="function"><span class="params">        String secondaryCpuAbiString, <span class="keyword">int</span> vc, <span class="keyword">int</span> pkgFlags, <span class="keyword">int</span> pkgPrivateFlags,</span></span></span><br><span class="line"><span class="function"><span class="params">        UserHandle installUser, <span class="keyword">boolean</span> add, <span class="keyword">boolean</span> allowInstall, String parentPackage,</span></span></span><br><span class="line"><span class="function"><span class="params">        List&lt;String&gt; childPackageNames)</span> </span>&#123;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">//【1】尝试获得之前的安装数据！</span></span><br><span class="line">    PackageSetting p = mPackages.get(name);</span><br><span class="line">    UserManagerService userManager = UserManagerService.getInstance();</span><br><span class="line">    </span><br><span class="line">    <span class="comment">//【2】如果 p 不为 null，说明这个 apk 之前就存在！</span></span><br><span class="line">    <span class="comment">// 下面就要比较 codePath！</span></span><br><span class="line">    <span class="keyword">if</span> (p != <span class="keyword">null</span>) &#123;</span><br><span class="line">        p.primaryCpuAbiString = primaryCpuAbiString;</span><br><span class="line">        p.secondaryCpuAbiString = secondaryCpuAbiString;</span><br><span class="line">        <span class="keyword">if</span> (childPackageNames != <span class="keyword">null</span>) &#123;</span><br><span class="line">            p.childPackageNames = <span class="keyword">new</span> ArrayList&lt;&gt;(childPackageNames);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (!p.codePath.equals(codePath)) &#123;</span><br><span class="line">            <span class="keyword">if</span> ((p.pkgFlags &amp; ApplicationInfo.FLAG_SYSTEM) != <span class="number">0</span>) &#123;</span><br><span class="line">                <span class="comment">// 这是被更新的 system app 的情况，此时在 system 分区和 app 分区都会有该 apk，我们只需要</span></span><br><span class="line">                <span class="comment">// 将高 versionCode 的 apk 显示出来即可！</span></span><br><span class="line">                Slog.w(PackageManagerService.TAG, <span class="string">"Trying to update system app code path from "</span></span><br><span class="line">                        + p.codePathString + <span class="string">" to "</span> + codePath.toString());</span><br><span class="line">            &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                <span class="comment">// 这种情况是说明这个 system apk 的路径发生了变化！</span></span><br><span class="line">                <span class="comment">// 或者说这个应用是一个三方应用！</span></span><br><span class="line">                Slog.i(PackageManagerService.TAG, <span class="string">"Package "</span> + name + <span class="string">" codePath changed from "</span></span><br><span class="line">                        + p.codePath + <span class="string">" to "</span> + codePath + <span class="string">"; Retaining data and using new"</span>);</span><br><span class="line">                <span class="comment">// 如果当前扫描的是 system apk，并且其不是被覆盖安装的，即 getDisabledSystemPkgLPr 为 null；</span></span><br><span class="line">                <span class="comment">// 更新所有用户下的安装状态为 true！</span></span><br><span class="line">                <span class="keyword">if</span> ((pkgFlags &amp; ApplicationInfo.FLAG_SYSTEM) != <span class="number">0</span> &amp;&amp;</span><br><span class="line">                        getDisabledSystemPkgLPr(name) == <span class="keyword">null</span>) &#123;</span><br><span class="line"></span><br><span class="line">                    List&lt;UserInfo&gt; allUserInfos = getAllUsers();</span><br><span class="line">                    <span class="keyword">if</span> (allUserInfos != <span class="keyword">null</span>) &#123;</span><br><span class="line">                        <span class="keyword">for</span> (UserInfo userInfo : allUserInfos) &#123;</span><br><span class="line">                            p.setInstalled(<span class="keyword">true</span>, userInfo.id);</span><br><span class="line">                        &#125;</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;</span><br><span class="line"></span><br><span class="line">                p.legacyNativeLibraryPathString = legacyNativeLibraryPathString;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        </span><br><span class="line">        <span class="keyword">if</span> (p.sharedUser != sharedUser) &#123; </span><br><span class="line">            <span class="comment">// 如果共享 uid 不匹配，就需要创建新的 PackageSetting 替换以前的！</span></span><br><span class="line">            PackageManagerService.reportSettingsProblem(Log.WARN,</span><br><span class="line">                    <span class="string">"Package "</span> + name + <span class="string">" shared user changed from "</span></span><br><span class="line">                    + (p.sharedUser != <span class="keyword">null</span> ? p.sharedUser.name : <span class="string">"&lt;nothing&gt;"</span>)</span><br><span class="line">                    + <span class="string">" to "</span></span><br><span class="line">                    + (sharedUser != <span class="keyword">null</span> ? sharedUser.name : <span class="string">"&lt;nothing&gt;"</span>)</span><br><span class="line">                    + <span class="string">"; replacing with new"</span>);</span><br><span class="line">            p = <span class="keyword">null</span>;</span><br><span class="line">            </span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            <span class="comment">// 如果共享 uid 匹配，或者没有使用共享，进入这里！</span></span><br><span class="line">            <span class="comment">// 如果我们扫描的是一个 system 分区的 apk,  无论其之前是否在 data 分区存在！</span></span><br><span class="line">            <span class="comment">// 我们都会给上一次的安装信息设置 FLAG_SYSTEM 和 PRIVATE_FLAG_PRIVILEGED 标志位；</span></span><br><span class="line">            <span class="comment">// 这里和【3.2.1】【B】有关联</span></span><br><span class="line">            p.pkgFlags |= pkgFlags &amp; ApplicationInfo.FLAG_SYSTEM;</span><br><span class="line">            p.pkgPrivateFlags |= pkgPrivateFlags &amp; ApplicationInfo.PRIVATE_FLAG_PRIVILEGED;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">//【3】处理需要重新创建 PackageSetting 的情况！</span></span><br><span class="line">    <span class="comment">// 如果 p 为 null，说明这个系统 apk 是通过 OTA 升级方式新添加的，或者 shareUserId 不匹配！</span></span><br><span class="line">    <span class="comment">// 如果有源包，就用源包的命名，创建新的 PackageSetting 对象，并源包的数据来初始化！</span></span><br><span class="line">    <span class="comment">// 没有源包，就用当前包的命名，创建新的 PackageSetting 对象！</span></span><br><span class="line">    <span class="keyword">if</span> (p == <span class="keyword">null</span>) &#123;</span><br><span class="line">        <span class="keyword">if</span> (origPackage != <span class="keyword">null</span>) &#123;</span><br><span class="line">            <span class="comment">//【3.1】源包不为 null 的情况，进入这里，使用本次扫描的信息创建新的 PackageSetting！</span></span><br><span class="line">            p = <span class="keyword">new</span> PackageSetting(origPackage.name, name, codePath, resourcePath,</span><br><span class="line">                    legacyNativeLibraryPathString, primaryCpuAbiString, secondaryCpuAbiString,</span><br><span class="line">                    <span class="keyword">null</span> <span class="comment">/* cpuAbiOverrideString */</span>, vc, pkgFlags, pkgPrivateFlags,</span><br><span class="line">                    parentPackage, childPackageNames);</span><br><span class="line"></span><br><span class="line">            <span class="keyword">if</span> (PackageManagerService.DEBUG_UPGRADE) Log.v(PackageManagerService.TAG, <span class="string">"Package "</span></span><br><span class="line">                    + name + <span class="string">" is adopting original package "</span> + origPackage.name);</span><br><span class="line"></span><br><span class="line">            PackageSignatures s = p.signatures;</span><br><span class="line">            p.copyFrom(origPackage);</span><br><span class="line">            p.signatures = s;</span><br><span class="line">            p.sharedUser = origPackage.sharedUser;</span><br><span class="line">            p.appId = origPackage.appId;</span><br><span class="line">            p.origPackage = origPackage;</span><br><span class="line">            p.getPermissionsState().copyFrom(origPackage.getPermissionsState());</span><br><span class="line">            </span><br><span class="line">            <span class="comment">// 重命名为源包的名字后，将新旧名字加入 mRenamedPackages 集合！</span></span><br><span class="line">            mRenamedPackages.put(name, origPackage.name);</span><br><span class="line">            name = origPackage.name;</span><br><span class="line"></span><br><span class="line">            p.setTimeStamp(codePath.lastModified());</span><br><span class="line"></span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            <span class="comment">//【3.2】源包为 null 的情况，进入这里，使用本次扫描的信息创建新的 PackageSetting！</span></span><br><span class="line">            p = <span class="keyword">new</span> PackageSetting(name, realName, codePath, resourcePath,</span><br><span class="line">                    legacyNativeLibraryPathString, primaryCpuAbiString, secondaryCpuAbiString,</span><br><span class="line">                    <span class="keyword">null</span> <span class="comment">/* cpuAbiOverrideString */</span>, vc, pkgFlags, pkgPrivateFlags,</span><br><span class="line">                    parentPackage, childPackageNames);</span><br><span class="line"></span><br><span class="line">            p.setTimeStamp(codePath.lastModified());</span><br><span class="line">            p.sharedUser = sharedUser;</span><br><span class="line"></span><br><span class="line">            <span class="comment">// 系统 apk 不会进入这个分支！</span></span><br><span class="line">            <span class="keyword">if</span> ((pkgFlags&amp;ApplicationInfo.FLAG_SYSTEM) == <span class="number">0</span>) &#123;</span><br><span class="line">                <span class="keyword">if</span> (DEBUG_STOPPED) &#123;</span><br><span class="line">                    RuntimeException e = <span class="keyword">new</span> RuntimeException(<span class="string">"here"</span>);</span><br><span class="line">                    e.fillInStackTrace();</span><br><span class="line">                    Slog.i(PackageManagerService.TAG, <span class="string">"Stopping package "</span> + name, e);</span><br><span class="line">                &#125;</span><br><span class="line">                List&lt;UserInfo&gt; users = getAllUsers();</span><br><span class="line">                <span class="keyword">final</span> <span class="keyword">int</span> installUserId = installUser != <span class="keyword">null</span> ? installUser.getIdentifier() : <span class="number">0</span>;</span><br><span class="line">                <span class="keyword">if</span> (users != <span class="keyword">null</span> &amp;&amp; allowInstall) &#123;</span><br><span class="line">                    <span class="keyword">for</span> (UserInfo user : users) &#123;</span><br><span class="line">                        <span class="keyword">final</span> <span class="keyword">boolean</span> installed = installUser == <span class="keyword">null</span></span><br><span class="line">                                || (installUserId == UserHandle.USER_ALL</span><br><span class="line">                                    &amp;&amp; !isAdbInstallDisallowed(userManager, user.id))</span><br><span class="line">                                || installUserId == user.id;</span><br><span class="line">                        p.setUserState(user.id, <span class="number">0</span>, COMPONENT_ENABLED_STATE_DEFAULT,</span><br><span class="line">                                installed,</span><br><span class="line">                                <span class="keyword">true</span>, <span class="comment">// stopped,</span></span><br><span class="line">                                <span class="keyword">true</span>, <span class="comment">// notLaunched</span></span><br><span class="line">                                <span class="keyword">false</span>, <span class="comment">// hidden</span></span><br><span class="line">                                <span class="keyword">false</span>, <span class="comment">// suspended</span></span><br><span class="line">                                <span class="keyword">null</span>, <span class="keyword">null</span>, <span class="keyword">null</span>,</span><br><span class="line">                                <span class="keyword">false</span>, <span class="comment">// blockUninstall</span></span><br><span class="line">                                INTENT_FILTER_DOMAIN_VERIFICATION_STATUS_UNDEFINED, <span class="number">0</span>);</span><br><span class="line">                        writePackageRestrictionsLPr(user.id);</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">            </span><br><span class="line">            <span class="comment">// 设置系统 package 的 appid</span></span><br><span class="line">            <span class="comment">// 如果是共享用户 id，那 appId 就是共享用户 id；</span></span><br><span class="line">            <span class="comment">// 如果不是共享用户 id，就看系统 app 是否被覆盖更新过，如果有，就克隆更新前的旧数据，初始化 appId，权限等等</span></span><br><span class="line">            <span class="comment">// 如果系统 app 没有被覆盖更新过，就创建新的 uid！</span></span><br><span class="line">            <span class="keyword">if</span> (sharedUser != <span class="keyword">null</span>) &#123;</span><br><span class="line">                p.appId = sharedUser.userId;</span><br><span class="line">                </span><br><span class="line">            &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                PackageSetting dis = mDisabledSysPackages.get(name);</span><br><span class="line">                <span class="keyword">if</span> (dis != <span class="keyword">null</span>) &#123;</span><br><span class="line">                </span><br><span class="line">                    <span class="keyword">if</span> (dis.signatures.mSignatures != <span class="keyword">null</span>) &#123;</span><br><span class="line">                        p.signatures.mSignatures = dis.signatures.mSignatures.clone();</span><br><span class="line">                    &#125;</span><br><span class="line">                    p.appId = dis.appId;</span><br><span class="line">                    </span><br><span class="line">                    p.getPermissionsState().copyFrom(dis.getPermissionsState());</span><br><span class="line">                    </span><br><span class="line">                    List&lt;UserInfo&gt; users = getAllUsers();</span><br><span class="line">                    <span class="keyword">if</span> (users != <span class="keyword">null</span>) &#123;</span><br><span class="line">                        <span class="keyword">for</span> (UserInfo user : users) &#123;</span><br><span class="line">                            <span class="keyword">int</span> userId = user.id;</span><br><span class="line">                            p.setDisabledComponentsCopy(</span><br><span class="line">                                    dis.getDisabledComponents(userId), userId);</span><br><span class="line">                            p.setEnabledComponentsCopy(</span><br><span class="line">                                    dis.getEnabledComponents(userId), userId);</span><br><span class="line">                        &#125;</span><br><span class="line">                    &#125;</span><br><span class="line">                    </span><br><span class="line">                    <span class="comment">// 将这个新的 PackageSetting 根据 uid 添加到 mUserIds 或者 mOtherUserIds 中！</span></span><br><span class="line">                    addUserIdLPw(p.appId, p, name);</span><br><span class="line">                &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                </span><br><span class="line">                    <span class="comment">// 分配一个新的 uid，并将映射关系保存到 mUserIds 中！</span></span><br><span class="line">                    p.appId = newUserIdLPw(p);</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (p.appId &lt; <span class="number">0</span>) &#123;</span><br><span class="line">            PackageManagerService.reportSettingsProblem(Log.WARN,</span><br><span class="line">                    <span class="string">"Package "</span> + name + <span class="string">" could not be assigned a valid uid"</span>);</span><br><span class="line">            <span class="keyword">return</span> <span class="keyword">null</span>;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (add) &#123; <span class="comment">// add 为 false，这里不添加，添加的操作在 PMS.scanPackageDirtyLI 方法中！</span></span><br><span class="line">            addPackageSettingLPw(p, name, sharedUser);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        <span class="keyword">if</span> (installUser != <span class="keyword">null</span> &amp;&amp; allowInstall) &#123;</span><br><span class="line">            <span class="comment">// The caller has explicitly specified the user they want this</span></span><br><span class="line">            <span class="comment">// package installed for, and the package already exists.</span></span><br><span class="line">            <span class="comment">// Make sure it conforms to the new request.</span></span><br><span class="line">            List&lt;UserInfo&gt; users = getAllUsers();</span><br><span class="line">            <span class="keyword">if</span> (users != <span class="keyword">null</span>) &#123;</span><br><span class="line">                <span class="keyword">for</span> (UserInfo user : users) &#123;</span><br><span class="line">                    <span class="keyword">if</span> ((installUser.getIdentifier() == UserHandle.USER_ALL</span><br><span class="line">                                &amp;&amp; !isAdbInstallDisallowed(userManager, user.id))</span><br><span class="line">                            || installUser.getIdentifier() == user.id) &#123;</span><br><span class="line">                        <span class="keyword">boolean</span> installed = p.getInstalled(user.id);</span><br><span class="line">                        <span class="keyword">if</span> (!installed) &#123;</span><br><span class="line">                            p.setInstalled(<span class="keyword">true</span>, user.id);</span><br><span class="line">                            writePackageRestrictionsLPr(user.id);</span><br><span class="line">                        &#125;</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">//【4】返回查到或者是创建的新的系统 package 对应的 PackageSetting 对象！</span></span><br><span class="line">    <span class="keyword">return</span> p;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h6 id="3-2-1-7-1-2-Settings-insertPackageSettingLPw"><a href="#3-2-1-7-1-2-Settings-insertPackageSettingLPw" class="headerlink" title="3.2.1.7.1.2 Settings.insertPackageSettingLPw"></a>3.2.1.7.1.2 Settings.insertPackageSettingLPw</h6><p>该方法会将 PackageSetting 保存到 mUserIds 或 mOtherIds 中去，同时用本次扫描的的 Package 更新 PackageSetting！</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">insertPackageSettingLPw</span><span class="params">(PackageSetting p, PackageParser.Package pkg)</span> </span>&#123;</span><br><span class="line">    p.pkg = pkg; <span class="comment">//【1】建立引用关系！</span></span><br><span class="line">    <span class="comment">// pkg.mSetEnabled = p.getEnabled(userId);</span></span><br><span class="line">    <span class="comment">// pkg.mSetStopped = p.getStopped(userId);</span></span><br><span class="line">    <span class="keyword">final</span> String volumeUuid = pkg.applicationInfo.volumeUuid;</span><br><span class="line">    <span class="keyword">final</span> String codePath = pkg.applicationInfo.getCodePath();</span><br><span class="line">    <span class="keyword">final</span> String resourcePath = pkg.applicationInfo.getResourcePath();</span><br><span class="line">    <span class="keyword">final</span> String legacyNativeLibraryPath = pkg.applicationInfo.nativeLibraryRootDir;</span><br><span class="line">    <span class="comment">// Update volume if needed</span></span><br><span class="line">    <span class="keyword">if</span> (!Objects.equals(volumeUuid, p.volumeUuid)) &#123;</span><br><span class="line">        Slog.w(PackageManagerService.TAG, <span class="string">"Volume for "</span> + p.pkg.packageName +</span><br><span class="line">                <span class="string">" changing from "</span> + p.volumeUuid + <span class="string">" to "</span> + volumeUuid);</span><br><span class="line">        p.volumeUuid = volumeUuid;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// Update code path if needed</span></span><br><span class="line">    <span class="keyword">if</span> (!Objects.equals(codePath, p.codePathString)) &#123;</span><br><span class="line">        Slog.w(PackageManagerService.TAG, <span class="string">"Code path for "</span> + p.pkg.packageName +</span><br><span class="line">                <span class="string">" changing from "</span> + p.codePathString + <span class="string">" to "</span> + codePath);</span><br><span class="line">        p.codePath = <span class="keyword">new</span> File(codePath);</span><br><span class="line">        p.codePathString = codePath;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">//Update resource path if needed</span></span><br><span class="line">    <span class="keyword">if</span> (!Objects.equals(resourcePath, p.resourcePathString)) &#123;</span><br><span class="line">        Slog.w(PackageManagerService.TAG, <span class="string">"Resource path for "</span> + p.pkg.packageName +</span><br><span class="line">                <span class="string">" changing from "</span> + p.resourcePathString + <span class="string">" to "</span> + resourcePath);</span><br><span class="line">        p.resourcePath = <span class="keyword">new</span> File(resourcePath);</span><br><span class="line">        p.resourcePathString = resourcePath;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// Update the native library paths if needed</span></span><br><span class="line">    <span class="keyword">if</span> (!Objects.equals(legacyNativeLibraryPath, p.legacyNativeLibraryPathString)) &#123;</span><br><span class="line">        p.legacyNativeLibraryPathString = legacyNativeLibraryPath;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// Update the required Cpu Abi</span></span><br><span class="line">    p.primaryCpuAbiString = pkg.applicationInfo.primaryCpuAbi;</span><br><span class="line">    p.secondaryCpuAbiString = pkg.applicationInfo.secondaryCpuAbi;</span><br><span class="line">    p.cpuAbiOverrideString = pkg.cpuAbiOverride;</span><br><span class="line">    <span class="comment">// Update version code if needed</span></span><br><span class="line">    <span class="keyword">if</span> (pkg.mVersionCode != p.versionCode) &#123;</span><br><span class="line">        p.versionCode = pkg.mVersionCode;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// Update signatures if needed.</span></span><br><span class="line">    <span class="keyword">if</span> (p.signatures.mSignatures == <span class="keyword">null</span>) &#123;</span><br><span class="line">        p.signatures.assignSignatures(pkg.mSignatures);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// Update flags if needed.</span></span><br><span class="line">    <span class="keyword">if</span> (pkg.applicationInfo.flags != p.pkgFlags) &#123;</span><br><span class="line">        p.pkgFlags = pkg.applicationInfo.flags;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// If this app defines a shared user id initialize</span></span><br><span class="line">    <span class="comment">// the shared user signatures as well.</span></span><br><span class="line">    <span class="keyword">if</span> (p.sharedUser != <span class="keyword">null</span> &amp;&amp; p.sharedUser.signatures.mSignatures == <span class="keyword">null</span>) &#123;</span><br><span class="line">        p.sharedUser.signatures.assignSignatures(pkg.mSignatures);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">//【2】将 PackageSetting 保存到 mUserIds 或则会 mOtherIds 中去</span></span><br><span class="line">    addPackageSettingLPw(p, pkg.packageName, p.sharedUser);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>这里就不多说了！</p>
<p>######3.2.1.7.1.3 ActivityIntentResolver.addActivity - 添加 activity</p>
<h4 id="3-2-1-8-Settings-disableSystemPackageLPw"><a href="#3-2-1-8-Settings-disableSystemPackageLPw" class="headerlink" title="3.2.1.8 Settings.disableSystemPackageLPw"></a>3.2.1.8 Settings.disableSystemPackageLPw</h4><p>当需要隐藏掉 system app 的时候，会调用 disableSystemPackageLPw 方法：</p>
<p>参数传递：</p>
<ul>
<li>boolean replaced：true！</li>
</ul>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">boolean</span> <span class="title">disableSystemPackageLPw</span><span class="params">(String name, <span class="keyword">boolean</span> replaced)</span> </span>&#123;</span><br><span class="line">    <span class="comment">// 判断一下，这个系统 apk 是否已经安装，没有安装就不用 disable！</span></span><br><span class="line">    <span class="keyword">final</span> PackageSetting p = mPackages.get(name);</span><br><span class="line">    <span class="keyword">if</span>(p == <span class="keyword">null</span>) &#123;</span><br><span class="line">        Log.w(PackageManagerService.TAG, <span class="string">"Package "</span> + name + <span class="string">" is not an installed package"</span>);</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">false</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// 系统 apk 已经安装了，并且之前没有被覆盖更新过，</span></span><br><span class="line">    <span class="comment">// 且之前没有添加 ApplicationInfo.FLAG_UPDATED_SYSTEM_APP 标签！</span></span><br><span class="line">    <span class="keyword">final</span> PackageSetting dp = mDisabledSysPackages.get(name);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (dp == <span class="keyword">null</span> &amp;&amp; p.pkg != <span class="keyword">null</span> &amp;&amp; p.pkg.isSystemApp() &amp;&amp; !p.pkg.isUpdatedSystemApp()) &#123;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span>((p.pkg != <span class="keyword">null</span>) &amp;&amp; (p.pkg.applicationInfo != <span class="keyword">null</span>)) &#123;</span><br><span class="line">            p.pkg.applicationInfo.flags |= ApplicationInfo.FLAG_UPDATED_SYSTEM_APP;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">// 将其添加到 mDisabledSysPackages 列表中！</span></span><br><span class="line">        mDisabledSysPackages.put(name, p);</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (replaced) &#123; <span class="comment">// 这里为 true</span></span><br><span class="line">            <span class="comment">//【3.2.1.8.1】为更新的后的应用重新创建一个 PackageSetting，添加到 mPackages 中</span></span><br><span class="line">            <span class="comment">// 因为旧的 PackageSetting 被添加到了 mDisabledSysPackages！</span></span><br><span class="line">            PackageSetting newp = <span class="keyword">new</span> PackageSetting(p);</span><br><span class="line">            replacePackageLPw(name, newp);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">true</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">false</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>这里面会设置到 pkgFlags 和 pkgPrivateFlags 的设置：<br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">setFlags</span><span class="params">(<span class="keyword">int</span> pkgFlags)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">this</span>.pkgFlags = pkgFlags</span><br><span class="line">            &amp; (ApplicationInfo.FLAG_SYSTEM</span><br><span class="line">                    | ApplicationInfo.FLAG_EXTERNAL_STORAGE);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">setPrivateFlags</span><span class="params">(<span class="keyword">int</span> pkgPrivateFlags)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">this</span>.pkgPrivateFlags = pkgPrivateFlags</span><br><span class="line">            &amp; (ApplicationInfo.PRIVATE_FLAG_PRIVILEGED</span><br><span class="line">            | ApplicationInfo.PRIVATE_FLAG_FORWARD_LOCK</span><br><span class="line">            | ApplicationInfo.PRIVATE_FLAG_REQUIRED_FOR_SYSTEM_USER);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>到这里 system 分区的扫描流程就结束了！</p>
<h5 id="3-2-1-8-1-Settings-replacePackageLPw"><a href="#3-2-1-8-1-Settings-replacePackageLPw" class="headerlink" title="3.2.1.8.1 Settings.replacePackageLPw"></a>3.2.1.8.1 Settings.replacePackageLPw</h5><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">replacePackageLPw</span><span class="params">(String name, PackageSetting newp)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">final</span> PackageSetting p = mPackages.get(name);</span><br><span class="line">    <span class="keyword">if</span> (p != <span class="keyword">null</span>) &#123;</span><br><span class="line">        <span class="keyword">if</span> (p.sharedUser != <span class="keyword">null</span>) &#123;</span><br><span class="line">            p.sharedUser.removePackage(p);</span><br><span class="line">            p.sharedUser.addPackage(newp);</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            replaceUserIdLPw(p.appId, newp);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    mPackages.put(name, newp);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>更新 mPackages 中的数据！</p>
<h6 id="3-2-1-8-1-1-Settings-replaceUserIdLPw"><a href="#3-2-1-8-1-1-Settings-replaceUserIdLPw" class="headerlink" title="3.2.1.8.1.1 Settings.replaceUserIdLPw"></a>3.2.1.8.1.1 Settings.replaceUserIdLPw</h6><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">replaceUserIdLPw</span><span class="params">(<span class="keyword">int</span> uid, Object obj)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">if</span> (uid &gt;= Process.FIRST_APPLICATION_UID) &#123;</span><br><span class="line">        <span class="keyword">final</span> <span class="keyword">int</span> N = mUserIds.size();</span><br><span class="line">        <span class="keyword">final</span> <span class="keyword">int</span> index = uid - Process.FIRST_APPLICATION_UID;</span><br><span class="line">        <span class="keyword">if</span> (index &lt; N) mUserIds.set(index, obj);</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        mOtherUserIds.put(uid, obj);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>更新 mOtherUserIds 和 mUserIds 中的数据！</p>
<h2 id="3-3-扫描总结"><a href="#3-3-扫描总结" class="headerlink" title="3.3 扫描总结"></a>3.3 扫描总结</h2><p>下面我们来总结下扫描过程：</p>
<h3 id="3-3-1-扫描过程总结"><a href="#3-3-1-扫描过程总结" class="headerlink" title="3.3.1 扫描过程总结"></a>3.3.1 扫描过程总结</h3><p>接下来，用一张图来总结一下，扫描的过程：<br><img src="http://static.zybuluo.com/Coolqi/dwx0jucpjl1q26m8u7i735wn/%E6%89%AB%E6%8F%8F%E7%B3%BB%E7%BB%9F%E7%9B%AE%E5%BD%95.png" alt="扫描系统目录.png-116.5kB"></p>
<p>流程很清晰了，不多说。</p>
<h3 id="3-3-2-数据关系总结"><a href="#3-3-2-数据关系总结" class="headerlink" title="3.3.2 数据关系总结"></a>3.3.2 数据关系总结</h3><p>下面我们来看看解析获得的数据之间的关系：<br><img src="http://static.zybuluo.com/Coolqi/lxyqc0fppux003uv2ynu4c5d/%E6%89%AB%E6%8F%8F%E6%95%B0%E6%8D%AE%E5%85%B3%E7%B3%BB%E5%9B%BE.png" alt="扫描数据关系图.png-354.6kB"></p>
<p>这个图展示了解析得到的一个 Package 对象在内存中的结果。</p>
<ul>
<li>组件的基类是 Component，AndroidManifest.xml 中定义的组件 activity，service，provider，permission等，都继承了 Component；</li>
<li>activity，service 这样的组件，都可以配置 <intent-filter> 属性，在 pms 中体现在 IntentInfo 这个数据结构中，从上图可以看到，每一种组件所依赖的 intentInfo 不同，Component 和 IntentInfo 之间的依赖关系采用了桥接模式，通过泛型实现！</intent-filter></li>
</ul>
<h1 id="4-系统目录扫描-收尾阶段"><a href="#4-系统目录扫描-收尾阶段" class="headerlink" title="4 系统目录扫描 - 收尾阶段"></a>4 系统目录扫描 - 收尾阶段</h1><p>接下来，是收集可能被删掉的系统应用包！<br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//【×】用于收集可能已经被删掉的系统应用包！</span></span><br><span class="line"><span class="keyword">final</span> List&lt;String&gt; possiblyDeletedUpdatedSystemApps = <span class="keyword">new</span> ArrayList&lt;String&gt;();</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> (!mOnlyCore) &#123;</span><br><span class="line">    <span class="comment">// 遍历上次安装的所有的 package！</span></span><br><span class="line">    Iterator&lt;PackageSetting&gt; psit = mSettings.mPackages.values().iterator();</span><br><span class="line">    <span class="keyword">while</span> (psit.hasNext()) &#123;</span><br><span class="line">        PackageSetting ps = psit.next();</span><br><span class="line">        <span class="comment">//【×】如果是非系统应用，跳过，如果是被覆盖安装！</span></span><br><span class="line">        <span class="keyword">if</span> ((ps.pkgFlags &amp; ApplicationInfo.FLAG_SYSTEM) == <span class="number">0</span>) &#123;</span><br><span class="line">            <span class="keyword">continue</span>;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">final</span> PackageParser.Package scannedPkg = mPackages.get(ps.name);</span><br><span class="line">        <span class="keyword">if</span> (scannedPkg != <span class="keyword">null</span>) &#123;</span><br><span class="line">            <span class="comment">//【4.1】如果系统应用包不仅被扫描过（在mPackages中），并且在不可用列表中！</span></span><br><span class="line">            <span class="comment">// 说明一定是通过覆盖安装的，移除之前扫描的结果，保证之前用户安装的应用能够被扫描！</span></span><br><span class="line">            <span class="keyword">if</span> (mSettings.isDisabledSystemPackageLPr(ps.name)) &#123;</span><br><span class="line">                logCriticalInfo(Log.WARN, <span class="string">"Expecting better updated system app for "</span></span><br><span class="line">                        + ps.name + <span class="string">"; removing system app.  Last known codePath="</span></span><br><span class="line">                        + ps.codePathString + <span class="string">", installStatus="</span> + ps.installStatus</span><br><span class="line">                        + <span class="string">", versionCode="</span> + ps.versionCode + <span class="string">"; scanned versionCode="</span></span><br><span class="line">                        + scannedPkg.mVersionCode);</span><br><span class="line">                </span><br><span class="line">                <span class="comment">//【4.2】将之前的扫描结果移除！</span></span><br><span class="line">                removePackageLI(scannedPkg, <span class="keyword">true</span>);</span><br><span class="line">                <span class="comment">// 将这包添加到 mExpectingBetter 列表中！</span></span><br><span class="line">                mExpectingBetter.put(ps.name, ps.codePath);</span><br><span class="line">            &#125;</span><br><span class="line">            </span><br><span class="line">            <span class="comment">// 跳出循环，确保不会被删掉！</span></span><br><span class="line">            <span class="keyword">continue</span>;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (!mSettings.isDisabledSystemPackageLPr(ps.name)) &#123;</span><br><span class="line">            <span class="comment">// 如果系统应用包没有被扫描，并且他也不在不可用的列表中，说明其没有被更新过，</span></span><br><span class="line">            <span class="comment">// 可能被删除了，也可能被移动到了 data 分区，那就清楚其前面的数据！</span></span><br><span class="line">            <span class="comment">// 如果移动到了 data 分区，那就在扫描 data 的过程中处理！</span></span><br><span class="line">            psit.remove();</span><br><span class="line">            logCriticalInfo(Log.WARN, <span class="string">"System package "</span> + ps.name</span><br><span class="line">                    + <span class="string">" no longer exists; it's data will be wiped"</span>);</span><br><span class="line"></span><br><span class="line">        &#125; <span class="keyword">else</span> &#123; </span><br><span class="line">            <span class="comment">// 如果系统应用包没有被扫描，却在不可用的列表中，说明其被更新过了，但是 apk 被删除了</span></span><br><span class="line">            <span class="comment">// 就将他加入到 possiblyDeletedUpdatedSystemApps 集合中！</span></span><br><span class="line">            <span class="keyword">final</span> PackageSetting disabledPs = mSettings.getDisabledSystemPkgLPr(ps.name);</span><br><span class="line">            <span class="keyword">if</span> (disabledPs.codePath == <span class="keyword">null</span> || !disabledPs.codePath.exists()) &#123;</span><br><span class="line">                possiblyDeletedUpdatedSystemApps.add(ps.name);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">//【×】清理所有安装不完全的应用包！</span></span><br><span class="line">ArrayList&lt;PackageSetting&gt; deletePkgsList = mSettings.getListOfIncompleteInstallPackagesLPr();</span><br><span class="line"><span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; deletePkgsList.size(); i++) &#123;</span><br><span class="line">    <span class="keyword">final</span> String packageName = deletePkgsList.get(i).name;</span><br><span class="line">    logCriticalInfo(Log.WARN, <span class="string">"Cleaning up incompletely installed app: "</span> + packageName);</span><br><span class="line">    <span class="keyword">synchronized</span> (mPackages) &#123;</span><br><span class="line">        mSettings.removePackageLPw(packageName);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 移除临时文件</span></span><br><span class="line">deleteTempPackageFiles();</span><br><span class="line"></span><br><span class="line"><span class="comment">// 移除没有和应用程序包相关联的共享用户 id！</span></span><br><span class="line">mSettings.pruneSharedUsersLPw();</span><br></pre></td></tr></table></figure></p>
<p>对于已经被扫描到的系统 app，如果发现他存在于被更新过的列表中，说明这个系统 apk 在 data 分区有更新的版本了，那就需要把之前扫描的清楚掉，这样我们要确保在扫描 data 分区时，data 分区的 app 能够显示出来！！</p>
<h2 id="4-1-PMS-isDisabledSystemPackageLPr"><a href="#4-1-PMS-isDisabledSystemPackageLPr" class="headerlink" title="4.1 PMS.isDisabledSystemPackageLPr"></a>4.1 PMS.isDisabledSystemPackageLPr</h2><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">boolean</span> <span class="title">isDisabledSystemPackageLPr</span><span class="params">(String name)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">return</span> mDisabledSysPackages.containsKey(name);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h2 id="4-2-PMS-removePackageLI"><a href="#4-2-PMS-removePackageLI" class="headerlink" title="4.2 PMS.removePackageLI"></a>4.2 PMS.removePackageLI</h2><p>removePackageLI 会移除指定 pacakge 的扫描结果！</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">removePackageLI</span><span class="params">(PackageParser.Package pkg, <span class="keyword">boolean</span> chatty)</span> </span>&#123;</span><br><span class="line">    <span class="comment">// Remove the parent package setting</span></span><br><span class="line">    PackageSetting ps = (PackageSetting) pkg.mExtras;</span><br><span class="line">    <span class="keyword">if</span> (ps != <span class="keyword">null</span>) &#123;</span><br><span class="line">        removePackageLI(ps, chatty);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// Remove the child package setting</span></span><br><span class="line">    <span class="keyword">final</span> <span class="keyword">int</span> childCount = (pkg.childPackages != <span class="keyword">null</span>) ? pkg.childPackages.size() : <span class="number">0</span>;</span><br><span class="line">    <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; childCount; i++) &#123;</span><br><span class="line">        PackageParser.Package childPkg = pkg.childPackages.get(i);</span><br><span class="line">        ps = (PackageSetting) childPkg.mExtras;</span><br><span class="line">        <span class="keyword">if</span> (ps != <span class="keyword">null</span>) &#123;</span><br><span class="line">            removePackageLI(ps, chatty);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">removePackageLI</span><span class="params">(PackageSetting ps, <span class="keyword">boolean</span> chatty)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">if</span> (DEBUG_INSTALL) &#123;</span><br><span class="line">        <span class="keyword">if</span> (chatty)</span><br><span class="line">            Log.d(TAG, <span class="string">"Removing package "</span> + ps.name);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// writer</span></span><br><span class="line">    <span class="keyword">synchronized</span> (mPackages) &#123;</span><br><span class="line">        mPackages.remove(ps.name);</span><br><span class="line">        <span class="keyword">final</span> PackageParser.Package pkg = ps.pkg;</span><br><span class="line">        <span class="keyword">if</span> (pkg != <span class="keyword">null</span>) &#123;</span><br><span class="line">            cleanPackageDataStructuresLILPw(pkg, chatty);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h1 id="5-总结"><a href="#5-总结" class="headerlink" title="5 总结"></a>5 总结</h1><p>我们用一张流程图来总结一下系统 apk 的扫描解析处理过程：</p>
<ul>
<li>需要隐藏的系统 apk 都会被添加到 mExpectingBetter 列表中：<br>1、系统 apk 被覆盖安装过，且 system 分区的 versionCode 的是不高于 data 分区的；<br>2、之前已经有一相同包名的 apk 安装在 data 分区中了，这次有同样的包名的 app 出现在了 system 分区， versionCode 不高于 data 分区的；</li>
</ul>
</div></article><div class="post-copyright"><div class="post-copyright__author"><span class="post-copyright-meta">文章作者: </span><span class="post-copyright-info"><a href="mailto:undefined">Coolqi.Li</a></span></div><div class="post-copyright__type"><span class="post-copyright-meta">文章链接: </span><span class="post-copyright-info"><a href="https://lishuaiqi.top/2018/02/05/PMS3-PMS_SYSTEM_SCAN_START/">https://lishuaiqi.top/2018/02/05/PMS3-PMS_SYSTEM_SCAN_START/</a></span></div><div class="post-copyright__notice"><span class="post-copyright-meta">版权声明: </span><span class="post-copyright-info">本博客所有文章除特别声明外，均采用 <a href="https://creativecommons.org/licenses/by-nc-sa/4.0/">CC BY-NC-SA 4.0</a> 许可协议。转载请注明来自 <a href="https://lishuaiqi.top">Coolqi`s Blog</a>！</span></div></div><div class="post-meta__tag-list"><a class="post-meta__tags" href="/tags/PackageManager包管理/">PackageManager包管理</a></div><div class="post-qr-code"><div class="post-qr-code-item"><img class="post-qr-code__img" src="/img/zfb.jpg"><div class="post-qr-code__desc">支付宝打赏</div></div><div class="post-qr-code-item"><img class="post-qr-code__img" src="/img/wechat.jpg"><div class="post-qr-code__desc">微信打赏</div></div></div><div class="social-share"></div><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/social-share.js@1.0.16/dist/css/share.min.css"><script src="https://cdn.jsdelivr.net/npm/social-share.js@1.0.16/dist/js/social-share.min.js"></script><nav id="pagination"><div class="prev-post pull-left"><a href="/2018/02/17/PMS4-PMS_DATA_SCAN_START/"><i class="fa fa-chevron-left">  </i><span>PMS 第 4 篇 - PMS_DATA_SCAN_START 阶段</span></a></div><div class="next-post pull-right"><a href="/2018/01/26/PMS2-PMS_START/"><span>PMS 第 2 篇 - PMS_START 阶段</span><i class="fa fa-chevron-right"></i></a></div></nav></div></div><footer><div class="layout" id="footer"><div class="copyright">&copy;2015 - 2020 By Coolqi.Li</div><div class="framework-info"><span>驱动 - </span><a href="http://hexo.io"><span>Hexo</span></a><span class="footer-separator">|</span><span>主题 - </span><a href="https://github.com/Molunerfinn/hexo-theme-melody"><span>Melody</span></a></div><div class="footer_custom_text">Hi, welcome to my <a href="https://lishuaiqi.top/">blog</a>!</div><div class="busuanzi"><script async src="https://busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script><span id="busuanzi_container_page_pv"><i class="fa fa-file-o"></i><span id="busuanzi_value_page_pv"></span><span></span></span></div></div></footer><i class="fa fa-arrow-up" id="go-up" aria-hidden="true"></i><script src="/js/third-party/anime.min.js"></script><script src="/js/third-party/jquery.min.js"></script><script src="/js/third-party/jquery.fancybox.min.js"></script><script src="/js/third-party/velocity.min.js"></script><script src="/js/third-party/velocity.ui.min.js"></script><script src="/js/utils.js?version=1.5.6"></script><script src="/js/fancybox.js?version=1.5.6"></script><script src="/js/sidebar.js?version=1.5.6"></script><script src="/js/copy.js?version=1.5.6"></script><script src="/js/fireworks.js?version=1.5.6"></script><script src="/js/transition.js?version=1.5.6"></script><script src="/js/scroll.js?version=1.5.6"></script><script src="/js/head.js?version=1.5.6"></script><script type="text/x-mathjax-config">MathJax.Hub.Config({
  tex2jax: {
    inlineMath: [ ['$','$'], ["\\(","\\)"]  ],
    processEscapes: true,
    skipTags: ['script', 'noscript', 'style', 'textarea', 'pre', 'code']
  },
  CommonHTML: {
    linebreaks: { automatic: true, width: "90% container" }
  },
  "HTML-CSS": { 
    linebreaks: { automatic: true, width: "90% container" }
  },
  "SVG": { 
    linebreaks: { automatic: true, width: "90% container" }
  }
});
</script><script type="text/x-mathjax-config">MathJax.Hub.Queue(function() {
  var all = MathJax.Hub.getAllJax(), i;
  for (i=0; i < all.length; i += 1) {
    all[i].SourceElement().parentNode.className += ' has-jax';
  }
});
</script><script src="https://cdn.jsdelivr.net/npm/mathjax/MathJax.js?config=TeX-AMS-MML_HTMLorMML"></script><script src="/js/search/local-search.js"></script><div class="search-dialog" id="local-search"><div class="search-dialog__title" id="local-search-title">本地搜索</div><div id="local-input-panel"><div id="local-search-input"><div class="local-search-box"><input class="local-search-box--input" placeholder="搜索文章"></div></div></div><hr><div id="local-search-results"><div id="local-hits"></div><div id="local-stats"><div class="local-search-stats__hr" id="hr"><span>由</span> <a href="https://github.com/wzpan/hexo-generator-search" style="color:#49B1F5;">hexo-generator-search</a>
 <span>提供支持</span></div></div></div><span class="search-close-button"><i class="fa fa-times"></i></span></div><div class="search-mask"></div></body></html>
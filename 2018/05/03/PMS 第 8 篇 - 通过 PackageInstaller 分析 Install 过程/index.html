<!DOCTYPE html><html lang="zh-Hans"><head><meta charset="UTF-8"><meta http-equiv="X-UA-Compatible" content="IE=edge"><meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1"><meta name="description" content="PMS 第 8 篇 - 通过 PackageInstaller 分析 Install 过程"><meta name="keywords" content="PackageManager包管理"><meta name="author" content="Coolqi Li,undefined"><meta name="copyright" content="Coolqi Li"><title>PMS 第 8 篇 - 通过 PackageInstaller 分析 Install 过程 | Coolqi`s Blog</title><link rel="shortcut icon" href="/img/my-favicon.ico"><link rel="stylesheet" href="/css/index.css?version=1.5.6"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/font-awesome@4.7.0/css/font-awesome.min.css?version=1.5.6"><link rel="dns-prefetch" href="https://cdn.staticfile.org"><link rel="dns-prefetch" href="https://cdn.bootcss.com"><link rel="dns-prefetch" href="https://creativecommons.org"><script>var GLOBAL_CONFIG = { 
  root: '/',
  algolia: undefined,
  localSearch: {"path":"search.xml","languages":{"hits_empty":"找不到您查询的内容:${query}"}},
  copy: {
    success: '复制成功',
    error: '复制错误',
    noSupport: '浏览器不支持'
  }
} </script></head><body><canvas class="fireworks"></canvas><i class="fa fa-arrow-right" id="toggle-sidebar" aria-hidden="true"></i><div id="sidebar"><div class="toggle-sidebar-info text-center"><span data-toggle="切换文章详情">切换站点概览</span><hr></div><div class="sidebar-toc"><div class="sidebar-toc__title">目录</div><div class="sidebar-toc__progress"><span class="progress-notice">你已经读了</span><span class="progress-num">0</span><span class="progress-percentage">%</span><div class="sidebar-toc__progress-bar"></div></div><div class="sidebar-toc__content"><ol class="toc"><li class="toc-item toc-level-1"><a class="toc-link" href="#0-综述"><span class="toc-text">0 综述</span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#1-PackageInstallerActivity-onCreate"><span class="toc-text">1 PackageInstallerActivity.onCreate</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#1-1-processPackageUri"><span class="toc-text">1.1 processPackageUri</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#1-1-1-PackageUtil-getPackageInfo"><span class="toc-text">1.1.1 PackageUtil.getPackageInfo</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#1-1-2-PackageUtil-getAppSnippet"><span class="toc-text">1.1.2 PackageUtil.getAppSnippet</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#1-1-2-1-new-AppSnippet"><span class="toc-text">1.1.2.1 new AppSnippet</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#1-1-3-PackageUtil-initSnippetForNewApp"><span class="toc-text">1.1.3 PackageUtil.initSnippetForNewApp</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#1-2-checkIfAllowedAndInitiateInstall"><span class="toc-text">1.2 checkIfAllowedAndInitiateInstall</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#1-2-1-isInstallRequestFromUnknownSource"><span class="toc-text">1.2.1 isInstallRequestFromUnknownSource</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#1-2-2-isUnknownSourcesDisallowed"><span class="toc-text">1.2.2 isUnknownSourcesDisallowed</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#1-2-3-isUnknownSourcesEnabled"><span class="toc-text">1.2.3 isUnknownSourcesEnabled</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#1-2-6-initiateInstall"><span class="toc-text">1.2.6 initiateInstall</span></a></li></ol></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#2-PackageInstallerActivity-startInstallConfirm"><span class="toc-text">2 PackageInstallerActivity.startInstallConfirm</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#2-1-new-AppSecurityPermissions"><span class="toc-text">2.1 new AppSecurityPermissions</span></a></li></ol></li></ol></div></div><div class="author-info hide"><div class="author-info__avatar text-center"><img src="/img/avatar.png"></div><div class="author-info__name text-center">Coolqi Li</div><div class="author-info__description text-center">“你好，我是李帅奇，Android 系统工程师，MineCraft 忠实玩家，设计和绘画爱好者，缺妹纸晚期患者，熬夜星人。”</div><div class="follow-button"><a href="https://github.com/USERNAME">Follow Me</a></div><hr><div class="author-info-articles"><a class="author-info-articles__archives article-meta" href="/archives"><span class="pull-left">文章</span><span class="pull-right">45</span></a><a class="author-info-articles__tags article-meta" href="/tags"><span class="pull-left">标签</span><span class="pull-right">11</span></a><a class="author-info-articles__categories article-meta" href="/categories"><span class="pull-left">分类</span><span class="pull-right">12</span></a></div><hr><div class="author-info-links"><div class="author-info-links__title text-center">Links</div><a class="author-info-links__name text-center" href="https://molunerfinn.com">Molunerfinn</a><a class="author-info-links__name text-center" href="https://piegg.cn">PiEgg</a><a class="author-info-links__name text-center" href="https://piegg.cn">Elody</a></div></div></div><div id="content-outer"><div class="no-bg" id="top-container"><div id="page-header"><span class="pull-left"> <a id="site-name" href="/">Coolqi`s Blog</a></span><i class="fa fa-bars toggle-menu pull-right" aria-hidden="true"></i><span class="pull-right menus"><a class="site-page social-icon search"><i class="fa fa-search"></i><span> 搜索</span></a><a class="site-page" href="/">Home</a><a class="site-page" href="/archives">Archives</a><a class="site-page" href="/tags">Tags</a><a class="site-page" href="/categories">Categories</a><a class="site-page" href="/about">About</a></span></div><div id="post-info"><div id="post-title">PMS 第 8 篇 - 通过 PackageInstaller 分析 Install 过程</div><div id="post-meta"><time class="post-meta__date"><i class="fa fa-calendar" aria-hidden="true"></i> 2018-05-03</time><span class="post-meta__separator">|</span><i class="fa fa-inbox post-meta__icon" aria-hidden="true"></i><a class="post-meta__categories" href="/categories/PackageManager包管理/">PackageManager包管理</a><i class="fa fa-angle-right" aria-hidden="true"></i><i class="fa fa-inbox post-meta__icon" aria-hidden="true"></i><a class="post-meta__categories" href="/categories/PackageManager包管理/PackageInstaller安装/">PackageInstaller安装</a><div class="post-meta-wordcount"><span>字数总计: </span><span class="word-count">3k</span><span class="post-meta__separator">|</span><span>阅读时长: 14 分钟</span></div></div></div></div><div class="layout" id="content-inner"><article id="post"><div class="article-container" id="post-content"><p>[toc]</p>
<p>基于 Android7.1.1 分析 PackageManagerService 的逻辑。</p>
<h1 id="0-综述"><a href="#0-综述" class="headerlink" title="0 综述"></a>0 综述</h1><p>前面总结了通过 pm install 的方式来安装一个 apk，但是这种方式用户是不经常使用的，用户使用的安装途径主要如下：</p>
<ul>
<li>通过应用商店下载 apk，进行安装；</li>
<li>将 apk 文件移动到关键管理器，点击触发安装；</li>
</ul>
<p>这里我们来看看第二种情况！</p>
<p>对于第二种中情况，当我们触发安装的时候，实际上是发送了一个 intent，这个 intent 中携带了 apk 的文件路径等参数，在 sample 给出了如下的启动安装的方式：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">private</span> OnClickListener mUnknownSourceListener = <span class="keyword">new</span> OnClickListener() &#123;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onClick</span><span class="params">(View v)</span> </span>&#123;</span><br><span class="line">        Intent intent = <span class="keyword">new</span> Intent(Intent.ACTION_INSTALL_PACKAGE);</span><br><span class="line">        intent.setData(Uri.fromFile(prepareApk(<span class="string">"HelloActivity.apk"</span>)));</span><br><span class="line">        startActivity(intent);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="keyword">private</span> OnClickListener mMySourceListener = <span class="keyword">new</span> OnClickListener() &#123;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onClick</span><span class="params">(View v)</span> </span>&#123;</span><br><span class="line">        Intent intent = <span class="keyword">new</span> Intent(Intent.ACTION_INSTALL_PACKAGE);</span><br><span class="line">        intent.setData(Uri.fromFile(prepareApk(<span class="string">"HelloActivity.apk"</span>)));</span><br><span class="line">        intent.putExtra(Intent.EXTRA_NOT_UNKNOWN_SOURCE, <span class="keyword">true</span>);</span><br><span class="line">        intent.putExtra(Intent.EXTRA_RETURN_RESULT, <span class="keyword">true</span>);</span><br><span class="line">        intent.putExtra(Intent.EXTRA_INSTALLER_PACKAGE_NAME,</span><br><span class="line">                getApplicationInfo().packageName);</span><br><span class="line">        startActivityForResult(intent, REQUEST_INSTALL);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="keyword">private</span> OnClickListener mReplaceListener = <span class="keyword">new</span> OnClickListener() &#123;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onClick</span><span class="params">(View v)</span> </span>&#123;</span><br><span class="line">        Intent intent = <span class="keyword">new</span> Intent(Intent.ACTION_INSTALL_PACKAGE);</span><br><span class="line">        intent.setData(Uri.fromFile(prepareApk(<span class="string">"HelloActivity.apk"</span>)));</span><br><span class="line">        intent.putExtra(Intent.EXTRA_NOT_UNKNOWN_SOURCE, <span class="keyword">true</span>);</span><br><span class="line">        intent.putExtra(Intent.EXTRA_RETURN_RESULT, <span class="keyword">true</span>);</span><br><span class="line">        intent.putExtra(Intent.EXTRA_ALLOW_REPLACE, <span class="keyword">true</span>);</span><br><span class="line">        intent.putExtra(Intent.EXTRA_INSTALLER_PACKAGE_NAME,</span><br><span class="line">                getApplicationInfo().packageName);</span><br><span class="line">        startActivityForResult(intent, REQUEST_INSTALL);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>
<p>那谁来接收这个 intent 呢？显而易见，PacakgeInstaller，我们去其说明书中看看：</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">activity</span> <span class="attr">android:name</span>=<span class="string">".PackageInstallerActivity"</span></span></span><br><span class="line"><span class="tag">        <span class="attr">android:configChanges</span>=<span class="string">"orientation|keyboardHidden|screenSize"</span></span></span><br><span class="line"><span class="tag">        <span class="attr">android:excludeFromRecents</span>=<span class="string">"true"</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">intent-filter</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">action</span> <span class="attr">android:name</span>=<span class="string">"android.intent.action.VIEW"</span> /&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">action</span> <span class="attr">android:name</span>=<span class="string">"android.intent.action.INSTALL_PACKAGE"</span> /&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">category</span> <span class="attr">android:name</span>=<span class="string">"android.intent.category.DEFAULT"</span> /&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">data</span> <span class="attr">android:scheme</span>=<span class="string">"file"</span> /&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">data</span> <span class="attr">android:scheme</span>=<span class="string">"content"</span> /&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">data</span> <span class="attr">android:mimeType</span>=<span class="string">"application/vnd.android.package-archive"</span> /&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">intent-filter</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">intent-filter</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">action</span> <span class="attr">android:name</span>=<span class="string">"android.intent.action.INSTALL_PACKAGE"</span> /&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">category</span> <span class="attr">android:name</span>=<span class="string">"android.intent.category.DEFAULT"</span> /&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">data</span> <span class="attr">android:scheme</span>=<span class="string">"file"</span> /&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">data</span> <span class="attr">android:scheme</span>=<span class="string">"package"</span> /&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">data</span> <span class="attr">android:scheme</span>=<span class="string">"content"</span> /&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">intent-filter</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">intent-filter</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">action</span> <span class="attr">android:name</span>=<span class="string">"android.content.pm.action.CONFIRM_PERMISSIONS"</span> /&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">category</span> <span class="attr">android:name</span>=<span class="string">"android.intent.category.DEFAULT"</span> /&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">intent-filter</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">activity</span>&gt;</span></span><br></pre></td></tr></table></figure>
<p>我们看到 PackageInstallerActivity 接收了 android.intent.action.INSTALL_PACKAGE action！</p>
<p>下面我们来分析下整个流程：</p>
<h1 id="1-PackageInstallerActivity-onCreate"><a href="#1-PackageInstallerActivity-onCreate" class="headerlink" title="1 PackageInstallerActivity.onCreate"></a>1 PackageInstallerActivity.onCreate</h1><p>这里我们进入 PackageInstallerActivity，看看其做了什么处理：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">PackageInstallerActivity</span> <span class="keyword">extends</span> <span class="title">Activity</span> <span class="keyword">implements</span> <span class="title">OnCancelListener</span>, <span class="title">OnClickListener</span> </span>&#123;</span><br><span class="line">    ... ... ...</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title">onCreate</span><span class="params">(Bundle icicle)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">super</span>.onCreate(icicle);</span><br><span class="line"></span><br><span class="line">        mPm = getPackageManager();</span><br><span class="line">        mInstaller = mPm.getPackageInstaller();</span><br><span class="line">        mUserManager = (UserManager) getSystemService(Context.USER_SERVICE);</span><br><span class="line"></span><br><span class="line">        <span class="comment">//【1】获得安装传入的  Intent！</span></span><br><span class="line">        <span class="keyword">final</span> Intent intent = getIntent();</span><br><span class="line">        mOriginatingUid = getOriginatingUid(intent);</span><br><span class="line"></span><br><span class="line">        <span class="keyword">final</span> Uri packageUri;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (PackageInstaller.ACTION_CONFIRM_PERMISSIONS.equals(intent.getAction())) &#123;</span><br><span class="line">            <span class="keyword">final</span> <span class="keyword">int</span> sessionId = intent.getIntExtra(PackageInstaller.EXTRA_SESSION_ID, -<span class="number">1</span>);</span><br><span class="line">            <span class="keyword">final</span> PackageInstaller.SessionInfo info = mInstaller.getSessionInfo(sessionId);</span><br><span class="line">            <span class="keyword">if</span> (info == <span class="keyword">null</span> || !info.sealed || info.resolvedBaseCodePath == <span class="keyword">null</span>) &#123;</span><br><span class="line">                Log.w(TAG, <span class="string">"Session "</span> + mSessionId + <span class="string">" in funky state; ignoring"</span>);</span><br><span class="line">                finish();</span><br><span class="line">                <span class="keyword">return</span>;</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            mSessionId = sessionId;</span><br><span class="line">            packageUri = Uri.fromFile(<span class="keyword">new</span> File(info.resolvedBaseCodePath));</span><br><span class="line">            mOriginatingURI = <span class="keyword">null</span>;</span><br><span class="line">            mReferrerURI = <span class="keyword">null</span>;</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            <span class="comment">//【2】对于 install package 进入这里，会通过 getData 获得 packageUri！</span></span><br><span class="line">            mSessionId = -<span class="number">1</span>;</span><br><span class="line">            packageUri = intent.getData();</span><br><span class="line">            mOriginatingURI = intent.getParcelableExtra(Intent.EXTRA_ORIGINATING_URI);</span><br><span class="line">            mReferrerURI = intent.getParcelableExtra(Intent.EXTRA_REFERRER);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment">//【3】如果 packageUri 为 null，那么这里会返回结果给启动安装的界面：INVALID_URI！</span></span><br><span class="line">        <span class="keyword">if</span> (packageUri == <span class="keyword">null</span>) &#123;</span><br><span class="line">            Log.w(TAG, <span class="string">"Unspecified source"</span>);</span><br><span class="line">            setPmResult(PackageManager.INSTALL_FAILED_INVALID_URI);</span><br><span class="line">            finish();</span><br><span class="line">            <span class="keyword">return</span>;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (DeviceUtils.isWear(<span class="keyword">this</span>)) &#123; <span class="comment">// 可穿戴设备的逻辑，不关注！</span></span><br><span class="line">            showDialogInner(DLG_NOT_SUPPORTED_ON_WEAR);</span><br><span class="line">            <span class="keyword">return</span>;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment">//【4】初始化界面！</span></span><br><span class="line">        setContentView(R.layout.install_start);</span><br><span class="line">        mInstallConfirm = findViewById(R.id.install_confirm_panel);</span><br><span class="line">        mInstallConfirm.setVisibility(View.INVISIBLE);</span><br><span class="line">        mOk = (Button)findViewById(R.id.ok_button);</span><br><span class="line">        mCancel = (Button)findViewById(R.id.cancel_button);</span><br><span class="line">        mOk.setOnClickListener(<span class="keyword">this</span>);</span><br><span class="line">        mCancel.setOnClickListener(<span class="keyword">this</span>);</span><br><span class="line"></span><br><span class="line">        <span class="comment">//【*1.1】解析传入的 packageUri！</span></span><br><span class="line">        <span class="keyword">boolean</span> wasSetUp = processPackageUri(packageUri);</span><br><span class="line">        <span class="keyword">if</span> (!wasSetUp) &#123;</span><br><span class="line">            <span class="keyword">return</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">//【*1.2】解析传入的 packageUri！</span></span><br><span class="line">        checkIfAllowedAndInitiateInstall(<span class="keyword">false</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    ... ... ...</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>我们看到 PackageInstallerActivity 方法实现了 OnCancelListener, OnClickListener，用于响应界面事件。。。</p>
<h2 id="1-1-processPackageUri"><a href="#1-1-processPackageUri" class="headerlink" title="1.1 processPackageUri"></a>1.1 processPackageUri</h2><p>解析 Uri 被为要安装的 apk 设置合适的 installer，如果返回 true，表示设置成功了！</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">boolean</span> <span class="title">processPackageUri</span><span class="params">(<span class="keyword">final</span> Uri packageUri)</span> </span>&#123;</span><br><span class="line">    mPackageURI = packageUri;</span><br><span class="line">    <span class="comment">//【1】获得 scheme 属性，对应资源使用的协议！</span></span><br><span class="line">    <span class="keyword">final</span> String scheme = packageUri.getScheme();</span><br><span class="line">    <span class="keyword">final</span> PackageUtil.AppSnippet as;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">switch</span> (scheme) &#123;</span><br><span class="line">        <span class="keyword">case</span> SCHEME_PACKAGE: &#123; <span class="comment">//【1.1】package 类型！</span></span><br><span class="line">            <span class="keyword">try</span> &#123;</span><br><span class="line">                mPkgInfo = mPm.getPackageInfo(packageUri.getSchemeSpecificPart(),</span><br><span class="line">                        PackageManager.GET_PERMISSIONS</span><br><span class="line">                                | PackageManager.GET_UNINSTALLED_PACKAGES);</span><br><span class="line">            &#125; <span class="keyword">catch</span> (NameNotFoundException e) &#123;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">if</span> (mPkgInfo == <span class="keyword">null</span>) &#123;</span><br><span class="line">                Log.w(TAG, <span class="string">"Requested package "</span> + packageUri.getScheme()</span><br><span class="line">                        + <span class="string">" not available. Discontinuing installation"</span>);</span><br><span class="line">                showDialogInner(DLG_PACKAGE_ERROR);</span><br><span class="line">                setPmResult(PackageManager.INSTALL_FAILED_INVALID_APK);</span><br><span class="line">                <span class="keyword">return</span> <span class="keyword">false</span>;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="comment">//【×1.1.2.1】创建 AppSnippet 实例！</span></span><br><span class="line">            as = <span class="keyword">new</span> PackageUtil.AppSnippet(mPm.getApplicationLabel(mPkgInfo.applicationInfo),</span><br><span class="line">                    mPm.getApplicationIcon(mPkgInfo.applicationInfo));</span><br><span class="line">        &#125; <span class="keyword">break</span>;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">case</span> SCHEME_FILE: &#123; <span class="comment">//【1.2】file 类型</span></span><br><span class="line">            File sourceFile = <span class="keyword">new</span> File(packageUri.getPath());</span><br><span class="line">            <span class="comment">//【*1.1.1】对 path 指定的 apk 进行解析，其实是是创建了一个 PackageParser 对象，然后扫描 apk</span></span><br><span class="line">            <span class="comment">// 将结果封装为 PackageParser.Package 并返回！</span></span><br><span class="line">            PackageParser.Package parsed = PackageUtil.getPackageInfo(sourceFile);</span><br><span class="line"></span><br><span class="line">            <span class="keyword">if</span> (parsed == <span class="keyword">null</span>) &#123; <span class="comment">// 发生了 error！</span></span><br><span class="line">                Log.w(TAG, <span class="string">"Parse error when parsing manifest. Discontinuing installation"</span>);</span><br><span class="line">                showDialogInner(DLG_PACKAGE_ERROR);</span><br><span class="line">                setPmResult(PackageManager.INSTALL_FAILED_INVALID_APK);</span><br><span class="line">                <span class="keyword">return</span> <span class="keyword">false</span>;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="comment">//【1.2.1】将解析到的 Package 转为 PackageInfo 对象！</span></span><br><span class="line">            <span class="comment">// 除了获取到了基本信息，这里还额外指定了获取该应用的定义的权限和申请的权限信息！</span></span><br><span class="line">            mPkgInfo = PackageParser.generatePackageInfo(parsed, <span class="keyword">null</span>,</span><br><span class="line">                    PackageManager.GET_PERMISSIONS, <span class="number">0</span>, <span class="number">0</span>, <span class="keyword">null</span>,</span><br><span class="line">                    <span class="keyword">new</span> PackageUserState());</span><br><span class="line">            <span class="comment">//【*1.1.2】获得 apk 的 AppSnippet 实例！</span></span><br><span class="line">            as = PackageUtil.getAppSnippet(<span class="keyword">this</span>, mPkgInfo.applicationInfo, sourceFile);</span><br><span class="line">        &#125; <span class="keyword">break</span>;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">case</span> SCHEME_CONTENT: &#123; <span class="comment">//【1.3】content 类型</span></span><br><span class="line">            mStagingAsynTask = <span class="keyword">new</span> StagingAsyncTask();</span><br><span class="line">            mStagingAsynTask.execute(packageUri);</span><br><span class="line">            <span class="keyword">return</span> <span class="keyword">false</span>;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">default</span>: &#123;</span><br><span class="line">            <span class="comment">//【1.4】不支持的资源协议，默认会进入这里！</span></span><br><span class="line">            Log.w(TAG, <span class="string">"Unsupported scheme "</span> + scheme);</span><br><span class="line">            setPmResult(PackageManager.INSTALL_FAILED_INVALID_URI);</span><br><span class="line">            clearCachedApkIfNeededAndFinish();</span><br><span class="line">            <span class="keyword">return</span> <span class="keyword">false</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">//【*1.1.3】继续处理 AppSnippet 实例！</span></span><br><span class="line">    PackageUtil.initSnippetForNewApp(<span class="keyword">this</span>, as, R.id.app_snippet);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">true</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>对于安装文件管理器的 apk 的方式，其 scheme 值为 file，所以这里</p>
<p>对于 package 的解析流程，这里就不再多说了；</p>
<p>而 generatePackageInfo 方法的逻辑也很简单，flags 可以通过设置指定的位来获取特定的数据！</p>
<h3 id="1-1-1-PackageUtil-getPackageInfo"><a href="#1-1-1-PackageUtil-getPackageInfo" class="headerlink" title="1.1.1 PackageUtil.getPackageInfo"></a>1.1.1 PackageUtil.getPackageInfo</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> PackageParser.<span class="function">Package <span class="title">getPackageInfo</span><span class="params">(File sourceFile)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">final</span> PackageParser parser = <span class="keyword">new</span> PackageParser();</span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> parser.parsePackage(sourceFile, <span class="number">0</span>);</span><br><span class="line">    &#125; <span class="keyword">catch</span> (PackageParserException e) &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">null</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h3 id="1-1-2-PackageUtil-getAppSnippet"><a href="#1-1-2-PackageUtil-getAppSnippet" class="headerlink" title="1.1.2 PackageUtil.getAppSnippet"></a>1.1.2 PackageUtil.getAppSnippet</h3><p>这个方法用于加载应用的 label 和 icon：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">static</span> AppSnippet <span class="title">getAppSnippet</span><span class="params">(</span></span></span><br><span class="line"><span class="function"><span class="params">        Activity pContext, ApplicationInfo appInfo, File sourceFile)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">final</span> String archiveFilePath = sourceFile.getAbsolutePath();</span><br><span class="line">    Resources pRes = pContext.getResources();</span><br><span class="line">    AssetManager assmgr = <span class="keyword">new</span> AssetManager();</span><br><span class="line">    <span class="comment">//【1】设置资源加载路径！</span></span><br><span class="line">    assmgr.addAssetPath(archiveFilePath);</span><br><span class="line">    Resources res = <span class="keyword">new</span> Resources(assmgr, pRes.getDisplayMetrics(), pRes.getConfiguration());</span><br><span class="line">    CharSequence label = <span class="keyword">null</span>;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">//【2】尝试先从资源文件中加载 label！</span></span><br><span class="line">    <span class="keyword">if</span> (appInfo.labelRes != <span class="number">0</span>) &#123;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            label = res.getText(appInfo.labelRes);</span><br><span class="line">        &#125; <span class="keyword">catch</span> (Resources.NotFoundException e) &#123;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">//【3】如果没有显式定义的话，那么就会使用包名；</span></span><br><span class="line">    <span class="keyword">if</span> (label == <span class="keyword">null</span>) &#123;</span><br><span class="line">        label = (appInfo.nonLocalizedLabel != <span class="keyword">null</span>) ?</span><br><span class="line">                appInfo.nonLocalizedLabel : appInfo.packageName;</span><br><span class="line">    &#125;</span><br><span class="line">    Drawable icon = <span class="keyword">null</span>;</span><br><span class="line">    <span class="comment">//【4】尝试从资源文件获取图标，如果没有定义，那么我们会从系统中获取默认图标！</span></span><br><span class="line">    <span class="keyword">if</span> (appInfo.icon != <span class="number">0</span>) &#123;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            icon = res.getDrawable(appInfo.icon);</span><br><span class="line">        &#125; <span class="keyword">catch</span> (Resources.NotFoundException e) &#123;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span> (icon == <span class="keyword">null</span>) &#123;</span><br><span class="line">        icon = pContext.getPackageManager().getDefaultActivityIcon();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//【×1.1.2.1】创建了一个 AppSnippet 对象！</span></span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">new</span> PackageUtil.AppSnippet(label, icon);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h4 id="1-1-2-1-new-AppSnippet"><a href="#1-1-2-1-new-AppSnippet" class="headerlink" title="1.1.2.1 new AppSnippet"></a>1.1.2.1 new AppSnippet</h4><p>AppSnippet 用于保存 apk 的 label 和 icon：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">static</span> <span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">AppSnippet</span> </span>&#123;</span><br><span class="line">    CharSequence label;</span><br><span class="line">    Drawable icon;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="title">AppSnippet</span><span class="params">(CharSequence label, Drawable icon)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">this</span>.label = label;</span><br><span class="line">        <span class="keyword">this</span>.icon = icon;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h3 id="1-1-3-PackageUtil-initSnippetForNewApp"><a href="#1-1-3-PackageUtil-initSnippetForNewApp" class="headerlink" title="1.1.3 PackageUtil.initSnippetForNewApp"></a>1.1.3 PackageUtil.initSnippetForNewApp</h3><p>根据返回的 AppSnippet，初始化界面，显示应用的名称和 label：<br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">static</span> View <span class="title">initSnippetForNewApp</span><span class="params">(Activity pContext, AppSnippet as,</span></span></span><br><span class="line"><span class="function"><span class="params">        <span class="keyword">int</span> snippetId)</span> </span>&#123;</span><br><span class="line">    View appSnippet = pContext.findViewById(snippetId);</span><br><span class="line">    ((ImageView)appSnippet.findViewById(R.id.app_icon)).setImageDrawable(as.icon);</span><br><span class="line">    ((TextView)appSnippet.findViewById(R.id.app_name)).setText(as.label);</span><br><span class="line">    <span class="keyword">return</span> appSnippet;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<h2 id="1-2-checkIfAllowedAndInitiateInstall"><a href="#1-2-checkIfAllowedAndInitiateInstall" class="headerlink" title="1.2 checkIfAllowedAndInitiateInstall"></a>1.2 checkIfAllowedAndInitiateInstall</h2><p>用于判断是否允许安装，如果允许安装，那就进行初始化；否则会弹出提示框，参数 ignoreUnknownSourcesSettings 表示是否忽视未知来源安装，这里我们传入的是 false；</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">checkIfAllowedAndInitiateInstall</span><span class="params">(<span class="keyword">boolean</span> ignoreUnknownSourcesSettings)</span> </span>&#123;</span><br><span class="line">    <span class="comment">//【×1.2.1】判断本次安装是否是来自未知来源！</span></span><br><span class="line">    <span class="keyword">final</span> <span class="keyword">boolean</span> requestFromUnknownSource = isInstallRequestFromUnknownSource(getIntent());</span><br><span class="line">    <span class="keyword">if</span> (!requestFromUnknownSource) &#123;</span><br><span class="line">        <span class="comment">//【×1.2.6】如果是特权应用发送的安装，那么就初始化安装！</span></span><br><span class="line">        initiateInstall();</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">//【1】判断当前所在 user 是否是在另外一个 user 的 profile 中！</span></span><br><span class="line">    <span class="keyword">final</span> <span class="keyword">boolean</span> isManagedProfile = mUserManager.isManagedProfile();</span><br><span class="line">    <span class="comment">//【*1.2.2】判断当前用户是否设置了不允许位置来源的用户限制！</span></span><br><span class="line">    <span class="keyword">if</span> (isUnknownSourcesDisallowed()) &#123;</span><br><span class="line">        <span class="keyword">if</span> ((mUserManager.getUserRestrictionSource(UserManager.DISALLOW_INSTALL_UNKNOWN_SOURCES,</span><br><span class="line">                Process.myUserHandle()) &amp; UserManager.RESTRICTION_SOURCE_SYSTEM) != <span class="number">0</span>) &#123;</span><br><span class="line">            <span class="keyword">if</span> (ignoreUnknownSourcesSettings) &#123;</span><br><span class="line">                <span class="comment">//【×1.2.6】如果忽视未知来源，初始化安装！</span></span><br><span class="line">                initiateInstall();</span><br><span class="line">            &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                <span class="comment">// 显示 DLG_UNKNOWN_SOURCES 弹窗！</span></span><br><span class="line">                showDialogInner(DLG_UNKNOWN_SOURCES);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            startActivity(<span class="keyword">new</span> Intent(Settings.ACTION_SHOW_ADMIN_SUPPORT_DETAILS));</span><br><span class="line">            clearCachedApkIfNeededAndFinish();</span><br><span class="line">        &#125;</span><br><span class="line">        </span><br><span class="line">    &#125; <span class="keyword">else</span> <span class="keyword">if</span> (!isUnknownSourcesEnabled() &amp;&amp; isManagedProfile) &#123;</span><br><span class="line">        <span class="comment">//【*1.2.3】如果没有设置用户限制，但是用户关闭了设置中的可未知来源安装</span></span><br><span class="line">        <span class="comment">// 同时当前用户是是在另外用户的 profile 中！</span></span><br><span class="line">        <span class="comment">// 显示 DLG_ADMIN_RESTRICTS_UNKNOWN_SOURCES 弹窗！</span></span><br><span class="line">        showDialogInner(DLG_ADMIN_RESTRICTS_UNKNOWN_SOURCES);</span><br><span class="line"></span><br><span class="line">    &#125; <span class="keyword">else</span> <span class="keyword">if</span> (!isUnknownSourcesEnabled()) &#123;</span><br><span class="line">        <span class="comment">//【*1.2.3】如果用户关闭了设置中的可未知来源安装，并且我们忽视位置来源</span></span><br><span class="line">        <span class="comment">// 那么就立刻初始化！</span></span><br><span class="line">        <span class="keyword">if</span> (ignoreUnknownSourcesSettings) &#123;</span><br><span class="line">            <span class="comment">//【×1.2.6】初始化安装！</span></span><br><span class="line">            initiateInstall();</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            <span class="comment">// 显示 DLG_UNKNOWN_SOURCES 弹窗！</span></span><br><span class="line">            showDialogInner(DLG_UNKNOWN_SOURCES);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        <span class="comment">//【×1.2.6】如果不是来自未知来源的安装，那么就初始化安装！</span></span><br><span class="line">        initiateInstall();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h3 id="1-2-1-isInstallRequestFromUnknownSource"><a href="#1-2-1-isInstallRequestFromUnknownSource" class="headerlink" title="1.2.1 isInstallRequestFromUnknownSource"></a>1.2.1 isInstallRequestFromUnknownSource</h3><p>判断本次安装是否来自未知来源：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">boolean</span> <span class="title">isInstallRequestFromUnknownSource</span><span class="params">(Intent intent)</span> </span>&#123;</span><br><span class="line">    String callerPackage = getCallingPackage();</span><br><span class="line">    <span class="comment">//【1】判断 intent 是否设置 EXTRA_NOT_UNKNOWN_SOURCE 为 true！</span></span><br><span class="line">    <span class="keyword">if</span> (callerPackage != <span class="keyword">null</span> &amp;&amp; intent.getBooleanExtra(</span><br><span class="line">            Intent.EXTRA_NOT_UNKNOWN_SOURCE, <span class="keyword">false</span>)) &#123;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            mSourceInfo = mPm.getApplicationInfo(callerPackage, <span class="number">0</span>);</span><br><span class="line">            <span class="keyword">if</span> (mSourceInfo != <span class="keyword">null</span>) &#123;</span><br><span class="line">                <span class="keyword">if</span> ((mSourceInfo.privateFlags &amp; ApplicationInfo.PRIVATE_FLAG_PRIVILEGED)</span><br><span class="line">                        != <span class="number">0</span>) &#123;</span><br><span class="line">                    <span class="comment">//【1.1】如果设置了为 true，只有特权应用发起安装时才不会视为未知来源；</span></span><br><span class="line">                    <span class="keyword">return</span> <span class="keyword">false</span>;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125; <span class="keyword">catch</span> (NameNotFoundException e) &#123;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">//【2】其他情况，无论你是否设置，都会视为未知来源！</span></span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">true</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h3 id="1-2-2-isUnknownSourcesDisallowed"><a href="#1-2-2-isUnknownSourcesDisallowed" class="headerlink" title="1.2.2 isUnknownSourcesDisallowed"></a>1.2.2 isUnknownSourcesDisallowed</h3><p>判断下当前设备用户是否限制来自未知来源的安装，也就是是否设置了 DISALLOW_INSTALL_UNKNOWN_SOURCES 用户限制：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">boolean</span> <span class="title">isUnknownSourcesDisallowed</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    <span class="keyword">return</span> mUserManager.hasUserRestriction(UserManager.DISALLOW_INSTALL_UNKNOWN_SOURCES);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h3 id="1-2-3-isUnknownSourcesEnabled"><a href="#1-2-3-isUnknownSourcesEnabled" class="headerlink" title="1.2.3 isUnknownSourcesEnabled"></a>1.2.3 isUnknownSourcesEnabled</h3><p>判断用户是否在设置中打开了位置来源限制：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">boolean</span> <span class="title">isUnknownSourcesEnabled</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    <span class="keyword">return</span> Settings.Secure.getInt(getContentResolver(),</span><br><span class="line">            Settings.Secure.INSTALL_NON_MARKET_APPS, <span class="number">0</span>) &gt; <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h3 id="1-2-6-initiateInstall"><a href="#1-2-6-initiateInstall" class="headerlink" title="1.2.6 initiateInstall"></a>1.2.6 initiateInstall</h3><p>初始化安装：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">initiateInstall</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    <span class="comment">//【1】获得要安装的应用包名！</span></span><br><span class="line">    String pkgName = mPkgInfo.packageName;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">//【2】判断下系统中是否存在该 pkg，但是被改为了其他名称，如果有，这里要调整下！</span></span><br><span class="line">    String[] oldName = mPm.canonicalToCurrentPackageNames(<span class="keyword">new</span> String[] &#123; pkgName &#125;);</span><br><span class="line">    <span class="keyword">if</span> (oldName != <span class="keyword">null</span> &amp;&amp; oldName.length &gt; <span class="number">0</span> &amp;&amp; oldName[<span class="number">0</span>] != <span class="keyword">null</span>) &#123;</span><br><span class="line">        pkgName = oldName[<span class="number">0</span>];</span><br><span class="line">        mPkgInfo.packageName = pkgName;</span><br><span class="line">        mPkgInfo.applicationInfo.packageName = pkgName;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//【3】判断该 pkg 是否已经安装过，如果是，弹出 replace 的弹窗；</span></span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">        <span class="comment">//【3.1】这里通过 GET_UNINSTALLED_PACKAGES 标志为获得该应用的安装信息</span></span><br><span class="line">        <span class="comment">// 如果该应用在系统中只有 data 数据，我们也会将其视为已经安装！</span></span><br><span class="line">        mAppInfo = mPm.getApplicationInfo(pkgName,</span><br><span class="line">                PackageManager.GET_UNINSTALLED_PACKAGES);</span><br><span class="line">        <span class="comment">//【3.2】判断是否有 FLAG_INSTALLED 标志为，如果没有，那就是没有安装过！</span></span><br><span class="line">        <span class="keyword">if</span> ((mAppInfo.flags&amp;ApplicationInfo.FLAG_INSTALLED) == <span class="number">0</span>) &#123;</span><br><span class="line">            mAppInfo = <span class="keyword">null</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125; <span class="keyword">catch</span> (NameNotFoundException e) &#123;</span><br><span class="line">        mAppInfo = <span class="keyword">null</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">//【*2】继续处理：</span></span><br><span class="line">    startInstallConfirm();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h1 id="2-PackageInstallerActivity-startInstallConfirm"><a href="#2-PackageInstallerActivity-startInstallConfirm" class="headerlink" title="2 PackageInstallerActivity.startInstallConfirm"></a>2 PackageInstallerActivity.startInstallConfirm</h1><p>如果时第一次安装的话，mAppInfo 为 null！</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">startInstallConfirm</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    <span class="comment">//【1】初始化界面；</span></span><br><span class="line">    ((TextView) findViewById(R.id.install_confirm_question))</span><br><span class="line">            .setText(R.string.install_confirm_question);</span><br><span class="line">    findViewById(R.id.spacer).setVisibility(View.GONE);</span><br><span class="line">    TabHost tabHost = (TabHost)findViewById(android.R.id.tabhost);</span><br><span class="line">    tabHost.setup();</span><br><span class="line">    tabHost.setVisibility(View.VISIBLE);</span><br><span class="line">    ViewPager viewPager = (ViewPager)findViewById(R.id.pager);</span><br><span class="line">    TabsAdapter adapter = <span class="keyword">new</span> TabsAdapter(<span class="keyword">this</span>, tabHost, viewPager);</span><br><span class="line">    </span><br><span class="line">    <span class="comment">//【2】判断应用是否支持运行时权限！</span></span><br><span class="line">    <span class="keyword">boolean</span> supportsRuntimePermissions = mPkgInfo.applicationInfo.targetSdkVersion</span><br><span class="line">            &gt;= Build.VERSION_CODES.M;</span><br><span class="line">    <span class="keyword">boolean</span> permVisible = <span class="keyword">false</span>;</span><br><span class="line">    mScrollView = <span class="keyword">null</span>;</span><br><span class="line">    mOkCanInstall = <span class="keyword">false</span>;</span><br><span class="line">    <span class="keyword">int</span> msg = <span class="number">0</span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//【*2.1】创建了一个 AppSecurityPermissions 实例！</span></span><br><span class="line">    AppSecurityPermissions perms = <span class="keyword">new</span> AppSecurityPermissions(<span class="keyword">this</span>, mPkgInfo);</span><br><span class="line">    <span class="keyword">final</span> <span class="keyword">int</span> N = perms.getPermissionCount(AppSecurityPermissions.WHICH_ALL);</span><br><span class="line">    <span class="keyword">if</span> (mAppInfo != <span class="keyword">null</span>) &#123;</span><br><span class="line">        msg = (mAppInfo.flags &amp; ApplicationInfo.FLAG_SYSTEM) != <span class="number">0</span></span><br><span class="line">                ? R.string.install_confirm_question_update_system</span><br><span class="line">                : R.string.install_confirm_question_update;</span><br><span class="line">        mScrollView = <span class="keyword">new</span> CaffeinatedScrollView(<span class="keyword">this</span>);</span><br><span class="line">        mScrollView.setFillViewport(<span class="keyword">true</span>);</span><br><span class="line">        <span class="keyword">boolean</span> newPermissionsFound = <span class="keyword">false</span>;</span><br><span class="line">        <span class="keyword">if</span> (!supportsRuntimePermissions) &#123;</span><br><span class="line">            newPermissionsFound =</span><br><span class="line">                    (perms.getPermissionCount(AppSecurityPermissions.WHICH_NEW) &gt; <span class="number">0</span>);</span><br><span class="line">            <span class="keyword">if</span> (newPermissionsFound) &#123;</span><br><span class="line">                permVisible = <span class="keyword">true</span>;</span><br><span class="line">                mScrollView.addView(perms.getPermissionsView(</span><br><span class="line">                        AppSecurityPermissions.WHICH_NEW));</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">if</span> (!supportsRuntimePermissions &amp;&amp; !newPermissionsFound) &#123;</span><br><span class="line">            LayoutInflater inflater = (LayoutInflater)getSystemService(</span><br><span class="line">                    Context.LAYOUT_INFLATER_SERVICE);</span><br><span class="line">            TextView label = (TextView)inflater.inflate(R.layout.label, <span class="keyword">null</span>);</span><br><span class="line">            label.setText(R.string.no_new_perms);</span><br><span class="line">            mScrollView.addView(label);</span><br><span class="line">        &#125;</span><br><span class="line">        adapter.addTab(tabHost.newTabSpec(TAB_ID_NEW).setIndicator(</span><br><span class="line">                getText(R.string.newPerms)), mScrollView);</span><br><span class="line">    &#125; <span class="keyword">else</span>  &#123;</span><br><span class="line">        findViewById(R.id.tabscontainer).setVisibility(View.GONE);</span><br><span class="line">        findViewById(R.id.spacer).setVisibility(View.VISIBLE);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span> (!supportsRuntimePermissions &amp;&amp; N &gt; <span class="number">0</span>) &#123;</span><br><span class="line">        permVisible = <span class="keyword">true</span>;</span><br><span class="line">        LayoutInflater inflater = (LayoutInflater)getSystemService(</span><br><span class="line">                Context.LAYOUT_INFLATER_SERVICE);</span><br><span class="line">        View root = inflater.inflate(R.layout.permissions_list, <span class="keyword">null</span>);</span><br><span class="line">        <span class="keyword">if</span> (mScrollView == <span class="keyword">null</span>) &#123;</span><br><span class="line">            mScrollView = (CaffeinatedScrollView)root.findViewById(R.id.scrollview);</span><br><span class="line">        &#125;</span><br><span class="line">        ((ViewGroup)root.findViewById(R.id.permission_list)).addView(</span><br><span class="line">                    perms.getPermissionsView(AppSecurityPermissions.WHICH_ALL));</span><br><span class="line">        adapter.addTab(tabHost.newTabSpec(TAB_ID_ALL).setIndicator(</span><br><span class="line">                getText(R.string.allPerms)), root);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span> (!permVisible) &#123;</span><br><span class="line">        <span class="keyword">if</span> (mAppInfo != <span class="keyword">null</span>) &#123;</span><br><span class="line">            <span class="comment">// This is an update to an application, but there are no</span></span><br><span class="line">            <span class="comment">// permissions at all.</span></span><br><span class="line">            msg = (mAppInfo.flags &amp; ApplicationInfo.FLAG_SYSTEM) != <span class="number">0</span></span><br><span class="line">                    ? R.string.install_confirm_question_update_system_no_perms</span><br><span class="line">                    : R.string.install_confirm_question_update_no_perms;</span><br><span class="line"></span><br><span class="line">            findViewById(R.id.spacer).setVisibility(View.VISIBLE);</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            <span class="comment">// This is a new application with no permissions.</span></span><br><span class="line">            msg = R.string.install_confirm_question_no_perms;</span><br><span class="line">        &#125;</span><br><span class="line">        tabHost.setVisibility(View.INVISIBLE);</span><br><span class="line">        mScrollView = <span class="keyword">null</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span> (msg != <span class="number">0</span>) &#123;</span><br><span class="line">        ((TextView)findViewById(R.id.install_confirm_question)).setText(msg);</span><br><span class="line">    &#125;</span><br><span class="line">    mInstallConfirm.setVisibility(View.VISIBLE);</span><br><span class="line">    mOk.setEnabled(<span class="keyword">true</span>);</span><br><span class="line">    <span class="keyword">if</span> (mScrollView == <span class="keyword">null</span>) &#123;</span><br><span class="line">        <span class="comment">// There is nothing to scroll view, so the ok button is immediately</span></span><br><span class="line">        <span class="comment">// set to install.</span></span><br><span class="line">        mOk.setText(R.string.install);</span><br><span class="line">        mOkCanInstall = <span class="keyword">true</span>;</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        mScrollView.setFullScrollAction(<span class="keyword">new</span> Runnable() &#123;</span><br><span class="line">            <span class="meta">@Override</span></span><br><span class="line">            <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">run</span><span class="params">()</span> </span>&#123;</span><br><span class="line">                mOk.setText(R.string.install);</span><br><span class="line">                mOkCanInstall = <span class="keyword">true</span>;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h2 id="2-1-new-AppSecurityPermissions"><a href="#2-1-new-AppSecurityPermissions" class="headerlink" title="2.1 new AppSecurityPermissions"></a>2.1 new AppSecurityPermissions</h2><p>zhel</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="title">AppSecurityPermissions</span><span class="params">(Context context, PackageInfo info)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">this</span>(context);</span><br><span class="line">    Set&lt;MyPermissionInfo&gt; permSet = <span class="keyword">new</span> HashSet&lt;MyPermissionInfo&gt;();</span><br><span class="line">    <span class="keyword">if</span>(info == <span class="keyword">null</span>) &#123;</span><br><span class="line">        <span class="keyword">return</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    mPackageName = info.packageName;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// Convert to a PackageInfo</span></span><br><span class="line">    PackageInfo installedPkgInfo = <span class="keyword">null</span>;</span><br><span class="line">    <span class="comment">// Get requested permissions</span></span><br><span class="line">    <span class="keyword">if</span> (info.requestedPermissions != <span class="keyword">null</span>) &#123;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            installedPkgInfo = mPm.getPackageInfo(info.packageName,</span><br><span class="line">                    PackageManager.GET_PERMISSIONS);</span><br><span class="line">        &#125; <span class="keyword">catch</span> (NameNotFoundException e) &#123;</span><br><span class="line">        &#125;</span><br><span class="line">        extractPerms(info, permSet, installedPkgInfo);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// Get permissions related to shared user if any</span></span><br><span class="line">    <span class="keyword">if</span> (info.sharedUserId != <span class="keyword">null</span>) &#123;</span><br><span class="line">        <span class="keyword">int</span> sharedUid;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            sharedUid = mPm.getUidForSharedUser(info.sharedUserId);</span><br><span class="line">            getAllUsedPermissions(sharedUid, permSet);</span><br><span class="line">        &#125; <span class="keyword">catch</span> (NameNotFoundException e) &#123;</span><br><span class="line">            Log.w(TAG, <span class="string">"Couldn't retrieve shared user id for: "</span> + info.packageName);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// Retrieve list of permissions</span></span><br><span class="line">    mPermsList.addAll(permSet);</span><br><span class="line">    setPermissions(mPermsList);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></div></article><div class="post-copyright"><div class="post-copyright__author"><span class="post-copyright-meta">文章作者: </span><span class="post-copyright-info"><a href="mailto:undefined">Coolqi Li</a></span></div><div class="post-copyright__type"><span class="post-copyright-meta">文章链接: </span><span class="post-copyright-info"><a href="http://yoursite.com/2018/05/03/PMS 第 8 篇 - 通过 PackageInstaller 分析 Install 过程/">http://yoursite.com/2018/05/03/PMS 第 8 篇 - 通过 PackageInstaller 分析 Install 过程/</a></span></div><div class="post-copyright__notice"><span class="post-copyright-meta">版权声明: </span><span class="post-copyright-info">本博客所有文章除特别声明外，均采用 <a href="https://creativecommons.org/licenses/by-nc-sa/4.0/">CC BY-NC-SA 4.0</a> 许可协议。转载请注明来自 <a href="http://yoursite.com">Coolqi`s Blog</a>！</span></div></div><div class="post-meta__tag-list"><a class="post-meta__tags" href="/tags/PackageManager包管理/">PackageManager包管理</a></div><div class="post-qr-code"><div class="post-qr-code-item"><img class="post-qr-code__img" src="/img/zfb.jpg"><div class="post-qr-code__desc">支付宝打赏</div></div><div class="post-qr-code-item"><img class="post-qr-code__img" src="/img/wechat.jpg"><div class="post-qr-code__desc">微信打赏</div></div></div><nav id="pagination"><div class="prev-post pull-left"><a href="/2018/05/03/PMS 第 7 篇 - 通过 pm 指令分析 Install 过程/"><i class="fa fa-chevron-left">  </i><span>PMS 第 7 篇 - 通过 pm 指令分析 InstallPackage 过程</span></a></div><div class="next-post pull-right"><a href="/2018/04/28/PMS 第 6 篇 - PMS_READY 阶段/"><span>PMS 第 6 篇 - PMS_READY 阶段</span><i class="fa fa-chevron-right"></i></a></div></nav><div class="post-adv"><a href="https://www.vultr.com/?ref=7231808"><img src="https://www.vultr.com/media/banner_1.png" width="728" height="90"></a></div></div></div><footer><div class="layout" id="footer"><div class="copyright">&copy;2015 - 2018 By Coolqi Li</div><div class="framework-info"><span>驱动 - </span><a href="http://hexo.io"><span>Hexo</span></a><span class="footer-separator">|</span><span>主题 - </span><a href="https://github.com/Molunerfinn/hexo-theme-melody"><span>Melody</span></a></div><div class="footer_custom_text">Hi, welcome to my <a href="https://molunerfinn.com">blog</a>!</div><div class="busuanzi"><script async src="//dn-lbstatics.qbox.me/busuanzi/2.3/busuanzi.pure.mini.js"></script><span id="busuanzi_container_page_pv"><i class="fa fa-file-o"></i><span id="busuanzi_value_page_pv"></span><span></span></span></div></div></footer><i class="fa fa-arrow-up" id="go-up" aria-hidden="true"></i><script src="/js/third-party/anime.min.js"></script><script src="/js/third-party/jquery.min.js"></script><script src="/js/third-party/jquery.fancybox.min.js"></script><script src="/js/third-party/velocity.min.js"></script><script src="/js/third-party/velocity.ui.min.js"></script><script src="/js/utils.js?version=1.5.6"></script><script src="/js/fancybox.js?version=1.5.6"></script><script src="/js/sidebar.js?version=1.5.6"></script><script src="/js/copy.js?version=1.5.6"></script><script src="/js/fireworks.js?version=1.5.6"></script><script src="/js/transition.js?version=1.5.6"></script><script src="/js/scroll.js?version=1.5.6"></script><script src="/js/head.js?version=1.5.6"></script><script src="/js/search/local-search.js"></script><div class="search-dialog" id="local-search"><div class="search-dialog__title" id="local-search-title">本地搜索</div><div id="local-input-panel"><div id="local-search-input"><div class="local-search-box"><input class="local-search-box--input" placeholder="搜索文章"></div></div></div><hr><div id="local-search-results"><div id="local-hits"></div><div id="local-stats"><div class="local-search-stats__hr" id="hr"><span>由</span> <a href="https://github.com/wzpan/hexo-generator-search" style="color:#49B1F5;">hexo-generator-search</a>
 <span>提供支持</span></div></div></div><span class="search-close-button"><i class="fa fa-times"></i></span></div><div class="search-mask"></div></body></html>
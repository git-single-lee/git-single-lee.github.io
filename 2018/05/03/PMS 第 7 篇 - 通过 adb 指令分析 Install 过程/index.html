<!DOCTYPE html><html lang="zh-Hans"><head><meta charset="UTF-8"><meta http-equiv="X-UA-Compatible" content="IE=edge"><meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1"><meta name="description" content="PMS 第 7 篇 - 通过 pm 指令分析 Install 过程"><meta name="keywords" content="PackageManager包管理"><meta name="author" content="Coolqi.Li,undefined"><meta name="copyright" content="Coolqi.Li"><title>PMS 第 7 篇 - 通过 pm 指令分析 Install 过程 | Coolqi`s Blog</title><link rel="shortcut icon" href="/img/favicon.ico"><link rel="stylesheet" href="/css/index.css?version=1.5.6"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/font-awesome@4.7.0/css/font-awesome.min.css?version=1.5.6"><link rel="dns-prefetch" href="https://cdn.staticfile.org"><link rel="dns-prefetch" href="https://cdn.bootcss.com"><link rel="dns-prefetch" href="https://creativecommons.org"><link rel="stylesheet" type="text/css" href="https://cdn.jsdelivr.net/npm/gitalk/dist/gitalk.min.css"><script src="https://cdn.jsdelivr.net/gh/upupming/gitalk@36368e5dffd049e956cdbbd751ff96c28d8255cf/dist/gitalk.min.js"></script><script src="https://cdn.jsdelivr.net/npm/blueimp-md5@2.10.0/js/md5.min.js"></script><script>var GLOBAL_CONFIG = { 
  root: '/',
  algolia: undefined,
  localSearch: {"path":"search.xml","languages":{"hits_empty":"找不到您查询的内容:${query}"}},
  copy: {
    success: '复制成功',
    error: '复制错误',
    noSupport: '浏览器不支持'
  }
} </script></head><body><canvas class="fireworks"></canvas><i class="fa fa-arrow-right" id="toggle-sidebar" aria-hidden="true"></i><div id="sidebar"><div class="toggle-sidebar-info text-center"><span data-toggle="切换文章详情">切换站点概览</span><hr></div><div class="sidebar-toc"><div class="sidebar-toc__title">目录</div><div class="sidebar-toc__progress"><span class="progress-notice">你已经读了</span><span class="progress-num">0</span><span class="progress-percentage">%</span><div class="sidebar-toc__progress-bar"></div></div><div class="sidebar-toc__content"><ol class="toc"><li class="toc-item toc-level-1"><a class="toc-link" href="#0-综述"><span class="toc-text">0 综述</span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#1-adb-install-commandline-adb-commandline"><span class="toc-text">1 adb install - commandline::adb_commandline</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#1-1-cmd-install-支持-cmd-指令"><span class="toc-text">1.1 cmd install - 支持 cmd 指令</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#1-1-1-commandline-install-app"><span class="toc-text">1.1.1 commandline::install_app</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#1-1-5-new-PackageManagerShellCommand"><span class="toc-text">1.1.5 new PackageManagerShellCommand</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#1-1-5-1-onCommand"><span class="toc-text">1.1.5.1 onCommand</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#1-1-5-2-runInstall"><span class="toc-text">1.1.5.2 runInstall</span></a><ol class="toc-child"><li class="toc-item toc-level-5"><a class="toc-link" href="#1-1-5-2-1-makeInstallParams"><span class="toc-text">1.1.5.2.1 makeInstallParams</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#1-1-5-2-2-doCreateSession"><span class="toc-text">1.1.5.2.2 doCreateSession</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#1-1-5-2-3-doWriteSplit"><span class="toc-text">1.1.5.2.3 doWriteSplit</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#1-1-5-2-4-doCommitSession"><span class="toc-text">1.1.5.2.4 doCommitSession</span></a></li></ol></li></ol></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#1-2-pm-install-不支持-cmd-指令"><span class="toc-text">1.2 pm install - 不支持 cmd 指令</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#1-2-1-commandline-install-app-legacy"><span class="toc-text">1.2.1 commandline::install_app_legacy</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#1-2-2-commandline-pm-command"><span class="toc-text">1.2.2 commandline::pm_command</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#1-2-3-commandline-send-shell-command"><span class="toc-text">1.2.3 commandline::send_shell_command</span></a></li></ol></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#2-pm-install"><span class="toc-text">2 pm install</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#2-1-app-process-main"><span class="toc-text">2.1 app_process::main</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#2-2-AndroidRuntime-start"><span class="toc-text">2.2 AndroidRuntime::start</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#2-3-RuntimeInit-main"><span class="toc-text">2.3 RuntimeInit.main</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#2-4-AR-com-android-internal-os-RuntimeInit-nativeFinishInit"><span class="toc-text">2.4 AR::com_android_internal_os_RuntimeInit_nativeFinishInit</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#2-5-AppRuntime-onStarted"><span class="toc-text">2.5 AppRuntime::onStarted</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#2-6-AndroidRuntime-callMain"><span class="toc-text">2.6 AndroidRuntime::callMain</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#2-7-Pm-main"><span class="toc-text">2.7 Pm.main</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#2-8-Pm-run"><span class="toc-text">2.8 Pm.run</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#2-9-Pm-runInstall"><span class="toc-text">2.9 Pm.runInstall</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#2-9-1-Pm-makeInstallParams-创建事务参数"><span class="toc-text">2.9.1 Pm.makeInstallParams - 创建事务参数</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#2-9-1-1-new-SessionParams"><span class="toc-text">2.9.1.1 new SessionParams</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#2-9-1-2-new-Pm-InstallParams"><span class="toc-text">2.9.1.2 new Pm.InstallParams</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#2-9-2-Pm-doCreateSession-创建事务"><span class="toc-text">2.9.2 Pm.doCreateSession - 创建事务</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#2-9-3-Pm-doWriteSession-写入事务（实际上是拷贝文件）"><span class="toc-text">2.9.3 Pm.doWriteSession - 写入事务（实际上是拷贝文件）</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#2-9-3-1-new-PackageInstaller-Session"><span class="toc-text">2.9.3.1 new PackageInstaller.Session</span></a><ol class="toc-child"><li class="toc-item toc-level-5"><a class="toc-link" href="#2-9-3-1-1-Session-openWrite"><span class="toc-text">2.9.3.1.1 Session.openWrite</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#2-9-3-1-2-Session-addProgress"><span class="toc-text">2.9.3.1.2 Session.addProgress</span></a><ol class="toc-child"><li class="toc-item toc-level-6"><a class="toc-link" href="#2-9-3-1-2-1-PackageInstallerSession-addClientProgress"><span class="toc-text">2.9.3.1.2.1 PackageInstallerSession.addClientProgress</span></a></li><li class="toc-item toc-level-6"><a class="toc-link" href="#2-9-3-1-2-2-PackageInstallerSession-setClientProgress"><span class="toc-text">2.9.3.1.2.2 PackageInstallerSession.setClientProgress</span></a></li><li class="toc-item toc-level-6"><a class="toc-link" href="#2-9-3-1-2-3-PackageInstallerSession-computeProgressLocked"><span class="toc-text">2.9.3.1.2.3 PackageInstallerSession.computeProgressLocked</span></a></li></ol></li></ol></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#2-9-4-Pm-doCommitSession-提交事务"><span class="toc-text">2.9.4 Pm.doCommitSession - 提交事务</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#2-9-4-1-new-LocalIntentReceiver-跨进程返回结果"><span class="toc-text">2.9.4.1 new LocalIntentReceiver - 跨进程返回结果</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#2-9-4-2-LocalIntentReceiver-getIntentSender"><span class="toc-text">2.9.4.2 LocalIntentReceiver.getIntentSender</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#2-9-4-3-Session-commit"><span class="toc-text">2.9.4.3 Session.commit</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#2-9-4-4-LocalIntentReceiver-getResult"><span class="toc-text">2.9.4.4 LocalIntentReceiver.getResult</span></a></li></ol></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#3-1-PackageInstallerS-createSession-Internal-创建事务"><span class="toc-text">3.1 PackageInstallerS.createSession(Internal) - 创建事务</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#3-1-1-PackageInstallerS-getSessionCount"><span class="toc-text">3.1.1 PackageInstallerS.getSessionCount</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#3-1-3-PackageInstallerS-buildStageDir"><span class="toc-text">3.1.3 PackageInstallerS.buildStageDir</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#3-1-3-1-PackageInstallerS-buildStagingDir"><span class="toc-text">3.1.3.1 PackageInstallerS.buildStagingDir</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#3-1-4-new-PackageInstallerSession-事务实例"><span class="toc-text">3.1.4 new PackageInstallerSession - 事务实例</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#3-1-4-1-new-InternalCallback"><span class="toc-text">3.1.4.1 new InternalCallback</span></a><ol class="toc-child"><li class="toc-item toc-level-5"><a class="toc-link" href="#3-1-4-1-1-new-Callbacks"><span class="toc-text">3.1.4.1.1 new Callbacks</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#3-1-4-1-2-Callbacks-notifySessionXXXX"><span class="toc-text">3.1.4.1.2 Callbacks.notifySessionXXXX</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#3-1-4-1-3-Callbacks-handleMessage"><span class="toc-text">3.1.4.1.3 Callbacks.handleMessage</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#3-1-4-1-4-Callbacks-invokeCallback"><span class="toc-text">3.1.4.1.4 Callbacks.invokeCallback</span></a></li></ol></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#3-1-6-PackageInstallerS-writeSessionsAsync-持久化事务"><span class="toc-text">3.1.6 PackageInstallerS.writeSessionsAsync - 持久化事务</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#3-1-6-1-PackageInstallerS-writeSessionsLocked"><span class="toc-text">3.1.6.1 PackageInstallerS.writeSessionsLocked</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#3-1-6-2-PackageInstallerS-writeSessionLocked"><span class="toc-text">3.1.6.2 PackageInstallerS.writeSessionLocked</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#3-1-6-3-PackageInstallerS-writeGrantedRuntimePermissions"><span class="toc-text">3.1.6.3 PackageInstallerS.writeGrantedRuntimePermissions</span></a></li></ol></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#3-2-PackageInstallerS-openSession-获得事务"><span class="toc-text">3.2 PackageInstallerS.openSession - 获得事务</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#3-2-1-PackageInstallerS-openSessionInternal"><span class="toc-text">3.2.1 PackageInstallerS.openSessionInternal</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#3-2-2-PackageInstallerS-isCallingUidOwner"><span class="toc-text">3.2.2 PackageInstallerS.isCallingUidOwner</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#3-3-PackageInstallerS-getSessionInfo-获得事务"><span class="toc-text">3.3 PackageInstallerS.getSessionInfo - 获得事务</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#3-3-1-PackageInstallerSession-generateInfo"><span class="toc-text">3.3.1 PackageInstallerSession.generateInfo</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#3-3-2-new-PackageInstaller-SessionInfo"><span class="toc-text">3.3.2 new PackageInstaller.SessionInfo</span></a></li></ol></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#4-PackageInstallerSession"><span class="toc-text">4 PackageInstallerSession</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#4-1-openWrite"><span class="toc-text">4.1 openWrite</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#4-1-1-openWriteInternal"><span class="toc-text">4.1.1 openWriteInternal</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#4-2-commit-提交事务核心入口"><span class="toc-text">4.2 commit - 提交事务核心入口</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#4-2-1-new-PackageInstallObserverAdapter"><span class="toc-text">4.2.1 new PackageInstallObserverAdapter</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#4-2-1-1-PackageInstallObserverAdapter-onUserActionRequired"><span class="toc-text">4.2.1.1 PackageInstallObserverAdapter.onUserActionRequired</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#4-1-1-2-PackageInstallObserverAdapter-onPackageInstalled"><span class="toc-text">4.1.1.2 PackageInstallObserverAdapter.onPackageInstalled</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#4-2-2-send-MSG-COMMIT"><span class="toc-text">4.2.2 send MSG_COMMIT</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#4-2-2-1-Handler-Callback-handleMessage-MSG-COMMIT"><span class="toc-text">4.2.2.1 Handler.Callback.handleMessage[MSG_COMMIT]</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#4-2-3-commitLocked"><span class="toc-text">4.2.3 commitLocked</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#4-2-3-1-resolveStageDir"><span class="toc-text">4.2.3.1 resolveStageDir</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#4-2-3-2-validateInstallLocked"><span class="toc-text">4.2.3.2 validateInstallLocked</span></a><ol class="toc-child"><li class="toc-item toc-level-5"><a class="toc-link" href="#4-2-3-2-1-assertApkConsistent"><span class="toc-text">4.2.3.2.1 assertApkConsistent</span></a></li></ol></li><li class="toc-item toc-level-4"><a class="toc-link" href="#4-2-3-3-close"><span class="toc-text">4.2.3.3 close</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#4-2-3-4-calculateInstalledSize"><span class="toc-text">4.2.3.4 calculateInstalledSize</span></a><ol class="toc-child"><li class="toc-item toc-level-5"><a class="toc-link" href="#4-2-3-4-1-calculateInstalledSize"><span class="toc-text">4.2.3.4.1 calculateInstalledSize</span></a></li></ol></li><li class="toc-item toc-level-4"><a class="toc-link" href="#4-2-3-5-computeProgressLocked"><span class="toc-text">4.2.3.5 computeProgressLocked</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#4-2-3-6-extractNativeLibraries"><span class="toc-text">4.2.3.6 extractNativeLibraries</span></a></li></ol></li></ol></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#5-PackageManagerService"><span class="toc-text">5 PackageManagerService</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#5-1-PackageManagerService-installStage"><span class="toc-text">5.1 PackageManagerService.installStage</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#5-1-1-new-VerificationInfo"><span class="toc-text">5.1.1 new VerificationInfo</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#5-1-2-new-OriginInfo"><span class="toc-text">5.1.2 new OriginInfo</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#5-1-3-new-PMS-InstallParams"><span class="toc-text">5.1.3 new PMS.InstallParams</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#5-2-PackageHandler-doHandleMessage-INIT-COPY"><span class="toc-text">5.2 PackageHandler.doHandleMessage[INIT_COPY]</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#5-2-1-PackageHandler-connectToService"><span class="toc-text">5.2.1 PackageHandler.connectToService</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#5-2-2-InstallParams-serviceError"><span class="toc-text">5.2.2 InstallParams.serviceError</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#5-3-PackageHandler-doHandleMessage-MCS-BOUND-绑定服务"><span class="toc-text">5.3 PackageHandler.doHandleMessage[MCS_BOUND] - 绑定服务</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#5-4-InstallParams-startCopy"><span class="toc-text">5.4 InstallParams.startCopy</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#5-4-1-PackageHandler-doHandleMessage-MCS-GIVE-UP-放弃安装"><span class="toc-text">5.4.1 PackageHandler.doHandleMessage[MCS_GIVE_UP] - 放弃安装</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#5-4-2-InstallParams-handleServiceError"><span class="toc-text">5.4.2 InstallParams.handleServiceError</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#5-4-3-PackageHandler-doHandleMessage-MCS-RECONNECT-重连服务"><span class="toc-text">5.4.3 PackageHandler.doHandleMessage[MCS_RECONNECT] - 重连服务</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#5-4-4-InstallParams-handleReturnCode"><span class="toc-text">5.4.4 InstallParams.handleReturnCode</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#5-5-InstallParams-handleStartCopy"><span class="toc-text">5.5 InstallParams.handleStartCopy</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#5-5-1-DefaultContainerService-getMinimalPackageInfo"><span class="toc-text">5.5.1 DefaultContainerService.getMinimalPackageInfo</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#5-5-1-1-new-PackageInfoLite"><span class="toc-text">5.5.1.1 new PackageInfoLite</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#5-5-1-2-PackageHelper-resolveInstallLocation"><span class="toc-text">5.5.1.2 PackageHelper.resolveInstallLocation</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#5-5-2-PackageManagerS-installLocationPolicy"><span class="toc-text">5.5.2 PackageManagerS.installLocationPolicy</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#5-5-3-PackageManagerS-createInstallArgs"><span class="toc-text">5.5.3 PackageManagerS.createInstallArgs</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#5-5-3-1-new-FileInstallArgs-要安装的-apk"><span class="toc-text">5.5.3.1 new FileInstallArgs - 要安装的 apk</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#5-5-4-PackageManagerService-isVerificationEnabled"><span class="toc-text">5.5.4 PackageManagerService.isVerificationEnabled</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#5-5-5-new-PackageVerificationState"><span class="toc-text">5.5.5 new PackageVerificationState</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#5-6-PackageHandler-doHandleMessage-CHECK-PENDING-VERIFICATION-校验完成"><span class="toc-text">5.6 PackageHandler.doHandleMessage[CHECK_PENDING_VERIFICATION] - 校验完成</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#5-6-1-PackageManagerS-broadcastPackageVerified"><span class="toc-text">5.6.1 PackageManagerS.broadcastPackageVerified</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#5-6-2-FileInstallArgs-do-copyApk"><span class="toc-text">5.6.2 FileInstallArgs.(do)copyApk</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#5-6-2-1-PackageInstallerService-allocateStageDirLegacy"><span class="toc-text">5.6.2.1 PackageInstallerService.allocateStageDirLegacy</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#5-6-2-2-DefaultContainerService-copyPackage-Inner"><span class="toc-text">5.6.2.2 DefaultContainerService.copyPackage(Inner)</span></a></li></ol></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#5-7-PackageManagerS-processPendingInstall"><span class="toc-text">5.7 PackageManagerS.processPendingInstall</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#5-7-1-new-PackageInstalledInfo"><span class="toc-text">5.7.1 new PackageInstalledInfo</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#5-7-1-1-new-PackageRemovedInfo"><span class="toc-text">5.7.1.1 new PackageRemovedInfo</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#5-7-2-FileInstallArgs-doPreInstall"><span class="toc-text">5.7.2 FileInstallArgs.doPreInstall</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#5-7-2-1-FileInstallArgs-cleanUp-ResourcesLI"><span class="toc-text">5.7.2.1 FileInstallArgs.cleanUp(ResourcesLI)</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#5-7-3-PackageManagerS-installPackageTracedLI-核心安装入口"><span class="toc-text">5.7.3 PackageManagerS.installPackageTracedLI - 核心安装入口</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#5-7-3-1-PackageParser-parsePackage"><span class="toc-text">5.7.3.1 PackageParser.parsePackage</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#5-7-3-2-shouldCheckUpgradeKeySetLP"><span class="toc-text">5.7.3.2 shouldCheckUpgradeKeySetLP</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#5-7-3-3-checkUpgradeKeySetLP"><span class="toc-text">5.7.3.3 checkUpgradeKeySetLP</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#5-7-3-4-verifySignaturesLP"><span class="toc-text">5.7.3.4 verifySignaturesLP</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#5-7-3-5-FileInstallArgs-doRename-重命名临时目录"><span class="toc-text">5.7.3.5 FileInstallArgs.doRename - 重命名临时目录</span></a><ol class="toc-child"><li class="toc-item toc-level-5"><a class="toc-link" href="#5-7-3-5-1-getNextCodePath"><span class="toc-text">5.7.3.5.1 getNextCodePath</span></a></li></ol></li><li class="toc-item toc-level-4"><a class="toc-link" href="#5-7-3-7-freezePackageForInstall-冻结应用"><span class="toc-text">5.7.3.7 freezePackageForInstall - 冻结应用</span></a><ol class="toc-child"><li class="toc-item toc-level-5"><a class="toc-link" href="#5-7-3-7-1-new-PackageFreezer"><span class="toc-text">5.7.3.7.1 new PackageFreezer</span></a></li></ol></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#5-7-4-FileInstallArgs-doPostInstall"><span class="toc-text">5.7.4 FileInstallArgs.doPostInstall</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#5-7-5-new-PostInstallData"><span class="toc-text">5.7.5 new PostInstallData</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#5-8-PackageHandler-doHandleMessage-POST-INSTALL-安装收尾"><span class="toc-text">5.8 PackageHandler.doHandleMessage[POST_INSTALL] - 安装收尾</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#5-8-1-PackageManagerS-handlePackagePostInstall"><span class="toc-text">5.8.1 PackageManagerS.handlePackagePostInstall</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#5-8-1-1-FileInstallArgs-doPostDeleteLI-删除被更新的旧-apk"><span class="toc-text">5.8.1.1 FileInstallArgs.doPostDeleteLI - 删除被更新的旧 apk</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#5-8-1-2-FileInstallArgs-cleanUpResourcesLI"><span class="toc-text">5.8.1.2 FileInstallArgs.cleanUpResourcesLI</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#5-8-2-IPackageInstallObserver2-onPackageInstalled"><span class="toc-text">5.8.2 IPackageInstallObserver2.onPackageInstalled</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#5-8-2-1-PackageInstallerSession-destroyInternal"><span class="toc-text">5.8.2.1 PackageInstallerSession.destroyInternal</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#5-8-2-2-PackageInstallerSession-dispatchSessionFinished"><span class="toc-text">5.8.2.2 PackageInstallerSession.dispatchSessionFinished</span></a><ol class="toc-child"><li class="toc-item toc-level-5"><a class="toc-link" href="#5-8-2-2-2-InternalCallback-onSessionFinished"><span class="toc-text">5.8.2.2.2 InternalCallback.onSessionFinished</span></a><ol class="toc-child"><li class="toc-item toc-level-6"><a class="toc-link" href="#5-8-2-2-2-1-Callback-notifySessionFinished"><span class="toc-text">5.8.2.2.2.1 Callback.notifySessionFinished</span></a></li></ol></li></ol></li></ol></li></ol></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#6-PackageManagerS-replacePackageLIF-覆盖安装"><span class="toc-text">6 PackageManagerS.replacePackageLIF - 覆盖安装</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#6-1-参数分析"><span class="toc-text">6.1 参数分析</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#6-2-方法分析"><span class="toc-text">6.2 方法分析</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#6-2-1-replaceSystemPackageLIF-覆盖安装系统应用"><span class="toc-text">6.2.1 replaceSystemPackageLIF - 覆盖安装系统应用</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#6-2-1-1-removePackageLI"><span class="toc-text">6.2.1.1 removePackageLI</span></a><ol class="toc-child"><li class="toc-item toc-level-5"><a class="toc-link" href="#6-2-1-1-1-cleanPackageDataStructuresLILPw"><span class="toc-text">6.2.1.1.1 cleanPackageDataStructuresLILPw</span></a></li></ol></li><li class="toc-item toc-level-4"><a class="toc-link" href="#6-2-1-2-disableSystemPackageLPw"><span class="toc-text">6.2.1.2 disableSystemPackageLPw</span></a><ol class="toc-child"><li class="toc-item toc-level-5"><a class="toc-link" href="#6-2-1-2-1-Settings-disableSystemPackageLPw"><span class="toc-text">6.2.1.2.1 Settings.disableSystemPackageLPw</span></a></li></ol></li><li class="toc-item toc-level-4"><a class="toc-link" href="#6-2-1-3-createInstallArgsForExisting-要删除的被更新-apk"><span class="toc-text">6.2.1.3 createInstallArgsForExisting - 要删除的被更新 apk</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#6-2-1-4-clearAppDataLIF"><span class="toc-text">6.2.1.4 clearAppDataLIF</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#6-2-1-5-clearAppProfilesLIF"><span class="toc-text">6.2.1.5 clearAppProfilesLIF</span></a><ol class="toc-child"><li class="toc-item toc-level-5"><a class="toc-link" href="#6-2-1-5-1-clearAppProfilesLeafLIF"><span class="toc-text">6.2.1.5.1 clearAppProfilesLeafLIF</span></a></li></ol></li><li class="toc-item toc-level-4"><a class="toc-link" href="#6-2-1-6-removeInstalledPackageLI"><span class="toc-text">6.2.1.6 removeInstalledPackageLI</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#6-2-1-7-enableSystemPackageLPw"><span class="toc-text">6.2.1.7 enableSystemPackageLPw</span></a><ol class="toc-child"><li class="toc-item toc-level-5"><a class="toc-link" href="#6-2-1-7-1-Settings-enableSystemPackageLPw"><span class="toc-text">6.2.1.7.1 Settings.enableSystemPackageLPw</span></a></li></ol></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#6-2-2-replaceNonSystemPackageLIF-覆盖安装三方应用-gt-接入-8"><span class="toc-text">6.2.2 replaceNonSystemPackageLIF - 覆盖安装三方应用 -&gt; 接入 8</span></a></li></ol></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#7-PackageManagerS-installNewPackageLIF-全新安装"><span class="toc-text">7 PackageManagerS.installNewPackageLIF - 全新安装</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#7-1-参数分析"><span class="toc-text">7.1 参数分析</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#7-2-方法解析"><span class="toc-text">7.2 方法解析</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#7-2-1-updateSettingsLI"><span class="toc-text">7.2.1 updateSettingsLI</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#7-2-1-1-updateSettingsInternalLI"><span class="toc-text">7.2.1.1 updateSettingsInternalLI</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#7-2-2-prepareAppDataAfterInstallLIF"><span class="toc-text">7.2.2 prepareAppDataAfterInstallLIF</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#7-2-2-1-prepareAppDataLIF"><span class="toc-text">7.2.2.1 prepareAppDataLIF</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#7-2-2-2-prepareAppDataLeafLIF"><span class="toc-text">7.2.2.2 prepareAppDataLeafLIF</span></a></li></ol></li></ol></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#8-PackageManagerS-replaceNonSystemPackageLIF-接-6-2-2"><span class="toc-text">8 PackageManagerS.replaceNonSystemPackageLIF - 接 6.2.2</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#8-1-deletePackageLIF"><span class="toc-text">8.1 deletePackageLIF</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#8-1-1-clearPackageStateForUserLIF"><span class="toc-text">8.1.1 clearPackageStateForUserLIF</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#8-1-1-1-destroyAppDataLIF-gt-Leaf"><span class="toc-text">8.1.1.1 destroyAppDataLIF -&gt;[Leaf]</span></a><ol class="toc-child"><li class="toc-item toc-level-5"><a class="toc-link" href="#8-1-1-1-1-PackageSetting-getCeDataInode"><span class="toc-text">8.1.1.1.1 PackageSetting.getCeDataInode</span></a></li></ol></li><li class="toc-item toc-level-4"><a class="toc-link" href="#8-1-1-3-schedulePackageCleaning"><span class="toc-text">8.1.1.3 schedulePackageCleaning</span></a><ol class="toc-child"><li class="toc-item toc-level-5"><a class="toc-link" href="#8-1-1-3-1-Packagehandler-doHandleMessage-START-CLEANING-PACKAGE"><span class="toc-text">8.1.1.3.1 Packagehandler.doHandleMessage[START_CLEANING_PACKAGE]</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#8-1-1-3-2-startCleaningPackages"><span class="toc-text">8.1.1.3.2 startCleaningPackages</span></a></li></ol></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#8-1-2-markPackageUninstalledForUserLPw"><span class="toc-text">8.1.2 markPackageUninstalledForUserLPw</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#8-1-3-deleteSystemPackageLIF"><span class="toc-text">8.1.3 deleteSystemPackageLIF</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#8-1-4-deleteInstalledPackageLIF"><span class="toc-text">8.1.4 deleteInstalledPackageLIF</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#8-1-4-1-removePackageDataLIF"><span class="toc-text">8.1.4.1 removePackageDataLIF</span></a><ol class="toc-child"><li class="toc-item toc-level-5"><a class="toc-link" href="#8-1-4-1-1-removePackageLI"><span class="toc-text">8.1.4.1.1 removePackageLI</span></a></li></ol></li></ol></li></ol></li></ol></li></ol></div></div><div class="author-info hide"><div class="author-info__avatar text-center"><img src="/img/avatar.png"></div><div class="author-info__name text-center">Coolqi.Li</div><div class="author-info__description text-center">“你好，我是李帅奇，Android 系统工程师，MineCraft 忠实玩家，设计和绘画爱好者，缺妹纸晚期患者，熬夜星人。”</div><hr><div class="author-info-articles"><a class="author-info-articles__archives article-meta" href="/archives"><span class="pull-left">文章</span><span class="pull-right">64</span></a><a class="author-info-articles__tags article-meta" href="/tags"><span class="pull-left">标签</span><span class="pull-right">14</span></a><a class="author-info-articles__categories article-meta" href="/categories"><span class="pull-left">分类</span><span class="pull-right">15</span></a></div><hr><div class="author-info-links"><div class="author-info-links__title text-center">Links</div><a class="author-info-links__name text-center" href="https://developer.android.google.cn/">AndroidDeveloper</a><a class="author-info-links__name text-center" href="http://www.android-studio.org/">AndroidStudio</a><a class="author-info-links__name text-center" href="https://www.jianshu.com/u/123a20a96441">简书</a><a class="author-info-links__name text-center" href="https://weibo.com/coolqiLi">微博</a></div></div></div><div id="content-outer"><div id="top-container" style="background-image: url(https://ws1.sinaimg.cn/large/8700af19ly1fvpabr30o6j22yo1o0q7i.jpg)"><div id="page-header"><span class="pull-left"> <a id="site-name" href="/">Coolqi`s Blog</a></span><i class="fa fa-bars toggle-menu pull-right" aria-hidden="true"></i><span class="pull-right menus"><a class="site-page social-icon search"><i class="fa fa-search"></i><span> 搜索</span></a><a class="site-page" href="/">Home</a><a class="site-page" href="/categories">Categories</a><a class="site-page" href="/tags">Tags</a><a class="site-page" href="/about">About</a><a class="site-page" href="/archives">Archives</a></span></div><div id="post-info"><div id="post-title">PMS 第 7 篇 - 通过 pm 指令分析 Install 过程</div><div id="post-meta"><time class="post-meta__date"><i class="fa fa-calendar" aria-hidden="true"></i> 2018-05-03</time><span class="post-meta__separator">|</span><i class="fa fa-inbox post-meta__icon" aria-hidden="true"></i><a class="post-meta__categories" href="/categories/AndroidFramework源码分析/">AndroidFramework源码分析</a><i class="fa fa-angle-right" aria-hidden="true"></i><i class="fa fa-inbox post-meta__icon" aria-hidden="true"></i><a class="post-meta__categories" href="/categories/AndroidFramework源码分析/PackageManager包管理/">PackageManager包管理</a><div class="post-meta-wordcount"><span>字数总计: </span><span class="word-count">40.3k</span><span class="post-meta__separator">|</span><span>阅读时长: 199 分钟</span></div></div></div></div><div class="layout" id="content-inner"><article id="post"><div class="article-container" id="post-content"><p>[toc]</p>
<p>基于 Android 7.1.1 源码分析 PackageManagerService 的架构和逻辑实现！</p>
<h1 id="0-综述"><a href="#0-综述" class="headerlink" title="0 综述"></a>0 综述</h1><p>本篇文章总结下 install package 的过程，在 Abdroid 7.1.1 上安装一个应用有如下的方式：</p>
<ul>
<li>adb install（根据情况转为 cmd package install 或者 pm install）</li>
<li>adb shell cmd package install（目前都是优先使用）</li>
<li>adb shell pm install;</li>
<li>拷贝 apk 到文件管理器中触发安装；</li>
<li>通过应用商店安装；</li>
</ul>
<p>这里我们先从 adb install 入手，对于其他的安装方式，我们后面再分析！</p>
<h1 id="1-adb-install-commandline-adb-commandline"><a href="#1-adb-install-commandline-adb-commandline" class="headerlink" title="1 adb install - commandline::adb_commandline"></a>1 adb install - commandline::adb_commandline</h1><p>adb install 的执行从 system/core/adb/commandline.cpp 开始：</p>
<p>adb_commandline 中会涉及到大量的 adb 指令的处理，这里我们只关注 adb install 的处理：</p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">adb_commandline</span><span class="params">(<span class="keyword">int</span> argc, <span class="keyword">const</span> <span class="keyword">char</span> **argv)</span> </span>&#123;</span><br><span class="line">    ... ... ...</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">else</span> <span class="keyword">if</span> (!<span class="built_in">strcmp</span>(argv[<span class="number">0</span>], <span class="string">"push"</span>)) &#123; <span class="comment">// adb push 命令！</span></span><br><span class="line">        <span class="keyword">bool</span> copy_attrs = <span class="literal">false</span>;</span><br><span class="line">        <span class="built_in">std</span>::<span class="built_in">vector</span>&lt;<span class="keyword">const</span> <span class="keyword">char</span>*&gt; srcs;</span><br><span class="line">        <span class="keyword">const</span> <span class="keyword">char</span>* dst = <span class="literal">nullptr</span>;</span><br><span class="line"></span><br><span class="line">        parse_push_pull_args(&amp;argv[<span class="number">1</span>], argc - <span class="number">1</span>, &amp;srcs, &amp;dst, &amp;copy_attrs);</span><br><span class="line">        <span class="keyword">if</span> (srcs.empty() || !dst) <span class="keyword">return</span> usage();</span><br><span class="line">        <span class="keyword">return</span> do_sync_push(srcs, dst) ? <span class="number">0</span> : <span class="number">1</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    ... ... ...</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">else</span> <span class="keyword">if</span> (!<span class="built_in">strcmp</span>(argv[<span class="number">0</span>], <span class="string">"install"</span>)) &#123; <span class="comment">//【1.2】adb install 命令！</span></span><br><span class="line">        <span class="keyword">if</span> (argc &lt; <span class="number">2</span>) <span class="keyword">return</span> usage();</span><br><span class="line">        <span class="keyword">if</span> (_use_legacy_install()) &#123;</span><br><span class="line">            <span class="comment">//【1.2】正常情况下调用 install_app_legacy！</span></span><br><span class="line">            <span class="keyword">return</span> install_app_legacy(transport_type, serial, argc, argv);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">// 如果支持 FeatureCmd，那就调用 install_app</span></span><br><span class="line">        <span class="keyword">return</span> install_app(transport_type, serial, argc, argv);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">else</span> <span class="keyword">if</span> (!<span class="built_in">strcmp</span>(argv[<span class="number">0</span>], <span class="string">"install-multiple"</span>)) &#123; <span class="comment">// adb install-multiple 命令</span></span><br><span class="line">        <span class="keyword">if</span> (argc &lt; <span class="number">2</span>) <span class="keyword">return</span> usage();</span><br><span class="line">        <span class="keyword">return</span> install_multiple_app(transport_type, serial, argc, argv);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">else</span> <span class="keyword">if</span> (!<span class="built_in">strcmp</span>(argv[<span class="number">0</span>], <span class="string">"uninstall"</span>)) &#123; <span class="comment">// adb uninstall 命令</span></span><br><span class="line">        <span class="keyword">if</span> (argc &lt; <span class="number">2</span>) <span class="keyword">return</span> usage();</span><br><span class="line">        <span class="keyword">if</span> (_use_legacy_install()) &#123;</span><br><span class="line">            <span class="keyword">return</span> uninstall_app_legacy(transport_type, serial, argc, argv);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> uninstall_app(transport_type, serial, argc, argv);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    ... ... ...</span><br><span class="line"></span><br><span class="line">    usage();</span><br><span class="line">    <span class="keyword">return</span> <span class="number">1</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>这里看到：</p>
<ul>
<li>如果支持 cmd 命令的情况下，会调用 install_app；</li>
<li>如果不支持，执行 install_app_legacy 方法！</li>
</ul>
<h2 id="1-1-cmd-install-支持-cmd-指令"><a href="#1-1-cmd-install-支持-cmd-指令" class="headerlink" title="1.1 cmd install - 支持 cmd 指令"></a>1.1 cmd install - 支持 cmd 指令</h2><h3 id="1-1-1-commandline-install-app"><a href="#1-1-1-commandline-install-app" class="headerlink" title="1.1.1 commandline::install_app"></a>1.1.1 commandline::install_app</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">static</span> <span class="keyword">int</span> <span class="title">install_app</span><span class="params">(TransportType transport, <span class="keyword">const</span> <span class="keyword">char</span>* serial, <span class="keyword">int</span> argc, <span class="keyword">const</span> <span class="keyword">char</span>** argv)</span> </span>&#123;</span><br><span class="line">    <span class="comment">// The last argument must be the APK file</span></span><br><span class="line">    <span class="keyword">const</span> <span class="keyword">char</span>* file = argv[argc - <span class="number">1</span>];</span><br><span class="line">    <span class="keyword">const</span> <span class="keyword">char</span>* dot = strrchr(file, <span class="string">'.'</span>);</span><br><span class="line">    bool found_apk = <span class="keyword">false</span>;</span><br><span class="line">    struct stat sb;</span><br><span class="line">    <span class="keyword">if</span> (dot &amp;&amp; !strcasecmp(dot, <span class="string">".apk"</span>)) &#123;</span><br><span class="line">        <span class="keyword">if</span> (stat(file, &amp;sb) == -<span class="number">1</span> || !S_ISREG(sb.st_mode)) &#123;</span><br><span class="line">            fprintf(stderr, <span class="string">"Invalid APK file: %s\n"</span>, file);</span><br><span class="line">            <span class="keyword">return</span> EXIT_FAILURE;</span><br><span class="line">        &#125;</span><br><span class="line">        found_apk = <span class="keyword">true</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (!found_apk) &#123;</span><br><span class="line">        fprintf(stderr, <span class="string">"Missing APK file\n"</span>);</span><br><span class="line">        <span class="keyword">return</span> EXIT_FAILURE;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">int</span> localFd = adb_open(file, O_RDONLY);</span><br><span class="line">    <span class="keyword">if</span> (localFd &lt; <span class="number">0</span>) &#123;</span><br><span class="line">        fprintf(stderr, <span class="string">"Failed to open %s: %s\n"</span>, file, strerror(errno));</span><br><span class="line">        <span class="keyword">return</span> <span class="number">1</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    std::string error;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//【1】使用 cmd package 命令！</span></span><br><span class="line">    std::string cmd = <span class="string">"exec:cmd package"</span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// don't copy the APK name, but, copy the rest of the arguments as-is</span></span><br><span class="line">    <span class="keyword">while</span> (argc-- &gt; <span class="number">1</span>) &#123;</span><br><span class="line">        cmd += <span class="string">" "</span> + escape_arg(std::string(*argv++));</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// add size parameter [required for streaming installs]</span></span><br><span class="line">    <span class="comment">// do last to override any user specified value</span></span><br><span class="line">    cmd += <span class="string">" "</span> + android::base::StringPrintf(<span class="string">"-S %"</span> PRIu64, static_cast&lt;uint64_t&gt;(sb.st_size));</span><br><span class="line"></span><br><span class="line">    <span class="keyword">int</span> remoteFd = adb_connect(cmd, &amp;error);</span><br><span class="line">    <span class="keyword">if</span> (remoteFd &lt; <span class="number">0</span>) &#123;</span><br><span class="line">        fprintf(stderr, <span class="string">"Connect error for write: %s\n"</span>, error.c_str());</span><br><span class="line">        adb_close(localFd);</span><br><span class="line">        <span class="keyword">return</span> <span class="number">1</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">char</span> buf[BUFSIZ];</span><br><span class="line">    copy_to_file(localFd, remoteFd);</span><br><span class="line">    read_status_line(remoteFd, buf, sizeof(buf));</span><br><span class="line"></span><br><span class="line">    adb_close(localFd);</span><br><span class="line">    adb_close(remoteFd);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (strncmp(<span class="string">"Success"</span>, buf, <span class="number">7</span>)) &#123;</span><br><span class="line">        fprintf(stderr, <span class="string">"Failed to install %s: %s"</span>, file, buf);</span><br><span class="line">        <span class="keyword">return</span> <span class="number">1</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    fputs(buf, stderr);</span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h3 id="1-1-5-new-PackageManagerShellCommand"><a href="#1-1-5-new-PackageManagerShellCommand" class="headerlink" title="1.1.5 new PackageManagerShellCommand"></a>1.1.5 new PackageManagerShellCommand</h3><h4 id="1-1-5-1-onCommand"><a href="#1-1-5-1-onCommand" class="headerlink" title="1.1.5.1 onCommand"></a>1.1.5.1 onCommand</h4><p>最终，会调用 PackageManagerShellCommand 的 onCommand 方法：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">PackageManagerShellCommand</span> <span class="keyword">extends</span> <span class="title">ShellCommand</span> </span>&#123;</span><br><span class="line">    ... ... ... ...</span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">int</span> <span class="title">onCommand</span><span class="params">(String cmd)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">if</span> (cmd == <span class="keyword">null</span>) &#123;</span><br><span class="line">            <span class="keyword">return</span> handleDefaultCommands(cmd);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">final</span> PrintWriter pw = getOutPrintWriter();</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            <span class="keyword">switch</span>(cmd) &#123;</span><br><span class="line">                <span class="keyword">case</span> <span class="string">"install"</span>: </span><br><span class="line">                    <span class="comment">//【*1.1.5.2】对于 install 调用，调用 runInstall 方法：</span></span><br><span class="line">                    <span class="keyword">return</span> runInstall();</span><br><span class="line">                <span class="keyword">case</span> <span class="string">"install-abandon"</span>:</span><br><span class="line">                <span class="keyword">case</span> <span class="string">"install-destroy"</span>:</span><br><span class="line">                    <span class="keyword">return</span> runInstallAbandon();</span><br><span class="line">                <span class="keyword">case</span> <span class="string">"install-commit"</span>:</span><br><span class="line">                    <span class="keyword">return</span> runInstallCommit();</span><br><span class="line">                <span class="keyword">case</span> <span class="string">"install-create"</span>:</span><br><span class="line">                    <span class="keyword">return</span> runInstallCreate();</span><br><span class="line">                <span class="keyword">case</span> <span class="string">"install-remove"</span>:</span><br><span class="line">                    <span class="keyword">return</span> runInstallRemove();</span><br><span class="line">                <span class="keyword">case</span> <span class="string">"install-write"</span>:</span><br><span class="line">                    <span class="keyword">return</span> runInstallWrite();</span><br><span class="line">                ... ... ...</span><br><span class="line">                <span class="keyword">default</span>:</span><br><span class="line">                    <span class="keyword">return</span> handleDefaultCommands(cmd);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125; <span class="keyword">catch</span> (RemoteException e) &#123;</span><br><span class="line">            pw.println(<span class="string">"Remote exception: "</span> + e);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> -<span class="number">1</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>这里我们先看 runInstall，其他指令相对于 runInstall 简单了不少！</p>
<h4 id="1-1-5-2-runInstall"><a href="#1-1-5-2-runInstall" class="headerlink" title="1.1.5.2 runInstall"></a>1.1.5.2 runInstall</h4><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">int</span> <span class="title">runInstall</span><span class="params">()</span> <span class="keyword">throws</span> RemoteException </span>&#123;</span><br><span class="line">    <span class="keyword">final</span> PrintWriter pw = getOutPrintWriter();</span><br><span class="line">    <span class="comment">//【*1.1.5.2.1】这个和 pm install 的流程是一样的，虽然这个同名方法是在 PackageManagerShellCommand 中，但实际上</span></span><br><span class="line">    <span class="comment">// 两个方法的代码一模一样，大家可以参考【*2.9.1】</span></span><br><span class="line">    <span class="keyword">final</span> InstallParams params = makeInstallParams();</span><br><span class="line">    <span class="keyword">final</span> String inPath = getNextArg(); <span class="comment">// 获得安装包的 path！</span></span><br><span class="line">    <span class="keyword">boolean</span> installExternal =</span><br><span class="line">            (params.sessionParams.installFlags &amp; PackageManager.INSTALL_EXTERNAL) != <span class="number">0</span>;</span><br><span class="line">    <span class="keyword">if</span> (params.sessionParams.sizeBytes &lt; <span class="number">0</span> &amp;&amp; inPath != <span class="keyword">null</span>) &#123;</span><br><span class="line">        File file = <span class="keyword">new</span> File(inPath);</span><br><span class="line">        <span class="keyword">if</span> (file.isFile()) &#123;</span><br><span class="line">            <span class="keyword">if</span> (installExternal) &#123;</span><br><span class="line">                <span class="keyword">try</span> &#123;</span><br><span class="line">                    <span class="comment">//【1】解析 apk，用于计算 apk 大小！！</span></span><br><span class="line">                    ApkLite baseApk = PackageParser.parseApkLite(file, <span class="number">0</span>);</span><br><span class="line">                    PackageLite pkgLite = <span class="keyword">new</span> PackageLite(<span class="keyword">null</span>, baseApk, <span class="keyword">null</span>, <span class="keyword">null</span>, <span class="keyword">null</span>);</span><br><span class="line">                    <span class="comment">//【*4.2.3.4.1】调用 PackageHelper 计算空间大小；</span></span><br><span class="line">                    params.sessionParams.setSize(</span><br><span class="line">                            PackageHelper.calculateInstalledSize(pkgLite, <span class="keyword">false</span>,</span><br><span class="line">                                    params.sessionParams.abiOverride));</span><br><span class="line">                &#125; <span class="keyword">catch</span> (PackageParserException | IOException e) &#123;</span><br><span class="line">                    pw.println(<span class="string">"Error: Failed to parse APK file : "</span> + e);</span><br><span class="line">                    <span class="keyword">return</span> <span class="number">1</span>;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                params.sessionParams.setSize(file.length());</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">//【*1.1.5.2.2】创建安装事务，返回事务 id！</span></span><br><span class="line">    <span class="keyword">final</span> <span class="keyword">int</span> sessionId = doCreateSession(params.sessionParams,</span><br><span class="line">            params.installerPackageName, params.userId);</span><br><span class="line">    <span class="keyword">boolean</span> abandonSession = <span class="keyword">true</span>;</span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">        <span class="keyword">if</span> (inPath == <span class="keyword">null</span> &amp;&amp; params.sessionParams.sizeBytes == <span class="number">0</span>) &#123;</span><br><span class="line">            pw.println(<span class="string">"Error: must either specify a package size or an APK file"</span>);</span><br><span class="line">            <span class="keyword">return</span> <span class="number">1</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">//【*1.1.5.2.3】进一步处理事务，我们可以看到，这种方法只能装 base apk！！</span></span><br><span class="line">        <span class="keyword">if</span> (doWriteSplit(sessionId, inPath, params.sessionParams.sizeBytes, <span class="string">"base.apk"</span>,</span><br><span class="line">                <span class="keyword">false</span> <span class="comment">/*logSuccess*/</span>) != PackageInstaller.STATUS_SUCCESS) &#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="number">1</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">//【*1.1.5.2.4】提交事务！！</span></span><br><span class="line">        <span class="keyword">if</span> (doCommitSession(sessionId, <span class="keyword">false</span> <span class="comment">/*logSuccess*/</span>)</span><br><span class="line">                != PackageInstaller.STATUS_SUCCESS) &#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="number">1</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        abandonSession = <span class="keyword">false</span>;</span><br><span class="line">        pw.println(<span class="string">"Success"</span>);</span><br><span class="line">        <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">    &#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">        <span class="keyword">if</span> (abandonSession) &#123;</span><br><span class="line">            <span class="keyword">try</span> &#123;</span><br><span class="line">                doAbandonSession(sessionId, <span class="keyword">false</span> <span class="comment">/*logSuccess*/</span>);</span><br><span class="line">            &#125; <span class="keyword">catch</span> (Exception ignore) &#123;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h5 id="1-1-5-2-1-makeInstallParams"><a href="#1-1-5-2-1-makeInstallParams" class="headerlink" title="1.1.5.2.1 makeInstallParams"></a>1.1.5.2.1 makeInstallParams</h5><p>这个和 pm install 的流程是一样的，虽然这个同名方法是在 PackageManagerShellCommand 中，但实际上两个方法的代码一模一样，大家可以参考【*2.9.1】!</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">private</span> InstallParams <span class="title">makeInstallParams</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    <span class="comment">//【1】这个 InstallParams 也是内部类，但是和 pm install 中的代码是一样的！</span></span><br><span class="line">    <span class="keyword">final</span> SessionParams sessionParams = <span class="keyword">new</span> SessionParams(SessionParams.MODE_FULL_INSTALL);</span><br><span class="line">    <span class="keyword">final</span> InstallParams params = <span class="keyword">new</span> InstallParams();</span><br><span class="line">    params.sessionParams = sessionParams;</span><br><span class="line">    String opt;</span><br><span class="line">    <span class="keyword">while</span> ((opt = getNextOption()) != <span class="keyword">null</span>) &#123;</span><br><span class="line">        <span class="keyword">switch</span> (opt) &#123;</span><br><span class="line">            <span class="keyword">case</span> <span class="string">"-l"</span>:</span><br><span class="line">                sessionParams.installFlags |= PackageManager.INSTALL_FORWARD_LOCK;</span><br><span class="line">                <span class="keyword">break</span>;</span><br><span class="line">            <span class="keyword">case</span> <span class="string">"-r"</span>:</span><br><span class="line">                sessionParams.installFlags |= PackageManager.INSTALL_REPLACE_EXISTING;</span><br><span class="line">                <span class="keyword">break</span>;</span><br><span class="line">            ... ... ...</span><br><span class="line">            <span class="keyword">default</span>:</span><br><span class="line">                <span class="keyword">throw</span> <span class="keyword">new</span> IllegalArgumentException(<span class="string">"Unknown option "</span> + opt);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> params;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>不多说了！</p>
<h5 id="1-1-5-2-2-doCreateSession"><a href="#1-1-5-2-2-doCreateSession" class="headerlink" title="1.1.5.2.2 doCreateSession"></a>1.1.5.2.2 doCreateSession</h5><p>这个和 pm install 的流程是一样的，虽然这个同名方法是在 PackageManagerShellCommand 中，但实际上两个方法的代码几乎一模一样，大家可以参考【*2.9.2】!</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">int</span> <span class="title">doCreateSession</span><span class="params">(SessionParams params, String installerPackageName, <span class="keyword">int</span> userId)</span></span></span><br><span class="line"><span class="function">        <span class="keyword">throws</span> RemoteException </span>&#123;</span><br><span class="line">    userId = translateUserId(userId, <span class="string">"runInstallCreate"</span>);</span><br><span class="line">    <span class="keyword">if</span> (userId == UserHandle.USER_ALL) &#123;</span><br><span class="line">        userId = UserHandle.USER_SYSTEM;</span><br><span class="line">        params.installFlags |= PackageManager.INSTALL_ALL_USERS;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">//【*3.1】调用 PackageInstallerService 的 createSession 方法，创建实例！</span></span><br><span class="line">    <span class="keyword">final</span> <span class="keyword">int</span> sessionId = mInterface.getPackageInstaller()</span><br><span class="line">            .createSession(params, installerPackageName, userId);</span><br><span class="line">    <span class="keyword">return</span> sessionId;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>这里的 mInterface 是 PMS 的代理对象，通过 getPackageInstaller 获得了 PackageInstallerService 实例！</p>
<h5 id="1-1-5-2-3-doWriteSplit"><a href="#1-1-5-2-3-doWriteSplit" class="headerlink" title="1.1.5.2.3 doWriteSplit"></a>1.1.5.2.3 doWriteSplit</h5><p>doWriteSplit 方法和 2.9.3 Pm.doWriteSession 是一样的：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">int</span> <span class="title">doWriteSplit</span><span class="params">(<span class="keyword">int</span> sessionId, String inPath, <span class="keyword">long</span> sizeBytes, String splitName,</span></span></span><br><span class="line"><span class="function"><span class="params">        <span class="keyword">boolean</span> logSuccess)</span> <span class="keyword">throws</span> RemoteException </span>&#123;</span><br><span class="line">    <span class="keyword">final</span> PrintWriter pw = getOutPrintWriter();</span><br><span class="line">    <span class="keyword">if</span> (sizeBytes &lt;= <span class="number">0</span>) &#123;</span><br><span class="line">        pw.println(<span class="string">"Error: must specify a APK size"</span>);</span><br><span class="line">        <span class="keyword">return</span> <span class="number">1</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span> (inPath != <span class="keyword">null</span> &amp;&amp; !<span class="string">"-"</span>.equals(inPath)) &#123;</span><br><span class="line">        pw.println(<span class="string">"Error: APK content must be streamed"</span>);</span><br><span class="line">        <span class="keyword">return</span> <span class="number">1</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    inPath = <span class="keyword">null</span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//【*3.3.2】根据前面创建的 Session id，获得本次安装事务对象！</span></span><br><span class="line">    <span class="keyword">final</span> SessionInfo info = mInterface.getPackageInstaller().getSessionInfo(sessionId);</span><br><span class="line"></span><br><span class="line">    PackageInstaller.Session session = <span class="keyword">null</span>;</span><br><span class="line">    InputStream in = <span class="keyword">null</span>;</span><br><span class="line">    OutputStream out = <span class="keyword">null</span>;</span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">        <span class="comment">//【*3.2.1】通过 PackageInstallerService.openSession 获得对应的 PackageInstallerSession 对象！</span></span><br><span class="line">        <span class="comment">//【*2.9.3.1】封装成 Session 实例！</span></span><br><span class="line">        session = <span class="keyword">new</span> PackageInstaller.Session(</span><br><span class="line">                mInterface.getPackageInstaller().openSession(sessionId));</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (inPath != <span class="keyword">null</span>) &#123;</span><br><span class="line">            in = <span class="keyword">new</span> FileInputStream(inPath);</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            in = <span class="keyword">new</span> SizedInputStream(getRawInputStream(), sizeBytes);</span><br><span class="line">        &#125;</span><br><span class="line">        </span><br><span class="line">        <span class="comment">//【*2.9.3.1.1】定义输出流对象，指向待安装 APK 对应文件的源地址！</span></span><br><span class="line">        out = session.openWrite(splitName, <span class="number">0</span>, sizeBytes);</span><br><span class="line"></span><br><span class="line">        <span class="keyword">int</span> total = <span class="number">0</span>;</span><br><span class="line">        <span class="keyword">byte</span>[] buffer = <span class="keyword">new</span> <span class="keyword">byte</span>[<span class="number">65536</span>];</span><br><span class="line">        <span class="keyword">int</span> c;</span><br><span class="line">        <span class="keyword">while</span> ((c = in.read(buffer)) != -<span class="number">1</span>) &#123;</span><br><span class="line">            total += c;</span><br><span class="line">            <span class="comment">//【1】拷贝文件到 /data/app/ 目标目录！</span></span><br><span class="line">            out.write(buffer, <span class="number">0</span>, c);</span><br><span class="line"></span><br><span class="line">            <span class="keyword">if</span> (info.sizeBytes &gt; <span class="number">0</span>) &#123;</span><br><span class="line">                <span class="keyword">final</span> <span class="keyword">float</span> fraction = ((<span class="keyword">float</span>) c / (<span class="keyword">float</span>) info.sizeBytes);</span><br><span class="line">                <span class="comment">//【2】同时更新进度！</span></span><br><span class="line">                session.addProgress(fraction);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        session.fsync(out);</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (logSuccess) &#123;</span><br><span class="line">            pw.println(<span class="string">"Success: streamed "</span> + total + <span class="string">" bytes"</span>);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">    &#125; <span class="keyword">catch</span> (IOException e) &#123;</span><br><span class="line">        pw.println(<span class="string">"Error: failed to write; "</span> + e.getMessage());</span><br><span class="line">        <span class="keyword">return</span> <span class="number">1</span>;</span><br><span class="line">    &#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">        IoUtils.closeQuietly(out);</span><br><span class="line">        IoUtils.closeQuietly(in);</span><br><span class="line">        IoUtils.closeQuietly(session);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>不多说了！</p>
<h5 id="1-1-5-2-4-doCommitSession"><a href="#1-1-5-2-4-doCommitSession" class="headerlink" title="1.1.5.2.4 doCommitSession"></a>1.1.5.2.4 doCommitSession</h5><p>doWriteSplit 方法和 2.9.4 Pm.doCommitSession 是一样的：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">int</span> <span class="title">doCommitSession</span><span class="params">(<span class="keyword">int</span> sessionId, <span class="keyword">boolean</span> logSuccess)</span> <span class="keyword">throws</span> RemoteException </span>&#123;</span><br><span class="line">    <span class="keyword">final</span> PrintWriter pw = getOutPrintWriter();</span><br><span class="line">    PackageInstaller.Session session = <span class="keyword">null</span>;</span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">        <span class="comment">//【×2.9.3.1】和前面一样，重新获得一个 Session 对象！</span></span><br><span class="line">        session = <span class="keyword">new</span> PackageInstaller.Session(</span><br><span class="line">                mInterface.getPackageInstaller().openSession(sessionId));</span><br><span class="line">        <span class="comment">//【×2.9.4.1】创建了一个 LocalIntentReceiver！</span></span><br><span class="line">        <span class="keyword">final</span> LocalIntentReceiver receiver = <span class="keyword">new</span> LocalIntentReceiver();</span><br><span class="line">        <span class="comment">//【×2.9.4.2】将 receiver.getIntentSender() 传递给 pms，用户客户端进程获得安装结果</span></span><br><span class="line">        <span class="comment">//【×2.9.4.3】调用 PackageInstallerSession 的 commit 方法，提交事务！</span></span><br><span class="line">        session.commit(receiver.getIntentSender());</span><br><span class="line">        <span class="comment">//【×2.9.4.4】处理返回结果！</span></span><br><span class="line">        <span class="keyword">final</span> Intent result = receiver.getResult();</span><br><span class="line">        <span class="keyword">final</span> <span class="keyword">int</span> status = result.getIntExtra(PackageInstaller.EXTRA_STATUS,</span><br><span class="line">                PackageInstaller.STATUS_FAILURE);</span><br><span class="line">        <span class="keyword">if</span> (status == PackageInstaller.STATUS_SUCCESS) &#123;</span><br><span class="line">            <span class="keyword">if</span> (logSuccess) &#123;</span><br><span class="line">                pw.println(<span class="string">"Success"</span>);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            pw.println(<span class="string">"Failure ["</span></span><br><span class="line">                    + result.getStringExtra(PackageInstaller.EXTRA_STATUS_MESSAGE) + <span class="string">"]"</span>);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> status;</span><br><span class="line">    &#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">        IoUtils.closeQuietly(session);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h2 id="1-2-pm-install-不支持-cmd-指令"><a href="#1-2-pm-install-不支持-cmd-指令" class="headerlink" title="1.2 pm install - 不支持 cmd 指令"></a>1.2 pm install - 不支持 cmd 指令</h2><h3 id="1-2-1-commandline-install-app-legacy"><a href="#1-2-1-commandline-install-app-legacy" class="headerlink" title="1.2.1 commandline::install_app_legacy"></a>1.2.1 commandline::install_app_legacy</h3><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">static</span> <span class="keyword">int</span> <span class="title">install_app_legacy</span><span class="params">(TransportType transport, <span class="keyword">const</span> <span class="keyword">char</span>* serial, <span class="keyword">int</span> argc, <span class="keyword">const</span> <span class="keyword">char</span>** argv)</span> </span>&#123;</span><br><span class="line">    <span class="comment">// 此时我们需要先将 apk 将拷贝到手机的指定目录下！</span></span><br><span class="line">    <span class="comment">//【1】如果是要安装到内部存储，目标路径是 DATA_DEST，如果是存储则是 SD_DEST！</span></span><br><span class="line">    <span class="keyword">static</span> <span class="keyword">const</span> <span class="keyword">char</span> *<span class="keyword">const</span> DATA_DEST = <span class="string">"/data/local/tmp/%s"</span>;</span><br><span class="line">    <span class="keyword">static</span> <span class="keyword">const</span> <span class="keyword">char</span> *<span class="keyword">const</span> SD_DEST = <span class="string">"/sdcard/tmp/%s"</span>;</span><br><span class="line">    <span class="keyword">const</span> <span class="keyword">char</span>* where = DATA_DEST;</span><br><span class="line">    <span class="keyword">int</span> i;</span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">stat</span> <span class="title">sb</span>;</span></span><br><span class="line">    <span class="comment">//【2】如果 adb 指令设置了 -s 参数，那就安装到外置存储，默认是内置存储！</span></span><br><span class="line">    <span class="keyword">for</span> (i = <span class="number">1</span>; i &lt; argc; i++) &#123;</span><br><span class="line">        <span class="keyword">if</span> (!<span class="built_in">strcmp</span>(argv[i], <span class="string">"-s"</span>)) &#123;</span><br><span class="line">            where = SD_DEST;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//【3】判断是否有 apk 文件参数！</span></span><br><span class="line">    <span class="keyword">int</span> last_apk = <span class="number">-1</span>;</span><br><span class="line">    <span class="keyword">for</span> (i = argc - <span class="number">1</span>; i &gt;= <span class="number">0</span>; i--) &#123;</span><br><span class="line">        <span class="keyword">const</span> <span class="keyword">char</span>* file = argv[i];</span><br><span class="line">        <span class="keyword">const</span> <span class="keyword">char</span>* dot = <span class="built_in">strrchr</span>(file, <span class="string">'.'</span>);</span><br><span class="line">        <span class="keyword">if</span> (dot &amp;&amp; !strcasecmp(dot, <span class="string">".apk"</span>)) &#123;</span><br><span class="line">            <span class="keyword">if</span> (stat(file, &amp;sb) == <span class="number">-1</span> || !S_ISREG(sb.st_mode)) &#123;</span><br><span class="line">                <span class="built_in">fprintf</span>(<span class="built_in">stderr</span>, <span class="string">"Invalid APK file: %s\n"</span>, file);</span><br><span class="line">                <span class="keyword">return</span> EXIT_FAILURE;</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            last_apk = i;</span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (last_apk == <span class="number">-1</span>) &#123;</span><br><span class="line">        <span class="built_in">fprintf</span>(<span class="built_in">stderr</span>, <span class="string">"Missing APK file\n"</span>);</span><br><span class="line">        <span class="keyword">return</span> EXIT_FAILURE;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">int</span> result = <span class="number">-1</span>;</span><br><span class="line">    <span class="built_in">std</span>::<span class="built_in">vector</span>&lt;<span class="keyword">const</span> <span class="keyword">char</span>*&gt; apk_file = &#123;argv[last_apk]&#125;;</span><br><span class="line">    <span class="comment">//【4】计算目标位置，将要安装的 apk 拷贝到目标缓存位置</span></span><br><span class="line">    <span class="comment">// 同时将 adb 命令的最后一个参数改为 apk 拷贝后的目标缓存位置！</span></span><br><span class="line">    <span class="comment">// 目标位置：/data/local/tmp/name.apk!</span></span><br><span class="line">    <span class="built_in">std</span>::<span class="built_in">string</span> apk_dest = android::base::StringPrintf(</span><br><span class="line">        where, adb_basename(argv[last_apk]).c_str());、</span><br><span class="line"></span><br><span class="line">    <span class="comment">// do_sync_push 将此 apk 文件传输到目标路径，失败的话将跳转到 clenaup_apk</span></span><br><span class="line">    <span class="keyword">if</span> (!do_sync_push(apk_file, apk_dest.c_str())) <span class="keyword">goto</span> cleanup_apk;</span><br><span class="line">    <span class="comment">// 设置新位置！</span></span><br><span class="line">    argv[last_apk] = apk_dest.c_str();</span><br><span class="line"></span><br><span class="line">    <span class="comment">//【*1.2.2】执行安装</span></span><br><span class="line">    result = pm_command(transport, serial, argc, argv);</span><br><span class="line"></span><br><span class="line">cleanup_apk:</span><br><span class="line">    <span class="comment">// 删除目标缓存 apk 文件，PMS 会把该 apk 拷贝到 /data/app 目录下，所以这个缓存中的 apk 没用了！</span></span><br><span class="line">    delete_file(transport, serial, apk_dest);</span><br><span class="line">    <span class="keyword">return</span> result;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>其实整个过程很简单，不多说了！</p>
<h3 id="1-2-2-commandline-pm-command"><a href="#1-2-2-commandline-pm-command" class="headerlink" title="1.2.2 commandline::pm_command"></a>1.2.2 commandline::pm_command</h3><p>我们继续来分析：<br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">static</span> <span class="keyword">int</span> <span class="title">pm_command</span><span class="params">(TransportType transport, <span class="keyword">const</span> <span class="keyword">char</span>* serial, <span class="keyword">int</span> argc, <span class="keyword">const</span> <span class="keyword">char</span>** argv)</span> </span>&#123;</span><br><span class="line">    <span class="comment">// 我们看到，这里会将 adb install 命令和参数，转为 pm 指令！</span></span><br><span class="line">    std::string cmd = <span class="string">"pm"</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">while</span> (argc-- &gt; <span class="number">0</span>) &#123;</span><br><span class="line">        cmd += <span class="string">" "</span> + escape_arg(*argv++);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">//【*1.2.3】继续调用 send_shell_command 方法！</span></span><br><span class="line">    <span class="keyword">return</span> send_shell_command(transport, serial, cmd, <span class="keyword">false</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<h3 id="1-2-3-commandline-send-shell-command"><a href="#1-2-3-commandline-send-shell-command" class="headerlink" title="1.2.3 commandline::send_shell_command"></a>1.2.3 commandline::send_shell_command</h3><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">send_shell_command</span><span class="params">(TransportType transport_type, <span class="keyword">const</span> <span class="keyword">char</span>* serial, <span class="keyword">const</span> <span class="built_in">std</span>::<span class="built_in">string</span>&amp; command,</span></span></span><br><span class="line"><span class="function"><span class="params">                       <span class="keyword">bool</span> disable_shell_protocol, StandardStreamsCallbackInterface* callback)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">int</span> fd;</span><br><span class="line">    <span class="keyword">bool</span> use_shell_protocol = <span class="literal">false</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">while</span> (<span class="literal">true</span>) &#123;</span><br><span class="line">        <span class="keyword">bool</span> attempt_connection = <span class="literal">true</span>;</span><br><span class="line">        <span class="comment">// 使用 shell protocol</span></span><br><span class="line">        <span class="keyword">if</span> (!disable_shell_protocol) &#123;</span><br><span class="line">            FeatureSet features;</span><br><span class="line">            <span class="built_in">std</span>::<span class="built_in">string</span> error;</span><br><span class="line">            <span class="keyword">if</span> (adb_get_feature_set(&amp;features, &amp;error)) &#123;</span><br><span class="line">                <span class="comment">// 如果定义了 feature，则替换 shell protocol!</span></span><br><span class="line">                use_shell_protocol = CanUseFeature(features, kFeatureShell2);</span><br><span class="line">            &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                attempt_connection = <span class="literal">false</span>;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (attempt_connection) &#123;</span><br><span class="line">            <span class="built_in">std</span>::<span class="built_in">string</span> error;</span><br><span class="line">            <span class="comment">// 此时 command 中携带的就是以 pm 开头的命令</span></span><br><span class="line">            <span class="built_in">std</span>::<span class="built_in">string</span> service_string = ShellServiceString(use_shell_protocol, <span class="string">""</span>, command);</span><br><span class="line">            <span class="comment">// 向 shell protocol 发送命令</span></span><br><span class="line">            fd = adb_connect(service_string, &amp;error);</span><br><span class="line">            <span class="keyword">if</span> (fd &gt;= <span class="number">0</span>) &#123;</span><br><span class="line">                <span class="keyword">break</span>;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="built_in">fprintf</span>(<span class="built_in">stderr</span>, <span class="string">"- waiting for device -\n"</span>);</span><br><span class="line">        <span class="keyword">if</span> (!wait_for_device(<span class="string">"wait-for-device"</span>, transport_type, serial)) &#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="number">1</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// 处理命令执行结果！</span></span><br><span class="line">    <span class="keyword">int</span> exit_code = read_and_dump(fd, use_shell_protocol, callback);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (adb_close(fd) &lt; <span class="number">0</span>) &#123;</span><br><span class="line">        PLOG(ERROR) &lt;&lt; <span class="string">"failure closing FD "</span> &lt;&lt; fd;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> exit_code;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>到这里，我们知道，最后其实是向 shell 服务发送 pm 命令，触发 apk 的安装！</p>
<h1 id="2-pm-install"><a href="#2-pm-install" class="headerlink" title="2 pm install"></a>2 pm install</h1><p>cmd 的调用上面已经分析了，其实和 pm install 没有区别！</p>
<p>这里我们来看下 pm 命令的主要用法，通过 pm install 继续分析安装：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br></pre></td><td class="code"><pre><span class="line">usage: pm path [--user USER_ID] PACKAGE</span><br><span class="line">       pm dump PACKAGE</span><br><span class="line">       pm install [-lrtsfd] [-i PACKAGE] [--user USER_ID] [PATH]</span><br><span class="line">       pm install-create [-lrtsfdp] [-i PACKAGE] [-S BYTES]</span><br><span class="line">               [--install-location <span class="number">0</span>/<span class="number">1</span>/<span class="number">2</span>]</span><br><span class="line">               [--force-uuid internal|UUID]</span><br><span class="line">       pm install-write [-S BYTES] SESSION_ID SPLIT_NAME [PATH]</span><br><span class="line">       pm install-commit SESSION_ID</span><br><span class="line">       pm install-abandon SESSION_ID</span><br><span class="line">       pm uninstall [-k] [--user USER_ID] [--versionCode VERSION_CODE] PACKAGE</span><br><span class="line">       pm set-installer PACKAGE INSTALLER</span><br><span class="line">       pm move-<span class="keyword">package</span> PACKAGE [internal|UUID]</span><br><span class="line">       pm move-primary-storage [internal|UUID]</span><br><span class="line">       pm clear [--user USER_ID] PACKAGE</span><br><span class="line">       pm enable [--user USER_ID] PACKAGE_OR_COMPONENT</span><br><span class="line">       pm disable [--user USER_ID] PACKAGE_OR_COMPONENT</span><br><span class="line">       pm disable-user [--user USER_ID] PACKAGE_OR_COMPONENT</span><br><span class="line">       pm disable-until-used [--user USER_ID] PACKAGE_OR_COMPONENT</span><br><span class="line">       pm <span class="keyword">default</span>-state [--user USER_ID] PACKAGE_OR_COMPONENT</span><br><span class="line">       pm set-user-restriction [--user USER_ID] RESTRICTION VALUE</span><br><span class="line">       pm hide [--user USER_ID] PACKAGE_OR_COMPONENT</span><br><span class="line">       pm unhide [--user USER_ID] PACKAGE_OR_COMPONENT</span><br><span class="line">       pm grant [--user USER_ID] PACKAGE PERMISSION</span><br><span class="line">       pm revoke [--user USER_ID] PACKAGE PERMISSION</span><br><span class="line">       pm reset-permissions</span><br><span class="line">       pm set-app-link [--user USER_ID] PACKAGE &#123;always|ask|never|undefined&#125;</span><br><span class="line">       pm get-app-link [--user USER_ID] PACKAGE</span><br><span class="line">       pm set-install-location [<span class="number">0</span>/auto] [<span class="number">1</span>/internal] [<span class="number">2</span>/external]</span><br><span class="line">       pm get-install-location</span><br><span class="line">       pm set-permission-enforced PERMISSION [<span class="keyword">true</span>|<span class="keyword">false</span>]</span><br><span class="line">       pm trim-caches DESIRED_FREE_SPACE [internal|UUID]</span><br><span class="line">       pm create-user [--profileOf USER_ID] [--managed] [--restricted] [--ephemeral] [--guest] USER_NAME</span><br><span class="line">       pm remove-user USER_ID</span><br><span class="line">       pm get-max-users</span><br></pre></td></tr></table></figure>
<p>pm 命令的源码位于 frameworks/base/cmds/pm 中，我们直接去看下目录结构：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">.</span><br><span class="line">├── Android.mk</span><br><span class="line">├── MODULE_LICENSE_APACHE2</span><br><span class="line">├── NOTICE</span><br><span class="line">├── pm</span><br><span class="line">└── src</span><br><span class="line">    └── com</span><br><span class="line">        └── android</span><br><span class="line">            └── commands</span><br><span class="line">                └── pm</span><br><span class="line">                    └── Pm.java</span><br></pre></td></tr></table></figure>
<p>我们先来看看 Android.mk 中的内容：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"># Copyright 2007 The Android Open Source Project</span><br><span class="line">#</span><br><span class="line">LOCAL_PATH:= $(call my-dir)</span><br><span class="line">include $(CLEAR_VARS)</span><br><span class="line"></span><br><span class="line">LOCAL_SRC_FILES := $(call all-subdir-java-files)</span><br><span class="line">LOCAL_MODULE := pm</span><br><span class="line">include $(BUILD_JAVA_LIBRARY)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">include $(CLEAR_VARS)</span><br><span class="line">ALL_PREBUILT += $(TARGET_OUT)/bin/pm</span><br><span class="line">$(TARGET_OUT)/bin/pm : $(LOCAL_PATH)/pm | $(ACP)</span><br><span class="line">	$(transform-prebuilt-to-target)</span><br></pre></td></tr></table></figure>
<p>可以看到，编译期间，编译系统会将 pm 脚本放置到 /system/bin/ 目录下。</p>
<p>接着，来看看 pm 脚本的内容：<br><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"># Script to start "pm" on the device, which has a very rudimentary</span><br><span class="line"># shell.</span><br><span class="line">#</span><br><span class="line">base=/system</span><br><span class="line">export CLASSPATH=$base/framework/pm.jar</span><br><span class="line">exec app_process $base/bin com.android.commands.pm.Pm "$@"</span><br></pre></td></tr></table></figure></p>
<p>该脚本的作用是通过 app_process 启动 pm java 进程！</p>
<h2 id="2-1-app-process-main"><a href="#2-1-app-process-main" class="headerlink" title="2.1 app_process::main"></a>2.1 app_process::main</h2><p>app_process 其实就是 Zygote 的源码，在开机篇我们已经分析过了 Zygote 的启动，这里略过和 Zygote 相关的代码：</p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">main</span><span class="params">(<span class="keyword">int</span> argc, <span class="keyword">char</span>* <span class="keyword">const</span> argv[])</span> </span>&#123;</span><br><span class="line">    ... ... ...</span><br><span class="line"></span><br><span class="line">    ++i;  <span class="comment">// Skip unused "parent dir" argument.</span></span><br><span class="line">    <span class="keyword">while</span> (i &lt; argc) &#123;</span><br><span class="line">        <span class="keyword">const</span> <span class="keyword">char</span>* arg = argv[i++];</span><br><span class="line">        <span class="keyword">if</span> (<span class="built_in">strcmp</span>(arg, <span class="string">"--zygote"</span>) == <span class="number">0</span>) &#123;</span><br><span class="line">            zygote = <span class="literal">true</span>;</span><br><span class="line">            niceName = ZYGOTE_NICE_NAME;</span><br><span class="line">        &#125; <span class="keyword">else</span> <span class="keyword">if</span> (<span class="built_in">strcmp</span>(arg, <span class="string">"--start-system-server"</span>) == <span class="number">0</span>) &#123;</span><br><span class="line">            startSystemServer = <span class="literal">true</span>;</span><br><span class="line">        &#125; <span class="keyword">else</span> <span class="keyword">if</span> (<span class="built_in">strcmp</span>(arg, <span class="string">"--application"</span>) == <span class="number">0</span>) &#123;</span><br><span class="line">            application = <span class="literal">true</span>;</span><br><span class="line">        &#125; <span class="keyword">else</span> <span class="keyword">if</span> (<span class="built_in">strncmp</span>(arg, <span class="string">"--nice-name="</span>, <span class="number">12</span>) == <span class="number">0</span>) &#123;</span><br><span class="line">            niceName.setTo(arg + <span class="number">12</span>);</span><br><span class="line">        &#125; <span class="keyword">else</span> <span class="keyword">if</span> (<span class="built_in">strncmp</span>(arg, <span class="string">"--"</span>, <span class="number">2</span>) != <span class="number">0</span>) &#123;</span><br><span class="line">            <span class="comment">//【1】获得要启动的 java 进程的 className</span></span><br><span class="line">            className.setTo(arg);</span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            --i;</span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    Vector&lt;String8&gt; args;</span><br><span class="line">    <span class="keyword">if</span> (!className.isEmpty()) &#123;</span><br><span class="line">        <span class="comment">//【2】根据 application 的取值，判断我们启动的是应用类型进程，还是工具类型进程！</span></span><br><span class="line">        args.add(application ? String8(<span class="string">"application"</span>) : String8(<span class="string">"tool"</span>));</span><br><span class="line">        runtime.setClassNameAndArgs(className, argc - i, argv + i);</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        ... ... ...<span class="comment">// zygote 启动才会进入！</span></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (!niceName.isEmpty()) &#123;</span><br><span class="line">        runtime.setArgv0(niceName.<span class="built_in">string</span>());</span><br><span class="line">        set_process_name(niceName.<span class="built_in">string</span>());</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (zygote) &#123;</span><br><span class="line">        runtime.start(<span class="string">"com.android.internal.os.ZygoteInit"</span>, args, zygote);</span><br><span class="line">    &#125; <span class="keyword">else</span> <span class="keyword">if</span> (className) &#123;</span><br><span class="line">        <span class="comment">//【2.2】非 Zygote 进程的启动方式如下</span></span><br><span class="line">        runtime.start(<span class="string">"com.android.internal.os.RuntimeInit"</span>, args, zygote);</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        <span class="built_in">fprintf</span>(<span class="built_in">stderr</span>, <span class="string">"Error: no class name or --zygote supplied.\n"</span>);</span><br><span class="line">        app_usage();</span><br><span class="line">        LOG_ALWAYS_FATAL(<span class="string">"app_process: no class name or --zygote supplied."</span>);</span><br><span class="line">        <span class="keyword">return</span> <span class="number">10</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>接下来，会进入 AndroidRuntime 中去！！</p>
<h2 id="2-2-AndroidRuntime-start"><a href="#2-2-AndroidRuntime-start" class="headerlink" title="2.2 AndroidRuntime::start"></a>2.2 AndroidRuntime::start</h2><p>这里的 className 传入的值为 com.android.internal.os.RuntimeInit！</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">void</span> AndroidRuntime::start(<span class="keyword">const</span> <span class="keyword">char</span>* className, <span class="keyword">const</span> Vector&lt;String8&gt;&amp; options, bool zygote)</span><br><span class="line">&#123;</span><br><span class="line">    ALOGD(<span class="string">"&gt;&gt;&gt;&gt;&gt;&gt; START %s uid %d &lt;&lt;&lt;&lt;&lt;&lt;\n"</span>,</span><br><span class="line">            className != NULL ? className : <span class="string">"(unknown)"</span>, getuid());</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">static</span> <span class="keyword">const</span> String8 <span class="title">startSystemServer</span><span class="params">(<span class="string">"start-system-server"</span>)</span></span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">for</span> (size_t i = <span class="number">0</span>; i &lt; options.size(); ++i) &#123;</span><br><span class="line">        <span class="keyword">if</span> (options[i] == startSystemServer) &#123;</span><br><span class="line">           <span class="comment">/* track our progress through the boot sequence */</span></span><br><span class="line">           <span class="keyword">const</span> <span class="keyword">int</span> LOG_BOOT_PROGRESS_START = <span class="number">3000</span>;</span><br><span class="line">           LOG_EVENT_LONG(LOG_BOOT_PROGRESS_START,  ns2ms(systemTime(SYSTEM_TIME_MONOTONIC)));</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">const</span> <span class="keyword">char</span>* rootDir = getenv(<span class="string">"ANDROID_ROOT"</span>);</span><br><span class="line">    <span class="keyword">if</span> (rootDir == NULL) &#123;</span><br><span class="line">        rootDir = <span class="string">"/system"</span>;</span><br><span class="line">        <span class="keyword">if</span> (!hasDir(<span class="string">"/system"</span>)) &#123;</span><br><span class="line">            LOG_FATAL(<span class="string">"No root directory specified, and /android does not exist."</span>);</span><br><span class="line">            <span class="keyword">return</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        setenv(<span class="string">"ANDROID_ROOT"</span>, rootDir, <span class="number">1</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//const char* kernelHack = getenv("LD_ASSUME_KERNEL");</span></span><br><span class="line">    <span class="comment">//ALOGD("Found LD_ASSUME_KERNEL='%s'\n", kernelHack);</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">//【1】启动虚拟机！</span></span><br><span class="line">    JniInvocation jni_invocation;</span><br><span class="line">    jni_invocation.Init(NULL);</span><br><span class="line">    JNIEnv* env;</span><br><span class="line">    <span class="keyword">if</span> (startVm(&amp;mJavaVM, &amp;env, zygote) != <span class="number">0</span>) &#123;</span><br><span class="line">        <span class="keyword">return</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    onVmCreated(env);</span><br><span class="line"></span><br><span class="line">    <span class="comment">//【2】注册 Android 函数！</span></span><br><span class="line">    <span class="keyword">if</span> (startReg(env) &lt; <span class="number">0</span>) &#123;</span><br><span class="line">        ALOGE(<span class="string">"Unable to register all android natives\n"</span>);</span><br><span class="line">        <span class="keyword">return</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//【3】创建一个 String 数组来保存传递进来的参数！</span></span><br><span class="line">    jclass stringClass;</span><br><span class="line">    jobjectArray strArray;</span><br><span class="line">    jstring classNameStr;</span><br><span class="line"></span><br><span class="line">    stringClass = env-&gt;FindClass(<span class="string">"java/lang/String"</span>);</span><br><span class="line">    <span class="keyword">assert</span>(stringClass != NULL);</span><br><span class="line">    strArray = env-&gt;NewObjectArray(options.size() + <span class="number">1</span>, stringClass, NULL);</span><br><span class="line">    <span class="keyword">assert</span>(strArray != NULL);</span><br><span class="line">    classNameStr = env-&gt;NewStringUTF(className);</span><br><span class="line">    <span class="keyword">assert</span>(classNameStr != NULL);</span><br><span class="line">    env-&gt;SetObjectArrayElement(strArray, <span class="number">0</span>, classNameStr);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">for</span> (size_t i = <span class="number">0</span>; i &lt; options.size(); ++i) &#123;</span><br><span class="line">        jstring optionsStr = env-&gt;NewStringUTF(options.itemAt(i).string());</span><br><span class="line">        <span class="keyword">assert</span>(optionsStr != NULL);</span><br><span class="line">        env-&gt;SetObjectArrayElement(strArray, i + <span class="number">1</span>, optionsStr);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//【4】启动虚拟机的主线程，该主线程不会退出，直到虚拟机退出！</span></span><br><span class="line">    <span class="keyword">char</span>* slashClassName = toSlashClassName(className);</span><br><span class="line">    jclass startClass = env-&gt;FindClass(slashClassName);</span><br><span class="line">    <span class="keyword">if</span> (startClass == NULL) &#123;</span><br><span class="line">        ALOGE(<span class="string">"JavaVM unable to locate class '%s'\n"</span>, slashClassName);</span><br><span class="line">        <span class="comment">/* keep going */</span></span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        <span class="comment">//【2.3】反射调用 RuntimeInit.main 函数，从 native 层进入 java 世界！</span></span><br><span class="line">        jmethodID startMeth = env-&gt;GetStaticMethodID(startClass, <span class="string">"main"</span>,</span><br><span class="line">            <span class="string">"([Ljava/lang/String;)V"</span>);</span><br><span class="line">        <span class="keyword">if</span> (startMeth == NULL) &#123;</span><br><span class="line">            ALOGE(<span class="string">"JavaVM unable to find main() in '%s'\n"</span>, className);</span><br><span class="line">            <span class="comment">/* keep going */</span></span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            env-&gt;CallStaticVoidMethod(startClass, startMeth, strArray);</span><br><span class="line">#if 0</span><br><span class="line">            <span class="keyword">if</span> (env-&gt;ExceptionCheck())</span><br><span class="line">                threadExitUncaughtException(env);</span><br><span class="line">#endif</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    free(slashClassName);</span><br><span class="line"></span><br><span class="line">    ALOGD(<span class="string">"Shutting down VM\n"</span>);</span><br><span class="line">    <span class="keyword">if</span> (mJavaVM-&gt;DetachCurrentThread() != JNI_OK)</span><br><span class="line">        ALOGW(<span class="string">"Warning: unable to detach main thread\n"</span>);</span><br><span class="line">    <span class="keyword">if</span> (mJavaVM-&gt;DestroyJavaVM() != <span class="number">0</span>)</span><br><span class="line">        ALOGW(<span class="string">"Warning: VM did not shut down cleanly\n"</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>通过反射，进入 RuntimeInit 中！</p>
<h2 id="2-3-RuntimeInit-main"><a href="#2-3-RuntimeInit-main" class="headerlink" title="2.3 RuntimeInit.main"></a>2.3 RuntimeInit.main</h2><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] argv)</span> </span>&#123;</span><br><span class="line">    enableDdms();</span><br><span class="line">    <span class="keyword">if</span> (argv.length == <span class="number">2</span> &amp;&amp; argv[<span class="number">1</span>].equals(<span class="string">"application"</span>)) &#123;</span><br><span class="line">        <span class="keyword">if</span> (DEBUG) Slog.d(TAG, <span class="string">"RuntimeInit: Starting application"</span>);</span><br><span class="line">        redirectLogStreams();</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        <span class="keyword">if</span> (DEBUG) Slog.d(TAG, <span class="string">"RuntimeInit: Starting tool"</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">//【1】进程一些初始化的操作，比如设置线程的默认异常处理 Handler，设置 Log 系统等等，在进程的启动时，我们分析过！！</span></span><br><span class="line">    commonInit();</span><br><span class="line"></span><br><span class="line">    <span class="comment">//【2.4】这里的关键点在这里！</span></span><br><span class="line">    nativeFinishInit();</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (DEBUG) Slog.d(TAG, <span class="string">"Leaving RuntimeInit!"</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>nativeFinishInit 调用的是 native 方法，位于 AndroidRuntime.cpp 文件中！</p>
<h2 id="2-4-AR-com-android-internal-os-RuntimeInit-nativeFinishInit"><a href="#2-4-AR-com-android-internal-os-RuntimeInit-nativeFinishInit" class="headerlink" title="2.4 AR::com_android_internal_os_RuntimeInit_nativeFinishInit"></a>2.4 AR::com_android_internal_os_RuntimeInit_nativeFinishInit</h2><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">static</span> <span class="keyword">void</span> <span class="title">com_android_internal_os_RuntimeInit_nativeFinishInit</span><span class="params">(JNIEnv* env, jobject clazz)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="comment">//【2.5】gCurRuntime 是 AndroidRuntime 子类 AppRuntime 的实例！</span></span><br><span class="line">    gCurRuntime-&gt;onStarted();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>实际上 AndroidRuntime 并没有实现 onStarted 方法，真正是实现是在 App_main.cpp 中的 AppRuntime 类中，他是 AndroidRuntime 的子类！</p>
<h2 id="2-5-AppRuntime-onStarted"><a href="#2-5-AppRuntime-onStarted" class="headerlink" title="2.5 AppRuntime::onStarted"></a>2.5 AppRuntime::onStarted</h2><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="function">virtual <span class="keyword">void</span> <span class="title">onStarted</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    sp&lt;ProcessState&gt; proc = ProcessState::self();</span><br><span class="line">    ALOGV(<span class="string">"App process: starting thread pool.\n"</span>);</span><br><span class="line">    proc-&gt;startThreadPool();</span><br><span class="line">    <span class="comment">//【2.6】执行 AndroidRuntime 的 callMain 方法！</span></span><br><span class="line">    AndroidRuntime* ar = AndroidRuntime::getRuntime();</span><br><span class="line">    ar-&gt;callMain(mClassName, mClass, mArgs);</span><br><span class="line"></span><br><span class="line">    IPCThreadState::self()-&gt;stopProcess();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h2 id="2-6-AndroidRuntime-callMain"><a href="#2-6-AndroidRuntime-callMain" class="headerlink" title="2.6 AndroidRuntime::callMain"></a>2.6 AndroidRuntime::callMain</h2><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br></pre></td><td class="code"><pre><span class="line">status_t AndroidRuntime::callMain(<span class="keyword">const</span> String8&amp; className, jclass clazz,</span><br><span class="line">    <span class="keyword">const</span> Vector&lt;String8&gt;&amp; args)</span><br><span class="line">&#123;</span><br><span class="line">    JNIEnv* env;</span><br><span class="line">    jmethodID methodId;</span><br><span class="line"></span><br><span class="line">    ALOGD(<span class="string">"Calling main entry %s"</span>, className.string());</span><br><span class="line"></span><br><span class="line">    env = getJNIEnv();</span><br><span class="line">    <span class="keyword">if</span> (clazz == NULL || env == NULL) &#123;</span><br><span class="line">        <span class="keyword">return</span> UNKNOWN_ERROR;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    methodId = env-&gt;GetStaticMethodID(clazz, <span class="string">"main"</span>, <span class="string">"([Ljava/lang/String;)V"</span>);</span><br><span class="line">    <span class="keyword">if</span> (methodId == NULL) &#123;</span><br><span class="line">        ALOGE(<span class="string">"ERROR: could not find method %s.main(String[])\n"</span>, className.string());</span><br><span class="line">        <span class="keyword">return</span> UNKNOWN_ERROR;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">//【1】创建一个 String 数组来封装参数！</span></span><br><span class="line">    jclass stringClass;</span><br><span class="line">    jobjectArray strArray;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">const</span> size_t numArgs = args.size();</span><br><span class="line">    stringClass = env-&gt;FindClass(<span class="string">"java/lang/String"</span>);</span><br><span class="line">    strArray = env-&gt;NewObjectArray(numArgs, stringClass, NULL);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">for</span> (size_t i = <span class="number">0</span>; i &lt; numArgs; i++) &#123;</span><br><span class="line">        jstring argStr = env-&gt;NewStringUTF(args[i].string());</span><br><span class="line">        env-&gt;SetObjectArrayElement(strArray, i, argStr);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">//【*2.7】最终反射调用了 Pm.main 方法！</span></span><br><span class="line">    env-&gt;CallStaticVoidMethod(clazz, methodId, strArray);</span><br><span class="line">    <span class="keyword">return</span> NO_ERROR;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h2 id="2-7-Pm-main"><a href="#2-7-Pm-main" class="headerlink" title="2.7 Pm.main"></a>2.7 Pm.main</h2><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">int</span> exitCode = <span class="number">1</span>;</span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">        <span class="comment">//【*2.8】执行 Pm.run f方法！</span></span><br><span class="line">        exitCode = <span class="keyword">new</span> Pm().run(args);</span><br><span class="line">    &#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">        Log.e(TAG, <span class="string">"Error"</span>, e);</span><br><span class="line">        System.err.println(<span class="string">"Error: "</span> + e);</span><br><span class="line">        <span class="keyword">if</span> (e <span class="keyword">instanceof</span> RemoteException) &#123;</span><br><span class="line">            System.err.println(PM_NOT_RUNNING_ERR);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    System.exit(exitCode);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h2 id="2-8-Pm-run"><a href="#2-8-Pm-run" class="headerlink" title="2.8 Pm.run"></a>2.8 Pm.run</h2><p>run 方法中涉及到的命令有很多，这里我们重点关注和 install 相关的！</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">int</span> <span class="title">run</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> RemoteException </span>&#123;</span><br><span class="line">    <span class="keyword">boolean</span> validCommand = <span class="keyword">false</span>;</span><br><span class="line">    <span class="keyword">if</span> (args.length &lt; <span class="number">1</span>) &#123;</span><br><span class="line">        <span class="keyword">return</span> showUsage();</span><br><span class="line">    &#125;</span><br><span class="line">    mAm = IAccountManager.Stub.asInterface(ServiceManager.getService(Context.ACCOUNT_SERVICE));</span><br><span class="line">    mUm = IUserManager.Stub.asInterface(ServiceManager.getService(Context.USER_SERVICE));</span><br><span class="line">    <span class="comment">//【1】获得 PacakgeManager 对象！</span></span><br><span class="line">    mPm = IPackageManager.Stub.asInterface(ServiceManager.getService(<span class="string">"package"</span>));</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (mPm == <span class="keyword">null</span>) &#123;</span><br><span class="line">        System.err.println(PM_NOT_RUNNING_ERR);</span><br><span class="line">        <span class="keyword">return</span> <span class="number">1</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">//【2】获得 PackageInstallerService 代理对象！</span></span><br><span class="line">    mInstaller = mPm.getPackageInstaller();</span><br><span class="line"></span><br><span class="line">    mArgs = args;</span><br><span class="line">    String op = args[<span class="number">0</span>];</span><br><span class="line">    mNextArg = <span class="number">1</span>;</span><br><span class="line"></span><br><span class="line">    ... ... ...</span><br><span class="line"></span><br><span class="line">    <span class="comment">//【*2.9】runInstall 方法，执行执行安装！</span></span><br><span class="line">    <span class="keyword">if</span> (<span class="string">"install"</span>.equals(op)) &#123;</span><br><span class="line">        <span class="keyword">return</span> runInstall();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    ... ... ... ...</span><br><span class="line"></span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">        <span class="keyword">if</span> (args.length == <span class="number">1</span>) &#123;</span><br><span class="line">            <span class="keyword">if</span> (args[<span class="number">0</span>].equalsIgnoreCase(<span class="string">"-l"</span>)) &#123;</span><br><span class="line">                validCommand = <span class="keyword">true</span>;</span><br><span class="line">                <span class="keyword">return</span> runShellCommand(<span class="string">"package"</span>, <span class="keyword">new</span> String[] &#123; <span class="string">"list"</span>, <span class="string">"package"</span> &#125;);</span><br><span class="line">            &#125; <span class="keyword">else</span> <span class="keyword">if</span> (args[<span class="number">0</span>].equalsIgnoreCase(<span class="string">"-lf"</span>)) &#123;</span><br><span class="line">                validCommand = <span class="keyword">true</span>;</span><br><span class="line">                <span class="keyword">return</span> runShellCommand(<span class="string">"package"</span>, <span class="keyword">new</span> String[] &#123; <span class="string">"list"</span>, <span class="string">"package"</span>, <span class="string">"-f"</span> &#125;);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125; <span class="keyword">else</span> <span class="keyword">if</span> (args.length == <span class="number">2</span>) &#123;</span><br><span class="line">            <span class="keyword">if</span> (args[<span class="number">0</span>].equalsIgnoreCase(<span class="string">"-p"</span>)) &#123;</span><br><span class="line">                validCommand = <span class="keyword">true</span>;</span><br><span class="line">                <span class="keyword">return</span> displayPackageFilePath(args[<span class="number">1</span>], UserHandle.USER_SYSTEM);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> <span class="number">1</span>;</span><br><span class="line">    &#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">        <span class="keyword">if</span> (validCommand == <span class="keyword">false</span>) &#123;</span><br><span class="line">            <span class="keyword">if</span> (op != <span class="keyword">null</span>) &#123;</span><br><span class="line">                System.err.println(<span class="string">"Error: unknown command '"</span> + op + <span class="string">"'"</span>);</span><br><span class="line">            &#125;</span><br><span class="line">            showUsage();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>继续看！</p>
<h2 id="2-9-Pm-runInstall"><a href="#2-9-Pm-runInstall" class="headerlink" title="2.9 Pm.runInstall"></a>2.9 Pm.runInstall</h2><p>我们继续分析：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">int</span> <span class="title">runInstall</span><span class="params">()</span> <span class="keyword">throws</span> RemoteException </span>&#123;</span><br><span class="line">    <span class="comment">//【*2.9.1】创建安装参数</span></span><br><span class="line">    <span class="keyword">final</span> InstallParams params = makeInstallParams();</span><br><span class="line">    <span class="keyword">final</span> String inPath = nextArg(); <span class="comment">// 获得安装 apk 的路径！</span></span><br><span class="line">    <span class="keyword">boolean</span> installExternal =</span><br><span class="line">            (params.sessionParams.installFlags &amp; PackageManager.INSTALL_EXTERNAL) != <span class="number">0</span>;</span><br><span class="line">    <span class="keyword">if</span> (params.sessionParams.sizeBytes &lt; <span class="number">0</span> &amp;&amp; inPath != <span class="keyword">null</span>) &#123;</span><br><span class="line">        File file = <span class="keyword">new</span> File(inPath);</span><br><span class="line">        <span class="keyword">if</span> (file.isFile()) &#123;</span><br><span class="line">            <span class="keyword">if</span> (installExternal) &#123;</span><br><span class="line">                <span class="keyword">try</span> &#123;</span><br><span class="line">                    <span class="comment">//【1】解析 apk，用于计算 apk 大小！</span></span><br><span class="line">                    ApkLite baseApk = PackageParser.parseApkLite(file, <span class="number">0</span>);</span><br><span class="line">                    PackageLite pkgLite = <span class="keyword">new</span> PackageLite(<span class="keyword">null</span>, baseApk, <span class="keyword">null</span>, <span class="keyword">null</span>, <span class="keyword">null</span>);</span><br><span class="line">                    params.sessionParams.setSize(</span><br><span class="line">                            PackageHelper.calculateInstalledSize(pkgLite, <span class="keyword">false</span>,</span><br><span class="line">                                    params.sessionParams.abiOverride));</span><br><span class="line">                &#125; <span class="keyword">catch</span> (PackageParserException | IOException e) &#123;</span><br><span class="line">                    System.err.println(<span class="string">"Error: Failed to parse APK file : "</span> + e);</span><br><span class="line">                    <span class="keyword">return</span> <span class="number">1</span>;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                params.sessionParams.setSize(file.length());</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">//【*2.9.2】创建安装 Session！</span></span><br><span class="line">    <span class="keyword">final</span> <span class="keyword">int</span> sessionId = doCreateSession(params.sessionParams,</span><br><span class="line">            params.installerPackageName, params.userId);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">        <span class="keyword">if</span> (inPath == <span class="keyword">null</span> &amp;&amp; params.sessionParams.sizeBytes == <span class="number">0</span>) &#123;</span><br><span class="line">            System.err.println(<span class="string">"Error: must either specify a package size or an APK file"</span>);</span><br><span class="line">            <span class="keyword">return</span> <span class="number">1</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">//【*2.9.3】该过程其实是将 inPath 指向的 apk 写入到 .tmp 目录下，指定了文件名是 "base.apk"</span></span><br><span class="line">        <span class="keyword">if</span> (doWriteSession(sessionId, inPath, params.sessionParams.sizeBytes, <span class="string">"base.apk"</span>,</span><br><span class="line">                <span class="keyword">false</span> <span class="comment">/*logSuccess*/</span>) != PackageInstaller.STATUS_SUCCESS) &#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="number">1</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">//【*2.9.4】提交 Session 触发安装！</span></span><br><span class="line">        <span class="keyword">if</span> (doCommitSession(sessionId, <span class="keyword">false</span> <span class="comment">/*logSuccess*/</span>)</span><br><span class="line">                != PackageInstaller.STATUS_SUCCESS) &#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="number">1</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        System.out.println(<span class="string">"Success"</span>);</span><br><span class="line">        <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">    &#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            <span class="comment">//【*2.9.5】如果安装异常，忽视本次事务！</span></span><br><span class="line">            mInstaller.abandonSession(sessionId);</span><br><span class="line">        &#125; <span class="keyword">catch</span> (Exception ignore) &#123;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h3 id="2-9-1-Pm-makeInstallParams-创建事务参数"><a href="#2-9-1-Pm-makeInstallParams-创建事务参数" class="headerlink" title="2.9.1 Pm.makeInstallParams - 创建事务参数"></a>2.9.1 Pm.makeInstallParams - 创建事务参数</h3><p>Pm 中会根据传入的安装参数，创建 InstallParams，封装安装参数！</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">private</span> InstallParams <span class="title">makeInstallParams</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    <span class="comment">//【*2.9.1.1】创建 SessionParams 实例，封装安装参数！</span></span><br><span class="line">    <span class="keyword">final</span> SessionParams sessionParams = <span class="keyword">new</span> SessionParams(SessionParams.MODE_FULL_INSTALL);</span><br><span class="line">    <span class="comment">//【*2.9.1.2】创建 InstallParams，解耦合！</span></span><br><span class="line">    <span class="keyword">final</span> InstallParams params = <span class="keyword">new</span> InstallParams();</span><br><span class="line">    params.sessionParams = sessionParams; <span class="comment">// 设置引用关系！</span></span><br><span class="line">    String opt;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">//【1】根据额外的参数，设置安装参数！</span></span><br><span class="line">    <span class="keyword">while</span> ((opt = nextOption()) != <span class="keyword">null</span>) &#123;</span><br><span class="line">        <span class="keyword">switch</span> (opt) &#123;</span><br><span class="line">            <span class="keyword">case</span> <span class="string">"-l"</span>: </span><br><span class="line">                <span class="comment">//【1.1】该应用以 forward locked 方式安装，在该模式下，只有应用自己能够访问自己的代码</span></span><br><span class="line">                <span class="comment">// 和非资源文件！ </span></span><br><span class="line">                sessionParams.installFlags |= PackageManager.INSTALL_FORWARD_LOCK;</span><br><span class="line">                <span class="keyword">break</span>;</span><br><span class="line">            <span class="keyword">case</span> <span class="string">"-r"</span>: <span class="comment">//【1.2】替换已存在的 apk</span></span><br><span class="line">                sessionParams.installFlags |= PackageManager.INSTALL_REPLACE_EXISTING;</span><br><span class="line">                <span class="keyword">break</span>;</span><br><span class="line">            <span class="keyword">case</span> <span class="string">"-i"</span>: <span class="comment">// 显式指定安装器</span></span><br><span class="line">                params.installerPackageName = nextArg();</span><br><span class="line">                <span class="keyword">if</span> (params.installerPackageName == <span class="keyword">null</span>) &#123;</span><br><span class="line">                    <span class="keyword">throw</span> <span class="keyword">new</span> IllegalArgumentException(<span class="string">"Missing installer package"</span>);</span><br><span class="line">                &#125;</span><br><span class="line">                <span class="keyword">break</span>;</span><br><span class="line">            <span class="keyword">case</span> <span class="string">"-t"</span>: <span class="comment">// 允许测试应用安装（设置了 android:testOnly）</span></span><br><span class="line">                sessionParams.installFlags |= PackageManager.INSTALL_ALLOW_TEST;</span><br><span class="line">                <span class="keyword">break</span>;</span><br><span class="line">            <span class="keyword">case</span> <span class="string">"-s"</span>: <span class="comment">// 安装到外置存储</span></span><br><span class="line">                sessionParams.installFlags |= PackageManager.INSTALL_EXTERNAL;</span><br><span class="line">                <span class="keyword">break</span>;</span><br><span class="line">            <span class="keyword">case</span> <span class="string">"-f"</span>: <span class="comment">// 安装到内置存储</span></span><br><span class="line">                sessionParams.installFlags |= PackageManager.INSTALL_INTERNAL;</span><br><span class="line">                <span class="keyword">break</span>;</span><br><span class="line">            <span class="keyword">case</span> <span class="string">"-d"</span>: <span class="comment">//【1.3】允许降级安装！</span></span><br><span class="line">                sessionParams.installFlags |= PackageManager.INSTALL_ALLOW_DOWNGRADE;</span><br><span class="line">                <span class="keyword">break</span>;</span><br><span class="line">            <span class="keyword">case</span> <span class="string">"-g"</span>: <span class="comment">//【1.4】授予运行时权限</span></span><br><span class="line">                sessionParams.installFlags |= PackageManager.INSTALL_GRANT_RUNTIME_PERMISSIONS;</span><br><span class="line">                <span class="keyword">break</span>;</span><br><span class="line">            <span class="keyword">case</span> <span class="string">"--dont-kill"</span>: <span class="comment">// 安装不会杀 app 进程</span></span><br><span class="line">                sessionParams.installFlags |= PackageManager.INSTALL_DONT_KILL_APP;</span><br><span class="line">                <span class="keyword">break</span>;</span><br><span class="line">            <span class="keyword">case</span> <span class="string">"--originating-uri"</span>:</span><br><span class="line">                sessionParams.originatingUri = Uri.parse(nextOptionData());</span><br><span class="line">                <span class="keyword">break</span>;</span><br><span class="line">            <span class="keyword">case</span> <span class="string">"--referrer"</span>:</span><br><span class="line">                sessionParams.referrerUri = Uri.parse(nextOptionData());</span><br><span class="line">                <span class="keyword">break</span>;</span><br><span class="line">            <span class="keyword">case</span> <span class="string">"-p"</span>: <span class="comment">//【1.5】继承已存在的 apk，appPackageName 用以保存要继承的包名，也就是主 apk 的报名！</span></span><br><span class="line">                sessionParams.mode = SessionParams.MODE_INHERIT_EXISTING;</span><br><span class="line">                sessionParams.appPackageName = nextOptionData();</span><br><span class="line">                <span class="keyword">if</span> (sessionParams.appPackageName == <span class="keyword">null</span>) &#123;</span><br><span class="line">                    <span class="keyword">throw</span> <span class="keyword">new</span> IllegalArgumentException(<span class="string">"Missing inherit package name"</span>);</span><br><span class="line">                &#125;</span><br><span class="line">                <span class="keyword">break</span>;</span><br><span class="line">            <span class="keyword">case</span> <span class="string">"-S"</span>: <span class="comment">// 显式指定应用的大小</span></span><br><span class="line">                sessionParams.setSize(Long.parseLong(nextOptionData()));</span><br><span class="line">                <span class="keyword">break</span>;</span><br><span class="line">            <span class="keyword">case</span> <span class="string">"--abi"</span>: <span class="comment">// 显式指定 abi</span></span><br><span class="line">                sessionParams.abiOverride = checkAbiArgument(nextOptionData());</span><br><span class="line">                <span class="keyword">break</span>;</span><br><span class="line">            <span class="keyword">case</span> <span class="string">"--ephemeral"</span>: <span class="comment">// 作为一个 lightweight "ephemeral" 应用！</span></span><br><span class="line">                sessionParams.installFlags |= PackageManager.INSTALL_EPHEMERAL;</span><br><span class="line">                <span class="keyword">break</span>;</span><br><span class="line">            <span class="keyword">case</span> <span class="string">"--user"</span>: <span class="comment">// 指定安装的 userId</span></span><br><span class="line">                params.userId = UserHandle.parseUserArg(nextOptionData());</span><br><span class="line">                <span class="keyword">break</span>;</span><br><span class="line">            <span class="keyword">case</span> <span class="string">"--install-location"</span>: <span class="comment">// 指定安装位置</span></span><br><span class="line">                sessionParams.installLocation = Integer.parseInt(nextOptionData());</span><br><span class="line">                <span class="keyword">break</span>;</span><br><span class="line">            <span class="keyword">case</span> <span class="string">"--force-uuid"</span>:</span><br><span class="line">                sessionParams.installFlags |= PackageManager.INSTALL_FORCE_VOLUME_UUID;</span><br><span class="line">                sessionParams.volumeUuid = nextOptionData();</span><br><span class="line">                <span class="keyword">if</span> (<span class="string">"internal"</span>.equals(sessionParams.volumeUuid)) &#123;</span><br><span class="line">                    sessionParams.volumeUuid = <span class="keyword">null</span>;</span><br><span class="line">                &#125;</span><br><span class="line">                <span class="keyword">break</span>;</span><br><span class="line">            <span class="keyword">case</span> <span class="string">"--force-sdk"</span>:</span><br><span class="line">                sessionParams.installFlags |= PackageManager.INSTALL_FORCE_SDK;</span><br><span class="line">                <span class="keyword">break</span>;</span><br><span class="line">            <span class="keyword">default</span>:</span><br><span class="line">                <span class="keyword">throw</span> <span class="keyword">new</span> IllegalArgumentException(<span class="string">"Unknown option "</span> + opt);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> params;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>额外的参数很多，根据额外的参数，对 SessionParams 进行了属性设置！</p>
<p>sessionParams.installFlags 会根据不同的额外参数，设置不同的二进制位，具体的含义我上面也简单的注释了下。大家可以自己去看源码！</p>
<p>这里我们要注意下：</p>
<ul>
<li>如果我们安装的是 split apk 的话，那么我们可以指定 -p 参数，后面指定主 apk 的包名，后面我们会分析其作用！</li>
</ul>
<h4 id="2-9-1-1-new-SessionParams"><a href="#2-9-1-1-new-SessionParams" class="headerlink" title="2.9.1.1 new SessionParams"></a>2.9.1.1 new SessionParams</h4><p>SessionParams 定义在 PackageInstaller.java 文件中：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> <span class="class"><span class="keyword">class</span> <span class="title">SessionParams</span> <span class="keyword">implements</span> <span class="title">Parcelable</span> </span>&#123;</span><br><span class="line">    <span class="comment">/** &#123;<span class="doctag">@hide</span>&#125; */</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">int</span> mode = MODE_INVALID;</span><br><span class="line">    <span class="comment">/** &#123;<span class="doctag">@hide</span>&#125; */</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">int</span> installFlags;</span><br><span class="line">    <span class="comment">/** &#123;<span class="doctag">@hide</span>&#125; */</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">int</span> installLocation = PackageInfo.INSTALL_LOCATION_INTERNAL_ONLY; <span class="comment">// 默认为仅内置</span></span><br><span class="line">    <span class="comment">/** &#123;<span class="doctag">@hide</span>&#125; */</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">long</span> sizeBytes = -<span class="number">1</span>;</span><br><span class="line">    <span class="comment">/** &#123;<span class="doctag">@hide</span>&#125; */</span></span><br><span class="line">    <span class="keyword">public</span> String appPackageName; <span class="comment">// 要继承的主 apk 的包名；</span></span><br><span class="line">    <span class="comment">/** &#123;<span class="doctag">@hide</span>&#125; */</span></span><br><span class="line">    <span class="keyword">public</span> Bitmap appIcon;</span><br><span class="line">    <span class="comment">/** &#123;<span class="doctag">@hide</span>&#125; */</span></span><br><span class="line">    <span class="keyword">public</span> String appLabel;</span><br><span class="line">    <span class="comment">/** &#123;<span class="doctag">@hide</span>&#125; */</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">long</span> appIconLastModified = -<span class="number">1</span>;</span><br><span class="line">    <span class="comment">/** &#123;<span class="doctag">@hide</span>&#125; */</span></span><br><span class="line">    <span class="keyword">public</span> Uri originatingUri;</span><br><span class="line">    <span class="comment">/** &#123;<span class="doctag">@hide</span>&#125; */</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">int</span> originatingUid = UID_UNKNOWN;</span><br><span class="line">    <span class="comment">/** &#123;<span class="doctag">@hide</span>&#125; */</span></span><br><span class="line">    <span class="keyword">public</span> Uri referrerUri;</span><br><span class="line">    <span class="comment">/** &#123;<span class="doctag">@hide</span>&#125; */</span></span><br><span class="line">    <span class="keyword">public</span> String abiOverride;</span><br><span class="line">    <span class="comment">/** &#123;<span class="doctag">@hide</span>&#125; */</span></span><br><span class="line">    <span class="keyword">public</span> String volumeUuid;</span><br><span class="line">    <span class="comment">/** &#123;<span class="doctag">@hide</span>&#125; */</span></span><br><span class="line">    <span class="keyword">public</span> String[] grantedRuntimePermissions;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="title">SessionParams</span><span class="params">(<span class="keyword">int</span> mode)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">this</span>.mode = mode;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/** &#123;<span class="doctag">@hide</span>&#125; */</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="title">SessionParams</span><span class="params">(Parcel source)</span> </span>&#123;</span><br><span class="line">        mode = source.readInt();</span><br><span class="line">        installFlags = source.readInt();</span><br><span class="line">        installLocation = source.readInt();</span><br><span class="line">        sizeBytes = source.readLong();</span><br><span class="line">        appPackageName = source.readString();</span><br><span class="line">        appIcon = source.readParcelable(<span class="keyword">null</span>);</span><br><span class="line">        appLabel = source.readString();</span><br><span class="line">        originatingUri = source.readParcelable(<span class="keyword">null</span>);</span><br><span class="line">        originatingUid = source.readInt();</span><br><span class="line">        referrerUri = source.readParcelable(<span class="keyword">null</span>);</span><br><span class="line">        abiOverride = source.readString();</span><br><span class="line">        volumeUuid = source.readString();</span><br><span class="line">        grantedRuntimePermissions = source.readStringArray();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    ... ... ... ...</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>这里我们来说下 mode 属性，它可以取三个值：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="keyword">int</span> MODE_INVALID = -<span class="number">1</span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 表示：完全替换已存在的 apk</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="keyword">int</span> MODE_FULL_INSTALL = <span class="number">1</span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 表示：会继承已存在的 apk，可以用于给 apk 添加 split APKS，如果没有已存在的 apk，</span></span><br><span class="line"><span class="comment">// 效果和 MODE_FULL_INSTALL 是一样的！</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="keyword">int</span> MODE_INHERIT_EXISTING = <span class="number">2</span>;</span><br></pre></td></tr></table></figure>
<p>我们省略掉暂时用不到的一些接口，后面有机会再分析！</p>
<h4 id="2-9-1-2-new-Pm-InstallParams"><a href="#2-9-1-2-new-Pm-InstallParams" class="headerlink" title="2.9.1.2 new Pm.InstallParams"></a>2.9.1.2 new Pm.InstallParams</h4><p>InstallParams 类很简单，内部有一个 SessionParams 实例变量，封装安装参数！<br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">private</span> <span class="keyword">static</span> <span class="class"><span class="keyword">class</span> <span class="title">InstallParams</span> </span>&#123;</span><br><span class="line">    SessionParams sessionParams;</span><br><span class="line">    String installerPackageName; <span class="comment">// 安装器的名字！</span></span><br><span class="line">    <span class="keyword">int</span> userId = UserHandle.USER_ALL;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<h3 id="2-9-2-Pm-doCreateSession-创建事务"><a href="#2-9-2-Pm-doCreateSession-创建事务" class="headerlink" title="2.9.2 Pm.doCreateSession - 创建事务"></a>2.9.2 Pm.doCreateSession - 创建事务</h3><p>创建 install Session 对象！</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">int</span> <span class="title">doCreateSession</span><span class="params">(SessionParams params, String installerPackageName, <span class="keyword">int</span> userId)</span></span></span><br><span class="line"><span class="function">        <span class="keyword">throws</span> RemoteException </span>&#123;</span><br><span class="line">    userId = translateUserId(userId, <span class="string">"runInstallCreate"</span>);</span><br><span class="line">    <span class="keyword">if</span> (userId == UserHandle.USER_ALL) &#123;</span><br><span class="line">        userId = UserHandle.USER_SYSTEM;</span><br><span class="line">        params.installFlags |= PackageManager.INSTALL_ALL_USERS;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">//【*3.1】进入 PackageInstallerService！</span></span><br><span class="line">    <span class="keyword">final</span> <span class="keyword">int</span> sessionId = mInstaller.createSession(params, installerPackageName, userId);</span><br><span class="line">    <span class="keyword">return</span> sessionId;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>进入了 PackageInstallerService 服务，创建 Session 对象！</p>
<h3 id="2-9-3-Pm-doWriteSession-写入事务（实际上是拷贝文件）"><a href="#2-9-3-Pm-doWriteSession-写入事务（实际上是拷贝文件）" class="headerlink" title="2.9.3 Pm.doWriteSession - 写入事务（实际上是拷贝文件）"></a>2.9.3 Pm.doWriteSession - 写入事务（实际上是拷贝文件）</h3><p>回顾下参数：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//【*2.9.3】将安装 Session 持久化到本地文件！</span></span><br><span class="line"><span class="keyword">if</span> (doWriteSession(sessionId, inPath, params.sessionParams.sizeBytes, <span class="string">"base.apk"</span>,...))</span><br></pre></td></tr></table></figure>
<p>这里的 splitName 值为 “base.apk”；</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">int</span> <span class="title">doWriteSession</span><span class="params">(<span class="keyword">int</span> sessionId, String inPath, <span class="keyword">long</span> sizeBytes, String splitName,</span></span></span><br><span class="line"><span class="function"><span class="params">        <span class="keyword">boolean</span> logSuccess)</span> <span class="keyword">throws</span> RemoteException </span>&#123;</span><br><span class="line">    <span class="comment">//【1】这里的 inPath 就是前面创建的 /data/local/tmp/ 目录！</span></span><br><span class="line">    <span class="keyword">if</span> (<span class="string">"-"</span>.equals(inPath)) &#123;</span><br><span class="line">        inPath = <span class="keyword">null</span>;</span><br><span class="line">    &#125; <span class="keyword">else</span> <span class="keyword">if</span> (inPath != <span class="keyword">null</span>) &#123;</span><br><span class="line">        <span class="keyword">final</span> File file = <span class="keyword">new</span> File(inPath);</span><br><span class="line">        <span class="keyword">if</span> (file.isFile()) &#123;</span><br><span class="line">            sizeBytes = file.length();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">//【*3.3.2】根据前面创建的 Session id，获得本次安装事务对象！</span></span><br><span class="line">    <span class="keyword">final</span> SessionInfo info = mInstaller.getSessionInfo(sessionId);</span><br><span class="line"></span><br><span class="line">    PackageInstaller.Session session = <span class="keyword">null</span>;</span><br><span class="line">    InputStream in = <span class="keyword">null</span>;</span><br><span class="line">    OutputStream out = <span class="keyword">null</span>;</span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">        <span class="comment">//【*3.2.1】通过 PackageInstallerService.openSession 获得对应的 PackageInstallerSession 对象！</span></span><br><span class="line">        <span class="comment">//【*2.9.3.1】封装成 Session 实例！</span></span><br><span class="line">        session = <span class="keyword">new</span> PackageInstaller.Session(</span><br><span class="line">                mInstaller.openSession(sessionId));</span><br><span class="line"></span><br><span class="line">        <span class="comment">//【3】 定义输入流对象，指向待安装 APK 对应文件的源地址！</span></span><br><span class="line">        <span class="keyword">if</span> (inPath != <span class="keyword">null</span>) &#123;</span><br><span class="line">            in = <span class="keyword">new</span> FileInputStream(inPath);</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            in = <span class="keyword">new</span> SizedInputStream(System.in, sizeBytes);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment">//【*2.9.3.1.1】 定义输出流对象，指向待安装 APK 对应文件的源地址！</span></span><br><span class="line">        out = session.openWrite(splitName, <span class="number">0</span>, sizeBytes);</span><br><span class="line"></span><br><span class="line">        <span class="keyword">int</span> total = <span class="number">0</span>;</span><br><span class="line">        <span class="keyword">byte</span>[] buffer = <span class="keyword">new</span> <span class="keyword">byte</span>[<span class="number">65536</span>];</span><br><span class="line">        <span class="keyword">int</span> c;</span><br><span class="line">        <span class="keyword">while</span> ((c = in.read(buffer)) != -<span class="number">1</span>) &#123;</span><br><span class="line">            total += c;</span><br><span class="line">            <span class="comment">//【5】拷贝文件到 /data/app/vmdl[sessionId].tmp 目标目录！</span></span><br><span class="line">            out.write(buffer, <span class="number">0</span>, c);</span><br><span class="line"></span><br><span class="line">            <span class="keyword">if</span> (info.sizeBytes &gt; <span class="number">0</span>) &#123;</span><br><span class="line">                <span class="keyword">final</span> <span class="keyword">float</span> fraction = ((<span class="keyword">float</span>) c / (<span class="keyword">float</span>) info.sizeBytes);</span><br><span class="line">                <span class="comment">//【6】同时更新拷贝进度</span></span><br><span class="line">                session.addProgress(fraction);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        session.fsync(out);</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (logSuccess) &#123;</span><br><span class="line">            System.out.println(<span class="string">"Success: streamed "</span> + total + <span class="string">" bytes"</span>);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">//【3】拷贝完成，返回 STATUS_SUCCESS！</span></span><br><span class="line">        <span class="keyword">return</span> PackageInstaller.STATUS_SUCCESS;</span><br><span class="line">    &#125; <span class="keyword">catch</span> (IOException e) &#123;</span><br><span class="line">        System.err.println(<span class="string">"Error: failed to write; "</span> + e.getMessage());</span><br><span class="line">        <span class="keyword">return</span> PackageInstaller.STATUS_FAILURE;</span><br><span class="line">    &#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">        IoUtils.closeQuietly(out);</span><br><span class="line">        IoUtils.closeQuietly(in);</span><br><span class="line">        IoUtils.closeQuietly(session);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>doWriteSession 整个流程其实就是进行 apk 的拷贝操作！ </p>
<h4 id="2-9-3-1-new-PackageInstaller-Session"><a href="#2-9-3-1-new-PackageInstaller-Session" class="headerlink" title="2.9.3.1 new PackageInstaller.Session"></a>2.9.3.1 new PackageInstaller.Session</h4><p>Session 是对 PackageInstallerSession 的简单封装！</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> <span class="class"><span class="keyword">class</span> <span class="title">Session</span> <span class="keyword">implements</span> <span class="title">Closeable</span> </span>&#123;</span><br><span class="line">    <span class="keyword">private</span> IPackageInstallerSession mSession;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/** &#123;<span class="doctag">@hide</span>&#125; */</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="title">Session</span><span class="params">(IPackageInstallerSession session)</span> </span>&#123;</span><br><span class="line">        mSession = session;</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure>
<p>mSession 指向了对应的 PackageInstallerSession 实例！</p>
<p>同时其还提供了很多借口，来操作 PackageInstallerSession，这里我们用一张图先简单的看下：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">Session.setProgress  -&gt;  PackageInstallerSession.setClientProgress</span><br><span class="line">Session.setStagingProgress  -&gt;  PackageInstallerSession.setClientProgress</span><br><span class="line">Session.addProgress  -&gt;  PackageInstallerSession.addClientProgress</span><br><span class="line"></span><br><span class="line">Session.openWrite  -&gt;  PackageInstallerSession.openWrite</span><br><span class="line">Session.openRead  -&gt;  PackageInstallerSession.openRead</span><br><span class="line"></span><br><span class="line">Session.commit  -&gt;  PackageInstallerSession.commit</span><br><span class="line">Session.abandon  -&gt;  PackageInstallerSession.abandon</span><br><span class="line">... ... ...</span><br></pre></td></tr></table></figure>
<p>这里我们先来看目前已经涉及到的一些重要方法：</p>
<h5 id="2-9-3-1-1-Session-openWrite"><a href="#2-9-3-1-1-Session-openWrite" class="headerlink" title="2.9.3.1.1 Session.openWrite"></a>2.9.3.1.1 Session.openWrite</h5><p>这里的 name 传入的是 base.apk：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="meta">@NonNull</span> <span class="function">OutputStream <span class="title">openWrite</span><span class="params">(@NonNull String name, <span class="keyword">long</span> offsetBytes,</span></span></span><br><span class="line"><span class="function"><span class="params">        <span class="keyword">long</span> lengthBytes)</span> <span class="keyword">throws</span> IOException </span>&#123;</span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">        <span class="comment">//【*4.1】这里会调用 PackageInstallerSession 的 openWrite 方法</span></span><br><span class="line">        <span class="comment">// 将前面创建 Session 的文件目录 /data/app/vmdl[sessionId].tmp 封装成一个文件描述符对象！  </span></span><br><span class="line">        <span class="keyword">final</span> ParcelFileDescriptor clientSocket = mSession.openWrite(name,</span><br><span class="line">                offsetBytes, lengthBytes);</span><br><span class="line">        <span class="comment">//【2】获得该文件描述符输出流！</span></span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> FileBridge.FileBridgeOutputStream(clientSocket);</span><br><span class="line">    &#125; <span class="keyword">catch</span> (RuntimeException e) &#123;</span><br><span class="line">        ExceptionUtils.maybeUnwrapIOException(e);</span><br><span class="line">        <span class="keyword">throw</span> e;</span><br><span class="line">    &#125; <span class="keyword">catch</span> (RemoteException e) &#123;</span><br><span class="line">        <span class="keyword">throw</span> e.rethrowFromSystemServer();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>mSession.openWrite 方法涉及到了文件相关处理，这里就不过多关注！</p>
<h5 id="2-9-3-1-2-Session-addProgress"><a href="#2-9-3-1-2-Session-addProgress" class="headerlink" title="2.9.3.1.2 Session.addProgress"></a>2.9.3.1.2 Session.addProgress</h5><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">addProgress</span><span class="params">(<span class="keyword">float</span> progress)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">        <span class="comment">//【*2.9.3.1.2.1】这里会调用 PackageInstallerSession 的 addClientProgress 方法</span></span><br><span class="line">        <span class="comment">// 更新文件读写进度！</span></span><br><span class="line">        mSession.addClientProgress(progress);</span><br><span class="line">    &#125; <span class="keyword">catch</span> (RemoteException e) &#123;</span><br><span class="line">        <span class="keyword">throw</span> e.rethrowFromSystemServer();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>继续来看：</p>
<h6 id="2-9-3-1-2-1-PackageInstallerSession-addClientProgress"><a href="#2-9-3-1-2-1-PackageInstallerSession-addClientProgress" class="headerlink" title="2.9.3.1.2.1 PackageInstallerSession.addClientProgress"></a>2.9.3.1.2.1 PackageInstallerSession.addClientProgress</h6><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">addClientProgress</span><span class="params">(<span class="keyword">float</span> progress)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">synchronized</span> (mLock) &#123;</span><br><span class="line">        <span class="comment">//【*2.9.3.1.2.2】调用了 setClientProgress 方法！</span></span><br><span class="line">        setClientProgress(mClientProgress + progress);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h6 id="2-9-3-1-2-2-PackageInstallerSession-setClientProgress"><a href="#2-9-3-1-2-2-PackageInstallerSession-setClientProgress" class="headerlink" title="2.9.3.1.2.2 PackageInstallerSession.setClientProgress"></a>2.9.3.1.2.2 PackageInstallerSession.setClientProgress</h6><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">setClientProgress</span><span class="params">(<span class="keyword">float</span> progress)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">synchronized</span> (mLock) &#123;</span><br><span class="line">        <span class="comment">//【1】用于第一次更新进度！</span></span><br><span class="line">        <span class="keyword">final</span> <span class="keyword">boolean</span> forcePublish = (mClientProgress == <span class="number">0</span>);</span><br><span class="line">        mClientProgress = progress;</span><br><span class="line">        <span class="comment">//【*2.9.3.1.2.3】最终，调用 computeProgressLocked 方法！</span></span><br><span class="line">        computeProgressLocked(forcePublish);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h6 id="2-9-3-1-2-3-PackageInstallerSession-computeProgressLocked"><a href="#2-9-3-1-2-3-PackageInstallerSession-computeProgressLocked" class="headerlink" title="2.9.3.1.2.3 PackageInstallerSession.computeProgressLocked"></a>2.9.3.1.2.3 PackageInstallerSession.computeProgressLocked</h6><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">computeProgressLocked</span><span class="params">(<span class="keyword">boolean</span> forcePublish)</span> </span>&#123;</span><br><span class="line">    <span class="comment">//【1】计算进度！</span></span><br><span class="line">    mProgress = MathUtils.constrain(mClientProgress * <span class="number">0.8f</span>, <span class="number">0f</span>, <span class="number">0.8f</span>)</span><br><span class="line">            + MathUtils.constrain(mInternalProgress * <span class="number">0.2f</span>, <span class="number">0f</span>, <span class="number">0.2f</span>);</span><br><span class="line">    <span class="comment">//【2】更新进度</span></span><br><span class="line">    <span class="keyword">if</span> (forcePublish || Math.abs(mProgress - mReportedProgress) &gt;= <span class="number">0.01</span>) &#123;</span><br><span class="line">        mReportedProgress = mProgress;</span><br><span class="line">        <span class="comment">//【*3.1.4.2】同时通知事务观察者，进度的变化！</span></span><br><span class="line">        mCallback.onSessionProgressChanged(<span class="keyword">this</span>, mProgress);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>逻辑很简单，这里就不多说了！</p>
<h3 id="2-9-4-Pm-doCommitSession-提交事务"><a href="#2-9-4-Pm-doCommitSession-提交事务" class="headerlink" title="2.9.4 Pm.doCommitSession - 提交事务"></a>2.9.4 Pm.doCommitSession - 提交事务</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">int</span> <span class="title">doCommitSession</span><span class="params">(<span class="keyword">int</span> sessionId, <span class="keyword">boolean</span> logSuccess)</span> <span class="keyword">throws</span> RemoteException </span>&#123;</span><br><span class="line">    PackageInstaller.Session session = <span class="keyword">null</span>;</span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">        <span class="comment">//【*2.9.3.1】获得前面创建的 Session 对象！</span></span><br><span class="line">        session = <span class="keyword">new</span> PackageInstaller.Session(</span><br><span class="line">                mInstaller.openSession(sessionId));</span><br><span class="line">        <span class="comment">//【*2.9.4.1】创建了一个 LocalIntentReceiver！</span></span><br><span class="line">        <span class="keyword">final</span> LocalIntentReceiver receiver = <span class="keyword">new</span> LocalIntentReceiver();</span><br><span class="line"></span><br><span class="line">        <span class="comment">//【*2.9.4.2】将 receiver.getIntentSender() 传递给 pms，用户客户端进程获得安装结果</span></span><br><span class="line">        <span class="comment">//【*2.9.4.3】调用 PackageInstallerSession 的 commit 方法，提交事务！</span></span><br><span class="line">        session.commit(receiver.getIntentSender());</span><br><span class="line"></span><br><span class="line">        <span class="comment">//【*2.9.4.4】处理返回结果！</span></span><br><span class="line">        <span class="keyword">final</span> Intent result = receiver.getResult();</span><br><span class="line">        <span class="keyword">final</span> <span class="keyword">int</span> status = result.getIntExtra(PackageInstaller.EXTRA_STATUS,</span><br><span class="line">                PackageInstaller.STATUS_FAILURE);</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (status == PackageInstaller.STATUS_SUCCESS) &#123;</span><br><span class="line">            <span class="keyword">if</span> (logSuccess) &#123;</span><br><span class="line">                System.out.println(<span class="string">"Success"</span>);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            System.err.println(<span class="string">"Failure ["</span></span><br><span class="line">                    + result.getStringExtra(PackageInstaller.EXTRA_STATUS_MESSAGE) + <span class="string">"]"</span>);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> status;</span><br><span class="line">    &#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">        IoUtils.closeQuietly(session);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>到这里，提交过程就结束了，最终的逻辑是在 PackageInstallerService 中实现！</p>
<h4 id="2-9-4-1-new-LocalIntentReceiver-跨进程返回结果"><a href="#2-9-4-1-new-LocalIntentReceiver-跨进程返回结果" class="headerlink" title="2.9.4.1 new LocalIntentReceiver - 跨进程返回结果"></a>2.9.4.1 new LocalIntentReceiver - 跨进程返回结果</h4><p>LocalIntentReceiver 用来接收安装结果！</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">private</span> <span class="keyword">static</span> <span class="class"><span class="keyword">class</span> <span class="title">LocalIntentReceiver</span> </span>&#123;</span><br><span class="line">    <span class="comment">//【1】以 Intent 的方式保存安装结果！</span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> SynchronousQueue&lt;Intent&gt; mResult = <span class="keyword">new</span> SynchronousQueue&lt;&gt;();</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> IIntentSender.Stub mLocalSender = <span class="keyword">new</span> IIntentSender.Stub() &#123;</span><br><span class="line">        <span class="meta">@Override</span></span><br><span class="line">        <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">send</span><span class="params">(<span class="keyword">int</span> code, Intent intent, String resolvedType,</span></span></span><br><span class="line"><span class="function"><span class="params">                IIntentReceiver finishedReceiver, String requiredPermission, Bundle options)</span> </span>&#123;</span><br><span class="line">            <span class="keyword">try</span> &#123;</span><br><span class="line">                <span class="comment">//【1.1】将结果保存到 mResult 中！</span></span><br><span class="line">                mResult.offer(intent, <span class="number">5</span>, TimeUnit.SECONDS);</span><br><span class="line">            &#125; <span class="keyword">catch</span> (InterruptedException e) &#123;</span><br><span class="line">                <span class="keyword">throw</span> <span class="keyword">new</span> RuntimeException(e);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;;</span><br><span class="line">    ... ... ...</span><br></pre></td></tr></table></figure>
<p>LocalIntentReceiver 有一个内部成员 mLocalSender，实现了 IIntentSender.Stub，用于跨进程通信！</p>
<p>系统进程会持有 mLocalSender 对应的代理对象，通过 send 方法，将安装的状态或者结果返回保存到 mResult 中！</p>
<h4 id="2-9-4-2-LocalIntentReceiver-getIntentSender"><a href="#2-9-4-2-LocalIntentReceiver-getIntentSender" class="headerlink" title="2.9.4.2 LocalIntentReceiver.getIntentSender"></a>2.9.4.2 LocalIntentReceiver.getIntentSender</h4><p>getIntentSender 将 getIntentSender 封装到 IntentSender 中，由于 IntentSender 实现了 Parcelable，所以可以跨进程传递：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> IntentSender <span class="title">getIntentSender</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">new</span> IntentSender((IIntentSender) mLocalSender);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h4 id="2-9-4-3-Session-commit"><a href="#2-9-4-3-Session-commit" class="headerlink" title="2.9.4.3 Session.commit"></a>2.9.4.3 Session.commit</h4><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">commit</span><span class="params">(@NonNull IntentSender statusReceiver)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">        <span class="comment">//【*4.2】最终，调用了 PackageInstallerSession 的 commit 方法，进入系统进程！</span></span><br><span class="line">        mSession.commit(statusReceiver);</span><br><span class="line">    &#125; <span class="keyword">catch</span> (RemoteException e) &#123;</span><br><span class="line">        <span class="keyword">throw</span> e.rethrowFromSystemServer();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>继续来看：</p>
<h4 id="2-9-4-4-LocalIntentReceiver-getResult"><a href="#2-9-4-4-LocalIntentReceiver-getResult" class="headerlink" title="2.9.4.4 LocalIntentReceiver.getResult"></a>2.9.4.4 LocalIntentReceiver.getResult</h4><p>getResult 用于获得安装结果！</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> Intent <span class="title">getResult</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">        <span class="comment">//【1】返回安装结果！</span></span><br><span class="line">        <span class="keyword">return</span> mResult.take();</span><br><span class="line">    &#125; <span class="keyword">catch</span> (InterruptedException e) &#123;</span><br><span class="line">        <span class="keyword">throw</span> <span class="keyword">new</span> RuntimeException(e);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>就先分析到这里：</p>
<p>#3 PackageInstallerService</p>
<p>下面来分析下 PackageInstallerService 中的逻辑，我们先来看看 PackageInstallerService 的创建，当然，这部分的逻辑是在开机的时候，这里我们再回顾下：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="title">PackageInstallerService</span><span class="params">(Context context, PackageManagerService pm)</span> </span>&#123;</span><br><span class="line">    mContext = context;</span><br><span class="line">    mPm = pm;</span><br><span class="line">    <span class="comment">//【1】启动了一个 HandlerThread 线程！</span></span><br><span class="line">    mInstallThread = <span class="keyword">new</span> HandlerThread(TAG);</span><br><span class="line">    mInstallThread.start();</span><br><span class="line">    <span class="comment">//【2】创建了 mInstallThread 对应的 Handler；</span></span><br><span class="line">    mInstallHandler = <span class="keyword">new</span> Handler(mInstallThread.getLooper());</span><br><span class="line">    <span class="comment">//【*3.1.4.1】创建了 Callbacks 实例，用于处理安装回调，传入了子线程的 Loopder！</span></span><br><span class="line">    mCallbacks = <span class="keyword">new</span> Callbacks(mInstallThread.getLooper());</span><br><span class="line">    <span class="comment">//【3】创建了 sessions 本地持久化文件和目录对象！</span></span><br><span class="line">    mSessionsFile = <span class="keyword">new</span> AtomicFile(</span><br><span class="line">            <span class="keyword">new</span> File(Environment.getDataSystemDirectory(), <span class="string">"install_sessions.xml"</span>));</span><br><span class="line">    mSessionsDir = <span class="keyword">new</span> File(Environment.getDataSystemDirectory(), <span class="string">"install_sessions"</span>);</span><br><span class="line">    mSessionsDir.mkdirs();</span><br><span class="line"></span><br><span class="line">    <span class="keyword">synchronized</span> (mSessions) &#123;</span><br><span class="line">        <span class="comment">//【4】读取本次持久化文件中的事务，创建对应的 PackageInstallerSession 实例！</span></span><br><span class="line">        readSessionsLocked();</span><br><span class="line">        <span class="comment">//【5】解决临时拷贝目录和持久化事务的冲突，过程很简单，移除那些没有持久化事务的临时拷贝文件！</span></span><br><span class="line">        reconcileStagesLocked(StorageManager.UUID_PRIVATE_INTERNAL, <span class="keyword">false</span> <span class="comment">/*isEphemeral*/</span>);</span><br><span class="line">        reconcileStagesLocked(StorageManager.UUID_PRIVATE_INTERNAL, <span class="keyword">true</span> <span class="comment">/*isEphemeral*/</span>);</span><br><span class="line"></span><br><span class="line">        <span class="keyword">final</span> ArraySet&lt;File&gt; unclaimedIcons = newArraySet(</span><br><span class="line">                mSessionsDir.listFiles());</span><br><span class="line">        <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; mSessions.size(); i++) &#123;</span><br><span class="line">            <span class="keyword">final</span> PackageInstallerSession session = mSessions.valueAt(i);</span><br><span class="line">            unclaimedIcons.remove(buildAppIconFile(session.sessionId));</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">for</span> (File icon : unclaimedIcons) &#123;</span><br><span class="line">            Slog.w(TAG, <span class="string">"Deleting orphan icon "</span> + icon);</span><br><span class="line">            icon.delete();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>关于 PackageInstallerService 这里就不在过多分析，我们继续看！！</p>
<h2 id="3-1-PackageInstallerS-createSession-Internal-创建事务"><a href="#3-1-PackageInstallerS-createSession-Internal-创建事务" class="headerlink" title="3.1 PackageInstallerS.createSession(Internal) - 创建事务"></a>3.1 PackageInstallerS.createSession(Internal) - 创建事务</h2><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">int</span> <span class="title">createSession</span><span class="params">(SessionParams params, String installerPackageName, <span class="keyword">int</span> userId)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">        <span class="comment">//【1】继续来看！</span></span><br><span class="line">        <span class="keyword">return</span> createSessionInternal(params, installerPackageName, userId);</span><br><span class="line">    &#125; <span class="keyword">catch</span> (IOException e) &#123;</span><br><span class="line">        <span class="keyword">throw</span> ExceptionUtils.wrap(e);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>createSession 方法调用了 createSessionInternal 方法！</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">int</span> <span class="title">createSessionInternal</span><span class="params">(SessionParams params, String installerPackageName, <span class="keyword">int</span> userId)</span></span></span><br><span class="line"><span class="function">        <span class="keyword">throws</span> IOException </span>&#123;</span><br><span class="line">    <span class="keyword">final</span> <span class="keyword">int</span> callingUid = Binder.getCallingUid();</span><br><span class="line">    <span class="comment">//【1】权限检查！</span></span><br><span class="line">    mPm.enforceCrossUserPermission(callingUid, userId, <span class="keyword">true</span>, <span class="keyword">true</span>, <span class="string">"createSession"</span>);</span><br><span class="line">    <span class="comment">//【2】用户操作检查！</span></span><br><span class="line">    <span class="keyword">if</span> (mPm.isUserRestricted(userId, UserManager.DISALLOW_INSTALL_APPS)) &#123;</span><br><span class="line">        <span class="keyword">throw</span> <span class="keyword">new</span> SecurityException(<span class="string">"User restriction prevents installing"</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">//【3】如果调用进程的 uid 是 SHELL_UID 或者 ROOT_UID，那么 installFlags 增加爱你 INSTALL_FROM_ADB</span></span><br><span class="line">    <span class="comment">// 表示通过 adb 进行安装！</span></span><br><span class="line">    <span class="keyword">if</span> ((callingUid == Process.SHELL_UID) || (callingUid == Process.ROOT_UID)) &#123;</span><br><span class="line">        params.installFlags |= PackageManager.INSTALL_FROM_ADB;</span><br><span class="line"></span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        <span class="comment">// 如果是 shell or root，校验下 package 是否属于 uid，</span></span><br><span class="line">        mAppOps.checkPackage(callingUid, installerPackageName);</span><br><span class="line">        <span class="comment">// 取消 INSTALL_FROM_ADB 和 INSTALL_ALL_USERS 标志位，设置 INSTALL_REPLACE_EXISTING 标志位！</span></span><br><span class="line">        params.installFlags &amp;= ~PackageManager.INSTALL_FROM_ADB;</span><br><span class="line">        params.installFlags &amp;= ~PackageManager.INSTALL_ALL_USERS;</span><br><span class="line">        params.installFlags |= PackageManager.INSTALL_REPLACE_EXISTING;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//【4】如果 installFlags 设置了 INSTALL_GRANT_RUNTIME_PERMISSIONS 标志位，那需要判断调用者是否有 </span></span><br><span class="line">    <span class="comment">// INSTALL_GRANT_RUNTIME_PERMISSIONS 权限！</span></span><br><span class="line">    <span class="keyword">if</span> ((params.installFlags &amp; PackageManager.INSTALL_GRANT_RUNTIME_PERMISSIONS) != <span class="number">0</span></span><br><span class="line">            &amp;&amp; mContext.checkCallingOrSelfPermission(Manifest.permission</span><br><span class="line">            .INSTALL_GRANT_RUNTIME_PERMISSIONS) == PackageManager.PERMISSION_DENIED) &#123;</span><br><span class="line">        <span class="keyword">throw</span> <span class="keyword">new</span> SecurityException(<span class="string">"You need the "</span></span><br><span class="line">                + <span class="string">"android.permission.INSTALL_GRANT_RUNTIME_PERMISSIONS permission "</span></span><br><span class="line">                + <span class="string">"to use the PackageManager.INSTALL_GRANT_RUNTIME_PERMISSIONS flag"</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//【5】调整应用的 icon 图标！</span></span><br><span class="line">    <span class="keyword">if</span> (params.appIcon != <span class="keyword">null</span>) &#123;</span><br><span class="line">        <span class="keyword">final</span> ActivityManager am = (ActivityManager) mContext.getSystemService(</span><br><span class="line">                Context.ACTIVITY_SERVICE);</span><br><span class="line">        <span class="keyword">final</span> <span class="keyword">int</span> iconSize = am.getLauncherLargeIconSize();</span><br><span class="line">        <span class="keyword">if</span> ((params.appIcon.getWidth() &gt; iconSize * <span class="number">2</span>)</span><br><span class="line">                || (params.appIcon.getHeight() &gt; iconSize * <span class="number">2</span>)) &#123;</span><br><span class="line">            params.appIcon = Bitmap.createScaledBitmap(params.appIcon, iconSize, iconSize,</span><br><span class="line">                    <span class="keyword">true</span>);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">//【6】检查 mode 取值是否正确！</span></span><br><span class="line">    <span class="keyword">switch</span> (params.mode) &#123;</span><br><span class="line">        <span class="keyword">case</span> SessionParams.MODE_FULL_INSTALL:</span><br><span class="line">        <span class="keyword">case</span> SessionParams.MODE_INHERIT_EXISTING:</span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line">        <span class="keyword">default</span>:</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> IllegalArgumentException(<span class="string">"Invalid install mode: "</span> + params.mode);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//【7】根据 installFlags 设置，调整安装位置，如果用户显示设置了位置，系统会对其进行检查，否则</span></span><br><span class="line">    <span class="comment">// 系统会选择合适的位置！</span></span><br><span class="line">    <span class="keyword">if</span> ((params.installFlags &amp; PackageManager.INSTALL_INTERNAL) != <span class="number">0</span>) &#123;</span><br><span class="line">        <span class="comment">//【7.1】如果显式指定内置，判断是否合适安装！</span></span><br><span class="line">        <span class="keyword">if</span> (!PackageHelper.fitsOnInternal(mContext, params.sizeBytes)) &#123;</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> IOException(<span class="string">"No suitable internal storage available"</span>);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">    &#125; <span class="keyword">else</span> <span class="keyword">if</span> ((params.installFlags &amp; PackageManager.INSTALL_EXTERNAL) != <span class="number">0</span>) &#123;</span><br><span class="line">        <span class="comment">//【7.2】如果显式指定外置，判断是否合适安装！</span></span><br><span class="line">        <span class="keyword">if</span> (!PackageHelper.fitsOnExternal(mContext, params.sizeBytes)) &#123;</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> IOException(<span class="string">"No suitable external storage available"</span>);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">    &#125; <span class="keyword">else</span> <span class="keyword">if</span> ((params.installFlags &amp; PackageManager.INSTALL_FORCE_VOLUME_UUID) != <span class="number">0</span>) &#123;</span><br><span class="line">        params.setInstallFlagsInternal();</span><br><span class="line"></span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        <span class="comment">//【7.4】默认情况下，进入这里，setInstallFlagsInternal 方法会设置 INSTALL_INTERNAL 标志位</span></span><br><span class="line">        <span class="comment">// 取消 INSTALL_EXTERNAL 标志位！</span></span><br><span class="line">        params.setInstallFlagsInternal();</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 选择最好的位置来安装！</span></span><br><span class="line">        <span class="keyword">final</span> <span class="keyword">long</span> ident = Binder.clearCallingIdentity();</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            params.volumeUuid = PackageHelper.resolveInstallVolume(mContext,</span><br><span class="line">                    params.appPackageName, params.installLocation, params.sizeBytes);</span><br><span class="line">        &#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">            Binder.restoreCallingIdentity(ident);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">final</span> <span class="keyword">int</span> sessionId;</span><br><span class="line">    <span class="keyword">final</span> PackageInstallerSession session;</span><br><span class="line">    <span class="keyword">synchronized</span> (mSessions) &#123;</span><br><span class="line">        <span class="comment">//【*3.1.1】判断，同一个 uid 是否有过多的正在处理的 Session，如果超过了 1024 个，那当前就不能执行安装！</span></span><br><span class="line">        <span class="keyword">final</span> <span class="keyword">int</span> activeCount = getSessionCount(mSessions, callingUid);</span><br><span class="line">        <span class="keyword">if</span> (activeCount &gt;= MAX_ACTIVE_SESSIONS) &#123;</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> IllegalStateException(</span><br><span class="line">                    <span class="string">"Too many active sessions for UID "</span> + callingUid);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">// 同样。判断同一个 uid，是否已经提交了过多的 Session，如果超过了 1048576 个，那当前就不能执行安装！</span></span><br><span class="line">        <span class="keyword">final</span> <span class="keyword">int</span> historicalCount = getSessionCount(mHistoricalSessions, callingUid);</span><br><span class="line">        <span class="keyword">if</span> (historicalCount &gt;= MAX_HISTORICAL_SESSIONS) &#123;</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> IllegalStateException(</span><br><span class="line">                    <span class="string">"Too many historical sessions for UID "</span> + callingUid);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">//【*3.1.2】给本次安装分配一个事务 id！</span></span><br><span class="line">        sessionId = allocateSessionIdLocked();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">final</span> <span class="keyword">long</span> createdMillis = System.currentTimeMillis();</span><br><span class="line"></span><br><span class="line">    <span class="comment">//【8】决定安装目录，因为默认是内置空间，这里会直接进入 buildStageDir 方法！</span></span><br><span class="line">    File stageDir = <span class="keyword">null</span>;</span><br><span class="line">    String stageCid = <span class="keyword">null</span>;</span><br><span class="line">    <span class="keyword">if</span> ((params.installFlags &amp; PackageManager.INSTALL_INTERNAL) != <span class="number">0</span>) &#123;</span><br><span class="line">        <span class="keyword">final</span> <span class="keyword">boolean</span> isEphemeral =</span><br><span class="line">                (params.installFlags &amp; PackageManager.INSTALL_EPHEMERAL) != <span class="number">0</span>;</span><br><span class="line">        <span class="comment">//【*3.1.3】创建文件临时目录；/data/app/vmdl[sessionId].tmp！</span></span><br><span class="line">        stageDir = buildStageDir(params.volumeUuid, sessionId, isEphemeral);</span><br><span class="line"></span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        <span class="comment">// 如果是外置，会直接返回 "smdl" + sessionId + ".tmp"</span></span><br><span class="line">        stageCid = buildExternalStageCid(sessionId);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//【*3.1.4】创建 PackageInstallerSession 对象！</span></span><br><span class="line">    session = <span class="keyword">new</span> PackageInstallerSession(mInternalCallback, mContext, mPm,</span><br><span class="line">            mInstallThread.getLooper(), sessionId, userId, installerPackageName, callingUid,</span><br><span class="line">            params, createdMillis, stageDir, stageCid, <span class="keyword">false</span>, <span class="keyword">false</span>);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">synchronized</span> (mSessions) &#123;</span><br><span class="line">        <span class="comment">//【9】将新创建的 PackageInstallerSession 添加到 mSessions 集合中！</span></span><br><span class="line">        mSessions.put(sessionId, session);</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">//【*3.1.4.2】通知有新的事务创建了，这里是直接回调 Callback 的接口！！</span></span><br><span class="line">    mCallbacks.notifySessionCreated(session.sessionId, session.userId);</span><br><span class="line"></span><br><span class="line">    <span class="comment">//【*3.1.6】持久化事务 Session！</span></span><br><span class="line">    writeSessionsAsync();</span><br><span class="line">    <span class="keyword">return</span> sessionId;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h3 id="3-1-1-PackageInstallerS-getSessionCount"><a href="#3-1-1-PackageInstallerS-getSessionCount" class="headerlink" title="3.1.1 PackageInstallerS.getSessionCount"></a>3.1.1 PackageInstallerS.getSessionCount</h3><p>获得 installerUid 创建的 Session 总数：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">int</span> <span class="title">getSessionCount</span><span class="params">(SparseArray&lt;PackageInstallerSession&gt; sessions,</span></span></span><br><span class="line"><span class="function"><span class="params">        <span class="keyword">int</span> installerUid)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">int</span> count = <span class="number">0</span>;</span><br><span class="line">    <span class="keyword">final</span> <span class="keyword">int</span> size = sessions.size();</span><br><span class="line">    <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; size; i++) &#123;</span><br><span class="line">        <span class="keyword">final</span> PackageInstallerSession session = sessions.valueAt(i);</span><br><span class="line">        <span class="comment">//【1】匹配创建者的 uid！</span></span><br><span class="line">        <span class="keyword">if</span> (session.installerUid == installerUid) &#123;</span><br><span class="line">            count++;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> count;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>PackageInstallerService 有两个 SparseBooleanArray 成员变量：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@GuardedBy</span>(<span class="string">"mSessions"</span>)</span><br><span class="line"><span class="keyword">private</span> <span class="keyword">final</span> SparseArray&lt;PackageInstallerSession&gt; mSessions = <span class="keyword">new</span> SparseArray&lt;&gt;();</span><br></pre></td></tr></table></figure>
<p>mSessions 保存了所有正在处理的 Session 实例，下标为创建事务的 uid，值为 PackageInstallerSession 是对 Session 的封装！</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/** Historical sessions kept around for debugging purposes */</span></span><br><span class="line"><span class="meta">@GuardedBy</span>(<span class="string">"mSessions"</span>)</span><br><span class="line"><span class="keyword">private</span> <span class="keyword">final</span> SparseArray&lt;PackageInstallerSession&gt; mHistoricalSessions = <span class="keyword">new</span> SparseArray&lt;&gt;();</span><br></pre></td></tr></table></figure>
<p>mHistoricalSessions 保存了所有已经处理的 Session 实例，下标为创建事务的 uid，值为 PackageInstallerSession 是对 Session 的封装！</p>
<p>###3.1.2 PackageInstallerS.allocateSessionIdLocked</p>
<p>allocateSessionIdLocked 方法用于给新的 Session 分配 id！</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">int</span> <span class="title">allocateSessionIdLocked</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    <span class="keyword">int</span> n = <span class="number">0</span>;</span><br><span class="line">    <span class="keyword">int</span> sessionId;</span><br><span class="line">    <span class="keyword">do</span> &#123;</span><br><span class="line">        sessionId = mRandom.nextInt(Integer.MAX_VALUE - <span class="number">1</span>) + <span class="number">1</span>;</span><br><span class="line">        <span class="keyword">if</span> (!mAllocatedSessions.get(sessionId, <span class="keyword">false</span>)) &#123;</span><br><span class="line">            mAllocatedSessions.put(sessionId, <span class="keyword">true</span>);</span><br><span class="line">            <span class="keyword">return</span> sessionId;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125; <span class="keyword">while</span> (n++ &lt; <span class="number">32</span>);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">throw</span> <span class="keyword">new</span> IllegalStateException(<span class="string">"Failed to allocate session ID"</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>PackageInstallerService 还有一个 SparseBooleanArray 成员变量：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/** All sessions allocated */</span></span><br><span class="line"><span class="meta">@GuardedBy</span>(<span class="string">"mSessions"</span>)</span><br><span class="line"><span class="keyword">private</span> <span class="keyword">final</span> SparseBooleanArray mAllocatedSessions = <span class="keyword">new</span> SparseBooleanArray();</span><br></pre></td></tr></table></figure>
<p>mAllocatedSessions 保存了所有的 Session 实例，包括正在处理和已经处理的（mSessions 和 mHistoricalSessions），下标为创建事务的 uid，值为 PackageInstallerSession 是对 Session 的封装！</p>
<h3 id="3-1-3-PackageInstallerS-buildStageDir"><a href="#3-1-3-PackageInstallerS-buildStageDir" class="headerlink" title="3.1.3 PackageInstallerS.buildStageDir"></a>3.1.3 PackageInstallerS.buildStageDir</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">private</span> File <span class="title">buildStageDir</span><span class="params">(String volumeUuid, <span class="keyword">int</span> sessionId, <span class="keyword">boolean</span> isEphemeral)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">final</span> File stagingDir = buildStagingDir(volumeUuid, isEphemeral);</span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">new</span> File(stagingDir, <span class="string">"vmdl"</span> + sessionId + <span class="string">".tmp"</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>我们可以看到，在安装时，创建的临时文件目录是 /data/app/vmdl[sessionId].tmp！！</p>
<h4 id="3-1-3-1-PackageInstallerS-buildStagingDir"><a href="#3-1-3-1-PackageInstallerS-buildStagingDir" class="headerlink" title="3.1.3.1 PackageInstallerS.buildStagingDir"></a>3.1.3.1 PackageInstallerS.buildStagingDir</h4><p>buildStagingDir 用于返回文件根目录！</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">private</span> File <span class="title">buildStagingDir</span><span class="params">(String volumeUuid, <span class="keyword">boolean</span> isEphemeral)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">if</span> (isEphemeral) &#123;</span><br><span class="line">        <span class="comment">// 如果显示指定了 ephemeral 参数的话，返回的是 /data/app-ephemeral 目录！</span></span><br><span class="line">        <span class="keyword">return</span> Environment.getDataAppEphemeralDirectory(volumeUuid);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">//【1】默认情况，返回的是 /data/app 目录！</span></span><br><span class="line">    <span class="keyword">return</span> Environment.getDataAppDirectory(volumeUuid);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h3 id="3-1-4-new-PackageInstallerSession-事务实例"><a href="#3-1-4-new-PackageInstallerSession-事务实例" class="headerlink" title="3.1.4 new PackageInstallerSession - 事务实例"></a>3.1.4 new PackageInstallerSession - 事务实例</h3><p>创建 PackageInstallerSession，对前面的 SessionParams 再次封装！</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">PackageInstallerSession</span> <span class="keyword">extends</span> <span class="title">IPackageInstallerSession</span>.<span class="title">Stub</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="title">PackageInstallerSession</span><span class="params">(PackageInstallerService.InternalCallback callback,</span></span></span><br><span class="line"><span class="function"><span class="params">            Context context, PackageManagerService pm, Looper looper, <span class="keyword">int</span> sessionId, <span class="keyword">int</span> userId,</span></span></span><br><span class="line"><span class="function"><span class="params">            String installerPackageName, <span class="keyword">int</span> installerUid, SessionParams params, <span class="keyword">long</span> createdMillis,</span></span></span><br><span class="line"><span class="function"><span class="params">            File stageDir, String stageCid, <span class="keyword">boolean</span> prepared, <span class="keyword">boolean</span> sealed)</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">        <span class="comment">//【×3.1.4.1】InternalCallback 回调！</span></span><br><span class="line">        mCallback = callback;</span><br><span class="line">        mContext = context;</span><br><span class="line">        mPm = pm;</span><br><span class="line">        <span class="comment">//【2】创建 Handler 绑定到子线程 mInstallThread，该子线程是在 PackageInstallerService 构造器中创建的！</span></span><br><span class="line">        <span class="comment">//【*4.2】这里通过 mHandlerCallback 指定了一个回调函数！</span></span><br><span class="line">        mHandler = <span class="keyword">new</span> Handler(looper, mHandlerCallback);</span><br><span class="line">        <span class="comment">//【3】基本属性保存</span></span><br><span class="line">        <span class="keyword">this</span>.sessionId = sessionId;</span><br><span class="line">        <span class="keyword">this</span>.userId = userId;</span><br><span class="line">        <span class="keyword">this</span>.installerPackageName = installerPackageName;</span><br><span class="line">        <span class="keyword">this</span>.installerUid = installerUid;</span><br><span class="line">        <span class="keyword">this</span>.params = params;</span><br><span class="line">        <span class="keyword">this</span>.createdMillis = createdMillis;</span><br><span class="line">        <span class="keyword">this</span>.stageDir = stageDir; <span class="comment">// 内置临时目录：/data/app/vmdl[sessionId].tmp；</span></span><br><span class="line">        <span class="keyword">this</span>.stageCid = stageCid; <span class="comment">// 默认为 null；</span></span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> ((stageDir == <span class="keyword">null</span>) == (stageCid == <span class="keyword">null</span>)) &#123;</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> IllegalArgumentException(</span><br><span class="line">                    <span class="string">"Exactly one of stageDir or stageCid stage must be set"</span>);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        mPrepared = prepared; <span class="comment">// 传入 false；</span></span><br><span class="line">        mSealed = sealed; <span class="comment">// 传入 false；</span></span><br><span class="line"></span><br><span class="line">        <span class="comment">//【4】获得 DevicePolicyManager 对象，用于静默安装相关的判断，如果是安装者是设备拥有者，</span></span><br><span class="line">        <span class="comment">// 可以不检查权限，直接静默安装！</span></span><br><span class="line">        DevicePolicyManager dpm = (DevicePolicyManager) mContext.getSystemService(</span><br><span class="line">                Context.DEVICE_POLICY_SERVICE);</span><br><span class="line">        <span class="comment">//【5】校验安装者 uid 是否有 INSTALL_PACKAGES 权限！</span></span><br><span class="line">        <span class="keyword">final</span> <span class="keyword">boolean</span> isPermissionGranted =</span><br><span class="line">                (mPm.checkUidPermission(android.Manifest.permission.INSTALL_PACKAGES, installerUid)</span><br><span class="line">                        == PackageManager.PERMISSION_GRANTED);</span><br><span class="line">        <span class="comment">//【6】安装者是否是 root 用户！</span></span><br><span class="line">        <span class="keyword">final</span> <span class="keyword">boolean</span> isInstallerRoot = (installerUid == Process.ROOT_UID);</span><br><span class="line">        <span class="comment">//【7】是否强制提醒！</span></span><br><span class="line">        <span class="keyword">final</span> <span class="keyword">boolean</span> forcePermissionPrompt =</span><br><span class="line">                (params.installFlags &amp; PackageManager.INSTALL_FORCE_PERMISSION_PROMPT) != <span class="number">0</span>;</span><br><span class="line">        <span class="comment">//【8】安装者是否是设备拥有者自身！</span></span><br><span class="line">        mIsInstallerDeviceOwner = (dpm != <span class="keyword">null</span>) &amp;&amp; dpm.isDeviceOwnerAppOnCallingUser(</span><br><span class="line">                installerPackageName);</span><br><span class="line">                </span><br><span class="line">        <span class="comment">//【8】如果 mPermissionsAccepted 为 true，那么我们就可以静默安装！</span></span><br><span class="line">        <span class="keyword">if</span> ((isPermissionGranted</span><br><span class="line">                        || isInstallerRoot</span><br><span class="line">                        || mIsInstallerDeviceOwner)</span><br><span class="line">                &amp;&amp; !forcePermissionPrompt) &#123;</span><br><span class="line">            mPermissionsAccepted = <span class="keyword">true</span>;</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            mPermissionsAccepted = <span class="keyword">false</span>;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">final</span> <span class="keyword">long</span> identity = Binder.clearCallingIdentity();</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            <span class="comment">//【1】获得 container 的 uid 和 gid！</span></span><br><span class="line">            <span class="keyword">final</span> <span class="keyword">int</span> uid = mPm.getPackageUid(PackageManagerService.DEFAULT_CONTAINER_PACKAGE,</span><br><span class="line">                    PackageManager.MATCH_SYSTEM_ONLY, UserHandle.USER_SYSTEM);</span><br><span class="line">            defaultContainerGid = UserHandle.getSharedAppGid(uid);</span><br><span class="line">        &#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">            Binder.restoreCallingIdentity(identity);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure>
<p>可以看到 PackageInstallerSession 除了用来表示一个 Session 之外，由于继承了 IPackageInstallerSession.Stub，因此其还可以作为服务端的桩对象，进行跨进程的通信！</p>
<p>这里的 DEFAULT_CONTAINER_PACKAGE 是一个字符串常量：<br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">static</span> <span class="keyword">final</span> String DEFAULT_CONTAINER_PACKAGE = <span class="string">"com.android.defcontainer"</span>;</span><br></pre></td></tr></table></figure></p>
<h4 id="3-1-4-1-new-InternalCallback"><a href="#3-1-4-1-new-InternalCallback" class="headerlink" title="3.1.4.1 new InternalCallback"></a>3.1.4.1 new InternalCallback</h4><p>在创建 PackageInstallerSession 时，我们传入了一个回调对象 InternalCallback：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">private</span> <span class="keyword">final</span> InternalCallback mInternalCallback = <span class="keyword">new</span> InternalCallback();</span><br></pre></td></tr></table></figure>
<p>InternalCallback 类定义在 PackageInstallerService 中：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">InternalCallback</span> </span>&#123;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onSessionBadgingChanged</span><span class="params">(PackageInstallerSession session)</span> </span>&#123;</span><br><span class="line">        mCallbacks.notifySessionBadgingChanged(session.sessionId, session.userId);</span><br><span class="line">        <span class="comment">//【*3.1.6】更新持久化文件</span></span><br><span class="line">        writeSessionsAsync();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//【1】当 Session 的活跃状态发生变化时，回调触发！</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onSessionActiveChanged</span><span class="params">(PackageInstallerSession session, <span class="keyword">boolean</span> active)</span> </span>&#123;</span><br><span class="line">        mCallbacks.notifySessionActiveChanged(session.sessionId, session.userId, active);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">//【2】当 Session 的进度发生了变化，会触发该方法！</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onSessionProgressChanged</span><span class="params">(PackageInstallerSession session, <span class="keyword">float</span> progress)</span> </span>&#123;</span><br><span class="line">        mCallbacks.notifySessionProgressChanged(session.sessionId, session.userId, progress);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">//【3】当 Session 完成后，会触发该方法！</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onSessionFinished</span><span class="params">(<span class="keyword">final</span> PackageInstallerSession session, <span class="keyword">boolean</span> success)</span> </span>&#123;</span><br><span class="line">        mCallbacks.notifySessionFinished(session.sessionId, session.userId, success);</span><br><span class="line"></span><br><span class="line">        mInstallHandler.post(<span class="keyword">new</span> Runnable() &#123;</span><br><span class="line">            <span class="meta">@Override</span></span><br><span class="line">            <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">run</span><span class="params">()</span> </span>&#123;</span><br><span class="line">                <span class="keyword">synchronized</span> (mSessions) &#123;</span><br><span class="line">                    mSessions.remove(session.sessionId);</span><br><span class="line">                    mHistoricalSessions.put(session.sessionId, session);</span><br><span class="line"></span><br><span class="line">                    <span class="keyword">final</span> File appIconFile = buildAppIconFile(session.sessionId);</span><br><span class="line">                    <span class="keyword">if</span> (appIconFile.exists()) &#123;</span><br><span class="line">                        appIconFile.delete();</span><br><span class="line">                    &#125;</span><br><span class="line">                    <span class="comment">//【*3.1.6.1】更新持久化文件</span></span><br><span class="line">                    writeSessionsLocked();</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onSessionPrepared</span><span class="params">(PackageInstallerSession session)</span> </span>&#123;</span><br><span class="line">        <span class="comment">//【*3.1.6】更新持久化文件</span></span><br><span class="line">        writeSessionsAsync();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onSessionSealedBlocking</span><span class="params">(PackageInstallerSession session)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">synchronized</span> (mSessions) &#123;</span><br><span class="line">            <span class="comment">//【*3.1.6.1】更新持久化文件</span></span><br><span class="line">            writeSessionsLocked();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>可以看到，当 Session 的状态发生变化后，InternalCallback 回调会触发！</p>
<p>同时会回调 mCallbacks 的一些接口，而 mCallbacks 是在 PackageInstallerService 中创建的：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="title">PackageInstallerService</span><span class="params">(Context context, PackageManagerService pm)</span> </span>&#123;</span><br><span class="line">    ... ... ...</span><br><span class="line">    <span class="comment">//【*3.1.4.1.1】初始化 Callbacks！</span></span><br><span class="line">    mCallbacks = <span class="keyword">new</span> Callbacks(mInstallThread.getLooper());</span><br><span class="line">    ... ... ...</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>我们来看下 Callbacks 的逻辑！</p>
<h5 id="3-1-4-1-1-new-Callbacks"><a href="#3-1-4-1-1-new-Callbacks" class="headerlink" title="3.1.4.1.1 new Callbacks"></a>3.1.4.1.1 new Callbacks</h5><p>Callbacks 是 Handler 的子类，持有子线程 mInstallThread 的 looper，Callbacks 是在</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">private</span> <span class="keyword">static</span> <span class="class"><span class="keyword">class</span> <span class="title">Callbacks</span> <span class="keyword">extends</span> <span class="title">Handler</span> </span>&#123;</span><br><span class="line"> <span class="keyword">private</span> <span class="keyword">static</span> <span class="class"><span class="keyword">class</span> <span class="title">Callbacks</span> <span class="keyword">extends</span> <span class="title">Handler</span> </span>&#123;</span><br><span class="line">     <span class="comment">//【1】内部会处理的消息！</span></span><br><span class="line">     <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="keyword">int</span> MSG_SESSION_CREATED = <span class="number">1</span>;</span><br><span class="line">     <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="keyword">int</span> MSG_SESSION_BADGING_CHANGED = <span class="number">2</span>;</span><br><span class="line">     <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="keyword">int</span> MSG_SESSION_ACTIVE_CHANGED = <span class="number">3</span>;</span><br><span class="line">     <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="keyword">int</span> MSG_SESSION_PROGRESS_CHANGED = <span class="number">4</span>;</span><br><span class="line">     <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="keyword">int</span> MSG_SESSION_FINISHED = <span class="number">5</span>;</span><br><span class="line"></span><br><span class="line">     <span class="comment">//【2】监听安装状态的观察者 list</span></span><br><span class="line">     <span class="keyword">private</span> <span class="keyword">final</span> RemoteCallbackList&lt;IPackageInstallerCallback&gt;</span><br><span class="line">             mCallbacks = <span class="keyword">new</span> RemoteCallbackList&lt;&gt;();</span><br><span class="line"></span><br><span class="line">     <span class="function"><span class="keyword">public</span> <span class="title">Callbacks</span><span class="params">(Looper looper)</span> </span>&#123;</span><br><span class="line">         <span class="keyword">super</span>(looper);</span><br><span class="line">     &#125;</span><br></pre></td></tr></table></figure>
<p>Callbacks 内部有一个 list，保存了所有监听 Session 状态变化的观察者，同时提供了 register 接口，动态注册观察者！<br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">register</span><span class="params">(IPackageInstallerCallback callback, <span class="keyword">int</span> userId)</span> </span>&#123;</span><br><span class="line">    mCallbacks.register(callback, <span class="keyword">new</span> UserHandle(userId));</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">unregister</span><span class="params">(IPackageInstallerCallback callback)</span> </span>&#123;</span><br><span class="line">    mCallbacks.unregister(callback);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>Callbacks 内部有如下的 notify 接口，来通知 Session 的状态变化！</p>
<h5 id="3-1-4-1-2-Callbacks-notifySessionXXXX"><a href="#3-1-4-1-2-Callbacks-notifySessionXXXX" class="headerlink" title="3.1.4.1.2 Callbacks.notifySessionXXXX"></a>3.1.4.1.2 Callbacks.notifySessionXXXX</h5><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line">    <span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">notifySessionCreated</span><span class="params">(<span class="keyword">int</span> sessionId, <span class="keyword">int</span> userId)</span> </span>&#123;</span><br><span class="line">        obtainMessage(MSG_SESSION_CREATED, sessionId, userId).sendToTarget();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">notifySessionBadgingChanged</span><span class="params">(<span class="keyword">int</span> sessionId, <span class="keyword">int</span> userId)</span> </span>&#123;</span><br><span class="line">        obtainMessage(MSG_SESSION_BADGING_CHANGED, sessionId, userId).sendToTarget();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">notifySessionActiveChanged</span><span class="params">(<span class="keyword">int</span> sessionId, <span class="keyword">int</span> userId, <span class="keyword">boolean</span> active)</span> </span>&#123;</span><br><span class="line">        obtainMessage(MSG_SESSION_ACTIVE_CHANGED, sessionId, userId, active).sendToTarget();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">notifySessionProgressChanged</span><span class="params">(<span class="keyword">int</span> sessionId, <span class="keyword">int</span> userId, <span class="keyword">float</span> progress)</span> </span>&#123;</span><br><span class="line">        obtainMessage(MSG_SESSION_PROGRESS_CHANGED, sessionId, userId, progress).sendToTarget();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">notifySessionFinished</span><span class="params">(<span class="keyword">int</span> sessionId, <span class="keyword">int</span> userId, <span class="keyword">boolean</span> success)</span> </span>&#123;</span><br><span class="line">        obtainMessage(MSG_SESSION_FINISHED, sessionId, userId, success).sendToTarget();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>本质上是发送不同的 msg，下面来看看：</p>
<h5 id="3-1-4-1-3-Callbacks-handleMessage"><a href="#3-1-4-1-3-Callbacks-handleMessage" class="headerlink" title="3.1.4.1.3 Callbacks.handleMessage"></a>3.1.4.1.3 Callbacks.handleMessage</h5><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">handleMessage</span><span class="params">(Message msg)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">final</span> <span class="keyword">int</span> userId = msg.arg2;</span><br><span class="line">    <span class="keyword">final</span> <span class="keyword">int</span> n = mCallbacks.beginBroadcast();</span><br><span class="line">    <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; n; i++) &#123;</span><br><span class="line">        <span class="comment">//【1】遍历所有的观察者</span></span><br><span class="line">        <span class="keyword">final</span> IPackageInstallerCallback callback = mCallbacks.getBroadcastItem(i);</span><br><span class="line">        <span class="keyword">final</span> UserHandle user = (UserHandle) mCallbacks.getBroadcastCookie(i);</span><br><span class="line">        <span class="comment">// <span class="doctag">TODO:</span> dispatch notifications for slave profiles</span></span><br><span class="line">        <span class="keyword">if</span> (userId == user.getIdentifier()) &#123;</span><br><span class="line">            <span class="keyword">try</span> &#123;</span><br><span class="line">                <span class="comment">//【*3.1.4.1.3】分发 Session 消息给观察者！</span></span><br><span class="line">                invokeCallback(callback, msg);</span><br><span class="line">            &#125; <span class="keyword">catch</span> (RemoteException ignored) &#123;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    mCallbacks.finishBroadcast();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>最后调用了 invokeCallback，其实可以看到 IPackageInstallerCallback 针对于不同的消息也有不同的接口：</p>
<h5 id="3-1-4-1-4-Callbacks-invokeCallback"><a href="#3-1-4-1-4-Callbacks-invokeCallback" class="headerlink" title="3.1.4.1.4 Callbacks.invokeCallback"></a>3.1.4.1.4 Callbacks.invokeCallback</h5><p>继续分析：<br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">invokeCallback</span><span class="params">(IPackageInstallerCallback callback, Message msg)</span></span></span><br><span class="line"><span class="function">        <span class="keyword">throws</span> RemoteException </span>&#123;</span><br><span class="line">    <span class="keyword">final</span> <span class="keyword">int</span> sessionId = msg.arg1;</span><br><span class="line">    <span class="keyword">switch</span> (msg.what) &#123;</span><br><span class="line">        <span class="keyword">case</span> MSG_SESSION_CREATED:</span><br><span class="line">            callback.onSessionCreated(sessionId);</span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line">        <span class="keyword">case</span> MSG_SESSION_BADGING_CHANGED:</span><br><span class="line">            callback.onSessionBadgingChanged(sessionId);</span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line">        <span class="keyword">case</span> MSG_SESSION_ACTIVE_CHANGED:</span><br><span class="line">            callback.onSessionActiveChanged(sessionId, (<span class="keyword">boolean</span>) msg.obj);</span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line">        <span class="keyword">case</span> MSG_SESSION_PROGRESS_CHANGED:</span><br><span class="line">            callback.onSessionProgressChanged(sessionId, (<span class="keyword">float</span>) msg.obj);</span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line">        <span class="keyword">case</span> MSG_SESSION_FINISHED:</span><br><span class="line">            callback.onSessionFinished(sessionId, (<span class="keyword">boolean</span>) msg.obj);</span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>这里我们先分析到这里！</p>
<h3 id="3-1-6-PackageInstallerS-writeSessionsAsync-持久化事务"><a href="#3-1-6-PackageInstallerS-writeSessionsAsync-持久化事务" class="headerlink" title="3.1.6 PackageInstallerS.writeSessionsAsync - 持久化事务"></a>3.1.6 PackageInstallerS.writeSessionsAsync - 持久化事务</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">writeSessionsAsync</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    IoThread.getHandler().post(<span class="keyword">new</span> Runnable() &#123;</span><br><span class="line">        <span class="meta">@Override</span></span><br><span class="line">        <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">run</span><span class="params">()</span> </span>&#123;</span><br><span class="line">            <span class="keyword">synchronized</span> (mSessions) &#123;</span><br><span class="line">                <span class="comment">//【*3.1.6.1】将事务记录到 mSessionsFile 文件中！</span></span><br><span class="line">                writeSessionsLocked();</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h4 id="3-1-6-1-PackageInstallerS-writeSessionsLocked"><a href="#3-1-6-1-PackageInstallerS-writeSessionsLocked" class="headerlink" title="3.1.6.1 PackageInstallerS.writeSessionsLocked"></a>3.1.6.1 PackageInstallerS.writeSessionsLocked</h4><p>mSessionsFile 在 PackageInstallerService 构造器中有见过：/data/system/install_sessions.xml！！<br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">writeSessionsLocked</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    <span class="keyword">if</span> (LOGD) Slog.v(TAG, <span class="string">"writeSessionsLocked()"</span>);</span><br><span class="line"></span><br><span class="line">    FileOutputStream fos = <span class="keyword">null</span>;</span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">        fos = mSessionsFile.startWrite();</span><br><span class="line"></span><br><span class="line">        XmlSerializer out = <span class="keyword">new</span> FastXmlSerializer();</span><br><span class="line">        out.setOutput(fos, StandardCharsets.UTF_8.name());</span><br><span class="line">        out.startDocument(<span class="keyword">null</span>, <span class="keyword">true</span>);</span><br><span class="line">        out.startTag(<span class="keyword">null</span>, TAG_SESSIONS); <span class="comment">//【1】写入 sessions 标签！</span></span><br><span class="line">        <span class="keyword">final</span> <span class="keyword">int</span> size = mSessions.size();</span><br><span class="line">        <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; size; i++) &#123;</span><br><span class="line">            <span class="keyword">final</span> PackageInstallerSession session = mSessions.valueAt(i);</span><br><span class="line">            <span class="comment">//【*3.1.6.2】写入所有的 Sessions！！</span></span><br><span class="line">            writeSessionLocked(out, session);</span><br><span class="line">        &#125;</span><br><span class="line">        out.endTag(<span class="keyword">null</span>, TAG_SESSIONS);</span><br><span class="line">        out.endDocument();</span><br><span class="line"></span><br><span class="line">        mSessionsFile.finishWrite(fos);</span><br><span class="line">    &#125; <span class="keyword">catch</span> (IOException e) &#123;</span><br><span class="line">        <span class="keyword">if</span> (fos != <span class="keyword">null</span>) &#123;</span><br><span class="line">            mSessionsFile.failWrite(fos);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<h4 id="3-1-6-2-PackageInstallerS-writeSessionLocked"><a href="#3-1-6-2-PackageInstallerS-writeSessionLocked" class="headerlink" title="3.1.6.2 PackageInstallerS.writeSessionLocked"></a>3.1.6.2 PackageInstallerS.writeSessionLocked</h4><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">writeSessionLocked</span><span class="params">(XmlSerializer out, PackageInstallerSession session)</span></span></span><br><span class="line"><span class="function">        <span class="keyword">throws</span> IOException </span>&#123;</span><br><span class="line">    <span class="keyword">final</span> SessionParams params = session.params;</span><br><span class="line"></span><br><span class="line">    out.startTag(<span class="keyword">null</span>, TAG_SESSION); <span class="comment">// 写入 session 标签</span></span><br><span class="line"></span><br><span class="line">    writeIntAttribute(out, ATTR_SESSION_ID, session.sessionId); <span class="comment">// 写入 sessionId 属性</span></span><br><span class="line">    writeIntAttribute(out, ATTR_USER_ID, session.userId); <span class="comment">// 写入 userId 属性</span></span><br><span class="line">    writeStringAttribute(out, ATTR_INSTALLER_PACKAGE_NAME, <span class="comment">// 写入 installerPackageName 属性</span></span><br><span class="line">            session.installerPackageName);</span><br><span class="line">    writeIntAttribute(out, ATTR_INSTALLER_UID, session.installerUid); <span class="comment">// 写入 installerUid 属性</span></span><br><span class="line">    writeLongAttribute(out, ATTR_CREATED_MILLIS, session.createdMillis);  <span class="comment">// 写入 createdMillis 属性</span></span><br><span class="line">    <span class="keyword">if</span> (session.stageDir != <span class="keyword">null</span>) &#123;</span><br><span class="line">        writeStringAttribute(out, ATTR_SESSION_STAGE_DIR, <span class="comment">// 写入 sessionStageDir 属性</span></span><br><span class="line">                session.stageDir.getAbsolutePath());</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span> (session.stageCid != <span class="keyword">null</span>) &#123;</span><br><span class="line">        writeStringAttribute(out, ATTR_SESSION_STAGE_CID, session.stageCid); <span class="comment">// 写入 sessionStageCid 属性</span></span><br><span class="line">    &#125;</span><br><span class="line">    writeBooleanAttribute(out, ATTR_PREPARED, session.isPrepared()); <span class="comment">// 写入 prepared 属性</span></span><br><span class="line">    writeBooleanAttribute(out, ATTR_SEALED, session.isSealed()); <span class="comment">// 写入 sealed 属性</span></span><br><span class="line"></span><br><span class="line">    writeIntAttribute(out, ATTR_MODE, params.mode); <span class="comment">// 写入 mode 子标签</span></span><br><span class="line">    writeIntAttribute(out, ATTR_INSTALL_FLAGS, params.installFlags); <span class="comment">// 写入 installFlags 属性</span></span><br><span class="line">    writeIntAttribute(out, ATTR_INSTALL_LOCATION, params.installLocation); <span class="comment">// 写入 installLocation 属性</span></span><br><span class="line">    writeLongAttribute(out, ATTR_SIZE_BYTES, params.sizeBytes); <span class="comment">// 写入 sizeBytes 属性</span></span><br><span class="line">    writeStringAttribute(out, ATTR_APP_PACKAGE_NAME, params.appPackageName); <span class="comment">// 写入 appPackageName 属性</span></span><br><span class="line">    writeStringAttribute(out, ATTR_APP_LABEL, params.appLabel); <span class="comment">// 写入 appLabel 属性</span></span><br><span class="line">    writeUriAttribute(out, ATTR_ORIGINATING_URI, params.originatingUri); <span class="comment">// 写入 originatingUri 属性</span></span><br><span class="line">    writeIntAttribute(out, ATTR_ORIGINATING_UID, params.originatingUid); <span class="comment">// 写入 originatingUid 属性</span></span><br><span class="line">    writeUriAttribute(out, ATTR_REFERRER_URI, params.referrerUri); <span class="comment">// 写入 referrerUri 属性</span></span><br><span class="line">    writeStringAttribute(out, ATTR_ABI_OVERRIDE, params.abiOverride); <span class="comment">// 写入 abiOverride 属性</span></span><br><span class="line">    writeStringAttribute(out, ATTR_VOLUME_UUID, params.volumeUuid); <span class="comment">// 写入 volumeUuid 属性</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">// Persist app icon if changed since last written</span></span><br><span class="line">    <span class="keyword">final</span> File appIconFile = buildAppIconFile(session.sessionId);</span><br><span class="line">    <span class="keyword">if</span> (params.appIcon == <span class="keyword">null</span> &amp;&amp; appIconFile.exists()) &#123;</span><br><span class="line">        appIconFile.delete();</span><br><span class="line">    &#125; <span class="keyword">else</span> <span class="keyword">if</span> (params.appIcon != <span class="keyword">null</span></span><br><span class="line">            &amp;&amp; appIconFile.lastModified() != params.appIconLastModified) &#123;</span><br><span class="line">        <span class="keyword">if</span> (LOGD) Slog.w(TAG, <span class="string">"Writing changed icon "</span> + appIconFile);</span><br><span class="line">        FileOutputStream os = <span class="keyword">null</span>;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            os = <span class="keyword">new</span> FileOutputStream(appIconFile);</span><br><span class="line">            params.appIcon.compress(CompressFormat.PNG, <span class="number">90</span>, os);</span><br><span class="line">        &#125; <span class="keyword">catch</span> (IOException e) &#123;</span><br><span class="line">            Slog.w(TAG, <span class="string">"Failed to write icon "</span> + appIconFile + <span class="string">": "</span> + e.getMessage());</span><br><span class="line">        &#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">            IoUtils.closeQuietly(os);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        params.appIconLastModified = appIconFile.lastModified();</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">//【*3.1.6.3】将要在安装时授予的运行时权限集合写入到持久化文件中！</span></span><br><span class="line">    writeGrantedRuntimePermissions(out, params.grantedRuntimePermissions);</span><br><span class="line"></span><br><span class="line">    out.endTag(<span class="keyword">null</span>, TAG_SESSION);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h4 id="3-1-6-3-PackageInstallerS-writeGrantedRuntimePermissions"><a href="#3-1-6-3-PackageInstallerS-writeGrantedRuntimePermissions" class="headerlink" title="3.1.6.3 PackageInstallerS.writeGrantedRuntimePermissions"></a>3.1.6.3 PackageInstallerS.writeGrantedRuntimePermissions</h4><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">writeGrantedRuntimePermissions</span><span class="params">(XmlSerializer out,</span></span></span><br><span class="line"><span class="function"><span class="params">        String[] grantedRuntimePermissions)</span> <span class="keyword">throws</span> IOException </span>&#123;</span><br><span class="line">    <span class="keyword">if</span> (grantedRuntimePermissions != <span class="keyword">null</span>) &#123;</span><br><span class="line">        <span class="keyword">for</span> (String permission : grantedRuntimePermissions) &#123;</span><br><span class="line">            out.startTag(<span class="keyword">null</span>, TAG_GRANTED_RUNTIME_PERMISSION); <span class="comment">// 写入 granted-runtime-permission 子标签</span></span><br><span class="line">            writeStringAttribute(out, ATTR_NAME, permission); <span class="comment">// 写入 name 属性！</span></span><br><span class="line">            out.endTag(<span class="keyword">null</span>, TAG_GRANTED_RUNTIME_PERMISSION);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h2 id="3-2-PackageInstallerS-openSession-获得事务"><a href="#3-2-PackageInstallerS-openSession-获得事务" class="headerlink" title="3.2 PackageInstallerS.openSession - 获得事务"></a>3.2 PackageInstallerS.openSession - 获得事务</h2><p>openSession 方法可以获得 id 对应的 PackageInstallerSession！</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> IPackageInstallerSession <span class="title">openSession</span><span class="params">(<span class="keyword">int</span> sessionId)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">        <span class="comment">//【*3.2.1】调用另外一个方法！</span></span><br><span class="line">        <span class="keyword">return</span> openSessionInternal(sessionId);</span><br><span class="line">    &#125; <span class="keyword">catch</span> (IOException e) &#123;</span><br><span class="line">        <span class="keyword">throw</span> ExceptionUtils.wrap(e);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h3 id="3-2-1-PackageInstallerS-openSessionInternal"><a href="#3-2-1-PackageInstallerS-openSessionInternal" class="headerlink" title="3.2.1 PackageInstallerS.openSessionInternal"></a>3.2.1 PackageInstallerS.openSessionInternal</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">private</span> IPackageInstallerSession <span class="title">openSessionInternal</span><span class="params">(<span class="keyword">int</span> sessionId)</span> <span class="keyword">throws</span> IOException </span>&#123;</span><br><span class="line">    <span class="keyword">synchronized</span> (mSessions) &#123;</span><br><span class="line">        <span class="keyword">final</span> PackageInstallerSession session = mSessions.get(sessionId);</span><br><span class="line">        <span class="comment">//【*3.2.2】判断 uid 是否被允许获得该事务！</span></span><br><span class="line">        <span class="keyword">if</span> (session == <span class="keyword">null</span> || !isCallingUidOwner(session)) &#123;</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> SecurityException(<span class="string">"Caller has no access to session "</span> + sessionId);</span><br><span class="line">        &#125;</span><br><span class="line">        session.open();</span><br><span class="line">        <span class="keyword">return</span> session;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h3 id="3-2-2-PackageInstallerS-isCallingUidOwner"><a href="#3-2-2-PackageInstallerS-isCallingUidOwner" class="headerlink" title="3.2.2 PackageInstallerS.isCallingUidOwner"></a>3.2.2 PackageInstallerS.isCallingUidOwner</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">boolean</span> <span class="title">isCallingUidOwner</span><span class="params">(PackageInstallerSession session)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">final</span> <span class="keyword">int</span> callingUid = Binder.getCallingUid();</span><br><span class="line">    <span class="keyword">if</span> (callingUid == Process.ROOT_UID) &#123;</span><br><span class="line">        <span class="comment">//【1】要么是 root 用户！</span></span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">true</span>;</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        <span class="comment">//【2】要么调用者的 uid 必须是事务的创建者 uid！</span></span><br><span class="line">        <span class="keyword">return</span> (session != <span class="keyword">null</span>) &amp;&amp; (callingUid == session.installerUid);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h2 id="3-3-PackageInstallerS-getSessionInfo-获得事务"><a href="#3-3-PackageInstallerS-getSessionInfo-获得事务" class="headerlink" title="3.3 PackageInstallerS.getSessionInfo - 获得事务"></a>3.3 PackageInstallerS.getSessionInfo - 获得事务</h2><p>getSessionInfo 方法也是获得 id 对应的 Session 实例，但是封装的结果不同！</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> SessionInfo <span class="title">getSessionInfo</span><span class="params">(<span class="keyword">int</span> sessionId)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">synchronized</span> (mSessions) &#123;</span><br><span class="line">        <span class="keyword">final</span> PackageInstallerSession session = mSessions.get(sessionId);</span><br><span class="line">        <span class="comment">//【*3.3.1】调用 PackageInstallerSession 的 generateInfo 方法！</span></span><br><span class="line">        <span class="keyword">return</span> session != <span class="keyword">null</span> ? session.generateInfo() : <span class="keyword">null</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h3 id="3-3-1-PackageInstallerSession-generateInfo"><a href="#3-3-1-PackageInstallerSession-generateInfo" class="headerlink" title="3.3.1 PackageInstallerSession.generateInfo"></a>3.3.1 PackageInstallerSession.generateInfo</h3><p>PackageInstallerSession 会返回一个 SessionInfo 对象！用于保存 Session 的一些细节信息！</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> SessionInfo <span class="title">generateInfo</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    <span class="keyword">final</span> SessionInfo info = <span class="keyword">new</span> SessionInfo();</span><br><span class="line">    <span class="keyword">synchronized</span> (mLock) &#123;</span><br><span class="line">        info.sessionId = sessionId;</span><br><span class="line">        info.installerPackageName = installerPackageName;</span><br><span class="line">        info.resolvedBaseCodePath = (mResolvedBaseFile != <span class="keyword">null</span>) ?</span><br><span class="line">                mResolvedBaseFile.getAbsolutePath() : <span class="keyword">null</span>;</span><br><span class="line">        info.progress = mProgress;</span><br><span class="line">        info.sealed = mSealed;</span><br><span class="line">        info.active = mActiveCount.get() &gt; <span class="number">0</span>;</span><br><span class="line"></span><br><span class="line">        info.mode = params.mode;</span><br><span class="line">        info.sizeBytes = params.sizeBytes;</span><br><span class="line">        info.appPackageName = params.appPackageName;</span><br><span class="line">        info.appIcon = params.appIcon;</span><br><span class="line">        info.appLabel = params.appLabel;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> info;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h3 id="3-3-2-new-PackageInstaller-SessionInfo"><a href="#3-3-2-new-PackageInstaller-SessionInfo" class="headerlink" title="3.3.2 new PackageInstaller.SessionInfo"></a>3.3.2 new PackageInstaller.SessionInfo</h3><p>SessionInfo 定义在 PackageInstaller.java 中，用于保存 Session 的信息，这里我们简单的分析下！</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> <span class="class"><span class="keyword">class</span> <span class="title">SessionInfo</span> <span class="keyword">implements</span> <span class="title">Parcelable</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/** &#123;<span class="doctag">@hide</span>&#125; */</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">int</span> sessionId;</span><br><span class="line">    <span class="comment">/** &#123;<span class="doctag">@hide</span>&#125; */</span></span><br><span class="line">    <span class="keyword">public</span> String installerPackageName;</span><br><span class="line">    <span class="comment">/** &#123;<span class="doctag">@hide</span>&#125; */</span></span><br><span class="line">    <span class="keyword">public</span> String resolvedBaseCodePath;</span><br><span class="line">    <span class="comment">/** &#123;<span class="doctag">@hide</span>&#125; */</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">float</span> progress;</span><br><span class="line">    <span class="comment">/** &#123;<span class="doctag">@hide</span>&#125; */</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">boolean</span> sealed;</span><br><span class="line">    <span class="comment">/** &#123;<span class="doctag">@hide</span>&#125; */</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">boolean</span> active;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/** &#123;<span class="doctag">@hide</span>&#125; */</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">int</span> mode;</span><br><span class="line">    <span class="comment">/** &#123;<span class="doctag">@hide</span>&#125; */</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">long</span> sizeBytes;</span><br><span class="line">    <span class="comment">/** &#123;<span class="doctag">@hide</span>&#125; */</span></span><br><span class="line">    <span class="keyword">public</span> String appPackageName;</span><br><span class="line">    <span class="comment">/** &#123;<span class="doctag">@hide</span>&#125; */</span></span><br><span class="line">    <span class="keyword">public</span> Bitmap appIcon;</span><br><span class="line">    <span class="comment">/** &#123;<span class="doctag">@hide</span>&#125; */</span></span><br><span class="line">    <span class="keyword">public</span> CharSequence appLabel;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/** &#123;<span class="doctag">@hide</span>&#125; */</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="title">SessionInfo</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/** &#123;<span class="doctag">@hide</span>&#125; */</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="title">SessionInfo</span><span class="params">(Parcel source)</span> </span>&#123;</span><br><span class="line">        sessionId = source.readInt();</span><br><span class="line">        installerPackageName = source.readString();</span><br><span class="line">        resolvedBaseCodePath = source.readString();</span><br><span class="line">        progress = source.readFloat();</span><br><span class="line">        sealed = source.readInt() != <span class="number">0</span>;</span><br><span class="line">        active = source.readInt() != <span class="number">0</span>;</span><br><span class="line"></span><br><span class="line">        mode = source.readInt();</span><br><span class="line">        sizeBytes = source.readLong();</span><br><span class="line">        appPackageName = source.readString();</span><br><span class="line">        appIcon = source.readParcelable(<span class="keyword">null</span>);</span><br><span class="line">        appLabel = source.readString();</span><br><span class="line">    &#125;</span><br><span class="line">    ... ... ...</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h1 id="4-PackageInstallerSession"><a href="#4-PackageInstallerSession" class="headerlink" title="4 PackageInstallerSession"></a>4 PackageInstallerSession</h1><h2 id="4-1-openWrite"><a href="#4-1-openWrite" class="headerlink" title="4.1 openWrite"></a>4.1 openWrite</h2><p>这里的 name 传入的是 base.apk</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> ParcelFileDescriptor <span class="title">openWrite</span><span class="params">(String name, <span class="keyword">long</span> offsetBytes, <span class="keyword">long</span> lengthBytes)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">        <span class="comment">//【*4.1.1】继续调用 openWriteInternal 方法处理；</span></span><br><span class="line">        <span class="keyword">return</span> openWriteInternal(name, offsetBytes, lengthBytes);</span><br><span class="line">    &#125; <span class="keyword">catch</span> (IOException e) &#123;</span><br><span class="line">        <span class="keyword">throw</span> ExceptionUtils.wrap(e);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h3 id="4-1-1-openWriteInternal"><a href="#4-1-1-openWriteInternal" class="headerlink" title="4.1.1 openWriteInternal"></a>4.1.1 openWriteInternal</h3><p>继续来看，这里的参数 name 传入的是 “base.apk”</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">private</span> ParcelFileDescriptor <span class="title">openWriteInternal</span><span class="params">(String name, <span class="keyword">long</span> offsetBytes, <span class="keyword">long</span> lengthBytes)</span></span></span><br><span class="line"><span class="function">        <span class="keyword">throws</span> IOException </span>&#123;</span><br><span class="line">    <span class="keyword">final</span> FileBridge bridge;</span><br><span class="line">    <span class="keyword">synchronized</span> (mLock) &#123;</span><br><span class="line">        assertPreparedAndNotSealed(<span class="string">"openWrite"</span>);</span><br><span class="line"></span><br><span class="line">        bridge = <span class="keyword">new</span> FileBridge();</span><br><span class="line">        mBridges.add(bridge);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">        <span class="keyword">if</span> (!FileUtils.isValidExtFilename(name)) &#123;</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> IllegalArgumentException(<span class="string">"Invalid name: "</span> + name);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">final</span> File target;</span><br><span class="line">        <span class="keyword">final</span> <span class="keyword">long</span> identity = Binder.clearCallingIdentity();</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            <span class="comment">//【1】创建 /data/app/vmdl[sessionId].tmp/base.apk 对应的文件对象！</span></span><br><span class="line">            target = <span class="keyword">new</span> File(resolveStageDir(), name);</span><br><span class="line">        &#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">            Binder.restoreCallingIdentity(identity);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment">//【2】返回其文件描述符；</span></span><br><span class="line">        <span class="keyword">final</span> FileDescriptor targetFd = Libcore.os.open(target.getAbsolutePath(),</span><br><span class="line">                O_CREAT | O_WRONLY, <span class="number">0644</span>);</span><br><span class="line">        Os.chmod(target.getAbsolutePath(), <span class="number">0644</span>);</span><br><span class="line"></span><br><span class="line">        <span class="comment">//【3】如果指定了大小，那么这里会做一次空间回收！</span></span><br><span class="line">        <span class="keyword">if</span> (lengthBytes &gt; <span class="number">0</span>) &#123;</span><br><span class="line">            <span class="keyword">final</span> StructStat stat = Libcore.os.fstat(targetFd);</span><br><span class="line">            <span class="keyword">final</span> <span class="keyword">long</span> deltaBytes = lengthBytes - stat.st_size;</span><br><span class="line">            <span class="comment">//【3.1】回收空间；</span></span><br><span class="line">            <span class="keyword">if</span> (stageDir != <span class="keyword">null</span> &amp;&amp; deltaBytes &gt; <span class="number">0</span>) &#123;</span><br><span class="line">                mPm.freeStorage(params.volumeUuid, deltaBytes);</span><br><span class="line">            &#125;</span><br><span class="line">            Libcore.os.posix_fallocate(targetFd, <span class="number">0</span>, lengthBytes);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (offsetBytes &gt; <span class="number">0</span>) &#123;</span><br><span class="line">            Libcore.os.lseek(targetFd, offsetBytes, OsConstants.SEEK_SET);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">//【4】使用 FileBridge 封装文件描述符！</span></span><br><span class="line">        bridge.setTargetFile(targetFd);</span><br><span class="line">        bridge.start();</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> ParcelFileDescriptor(bridge.getClientSocket());</span><br><span class="line"></span><br><span class="line">    &#125; <span class="keyword">catch</span> (ErrnoException e) &#123;</span><br><span class="line">        <span class="keyword">throw</span> e.rethrowAsIOException();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>整个方法很简单，不多说了！</p>
<h2 id="4-2-commit-提交事务核心入口"><a href="#4-2-commit-提交事务核心入口" class="headerlink" title="4.2 commit - 提交事务核心入口"></a>4.2 commit - 提交事务核心入口</h2><p>在上面我们分析到，会进入 PackageInstallerSession.commit 提交事务。下面我们继续来分析！</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">commit</span><span class="params">(IntentSender statusReceiver)</span> </span>&#123;</span><br><span class="line">    Preconditions.checkNotNull(statusReceiver);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">final</span> <span class="keyword">boolean</span> wasSealed;</span><br><span class="line">    <span class="keyword">synchronized</span> (mLock) &#123;</span><br><span class="line">        wasSealed = mSealed;</span><br><span class="line">        <span class="keyword">if</span> (!mSealed) &#123;</span><br><span class="line">            <span class="comment">// 校验所有的写操作都已经完成了，正常情况下，是肯定完成了的！</span></span><br><span class="line">            <span class="keyword">for</span> (FileBridge bridge : mBridges) &#123;</span><br><span class="line">                <span class="keyword">if</span> (!bridge.isClosed()) &#123;</span><br><span class="line">                    <span class="keyword">throw</span> <span class="keyword">new</span> SecurityException(<span class="string">"Files still open"</span>);</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">            mSealed = <span class="keyword">true</span>;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment">//【1】由于此时文件已经拷贝完成，这里更新进度为完成！</span></span><br><span class="line">        mClientProgress = <span class="number">1f</span>;</span><br><span class="line">        </span><br><span class="line">        <span class="comment">//【*4.2.3.5】通知结果！</span></span><br><span class="line">        computeProgressLocked(<span class="keyword">true</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (!wasSealed) &#123;</span><br><span class="line">        <span class="comment">// Persist the fact that we've sealed ourselves to prevent</span></span><br><span class="line">        <span class="comment">// mutations of any hard links we create. We do this without holding</span></span><br><span class="line">        <span class="comment">// the session lock, since otherwise it's a lock inversion.</span></span><br><span class="line">        mCallback.onSessionSealedBlocking(<span class="keyword">this</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//【2】活跃计数 +1，表示该 Session 处于活跃状态；</span></span><br><span class="line">    mActiveCount.incrementAndGet();</span><br><span class="line"></span><br><span class="line">    <span class="comment">//【*4.2.1】创建了一个 PackageInstallObserverAdapter 实例！</span></span><br><span class="line">    <span class="comment">// 会将前面创建的 IntentSender 实例，作为参数传入！</span></span><br><span class="line">    <span class="keyword">final</span> PackageInstallObserverAdapter adapter = <span class="keyword">new</span> PackageInstallObserverAdapter(mContext,</span><br><span class="line">            statusReceiver, sessionId, mIsInstallerDeviceOwner, userId);</span><br><span class="line"></span><br><span class="line">    <span class="comment">//【*4.2.2】发送 MSG_COMMIT 消息</span></span><br><span class="line">    mHandler.obtainMessage(MSG_COMMIT, adapter.getBinder()).sendToTarget();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>mActiveCount 加 1，表示该事务处于活跃状态，直到安装完成！</p>
<p>这里的 PackageInstallObserverAdapter.getBinder() 返回是一个服务端 Stub 桩对象！</p>
<p>整个流程很清晰，我们继续看：</p>
<h3 id="4-2-1-new-PackageInstallObserverAdapter"><a href="#4-2-1-new-PackageInstallObserverAdapter" class="headerlink" title="4.2.1 new PackageInstallObserverAdapter"></a>4.2.1 new PackageInstallObserverAdapter</h3><p>PackageInstallObserverAdapter 定义在 PackageInstallService 中：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">static</span> <span class="class"><span class="keyword">class</span> <span class="title">PackageInstallObserverAdapter</span> <span class="keyword">extends</span> <span class="title">PackageInstallObserver</span> </span>&#123;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> Context mContext; <span class="comment">// 系统进程的上下文</span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> IntentSender mTarget; <span class="comment">// 前面创建的 IntentSender 实例</span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> <span class="keyword">int</span> mSessionId; <span class="comment">// 事务的 id！</span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> <span class="keyword">boolean</span> mShowNotification; <span class="comment">// 是否显示通知，取决于安装者是否是设备用户！</span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> <span class="keyword">int</span> mUserId;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="title">PackageInstallObserverAdapter</span><span class="params">(Context context, IntentSender target, <span class="keyword">int</span> sessionId,</span></span></span><br><span class="line"><span class="function"><span class="params">            <span class="keyword">boolean</span> showNotification, <span class="keyword">int</span> userId)</span> </span>&#123;</span><br><span class="line">        mContext = context;</span><br><span class="line">        mTarget = target;</span><br><span class="line">        mSessionId = sessionId;</span><br><span class="line">        mShowNotification = showNotification; </span><br><span class="line">        mUserId = userId;</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure>
<p>PackageInstallObserverAdapter 继承了 PackageInstallObserver：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">PackageInstallObserver</span> </span>&#123;</span><br><span class="line">    <span class="comment">//【1】服务端桩对象！</span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> IPackageInstallObserver2.Stub mBinder = <span class="keyword">new</span> IPackageInstallObserver2.Stub() &#123;</span><br><span class="line">        <span class="meta">@Override</span></span><br><span class="line">        <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onUserActionRequired</span><span class="params">(Intent intent)</span> </span>&#123;</span><br><span class="line">            <span class="comment">//【1.1】调用子类的 onUserActionRequired 方法！</span></span><br><span class="line">            PackageInstallObserver.<span class="keyword">this</span>.onUserActionRequired(intent);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="meta">@Override</span></span><br><span class="line">        <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onPackageInstalled</span><span class="params">(String basePackageName, <span class="keyword">int</span> returnCode,</span></span></span><br><span class="line"><span class="function"><span class="params">                String msg, Bundle extras)</span> </span>&#123;</span><br><span class="line">            <span class="comment">//【1.2】调用子类的 onPackageInstalled 方法！</span></span><br><span class="line">            PackageInstallObserver.<span class="keyword">this</span>.onPackageInstalled(basePackageName, returnCode, msg,</span><br><span class="line">                    extras);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/** &#123;<span class="doctag">@hide</span>&#125; */</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> IPackageInstallObserver2 <span class="title">getBinder</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="comment">//【2】用于返回服务端桩对象！</span></span><br><span class="line">        <span class="keyword">return</span> mBinder;</span><br><span class="line">    &#125;</span><br><span class="line">    ... ... ...</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>PackageInstallObserverAdapter 继承了 PackageInstallObserver，并覆写了以下两个方法：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">onUserActionRequired</span><br><span class="line">onPackageInstalled</span><br></pre></td></tr></table></figure>
<h4 id="4-2-1-1-PackageInstallObserverAdapter-onUserActionRequired"><a href="#4-2-1-1-PackageInstallObserverAdapter-onUserActionRequired" class="headerlink" title="4.2.1.1 PackageInstallObserverAdapter.onUserActionRequired"></a>4.2.1.1 PackageInstallObserverAdapter.onUserActionRequired</h4><p>覆写 onUserActionRequired，当安装过程需要用户参与授权时，会回调该接口，此时会中断安装，事务从 active 变为 idle 状态！</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onUserActionRequired</span><span class="params">(Intent intent)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">final</span> Intent fillIn = <span class="keyword">new</span> Intent();</span><br><span class="line">    <span class="comment">//【1】事务 id！</span></span><br><span class="line">    fillIn.putExtra(PackageInstaller.EXTRA_SESSION_ID, mSessionId);</span><br><span class="line">    <span class="comment">//【2】当前的状态：PackageInstaller.STATUS_PENDING_USER_ACTION！</span></span><br><span class="line">    fillIn.putExtra(PackageInstaller.EXTRA_STATUS,</span><br><span class="line">            PackageInstaller.STATUS_PENDING_USER_ACTION);</span><br><span class="line">    fillIn.putExtra(Intent.EXTRA_INTENT, intent); <span class="comment">// 额外的 intent</span></span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">        <span class="comment">//【*2.9.4.1】发送 intent，其实，这里我们知道，该 intent 会发送到前面的 LocalIntentReceiver!</span></span><br><span class="line">        mTarget.sendIntent(mContext, <span class="number">0</span>, fillIn, <span class="keyword">null</span>, <span class="keyword">null</span>);</span><br><span class="line">    &#125; <span class="keyword">catch</span> (SendIntentException ignored) &#123;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>关于这个额外的 Intent，我们后面会看到！</p>
<h4 id="4-1-1-2-PackageInstallObserverAdapter-onPackageInstalled"><a href="#4-1-1-2-PackageInstallObserverAdapter-onPackageInstalled" class="headerlink" title="4.1.1.2 PackageInstallObserverAdapter.onPackageInstalled"></a>4.1.1.2 PackageInstallObserverAdapter.onPackageInstalled</h4><p>覆写 onPackageInstalled，当安装完成后，会回调该接口！</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onPackageInstalled</span><span class="params">(String basePackageName, <span class="keyword">int</span> returnCode, String msg,</span></span></span><br><span class="line"><span class="function"><span class="params">        Bundle extras)</span> </span>&#123;</span><br><span class="line">    <span class="comment">//【1】当安装成功，并且需要弹出通知时，会在这里显示通知！</span></span><br><span class="line">    <span class="keyword">if</span> (PackageManager.INSTALL_SUCCEEDED == returnCode &amp;&amp; mShowNotification) &#123;</span><br><span class="line">        <span class="keyword">boolean</span> update = (extras != <span class="keyword">null</span>) &amp;&amp; extras.getBoolean(Intent.EXTRA_REPLACING);</span><br><span class="line">        Notification notification = buildSuccessNotification(mContext,</span><br><span class="line">                mContext.getResources()</span><br><span class="line">                        .getString(update ? R.string.package_updated_device_owner :</span><br><span class="line">                                R.string.package_installed_device_owner),</span><br><span class="line">                basePackageName,</span><br><span class="line">                mUserId);</span><br><span class="line">        <span class="keyword">if</span> (notification != <span class="keyword">null</span>) &#123;</span><br><span class="line">            NotificationManager notificationManager = (NotificationManager)</span><br><span class="line">                    mContext.getSystemService(Context.NOTIFICATION_SERVICE);</span><br><span class="line">            notificationManager.notify(basePackageName, <span class="number">0</span>, notification);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">//【2】创建一个 intent，保存了安装结果等信息！</span></span><br><span class="line">    <span class="keyword">final</span> Intent fillIn = <span class="keyword">new</span> Intent();</span><br><span class="line">    fillIn.putExtra(PackageInstaller.EXTRA_PACKAGE_NAME, basePackageName);</span><br><span class="line">    fillIn.putExtra(PackageInstaller.EXTRA_SESSION_ID, mSessionId);</span><br><span class="line">    fillIn.putExtra(PackageInstaller.EXTRA_STATUS,</span><br><span class="line">            PackageManager.installStatusToPublicStatus(returnCode));</span><br><span class="line">    fillIn.putExtra(PackageInstaller.EXTRA_STATUS_MESSAGE,</span><br><span class="line">            PackageManager.installStatusToString(returnCode, msg));</span><br><span class="line">    fillIn.putExtra(PackageInstaller.EXTRA_LEGACY_STATUS, returnCode);</span><br><span class="line">    <span class="keyword">if</span> (extras != <span class="keyword">null</span>) &#123;</span><br><span class="line">        <span class="keyword">final</span> String existing = extras.getString(</span><br><span class="line">                PackageManager.EXTRA_FAILURE_EXISTING_PACKAGE);</span><br><span class="line">        <span class="keyword">if</span> (!TextUtils.isEmpty(existing)) &#123;</span><br><span class="line">            fillIn.putExtra(PackageInstaller.EXTRA_OTHER_PACKAGE_NAME, existing);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">        <span class="comment">//【*2.9.4.1】发送 intent，其实，这里我们知道，该 intent 会发送到前面的 LocalIntentReceiver</span></span><br><span class="line">        mTarget.sendIntent(mContext, <span class="number">0</span>, fillIn, <span class="keyword">null</span>, <span class="keyword">null</span>);</span><br><span class="line">    &#125; <span class="keyword">catch</span> (SendIntentException ignored) &#123;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>我们继续分析！</p>
<h3 id="4-2-2-send-MSG-COMMIT"><a href="#4-2-2-send-MSG-COMMIT" class="headerlink" title="4.2.2 send MSG_COMMIT"></a>4.2.2 send MSG_COMMIT</h3><p>代码片段如下：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//【*4.2.2.1】发送 MSG_COMMIT 消息</span></span><br><span class="line">mHandler.obtainMessage(MSG_COMMIT, adapter.getBinder()).sendToTarget();</span><br></pre></td></tr></table></figure>
<p>mHandler 的初始化是在 PackageInstallerSession 的构造器中：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="title">PackageInstallerSession</span><span class="params">(PackageInstallerService.InternalCallback callback,</span></span></span><br><span class="line"><span class="function"><span class="params">        Context context, PackageManagerService pm, Looper looper, <span class="keyword">int</span> sessionId, <span class="keyword">int</span> userId,</span></span></span><br><span class="line"><span class="function"><span class="params">        String installerPackageName, <span class="keyword">int</span> installerUid, SessionParams params, <span class="keyword">long</span> createdMillis,</span></span></span><br><span class="line"><span class="function"><span class="params">        File stageDir, String stageCid, <span class="keyword">boolean</span> prepared, <span class="keyword">boolean</span> sealed)</span> </span>&#123;</span><br><span class="line">    mCallback = callback;</span><br><span class="line">    mContext = context;</span><br><span class="line">    mPm = pm;</span><br><span class="line">    <span class="comment">//【*4.2.1】handler 会处理该消息，我们看到，其传入了一个 mHandlerCallback 回调！</span></span><br><span class="line">    mHandler = <span class="keyword">new</span> Handler(looper, mHandlerCallback);</span><br><span class="line">    ... ... ...</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>如果我们直接发送 MSG_COMMIT 消息，回调 mHandlerCallback 会立刻触发：</p>
<h4 id="4-2-2-1-Handler-Callback-handleMessage-MSG-COMMIT"><a href="#4-2-2-1-Handler-Callback-handleMessage-MSG-COMMIT" class="headerlink" title="4.2.2.1 Handler.Callback.handleMessage[MSG_COMMIT]"></a>4.2.2.1 Handler.Callback.handleMessage[MSG_COMMIT]</h4><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">private</span> <span class="keyword">final</span> Handler.Callback mHandlerCallback = <span class="keyword">new</span> Handler.Callback() &#123;</span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">boolean</span> <span class="title">handleMessage</span><span class="params">(Message msg)</span> </span>&#123;</span><br><span class="line">        <span class="comment">//【1】获得要安装的应用的信息，如果是第一次安装的话，那么二者返回的均为 null！</span></span><br><span class="line">        <span class="keyword">final</span> PackageInfo pkgInfo = mPm.getPackageInfo(</span><br><span class="line">                params.appPackageName, PackageManager.GET_SIGNATURES <span class="comment">/*flags*/</span>, userId);</span><br><span class="line">        <span class="keyword">final</span> ApplicationInfo appInfo = mPm.getApplicationInfo(</span><br><span class="line">                params.appPackageName, <span class="number">0</span>, userId);</span><br><span class="line"></span><br><span class="line">        <span class="keyword">synchronized</span> (mLock) &#123;</span><br><span class="line">            <span class="keyword">if</span> (msg.obj != <span class="keyword">null</span>) &#123;</span><br><span class="line">                <span class="comment">//【2】获得前面 PackageInstallObserverAdapter 内部的 PackageInstallObserver2 桩对象！</span></span><br><span class="line">                <span class="comment">// 保存到了 mRemoteObserver 中！</span></span><br><span class="line">                mRemoteObserver = (IPackageInstallObserver2) msg.obj;</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            <span class="keyword">try</span> &#123;</span><br><span class="line">                <span class="comment">//【*4.2.3】调用 commitLocked 继续处理！</span></span><br><span class="line">                commitLocked(pkgInfo, appInfo);</span><br><span class="line"></span><br><span class="line">            &#125; <span class="keyword">catch</span> (PackageManagerException e) &#123;</span><br><span class="line">                <span class="keyword">final</span> String completeMsg = ExceptionUtils.getCompleteMessage(e);</span><br><span class="line">                Slog.e(TAG, <span class="string">"Commit of session "</span> + sessionId + <span class="string">" failed: "</span> + completeMsg);</span><br><span class="line">                destroyInternal();</span><br><span class="line">                dispatchSessionFinished(e.error, completeMsg, <span class="keyword">null</span>);</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            <span class="keyword">return</span> <span class="keyword">true</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>
<p>PackageInstallerSession 内部有一个 mRemoteObserver 成员变量，后面我们会见到：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@GuardedBy</span>(<span class="string">"mLock"</span>)</span><br><span class="line"><span class="keyword">private</span> IPackageInstallObserver2 mRemoteObserver;</span><br></pre></td></tr></table></figure>
<p>接下来，进入了 commitLocked 方法！</p>
<h3 id="4-2-3-commitLocked"><a href="#4-2-3-commitLocked" class="headerlink" title="4.2.3 commitLocked"></a>4.2.3 commitLocked</h3><p>继续来看：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">commitLocked</span><span class="params">(PackageInfo pkgInfo, ApplicationInfo appInfo)</span></span></span><br><span class="line"><span class="function">        <span class="keyword">throws</span> PackageManagerException </span>&#123;</span><br><span class="line">    <span class="keyword">if</span> (mDestroyed) &#123;</span><br><span class="line">        <span class="keyword">throw</span> <span class="keyword">new</span> PackageManagerException(INSTALL_FAILED_INTERNAL_ERROR, <span class="string">"Session destroyed"</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span> (!mSealed) &#123;</span><br><span class="line">        <span class="keyword">throw</span> <span class="keyword">new</span> PackageManagerException(INSTALL_FAILED_INTERNAL_ERROR, <span class="string">"Session not sealed"</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">        <span class="comment">//【*4.2.3.1】解析安装地址，即前文APK文件copy后的目的地址</span></span><br><span class="line">        resolveStageDir();</span><br><span class="line">    &#125; <span class="keyword">catch</span> (IOException e) &#123;</span><br><span class="line">        <span class="keyword">throw</span> <span class="keyword">new</span> PackageManagerException(INSTALL_FAILED_CONTAINER_ERROR,</span><br><span class="line">                <span class="string">"Failed to resolve stage location"</span>, e);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//【*4.2.3.2】校验安装有效性！</span></span><br><span class="line">    validateInstallLocked(pkgInfo, appInfo);</span><br><span class="line"></span><br><span class="line">    Preconditions.checkNotNull(mPackageName); <span class="comment">// 非 null 校验！</span></span><br><span class="line">    Preconditions.checkNotNull(mSignatures);</span><br><span class="line">    Preconditions.checkNotNull(mResolvedBaseFile);</span><br><span class="line"></span><br><span class="line">    <span class="comment">//【1】mPermissionsAccepted 为 true，那么用户就可以静默安装了，如果为 false，那么就需要用户确认权限！！</span></span><br><span class="line">    <span class="keyword">if</span> (!mPermissionsAccepted) &#123;</span><br><span class="line"></span><br><span class="line">        <span class="comment">//【1.1】这里会创建一个 intent， action 为 PackageInstaller.ACTION_CONFIRM_PERMISSIONS</span></span><br><span class="line">        <span class="comment">// 目标应用是 PackageInstaller，这里会先进入 packageinstaller 中确认权限信息！</span></span><br><span class="line">        <span class="keyword">final</span> Intent intent = <span class="keyword">new</span> Intent(PackageInstaller.ACTION_CONFIRM_PERMISSIONS);</span><br><span class="line">        intent.setPackage(mContext.getPackageManager().getPermissionControllerPackageName());</span><br><span class="line">        intent.putExtra(PackageInstaller.EXTRA_SESSION_ID, sessionId); <span class="comment">// 事务 id 也要从传递过去！</span></span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            <span class="comment">//【*4.2.1.1】回调了 PackageInstallObserverAdapter 的 onUserActionRequired 接口</span></span><br><span class="line">            <span class="comment">// 将 intent 传递过去！</span></span><br><span class="line">            mRemoteObserver.onUserActionRequired(intent);</span><br><span class="line">        &#125; <span class="keyword">catch</span> (RemoteException ignored) &#123;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment">//【*4.2.3.3】关闭该事务，使其从 active 变为 idle 状态！！</span></span><br><span class="line">        close();</span><br><span class="line">        <span class="comment">// 停止安装，等待用户确认权限，用户在 PackageInstaller 点击安装，安装会继续！！</span></span><br><span class="line">        <span class="keyword">return</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//【2】安装到外置时，计算最终安装大小！</span></span><br><span class="line">    <span class="keyword">if</span> (stageCid != <span class="keyword">null</span>) &#123;</span><br><span class="line">        <span class="comment">//【*4.2.3.4】计算大小</span></span><br><span class="line">        <span class="keyword">final</span> <span class="keyword">long</span> finalSize = calculateInstalledSize();</span><br><span class="line">        resizeContainer(stageCid, finalSize);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//【3】如果安装方式是继承已存在的 apk，那我们就要尝试基于已有的安装进行安装，这个一般用于安装和卸载 split apk！</span></span><br><span class="line">    <span class="keyword">if</span> (params.mode == SessionParams.MODE_INHERIT_EXISTING) &#123;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            <span class="keyword">final</span> List&lt;File&gt; fromFiles = mResolvedInheritedFiles;</span><br><span class="line">            <span class="keyword">final</span> File toDir = resolveStageDir(); <span class="comment">// 这是我们本次安装的目录</span></span><br><span class="line"></span><br><span class="line">            <span class="keyword">if</span> (LOGD) Slog.d(TAG, <span class="string">"Inherited files: "</span> + mResolvedInheritedFiles);</span><br><span class="line">            <span class="keyword">if</span> (!mResolvedInheritedFiles.isEmpty() &amp;&amp; mInheritedFilesBase == <span class="keyword">null</span>) &#123;</span><br><span class="line">                <span class="keyword">throw</span> <span class="keyword">new</span> IllegalStateException(<span class="string">"mInheritedFilesBase == null"</span>);</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="comment">//【3.1】如果可以直接建立 link 的话，不行的话，就 copy！</span></span><br><span class="line">            <span class="keyword">if</span> (isLinkPossible(fromFiles, toDir)) &#123;</span><br><span class="line">                <span class="keyword">if</span> (!mResolvedInstructionSets.isEmpty()) &#123;</span><br><span class="line">                    <span class="keyword">final</span> File oatDir = <span class="keyword">new</span> File(toDir, <span class="string">"oat"</span>);</span><br><span class="line">                    createOatDirs(mResolvedInstructionSets, oatDir);</span><br><span class="line">                &#125;</span><br><span class="line">                linkFiles(fromFiles, toDir, mInheritedFilesBase);</span><br><span class="line">            &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                <span class="comment">//【3.2】执行拷贝，其实是将已经存在的目录的 apk，oat 文件拷贝到了这个目录！</span></span><br><span class="line">                <span class="comment">// 对于要 remove 的文件，则会跳过拷贝！</span></span><br><span class="line">                copyFiles(fromFiles, toDir);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125; <span class="keyword">catch</span> (IOException e) &#123;</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> PackageManagerException(INSTALL_FAILED_INSUFFICIENT_STORAGE,</span><br><span class="line">                    <span class="string">"Failed to inherit existing install"</span>, e);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//【4】更新进度！</span></span><br><span class="line">    mInternalProgress = <span class="number">0.5f</span>;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">//【*4.2.3.5】通知结果！</span></span><br><span class="line">    computeProgressLocked(<span class="keyword">true</span>);</span><br><span class="line"></span><br><span class="line">    <span class="comment">//【*4.2.3.6】提取 lib 库文件到目录中！</span></span><br><span class="line">    extractNativeLibraries(mResolvedStageDir, params.abiOverride);</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 如果安装到外置，释放 Container</span></span><br><span class="line">    <span class="keyword">if</span> (stageCid != <span class="keyword">null</span>) &#123;</span><br><span class="line">        finalizeAndFixContainer(stageCid);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//【5】创建一个本地的安装观察者，监听安装结果！</span></span><br><span class="line">    <span class="keyword">final</span> IPackageInstallObserver2 localObserver = <span class="keyword">new</span> IPackageInstallObserver2.Stub() &#123;</span><br><span class="line">        <span class="meta">@Override</span></span><br><span class="line">        <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onUserActionRequired</span><span class="params">(Intent intent)</span> </span>&#123;</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> IllegalStateException();</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="meta">@Override</span></span><br><span class="line">        <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onPackageInstalled</span><span class="params">(String basePackageName, <span class="keyword">int</span> returnCode, String msg,</span></span></span><br><span class="line"><span class="function"><span class="params">                Bundle extras)</span> </span>&#123;</span><br><span class="line">            <span class="comment">//【*5.8.2.1】删除目录文件；</span></span><br><span class="line">            destroyInternal();</span><br><span class="line">            <span class="comment">//【*5.8.2.2】处理回调，通知监听者！</span></span><br><span class="line">            dispatchSessionFinished(returnCode, msg, extras);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">//【6】处理要安装的目标设别用户</span></span><br><span class="line">    <span class="keyword">final</span> UserHandle user;</span><br><span class="line">    <span class="keyword">if</span> ((params.installFlags &amp; PackageManager.INSTALL_ALL_USERS) != <span class="number">0</span>) &#123;</span><br><span class="line">        user = UserHandle.ALL;</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        user = <span class="keyword">new</span> UserHandle(userId);</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    mRelinquished = <span class="keyword">true</span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//【×5.1】然后继续安装！</span></span><br><span class="line">    mPm.installStage(mPackageName, stageDir, stageCid, localObserver, params,</span><br><span class="line">            installerPackageName, installerUid, user, mCertificates);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>继续分析：</p>
<h4 id="4-2-3-1-resolveStageDir"><a href="#4-2-3-1-resolveStageDir" class="headerlink" title="4.2.3.1 resolveStageDir"></a>4.2.3.1 resolveStageDir</h4><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">private</span> File <span class="title">resolveStageDir</span><span class="params">()</span> <span class="keyword">throws</span> IOException </span>&#123;</span><br><span class="line">    <span class="keyword">synchronized</span> (mLock) &#123;</span><br><span class="line">        <span class="comment">//【1】将之前保存的目录 stageDir 值赋给 mResolvedStageDir 并返回！</span></span><br><span class="line">        <span class="keyword">if</span> (mResolvedStageDir == <span class="keyword">null</span>) &#123;</span><br><span class="line">            <span class="keyword">if</span> (stageDir != <span class="keyword">null</span>) &#123;</span><br><span class="line">                mResolvedStageDir = stageDir;</span><br><span class="line">            &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                <span class="keyword">final</span> String path = PackageHelper.getSdDir(stageCid);</span><br><span class="line">                <span class="keyword">if</span> (path != <span class="keyword">null</span>) &#123;</span><br><span class="line">                    mResolvedStageDir = <span class="keyword">new</span> File(path);</span><br><span class="line">                &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                    <span class="keyword">throw</span> <span class="keyword">new</span> IOException(<span class="string">"Failed to resolve path to container "</span> + stageCid);</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> mResolvedStageDir;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>逻辑很简单，不多说了！</p>
<h4 id="4-2-3-2-validateInstallLocked"><a href="#4-2-3-2-validateInstallLocked" class="headerlink" title="4.2.3.2 validateInstallLocked"></a>4.2.3.2 validateInstallLocked</h4><p>校验安装有效性，这里的 mResolvedStageDir 就是前面的 /data/app/vmdl[sessionId].tmp 目录！</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">validateInstallLocked</span><span class="params">(PackageInfo pkgInfo, ApplicationInfo appInfo)</span></span></span><br><span class="line"><span class="function">        <span class="keyword">throws</span> PackageManagerException </span>&#123;</span><br><span class="line">    mPackageName = <span class="keyword">null</span>;</span><br><span class="line">    mVersionCode = -<span class="number">1</span>;</span><br><span class="line">    mSignatures = <span class="keyword">null</span>;</span><br><span class="line"></span><br><span class="line">    mResolvedBaseFile = <span class="keyword">null</span>;</span><br><span class="line">    mResolvedStagedFiles.clear();</span><br><span class="line">    mResolvedInheritedFiles.clear();</span><br><span class="line"></span><br><span class="line">    <span class="comment">//【1】返回 /data/app/vmdl[sessionId].tmp 目录下所有的 .removed 文件！</span></span><br><span class="line">    <span class="comment">// 去除后缀，将前缀名保存到 removeSplitList！</span></span><br><span class="line">    <span class="keyword">final</span> File[] removedFiles = mResolvedStageDir.listFiles(sRemovedFilter);</span><br><span class="line">    <span class="keyword">final</span> List&lt;String&gt; removeSplitList = <span class="keyword">new</span> ArrayList&lt;&gt;();</span><br><span class="line">    <span class="keyword">if</span> (!ArrayUtils.isEmpty(removedFiles)) &#123;</span><br><span class="line">        <span class="keyword">for</span> (File removedFile : removedFiles) &#123;</span><br><span class="line">            <span class="keyword">final</span> String fileName = removedFile.getName();</span><br><span class="line">            <span class="keyword">final</span> String splitName = fileName.substring(</span><br><span class="line">                    <span class="number">0</span>, fileName.length() - REMOVE_SPLIT_MARKER_EXTENSION.length());</span><br><span class="line">            removeSplitList.add(splitName);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">//【2】返回 /data/app/vmdl[sessionId].tmp 目录下所有的非 .removed 文件！</span></span><br><span class="line">    <span class="comment">// 并判断是否正常，如果该目录下没有任何 apk 和 .removed 文件，那么抛出异常！！</span></span><br><span class="line">    <span class="keyword">final</span> File[] addedFiles = mResolvedStageDir.listFiles(sAddedFilter);</span><br><span class="line">    <span class="keyword">if</span> (ArrayUtils.isEmpty(addedFiles) &amp;&amp; removeSplitList.size() == <span class="number">0</span>) &#123;</span><br><span class="line">        <span class="keyword">throw</span> <span class="keyword">new</span> PackageManagerException(INSTALL_FAILED_INVALID_APK, <span class="string">"No packages staged"</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//【3】遍历该目录下的非 .removed 文件，解析其中的 apk 文件，也就是我们之前 copy 到这里的目标文件！</span></span><br><span class="line">    <span class="comment">// 卸载和安装 split 都会进入这里！</span></span><br><span class="line">    <span class="keyword">final</span> ArraySet&lt;String&gt; stagedSplits = <span class="keyword">new</span> ArraySet&lt;&gt;();</span><br><span class="line">    <span class="keyword">for</span> (File addedFile : addedFiles) &#123;</span><br><span class="line">        <span class="keyword">final</span> ApkLite apk;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            <span class="comment">//【3.1】解析要安装的 apk，具体的流程这里就不分析了！</span></span><br><span class="line">            apk = PackageParser.parseApkLite(</span><br><span class="line">                    addedFile, PackageParser.PARSE_COLLECT_CERTIFICATES);</span><br><span class="line">        &#125; <span class="keyword">catch</span> (PackageParserException e) &#123;</span><br><span class="line">            <span class="keyword">throw</span> PackageManagerException.from(e);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">//【3.2】将其添加到 stagedSplits 中，注意 base.apk 的 apk.splitName 为 null！</span></span><br><span class="line">        <span class="keyword">if</span> (!stagedSplits.add(apk.splitName)) &#123;</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> PackageManagerException(INSTALL_FAILED_INVALID_APK,</span><br><span class="line">                    <span class="string">"Split "</span> + apk.splitName + <span class="string">" was defined multiple times"</span>);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment">//【3.3】将第一个被解析 apk 的包名，版本号，签名，证书保存下载，这个目录下的其他 apk </span></span><br><span class="line">        <span class="comment">// 的这几项要和其保持一致！</span></span><br><span class="line">        <span class="keyword">if</span> (mPackageName == <span class="keyword">null</span>) &#123;</span><br><span class="line">            mPackageName = apk.packageName;</span><br><span class="line">            mVersionCode = apk.versionCode;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">if</span> (mSignatures == <span class="keyword">null</span>) &#123;</span><br><span class="line">            mSignatures = apk.signatures;</span><br><span class="line">            mCertificates = apk.certificates;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment">//【*4.3.2.1】校验 apk 关联性！</span></span><br><span class="line">        assertApkConsistent(String.valueOf(addedFile), apk);</span><br><span class="line"></span><br><span class="line">        <span class="comment">//【3.4】设置 apk 文件的目标名称！</span></span><br><span class="line">        <span class="keyword">final</span> String targetName;</span><br><span class="line">        <span class="keyword">if</span> (apk.splitName == <span class="keyword">null</span>) &#123;</span><br><span class="line">            targetName = <span class="string">"base.apk"</span>; <span class="comment">// 一般情况下，我们只装 base apk！</span></span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            targetName = <span class="string">"split_"</span> + apk.splitName + <span class="string">".apk"</span>; <span class="comment">// 对于 split apk 名称是这样的！！</span></span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">if</span> (!FileUtils.isValidExtFilename(targetName)) &#123;</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> PackageManagerException(INSTALL_FAILED_INVALID_APK,</span><br><span class="line">                    <span class="string">"Invalid filename: "</span> + targetName);</span><br><span class="line">        &#125;</span><br><span class="line">        </span><br><span class="line">        <span class="comment">//【3.5】当 addedFile 命名不标准的话，会改名;</span></span><br><span class="line">        <span class="keyword">final</span> File targetFile = <span class="keyword">new</span> File(mResolvedStageDir, targetName);</span><br><span class="line">        <span class="keyword">if</span> (!addedFile.equals(targetFile)) &#123;</span><br><span class="line">            addedFile.renameTo(targetFile);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment">//【3.6】找到了 base apk，将其保存到 mResolvedBaseFile，同时将其添加到 mResolvedStagedFiles 中！</span></span><br><span class="line">        <span class="keyword">if</span> (apk.splitName == <span class="keyword">null</span>) &#123;</span><br><span class="line">            mResolvedBaseFile = targetFile;</span><br><span class="line">        &#125;</span><br><span class="line">        mResolvedStagedFiles.add(targetFile);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//【4】处理 .removed 文件（卸载 split apk，才会进入这里）</span></span><br><span class="line">    <span class="keyword">if</span> (removeSplitList.size() &gt; <span class="number">0</span>) &#123;</span><br><span class="line">        <span class="comment">//【4.1】找不到 split apk，抛出异常！</span></span><br><span class="line">        <span class="keyword">for</span> (String splitName : removeSplitList) &#123;</span><br><span class="line">            <span class="keyword">if</span> (!ArrayUtils.contains(pkgInfo.splitNames, splitName)) &#123;</span><br><span class="line">                <span class="keyword">throw</span> <span class="keyword">new</span> PackageManagerException(INSTALL_FAILED_INVALID_APK,</span><br><span class="line">                        <span class="string">"Split not found: "</span> + splitName);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 再次获得要安装的应用的包名，版本号，签名；</span></span><br><span class="line">        <span class="keyword">if</span> (mPackageName == <span class="keyword">null</span>) &#123;</span><br><span class="line">            mPackageName = pkgInfo.packageName;</span><br><span class="line">            mVersionCode = pkgInfo.versionCode;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">if</span> (mSignatures == <span class="keyword">null</span>) &#123;</span><br><span class="line">            mSignatures = pkgInfo.signatures;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//【5】处理安装模式！</span></span><br><span class="line">    <span class="keyword">if</span> (params.mode == SessionParams.MODE_FULL_INSTALL) &#123;</span><br><span class="line">        <span class="comment">//【5.1】全量安装必须要有 base.apk；</span></span><br><span class="line">        <span class="keyword">if</span> (!stagedSplits.contains(<span class="keyword">null</span>)) &#123;</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> PackageManagerException(INSTALL_FAILED_INVALID_APK,</span><br><span class="line">                    <span class="string">"Full install must include a base package"</span>);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        <span class="comment">//【5.2】部分安装必须基于现有的安装（卸载和安装 split apk 也会进入这里）！</span></span><br><span class="line">        <span class="keyword">if</span> (appInfo == <span class="keyword">null</span>) &#123;</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> PackageManagerException(INSTALL_FAILED_INVALID_APK,</span><br><span class="line">                    <span class="string">"Missing existing base package for "</span> + mPackageName);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment">//【5.3】获得已存在的 apk 安装信息，这里会解析主 apk 的安装信息！</span></span><br><span class="line">        <span class="keyword">final</span> PackageLite existing;</span><br><span class="line">        <span class="keyword">final</span> ApkLite existingBase;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            existing = PackageParser.parsePackageLite(<span class="keyword">new</span> File(appInfo.getCodePath()), <span class="number">0</span>);</span><br><span class="line">            existingBase = PackageParser.parseApkLite(<span class="keyword">new</span> File(appInfo.getBaseCodePath()),</span><br><span class="line">                    PackageParser.PARSE_COLLECT_CERTIFICATES);</span><br><span class="line">        &#125; <span class="keyword">catch</span> (PackageParserException e) &#123;</span><br><span class="line">            <span class="keyword">throw</span> PackageManagerException.from(e);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment">//【*4.3.2.1】再次校验要本次要安装的 apk 和已存在的 apk 是有关联，包括包名，签名，版本号！</span></span><br><span class="line">        assertApkConsistent(<span class="string">"Existing base"</span>, existingBase);</span><br><span class="line"></span><br><span class="line">        <span class="comment">//【5.4】继承已有的 base apk，如果没有指定安装的 apk！！</span></span><br><span class="line">        <span class="keyword">if</span> (mResolvedBaseFile == <span class="keyword">null</span>) &#123;</span><br><span class="line">            mResolvedBaseFile = <span class="keyword">new</span> File(appInfo.getBaseCodePath());</span><br><span class="line">            mResolvedInheritedFiles.add(mResolvedBaseFile);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment">//【5.5】继承已有的 split apk，要继承的 split apk 不能是在 removeSplitList 列表中！！</span></span><br><span class="line">        <span class="keyword">if</span> (!ArrayUtils.isEmpty(existing.splitNames)) &#123;</span><br><span class="line">            <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; existing.splitNames.length; i++) &#123;</span><br><span class="line">                <span class="keyword">final</span> String splitName = existing.splitNames[i];</span><br><span class="line">                <span class="keyword">final</span> File splitFile = <span class="keyword">new</span> File(existing.splitCodePaths[i]);</span><br><span class="line">                <span class="keyword">final</span> <span class="keyword">boolean</span> splitRemoved = removeSplitList.contains(splitName);</span><br><span class="line">                <span class="keyword">if</span> (!stagedSplits.contains(splitName) &amp;&amp; !splitRemoved) &#123;</span><br><span class="line">                    mResolvedInheritedFiles.add(splitFile);</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment">//【5.6】继承已有的 oat 相关文件！！</span></span><br><span class="line">        <span class="keyword">final</span> File packageInstallDir = (<span class="keyword">new</span> File(appInfo.getBaseCodePath())).getParentFile();</span><br><span class="line">        mInheritedFilesBase = packageInstallDir;</span><br><span class="line">        <span class="keyword">final</span> File oatDir = <span class="keyword">new</span> File(packageInstallDir, <span class="string">"oat"</span>);</span><br><span class="line">        <span class="keyword">if</span> (oatDir.exists()) &#123;</span><br><span class="line">            <span class="keyword">final</span> File[] archSubdirs = oatDir.listFiles();</span><br><span class="line">            <span class="keyword">if</span> (archSubdirs != <span class="keyword">null</span> &amp;&amp; archSubdirs.length &gt; <span class="number">0</span>) &#123;</span><br><span class="line">                <span class="keyword">final</span> String[] instructionSets = InstructionSets.getAllDexCodeInstructionSets();</span><br><span class="line">                <span class="keyword">for</span> (File archSubDir : archSubdirs) &#123;</span><br><span class="line">                    <span class="comment">// Skip any directory that isn't an ISA subdir.</span></span><br><span class="line">                    <span class="keyword">if</span> (!ArrayUtils.contains(instructionSets, archSubDir.getName())) &#123;</span><br><span class="line">                        <span class="keyword">continue</span>;</span><br><span class="line">                    &#125;</span><br><span class="line">                    <span class="comment">// 将要继承的 oat 目录文件名添加到 mResolvedInstructionSets！</span></span><br><span class="line">                    mResolvedInstructionSets.add(archSubDir.getName());</span><br><span class="line">                    List&lt;File&gt; oatFiles = Arrays.asList(archSubDir.listFiles());</span><br><span class="line">                    <span class="keyword">if</span> (!oatFiles.isEmpty()) &#123;</span><br><span class="line">                        <span class="comment">// 将要继承的 odex 相关文件添加到 mResolvedInheritedFiles！</span></span><br><span class="line">                        mResolvedInheritedFiles.addAll(oatFiles);</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>总结下：</p>
<p>1、返回 /data/app/vmdl[sessionId].tmp 目录下所有的 .removed 文件，去除后缀，将前缀名保存到 removeSplitList；<br>2、/data/app/vmdl[sessionId].tmp 目录下必须要有 apk 文件或者 .removed 文件；<br>3、遍历该目录下的非 .removed 文件，对其 packagename versionCode 和签名做关联校验；<br>4、stagedSplits 用于保存该目录下的所有 apk 的 splitName，base apk 的 splitName 为 null；<br>5、mResolvedBaseFile 用于保存 base apk；<br>6、mResolvedStagedFiles 用于保存目录下所有的 apk；</p>
<p>7、removeSplitList 大于 0，说明有要移除的 split apk，前提是主 apk 要有 split apk！</p>
<p>8、对于 MODE_FULL_INSTALL，全量安装，必须要有 base apk！<br>9、对于 MODE_INHERIT_EXISTING，继承安装，会再次解析主 apk，收集那些不在 removeSplitList 列表中的 splitApk 路径到 mResolvedInheritedFiles 中；</p>
<h5 id="4-2-3-2-1-assertApkConsistent"><a href="#4-2-3-2-1-assertApkConsistent" class="headerlink" title="4.2.3.2.1 assertApkConsistent"></a>4.2.3.2.1 assertApkConsistent</h5><p>校验 apk 的一致性，ApkLite apk 为扫描到的文件！</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">assertApkConsistent</span><span class="params">(String tag, ApkLite apk)</span></span></span><br><span class="line"><span class="function">        <span class="keyword">throws</span> PackageManagerException </span>&#123;</span><br><span class="line">    <span class="comment">//【1】扫描到的 apk 的包名必须和该目录下第一个被扫描到的 apk 包名保持一致！</span></span><br><span class="line">    <span class="keyword">if</span> (!mPackageName.equals(apk.packageName)) &#123;</span><br><span class="line">        <span class="keyword">throw</span> <span class="keyword">new</span> PackageManagerException(INSTALL_FAILED_INVALID_APK, tag + <span class="string">" package "</span></span><br><span class="line">                + apk.packageName + <span class="string">" inconsistent with "</span> + mPackageName);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">//【2】如果是要继承已安装的 apk，那么包名要一样！</span></span><br><span class="line">    <span class="keyword">if</span> (params.appPackageName != <span class="keyword">null</span> &amp;&amp; !params.appPackageName.equals(apk.packageName)) &#123;</span><br><span class="line">        <span class="keyword">throw</span> <span class="keyword">new</span> PackageManagerException(INSTALL_FAILED_INVALID_APK, tag</span><br><span class="line">                + <span class="string">" specified package "</span> + params.appPackageName</span><br><span class="line">                + <span class="string">" inconsistent with "</span> + apk.packageName);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">//【3】扫描到的 apk 的版本号必须和该目录下第一个被扫描到的 apk 版本号保持一致！</span></span><br><span class="line">    <span class="keyword">if</span> (mVersionCode != apk.versionCode) &#123;</span><br><span class="line">        <span class="keyword">throw</span> <span class="keyword">new</span> PackageManagerException(INSTALL_FAILED_INVALID_APK, tag</span><br><span class="line">                + <span class="string">" version code "</span> + apk.versionCode + <span class="string">" inconsistent with "</span></span><br><span class="line">                + mVersionCode);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">//【4】扫描到的 apk 的签名必须和该目录下第一个被扫描到的 apk 签名保持一致！</span></span><br><span class="line">    <span class="keyword">if</span> (!Signature.areExactMatch(mSignatures, apk.signatures)) &#123;</span><br><span class="line">        <span class="keyword">throw</span> <span class="keyword">new</span> PackageManagerException(INSTALL_FAILED_INVALID_APK,</span><br><span class="line">                tag + <span class="string">" signatures are inconsistent"</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>流程很简单，不多说了！</p>
<h4 id="4-2-3-3-close"><a href="#4-2-3-3-close" class="headerlink" title="4.2.3.3 close"></a>4.2.3.3 close</h4><p>close 方法很简单，将事务的 mActiveCount 引用计数自减 1，同时回调 </p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">close</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    <span class="comment">//【1】引用计数减去 1；</span></span><br><span class="line">    <span class="keyword">if</span> (mActiveCount.decrementAndGet() == <span class="number">0</span>) &#123;</span><br><span class="line">        <span class="comment">//【*3.1.4.2】反馈事务状态！</span></span><br><span class="line">        mCallback.onSessionActiveChanged(<span class="keyword">this</span>, <span class="keyword">false</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h4 id="4-2-3-4-calculateInstalledSize"><a href="#4-2-3-4-calculateInstalledSize" class="headerlink" title="4.2.3.4 calculateInstalledSize"></a>4.2.3.4 calculateInstalledSize</h4><p>用于计算最终的安装大小！</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">long</span> <span class="title">calculateInstalledSize</span><span class="params">()</span> <span class="keyword">throws</span> PackageManagerException </span>&#123;</span><br><span class="line">    Preconditions.checkNotNull(mResolvedBaseFile);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">final</span> ApkLite baseApk;</span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">        <span class="comment">//【1】解析要安装的 apk 的数据信息！</span></span><br><span class="line">        baseApk = PackageParser.parseApkLite(mResolvedBaseFile, <span class="number">0</span>);</span><br><span class="line">    &#125; <span class="keyword">catch</span> (PackageParserException e) &#123;</span><br><span class="line">        <span class="keyword">throw</span> PackageManagerException.from(e);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">//【2】获得其 split apk 的文件路径！</span></span><br><span class="line">    <span class="keyword">final</span> List&lt;String&gt; splitPaths = <span class="keyword">new</span> ArrayList&lt;&gt;();</span><br><span class="line">    <span class="keyword">for</span> (File file : mResolvedStagedFiles) &#123;</span><br><span class="line">        <span class="keyword">if</span> (mResolvedBaseFile.equals(file)) <span class="keyword">continue</span>;</span><br><span class="line">        splitPaths.add(file.getAbsolutePath());</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">//【3】获得其要继承的 apk 的文件路径！</span></span><br><span class="line">    <span class="keyword">for</span> (File file : mResolvedInheritedFiles) &#123;</span><br><span class="line">        <span class="keyword">if</span> (mResolvedBaseFile.equals(file)) <span class="keyword">continue</span>;</span><br><span class="line">        splitPaths.add(file.getAbsolutePath());</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//【4】创建一个 PackageLite 对象！</span></span><br><span class="line">    <span class="keyword">final</span> PackageLite pkg = <span class="keyword">new</span> PackageLite(<span class="keyword">null</span>, baseApk, <span class="keyword">null</span>,</span><br><span class="line">            splitPaths.toArray(<span class="keyword">new</span> String[splitPaths.size()]), <span class="keyword">null</span>);</span><br><span class="line">    <span class="keyword">final</span> <span class="keyword">boolean</span> isForwardLocked =</span><br><span class="line">            (params.installFlags &amp; PackageManager.INSTALL_FORWARD_LOCK) != <span class="number">0</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">        <span class="comment">//【*4.2.3.4.1】调用 PackageHelper 计算空间大小！</span></span><br><span class="line">        <span class="keyword">return</span> PackageHelper.calculateInstalledSize(pkg, isForwardLocked, params.abiOverride);</span><br><span class="line">    &#125; <span class="keyword">catch</span> (IOException e) &#123;</span><br><span class="line">        <span class="keyword">throw</span> <span class="keyword">new</span> PackageManagerException(INSTALL_FAILED_INVALID_APK,</span><br><span class="line">                <span class="string">"Failed to calculate install size"</span>, e);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>我们去 PackageHelper.calculateInstalledSize 方法中去看看：</p>
<h5 id="4-2-3-4-1-calculateInstalledSize"><a href="#4-2-3-4-1-calculateInstalledSize" class="headerlink" title="4.2.3.4.1 calculateInstalledSize"></a>4.2.3.4.1 calculateInstalledSize</h5><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">long</span> <span class="title">calculateInstalledSize</span><span class="params">(PackageLite pkg, <span class="keyword">boolean</span> isForwardLocked,</span></span></span><br><span class="line"><span class="function"><span class="params">        String abiOverride)</span> <span class="keyword">throws</span> IOException </span>&#123;</span><br><span class="line">    NativeLibraryHelper.Handle handle = <span class="keyword">null</span>;</span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">        handle = NativeLibraryHelper.Handle.create(pkg);</span><br><span class="line">        <span class="keyword">return</span> calculateInstalledSize(pkg, handle, isForwardLocked, abiOverride);</span><br><span class="line">    &#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">        IoUtils.closeQuietly(handle);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">long</span> <span class="title">calculateInstalledSize</span><span class="params">(PackageLite pkg, NativeLibraryHelper.Handle handle,</span></span></span><br><span class="line"><span class="function"><span class="params">        <span class="keyword">boolean</span> isForwardLocked, String abiOverride)</span> <span class="keyword">throws</span> IOException </span>&#123;</span><br><span class="line">    <span class="keyword">long</span> sizeBytes = <span class="number">0</span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//【1】包括 apk 集合其他的一些资源！</span></span><br><span class="line">    <span class="keyword">for</span> (String codePath : pkg.getAllCodePaths()) &#123;</span><br><span class="line">        <span class="keyword">final</span> File codeFile = <span class="keyword">new</span> File(codePath);</span><br><span class="line">        sizeBytes += codeFile.length();</span><br><span class="line">        <span class="comment">//【2】如果是 forward lock 模式，还要加入一些公共资源！</span></span><br><span class="line">        <span class="keyword">if</span> (isForwardLocked) &#123;</span><br><span class="line">            sizeBytes += PackageHelper.extractPublicFiles(codeFile, <span class="keyword">null</span>);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//【3】加入 native code 的大小！</span></span><br><span class="line">    sizeBytes += NativeLibraryHelper.sumNativeBinariesWithOverride(handle, abiOverride);</span><br><span class="line">    <span class="comment">//【4】返回最终大小！</span></span><br><span class="line">    <span class="keyword">return</span> sizeBytes;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>这里就分析到这里！</p>
<h4 id="4-2-3-5-computeProgressLocked"><a href="#4-2-3-5-computeProgressLocked" class="headerlink" title="4.2.3.5 computeProgressLocked"></a>4.2.3.5 computeProgressLocked</h4><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">computeProgressLocked</span><span class="params">(<span class="keyword">boolean</span> forcePublish)</span> </span>&#123;</span><br><span class="line">    mProgress = MathUtils.constrain(mClientProgress * <span class="number">0.8f</span>, <span class="number">0f</span>, <span class="number">0.8f</span>)</span><br><span class="line">            + MathUtils.constrain(mInternalProgress * <span class="number">0.2f</span>, <span class="number">0f</span>, <span class="number">0.2f</span>);</span><br><span class="line"></span><br><span class="line">    <span class="comment">// Only publish when meaningful change</span></span><br><span class="line">    <span class="keyword">if</span> (forcePublish || Math.abs(mProgress - mReportedProgress) &gt;= <span class="number">0.01</span>) &#123;</span><br><span class="line">        mReportedProgress = mProgress;</span><br><span class="line">        <span class="comment">//【3.1.4.1】调用 InternalCallback 回调！</span></span><br><span class="line">        mCallback.onSessionProgressChanged(<span class="keyword">this</span>, mProgress);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h4 id="4-2-3-6-extractNativeLibraries"><a href="#4-2-3-6-extractNativeLibraries" class="headerlink" title="4.2.3.6 extractNativeLibraries"></a>4.2.3.6 extractNativeLibraries</h4><p>提取本地的 lib 库文件！</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">extractNativeLibraries</span><span class="params">(File packageDir, String abiOverride)</span></span></span><br><span class="line"><span class="function">        <span class="keyword">throws</span> PackageManagerException </span>&#123;</span><br><span class="line">    <span class="comment">//【1】libDir 指向 /data/app/vmdl[id].tmp/lib 目录，这里是删除目录下存在的 lib 库文件！</span></span><br><span class="line">    <span class="keyword">final</span> File libDir = <span class="keyword">new</span> File(packageDir, NativeLibraryHelper.LIB_DIR_NAME);</span><br><span class="line">    NativeLibraryHelper.removeNativeBinariesFromDirLI(libDir, <span class="keyword">true</span>);</span><br><span class="line"></span><br><span class="line">    NativeLibraryHelper.Handle handle = <span class="keyword">null</span>;</span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">        <span class="comment">//【2】创建 lib 子目录，并将应用程序中的 lib 库拷贝到该目录下！</span></span><br><span class="line">        handle = NativeLibraryHelper.Handle.create(packageDir);</span><br><span class="line">        <span class="keyword">final</span> <span class="keyword">int</span> res = NativeLibraryHelper.copyNativeBinariesWithOverride(handle, libDir,</span><br><span class="line">                abiOverride);</span><br><span class="line">        <span class="keyword">if</span> (res != PackageManager.INSTALL_SUCCEEDED) &#123;</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> PackageManagerException(res,</span><br><span class="line">                    <span class="string">"Failed to extract native libraries, res="</span> + res);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125; <span class="keyword">catch</span> (IOException e) &#123;</span><br><span class="line">        <span class="keyword">throw</span> <span class="keyword">new</span> PackageManagerException(INSTALL_FAILED_INTERNAL_ERROR,</span><br><span class="line">                <span class="string">"Failed to extract native libraries"</span>, e);</span><br><span class="line">    &#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">        IoUtils.closeQuietly(handle);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>对于 lib 的提取，这里涉及到了 NativeLibraryHelper，我们先不过多关注其实现！</p>
<h1 id="5-PackageManagerService"><a href="#5-PackageManagerService" class="headerlink" title="5 PackageManagerService"></a>5 PackageManagerService</h1><h2 id="5-1-PackageManagerService-installStage"><a href="#5-1-PackageManagerService-installStage" class="headerlink" title="5.1 PackageManagerService.installStage"></a>5.1 PackageManagerService.installStage</h2><p>接下来，进入 PackageManagerService 阶段。</p>
<p>这里的 IPackageInstallObserver2 observer 是前面创建的本次 localObserver：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">installStage</span><span class="params">(String packageName, File stagedDir, String stagedCid,</span></span></span><br><span class="line"><span class="function"><span class="params">         IPackageInstallObserver2 observer, PackageInstaller.SessionParams sessionParams,</span></span></span><br><span class="line"><span class="function"><span class="params">         String installerPackageName, <span class="keyword">int</span> installerUid, UserHandle user,</span></span></span><br><span class="line"><span class="function"><span class="params">         Certificate[][] certificates)</span> </span>&#123;</span><br><span class="line">     <span class="keyword">if</span> (DEBUG_EPHEMERAL) &#123;</span><br><span class="line">         <span class="keyword">if</span> ((sessionParams.installFlags &amp; PackageManager.INSTALL_EPHEMERAL) != <span class="number">0</span>) &#123;</span><br><span class="line">             Slog.d(TAG, <span class="string">"Ephemeral install of "</span> + packageName);</span><br><span class="line">         &#125;</span><br><span class="line">     &#125;</span><br><span class="line">     <span class="comment">//【5.1.1】创建一个 VerificationInfo 对象，用于校验</span></span><br><span class="line">     <span class="keyword">final</span> VerificationInfo verificationInfo = <span class="keyword">new</span> VerificationInfo(</span><br><span class="line">             sessionParams.originatingUri, sessionParams.referrerUri,</span><br><span class="line">             sessionParams.originatingUid, installerUid);</span><br><span class="line">     <span class="comment">//【5.1.2】创建了一个 OriginInfo 对象！</span></span><br><span class="line">     <span class="keyword">final</span> OriginInfo origin;</span><br><span class="line">     <span class="keyword">if</span> (stagedDir != <span class="keyword">null</span>) &#123;</span><br><span class="line">         origin = OriginInfo.fromStagedFile(stagedDir);</span><br><span class="line">     &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">         origin = OriginInfo.fromStagedContainer(stagedCid);</span><br><span class="line">     &#125;</span><br><span class="line">     <span class="comment">//【1】创建了一个 INIT_COPY 消息！</span></span><br><span class="line">     <span class="keyword">final</span> Message msg = mHandler.obtainMessage(INIT_COPY);</span><br><span class="line">     <span class="comment">//【5.1.3】创建一个 InstallParams 安装参数对象！</span></span><br><span class="line">     <span class="keyword">final</span> InstallParams params = <span class="keyword">new</span> InstallParams(origin, <span class="keyword">null</span>, observer,</span><br><span class="line">             sessionParams.installFlags, installerPackageName, sessionParams.volumeUuid,</span><br><span class="line">             verificationInfo, user, sessionParams.abiOverride,</span><br><span class="line">             sessionParams.grantedRuntimePermissions, certificates);</span><br><span class="line">     params.setTraceMethod(<span class="string">"installStage"</span>).setTraceCookie(System.identityHashCode(params));</span><br><span class="line">     msg.obj = params;</span><br><span class="line"></span><br><span class="line">     Trace.asyncTraceBegin(TRACE_TAG_PACKAGE_MANAGER, <span class="string">"installStage"</span>,</span><br><span class="line">             System.identityHashCode(msg.obj));</span><br><span class="line">     Trace.asyncTraceBegin(TRACE_TAG_PACKAGE_MANAGER, <span class="string">"queueInstall"</span>,</span><br><span class="line">             System.identityHashCode(msg.obj));</span><br><span class="line">             </span><br><span class="line">     <span class="comment">//【5.2】发送 INIT_COPY 消息！</span></span><br><span class="line">     mHandler.sendMessage(msg);</span><br><span class="line"> &#125;</span><br></pre></td></tr></table></figure>
<p>这里的 mHandler 是在 PackageManagerService 的构造器中创建的：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">mHandlerThread = <span class="keyword">new</span> ServiceThread(TAG,</span><br><span class="line">        Process.THREAD_PRIORITY_BACKGROUND, <span class="keyword">true</span> <span class="comment">/*allowIo*/</span>);</span><br><span class="line">mHandlerThread.start();</span><br><span class="line">mHandler = <span class="keyword">new</span> PackageHandler(mHandlerThread.getLooper());</span><br></pre></td></tr></table></figure>
<p>是一个 PackageHandler 实例，其绑定了一个子线程 ServiceThread！</p>
<h3 id="5-1-1-new-VerificationInfo"><a href="#5-1-1-new-VerificationInfo" class="headerlink" title="5.1.1 new VerificationInfo"></a>5.1.1 new VerificationInfo</h3><p>VerificationInfo 类定义在 PackageManagerService 中，用于信息校验：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">static</span> <span class="class"><span class="keyword">class</span> <span class="title">VerificationInfo</span> </span>&#123;</span><br><span class="line">    <span class="comment">/** A constant used to indicate that a uid value is not present. */</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="keyword">int</span> NO_UID = -<span class="number">1</span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/** URI referencing where the package was downloaded from. */</span></span><br><span class="line">    <span class="keyword">final</span> Uri originatingUri;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/** HTTP referrer URI associated with the originatingURI. */</span></span><br><span class="line">    <span class="keyword">final</span> Uri referrer;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/** UID of the application that the install request originated from. */</span></span><br><span class="line">    <span class="keyword">final</span> <span class="keyword">int</span> originatingUid;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">final</span> <span class="keyword">int</span> installerUid; <span class="comment">// 安装者应用的 uid！</span></span><br><span class="line"></span><br><span class="line">    VerificationInfo(Uri originatingUri, Uri referrer, <span class="keyword">int</span> originatingUid, <span class="keyword">int</span> installerUid) &#123;</span><br><span class="line">        <span class="keyword">this</span>.originatingUri = originatingUri;</span><br><span class="line">        <span class="keyword">this</span>.referrer = referrer;</span><br><span class="line">        <span class="keyword">this</span>.originatingUid = originatingUid;</span><br><span class="line">        <span class="keyword">this</span>.installerUid = installerUid;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h3 id="5-1-2-new-OriginInfo"><a href="#5-1-2-new-OriginInfo" class="headerlink" title="5.1.2 new OriginInfo"></a>5.1.2 new OriginInfo</h3><p>这里创建了一个 OriginInfo 实例，封装安装目录相关信息！</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">static</span> <span class="class"><span class="keyword">class</span> <span class="title">OriginInfo</span> </span>&#123;</span><br><span class="line">    <span class="keyword">final</span> File file; <span class="comment">// 安装到内置存储，不为 null</span></span><br><span class="line">    <span class="keyword">final</span> String cid; <span class="comment">// 安装到内置存储，为 null</span></span><br><span class="line">    <span class="keyword">final</span> <span class="keyword">boolean</span> staged;</span><br><span class="line">    <span class="keyword">final</span> <span class="keyword">boolean</span> existing;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">final</span> String resolvedPath;</span><br><span class="line">    <span class="keyword">final</span> File resolvedFile;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">static</span> OriginInfo <span class="title">fromNothing</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> OriginInfo(<span class="keyword">null</span>, <span class="keyword">null</span>, <span class="keyword">false</span>, <span class="keyword">false</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">static</span> OriginInfo <span class="title">fromUntrustedFile</span><span class="params">(File file)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> OriginInfo(file, <span class="keyword">null</span>, <span class="keyword">false</span>, <span class="keyword">false</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">static</span> OriginInfo <span class="title">fromExistingFile</span><span class="params">(File file)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> OriginInfo(file, <span class="keyword">null</span>, <span class="keyword">false</span>, <span class="keyword">true</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">static</span> OriginInfo <span class="title">fromStagedFile</span><span class="params">(File file)</span> </span>&#123; <span class="comment">//【1】安装到内置存储会调用</span></span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> OriginInfo(file, <span class="keyword">null</span>, <span class="keyword">true</span>, <span class="keyword">false</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">static</span> OriginInfo <span class="title">fromStagedContainer</span><span class="params">(String cid)</span> </span>&#123; <span class="comment">//【2】安装到外置存储会调用</span></span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> OriginInfo(<span class="keyword">null</span>, cid, <span class="keyword">true</span>, <span class="keyword">false</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">private</span> <span class="title">OriginInfo</span><span class="params">(File file, String cid, <span class="keyword">boolean</span> staged, <span class="keyword">boolean</span> existing)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">this</span>.file = file; <span class="comment">// 内置时为：/data/app/vmdl[sessionId].tmp</span></span><br><span class="line">        <span class="keyword">this</span>.cid = cid;</span><br><span class="line">        <span class="keyword">this</span>.staged = staged; <span class="comment">// 安装到内置存储时为 true。</span></span><br><span class="line">        <span class="keyword">this</span>.existing = existing; <span class="comment">// 安装到内置存储时为 false。</span></span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (cid != <span class="keyword">null</span>) &#123;</span><br><span class="line">            resolvedPath = PackageHelper.getSdDir(cid);</span><br><span class="line">            resolvedFile = <span class="keyword">new</span> File(resolvedPath);</span><br><span class="line">        &#125; <span class="keyword">else</span> <span class="keyword">if</span> (file != <span class="keyword">null</span>) &#123;</span><br><span class="line">            resolvedPath = file.getAbsolutePath();</span><br><span class="line">            resolvedFile = file;</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            resolvedPath = <span class="keyword">null</span>;</span><br><span class="line">            resolvedFile = <span class="keyword">null</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>这里我们先关注安装到内置存储中的逻辑！</p>
<h3 id="5-1-3-new-PMS-InstallParams"><a href="#5-1-3-new-PMS-InstallParams" class="headerlink" title="5.1.3 new PMS.InstallParams"></a>5.1.3 new PMS.InstallParams</h3><p>InstallParams  类定义在 PackageManagerService 中，封装了安装参数：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">InstallParams</span> <span class="keyword">extends</span> <span class="title">HandlerParams</span> </span>&#123;</span><br><span class="line">    <span class="keyword">final</span> OriginInfo origin;</span><br><span class="line">    <span class="keyword">final</span> MoveInfo move; <span class="comment">// move package 才会传入，安装时为 null！</span></span><br><span class="line">    <span class="keyword">final</span> IPackageInstallObserver2 observer; <span class="comment">// 本地传观察者；</span></span><br><span class="line">    <span class="keyword">int</span> installFlags;</span><br><span class="line">    <span class="keyword">final</span> String installerPackageName;</span><br><span class="line">    <span class="keyword">final</span> String volumeUuid;</span><br><span class="line">    <span class="keyword">private</span> InstallArgs mArgs;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">int</span> mRet;</span><br><span class="line">    <span class="keyword">final</span> String packageAbiOverride;</span><br><span class="line">    <span class="keyword">final</span> String[] grantedRuntimePermissions; <span class="comment">// 安装时授予的运行时权限列表；</span></span><br><span class="line">    <span class="keyword">final</span> VerificationInfo verificationInfo;</span><br><span class="line">    <span class="keyword">final</span> Certificate[][] certificates;</span><br><span class="line"></span><br><span class="line">    InstallParams(OriginInfo origin, MoveInfo move, IPackageInstallObserver2 observer,</span><br><span class="line">            <span class="keyword">int</span> installFlags, String installerPackageName, String volumeUuid,</span><br><span class="line">            VerificationInfo verificationInfo, UserHandle user, String packageAbiOverride,</span><br><span class="line">            String[] grantedPermissions, Certificate[][] certificates) &#123;</span><br><span class="line">        <span class="keyword">super</span>(user);</span><br><span class="line">        <span class="keyword">this</span>.origin = origin;</span><br><span class="line">        <span class="keyword">this</span>.move = move;</span><br><span class="line">        <span class="keyword">this</span>.observer = observer;</span><br><span class="line">        <span class="keyword">this</span>.installFlags = installFlags;</span><br><span class="line">        <span class="keyword">this</span>.installerPackageName = installerPackageName;</span><br><span class="line">        <span class="keyword">this</span>.volumeUuid = volumeUuid;</span><br><span class="line">        <span class="keyword">this</span>.verificationInfo = verificationInfo;</span><br><span class="line">        <span class="keyword">this</span>.packageAbiOverride = packageAbiOverride;</span><br><span class="line">        <span class="keyword">this</span>.grantedRuntimePermissions = grantedPermissions;</span><br><span class="line">        <span class="keyword">this</span>.certificates = certificates;</span><br><span class="line">    &#125;</span><br><span class="line">    ... ... ...   </span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>InstallParams 继承了 HandlerParams！</p>
<p>这里涉及到一个 MoveInfo move，在 movePackageInternal 也就是移动 package 时才会调用，这里是安装，我们先不关注！</p>
<h2 id="5-2-PackageHandler-doHandleMessage-INIT-COPY"><a href="#5-2-PackageHandler-doHandleMessage-INIT-COPY" class="headerlink" title="5.2 PackageHandler.doHandleMessage[INIT_COPY]"></a>5.2 PackageHandler.doHandleMessage[INIT_COPY]</h2><p>PackageHandler 会在子线程中处理 INIT_COPY 消息：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">case</span> INIT_COPY: &#123;</span><br><span class="line">    <span class="comment">//【1】取出 InstallParams！</span></span><br><span class="line">    HandlerParams params = (HandlerParams) msg.obj;</span><br><span class="line">    <span class="comment">// mPendingInstalls 中会保存所有正在等待的安装！</span></span><br><span class="line">    <span class="keyword">int</span> idx = mPendingInstalls.size();</span><br><span class="line">    <span class="keyword">if</span> (DEBUG_INSTALL) Slog.i(TAG, <span class="string">"init_copy idx="</span> + idx + <span class="string">": "</span> + params);</span><br><span class="line"></span><br><span class="line">    <span class="comment">//【2】mBound 用来判断是否已经绑定到了 DefaultContainerService，该服务用于安装！</span></span><br><span class="line">    <span class="keyword">if</span> (!mBound) &#123;</span><br><span class="line">        Trace.asyncTraceBegin(TRACE_TAG_PACKAGE_MANAGER, <span class="string">"bindingMCS"</span>,</span><br><span class="line">                System.identityHashCode(mHandler));</span><br><span class="line"></span><br><span class="line">        <span class="comment">//【5.2.1】尝试去 bind 服务，bind 成功后，mBound 置为 true！</span></span><br><span class="line">        <span class="keyword">if</span> (!connectToService()) &#123;</span><br><span class="line">            Slog.e(TAG, <span class="string">"Failed to bind to media container service"</span>);</span><br><span class="line">            <span class="comment">//【5.2.2】如果不能 bind 成功，那就触发 HandlerParams 的 serviceError 方法！</span></span><br><span class="line">            params.serviceError();</span><br><span class="line">            Trace.asyncTraceEnd(TRACE_TAG_PACKAGE_MANAGER, <span class="string">"bindingMCS"</span>,</span><br><span class="line">                    System.identityHashCode(mHandler));</span><br><span class="line">            <span class="keyword">if</span> (params.traceMethod != <span class="keyword">null</span>) &#123;</span><br><span class="line">                Trace.asyncTraceEnd(TRACE_TAG_PACKAGE_MANAGER, params.traceMethod,</span><br><span class="line">                        params.traceCookie);</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">return</span>;</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            <span class="comment">//【3】将本次的安装参数添加到等待集合中！！</span></span><br><span class="line">            mPendingInstalls.add(idx, params);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        <span class="comment">//【4】如果之前已经 bind 了，那就直接将安装参数添加到等待集合中！！</span></span><br><span class="line">        mPendingInstalls.add(idx, params);</span><br><span class="line">        <span class="comment">//【5.3】如果是第一次添加，发送 MCS_BOUND 消息！</span></span><br><span class="line">        <span class="keyword">if</span> (idx == <span class="number">0</span>) &#123;</span><br><span class="line">            mHandler.sendEmptyMessage(MCS_BOUND);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">break</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>这里逻辑很清晰了，我们继续看！</p>
<h3 id="5-2-1-PackageHandler-connectToService"><a href="#5-2-1-PackageHandler-connectToService" class="headerlink" title="5.2.1 PackageHandler.connectToService"></a>5.2.1 PackageHandler.connectToService</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">boolean</span> <span class="title">connectToService</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    <span class="keyword">if</span> (DEBUG_SD_INSTALL) Log.i(TAG, <span class="string">"Trying to bind to"</span> +</span><br><span class="line">            <span class="string">" DefaultContainerService"</span>);</span><br><span class="line">    Intent service = <span class="keyword">new</span> Intent().setComponent(DEFAULT_CONTAINER_COMPONENT);</span><br><span class="line">    Process.setThreadPriority(Process.THREAD_PRIORITY_DEFAULT);</span><br><span class="line">    <span class="comment">//【1】开始 bind 服务，传入了 mDefContainerConn 对象！</span></span><br><span class="line">    <span class="keyword">if</span> (mContext.bindServiceAsUser(service, mDefContainerConn,</span><br><span class="line">            Context.BIND_AUTO_CREATE, UserHandle.SYSTEM)) &#123;</span><br><span class="line">        Process.setThreadPriority(Process.THREAD_PRIORITY_BACKGROUND);</span><br><span class="line">        mBound = <span class="keyword">true</span>;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">true</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    Process.setThreadPriority(Process.THREAD_PRIORITY_BACKGROUND);</span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">false</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>这里 bind 的服务是 DefaultContainerService！<br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">static</span> <span class="keyword">final</span> ComponentName DEFAULT_CONTAINER_COMPONENT = <span class="keyword">new</span> ComponentName(</span><br><span class="line">        DEFAULT_CONTAINER_PACKAGE,</span><br><span class="line">        <span class="string">"com.android.defcontainer.DefaultContainerService"</span>);</span><br></pre></td></tr></table></figure></p>
<p>PackageManagerService 内部持有一个 DefaultContainerConnection 实例！</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">final</span> <span class="keyword">private</span> DefaultContainerConnection mDefContainerConn =</span><br><span class="line">        <span class="keyword">new</span> DefaultContainerConnection();</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">DefaultContainerConnection</span> <span class="keyword">implements</span> <span class="title">ServiceConnection</span> </span>&#123;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onServiceConnected</span><span class="params">(ComponentName name, IBinder service)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">if</span> (DEBUG_SD_INSTALL) Log.i(TAG, <span class="string">"onServiceConnected"</span>);</span><br><span class="line">        <span class="comment">//【1】获得 DefaultContainerConnection 代理对象！</span></span><br><span class="line">        IMediaContainerService imcs =</span><br><span class="line">            IMediaContainerService.Stub.asInterface(service);</span><br><span class="line"></span><br><span class="line">        <span class="comment">//【5.3】发送 MCS_BOUND 消息！</span></span><br><span class="line">        mHandler.sendMessage(mHandler.obtainMessage(MCS_BOUND, imcs));</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onServiceDisconnected</span><span class="params">(ComponentName name)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">if</span> (DEBUG_SD_INSTALL) Log.i(TAG, <span class="string">"onServiceDisconnected"</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>最后会发送 MCS_BOUND 消息给 PackageHandler 对象！</p>
<h3 id="5-2-2-InstallParams-serviceError"><a href="#5-2-2-InstallParams-serviceError" class="headerlink" title="5.2.2 InstallParams.serviceError"></a>5.2.2 InstallParams.serviceError</h3><p>serviceError 方法是从 HandlerParams 中继承到的：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">final</span> <span class="keyword">void</span> <span class="title">serviceError</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    <span class="keyword">if</span> (DEBUG_INSTALL) Slog.i(TAG, <span class="string">"serviceError"</span>);</span><br><span class="line">    <span class="comment">//【5.4.2】安装异常，保存结果</span></span><br><span class="line">    handleServiceError();</span><br><span class="line">    <span class="comment">//【5.4.4】处理结果！</span></span><br><span class="line">    handleReturnCode();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>handleServiceError 方法和 handleReturnCode 方法的最终实现也是在 InstallParams 中！</p>
<h2 id="5-3-PackageHandler-doHandleMessage-MCS-BOUND-绑定服务"><a href="#5-3-PackageHandler-doHandleMessage-MCS-BOUND-绑定服务" class="headerlink" title="5.3 PackageHandler.doHandleMessage[MCS_BOUND] - 绑定服务"></a>5.3 PackageHandler.doHandleMessage[MCS_BOUND] - 绑定服务</h2><p>继续来看下 PackageHandler 对 MCS_BOUND 的处理：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">case</span> MCS_BOUND: &#123;</span><br><span class="line">    <span class="keyword">if</span> (DEBUG_INSTALL) Slog.i(TAG, <span class="string">"mcs_bound"</span>);</span><br><span class="line">    <span class="comment">//【1】这里的 msg.obj 是前面 bind 获得的代理对象，将其保存到 mContainerService 中！ </span></span><br><span class="line">    <span class="keyword">if</span> (msg.obj != <span class="keyword">null</span>) &#123;</span><br><span class="line">        mContainerService = (IMediaContainerService) msg.obj;</span><br><span class="line">        Trace.asyncTraceEnd(TRACE_TAG_PACKAGE_MANAGER, <span class="string">"bindingMCS"</span>,</span><br><span class="line">                System.identityHashCode(mHandler));</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">//【2】异常处理，如果 mContainerService 为 null，且 mBound 为 ture，那么这种情况是异常！</span></span><br><span class="line">    <span class="keyword">if</span> (mContainerService == <span class="keyword">null</span>) &#123;</span><br><span class="line">        <span class="keyword">if</span> (!mBound) &#123;</span><br><span class="line">            Slog.e(TAG, <span class="string">"Cannot bind to media container service"</span>);</span><br><span class="line">            </span><br><span class="line">            <span class="comment">//【2.1】遍历所有的 HandlerParams 安装参数，回调 serviceError！</span></span><br><span class="line">            <span class="keyword">for</span> (HandlerParams params : mPendingInstalls) &#123;</span><br><span class="line">                params.serviceError();</span><br><span class="line">                Trace.asyncTraceEnd(TRACE_TAG_PACKAGE_MANAGER, <span class="string">"queueInstall"</span>,</span><br><span class="line">                        System.identityHashCode(params));</span><br><span class="line">                <span class="keyword">if</span> (params.traceMethod != <span class="keyword">null</span>) &#123;</span><br><span class="line">                    Trace.asyncTraceEnd(TRACE_TAG_PACKAGE_MANAGER,</span><br><span class="line">                            params.traceMethod, params.traceCookie);</span><br><span class="line">                &#125;</span><br><span class="line">                <span class="keyword">return</span>;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="comment">//【2.2】清空 mPendingInstalls 集合！</span></span><br><span class="line">            mPendingInstalls.clear();</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            Slog.w(TAG, <span class="string">"Waiting to connect to media container service"</span>);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125; <span class="keyword">else</span> <span class="keyword">if</span> (mPendingInstalls.size() &gt; <span class="number">0</span>) &#123;</span><br><span class="line">        <span class="comment">//【3】正常情况下，bind 是有效的，那么会进入这里！</span></span><br><span class="line">        HandlerParams params = mPendingInstalls.get(<span class="number">0</span>);</span><br><span class="line">        <span class="keyword">if</span> (params != <span class="keyword">null</span>) &#123;</span><br><span class="line">            Trace.asyncTraceEnd(TRACE_TAG_PACKAGE_MANAGER, <span class="string">"queueInstall"</span>,</span><br><span class="line">                    System.identityHashCode(params));</span><br><span class="line">            Trace.traceBegin(TRACE_TAG_PACKAGE_MANAGER, <span class="string">"startCopy"</span>);</span><br><span class="line">            <span class="comment">//【5.4】调用了 HandlerParams 的 startCopy 方法！</span></span><br><span class="line">            <span class="keyword">if</span> (params.startCopy()) &#123;</span><br><span class="line">                <span class="comment">// We are done...  look for more work or to</span></span><br><span class="line">                <span class="comment">// go idle.</span></span><br><span class="line">                <span class="keyword">if</span> (DEBUG_SD_INSTALL) Log.i(TAG,</span><br><span class="line">                        <span class="string">"Checking for more work or unbind..."</span>);</span><br><span class="line">                <span class="comment">//【3.1】本次安装完成，删除本次处理的安装参数！</span></span><br><span class="line">                <span class="keyword">if</span> (mPendingInstalls.size() &gt; <span class="number">0</span>) &#123;</span><br><span class="line">                    mPendingInstalls.remove(<span class="number">0</span>);</span><br><span class="line">                &#125;</span><br><span class="line">                <span class="keyword">if</span> (mPendingInstalls.size() == <span class="number">0</span>) &#123;</span><br><span class="line">                    <span class="comment">//【3.2】如果所有的安装参数都处理玩了，unbind 服务！</span></span><br><span class="line">                    <span class="comment">// 这里的 unbind 延迟了 10s</span></span><br><span class="line">                    <span class="keyword">if</span> (mBound) &#123;</span><br><span class="line">                        <span class="keyword">if</span> (DEBUG_SD_INSTALL) Log.i(TAG,</span><br><span class="line">                                <span class="string">"Posting delayed MCS_UNBIND"</span>);</span><br><span class="line">                        removeMessages(MCS_UNBIND);</span><br><span class="line">                        Message ubmsg = obtainMessage(MCS_UNBIND);</span><br><span class="line">                        sendMessageDelayed(ubmsg, <span class="number">10000</span>);</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                    <span class="comment">//【3.3】在安装队列中有其他的安装项，我们发送 MCS_BOUND 消息继续处理！</span></span><br><span class="line">                    <span class="keyword">if</span> (DEBUG_SD_INSTALL) Log.i(TAG,</span><br><span class="line">                            <span class="string">"Posting MCS_BOUND for next work"</span>);</span><br><span class="line">                    mHandler.sendEmptyMessage(MCS_BOUND);</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">            Trace.traceEnd(TRACE_TAG_PACKAGE_MANAGER);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        <span class="comment">// Should never happen ideally.</span></span><br><span class="line">        Slog.w(TAG, <span class="string">"Empty queue"</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">break</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h2 id="5-4-InstallParams-startCopy"><a href="#5-4-InstallParams-startCopy" class="headerlink" title="5.4 InstallParams.startCopy"></a>5.4 InstallParams.startCopy</h2><p>InstallParams 继承了 HandlerParams：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">final</span> <span class="keyword">boolean</span> <span class="title">startCopy</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    <span class="keyword">boolean</span> res;</span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">        <span class="keyword">if</span> (DEBUG_INSTALL) Slog.i(TAG, <span class="string">"startCopy "</span> + mUser + <span class="string">": "</span> + <span class="keyword">this</span>);</span><br><span class="line">        <span class="comment">//【1】如果重试次数大于 4 ，那么就放弃本次安装！</span></span><br><span class="line">        <span class="keyword">if</span> (++mRetries &gt; MAX_RETRIES) &#123;</span><br><span class="line">            Slog.w(TAG, <span class="string">"Failed to invoke remote methods on default container service. Giving up"</span>);</span><br><span class="line">            <span class="comment">//【5.4.1】发送 MCS_GIVE_UP 消息！</span></span><br><span class="line">            mHandler.sendEmptyMessage(MCS_GIVE_UP);</span><br><span class="line">            <span class="comment">//【5.4.2】处理失败结果</span></span><br><span class="line">            handleServiceError();</span><br><span class="line">            <span class="keyword">return</span> <span class="keyword">false</span>;</span><br><span class="line"></span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            <span class="comment">//【5.5】继续安装！</span></span><br><span class="line">            handleStartCopy();</span><br><span class="line">            res = <span class="keyword">true</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125; <span class="keyword">catch</span> (RemoteException e) &#123;</span><br><span class="line">        <span class="keyword">if</span> (DEBUG_INSTALL) Slog.i(TAG, <span class="string">"Posting install MCS_RECONNECT"</span>);</span><br><span class="line">        <span class="comment">//【5.4.3】发送 MCS_RECONNECT 消息！</span></span><br><span class="line">        mHandler.sendEmptyMessage(MCS_RECONNECT);</span><br><span class="line">        res = <span class="keyword">false</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//【5.4.4】处理返回码！</span></span><br><span class="line">    handleReturnCode();</span><br><span class="line">    <span class="keyword">return</span> res;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>这里定义了安装尝试次数：<br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="keyword">int</span> MAX_RETRIES = <span class="number">4</span>;</span><br></pre></td></tr></table></figure></p>
<h3 id="5-4-1-PackageHandler-doHandleMessage-MCS-GIVE-UP-放弃安装"><a href="#5-4-1-PackageHandler-doHandleMessage-MCS-GIVE-UP-放弃安装" class="headerlink" title="5.4.1 PackageHandler.doHandleMessage[MCS_GIVE_UP] - 放弃安装"></a>5.4.1 PackageHandler.doHandleMessage[MCS_GIVE_UP] - 放弃安装</h3><p>重试次数大于 4 ，那么就放弃本次安装！</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">case</span> MCS_GIVE_UP: &#123;</span><br><span class="line">    <span class="keyword">if</span> (DEBUG_INSTALL) Slog.i(TAG, <span class="string">"mcs_giveup too many retries"</span>);</span><br><span class="line">    <span class="comment">//【1】移除这个安装参数。</span></span><br><span class="line">    HandlerParams params = mPendingInstalls.remove(<span class="number">0</span>);</span><br><span class="line">    Trace.asyncTraceEnd(TRACE_TAG_PACKAGE_MANAGER, <span class="string">"queueInstall"</span>,</span><br><span class="line">            System.identityHashCode(params));</span><br><span class="line">    <span class="keyword">break</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h3 id="5-4-2-InstallParams-handleServiceError"><a href="#5-4-2-InstallParams-handleServiceError" class="headerlink" title="5.4.2 InstallParams.handleServiceError"></a>5.4.2 InstallParams.handleServiceError</h3><p>处理本次安装失败的结果：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">handleServiceError</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    <span class="comment">//【5.2.3】创建安装参数 InstallArgs！</span></span><br><span class="line">    mArgs = createInstallArgs(<span class="keyword">this</span>);</span><br><span class="line">    mRet = PackageManager.INSTALL_FAILED_INTERNAL_ERROR;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>这里的 createInstallArgs 方法我们后面再分析！</p>
<h3 id="5-4-3-PackageHandler-doHandleMessage-MCS-RECONNECT-重连服务"><a href="#5-4-3-PackageHandler-doHandleMessage-MCS-RECONNECT-重连服务" class="headerlink" title="5.4.3 PackageHandler.doHandleMessage[MCS_RECONNECT] - 重连服务"></a>5.4.3 PackageHandler.doHandleMessage[MCS_RECONNECT] - 重连服务</h3><p>MCS_RECONNECT 消息会尝试重连服务！</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">case</span> MCS_RECONNECT: &#123;</span><br><span class="line">    <span class="keyword">if</span> (DEBUG_INSTALL) Slog.i(TAG, <span class="string">"mcs_reconnect"</span>);</span><br><span class="line">    <span class="keyword">if</span> (mPendingInstalls.size() &gt; <span class="number">0</span>) &#123;</span><br><span class="line">        <span class="comment">//【1】如果 mBound 为 true，先尝试断开连接！</span></span><br><span class="line">        <span class="keyword">if</span> (mBound) &#123;</span><br><span class="line">            disconnectService();</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">//【2】开始重新连接服务！</span></span><br><span class="line">        <span class="keyword">if</span> (!connectToService()) &#123;</span><br><span class="line">            Slog.e(TAG, <span class="string">"Failed to bind to media container service"</span>);</span><br><span class="line">            <span class="keyword">for</span> (HandlerParams params : mPendingInstalls) &#123;</span><br><span class="line">                <span class="comment">//【5.2.2】返回安装异常！</span></span><br><span class="line">                params.serviceError();</span><br><span class="line">                Trace.asyncTraceEnd(TRACE_TAG_PACKAGE_MANAGER, <span class="string">"queueInstall"</span>,</span><br><span class="line">                        System.identityHashCode(params));</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="comment">//【3】清空 mPendingInstalls 集合！</span></span><br><span class="line">            mPendingInstalls.clear();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">break</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>流程很简单，不多说了！</p>
<h3 id="5-4-4-InstallParams-handleReturnCode"><a href="#5-4-4-InstallParams-handleReturnCode" class="headerlink" title="5.4.4 InstallParams.handleReturnCode"></a>5.4.4 InstallParams.handleReturnCode</h3><p>当 mArgs 为 null 的时候，此时该 package 正在被校验，所以需要等到校验成功后才能安装，所以不会进入这里！</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">handleReturnCode</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    <span class="comment">//【1】如果 mArgs 这里为 null，可能是不需要校验！</span></span><br><span class="line">    <span class="keyword">if</span> (mArgs != <span class="keyword">null</span>) &#123;</span><br><span class="line">        <span class="comment">//【5.7】继续安装！</span></span><br><span class="line">        processPendingInstall(mArgs, mRet);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>我们继续看！</p>
<h2 id="5-5-InstallParams-handleStartCopy"><a href="#5-5-InstallParams-handleStartCopy" class="headerlink" title="5.5 InstallParams.handleStartCopy"></a>5.5 InstallParams.handleStartCopy</h2><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br><span class="line">212</span><br><span class="line">213</span><br><span class="line">214</span><br><span class="line">215</span><br><span class="line">216</span><br><span class="line">217</span><br><span class="line">218</span><br><span class="line">219</span><br><span class="line">220</span><br><span class="line">221</span><br><span class="line">222</span><br><span class="line">223</span><br><span class="line">224</span><br><span class="line">225</span><br><span class="line">226</span><br><span class="line">227</span><br><span class="line">228</span><br><span class="line">229</span><br><span class="line">230</span><br><span class="line">231</span><br><span class="line">232</span><br><span class="line">233</span><br><span class="line">234</span><br><span class="line">235</span><br><span class="line">236</span><br><span class="line">237</span><br><span class="line">238</span><br><span class="line">239</span><br><span class="line">240</span><br><span class="line">241</span><br><span class="line">242</span><br><span class="line">243</span><br><span class="line">244</span><br><span class="line">245</span><br><span class="line">246</span><br><span class="line">247</span><br><span class="line">248</span><br><span class="line">249</span><br><span class="line">250</span><br><span class="line">251</span><br><span class="line">252</span><br><span class="line">253</span><br><span class="line">254</span><br><span class="line">255</span><br><span class="line">256</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">handleStartCopy</span><span class="params">()</span> <span class="keyword">throws</span> RemoteException </span>&#123;</span><br><span class="line">    <span class="comment">//【1】保存安装结果，默认为成功！</span></span><br><span class="line">    <span class="keyword">int</span> ret = PackageManager.INSTALL_SUCCEEDED;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//【2】我们知道 origin 中存储了安装目录相关的信息！</span></span><br><span class="line">    <span class="keyword">if</span> (origin.staged) &#123;</span><br><span class="line">        <span class="keyword">if</span> (origin.file != <span class="keyword">null</span>) &#123;</span><br><span class="line">            <span class="comment">//【2.1】安装到内置存储中！</span></span><br><span class="line">            installFlags |= PackageManager.INSTALL_INTERNAL;</span><br><span class="line">            installFlags &amp;= ~PackageManager.INSTALL_EXTERNAL;</span><br><span class="line">        &#125; <span class="keyword">else</span> <span class="keyword">if</span> (origin.cid != <span class="keyword">null</span>) &#123;</span><br><span class="line">            <span class="comment">//【2.2】这里是安装到外置存储中的逻辑！</span></span><br><span class="line">            installFlags |= PackageManager.INSTALL_EXTERNAL;</span><br><span class="line">            installFlags &amp;= ~PackageManager.INSTALL_INTERNAL;</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> IllegalStateException(<span class="string">"Invalid stage location"</span>);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">//【3】判断安装位置！</span></span><br><span class="line">    <span class="keyword">final</span> <span class="keyword">boolean</span> onSd = (installFlags &amp; PackageManager.INSTALL_EXTERNAL) != <span class="number">0</span>;</span><br><span class="line">    <span class="keyword">final</span> <span class="keyword">boolean</span> onInt = (installFlags &amp; PackageManager.INSTALL_INTERNAL) != <span class="number">0</span>;</span><br><span class="line">    <span class="keyword">final</span> <span class="keyword">boolean</span> ephemeral = (installFlags &amp; PackageManager.INSTALL_EPHEMERAL) != <span class="number">0</span>;</span><br><span class="line">    PackageInfoLite pkgLite = <span class="keyword">null</span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//【4】判断安装位置是否满足条件！</span></span><br><span class="line">    <span class="keyword">if</span> (onInt &amp;&amp; onSd) &#123;</span><br><span class="line">        <span class="comment">//【4.1】不能同时设置安装在 sd 和内置中！</span></span><br><span class="line">        Slog.w(TAG, <span class="string">"Conflicting flags specified for installing on both internal and external"</span>);</span><br><span class="line">        ret = PackageManager.INSTALL_FAILED_INVALID_INSTALL_LOCATION;</span><br><span class="line">    &#125; <span class="keyword">else</span> <span class="keyword">if</span> (onSd &amp;&amp; ephemeral) &#123;</span><br><span class="line">        Slog.w(TAG,  <span class="string">"Conflicting flags specified for installing ephemeral on external"</span>);</span><br><span class="line">        <span class="comment">//【4.2】不能设置短暂安装在 sd 中！</span></span><br><span class="line">        ret = PackageManager.INSTALL_FAILED_INVALID_INSTALL_LOCATION;</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        <span class="comment">//【5.5.1】利用 ContainerService 获取 PackageInfoLite，同时判断空间是否合适！</span></span><br><span class="line">        pkgLite = mContainerService.getMinimalPackageInfo(origin.resolvedPath, installFlags,</span><br><span class="line">                packageAbiOverride);</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (DEBUG_EPHEMERAL &amp;&amp; ephemeral) &#123;</span><br><span class="line">            Slog.v(TAG, <span class="string">"pkgLite for install: "</span> + pkgLite);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment">//【4.3】空间不足，尝试释放空尽！</span></span><br><span class="line">        <span class="keyword">if</span> (!origin.staged &amp;&amp; pkgLite.recommendedInstallLocation</span><br><span class="line">                == PackageHelper.RECOMMEND_FAILED_INSUFFICIENT_STORAGE) &#123;</span><br><span class="line">            <span class="comment">// <span class="doctag">TODO:</span> focus freeing disk space on the target device</span></span><br><span class="line">            <span class="keyword">final</span> StorageManager storage = StorageManager.from(mContext);</span><br><span class="line">            <span class="keyword">final</span> <span class="keyword">long</span> lowThreshold = storage.getStorageLowBytes(</span><br><span class="line">                    Environment.getDataDirectory());</span><br><span class="line"></span><br><span class="line">            <span class="keyword">final</span> <span class="keyword">long</span> sizeBytes = mContainerService.calculateInstalledSize(</span><br><span class="line">                    origin.resolvedPath, isForwardLocked(), packageAbiOverride);</span><br><span class="line"></span><br><span class="line">            <span class="keyword">try</span> &#123;</span><br><span class="line">                <span class="comment">//【4.4】通过 installd 释放存储！</span></span><br><span class="line">                mInstaller.freeCache(<span class="keyword">null</span>, sizeBytes + lowThreshold);</span><br><span class="line">                <span class="comment">//【5.5.1】再次利用 ContainerService 获取 PackageInfoLite，同时判断空间是否合适！</span></span><br><span class="line">                pkgLite = mContainerService.getMinimalPackageInfo(origin.resolvedPath,</span><br><span class="line">                        installFlags, packageAbiOverride);</span><br><span class="line">            &#125; <span class="keyword">catch</span> (InstallerException e) &#123;</span><br><span class="line">                Slog.w(TAG, <span class="string">"Failed to free cache"</span>, e);</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            <span class="comment">//【4.5】依然无法安装，设置结果为 RECOMMEND_FAILED_INSUFFICIENT_STORAGE！</span></span><br><span class="line">            <span class="keyword">if</span> (pkgLite.recommendedInstallLocation</span><br><span class="line">                    == PackageHelper.RECOMMEND_FAILED_INVALID_URI) &#123;</span><br><span class="line">                pkgLite.recommendedInstallLocation</span><br><span class="line">                    = PackageHelper.RECOMMEND_FAILED_INSUFFICIENT_STORAGE;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">//【5】处理前面的空间判断后的结果！</span></span><br><span class="line">    <span class="keyword">if</span> (ret == PackageManager.INSTALL_SUCCEEDED) &#123;</span><br><span class="line">        <span class="keyword">int</span> loc = pkgLite.recommendedInstallLocation;</span><br><span class="line">        <span class="keyword">if</span> (loc == PackageHelper.RECOMMEND_FAILED_INVALID_LOCATION) &#123;</span><br><span class="line">            ret = PackageManager.INSTALL_FAILED_INVALID_INSTALL_LOCATION;</span><br><span class="line"></span><br><span class="line">        &#125; <span class="keyword">else</span> <span class="keyword">if</span> (loc == PackageHelper.RECOMMEND_FAILED_ALREADY_EXISTS) &#123;</span><br><span class="line">            ret = PackageManager.INSTALL_FAILED_ALREADY_EXISTS;</span><br><span class="line"></span><br><span class="line">        &#125; <span class="keyword">else</span> <span class="keyword">if</span> (loc == PackageHelper.RECOMMEND_FAILED_INSUFFICIENT_STORAGE) &#123;</span><br><span class="line">            ret = PackageManager.INSTALL_FAILED_INSUFFICIENT_STORAGE;</span><br><span class="line"></span><br><span class="line">        &#125; <span class="keyword">else</span> <span class="keyword">if</span> (loc == PackageHelper.RECOMMEND_FAILED_INVALID_APK) &#123;</span><br><span class="line">            ret = PackageManager.INSTALL_FAILED_INVALID_APK;</span><br><span class="line"></span><br><span class="line">        &#125; <span class="keyword">else</span> <span class="keyword">if</span> (loc == PackageHelper.RECOMMEND_FAILED_INVALID_URI) &#123;</span><br><span class="line">            ret = PackageManager.INSTALL_FAILED_INVALID_URI;</span><br><span class="line"></span><br><span class="line">        &#125; <span class="keyword">else</span> <span class="keyword">if</span> (loc == PackageHelper.RECOMMEND_MEDIA_UNAVAILABLE) &#123;</span><br><span class="line">            ret = PackageManager.INSTALL_FAILED_MEDIA_UNAVAILABLE;</span><br><span class="line"></span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            <span class="comment">//【5.5.2】调用 installLocationPolicy 方法，针对于降级安装和替换安装做处理！</span></span><br><span class="line">            loc = installLocationPolicy(pkgLite);</span><br><span class="line">            <span class="keyword">if</span> (loc == PackageHelper.RECOMMEND_FAILED_VERSION_DOWNGRADE) &#123;</span><br><span class="line">                <span class="comment">// 处理无法降级的结果！</span></span><br><span class="line">                ret = PackageManager.INSTALL_FAILED_VERSION_DOWNGRADE;</span><br><span class="line"></span><br><span class="line">            &#125; <span class="keyword">else</span> <span class="keyword">if</span> (!onSd &amp;&amp; !onInt) &#123;</span><br><span class="line">                <span class="comment">// 如果 flags 没有指定内置还是外置，那么由 installLocationPolicy 的返回值指定！</span></span><br><span class="line">                <span class="keyword">if</span> (loc == PackageHelper.RECOMMEND_INSTALL_EXTERNAL) &#123;</span><br><span class="line">                    installFlags |= PackageManager.INSTALL_EXTERNAL; <span class="comment">// 外置</span></span><br><span class="line">                    installFlags &amp;= ~PackageManager.INSTALL_INTERNAL;</span><br><span class="line"></span><br><span class="line">                &#125; <span class="keyword">else</span> <span class="keyword">if</span> (loc == PackageHelper.RECOMMEND_INSTALL_EPHEMERAL) &#123;</span><br><span class="line">                    <span class="keyword">if</span> (DEBUG_EPHEMERAL) &#123;</span><br><span class="line">                        Slog.v(TAG, <span class="string">"...setting INSTALL_EPHEMERAL install flag"</span>);</span><br><span class="line">                    &#125;</span><br><span class="line">                    installFlags |= PackageManager.INSTALL_EPHEMERAL; <span class="comment">// 内置并且是短暂安装！</span></span><br><span class="line">                    installFlags &amp;= ~(PackageManager.INSTALL_EXTERNAL</span><br><span class="line">                            |PackageManager.INSTALL_INTERNAL);</span><br><span class="line">                &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                    installFlags |= PackageManager.INSTALL_INTERNAL; <span class="comment">// 内置</span></span><br><span class="line">                    installFlags &amp;= ~PackageManager.INSTALL_EXTERNAL;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">//【5.5.3】创建一个 InstallArgs 对象，和 InstallParams 相互引用！</span></span><br><span class="line">    <span class="keyword">final</span> InstallArgs args = createInstallArgs(<span class="keyword">this</span>);</span><br><span class="line">    mArgs = args;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (ret == PackageManager.INSTALL_SUCCEEDED) &#123;</span><br><span class="line">        <span class="comment">// <span class="doctag">TODO:</span> http://b/22976637</span></span><br><span class="line">        <span class="comment">//【6】如果该应用是安装给 all users 的，那么需要校验应用！</span></span><br><span class="line">        UserHandle verifierUser = getUser();</span><br><span class="line">        <span class="keyword">if</span> (verifierUser == UserHandle.ALL) &#123;</span><br><span class="line">            verifierUser = UserHandle.SYSTEM;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment">//【7】尝试找到系统中安装的 pacakge 校验器，如果可以找到，那就要做校验啦！</span></span><br><span class="line">        <span class="comment">//【7.1】获得校验器的 uid！</span></span><br><span class="line">        <span class="keyword">final</span> <span class="keyword">int</span> requiredUid = mRequiredVerifierPackage == <span class="keyword">null</span> ? -<span class="number">1</span></span><br><span class="line">                : getPackageUid(mRequiredVerifierPackage, MATCH_DEBUG_TRIAGED_MISSING,</span><br><span class="line">                        verifierUser.getIdentifier());</span><br><span class="line">        <span class="comment">//【7.1】如果是安装到内置存储（existing 为 true），并且系统中有校验器，并且系统打开了校验功能，那么就尝试校验！</span></span><br><span class="line">        <span class="comment">//【5.5.4】通过 isVerificationEnabled 判断是否打开校验功能！</span></span><br><span class="line">        <span class="keyword">if</span> (!origin.existing &amp;&amp; requiredUid != -<span class="number">1</span></span><br><span class="line">                &amp;&amp; isVerificationEnabled(verifierUser.getIdentifier(), installFlags)) &#123;</span><br><span class="line"></span><br><span class="line">            <span class="comment">//【7.1.1】准备发送校验广播</span></span><br><span class="line">            <span class="keyword">final</span> Intent verification = <span class="keyword">new</span> Intent(</span><br><span class="line">                    Intent.ACTION_PACKAGE_NEEDS_VERIFICATION);</span><br><span class="line">            verification.addFlags(Intent.FLAG_RECEIVER_FOREGROUND);</span><br><span class="line">            verification.setDataAndType(Uri.fromFile(<span class="keyword">new</span> File(origin.resolvedPath)),</span><br><span class="line">                    PACKAGE_MIME_TYPE); <span class="comment">// 设置 DataAndType 属性，包含了 apk 路径对应的 uri</span></span><br><span class="line">            verification.addFlags(Intent.FLAG_GRANT_READ_URI_PERMISSION); <span class="comment">// 增加了临时的权限授予！</span></span><br><span class="line"></span><br><span class="line">            <span class="comment">//【7.1.2】查询校验器！</span></span><br><span class="line">            <span class="keyword">final</span> List&lt;ResolveInfo&gt; receivers = queryIntentReceiversInternal(verification,</span><br><span class="line">                    PACKAGE_MIME_TYPE, <span class="number">0</span>, verifierUser.getIdentifier());</span><br><span class="line"></span><br><span class="line">            <span class="keyword">if</span> (DEBUG_VERIFY) &#123;</span><br><span class="line">                Slog.d(TAG, <span class="string">"Found "</span> + receivers.size() + <span class="string">" verifiers for intent "</span></span><br><span class="line">                        + verification.toString() + <span class="string">" with "</span> + pkgLite.verifiers.length</span><br><span class="line">                        + <span class="string">" optional verifiers"</span>);</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            <span class="keyword">final</span> <span class="keyword">int</span> verificationId = mPendingVerificationToken++; <span class="comment">// 计算本次校验的唯一标识 token</span></span><br><span class="line">            verification.putExtra(PackageManager.EXTRA_VERIFICATION_ID, verificationId);</span><br><span class="line">            verification.putExtra(PackageManager.EXTRA_VERIFICATION_INSTALLER_PACKAGE,</span><br><span class="line">                    installerPackageName); <span class="comment">// 安装器（packageInstaller）</span></span><br><span class="line">            verification.putExtra(PackageManager.EXTRA_VERIFICATION_INSTALL_FLAGS,</span><br><span class="line">                    installFlags); <span class="comment">// 本次安装的 installFlags</span></span><br><span class="line">            verification.putExtra(PackageManager.EXTRA_VERIFICATION_PACKAGE_NAME,</span><br><span class="line">                    pkgLite.packageName); <span class="comment">// 要校验的应用</span></span><br><span class="line">            verification.putExtra(PackageManager.EXTRA_VERIFICATION_VERSION_CODE,</span><br><span class="line">                    pkgLite.versionCode); <span class="comment">// 版本号</span></span><br><span class="line">          </span><br><span class="line">            <span class="keyword">if</span> (verificationInfo != <span class="keyword">null</span>) &#123; <span class="comment">// 如果指定了校验信息，将其写入 intent！</span></span><br><span class="line">                <span class="keyword">if</span> (verificationInfo.originatingUri != <span class="keyword">null</span>) &#123;</span><br><span class="line">                    verification.putExtra(Intent.EXTRA_ORIGINATING_URI,</span><br><span class="line">                            verificationInfo.originatingUri);</span><br><span class="line">                &#125;</span><br><span class="line">                <span class="keyword">if</span> (verificationInfo.referrer != <span class="keyword">null</span>) &#123;</span><br><span class="line">                    verification.putExtra(Intent.EXTRA_REFERRER,</span><br><span class="line">                            verificationInfo.referrer);</span><br><span class="line">                &#125;</span><br><span class="line">                <span class="keyword">if</span> (verificationInfo.originatingUid &gt;= <span class="number">0</span>) &#123;</span><br><span class="line">                    verification.putExtra(Intent.EXTRA_ORIGINATING_UID,</span><br><span class="line">                            verificationInfo.originatingUid);</span><br><span class="line">                &#125;</span><br><span class="line">                <span class="keyword">if</span> (verificationInfo.installerUid &gt;= <span class="number">0</span>) &#123;</span><br><span class="line">                    verification.putExtra(PackageManager.EXTRA_VERIFICATION_INSTALLER_UID,</span><br><span class="line">                            verificationInfo.installerUid);</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            <span class="comment">//【5.5.5】创建一个 PackageVerificationState 对象，用于保存应用校验状态，同时将创建的</span></span><br><span class="line">            <span class="comment">// installArgs 作为参数传入，并加入 mPendingVerification 集合中！！</span></span><br><span class="line">            <span class="keyword">final</span> PackageVerificationState verificationState = <span class="keyword">new</span> PackageVerificationState(</span><br><span class="line">                    requiredUid, args);</span><br><span class="line">            mPendingVerification.append(verificationId, verificationState);</span><br><span class="line"></span><br><span class="line">            <span class="comment">//【7.1.3】如果应用指定了校验者，那么我们要尝试先用指定的校验器校验！</span></span><br><span class="line">            <span class="keyword">final</span> List&lt;ComponentName&gt; sufficientVerifiers = matchVerifiers(pkgLite,</span><br><span class="line">                    receivers, verificationState);</span><br><span class="line">            <span class="keyword">if</span> (sufficientVerifiers != <span class="keyword">null</span>) &#123;</span><br><span class="line">                <span class="keyword">final</span> <span class="keyword">int</span> N = sufficientVerifiers.size();</span><br><span class="line">                <span class="keyword">if</span> (N == <span class="number">0</span>) &#123;</span><br><span class="line">                    Slog.i(TAG, <span class="string">"Additional verifiers required, but none installed."</span>);</span><br><span class="line">                    ret = PackageManager.INSTALL_FAILED_VERIFICATION_FAILURE;</span><br><span class="line">                &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                    <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; N; i++) &#123;</span><br><span class="line">                        <span class="keyword">final</span> ComponentName verifierComponent = sufficientVerifiers.get(i);</span><br><span class="line">                        <span class="comment">// 使用前面创建的 verification 意图，再创建一个 intent！</span></span><br><span class="line">                        <span class="comment">// 指定组件为应用指定的校验器，并发送广播！</span></span><br><span class="line">                        <span class="keyword">final</span> Intent sufficientIntent = <span class="keyword">new</span> Intent(verification);</span><br><span class="line">                        sufficientIntent.setComponent(verifierComponent);</span><br><span class="line">                        mContext.sendBroadcastAsUser(sufficientIntent, verifierUser);</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="comment">//【7.1.4】找到和 mRequiredVerifierPackage（系统指定的默认校验器）匹配的接收者！</span></span><br><span class="line">            <span class="keyword">final</span> ComponentName requiredVerifierComponent = matchComponentForVerifier(</span><br><span class="line">                    mRequiredVerifierPackage, receivers);</span><br><span class="line"></span><br><span class="line">            <span class="keyword">if</span> (ret == PackageManager.INSTALL_SUCCEEDED</span><br><span class="line">                    &amp;&amp; mRequiredVerifierPackage != <span class="keyword">null</span>) &#123;</span><br><span class="line">                Trace.asyncTraceBegin(</span><br><span class="line">                        TRACE_TAG_PACKAGE_MANAGER, <span class="string">"verification"</span>, verificationId);</span><br><span class="line">                <span class="comment">//【7.1.5】指定目标应用为 mRequiredVerifierPackage 的内部组件！</span></span><br><span class="line">                <span class="comment">// 发送 verification 意图！</span></span><br><span class="line">                verification.setComponent(requiredVerifierComponent);</span><br><span class="line">                mContext.sendOrderedBroadcastAsUser(verification, verifierUser,</span><br><span class="line">                        android.Manifest.permission.PACKAGE_VERIFICATION_AGENT,</span><br><span class="line">                        <span class="keyword">new</span> BroadcastReceiver() &#123;</span><br><span class="line">                            <span class="meta">@Override</span></span><br><span class="line">                            <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onReceive</span><span class="params">(Context context, Intent intent)</span> </span>&#123;</span><br><span class="line">                                <span class="comment">//【7.1.6】当 mRequiredVerifierPackage 接收到广播后，会回调</span></span><br><span class="line">                                <span class="comment">// 该 BroadcastReceiver 的 onReceive 方法！</span></span><br><span class="line">                                <span class="comment">//【5.6】此时校验完成，这里会发送 CHECK_PENDING_VERIFICATION 给 PackageHandler</span></span><br><span class="line">                                <span class="comment">// 携带校验标识符！</span></span><br><span class="line">                                <span class="keyword">final</span> Message msg = mHandler</span><br><span class="line">                                        .obtainMessage(CHECK_PENDING_VERIFICATION);</span><br><span class="line">                                msg.arg1 = verificationId;</span><br><span class="line">                                mHandler.sendMessageDelayed(msg, getVerificationTimeout());</span><br><span class="line">                            &#125;</span><br><span class="line">                        &#125;, <span class="keyword">null</span>, <span class="number">0</span>, <span class="keyword">null</span>, <span class="keyword">null</span>);</span><br><span class="line"></span><br><span class="line">                <span class="comment">/*</span></span><br><span class="line"><span class="comment">                 * We don't want the copy to proceed until verification</span></span><br><span class="line"><span class="comment">                 * succeeds, so null out this field.</span></span><br><span class="line"><span class="comment">                 */</span></span><br><span class="line">                mArgs = <span class="keyword">null</span>;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            <span class="comment">//【5.7】没有合适的校验器，那么会调用 InstallArgs 的 copyApk 方法！</span></span><br><span class="line">            ret = args.copyApk(mContainerService, <span class="keyword">true</span>);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    mRet = ret;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>直接可以看到，最终</p>
<h3 id="5-5-1-DefaultContainerService-getMinimalPackageInfo"><a href="#5-5-1-DefaultContainerService-getMinimalPackageInfo" class="headerlink" title="5.5.1 DefaultContainerService.getMinimalPackageInfo"></a>5.5.1 DefaultContainerService.getMinimalPackageInfo</h3><p>getMinimalPackageInfo 方法会解析 apk，返回 apk 的解析信息，同时判断空间状态！</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> PackageInfoLite <span class="title">getMinimalPackageInfo</span><span class="params">(String packagePath, <span class="keyword">int</span> flags,</span></span></span><br><span class="line"><span class="function"><span class="params">        String abiOverride)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">final</span> Context context = DefaultContainerService.<span class="keyword">this</span>;</span><br><span class="line">    <span class="keyword">final</span> <span class="keyword">boolean</span> isForwardLocked = (flags &amp; PackageManager.INSTALL_FORWARD_LOCK) != <span class="number">0</span>;</span><br><span class="line">    <span class="comment">//【5.5.1.1】创建了一个 PackageInfoLite 实例！</span></span><br><span class="line">    PackageInfoLite ret = <span class="keyword">new</span> PackageInfoLite();</span><br><span class="line">    <span class="keyword">if</span> (packagePath == <span class="keyword">null</span>) &#123;</span><br><span class="line">        Slog.i(TAG, <span class="string">"Invalid package file "</span> + packagePath);</span><br><span class="line">        ret.recommendedInstallLocation = PackageHelper.RECOMMEND_FAILED_INVALID_APK; <span class="comment">// 该 apk 无效</span></span><br><span class="line">        <span class="keyword">return</span> ret;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">final</span> File packageFile = <span class="keyword">new</span> File(packagePath);</span><br><span class="line">    <span class="keyword">final</span> PackageParser.PackageLite pkg;</span><br><span class="line">    <span class="keyword">final</span> <span class="keyword">long</span> sizeBytes;</span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">        <span class="comment">//【2】解析 apk，获得其 PackageLite 对象，并计算安装所需空间！</span></span><br><span class="line">        pkg = PackageParser.parsePackageLite(packageFile, <span class="number">0</span>);</span><br><span class="line">        sizeBytes = PackageHelper.calculateInstalledSize(pkg, isForwardLocked, abiOverride);</span><br><span class="line">    &#125; <span class="keyword">catch</span> (PackageParserException | IOException e) &#123;</span><br><span class="line">        Slog.w(TAG, <span class="string">"Failed to parse package at "</span> + packagePath + <span class="string">": "</span> + e);</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (!packageFile.exists()) &#123;</span><br><span class="line">            ret.recommendedInstallLocation = PackageHelper.RECOMMEND_FAILED_INVALID_URI; <span class="comment">// 该 apk 无效</span></span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            ret.recommendedInstallLocation = PackageHelper.RECOMMEND_FAILED_INVALID_APK; <span class="comment">// 该 apk 无效</span></span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> ret;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">//【3】将解析到的参数保存到 PackageInfoLite 中！</span></span><br><span class="line">    ret.packageName = pkg.packageName;</span><br><span class="line">    ret.splitNames = pkg.splitNames;</span><br><span class="line">    ret.versionCode = pkg.versionCode;</span><br><span class="line">    ret.baseRevisionCode = pkg.baseRevisionCode;</span><br><span class="line">    ret.splitRevisionCodes = pkg.splitRevisionCodes;</span><br><span class="line">    ret.installLocation = pkg.installLocation;</span><br><span class="line">    ret.verifiers = pkg.verifiers;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">//【5.5.1.2】解析安装位置状态信息！</span></span><br><span class="line">    ret.recommendedInstallLocation = PackageHelper.resolveInstallLocation(context,</span><br><span class="line">            pkg.packageName, pkg.installLocation, sizeBytes, flags);</span><br><span class="line">    ret.multiArch = pkg.multiArch;</span><br><span class="line">    <span class="comment">//【4】返回该 PackageInfoLite 实例！</span></span><br><span class="line">    <span class="keyword">return</span> ret;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h4 id="5-5-1-1-new-PackageInfoLite"><a href="#5-5-1-1-new-PackageInfoLite" class="headerlink" title="5.5.1.1 new PackageInfoLite"></a>5.5.1.1 new PackageInfoLite</h4><p>PackageInfoLite 用来保存解析到的 apk 的一些信息！</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">PackageInfoLite</span> <span class="keyword">implements</span> <span class="title">Parcelable</span> </span>&#123;</span><br><span class="line">    <span class="keyword">public</span> String packageName; <span class="comment">// 应用包名；</span></span><br><span class="line">    <span class="keyword">public</span> String[] splitNames; <span class="comment">// split apk 的名字</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">int</span> versionCode; <span class="comment">// 版本号</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">int</span> baseRevisionCode;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">int</span>[] splitRevisionCodes;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * The android:multiArch flag from the package manifest. If set,</span></span><br><span class="line"><span class="comment">     * we will extract all native libraries for the given app, not just those</span></span><br><span class="line"><span class="comment">     * from the preferred ABI.</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">boolean</span> multiArch; </span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">int</span> recommendedInstallLocation;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">int</span> installLocation;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> VerifierInfo[] verifiers;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="title">PackageInfoLite</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    &#125;</span><br><span class="line">    ... ... ...</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>这里的 recommendedInstallLocation 可以取下面四个值：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">PackageHelper.RECOMMEND_INSTALL_INTERNAL <span class="comment">// 内置</span></span><br><span class="line">PackageHelper.RECOMMEND_INSTALL_EXTERNAL <span class="comment">// 外置</span></span><br><span class="line">PackageHelper.RECOMMEND_FAILED_INSUFFICIENT_STORAGE <span class="comment">// 存储异常</span></span><br><span class="line">PackageHelper.RECOMMEND_FAILED_INVALID_APK <span class="comment">// apk解析异常</span></span><br></pre></td></tr></table></figure>
<h4 id="5-5-1-2-PackageHelper-resolveInstallLocation"><a href="#5-5-1-2-PackageHelper-resolveInstallLocation" class="headerlink" title="5.5.1.2 PackageHelper.resolveInstallLocation"></a>5.5.1.2 PackageHelper.resolveInstallLocation</h4><p>resolveInstallLocation 方法用于计算一个合适的安装位置给 apk！<br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">int</span> <span class="title">resolveInstallLocation</span><span class="params">(Context context, String packageName,</span></span></span><br><span class="line"><span class="function"><span class="params">        <span class="keyword">int</span> installLocation, <span class="keyword">long</span> sizeBytes, <span class="keyword">int</span> installFlags)</span> </span>&#123;</span><br><span class="line">    <span class="comment">//【1】如果该应用已经安装了，那么我们获得上一次安装后的信息！！</span></span><br><span class="line">    ApplicationInfo existingInfo = <span class="keyword">null</span>;</span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">        existingInfo = context.getPackageManager().getApplicationInfo(packageName,</span><br><span class="line">                PackageManager.GET_UNINSTALLED_PACKAGES);</span><br><span class="line">    &#125; <span class="keyword">catch</span> (NameNotFoundException ignored) &#123;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">final</span> <span class="keyword">int</span> prefer;</span><br><span class="line">    <span class="keyword">final</span> <span class="keyword">boolean</span> checkBoth;</span><br><span class="line">    <span class="keyword">boolean</span> ephemeral = <span class="keyword">false</span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//【2】根据安装参数 installFlags，来选择合适的安装位置，按照优先级依次解析！</span></span><br><span class="line">    <span class="keyword">if</span> ((installFlags &amp; PackageManager.INSTALL_EPHEMERAL) != <span class="number">0</span>) &#123;</span><br><span class="line">        <span class="comment">//【2.1】如果指定了 PackageManager.INSTALL_EPHEMERAL，优先内置！</span></span><br><span class="line">        prefer = RECOMMEND_INSTALL_INTERNAL;</span><br><span class="line">        ephemeral = <span class="keyword">true</span>; <span class="comment">// 表示短暂安装！</span></span><br><span class="line">        checkBoth = <span class="keyword">false</span>;</span><br><span class="line">        </span><br><span class="line">    &#125; <span class="keyword">else</span> <span class="keyword">if</span> ((installFlags &amp; PackageManager.INSTALL_INTERNAL) != <span class="number">0</span>) &#123;</span><br><span class="line">        <span class="comment">//【2.2】如果指定了 PackageManager.INSTALL_INTERNAL，优先内置！</span></span><br><span class="line">        prefer = RECOMMEND_INSTALL_INTERNAL;</span><br><span class="line">        checkBoth = <span class="keyword">false</span>;</span><br><span class="line">        </span><br><span class="line">    &#125; <span class="keyword">else</span> <span class="keyword">if</span> ((installFlags &amp; PackageManager.INSTALL_EXTERNAL) != <span class="number">0</span>) &#123;</span><br><span class="line">        <span class="comment">//【2.3】如果指定了 PackageManager.INSTALL_EXTERNAL，优先外置！</span></span><br><span class="line">        prefer = RECOMMEND_INSTALL_EXTERNAL;</span><br><span class="line">        checkBoth = <span class="keyword">false</span>;</span><br><span class="line">        </span><br><span class="line">    &#125; <span class="keyword">else</span> <span class="keyword">if</span> (installLocation == PackageInfo.INSTALL_LOCATION_INTERNAL_ONLY) &#123;</span><br><span class="line">        <span class="comment">//【2.4】如果指定了 PackageManager.INSTALL_LOCATION_INTERNAL_ONLY，优先内置！</span></span><br><span class="line">        prefer = RECOMMEND_INSTALL_INTERNAL;</span><br><span class="line">        checkBoth = <span class="keyword">false</span>;</span><br><span class="line">        </span><br><span class="line">    &#125; <span class="keyword">else</span> <span class="keyword">if</span> (installLocation == PackageInfo.INSTALL_LOCATION_PREFER_EXTERNAL) &#123;</span><br><span class="line">        <span class="comment">//【2.5】如果指定了 PackageManager.INSTALL_LOCATION_PREFER_EXTERNAL，优先外置！</span></span><br><span class="line">        prefer = RECOMMEND_INSTALL_EXTERNAL;</span><br><span class="line">        checkBoth = <span class="keyword">true</span>;</span><br><span class="line">        </span><br><span class="line">    &#125; <span class="keyword">else</span> <span class="keyword">if</span> (installLocation == PackageInfo.INSTALL_LOCATION_AUTO) &#123;</span><br><span class="line">        <span class="comment">//【2.6】如果指定了 PackageManager.INSTALL_LOCATION_AUTO，那么我们自动调整！</span></span><br><span class="line">        <span class="keyword">if</span> (existingInfo != <span class="keyword">null</span>) &#123;</span><br><span class="line">            <span class="comment">//【2.6.1】如果之前已经安装过该应用，那么就和之前安装的位置保持一致！</span></span><br><span class="line">            <span class="keyword">if</span> ((existingInfo.flags &amp; ApplicationInfo.FLAG_EXTERNAL_STORAGE) != <span class="number">0</span>) &#123;</span><br><span class="line">                prefer = RECOMMEND_INSTALL_EXTERNAL;</span><br><span class="line">            &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                prefer = RECOMMEND_INSTALL_INTERNAL;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            <span class="comment">//【2.6.2】否则，自动安装到内置！</span></span><br><span class="line">            prefer = RECOMMEND_INSTALL_INTERNAL;</span><br><span class="line">        &#125;</span><br><span class="line">        checkBoth = <span class="keyword">true</span>;</span><br><span class="line">        </span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        <span class="comment">//【2.7】其他情况，默认是内置！</span></span><br><span class="line">        prefer = RECOMMEND_INSTALL_INTERNAL;</span><br><span class="line">        checkBoth = <span class="keyword">false</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//【3】再次校验内置和外置是否合适！</span></span><br><span class="line">    <span class="keyword">boolean</span> fitsOnInternal = <span class="keyword">false</span>;</span><br><span class="line">    <span class="keyword">if</span> (checkBoth || prefer == RECOMMEND_INSTALL_INTERNAL) &#123;</span><br><span class="line">        fitsOnInternal = fitsOnInternal(context, sizeBytes);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">boolean</span> fitsOnExternal = <span class="keyword">false</span>;</span><br><span class="line">    <span class="keyword">if</span> (checkBoth || prefer == RECOMMEND_INSTALL_EXTERNAL) &#123;</span><br><span class="line">        fitsOnExternal = fitsOnExternal(context, sizeBytes);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">//【4】最后，返回合适的安装位置！</span></span><br><span class="line">    <span class="keyword">if</span> (prefer == RECOMMEND_INSTALL_INTERNAL) &#123;</span><br><span class="line">        <span class="comment">//【4.1】如果优先安装到内置，且内置存储是合适的，根据是否是 ephemeral 返回不同的值！</span></span><br><span class="line">        <span class="keyword">if</span> (fitsOnInternal) &#123;</span><br><span class="line">            <span class="keyword">return</span> (ephemeral)</span><br><span class="line">                    ? PackageHelper.RECOMMEND_INSTALL_EPHEMERAL</span><br><span class="line">                    : PackageHelper.RECOMMEND_INSTALL_INTERNAL;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125; <span class="keyword">else</span> <span class="keyword">if</span> (prefer == RECOMMEND_INSTALL_EXTERNAL) &#123;</span><br><span class="line">        <span class="comment">//【4.2】如果优先安装到外置，且外置存储是合适的，返回结果！</span></span><br><span class="line">        <span class="keyword">if</span> (fitsOnExternal) &#123;</span><br><span class="line">            <span class="keyword">return</span> PackageHelper.RECOMMEND_INSTALL_EXTERNAL;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">//【4.3】其他情况！</span></span><br><span class="line">    <span class="keyword">if</span> (checkBoth) &#123;</span><br><span class="line">        <span class="keyword">if</span> (fitsOnInternal) &#123;</span><br><span class="line">            <span class="keyword">return</span> PackageHelper.RECOMMEND_INSTALL_INTERNAL;</span><br><span class="line">        &#125; <span class="keyword">else</span> <span class="keyword">if</span> (fitsOnExternal) &#123;</span><br><span class="line">            <span class="keyword">return</span> PackageHelper.RECOMMEND_INSTALL_EXTERNAL;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">//【5】异常情况，返回 PackageHelper.RECOMMEND_FAILED_INSUFFICIENT_STORAGE！</span></span><br><span class="line">    <span class="keyword">return</span> PackageHelper.RECOMMEND_FAILED_INSUFFICIENT_STORAGE;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>整个过程很简单，不多说了！</p>
<h3 id="5-5-2-PackageManagerS-installLocationPolicy"><a href="#5-5-2-PackageManagerS-installLocationPolicy" class="headerlink" title="5.5.2 PackageManagerS.installLocationPolicy"></a>5.5.2 PackageManagerS.installLocationPolicy</h3><p>PackageInfoLite pkgLite 保存了本次要安装的应用的信息！</p>
<p>installLocationPolicy 方法会对降级安装和替换安装做一个校验和判断！</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">int</span> <span class="title">installLocationPolicy</span><span class="params">(PackageInfoLite pkgLite)</span> </span>&#123;</span><br><span class="line">    String packageName = pkgLite.packageName;</span><br><span class="line">    <span class="keyword">int</span> installLocation = pkgLite.installLocation;</span><br><span class="line">    <span class="keyword">boolean</span> onSd = (installFlags &amp; PackageManager.INSTALL_EXTERNAL) != <span class="number">0</span>;</span><br><span class="line">    <span class="keyword">synchronized</span> (mPackages) &#123;</span><br><span class="line">        <span class="comment">//【1】如果该应用已经安装过的话，那就获得上次安装后的解析信息！</span></span><br><span class="line">        PackageParser.Package installedPkg = mPackages.get(packageName);</span><br><span class="line">        <span class="comment">// 下面这段代码主要是处理卸载但是保留了数据的情况，比如 adb uninstall -k！</span></span><br><span class="line">        PackageParser.Package dataOwnerPkg = installedPkg;</span><br><span class="line">        <span class="keyword">if</span> (dataOwnerPkg  == <span class="keyword">null</span>) &#123;</span><br><span class="line">            PackageSetting ps = mSettings.mPackages.get(packageName);</span><br><span class="line">            <span class="keyword">if</span> (ps != <span class="keyword">null</span>) &#123;</span><br><span class="line">                dataOwnerPkg = ps.pkg;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">//【2】如果 dataOwnerPkg 不为 nulkl，说明之前已经安装了！</span></span><br><span class="line">        <span class="keyword">if</span> (dataOwnerPkg != <span class="keyword">null</span>) &#123;</span><br><span class="line">            <span class="comment">//【2.1】如果安装标志位设置了 INSTALL_ALLOW_DOWNGRADE，表示允许降级安装！</span></span><br><span class="line">            <span class="keyword">final</span> <span class="keyword">boolean</span> downgradeRequested =</span><br><span class="line">                    (installFlags &amp; PackageManager.INSTALL_ALLOW_DOWNGRADE) != <span class="number">0</span>;</span><br><span class="line">            <span class="comment">//【2.2】判断应用是否允许 debug！</span></span><br><span class="line">            <span class="keyword">final</span> <span class="keyword">boolean</span> packageDebuggable =</span><br><span class="line">                        (dataOwnerPkg.applicationInfo.flags</span><br><span class="line">                                &amp; ApplicationInfo.FLAG_DEBUGGABLE) != <span class="number">0</span>;</span><br><span class="line">            <span class="comment">//【2.3】如果要能够降级安装，必须满足 2 个条件：1、安装标志位设置了 allow downgrade</span></span><br><span class="line">            <span class="comment">// 2、系统允许 debug 或者该应用可以 debug！</span></span><br><span class="line">            <span class="keyword">final</span> <span class="keyword">boolean</span> downgradePermitted =</span><br><span class="line">                    (downgradeRequested) &amp;&amp; ((Build.IS_DEBUGGABLE) || (packageDebuggable));</span><br><span class="line">            <span class="keyword">if</span> (!downgradePermitted) &#123;</span><br><span class="line">                <span class="keyword">try</span> &#123;</span><br><span class="line">                    <span class="comment">//【5.5.2.1】如果，安装不允许降级，那就需要做检查！</span></span><br><span class="line">                    checkDowngrade(dataOwnerPkg, pkgLite);</span><br><span class="line">                &#125; <span class="keyword">catch</span> (PackageManagerException e) &#123;</span><br><span class="line">                    Slog.w(TAG, <span class="string">"Downgrade detected: "</span> + e.getMessage());</span><br><span class="line">                    <span class="keyword">return</span> PackageHelper.RECOMMEND_FAILED_VERSION_DOWNGRADE;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">//【3】接着处理覆盖安装的情况，即相同包名的应用已经存在！</span></span><br><span class="line">        <span class="keyword">if</span> (installedPkg != <span class="keyword">null</span>) &#123;</span><br><span class="line">            <span class="comment">//【3.1】覆盖安装的情况，必须携带 PackageManager.INSTALL_REPLACE_EXISTING 安装标志位！</span></span><br><span class="line">            <span class="keyword">if</span> ((installFlags &amp; PackageManager.INSTALL_REPLACE_EXISTING) != <span class="number">0</span>) &#123;</span><br><span class="line">                <span class="keyword">if</span> ((installedPkg.applicationInfo.flags &amp; ApplicationInfo.FLAG_SYSTEM) != <span class="number">0</span>) &#123;</span><br><span class="line">                    <span class="comment">//【3.1.1】对于系统应用，不能覆盖安装到 sd 卡上！</span></span><br><span class="line">                    <span class="keyword">if</span> (onSd) &#123;</span><br><span class="line">                        Slog.w(TAG, <span class="string">"Cannot install update to system app on sdcard"</span>);</span><br><span class="line">                        <span class="keyword">return</span> PackageHelper.RECOMMEND_FAILED_INVALID_LOCATION;</span><br><span class="line">                    &#125;</span><br><span class="line">                    <span class="keyword">return</span> PackageHelper.RECOMMEND_INSTALL_INTERNAL;</span><br><span class="line">                &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                    <span class="comment">//【3.1.2】对于非系统应用，如果是安装到 sdcard，直接返回对应值！</span></span><br><span class="line">                    <span class="keyword">if</span> (onSd) &#123;</span><br><span class="line">                        <span class="keyword">return</span> PackageHelper.RECOMMEND_INSTALL_EXTERNAL;</span><br><span class="line">                    &#125;</span><br><span class="line">                    <span class="comment">//【3.1.2】对于非系统应用，如果只安装到内置，直接返回对应值！</span></span><br><span class="line">                    <span class="keyword">if</span> (installLocation == PackageInfo.INSTALL_LOCATION_INTERNAL_ONLY) &#123;</span><br><span class="line">                        <span class="keyword">return</span> PackageHelper.RECOMMEND_INSTALL_INTERNAL;</span><br><span class="line">                        </span><br><span class="line">                    &#125; <span class="keyword">else</span> <span class="keyword">if</span> (installLocation == PackageInfo.INSTALL_LOCATION_PREFER_EXTERNAL) &#123;</span><br><span class="line">                        <span class="comment">//【3.1.3】对于非系统应用，如果优先安装到外置，那么安装位置由 </span></span><br><span class="line">                        <span class="comment">// pkgLite.recommendedInstallLocation 决定！</span></span><br><span class="line">                    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                        <span class="comment">//【3.1.4】对于非系统应用，其他情况进入这里！</span></span><br><span class="line">                        <span class="keyword">if</span> (isExternal(installedPkg)) &#123;</span><br><span class="line">                            <span class="keyword">return</span> PackageHelper.RECOMMEND_INSTALL_EXTERNAL;</span><br><span class="line">                        &#125;</span><br><span class="line">                        <span class="keyword">return</span> PackageHelper.RECOMMEND_INSTALL_INTERNAL;</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                <span class="comment">//【3.2】异常情况</span></span><br><span class="line">                <span class="keyword">return</span> PackageHelper.RECOMMEND_FAILED_ALREADY_EXISTS;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">//【4】如果上面的条件都不满足，并且指定了在 sdcard，那么就返回 RECOMMEND_INSTALL_EXTERNAL；</span></span><br><span class="line">    <span class="keyword">if</span> (onSd) &#123;</span><br><span class="line">        <span class="keyword">return</span> PackageHelper.RECOMMEND_INSTALL_EXTERNAL;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">//【5】其他情况，均由 pkgLite.recommendedInstallLocation 决定！</span></span><br><span class="line">    <span class="keyword">return</span> pkgLite.recommendedInstallLocation;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h3 id="5-5-3-PackageManagerS-createInstallArgs"><a href="#5-5-3-PackageManagerS-createInstallArgs" class="headerlink" title="5.5.3 PackageManagerS.createInstallArgs"></a>5.5.3 PackageManagerS.createInstallArgs</h3><p>其实就是针对不同的安装方式，创建不同的 InstallArgs！</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">private</span> InstallArgs <span class="title">createInstallArgs</span><span class="params">(InstallParams params)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">if</span> (params.move != <span class="keyword">null</span>) &#123;</span><br><span class="line">        <span class="comment">//【1】如果是 move package，那么会创建 MoveInstallArgs 实例！</span></span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> MoveInstallArgs(params);</span><br><span class="line">    &#125; <span class="keyword">else</span> <span class="keyword">if</span> (installOnExternalAsec(params.installFlags) || params.isForwardLocked()) &#123;</span><br><span class="line">        <span class="comment">//【2】对于安装到外置存储，或者 forward locked 安装，会创建 AsecInstallArgs 实例！</span></span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> AsecInstallArgs(params);</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        <span class="comment">//【5.5.3.1】对于一般安装，创建 FileInstallArgs 实例！</span></span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> FileInstallArgs(params);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>这里我们先关注一般情况，即创建 FileInstallArgs 实例的情况！</p>
<h4 id="5-5-3-1-new-FileInstallArgs-要安装的-apk"><a href="#5-5-3-1-new-FileInstallArgs-要安装的-apk" class="headerlink" title="5.5.3.1 new FileInstallArgs - 要安装的 apk"></a>5.5.3.1 new FileInstallArgs - 要安装的 apk</h4><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">FileInstallArgs</span> <span class="keyword">extends</span> <span class="title">InstallArgs</span> </span>&#123;</span><br><span class="line">    <span class="keyword">private</span> File codeFile;</span><br><span class="line">    <span class="keyword">private</span> File resourceFile;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// Example topology:</span></span><br><span class="line">    <span class="comment">// /data/app/com.example/base.apk</span></span><br><span class="line">    <span class="comment">// /data/app/com.example/split_foo.apk</span></span><br><span class="line">    <span class="comment">// /data/app/com.example/lib/arm/libfoo.so</span></span><br><span class="line">    <span class="comment">// /data/app/com.example/lib/arm64/libfoo.so</span></span><br><span class="line">    <span class="comment">// /data/app/com.example/dalvik/arm/base.apk@classes.dex</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">//【1】安装一个新的 apk！</span></span><br><span class="line">    FileInstallArgs(InstallParams params) &#123;</span><br><span class="line">        <span class="keyword">super</span>(params.origin, params.move, params.observer, params.installFlags,</span><br><span class="line">                params.installerPackageName, params.volumeUuid,</span><br><span class="line">                params.getUser(), <span class="keyword">null</span> <span class="comment">/*instructionSets*/</span>, params.packageAbiOverride,</span><br><span class="line">                params.grantedRuntimePermissions,</span><br><span class="line">                params.traceMethod, params.traceCookie, params.certificates);</span><br><span class="line">        <span class="comment">//【1.1】这里校验了下是否是  Forward Locked 的！</span></span><br><span class="line">        <span class="keyword">if</span> (isFwdLocked()) &#123;</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> IllegalArgumentException(<span class="string">"Forward locking only supported in ASEC"</span>);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//【2】用于描述已存在的一个安装！</span></span><br><span class="line">    FileInstallArgs(String codePath, String resourcePath, String[] instructionSets) &#123;</span><br><span class="line">        <span class="keyword">super</span>(OriginInfo.fromNothing(), <span class="keyword">null</span>, <span class="keyword">null</span>, <span class="number">0</span>, <span class="keyword">null</span>, <span class="keyword">null</span>, <span class="keyword">null</span>, instructionSets,</span><br><span class="line">                <span class="keyword">null</span>, <span class="keyword">null</span>, <span class="keyword">null</span>, <span class="number">0</span>, <span class="keyword">null</span> <span class="comment">/*certificates*/</span>);</span><br><span class="line">        <span class="keyword">this</span>.codeFile = (codePath != <span class="keyword">null</span>) ? <span class="keyword">new</span> File(codePath) : <span class="keyword">null</span>;</span><br><span class="line">        <span class="keyword">this</span>.resourceFile = (resourcePath != <span class="keyword">null</span>) ? <span class="keyword">new</span> File(resourcePath) : <span class="keyword">null</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    ... ... ...</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>我们看到 FileInstallArgs 有两个构造器！</p>
<ul>
<li><p>一参数构造器用于创建安装过程中的 InstallArgs！</p>
</li>
<li><p>三参数构造器，用于描述一个已存在的安装，主要用于清除旧的安装，或者作为移动应用的时候的源数据，我们在 pms 开机初始化的过程中就已经看到过了！</p>
</li>
</ul>
<p>当然，这里我们重点关注安装过程！</p>
<h3 id="5-5-4-PackageManagerService-isVerificationEnabled"><a href="#5-5-4-PackageManagerService-isVerificationEnabled" class="headerlink" title="5.5.4 PackageManagerService.isVerificationEnabled"></a>5.5.4 PackageManagerService.isVerificationEnabled</h3><p>isVerificationEnabled 用于校验系统是否打开了校验功能！</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">boolean</span> <span class="title">isVerificationEnabled</span><span class="params">(<span class="keyword">int</span> userId, <span class="keyword">int</span> installFlags)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">if</span> (!DEFAULT_VERIFY_ENABLE) &#123;<span class="comment">//【1】如果默认没有打开校验，false！</span></span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">false</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">//【2】如果是 INSTALL_EPHEMERAL 方式的安装，不校验，false！</span></span><br><span class="line">    <span class="keyword">if</span> ((installFlags &amp; PackageManager.INSTALL_EPHEMERAL) != <span class="number">0</span>) &#123;</span><br><span class="line">        <span class="keyword">if</span> (DEBUG_EPHEMERAL) &#123;</span><br><span class="line">            Slog.d(TAG, <span class="string">"INSTALL_EPHEMERAL so skipping verification"</span>);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">false</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">//【3】判断该用户下是否允许校验应用！</span></span><br><span class="line">    <span class="keyword">boolean</span> ensureVerifyAppsEnabled = isUserRestricted(userId, UserManager.ENSURE_VERIFY_APPS);</span><br><span class="line"></span><br><span class="line">    <span class="comment">//【4】如果安装指定了 INSTALL_FROM_ADB，进入这里！</span></span><br><span class="line">    <span class="keyword">if</span> ((installFlags &amp; PackageManager.INSTALL_FROM_ADB) != <span class="number">0</span>) &#123;</span><br><span class="line">        <span class="comment">//【4.1】test harness environment 不校验！</span></span><br><span class="line">        <span class="keyword">if</span> (ActivityManager.isRunningInTestHarness()) &#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="keyword">false</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">//【4.2】如果同时该用户下能校验应用，返回 true！</span></span><br><span class="line">        <span class="keyword">if</span> (ensureVerifyAppsEnabled) &#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="keyword">true</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">//【4.3】对于 adb install，如果系统属性 PACKAGE_VERIFIER_INCLUDE_ADB 为 0 ，那就不用校验！</span></span><br><span class="line">        <span class="keyword">if</span> (android.provider.Settings.Global.getInt(mContext.getContentResolver(),</span><br><span class="line">                android.provider.Settings.Global.PACKAGE_VERIFIER_INCLUDE_ADB, <span class="number">1</span>) == <span class="number">0</span>) &#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="keyword">false</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">//【5】如果该用户下能校验应用，返回 true！</span></span><br><span class="line">    <span class="keyword">if</span> (ensureVerifyAppsEnabled) &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">true</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">//【6】判断系统属性 PACKAGE_VERIFIER_ENABLE 如果为 0，那就不用校验！</span></span><br><span class="line">    <span class="keyword">return</span> android.provider.Settings.Global.getInt(mContext.getContentResolver(),</span><br><span class="line">            android.provider.Settings.Global.PACKAGE_VERIFIER_ENABLE, <span class="number">1</span>) == <span class="number">1</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>就不多说了！</p>
<h3 id="5-5-5-new-PackageVerificationState"><a href="#5-5-5-new-PackageVerificationState" class="headerlink" title="5.5.5 new PackageVerificationState"></a>5.5.5 new PackageVerificationState</h3><p>PackageVerificationState 用于保存被安装的应用的校验状态信息：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">PackageVerificationState</span> </span>&#123;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> InstallArgs mArgs; <span class="comment">// InstallArgs 实例</span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> SparseBooleanArray mSufficientVerifierUids; </span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> <span class="keyword">int</span> mRequiredVerifierUid; <span class="comment">// 校验者的 uid！</span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">boolean</span> mSufficientVerificationComplete;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">boolean</span> mSufficientVerificationPassed;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">boolean</span> mRequiredVerificationComplete;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">boolean</span> mRequiredVerificationPassed;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">boolean</span> mExtendedTimeout;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="title">PackageVerificationState</span><span class="params">(<span class="keyword">int</span> requiredVerifierUid, InstallArgs args)</span> </span>&#123;</span><br><span class="line">        mRequiredVerifierUid = requiredVerifierUid;</span><br><span class="line">        mArgs = args;</span><br><span class="line">        mSufficientVerifierUids = <span class="keyword">new</span> SparseBooleanArray();</span><br><span class="line">        mExtendedTimeout = <span class="keyword">false</span>; <span class="comment">// 表示是否超时！</span></span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure>
<p>不多说了！</p>
<h2 id="5-6-PackageHandler-doHandleMessage-CHECK-PENDING-VERIFICATION-校验完成"><a href="#5-6-PackageHandler-doHandleMessage-CHECK-PENDING-VERIFICATION-校验完成" class="headerlink" title="5.6 PackageHandler.doHandleMessage[CHECK_PENDING_VERIFICATION] - 校验完成"></a>5.6 PackageHandler.doHandleMessage[CHECK_PENDING_VERIFICATION] - 校验完成</h2><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">case</span> CHECK_PENDING_VERIFICATION: &#123;</span><br><span class="line">    <span class="comment">//【1】获得校验唯一标识！</span></span><br><span class="line">    <span class="keyword">final</span> <span class="keyword">int</span> verificationId = msg.arg1;</span><br><span class="line">    <span class="comment">//【2】获得本次校验的 PackageVerificationState 实例！</span></span><br><span class="line">    <span class="keyword">final</span> PackageVerificationState state = mPendingVerification.get(verificationId);</span><br><span class="line">    <span class="keyword">if</span> ((state != <span class="keyword">null</span>) &amp;&amp; !state.timeoutExtended()) &#123;</span><br><span class="line">        <span class="comment">//【3】获得 InstallArgs 实例！</span></span><br><span class="line">        <span class="keyword">final</span> InstallArgs args = state.getInstallArgs();</span><br><span class="line">        <span class="keyword">final</span> Uri originUri = Uri.fromFile(args.origin.resolvedFile);</span><br><span class="line"></span><br><span class="line">        Slog.i(TAG, <span class="string">"Verification timed out for "</span> + originUri);</span><br><span class="line">        <span class="comment">//【4】从 mPendingVerification 中移除校验状态对象！</span></span><br><span class="line">        mPendingVerification.remove(verificationId);</span><br><span class="line"></span><br><span class="line">        <span class="keyword">int</span> ret = PackageManager.INSTALL_FAILED_VERIFICATION_FAILURE;</span><br><span class="line">        </span><br><span class="line">        <span class="comment">//【5】处理校验结果！</span></span><br><span class="line">        <span class="keyword">if</span> (getDefaultVerificationResponse() == PackageManager.VERIFICATION_ALLOW) &#123;</span><br><span class="line">            <span class="comment">//【5.1】校验成功</span></span><br><span class="line">            Slog.i(TAG, <span class="string">"Continuing with installation of "</span> + originUri);</span><br><span class="line">            state.setVerifierResponse(Binder.getCallingUid(),</span><br><span class="line">                    PackageManager.VERIFICATION_ALLOW_WITHOUT_SUFFICIENT);</span><br><span class="line">            <span class="comment">//【5.6.1】发送 Intent.ACTION_PACKAGE_VERIFIED 广播</span></span><br><span class="line">            broadcastPackageVerified(verificationId, originUri,</span><br><span class="line">                    PackageManager.VERIFICATION_ALLOW,</span><br><span class="line">                    state.getInstallArgs().getUser());</span><br><span class="line">            <span class="keyword">try</span> &#123;</span><br><span class="line">                <span class="comment">//【5.6.2】校验成功后，调用 installArgs.copyApk 继续处理！</span></span><br><span class="line">                ret = args.copyApk(mContainerService, <span class="keyword">true</span>);</span><br><span class="line">            &#125; <span class="keyword">catch</span> (RemoteException e) &#123;</span><br><span class="line">                Slog.e(TAG, <span class="string">"Could not contact the ContainerService"</span>);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            <span class="comment">//【5.6.1】校验失败，发送 Intent.ACTION_PACKAGE_VERIFIED 广播</span></span><br><span class="line">            broadcastPackageVerified(verificationId, originUri,</span><br><span class="line">                    PackageManager.VERIFICATION_REJECT,</span><br><span class="line">                    state.getInstallArgs().getUser());</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        Trace.asyncTraceEnd(</span><br><span class="line">                TRACE_TAG_PACKAGE_MANAGER, <span class="string">"verification"</span>, verificationId);</span><br><span class="line">        </span><br><span class="line">        <span class="comment">//【5.7】继续安装！</span></span><br><span class="line">        processPendingInstall(args, ret);</span><br><span class="line">        </span><br><span class="line">        <span class="comment">// 安装过程结束，发送 MCS_UNBIND 消息！</span></span><br><span class="line">        mHandler.sendEmptyMessage(MCS_UNBIND);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">break</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>这里我们通过 getDefaultVerificationResponse 方法返回校验结果：<br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">int</span> <span class="title">getDefaultVerificationResponse</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    <span class="keyword">return</span> android.provider.Settings.Global.getInt(mContext.getContentResolver(),</span><br><span class="line">            android.provider.Settings.Global.PACKAGE_VERIFIER_DEFAULT_RESPONSE,</span><br><span class="line">            DEFAULT_VERIFICATION_RESPONSE);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>默认返回的是 PackageManager.VERIFICATION_ALLOW，比如在校验超时的情况下！</p>
<h3 id="5-6-1-PackageManagerS-broadcastPackageVerified"><a href="#5-6-1-PackageManagerS-broadcastPackageVerified" class="headerlink" title="5.6.1 PackageManagerS.broadcastPackageVerified"></a>5.6.1 PackageManagerS.broadcastPackageVerified</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">broadcastPackageVerified</span><span class="params">(<span class="keyword">int</span> verificationId, Uri packageUri,</span></span></span><br><span class="line"><span class="function"><span class="params">        <span class="keyword">int</span> verificationCode, UserHandle user)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">final</span> Intent intent = <span class="keyword">new</span> Intent(Intent.ACTION_PACKAGE_VERIFIED);</span><br><span class="line">    intent.setDataAndType(packageUri, PACKAGE_MIME_TYPE);</span><br><span class="line">    intent.addFlags(Intent.FLAG_GRANT_READ_URI_PERMISSION);</span><br><span class="line">    intent.putExtra(PackageManager.EXTRA_VERIFICATION_ID, verificationId);</span><br><span class="line">    intent.putExtra(PackageManager.EXTRA_VERIFICATION_RESULT, verificationCode);</span><br><span class="line"></span><br><span class="line">    mContext.sendBroadcastAsUser(intent, user,</span><br><span class="line">            android.Manifest.permission.PACKAGE_VERIFICATION_AGENT);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h3 id="5-6-2-FileInstallArgs-do-copyApk"><a href="#5-6-2-FileInstallArgs-do-copyApk" class="headerlink" title="5.6.2 FileInstallArgs.(do)copyApk"></a>5.6.2 FileInstallArgs.(do)copyApk</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">copyApk</span><span class="params">(IMediaContainerService imcs, <span class="keyword">boolean</span> temp)</span> <span class="keyword">throws</span> RemoteException </span>&#123;</span><br><span class="line">    Trace.traceBegin(TRACE_TAG_PACKAGE_MANAGER, <span class="string">"copyApk"</span>);</span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> doCopyApk(imcs, temp);</span><br><span class="line">    &#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">        Trace.traceEnd(TRACE_TAG_PACKAGE_MANAGER);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>copyApk 调用了 doCopyApk 方法：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">int</span> <span class="title">doCopyApk</span><span class="params">(IMediaContainerService imcs, <span class="keyword">boolean</span> temp)</span> <span class="keyword">throws</span> RemoteException </span>&#123;</span><br><span class="line">    <span class="comment">//【1】如果 origin.staged 为 true，那么说明应用已经 copy 到目标目录了，</span></span><br><span class="line">    <span class="comment">// 那就直接返回 PackageManager.INSTALL_SUCCEEDED！</span></span><br><span class="line">    <span class="keyword">if</span> (origin.staged) &#123;</span><br><span class="line">        <span class="keyword">if</span> (DEBUG_INSTALL) Slog.d(TAG, origin.file + <span class="string">" already staged; skipping copy"</span>);</span><br><span class="line">        <span class="comment">//【1.1】设置 FileInstallArgs 的 codeFile 属性！</span></span><br><span class="line">        codeFile = origin.file;</span><br><span class="line">        resourceFile = origin.file;</span><br><span class="line">        <span class="keyword">return</span> PackageManager.INSTALL_SUCCEEDED;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">//【2】如果 origin.staged 为 false，说明应用没有拷贝到目标目录！</span></span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">        <span class="keyword">final</span> <span class="keyword">boolean</span> isEphemeral = (installFlags &amp; PackageManager.INSTALL_EPHEMERAL) != <span class="number">0</span>;</span><br><span class="line">        <span class="comment">//【5.6.2.1】获得要拷贝的目标目录！</span></span><br><span class="line">        <span class="keyword">final</span> File tempDir =</span><br><span class="line">                mInstallerService.allocateStageDirLegacy(volumeUuid, isEphemeral);</span><br><span class="line">        codeFile = tempDir;</span><br><span class="line">        resourceFile = tempDir;</span><br><span class="line"></span><br><span class="line">    &#125; <span class="keyword">catch</span> (IOException e) &#123;</span><br><span class="line">        Slog.w(TAG, <span class="string">"Failed to create copy file: "</span> + e);</span><br><span class="line">        <span class="keyword">return</span> PackageManager.INSTALL_FAILED_INSUFFICIENT_STORAGE;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">//【3】回调接口！</span></span><br><span class="line">    <span class="keyword">final</span> IParcelFileDescriptorFactory target = <span class="keyword">new</span> IParcelFileDescriptorFactory.Stub() &#123;</span><br><span class="line">        <span class="meta">@Override</span></span><br><span class="line">        <span class="function"><span class="keyword">public</span> ParcelFileDescriptor <span class="title">open</span><span class="params">(String name, <span class="keyword">int</span> mode)</span> <span class="keyword">throws</span> RemoteException </span>&#123;</span><br><span class="line">            <span class="keyword">if</span> (!FileUtils.isValidExtFilename(name)) &#123;</span><br><span class="line">                <span class="keyword">throw</span> <span class="keyword">new</span> IllegalArgumentException(<span class="string">"Invalid filename: "</span> + name);</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">try</span> &#123;</span><br><span class="line">                <span class="comment">//【3.1】访问 codeFile 目录下的 name 文件，设置权限，并返回其文件描述符！</span></span><br><span class="line">                <span class="keyword">final</span> File file = <span class="keyword">new</span> File(codeFile, name);</span><br><span class="line">                <span class="keyword">final</span> FileDescriptor fd = Os.open(file.getAbsolutePath(),</span><br><span class="line">                        O_RDWR | O_CREAT, <span class="number">0644</span>);</span><br><span class="line">                Os.chmod(file.getAbsolutePath(), <span class="number">0644</span>);</span><br><span class="line">                <span class="keyword">return</span> <span class="keyword">new</span> ParcelFileDescriptor(fd);</span><br><span class="line">            &#125; <span class="keyword">catch</span> (ErrnoException e) &#123;</span><br><span class="line">                <span class="keyword">throw</span> <span class="keyword">new</span> RemoteException(<span class="string">"Failed to open: "</span> + e.getMessage());</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">int</span> ret = PackageManager.INSTALL_SUCCEEDED;</span><br><span class="line">    <span class="comment">//【5.6.2.2】将应用程序拷贝到目标目录！</span></span><br><span class="line">    ret = imcs.copyPackage(origin.file.getAbsolutePath(), target);</span><br><span class="line">    <span class="keyword">if</span> (ret != PackageManager.INSTALL_SUCCEEDED) &#123;</span><br><span class="line">        Slog.e(TAG, <span class="string">"Failed to copy package"</span>);</span><br><span class="line">        <span class="keyword">return</span> ret;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">//【4】解压本地 lib 库文件！</span></span><br><span class="line">    <span class="keyword">final</span> File libraryRoot = <span class="keyword">new</span> File(codeFile, LIB_DIR_NAME);</span><br><span class="line">    NativeLibraryHelper.Handle handle = <span class="keyword">null</span>;</span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">        handle = NativeLibraryHelper.Handle.create(codeFile);</span><br><span class="line">        ret = NativeLibraryHelper.copyNativeBinariesWithOverride(handle, libraryRoot,</span><br><span class="line">                abiOverride);</span><br><span class="line">    &#125; <span class="keyword">catch</span> (IOException e) &#123;</span><br><span class="line">        Slog.e(TAG, <span class="string">"Copying native libraries failed"</span>, e);</span><br><span class="line">        ret = PackageManager.INSTALL_FAILED_INTERNAL_ERROR;</span><br><span class="line">    &#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">        IoUtils.closeQuietly(handle);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> ret;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>根据前面创建 OriginInfo 时知道：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">if</span> (stagedDir != <span class="keyword">null</span>) &#123;</span><br><span class="line">    origin = OriginInfo.fromStagedFile(stagedDir);</span><br><span class="line">&#125; <span class="keyword">else</span> &#123;</span><br><span class="line">    origin = OriginInfo.fromStagedContainer(stagedCid);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>通过 adb 安装时，安装到内置存储，会调用 OriginInfo.fromStagedFile 方法，此时 OriginInfo.staged 为 true，安装到外置存储时， OriginInfo.staged 也会为 true。</p>
<p>这是因为在进行 adb install 过程中时，我们通过 Session，已经拷贝到目标目录了：/data/app/vml[sessionId].tmp/，所以这里 doCopyApk 无需在继续进行下去！！</p>
<p>对于其他的安装方式，OriginInfo.staged 为 false 的，那么会进入 doCopyApk 的下一步！</p>
<h4 id="5-6-2-1-PackageInstallerService-allocateStageDirLegacy"><a href="#5-6-2-1-PackageInstallerService-allocateStageDirLegacy" class="headerlink" title="5.6.2.1 PackageInstallerService.allocateStageDirLegacy"></a>5.6.2.1 PackageInstallerService.allocateStageDirLegacy</h4><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Deprecated</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> File <span class="title">allocateStageDirLegacy</span><span class="params">(String volumeUuid, <span class="keyword">boolean</span> isEphemeral)</span> <span class="keyword">throws</span> IOException </span>&#123;</span><br><span class="line">    <span class="keyword">synchronized</span> (mSessions) &#123;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            <span class="comment">//【3.1.2】分配一个 sessionId，保存到 mLegacySessions 中！</span></span><br><span class="line">            <span class="keyword">final</span> <span class="keyword">int</span> sessionId = allocateSessionIdLocked();</span><br><span class="line">            mLegacySessions.put(sessionId, <span class="keyword">true</span>);</span><br><span class="line">            <span class="comment">//【3.1.2】创建目标目录！</span></span><br><span class="line">            <span class="keyword">final</span> File stageDir = buildStageDir(volumeUuid, sessionId, isEphemeral);</span><br><span class="line">            <span class="comment">//【2】创建目录，设置权限！</span></span><br><span class="line">            prepareStageDir(stageDir);</span><br><span class="line">            <span class="keyword">return</span> stageDir;</span><br><span class="line">        &#125; <span class="keyword">catch</span> (IllegalStateException e) &#123;</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> IOException(e);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>这里，前面分析过，这里就不多说了！</p>
<h4 id="5-6-2-2-DefaultContainerService-copyPackage-Inner"><a href="#5-6-2-2-DefaultContainerService-copyPackage-Inner" class="headerlink" title="5.6.2.2 DefaultContainerService.copyPackage(Inner)"></a>5.6.2.2 DefaultContainerService.copyPackage(Inner)</h4><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">int</span> <span class="title">copyPackage</span><span class="params">(String packagePath, IParcelFileDescriptorFactory target)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">if</span> (packagePath == <span class="keyword">null</span> || target == <span class="keyword">null</span>) &#123;</span><br><span class="line">        <span class="keyword">return</span> PackageManager.INSTALL_FAILED_INVALID_URI;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    PackageLite pkg = <span class="keyword">null</span>;</span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">        <span class="keyword">final</span> File packageFile = <span class="keyword">new</span> File(packagePath);</span><br><span class="line">        <span class="comment">//【1】解析应用！</span></span><br><span class="line">        pkg = PackageParser.parsePackageLite(packageFile, <span class="number">0</span>);</span><br><span class="line">        <span class="comment">//【2】继续处理 copyPackageInner</span></span><br><span class="line">        <span class="keyword">return</span> copyPackageInner(pkg, target);</span><br><span class="line">    &#125; <span class="keyword">catch</span> (PackageParserException | IOException | RemoteException e) &#123;</span><br><span class="line">        Slog.w(TAG, <span class="string">"Failed to copy package at "</span> + packagePath + <span class="string">": "</span> + e);</span><br><span class="line">        <span class="keyword">return</span> PackageManager.INSTALL_FAILED_INSUFFICIENT_STORAGE;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>这里继续调用了 copyPackageInner 方法<br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">int</span> <span class="title">copyPackageInner</span><span class="params">(PackageLite pkg, IParcelFileDescriptorFactory target)</span></span></span><br><span class="line"><span class="function">        <span class="keyword">throws</span> IOException, RemoteException </span>&#123;</span><br><span class="line">    <span class="comment">//【1】对 base apk 和 split apk 分别执行 copy！</span></span><br><span class="line">    copyFile(pkg.baseCodePath, target, <span class="string">"base.apk"</span>);</span><br><span class="line">    <span class="keyword">if</span> (!ArrayUtils.isEmpty(pkg.splitNames)) &#123;</span><br><span class="line">        <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; pkg.splitNames.length; i++) &#123;</span><br><span class="line">            copyFile(pkg.splitCodePaths[i], target, <span class="string">"split_"</span> + pkg.splitNames[i] + <span class="string">".apk"</span>);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> PackageManager.INSTALL_SUCCEEDED;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>最终，调用了 copyFile 执行 copy！</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">copyFile</span><span class="params">(String sourcePath, IParcelFileDescriptorFactory target, String targetName)</span></span></span><br><span class="line"><span class="function">        <span class="keyword">throws</span> IOException, RemoteException </span>&#123;</span><br><span class="line">    Slog.d(TAG, <span class="string">"Copying "</span> + sourcePath + <span class="string">" to "</span> + targetName);</span><br><span class="line">    InputStream in = <span class="keyword">null</span>;</span><br><span class="line">    OutputStream out = <span class="keyword">null</span>;</span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">        in = <span class="keyword">new</span> FileInputStream(sourcePath);</span><br><span class="line">        out = <span class="keyword">new</span> ParcelFileDescriptor.AutoCloseOutputStream(</span><br><span class="line">                target.open(targetName, ParcelFileDescriptor.MODE_READ_WRITE));</span><br><span class="line">        Streams.copy(in, out);</span><br><span class="line">    &#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">        IoUtils.closeQuietly(out);</span><br><span class="line">        IoUtils.closeQuietly(in);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>到这里就结束了！</p>
<h2 id="5-7-PackageManagerS-processPendingInstall"><a href="#5-7-PackageManagerS-processPendingInstall" class="headerlink" title="5.7 PackageManagerS.processPendingInstall"></a>5.7 PackageManagerS.processPendingInstall</h2><p>processPendingInstall 用于继续安装：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">processPendingInstall</span><span class="params">(<span class="keyword">final</span> InstallArgs args, <span class="keyword">final</span> <span class="keyword">int</span> currentStatus)</span> </span>&#123;</span><br><span class="line">    <span class="comment">// Queue up an async operation since the package installation may take a little while.</span></span><br><span class="line">    mHandler.post(<span class="keyword">new</span> Runnable() &#123;</span><br><span class="line">        <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">run</span><span class="params">()</span> </span>&#123;</span><br><span class="line">            mHandler.removeCallbacks(<span class="keyword">this</span>);</span><br><span class="line"></span><br><span class="line">            <span class="comment">//【5.7.1】创建 PackageInstalledInfo 实例，封装安装结果！</span></span><br><span class="line">            PackageInstalledInfo res = <span class="keyword">new</span> PackageInstalledInfo();</span><br><span class="line">            res.setReturnCode(currentStatus); <span class="comment">// 保存当前的返回码</span></span><br><span class="line">            res.uid = -<span class="number">1</span>;</span><br><span class="line">            res.pkg = <span class="keyword">null</span>;</span><br><span class="line">            res.removedInfo = <span class="keyword">null</span>;</span><br><span class="line"></span><br><span class="line">            <span class="comment">//【1】如果返回码为 PackageManager.INSTALL_SUCCEEDED！</span></span><br><span class="line">            <span class="keyword">if</span> (res.returnCode == PackageManager.INSTALL_SUCCEEDED) &#123;</span><br><span class="line">                <span class="comment">//【×5.7.2】安装前处理；</span></span><br><span class="line">                args.doPreInstall(res.returnCode);</span><br><span class="line">                <span class="keyword">synchronized</span> (mInstallLock) &#123;</span><br><span class="line">                    <span class="comment">//【×5.7.3】执行安装！</span></span><br><span class="line">                    installPackageTracedLI(args, res);</span><br><span class="line">                &#125;</span><br><span class="line">                <span class="comment">//【×5.7.4】安装后处理；</span></span><br><span class="line">                args.doPostInstall(res.returnCode, res.uid);</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            <span class="comment">//【2】判断是否执行备份，要备份必须满足 3 个条件！</span></span><br><span class="line">            <span class="comment">// 1、安装正常；2、本次安装并不是更新操作！3、应用允许备份</span></span><br><span class="line">            <span class="keyword">final</span> <span class="keyword">boolean</span> update = res.removedInfo != <span class="keyword">null</span></span><br><span class="line">                    &amp;&amp; res.removedInfo.removedPackage != <span class="keyword">null</span>;</span><br><span class="line">            <span class="keyword">final</span> <span class="keyword">int</span> flags = (res.pkg == <span class="keyword">null</span>) ? <span class="number">0</span> : res.pkg.applicationInfo.flags;</span><br><span class="line">            <span class="keyword">boolean</span> doRestore = !update</span><br><span class="line">                    &amp;&amp; ((flags &amp; ApplicationInfo.FLAG_ALLOW_BACKUP) != <span class="number">0</span>);</span><br><span class="line"></span><br><span class="line">            <span class="comment">//【3】计算本次安装的 token</span></span><br><span class="line">            <span class="keyword">int</span> token;</span><br><span class="line">            <span class="keyword">if</span> (mNextInstallToken &lt; <span class="number">0</span>) mNextInstallToken = <span class="number">1</span>;</span><br><span class="line">            token = mNextInstallToken++;</span><br><span class="line">            </span><br><span class="line">            <span class="comment">//【*5.7.5】创建一个 PostInstallData 对象，并将其加入 mRunningInstalls 中！</span></span><br><span class="line">            PostInstallData data = <span class="keyword">new</span> PostInstallData(args, res);</span><br><span class="line">            mRunningInstalls.put(token, data);</span><br><span class="line"></span><br><span class="line">            <span class="keyword">if</span> (DEBUG_INSTALL) Log.v(TAG, <span class="string">"+ starting restore round-trip "</span> + token);</span><br><span class="line"></span><br><span class="line">            <span class="keyword">if</span> (res.returnCode == PackageManager.INSTALL_SUCCEEDED &amp;&amp; doRestore) &#123;</span><br><span class="line">                <span class="comment">//【4】如果安装成功，并且需要备份，那就获得 BackupManager 执行备份！</span></span><br><span class="line">                IBackupManager bm = IBackupManager.Stub.asInterface(</span><br><span class="line">                        ServiceManager.getService(Context.BACKUP_SERVICE));</span><br><span class="line">                <span class="keyword">if</span> (bm != <span class="keyword">null</span>) &#123;</span><br><span class="line">                    <span class="keyword">if</span> (DEBUG_INSTALL) Log.v(TAG, <span class="string">"token "</span> + token</span><br><span class="line">                            + <span class="string">" to BM for possible restore"</span>);</span><br><span class="line">                    Trace.asyncTraceBegin(TRACE_TAG_PACKAGE_MANAGER, <span class="string">"restore"</span>, token);</span><br><span class="line">                    <span class="keyword">try</span> &#123;</span><br><span class="line">                        <span class="comment">// <span class="doctag">TODO:</span> http://b/22388012</span></span><br><span class="line">                        <span class="keyword">if</span> (bm.isBackupServiceActive(UserHandle.USER_SYSTEM)) &#123;</span><br><span class="line">                            bm.restoreAtInstall(res.pkg.applicationInfo.packageName, token);</span><br><span class="line">                        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                            doRestore = <span class="keyword">false</span>;</span><br><span class="line">                        &#125;</span><br><span class="line">                    &#125; <span class="keyword">catch</span> (RemoteException e) &#123;</span><br><span class="line">                        <span class="comment">// can't happen; the backup manager is local</span></span><br><span class="line">                    &#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">                        Slog.e(TAG, <span class="string">"Exception trying to enqueue restore"</span>, e);</span><br><span class="line">                        doRestore = <span class="keyword">false</span>;</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                    Slog.e(TAG, <span class="string">"Backup Manager not found!"</span>);</span><br><span class="line">                    doRestore = <span class="keyword">false</span>;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="comment">//【5】如果备份失败或者不需要备份，那就进入这个阶段！</span></span><br><span class="line">            <span class="keyword">if</span> (!doRestore) &#123;</span><br><span class="line">                <span class="comment">// No restore possible, or the Backup Manager was mysteriously not</span></span><br><span class="line">                <span class="comment">// available -- just fire the post-install work request directly.</span></span><br><span class="line">                <span class="keyword">if</span> (DEBUG_INSTALL) Log.v(TAG, <span class="string">"No restore - queue post-install for "</span> + token);</span><br><span class="line"></span><br><span class="line">                Trace.asyncTraceBegin(TRACE_TAG_PACKAGE_MANAGER, <span class="string">"postInstall"</span>, token);</span><br><span class="line"></span><br><span class="line">                Message msg = mHandler.obtainMessage(POST_INSTALL, token, <span class="number">0</span>);</span><br><span class="line">                mHandler.sendMessage(msg);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h3 id="5-7-1-new-PackageInstalledInfo"><a href="#5-7-1-new-PackageInstalledInfo" class="headerlink" title="5.7.1 new PackageInstalledInfo"></a>5.7.1 new PackageInstalledInfo</h3><p>PackageInstalledInfo 用于保存该应用的安装结果信息！</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">static</span> <span class="class"><span class="keyword">class</span> <span class="title">PackageInstalledInfo</span> </span>&#123;</span><br><span class="line">    String name;</span><br><span class="line">    <span class="keyword">int</span> uid;</span><br><span class="line">    <span class="keyword">int</span>[] origUsers; <span class="comment">// 该 pacakge 之前安装后所属的 user</span></span><br><span class="line">    <span class="keyword">int</span>[] newUsers; <span class="comment">// 该 pacakge 现在安装后所属的 user</span></span><br><span class="line">    PackageParser.Package pkg;</span><br><span class="line">    <span class="keyword">int</span> returnCode; <span class="comment">// 返回码</span></span><br><span class="line">    String returnMsg;</span><br><span class="line">    <span class="comment">//【7.7.1.1】用于封装要移除的 apk 的信息！</span></span><br><span class="line">    PackageRemovedInfo removedInfo;</span><br><span class="line">    ArrayMap&lt;String, PackageInstalledInfo&gt; addedChildPackages; <span class="comment">// split apk 的安装结果信息！</span></span><br><span class="line"></span><br><span class="line">    ... ... ...</span><br><span class="line"></span><br><span class="line">    <span class="comment">// In some error cases we want to convey more info back to the observer</span></span><br><span class="line">    String origPackage;</span><br><span class="line">    String origPermission;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>我们先看到这里！</p>
<h4 id="5-7-1-1-new-PackageRemovedInfo"><a href="#5-7-1-1-new-PackageRemovedInfo" class="headerlink" title="5.7.1.1 new PackageRemovedInfo"></a>5.7.1.1 new PackageRemovedInfo</h4><p>封装要移除的 apk 的信息：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">PackageRemovedInfo</span> </span>&#123;</span><br><span class="line">    String removedPackage;</span><br><span class="line">    <span class="keyword">int</span> uid = -<span class="number">1</span>;</span><br><span class="line">    <span class="keyword">int</span> removedAppId = -<span class="number">1</span>;</span><br><span class="line">    <span class="keyword">int</span>[] origUsers;</span><br><span class="line">    <span class="keyword">int</span>[] removedUsers = <span class="keyword">null</span>;</span><br><span class="line">    <span class="keyword">boolean</span> isRemovedPackageSystemUpdate = <span class="keyword">false</span>;</span><br><span class="line">    <span class="keyword">boolean</span> isUpdate;</span><br><span class="line">    <span class="keyword">boolean</span> dataRemoved;</span><br><span class="line">    <span class="keyword">boolean</span> removedForAllUsers;</span><br><span class="line">    <span class="comment">//【1】InstallArgs 用于清除 apk 的相关数据，后面会看到！</span></span><br><span class="line">    InstallArgs args = <span class="keyword">null</span>;</span><br><span class="line">    ArrayMap&lt;String, PackageRemovedInfo&gt; removedChildPackages;</span><br><span class="line">    ArrayMap&lt;String, PackageInstalledInfo&gt; appearedChildPackages;</span><br><span class="line">    ... ... ...</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h3 id="5-7-2-FileInstallArgs-doPreInstall"><a href="#5-7-2-FileInstallArgs-doPreInstall" class="headerlink" title="5.7.2 FileInstallArgs.doPreInstall"></a>5.7.2 FileInstallArgs.doPreInstall</h3><p>安装前执行清理操作，正常情况不会触发！<br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">doPreInstall</span><span class="params">(<span class="keyword">int</span> status)</span> </span>&#123;</span><br><span class="line">    <span class="comment">//【1】如果安装前的状态不是 PackageManager.INSTALL_SUCCEEDED</span></span><br><span class="line">    <span class="keyword">if</span> (status != PackageManager.INSTALL_SUCCEEDED) &#123;</span><br><span class="line">        <span class="comment">//【5.7.2.1】执行清理操作！</span></span><br><span class="line">        cleanUp();</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> status;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<h4 id="5-7-2-1-FileInstallArgs-cleanUp-ResourcesLI"><a href="#5-7-2-1-FileInstallArgs-cleanUp-ResourcesLI" class="headerlink" title="5.7.2.1 FileInstallArgs.cleanUp(ResourcesLI)"></a>5.7.2.1 FileInstallArgs.cleanUp(ResourcesLI)</h4><p>清理操作！<br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">boolean</span> <span class="title">cleanUp</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    <span class="keyword">if</span> (codeFile == <span class="keyword">null</span> || !codeFile.exists()) &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">false</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">//【1】删除目标目录下的所有文件！</span></span><br><span class="line">    removeCodePathLI(codeFile);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (resourceFile != <span class="keyword">null</span> &amp;&amp; !FileUtils.contains(codeFile, resourceFile)) &#123;</span><br><span class="line">        resourceFile.delete();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">true</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>可以看到，最后调用了 removeCodePathLI 方法！<br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">removeCodePathLI</span><span class="params">(File codePath)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">if</span> (codePath.isDirectory()) &#123;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            mInstaller.rmPackageDir(codePath.getAbsolutePath());</span><br><span class="line">        &#125; <span class="keyword">catch</span> (InstallerException e) &#123;</span><br><span class="line">            Slog.w(TAG, <span class="string">"Failed to remove code path"</span>, e);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        codePath.delete();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<h3 id="5-7-3-PackageManagerS-installPackageTracedLI-核心安装入口"><a href="#5-7-3-PackageManagerS-installPackageTracedLI-核心安装入口" class="headerlink" title="5.7.3 PackageManagerS.installPackageTracedLI - 核心安装入口"></a>5.7.3 PackageManagerS.installPackageTracedLI - 核心安装入口</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">installPackageTracedLI</span><span class="params">(InstallArgs args, PackageInstalledInfo res)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">        Trace.traceBegin(TRACE_TAG_PACKAGE_MANAGER, <span class="string">"installPackage"</span>);</span><br><span class="line">        <span class="comment">//【1】调用了 installPackageLI 方法！</span></span><br><span class="line">        installPackageLI(args, res);</span><br><span class="line">    &#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">        Trace.traceEnd(TRACE_TAG_PACKAGE_MANAGER);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>这里调用了 installPackageLI 方法：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br><span class="line">212</span><br><span class="line">213</span><br><span class="line">214</span><br><span class="line">215</span><br><span class="line">216</span><br><span class="line">217</span><br><span class="line">218</span><br><span class="line">219</span><br><span class="line">220</span><br><span class="line">221</span><br><span class="line">222</span><br><span class="line">223</span><br><span class="line">224</span><br><span class="line">225</span><br><span class="line">226</span><br><span class="line">227</span><br><span class="line">228</span><br><span class="line">229</span><br><span class="line">230</span><br><span class="line">231</span><br><span class="line">232</span><br><span class="line">233</span><br><span class="line">234</span><br><span class="line">235</span><br><span class="line">236</span><br><span class="line">237</span><br><span class="line">238</span><br><span class="line">239</span><br><span class="line">240</span><br><span class="line">241</span><br><span class="line">242</span><br><span class="line">243</span><br><span class="line">244</span><br><span class="line">245</span><br><span class="line">246</span><br><span class="line">247</span><br><span class="line">248</span><br><span class="line">249</span><br><span class="line">250</span><br><span class="line">251</span><br><span class="line">252</span><br><span class="line">253</span><br><span class="line">254</span><br><span class="line">255</span><br><span class="line">256</span><br><span class="line">257</span><br><span class="line">258</span><br><span class="line">259</span><br><span class="line">260</span><br><span class="line">261</span><br><span class="line">262</span><br><span class="line">263</span><br><span class="line">264</span><br><span class="line">265</span><br><span class="line">266</span><br><span class="line">267</span><br><span class="line">268</span><br><span class="line">269</span><br><span class="line">270</span><br><span class="line">271</span><br><span class="line">272</span><br><span class="line">273</span><br><span class="line">274</span><br><span class="line">275</span><br><span class="line">276</span><br><span class="line">277</span><br><span class="line">278</span><br><span class="line">279</span><br><span class="line">280</span><br><span class="line">281</span><br><span class="line">282</span><br><span class="line">283</span><br><span class="line">284</span><br><span class="line">285</span><br><span class="line">286</span><br><span class="line">287</span><br><span class="line">288</span><br><span class="line">289</span><br><span class="line">290</span><br><span class="line">291</span><br><span class="line">292</span><br><span class="line">293</span><br><span class="line">294</span><br><span class="line">295</span><br><span class="line">296</span><br><span class="line">297</span><br><span class="line">298</span><br><span class="line">299</span><br><span class="line">300</span><br><span class="line">301</span><br><span class="line">302</span><br><span class="line">303</span><br><span class="line">304</span><br><span class="line">305</span><br><span class="line">306</span><br><span class="line">307</span><br><span class="line">308</span><br><span class="line">309</span><br><span class="line">310</span><br><span class="line">311</span><br><span class="line">312</span><br><span class="line">313</span><br><span class="line">314</span><br><span class="line">315</span><br><span class="line">316</span><br><span class="line">317</span><br><span class="line">318</span><br><span class="line">319</span><br><span class="line">320</span><br><span class="line">321</span><br><span class="line">322</span><br><span class="line">323</span><br><span class="line">324</span><br><span class="line">325</span><br><span class="line">326</span><br><span class="line">327</span><br><span class="line">328</span><br><span class="line">329</span><br><span class="line">330</span><br><span class="line">331</span><br><span class="line">332</span><br><span class="line">333</span><br><span class="line">334</span><br><span class="line">335</span><br><span class="line">336</span><br><span class="line">337</span><br><span class="line">338</span><br><span class="line">339</span><br><span class="line">340</span><br><span class="line">341</span><br><span class="line">342</span><br><span class="line">343</span><br><span class="line">344</span><br><span class="line">345</span><br><span class="line">346</span><br><span class="line">347</span><br><span class="line">348</span><br><span class="line">349</span><br><span class="line">350</span><br><span class="line">351</span><br><span class="line">352</span><br><span class="line">353</span><br><span class="line">354</span><br><span class="line">355</span><br><span class="line">356</span><br><span class="line">357</span><br><span class="line">358</span><br><span class="line">359</span><br><span class="line">360</span><br><span class="line">361</span><br><span class="line">362</span><br><span class="line">363</span><br><span class="line">364</span><br><span class="line">365</span><br><span class="line">366</span><br><span class="line">367</span><br><span class="line">368</span><br><span class="line">369</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">installPackageLI</span><span class="params">(InstallArgs args, PackageInstalledInfo res)</span> </span>&#123;</span><br><span class="line">    <span class="comment">//【1】获得安装时传入的参数和标志位！！</span></span><br><span class="line">    <span class="keyword">final</span> <span class="keyword">int</span> installFlags = args.installFlags;</span><br><span class="line">    <span class="keyword">final</span> String installerPackageName = args.installerPackageName;</span><br><span class="line">    <span class="keyword">final</span> String volumeUuid = args.volumeUuid;</span><br><span class="line">    <span class="keyword">final</span> File tmpPackageFile = <span class="keyword">new</span> File(args.getCodePath());</span><br><span class="line">    <span class="keyword">final</span> <span class="keyword">boolean</span> forwardLocked = ((installFlags &amp; PackageManager.INSTALL_FORWARD_LOCK) != <span class="number">0</span>);</span><br><span class="line">    <span class="keyword">final</span> <span class="keyword">boolean</span> onExternal = (((installFlags &amp; PackageManager.INSTALL_EXTERNAL) != <span class="number">0</span>)</span><br><span class="line">            || (args.volumeUuid != <span class="keyword">null</span>));</span><br><span class="line">    <span class="keyword">final</span> <span class="keyword">boolean</span> ephemeral = ((installFlags &amp; PackageManager.INSTALL_EPHEMERAL) != <span class="number">0</span>);</span><br><span class="line">    <span class="keyword">final</span> <span class="keyword">boolean</span> forceSdk = ((installFlags &amp; PackageManager.INSTALL_FORCE_SDK) != <span class="number">0</span>);</span><br><span class="line">    <span class="keyword">boolean</span> replace = <span class="keyword">false</span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//【2】重新设置扫描参数</span></span><br><span class="line">    <span class="keyword">int</span> scanFlags = SCAN_NEW_INSTALL | SCAN_UPDATE_SIGNATURE;</span><br><span class="line">    <span class="keyword">if</span> (args.move != <span class="keyword">null</span>) &#123;</span><br><span class="line">        <span class="comment">//【2.1】如果 args.move 不为 null，表示正在移动一个 app，我们会对其进行一个初始化的扫描</span></span><br><span class="line">        <span class="comment">// 增加 SCAN_INITIAL 位！</span></span><br><span class="line">        scanFlags |= SCAN_INITIAL;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span> ((installFlags &amp; PackageManager.INSTALL_DONT_KILL_APP) != <span class="number">0</span>) &#123; </span><br><span class="line">        <span class="comment">//【2.2】如果安装参数指定了 INSTALL_DONT_KILL_APP，那么增加 SCAN_DONT_KILL_APP 位！</span></span><br><span class="line">        scanFlags |= SCAN_DONT_KILL_APP;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//【3】更新结果码！</span></span><br><span class="line">    res.setReturnCode(PackageManager.INSTALL_SUCCEEDED);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (DEBUG_INSTALL) Slog.d(TAG, <span class="string">"installPackageLI: path="</span> + tmpPackageFile);</span><br><span class="line"></span><br><span class="line">    <span class="comment">//【4】检查 ephemeral 是否和 forwardLocked/onExternal 共存，共存则报错！</span></span><br><span class="line">    <span class="keyword">if</span> (ephemeral &amp;&amp; (forwardLocked || onExternal)) &#123;</span><br><span class="line">        Slog.i(TAG, <span class="string">"Incompatible ephemeral install; fwdLocked="</span> + forwardLocked</span><br><span class="line">                + <span class="string">" external="</span> + onExternal);</span><br><span class="line">        res.setReturnCode(PackageManager.INSTALL_FAILED_EPHEMERAL_INVALID);</span><br><span class="line">        <span class="keyword">return</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//【5】设置解析参数 parseFlags</span></span><br><span class="line">    <span class="keyword">final</span> <span class="keyword">int</span> parseFlags = mDefParseFlags | PackageParser.PARSE_CHATTY</span><br><span class="line">            | PackageParser.PARSE_ENFORCE_CODE</span><br><span class="line">            | (forwardLocked ? PackageParser.PARSE_FORWARD_LOCK : <span class="number">0</span>)</span><br><span class="line">            | (onExternal ? PackageParser.PARSE_EXTERNAL_STORAGE : <span class="number">0</span>)</span><br><span class="line">            | (ephemeral ? PackageParser.PARSE_IS_EPHEMERAL : <span class="number">0</span>)</span><br><span class="line">            | (forceSdk ? PackageParser.PARSE_FORCE_SDK : <span class="number">0</span>);</span><br><span class="line"></span><br><span class="line">    <span class="comment">//【6】创建解析对象！</span></span><br><span class="line">    PackageParser pp = <span class="keyword">new</span> PackageParser();</span><br><span class="line">    pp.setSeparateProcesses(mSeparateProcesses);</span><br><span class="line">    pp.setDisplayMetrics(mMetrics);</span><br><span class="line"></span><br><span class="line">    Trace.traceBegin(TRACE_TAG_PACKAGE_MANAGER, <span class="string">"parsePackage"</span>);</span><br><span class="line">    <span class="keyword">final</span> PackageParser.Package pkg;</span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">        <span class="comment">//【*5.7.3.1】解析 apk，获得其对应的 Package 对象！</span></span><br><span class="line">        pkg = pp.parsePackage(tmpPackageFile, parseFlags);</span><br><span class="line">    &#125; <span class="keyword">catch</span> (PackageParserException e) &#123;</span><br><span class="line">        res.setError(<span class="string">"Failed parse during installPackageLI"</span>, e);</span><br><span class="line">        <span class="keyword">return</span>;</span><br><span class="line">    &#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">        Trace.traceEnd(TRACE_TAG_PACKAGE_MANAGER);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//【7】如果该应用有子包的话，那么对于每个子包，也会创建安装结果对象！！</span></span><br><span class="line">    <span class="keyword">if</span> (pkg.childPackages != <span class="keyword">null</span>) &#123;</span><br><span class="line">        <span class="keyword">synchronized</span> (mPackages) &#123;</span><br><span class="line">            <span class="keyword">final</span> <span class="keyword">int</span> childCount = pkg.childPackages.size();</span><br><span class="line">            <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; childCount; i++) &#123;</span><br><span class="line">                PackageParser.Package childPkg = pkg.childPackages.get(i);</span><br><span class="line">                <span class="comment">//【*5.7.1】针对子包，创建 PackageInstalledInfo 对象!</span></span><br><span class="line">                <span class="comment">// 设置返回码，子包包名！</span></span><br><span class="line">                PackageInstalledInfo childRes = <span class="keyword">new</span> PackageInstalledInfo();</span><br><span class="line">                childRes.setReturnCode(PackageManager.INSTALL_SUCCEEDED);</span><br><span class="line">                childRes.pkg = childPkg;</span><br><span class="line">                childRes.name = childPkg.packageName;</span><br><span class="line">                <span class="comment">//【7.1】获得子包的源 user!</span></span><br><span class="line">                PackageSetting childPs = mSettings.peekPackageLPr(childPkg.packageName);</span><br><span class="line">                <span class="keyword">if</span> (childPs != <span class="keyword">null</span>) &#123;</span><br><span class="line">                    childRes.origUsers = childPs.queryInstalledUsers(</span><br><span class="line">                            sUserManager.getUserIds(), <span class="keyword">true</span>);</span><br><span class="line">                &#125;</span><br><span class="line">                <span class="comment">//【7.2】如果子包之前被扫描到了（安装过），创建 PackageRemovedInfo 对象！</span></span><br><span class="line">                <span class="keyword">if</span> ((mPackages.containsKey(childPkg.packageName))) &#123;</span><br><span class="line">                    childRes.removedInfo = <span class="keyword">new</span> PackageRemovedInfo();</span><br><span class="line">                    childRes.removedInfo.removedPackage = childPkg.packageName;</span><br><span class="line">                &#125;</span><br><span class="line">                <span class="keyword">if</span> (res.addedChildPackages == <span class="keyword">null</span>) &#123;</span><br><span class="line">                    res.addedChildPackages = <span class="keyword">new</span> ArrayMap&lt;&gt;();</span><br><span class="line">                &#125;</span><br><span class="line">                <span class="comment">//【7.3】将子包的安装结果对象保存到 base apk 的信息中！</span></span><br><span class="line">                res.addedChildPackages.put(childPkg.packageName, childRes);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// 如果应用没有指定 abi，我们通过安装参数指定！</span></span><br><span class="line">    <span class="keyword">if</span> (TextUtils.isEmpty(pkg.cpuAbiOverride)) &#123;</span><br><span class="line">        pkg.cpuAbiOverride = args.abiOverride;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// 如果应用指定了 ApplicationInfo.FLAG_TEST_ONLY，那么安装参数也需要指定这个参数！</span></span><br><span class="line">    String pkgName = res.name = pkg.packageName;</span><br><span class="line">    <span class="keyword">if</span> ((pkg.applicationInfo.flags&amp;ApplicationInfo.FLAG_TEST_ONLY) != <span class="number">0</span>) &#123;</span><br><span class="line">        <span class="keyword">if</span> ((installFlags &amp; PackageManager.INSTALL_ALLOW_TEST) == <span class="number">0</span>) &#123;</span><br><span class="line">            res.setError(INSTALL_FAILED_TEST_ONLY, <span class="string">"installPackageLI"</span>);</span><br><span class="line">            <span class="keyword">return</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">        <span class="comment">//【8】收集证书信息！</span></span><br><span class="line">        <span class="keyword">if</span> (args.certificates != <span class="keyword">null</span>) &#123;</span><br><span class="line">            <span class="keyword">try</span> &#123;</span><br><span class="line">                PackageParser.populateCertificates(pkg, args.certificates);</span><br><span class="line">            &#125; <span class="keyword">catch</span> (PackageParserException e) &#123;</span><br><span class="line">                PackageParser.collectCertificates(pkg, parseFlags);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            PackageParser.collectCertificates(pkg, parseFlags);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125; <span class="keyword">catch</span> (PackageParserException e) &#123;</span><br><span class="line">        res.setError(<span class="string">"Failed collect during installPackageLI"</span>, e);</span><br><span class="line">        <span class="keyword">return</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// Get rid of all references to package scan path via parser.</span></span><br><span class="line">    pp = <span class="keyword">null</span>;</span><br><span class="line">    String oldCodePath = <span class="keyword">null</span>;</span><br><span class="line">    <span class="keyword">boolean</span> systemApp = <span class="keyword">false</span>;</span><br><span class="line">    <span class="keyword">synchronized</span> (mPackages) &#123;</span><br><span class="line">        <span class="comment">//【9】如果安装参数指定了 INSTALL_REPLACE_EXISTING，那么我们要尝试判断是否存在已安装的应用！</span></span><br><span class="line">        <span class="comment">// 如果存在，那就要 replace！</span></span><br><span class="line">        <span class="keyword">if</span> ((installFlags &amp; PackageManager.INSTALL_REPLACE_EXISTING) != <span class="number">0</span>) &#123;</span><br><span class="line">            String oldName = mSettings.mRenamedPackages.get(pkgName); <span class="comment">// 判断该应用是否重命名过！</span></span><br><span class="line">            <span class="keyword">if</span> (pkg.mOriginalPackages != <span class="keyword">null</span></span><br><span class="line">                    &amp;&amp; pkg.mOriginalPackages.contains(oldName)</span><br><span class="line">                    &amp;&amp; mPackages.containsKey(oldName)) &#123;</span><br><span class="line"></span><br><span class="line">                <span class="comment">//【9.1】如果有源包（系统应用才会有），要命名为源包，replace 为 true！</span></span><br><span class="line">                pkg.setPackageName(oldName);</span><br><span class="line">                pkgName = pkg.packageName;</span><br><span class="line">                replace = <span class="keyword">true</span>;</span><br><span class="line">                <span class="keyword">if</span> (DEBUG_INSTALL) Slog.d(TAG, <span class="string">"Replacing existing renamed package: oldName="</span></span><br><span class="line">                        + oldName + <span class="string">" pkgName="</span> + pkgName);</span><br><span class="line"></span><br><span class="line">            &#125; <span class="keyword">else</span> <span class="keyword">if</span> (mPackages.containsKey(pkgName)) &#123;</span><br><span class="line">                <span class="comment">//【9.2】如果没有源包（系统应用才会有），但是已经有相同包名的应用存在，replace 为 true！</span></span><br><span class="line">                replace = <span class="keyword">true</span>;</span><br><span class="line">                <span class="keyword">if</span> (DEBUG_INSTALL) Slog.d(TAG, <span class="string">"Replace existing pacakge: "</span> + pkgName);</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            <span class="comment">//【9.2】对于子包，只能通过父包更新，这里不处理子包的 replace！</span></span><br><span class="line">            <span class="keyword">if</span> (pkg.parentPackage != <span class="keyword">null</span>) &#123;</span><br><span class="line">                res.setError(PackageManager.INSTALL_PARSE_FAILED_BAD_PACKAGE_NAME,</span><br><span class="line">                        <span class="string">"Package "</span> + pkg.packageName + <span class="string">" is child of package "</span></span><br><span class="line">                                + pkg.parentPackage.parentPackage + <span class="string">". Child packages "</span></span><br><span class="line">                                + <span class="string">"can be updated only through the parent package."</span>);</span><br><span class="line">                <span class="keyword">return</span>;</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            <span class="comment">//【9.3】如果需要替换已存在的 apk，那么需要做 sdk 的校验！</span></span><br><span class="line">            <span class="comment">// 如果旧应用支持运行时，不允许新的应用不支持运行时！</span></span><br><span class="line">            <span class="keyword">if</span> (replace) &#123;</span><br><span class="line">                PackageParser.Package oldPackage = mPackages.get(pkgName);</span><br><span class="line">                <span class="keyword">final</span> <span class="keyword">int</span> oldTargetSdk = oldPackage.applicationInfo.targetSdkVersion;</span><br><span class="line">                <span class="keyword">final</span> <span class="keyword">int</span> newTargetSdk = pkg.applicationInfo.targetSdkVersion;</span><br><span class="line">                <span class="keyword">if</span> (oldTargetSdk &gt; Build.VERSION_CODES.LOLLIPOP_MR1</span><br><span class="line">                        &amp;&amp; newTargetSdk &lt;= Build.VERSION_CODES.LOLLIPOP_MR1) &#123;</span><br><span class="line">                    res.setError(PackageManager.INSTALL_FAILED_PERMISSION_MODEL_DOWNGRADE,</span><br><span class="line">                            <span class="string">"Package "</span> + pkg.packageName + <span class="string">" new target SDK "</span> + newTargetSdk</span><br><span class="line">                                    + <span class="string">" doesn't support runtime permissions but the old"</span></span><br><span class="line">                                    + <span class="string">" target SDK "</span> + oldTargetSdk + <span class="string">" does."</span>);</span><br><span class="line">                    <span class="keyword">return</span>;</span><br><span class="line">                &#125;</span><br><span class="line"></span><br><span class="line">                <span class="comment">//【9.4】如果旧包也是子包，也不安装！</span></span><br><span class="line">                <span class="keyword">if</span> (oldPackage.parentPackage != <span class="keyword">null</span>) &#123;</span><br><span class="line">                    res.setError(PackageManager.INSTALL_PARSE_FAILED_BAD_PACKAGE_NAME,</span><br><span class="line">                            <span class="string">"Package "</span> + pkg.packageName + <span class="string">" is child of package "</span></span><br><span class="line">                                    + oldPackage.parentPackage + <span class="string">". Child packages "</span></span><br><span class="line">                                    + <span class="string">"can be updated only through the parent package."</span>);</span><br><span class="line">                    <span class="keyword">return</span>;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        </span><br><span class="line">        <span class="comment">//【10】获得上一次的安装数据！</span></span><br><span class="line">        PackageSetting ps = mSettings.mPackages.get(pkgName);</span><br><span class="line">        <span class="keyword">if</span> (ps != <span class="keyword">null</span>) &#123;</span><br><span class="line">            <span class="keyword">if</span> (DEBUG_INSTALL) Slog.d(TAG, <span class="string">"Existing package: "</span> + ps);</span><br><span class="line">            <span class="comment">//【10.1】如果安装过旧版本，那就要校验签名！</span></span><br><span class="line">            <span class="comment">//【×5.3.7.2】shouldCheckUpgradeKeySetLP 用于判断是否检查签名更新；</span></span><br><span class="line">            <span class="keyword">if</span> (shouldCheckUpgradeKeySetLP(ps, scanFlags)) &#123;</span><br><span class="line">                <span class="comment">//【×5.3.7.3】checkUpgradeKeySetLP 用于检查签名更新；</span></span><br><span class="line">                <span class="keyword">if</span> (!checkUpgradeKeySetLP(ps, pkg)) &#123;</span><br><span class="line">                    res.setError(INSTALL_FAILED_UPDATE_INCOMPATIBLE, <span class="string">"Package "</span></span><br><span class="line">                            + pkg.packageName + <span class="string">" upgrade keys do not match the "</span></span><br><span class="line">                            + <span class="string">"previously installed version"</span>);</span><br><span class="line">                    <span class="keyword">return</span>;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                <span class="keyword">try</span> &#123;</span><br><span class="line">                    <span class="comment">//【×5.3.7.4】校验签名，如果签名不相等，那就禁止安装！</span></span><br><span class="line">                    verifySignaturesLP(ps, pkg);</span><br><span class="line">                &#125; <span class="keyword">catch</span> (PackageManagerException e) &#123;</span><br><span class="line">                    res.setError(e.error, e.getMessage());</span><br><span class="line">                    <span class="keyword">return</span>;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="comment">//【10.2】获得旧的 apk 的路径，判断旧应用是否是系统应用！</span></span><br><span class="line">            oldCodePath = mSettings.mPackages.get(pkgName).codePathString;</span><br><span class="line">            <span class="keyword">if</span> (ps.pkg != <span class="keyword">null</span> &amp;&amp; ps.pkg.applicationInfo != <span class="keyword">null</span>) &#123;</span><br><span class="line">                systemApp = (ps.pkg.applicationInfo.flags &amp;</span><br><span class="line">                        ApplicationInfo.FLAG_SYSTEM) != <span class="number">0</span>;</span><br><span class="line">            &#125;</span><br><span class="line">            res.origUsers = ps.queryInstalledUsers(sUserManager.getUserIds(), <span class="keyword">true</span>);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment">//【11】检查权限是否被重新定义，如果重新定义，那就要校验权限！</span></span><br><span class="line">        <span class="keyword">int</span> N = pkg.permissions.size();</span><br><span class="line">        <span class="keyword">for</span> (<span class="keyword">int</span> i = N-<span class="number">1</span>; i &gt;= <span class="number">0</span>; i--) &#123;</span><br><span class="line">            <span class="comment">//【11.1】获得该应用定义的权限</span></span><br><span class="line">            PackageParser.Permission perm = pkg.permissions.get(i);</span><br><span class="line">            <span class="comment">//【11.2】尝试从系统中获得该权限已有的信息！</span></span><br><span class="line">            BasePermission bp = mSettings.mPermissions.get(perm.info.name);</span><br><span class="line">            <span class="keyword">if</span> (bp != <span class="keyword">null</span>) &#123;</span><br><span class="line">                <span class="comment">//【11.3】如果该权限已经被定义过了，那就要校验下签名！</span></span><br><span class="line">                <span class="keyword">final</span> <span class="keyword">boolean</span> sigsOk;</span><br><span class="line">                <span class="keyword">if</span> (bp.sourcePackage.equals(pkg.packageName)</span><br><span class="line">                        &amp;&amp; (bp.packageSetting <span class="keyword">instanceof</span> PackageSetting)</span><br><span class="line">                        &amp;&amp; (shouldCheckUpgradeKeySetLP((PackageSetting) bp.packageSetting,</span><br><span class="line">                                scanFlags))) &#123;</span><br><span class="line">                    <span class="comment">//【11.3.1】检查签名更新！</span></span><br><span class="line">                    sigsOk = checkUpgradeKeySetLP((PackageSetting) bp.packageSetting, pkg);</span><br><span class="line">                &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                    <span class="comment">//【11.3.2】如果不检查签名更新，那就直接比较签名！</span></span><br><span class="line">                    sigsOk = compareSignatures(bp.packageSetting.signatures.mSignatures,</span><br><span class="line">                            pkg.mSignatures) == PackageManager.SIGNATURE_MATCH;</span><br><span class="line">                &#125;</span><br><span class="line">                <span class="comment">//【11.4】如果签名发生了变化！</span></span><br><span class="line">                <span class="keyword">if</span> (!sigsOk) &#123;</span><br><span class="line">                    <span class="keyword">if</span> (!bp.sourcePackage.equals(<span class="string">"android"</span>)) &#123;</span><br><span class="line">                        <span class="comment">//【11.4.1】如果权限的定义者不是系统，那么不允许重新定义，同时不允许继续安装！</span></span><br><span class="line">                        res.setError(INSTALL_FAILED_DUPLICATE_PERMISSION, <span class="string">"Package "</span></span><br><span class="line">                                + pkg.packageName + <span class="string">" attempting to redeclare permission "</span></span><br><span class="line">                                + perm.info.name + <span class="string">" already owned by "</span> + bp.sourcePackage);</span><br><span class="line">                        res.origPermission = perm.info.name;</span><br><span class="line">                        res.origPackage = bp.sourcePackage;</span><br><span class="line">                        <span class="keyword">return</span>;</span><br><span class="line">                    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                        <span class="comment">//【11.4.2】如果权限的定义不是系统，那么允许安装，但是会忽视掉新的定义！</span></span><br><span class="line">                        Slog.w(TAG, <span class="string">"Package "</span> + pkg.packageName</span><br><span class="line">                                + <span class="string">" attempting to redeclare system permission "</span></span><br><span class="line">                                + perm.info.name + <span class="string">"; ignoring new declaration"</span>);</span><br><span class="line">                        pkg.permissions.remove(i);</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">//【12】如果覆盖更新的是系统应用，要针对安装位置做判断！</span></span><br><span class="line">    <span class="comment">// 新的 apk 不能是 onExternal / ephemeral！</span></span><br><span class="line">    <span class="keyword">if</span> (systemApp) &#123;</span><br><span class="line">        <span class="keyword">if</span> (onExternal) &#123;</span><br><span class="line">            res.setError(INSTALL_FAILED_INVALID_INSTALL_LOCATION,</span><br><span class="line">                    <span class="string">"Cannot install updates to system apps on sdcard"</span>);</span><br><span class="line">            <span class="keyword">return</span>;</span><br><span class="line">        &#125; <span class="keyword">else</span> <span class="keyword">if</span> (ephemeral) &#123;</span><br><span class="line">            res.setError(INSTALL_FAILED_EPHEMERAL_INVALID,</span><br><span class="line">                    <span class="string">"Cannot update a system app with an ephemeral app"</span>);</span><br><span class="line">            <span class="keyword">return</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//【13】根据安装参数做不同的处理！</span></span><br><span class="line">    <span class="keyword">if</span> (args.move != <span class="keyword">null</span>) &#123;</span><br><span class="line">        <span class="comment">//【13.1】如果是 move package，进入这里！</span></span><br><span class="line">        scanFlags |= SCAN_NO_DEX; <span class="comment">// 设置以下标签，无需做 odex，我们需要已有的移动过去即可！</span></span><br><span class="line">        scanFlags |= SCAN_MOVE;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">synchronized</span> (mPackages) &#123;</span><br><span class="line">            <span class="keyword">final</span> PackageSetting ps = mSettings.mPackages.get(pkgName);</span><br><span class="line">            <span class="keyword">if</span> (ps == <span class="keyword">null</span>) &#123;</span><br><span class="line">                res.setError(INSTALL_FAILED_INTERNAL_ERROR,</span><br><span class="line">                        <span class="string">"Missing settings for moved package "</span> + pkgName);</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            <span class="comment">//【13.1.1】对于 abi，和移动前的保持一致！</span></span><br><span class="line">            pkg.applicationInfo.primaryCpuAbi = ps.primaryCpuAbiString;</span><br><span class="line">            pkg.applicationInfo.secondaryCpuAbi = ps.secondaryCpuAbiString;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">    &#125; <span class="keyword">else</span> <span class="keyword">if</span> (!forwardLocked &amp;&amp; !pkg.applicationInfo.isExternalAsec()) &#123;</span><br><span class="line">        <span class="comment">//【13.2】如果不是 forward lock 模式安装且没有安装到外置存储上，进入这里！</span></span><br><span class="line">        scanFlags |= SCAN_NO_DEX; <span class="comment">// 扫描参数设置 SCAN_NO_DEX，意味着后面不做 odex，因为这里会做！</span></span><br><span class="line"></span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            String abiOverride = (TextUtils.isEmpty(pkg.cpuAbiOverride) ?</span><br><span class="line">                args.abiOverride : pkg.cpuAbiOverride);</span><br><span class="line">            derivePackageAbi(pkg, <span class="keyword">new</span> File(pkg.codePath), abiOverride,</span><br><span class="line">                    <span class="keyword">true</span> <span class="comment">/* extract libs */</span>);</span><br><span class="line">        &#125; <span class="keyword">catch</span> (PackageManagerException pme) &#123;</span><br><span class="line">            Slog.e(TAG, <span class="string">"Error deriving application ABI"</span>, pme);</span><br><span class="line">            res.setError(INSTALL_FAILED_INTERNAL_ERROR, <span class="string">"Error deriving application ABI"</span>);</span><br><span class="line">            <span class="keyword">return</span>;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment">//【13.2.1】更新共享库文件！！</span></span><br><span class="line">        <span class="keyword">synchronized</span> (mPackages) &#123;</span><br><span class="line">            <span class="keyword">try</span> &#123;</span><br><span class="line">                updateSharedLibrariesLPw(pkg, <span class="keyword">null</span>);</span><br><span class="line">            &#125; <span class="keyword">catch</span> (PackageManagerException e) &#123;</span><br><span class="line">                Slog.e(TAG, <span class="string">"updateSharedLibrariesLPw failed: "</span> + e.getMessage());</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        Trace.traceBegin(TRACE_TAG_PACKAGE_MANAGER, <span class="string">"dexopt"</span>);</span><br><span class="line">        </span><br><span class="line">        <span class="comment">//【13.2.2】执行 odex 优化</span></span><br><span class="line">        mPackageDexOptimizer.performDexOpt(pkg, pkg.usesLibraryFiles,</span><br><span class="line">                <span class="keyword">null</span> <span class="comment">/* instructionSets */</span>, <span class="keyword">false</span> <span class="comment">/* checkProfiles */</span>,</span><br><span class="line">                getCompilerFilterForReason(REASON_INSTALL),</span><br><span class="line">                getOrCreateCompilerPackageStats(pkg));</span><br><span class="line">        Trace.traceEnd(TRACE_TAG_PACKAGE_MANAGER);</span><br><span class="line"></span><br><span class="line">        <span class="comment">//【13.2.3】将该应用从 odex fail list 中删除！</span></span><br><span class="line">        BackgroundDexOptService.notifyPackageChanged(pkg.packageName);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//【×5.7.3.5】重命名文件目录，此时文件目录由 /data/app/tmpl[SessionId].tmp 变为 /data/app/packageName-X！</span></span><br><span class="line">    <span class="comment">// 如果 X 存在，那么会 X + 1;</span></span><br><span class="line">    <span class="keyword">if</span> (!args.doRename(res.returnCode, pkg, oldCodePath)) &#123;</span><br><span class="line">        res.setError(INSTALL_FAILED_INSUFFICIENT_STORAGE, <span class="string">"Failed rename"</span>);</span><br><span class="line">        <span class="keyword">return</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//【*5.7.3.6】开始 intentFilter 校验！</span></span><br><span class="line">    startIntentFilterVerifications(args.user.getIdentifier(), replace, pkg);</span><br><span class="line"></span><br><span class="line">    <span class="comment">//【*5.7.3.7】冻结应用！</span></span><br><span class="line">    <span class="keyword">try</span> (PackageFreezer freezer = freezePackageForInstall(pkgName, installFlags,</span><br><span class="line">            <span class="string">"installPackageLI"</span>)) &#123;</span><br><span class="line">        <span class="keyword">if</span> (replace) &#123;</span><br><span class="line">            <span class="comment">//【*6】如果是覆盖安装，进入这里！</span></span><br><span class="line">            replacePackageLIF(pkg, parseFlags, scanFlags | SCAN_REPLACING, args.user,</span><br><span class="line">                    installerPackageName, res);</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            <span class="comment">//【*7】如果是全新安装，进入这里！</span></span><br><span class="line">            installNewPackageLIF(pkg, parseFlags, scanFlags | SCAN_DELETE_DATA_ON_FAILURES,</span><br><span class="line">                    args.user, installerPackageName, volumeUuid, res);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">//【14】为本次安装的 apk 更新目标用户信息！</span></span><br><span class="line">    <span class="keyword">synchronized</span> (mPackages) &#123;</span><br><span class="line">        <span class="keyword">final</span> PackageSetting ps = mSettings.mPackages.get(pkgName);</span><br><span class="line">        <span class="keyword">if</span> (ps != <span class="keyword">null</span>) &#123;</span><br><span class="line">            res.newUsers = ps.queryInstalledUsers(sUserManager.getUserIds(), <span class="keyword">true</span>);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">final</span> <span class="keyword">int</span> childCount = (pkg.childPackages != <span class="keyword">null</span>) ? pkg.childPackages.size() : <span class="number">0</span>;</span><br><span class="line">        <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; childCount; i++) &#123;</span><br><span class="line">            PackageParser.Package childPkg = pkg.childPackages.get(i);</span><br><span class="line">            PackageInstalledInfo childRes = res.addedChildPackages.get(childPkg.packageName);</span><br><span class="line">            PackageSetting childPs = mSettings.peekPackageLPr(childPkg.packageName);</span><br><span class="line">            <span class="keyword">if</span> (childPs != <span class="keyword">null</span>) &#123;</span><br><span class="line">                childRes.newUsers = childPs.queryInstalledUsers(</span><br><span class="line">                        sUserManager.getUserIds(), <span class="keyword">true</span>);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h4 id="5-7-3-1-PackageParser-parsePackage"><a href="#5-7-3-1-PackageParser-parsePackage" class="headerlink" title="5.7.3.1 PackageParser.parsePackage"></a>5.7.3.1 PackageParser.parsePackage</h4><p>PackageParser.parsePackage 其实我们在 PMS 启动扫描的过程中已经分析过了，这里我们重点关注其对 installFlags 的处理！</p>
<h4 id="5-7-3-2-shouldCheckUpgradeKeySetLP"><a href="#5-7-3-2-shouldCheckUpgradeKeySetLP" class="headerlink" title="5.7.3.2 shouldCheckUpgradeKeySetLP"></a>5.7.3.2 shouldCheckUpgradeKeySetLP</h4><p>判断是否应该检查签名更新：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">boolean</span> <span class="title">shouldCheckUpgradeKeySetLP</span><span class="params">(PackageSetting oldPs, <span class="keyword">int</span> scanFlags)</span> </span>&#123;</span><br><span class="line">    <span class="comment">//【1】以下情况无需检查签名更新：</span></span><br><span class="line">    <span class="comment">// 1、本次是全新安装；2、扫描设置了 SCAN_INITIAL(move pkg)；3、本次是覆盖安装，但是应用是 sharedUser 的！</span></span><br><span class="line">    <span class="comment">// 4、应用不使用 upgradeKeySets！</span></span><br><span class="line">    <span class="keyword">if</span> (oldPs == <span class="keyword">null</span> || (scanFlags &amp; SCAN_INITIAL) != <span class="number">0</span> || oldPs.sharedUser != <span class="keyword">null</span></span><br><span class="line">            || !oldPs.keySetData.isUsingUpgradeKeySets()) &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">false</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">//【2】如果应用是覆盖安装，且不是 move pkg，且不是共享 uid 的，且使用 upgradeKeySets，那么就要检查</span></span><br><span class="line">    <span class="comment">// upgradeKeySets 有效性，只有有效的 upgradeKeySets 才能检查更新！</span></span><br><span class="line">    KeySetManagerService ksms = mSettings.mKeySetManagerService;</span><br><span class="line">    <span class="keyword">long</span>[] upgradeKeySets = oldPs.keySetData.getUpgradeKeySets();</span><br><span class="line">    <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; upgradeKeySets.length; i++) &#123;</span><br><span class="line">        <span class="comment">//【2.1】判断 upgradeKeySets 是否有效！</span></span><br><span class="line">        <span class="keyword">if</span> (!ksms.isIdValidKeySetId(upgradeKeySets[i])) &#123;</span><br><span class="line">            Slog.wtf(TAG, <span class="string">"Package "</span></span><br><span class="line">                     + (oldPs.name != <span class="keyword">null</span> ? oldPs.name : <span class="string">"&lt;null&gt;"</span>)</span><br><span class="line">                     + <span class="string">" contains upgrade-key-set reference to unknown key-set: "</span></span><br><span class="line">                     + upgradeKeySets[i]</span><br><span class="line">                     + <span class="string">" reverting to signatures check."</span>);</span><br><span class="line">            <span class="keyword">return</span> <span class="keyword">false</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">true</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>先分析到这里！</p>
<h4 id="5-7-3-3-checkUpgradeKeySetLP"><a href="#5-7-3-3-checkUpgradeKeySetLP" class="headerlink" title="5.7.3.3 checkUpgradeKeySetLP"></a>5.7.3.3 checkUpgradeKeySetLP</h4><p>进行签名更新检查：<br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">boolean</span> <span class="title">checkUpgradeKeySetLP</span><span class="params">(PackageSetting oldPS, PackageParser.Package newPkg)</span> </span>&#123;</span><br><span class="line">    <span class="comment">//【1】检查 key set 更新，更新有效的前提是新的 apk 持有的 keyset 至少包含旧应用的 keyset！</span></span><br><span class="line">    <span class="keyword">long</span>[] upgradeKeySets = oldPS.keySetData.getUpgradeKeySets();</span><br><span class="line">    KeySetManagerService ksms = mSettings.mKeySetManagerService;</span><br><span class="line">    <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; upgradeKeySets.length; i++) &#123;</span><br><span class="line">        Set&lt;PublicKey&gt; upgradeSet = ksms.getPublicKeysFromKeySetLPr(upgradeKeySets[i]);</span><br><span class="line">        <span class="keyword">if</span> (upgradeSet != <span class="keyword">null</span> &amp;&amp; newPkg.mSigningKeys.containsAll(upgradeSet)) &#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="keyword">true</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">false</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<h4 id="5-7-3-4-verifySignaturesLP"><a href="#5-7-3-4-verifySignaturesLP" class="headerlink" title="5.7.3.4 verifySignaturesLP"></a>5.7.3.4 verifySignaturesLP</h4><p>校验签名：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">verifySignaturesLP</span><span class="params">(PackageSetting pkgSetting, PackageParser.Package pkg)</span></span></span><br><span class="line"><span class="function">        <span class="keyword">throws</span> PackageManagerException </span>&#123;</span><br><span class="line">    <span class="keyword">if</span> (pkgSetting.signatures.mSignatures != <span class="keyword">null</span>) &#123;</span><br><span class="line">        <span class="comment">// Already existing package. Make sure signatures match</span></span><br><span class="line">        <span class="keyword">boolean</span> match = compareSignatures(pkgSetting.signatures.mSignatures, pkg.mSignatures)</span><br><span class="line">                == PackageManager.SIGNATURE_MATCH;</span><br><span class="line">        <span class="keyword">if</span> (!match) &#123;</span><br><span class="line">            match = compareSignaturesCompat(pkgSetting.signatures, pkg)</span><br><span class="line">                    == PackageManager.SIGNATURE_MATCH;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">if</span> (!match) &#123;</span><br><span class="line">            match = compareSignaturesRecover(pkgSetting.signatures, pkg)</span><br><span class="line">                    == PackageManager.SIGNATURE_MATCH;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">if</span> (!match) &#123;</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> PackageManagerException(INSTALL_FAILED_UPDATE_INCOMPATIBLE, <span class="string">"Package "</span></span><br><span class="line">                    + pkg.packageName + <span class="string">" signatures do not match the "</span></span><br><span class="line">                    + <span class="string">"previously installed version; ignoring!"</span>);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// Check for shared user signatures</span></span><br><span class="line">    <span class="keyword">if</span> (pkgSetting.sharedUser != <span class="keyword">null</span> &amp;&amp; pkgSetting.sharedUser.signatures.mSignatures != <span class="keyword">null</span>) &#123;</span><br><span class="line">        <span class="comment">// Already existing package. Make sure signatures match</span></span><br><span class="line">        <span class="keyword">boolean</span> match = compareSignatures(pkgSetting.sharedUser.signatures.mSignatures,</span><br><span class="line">                pkg.mSignatures) == PackageManager.SIGNATURE_MATCH;</span><br><span class="line">        <span class="keyword">if</span> (!match) &#123;</span><br><span class="line">            match = compareSignaturesCompat(pkgSetting.sharedUser.signatures, pkg)</span><br><span class="line">                    == PackageManager.SIGNATURE_MATCH;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">if</span> (!match) &#123;</span><br><span class="line">            match = compareSignaturesRecover(pkgSetting.sharedUser.signatures, pkg)</span><br><span class="line">                    == PackageManager.SIGNATURE_MATCH;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">if</span> (!match) &#123;</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> PackageManagerException(INSTALL_FAILED_SHARED_USER_INCOMPATIBLE,</span><br><span class="line">                    <span class="string">"Package "</span> + pkg.packageName</span><br><span class="line">                    + <span class="string">" has no signatures that match those in shared user "</span></span><br><span class="line">                    + pkgSetting.sharedUser.name + <span class="string">"; ignoring!"</span>);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h4 id="5-7-3-5-FileInstallArgs-doRename-重命名临时目录"><a href="#5-7-3-5-FileInstallArgs-doRename-重命名临时目录" class="headerlink" title="5.7.3.5 FileInstallArgs.doRename - 重命名临时目录"></a>5.7.3.5 FileInstallArgs.doRename - 重命名临时目录</h4><p>doRename 重命名文件！之前我们的临时目录为 /data/app/tmpl[SessionId].tmp，这里会将其重命名为 /data/app/packageName-X！！</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">boolean</span> <span class="title">doRename</span><span class="params">(<span class="keyword">int</span> status, PackageParser.Package pkg, String oldCodePath)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">if</span> (status != PackageManager.INSTALL_SUCCEEDED) &#123;</span><br><span class="line">        cleanUp();</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">false</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">//【1】获得改名前的临时目录 targetDir 就是 /data/app/tmpl[SessionId].tmp！</span></span><br><span class="line">    <span class="keyword">final</span> File targetDir = codeFile.getParentFile();</span><br><span class="line">    <span class="keyword">final</span> File beforeCodeFile = codeFile;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//【5.7.3.5.1】获得改名后的目录：/data/app/packageName-X，策略取决为 getNextCodePath！</span></span><br><span class="line">    <span class="keyword">final</span> File afterCodeFile = getNextCodePath(targetDir, pkg.packageName);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (DEBUG_INSTALL) Slog.d(TAG, <span class="string">"Renaming "</span> + beforeCodeFile + <span class="string">" to "</span> + afterCodeFile);</span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">        Os.rename(beforeCodeFile.getAbsolutePath(), afterCodeFile.getAbsolutePath());</span><br><span class="line">    &#125; <span class="keyword">catch</span> (ErrnoException e) &#123;</span><br><span class="line">        Slog.w(TAG, <span class="string">"Failed to rename"</span>, e);</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">false</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">//【2】恢复默认的安全上下文！</span></span><br><span class="line">    <span class="keyword">if</span> (!SELinux.restoreconRecursive(afterCodeFile)) &#123;</span><br><span class="line">        Slog.w(TAG, <span class="string">"Failed to restorecon"</span>);</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">false</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//【3】更新 FileInstallArgs 的目录为最终目录！</span></span><br><span class="line">    codeFile = afterCodeFile;</span><br><span class="line">    resourceFile = afterCodeFile;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//【4】更新扫描到的应用的 Package 中的目录数据！</span></span><br><span class="line">    <span class="comment">// 以及 Application 中的数据！</span></span><br><span class="line">    pkg.setCodePath(afterCodeFile.getAbsolutePath());</span><br><span class="line">    pkg.setBaseCodePath(FileUtils.rewriteAfterRename(beforeCodeFile,</span><br><span class="line">            afterCodeFile, pkg.baseCodePath));</span><br><span class="line">    pkg.setSplitCodePaths(FileUtils.rewriteAfterRename(beforeCodeFile,</span><br><span class="line">            afterCodeFile, pkg.splitCodePaths));</span><br><span class="line"></span><br><span class="line">    pkg.setApplicationVolumeUuid(pkg.volumeUuid);</span><br><span class="line">    pkg.setApplicationInfoCodePath(pkg.codePath);</span><br><span class="line">    pkg.setApplicationInfoBaseCodePath(pkg.baseCodePath);</span><br><span class="line">    pkg.setApplicationInfoSplitCodePaths(pkg.splitCodePaths);</span><br><span class="line">    pkg.setApplicationInfoResourcePath(pkg.codePath);</span><br><span class="line">    pkg.setApplicationInfoBaseResourcePath(pkg.baseCodePath);</span><br><span class="line">    pkg.setApplicationInfoSplitResourcePaths(pkg.splitCodePaths);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">true</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>流程很简单，不多说了！</p>
<h5 id="5-7-3-5-1-getNextCodePath"><a href="#5-7-3-5-1-getNextCodePath" class="headerlink" title="5.7.3.5.1 getNextCodePath"></a>5.7.3.5.1 getNextCodePath</h5><p>getNextCodePath 方法用于获得最终的目录！</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">private</span> File <span class="title">getNextCodePath</span><span class="params">(File targetDir, String packageName)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">int</span> suffix = <span class="number">1</span>;</span><br><span class="line">    File result;</span><br><span class="line">    <span class="keyword">do</span> &#123;</span><br><span class="line">        <span class="comment">//【1】最终目录为 /data/app/packageName-X(X=1,2,3...)</span></span><br><span class="line">        <span class="comment">// suffix 从 1 开始，如果 suffix 已存在，那就 +1;</span></span><br><span class="line">        result = <span class="keyword">new</span> File(targetDir, packageName + <span class="string">"-"</span> + suffix);</span><br><span class="line">        suffix++;</span><br><span class="line">    &#125; <span class="keyword">while</span> (result.exists());</span><br><span class="line">    <span class="keyword">return</span> result;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>逻辑很简单，不多说了！</p>
<h4 id="5-7-3-7-freezePackageForInstall-冻结应用"><a href="#5-7-3-7-freezePackageForInstall-冻结应用" class="headerlink" title="5.7.3.7 freezePackageForInstall - 冻结应用"></a>5.7.3.7 freezePackageForInstall - 冻结应用</h4><p>该方法用于冻结应用：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> PackageFreezer <span class="title">freezePackageForInstall</span><span class="params">(String packageName, <span class="keyword">int</span> installFlags,</span></span></span><br><span class="line"><span class="function"><span class="params">        String killReason)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">return</span> freezePackageForInstall(packageName, UserHandle.USER_ALL, installFlags, killReason);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>继续来看：<br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> PackageFreezer <span class="title">freezePackageForInstall</span><span class="params">(String packageName, <span class="keyword">int</span> userId, <span class="keyword">int</span> installFlags,</span></span></span><br><span class="line"><span class="function"><span class="params">        String killReason)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">if</span> ((installFlags &amp; PackageManager.INSTALL_DONT_KILL_APP) != <span class="number">0</span>) &#123;</span><br><span class="line">        <span class="comment">//【1】如果指定了卸载时不 kill app，就用默认的参数（卸载时才会进入）</span></span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> PackageFreezer();</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        <span class="comment">//【2】默认是需要 kill app 的，调用 freezePackage！</span></span><br><span class="line">        <span class="keyword">return</span> freezePackage(packageName, userId, killReason);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>继续调用 freezePackage 方法：<br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> PackageFreezer <span class="title">freezePackage</span><span class="params">(String packageName, <span class="keyword">int</span> userId, String killReason)</span> </span>&#123;</span><br><span class="line">    <span class="comment">//【×5.7.3.7.1】创建了一个 PackageFreezer 实例！</span></span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">new</span> PackageFreezer(packageName, userId, killReason);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<h5 id="5-7-3-7-1-new-PackageFreezer"><a href="#5-7-3-7-1-new-PackageFreezer" class="headerlink" title="5.7.3.7.1 new PackageFreezer"></a>5.7.3.7.1 new PackageFreezer</h5><p>如果不杀进程，那就只创建一个 PackageFreezer 实例，并返回，不做任何事情！</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="title">PackageFreezer</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    mPackageName = <span class="keyword">null</span>;</span><br><span class="line">    mChildren = <span class="keyword">null</span>;</span><br><span class="line">    mWeFroze = <span class="keyword">false</span>;</span><br><span class="line">    mCloseGuard.open(<span class="string">"close"</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>如果要 kill app，那么会创建 PackageFreezer（父包和子包），并且会杀掉进程！</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="title">PackageFreezer</span><span class="params">(String packageName, <span class="keyword">int</span> userId, String killReason)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">synchronized</span> (mPackages) &#123;</span><br><span class="line">        mPackageName = packageName;</span><br><span class="line">        mWeFroze = mFrozenPackages.add(mPackageName);</span><br><span class="line"></span><br><span class="line">        <span class="keyword">final</span> PackageSetting ps = mSettings.mPackages.get(mPackageName);</span><br><span class="line">        <span class="keyword">if</span> (ps != <span class="keyword">null</span>) &#123;</span><br><span class="line">            <span class="comment">//【1】杀掉父包的进程!</span></span><br><span class="line">            killApplication(ps.name, ps.appId, userId, killReason);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">final</span> PackageParser.Package p = mPackages.get(packageName);</span><br><span class="line">        <span class="keyword">if</span> (p != <span class="keyword">null</span> &amp;&amp; p.childPackages != <span class="keyword">null</span>) &#123;</span><br><span class="line">            <span class="keyword">final</span> <span class="keyword">int</span> N = p.childPackages.size();</span><br><span class="line">            mChildren = <span class="keyword">new</span> PackageFreezer[N];</span><br><span class="line">            <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; N; i++) &#123;</span><br><span class="line">                <span class="comment">//【2】为子包创建 PackageFreezer，并杀掉子包的进程！</span></span><br><span class="line">                mChildren[i] = <span class="keyword">new</span> PackageFreezer(p.childPackages.get(i).packageName,</span><br><span class="line">                        userId, killReason);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            mChildren = <span class="keyword">null</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    mCloseGuard.open(<span class="string">"close"</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>这里就不多说了！！</p>
<h3 id="5-7-4-FileInstallArgs-doPostInstall"><a href="#5-7-4-FileInstallArgs-doPostInstall" class="headerlink" title="5.7.4 FileInstallArgs.doPostInstall"></a>5.7.4 FileInstallArgs.doPostInstall</h3><p>清理操作，正常情况不会触发！</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">doPostInstall</span><span class="params">(<span class="keyword">int</span> status, <span class="keyword">int</span> uid)</span> </span>&#123;</span><br><span class="line">    <span class="comment">//【1】如果安装前的状态不是 PackageManager.INSTALL_SUCCEEDED</span></span><br><span class="line">    <span class="keyword">if</span> (status != PackageManager.INSTALL_SUCCEEDED) &#123;</span><br><span class="line">        <span class="comment">//【5.7.2.1】执行清理操作！</span></span><br><span class="line">        cleanUp();</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> status;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h3 id="5-7-5-new-PostInstallData"><a href="#5-7-5-new-PostInstallData" class="headerlink" title="5.7.5 new PostInstallData"></a>5.7.5 new PostInstallData</h3><p>又创建了一个 PostInstallData 对象，对 PackageInstalledInfo 做了再次封装：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">static</span> <span class="class"><span class="keyword">class</span> <span class="title">PostInstallData</span> </span>&#123;</span><br><span class="line">    <span class="keyword">public</span> InstallArgs args;</span><br><span class="line">    <span class="keyword">public</span> PackageInstalledInfo res;</span><br><span class="line"></span><br><span class="line">    PostInstallData(InstallArgs _a, PackageInstalledInfo _r) &#123;</span><br><span class="line">        args = _a;</span><br><span class="line">        res = _r;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>继续来看！!</p>
<h2 id="5-8-PackageHandler-doHandleMessage-POST-INSTALL-安装收尾"><a href="#5-8-PackageHandler-doHandleMessage-POST-INSTALL-安装收尾" class="headerlink" title="5.8 PackageHandler.doHandleMessage[POST_INSTALL] - 安装收尾"></a>5.8 PackageHandler.doHandleMessage[POST_INSTALL] - 安装收尾</h2><p>PackageHandler 会处理 POST_INSTALL 消息，此时已经处于安装收尾阶段：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">case</span> POST_INSTALL: &#123;</span><br><span class="line">    <span class="keyword">if</span> (DEBUG_INSTALL) Log.v(TAG, <span class="string">"Handling post-install for "</span> + msg.arg1);</span><br><span class="line"></span><br><span class="line">    <span class="comment">//【1】我们在安装开始前，会用 PostInstallData 封装安装结果，并保存到 mRunningInstalls 中！</span></span><br><span class="line">    <span class="comment">// 在安装结束后，会处理本次的安装结果！</span></span><br><span class="line">    PostInstallData data = mRunningInstalls.get(msg.arg1);</span><br><span class="line">    <span class="keyword">final</span> <span class="keyword">boolean</span> didRestore = (msg.arg2 != <span class="number">0</span>);</span><br><span class="line">    mRunningInstalls.delete(msg.arg1);  <span class="comment">// 删除掉！</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (data != <span class="keyword">null</span>) &#123;</span><br><span class="line">        InstallArgs args = data.args;</span><br><span class="line">        PackageInstalledInfo parentRes = data.res;</span><br><span class="line"></span><br><span class="line">        <span class="comment">//【2】本次安装是否授予运行时权限！</span></span><br><span class="line">        <span class="keyword">final</span> <span class="keyword">boolean</span> grantPermissions = (args.installFlags</span><br><span class="line">                &amp; PackageManager.INSTALL_GRANT_RUNTIME_PERMISSIONS) != <span class="number">0</span>;</span><br><span class="line"></span><br><span class="line">        <span class="comment">//【2】本次安装是否 kill app！</span></span><br><span class="line">        <span class="keyword">final</span> <span class="keyword">boolean</span> killApp = (args.installFlags</span><br><span class="line">                &amp; PackageManager.INSTALL_DONT_KILL_APP) == <span class="number">0</span>;</span><br><span class="line">        <span class="keyword">final</span> String[] grantedPermissions = args.installGrantPermissions;</span><br><span class="line"></span><br><span class="line">        <span class="comment">//【×5.8.1】调用 handlePackagePostInstall 继续处理收尾工作！</span></span><br><span class="line">        handlePackagePostInstall(parentRes, grantPermissions, killApp,</span><br><span class="line">                grantedPermissions, didRestore, args.installerPackageName,</span><br><span class="line">                args.observer);</span><br><span class="line"></span><br><span class="line">        <span class="comment">//【3】处理子包！</span></span><br><span class="line">        <span class="keyword">final</span> <span class="keyword">int</span> childCount = (parentRes.addedChildPackages != <span class="keyword">null</span>)</span><br><span class="line">                ? parentRes.addedChildPackages.size() : <span class="number">0</span>;</span><br><span class="line">        <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; childCount; i++) &#123;</span><br><span class="line">            PackageInstalledInfo childRes = parentRes.addedChildPackages.valueAt(i);</span><br><span class="line">            </span><br><span class="line">            <span class="comment">//【×5.8.1】调用 handlePackagePostInstall 继续处理收尾工作！</span></span><br><span class="line">            handlePackagePostInstall(childRes, grantPermissions, killApp,</span><br><span class="line">                    grantedPermissions, <span class="keyword">false</span>, args.installerPackageName,</span><br><span class="line">                    args.observer);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (args.traceMethod != <span class="keyword">null</span>) &#123;</span><br><span class="line">            Trace.asyncTraceEnd(TRACE_TAG_PACKAGE_MANAGER, args.traceMethod,</span><br><span class="line">                    args.traceCookie);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        Slog.e(TAG, <span class="string">"Bogus post-install token "</span> + msg.arg1);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    Trace.asyncTraceEnd(TRACE_TAG_PACKAGE_MANAGER, <span class="string">"postInstall"</span>, msg.arg1);</span><br><span class="line">&#125; <span class="keyword">break</span>;</span><br></pre></td></tr></table></figure>
<p>继续处理！</p>
<h3 id="5-8-1-PackageManagerS-handlePackagePostInstall"><a href="#5-8-1-PackageManagerS-handlePackagePostInstall" class="headerlink" title="5.8.1 PackageManagerS.handlePackagePostInstall"></a>5.8.1 PackageManagerS.handlePackagePostInstall</h3><p>处理安装收尾工作：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">handlePackagePostInstall</span><span class="params">(PackageInstalledInfo res, <span class="keyword">boolean</span> grantPermissions,</span></span></span><br><span class="line"><span class="function"><span class="params">        <span class="keyword">boolean</span> killApp, String[] grantedPermissions,</span></span></span><br><span class="line"><span class="function"><span class="params">        <span class="keyword">boolean</span> launchedForRestore, String installerPackage,</span></span></span><br><span class="line"><span class="function"><span class="params">        IPackageInstallObserver2 installObserver)</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//【1】当安装结果为 success 后，会进入后续的处理！</span></span><br><span class="line">    <span class="keyword">if</span> (res.returnCode == PackageManager.INSTALL_SUCCEEDED) &#123;</span><br><span class="line">        <span class="comment">//【1.1】如果是 move pacakge，那么发送 removed 广播！</span></span><br><span class="line">        <span class="keyword">if</span> (res.removedInfo != <span class="keyword">null</span>) &#123;</span><br><span class="line">            res.removedInfo.sendPackageRemovedBroadcasts(killApp);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment">//【1.2】如果安装时指定了授予运行时权限，并且应用的目标 sdk 支持运行时权限，那就授予运行时权限！</span></span><br><span class="line">        <span class="keyword">if</span> (grantPermissions &amp;&amp; res.pkg.applicationInfo.targetSdkVersion</span><br><span class="line">                &gt;= Build.VERSION_CODES.M) &#123;</span><br><span class="line">            grantRequestedRuntimePermissions(res.pkg, res.newUsers, grantedPermissions);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment">//【1.3】判断安装方式，是更新安装，还是全新安装！</span></span><br><span class="line">        <span class="comment">// 我们知道，如果 res.removedInfo 不为 null 的话，一定是覆盖更新！</span></span><br><span class="line">        <span class="keyword">final</span> <span class="keyword">boolean</span> update = res.removedInfo != <span class="keyword">null</span></span><br><span class="line">                &amp;&amp; res.removedInfo.removedPackage != <span class="keyword">null</span>;</span><br><span class="line"></span><br><span class="line">        <span class="comment">//【1.4】如果被 disable 的特权应用之前没有子包，这是第一次有子包，那么我们会授予新的子包</span></span><br><span class="line">        <span class="comment">// 运行时权限，如果旧的特权应用之前已经授予！</span></span><br><span class="line">        <span class="keyword">if</span> (res.pkg.parentPackage != <span class="keyword">null</span>) &#123;</span><br><span class="line">            <span class="keyword">synchronized</span> (mPackages) &#123;</span><br><span class="line">                grantRuntimePermissionsGrantedToDisabledPrivSysPackageParentLPw(res.pkg);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">synchronized</span> (mPackages) &#123;</span><br><span class="line">            mEphemeralApplicationRegistry.onPackageInstalledLPw(res.pkg);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">final</span> String packageName = res.pkg.applicationInfo.packageName;</span><br><span class="line">        Bundle extras = <span class="keyword">new</span> Bundle(<span class="number">1</span>);</span><br><span class="line">        extras.putInt(Intent.EXTRA_UID, res.uid);</span><br><span class="line"></span><br><span class="line">        <span class="comment">//【1.5】决定在那些 user 下是第一次安装，那些用户下是覆盖更新！</span></span><br><span class="line">        <span class="keyword">int</span>[] firstUsers = EMPTY_INT_ARRAY;</span><br><span class="line">        <span class="keyword">int</span>[] updateUsers = EMPTY_INT_ARRAY;</span><br><span class="line">        <span class="keyword">if</span> (res.origUsers == <span class="keyword">null</span> || res.origUsers.length == <span class="number">0</span>) &#123;</span><br><span class="line">            firstUsers = res.newUsers;</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            <span class="comment">// res.newUsers 表示本次安装新增加的目标 user！</span></span><br><span class="line">            <span class="comment">// res.origUsers 标志之前安装的目标 user！</span></span><br><span class="line">            <span class="keyword">for</span> (<span class="keyword">int</span> newUser : res.newUsers) &#123;</span><br><span class="line">                <span class="keyword">boolean</span> isNew = <span class="keyword">true</span>;</span><br><span class="line">                <span class="keyword">for</span> (<span class="keyword">int</span> origUser : res.origUsers) &#123;</span><br><span class="line">                    <span class="keyword">if</span> (origUser == newUser) &#123;</span><br><span class="line">                        isNew = <span class="keyword">false</span>;</span><br><span class="line">                        <span class="keyword">break</span>;</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;</span><br><span class="line">                <span class="keyword">if</span> (isNew) &#123;</span><br><span class="line">                    firstUsers = ArrayUtils.appendInt(firstUsers, newUser);</span><br><span class="line">                &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                    updateUsers = ArrayUtils.appendInt(updateUsers, newUser);</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment">//【1.5】发送 ADD 和 REPLACE 广播，如果不是 Ephemeral app！</span></span><br><span class="line">        <span class="keyword">if</span> (!isEphemeral(res.pkg)) &#123;</span><br><span class="line">            mProcessLoggingHandler.invalidateProcessLoggingBaseApkHash(res.pkg.baseCodePath);</span><br><span class="line"></span><br><span class="line">            <span class="comment">//【1.5.1】给第一次安装的用户发送 ACTION_PACKAGE_ADDED 广播，不带 EXTRA_REPLACING 属性！</span></span><br><span class="line">            sendPackageBroadcast(Intent.ACTION_PACKAGE_ADDED, packageName,</span><br><span class="line">                    extras, <span class="number">0</span> <span class="comment">/*flags*/</span>, <span class="keyword">null</span> <span class="comment">/*targetPackage*/</span>,</span><br><span class="line">                    <span class="keyword">null</span> <span class="comment">/*finishedReceiver*/</span>, firstUsers);</span><br><span class="line"></span><br><span class="line">            <span class="comment">//【1.5.2】给覆盖更新的用户发送 ACTION_PACKAGE_ADDED 广播，带 EXTRA_REPLACING 属性！</span></span><br><span class="line">            <span class="keyword">if</span> (update) &#123;</span><br><span class="line">                extras.putBoolean(Intent.EXTRA_REPLACING, <span class="keyword">true</span>);</span><br><span class="line">            &#125;</span><br><span class="line">            sendPackageBroadcast(Intent.ACTION_PACKAGE_ADDED, packageName,</span><br><span class="line">                    extras, <span class="number">0</span> <span class="comment">/*flags*/</span>, <span class="keyword">null</span> <span class="comment">/*targetPackage*/</span>,</span><br><span class="line">                    <span class="keyword">null</span> <span class="comment">/*finishedReceiver*/</span>, updateUsers);</span><br><span class="line"></span><br><span class="line">            <span class="comment">//【1.5.3】给覆盖更新的用户发送 ACTION_PACKAGE_REPLACED / ACTION_MY_PACKAGE_REPLACED 广播！</span></span><br><span class="line">            <span class="keyword">if</span> (update) &#123;</span><br><span class="line">                sendPackageBroadcast(Intent.ACTION_PACKAGE_REPLACED,</span><br><span class="line">                        packageName, extras, <span class="number">0</span> <span class="comment">/*flags*/</span>,</span><br><span class="line">                        <span class="keyword">null</span> <span class="comment">/*targetPackage*/</span>, <span class="keyword">null</span> <span class="comment">/*finishedReceiver*/</span>,</span><br><span class="line">                        updateUsers);</span><br><span class="line">                        </span><br><span class="line">                sendPackageBroadcast(Intent.ACTION_MY_PACKAGE_REPLACED,</span><br><span class="line">                        <span class="keyword">null</span> <span class="comment">/*package*/</span>, <span class="keyword">null</span> <span class="comment">/*extras*/</span>, <span class="number">0</span> <span class="comment">/*flags*/</span>,</span><br><span class="line">                        packageName <span class="comment">/*targetPackage*/</span>,</span><br><span class="line">                        <span class="keyword">null</span> <span class="comment">/*finishedReceiver*/</span>, updateUsers);</span><br><span class="line">                        </span><br><span class="line">            &#125; <span class="keyword">else</span> <span class="keyword">if</span> (launchedForRestore &amp;&amp; !isSystemApp(res.pkg)) &#123;</span><br><span class="line">                <span class="comment">//【1.5.4】如果是第一次安装，同时我们要做一个恢复操作，并且 apk 不是系统应用</span></span><br><span class="line">                <span class="comment">// 那么我们会发送 ACTION_PACKAGE_FIRST_LAUNCH 广播！</span></span><br><span class="line">                <span class="keyword">if</span> (DEBUG_BACKUP) &#123;</span><br><span class="line">                    Slog.i(TAG, <span class="string">"Post-restore of "</span> + packageName</span><br><span class="line">                            + <span class="string">" sending FIRST_LAUNCH in "</span> + Arrays.toString(firstUsers));</span><br><span class="line">                &#125;</span><br><span class="line">                sendFirstLaunchBroadcast(packageName, installerPackage, firstUsers);</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            <span class="comment">//【1.5.5】如果该 apk 处于 forward locked 或者处于外置存储中，那么会给所有的用户发送</span></span><br><span class="line">            <span class="comment">// 资源变化的广播！</span></span><br><span class="line">            <span class="keyword">if</span> (res.pkg.isForwardLocked() || isExternal(res.pkg)) &#123;</span><br><span class="line">                <span class="keyword">if</span> (DEBUG_INSTALL) &#123;</span><br><span class="line">                    Slog.i(TAG, <span class="string">"upgrading pkg "</span> + res.pkg</span><br><span class="line">                            + <span class="string">" is ASEC-hosted -&gt; AVAILABLE"</span>);</span><br><span class="line">                &#125;</span><br><span class="line">                <span class="keyword">final</span> <span class="keyword">int</span>[] uidArray = <span class="keyword">new</span> <span class="keyword">int</span>[]&#123;res.pkg.applicationInfo.uid&#125;;</span><br><span class="line">                ArrayList&lt;String&gt; pkgList = <span class="keyword">new</span> ArrayList&lt;&gt;(<span class="number">1</span>);</span><br><span class="line">                pkgList.add(packageName);</span><br><span class="line">                sendResourcesChangedBroadcast(<span class="keyword">true</span>, <span class="keyword">true</span>, pkgList, uidArray, <span class="keyword">null</span>);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment">//【1.6】针对 firstUsers 做一些权限恢复和默认浏览器设置！</span></span><br><span class="line">        <span class="keyword">if</span> (firstUsers != <span class="keyword">null</span> &amp;&amp; firstUsers.length &gt; <span class="number">0</span>) &#123;</span><br><span class="line">            <span class="keyword">synchronized</span> (mPackages) &#123;</span><br><span class="line">                <span class="keyword">for</span> (<span class="keyword">int</span> userId : firstUsers) &#123;</span><br><span class="line">                    <span class="comment">//【1.6.1】默认浏览器设置！！</span></span><br><span class="line">                    <span class="keyword">if</span> (packageIsBrowser(packageName, userId)) &#123;</span><br><span class="line">                        mSettings.setDefaultBrowserPackageNameLPw(<span class="keyword">null</span>, userId);</span><br><span class="line">                    &#125;</span><br><span class="line">                    <span class="comment">//【1.6.2】处理那些正在等待或者需要恢复的运行时权限授予！</span></span><br><span class="line">                    mSettings.applyPendingPermissionGrantsLPw(packageName, userId);</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        EventLog.writeEvent(EventLogTags.UNKNOWN_SOURCES_ENABLED,</span><br><span class="line">                getUnknownSourcesSettings());</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 触发 GC 回收资源！</span></span><br><span class="line">        Runtime.getRuntime().gc();</span><br><span class="line"></span><br><span class="line">        <span class="comment">//【5.8.1.1】移除掉更新后的旧 apk！</span></span><br><span class="line">        <span class="keyword">if</span> (res.removedInfo != <span class="keyword">null</span> &amp;&amp; res.removedInfo.args != <span class="keyword">null</span>) &#123;</span><br><span class="line">            <span class="keyword">synchronized</span> (mInstallLock) &#123;</span><br><span class="line">                res.removedInfo.args.doPostDeleteLI(<span class="keyword">true</span>);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//【*5.8.2】通知观察者安装的结果，这里的 installObserver 是我们之前创建的 localObsever！！</span></span><br><span class="line">    <span class="keyword">if</span> (installObserver != <span class="keyword">null</span>) &#123;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            Bundle extras = extrasForInstallResult(res);</span><br><span class="line">            installObserver.onPackageInstalled(res.name, res.returnCode,</span><br><span class="line">                    res.returnMsg, extras);</span><br><span class="line">        &#125; <span class="keyword">catch</span> (RemoteException e) &#123;</span><br><span class="line">            Slog.i(TAG, <span class="string">"Observer no longer exists."</span>);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>我们看到，这里涉及到了几个重要的广播：</p>
<ul>
<li><p><strong>Intent.ACTION_PACKAGE_ADDED</strong>：当有应用程序第一次安装时，会发送该广播给对应的 firstUsers！</p>
<ul>
<li>携带数据：Intent.EXTRA_UID，值为 apk uid；</li>
</ul>
</li>
<li><p><strong>Intent.ACTION_PACKAGE_REPLACED</strong>：当有应用程序被覆盖安装时，会发送该广播给对应的 updateUsers！</p>
<ul>
<li>携带数据：Intent.EXTRA_UID，</li>
<li>携带数据：Intent.EXTRA_REPLACING，置为 true；</li>
</ul>
</li>
<li><p><strong>Intent.ACTION_MY_PACKAGE_REPLACED</strong>：当有应用程序被覆盖安装时，会发送该广播给对应的 updateUsers 下被更新的 pkg！</p>
<ul>
<li>携带数据：packageName，被更新的应用包； </li>
</ul>
</li>
</ul>
<h4 id="5-8-1-1-FileInstallArgs-doPostDeleteLI-删除被更新的旧-apk"><a href="#5-8-1-1-FileInstallArgs-doPostDeleteLI-删除被更新的旧-apk" class="headerlink" title="5.8.1.1 FileInstallArgs.doPostDeleteLI - 删除被更新的旧 apk"></a>5.8.1.1 FileInstallArgs.doPostDeleteLI - 删除被更新的旧 apk</h4><p>继续来看：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">boolean</span> <span class="title">doPostDeleteLI</span><span class="params">(<span class="keyword">boolean</span> delete)</span> </span>&#123;</span><br><span class="line">    <span class="comment">//【*5.8.1.2】清楚 apk 文件 和 dex 文件！</span></span><br><span class="line">    cleanUpResourcesLI();</span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">true</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>继续分析：</p>
<h4 id="5-8-1-2-FileInstallArgs-cleanUpResourcesLI"><a href="#5-8-1-2-FileInstallArgs-cleanUpResourcesLI" class="headerlink" title="5.8.1.2 FileInstallArgs.cleanUpResourcesLI"></a>5.8.1.2 FileInstallArgs.cleanUpResourcesLI</h4><p>继续分析：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">cleanUpResourcesLI</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    List&lt;String&gt; allCodePaths = Collections.EMPTY_LIST;</span><br><span class="line">    <span class="keyword">if</span> (codeFile != <span class="keyword">null</span> &amp;&amp; codeFile.exists()) &#123;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            <span class="comment">//【1】收集 apk path！</span></span><br><span class="line">            <span class="keyword">final</span> PackageLite pkg = PackageParser.parsePackageLite(codeFile, <span class="number">0</span>);</span><br><span class="line">            allCodePaths = pkg.getAllCodePaths();</span><br><span class="line">        &#125; <span class="keyword">catch</span> (PackageParserException e) &#123;</span><br><span class="line">            <span class="comment">// Ignored; we tried our best</span></span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">//【2】清除 apk！</span></span><br><span class="line">    cleanUp();</span><br><span class="line">    <span class="comment">//【3】清除 dex files！</span></span><br><span class="line">    removeDexFiles(allCodePaths, instructionSets);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>这里就不再过多分析！</p>
<h3 id="5-8-2-IPackageInstallObserver2-onPackageInstalled"><a href="#5-8-2-IPackageInstallObserver2-onPackageInstalled" class="headerlink" title="5.8.2 IPackageInstallObserver2.onPackageInstalled"></a>5.8.2 IPackageInstallObserver2.onPackageInstalled</h3><p>这里的 installObserver 是我们在 4.3 PackageInstallerSession.commitLocked 中创建的另一个 Observer：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//【1】创建一个本地的安装观察者，监听安装结果！</span></span><br><span class="line"><span class="keyword">final</span> IPackageInstallObserver2 localObserver = <span class="keyword">new</span> IPackageInstallObserver2.Stub() &#123;</span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onUserActionRequired</span><span class="params">(Intent intent)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">throw</span> <span class="keyword">new</span> IllegalStateException();</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onPackageInstalled</span><span class="params">(String basePackageName, <span class="keyword">int</span> returnCode, String msg,</span></span></span><br><span class="line"><span class="function"><span class="params">            Bundle extras)</span> </span>&#123;</span><br><span class="line">        <span class="comment">//【×5.8.2.1】关闭文件桥，删除文件拷贝！</span></span><br><span class="line">        destroyInternal();</span><br><span class="line">        <span class="comment">//【×5.8.2.2】处理回调，通知监听者！</span></span><br><span class="line">        dispatchSessionFinished(returnCode, msg, extras);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>
<h4 id="5-8-2-1-PackageInstallerSession-destroyInternal"><a href="#5-8-2-1-PackageInstallerSession-destroyInternal" class="headerlink" title="5.8.2.1 PackageInstallerSession.destroyInternal"></a>5.8.2.1 PackageInstallerSession.destroyInternal</h4><p>关闭文件桥，删除文件拷贝：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">destroyInternal</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    <span class="keyword">synchronized</span> (mLock) &#123;</span><br><span class="line">        mSealed = <span class="keyword">true</span>;</span><br><span class="line">        mDestroyed = <span class="keyword">true</span>;</span><br><span class="line"></span><br><span class="line">        <span class="comment">//【1】关闭之前打开的文件桥对象！</span></span><br><span class="line">        <span class="keyword">for</span> (FileBridge bridge : mBridges) &#123;</span><br><span class="line">            bridge.forceClose();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span> (stageDir != <span class="keyword">null</span>) &#123;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            <span class="comment">//【2】删除之前的文件拷贝目录！</span></span><br><span class="line">            mPm.mInstaller.rmPackageDir(stageDir.getAbsolutePath());</span><br><span class="line">        &#125; <span class="keyword">catch</span> (InstallerException ignored) &#123;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span> (stageCid != <span class="keyword">null</span>) &#123;</span><br><span class="line">        PackageHelper.destroySdDir(stageCid);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h4 id="5-8-2-2-PackageInstallerSession-dispatchSessionFinished"><a href="#5-8-2-2-PackageInstallerSession-dispatchSessionFinished" class="headerlink" title="5.8.2.2 PackageInstallerSession.dispatchSessionFinished"></a>5.8.2.2 PackageInstallerSession.dispatchSessionFinished</h4><p>处理回调，通知监听者！</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">dispatchSessionFinished</span><span class="params">(<span class="keyword">int</span> returnCode, String msg, Bundle extras)</span> </span>&#123;</span><br><span class="line">    mFinalStatus = returnCode;</span><br><span class="line">    mFinalMessage = msg;</span><br><span class="line">    <span class="comment">//【*4.1.2】触发 mRemoteObserver 回调！</span></span><br><span class="line">    <span class="keyword">if</span> (mRemoteObserver != <span class="keyword">null</span>) &#123;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            mRemoteObserver.onPackageInstalled(mPackageName, returnCode, msg, extras);</span><br><span class="line">        &#125; <span class="keyword">catch</span> (RemoteException ignored) &#123;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">final</span> <span class="keyword">boolean</span> success = (returnCode == PackageManager.INSTALL_SUCCEEDED);</span><br><span class="line">    <span class="comment">//【*5.8.2.2.2】回调触发！！</span></span><br><span class="line">    mCallback.onSessionFinished(<span class="keyword">this</span>, success);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>在前面 4.1 commit 事务的时候，我们创建了一个 PackageInstallObserverAdapter，并将其保存到了 PackageInstallerSession.mRemoteObserver 中，这里首先会触发 mRemoteObserver 的回调！</p>
<p>在 3.1.4.1 new InternalCallback 的时候，我们在创建 PackageInstallerSession 时，传入了一个回调对象 InternalCallback：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">private</span> <span class="keyword">final</span> InternalCallback mInternalCallback = <span class="keyword">new</span> InternalCallback();</span><br></pre></td></tr></table></figure>
<p>InternalCallback 类定义在 PackageInstallerService 中，该对象的引用会被保存到 PackageInstallerSession.mCallback 变量中！</p>
<h5 id="5-8-2-2-2-InternalCallback-onSessionFinished"><a href="#5-8-2-2-2-InternalCallback-onSessionFinished" class="headerlink" title="5.8.2.2.2 InternalCallback.onSessionFinished"></a>5.8.2.2.2 InternalCallback.onSessionFinished</h5><p>这里我们重点关于 onSessionFinished 方法：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onSessionFinished</span><span class="params">(<span class="keyword">final</span> PackageInstallerSession session, <span class="keyword">boolean</span> success)</span> </span>&#123;</span><br><span class="line">    <span class="comment">//【×5.8.2.2.2.1】注册者回调！</span></span><br><span class="line">    mCallbacks.notifySessionFinished(session.sessionId, session.userId, success);</span><br><span class="line"></span><br><span class="line">    mInstallHandler.post(<span class="keyword">new</span> Runnable() &#123;</span><br><span class="line">        <span class="meta">@Override</span></span><br><span class="line">        <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">run</span><span class="params">()</span> </span>&#123;</span><br><span class="line">            <span class="keyword">synchronized</span> (mSessions) &#123;</span><br><span class="line">                <span class="comment">//【1】从 PackageInstallerService 中的 mSessions 移除了该 Session；</span></span><br><span class="line">                mSessions.remove(session.sessionId);</span><br><span class="line">                <span class="comment">//【2】将该 Sesssion 添加到历史中；</span></span><br><span class="line">                mHistoricalSessions.put(session.sessionId, session);</span><br><span class="line"></span><br><span class="line">                <span class="keyword">final</span> File appIconFile = buildAppIconFile(session.sessionId);</span><br><span class="line">                <span class="keyword">if</span> (appIconFile.exists()) &#123;</span><br><span class="line">                    appIconFile.delete();</span><br><span class="line">                &#125;</span><br><span class="line">                <span class="comment">//【×3.1.6.1】持久化事务记录文件！</span></span><br><span class="line">                writeSessionsLocked();</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>我们看到，在 InternalCallback 中又回调了另外一个 Callback mCallbacks，它也是 PackageInstallerService 的内部类：</p>
<h6 id="5-8-2-2-2-1-Callback-notifySessionFinished"><a href="#5-8-2-2-2-1-Callback-notifySessionFinished" class="headerlink" title="5.8.2.2.2.1 Callback.notifySessionFinished"></a>5.8.2.2.2.1 Callback.notifySessionFinished</h6><p>前面我们分析过，Callback 本质上就是一个 Handler，这里就是向其所在的线程发送消息：<br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">notifySessionFinished</span><span class="params">(<span class="keyword">int</span> sessionId, <span class="keyword">int</span> userId, <span class="keyword">boolean</span> success)</span> </span>&#123;</span><br><span class="line">    obtainMessage(MSG_SESSION_FINISHED, sessionId, userId, success).sendToTarget();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>在 3.1.4.2 Callbacks.notifySessionXXXX 中，我们分析过，最终其实是很将安装的结果分发给了注册在 Callback 中的所有远程回调：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">private</span> <span class="keyword">final</span> RemoteCallbackList&lt;IPackageInstallerCallback&gt;</span><br><span class="line">        mCallbacks = <span class="keyword">new</span> RemoteCallbackList&lt;&gt;();</span><br></pre></td></tr></table></figure>
<p>这里就不多说了！</p>
<h1 id="6-PackageManagerS-replacePackageLIF-覆盖安装"><a href="#6-PackageManagerS-replacePackageLIF-覆盖安装" class="headerlink" title="6 PackageManagerS.replacePackageLIF - 覆盖安装"></a>6 PackageManagerS.replacePackageLIF - 覆盖安装</h1><h2 id="6-1-参数分析"><a href="#6-1-参数分析" class="headerlink" title="6.1 参数分析"></a>6.1 参数分析</h2><p>这里我们来回顾下传入的参数：final int policyFlags 就是我们之前的解析参数 parseFlags</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 默认情况下： mDefParseFlags = 0 </span></span><br><span class="line"><span class="keyword">final</span> <span class="keyword">int</span> parseFlags = mDefParseFlags | PackageParser.PARSE_CHATTY</span><br><span class="line">        | PackageParser.PARSE_ENFORCE_CODE</span><br><span class="line">        | (forwardLocked ? PackageParser.PARSE_FORWARD_LOCK : <span class="number">0</span>)</span><br><span class="line">        | (onExternal ? PackageParser.PARSE_EXTERNAL_STORAGE : <span class="number">0</span>)</span><br><span class="line">        | (ephemeral ? PackageParser.PARSE_IS_EPHEMERAL : <span class="number">0</span>)</span><br><span class="line">        | (forceSdk ? PackageParser.PARSE_FORCE_SDK : <span class="number">0</span>);</span><br></pre></td></tr></table></figure>
<p>同时，对于扫描标志位 scanFlags，会做如下处理：<br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//【2】设置扫描参数</span></span><br><span class="line"><span class="keyword">int</span> scanFlags = SCAN_NEW_INSTALL | SCAN_UPDATE_SIGNATURE;</span><br><span class="line"><span class="keyword">if</span> (args.move != <span class="keyword">null</span>) &#123;</span><br><span class="line">	<span class="comment">//【2.1】如果 args.move 不为 null，表示正在移动一个 app，我们会对其进行一个初始化的扫描</span></span><br><span class="line">	<span class="comment">// 增加 SCAN_INITIAL 位！</span></span><br><span class="line">	scanFlags |= SCAN_INITIAL;</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">if</span> ((installFlags &amp; PackageManager.INSTALL_DONT_KILL_APP) != <span class="number">0</span>) &#123; </span><br><span class="line">	<span class="comment">//【2.2】如果安装参数指定了 INSTALL_DONT_KILL_APP，那么增加 SCAN_DONT_KILL_APP 位！</span></span><br><span class="line">	scanFlags |= SCAN_DONT_KILL_APP;</span><br><span class="line">&#125;</span><br><span class="line">... ...</span><br><span class="line"><span class="comment">//【13】根据安装参数做不同的处理！</span></span><br><span class="line"><span class="keyword">if</span> (args.move != <span class="keyword">null</span>) &#123;</span><br><span class="line">	<span class="comment">//【13.1】如果是 move package，进入这里！</span></span><br><span class="line">	scanFlags |= SCAN_NO_DEX; <span class="comment">// 设置以下标签，无需做 odex，我们需要已有的移动过去即可！</span></span><br><span class="line">	scanFlags |= SCAN_MOVE;</span><br><span class="line">	... ... ...</span><br><span class="line">&#125; <span class="keyword">else</span> <span class="keyword">if</span> (!forwardLocked &amp;&amp; !pkg.applicationInfo.isExternalAsec()) &#123;</span><br><span class="line">	<span class="comment">//【13.2】如果不是 forward lock 模式安装且没有安装到外置存储上，进入这里！</span></span><br><span class="line">	scanFlags |= SCAN_NO_DEX; <span class="comment">// 扫描参数设置 SCAN_NO_DEX，意味着后面不做 odex，因为这里会做！</span></span><br><span class="line">	... ... ...</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>上面，我们省略掉了不重要的代码段！</p>
<h2 id="6-2-方法分析"><a href="#6-2-方法分析" class="headerlink" title="6.2 方法分析"></a>6.2 方法分析</h2><p>下面继续分析核心方法：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">replacePackageLIF</span><span class="params">(PackageParser.Package pkg, <span class="keyword">final</span> <span class="keyword">int</span> policyFlags, <span class="keyword">int</span> scanFlags,</span></span></span><br><span class="line"><span class="function"><span class="params">        UserHandle user, String installerPackageName, PackageInstalledInfo res)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">final</span> <span class="keyword">boolean</span> isEphemeral = (policyFlags &amp; PackageParser.PARSE_IS_EPHEMERAL) != <span class="number">0</span>; <span class="comment">// 是否是 ephemeral </span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">final</span> PackageParser.Package oldPackage;</span><br><span class="line">    <span class="keyword">final</span> String pkgName = pkg.packageName;</span><br><span class="line">    <span class="keyword">final</span> <span class="keyword">int</span>[] allUsers;</span><br><span class="line">    <span class="keyword">final</span> <span class="keyword">int</span>[] installedUsers;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">synchronized</span>(mPackages) &#123;</span><br><span class="line">        <span class="comment">//【1】获得旧应用的 Package 对象！</span></span><br><span class="line">        oldPackage = mPackages.get(pkgName);</span><br><span class="line">        <span class="keyword">if</span> (DEBUG_INSTALL) Slog.d(TAG, <span class="string">"replacePackageLI: new="</span> + pkg + <span class="string">", old="</span> + oldPackage);</span><br><span class="line"></span><br><span class="line">        <span class="comment">// don't allow upgrade to target a release SDK from a pre-release SDK</span></span><br><span class="line">        <span class="keyword">final</span> <span class="keyword">boolean</span> oldTargetsPreRelease = oldPackage.applicationInfo.targetSdkVersion</span><br><span class="line">                == android.os.Build.VERSION_CODES.CUR_DEVELOPMENT;</span><br><span class="line">        <span class="keyword">final</span> <span class="keyword">boolean</span> newTargetsPreRelease = pkg.applicationInfo.targetSdkVersion</span><br><span class="line">                == android.os.Build.VERSION_CODES.CUR_DEVELOPMENT;</span><br><span class="line">        <span class="comment">//【2】如果安装设置了 PackageParser.PARSE_FORCE_SDK，那就要校验下 sdk！</span></span><br><span class="line">        <span class="keyword">if</span> (oldTargetsPreRelease</span><br><span class="line">                &amp;&amp; !newTargetsPreRelease</span><br><span class="line">                &amp;&amp; ((policyFlags &amp; PackageParser.PARSE_FORCE_SDK) == <span class="number">0</span>)) &#123;</span><br><span class="line">            Slog.w(TAG, <span class="string">"Can't install package targeting released sdk"</span>);</span><br><span class="line">            res.setReturnCode(PackageManager.INSTALL_FAILED_UPDATE_INCOMPATIBLE);</span><br><span class="line">            <span class="keyword">return</span>;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment">//【3】如果之前安装是 no ephemeral，现在是 ephemeral，那么不能安装！</span></span><br><span class="line">        <span class="keyword">final</span> <span class="keyword">boolean</span> oldIsEphemeral = oldPackage.applicationInfo.isEphemeralApp();</span><br><span class="line">        <span class="keyword">if</span> (isEphemeral &amp;&amp; !oldIsEphemeral) &#123;</span><br><span class="line">            Slog.w(TAG, <span class="string">"Can't replace app with ephemeral: "</span> + pkgName);</span><br><span class="line">            res.setReturnCode(PackageManager.INSTALL_FAILED_EPHEMERAL_INVALID);</span><br><span class="line">            <span class="keyword">return</span>;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment">//【4】校验签名，不匹配，不能安装！</span></span><br><span class="line">        <span class="keyword">final</span> PackageSetting ps = mSettings.mPackages.get(pkgName);</span><br><span class="line">        <span class="keyword">if</span> (shouldCheckUpgradeKeySetLP(ps, scanFlags)) &#123;</span><br><span class="line">            <span class="keyword">if</span> (!checkUpgradeKeySetLP(ps, pkg)) &#123;</span><br><span class="line">                res.setError(INSTALL_FAILED_UPDATE_INCOMPATIBLE,</span><br><span class="line">                        <span class="string">"New package not signed by keys specified by upgrade-keysets: "</span></span><br><span class="line">                                + pkgName);</span><br><span class="line">                <span class="keyword">return</span>;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            <span class="keyword">if</span> (compareSignatures(oldPackage.mSignatures, pkg.mSignatures)</span><br><span class="line">                    != PackageManager.SIGNATURE_MATCH) &#123;</span><br><span class="line">                res.setError(INSTALL_FAILED_UPDATE_INCOMPATIBLE,</span><br><span class="line">                        <span class="string">"New package has a different signature: "</span> + pkgName);</span><br><span class="line">                <span class="keyword">return</span>;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment">//【5】如果旧的应用是 sys app，并且需要强制 hash 校验，那就会在这里校验 hash！</span></span><br><span class="line">        <span class="keyword">if</span> (oldPackage.restrictUpdateHash != <span class="keyword">null</span> &amp;&amp; oldPackage.isSystemApp()) &#123;</span><br><span class="line">            <span class="keyword">byte</span>[] digestBytes = <span class="keyword">null</span>;</span><br><span class="line">            <span class="keyword">try</span> &#123;</span><br><span class="line">                <span class="keyword">final</span> MessageDigest digest = MessageDigest.getInstance(<span class="string">"SHA-512"</span>);</span><br><span class="line">                updateDigest(digest, <span class="keyword">new</span> File(pkg.baseCodePath));</span><br><span class="line">                <span class="keyword">if</span> (!ArrayUtils.isEmpty(pkg.splitCodePaths)) &#123;</span><br><span class="line">                    <span class="keyword">for</span> (String path : pkg.splitCodePaths) &#123;</span><br><span class="line">                        updateDigest(digest, <span class="keyword">new</span> File(path));</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;</span><br><span class="line">                digestBytes = digest.digest();</span><br><span class="line">            &#125; <span class="keyword">catch</span> (NoSuchAlgorithmException | IOException e) &#123;</span><br><span class="line">                res.setError(INSTALL_FAILED_INVALID_APK,</span><br><span class="line">                        <span class="string">"Could not compute hash: "</span> + pkgName);</span><br><span class="line">                <span class="keyword">return</span>;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">if</span> (!Arrays.equals(oldPackage.restrictUpdateHash, digestBytes)) &#123;</span><br><span class="line">                res.setError(INSTALL_FAILED_INVALID_APK,</span><br><span class="line">                        <span class="string">"New package fails restrict-update check: "</span> + pkgName);</span><br><span class="line">                <span class="keyword">return</span>;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="comment">// retain upgrade restriction</span></span><br><span class="line">            pkg.restrictUpdateHash = oldPackage.restrictUpdateHash;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment">//【6】检查 shareUserId 是否变化！</span></span><br><span class="line">        String invalidPackageName =</span><br><span class="line">                getParentOrChildPackageChangedSharedUser(oldPackage, pkg);</span><br><span class="line">        <span class="keyword">if</span> (invalidPackageName != <span class="keyword">null</span>) &#123;</span><br><span class="line">            res.setError(INSTALL_FAILED_SHARED_USER_INCOMPATIBLE,</span><br><span class="line">                    <span class="string">"Package "</span> + invalidPackageName + <span class="string">" tried to change user "</span></span><br><span class="line">                            + oldPackage.mSharedUserId);</span><br><span class="line">            <span class="keyword">return</span>;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment">//【7】获得系统中所有的 user，已经上一次安装的目标 user！</span></span><br><span class="line">        allUsers = sUserManager.getUserIds();</span><br><span class="line">        installedUsers = ps.queryInstalledUsers(allUsers, <span class="keyword">true</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//【×5.7.1.1】针对与 replace 的情况，会创建一个 PackageRemovedInfo，封装被 replace 的 app 的信息！</span></span><br><span class="line">    <span class="comment">// 如果有子包的话，也会做相同的事情！</span></span><br><span class="line">    res.removedInfo = <span class="keyword">new</span> PackageRemovedInfo();</span><br><span class="line">    res.removedInfo.uid = oldPackage.applicationInfo.uid;</span><br><span class="line">    res.removedInfo.removedPackage = oldPackage.packageName;</span><br><span class="line">    res.removedInfo.isUpdate = <span class="keyword">true</span>; <span class="comment">// 表示要更新 package！！</span></span><br><span class="line">    res.removedInfo.origUsers = installedUsers;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">final</span> <span class="keyword">int</span> childCount = (oldPackage.childPackages != <span class="keyword">null</span>)</span><br><span class="line">            ? oldPackage.childPackages.size() : <span class="number">0</span>;</span><br><span class="line">    <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; childCount; i++) &#123;</span><br><span class="line">        <span class="keyword">boolean</span> childPackageUpdated = <span class="keyword">false</span>;</span><br><span class="line">        PackageParser.Package childPkg = oldPackage.childPackages.get(i);</span><br><span class="line">        <span class="keyword">if</span> (res.addedChildPackages != <span class="keyword">null</span>) &#123;</span><br><span class="line">            PackageInstalledInfo childRes = res.addedChildPackages.get(childPkg.packageName);</span><br><span class="line">            <span class="keyword">if</span> (childRes != <span class="keyword">null</span>) &#123;</span><br><span class="line">                childRes.removedInfo.uid = childPkg.applicationInfo.uid;</span><br><span class="line">                childRes.removedInfo.removedPackage = childPkg.packageName;</span><br><span class="line">                childRes.removedInfo.isUpdate = <span class="keyword">true</span>;</span><br><span class="line">                childPackageUpdated = <span class="keyword">true</span>;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">if</span> (!childPackageUpdated) &#123;</span><br><span class="line">            PackageRemovedInfo childRemovedRes = <span class="keyword">new</span> PackageRemovedInfo();</span><br><span class="line">            childRemovedRes.removedPackage = childPkg.packageName;</span><br><span class="line">            childRemovedRes.isUpdate = <span class="keyword">false</span>;</span><br><span class="line">            childRemovedRes.dataRemoved = <span class="keyword">true</span>;</span><br><span class="line">            <span class="keyword">synchronized</span> (mPackages) &#123;</span><br><span class="line">                PackageSetting childPs = mSettings.peekPackageLPr(childPkg.packageName);</span><br><span class="line">                <span class="keyword">if</span> (childPs != <span class="keyword">null</span>) &#123;</span><br><span class="line">                    childRemovedRes.origUsers = childPs.queryInstalledUsers(allUsers, <span class="keyword">true</span>);</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">if</span> (res.removedInfo.removedChildPackages == <span class="keyword">null</span>) &#123;</span><br><span class="line">                res.removedInfo.removedChildPackages = <span class="keyword">new</span> ArrayMap&lt;&gt;();</span><br><span class="line">            &#125;</span><br><span class="line">            res.removedInfo.removedChildPackages.put(childPkg.packageName, childRemovedRes);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">//【9】判断下旧应用是系统应用，还是非系统应用，然后做不同的处理！</span></span><br><span class="line">    <span class="keyword">boolean</span> sysPkg = (isSystemApp(oldPackage));</span><br><span class="line">    <span class="keyword">if</span> (sysPkg) &#123;</span><br><span class="line">        <span class="comment">//【9.1】如果是系统应用，再判断是是否是系统特权应用！</span></span><br><span class="line">        <span class="keyword">final</span> <span class="keyword">boolean</span> privileged =</span><br><span class="line">                (oldPackage.applicationInfo.privateFlags</span><br><span class="line">                        &amp; ApplicationInfo.PRIVATE_FLAG_PRIVILEGED) != <span class="number">0</span>;</span><br><span class="line">        <span class="comment">//【9.2】对于系统应用会增加如下的解析 flags!</span></span><br><span class="line">        <span class="keyword">final</span> <span class="keyword">int</span> systemPolicyFlags = policyFlags</span><br><span class="line">                | PackageParser.PARSE_IS_SYSTEM</span><br><span class="line">                | (privileged ? PackageParser.PARSE_IS_PRIVILEGED : <span class="number">0</span>);</span><br><span class="line"></span><br><span class="line">        <span class="comment">//【×6.2.1】处理系统应用的 replace！</span></span><br><span class="line">        replaceSystemPackageLIF(oldPackage, pkg, systemPolicyFlags, scanFlags,</span><br><span class="line">                user, allUsers, installerPackageName, res);</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        <span class="comment">//【×6.2.2】处理下非系统应用的 replace！</span></span><br><span class="line">        replaceNonSystemPackageLIF(oldPackage, pkg, policyFlags, scanFlags,</span><br><span class="line">                user, allUsers, installerPackageName, res);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>对于判断是否是系统应用，调用了如下的接口：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">boolean</span> <span class="title">isSystemApp</span><span class="params">(PackageParser.Package pkg)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">return</span> (pkg.applicationInfo.flags &amp; ApplicationInfo.FLAG_SYSTEM) != <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h3 id="6-2-1-replaceSystemPackageLIF-覆盖安装系统应用"><a href="#6-2-1-replaceSystemPackageLIF-覆盖安装系统应用" class="headerlink" title="6.2.1 replaceSystemPackageLIF - 覆盖安装系统应用"></a>6.2.1 replaceSystemPackageLIF - 覆盖安装系统应用</h3><p>这里我们来回顾下传入的参数：final int policyFlags 就是我们之前的解析参数 parseFlags</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//【1】默认情况下： mDefParseFlags = 0 </span></span><br><span class="line"><span class="keyword">final</span> <span class="keyword">int</span> parseFlags = mDefParseFlags | PackageParser.PARSE_CHATTY</span><br><span class="line">        | PackageParser.PARSE_ENFORCE_CODE</span><br><span class="line">        | (forwardLocked ? PackageParser.PARSE_FORWARD_LOCK : <span class="number">0</span>)</span><br><span class="line">        | (onExternal ? PackageParser.PARSE_EXTERNAL_STORAGE : <span class="number">0</span>)</span><br><span class="line">        | (ephemeral ? PackageParser.PARSE_IS_EPHEMERAL : <span class="number">0</span>)</span><br><span class="line">        | (forceSdk ? PackageParser.PARSE_FORCE_SDK : <span class="number">0</span>);</span><br><span class="line"> </span><br><span class="line"><span class="comment">//【2】针对系统应用额外增加如下的标志       </span></span><br><span class="line"><span class="keyword">final</span> <span class="keyword">int</span> systemPolicyFlags = policyFlags</span><br><span class="line">    | PackageParser.PARSE_IS_SYSTEM</span><br><span class="line">    | (privileged ? PackageParser.PARSE_IS_PRIVILEGED : <span class="number">0</span>);</span><br></pre></td></tr></table></figure>
<p>同时，对于扫描标志位 scanFlags，和上面保持一致，下面我们来分析下更新 sys app 的流程！</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">replaceSystemPackageLIF</span><span class="params">(PackageParser.Package deletedPackage,</span></span></span><br><span class="line"><span class="function"><span class="params">        PackageParser.Package pkg, <span class="keyword">final</span> <span class="keyword">int</span> policyFlags, <span class="keyword">int</span> scanFlags, UserHandle user,</span></span></span><br><span class="line"><span class="function"><span class="params">        <span class="keyword">int</span>[] allUsers, String installerPackageName, PackageInstalledInfo res)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">if</span> (DEBUG_INSTALL) Slog.d(TAG, <span class="string">"replaceSystemPackageLI: new="</span> + pkg</span><br><span class="line">            + <span class="string">", old="</span> + deletedPackage);</span><br><span class="line">    <span class="keyword">final</span> <span class="keyword">boolean</span> disabledSystem;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//【*6.2.1.1】移除掉已安装的 sys app 的数据，包括解析到的四大组件；</span></span><br><span class="line">    removePackageLI(deletedPackage, <span class="keyword">true</span>);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">synchronized</span> (mPackages) &#123;</span><br><span class="line">        <span class="comment">//【*6.2.1.2】disable 掉系统应用；</span></span><br><span class="line">        disabledSystem = disableSystemPackageLPw(deletedPackage, pkg);</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">//【1】根据 disabledSystem 的值做不同处理！</span></span><br><span class="line">    <span class="keyword">if</span> (!disabledSystem) &#123;</span><br><span class="line">        <span class="comment">//【1.1】如果 disabledSystem 为 false，说明我们之前已经更新过 sys app 了，其已经被 disable 过了</span></span><br><span class="line">        <span class="comment">// 我们现在更新的是位于 data 分区的那个 app，所以要删除掉那个旧的 data app！</span></span><br><span class="line">        <span class="comment">//【*6.2.1.3】这里会根据要删除 data 分区的 apk 的数据，创建一个 InstallArgs，用于执行删除操作！</span></span><br><span class="line">        res.removedInfo.args = createInstallArgsForExisting(<span class="number">0</span>,</span><br><span class="line">                deletedPackage.applicationInfo.getCodePath(),</span><br><span class="line">                deletedPackage.applicationInfo.getResourcePath(),</span><br><span class="line">                getAppDexInstructionSets(deletedPackage.applicationInfo));</span><br><span class="line"></span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        <span class="comment">//【1.2】此时无需删除 app，所以设置为 null</span></span><br><span class="line">        res.removedInfo.args = <span class="keyword">null</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//【*6.2.1.4】清楚掉新安装的应用 code_cache 目录下的文件数据；</span></span><br><span class="line">    clearAppDataLIF(pkg, UserHandle.USER_ALL, StorageManager.FLAG_STORAGE_DE</span><br><span class="line">            | StorageManager.FLAG_STORAGE_CE | Installer.FLAG_CLEAR_CODE_CACHE_ONLY);</span><br><span class="line"></span><br><span class="line">    <span class="comment">//【*6.2.1.5】清楚掉旧的 app 的 profile 相关数据；</span></span><br><span class="line">    clearAppProfilesLIF(deletedPackage, UserHandle.USER_ALL);</span><br><span class="line"></span><br><span class="line">    res.setReturnCode(PackageManager.INSTALL_SUCCEEDED);</span><br><span class="line"></span><br><span class="line">    <span class="comment">//【2】给本次扫描的新 app 设置 ApplicationInfo.FLAG_UPDATED_SYSTEM_APP 标志位！</span></span><br><span class="line">    pkg.setApplicationInfoFlags(ApplicationInfo.FLAG_UPDATED_SYSTEM_APP,</span><br><span class="line">            ApplicationInfo.FLAG_UPDATED_SYSTEM_APP);</span><br><span class="line"></span><br><span class="line">    PackageParser.Package newPackage = <span class="keyword">null</span>;</span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">        <span class="comment">//【3】再次扫描 apk 文件！！</span></span><br><span class="line">        newPackage = scanPackageTracedLI(pkg, policyFlags, scanFlags, <span class="number">0</span>, user);</span><br><span class="line"></span><br><span class="line">        <span class="comment">//【4】更新新 apk 的安装时间和最新更新时间（包括子包的）；</span></span><br><span class="line">        PackageSetting deletedPkgSetting = (PackageSetting) deletedPackage.mExtras;</span><br><span class="line">        setInstallAndUpdateTime(newPackage, deletedPkgSetting.firstInstallTime,</span><br><span class="line">                System.currentTimeMillis());</span><br><span class="line"></span><br><span class="line">        <span class="comment">//【5】处理安装成功的情况！</span></span><br><span class="line">        <span class="keyword">if</span> (res.returnCode == PackageManager.INSTALL_SUCCEEDED) &#123;</span><br><span class="line">            <span class="keyword">final</span> <span class="keyword">int</span> deletedChildCount = (deletedPackage.childPackages != <span class="keyword">null</span>)</span><br><span class="line">                    ? deletedPackage.childPackages.size() : <span class="number">0</span>;</span><br><span class="line">            <span class="keyword">final</span> <span class="keyword">int</span> newChildCount = (newPackage.childPackages != <span class="keyword">null</span>)</span><br><span class="line">                    ? newPackage.childPackages.size() : <span class="number">0</span>;</span><br><span class="line"></span><br><span class="line">            <span class="comment">//【5.1】比较旧的应用和新安装的应用的子包！</span></span><br><span class="line">            <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; deletedChildCount; i++) &#123;</span><br><span class="line">                PackageParser.Package deletedChildPkg = deletedPackage.childPackages.get(i);</span><br><span class="line">                <span class="keyword">boolean</span> childPackageDeleted = <span class="keyword">true</span>;</span><br><span class="line">                <span class="keyword">for</span> (<span class="keyword">int</span> j = <span class="number">0</span>; j &lt; newChildCount; j++) &#123;</span><br><span class="line">                    PackageParser.Package newChildPkg = newPackage.childPackages.get(j);</span><br><span class="line">                    <span class="keyword">if</span> (deletedChildPkg.packageName.equals(newChildPkg.packageName)) &#123;</span><br><span class="line">                        childPackageDeleted = <span class="keyword">false</span>;</span><br><span class="line">                        <span class="keyword">break</span>;</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;</span><br><span class="line">                <span class="comment">//【5.1.1】如果旧的应用的子包被删除了，那会移除旧的应用子包遗留下的数据！</span></span><br><span class="line">                <span class="keyword">if</span> (childPackageDeleted) &#123;</span><br><span class="line">                    PackageSetting ps = mSettings.getDisabledSystemPkgLPr(</span><br><span class="line">                            deletedChildPkg.packageName);</span><br><span class="line">                    <span class="keyword">if</span> (ps != <span class="keyword">null</span> &amp;&amp; res.removedInfo.removedChildPackages != <span class="keyword">null</span>) &#123;</span><br><span class="line">                        PackageRemovedInfo removedChildRes = res.removedInfo</span><br><span class="line">                                .removedChildPackages.get(deletedChildPkg.packageName);</span><br><span class="line">                        <span class="comment">// 移除数据！</span></span><br><span class="line">                        removePackageDataLIF(ps, allUsers, removedChildRes, <span class="number">0</span>, <span class="keyword">false</span>);</span><br><span class="line">                        removedChildRes.removedForAllUsers = mPackages.get(ps.name) == <span class="keyword">null</span>;</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="comment">//【*7.2.1】更新数据；</span></span><br><span class="line">            updateSettingsLI(newPackage, installerPackageName, allUsers, res, user);</span><br><span class="line">            <span class="comment">//【*7.2.2】准备数据目录，即 data/data/packageName 的目录；</span></span><br><span class="line">            prepareAppDataAfterInstallLIF(newPackage);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125; <span class="keyword">catch</span> (PackageManagerException e) &#123;</span><br><span class="line">        res.setReturnCode(INSTALL_FAILED_INTERNAL_ERROR);</span><br><span class="line">        res.setError(<span class="string">"Package couldn't be installed in "</span> + pkg.codePath, e);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//【3】处理安装失败的情况！</span></span><br><span class="line">    <span class="keyword">if</span> (res.returnCode != PackageManager.INSTALL_SUCCEEDED) &#123;</span><br><span class="line">        <span class="keyword">if</span> (newPackage != <span class="keyword">null</span>) &#123;</span><br><span class="line">            <span class="comment">//【*6.2.1.6】移除新解析的 apk 的数据</span></span><br><span class="line">            removeInstalledPackageLI(newPackage, <span class="keyword">true</span>);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            <span class="comment">//【3.1】重新扫描旧的 apk（注意如果之前 system apk 已经被更新过了，那么这里</span></span><br><span class="line">            <span class="comment">// 恢复的是处于 data 的那个新的 apk）！</span></span><br><span class="line">            scanPackageTracedLI(deletedPackage, policyFlags, SCAN_UPDATE_SIGNATURE, <span class="number">0</span>, user);</span><br><span class="line">        &#125; <span class="keyword">catch</span> (PackageManagerException e) &#123;</span><br><span class="line">            Slog.e(TAG, <span class="string">"Failed to restore original package: "</span> + e.getMessage());</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">synchronized</span> (mPackages) &#123;</span><br><span class="line">            <span class="keyword">if</span> (disabledSystem) &#123;</span><br><span class="line">                <span class="comment">//【*6.2.1.7】如果本次是第一次更新（即 disable 了 sys app），那么我们要 enable sys app！</span></span><br><span class="line">                enableSystemPackageLPw(deletedPackage);</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            <span class="comment">//【3.2】更新升级包的安装信息，就是 PackageInstaller！</span></span><br><span class="line">            setInstallerPackageNameLPw(deletedPackage, installerPackageName);</span><br><span class="line"></span><br><span class="line">            <span class="comment">//【3.3】更新权限信息，关于权限的相关逻辑，这里不再分析，但是能推测到更新权限的原因！</span></span><br><span class="line">            updatePermissionsLPw(deletedPackage, UPDATE_PERMISSIONS_ALL);</span><br><span class="line">            </span><br><span class="line">            <span class="comment">//【3.4】持久化数据！</span></span><br><span class="line">            mSettings.writeLPr();</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        Slog.i(TAG, <span class="string">"Successfully restored package : "</span> + deletedPackage.packageName</span><br><span class="line">                + <span class="string">" after failed upgrade"</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>这里就不多说了！！</p>
<h4 id="6-2-1-1-removePackageLI"><a href="#6-2-1-1-removePackageLI" class="headerlink" title="6.2.1.1 removePackageLI"></a>6.2.1.1 removePackageLI</h4><p>移除旧的 apk 的数据信息：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">removePackageLI</span> <span class="params">(PackageParser.Package pkg, <span class="keyword">boolean</span> chatty)</span> </span>&#123;</span><br><span class="line">    <span class="comment">//【1】处理父包！</span></span><br><span class="line">    PackageSetting ps = (PackageSetting) pkg.mExtras;</span><br><span class="line">    <span class="keyword">if</span> (ps != <span class="keyword">null</span>) &#123;</span><br><span class="line">        <span class="comment">//【1.1】移除父包的 Settings 对象的 Settings 数据！</span></span><br><span class="line">        removePackageLI(ps, chatty);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">//【2】处理子包！</span></span><br><span class="line">    <span class="keyword">final</span> <span class="keyword">int</span> childCount = (pkg.childPackages != <span class="keyword">null</span>) ? pkg.childPackages.size() : <span class="number">0</span>;</span><br><span class="line">    <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; childCount; i++) &#123;</span><br><span class="line">        PackageParser.Package childPkg = pkg.childPackages.get(i);</span><br><span class="line">        ps = (PackageSetting) childPkg.mExtras;</span><br><span class="line">        <span class="keyword">if</span> (ps != <span class="keyword">null</span>) &#123;</span><br><span class="line">            <span class="comment">//【2.1】移除子包的 Settings 对象的 Settings 数据！</span></span><br><span class="line">            removePackageLI(ps, chatty);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>调用了另外一个 removePackageLI 方法！<br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">removePackageLI</span><span class="params">(PackageSetting ps, <span class="keyword">boolean</span> chatty)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">if</span> (DEBUG_INSTALL) &#123;</span><br><span class="line">        <span class="keyword">if</span> (chatty)</span><br><span class="line">            Log.d(TAG, <span class="string">"Removing package "</span> + ps.name);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">synchronized</span> (mPackages) &#123;</span><br><span class="line">        <span class="comment">//【1】将应用对应的 PackageSettings 对象删除掉！</span></span><br><span class="line">        mPackages.remove(ps.name);</span><br><span class="line">        <span class="keyword">final</span> PackageParser.Package pkg = ps.pkg;</span><br><span class="line">        <span class="keyword">if</span> (pkg != <span class="keyword">null</span>) &#123;</span><br><span class="line">            <span class="comment">//【×6.2.1.1.1】移除四大组件数据！</span></span><br><span class="line">            cleanPackageDataStructuresLILPw(pkg, chatty);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<h5 id="6-2-1-1-1-cleanPackageDataStructuresLILPw"><a href="#6-2-1-1-1-cleanPackageDataStructuresLILPw" class="headerlink" title="6.2.1.1.1 cleanPackageDataStructuresLILPw"></a>6.2.1.1.1 cleanPackageDataStructuresLILPw</h5><p>用于删除 apk 的四大组件和共享库数据：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">cleanPackageDataStructuresLILPw</span><span class="params">(PackageParser.Package pkg, <span class="keyword">boolean</span> chatty)</span> </span>&#123;</span><br><span class="line">    <span class="comment">//【1】移除 provider！</span></span><br><span class="line">    <span class="keyword">int</span> N = pkg.providers.size();</span><br><span class="line">    StringBuilder r = <span class="keyword">null</span>;</span><br><span class="line">    <span class="keyword">int</span> i;</span><br><span class="line">    <span class="keyword">for</span> (i=<span class="number">0</span>; i&lt;N; i++) &#123;</span><br><span class="line">        PackageParser.Provider p = pkg.providers.get(i);</span><br><span class="line">        mProviders.removeProvider(p);</span><br><span class="line">        <span class="keyword">if</span> (p.info.authority == <span class="keyword">null</span>) &#123;</span><br><span class="line">            <span class="comment">//【1.1】表示系统之前已经有相同 authority 的 provider，那么这个应用的 provider 是不会注册的！</span></span><br><span class="line">            <span class="comment">// 对于没有注册的 provider 不处理！</span></span><br><span class="line">            <span class="keyword">continue</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        String names[] = p.info.authority.split(<span class="string">";"</span>);</span><br><span class="line">        <span class="keyword">for</span> (<span class="keyword">int</span> j = <span class="number">0</span>; j &lt; names.length; j++) &#123;</span><br><span class="line">            <span class="keyword">if</span> (mProvidersByAuthority.get(names[j]) == p) &#123;</span><br><span class="line">                mProvidersByAuthority.remove(names[j]);</span><br><span class="line">                <span class="keyword">if</span> (DEBUG_REMOVE) &#123;</span><br><span class="line">                    <span class="keyword">if</span> (chatty)</span><br><span class="line">                        Log.d(TAG, <span class="string">"Unregistered content provider: "</span> + names[j]</span><br><span class="line">                                + <span class="string">", className = "</span> + p.info.name + <span class="string">", isSyncable = "</span></span><br><span class="line">                                + p.info.isSyncable);</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">if</span> (DEBUG_REMOVE &amp;&amp; chatty) &#123;</span><br><span class="line">            <span class="keyword">if</span> (r == <span class="keyword">null</span>) &#123;</span><br><span class="line">                r = <span class="keyword">new</span> StringBuilder(<span class="number">256</span>);</span><br><span class="line">            &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                r.append(<span class="string">' '</span>);</span><br><span class="line">            &#125;</span><br><span class="line">            r.append(p.info.name);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span> (r != <span class="keyword">null</span>) &#123;</span><br><span class="line">        <span class="keyword">if</span> (DEBUG_REMOVE) Log.d(TAG, <span class="string">"  Providers: "</span> + r);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">//【2】移除 service！</span></span><br><span class="line">    N = pkg.services.size();</span><br><span class="line">    r = <span class="keyword">null</span>;</span><br><span class="line">    <span class="keyword">for</span> (i=<span class="number">0</span>; i&lt;N; i++) &#123;</span><br><span class="line">        PackageParser.Service s = pkg.services.get(i);</span><br><span class="line">        mServices.removeService(s);</span><br><span class="line">        <span class="keyword">if</span> (chatty) &#123;</span><br><span class="line">            <span class="keyword">if</span> (r == <span class="keyword">null</span>) &#123;</span><br><span class="line">                r = <span class="keyword">new</span> StringBuilder(<span class="number">256</span>);</span><br><span class="line">            &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                r.append(<span class="string">' '</span>);</span><br><span class="line">            &#125;</span><br><span class="line">            r.append(s.info.name);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span> (r != <span class="keyword">null</span>) &#123;</span><br><span class="line">        <span class="keyword">if</span> (DEBUG_REMOVE) Log.d(TAG, <span class="string">"  Services: "</span> + r);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">//【3】移除 receiver！</span></span><br><span class="line">    N = pkg.receivers.size();</span><br><span class="line">    r = <span class="keyword">null</span>;</span><br><span class="line">    <span class="keyword">for</span> (i=<span class="number">0</span>; i&lt;N; i++) &#123;</span><br><span class="line">        PackageParser.Activity a = pkg.receivers.get(i);</span><br><span class="line">        mReceivers.removeActivity(a, <span class="string">"receiver"</span>);</span><br><span class="line">        <span class="keyword">if</span> (DEBUG_REMOVE &amp;&amp; chatty) &#123;</span><br><span class="line">            <span class="keyword">if</span> (r == <span class="keyword">null</span>) &#123;</span><br><span class="line">                r = <span class="keyword">new</span> StringBuilder(<span class="number">256</span>);</span><br><span class="line">            &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                r.append(<span class="string">' '</span>);</span><br><span class="line">            &#125;</span><br><span class="line">            r.append(a.info.name);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span> (r != <span class="keyword">null</span>) &#123;</span><br><span class="line">        <span class="keyword">if</span> (DEBUG_REMOVE) Log.d(TAG, <span class="string">"  Receivers: "</span> + r);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">//【4】移除 activity！</span></span><br><span class="line">    N = pkg.activities.size();</span><br><span class="line">    r = <span class="keyword">null</span>;</span><br><span class="line">    <span class="keyword">for</span> (i=<span class="number">0</span>; i&lt;N; i++) &#123;</span><br><span class="line">        PackageParser.Activity a = pkg.activities.get(i);</span><br><span class="line">        mActivities.removeActivity(a, <span class="string">"activity"</span>);</span><br><span class="line">        <span class="keyword">if</span> (DEBUG_REMOVE &amp;&amp; chatty) &#123;</span><br><span class="line">            <span class="keyword">if</span> (r == <span class="keyword">null</span>) &#123;</span><br><span class="line">                r = <span class="keyword">new</span> StringBuilder(<span class="number">256</span>);</span><br><span class="line">            &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                r.append(<span class="string">' '</span>);</span><br><span class="line">            &#125;</span><br><span class="line">            r.append(a.info.name);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span> (r != <span class="keyword">null</span>) &#123;</span><br><span class="line">        <span class="keyword">if</span> (DEBUG_REMOVE) Log.d(TAG, <span class="string">"  Activities: "</span> + r);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">//【5】移除定义的 permission，设置了 appop 标志为的权限，从 mAppOpPermissionPackages 也要移除！</span></span><br><span class="line">    N = pkg.permissions.size();</span><br><span class="line">    r = <span class="keyword">null</span>;</span><br><span class="line">    <span class="keyword">for</span> (i=<span class="number">0</span>; i&lt;N; i++) &#123;</span><br><span class="line">        PackageParser.Permission p = pkg.permissions.get(i);</span><br><span class="line">        BasePermission bp = mSettings.mPermissions.get(p.info.name);</span><br><span class="line">        <span class="keyword">if</span> (bp == <span class="keyword">null</span>) &#123;</span><br><span class="line">            bp = mSettings.mPermissionTrees.get(p.info.name);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">if</span> (bp != <span class="keyword">null</span> &amp;&amp; bp.perm == p) &#123;</span><br><span class="line">            bp.perm = <span class="keyword">null</span>;</span><br><span class="line">            <span class="keyword">if</span> (DEBUG_REMOVE &amp;&amp; chatty) &#123;</span><br><span class="line">                <span class="keyword">if</span> (r == <span class="keyword">null</span>) &#123;</span><br><span class="line">                    r = <span class="keyword">new</span> StringBuilder(<span class="number">256</span>);</span><br><span class="line">                &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                    r.append(<span class="string">' '</span>);</span><br><span class="line">                &#125;</span><br><span class="line">                r.append(p.info.name);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">if</span> ((p.info.protectionLevel&amp;PermissionInfo.PROTECTION_FLAG_APPOP) != <span class="number">0</span>) &#123;</span><br><span class="line">            ArraySet&lt;String&gt; appOpPkgs = mAppOpPermissionPackages.get(p.info.name);</span><br><span class="line">            <span class="keyword">if</span> (appOpPkgs != <span class="keyword">null</span>) &#123;</span><br><span class="line">                appOpPkgs.remove(pkg.packageName);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span> (r != <span class="keyword">null</span>) &#123;</span><br><span class="line">        <span class="keyword">if</span> (DEBUG_REMOVE) Log.d(TAG, <span class="string">"  Permissions: "</span> + r);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">//【6】移除请求的 permission，设置了 appop 标志为的权限，从 mAppOpPermissionPackages 也要移除！！</span></span><br><span class="line">    N = pkg.requestedPermissions.size();</span><br><span class="line">    r = <span class="keyword">null</span>;</span><br><span class="line">    <span class="keyword">for</span> (i=<span class="number">0</span>; i&lt;N; i++) &#123;</span><br><span class="line">        String perm = pkg.requestedPermissions.get(i);</span><br><span class="line">        BasePermission bp = mSettings.mPermissions.get(perm);</span><br><span class="line">        <span class="keyword">if</span> (bp != <span class="keyword">null</span> &amp;&amp; (bp.protectionLevel&amp;PermissionInfo.PROTECTION_FLAG_APPOP) != <span class="number">0</span>) &#123;</span><br><span class="line">            ArraySet&lt;String&gt; appOpPkgs = mAppOpPermissionPackages.get(perm);</span><br><span class="line">            <span class="keyword">if</span> (appOpPkgs != <span class="keyword">null</span>) &#123;</span><br><span class="line">                appOpPkgs.remove(pkg.packageName);</span><br><span class="line">                <span class="keyword">if</span> (appOpPkgs.isEmpty()) &#123;</span><br><span class="line">                    mAppOpPermissionPackages.remove(perm);</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span> (r != <span class="keyword">null</span>) &#123;</span><br><span class="line">        <span class="keyword">if</span> (DEBUG_REMOVE) Log.d(TAG, <span class="string">"  Permissions: "</span> + r);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">//【7】移除请求的 instrumentation！</span></span><br><span class="line">    N = pkg.instrumentation.size();</span><br><span class="line">    r = <span class="keyword">null</span>;</span><br><span class="line">    <span class="keyword">for</span> (i=<span class="number">0</span>; i&lt;N; i++) &#123;</span><br><span class="line">        PackageParser.Instrumentation a = pkg.instrumentation.get(i);</span><br><span class="line">        mInstrumentation.remove(a.getComponentName());</span><br><span class="line">        <span class="keyword">if</span> (DEBUG_REMOVE &amp;&amp; chatty) &#123;</span><br><span class="line">            <span class="keyword">if</span> (r == <span class="keyword">null</span>) &#123;</span><br><span class="line">                r = <span class="keyword">new</span> StringBuilder(<span class="number">256</span>);</span><br><span class="line">            &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                r.append(<span class="string">' '</span>);</span><br><span class="line">            &#125;</span><br><span class="line">            r.append(a.info.name);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span> (r != <span class="keyword">null</span>) &#123;</span><br><span class="line">        <span class="keyword">if</span> (DEBUG_REMOVE) Log.d(TAG, <span class="string">"  Instrumentation: "</span> + r);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">//【8】移除 SharedLibraries！</span></span><br><span class="line">    r = <span class="keyword">null</span>;</span><br><span class="line">    <span class="keyword">if</span> ((pkg.applicationInfo.flags&amp;ApplicationInfo.FLAG_SYSTEM) != <span class="number">0</span>) &#123;</span><br><span class="line">        <span class="comment">// Only system apps can hold shared libraries.</span></span><br><span class="line">        <span class="keyword">if</span> (pkg.libraryNames != <span class="keyword">null</span>) &#123;</span><br><span class="line">            <span class="keyword">for</span> (i=<span class="number">0</span>; i&lt;pkg.libraryNames.size(); i++) &#123;</span><br><span class="line">                String name = pkg.libraryNames.get(i);</span><br><span class="line">                SharedLibraryEntry cur = mSharedLibraries.get(name);</span><br><span class="line">                <span class="keyword">if</span> (cur != <span class="keyword">null</span> &amp;&amp; cur.apk != <span class="keyword">null</span> &amp;&amp; cur.apk.equals(pkg.packageName)) &#123;</span><br><span class="line">                    mSharedLibraries.remove(name);</span><br><span class="line">                    <span class="keyword">if</span> (DEBUG_REMOVE &amp;&amp; chatty) &#123;</span><br><span class="line">                        <span class="keyword">if</span> (r == <span class="keyword">null</span>) &#123;</span><br><span class="line">                            r = <span class="keyword">new</span> StringBuilder(<span class="number">256</span>);</span><br><span class="line">                        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                            r.append(<span class="string">' '</span>);</span><br><span class="line">                        &#125;</span><br><span class="line">                        r.append(name);</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span> (r != <span class="keyword">null</span>) &#123;</span><br><span class="line">        <span class="keyword">if</span> (DEBUG_REMOVE) Log.d(TAG, <span class="string">"  Libraries: "</span> + r);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>该阶段的逻辑比较简单，不多说了！</p>
<h4 id="6-2-1-2-disableSystemPackageLPw"><a href="#6-2-1-2-disableSystemPackageLPw" class="headerlink" title="6.2.1.2 disableSystemPackageLPw"></a>6.2.1.2 disableSystemPackageLPw</h4><p>disable 掉系统应用</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">boolean</span> <span class="title">disableSystemPackageLPw</span><span class="params">(PackageParser.Package oldPkg,</span></span></span><br><span class="line"><span class="function"><span class="params">        PackageParser.Package newPkg)</span> </span>&#123;</span><br><span class="line">    <span class="comment">//【6.2.1.2.1】disable 掉父包，父包是要通过 replace 方式！</span></span><br><span class="line">    <span class="keyword">boolean</span> disabled = mSettings.disableSystemPackageLPw(oldPkg.packageName, <span class="keyword">true</span>);</span><br><span class="line">    <span class="comment">// Disable the child packages</span></span><br><span class="line">    <span class="keyword">final</span> <span class="keyword">int</span> childCount = (oldPkg.childPackages != <span class="keyword">null</span>) ? oldPkg.childPackages.size() : <span class="number">0</span>;</span><br><span class="line">    <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; childCount; i++) &#123;</span><br><span class="line">        PackageParser.Package childPkg = oldPkg.childPackages.get(i);</span><br><span class="line">        <span class="keyword">final</span> <span class="keyword">boolean</span> replace = newPkg.hasChildPackage(childPkg.packageName);</span><br><span class="line">        <span class="comment">//【6.2.1.2.1】disable 掉子包，如果新包也有子包，那就通过 replace 方式！</span></span><br><span class="line">        disabled |= mSettings.disableSystemPackageLPw(childPkg.packageName, replace);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> disabled;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>这里调用了 Settings 的 disableSystemPackageLPw 方法！</p>
<h5 id="6-2-1-2-1-Settings-disableSystemPackageLPw"><a href="#6-2-1-2-1-Settings-disableSystemPackageLPw" class="headerlink" title="6.2.1.2.1 Settings.disableSystemPackageLPw"></a>6.2.1.2.1 Settings.disableSystemPackageLPw</h5><p>我们继续分析：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">boolean</span> <span class="title">disableSystemPackageLPw</span><span class="params">(String name, <span class="keyword">boolean</span> replaced)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">final</span> PackageSetting p = mPackages.get(name);</span><br><span class="line">    <span class="comment">//【1】异常判断，如果没安装，disable 个屁！</span></span><br><span class="line">    <span class="keyword">if</span>(p == <span class="keyword">null</span>) &#123;</span><br><span class="line">        Log.w(PackageManagerService.TAG, <span class="string">"Package "</span> + name + <span class="string">" is not an installed package"</span>);</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">false</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">//【2】尝试从 mDisabledSysPackages 列表中获得 PackageSetting！</span></span><br><span class="line">    <span class="keyword">final</span> PackageSetting dp = mDisabledSysPackages.get(name);</span><br><span class="line">    </span><br><span class="line">    <span class="comment">//【3】判断 disable 的条件是否满足：</span></span><br><span class="line">    <span class="comment">// 1、之前没有 disable；2、是系统应用；3、没有更新过！</span></span><br><span class="line">    <span class="keyword">if</span> (dp == <span class="keyword">null</span> &amp;&amp; p.pkg != <span class="keyword">null</span> &amp;&amp; p.pkg.isSystemApp() &amp;&amp; !p.pkg.isUpdatedSystemApp()) &#123;</span><br><span class="line">        <span class="comment">//【3.1】设置 ApplicationInfo.FLAG_UPDATED_SYSTEM_APP 标志位，表示更新过的 sys app！</span></span><br><span class="line">        <span class="keyword">if</span>((p.pkg != <span class="keyword">null</span>) &amp;&amp; (p.pkg.applicationInfo != <span class="keyword">null</span>)) &#123;</span><br><span class="line">            p.pkg.applicationInfo.flags |= ApplicationInfo.FLAG_UPDATED_SYSTEM_APP;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">//【3.2】将其旧应用的 PackageSetting 添加到 mDisabledSysPackages 中！</span></span><br><span class="line">        mDisabledSysPackages.put(name, p);</span><br><span class="line"></span><br><span class="line">        <span class="comment">//【3.4】判断是否是 replace，显然，对于 base apk 是需要 replace 的，对于 child apk，</span></span><br><span class="line">        <span class="comment">// 需要看新安装的应用是否有相应的子包！</span></span><br><span class="line">        <span class="keyword">if</span> (replaced) &#123;</span><br><span class="line">            PackageSetting newp = <span class="keyword">new</span> PackageSetting(p); <span class="comment">// copy 一份旧数据</span></span><br><span class="line">            <span class="comment">//【3.5】用 copy 后的数据替换之前的数据！</span></span><br><span class="line">            replacePackageLPw(name, newp);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">true</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">false</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>可以看到，对于系统应用来说，只有第一次覆盖更新时，会 disable 掉 sys 下的那个 app；如果多次覆盖安装，后续的不会再 disable！</p>
<p>下面是替换的具体操作！</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">replacePackageLPw</span><span class="params">(String name, PackageSetting newp)</span> </span>&#123;</span><br><span class="line">    <span class="comment">//【1】获得之前数据，然后根据 uid 的不同做不同的处理！</span></span><br><span class="line">    <span class="keyword">final</span> PackageSetting p = mPackages.get(name);</span><br><span class="line">    <span class="keyword">if</span> (p != <span class="keyword">null</span>) &#123;</span><br><span class="line">        <span class="keyword">if</span> (p.sharedUser != <span class="keyword">null</span>) &#123;</span><br><span class="line">            p.sharedUser.removePackage(p);</span><br><span class="line">            p.sharedUser.addPackage(newp);</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            replaceUserIdLPw(p.appId, newp);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">//【2】更新 mPackages 中的数据！</span></span><br><span class="line">    mPackages.put(name, newp);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>旧的数据，此时是在 mDisabledSysPackages 中！</p>
<h4 id="6-2-1-3-createInstallArgsForExisting-要删除的被更新-apk"><a href="#6-2-1-3-createInstallArgsForExisting-要删除的被更新-apk" class="headerlink" title="6.2.1.3 createInstallArgsForExisting - 要删除的被更新 apk"></a>6.2.1.3 createInstallArgsForExisting - 要删除的被更新 apk</h4><p>这里是针对已存在的应用创建一个 InstallArgs</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">private</span> InstallArgs <span class="title">createInstallArgsForExisting</span><span class="params">(<span class="keyword">int</span> installFlags, String codePath,</span></span></span><br><span class="line"><span class="function"><span class="params">        String resourcePath, String[] instructionSets)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">final</span> <span class="keyword">boolean</span> isInAsec;</span><br><span class="line">    <span class="keyword">if</span> (installOnExternalAsec(installFlags)) &#123;</span><br><span class="line">        <span class="comment">//【1】如果是安装到外置的，那就创建 AsecInstallArgs！</span></span><br><span class="line">        isInAsec = <span class="keyword">true</span>;</span><br><span class="line">    &#125; <span class="keyword">else</span> <span class="keyword">if</span> (installForwardLocked(installFlags)</span><br><span class="line">            &amp;&amp; !codePath.startsWith(mDrmAppPrivateInstallDir.getAbsolutePath())) &#123;</span><br><span class="line">        <span class="comment">//【2】对于 forward lock 安装，如果目录是 drm app pri</span></span><br><span class="line">        <span class="comment">// 那就创建 AsecInstallArgs！</span></span><br><span class="line">        isInAsec = <span class="keyword">true</span>;</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        isInAsec = <span class="keyword">false</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (isInAsec) &#123;</span><br><span class="line">        <span class="comment">//【3】创建 AsecInstallArgs 安装参数</span></span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> AsecInstallArgs(codePath, instructionSets,</span><br><span class="line">                installOnExternalAsec(installFlags), installForwardLocked(installFlags));</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        <span class="comment">//【5.5.3.1】一般情况下，会创建 FileInstallArgs，这里通过 FileInstallArgs 的另一构造器</span></span><br><span class="line">        <span class="comment">// 创建了实例，描述一个已经存在的 app！</span></span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> FileInstallArgs(codePath, resourcePath, instructionSets);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>这里又回到了 5.5.3.1 的 FileInstallArgs 的相关创建！</p>
<h4 id="6-2-1-4-clearAppDataLIF"><a href="#6-2-1-4-clearAppDataLIF" class="headerlink" title="6.2.1.4 clearAppDataLIF"></a>6.2.1.4 clearAppDataLIF</h4><p>清楚 app 的数据：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">clearAppDataLIF</span><span class="params">(PackageParser.Package pkg, <span class="keyword">int</span> userId, <span class="keyword">int</span> flags)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">if</span> (pkg == <span class="keyword">null</span>) &#123;</span><br><span class="line">        Slog.wtf(TAG, <span class="string">"Package was null!"</span>, <span class="keyword">new</span> Throwable());</span><br><span class="line">        <span class="keyword">return</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">//【1】处理父包！</span></span><br><span class="line">    clearAppDataLeafLIF(pkg, userId, flags);</span><br><span class="line">    <span class="keyword">final</span> <span class="keyword">int</span> childCount = (pkg.childPackages != <span class="keyword">null</span>) ? pkg.childPackages.size() : <span class="number">0</span>;</span><br><span class="line">    <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; childCount; i++) &#123;</span><br><span class="line">        <span class="comment">//【2】调用另外一个方法处理子包！</span></span><br><span class="line">        clearAppDataLeafLIF(pkg.childPackages.get(i), userId, flags);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>继续看：<br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">clearAppDataLeafLIF</span><span class="params">(PackageParser.Package pkg, <span class="keyword">int</span> userId, <span class="keyword">int</span> flags)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">final</span> PackageSetting ps;</span><br><span class="line">    <span class="keyword">synchronized</span> (mPackages) &#123;</span><br><span class="line">        ps = mSettings.mPackages.get(pkg.packageName);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">for</span> (<span class="keyword">int</span> realUserId : resolveUserIds(userId)) &#123;</span><br><span class="line">        <span class="keyword">final</span> <span class="keyword">long</span> ceDataInode = (ps != <span class="keyword">null</span>) ? ps.getCeDataInode(realUserId) : <span class="number">0</span>;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            mInstaller.clearAppData(pkg.volumeUuid, pkg.packageName, realUserId, flags,</span><br><span class="line">                    ceDataInode);</span><br><span class="line">        &#125; <span class="keyword">catch</span> (InstallerException e) &#123;</span><br><span class="line">            Slog.w(TAG, String.valueOf(e));</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<h4 id="6-2-1-5-clearAppProfilesLIF"><a href="#6-2-1-5-clearAppProfilesLIF" class="headerlink" title="6.2.1.5 clearAppProfilesLIF"></a>6.2.1.5 clearAppProfilesLIF</h4><p>清楚 app 的 profiles 数据：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">clearAppProfilesLIF</span><span class="params">(PackageParser.Package pkg, <span class="keyword">int</span> userId)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">if</span> (pkg == <span class="keyword">null</span>) &#123;</span><br><span class="line">        Slog.wtf(TAG, <span class="string">"Package was null!"</span>, <span class="keyword">new</span> Throwable());</span><br><span class="line">        <span class="keyword">return</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">//【×6.2.1.5.1】清除父包的 profile 数据！</span></span><br><span class="line">    clearAppProfilesLeafLIF(pkg);</span><br><span class="line"></span><br><span class="line">    <span class="comment">// We don't remove the base foreign use marker when clearing profiles because</span></span><br><span class="line">    <span class="comment">// we will rename it when the app is updated. Unlike the actual profile contents,</span></span><br><span class="line">    <span class="comment">// the foreign use marker is good across installs.</span></span><br><span class="line">    destroyAppReferenceProfileLeafLIF(pkg, userId, <span class="keyword">false</span> <span class="comment">/* removeBaseMarker */</span>);</span><br><span class="line">    <span class="keyword">final</span> <span class="keyword">int</span> childCount = (pkg.childPackages != <span class="keyword">null</span>) ? pkg.childPackages.size() : <span class="number">0</span>;</span><br><span class="line">    <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; childCount; i++) &#123;</span><br><span class="line">        <span class="comment">//【×6.2.1.5.1】清除子包的！</span></span><br><span class="line">        clearAppProfilesLeafLIF(pkg.childPackages.get(i));</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h5 id="6-2-1-5-1-clearAppProfilesLeafLIF"><a href="#6-2-1-5-1-clearAppProfilesLeafLIF" class="headerlink" title="6.2.1.5.1 clearAppProfilesLeafLIF"></a>6.2.1.5.1 clearAppProfilesLeafLIF</h5><p>最终调用了这个方法，清楚 profile 数据：<br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">clearAppProfilesLeafLIF</span><span class="params">(PackageParser.Package pkg)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">        mInstaller.clearAppProfiles(pkg.packageName);</span><br><span class="line">    &#125; <span class="keyword">catch</span> (InstallerException e) &#123;</span><br><span class="line">        Slog.w(TAG, String.valueOf(e));</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<h4 id="6-2-1-6-removeInstalledPackageLI"><a href="#6-2-1-6-removeInstalledPackageLI" class="headerlink" title="6.2.1.6 removeInstalledPackageLI"></a>6.2.1.6 removeInstalledPackageLI</h4><p>移除被扫描到的新的 apk 的数据：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">removeInstalledPackageLI</span><span class="params">(PackageParser.Package pkg, <span class="keyword">boolean</span> chatty)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">if</span> (DEBUG_INSTALL) &#123;</span><br><span class="line">        <span class="keyword">if</span> (chatty)</span><br><span class="line">            Log.d(TAG, <span class="string">"Removing package "</span> + pkg.applicationInfo.packageName);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// writer</span></span><br><span class="line">    <span class="keyword">synchronized</span> (mPackages) &#123;</span><br><span class="line">        <span class="comment">//【1】移除父包!</span></span><br><span class="line">        mPackages.remove(pkg.applicationInfo.packageName);</span><br><span class="line">        <span class="comment">//【*6.2.1.1.1】移除父包的数据结构！</span></span><br><span class="line">        cleanPackageDataStructuresLILPw(pkg, chatty);</span><br><span class="line"></span><br><span class="line">        <span class="comment">// Remove the child packages</span></span><br><span class="line">        <span class="keyword">final</span> <span class="keyword">int</span> childCount = (pkg.childPackages != <span class="keyword">null</span>) ? pkg.childPackages.size() : <span class="number">0</span>;</span><br><span class="line">        <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; childCount; i++) &#123;</span><br><span class="line">            <span class="comment">//【2】移除子包!</span></span><br><span class="line">            PackageParser.Package childPkg = pkg.childPackages.get(i);</span><br><span class="line">            mPackages.remove(childPkg.applicationInfo.packageName);</span><br><span class="line">            <span class="comment">//【*6.2.1.1.1】移除子包的数据结构！</span></span><br><span class="line">            cleanPackageDataStructuresLILPw(childPkg, chatty);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h4 id="6-2-1-7-enableSystemPackageLPw"><a href="#6-2-1-7-enableSystemPackageLPw" class="headerlink" title="6.2.1.7 enableSystemPackageLPw"></a>6.2.1.7 enableSystemPackageLPw</h4><p>恢复系统应用</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">enableSystemPackageLPw</span><span class="params">(PackageParser.Package pkg)</span> </span>&#123;</span><br><span class="line">    <span class="comment">//【1】恢复父包！</span></span><br><span class="line">    mSettings.enableSystemPackageLPw(pkg.packageName);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">final</span> <span class="keyword">int</span> childCount = (pkg.childPackages != <span class="keyword">null</span>) ? pkg.childPackages.size() : <span class="number">0</span>;</span><br><span class="line">    <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; childCount; i++) &#123;</span><br><span class="line">        PackageParser.Package childPkg = pkg.childPackages.get(i);</span><br><span class="line">        <span class="comment">//【*6.2.1.7.1】恢复子包！</span></span><br><span class="line">        mSettings.enableSystemPackageLPw(childPkg.packageName);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h5 id="6-2-1-7-1-Settings-enableSystemPackageLPw"><a href="#6-2-1-7-1-Settings-enableSystemPackageLPw" class="headerlink" title="6.2.1.7.1 Settings.enableSystemPackageLPw"></a>6.2.1.7.1 Settings.enableSystemPackageLPw</h5><p>最终会调用 Settings 的 enableSystemPackageLPw 方法 enable package：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="function">PackageSetting <span class="title">enableSystemPackageLPw</span><span class="params">(String name)</span> </span>&#123;</span><br><span class="line">    <span class="comment">//【1】判断该 sys package 是否被 disable 了；</span></span><br><span class="line">    PackageSetting p = mDisabledSysPackages.get(name);</span><br><span class="line">    <span class="keyword">if</span>(p == <span class="keyword">null</span>) &#123;</span><br><span class="line">        Log.w(PackageManagerService.TAG, <span class="string">"Package "</span> + name + <span class="string">" is not disabled"</span>);</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">null</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">//【2】取消 ApplicationInfo.FLAG_UPDATED_SYSTEM_APP 标志位！</span></span><br><span class="line">    <span class="keyword">if</span>((p.pkg != <span class="keyword">null</span>) &amp;&amp; (p.pkg.applicationInfo != <span class="keyword">null</span>)) &#123;</span><br><span class="line">        p.pkg.applicationInfo.flags &amp;= ~ApplicationInfo.FLAG_UPDATED_SYSTEM_APP;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">//【3】重新为该 system 创建一个 PackageSetting 对象，并添加到相应的集合中！</span></span><br><span class="line">    PackageSetting ret = addPackageLPw(name, p.realName, p.codePath, p.resourcePath,</span><br><span class="line">            p.legacyNativeLibraryPathString, p.primaryCpuAbiString,</span><br><span class="line">            p.secondaryCpuAbiString, p.cpuAbiOverrideString,</span><br><span class="line">            p.appId, p.versionCode, p.pkgFlags, p.pkgPrivateFlags,</span><br><span class="line">            p.parentPackageName, p.childPackageNames);</span><br><span class="line">    <span class="comment">//【4】从 mDisabledSysPackages 中删除！</span></span><br><span class="line">    mDisabledSysPackages.remove(name);</span><br><span class="line">    <span class="keyword">return</span> ret;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>关于 addPackageLPw 的逻辑这里就不在分析了！</p>
<h3 id="6-2-2-replaceNonSystemPackageLIF-覆盖安装三方应用-gt-接入-8"><a href="#6-2-2-replaceNonSystemPackageLIF-覆盖安装三方应用-gt-接入-8" class="headerlink" title="6.2.2 replaceNonSystemPackageLIF - 覆盖安装三方应用 -&gt; 接入 8"></a>6.2.2 replaceNonSystemPackageLIF - 覆盖安装三方应用 -&gt; 接入 8</h3><p>关于 replaceNonSystemPackageLIF 的逻辑，由于 markdown 不支持 6 级以上的标题，所以移动到第 8 节，单独分析!!</p>
<h1 id="7-PackageManagerS-installNewPackageLIF-全新安装"><a href="#7-PackageManagerS-installNewPackageLIF-全新安装" class="headerlink" title="7 PackageManagerS.installNewPackageLIF - 全新安装"></a>7 PackageManagerS.installNewPackageLIF - 全新安装</h1><h2 id="7-1-参数分析"><a href="#7-1-参数分析" class="headerlink" title="7.1 参数分析"></a>7.1 参数分析</h2><p>这里我们来回顾下传入的参数：final int policyFlags 就是我们之前的解析参数 parseFlags</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//【1】默认情况下： mDefParseFlags = 0 </span></span><br><span class="line"><span class="keyword">final</span> <span class="keyword">int</span> parseFlags = mDefParseFlags | PackageParser.PARSE_CHATTY</span><br><span class="line">        | PackageParser.PARSE_ENFORCE_CODE</span><br><span class="line">        | (forwardLocked ? PackageParser.PARSE_FORWARD_LOCK : <span class="number">0</span>)</span><br><span class="line">        | (onExternal ? PackageParser.PARSE_EXTERNAL_STORAGE : <span class="number">0</span>)</span><br><span class="line">        | (ephemeral ? PackageParser.PARSE_IS_EPHEMERAL : <span class="number">0</span>)</span><br><span class="line">        | (forceSdk ? PackageParser.PARSE_FORCE_SDK : <span class="number">0</span>);</span><br></pre></td></tr></table></figure>
<p>同时，对于扫描标志位 scanFlags，会做如下处理：<br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//【2】设置扫描参数</span></span><br><span class="line"><span class="keyword">int</span> scanFlags = SCAN_NEW_INSTALL | SCAN_UPDATE_SIGNATURE;</span><br><span class="line"><span class="keyword">if</span> (args.move != <span class="keyword">null</span>) &#123;</span><br><span class="line">	<span class="comment">//【2.1】如果 args.move 不为 null，表示正在移动一个 app，我们会对其进行一个初始化的扫描</span></span><br><span class="line">	<span class="comment">// 增加 SCAN_INITIAL 位！</span></span><br><span class="line">	scanFlags |= SCAN_INITIAL;</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">if</span> ((installFlags &amp; PackageManager.INSTALL_DONT_KILL_APP) != <span class="number">0</span>) &#123; </span><br><span class="line">	<span class="comment">//【2.2】如果安装参数指定了 INSTALL_DONT_KILL_APP，那么增加 SCAN_DONT_KILL_APP 位！</span></span><br><span class="line">	scanFlags |= SCAN_DONT_KILL_APP;</span><br><span class="line">&#125;</span><br><span class="line">... ... ...</span><br><span class="line"><span class="comment">//【13】根据安装参数做不同的处理！</span></span><br><span class="line"><span class="keyword">if</span> (args.move != <span class="keyword">null</span>) &#123;</span><br><span class="line">	<span class="comment">//【13.1】如果是 move package，进入这里！</span></span><br><span class="line">	scanFlags |= SCAN_NO_DEX; <span class="comment">// 设置以下标签，无需做 odex，我们需要已有的移动过去即可！</span></span><br><span class="line">	scanFlags |= SCAN_MOVE;</span><br><span class="line">	... ... ...</span><br><span class="line">&#125; <span class="keyword">else</span> <span class="keyword">if</span> (!forwardLocked &amp;&amp; !pkg.applicationInfo.isExternalAsec()) &#123;</span><br><span class="line">	<span class="comment">//【13.2】如果不是 forward lock 模式安装且没有安装到外置存储上，进入这里！</span></span><br><span class="line">	scanFlags |= SCAN_NO_DEX; <span class="comment">// 扫描参数设置 SCAN_NO_DEX，意味着后面不做 odex，因为这里会做！</span></span><br><span class="line">	... ... ...</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>上面我们省略掉了不重要的代码段！</p>
<h2 id="7-2-方法解析"><a href="#7-2-方法解析" class="headerlink" title="7.2 方法解析"></a>7.2 方法解析</h2><p>下面继续分析核心方法：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">installNewPackageLIF</span><span class="params">(PackageParser.Package pkg, <span class="keyword">final</span> <span class="keyword">int</span> policyFlags,</span></span></span><br><span class="line"><span class="function"><span class="params">        <span class="keyword">int</span> scanFlags, UserHandle user, String installerPackageName, String volumeUuid,</span></span></span><br><span class="line"><span class="function"><span class="params">        PackageInstalledInfo res)</span> </span>&#123;</span><br><span class="line">    Trace.traceBegin(TRACE_TAG_PACKAGE_MANAGER, <span class="string">"installNewPackage"</span>);</span><br><span class="line"></span><br><span class="line">    <span class="comment">// Remember this for later, in case we need to rollback this install</span></span><br><span class="line">    String pkgName = pkg.packageName;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (DEBUG_INSTALL) Slog.d(TAG, <span class="string">"installNewPackageLI: "</span> + pkg);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">synchronized</span>(mPackages) &#123;</span><br><span class="line">        <span class="comment">//【1】如果已经有一个同名的应用安装了，并且其被改为的旧的名字，那么这种情况不能用该接口安装，</span></span><br><span class="line">        <span class="comment">// 需要使用 replace 接口来更新！</span></span><br><span class="line">        <span class="keyword">if</span> (mSettings.mRenamedPackages.containsKey(pkgName)) &#123;</span><br><span class="line">            res.setError(INSTALL_FAILED_ALREADY_EXISTS, <span class="string">"Attempt to re-install "</span> + pkgName</span><br><span class="line">                    + <span class="string">" without first uninstalling package running as "</span></span><br><span class="line">                    + mSettings.mRenamedPackages.get(pkgName));</span><br><span class="line">            <span class="keyword">return</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">//【2】如果 PMS.mPackages 中已经扫描到同名的应用，这种情况不能用该接口安装，需要通过 replace 接口！</span></span><br><span class="line">        <span class="keyword">if</span> (mPackages.containsKey(pkgName)) &#123;</span><br><span class="line">            <span class="comment">// Don't allow installation over an existing package with the same name.</span></span><br><span class="line">            res.setError(INSTALL_FAILED_ALREADY_EXISTS, <span class="string">"Attempt to re-install "</span> + pkgName</span><br><span class="line">                    + <span class="string">" without first uninstalling."</span>);</span><br><span class="line">            <span class="keyword">return</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">        <span class="comment">//【3】核心方法，扫描 apk，这里和 PMS 开机的时候一样！</span></span><br><span class="line">        PackageParser.Package newPackage = scanPackageTracedLI(pkg, policyFlags, scanFlags,</span><br><span class="line">                System.currentTimeMillis(), user);</span><br><span class="line">        <span class="comment">//【*7.2.1】更新 Settings 中对应的 PackageSettings 集合！</span></span><br><span class="line">        updateSettingsLI(newPackage, installerPackageName, <span class="keyword">null</span>, res, user);</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (res.returnCode == PackageManager.INSTALL_SUCCEEDED) &#123;</span><br><span class="line">            <span class="comment">//【*7.2.2】安装成功，准备数据目录！</span></span><br><span class="line">            prepareAppDataAfterInstallLIF(newPackage);</span><br><span class="line"></span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            <span class="comment">//【*8.1】安装失败，删除 apk，但是保存之前就存在的数据！</span></span><br><span class="line">            deletePackageLIF(pkgName, UserHandle.ALL, <span class="keyword">false</span>, <span class="keyword">null</span>,</span><br><span class="line">                    PackageManager.DELETE_KEEP_DATA, res.removedInfo, <span class="keyword">true</span>, <span class="keyword">null</span>);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125; <span class="keyword">catch</span> (PackageManagerException e) &#123;</span><br><span class="line">        res.setError(<span class="string">"Package couldn't be installed in "</span> + pkg.codePath, e);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    Trace.traceEnd(TRACE_TAG_PACKAGE_MANAGER);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>继续分析：</p>
<h3 id="7-2-1-updateSettingsLI"><a href="#7-2-1-updateSettingsLI" class="headerlink" title="7.2.1 updateSettingsLI"></a>7.2.1 updateSettingsLI</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">updateSettingsLI</span><span class="params">(PackageParser.Package newPackage, String installerPackageName,</span></span></span><br><span class="line"><span class="function"><span class="params">        <span class="keyword">int</span>[] allUsers, PackageInstalledInfo res, UserHandle user)</span> </span>&#123;</span><br><span class="line">    <span class="comment">//【×7.2.1.1】更新父包！</span></span><br><span class="line">    updateSettingsInternalLI(newPackage, installerPackageName, allUsers, res.origUsers,</span><br><span class="line">            res, user);</span><br><span class="line">    <span class="comment">//【1】对子包也做相同的处理；</span></span><br><span class="line">    <span class="keyword">final</span> <span class="keyword">int</span> childCount = (newPackage.childPackages != <span class="keyword">null</span>)</span><br><span class="line">            ? newPackage.childPackages.size() : <span class="number">0</span>;</span><br><span class="line">    <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; childCount; i++) &#123;</span><br><span class="line">        PackageParser.Package childPackage = newPackage.childPackages.get(i);</span><br><span class="line">        PackageInstalledInfo childRes = res.addedChildPackages.get(childPackage.packageName);</span><br><span class="line">        <span class="comment">//【×7.2.1.1】更新子包！</span></span><br><span class="line">        updateSettingsInternalLI(childPackage, installerPackageName, allUsers,</span><br><span class="line">                childRes.origUsers, childRes, user);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>继续来看：</p>
<h4 id="7-2-1-1-updateSettingsInternalLI"><a href="#7-2-1-1-updateSettingsInternalLI" class="headerlink" title="7.2.1.1 updateSettingsInternalLI"></a>7.2.1.1 updateSettingsInternalLI</h4><p>此时，apk 已经扫描了，在扫描的最后阶段，也会创建对应的 PackageSettings 对象，这里会根据安装结果，更新数据！</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">updateSettingsInternalLI</span><span class="params">(PackageParser.Package newPackage,</span></span></span><br><span class="line"><span class="function"><span class="params">        String installerPackageName, <span class="keyword">int</span>[] allUsers, <span class="keyword">int</span>[] installedForUsers,</span></span></span><br><span class="line"><span class="function"><span class="params">        PackageInstalledInfo res, UserHandle user)</span> </span>&#123;</span><br><span class="line">    Trace.traceBegin(TRACE_TAG_PACKAGE_MANAGER, <span class="string">"updateSettings"</span>);</span><br><span class="line"></span><br><span class="line">    String pkgName = newPackage.packageName;</span><br><span class="line">    <span class="keyword">synchronized</span> (mPackages) &#123;</span><br><span class="line">        <span class="comment">//【1】如果应用已经安装了，更新安装状态 INCOMPLETE，并调用 writeLPr 方法更新本地文件！</span></span><br><span class="line">        <span class="comment">// writeLPr 方法在 PMS 开机的时候后有分析过，这里不多说了！</span></span><br><span class="line">        mSettings.setInstallStatus(pkgName, PackageSettingBase.PKG_INSTALL_INCOMPLETE);</span><br><span class="line">        Trace.traceBegin(TRACE_TAG_PACKAGE_MANAGER, <span class="string">"writeSettings"</span>);</span><br><span class="line">        mSettings.writeLPr();</span><br><span class="line">        Trace.traceEnd(TRACE_TAG_PACKAGE_MANAGER);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (DEBUG_INSTALL) Slog.d(TAG, <span class="string">"New package installed in "</span> + newPackage.codePath);</span><br><span class="line">    <span class="keyword">synchronized</span> (mPackages) &#123;</span><br><span class="line">        <span class="comment">//【2】更新权限信息，移除无效的权限和权限树，更新的 flags 设置了 UPDATE_PERMISSIONS_REPLACE_PKG，</span></span><br><span class="line">        <span class="comment">// 表示只更新自身；如果其有定义权限，还会增加 UPDATE_PERMISSIONS_ALL！</span></span><br><span class="line">        <span class="comment">// 关于 updatePermissionsLPw 我们在 PMS 启动时分析过！</span></span><br><span class="line">        updatePermissionsLPw(newPackage.packageName, newPackage,</span><br><span class="line">                UPDATE_PERMISSIONS_REPLACE_PKG | (newPackage.permissions.size() &gt; <span class="number">0</span></span><br><span class="line">                        ? UPDATE_PERMISSIONS_ALL : <span class="number">0</span>));</span><br><span class="line"></span><br><span class="line">        <span class="comment">//【3】对于系统应用，我们默认其为可用状态！</span></span><br><span class="line">        PackageSetting ps = mSettings.mPackages.get(pkgName);</span><br><span class="line">        <span class="keyword">final</span> <span class="keyword">int</span> userId = user.getIdentifier();</span><br><span class="line">        <span class="keyword">if</span> (ps != <span class="keyword">null</span>) &#123;</span><br><span class="line">            <span class="keyword">if</span> (isSystemApp(newPackage)) &#123;</span><br><span class="line">                <span class="keyword">if</span> (DEBUG_INSTALL) &#123;</span><br><span class="line">                    Slog.d(TAG, <span class="string">"Implicitly enabling system package on upgrade: "</span> + pkgName);</span><br><span class="line">                &#125;</span><br><span class="line">                <span class="comment">//【3.1】设置在请求的 userId 下，该应用可用！</span></span><br><span class="line">                <span class="keyword">if</span> (res.origUsers != <span class="keyword">null</span>) &#123;</span><br><span class="line">                    <span class="keyword">for</span> (<span class="keyword">int</span> origUserId : res.origUsers) &#123;</span><br><span class="line">                        <span class="keyword">if</span> (userId == UserHandle.USER_ALL || userId == origUserId) &#123;</span><br><span class="line">                            ps.setEnabled(COMPONENT_ENABLED_STATE_DEFAULT,</span><br><span class="line">                                    origUserId, installerPackageName);</span><br><span class="line">                        &#125;</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;</span><br><span class="line">                <span class="comment">//【3.2】设置只有在指定要安装的目标 user 下，安装状态为 true！</span></span><br><span class="line">                <span class="keyword">if</span> (allUsers != <span class="keyword">null</span> &amp;&amp; installedForUsers != <span class="keyword">null</span>) &#123;</span><br><span class="line">                    <span class="keyword">for</span> (<span class="keyword">int</span> currentUserId : allUsers) &#123;</span><br><span class="line">                        <span class="keyword">final</span> <span class="keyword">boolean</span> installed = ArrayUtils.contains(</span><br><span class="line">                                installedForUsers, currentUserId);</span><br><span class="line">                        <span class="keyword">if</span> (DEBUG_INSTALL) &#123;</span><br><span class="line">                            Slog.d(TAG, <span class="string">"    user "</span> + currentUserId + <span class="string">" =&gt; "</span> + installed);</span><br><span class="line">                        &#125;</span><br><span class="line">                        ps.setInstalled(installed, currentUserId);</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="comment">//【3.3】如果安装目标用户不是 UserHandle.USER_ALL，设置其在该 userId 下为已安装状态并且可用！</span></span><br><span class="line">            <span class="keyword">if</span> (userId != UserHandle.USER_ALL) &#123;</span><br><span class="line">                ps.setInstalled(<span class="keyword">true</span>, userId);</span><br><span class="line">                ps.setEnabled(COMPONENT_ENABLED_STATE_DEFAULT, userId, installerPackageName);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">//【4】修改安装结果对象中的属性！</span></span><br><span class="line">        res.name = pkgName;</span><br><span class="line">        res.uid = newPackage.applicationInfo.uid;</span><br><span class="line">        res.pkg = newPackage;</span><br><span class="line"></span><br><span class="line">        <span class="comment">//【5】更新 Settings 中该 PackageSetting 的安装状态！</span></span><br><span class="line">        mSettings.setInstallStatus(pkgName, PackageSettingBase.PKG_INSTALL_COMPLETE);</span><br><span class="line">        mSettings.setInstallerPackageName(pkgName, installerPackageName);</span><br><span class="line">        </span><br><span class="line">        res.setReturnCode(PackageManager.INSTALL_SUCCEEDED);</span><br><span class="line">        </span><br><span class="line">        <span class="comment">//【6】并调用 writeLPr 方法更新本地文件！</span></span><br><span class="line">        Trace.traceBegin(TRACE_TAG_PACKAGE_MANAGER, <span class="string">"writeSettings"</span>);</span><br><span class="line">        mSettings.writeLPr();</span><br><span class="line">        Trace.traceEnd(TRACE_TAG_PACKAGE_MANAGER);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    Trace.traceEnd(TRACE_TAG_PACKAGE_MANAGER);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h3 id="7-2-2-prepareAppDataAfterInstallLIF"><a href="#7-2-2-prepareAppDataAfterInstallLIF" class="headerlink" title="7.2.2 prepareAppDataAfterInstallLIF"></a>7.2.2 prepareAppDataAfterInstallLIF</h3><p>准备数据目录！</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">prepareAppDataAfterInstallLIF</span><span class="params">(PackageParser.Package pkg)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">final</span> PackageSetting ps;</span><br><span class="line">    <span class="keyword">synchronized</span> (mPackages) &#123;</span><br><span class="line">        <span class="comment">//【1】保存 Kernel Map 数据！</span></span><br><span class="line">        ps = mSettings.mPackages.get(pkg.packageName);</span><br><span class="line">        mSettings.writeKernelMappingLPr(ps);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">final</span> UserManager um = mContext.getSystemService(UserManager.class);</span><br><span class="line">    UserManagerInternal umInternal = getUserManagerInternal();</span><br><span class="line">    <span class="keyword">for</span> (UserInfo user : um.getUsers()) &#123;</span><br><span class="line">        <span class="keyword">final</span> <span class="keyword">int</span> flags;</span><br><span class="line">        <span class="keyword">if</span> (umInternal.isUserUnlockingOrUnlocked(user.id)) &#123;</span><br><span class="line">            flags = StorageManager.FLAG_STORAGE_DE | StorageManager.FLAG_STORAGE_CE;</span><br><span class="line">        &#125; <span class="keyword">else</span> <span class="keyword">if</span> (umInternal.isUserRunning(user.id)) &#123;</span><br><span class="line">            flags = StorageManager.FLAG_STORAGE_DE;</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            <span class="keyword">continue</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">//【2】如果在该 user 下是安装状态，那就在该设备用户下准备数据目录！</span></span><br><span class="line">        <span class="keyword">if</span> (ps.getInstalled(user.id)) &#123;</span><br><span class="line">            <span class="comment">//【7.2.2.1】准备数据目录！</span></span><br><span class="line">            prepareAppDataLIF(pkg, user.id, flags);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>暂时分析到这里！</p>
<h4 id="7-2-2-1-prepareAppDataLIF"><a href="#7-2-2-1-prepareAppDataLIF" class="headerlink" title="7.2.2.1 prepareAppDataLIF"></a>7.2.2.1 prepareAppDataLIF</h4><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">prepareAppDataLIF</span><span class="params">(PackageParser.Package pkg, <span class="keyword">int</span> userId, <span class="keyword">int</span> flags)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">if</span> (pkg == <span class="keyword">null</span>) &#123;</span><br><span class="line">        Slog.wtf(TAG, <span class="string">"Package was null!"</span>, <span class="keyword">new</span> Throwable());</span><br><span class="line">        <span class="keyword">return</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">//【×7.2.2】准备父包的数据目录</span></span><br><span class="line">    prepareAppDataLeafLIF(pkg, userId, flags);</span><br><span class="line">    <span class="keyword">final</span> <span class="keyword">int</span> childCount = (pkg.childPackages != <span class="keyword">null</span>) ? pkg.childPackages.size() : <span class="number">0</span>;</span><br><span class="line">    <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; childCount; i++) &#123;</span><br><span class="line">        <span class="comment">//【×7.2.2.2】准备子包的数据目录</span></span><br><span class="line">        prepareAppDataLeafLIF(pkg.childPackages.get(i), userId, flags);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h4 id="7-2-2-2-prepareAppDataLeafLIF"><a href="#7-2-2-2-prepareAppDataLeafLIF" class="headerlink" title="7.2.2.2 prepareAppDataLeafLIF"></a>7.2.2.2 prepareAppDataLeafLIF</h4><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">prepareAppDataLeafLIF</span><span class="params">(PackageParser.Package pkg, <span class="keyword">int</span> userId, <span class="keyword">int</span> flags)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">if</span> (DEBUG_APP_DATA) &#123;</span><br><span class="line">        Slog.v(TAG, <span class="string">"prepareAppData for "</span> + pkg.packageName + <span class="string">" u"</span> + userId + <span class="string">" 0x"</span></span><br><span class="line">                + Integer.toHexString(flags));</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">final</span> String volumeUuid = pkg.volumeUuid;</span><br><span class="line">    <span class="keyword">final</span> String packageName = pkg.packageName;</span><br><span class="line">    <span class="keyword">final</span> ApplicationInfo app = pkg.applicationInfo;</span><br><span class="line">    <span class="keyword">final</span> <span class="keyword">int</span> appId = UserHandle.getAppId(app.uid);</span><br><span class="line"></span><br><span class="line">    Preconditions.checkNotNull(app.seinfo);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">        <span class="comment">//【1】通过 installd 来准备数据目录！</span></span><br><span class="line">        mInstaller.createAppData(volumeUuid, packageName, userId, flags,</span><br><span class="line">                appId, app.seinfo, app.targetSdkVersion);</span><br><span class="line">    &#125; <span class="keyword">catch</span> (InstallerException e) &#123;</span><br><span class="line">        <span class="comment">//【2】如果是系统应用，第一次准备失败后，还会在尝试一次！</span></span><br><span class="line">        <span class="keyword">if</span> (app.isSystemApp()) &#123;</span><br><span class="line">            logCriticalInfo(Log.ERROR, <span class="string">"Failed to create app data for "</span> + packageName</span><br><span class="line">                    + <span class="string">", but trying to recover: "</span> + e);</span><br><span class="line">            <span class="comment">//【2.1】先删除之前创建的脏目录！</span></span><br><span class="line">            destroyAppDataLeafLIF(pkg, userId, flags);</span><br><span class="line">            <span class="keyword">try</span> &#123;</span><br><span class="line">                <span class="comment">//【2.2】再次创建数据目录；</span></span><br><span class="line">                mInstaller.createAppData(volumeUuid, packageName, userId, flags,</span><br><span class="line">                        appId, app.seinfo, app.targetSdkVersion);</span><br><span class="line">                logCriticalInfo(Log.DEBUG, <span class="string">"Recovery succeeded!"</span>);</span><br><span class="line">            &#125; <span class="keyword">catch</span> (InstallerException e2) &#123;</span><br><span class="line">                logCriticalInfo(Log.DEBUG, <span class="string">"Recovery failed!"</span>);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            Slog.e(TAG, <span class="string">"Failed to create app data for "</span> + packageName + <span class="string">": "</span> + e);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> ((flags &amp; StorageManager.FLAG_STORAGE_CE) != <span class="number">0</span>) &#123;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            <span class="comment">// CE storage is unlocked right now, so read out the inode and</span></span><br><span class="line">            <span class="comment">// remember for use later when it's locked</span></span><br><span class="line">            <span class="comment">// <span class="doctag">TODO:</span> mark this structure as dirty so we persist it!</span></span><br><span class="line">            <span class="keyword">final</span> <span class="keyword">long</span> ceDataInode = mInstaller.getAppDataInode(volumeUuid, packageName, userId,</span><br><span class="line">                    StorageManager.FLAG_STORAGE_CE);</span><br><span class="line">            <span class="keyword">synchronized</span> (mPackages) &#123;</span><br><span class="line">                <span class="keyword">final</span> PackageSetting ps = mSettings.mPackages.get(packageName);</span><br><span class="line">                <span class="keyword">if</span> (ps != <span class="keyword">null</span>) &#123;</span><br><span class="line">                    ps.setCeDataInode(ceDataInode, userId);</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125; <span class="keyword">catch</span> (InstallerException e) &#123;</span><br><span class="line">            Slog.e(TAG, <span class="string">"Failed to find inode for "</span> + packageName + <span class="string">": "</span> + e);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    prepareAppDataContentsLeafLIF(pkg, userId, flags);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h1 id="8-PackageManagerS-replaceNonSystemPackageLIF-接-6-2-2"><a href="#8-PackageManagerS-replaceNonSystemPackageLIF-接-6-2-2" class="headerlink" title="8 PackageManagerS.replaceNonSystemPackageLIF - 接 6.2.2"></a>8 PackageManagerS.replaceNonSystemPackageLIF - 接 6.2.2</h1><p>这里我们分析下覆盖安装三方应用的流程，对于扫描标志位 scanFlags，和上面保持一致：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">replaceNonSystemPackageLIF</span><span class="params">(PackageParser.Package deletedPackage,</span></span></span><br><span class="line"><span class="function"><span class="params">        PackageParser.Package pkg, <span class="keyword">final</span> <span class="keyword">int</span> policyFlags, <span class="keyword">int</span> scanFlags, UserHandle user,</span></span></span><br><span class="line"><span class="function"><span class="params">        <span class="keyword">int</span>[] allUsers, String installerPackageName, PackageInstalledInfo res)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">if</span> (DEBUG_INSTALL) Slog.d(TAG, <span class="string">"replaceNonSystemPackageLI: new="</span> + pkg + <span class="string">", old="</span></span><br><span class="line">            + deletedPackage);</span><br><span class="line"></span><br><span class="line">    String pkgName = deletedPackage.packageName; <span class="comment">// 获得包名！</span></span><br><span class="line">    <span class="keyword">boolean</span> deletedPkg = <span class="keyword">true</span>;</span><br><span class="line">    <span class="keyword">boolean</span> addedPkg = <span class="keyword">false</span>;</span><br><span class="line">    <span class="keyword">boolean</span> updatedSettings = <span class="keyword">false</span>;</span><br><span class="line">    <span class="keyword">final</span> <span class="keyword">boolean</span> killApp = (scanFlags &amp; SCAN_DONT_KILL_APP) == <span class="number">0</span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//【1】设置删除 flags，会保留用户数据！</span></span><br><span class="line">    <span class="keyword">final</span> <span class="keyword">int</span> deleteFlags = PackageManager.DELETE_KEEP_DATA</span><br><span class="line">            | (killApp ? <span class="number">0</span> : PackageManager.DELETE_DONT_KILL_APP);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">final</span> <span class="keyword">long</span> origUpdateTime = (pkg.mExtras != <span class="keyword">null</span>)</span><br><span class="line">            ? ((PackageSetting)pkg.mExtras).lastUpdateTime : <span class="number">0</span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//【*8.1】删除在 data 分区的旧 apk 数据，res.removedInfo 用于表示要移除的 apk！！</span></span><br><span class="line">    <span class="comment">// 删除失败会进入 if 分支！</span></span><br><span class="line">    <span class="keyword">if</span> (!deletePackageLIF(pkgName, <span class="keyword">null</span>, <span class="keyword">true</span>, allUsers, deleteFlags,</span><br><span class="line">            res.removedInfo, <span class="keyword">true</span>, pkg)) &#123;</span><br><span class="line"></span><br><span class="line">        res.setError(INSTALL_FAILED_REPLACE_COULDNT_DELETE, <span class="string">"replaceNonSystemPackageLI"</span>);</span><br><span class="line">        deletedPkg = <span class="keyword">false</span>;</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        <span class="comment">//【2】删除成功后，要判断下被删除的 apk 是否安装在 External 位置或者其是否是 forward lock 的</span></span><br><span class="line">        <span class="comment">// 如果是，那么我们要发送资源变化的广播通知其他进程！！</span></span><br><span class="line">        <span class="keyword">if</span> (deletedPackage.isForwardLocked() || isExternal(deletedPackage)) &#123;</span><br><span class="line">            <span class="keyword">if</span> (DEBUG_INSTALL) &#123;</span><br><span class="line">                Slog.i(TAG, <span class="string">"upgrading pkg "</span> + deletedPackage + <span class="string">" is ASEC-hosted -&gt; UNAVAILABLE"</span>);</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">final</span> <span class="keyword">int</span>[] uidArray = <span class="keyword">new</span> <span class="keyword">int</span>[] &#123; deletedPackage.applicationInfo.uid &#125;;</span><br><span class="line">            <span class="keyword">final</span> ArrayList&lt;String&gt; pkgList = <span class="keyword">new</span> ArrayList&lt;String&gt;(<span class="number">1</span>);</span><br><span class="line">            pkgList.add(deletedPackage.applicationInfo.packageName);</span><br><span class="line">            sendResourcesChangedBroadcast(<span class="keyword">false</span>, <span class="keyword">true</span>, pkgList, uidArray, <span class="keyword">null</span>);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment">//【*6.2.1.4】清楚 code cache 数据！</span></span><br><span class="line">        clearAppDataLIF(pkg, UserHandle.USER_ALL, StorageManager.FLAG_STORAGE_DE</span><br><span class="line">                | StorageManager.FLAG_STORAGE_CE | Installer.FLAG_CLEAR_CODE_CACHE_ONLY);</span><br><span class="line"></span><br><span class="line">        <span class="comment">//【*6.2.1.5】清楚要被删除的应用的 profile 数据，这个和 odex 优化相关！</span></span><br><span class="line">        clearAppProfilesLIF(deletedPackage, UserHandle.USER_ALL);</span><br><span class="line"></span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            <span class="comment">//【3】扫描新的 apk 应用！</span></span><br><span class="line">            <span class="keyword">final</span> PackageParser.Package newPackage = scanPackageTracedLI(pkg, policyFlags,</span><br><span class="line">                    scanFlags | SCAN_UPDATE_TIME, System.currentTimeMillis(), user);</span><br><span class="line">                    </span><br><span class="line">            <span class="comment">//【4】更新系统中的数据结构；</span></span><br><span class="line">            updateSettingsLI(newPackage, installerPackageName, allUsers, res, user);</span><br><span class="line"></span><br><span class="line">            <span class="comment">//【5】记录保存被删除的旧 apk 的 code path，包括父包和子包！</span></span><br><span class="line">            PackageSetting ps = mSettings.mPackages.get(pkgName);</span><br><span class="line">            <span class="keyword">if</span> (!killApp) &#123;</span><br><span class="line">                <span class="keyword">if</span> (ps.oldCodePaths == <span class="keyword">null</span>) &#123;</span><br><span class="line">                    ps.oldCodePaths = <span class="keyword">new</span> ArraySet&lt;&gt;();</span><br><span class="line">                &#125;</span><br><span class="line">                Collections.addAll(ps.oldCodePaths, deletedPackage.baseCodePath);</span><br><span class="line">                <span class="keyword">if</span> (deletedPackage.splitCodePaths != <span class="keyword">null</span>) &#123;</span><br><span class="line">                    Collections.addAll(ps.oldCodePaths, deletedPackage.splitCodePaths);</span><br><span class="line">                &#125;</span><br><span class="line">            &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                ps.oldCodePaths = <span class="keyword">null</span>;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">if</span> (ps.childPackageNames != <span class="keyword">null</span>) &#123;</span><br><span class="line">                <span class="keyword">for</span> (<span class="keyword">int</span> i = ps.childPackageNames.size() - <span class="number">1</span>; i &gt;= <span class="number">0</span>; --i) &#123;</span><br><span class="line">                    <span class="keyword">final</span> String childPkgName = ps.childPackageNames.get(i);</span><br><span class="line">                    <span class="keyword">final</span> PackageSetting childPs = mSettings.mPackages.get(childPkgName);</span><br><span class="line">                    childPs.oldCodePaths = ps.oldCodePaths;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">            </span><br><span class="line">            <span class="comment">//【*7.2.2】准备 app 数据目录；</span></span><br><span class="line">            prepareAppDataAfterInstallLIF(newPackage);</span><br><span class="line">            </span><br><span class="line">            <span class="comment">// 表示安装应用成功！</span></span><br><span class="line">            addedPkg = <span class="keyword">true</span>;</span><br><span class="line">        &#125; <span class="keyword">catch</span> (PackageManagerException e) &#123;</span><br><span class="line">            res.setError(<span class="string">"Package couldn't be installed in "</span> + pkg.codePath, e);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">//【6】如果前面的处理没有问题，进入 if 分支！！</span></span><br><span class="line">    <span class="keyword">if</span> (res.returnCode != PackageManager.INSTALL_SUCCEEDED) &#123;</span><br><span class="line">        <span class="keyword">if</span> (DEBUG_INSTALL) Slog.d(TAG, <span class="string">"Install failed, rolling pack: "</span> + pkgName);</span><br><span class="line"></span><br><span class="line">        <span class="comment">//【*8.1】如果安装不成功，但是我们已经扫描了新的 apk 那么这里会删除其遗留的数据！</span></span><br><span class="line">        <span class="keyword">if</span> (addedPkg) &#123;</span><br><span class="line">            deletePackageLIF(pkgName, <span class="keyword">null</span>, <span class="keyword">true</span>, allUsers, deleteFlags,</span><br><span class="line">                    res.removedInfo, <span class="keyword">true</span>, <span class="keyword">null</span>);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment">//【6.1】如果新 apk 安装失败了，并且执行了清理旧的 apk 的数据，那么这里会 reinstall 旧 apk！</span></span><br><span class="line">        <span class="keyword">if</span> (deletedPkg) &#123;</span><br><span class="line">            <span class="keyword">if</span> (DEBUG_INSTALL) Slog.d(TAG, <span class="string">"Install failed, reinstalling: "</span> + deletedPackage);</span><br><span class="line">            File restoreFile = <span class="keyword">new</span> File(deletedPackage.codePath);</span><br><span class="line"></span><br><span class="line">            <span class="comment">//【6.1.1】设置解析参数 flags！</span></span><br><span class="line">            <span class="keyword">boolean</span> oldExternal = isExternal(deletedPackage);</span><br><span class="line">            <span class="keyword">int</span> oldParseFlags  = mDefParseFlags | PackageParser.PARSE_CHATTY |</span><br><span class="line">                    (deletedPackage.isForwardLocked() ? PackageParser.PARSE_FORWARD_LOCK : <span class="number">0</span>) |</span><br><span class="line">                    (oldExternal ? PackageParser.PARSE_EXTERNAL_STORAGE : <span class="number">0</span>);</span><br><span class="line">            <span class="keyword">int</span> oldScanFlags = SCAN_UPDATE_SIGNATURE | SCAN_UPDATE_TIME;</span><br><span class="line">            <span class="keyword">try</span> &#123;</span><br><span class="line">                <span class="comment">//【6.1.2】重新解析和扫描旧的 apk！</span></span><br><span class="line">                scanPackageTracedLI(restoreFile, oldParseFlags, oldScanFlags, origUpdateTime,</span><br><span class="line">                        <span class="keyword">null</span>);</span><br><span class="line">            &#125; <span class="keyword">catch</span> (PackageManagerException e) &#123;</span><br><span class="line">                Slog.e(TAG, <span class="string">"Failed to restore package : "</span> + pkgName + <span class="string">" after failed upgrade: "</span></span><br><span class="line">                        + e.getMessage());</span><br><span class="line">                <span class="keyword">return</span>;</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            <span class="keyword">synchronized</span> (mPackages) &#123;</span><br><span class="line">                <span class="comment">//【6.1.3】设置 installer name！</span></span><br><span class="line">                setInstallerPackageNameLPw(deletedPackage, installerPackageName);</span><br><span class="line">                </span><br><span class="line">                <span class="comment">//【6.1.4】更新被恢复的旧 apk 的权限信息！</span></span><br><span class="line">                updatePermissionsLPw(deletedPackage, UPDATE_PERMISSIONS_ALL);</span><br><span class="line">                </span><br><span class="line">                <span class="comment">//【6.1.5】持久化内存中的应用数据！</span></span><br><span class="line">                mSettings.writeLPr();</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            Slog.i(TAG, <span class="string">"Successfully restored package : "</span> + pkgName + <span class="string">" after failed upgrade"</span>);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        <span class="comment">//【7】新 apk 覆盖安装成功了，进入 else！</span></span><br><span class="line">        <span class="keyword">synchronized</span> (mPackages) &#123;</span><br><span class="line">            PackageSetting ps = mSettings.peekPackageLPr(pkg.packageName);</span><br><span class="line">            <span class="keyword">if</span> (ps != <span class="keyword">null</span>) &#123;</span><br><span class="line">                <span class="comment">//【7.1】更新要从那些 user 下移除！</span></span><br><span class="line">                res.removedInfo.removedForAllUsers = mPackages.get(ps.name) == <span class="keyword">null</span>;</span><br><span class="line">                <span class="keyword">if</span> (res.removedInfo.removedChildPackages != <span class="keyword">null</span>) &#123;</span><br><span class="line">                    <span class="keyword">final</span> <span class="keyword">int</span> childCount = res.removedInfo.removedChildPackages.size();</span><br><span class="line">                    <span class="keyword">for</span> (<span class="keyword">int</span> i = childCount - <span class="number">1</span>; i &gt;= <span class="number">0</span>; i--) &#123;</span><br><span class="line">                        String childPackageName = res.removedInfo.removedChildPackages.keyAt(i);</span><br><span class="line">                        <span class="keyword">if</span> (res.addedChildPackages.containsKey(childPackageName)) &#123;</span><br><span class="line">                            res.removedInfo.removedChildPackages.removeAt(i);</span><br><span class="line">                        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                            PackageRemovedInfo childInfo = res.removedInfo</span><br><span class="line">                                    .removedChildPackages.valueAt(i);</span><br><span class="line">                            childInfo.removedForAllUsers = mPackages.get(</span><br><span class="line">                                    childInfo.removedPackage) == <span class="keyword">null</span>;</span><br><span class="line">                        &#125;</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>不多说了！</p>
<h2 id="8-1-deletePackageLIF"><a href="#8-1-deletePackageLIF" class="headerlink" title="8.1 deletePackageLIF"></a>8.1 deletePackageLIF</h2><p>删除 apk，参数 PackageParser.Package replacingPackage 表示用于 replace 的 package：</p>
<p>deletePackageLIF 中的逻辑很多涉及到了 delete package 的逻辑，和 install package 并没有太大关系，我们在后面的 delete package 中会继续分析！</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">boolean</span> <span class="title">deletePackageLIF</span><span class="params">(String packageName, UserHandle user,</span></span></span><br><span class="line"><span class="function"><span class="params">        <span class="keyword">boolean</span> deleteCodeAndResources, <span class="keyword">int</span>[] allUserHandles, <span class="keyword">int</span> flags,</span></span></span><br><span class="line"><span class="function"><span class="params">        PackageRemovedInfo outInfo, <span class="keyword">boolean</span> writeSettings,</span></span></span><br><span class="line"><span class="function"><span class="params">        PackageParser.Package replacingPackage)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">if</span> (packageName == <span class="keyword">null</span>) &#123;</span><br><span class="line">        Slog.w(TAG, <span class="string">"Attempt to delete null packageName."</span>);</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">false</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span> (DEBUG_REMOVE) Slog.d(TAG, <span class="string">"deletePackageLI: "</span> + packageName + <span class="string">" user "</span> + user);</span><br><span class="line">    PackageSetting ps;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">synchronized</span> (mPackages) &#123;</span><br><span class="line">        <span class="comment">//【1】获得要删除的 apk 的 PackageSetting 数据！</span></span><br><span class="line">        ps = mSettings.mPackages.get(packageName);</span><br><span class="line">        <span class="keyword">if</span> (ps == <span class="keyword">null</span>) &#123;</span><br><span class="line">            Slog.w(TAG, <span class="string">"Package named '"</span> + packageName + <span class="string">"' doesn't exist."</span>);</span><br><span class="line">            <span class="keyword">return</span> <span class="keyword">false</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">//【2】处理子包的数据：</span></span><br><span class="line">        <span class="comment">// 如果是子包，并且（其不是系统应用，或者 deleteFlags 设置了 DELETE_SYSTEM_APP 标志）！</span></span><br><span class="line">        <span class="comment">// 那么我们会清除该子包的使用状态，同时设置在设备用户下处于未安装状态！</span></span><br><span class="line">        <span class="keyword">if</span> (ps.parentPackageName != <span class="keyword">null</span> &amp;&amp; (!isSystemApp(ps)</span><br><span class="line">                || (flags &amp; PackageManager.DELETE_SYSTEM_APP) != <span class="number">0</span>)) &#123;</span><br><span class="line">            <span class="keyword">if</span> (DEBUG_REMOVE) &#123;</span><br><span class="line">                Slog.d(TAG, <span class="string">"Uninstalled child package:"</span> + packageName + <span class="string">" for user:"</span></span><br><span class="line">                        + ((user == <span class="keyword">null</span>) ? UserHandle.USER_ALL : user));</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="comment">//【2.1】判断下要在那些 user 下删除该子包 apk 的状态信息！</span></span><br><span class="line">            <span class="keyword">final</span> <span class="keyword">int</span> removedUserId = (user != <span class="keyword">null</span>) ? user.getIdentifier()</span><br><span class="line">                    : UserHandle.USER_ALL;</span><br><span class="line"></span><br><span class="line">            <span class="comment">//【*8.1.1】清除掉 userId 下的子包 apk 的使用信息！！</span></span><br><span class="line">            <span class="keyword">if</span> (!clearPackageStateForUserLIF(ps, removedUserId, outInfo)) &#123;</span><br><span class="line">                <span class="keyword">return</span> <span class="keyword">false</span>;</span><br><span class="line">            &#125;</span><br><span class="line">            </span><br><span class="line">            <span class="comment">//【*8.1.2】更新子包 apk 在该 user 下为未安装状态！</span></span><br><span class="line">            markPackageUninstalledForUserLPw(ps, user);</span><br><span class="line">            </span><br><span class="line">            <span class="comment">//【2.2】更新应用偏好设置！</span></span><br><span class="line">            scheduleWritePackageRestrictionsLocked(user);</span><br><span class="line">            <span class="keyword">return</span> <span class="keyword">true</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">//【3】如果只是删除在指定 user 下的安装信息，那么我们会设置其在该 user 下为未安装的状态，同时删除其数据！</span></span><br><span class="line">    <span class="comment">// 如果 deleteFlags 设置了 DELETE_SYSTEM_APP 标志位，表示删除的是系统应用；</span></span><br><span class="line">    <span class="keyword">if</span> (((!isSystemApp(ps) || (flags &amp; PackageManager.DELETE_SYSTEM_APP) != <span class="number">0</span>) &amp;&amp; user != <span class="keyword">null</span></span><br><span class="line">            &amp;&amp; user.getIdentifier() != UserHandle.USER_ALL)) &#123;</span><br><span class="line"></span><br><span class="line">        <span class="comment">//【*8.1.2】更新子包 apk 在该 user 下为未安装状态！</span></span><br><span class="line">        markPackageUninstalledForUserLPw(ps, user);</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (!isSystemApp(ps)) &#123;</span><br><span class="line">            <span class="comment">//【3.1】对于非系统应用的情况，先判断下是否需要保留不卸载！</span></span><br><span class="line">            <span class="keyword">boolean</span> keepUninstalledPackage = shouldKeepUninstalledPackageLPr(packageName);</span><br><span class="line"></span><br><span class="line">            <span class="comment">//【3.2】如果该 package 在其他用户下有安装；或者其需要保留不卸载！</span></span><br><span class="line">            <span class="comment">// 那么我们只需要清楚在当前指定的用户 user 下的数据并设置其为未安装状态；</span></span><br><span class="line">            <span class="keyword">if</span> (ps.isAnyInstalled(sUserManager.getUserIds()) || keepUninstalledPackage) &#123;</span><br><span class="line">                <span class="keyword">if</span> (DEBUG_REMOVE) Slog.d(TAG, <span class="string">"Still installed by other users"</span>);</span><br><span class="line"></span><br><span class="line">                <span class="comment">//【*8.1.1】清除掉当前指定的用户 user 下的 apk 的使用信息！！</span></span><br><span class="line">                <span class="keyword">if</span> (!clearPackageStateForUserLIF(ps, user.getIdentifier(), outInfo)) &#123;</span><br><span class="line">                    <span class="keyword">return</span> <span class="keyword">false</span>;</span><br><span class="line">                &#125;</span><br><span class="line">                <span class="comment">//【3.3】更新应用偏好设置，然后返回！</span></span><br><span class="line">                scheduleWritePackageRestrictionsLocked(user);</span><br><span class="line">                <span class="keyword">return</span> <span class="keyword">true</span>;</span><br><span class="line"></span><br><span class="line">            &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                <span class="comment">//【3.4】这里说明其没有在其他 user 下安装，同时也不需要保留，那么后面会执行删除操作</span></span><br><span class="line">                <span class="comment">// 这里会将在当前指定的用户 user 下的安装状态设置为 installed，这样卸载广播能正确发出！ </span></span><br><span class="line">                <span class="keyword">if</span> (DEBUG_REMOVE) Slog.d(TAG, <span class="string">"Not installed by other users, full delete"</span>);</span><br><span class="line">                ps.setInstalled(<span class="keyword">true</span>, user.getIdentifier());</span><br><span class="line">            &#125;</span><br><span class="line">            </span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            <span class="comment">//【3.5】对于系统应用的情况，这里只会清楚当前指定用户下的数据，然后返回！</span></span><br><span class="line">            <span class="keyword">if</span> (DEBUG_REMOVE) Slog.d(TAG, <span class="string">"Deleting system app"</span>);</span><br><span class="line">            </span><br><span class="line">            <span class="comment">//【*8.1.1】清除掉当前指定的用户 user 下的 apk 的使用信息！！</span></span><br><span class="line">            <span class="keyword">if</span> (!clearPackageStateForUserLIF(ps, user.getIdentifier(), outInfo)) &#123;</span><br><span class="line">                <span class="keyword">return</span> <span class="keyword">false</span>;</span><br><span class="line">            &#125;</span><br><span class="line">            </span><br><span class="line">            <span class="comment">//【3.6】更新应用偏好设置，然后返回！</span></span><br><span class="line">            scheduleWritePackageRestrictionsLocked(user);</span><br><span class="line">            <span class="keyword">return</span> <span class="keyword">true</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//【4】这里按照逻辑，只有系统 apk 才能进入，因为只有系统 apk 才有子包！</span></span><br><span class="line">    <span class="comment">// 这里是处理每个子包的移除信息，包括子包名，子包所在 user！</span></span><br><span class="line">    <span class="keyword">if</span> (ps.childPackageNames != <span class="keyword">null</span> &amp;&amp; outInfo != <span class="keyword">null</span>) &#123;</span><br><span class="line">        <span class="keyword">synchronized</span> (mPackages) &#123;</span><br><span class="line">            <span class="keyword">final</span> <span class="keyword">int</span> childCount = ps.childPackageNames.size();</span><br><span class="line">            outInfo.removedChildPackages = <span class="keyword">new</span> ArrayMap&lt;&gt;(childCount);</span><br><span class="line">            <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; childCount; i++) &#123;</span><br><span class="line">                String childPackageName = ps.childPackageNames.get(i);</span><br><span class="line">                PackageRemovedInfo childInfo = <span class="keyword">new</span> PackageRemovedInfo();</span><br><span class="line">                childInfo.removedPackage = childPackageName;</span><br><span class="line">                </span><br><span class="line">                <span class="comment">//【4.1】添加到父包的 removedChildPackages 集合中！</span></span><br><span class="line">                outInfo.removedChildPackages.put(childPackageName, childInfo);</span><br><span class="line">                PackageSetting childPs = mSettings.peekPackageLPr(childPackageName);</span><br><span class="line">                <span class="keyword">if</span> (childPs != <span class="keyword">null</span>) &#123;</span><br><span class="line">                    childInfo.origUsers = childPs.queryInstalledUsers(allUserHandles, <span class="keyword">true</span>);</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">boolean</span> ret = <span class="keyword">false</span>;</span><br><span class="line">    <span class="keyword">if</span> (isSystemApp(ps)) &#123;</span><br><span class="line">        <span class="keyword">if</span> (DEBUG_REMOVE) Slog.d(TAG, <span class="string">"Removing system package: "</span> + ps.name);</span><br><span class="line">        <span class="comment">//【×8.1.3】删除系统 apk，如果系统 apk 之前被覆盖更新了，那么我们会删除新的 apk</span></span><br><span class="line">        <span class="comment">// 回滚到 system 分区的旧 apk！！</span></span><br><span class="line">        ret = deleteSystemPackageLIF(ps.pkg, ps, allUserHandles, flags, outInfo, writeSettings);</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        <span class="keyword">if</span> (DEBUG_REMOVE) Slog.d(TAG, <span class="string">"Removing non-system package: "</span> + ps.name);</span><br><span class="line">        <span class="comment">//【×8.1.4】删除非系统的 apk！</span></span><br><span class="line">        ret = deleteInstalledPackageLIF(ps, deleteCodeAndResources, flags, allUserHandles,</span><br><span class="line">                outInfo, writeSettings, replacingPackage);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//【5】记录下，我们是否从所有的用户 user 下删除了该 package!</span></span><br><span class="line">    <span class="keyword">if</span> (outInfo != <span class="keyword">null</span>) &#123;</span><br><span class="line">        <span class="comment">//【5.1】更新父包和子包的 removedForAllUsers 属性！</span></span><br><span class="line">        outInfo.removedForAllUsers = mPackages.get(ps.name) == <span class="keyword">null</span>;</span><br><span class="line">        <span class="keyword">if</span> (outInfo.removedChildPackages != <span class="keyword">null</span>) &#123;</span><br><span class="line">            <span class="keyword">synchronized</span> (mPackages) &#123;</span><br><span class="line">                <span class="keyword">final</span> <span class="keyword">int</span> childCount = outInfo.removedChildPackages.size();</span><br><span class="line">                <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; childCount; i++) &#123;</span><br><span class="line">                    PackageRemovedInfo childInfo = outInfo.removedChildPackages.valueAt(i);</span><br><span class="line">                    <span class="keyword">if</span> (childInfo != <span class="keyword">null</span>) &#123;</span><br><span class="line">                        childInfo.removedForAllUsers = mPackages.get(</span><br><span class="line">                                childInfo.removedPackage) == <span class="keyword">null</span>;</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment">//【5.2】我们卸载的是一个系统 apk 的更新包，那么可能有些子包在 system 分区的旧 apk 中声明了</span></span><br><span class="line">        <span class="comment">// 但是在新的 data 更新 apk 中没有申明，这里会处理这种情况！！</span></span><br><span class="line">        <span class="keyword">if</span> (isSystemApp(ps)) &#123;</span><br><span class="line">            <span class="keyword">synchronized</span> (mPackages) &#123;</span><br><span class="line">                PackageSetting updatedPs = mSettings.peekPackageLPr(ps.name);</span><br><span class="line">                <span class="keyword">final</span> <span class="keyword">int</span> childCount = (updatedPs.childPackageNames != <span class="keyword">null</span>)</span><br><span class="line">                        ? updatedPs.childPackageNames.size() : <span class="number">0</span>;</span><br><span class="line">                <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; childCount; i++) &#123;</span><br><span class="line">                    String childPackageName = updatedPs.childPackageNames.get(i);</span><br><span class="line">                    <span class="keyword">if</span> (outInfo.removedChildPackages == <span class="keyword">null</span></span><br><span class="line">                            || outInfo.removedChildPackages.indexOfKey(childPackageName) &lt; <span class="number">0</span>) &#123;</span><br><span class="line">                        PackageSetting childPs = mSettings.peekPackageLPr(childPackageName);</span><br><span class="line">                        <span class="keyword">if</span> (childPs == <span class="keyword">null</span>) &#123;</span><br><span class="line">                            <span class="keyword">continue</span>;</span><br><span class="line">                        &#125;</span><br><span class="line">                        PackageInstalledInfo installRes = <span class="keyword">new</span> PackageInstalledInfo();</span><br><span class="line">                        installRes.name = childPackageName;</span><br><span class="line">                        installRes.newUsers = childPs.queryInstalledUsers(allUserHandles, <span class="keyword">true</span>);</span><br><span class="line">                        installRes.pkg = mPackages.get(childPackageName);</span><br><span class="line">                        installRes.uid = childPs.pkg.applicationInfo.uid;</span><br><span class="line">                        <span class="keyword">if</span> (outInfo.appearedChildPackages == <span class="keyword">null</span>) &#123;</span><br><span class="line">                            outInfo.appearedChildPackages = <span class="keyword">new</span> ArrayMap&lt;&gt;();</span><br><span class="line">                        &#125;</span><br><span class="line">                        <span class="comment">//【5.3】将这些子包保存到 outInfo.appearedChildPackages 中！</span></span><br><span class="line">                        outInfo.appearedChildPackages.put(childPackageName, installRes);</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> ret;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>先看到这里！</p>
<h3 id="8-1-1-clearPackageStateForUserLIF"><a href="#8-1-1-clearPackageStateForUserLIF" class="headerlink" title="8.1.1 clearPackageStateForUserLIF"></a>8.1.1 clearPackageStateForUserLIF</h3><p>清楚指定 user 下的应用数据，这里涉及到的清理操作很多，由于篇幅，这里先不细讲，等到卸载应用时在深入分析！<br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">boolean</span> <span class="title">clearPackageStateForUserLIF</span><span class="params">(PackageSetting ps, <span class="keyword">int</span> userId,</span></span></span><br><span class="line"><span class="function"><span class="params">        PackageRemovedInfo outInfo)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">final</span> PackageParser.Package pkg;</span><br><span class="line">    <span class="keyword">synchronized</span> (mPackages) &#123;</span><br><span class="line">        <span class="comment">//【1】获得旧 apk 的扫描信息！</span></span><br><span class="line">        pkg = mPackages.get(ps.name);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">//【2】判断要删除那些 user 下的状态数据！</span></span><br><span class="line">    <span class="keyword">final</span> <span class="keyword">int</span>[] userIds = (userId == UserHandle.USER_ALL) ? sUserManager.getUserIds()</span><br><span class="line">            : <span class="keyword">new</span> <span class="keyword">int</span>[] &#123;userId&#125;;</span><br><span class="line">    <span class="keyword">for</span> (<span class="keyword">int</span> nextUserId : userIds) &#123;</span><br><span class="line">        <span class="keyword">if</span> (DEBUG_REMOVE) &#123;</span><br><span class="line">            Slog.d(TAG, <span class="string">"Updating package:"</span> + ps.name + <span class="string">" install state for user:"</span></span><br><span class="line">                    + nextUserId);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">//【×8.1.1.1】删除掉旧 apk 的使用状态本地记录文件！</span></span><br><span class="line">        destroyAppDataLIF(pkg, userId,</span><br><span class="line">                StorageManager.FLAG_STORAGE_DE | StorageManager.FLAG_STORAGE_CE);</span><br><span class="line">                </span><br><span class="line">        <span class="comment">//【×8.1.1.2】删除 profile 相关信息！！</span></span><br><span class="line">        destroyAppProfilesLIF(pkg, userId);</span><br><span class="line">        </span><br><span class="line">        <span class="comment">//【4】移除 key store！！</span></span><br><span class="line">        removeKeystoreDataIfNeeded(nextUserId, ps.appId);</span><br><span class="line">        </span><br><span class="line">        <span class="comment">//【×8.1.1.3】执行 package clean 操作！！</span></span><br><span class="line">        schedulePackageCleaning(ps.name, nextUserId, <span class="keyword">false</span>);</span><br><span class="line">        </span><br><span class="line">        <span class="keyword">synchronized</span> (mPackages) &#123;</span><br><span class="line">            <span class="comment">//【5】清楚默认应用设置!</span></span><br><span class="line">            <span class="keyword">if</span> (clearPackagePreferredActivitiesLPw(ps.name, nextUserId)) &#123;</span><br><span class="line">                <span class="comment">//【5.1】更新偏好设置！</span></span><br><span class="line">                scheduleWritePackageRestrictionsLocked(nextUserId);</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="comment">//【6】更新运行时权限信息！</span></span><br><span class="line">            resetUserChangesToRuntimePermissionsAndFlagsLPw(ps, nextUserId);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (outInfo != <span class="keyword">null</span>) &#123;</span><br><span class="line">        outInfo.removedPackage = ps.name;</span><br><span class="line">        outInfo.removedAppId = ps.appId;</span><br><span class="line">        outInfo.removedUsers = userIds;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">true</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>关于以下的内容，会在卸载 app 和权限相关文章中分析，这里由于篇幅原因（markdown 只支持 6 级标题），就先不深入分析了！</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//【3】删除 profile 相关信息！！</span></span><br><span class="line">destroyAppProfilesLIF(pkg, userId);</span><br><span class="line"><span class="comment">//【4】移除 key store！！</span></span><br><span class="line">removeKeystoreDataIfNeeded(nextUserId, ps.appId);</span><br><span class="line"><span class="comment">//【5】清楚默认应用设置</span></span><br><span class="line">clearPackagePreferredActivitiesLPw();</span><br><span class="line"><span class="comment">//【6】更新运行时权限信息！</span></span><br><span class="line">resetUserChangesToRuntimePermissionsAndFlagsLPw(ps, nextUserId);</span><br></pre></td></tr></table></figure>
<p>这里就不再多说了！！</p>
<h4 id="8-1-1-1-destroyAppDataLIF-gt-Leaf"><a href="#8-1-1-1-destroyAppDataLIF-gt-Leaf" class="headerlink" title="8.1.1.1 destroyAppDataLIF -&gt;[Leaf]"></a>8.1.1.1 destroyAppDataLIF -&gt;[Leaf]</h4><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">destroyAppDataLIF</span><span class="params">(PackageParser.Package pkg, <span class="keyword">int</span> userId, <span class="keyword">int</span> flags)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">if</span> (pkg == <span class="keyword">null</span>) &#123;</span><br><span class="line">        Slog.wtf(TAG, <span class="string">"Package was null!"</span>, <span class="keyword">new</span> Throwable());</span><br><span class="line">        <span class="keyword">return</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">//【1】删除父包的数据！！</span></span><br><span class="line">    destroyAppDataLeafLIF(pkg, userId, flags);</span><br><span class="line">    <span class="keyword">final</span> <span class="keyword">int</span> childCount = (pkg.childPackages != <span class="keyword">null</span>) ? pkg.childPackages.size() : <span class="number">0</span>;</span><br><span class="line">    <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; childCount; i++) &#123;</span><br><span class="line">        <span class="comment">//【2】删除子包的数据！</span></span><br><span class="line">        destroyAppDataLeafLIF(pkg.childPackages.get(i), userId, flags);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>继续看：<br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">destroyAppDataLeafLIF</span><span class="params">(PackageParser.Package pkg, <span class="keyword">int</span> userId, <span class="keyword">int</span> flags)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">final</span> PackageSetting ps;</span><br><span class="line">    <span class="keyword">synchronized</span> (mPackages) &#123;</span><br><span class="line">        <span class="comment">//【1】获得该应用的安装信息 PackageSetting ！</span></span><br><span class="line">        ps = mSettings.mPackages.get(pkg.packageName);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">for</span> (<span class="keyword">int</span> realUserId : resolveUserIds(userId)) &#123;</span><br><span class="line">        <span class="comment">//【2】获得要删除的状态信息目录：</span></span><br><span class="line">        <span class="keyword">final</span> <span class="keyword">long</span> ceDataInode = (ps != <span class="keyword">null</span>) ? ps.getCeDataInode(realUserId) : <span class="number">0</span>;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            <span class="comment">//【3】调用了 Installd 删除指定目录！</span></span><br><span class="line">            mInstaller.destroyAppData(pkg.volumeUuid, pkg.packageName, realUserId, flags,</span><br><span class="line">                    ceDataInode);</span><br><span class="line">        &#125; <span class="keyword">catch</span> (InstallerException e) &#123;</span><br><span class="line">            Slog.w(TAG, String.valueOf(e));</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>这里使用了 PackageSetting.getCeDataInode 方法：</p>
<h5 id="8-1-1-1-1-PackageSetting-getCeDataInode"><a href="#8-1-1-1-1-PackageSetting-getCeDataInode" class="headerlink" title="8.1.1.1.1 PackageSetting.getCeDataInode"></a>8.1.1.1.1 PackageSetting.getCeDataInode</h5><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">long</span> <span class="title">getCeDataInode</span><span class="params">(<span class="keyword">int</span> userId)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">return</span> readUserState(userId).ceDataInode;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>该方法返回的是 PackageUserState.ceDataInode 的值！</p>
<h4 id="8-1-1-3-schedulePackageCleaning"><a href="#8-1-1-3-schedulePackageCleaning" class="headerlink" title="8.1.1.3 schedulePackageCleaning"></a>8.1.1.3 schedulePackageCleaning</h4><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">schedulePackageCleaning</span><span class="params">(String packageName, <span class="keyword">int</span> userId, <span class="keyword">boolean</span> andCode)</span> </span>&#123;</span><br><span class="line">    <span class="comment">//【*8.1.1.3.1】这里会发送一个 START_CLEANING_PACKAGE 的消息给 PackageHandler ！</span></span><br><span class="line">    <span class="keyword">final</span> Message msg = mHandler.obtainMessage(START_CLEANING_PACKAGE,</span><br><span class="line">            userId, andCode ? <span class="number">1</span> : <span class="number">0</span>, packageName);</span><br><span class="line">    <span class="keyword">if</span> (mSystemReady) &#123;</span><br><span class="line">        msg.sendToTarget();</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        <span class="keyword">if</span> (mPostSystemReadyMessages == <span class="keyword">null</span>) &#123;</span><br><span class="line">            mPostSystemReadyMessages = <span class="keyword">new</span> ArrayList&lt;&gt;();</span><br><span class="line">        &#125;</span><br><span class="line">        mPostSystemReadyMessages.add(msg);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h5 id="8-1-1-3-1-Packagehandler-doHandleMessage-START-CLEANING-PACKAGE"><a href="#8-1-1-3-1-Packagehandler-doHandleMessage-START-CLEANING-PACKAGE" class="headerlink" title="8.1.1.3.1 Packagehandler.doHandleMessage[START_CLEANING_PACKAGE]"></a>8.1.1.3.1 Packagehandler.doHandleMessage[START_CLEANING_PACKAGE]</h5><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">case</span> START_CLEANING_PACKAGE: &#123;</span><br><span class="line">    Process.setThreadPriority(Process.THREAD_PRIORITY_DEFAULT);</span><br><span class="line">    <span class="keyword">final</span> String packageName = (String)msg.obj;</span><br><span class="line">    <span class="keyword">final</span> <span class="keyword">int</span> userId = msg.arg1;</span><br><span class="line">    <span class="keyword">final</span> <span class="keyword">boolean</span> andCode = msg.arg2 != <span class="number">0</span>;</span><br><span class="line">    <span class="keyword">synchronized</span> (mPackages) &#123;</span><br><span class="line">        <span class="keyword">if</span> (userId == UserHandle.USER_ALL) &#123;</span><br><span class="line">            <span class="keyword">int</span>[] users = sUserManager.getUserIds();</span><br><span class="line">            <span class="keyword">for</span> (<span class="keyword">int</span> user : users) &#123;</span><br><span class="line">                <span class="comment">//【1】将 package 加入到 Settings 内部的 mPackagesToBeCleaned 集合中！</span></span><br><span class="line">                mSettings.addPackageToCleanLPw(</span><br><span class="line">                        <span class="keyword">new</span> PackageCleanItem(user, packageName, andCode));</span><br><span class="line">            &#125;</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            mSettings.addPackageToCleanLPw(</span><br><span class="line">                    <span class="keyword">new</span> PackageCleanItem(userId, packageName, andCode));</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    Process.setThreadPriority(Process.THREAD_PRIORITY_BACKGROUND);</span><br><span class="line">    <span class="comment">//【*8.1.1.3.2】</span></span><br><span class="line">    startCleaningPackages();</span><br><span class="line">&#125; <span class="keyword">break</span>;</span><br></pre></td></tr></table></figure>
<h5 id="8-1-1-3-2-startCleaningPackages"><a href="#8-1-1-3-2-startCleaningPackages" class="headerlink" title="8.1.1.3.2 startCleaningPackages"></a>8.1.1.3.2 startCleaningPackages</h5><p>执行扩展存储清理操作：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">startCleaningPackages</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    <span class="comment">// reader</span></span><br><span class="line">    <span class="keyword">if</span> (!isExternalMediaAvailable()) &#123;</span><br><span class="line">        <span class="keyword">return</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">synchronized</span> (mPackages) &#123;</span><br><span class="line">        <span class="keyword">if</span> (mSettings.mPackagesToBeCleaned.isEmpty()) &#123;</span><br><span class="line">            <span class="keyword">return</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">//【1】发送 action PackageManager.ACTION_CLEAN_EXTERNAL_STORAGE！</span></span><br><span class="line">    Intent intent = <span class="keyword">new</span> Intent(PackageManager.ACTION_CLEAN_EXTERNAL_STORAGE);</span><br><span class="line">    <span class="comment">//【2】目标组件服务：DefaultContainerService</span></span><br><span class="line">    intent.setComponent(DEFAULT_CONTAINER_COMPONENT);</span><br><span class="line">    IActivityManager am = ActivityManagerNative.getDefault();</span><br><span class="line">    <span class="keyword">if</span> (am != <span class="keyword">null</span>) &#123;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            <span class="comment">//【2.1】启动服务！</span></span><br><span class="line">            am.startService(<span class="keyword">null</span>, intent, <span class="keyword">null</span>, mContext.getOpPackageName(),</span><br><span class="line">                    UserHandle.USER_SYSTEM);</span><br><span class="line">        &#125; <span class="keyword">catch</span> (RemoteException e) &#123;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>进入 DefaultContainerService.onHandleIntent 方法：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="function"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title">onHandleIntent</span><span class="params">(Intent intent)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">if</span> (PackageManager.ACTION_CLEAN_EXTERNAL_STORAGE.equals(intent.getAction())) &#123;</span><br><span class="line">        <span class="keyword">final</span> IPackageManager pm = IPackageManager.Stub.asInterface(</span><br><span class="line">                ServiceManager.getService(<span class="string">"package"</span>));</span><br><span class="line">        PackageCleanItem item = <span class="keyword">null</span>;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            <span class="keyword">while</span> ((item = pm.nextPackageToClean(item)) != <span class="keyword">null</span>) &#123;</span><br><span class="line">                <span class="keyword">final</span> UserEnvironment userEnv = <span class="keyword">new</span> UserEnvironment(item.userId);</span><br><span class="line">                eraseFiles(userEnv.buildExternalStorageAppDataDirs(item.packageName));</span><br><span class="line">                eraseFiles(userEnv.buildExternalStorageAppMediaDirs(item.packageName));</span><br><span class="line">                <span class="keyword">if</span> (item.andCode) &#123;</span><br><span class="line">                    eraseFiles(userEnv.buildExternalStorageAppObbDirs(item.packageName));</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125; <span class="keyword">catch</span> (RemoteException e) &#123;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>这里的逻辑就不多说了！</p>
<h3 id="8-1-2-markPackageUninstalledForUserLPw"><a href="#8-1-2-markPackageUninstalledForUserLPw" class="headerlink" title="8.1.2 markPackageUninstalledForUserLPw"></a>8.1.2 markPackageUninstalledForUserLPw</h3><p>更新每个用户下的 package 的用户状态：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">markPackageUninstalledForUserLPw</span><span class="params">(PackageSetting ps, UserHandle user)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">final</span> <span class="keyword">int</span>[] userIds = (user == <span class="keyword">null</span> || user.getIdentifier() == UserHandle.USER_ALL)</span><br><span class="line">            ? sUserManager.getUserIds() : <span class="keyword">new</span> <span class="keyword">int</span>[] &#123;user.getIdentifier()&#125;;</span><br><span class="line">    <span class="keyword">for</span> (<span class="keyword">int</span> nextUserId : userIds) &#123;</span><br><span class="line">        <span class="keyword">if</span> (DEBUG_REMOVE) &#123;</span><br><span class="line">            Slog.d(TAG, <span class="string">"Marking package:"</span> + ps.name + <span class="string">" uninstalled for user:"</span> + nextUserId);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">//【1】调用了 PackageSettings 的 setUserState 接口！</span></span><br><span class="line">        ps.setUserState(nextUserId, <span class="number">0</span>, COMPONENT_ENABLED_STATE_DEFAULT,</span><br><span class="line">                <span class="keyword">false</span> <span class="comment">/*installed*/</span>, <span class="keyword">true</span> <span class="comment">/*stopped*/</span>, <span class="keyword">true</span> <span class="comment">/*notLaunched*/</span>,</span><br><span class="line">                <span class="keyword">false</span> <span class="comment">/*hidden*/</span>, <span class="keyword">false</span> <span class="comment">/*suspended*/</span>, <span class="keyword">null</span>, <span class="keyword">null</span>, <span class="keyword">null</span>,</span><br><span class="line">                <span class="keyword">false</span> <span class="comment">/*blockUninstall*/</span>,</span><br><span class="line">                ps.readUserState(nextUserId).domainVerificationStatus, <span class="number">0</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h3 id="8-1-3-deleteSystemPackageLIF"><a href="#8-1-3-deleteSystemPackageLIF" class="headerlink" title="8.1.3 deleteSystemPackageLIF"></a>8.1.3 deleteSystemPackageLIF</h3><p>关于 flags 的设置：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//【1】设置删除 flags，会保留用户数据！</span></span><br><span class="line"><span class="keyword">final</span> <span class="keyword">int</span> deleteFlags = PackageManager.DELETE_KEEP_DATA</span><br><span class="line">        | (killApp ? <span class="number">0</span> : PackageManager.DELETE_DONT_KILL_APP);</span><br></pre></td></tr></table></figure>
<p>删除 system 更新 apk，PackageRemovedInfo outInfo 用于封装移除的相关信息！</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">boolean</span> <span class="title">deleteSystemPackageLIF</span><span class="params">(PackageParser.Package deletedPkg,</span></span></span><br><span class="line"><span class="function"><span class="params">        PackageSetting deletedPs, <span class="keyword">int</span>[] allUserHandles, <span class="keyword">int</span> flags, PackageRemovedInfo outInfo,</span></span></span><br><span class="line"><span class="function"><span class="params">        <span class="keyword">boolean</span> writeSettings)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">if</span> (deletedPs.parentPackageName != <span class="keyword">null</span>) &#123;</span><br><span class="line">        Slog.w(TAG, <span class="string">"Attempt to delete child system package "</span> + deletedPkg.packageName);</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">false</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">final</span> <span class="keyword">boolean</span> applyUserRestrictions</span><br><span class="line">            = (allUserHandles != <span class="keyword">null</span>) &amp;&amp; (outInfo.origUsers != <span class="keyword">null</span>);</span><br><span class="line">    <span class="keyword">final</span> PackageSetting disabledPs;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">synchronized</span> (mPackages) &#123;</span><br><span class="line">        <span class="comment">//【1】尝试获得被更新的 system apk 数据！</span></span><br><span class="line">        disabledPs = mSettings.getDisabledSystemPkgLPr(deletedPs.name);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (DEBUG_REMOVE) Slog.d(TAG, <span class="string">"deleteSystemPackageLI: newPs="</span> + deletedPkg.packageName</span><br><span class="line">            + <span class="string">" disabledPs="</span> + disabledPs);</span><br><span class="line">    <span class="comment">//【2】如果没有更新，那就不能删除，对于系统 apk，我们只能删除覆盖更新在 data 分区的！</span></span><br><span class="line">    <span class="keyword">if</span> (disabledPs == <span class="keyword">null</span>) &#123;</span><br><span class="line">        Slog.w(TAG, <span class="string">"Attempt to delete unknown system package "</span>+ deletedPkg.packageName);</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">false</span>;</span><br><span class="line">    &#125; <span class="keyword">else</span> <span class="keyword">if</span> (DEBUG_REMOVE) &#123;</span><br><span class="line">        Slog.d(TAG, <span class="string">"Deleting system pkg from data partition"</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (DEBUG_REMOVE) &#123;</span><br><span class="line">        <span class="keyword">if</span> (applyUserRestrictions) &#123;</span><br><span class="line">            Slog.d(TAG, <span class="string">"Remembering install states:"</span>);</span><br><span class="line">            <span class="keyword">for</span> (<span class="keyword">int</span> userId : allUserHandles) &#123;</span><br><span class="line">                <span class="keyword">final</span> <span class="keyword">boolean</span> finstalled = ArrayUtils.contains(outInfo.origUsers, userId);</span><br><span class="line">                Slog.d(TAG, <span class="string">"   u="</span> + userId + <span class="string">" inst="</span> + finstalled);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//【3】设置父包和子包的 isRemovedPackageSystemUpdate 为 true！</span></span><br><span class="line">    outInfo.isRemovedPackageSystemUpdate = <span class="keyword">true</span>;</span><br><span class="line">    <span class="keyword">if</span> (outInfo.removedChildPackages != <span class="keyword">null</span>) &#123;</span><br><span class="line">        <span class="keyword">final</span> <span class="keyword">int</span> childCount = (deletedPs.childPackageNames != <span class="keyword">null</span>)</span><br><span class="line">                ? deletedPs.childPackageNames.size() : <span class="number">0</span>;</span><br><span class="line">        <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; childCount; i++) &#123;</span><br><span class="line">            String childPackageName = deletedPs.childPackageNames.get(i);</span><br><span class="line">            <span class="keyword">if</span> (disabledPs.childPackageNames != <span class="keyword">null</span> &amp;&amp; disabledPs.childPackageNames</span><br><span class="line">                    .contains(childPackageName)) &#123;</span><br><span class="line">                PackageRemovedInfo childInfo = outInfo.removedChildPackages.get(</span><br><span class="line">                        childPackageName);</span><br><span class="line">                <span class="keyword">if</span> (childInfo != <span class="keyword">null</span>) &#123;</span><br><span class="line">                    childInfo.isRemovedPackageSystemUpdate = <span class="keyword">true</span>;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//【4】判读 version code，如果出现降级，那么就不能保留数据！</span></span><br><span class="line">    <span class="keyword">if</span> (disabledPs.versionCode &lt; deletedPs.versionCode) &#123;</span><br><span class="line">        flags &amp;= ~PackageManager.DELETE_KEEP_DATA;</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        flags |= PackageManager.DELETE_KEEP_DATA;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">//【×8.1.4】执行删除 data 分区新 apk，删除失败就结束操作！</span></span><br><span class="line">    <span class="keyword">boolean</span> ret = deleteInstalledPackageLIF(deletedPs, <span class="keyword">true</span>, flags, allUserHandles,</span><br><span class="line">            outInfo, writeSettings, disabledPs.pkg);</span><br><span class="line">    <span class="keyword">if</span> (!ret) &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">false</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//【5】恢复 system 分区的旧 apk 的数据，同时删除更新的 apk 的 native libs</span></span><br><span class="line">    <span class="keyword">synchronized</span> (mPackages) &#123;</span><br><span class="line">        enableSystemPackageLPw(disabledPs.pkg);</span><br><span class="line">        removeNativeBinariesLI(deletedPs);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//【6】设置扫描 flags！</span></span><br><span class="line">    <span class="keyword">if</span> (DEBUG_REMOVE) Slog.d(TAG, <span class="string">"Re-installing system package: "</span> + disabledPs);</span><br><span class="line">    <span class="keyword">int</span> parseFlags = mDefParseFlags</span><br><span class="line">            | PackageParser.PARSE_MUST_BE_APK</span><br><span class="line">            | PackageParser.PARSE_IS_SYSTEM</span><br><span class="line">            | PackageParser.PARSE_IS_SYSTEM_DIR;</span><br><span class="line">    <span class="keyword">if</span> (locationIsPrivileged(disabledPs.codePath)) &#123;</span><br><span class="line">        parseFlags |= PackageParser.PARSE_IS_PRIVILEGED;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">final</span> PackageParser.Package newPkg;</span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">        <span class="comment">//【7】扫描旧的 system apk！</span></span><br><span class="line">        newPkg = scanPackageTracedLI(disabledPs.codePath, parseFlags, SCAN_NO_PATHS, <span class="number">0</span>, <span class="keyword">null</span>);</span><br><span class="line">    &#125; <span class="keyword">catch</span> (PackageManagerException e) &#123;</span><br><span class="line">        Slog.w(TAG, <span class="string">"Failed to restore system package:"</span> + deletedPkg.packageName + <span class="string">": "</span></span><br><span class="line">                + e.getMessage());</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">false</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">        <span class="comment">//【8】更新 shared libs 给重新安装的 system apk！</span></span><br><span class="line">        updateSharedLibrariesLPw(newPkg, <span class="keyword">null</span>);</span><br><span class="line">    &#125; <span class="keyword">catch</span> (PackageManagerException e) &#123;</span><br><span class="line">        Slog.e(TAG, <span class="string">"updateAllSharedLibrariesLPw failed: "</span> + e.getMessage());</span><br><span class="line">    &#125; </span><br><span class="line">    </span><br><span class="line">    <span class="comment">//【*7.2.2】准备 app 数据目录；</span></span><br><span class="line">    prepareAppDataAfterInstallLIF(newPkg);</span><br><span class="line"></span><br><span class="line">    <span class="comment">//【9】更新 pms 数据！</span></span><br><span class="line">    <span class="keyword">synchronized</span> (mPackages) &#123;</span><br><span class="line">        PackageSetting ps = mSettings.mPackages.get(newPkg.packageName);</span><br><span class="line"></span><br><span class="line">        <span class="comment">//【9.1】从被删除的 data 分区 apk 那里继承最新的权限信息！</span></span><br><span class="line">        ps.getPermissionsState().copyFrom(deletedPs.getPermissionsState());</span><br><span class="line">        <span class="comment">//【9.2】更新系统中所有应用的权限信息！</span></span><br><span class="line">        updatePermissionsLPw(newPkg.packageName, newPkg,</span><br><span class="line">                UPDATE_PERMISSIONS_ALL | UPDATE_PERMISSIONS_REPLACE_PKG);</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (applyUserRestrictions) &#123;</span><br><span class="line">            <span class="keyword">if</span> (DEBUG_REMOVE) &#123;</span><br><span class="line">                Slog.d(TAG, <span class="string">"Propagating install state across reinstall"</span>);</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">for</span> (<span class="keyword">int</span> userId : allUserHandles) &#123;</span><br><span class="line">                <span class="keyword">final</span> <span class="keyword">boolean</span> installed = ArrayUtils.contains(outInfo.origUsers, userId);</span><br><span class="line">                <span class="keyword">if</span> (DEBUG_REMOVE) &#123;</span><br><span class="line">                    Slog.d(TAG, <span class="string">"    user "</span> + userId + <span class="string">" =&gt; "</span> + installed);</span><br><span class="line">                &#125;</span><br><span class="line">                ps.setInstalled(installed, userId);</span><br><span class="line">                <span class="comment">//【9.3】持久化运行时权限；</span></span><br><span class="line">                mSettings.writeRuntimePermissionsForUserLPr(userId, <span class="keyword">false</span>);</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="comment">//【9.4】持久化应用偏好设置！</span></span><br><span class="line">            mSettings.writeAllUsersPackageRestrictionsLPr();</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">//【9.5】持久化最新的所有应用数据！</span></span><br><span class="line">        <span class="keyword">if</span> (writeSettings) &#123;</span><br><span class="line">            mSettings.writeLPr();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">true</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>这里就不在多说了！</p>
<h3 id="8-1-4-deleteInstalledPackageLIF"><a href="#8-1-4-deleteInstalledPackageLIF" class="headerlink" title="8.1.4 deleteInstalledPackageLIF"></a>8.1.4 deleteInstalledPackageLIF</h3><p>关于 flags 的设置：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//【1】设置删除 flags，会保留用户数据！</span></span><br><span class="line"><span class="keyword">final</span> <span class="keyword">int</span> deleteFlags = PackageManager.DELETE_KEEP_DATA</span><br><span class="line">        | (killApp ? <span class="number">0</span> : PackageManager.DELETE_DONT_KILL_APP);</span><br></pre></td></tr></table></figure>
<p>删除 data 分区的 apk：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">boolean</span> <span class="title">deleteInstalledPackageLIF</span><span class="params">(PackageSetting ps,</span></span></span><br><span class="line"><span class="function"><span class="params">        <span class="keyword">boolean</span> deleteCodeAndResources, <span class="keyword">int</span> flags, <span class="keyword">int</span>[] allUserHandles,</span></span></span><br><span class="line"><span class="function"><span class="params">        PackageRemovedInfo outInfo, <span class="keyword">boolean</span> writeSettings,</span></span></span><br><span class="line"><span class="function"><span class="params">        PackageParser.Package replacingPackage)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">synchronized</span> (mPackages) &#123;</span><br><span class="line">        <span class="keyword">if</span> (outInfo != <span class="keyword">null</span>) &#123;</span><br><span class="line">            outInfo.uid = ps.appId;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (outInfo != <span class="keyword">null</span> &amp;&amp; outInfo.removedChildPackages != <span class="keyword">null</span>) &#123;</span><br><span class="line">            <span class="keyword">final</span> <span class="keyword">int</span> childCount = (ps.childPackageNames != <span class="keyword">null</span>)</span><br><span class="line">                    ? ps.childPackageNames.size() : <span class="number">0</span>;</span><br><span class="line">            <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; childCount; i++) &#123;</span><br><span class="line">                String childPackageName = ps.childPackageNames.get(i);</span><br><span class="line">                PackageSetting childPs = mSettings.mPackages.get(childPackageName);</span><br><span class="line">                <span class="keyword">if</span> (childPs == <span class="keyword">null</span>) &#123;</span><br><span class="line">                    <span class="keyword">return</span> <span class="keyword">false</span>;</span><br><span class="line">                &#125;</span><br><span class="line">                PackageRemovedInfo childInfo = outInfo.removedChildPackages.get(</span><br><span class="line">                        childPackageName);</span><br><span class="line">                <span class="keyword">if</span> (childInfo != <span class="keyword">null</span>) &#123;</span><br><span class="line">                    childInfo.uid = childPs.appId;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//【×8.1.4.1】移除 package 的数据！</span></span><br><span class="line">    removePackageDataLIF(ps, allUserHandles, outInfo, flags, writeSettings);</span><br><span class="line"></span><br><span class="line">    <span class="comment">//【1】如果有子包，也会移除子包的数据！</span></span><br><span class="line">    <span class="keyword">final</span> <span class="keyword">int</span> childCount = (ps.childPackageNames != <span class="keyword">null</span>) ? ps.childPackageNames.size() : <span class="number">0</span>;</span><br><span class="line">    <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; childCount; i++) &#123;</span><br><span class="line">        PackageSetting childPs;</span><br><span class="line">        <span class="keyword">synchronized</span> (mPackages) &#123;</span><br><span class="line">            childPs = mSettings.peekPackageLPr(ps.childPackageNames.get(i));</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">if</span> (childPs != <span class="keyword">null</span>) &#123;</span><br><span class="line">            PackageRemovedInfo childOutInfo = (outInfo != <span class="keyword">null</span></span><br><span class="line">                    &amp;&amp; outInfo.removedChildPackages != <span class="keyword">null</span>)</span><br><span class="line">                    ? outInfo.removedChildPackages.get(childPs.name) : <span class="keyword">null</span>;</span><br><span class="line">            <span class="keyword">final</span> <span class="keyword">int</span> deleteFlags = (flags &amp; DELETE_KEEP_DATA) != <span class="number">0</span></span><br><span class="line">                    &amp;&amp; (replacingPackage != <span class="keyword">null</span></span><br><span class="line">                    &amp;&amp; !replacingPackage.hasChildPackage(childPs.name))</span><br><span class="line">                    ? flags &amp; ~DELETE_KEEP_DATA : flags;</span><br><span class="line">                    </span><br><span class="line">            <span class="comment">//【×8.1.4.1】移除 package 的数据！</span></span><br><span class="line">            removePackageDataLIF(childPs, allUserHandles, childOutInfo,</span><br><span class="line">                    deleteFlags, writeSettings);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//【2】对于被删除的父包，会创建一个 InstallArgs，用于删除 apk 和资源！</span></span><br><span class="line">    <span class="keyword">if</span> (ps.parentPackageName == <span class="keyword">null</span>) &#123;</span><br><span class="line">        <span class="keyword">if</span> (deleteCodeAndResources &amp;&amp; (outInfo != <span class="keyword">null</span>)) &#123;</span><br><span class="line">        </span><br><span class="line">            <span class="comment">//【×6.2.1.3】根据一个存在的 package 创建一个 InstallArgs 中！</span></span><br><span class="line">            outInfo.args = createInstallArgsForExisting(packageFlagsToInstallFlags(ps),</span><br><span class="line">                    ps.codePathString, ps.resourcePathString, getAppDexInstructionSets(ps));</span><br><span class="line"></span><br><span class="line">            <span class="keyword">if</span> (DEBUG_SD_INSTALL) Slog.i(TAG, <span class="string">"args="</span> + outInfo.args);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">true</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>不多说了！</p>
<h4 id="8-1-4-1-removePackageDataLIF"><a href="#8-1-4-1-removePackageDataLIF" class="headerlink" title="8.1.4.1 removePackageDataLIF"></a>8.1.4.1 removePackageDataLIF</h4><p>删除 package 的数据！</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">removePackageDataLIF</span><span class="params">(PackageSetting ps, <span class="keyword">int</span>[] allUserHandles,</span></span></span><br><span class="line"><span class="function"><span class="params">        PackageRemovedInfo outInfo, <span class="keyword">int</span> flags, <span class="keyword">boolean</span> writeSettings)</span> </span>&#123;</span><br><span class="line">    String packageName = ps.name;</span><br><span class="line">    <span class="keyword">if</span> (DEBUG_REMOVE) Slog.d(TAG, <span class="string">"removePackageDataLI: "</span> + ps);</span><br><span class="line">    <span class="keyword">final</span> PackageParser.Package deletedPkg;</span><br><span class="line">    <span class="keyword">final</span> PackageSetting deletedPs;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">synchronized</span> (mPackages) &#123;</span><br><span class="line">        <span class="comment">//【1】获得要被删除的 apk 的 PackageSetting 和 PackageParser.Package 对象！</span></span><br><span class="line">        deletedPkg = mPackages.get(packageName);</span><br><span class="line">        deletedPs = mSettings.mPackages.get(packageName);</span><br><span class="line">        <span class="keyword">if</span> (outInfo != <span class="keyword">null</span>) &#123;</span><br><span class="line">            outInfo.removedPackage = packageName;</span><br><span class="line">            outInfo.removedUsers = deletedPs != <span class="keyword">null</span></span><br><span class="line">                    ? deletedPs.queryInstalledUsers(sUserManager.getUserIds(), <span class="keyword">true</span>)</span><br><span class="line">                    : <span class="keyword">null</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">//【×8.1.4.1】第一部移除，扫描和四大组件信息！</span></span><br><span class="line">    removePackageLI(ps, (flags &amp; REMOVE_CHATTY) != <span class="number">0</span>);</span><br><span class="line"></span><br><span class="line">    <span class="comment">//【2】如果 flags 没有设置 DELETE_KEEP_DATA，那么会清楚 apk 的数据，显然这里由于设置了，那么就不会清楚！</span></span><br><span class="line">    <span class="keyword">if</span> ((flags &amp; PackageManager.DELETE_KEEP_DATA) == <span class="number">0</span>) &#123;</span><br><span class="line">        <span class="keyword">final</span> PackageParser.Package resolvedPkg;</span><br><span class="line">        <span class="keyword">if</span> (deletedPkg != <span class="keyword">null</span>) &#123;</span><br><span class="line">            resolvedPkg = deletedPkg;</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            resolvedPkg = <span class="keyword">new</span> PackageParser.Package(ps.name);</span><br><span class="line">            resolvedPkg.setVolumeUuid(ps.volumeUuid);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment">//【×8.1.1.1】删除 apk 的 data 数据！！</span></span><br><span class="line">        destroyAppDataLIF(resolvedPkg, UserHandle.USER_ALL,</span><br><span class="line">                StorageManager.FLAG_STORAGE_DE | StorageManager.FLAG_STORAGE_CE);</span><br><span class="line">        <span class="comment">//【×8.1.1.2】删除 apk 的 profiles 数据！！</span></span><br><span class="line">        destroyAppProfilesLIF(resolvedPkg, UserHandle.USER_ALL);</span><br><span class="line">        </span><br><span class="line">        <span class="keyword">if</span> (outInfo != <span class="keyword">null</span>) &#123;</span><br><span class="line">            outInfo.dataRemoved = <span class="keyword">true</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        </span><br><span class="line">        <span class="comment">//【×8.1.1.3】执行 package 清除！！</span></span><br><span class="line">        schedulePackageCleaning(packageName, UserHandle.USER_ALL, <span class="keyword">true</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//【3】进一步处理！</span></span><br><span class="line">    <span class="keyword">synchronized</span> (mPackages) &#123;</span><br><span class="line">        <span class="keyword">if</span> (deletedPs != <span class="keyword">null</span>) &#123;</span><br><span class="line">            <span class="comment">//【3.1】如果 flags 没有设置 DELETE_KEEP_DATA 标志位，那么执行其他的清楚操作！</span></span><br><span class="line">            <span class="keyword">if</span> ((flags &amp; PackageManager.DELETE_KEEP_DATA) == <span class="number">0</span>) &#123;</span><br><span class="line">            </span><br><span class="line">                <span class="comment">//【3.1.1】清楚 intentfilter verify 和 默认浏览器的设置数据！</span></span><br><span class="line">                clearIntentFilterVerificationsLPw(deletedPs.name, UserHandle.USER_ALL);</span><br><span class="line">                clearDefaultBrowserIfNeeded(packageName);</span><br><span class="line">                </span><br><span class="line">                <span class="keyword">if</span> (outInfo != <span class="keyword">null</span>) &#123;</span><br><span class="line">                    mSettings.mKeySetManagerService.removeAppKeySetDataLPw(packageName);</span><br><span class="line">                    outInfo.removedAppId = mSettings.removePackageLPw(packageName);</span><br><span class="line">                &#125;</span><br><span class="line"></span><br><span class="line">                <span class="comment">//【3.1.2】更新权限信息！</span></span><br><span class="line">                updatePermissionsLPw(deletedPs.name, <span class="keyword">null</span>, <span class="number">0</span>);</span><br><span class="line">                </span><br><span class="line">                <span class="comment">//【3.1.3】如果该应用是共享 shared user 的，进入这里！</span></span><br><span class="line">                <span class="keyword">if</span> (deletedPs.sharedUser != <span class="keyword">null</span>) &#123;</span><br><span class="line">                    <span class="keyword">for</span> (<span class="keyword">int</span> userId : UserManagerService.getInstance().getUserIds()) &#123;</span><br><span class="line"></span><br><span class="line">                        <span class="comment">//【3.1.3.1】更新该共享 shared uid 的权限，该 package 被移除掉，会导致和该</span></span><br><span class="line">                        <span class="comment">// 应用相关连的权限的变化，从而导致共享 shared uid 的 gids 发生变化！</span></span><br><span class="line">                        <span class="keyword">final</span> <span class="keyword">int</span> userIdToKill = mSettings.updateSharedUserPermsLPw(deletedPs,</span><br><span class="line">                                userId);</span><br><span class="line">                        <span class="keyword">if</span> (userIdToKill == UserHandle.USER_ALL</span><br><span class="line">                                || userIdToKill &gt;= UserHandle.USER_SYSTEM) &#123;</span><br><span class="line">                            <span class="comment">//【3.1.3.1】如果共享 shared uid 的 gids 发生变化，杀掉该 uid 下的</span></span><br><span class="line">                            <span class="comment">// 所有的 app 进程！</span></span><br><span class="line">                            mHandler.post(<span class="keyword">new</span> Runnable() &#123;</span><br><span class="line">                                <span class="meta">@Override</span></span><br><span class="line">                                <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">run</span><span class="params">()</span> </span>&#123;</span><br><span class="line">                                    killApplication(deletedPs.name, deletedPs.appId,</span><br><span class="line">                                            KILL_APP_REASON_GIDS_CHANGED);</span><br><span class="line">                                &#125;</span><br><span class="line">                            &#125;);</span><br><span class="line">                            <span class="keyword">break</span>;</span><br><span class="line">                        &#125;</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;</span><br><span class="line">                <span class="comment">//【3.1.4】清除默认应用的数据；</span></span><br><span class="line">                clearPackagePreferredActivitiesLPw(deletedPs.name, UserHandle.USER_ALL);</span><br><span class="line">            &#125;</span><br><span class="line">            </span><br><span class="line">            <span class="comment">//【3.4】更新下在每个 user 下的安装状态！</span></span><br><span class="line">            <span class="keyword">if</span> (allUserHandles != <span class="keyword">null</span> &amp;&amp; outInfo != <span class="keyword">null</span> &amp;&amp; outInfo.origUsers != <span class="keyword">null</span>) &#123;</span><br><span class="line">                <span class="keyword">if</span> (DEBUG_REMOVE) &#123;</span><br><span class="line">                    Slog.d(TAG, <span class="string">"Propagating install state across downgrade"</span>);</span><br><span class="line">                &#125;</span><br><span class="line">                <span class="keyword">for</span> (<span class="keyword">int</span> userId : allUserHandles) &#123;</span><br><span class="line">                    <span class="keyword">final</span> <span class="keyword">boolean</span> installed = ArrayUtils.contains(outInfo.origUsers, userId);</span><br><span class="line">                    <span class="keyword">if</span> (DEBUG_REMOVE) &#123;</span><br><span class="line">                        Slog.d(TAG, <span class="string">"    user "</span> + userId + <span class="string">" =&gt; "</span> + installed);</span><br><span class="line">                    &#125;</span><br><span class="line">                    ps.setInstalled(installed, userId);</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">//【3.5】持久化 Settings！！</span></span><br><span class="line">        <span class="keyword">if</span> (writeSettings) &#123;</span><br><span class="line">            mSettings.writeLPr();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span> (outInfo != <span class="keyword">null</span>) &#123;</span><br><span class="line">        <span class="comment">//【4】移除 key-store！</span></span><br><span class="line">        removeKeystoreDataIfNeeded(UserHandle.USER_ALL, outInfo.removedAppId);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>不多说了！！</p>
<h5 id="8-1-4-1-1-removePackageLI"><a href="#8-1-4-1-1-removePackageLI" class="headerlink" title="8.1.4.1.1 removePackageLI"></a>8.1.4.1.1 removePackageLI</h5><p>移除 PackageSetting 对应的扫描数据：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">removePackageLI</span><span class="params">(PackageSetting ps, <span class="keyword">boolean</span> chatty)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">if</span> (DEBUG_INSTALL) &#123;</span><br><span class="line">        <span class="keyword">if</span> (chatty)</span><br><span class="line">            Log.d(TAG, <span class="string">"Removing package "</span> + ps.name);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">synchronized</span> (mPackages) &#123;</span><br><span class="line">        <span class="comment">//【1】移除扫描信息！</span></span><br><span class="line">        mPackages.remove(ps.name);</span><br><span class="line">        <span class="keyword">final</span> PackageParser.Package pkg = ps.pkg;</span><br><span class="line">        <span class="keyword">if</span> (pkg != <span class="keyword">null</span>) &#123;</span><br><span class="line">            <span class="comment">//【×6.2.1.6.1】移除四大组件，共享库解析对象！</span></span><br><span class="line">            cleanPackageDataStructuresLILPw(pkg, chatty);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>这个就不多说了！！</p>
</div></article><div class="post-copyright"><div class="post-copyright__author"><span class="post-copyright-meta">文章作者: </span><span class="post-copyright-info"><a href="mailto:undefined">Coolqi.Li</a></span></div><div class="post-copyright__type"><span class="post-copyright-meta">文章链接: </span><span class="post-copyright-info"><a href="https://coolqi.top/2018/05/03/PMS 第 7 篇 - 通过 adb 指令分析 Install 过程/">https://coolqi.top/2018/05/03/PMS 第 7 篇 - 通过 adb 指令分析 Install 过程/</a></span></div><div class="post-copyright__notice"><span class="post-copyright-meta">版权声明: </span><span class="post-copyright-info">本博客所有文章除特别声明外，均采用 <a href="https://creativecommons.org/licenses/by-nc-sa/4.0/">CC BY-NC-SA 4.0</a> 许可协议。转载请注明来自 <a href="https://coolqi.top">Coolqi`s Blog</a>！</span></div></div><div class="post-meta__tag-list"><a class="post-meta__tags" href="/tags/PackageManager包管理/">PackageManager包管理</a></div><div class="post-qr-code"><div class="post-qr-code-item"><img class="post-qr-code__img" src="/img/zfb.jpg"><div class="post-qr-code__desc">支付宝打赏</div></div><div class="post-qr-code-item"><img class="post-qr-code__img" src="/img/wechat.jpg"><div class="post-qr-code__desc">微信打赏</div></div></div><nav id="pagination"><div class="prev-post pull-left"><a href="/2018/07/23/PMS 第 8 篇 - 通过 PackageInstaller 分析 Install 过程/"><i class="fa fa-chevron-left">  </i><span>PMS 第 8 篇 - 通过 PackageInstaller 分析 Install 过程</span></a></div><div class="next-post pull-right"><a href="/2018/04/28/PMS 第 6 篇 - PMS_READY 阶段/"><span>PMS 第 6 篇 - PMS_READY 阶段</span><i class="fa fa-chevron-right"></i></a></div></nav><div class="post-adv"><a href="https://www.vultr.com/?ref=7231808"><img src="https://www.vultr.com/media/banner_1.png" width="728" height="90"></a></div><div id="gitalk-container"></div><script>var gitalk = new Gitalk({
  clientID: '2cd8921819db714376b8',
  clientSecret: '94b82090448833d5295bc0d210f9f0719b2f124d',
  repo: 'single-li.github.io',
  owner: 'single-li',
  admin: 'single-li',
  id: decodeURI(location.pathname),
  language: 'zh-CN'
})
gitalk.render('gitalk-container')</script></div></div><footer><div class="layout" id="footer"><div class="copyright">&copy;2015 - 2019 By Coolqi.Li</div><div class="framework-info"><span>驱动 - </span><a href="http://hexo.io"><span>Hexo</span></a><span class="footer-separator">|</span><span>主题 - </span><a href="https://github.com/Molunerfinn/hexo-theme-melody"><span>Melody</span></a></div><div class="footer_custom_text">Hi, welcome to my <a href="https://coolqi.top/">blog</a>!</div><div class="busuanzi"><script async src="https://busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script><span id="busuanzi_container_page_pv"><i class="fa fa-file-o"></i><span id="busuanzi_value_page_pv"></span><span></span></span></div></div></footer><i class="fa fa-arrow-up" id="go-up" aria-hidden="true"></i><script src="/js/third-party/anime.min.js"></script><script src="/js/third-party/jquery.min.js"></script><script src="/js/third-party/jquery.fancybox.min.js"></script><script src="/js/third-party/velocity.min.js"></script><script src="/js/third-party/velocity.ui.min.js"></script><script src="/js/utils.js?version=1.5.6"></script><script src="/js/fancybox.js?version=1.5.6"></script><script src="/js/sidebar.js?version=1.5.6"></script><script src="/js/copy.js?version=1.5.6"></script><script src="/js/fireworks.js?version=1.5.6"></script><script src="/js/transition.js?version=1.5.6"></script><script src="/js/scroll.js?version=1.5.6"></script><script src="/js/head.js?version=1.5.6"></script><script type="text/x-mathjax-config">MathJax.Hub.Config({
  tex2jax: {
    inlineMath: [ ['$','$'], ["\\(","\\)"]  ],
    processEscapes: true,
    skipTags: ['script', 'noscript', 'style', 'textarea', 'pre', 'code']
  },
  CommonHTML: {
    linebreaks: { automatic: true, width: "90% container" }
  },
  "HTML-CSS": { 
    linebreaks: { automatic: true, width: "90% container" }
  },
  "SVG": { 
    linebreaks: { automatic: true, width: "90% container" }
  }
});
</script><script type="text/x-mathjax-config">MathJax.Hub.Queue(function() {
  var all = MathJax.Hub.getAllJax(), i;
  for (i=0; i < all.length; i += 1) {
    all[i].SourceElement().parentNode.className += ' has-jax';
  }
});
</script><script src="https://cdn.jsdelivr.net/npm/mathjax/MathJax.js?config=TeX-AMS-MML_HTMLorMML"></script><script src="/js/search/local-search.js"></script><div class="search-dialog" id="local-search"><div class="search-dialog__title" id="local-search-title">本地搜索</div><div id="local-input-panel"><div id="local-search-input"><div class="local-search-box"><input class="local-search-box--input" placeholder="搜索文章"></div></div></div><hr><div id="local-search-results"><div id="local-hits"></div><div id="local-stats"><div class="local-search-stats__hr" id="hr"><span>由</span> <a href="https://github.com/wzpan/hexo-generator-search" style="color:#49B1F5;">hexo-generator-search</a>
 <span>提供支持</span></div></div></div><span class="search-close-button"><i class="fa fa-times"></i></span></div><div class="search-mask"></div><script src="/live2dw/lib/L2Dwidget.min.js?0c58a1486de42ac6cc1c59c7d98ae887"></script><script>L2Dwidget.init({"pluginRootPath":"live2dw/","pluginJsPath":"lib/","pluginModelPath":"assets/","tagMode":false,"debug":false,"model":{"jsonPath":"live2d-widget-model-hijiki"},"display":{"position":"right","width":110,"height":220},"mobile":{"show":false},"log":false});</script></body></html>
<!DOCTYPE html><html lang="zh-Hans"><head><meta charset="UTF-8"><meta http-equiv="X-UA-Compatible" content="IE=edge"><meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1"><meta name="description" content="“你好，我是李帅奇，Android 系统工程师，MineCraft 忠实玩家，设计和绘画爱好者，缺妹纸晚期患者，熬夜星人。”"><meta name="keywords" content=""><meta name="author" content="Coolqi.Li,undefined"><meta name="copyright" content="Coolqi.Li"><title>Every day is always sleepy. | Coolqi`s Blog</title><link rel="shortcut icon" href="/my-favicon.ico"><link rel="stylesheet" href="/css/index.css?version=1.5.6"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/font-awesome@latest/css/font-awesome.min.css?version=1.5.6"><link rel="dns-prefetch" href="https://cdn.staticfile.org"><link rel="dns-prefetch" href="https://cdn.bootcss.com"><link rel="dns-prefetch" href="https://creativecommons.org"><script>var GLOBAL_CONFIG = { 
  root: '/',
  algolia: undefined,
  localSearch: undefined,
  copy: {
    success: '复制成功',
    error: '复制错误',
    noSupport: '浏览器不支持'
  }
} </script></head><body><i class="fa fa-arrow-right" id="toggle-sidebar" aria-hidden="true"></i><div id="sidebar"><div class="author-info"><div class="author-info__avatar text-center"><img src="/img/avatar.png"></div><div class="author-info__name text-center">Coolqi.Li</div><div class="author-info__description text-center">“你好，我是李帅奇，Android 系统工程师，MineCraft 忠实玩家，设计和绘画爱好者，缺妹纸晚期患者，熬夜星人。”</div><hr><div class="author-info-articles"><a class="author-info-articles__archives article-meta" href="/archives"><span class="pull-left">文章</span><span class="pull-right">64</span></a><a class="author-info-articles__tags article-meta" href="/tags"><span class="pull-left">标签</span><span class="pull-right">14</span></a><a class="author-info-articles__categories article-meta" href="/categories"><span class="pull-left">分类</span><span class="pull-right">15</span></a></div></div></div><nav class="no-bg" id="nav"><div id="page-header"><span class="pull-left"> <a id="site-name" href="/">Coolqi`s Blog</a></span><i class="fa fa-bars toggle-menu pull-right" aria-hidden="true"></i><span class="pull-right menus"><a class="site-page" href="/">Home</a><a class="site-page" href="/archives">Archives</a><a class="site-page" href="/tags">Tags</a><a class="site-page" href="/categories">Categories</a></span></div><div id="site-info"><div id="site-title">Coolqi`s Blog</div><div id="site-sub-title">Every day is always sleepy.</div></div></nav><div id="sidebar"><div class="author-info"><div class="author-info__avatar text-center"><img src="/img/avatar.png"></div><div class="author-info__name text-center">Coolqi.Li</div><div class="author-info__description text-center">“你好，我是李帅奇，Android 系统工程师，MineCraft 忠实玩家，设计和绘画爱好者，缺妹纸晚期患者，熬夜星人。”</div><hr><div class="author-info-articles"><a class="author-info-articles__archives article-meta" href="/archives"><span class="pull-left">文章</span><span class="pull-right">64</span></a><a class="author-info-articles__tags article-meta" href="/tags"><span class="pull-left">标签</span><span class="pull-right">14</span></a><a class="author-info-articles__categories article-meta" href="/categories"><span class="pull-left">分类</span><span class="pull-right">15</span></a></div></div></div><div id="content-outer"><div class="layout" id="content-inner"><div class="recent-post-item article-container"><a class="article-title" href="/2018/02/17/PMS 第 4 篇 - PMS_DATA_SCAN_START 阶段/">PMS 第 4 篇 - PMS_DATA_SCAN_START 阶段</a><time class="post-meta__date"><i class="fa fa-calendar" aria-hidden="true"></i> 2018-02-17</time><span class="article-meta"><span class="article-meta__separator">|</span><i class="fa fa-inbox article-meta__icon" aria-hidden="true"></i><a class="article-meta__categories" href="/categories/AndroidFramework源码分析/">AndroidFramework源码分析</a><i class="fa fa-angle-right" aria-hidden="true"></i><i class="fa fa-inbox article-meta__icon" aria-hidden="true"></i><a class="article-meta__categories" href="/categories/AndroidFramework源码分析/PackageManager包管理/">PackageManager包管理</a></span><span class="article-meta tags"><span class="article-meta__separator">|</span><i class="fa fa-tag article-meta__icon" aria-hidden="true"></i><a class="article-meta__tags" href="/tags/PackageManager包管理/">PackageManager包管理</a></span><div class="content"><p>[toc]</p>
<p>基于 Android 7.1.1 源码分析 PackageManagerService 的架构和逻辑实现，本文是作者原创，转载请说明出处！</p>
<h1 id="0-综述"><a href="#0-综述" class="headerlink" title="0 综述"></a>0 综述</h1><p>通过扫描 system 分区阶段，我们得到如下的几个集合：</p>
<ul>
<li><strong>mExpectingBetter</strong>：用来存放那些在 data 分区有更高版本的系统 app！</li>
<li><strong>possiblyDeletedUpdatedSystemApps</strong>：用来存储那些不存在的被更新过的系统 app！</li>
</ul>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// Set flag to monitor and not change apk file paths when</span></span><br><span class="line"><span class="comment">// scanning install directories.</span></span><br><span class="line"><span class="keyword">final</span> <span class="keyword">int</span> scanFlags = SCAN_NO_PATHS | SCAN_DEFER_DEX | SCAN_BOOTING | SCAN_INITIAL;</span><br><span class="line"></span><br><span class="line">... ... ... ...<span class="comment">// 第三阶段</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> (!mOnlyCore) &#123;</span><br><span class="line">    EventLog.writeEvent(EventLogTags.BOOT_PROGRESS_PMS_DATA_SCAN_START,</span><br><span class="line">            SystemClock.uptimeMillis());</span><br><span class="line">            </span><br><span class="line">    <span class="comment">// 同理，扫描 /data/app 目录和 /data/app-private 目录！</span></span><br><span class="line">    scanDirTracedLI(mAppInstallDir, <span class="number">0</span>, scanFlags | SCAN_REQUIRE_KNOWN, <span class="number">0</span>);</span><br><span class="line"></span><br><span class="line">    scanDirTracedLI(mDrmAppPrivateInstallDir, mDefParseFlags</span><br><span class="line">            | PackageParser.PARSE_FORWARD_LOCK,</span><br><span class="line">            scanFlags | SCAN_REQUIRE_KNOWN, <span class="number">0</span>);</span><br><span class="line"></span><br><span class="line">    scanDirLI(mEphemeralInstallDir, mDefParseFlags</span><br><span class="line">            | PackageParser.PARSE_IS_EPHEMERAL,</span><br><span class="line">            scanFlags | SCAN_REQUIRE_KNOWN, <span class="number">0</span>);</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 处理那些不存在的系统 app！</span></span><br><span class="line">    <span class="keyword">for</span> (String deletedAppName : possiblyDeletedUpdatedSystemApps) &#123;</span><br><span class="line">        PackageParser.Package deletedPkg = mPackages.get(deletedAppName);</span><br><span class="line">        mSettings.removeDisabledSystemPackageLPw(deletedAppName);</span><br><span class="line"></span><br><span class="line">        String msg;</span><br><span class="line">        <span class="keyword">if</span> (deletedPkg == <span class="keyword">null</span>) &#123;</span><br><span class="line">            msg = <span class="string">"Updated system package "</span> + deletedAppName</span><br><span class="line">                    + <span class="string">" no longer exists; it's data will be wiped"</span>;</span><br><span class="line">            <span class="comment">// Actual deletion of code and data will be handled by later</span></span><br><span class="line">            <span class="comment">// reconciliation step</span></span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            msg = <span class="string">"Updated system app + "</span> + deletedAppName</span><br><span class="line">                    + <span class="string">" no longer present; removing system privileges for "</span></span><br><span class="line">                    + deletedAppName;</span><br><span class="line"></span><br><span class="line">            deletedPkg.applicationInfo.flags &amp;= ~ApplicationInfo.FLAG_SYSTEM;</span><br><span class="line"></span><br><span class="line">            PackageSetting deletedPs = mSettings.mPackages.get(deletedAppName);</span><br><span class="line">            deletedPs.pkgFlags &amp;= ~ApplicationInfo.FLAG_SYSTEM;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        logCriticalInfo(Log.WARN, msg);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 确保所有在用户 data 分区的应用都显示出来了，如果 data 分区的无法显示，就显示 system 分区的！</span></span><br><span class="line">    <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; mExpectingBetter.size(); i++) &#123;</span><br><span class="line">        <span class="keyword">final</span> String packageName = mExpectingBetter.keyAt(i);</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 如果 PMS 仍然没有扫描到 mExpectingBetter 列表中的 apk，说明 data 分区的 apk 无法显示</span></span><br><span class="line">        <span class="comment">// 那就要显示原来 system 分区的 apk！</span></span><br><span class="line">        <span class="keyword">if</span> (!mPackages.containsKey(packageName)) &#123;</span><br><span class="line">            <span class="keyword">final</span> File scanFile = mExpectingBetter.valueAt(i);</span><br><span class="line"></span><br><span class="line">            logCriticalInfo(Log.WARN, <span class="string">"Expected better "</span> + packageName</span><br><span class="line">                    + <span class="string">" but never showed up; reverting to system"</span>);</span><br><span class="line"></span><br><span class="line">            <span class="comment">// 根据目录，初始化解析标志！</span></span><br><span class="line">            <span class="keyword">int</span> reparseFlags = mDefParseFlags;</span><br><span class="line">            <span class="keyword">if</span> (FileUtils.contains(privilegedAppDir, scanFile)) &#123;</span><br><span class="line">                reparseFlags = PackageParser.PARSE_IS_SYSTEM</span><br><span class="line">                        | PackageParser.PARSE_IS_SYSTEM_DIR</span><br><span class="line">                        | PackageParser.PARSE_IS_PRIVILEGED;</span><br><span class="line">                        </span><br><span class="line">            &#125; <span class="keyword">else</span> <span class="keyword">if</span> (FileUtils.contains(systemAppDir, scanFile)) &#123;</span><br><span class="line">                reparseFlags = PackageParser.PARSE_IS_SYSTEM</span><br><span class="line">                        | PackageParser.PARSE_IS_SYSTEM_DIR;</span><br><span class="line">                        </span><br><span class="line">            &#125; <span class="keyword">else</span> <span class="keyword">if</span> (FileUtils.contains(vendorAppDir, scanFile)) &#123;</span><br><span class="line">                reparseFlags = PackageParser.PARSE_IS_SYSTEM</span><br><span class="line">                        | PackageParser.PARSE_IS_SYSTEM_DIR;</span><br><span class="line">                        </span><br><span class="line">            &#125; <span class="keyword">else</span> <span class="keyword">if</span> (FileUtils.contains(oemAppDir, scanFile)) &#123;</span><br><span class="line">                reparseFlags = PackageParser.PARSE_IS_SYSTEM</span><br><span class="line">                        | PackageParser.PARSE_IS_SYSTEM_DIR;</span><br><span class="line">                        </span><br><span class="line">            &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                Slog.e(TAG, <span class="string">"Ignoring unexpected fallback path "</span> + scanFile);</span><br><span class="line">                <span class="keyword">continue</span>;</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            <span class="comment">// 使得 system 的 apk 可用；</span></span><br><span class="line">            mSettings.enableSystemPackageLPw(packageName);</span><br><span class="line"></span><br><span class="line">            <span class="keyword">try</span> &#123;</span><br><span class="line">            </span><br><span class="line">                <span class="comment">// 重新扫描 system 的 apk！</span></span><br><span class="line">                scanPackageTracedLI(scanFile, reparseFlags, scanFlags, <span class="number">0</span>, <span class="keyword">null</span>);</span><br><span class="line">            &#125; <span class="keyword">catch</span> (PackageManagerException e) &#123;</span><br><span class="line">                Slog.e(TAG, <span class="string">"Failed to parse original system package: "</span></span><br><span class="line">                        + e.getMessage());</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line">mExpectingBetter.clear();</span><br><span class="line"></span><br><span class="line"><span class="comment">// Resolve the storage manager.</span></span><br><span class="line">mStorageManagerPackage = getStorageManagerPackageName();</span><br><span class="line"></span><br><span class="line"><span class="comment">// Resolve protected action filters. Only the setup wizard is allowed to</span></span><br><span class="line"><span class="comment">// have a high priority filter for these actions.</span></span><br><span class="line">mSetupWizardPackage = getSetupWizardPackageName();</span><br><span class="line"><span class="keyword">if</span> (mProtectedFilters.size() &gt; <span class="number">0</span>) &#123;</span><br><span class="line">    <span class="keyword">if</span> (DEBUG_FILTERS &amp;&amp; mSetupWizardPackage == <span class="keyword">null</span>) &#123;</span><br><span class="line">        Slog.i(TAG, <span class="string">"No setup wizard;"</span></span><br><span class="line">            + <span class="string">" All protected intents capped to priority 0"</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">for</span> (ActivityIntentInfo filter : mProtectedFilters) &#123;</span><br><span class="line">        <span class="keyword">if</span> (filter.activity.info.packageName.equals(mSetupWizardPackage)) &#123;</span><br><span class="line">            <span class="keyword">if</span> (DEBUG_FILTERS) &#123;</span><br><span class="line">                Slog.i(TAG, <span class="string">"Found setup wizard;"</span></span><br><span class="line">                    + <span class="string">" allow priority "</span> + filter.getPriority() + <span class="string">";"</span></span><br><span class="line">                    + <span class="string">" package: "</span> + filter.activity.info.packageName</span><br><span class="line">                    + <span class="string">" activity: "</span> + filter.activity.className</span><br><span class="line">                    + <span class="string">" priority: "</span> + filter.getPriority());</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="comment">// skip setup wizard; allow it to keep the high priority filter</span></span><br><span class="line">            <span class="keyword">continue</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        Slog.w(TAG, <span class="string">"Protected action; cap priority to 0;"</span></span><br><span class="line">                + <span class="string">" package: "</span> + filter.activity.info.packageName</span><br><span class="line">                + <span class="string">" activity: "</span> + filter.activity.className</span><br><span class="line">                + <span class="string">" origPrio: "</span> + filter.getPriority());</span><br><span class="line">        filter.setPriority(<span class="number">0</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line">mDeferProtectedFilters = <span class="keyword">false</span>;</span><br><span class="line">mProtectedFilters.clear();</span><br><span class="line"></span><br><span class="line"><span class="comment">// 我们需要更新所有的应用，保证他们有正确的共享库路径。</span></span><br><span class="line">updateAllSharedLibrariesLPw();</span><br><span class="line"></span><br><span class="line"><span class="keyword">for</span> (SharedUserSetting setting : mSettings.getAllSharedUsersLPw()) &#123;</span><br><span class="line">    adjustCpuAbisForSharedUserLPw(setting.packages, <span class="keyword">null</span> <span class="comment">/* scanned package */</span>,</span><br><span class="line">            <span class="keyword">false</span> <span class="comment">/* boot complete */</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 更新所有 package 的最新使用时间！</span></span><br><span class="line">mPackageUsage.read(mPackages);</span><br><span class="line">mCompilerStats.read();</span><br><span class="line"></span><br><span class="line">... ... ... ...<span class="comment">// 见，第四阶段</span></span><br></pre></td></tr></table></figure>
<h1 id="1-扫描-data-分区"><a href="#1-扫描-data-分区" class="headerlink" title="1 扫描 data 分区"></a>1 扫描 data 分区</h1><p>data 分区比较特殊，data 分区的 apk 有两种：</p>
<ul>
<li>一种是非系统 apk；</li>
<li>另外一种是系统 apk 通过覆盖安装的方式，安装到了 data 分区；</li>
</ul>
<p>下面我们来看看 data 分区的扫描过程！<br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">final</span> <span class="keyword">int</span> scanFlags = SCAN_NO_PATHS | SCAN_DEFER_DEX | SCAN_BOOTING | SCAN_INITIAL;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 同理，扫描 /data/app 目录和 /data/app-private 目录！</span></span><br><span class="line">    scanDirTracedLI(mAppInstallDir, <span class="number">0</span>, scanFlags | SCAN_REQUIRE_KNOWN, <span class="number">0</span>);</span><br><span class="line"></span><br><span class="line">    scanDirTracedLI(mDrmAppPrivateInstallDir, mDefParseFlags</span><br><span class="line">            | PackageParser.PARSE_FORWARD_LOCK,</span><br><span class="line">            scanFlags | SCAN_REQUIRE_KNOWN, <span class="number">0</span>);</span><br><span class="line"></span><br><span class="line">    scanDirLI(mEphemeralInstallDir, mDefParseFlags</span><br><span class="line">            | PackageParser.PARSE_IS_EPHEMERAL,</span><br><span class="line">            scanFlags | SCAN_REQUIRE_KNOWN, <span class="number">0</span>);</span><br></pre></td></tr></table></figure></p>
<p>扫描的目录如下：</p>
<ul>
<li>/data/app；<ul>
<li><strong>parseFlags</strong>：0</li>
<li><strong>scanFlags</strong>：scanFlags | SCAN_REQUIRE_KNOWN</li>
</ul>
</li>
<li>/data/app-private；<ul>
<li><strong>parseFlags</strong>：PackageParser.PARSE_FORWARD_LOCK</li>
<li><strong>scanFlags</strong>：scanFlags | SCAN_REQUIRE_KNOWN</li>
</ul>
</li>
<li>/data/app-ephemeral；<ul>
<li><strong>parseFlags</strong>：PackageParser.PARSE_IS_EPHEMERAL</li>
<li><strong>scanFlags</strong>：scanFlags | SCAN_REQUIRE_KNOWN</li>
</ul>
</li>
</ul>
<p>这里的步骤和扫描 system 分区是一样的，但是因为 flag 不同，所以会涉及不同的逻辑，这里我们分析一下重点方法，根据之前的扫描顺序，最后会调用一下方法：scanPackageInternalLI 方法！</p>
<h2 id="1-1-PMS-scanPackageInternalLI"><a href="#1-1-PMS-scanPackageInternalLI" class="headerlink" title="1.1 PMS.scanPackageInternalLI"></a>1.1 PMS.scanPackageInternalLI</h2><p>我们继续来看，通过前面的扫描解析，我们获得了应用程序的 PackageParser.Package 对象，接下来，就是要处理解析获得的数据，policyFlags 的值就是最开始传入的 parseFlags！<br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">private</span> PackageParser.<span class="function">Package <span class="title">scanPackageInternalLI</span><span class="params">(PackageParser.Package pkg, File scanFile,</span></span></span><br><span class="line"><span class="function"><span class="params">        <span class="keyword">int</span> policyFlags, <span class="keyword">int</span> scanFlags, <span class="keyword">long</span> currentTime, UserHandle user)</span></span></span><br><span class="line"><span class="function">        <span class="keyword">throws</span> PackageManagerException </span>&#123;</span><br><span class="line"></span><br><span class="line">    PackageSetting ps = <span class="keyword">null</span>;</span><br><span class="line">    PackageSetting updatedPkg;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">synchronized</span> (mPackages) &#123;</span><br><span class="line">        <span class="comment">// 对于系统 apk 来说，才有源包！！</span></span><br><span class="line">        String oldName = mSettings.mRenamedPackages.get(pkg.packageName);</span><br><span class="line">        <span class="keyword">if</span> (pkg.mOriginalPackages != <span class="keyword">null</span> &amp;&amp; pkg.mOriginalPackages.contains(oldName)) &#123;</span><br><span class="line">            ps = mSettings.peekPackageLPr(oldName);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 尝试获得 PackageSetting 对象！</span></span><br><span class="line">        <span class="keyword">if</span> (ps == <span class="keyword">null</span>) &#123;</span><br><span class="line">            ps = mSettings.peekPackageLPr(pkg.packageName);</span><br><span class="line">        &#125;</span><br><span class="line">    </span><br><span class="line">        <span class="comment">// 对于非系统的 apk，updatedPkg 是为 null 的！</span></span><br><span class="line">        <span class="comment">// 但对于覆盖安装的系统 apk 来说，updatedPkg 不为 null 的！</span></span><br><span class="line">        updatedPkg = mSettings.getDisabledSystemPkgLPr(ps != <span class="keyword">null</span> ? ps.name : pkg.packageName);</span><br><span class="line">        <span class="keyword">if</span> (DEBUG_INSTALL &amp;&amp; updatedPkg != <span class="keyword">null</span>) Slog.d(TAG, <span class="string">"updatedPkg = "</span> + updatedPkg);</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 因为扫描的是 data 分区，不进入这个分支！</span></span><br><span class="line">        <span class="keyword">if</span> ((policyFlags &amp; PackageParser.PARSE_IS_SYSTEM) != <span class="number">0</span>) &#123; </span><br><span class="line">            ... ... ... ...</span><br><span class="line"></span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 目前，不进入这个分支！</span></span><br><span class="line">    <span class="keyword">boolean</span> updatedPkgBetter = <span class="keyword">false</span>;</span><br><span class="line">    <span class="keyword">if</span> (updatedPkg != <span class="keyword">null</span> &amp;&amp; (policyFlags &amp; PackageParser.PARSE_IS_SYSTEM) != <span class="number">0</span>) &#123;</span><br><span class="line">        ... ... ... ...</span><br><span class="line">    </span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 非系统 apk，不进入这个分支！</span></span><br><span class="line">    <span class="comment">// 但是对于覆盖安装的系统 apk，updatedPkg 不为 null，所以要添加指定的扫描位，表示当前解析的是一个系统 apk！</span></span><br><span class="line">    <span class="keyword">if</span> (updatedPkg != <span class="keyword">null</span>) &#123; </span><br><span class="line">        policyFlags |= PackageParser.PARSE_IS_SYSTEM;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> ((updatedPkg.pkgPrivateFlags &amp; ApplicationInfo.PRIVATE_FLAG_PRIVILEGED) != <span class="number">0</span>) &#123;</span><br><span class="line">            policyFlags |= PackageParser.PARSE_IS_PRIVILEGED;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    collectCertificatesLI(ps, pkg, scanFile, policyFlags);</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 同样的， policyFlags 并没有置 PackageParser.PARSE_IS_SYSTEM_DIR 位为 1，所以不进入改分支！</span></span><br><span class="line">    <span class="keyword">boolean</span> shouldHideSystemApp = <span class="keyword">false</span>;</span><br><span class="line">    <span class="keyword">if</span> (updatedPkg == <span class="keyword">null</span> &amp;&amp; ps != <span class="keyword">null</span></span><br><span class="line">            &amp;&amp; (policyFlags &amp; PackageParser.PARSE_IS_SYSTEM_DIR) != <span class="number">0</span> &amp;&amp; !isSystemApp(ps)) &#123;</span><br><span class="line">       </span><br><span class="line">       ... ... ... ...</span><br><span class="line">       </span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 对于非系统的 apk，可能存在 apk 路径和 data 路径不一样的情况！</span></span><br><span class="line">    <span class="keyword">if</span> ((policyFlags &amp; PackageParser.PARSE_IS_SYSTEM_DIR) == <span class="number">0</span>) &#123;</span><br><span class="line">        <span class="keyword">if</span> (ps != <span class="keyword">null</span> &amp;&amp; !ps.codePath.equals(ps.resourcePath)) &#123;</span><br><span class="line">        </span><br><span class="line">            <span class="comment">// 如果不一样，就加上 PackageParser.PARSE_FORWARD_LOCK 位！</span></span><br><span class="line">            policyFlags |= PackageParser.PARSE_FORWARD_LOCK;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    </span><br><span class="line">    <span class="comment">// 下面是处理 data apk 的 apk 路径和资源路径！</span></span><br><span class="line">    String resourcePath = <span class="keyword">null</span>;</span><br><span class="line">    String baseResourcePath = <span class="keyword">null</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> ((policyFlags &amp; PackageParser.PARSE_FORWARD_LOCK) != <span class="number">0</span> &amp;&amp; !updatedPkgBetter) &#123;</span><br><span class="line">        <span class="keyword">if</span> (ps != <span class="keyword">null</span> &amp;&amp; ps.resourcePathString != <span class="keyword">null</span>) &#123;</span><br><span class="line">            resourcePath = ps.resourcePathString;</span><br><span class="line">            baseResourcePath = ps.resourcePathString;</span><br><span class="line"></span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            <span class="comment">// Should not happen at all. Just log an error.</span></span><br><span class="line">            Slog.e(TAG, <span class="string">"Resource path not set for package "</span> + pkg.packageName);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        resourcePath = pkg.codePath;</span><br><span class="line">        baseResourcePath = pkg.baseCodePath;</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 设置 ApplicationInfo 对象的属性！</span></span><br><span class="line">    pkg.setApplicationVolumeUuid(pkg.volumeUuid);</span><br><span class="line">    pkg.setApplicationInfoCodePath(pkg.codePath);</span><br><span class="line">    pkg.setApplicationInfoBaseCodePath(pkg.baseCodePath);</span><br><span class="line">    pkg.setApplicationInfoSplitCodePaths(pkg.splitCodePaths);</span><br><span class="line">    pkg.setApplicationInfoResourcePath(resourcePath);</span><br><span class="line">    pkg.setApplicationInfoBaseResourcePath(baseResourcePath);</span><br><span class="line">    pkg.setApplicationInfoSplitResourcePaths(pkg.splitCodePaths);</span><br><span class="line"></span><br><span class="line">    <span class="comment">//【1.2】接着调用 scanPackageLI，继续处理扫描数据！</span></span><br><span class="line">    PackageParser.Package scannedPkg = scanPackageLI(pkg, policyFlags, scanFlags</span><br><span class="line">            | SCAN_UPDATE_SIGNATURE, currentTime, user);</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 对于非系统的 app，shouldHideSystemApp 为 false，不走这个分支！</span></span><br><span class="line">    <span class="keyword">if</span> (shouldHideSystemApp) &#123;</span><br><span class="line">        <span class="keyword">synchronized</span> (mPackages) &#123;</span><br><span class="line">            mSettings.disableSystemPackageLPw(pkg.packageName, <span class="keyword">true</span>);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> scannedPkg;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>对于非系统 apk，有两种情况：</p>
<ul>
<li>apk 之前已经安装到了 data 分区，所以肯定有对应的 PackageSetting 对象；</li>
<li>apk 之前并没有安装，这次通过 OTA 升级的方式，通过 data 分区内置 app 的方式安装 apk；</li>
</ul>
<p>下面，我们继续来分析：</p>
<h2 id="1-2-PMS-scanPackageLI"><a href="#1-2-PMS-scanPackageLI" class="headerlink" title="1.2 PMS.scanPackageLI"></a>1.2 PMS.scanPackageLI</h2><p>继续来看：<br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">private</span> PackageParser.<span class="function">Package <span class="title">scanPackageLI</span><span class="params">(PackageParser.Package pkg, <span class="keyword">final</span> <span class="keyword">int</span> policyFlags,</span></span></span><br><span class="line"><span class="function"><span class="params">        <span class="keyword">int</span> scanFlags, <span class="keyword">long</span> currentTime, UserHandle user)</span> <span class="keyword">throws</span> PackageManagerException </span>&#123;</span><br><span class="line">    <span class="keyword">boolean</span> success = <span class="keyword">false</span>;</span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">        <span class="comment">//【1.3】继续调用 scanPackageDirtyLI 处理扫描数据！</span></span><br><span class="line">        <span class="keyword">final</span> PackageParser.Package res = scanPackageDirtyLI(pkg, policyFlags, scanFlags,</span><br><span class="line">                currentTime, user);</span><br><span class="line">                </span><br><span class="line">        success = <span class="keyword">true</span>;</span><br><span class="line">        <span class="keyword">return</span> res;</span><br><span class="line">    &#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">        <span class="keyword">if</span> (!success &amp;&amp; (scanFlags &amp; SCAN_DELETE_DATA_ON_FAILURES) != <span class="number">0</span>) &#123;</span><br><span class="line">        </span><br><span class="line">            <span class="comment">// DELETE_DATA_ON_FAILURES is only used by frozen paths</span></span><br><span class="line">            <span class="comment">// 失败了就清楚掉数据！</span></span><br><span class="line">            destroyAppDataLIF(pkg, UserHandle.USER_ALL,</span><br><span class="line">                    StorageManager.FLAG_STORAGE_DE | StorageManager.FLAG_STORAGE_CE);</span><br><span class="line">            destroyAppProfilesLIF(pkg, UserHandle.USER_ALL);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>继续看：</p>
<h2 id="1-3-PMS-scanPackageDirtyLI"><a href="#1-3-PMS-scanPackageDirtyLI" class="headerlink" title="1.3 PMS.scanPackageDirtyLI"></a>1.3 PMS.scanPackageDirtyLI</h2><p>最终，同样调用 scanPackageDirtyLI 方法处理扫描得到的数据，传入参数：</p>
<ul>
<li><strong>PackageParser.Package pkg</strong>：非系统目录下解析的 apk 数据；</li>
</ul>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br><span class="line">212</span><br><span class="line">213</span><br><span class="line">214</span><br><span class="line">215</span><br><span class="line">216</span><br><span class="line">217</span><br><span class="line">218</span><br><span class="line">219</span><br><span class="line">220</span><br><span class="line">221</span><br><span class="line">222</span><br><span class="line">223</span><br><span class="line">224</span><br><span class="line">225</span><br><span class="line">226</span><br><span class="line">227</span><br><span class="line">228</span><br><span class="line">229</span><br><span class="line">230</span><br><span class="line">231</span><br><span class="line">232</span><br><span class="line">233</span><br><span class="line">234</span><br><span class="line">235</span><br><span class="line">236</span><br><span class="line">237</span><br><span class="line">238</span><br><span class="line">239</span><br><span class="line">240</span><br><span class="line">241</span><br><span class="line">242</span><br><span class="line">243</span><br><span class="line">244</span><br><span class="line">245</span><br><span class="line">246</span><br><span class="line">247</span><br><span class="line">248</span><br><span class="line">249</span><br><span class="line">250</span><br><span class="line">251</span><br><span class="line">252</span><br><span class="line">253</span><br><span class="line">254</span><br><span class="line">255</span><br><span class="line">256</span><br><span class="line">257</span><br><span class="line">258</span><br><span class="line">259</span><br><span class="line">260</span><br><span class="line">261</span><br><span class="line">262</span><br><span class="line">263</span><br><span class="line">264</span><br><span class="line">265</span><br><span class="line">266</span><br><span class="line">267</span><br><span class="line">268</span><br><span class="line">269</span><br><span class="line">270</span><br><span class="line">271</span><br><span class="line">272</span><br><span class="line">273</span><br><span class="line">274</span><br><span class="line">275</span><br><span class="line">276</span><br><span class="line">277</span><br><span class="line">278</span><br><span class="line">279</span><br><span class="line">280</span><br><span class="line">281</span><br><span class="line">282</span><br><span class="line">283</span><br><span class="line">284</span><br><span class="line">285</span><br><span class="line">286</span><br><span class="line">287</span><br><span class="line">288</span><br><span class="line">289</span><br><span class="line">290</span><br><span class="line">291</span><br><span class="line">292</span><br><span class="line">293</span><br><span class="line">294</span><br><span class="line">295</span><br><span class="line">296</span><br><span class="line">297</span><br><span class="line">298</span><br><span class="line">299</span><br><span class="line">300</span><br><span class="line">301</span><br><span class="line">302</span><br><span class="line">303</span><br><span class="line">304</span><br><span class="line">305</span><br><span class="line">306</span><br><span class="line">307</span><br><span class="line">308</span><br><span class="line">309</span><br><span class="line">310</span><br><span class="line">311</span><br><span class="line">312</span><br><span class="line">313</span><br><span class="line">314</span><br><span class="line">315</span><br><span class="line">316</span><br><span class="line">317</span><br><span class="line">318</span><br><span class="line">319</span><br><span class="line">320</span><br><span class="line">321</span><br><span class="line">322</span><br><span class="line">323</span><br><span class="line">324</span><br><span class="line">325</span><br><span class="line">326</span><br><span class="line">327</span><br><span class="line">328</span><br><span class="line">329</span><br><span class="line">330</span><br><span class="line">331</span><br><span class="line">332</span><br><span class="line">333</span><br><span class="line">334</span><br><span class="line">335</span><br><span class="line">336</span><br><span class="line">337</span><br><span class="line">338</span><br><span class="line">339</span><br><span class="line">340</span><br><span class="line">341</span><br><span class="line">342</span><br><span class="line">343</span><br><span class="line">344</span><br><span class="line">345</span><br><span class="line">346</span><br><span class="line">347</span><br><span class="line">348</span><br><span class="line">349</span><br><span class="line">350</span><br><span class="line">351</span><br><span class="line">352</span><br><span class="line">353</span><br><span class="line">354</span><br><span class="line">355</span><br><span class="line">356</span><br><span class="line">357</span><br><span class="line">358</span><br><span class="line">359</span><br><span class="line">360</span><br><span class="line">361</span><br><span class="line">362</span><br><span class="line">363</span><br><span class="line">364</span><br><span class="line">365</span><br><span class="line">366</span><br><span class="line">367</span><br><span class="line">368</span><br><span class="line">369</span><br><span class="line">370</span><br><span class="line">371</span><br><span class="line">372</span><br><span class="line">373</span><br><span class="line">374</span><br><span class="line">375</span><br><span class="line">376</span><br><span class="line">377</span><br><span class="line">378</span><br><span class="line">379</span><br><span class="line">380</span><br><span class="line">381</span><br><span class="line">382</span><br><span class="line">383</span><br><span class="line">384</span><br><span class="line">385</span><br><span class="line">386</span><br><span class="line">387</span><br><span class="line">388</span><br><span class="line">389</span><br><span class="line">390</span><br><span class="line">391</span><br><span class="line">392</span><br><span class="line">393</span><br><span class="line">394</span><br><span class="line">395</span><br><span class="line">396</span><br><span class="line">397</span><br><span class="line">398</span><br><span class="line">399</span><br><span class="line">400</span><br><span class="line">401</span><br><span class="line">402</span><br><span class="line">403</span><br><span class="line">404</span><br><span class="line">405</span><br><span class="line">406</span><br><span class="line">407</span><br><span class="line">408</span><br><span class="line">409</span><br><span class="line">410</span><br><span class="line">411</span><br><span class="line">412</span><br><span class="line">413</span><br><span class="line">414</span><br><span class="line">415</span><br><span class="line">416</span><br><span class="line">417</span><br><span class="line">418</span><br><span class="line">419</span><br><span class="line">420</span><br><span class="line">421</span><br><span class="line">422</span><br><span class="line">423</span><br><span class="line">424</span><br><span class="line">425</span><br><span class="line">426</span><br><span class="line">427</span><br><span class="line">428</span><br><span class="line">429</span><br><span class="line">430</span><br><span class="line">431</span><br><span class="line">432</span><br><span class="line">433</span><br><span class="line">434</span><br><span class="line">435</span><br><span class="line">436</span><br><span class="line">437</span><br><span class="line">438</span><br><span class="line">439</span><br><span class="line">440</span><br><span class="line">441</span><br><span class="line">442</span><br><span class="line">443</span><br><span class="line">444</span><br><span class="line">445</span><br><span class="line">446</span><br><span class="line">447</span><br><span class="line">448</span><br><span class="line">449</span><br><span class="line">450</span><br><span class="line">451</span><br><span class="line">452</span><br><span class="line">453</span><br><span class="line">454</span><br><span class="line">455</span><br><span class="line">456</span><br><span class="line">457</span><br><span class="line">458</span><br><span class="line">459</span><br><span class="line">460</span><br><span class="line">461</span><br><span class="line">462</span><br><span class="line">463</span><br><span class="line">464</span><br><span class="line">465</span><br><span class="line">466</span><br><span class="line">467</span><br><span class="line">468</span><br><span class="line">469</span><br><span class="line">470</span><br><span class="line">471</span><br><span class="line">472</span><br><span class="line">473</span><br><span class="line">474</span><br><span class="line">475</span><br><span class="line">476</span><br><span class="line">477</span><br><span class="line">478</span><br><span class="line">479</span><br><span class="line">480</span><br><span class="line">481</span><br><span class="line">482</span><br><span class="line">483</span><br><span class="line">484</span><br><span class="line">485</span><br><span class="line">486</span><br><span class="line">487</span><br><span class="line">488</span><br><span class="line">489</span><br><span class="line">490</span><br><span class="line">491</span><br><span class="line">492</span><br><span class="line">493</span><br><span class="line">494</span><br><span class="line">495</span><br><span class="line">496</span><br><span class="line">497</span><br><span class="line">498</span><br><span class="line">499</span><br><span class="line">500</span><br><span class="line">501</span><br><span class="line">502</span><br><span class="line">503</span><br><span class="line">504</span><br><span class="line">505</span><br><span class="line">506</span><br><span class="line">507</span><br><span class="line">508</span><br><span class="line">509</span><br><span class="line">510</span><br><span class="line">511</span><br><span class="line">512</span><br><span class="line">513</span><br><span class="line">514</span><br><span class="line">515</span><br><span class="line">516</span><br><span class="line">517</span><br><span class="line">518</span><br><span class="line">519</span><br><span class="line">520</span><br><span class="line">521</span><br><span class="line">522</span><br><span class="line">523</span><br><span class="line">524</span><br><span class="line">525</span><br><span class="line">526</span><br><span class="line">527</span><br><span class="line">528</span><br><span class="line">529</span><br><span class="line">530</span><br><span class="line">531</span><br><span class="line">532</span><br><span class="line">533</span><br><span class="line">534</span><br><span class="line">535</span><br><span class="line">536</span><br><span class="line">537</span><br><span class="line">538</span><br><span class="line">539</span><br><span class="line">540</span><br><span class="line">541</span><br><span class="line">542</span><br><span class="line">543</span><br><span class="line">544</span><br><span class="line">545</span><br><span class="line">546</span><br><span class="line">547</span><br><span class="line">548</span><br><span class="line">549</span><br><span class="line">550</span><br><span class="line">551</span><br><span class="line">552</span><br><span class="line">553</span><br><span class="line">554</span><br><span class="line">555</span><br><span class="line">556</span><br><span class="line">557</span><br><span class="line">558</span><br><span class="line">559</span><br><span class="line">560</span><br><span class="line">561</span><br><span class="line">562</span><br><span class="line">563</span><br><span class="line">564</span><br><span class="line">565</span><br><span class="line">566</span><br><span class="line">567</span><br><span class="line">568</span><br><span class="line">569</span><br><span class="line">570</span><br><span class="line">571</span><br><span class="line">572</span><br><span class="line">573</span><br><span class="line">574</span><br><span class="line">575</span><br><span class="line">576</span><br><span class="line">577</span><br><span class="line">578</span><br><span class="line">579</span><br><span class="line">580</span><br><span class="line">581</span><br><span class="line">582</span><br><span class="line">583</span><br><span class="line">584</span><br><span class="line">585</span><br><span class="line">586</span><br><span class="line">587</span><br><span class="line">588</span><br><span class="line">589</span><br><span class="line">590</span><br><span class="line">591</span><br><span class="line">592</span><br><span class="line">593</span><br><span class="line">594</span><br><span class="line">595</span><br><span class="line">596</span><br><span class="line">597</span><br><span class="line">598</span><br><span class="line">599</span><br><span class="line">600</span><br><span class="line">601</span><br><span class="line">602</span><br><span class="line">603</span><br><span class="line">604</span><br><span class="line">605</span><br><span class="line">606</span><br><span class="line">607</span><br><span class="line">608</span><br><span class="line">609</span><br><span class="line">610</span><br><span class="line">611</span><br><span class="line">612</span><br><span class="line">613</span><br><span class="line">614</span><br><span class="line">615</span><br><span class="line">616</span><br><span class="line">617</span><br><span class="line">618</span><br><span class="line">619</span><br><span class="line">620</span><br><span class="line">621</span><br><span class="line">622</span><br><span class="line">623</span><br><span class="line">624</span><br><span class="line">625</span><br><span class="line">626</span><br><span class="line">627</span><br><span class="line">628</span><br><span class="line">629</span><br><span class="line">630</span><br><span class="line">631</span><br><span class="line">632</span><br><span class="line">633</span><br><span class="line">634</span><br><span class="line">635</span><br><span class="line">636</span><br><span class="line">637</span><br><span class="line">638</span><br><span class="line">639</span><br><span class="line">640</span><br><span class="line">641</span><br><span class="line">642</span><br><span class="line">643</span><br><span class="line">644</span><br><span class="line">645</span><br><span class="line">646</span><br><span class="line">647</span><br><span class="line">648</span><br><span class="line">649</span><br><span class="line">650</span><br><span class="line">651</span><br><span class="line">652</span><br><span class="line">653</span><br><span class="line">654</span><br><span class="line">655</span><br><span class="line">656</span><br><span class="line">657</span><br><span class="line">658</span><br><span class="line">659</span><br><span class="line">660</span><br><span class="line">661</span><br><span class="line">662</span><br><span class="line">663</span><br><span class="line">664</span><br><span class="line">665</span><br><span class="line">666</span><br><span class="line">667</span><br><span class="line">668</span><br><span class="line">669</span><br><span class="line">670</span><br><span class="line">671</span><br><span class="line">672</span><br><span class="line">673</span><br><span class="line">674</span><br><span class="line">675</span><br><span class="line">676</span><br><span class="line">677</span><br><span class="line">678</span><br><span class="line">679</span><br><span class="line">680</span><br><span class="line">681</span><br><span class="line">682</span><br><span class="line">683</span><br><span class="line">684</span><br><span class="line">685</span><br><span class="line">686</span><br><span class="line">687</span><br><span class="line">688</span><br><span class="line">689</span><br><span class="line">690</span><br><span class="line">691</span><br><span class="line">692</span><br><span class="line">693</span><br><span class="line">694</span><br><span class="line">695</span><br><span class="line">696</span><br><span class="line">697</span><br><span class="line">698</span><br><span class="line">699</span><br><span class="line">700</span><br><span class="line">701</span><br><span class="line">702</span><br><span class="line">703</span><br><span class="line">704</span><br><span class="line">705</span><br><span class="line">706</span><br><span class="line">707</span><br><span class="line">708</span><br><span class="line">709</span><br><span class="line">710</span><br><span class="line">711</span><br><span class="line">712</span><br><span class="line">713</span><br><span class="line">714</span><br><span class="line">715</span><br><span class="line">716</span><br><span class="line">717</span><br><span class="line">718</span><br><span class="line">719</span><br><span class="line">720</span><br><span class="line">721</span><br><span class="line">722</span><br><span class="line">723</span><br><span class="line">724</span><br><span class="line">725</span><br><span class="line">726</span><br><span class="line">727</span><br><span class="line">728</span><br><span class="line">729</span><br><span class="line">730</span><br><span class="line">731</span><br><span class="line">732</span><br><span class="line">733</span><br><span class="line">734</span><br><span class="line">735</span><br><span class="line">736</span><br><span class="line">737</span><br><span class="line">738</span><br><span class="line">739</span><br><span class="line">740</span><br><span class="line">741</span><br><span class="line">742</span><br><span class="line">743</span><br><span class="line">744</span><br><span class="line">745</span><br><span class="line">746</span><br><span class="line">747</span><br><span class="line">748</span><br><span class="line">749</span><br><span class="line">750</span><br><span class="line">751</span><br><span class="line">752</span><br><span class="line">753</span><br><span class="line">754</span><br><span class="line">755</span><br><span class="line">756</span><br><span class="line">757</span><br><span class="line">758</span><br><span class="line">759</span><br><span class="line">760</span><br><span class="line">761</span><br><span class="line">762</span><br><span class="line">763</span><br><span class="line">764</span><br><span class="line">765</span><br><span class="line">766</span><br><span class="line">767</span><br><span class="line">768</span><br><span class="line">769</span><br><span class="line">770</span><br><span class="line">771</span><br><span class="line">772</span><br><span class="line">773</span><br><span class="line">774</span><br><span class="line">775</span><br><span class="line">776</span><br><span class="line">777</span><br><span class="line">778</span><br><span class="line">779</span><br><span class="line">780</span><br><span class="line">781</span><br><span class="line">782</span><br><span class="line">783</span><br><span class="line">784</span><br><span class="line">785</span><br><span class="line">786</span><br><span class="line">787</span><br><span class="line">788</span><br><span class="line">789</span><br><span class="line">790</span><br><span class="line">791</span><br><span class="line">792</span><br><span class="line">793</span><br><span class="line">794</span><br><span class="line">795</span><br><span class="line">796</span><br><span class="line">797</span><br><span class="line">798</span><br><span class="line">799</span><br><span class="line">800</span><br><span class="line">801</span><br><span class="line">802</span><br><span class="line">803</span><br><span class="line">804</span><br><span class="line">805</span><br><span class="line">806</span><br><span class="line">807</span><br><span class="line">808</span><br><span class="line">809</span><br><span class="line">810</span><br><span class="line">811</span><br><span class="line">812</span><br><span class="line">813</span><br><span class="line">814</span><br><span class="line">815</span><br><span class="line">816</span><br><span class="line">817</span><br><span class="line">818</span><br><span class="line">819</span><br><span class="line">820</span><br><span class="line">821</span><br><span class="line">822</span><br><span class="line">823</span><br><span class="line">824</span><br><span class="line">825</span><br><span class="line">826</span><br><span class="line">827</span><br><span class="line">828</span><br><span class="line">829</span><br><span class="line">830</span><br><span class="line">831</span><br><span class="line">832</span><br><span class="line">833</span><br><span class="line">834</span><br><span class="line">835</span><br><span class="line">836</span><br><span class="line">837</span><br><span class="line">838</span><br><span class="line">839</span><br><span class="line">840</span><br><span class="line">841</span><br><span class="line">842</span><br><span class="line">843</span><br><span class="line">844</span><br><span class="line">845</span><br><span class="line">846</span><br><span class="line">847</span><br><span class="line">848</span><br><span class="line">849</span><br><span class="line">850</span><br><span class="line">851</span><br><span class="line">852</span><br><span class="line">853</span><br><span class="line">854</span><br><span class="line">855</span><br><span class="line">856</span><br><span class="line">857</span><br><span class="line">858</span><br><span class="line">859</span><br><span class="line">860</span><br><span class="line">861</span><br><span class="line">862</span><br><span class="line">863</span><br><span class="line">864</span><br><span class="line">865</span><br><span class="line">866</span><br><span class="line">867</span><br><span class="line">868</span><br><span class="line">869</span><br><span class="line">870</span><br><span class="line">871</span><br><span class="line">872</span><br><span class="line">873</span><br><span class="line">874</span><br><span class="line">875</span><br><span class="line">876</span><br><span class="line">877</span><br><span class="line">878</span><br><span class="line">879</span><br><span class="line">880</span><br><span class="line">881</span><br><span class="line">882</span><br><span class="line">883</span><br><span class="line">884</span><br><span class="line">885</span><br><span class="line">886</span><br><span class="line">887</span><br><span class="line">888</span><br><span class="line">889</span><br><span class="line">890</span><br><span class="line">891</span><br><span class="line">892</span><br><span class="line">893</span><br><span class="line">894</span><br><span class="line">895</span><br><span class="line">896</span><br><span class="line">897</span><br><span class="line">898</span><br><span class="line">899</span><br><span class="line">900</span><br><span class="line">901</span><br><span class="line">902</span><br><span class="line">903</span><br><span class="line">904</span><br><span class="line">905</span><br><span class="line">906</span><br><span class="line">907</span><br><span class="line">908</span><br><span class="line">909</span><br><span class="line">910</span><br><span class="line">911</span><br><span class="line">912</span><br><span class="line">913</span><br><span class="line">914</span><br><span class="line">915</span><br><span class="line">916</span><br><span class="line">917</span><br><span class="line">918</span><br><span class="line">919</span><br><span class="line">920</span><br><span class="line">921</span><br><span class="line">922</span><br><span class="line">923</span><br><span class="line">924</span><br><span class="line">925</span><br><span class="line">926</span><br><span class="line">927</span><br><span class="line">928</span><br><span class="line">929</span><br><span class="line">930</span><br><span class="line">931</span><br><span class="line">932</span><br><span class="line">933</span><br><span class="line">934</span><br><span class="line">935</span><br><span class="line">936</span><br><span class="line">937</span><br><span class="line">938</span><br><span class="line">939</span><br><span class="line">940</span><br><span class="line">941</span><br><span class="line">942</span><br><span class="line">943</span><br><span class="line">944</span><br><span class="line">945</span><br><span class="line">946</span><br><span class="line">947</span><br><span class="line">948</span><br><span class="line">949</span><br><span class="line">950</span><br><span class="line">951</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">private</span> PackageParser.<span class="function">Package <span class="title">scanPackageDirtyLI</span><span class="params">(PackageParser.Package pkg,</span></span></span><br><span class="line"><span class="function"><span class="params">        <span class="keyword">final</span> <span class="keyword">int</span> policyFlags, <span class="keyword">final</span> <span class="keyword">int</span> scanFlags, <span class="keyword">long</span> currentTime, UserHandle user)</span></span></span><br><span class="line"><span class="function">        <span class="keyword">throws</span> PackageManagerException </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">final</span> File scanFile = <span class="keyword">new</span> File(pkg.codePath);</span><br><span class="line">    <span class="keyword">if</span> (pkg.applicationInfo.getCodePath() == <span class="keyword">null</span> ||</span><br><span class="line">            pkg.applicationInfo.getResourcePath() == <span class="keyword">null</span>) &#123;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">throw</span> <span class="keyword">new</span> PackageManagerException(INSTALL_FAILED_INVALID_APK,</span><br><span class="line">                <span class="string">"Code and resource paths haven't been set correctly"</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">//【×】扫描 data 分区不会进入这里，那么 package 也就不会被设置 ApplicationInfo.FLAG_SYSTEM 标志位！</span></span><br><span class="line">    <span class="keyword">if</span> ((policyFlags&amp;PackageParser.PARSE_IS_SYSTEM) != <span class="number">0</span>) &#123; </span><br><span class="line">        pkg.applicationInfo.flags |= ApplicationInfo.FLAG_SYSTEM;</span><br><span class="line">        <span class="keyword">if</span> (pkg.applicationInfo.isDirectBootAware()) &#123;</span><br><span class="line"></span><br><span class="line">            <span class="keyword">for</span> (PackageParser.Service s : pkg.services) &#123;</span><br><span class="line">                s.info.encryptionAware = s.info.directBootAware = <span class="keyword">true</span>;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">for</span> (PackageParser.Provider p : pkg.providers) &#123;</span><br><span class="line">                p.info.encryptionAware = p.info.directBootAware = <span class="keyword">true</span>;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">for</span> (PackageParser.Activity a : pkg.activities) &#123;</span><br><span class="line">                a.info.encryptionAware = a.info.directBootAware = <span class="keyword">true</span>;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">for</span> (PackageParser.Activity r : pkg.receivers) &#123;</span><br><span class="line">                r.info.encryptionAware = r.info.directBootAware = <span class="keyword">true</span>;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        <span class="comment">//【×】data 分区 apk 进入这个分支，coreApp 的值为 false，并清除一些 flag；</span></span><br><span class="line">        pkg.coreApp = <span class="keyword">false</span>;</span><br><span class="line">        pkg.applicationInfo.privateFlags &amp;=</span><br><span class="line">                ~ApplicationInfo.PRIVATE_FLAG_DEFAULT_TO_DEVICE_PROTECTED_STORAGE;</span><br><span class="line">        pkg.applicationInfo.privateFlags &amp;=</span><br><span class="line">                ~ApplicationInfo.PRIVATE_FLAG_DIRECT_BOOT_AWARE;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 下面这部分扫描 data 分区也不会遇到！</span></span><br><span class="line">    pkg.mTrustedOverlay = (policyFlags&amp;PackageParser.PARSE_TRUSTED_OVERLAY) != <span class="number">0</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> ((policyFlags&amp;PackageParser.PARSE_IS_PRIVILEGED) != <span class="number">0</span>) &#123;</span><br><span class="line">        pkg.applicationInfo.privateFlags |= ApplicationInfo.PRIVATE_FLAG_PRIVILEGED;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> ((policyFlags &amp; PackageParser.PARSE_ENFORCE_CODE) != <span class="number">0</span>) &#123;</span><br><span class="line">        enforceCodePolicy(pkg);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (mCustomResolverComponentName != <span class="keyword">null</span> &amp;&amp;</span><br><span class="line">            mCustomResolverComponentName.getPackageName().equals(pkg.packageName)) &#123;</span><br><span class="line">        setUpCustomResolverActivity(pkg);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 扫描 data 不会进入这里！！ </span></span><br><span class="line">    <span class="keyword">if</span> (pkg.packageName.equals(<span class="string">"android"</span>)) &#123;</span><br><span class="line">        ... ... ... ...</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (DEBUG_PACKAGE_SCANNING) &#123;</span><br><span class="line">        <span class="keyword">if</span> ((policyFlags &amp; PackageParser.PARSE_CHATTY) != <span class="number">0</span>)</span><br><span class="line">            Log.d(TAG, <span class="string">"Scanning package "</span> + pkg.packageName);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">synchronized</span> (mPackages) &#123;</span><br><span class="line">        <span class="comment">// 如果 PMS 已经扫描并处理了这个 apk，就抛异常，跳过！</span></span><br><span class="line">        <span class="keyword">if</span> (mPackages.containsKey(pkg.packageName)</span><br><span class="line">                || mSharedLibraries.containsKey(pkg.packageName)) &#123;</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> PackageManagerException(INSTALL_FAILED_DUPLICATE_PACKAGE,</span><br><span class="line">                    <span class="string">"Application package "</span> + pkg.packageName</span><br><span class="line">                            + <span class="string">" already installed.  Skipping duplicate."</span>);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">        <span class="comment">//【A】对于 data 分区的 apk，进入该分支！</span></span><br><span class="line">        <span class="keyword">if</span> ((scanFlags &amp; SCAN_REQUIRE_KNOWN) != <span class="number">0</span>) &#123;</span><br><span class="line">            <span class="comment">// 如果 mExpectingBetter 中有该应用的包名，说明该应用是覆盖了 system apk！</span></span><br><span class="line">            <span class="comment">// 这种情况，我们后续会选择 versionCode 更高的显示出来！</span></span><br><span class="line">            <span class="keyword">if</span> (mExpectingBetter.containsKey(pkg.packageName)) &#123;</span><br><span class="line">                logCriticalInfo(Log.WARN,</span><br><span class="line">                        <span class="string">"Relax SCAN_REQUIRE_KNOWN requirement for package "</span> + pkg.packageName);</span><br><span class="line">                    </span><br><span class="line">            &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                <span class="comment">// 获得上一次安装的信息!</span></span><br><span class="line">                PackageSetting known = mSettings.peekPackageLPr(pkg.packageName);</span><br><span class="line">                <span class="keyword">if</span> (known != <span class="keyword">null</span>) &#123;</span><br><span class="line">                    <span class="keyword">if</span> (DEBUG_PACKAGE_SCANNING) &#123;</span><br><span class="line">                        Log.d(TAG, <span class="string">"Examining "</span> + pkg.codePath</span><br><span class="line">                                + <span class="string">" and requiring known paths "</span> + known.codePathString</span><br><span class="line">                                + <span class="string">" &amp; "</span> + known.resourcePathString);</span><br><span class="line">                    &#125;</span><br><span class="line"></span><br><span class="line">                    <span class="comment">//【B】如果本次扫描和之前安装后的的 codePath 或者 ResourcePath 不一样，抛出异常，结束处理！</span></span><br><span class="line">                    <span class="comment">// 这种情况，我们会忽视这个 apk！！</span></span><br><span class="line">                    <span class="keyword">if</span> (!pkg.applicationInfo.getCodePath().equals(known.codePathString)</span><br><span class="line">                            || !pkg.applicationInfo.getResourcePath().equals(</span><br><span class="line">                            known.resourcePathString)) &#123;</span><br><span class="line"></span><br><span class="line">                        <span class="keyword">throw</span> <span class="keyword">new</span> PackageManagerException(INSTALL_FAILED_PACKAGE_CHANGED,</span><br><span class="line">                                <span class="string">"Application package "</span> + pkg.packageName</span><br><span class="line">                                        + <span class="string">" found at "</span> + pkg.applicationInfo.getCodePath()</span><br><span class="line">                                        + <span class="string">" but expected at "</span> + known.codePathString</span><br><span class="line">                                        + <span class="string">"; ignoring."</span>);</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 初始化资源路径！</span></span><br><span class="line">    File destCodeFile = <span class="keyword">new</span> File(pkg.applicationInfo.getCodePath());</span><br><span class="line">    File destResourceFile = <span class="keyword">new</span> File(pkg.applicationInfo.getResourcePath());</span><br><span class="line"></span><br><span class="line">    SharedUserSetting suid = <span class="keyword">null</span>;</span><br><span class="line">    PackageSetting pkgSetting = <span class="keyword">null</span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 非系统 apk ，要取消以下属性！！，判断是否是 system app 的依据是 </span></span><br><span class="line">    <span class="comment">// 是否有这个 ApplicationInfo.FLAG_SYSTEM 标志位！</span></span><br><span class="line">    <span class="keyword">if</span> (!isSystemApp(pkg)) &#123;</span><br><span class="line">        pkg.mOriginalPackages = <span class="keyword">null</span>;</span><br><span class="line">        pkg.mRealPackage = <span class="keyword">null</span>;</span><br><span class="line">        pkg.mAdoptPermissions = <span class="keyword">null</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// Getting the package setting may have a side-effect, so if we</span></span><br><span class="line">    <span class="comment">// are only checking if scan would succeed, stash a copy of the</span></span><br><span class="line">    <span class="comment">// old setting to restore at the end.</span></span><br><span class="line">    PackageSetting nonMutatedPs = <span class="keyword">null</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">synchronized</span> (mPackages) &#123;</span><br><span class="line">        <span class="comment">// 如果 apk 是共享 uid 的！</span></span><br><span class="line">        <span class="keyword">if</span> (pkg.mSharedUserId != <span class="keyword">null</span>) &#123;</span><br><span class="line">            <span class="comment">// 获得 SharedUserSetting 对象！</span></span><br><span class="line">            suid = mSettings.getSharedUserLPw(pkg.mSharedUserId, <span class="number">0</span>, <span class="number">0</span>, <span class="keyword">true</span>);</span><br><span class="line">            <span class="keyword">if</span> (suid == <span class="keyword">null</span>) &#123;</span><br><span class="line">                <span class="keyword">throw</span> <span class="keyword">new</span> PackageManagerException(INSTALL_FAILED_INSUFFICIENT_STORAGE,</span><br><span class="line">                        <span class="string">"Creating application package "</span> + pkg.packageName</span><br><span class="line">                        + <span class="string">" for shared user failed"</span>);</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            <span class="keyword">if</span> (DEBUG_PACKAGE_SCANNING) &#123;</span><br><span class="line">                <span class="keyword">if</span> ((policyFlags &amp; PackageParser.PARSE_CHATTY) != <span class="number">0</span>)</span><br><span class="line">                    Log.d(TAG, <span class="string">"Shared UserID "</span> + pkg.mSharedUserId + <span class="string">" (uid="</span> + suid.userId</span><br><span class="line">                            + <span class="string">"): packages="</span> + suid.packages);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 非系统 apk 无源包，不进入这个分支！</span></span><br><span class="line">        <span class="comment">// 覆盖安装的系统 apk，可以进入这个分支，这里的目的是找到合适的源包，用来设置包名，已经复用源包的数据！</span></span><br><span class="line">        PackageSetting origPackage = <span class="keyword">null</span>;</span><br><span class="line">        String realName = <span class="keyword">null</span>;</span><br><span class="line">        <span class="keyword">if</span> (pkg.mOriginalPackages != <span class="keyword">null</span>) &#123;</span><br><span class="line">            </span><br><span class="line">            <span class="keyword">final</span> String renamed = mSettings.mRenamedPackages.get(pkg.mRealPackage);</span><br><span class="line">            </span><br><span class="line">            <span class="keyword">if</span> (pkg.mOriginalPackages.contains(renamed)) &#123;</span><br><span class="line">            </span><br><span class="line">                realName = pkg.mRealPackage;</span><br><span class="line">                <span class="keyword">if</span> (!pkg.packageName.equals(renamed)) &#123;</span><br><span class="line">                </span><br><span class="line">                    pkg.setPackageName(renamed);</span><br><span class="line">                &#125;</span><br><span class="line"></span><br><span class="line">            &#125; <span class="keyword">else</span> &#123;</span><br><span class="line"></span><br><span class="line">                <span class="keyword">for</span> (<span class="keyword">int</span> i=pkg.mOriginalPackages.size()-<span class="number">1</span>; i&gt;=<span class="number">0</span>; i--) &#123;</span><br><span class="line">                    <span class="keyword">if</span> ((origPackage = mSettings.peekPackageLPr(</span><br><span class="line">                            pkg.mOriginalPackages.get(i))) != <span class="keyword">null</span>) &#123;</span><br><span class="line">                    </span><br><span class="line">                        <span class="keyword">if</span> (!verifyPackageUpdateLPr(origPackage, pkg)) &#123;</span><br><span class="line">                            <span class="comment">// New package is not compatible with original.</span></span><br><span class="line">                            origPackage = <span class="keyword">null</span>;</span><br><span class="line">                            <span class="keyword">continue</span>;</span><br><span class="line">                            </span><br><span class="line">                        &#125; <span class="keyword">else</span> <span class="keyword">if</span> (origPackage.sharedUser != <span class="keyword">null</span>) &#123;</span><br><span class="line">                            <span class="keyword">if</span> (!origPackage.sharedUser.name.equals(pkg.mSharedUserId)) &#123;</span><br><span class="line">                                Slog.w(TAG, <span class="string">"Unable to migrate data from "</span> + origPackage.name</span><br><span class="line">                                        + <span class="string">" to "</span> + pkg.packageName + <span class="string">": old uid "</span></span><br><span class="line">                                        + origPackage.sharedUser.name</span><br><span class="line">                                        + <span class="string">" differs from "</span> + pkg.mSharedUserId);</span><br><span class="line">                                origPackage = <span class="keyword">null</span>;</span><br><span class="line">                                <span class="keyword">continue</span>;</span><br><span class="line">                            &#125;</span><br><span class="line">                            <span class="comment">// <span class="doctag">TODO:</span> Add case when shared user id is added [b/28144775]</span></span><br><span class="line">                        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                        </span><br><span class="line">                            <span class="keyword">if</span> (DEBUG_UPGRADE) Log.v(TAG, <span class="string">"Renaming new package "</span></span><br><span class="line">                                    + pkg.packageName + <span class="string">" to old name "</span> + origPackage.name);</span><br><span class="line">                        &#125;</span><br><span class="line">                        <span class="keyword">break</span>;</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (mTransferedPackages.contains(pkg.packageName)) &#123;</span><br><span class="line">            Slog.w(TAG, <span class="string">"Package "</span> + pkg.packageName</span><br><span class="line">                    + <span class="string">" was transferred to another, but its .apk remains"</span>);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// See comments in nonMutatedPs declaration</span></span><br><span class="line">        <span class="keyword">if</span> ((scanFlags &amp; SCAN_CHECK_ONLY) != <span class="number">0</span>) &#123;</span><br><span class="line">            PackageSetting foundPs = mSettings.peekPackageLPr(pkg.packageName);</span><br><span class="line">            <span class="keyword">if</span> (foundPs != <span class="keyword">null</span>) &#123;</span><br><span class="line">                nonMutatedPs = <span class="keyword">new</span> PackageSetting(foundPs);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        </span><br><span class="line">        <span class="comment">//【1.3.1】获得当前扫描的这个 package 对应的 packageSetting 对象，如果已经存在就直接返回，不存在就创建！</span></span><br><span class="line">        <span class="comment">// 如果 origPackage 不为 null，创建新的需要重命名为源包的名字！</span></span><br><span class="line">        pkgSetting = mSettings.getPackageLPw(pkg, origPackage, realName, suid, destCodeFile,</span><br><span class="line">                destResourceFile, pkg.applicationInfo.nativeLibraryRootDir,</span><br><span class="line">                pkg.applicationInfo.primaryCpuAbi,</span><br><span class="line">                pkg.applicationInfo.secondaryCpuAbi,</span><br><span class="line">                pkg.applicationInfo.flags, pkg.applicationInfo.privateFlags,</span><br><span class="line">                user, <span class="keyword">false</span>);</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (pkgSetting == <span class="keyword">null</span>) &#123;</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> PackageManagerException(INSTALL_FAILED_INSUFFICIENT_STORAGE,</span><br><span class="line">                    <span class="string">"Creating application package "</span> + pkg.packageName + <span class="string">" failed"</span>);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (pkgSetting.origPackage != <span class="keyword">null</span>) &#123; <span class="comment">// 非系统 apk 不会进入该分支!</span></span><br><span class="line">        </span><br><span class="line">            pkg.setPackageName(origPackage.name);</span><br><span class="line"></span><br><span class="line">            String msg = <span class="string">"New package "</span> + pkgSetting.realName</span><br><span class="line">                    + <span class="string">" renamed to replace old package "</span> + pkgSetting.name;</span><br><span class="line">            reportSettingsProblem(Log.WARN, msg);</span><br><span class="line"></span><br><span class="line">            <span class="keyword">if</span> ((scanFlags &amp; SCAN_CHECK_ONLY) == <span class="number">0</span>) &#123;</span><br><span class="line">                mTransferedPackages.add(origPackage.name);</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            pkgSetting.origPackage = <span class="keyword">null</span>;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> ((scanFlags &amp; SCAN_CHECK_ONLY) == <span class="number">0</span> &amp;&amp; realName != <span class="keyword">null</span>) &#123;</span><br><span class="line">            mTransferedPackages.add(pkg.packageName);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 如果是被覆盖安装的系统 apk，需要添加 ApplicationInfo.FLAG_UPDATED_SYSTEM_APP 标签</span></span><br><span class="line">        <span class="keyword">if</span> (mSettings.isDisabledSystemPackageLPr(pkg.packageName)) &#123;</span><br><span class="line">            pkg.applicationInfo.flags |= ApplicationInfo.FLAG_UPDATED_SYSTEM_APP;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> ((policyFlags&amp;PackageParser.PARSE_IS_SYSTEM_DIR) == <span class="number">0</span>) &#123;</span><br><span class="line">            updateSharedLibrariesLPw(pkg, <span class="keyword">null</span>);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 设置 Polisy 标签！</span></span><br><span class="line">        <span class="keyword">if</span> (mFoundPolicyFile) &#123;</span><br><span class="line">            SELinuxMMAC.assignSeinfoValue(pkg);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        pkg.applicationInfo.uid = pkgSetting.appId;</span><br><span class="line">        pkg.mExtras = pkgSetting;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 处理 keySet 更新和签名校验！</span></span><br><span class="line">        <span class="keyword">if</span> (shouldCheckUpgradeKeySetLP(pkgSetting, scanFlags)) &#123;</span><br><span class="line">            <span class="keyword">if</span> (checkUpgradeKeySetLP(pkgSetting, pkg)) &#123;</span><br><span class="line">                <span class="comment">// We just determined the app is signed correctly, so bring</span></span><br><span class="line">                <span class="comment">// over the latest parsed certs.</span></span><br><span class="line">                pkgSetting.signatures.mSignatures = pkg.mSignatures;</span><br><span class="line">            &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                <span class="keyword">if</span> ((policyFlags &amp; PackageParser.PARSE_IS_SYSTEM_DIR) == <span class="number">0</span>) &#123;</span><br><span class="line">                    <span class="keyword">throw</span> <span class="keyword">new</span> PackageManagerException(INSTALL_FAILED_UPDATE_INCOMPATIBLE,</span><br><span class="line">                            <span class="string">"Package "</span> + pkg.packageName + <span class="string">" upgrade keys do not match the "</span></span><br><span class="line">                            + <span class="string">"previously installed version"</span>);</span><br><span class="line">                &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                    pkgSetting.signatures.mSignatures = pkg.mSignatures;</span><br><span class="line">                    String msg = <span class="string">"System package "</span> + pkg.packageName</span><br><span class="line">                        + <span class="string">" signature changed; retaining data."</span>;</span><br><span class="line">                    reportSettingsProblem(Log.WARN, msg);</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            <span class="keyword">try</span> &#123;</span><br><span class="line">                verifySignaturesLP(pkgSetting, pkg);</span><br><span class="line"></span><br><span class="line">                pkgSetting.signatures.mSignatures = pkg.mSignatures;</span><br><span class="line">                </span><br><span class="line">            &#125; <span class="keyword">catch</span> (PackageManagerException e) &#123;</span><br><span class="line">                <span class="keyword">if</span> ((policyFlags &amp; PackageParser.PARSE_IS_SYSTEM_DIR) == <span class="number">0</span>) &#123;</span><br><span class="line">                    <span class="keyword">throw</span> e;</span><br><span class="line">                &#125;</span><br><span class="line"></span><br><span class="line">                pkgSetting.signatures.mSignatures = pkg.mSignatures;</span><br><span class="line"></span><br><span class="line">                <span class="keyword">if</span> (pkgSetting.sharedUser != <span class="keyword">null</span>) &#123;</span><br><span class="line">                    <span class="keyword">if</span> (compareSignatures(pkgSetting.sharedUser.signatures.mSignatures,</span><br><span class="line">                                          pkg.mSignatures) != PackageManager.SIGNATURE_MATCH) &#123;</span><br><span class="line">                        <span class="keyword">throw</span> <span class="keyword">new</span> PackageManagerException(</span><br><span class="line">                                INSTALL_PARSE_FAILED_INCONSISTENT_CERTIFICATES,</span><br><span class="line">                                        <span class="string">"Signature mismatch for shared user: "</span></span><br><span class="line">                                        + pkgSetting.sharedUser);</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;</span><br><span class="line">                <span class="comment">// File a report about this.</span></span><br><span class="line">                String msg = <span class="string">"System package "</span> + pkg.packageName</span><br><span class="line">                    + <span class="string">" signature changed; retaining data."</span>;</span><br><span class="line">                reportSettingsProblem(Log.WARN, msg);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        </span><br><span class="line"></span><br><span class="line">        <span class="comment">// 安装的时候才会进入这个分支，这里不看！</span></span><br><span class="line">        <span class="comment">// 判断这个 package 使用的 content providers 是否和已经存在 package 冲突！</span></span><br><span class="line">        <span class="keyword">if</span> ((scanFlags &amp; SCAN_NEW_INSTALL) != <span class="number">0</span>) &#123; </span><br><span class="line">            <span class="keyword">final</span> <span class="keyword">int</span> N = pkg.providers.size();</span><br><span class="line">            <span class="keyword">int</span> i;</span><br><span class="line">            <span class="keyword">for</span> (i=<span class="number">0</span>; i&lt;N; i++) &#123;</span><br><span class="line">                PackageParser.Provider p = pkg.providers.get(i);</span><br><span class="line">                <span class="keyword">if</span> (p.info.authority != <span class="keyword">null</span>) &#123;</span><br><span class="line">                    String names[] = p.info.authority.split(<span class="string">";"</span>);</span><br><span class="line">                    <span class="keyword">for</span> (<span class="keyword">int</span> j = <span class="number">0</span>; j &lt; names.length; j++) &#123;</span><br><span class="line">                        <span class="keyword">if</span> (mProvidersByAuthority.containsKey(names[j])) &#123;</span><br><span class="line">                            PackageParser.Provider other = mProvidersByAuthority.get(names[j]);</span><br><span class="line">                            <span class="keyword">final</span> String otherPackageName =</span><br><span class="line">                                    ((other != <span class="keyword">null</span> &amp;&amp; other.getComponentName() != <span class="keyword">null</span>) ?</span><br><span class="line">                                            other.getComponentName().getPackageName() : <span class="string">"?"</span>);</span><br><span class="line">                            <span class="keyword">throw</span> <span class="keyword">new</span> PackageManagerException(</span><br><span class="line">                                    INSTALL_FAILED_CONFLICTING_PROVIDER,</span><br><span class="line">                                            <span class="string">"Can't install because provider name "</span> + names[j]</span><br><span class="line">                                            + <span class="string">" (in package "</span> + pkg.applicationInfo.packageName</span><br><span class="line">                                            + <span class="string">") is already used by "</span> + otherPackageName);</span><br><span class="line">                        &#125;</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 同样的，只有系统 apk 才能进入该分支！</span></span><br><span class="line">        <span class="keyword">if</span> ((scanFlags &amp; SCAN_CHECK_ONLY) == <span class="number">0</span> &amp;&amp; pkg.mAdoptPermissions != <span class="keyword">null</span>) &#123;</span><br><span class="line"></span><br><span class="line">            <span class="comment">// This package wants to adopt ownership of permissions from</span></span><br><span class="line">            <span class="comment">// another package.</span></span><br><span class="line">            <span class="keyword">for</span> (<span class="keyword">int</span> i = pkg.mAdoptPermissions.size() - <span class="number">1</span>; i &gt;= <span class="number">0</span>; i--) &#123;</span><br><span class="line">                <span class="keyword">final</span> String origName = pkg.mAdoptPermissions.get(i);</span><br><span class="line">                <span class="keyword">final</span> PackageSetting orig = mSettings.peekPackageLPr(origName);</span><br><span class="line">                <span class="keyword">if</span> (orig != <span class="keyword">null</span>) &#123;</span><br><span class="line">                    <span class="keyword">if</span> (verifyPackageUpdateLPr(orig, pkg)) &#123;</span><br><span class="line">                        Slog.i(TAG, <span class="string">"Adopting permissions from "</span> + origName + <span class="string">" to "</span></span><br><span class="line">                                + pkg.packageName);</span><br><span class="line"></span><br><span class="line">                        mSettings.transferPermissionsLPw(origName, pkg.packageName);</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">final</span> String pkgName = pkg.packageName;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">final</span> <span class="keyword">long</span> scanFileTime = getLastModifiedTime(pkg, scanFile);</span><br><span class="line">    <span class="keyword">final</span> <span class="keyword">boolean</span> forceDex = (scanFlags &amp; SCAN_FORCE_DEX) != <span class="number">0</span>;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// 设置 pacakge 对应的进程名！</span></span><br><span class="line">    pkg.applicationInfo.processName = fixProcessName(</span><br><span class="line">            pkg.applicationInfo.packageName,</span><br><span class="line">            pkg.applicationInfo.processName,</span><br><span class="line">            pkg.applicationInfo.uid);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (pkg != mPlatformPackage) &#123;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// Get all of our default paths setup</span></span><br><span class="line">        pkg.applicationInfo.initForUser(UserHandle.USER_SYSTEM);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">final</span> String path = scanFile.getPath();</span><br><span class="line">    <span class="keyword">final</span> String cpuAbiOverride = deriveAbiOverride(pkg.cpuAbiOverride, pkgSetting);</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 下面是设置本地库和系统平台相关的属性！</span></span><br><span class="line">    <span class="keyword">if</span> ((scanFlags &amp; SCAN_NEW_INSTALL) == <span class="number">0</span>) &#123;</span><br><span class="line">        derivePackageAbi(pkg, scanFile, cpuAbiOverride, <span class="keyword">true</span> <span class="comment">/* extract libs */</span>);</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (isSystemApp(pkg) &amp;&amp; !pkg.isUpdatedSystemApp() &amp;&amp;</span><br><span class="line">                pkg.applicationInfo.primaryCpuAbi == <span class="keyword">null</span>) &#123;</span><br><span class="line">            setBundledAppAbisAndRoots(pkg, pkgSetting);</span><br><span class="line">            setNativeLibraryPaths(pkg);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        <span class="keyword">if</span> ((scanFlags &amp; SCAN_MOVE) != <span class="number">0</span>) &#123;</span><br><span class="line">        </span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        setNativeLibraryPaths(pkg);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (mPlatformPackage == pkg) &#123;</span><br><span class="line">        pkg.applicationInfo.primaryCpuAbi = VMRuntime.getRuntime().is64Bit() ?</span><br><span class="line">                Build.SUPPORTED_64_BIT_ABIS[<span class="number">0</span>] : Build.SUPPORTED_32_BIT_ABIS[<span class="number">0</span>];</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> ((scanFlags &amp; SCAN_NO_DEX) == <span class="number">0</span> &amp;&amp; (scanFlags &amp; SCAN_NEW_INSTALL) != <span class="number">0</span>) &#123;</span><br><span class="line">        <span class="keyword">if</span> (cpuAbiOverride == <span class="keyword">null</span> &amp;&amp; pkgSetting.cpuAbiOverrideString != <span class="keyword">null</span>) &#123;</span><br><span class="line">            Slog.w(TAG, <span class="string">"Ignoring persisted ABI override "</span> + cpuAbiOverride +</span><br><span class="line">                    <span class="string">" for package "</span> + pkg.packageName);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    pkgSetting.primaryCpuAbiString = pkg.applicationInfo.primaryCpuAbi;</span><br><span class="line">    pkgSetting.secondaryCpuAbiString = pkg.applicationInfo.secondaryCpuAbi;</span><br><span class="line">    pkgSetting.cpuAbiOverrideString = cpuAbiOverride;</span><br><span class="line"></span><br><span class="line">    pkg.cpuAbiOverride = cpuAbiOverride;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (DEBUG_ABI_SELECTION) &#123;</span><br><span class="line">        Slog.d(TAG, <span class="string">"Resolved nativeLibraryRoot for "</span> + pkg.applicationInfo.packageName</span><br><span class="line">                + <span class="string">" to root="</span> + pkg.applicationInfo.nativeLibraryRootDir + <span class="string">", isa="</span></span><br><span class="line">                + pkg.applicationInfo.nativeLibraryRootRequiresIsa);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    pkgSetting.legacyNativeLibraryPathString = pkg.applicationInfo.nativeLibraryRootDir;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (DEBUG_ABI_SELECTION) &#123;</span><br><span class="line">        Log.d(TAG, <span class="string">"Abis for package["</span> + pkg.packageName + <span class="string">"] are"</span> +</span><br><span class="line">                <span class="string">" primary="</span> + pkg.applicationInfo.primaryCpuAbi +</span><br><span class="line">                <span class="string">" secondary="</span> + pkg.applicationInfo.secondaryCpuAbi);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> ((scanFlags &amp; SCAN_BOOTING) == <span class="number">0</span> &amp;&amp; pkgSetting.sharedUser != <span class="keyword">null</span>) &#123;</span><br><span class="line">        adjustCpuAbisForSharedUserLPw(pkgSetting.sharedUser.packages,</span><br><span class="line">                pkg, <span class="keyword">true</span> <span class="comment">/* boot complete */</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (mFactoryTest &amp;&amp; pkg.requestedPermissions.contains(</span><br><span class="line">            android.Manifest.permission.FACTORY_TEST)) &#123;</span><br><span class="line">        pkg.applicationInfo.flags |= ApplicationInfo.FLAG_FACTORY_TEST;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 如果是系统 package，设置 isOrphaned 的属性为 true！</span></span><br><span class="line">    <span class="keyword">if</span> (isSystemApp(pkg)) &#123;</span><br><span class="line">        pkgSetting.isOrphaned = <span class="keyword">true</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    ArrayList&lt;PackageParser.Package&gt; clientLibPkgs = <span class="keyword">null</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> ((scanFlags &amp; SCAN_CHECK_ONLY) != <span class="number">0</span>) &#123;</span><br><span class="line">        <span class="keyword">if</span> (nonMutatedPs != <span class="keyword">null</span>) &#123;</span><br><span class="line">            <span class="keyword">synchronized</span> (mPackages) &#123;</span><br><span class="line">                mSettings.mPackages.put(nonMutatedPs.name, nonMutatedPs);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> pkg;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 处理特权 apk 的子包，只有特权 apk 才能添加子包；</span></span><br><span class="line">    <span class="comment">// 特权 apk 包括两部分：</span></span><br><span class="line">    <span class="comment">// 1、特定 uid 的 app</span></span><br><span class="line">    <span class="comment">// 2、framework-res.apk 和 system/priv-app 目录下的 apk！</span></span><br><span class="line">    <span class="keyword">if</span> (pkg.childPackages != <span class="keyword">null</span> &amp;&amp; !pkg.childPackages.isEmpty()) &#123;</span><br><span class="line">        <span class="keyword">if</span> ((policyFlags &amp; PARSE_IS_PRIVILEGED) == <span class="number">0</span>) &#123;</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> PackageManagerException(<span class="string">"Only privileged apps and updated "</span></span><br><span class="line">                    + <span class="string">"privileged apps can add child packages. Ignoring package "</span></span><br><span class="line">                    + pkg.packageName);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">final</span> <span class="keyword">int</span> childCount = pkg.childPackages.size();</span><br><span class="line">        <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; childCount; i++) &#123;</span><br><span class="line">            PackageParser.Package childPkg = pkg.childPackages.get(i);</span><br><span class="line">            <span class="keyword">if</span> (mSettings.hasOtherDisabledSystemPkgWithChildLPr(pkg.packageName,</span><br><span class="line">                    childPkg.packageName)) &#123;</span><br><span class="line">                <span class="keyword">throw</span> <span class="keyword">new</span> PackageManagerException(<span class="string">"Cannot override a child package of "</span></span><br><span class="line">                        + <span class="string">"another disabled system app. Ignoring package "</span> + pkg.packageName);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">synchronized</span> (mPackages) &#123;</span><br><span class="line">        <span class="keyword">if</span> ((pkg.applicationInfo.flags&amp;ApplicationInfo.FLAG_SYSTEM) != <span class="number">0</span>) &#123;</span><br><span class="line"></span><br><span class="line">            <span class="comment">// 如果是系统 package，并且他之前更新过，就要尝试对共享库 lib 进行更新！</span></span><br><span class="line">            <span class="comment">// 只有系统 package 才能添加共享 lib</span></span><br><span class="line">            <span class="keyword">if</span> (pkg.libraryNames != <span class="keyword">null</span>) &#123;</span><br><span class="line">                <span class="keyword">for</span> (<span class="keyword">int</span> i=<span class="number">0</span>; i&lt;pkg.libraryNames.size(); i++) &#123;</span><br><span class="line">                    String name = pkg.libraryNames.get(i);</span><br><span class="line">                    <span class="keyword">boolean</span> allowed = <span class="keyword">false</span>;</span><br><span class="line">                    <span class="keyword">if</span> (pkg.isUpdatedSystemApp()) &#123;</span><br><span class="line">                    </span><br><span class="line">                        <span class="comment">// New library entries can only be added through the</span></span><br><span class="line">                        <span class="comment">// system image.  This is important to get rid of a lot</span></span><br><span class="line">                        <span class="comment">// of nasty edge cases: for example if we allowed a non-</span></span><br><span class="line">                        <span class="comment">// system update of the app to add a library, then uninstalling</span></span><br><span class="line">                        <span class="comment">// the update would make the library go away, and assumptions</span></span><br><span class="line">                        <span class="comment">// we made such as through app install filtering would now</span></span><br><span class="line">                        <span class="comment">// have allowed apps on the device which aren't compatible</span></span><br><span class="line">                        <span class="comment">// with it.  Better to just have the restriction here, be</span></span><br><span class="line">                        <span class="comment">// conservative, and create many fewer cases that can negatively</span></span><br><span class="line">                        <span class="comment">// impact the user experience.</span></span><br><span class="line">                        <span class="keyword">final</span> PackageSetting sysPs = mSettings</span><br><span class="line">                                .getDisabledSystemPkgLPr(pkg.packageName);</span><br><span class="line">                        <span class="keyword">if</span> (sysPs.pkg != <span class="keyword">null</span> &amp;&amp; sysPs.pkg.libraryNames != <span class="keyword">null</span>) &#123;</span><br><span class="line">                            <span class="keyword">for</span> (<span class="keyword">int</span> j=<span class="number">0</span>; j&lt;sysPs.pkg.libraryNames.size(); j++) &#123;</span><br><span class="line">                                <span class="keyword">if</span> (name.equals(sysPs.pkg.libraryNames.get(j))) &#123;</span><br><span class="line">                                    allowed = <span class="keyword">true</span>;</span><br><span class="line">                                    <span class="keyword">break</span>;</span><br><span class="line">                                &#125;</span><br><span class="line">                            &#125;</span><br><span class="line">                        &#125;</span><br><span class="line">                    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                        allowed = <span class="keyword">true</span>;</span><br><span class="line">                    &#125;</span><br><span class="line">                    <span class="keyword">if</span> (allowed) &#123;</span><br><span class="line">                        <span class="keyword">if</span> (!mSharedLibraries.containsKey(name)) &#123;</span><br><span class="line">                            mSharedLibraries.put(name, <span class="keyword">new</span> SharedLibraryEntry(<span class="keyword">null</span>, pkg.packageName));</span><br><span class="line">                            </span><br><span class="line">                        &#125; <span class="keyword">else</span> <span class="keyword">if</span> (!name.equals(pkg.packageName)) &#123;</span><br><span class="line">                            Slog.w(TAG, <span class="string">"Package "</span> + pkg.packageName + <span class="string">" library "</span></span><br><span class="line">                                    + name + <span class="string">" already exists; skipping"</span>);</span><br><span class="line">                        &#125;</span><br><span class="line">                    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                        Slog.w(TAG, <span class="string">"Package "</span> + pkg.packageName + <span class="string">" declares lib "</span></span><br><span class="line">                                + name + <span class="string">" that is not declared on system image; skipping"</span>);</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;</span><br><span class="line">                <span class="keyword">if</span> ((scanFlags &amp; SCAN_BOOTING) == <span class="number">0</span>) &#123;</span><br><span class="line"></span><br><span class="line">                    <span class="comment">// If we are not booting, we need to update any applications</span></span><br><span class="line">                    <span class="comment">// that are clients of our shared library.  If we are booting,</span></span><br><span class="line">                    <span class="comment">// this will all be done once the scan is complete.</span></span><br><span class="line">                    clientLibPkgs = updateAllSharedLibrariesLPw(pkg);</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> ((scanFlags &amp; SCAN_BOOTING) != <span class="number">0</span>) &#123;</span><br><span class="line">    &#125; <span class="keyword">else</span> <span class="keyword">if</span> ((scanFlags &amp; SCAN_DONT_KILL_APP) != <span class="number">0</span>) &#123;</span><br><span class="line">    &#125; <span class="keyword">else</span> <span class="keyword">if</span> ((scanFlags &amp; SCAN_IGNORE_FROZEN) != <span class="number">0</span>) &#123;</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        <span class="comment">// 尝试去冻结 apk！</span></span><br><span class="line">        checkPackageFrozen(pkgName);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (clientLibPkgs != <span class="keyword">null</span>) &#123;</span><br><span class="line">        <span class="keyword">for</span> (<span class="keyword">int</span> i=<span class="number">0</span>; i&lt;clientLibPkgs.size(); i++) &#123;</span><br><span class="line">            PackageParser.Package clientPkg = clientLibPkgs.get(i);</span><br><span class="line">            killApplication(clientPkg.applicationInfo.packageName,</span><br><span class="line">                    clientPkg.applicationInfo.uid, <span class="string">"update lib"</span>);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// Make sure we're not adding any bogus keyset info</span></span><br><span class="line">    KeySetManagerService ksms = mSettings.mKeySetManagerService;</span><br><span class="line">    ksms.assertScannedPackageValid(pkg);</span><br><span class="line"></span><br><span class="line">    <span class="comment">// writer</span></span><br><span class="line">    Trace.traceBegin(TRACE_TAG_PACKAGE_MANAGER, <span class="string">"updateSettings"</span>);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">boolean</span> createIdmapFailed = <span class="keyword">false</span>;</span><br><span class="line">    <span class="keyword">synchronized</span> (mPackages) &#123;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// We don't expect installation to fail beyond this point</span></span><br><span class="line">        <span class="keyword">if</span> (pkgSetting.pkg != <span class="keyword">null</span>) &#123;</span><br><span class="line"></span><br><span class="line">            <span class="comment">// Note that |user| might be null during the initial boot scan. If a codePath</span></span><br><span class="line">            <span class="comment">// for an app has changed during a boot scan, it's due to an app update that's</span></span><br><span class="line">            <span class="comment">// part of the system partition and marker changes must be applied to all users.</span></span><br><span class="line">            maybeRenameForeignDexMarkers(pkgSetting.pkg, pkg,</span><br><span class="line">                (user != <span class="keyword">null</span>) ? user : UserHandle.ALL);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment">//【×】将新创建的 PackageSetting 添加到 mSettings 中！</span></span><br><span class="line">        mSettings.insertPackageSettingLPw(pkgSetting, pkg);</span><br><span class="line">        </span><br><span class="line">        <span class="comment">// 将新创建的 PackageSetting 添加到 PMS.mPackages 中！</span></span><br><span class="line">        mPackages.put(pkg.applicationInfo.packageName, pkg);</span><br><span class="line">        </span><br><span class="line">        <span class="comment">// 将当前的 package 从 mSettings.mPackagesToBeCleaned 中移除，防止数据清除！</span></span><br><span class="line">        <span class="keyword">final</span> Iterator&lt;PackageCleanItem&gt; iter = mSettings.mPackagesToBeCleaned.iterator();</span><br><span class="line">        <span class="keyword">while</span> (iter.hasNext()) &#123;</span><br><span class="line">            PackageCleanItem item = iter.next();</span><br><span class="line">            <span class="keyword">if</span> (pkgName.equals(item.packageName)) &#123;</span><br><span class="line">                iter.remove();</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 处理 package 的第一次安装时间和最近更新时间！</span></span><br><span class="line">        <span class="keyword">if</span> (currentTime != <span class="number">0</span>) &#123;</span><br><span class="line">            <span class="keyword">if</span> (pkgSetting.firstInstallTime == <span class="number">0</span>) &#123;</span><br><span class="line">                pkgSetting.firstInstallTime = pkgSetting.lastUpdateTime = currentTime;</span><br><span class="line"></span><br><span class="line">            &#125; <span class="keyword">else</span> <span class="keyword">if</span> ((scanFlags&amp;SCAN_UPDATE_TIME) != <span class="number">0</span>) &#123;</span><br><span class="line">                pkgSetting.lastUpdateTime = currentTime;</span><br><span class="line"></span><br><span class="line">            &#125;</span><br><span class="line">        &#125; <span class="keyword">else</span> <span class="keyword">if</span> (pkgSetting.firstInstallTime == <span class="number">0</span>) &#123;</span><br><span class="line">        </span><br><span class="line">            <span class="comment">// We need *something*.  Take time time stamp of the file.</span></span><br><span class="line">            pkgSetting.firstInstallTime = pkgSetting.lastUpdateTime = scanFileTime;</span><br><span class="line">            </span><br><span class="line">        &#125; <span class="keyword">else</span> <span class="keyword">if</span> ((policyFlags&amp;PackageParser.PARSE_IS_SYSTEM_DIR) != <span class="number">0</span>) &#123;</span><br><span class="line">            <span class="keyword">if</span> (scanFileTime != pkgSetting.timeStamp) &#123;</span><br><span class="line"></span><br><span class="line">                <span class="comment">// A package on the system image has changed; consider this</span></span><br><span class="line">                <span class="comment">// to be an update.</span></span><br><span class="line">                pkgSetting.lastUpdateTime = scanFileTime;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// Add the package's KeySets to the global KeySetManagerService</span></span><br><span class="line">        ksms.addScannedPackageLPw(pkg);</span><br><span class="line">        </span><br><span class="line">        <span class="comment">// 处理该 Package 中 的 Provider 信息，添加到 mProviders 中！</span></span><br><span class="line">        <span class="keyword">int</span> N = pkg.providers.size();</span><br><span class="line">        StringBuilder r = <span class="keyword">null</span>;</span><br><span class="line">        <span class="keyword">int</span> i;</span><br><span class="line">        <span class="keyword">for</span> (i=<span class="number">0</span>; i&lt;N; i++) &#123;</span><br><span class="line">            PackageParser.Provider p = pkg.providers.get(i);</span><br><span class="line">            p.info.processName = fixProcessName(pkg.applicationInfo.processName,</span><br><span class="line">                    p.info.processName, pkg.applicationInfo.uid);</span><br><span class="line">            mProviders.addProvider(p);</span><br><span class="line">            p.syncable = p.info.isSyncable;</span><br><span class="line">            <span class="keyword">if</span> (p.info.authority != <span class="keyword">null</span>) &#123;</span><br><span class="line">                String names[] = p.info.authority.split(<span class="string">";"</span>);</span><br><span class="line">                p.info.authority = <span class="keyword">null</span>;</span><br><span class="line">                <span class="keyword">for</span> (<span class="keyword">int</span> j = <span class="number">0</span>; j &lt; names.length; j++) &#123;</span><br><span class="line">                    <span class="keyword">if</span> (j == <span class="number">1</span> &amp;&amp; p.syncable) &#123;</span><br><span class="line">                    </span><br><span class="line">                        <span class="comment">// We only want the first authority for a provider to possibly be</span></span><br><span class="line">                        <span class="comment">// syncable, so if we already added this provider using a different</span></span><br><span class="line">                        <span class="comment">// authority clear the syncable flag. We copy the provider before</span></span><br><span class="line">                        <span class="comment">// changing it because the mProviders object contains a reference</span></span><br><span class="line">                        <span class="comment">// to a provider that we don't want to change.</span></span><br><span class="line">                        <span class="comment">// Only do this for the second authority since the resulting provider</span></span><br><span class="line">                        <span class="comment">// object can be the same for all future authorities for this provider.</span></span><br><span class="line">                        p = <span class="keyword">new</span> PackageParser.Provider(p);</span><br><span class="line">                        p.syncable = <span class="keyword">false</span>;</span><br><span class="line">                    &#125;</span><br><span class="line">                    <span class="keyword">if</span> (!mProvidersByAuthority.containsKey(names[j])) &#123;</span><br><span class="line">                        mProvidersByAuthority.put(names[j], p);</span><br><span class="line">                        <span class="keyword">if</span> (p.info.authority == <span class="keyword">null</span>) &#123;</span><br><span class="line">                            p.info.authority = names[j];</span><br><span class="line">                        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                            p.info.authority = p.info.authority + <span class="string">";"</span> + names[j];</span><br><span class="line">                        &#125;</span><br><span class="line">                        <span class="keyword">if</span> (DEBUG_PACKAGE_SCANNING) &#123;</span><br><span class="line">                            <span class="keyword">if</span> ((policyFlags &amp; PackageParser.PARSE_CHATTY) != <span class="number">0</span>)</span><br><span class="line">                                Log.d(TAG, <span class="string">"Registered content provider: "</span> + names[j]</span><br><span class="line">                                        + <span class="string">", className = "</span> + p.info.name + <span class="string">", isSyncable = "</span></span><br><span class="line">                                        + p.info.isSyncable);</span><br><span class="line">                        &#125;</span><br><span class="line">                    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                        PackageParser.Provider other = mProvidersByAuthority.get(names[j]);</span><br><span class="line">                        Slog.w(TAG, <span class="string">"Skipping provider name "</span> + names[j] +</span><br><span class="line">                                <span class="string">" (in package "</span> + pkg.applicationInfo.packageName +</span><br><span class="line">                                <span class="string">"): name already used by "</span></span><br><span class="line">                                + ((other != <span class="keyword">null</span> &amp;&amp; other.getComponentName() != <span class="keyword">null</span>)</span><br><span class="line">                                        ? other.getComponentName().getPackageName() : <span class="string">"?"</span>));</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">if</span> ((policyFlags&amp;PackageParser.PARSE_CHATTY) != <span class="number">0</span>) &#123;</span><br><span class="line">                <span class="keyword">if</span> (r == <span class="keyword">null</span>) &#123;</span><br><span class="line">                    r = <span class="keyword">new</span> StringBuilder(<span class="number">256</span>);</span><br><span class="line">                &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                    r.append(<span class="string">' '</span>);</span><br><span class="line">                &#125;</span><br><span class="line">                r.append(p.info.name);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">if</span> (r != <span class="keyword">null</span>) &#123;</span><br><span class="line">            <span class="keyword">if</span> (DEBUG_PACKAGE_SCANNING) Log.d(TAG, <span class="string">"  Providers: "</span> + r);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 处理该 Package 中的 Service 信息，添加到 PMS.mService 中！</span></span><br><span class="line">        N = pkg.services.size();</span><br><span class="line">        r = <span class="keyword">null</span>;</span><br><span class="line">        <span class="keyword">for</span> (i=<span class="number">0</span>; i&lt;N; i++) &#123;</span><br><span class="line">            PackageParser.Service s = pkg.services.get(i);</span><br><span class="line">            s.info.processName = fixProcessName(pkg.applicationInfo.processName,</span><br><span class="line">                    s.info.processName, pkg.applicationInfo.uid);</span><br><span class="line">            mServices.addService(s);</span><br><span class="line">            <span class="keyword">if</span> ((policyFlags&amp;PackageParser.PARSE_CHATTY) != <span class="number">0</span>) &#123;</span><br><span class="line">                <span class="keyword">if</span> (r == <span class="keyword">null</span>) &#123;</span><br><span class="line">                    r = <span class="keyword">new</span> StringBuilder(<span class="number">256</span>);</span><br><span class="line">                &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                    r.append(<span class="string">' '</span>);</span><br><span class="line">                &#125;</span><br><span class="line">                r.append(s.info.name);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">if</span> (r != <span class="keyword">null</span>) &#123;</span><br><span class="line">            <span class="keyword">if</span> (DEBUG_PACKAGE_SCANNING) Log.d(TAG, <span class="string">"  Services: "</span> + r);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 处理该 Package 中的 BroadcastReceiver 信息,添加到 PMS.mReceivers 中。</span></span><br><span class="line">        N = pkg.receivers.size();</span><br><span class="line">        r = <span class="keyword">null</span>;</span><br><span class="line">        <span class="keyword">for</span> (i=<span class="number">0</span>; i&lt;N; i++) &#123;</span><br><span class="line">            PackageParser.Activity a = pkg.receivers.get(i);</span><br><span class="line">            a.info.processName = fixProcessName(pkg.applicationInfo.processName,</span><br><span class="line">                    a.info.processName, pkg.applicationInfo.uid);</span><br><span class="line">            mReceivers.addActivity(a, <span class="string">"receiver"</span>);</span><br><span class="line">            <span class="keyword">if</span> ((policyFlags&amp;PackageParser.PARSE_CHATTY) != <span class="number">0</span>) &#123;</span><br><span class="line">                <span class="keyword">if</span> (r == <span class="keyword">null</span>) &#123;</span><br><span class="line">                    r = <span class="keyword">new</span> StringBuilder(<span class="number">256</span>);</span><br><span class="line">                &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                    r.append(<span class="string">' '</span>);</span><br><span class="line">                &#125;</span><br><span class="line">                r.append(a.info.name);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">if</span> (r != <span class="keyword">null</span>) &#123;</span><br><span class="line">            <span class="keyword">if</span> (DEBUG_PACKAGE_SCANNING) Log.d(TAG, <span class="string">"  Receivers: "</span> + r);</span><br><span class="line">        &#125;</span><br><span class="line">        </span><br><span class="line">        <span class="comment">// 处理该 Package 中的 activity 信息，添加到 PMS.mActivities 中！</span></span><br><span class="line">        N = pkg.activities.size();</span><br><span class="line">        r = <span class="keyword">null</span>;</span><br><span class="line">        <span class="keyword">for</span> (i=<span class="number">0</span>; i&lt;N; i++) &#123;</span><br><span class="line">            PackageParser.Activity a = pkg.activities.get(i);</span><br><span class="line">            a.info.processName = fixProcessName(pkg.applicationInfo.processName,</span><br><span class="line">                    a.info.processName, pkg.applicationInfo.uid);</span><br><span class="line">            mActivities.addActivity(a, <span class="string">"activity"</span>);</span><br><span class="line">            <span class="keyword">if</span> ((policyFlags&amp;PackageParser.PARSE_CHATTY) != <span class="number">0</span>) &#123;</span><br><span class="line">                <span class="keyword">if</span> (r == <span class="keyword">null</span>) &#123;</span><br><span class="line">                    r = <span class="keyword">new</span> StringBuilder(<span class="number">256</span>);</span><br><span class="line">                &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                    r.append(<span class="string">' '</span>);</span><br><span class="line">                &#125;</span><br><span class="line">                r.append(a.info.name);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">if</span> (r != <span class="keyword">null</span>) &#123;</span><br><span class="line">            <span class="keyword">if</span> (DEBUG_PACKAGE_SCANNING) Log.d(TAG, <span class="string">"  Activities: "</span> + r);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 处理该 Package 中的 PermissionGroups 信息</span></span><br><span class="line">        N = pkg.permissionGroups.size();</span><br><span class="line">        r = <span class="keyword">null</span>;</span><br><span class="line">        <span class="keyword">for</span> (i=<span class="number">0</span>; i&lt;N; i++) &#123;</span><br><span class="line">            PackageParser.PermissionGroup pg = pkg.permissionGroups.get(i);</span><br><span class="line">            PackageParser.PermissionGroup cur = mPermissionGroups.get(pg.info.name);</span><br><span class="line">            <span class="keyword">final</span> String curPackageName = cur == <span class="keyword">null</span> ? <span class="keyword">null</span> : cur.info.packageName;</span><br><span class="line">            <span class="keyword">final</span> <span class="keyword">boolean</span> isPackageUpdate = pg.info.packageName.equals(curPackageName);</span><br><span class="line">            <span class="keyword">if</span> (cur == <span class="keyword">null</span> || isPackageUpdate) &#123;</span><br><span class="line">                mPermissionGroups.put(pg.info.name, pg);</span><br><span class="line">                <span class="keyword">if</span> ((policyFlags&amp;PackageParser.PARSE_CHATTY) != <span class="number">0</span>) &#123;</span><br><span class="line">                    <span class="keyword">if</span> (r == <span class="keyword">null</span>) &#123;</span><br><span class="line">                        r = <span class="keyword">new</span> StringBuilder(<span class="number">256</span>);</span><br><span class="line">                    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                        r.append(<span class="string">' '</span>);</span><br><span class="line">                    &#125;</span><br><span class="line">                    <span class="keyword">if</span> (isPackageUpdate) &#123;</span><br><span class="line">                        r.append(<span class="string">"UPD:"</span>);</span><br><span class="line">                    &#125;</span><br><span class="line">                    r.append(pg.info.name);</span><br><span class="line">                &#125;</span><br><span class="line">            &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                Slog.w(TAG, <span class="string">"Permission group "</span> + pg.info.name + <span class="string">" from package "</span></span><br><span class="line">                        + pg.info.packageName + <span class="string">" ignored: original from "</span></span><br><span class="line">                        + cur.info.packageName);</span><br><span class="line">                <span class="keyword">if</span> ((policyFlags&amp;PackageParser.PARSE_CHATTY) != <span class="number">0</span>) &#123;</span><br><span class="line">                    <span class="keyword">if</span> (r == <span class="keyword">null</span>) &#123;</span><br><span class="line">                        r = <span class="keyword">new</span> StringBuilder(<span class="number">256</span>);</span><br><span class="line">                    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                        r.append(<span class="string">' '</span>);</span><br><span class="line">                    &#125;</span><br><span class="line">                    r.append(<span class="string">"DUP:"</span>);</span><br><span class="line">                    r.append(pg.info.name);</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">if</span> (r != <span class="keyword">null</span>) &#123;</span><br><span class="line">            <span class="keyword">if</span> (DEBUG_PACKAGE_SCANNING) Log.d(TAG, <span class="string">"  Permission Groups: "</span> + r);</span><br><span class="line">        &#125;</span><br><span class="line">        </span><br><span class="line">        <span class="comment">// 处理该 Package 中的 Permissions 信息！</span></span><br><span class="line">        N = pkg.permissions.size();</span><br><span class="line">        r = <span class="keyword">null</span>;</span><br><span class="line">        <span class="keyword">for</span> (i=<span class="number">0</span>; i&lt;N; i++) &#123;</span><br><span class="line">            PackageParser.Permission p = pkg.permissions.get(i);</span><br><span class="line"></span><br><span class="line">            <span class="comment">// Assume by default that we did not install this permission into the system.</span></span><br><span class="line">            p.info.flags &amp;= ~PermissionInfo.FLAG_INSTALLED;</span><br><span class="line"></span><br><span class="line">            <span class="comment">// Now that permission groups have a special meaning, we ignore permission</span></span><br><span class="line">            <span class="comment">// groups for legacy apps to prevent unexpected behavior. In particular,</span></span><br><span class="line">            <span class="comment">// permissions for one app being granted to someone just becase they happen</span></span><br><span class="line">            <span class="comment">// to be in a group defined by another app (before this had no implications).</span></span><br><span class="line">            <span class="keyword">if</span> (pkg.applicationInfo.targetSdkVersion &gt; Build.VERSION_CODES.LOLLIPOP_MR1) &#123;</span><br><span class="line">                p.group = mPermissionGroups.get(p.info.group);</span><br><span class="line">                <span class="comment">// Warn for a permission in an unknown group.</span></span><br><span class="line">                <span class="keyword">if</span> (p.info.group != <span class="keyword">null</span> &amp;&amp; p.group == <span class="keyword">null</span>) &#123;</span><br><span class="line">                    Slog.w(TAG, <span class="string">"Permission "</span> + p.info.name + <span class="string">" from package "</span></span><br><span class="line">                            + p.info.packageName + <span class="string">" in an unknown group "</span> + p.info.group);</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            <span class="comment">// 从 Settings 中获得权限管理集合！</span></span><br><span class="line">            ArrayMap&lt;String, BasePermission&gt; permissionMap =</span><br><span class="line">                    p.tree ? mSettings.mPermissionTrees</span><br><span class="line">                            : mSettings.mPermissions;</span><br><span class="line"></span><br><span class="line">            <span class="comment">// 获得 package 的权限对应的 BasePermission 对象！</span></span><br><span class="line">            BasePermission bp = permissionMap.get(p.info.name);</span><br><span class="line"></span><br><span class="line">            <span class="comment">// Allow system apps to redefine non-system permissions</span></span><br><span class="line">            <span class="comment">// BasePermission 不为 null，且当前解析的 package 也不是权限的定义者！</span></span><br><span class="line">            <span class="keyword">if</span> (bp != <span class="keyword">null</span> &amp;&amp; !Objects.equals(bp.sourcePackage, p.info.packageName)) &#123;</span><br><span class="line">            </span><br><span class="line">                <span class="keyword">final</span> <span class="keyword">boolean</span> currentOwnerIsSystem = (bp.perm != <span class="keyword">null</span></span><br><span class="line">                        &amp;&amp; isSystemApp(bp.perm.owner));</span><br><span class="line">                        </span><br><span class="line">                <span class="keyword">if</span> (isSystemApp(p.owner)) </span><br><span class="line">                </span><br><span class="line">                    <span class="comment">// 如果当前 package 申请的权限拥有者是系统 app</span></span><br><span class="line">                    <span class="keyword">if</span> (bp.type == BasePermission.TYPE_BUILTIN &amp;&amp; bp.perm == <span class="keyword">null</span>) &#123;</span><br><span class="line">                        <span class="comment">// It's a built-in permission and no owner, take ownership now</span></span><br><span class="line">                        bp.packageSetting = pkgSetting;</span><br><span class="line">                        bp.perm = p;</span><br><span class="line">                        bp.uid = pkg.applicationInfo.uid;</span><br><span class="line">                        bp.sourcePackage = p.info.packageName;</span><br><span class="line">                        p.info.flags |= PermissionInfo.FLAG_INSTALLED;</span><br><span class="line">                        </span><br><span class="line">                    &#125; <span class="keyword">else</span> <span class="keyword">if</span> (!currentOwnerIsSystem) &#123;</span><br><span class="line">                        String msg = <span class="string">"New decl "</span> + p.owner + <span class="string">" of permission  "</span></span><br><span class="line">                                + p.info.name + <span class="string">" is system; overriding "</span> + bp.sourcePackage;</span><br><span class="line">                        reportSettingsProblem(Log.WARN, msg);</span><br><span class="line">                        bp = <span class="keyword">null</span>;</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            <span class="keyword">if</span> (bp == <span class="keyword">null</span>) &#123;</span><br><span class="line">                bp = <span class="keyword">new</span> BasePermission(p.info.name, p.info.packageName,</span><br><span class="line">                        BasePermission.TYPE_NORMAL);</span><br><span class="line">                permissionMap.put(p.info.name, bp);</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            <span class="keyword">if</span> (bp.perm == <span class="keyword">null</span>) &#123;</span><br><span class="line">                <span class="keyword">if</span> (bp.sourcePackage == <span class="keyword">null</span></span><br><span class="line">                        || bp.sourcePackage.equals(p.info.packageName)) &#123;</span><br><span class="line">                    BasePermission tree = findPermissionTreeLP(p.info.name);</span><br><span class="line">                    <span class="keyword">if</span> (tree == <span class="keyword">null</span></span><br><span class="line">                            || tree.sourcePackage.equals(p.info.packageName)) &#123;</span><br><span class="line">                        bp.packageSetting = pkgSetting;</span><br><span class="line">                        bp.perm = p;</span><br><span class="line">                        bp.uid = pkg.applicationInfo.uid;</span><br><span class="line">                        bp.sourcePackage = p.info.packageName;</span><br><span class="line">                        p.info.flags |= PermissionInfo.FLAG_INSTALLED;</span><br><span class="line">                        <span class="keyword">if</span> ((policyFlags&amp;PackageParser.PARSE_CHATTY) != <span class="number">0</span>) &#123;</span><br><span class="line">                            <span class="keyword">if</span> (r == <span class="keyword">null</span>) &#123;</span><br><span class="line">                                r = <span class="keyword">new</span> StringBuilder(<span class="number">256</span>);</span><br><span class="line">                            &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                                r.append(<span class="string">' '</span>);</span><br><span class="line">                            &#125;</span><br><span class="line">                            r.append(p.info.name);</span><br><span class="line">                        &#125;</span><br><span class="line">                    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                        Slog.w(TAG, <span class="string">"Permission "</span> + p.info.name + <span class="string">" from package "</span></span><br><span class="line">                                + p.info.packageName + <span class="string">" ignored: base tree "</span></span><br><span class="line">                                + tree.name + <span class="string">" is from package "</span></span><br><span class="line">                                + tree.sourcePackage);</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                    Slog.w(TAG, <span class="string">"Permission "</span> + p.info.name + <span class="string">" from package "</span></span><br><span class="line">                            + p.info.packageName + <span class="string">" ignored: original from "</span></span><br><span class="line">                            + bp.sourcePackage);</span><br><span class="line">                &#125;</span><br><span class="line">            &#125; <span class="keyword">else</span> <span class="keyword">if</span> ((policyFlags&amp;PackageParser.PARSE_CHATTY) != <span class="number">0</span>) &#123;</span><br><span class="line">                <span class="keyword">if</span> (r == <span class="keyword">null</span>) &#123;</span><br><span class="line">                    r = <span class="keyword">new</span> StringBuilder(<span class="number">256</span>);</span><br><span class="line">                &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                    r.append(<span class="string">' '</span>);</span><br><span class="line">                &#125;</span><br><span class="line">                r.append(<span class="string">"DUP:"</span>);</span><br><span class="line">                r.append(p.info.name);</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">if</span> (bp.perm == p) &#123;</span><br><span class="line">                bp.protectionLevel = p.info.protectionLevel;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (r != <span class="keyword">null</span>) &#123;</span><br><span class="line">            <span class="keyword">if</span> (DEBUG_PACKAGE_SCANNING) Log.d(TAG, <span class="string">"  Permissions: "</span> + r);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        N = pkg.instrumentation.size();</span><br><span class="line">        r = <span class="keyword">null</span>;</span><br><span class="line">        <span class="keyword">for</span> (i=<span class="number">0</span>; i&lt;N; i++) &#123;</span><br><span class="line">            PackageParser.Instrumentation a = pkg.instrumentation.get(i);</span><br><span class="line">            a.info.packageName = pkg.applicationInfo.packageName;</span><br><span class="line">            a.info.sourceDir = pkg.applicationInfo.sourceDir;</span><br><span class="line">            a.info.publicSourceDir = pkg.applicationInfo.publicSourceDir;</span><br><span class="line">            a.info.splitSourceDirs = pkg.applicationInfo.splitSourceDirs;</span><br><span class="line">            a.info.splitPublicSourceDirs = pkg.applicationInfo.splitPublicSourceDirs;</span><br><span class="line">            a.info.dataDir = pkg.applicationInfo.dataDir;</span><br><span class="line">            a.info.deviceProtectedDataDir = pkg.applicationInfo.deviceProtectedDataDir;</span><br><span class="line">            a.info.credentialProtectedDataDir = pkg.applicationInfo.credentialProtectedDataDir;</span><br><span class="line"></span><br><span class="line">            a.info.nativeLibraryDir = pkg.applicationInfo.nativeLibraryDir;</span><br><span class="line">            a.info.secondaryNativeLibraryDir = pkg.applicationInfo.secondaryNativeLibraryDir;</span><br><span class="line">            mInstrumentation.put(a.getComponentName(), a);</span><br><span class="line">            <span class="keyword">if</span> ((policyFlags&amp;PackageParser.PARSE_CHATTY) != <span class="number">0</span>) &#123;</span><br><span class="line">                <span class="keyword">if</span> (r == <span class="keyword">null</span>) &#123;</span><br><span class="line">                    r = <span class="keyword">new</span> StringBuilder(<span class="number">256</span>);</span><br><span class="line">                &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                    r.append(<span class="string">' '</span>);</span><br><span class="line">                &#125;</span><br><span class="line">                r.append(a.info.name);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">if</span> (r != <span class="keyword">null</span>) &#123;</span><br><span class="line">            <span class="keyword">if</span> (DEBUG_PACKAGE_SCANNING) Log.d(TAG, <span class="string">"  Instrumentation: "</span> + r);</span><br><span class="line">        &#125;</span><br><span class="line">        </span><br><span class="line">        <span class="comment">// 处理该 Package 中的 protectedBroadcasts 信息！</span></span><br><span class="line">        <span class="keyword">if</span> (pkg.protectedBroadcasts != <span class="keyword">null</span>) &#123;</span><br><span class="line">            N = pkg.protectedBroadcasts.size();</span><br><span class="line">            <span class="keyword">for</span> (i=<span class="number">0</span>; i&lt;N; i++) &#123;</span><br><span class="line">                mProtectedBroadcasts.add(pkg.protectedBroadcasts.get(i));</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        pkgSetting.setTimeStamp(scanFileTime);</span><br><span class="line"></span><br><span class="line">        <span class="comment">// Create idmap files for pairs of (packages, overlay packages).</span></span><br><span class="line">        <span class="comment">// Note: "android", ie framework-res.apk, is handled by native layers.</span></span><br><span class="line">        <span class="keyword">if</span> (pkg.mOverlayTarget != <span class="keyword">null</span>) &#123;</span><br><span class="line">            <span class="comment">// This is an overlay package.</span></span><br><span class="line">            <span class="keyword">if</span> (pkg.mOverlayTarget != <span class="keyword">null</span> &amp;&amp; !pkg.mOverlayTarget.equals(<span class="string">"android"</span>)) &#123;</span><br><span class="line">                <span class="keyword">if</span> (!mOverlays.containsKey(pkg.mOverlayTarget)) &#123;</span><br><span class="line">                    mOverlays.put(pkg.mOverlayTarget,</span><br><span class="line">                            <span class="keyword">new</span> ArrayMap&lt;String, PackageParser.Package&gt;());</span><br><span class="line">                &#125;</span><br><span class="line">                ArrayMap&lt;String, PackageParser.Package&gt; map = mOverlays.get(pkg.mOverlayTarget);</span><br><span class="line">                map.put(pkg.packageName, pkg);</span><br><span class="line">                PackageParser.Package orig = mPackages.get(pkg.mOverlayTarget);</span><br><span class="line">                <span class="keyword">if</span> (orig != <span class="keyword">null</span> &amp;&amp; !createIdmapForPackagePairLI(orig, pkg)) &#123;</span><br><span class="line">                    createIdmapFailed = <span class="keyword">true</span>;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125; <span class="keyword">else</span> <span class="keyword">if</span> (mOverlays.containsKey(pkg.packageName) &amp;&amp;</span><br><span class="line">                !pkg.packageName.equals(<span class="string">"android"</span>)) &#123;</span><br><span class="line">            <span class="comment">// This is a regular package, with one or more known overlay packages.</span></span><br><span class="line">            createIdmapsForPackageLI(pkg);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    Trace.traceEnd(TRACE_TAG_PACKAGE_MANAGER);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (createIdmapFailed) &#123;</span><br><span class="line">        <span class="keyword">throw</span> <span class="keyword">new</span> PackageManagerException(INSTALL_FAILED_UPDATE_INCOMPATIBLE,</span><br><span class="line">                <span class="string">"scanPackageLI failed to createIdmap"</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> pkg;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h3 id="1-3-1-Settings-getPackageLPw"><a href="#1-3-1-Settings-getPackageLPw" class="headerlink" title="1.3.1 Settings.getPackageLPw"></a>1.3.1 Settings.getPackageLPw</h3><p>上面又再次调用了 getPackageLPw 方法，注意根据参数传递：</p>
<ul>
<li>boolean add：传入的值为 false！</li>
<li>boolean allowInstall：传入的值为 true；</li>
</ul>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 最终进入这个方法！</span></span><br><span class="line"><span class="function"><span class="keyword">private</span> PackageSetting <span class="title">getPackageLPw</span><span class="params">(String name, PackageSetting origPackage,</span></span></span><br><span class="line"><span class="function"><span class="params">        String realName, SharedUserSetting sharedUser, File codePath, File resourcePath,</span></span></span><br><span class="line"><span class="function"><span class="params">        String legacyNativeLibraryPathString, String primaryCpuAbiString,</span></span></span><br><span class="line"><span class="function"><span class="params">        String secondaryCpuAbiString, <span class="keyword">int</span> vc, <span class="keyword">int</span> pkgFlags, <span class="keyword">int</span> pkgPrivateFlags,</span></span></span><br><span class="line"><span class="function"><span class="params">        UserHandle installUser, <span class="keyword">boolean</span> add, <span class="keyword">boolean</span> allowInstall, String parentPackage,</span></span></span><br><span class="line"><span class="function"><span class="params">        List&lt;String&gt; childPackageNames)</span> </span>&#123;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// 尝试获得之前的安装数据！</span></span><br><span class="line">    <span class="comment">// 如果是非系统 apk，这个安装就是他自身的；如果是覆盖安装的系统 app，那么这个数据是 data 分区下的；</span></span><br><span class="line">    PackageSetting p = mPackages.get(name);</span><br><span class="line">    UserManagerService userManager = UserManagerService.getInstance();</span><br><span class="line">    </span><br><span class="line">    <span class="comment">//【×】如果 p 不为 null，说明这个 data 分区的 apk 之前就存在，它可能是一个非系统 apk；</span></span><br><span class="line">    <span class="comment">// 也可能是一个系统的 apk 覆盖安装到了 data 分区！</span></span><br><span class="line">    <span class="keyword">if</span> (p != <span class="keyword">null</span>) &#123;</span><br><span class="line">        p.primaryCpuAbiString = primaryCpuAbiString;</span><br><span class="line">        p.secondaryCpuAbiString = secondaryCpuAbiString;</span><br><span class="line">        <span class="keyword">if</span> (childPackageNames != <span class="keyword">null</span>) &#123;</span><br><span class="line">            p.childPackageNames = <span class="keyword">new</span> ArrayList&lt;&gt;(childPackageNames);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 对于扫描 data 分区的情况，如果 codePath 不匹配，会在【1.3】【B】的位置抛出异常，也就是说会忽略掉这个包！</span></span><br><span class="line">        <span class="comment">// 这里是不会进入的！！</span></span><br><span class="line">        <span class="keyword">if</span> (!p.codePath.equals(codePath)) &#123;</span><br><span class="line">            <span class="keyword">if</span> ((p.pkgFlags &amp; ApplicationInfo.FLAG_SYSTEM) != <span class="number">0</span>) &#123;</span><br><span class="line">                Slog.w(PackageManagerService.TAG, <span class="string">"Trying to update system app code path from "</span></span><br><span class="line">                        + p.codePathString + <span class="string">" to "</span> + codePath.toString());</span><br><span class="line">            &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                Slog.i(PackageManagerService.TAG, <span class="string">"Package "</span> + name + <span class="string">" codePath changed from "</span></span><br><span class="line">                        + p.codePath + <span class="string">" to "</span> + codePath + <span class="string">"; Retaining data and using new"</span>);</span><br><span class="line"></span><br><span class="line">                <span class="keyword">if</span> ((pkgFlags &amp; ApplicationInfo.FLAG_SYSTEM) != <span class="number">0</span> &amp;&amp;</span><br><span class="line">                        getDisabledSystemPkgLPr(name) == <span class="keyword">null</span>) &#123;</span><br><span class="line">                    List&lt;UserInfo&gt; allUserInfos = getAllUsers();</span><br><span class="line">                    <span class="keyword">if</span> (allUserInfos != <span class="keyword">null</span>) &#123;</span><br><span class="line">                        <span class="keyword">for</span> (UserInfo userInfo : allUserInfos) &#123;</span><br><span class="line">                            p.setInstalled(<span class="keyword">true</span>, userInfo.id);</span><br><span class="line">                        &#125;</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;</span><br><span class="line">                p.legacyNativeLibraryPathString = legacyNativeLibraryPathString;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        </span><br><span class="line">        <span class="keyword">if</span> (p.sharedUser != sharedUser) &#123; </span><br><span class="line">            <span class="comment">// 如果共享 uid 不匹配，就需要创建新的 PackageSetting 替换以前的！</span></span><br><span class="line">            PackageManagerService.reportSettingsProblem(Log.WARN,</span><br><span class="line">                    <span class="string">"Package "</span> + name + <span class="string">" shared user changed from "</span></span><br><span class="line">                    + (p.sharedUser != <span class="keyword">null</span> ? p.sharedUser.name : <span class="string">"&lt;nothing&gt;"</span>)</span><br><span class="line">                    + <span class="string">" to "</span></span><br><span class="line">                    + (sharedUser != <span class="keyword">null</span> ? sharedUser.name : <span class="string">"&lt;nothing&gt;"</span>)</span><br><span class="line">                    + <span class="string">"; replacing with new"</span>);</span><br><span class="line">            p = <span class="keyword">null</span>;</span><br><span class="line">            </span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            <span class="comment">// 如果不是共享 uid，或者共享 uid 匹配，会进入这里：</span></span><br><span class="line">            <span class="comment">// 这里要注意：pkgFlags 是没有 FLAG_SYSTEM 标志位的，所以 pkgFlags &amp; ApplicationInfo.FLAG_SYSTEM </span></span><br><span class="line">            <span class="comment">// 会置空该标志，但是由于 | 的特性，并没有影响上一次安装信息的 pkgFlags 位！</span></span><br><span class="line">            <span class="comment">// 就是说如果是覆盖更新的 system app，即使扫描了 data 分区，也不会取消 FLAG_SYSTEM 位！</span></span><br><span class="line">            p.pkgFlags |= pkgFlags &amp; ApplicationInfo.FLAG_SYSTEM;</span><br><span class="line">            p.pkgPrivateFlags |= pkgPrivateFlags &amp; ApplicationInfo.PRIVATE_FLAG_PRIVILEGED;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//【×】如果 p == null，</span></span><br><span class="line">    <span class="comment">// 说明这个 data 分区的 apk 是新增的，比如一些 OTA 版本会在 data 分区内置一些应用！</span></span><br><span class="line">    <span class="comment">// 或者是之前的数据和最新的扫描数据比较，共享 uid 不匹配，那就需要创建新的 PackageSetting！</span></span><br><span class="line">    <span class="comment">// 或者是 system 的 app 移动到了 data 分区！</span></span><br><span class="line">    <span class="keyword">if</span> (p == <span class="keyword">null</span>) &#123;</span><br><span class="line">        <span class="keyword">if</span> (origPackage != <span class="keyword">null</span>) &#123;</span><br><span class="line">            p = <span class="keyword">new</span> PackageSetting(origPackage.name, name, codePath, resourcePath,</span><br><span class="line">                    legacyNativeLibraryPathString, primaryCpuAbiString, secondaryCpuAbiString,</span><br><span class="line">                    <span class="keyword">null</span> <span class="comment">/* cpuAbiOverrideString */</span>, vc, pkgFlags, pkgPrivateFlags,</span><br><span class="line">                    parentPackage, childPackageNames);</span><br><span class="line"></span><br><span class="line">            <span class="keyword">if</span> (PackageManagerService.DEBUG_UPGRADE) Log.v(PackageManagerService.TAG, <span class="string">"Package "</span></span><br><span class="line">                    + name + <span class="string">" is adopting original package "</span> + origPackage.name);</span><br><span class="line"></span><br><span class="line">            PackageSignatures s = p.signatures;</span><br><span class="line">            p.copyFrom(origPackage);</span><br><span class="line">            p.signatures = s;</span><br><span class="line">            p.sharedUser = origPackage.sharedUser;</span><br><span class="line">            p.appId = origPackage.appId;</span><br><span class="line">            p.origPackage = origPackage;</span><br><span class="line">            p.getPermissionsState().copyFrom(origPackage.getPermissionsState());</span><br><span class="line">            </span><br><span class="line">            <span class="comment">// 重命名为源包的名字后，将新旧名字加入 mRenamedPackages 集合！</span></span><br><span class="line">            mRenamedPackages.put(name, origPackage.name);</span><br><span class="line">            name = origPackage.name;</span><br><span class="line"></span><br><span class="line">            p.setTimeStamp(codePath.lastModified());</span><br><span class="line"></span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            <span class="comment">// 非系统 app 会进入这里，使用本次扫描的信息创建 PackageSetting！</span></span><br><span class="line">            p = <span class="keyword">new</span> PackageSetting(name, realName, codePath, resourcePath,</span><br><span class="line">                    legacyNativeLibraryPathString, primaryCpuAbiString, secondaryCpuAbiString,</span><br><span class="line">                    <span class="keyword">null</span> <span class="comment">/* cpuAbiOverrideString */</span>, vc, pkgFlags, pkgPrivateFlags,</span><br><span class="line">                    parentPackage, childPackageNames);</span><br><span class="line"></span><br><span class="line">            p.setTimeStamp(codePath.lastModified());</span><br><span class="line">            p.sharedUser = sharedUser;</span><br><span class="line"></span><br><span class="line">            <span class="comment">// 系统 apk 不会进入这个分支！</span></span><br><span class="line">            <span class="keyword">if</span> ((pkgFlags &amp; ApplicationInfo.FLAG_SYSTEM) == <span class="number">0</span>) &#123;</span><br><span class="line">                <span class="keyword">if</span> (DEBUG_STOPPED) &#123;</span><br><span class="line">                    RuntimeException e = <span class="keyword">new</span> RuntimeException(<span class="string">"here"</span>);</span><br><span class="line">                    e.fillInStackTrace();</span><br><span class="line">                    Slog.i(PackageManagerService.TAG, <span class="string">"Stopping package "</span> + name, e);</span><br><span class="line">                &#125;</span><br><span class="line">                List&lt;UserInfo&gt; users = getAllUsers();</span><br><span class="line">                <span class="keyword">final</span> <span class="keyword">int</span> installUserId = installUser != <span class="keyword">null</span> ? installUser.getIdentifier() : <span class="number">0</span>;</span><br><span class="line">                <span class="keyword">if</span> (users != <span class="keyword">null</span> &amp;&amp; allowInstall) &#123;</span><br><span class="line">                    <span class="keyword">for</span> (UserInfo user : users) &#123;</span><br><span class="line">                        <span class="keyword">final</span> <span class="keyword">boolean</span> installed = installUser == <span class="keyword">null</span></span><br><span class="line">                                || (installUserId == UserHandle.USER_ALL</span><br><span class="line">                                    &amp;&amp; !isAdbInstallDisallowed(userManager, user.id))</span><br><span class="line">                                || installUserId == user.id;</span><br><span class="line">                        p.setUserState(user.id, <span class="number">0</span>, COMPONENT_ENABLED_STATE_DEFAULT,</span><br><span class="line">                                installed,</span><br><span class="line">                                <span class="keyword">true</span>, <span class="comment">// stopped,</span></span><br><span class="line">                                <span class="keyword">true</span>, <span class="comment">// notLaunched</span></span><br><span class="line">                                <span class="keyword">false</span>, <span class="comment">// hidden</span></span><br><span class="line">                                <span class="keyword">false</span>, <span class="comment">// suspended</span></span><br><span class="line">                                <span class="keyword">null</span>, <span class="keyword">null</span>, <span class="keyword">null</span>,</span><br><span class="line">                                <span class="keyword">false</span>, <span class="comment">// blockUninstall</span></span><br><span class="line">                                INTENT_FILTER_DOMAIN_VERIFICATION_STATUS_UNDEFINED, <span class="number">0</span>);</span><br><span class="line">                        writePackageRestrictionsLPr(user.id);</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">            </span><br><span class="line">            <span class="comment">// 设置系统 package 的 appid</span></span><br><span class="line">            <span class="comment">// 如果是共享用户 id，那 appId 就是共享用户 id；</span></span><br><span class="line">            <span class="comment">// 如果不是共享用户 id，就看系统 app 是否被覆盖更新过，如果有，就克隆更新前的旧数据，初始化 appId，权限等等</span></span><br><span class="line">            <span class="comment">// 如果系统 app 没有被覆盖更新过，就创建新的 uid！</span></span><br><span class="line">            <span class="keyword">if</span> (sharedUser != <span class="keyword">null</span>) &#123;</span><br><span class="line">                p.appId = sharedUser.userId;</span><br><span class="line">                </span><br><span class="line">            &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                PackageSetting dis = mDisabledSysPackages.get(name);</span><br><span class="line">                <span class="keyword">if</span> (dis != <span class="keyword">null</span>) &#123;</span><br><span class="line">                </span><br><span class="line">                    <span class="keyword">if</span> (dis.signatures.mSignatures != <span class="keyword">null</span>) &#123;</span><br><span class="line">                        p.signatures.mSignatures = dis.signatures.mSignatures.clone();</span><br><span class="line">                    &#125;</span><br><span class="line">                    p.appId = dis.appId;</span><br><span class="line">                    </span><br><span class="line">                    p.getPermissionsState().copyFrom(dis.getPermissionsState());</span><br><span class="line">                    </span><br><span class="line">                    List&lt;UserInfo&gt; users = getAllUsers();</span><br><span class="line">                    <span class="keyword">if</span> (users != <span class="keyword">null</span>) &#123;</span><br><span class="line">                        <span class="keyword">for</span> (UserInfo user : users) &#123;</span><br><span class="line">                            <span class="keyword">int</span> userId = user.id;</span><br><span class="line">                            p.setDisabledComponentsCopy(</span><br><span class="line">                                    dis.getDisabledComponents(userId), userId);</span><br><span class="line">                            p.setEnabledComponentsCopy(</span><br><span class="line">                                    dis.getEnabledComponents(userId), userId);</span><br><span class="line">                        &#125;</span><br><span class="line">                    &#125;</span><br><span class="line">                    </span><br><span class="line">                    <span class="comment">// 将这个新的 PackageSetting 根据 uid 添加到 mUserIds 或者 mOtherUserIds 中！</span></span><br><span class="line">                    addUserIdLPw(p.appId, p, name);</span><br><span class="line">                &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                </span><br><span class="line">                    <span class="comment">// 分配一个新的 uid，并将映射关系保存到 mUserIds 中！</span></span><br><span class="line">                    p.appId = newUserIdLPw(p);</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (p.appId &lt; <span class="number">0</span>) &#123;</span><br><span class="line">            PackageManagerService.reportSettingsProblem(Log.WARN,</span><br><span class="line">                    <span class="string">"Package "</span> + name + <span class="string">" could not be assigned a valid uid"</span>);</span><br><span class="line">            <span class="keyword">return</span> <span class="keyword">null</span>;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (add) &#123; <span class="comment">// add 为 false，这里不添加，添加的操作在 PMS.scanPackageDirtyLI 方法中！</span></span><br><span class="line">            addPackageSettingLPw(p, name, sharedUser);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        <span class="keyword">if</span> (installUser != <span class="keyword">null</span> &amp;&amp; allowInstall) &#123;</span><br><span class="line">            <span class="comment">// The caller has explicitly specified the user they want this</span></span><br><span class="line">            <span class="comment">// package installed for, and the package already exists.</span></span><br><span class="line">            <span class="comment">// Make sure it conforms to the new request.</span></span><br><span class="line">            List&lt;UserInfo&gt; users = getAllUsers();</span><br><span class="line">            <span class="keyword">if</span> (users != <span class="keyword">null</span>) &#123;</span><br><span class="line">                <span class="keyword">for</span> (UserInfo user : users) &#123;</span><br><span class="line">                    <span class="keyword">if</span> ((installUser.getIdentifier() == UserHandle.USER_ALL</span><br><span class="line">                                &amp;&amp; !isAdbInstallDisallowed(userManager, user.id))</span><br><span class="line">                            || installUser.getIdentifier() == user.id) &#123;</span><br><span class="line">                        <span class="keyword">boolean</span> installed = p.getInstalled(user.id);</span><br><span class="line">                        <span class="keyword">if</span> (!installed) &#123;</span><br><span class="line">                            p.setInstalled(<span class="keyword">true</span>, user.id);</span><br><span class="line">                            writePackageRestrictionsLPr(user.id);</span><br><span class="line">                        &#125;</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// 返回查到或者是创建的新的系统 package 对应的 PackageSetting 对象！</span></span><br><span class="line">    <span class="keyword">return</span> p;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>整个过程其实还是很复杂的，要忽视很多的细节，抓住脉络才行！</p>
<h1 id="2-Data-分区扫描结尾工作"><a href="#2-Data-分区扫描结尾工作" class="headerlink" title="2 Data 分区扫描结尾工作"></a>2 Data 分区扫描结尾工作</h1><p>下面我们来看看 Data 分区扫描的结尾工作！</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br></pre></td><td class="code"><pre><span class="line">    <span class="comment">//【1】处理那些已经不存在的被更新过的系统 app！</span></span><br><span class="line">    <span class="keyword">for</span> (String deletedAppName : possiblyDeletedUpdatedSystemApps) &#123;</span><br><span class="line">        PackageParser.Package deletedPkg = mPackages.get(deletedAppName);</span><br><span class="line">        </span><br><span class="line">        mSettings.removeDisabledSystemPackageLPw(deletedAppName);</span><br><span class="line"></span><br><span class="line">        String msg;</span><br><span class="line">        <span class="keyword">if</span> (deletedPkg == <span class="keyword">null</span>) &#123;</span><br><span class="line">            <span class="comment">// 如果无扫描结果，那么系统中一已经没有该 apk 了，那就删掉它！</span></span><br><span class="line">            msg = <span class="string">"Updated system package "</span> + deletedAppName</span><br><span class="line">                    + <span class="string">" no longer exists; it's data will be wiped"</span>;</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            <span class="comment">// 如果有扫描结果，说明 data 分区的 apk 还在，那么这个系统 apk 此时就已经是一个非系统 apk 了</span></span><br><span class="line">            <span class="comment">// 那就要去掉 FLAG_SYSTEM 标志位！</span></span><br><span class="line">            msg = <span class="string">"Updated system app + "</span> + deletedAppName</span><br><span class="line">                    + <span class="string">" no longer present; removing system privileges for "</span></span><br><span class="line">                    + deletedAppName;</span><br><span class="line"></span><br><span class="line">            deletedPkg.applicationInfo.flags &amp;= ~ApplicationInfo.FLAG_SYSTEM;</span><br><span class="line">            PackageSetting deletedPs = mSettings.mPackages.get(deletedAppName);</span><br><span class="line">            deletedPs.pkgFlags &amp;= ~ApplicationInfo.FLAG_SYSTEM;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        logCriticalInfo(Log.WARN, msg);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//【2】确保所有在用户 data 分区的应用都显示出来了，如果 data 分区的无法显示，就显示 system 分区的！</span></span><br><span class="line">    <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; mExpectingBetter.size(); i++) &#123;</span><br><span class="line">        <span class="keyword">final</span> String packageName = mExpectingBetter.keyAt(i);</span><br><span class="line">        <span class="comment">// 如果 PMS 仍然没有扫描到 mExpectingBetter 列表中的 apk，说明 data 分区的 apk 无法显示</span></span><br><span class="line">        <span class="comment">// 那就要显示原来 system 分区的 apk！</span></span><br><span class="line">        <span class="keyword">if</span> (!mPackages.containsKey(packageName)) &#123;</span><br><span class="line">            <span class="keyword">final</span> File scanFile = mExpectingBetter.valueAt(i);</span><br><span class="line"></span><br><span class="line">            logCriticalInfo(Log.WARN, <span class="string">"Expected better "</span> + packageName</span><br><span class="line">                    + <span class="string">" but never showed up; reverting to system"</span>);</span><br><span class="line">            <span class="comment">//【2.1】根据目录，初始化解析标志！！！</span></span><br><span class="line">            <span class="keyword">int</span> reparseFlags = mDefParseFlags;</span><br><span class="line">            <span class="keyword">if</span> (FileUtils.contains(privilegedAppDir, scanFile)) &#123;</span><br><span class="line">                reparseFlags = PackageParser.PARSE_IS_SYSTEM</span><br><span class="line">                        | PackageParser.PARSE_IS_SYSTEM_DIR</span><br><span class="line">                        | PackageParser.PARSE_IS_PRIVILEGED;</span><br><span class="line">                        </span><br><span class="line">            &#125; <span class="keyword">else</span> <span class="keyword">if</span> (FileUtils.contains(systemAppDir, scanFile)) &#123;</span><br><span class="line">                reparseFlags = PackageParser.PARSE_IS_SYSTEM</span><br><span class="line">                        | PackageParser.PARSE_IS_SYSTEM_DIR;</span><br><span class="line">                        </span><br><span class="line">            &#125; <span class="keyword">else</span> <span class="keyword">if</span> (FileUtils.contains(vendorAppDir, scanFile)) &#123;</span><br><span class="line">                reparseFlags = PackageParser.PARSE_IS_SYSTEM</span><br><span class="line">                        | PackageParser.PARSE_IS_SYSTEM_DIR;</span><br><span class="line">                        </span><br><span class="line">            &#125; <span class="keyword">else</span> <span class="keyword">if</span> (FileUtils.contains(oemAppDir, scanFile)) &#123;</span><br><span class="line">                reparseFlags = PackageParser.PARSE_IS_SYSTEM</span><br><span class="line">                        | PackageParser.PARSE_IS_SYSTEM_DIR;</span><br><span class="line">                        </span><br><span class="line">            &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                Slog.e(TAG, <span class="string">"Ignoring unexpected fallback path "</span> + scanFile);</span><br><span class="line">                <span class="keyword">continue</span>;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="comment">//【2.2】使得 system 的 apk 可用；</span></span><br><span class="line">            mSettings.enableSystemPackageLPw(packageName);</span><br><span class="line"></span><br><span class="line">            <span class="keyword">try</span> &#123;</span><br><span class="line">                <span class="comment">//【2.3】重新扫描 system 的 apk！</span></span><br><span class="line">                scanPackageTracedLI(scanFile, reparseFlags, scanFlags, <span class="number">0</span>, <span class="keyword">null</span>);</span><br><span class="line">            &#125; <span class="keyword">catch</span> (PackageManagerException e) &#123;</span><br><span class="line">                Slog.e(TAG, <span class="string">"Failed to parse original system package: "</span></span><br><span class="line">                        + e.getMessage());</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line">mExpectingBetter.clear(); <span class="comment">// 清空 mExpectingBetter 因为已经处理完了！</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// 获得存储管理对象！</span></span><br><span class="line">mStorageManagerPackage = getStorageManagerPackageName();</span><br><span class="line"></span><br><span class="line"><span class="comment">// Resolve protected action filters. Only the setup wizard is allowed to</span></span><br><span class="line"><span class="comment">// have a high priority filter for these actions.</span></span><br><span class="line"><span class="comment">// 获得开机向导应用</span></span><br><span class="line">mSetupWizardPackage = getSetupWizardPackageName();</span><br><span class="line"><span class="keyword">if</span> (mProtectedFilters.size() &gt; <span class="number">0</span>) &#123;</span><br><span class="line">    <span class="keyword">if</span> (DEBUG_FILTERS &amp;&amp; mSetupWizardPackage == <span class="keyword">null</span>) &#123;</span><br><span class="line">        Slog.i(TAG, <span class="string">"No setup wizard;"</span></span><br><span class="line">            + <span class="string">" All protected intents capped to priority 0"</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">for</span> (ActivityIntentInfo filter : mProtectedFilters) &#123;</span><br><span class="line">        <span class="keyword">if</span> (filter.activity.info.packageName.equals(mSetupWizardPackage)) &#123;</span><br><span class="line">            <span class="keyword">if</span> (DEBUG_FILTERS) &#123;</span><br><span class="line">                Slog.i(TAG, <span class="string">"Found setup wizard;"</span></span><br><span class="line">                    + <span class="string">" allow priority "</span> + filter.getPriority() + <span class="string">";"</span></span><br><span class="line">                    + <span class="string">" package: "</span> + filter.activity.info.packageName</span><br><span class="line">                    + <span class="string">" activity: "</span> + filter.activity.className</span><br><span class="line">                    + <span class="string">" priority: "</span> + filter.getPriority());</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="comment">// skip setup wizard; allow it to keep the high priority filter</span></span><br><span class="line">            <span class="keyword">continue</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        Slog.w(TAG, <span class="string">"Protected action; cap priority to 0;"</span></span><br><span class="line">                + <span class="string">" package: "</span> + filter.activity.info.packageName</span><br><span class="line">                + <span class="string">" activity: "</span> + filter.activity.className</span><br><span class="line">                + <span class="string">" origPrio: "</span> + filter.getPriority());</span><br><span class="line">        filter.setPriority(<span class="number">0</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line">mDeferProtectedFilters = <span class="keyword">false</span>;</span><br><span class="line">mProtectedFilters.clear();</span><br><span class="line"></span><br><span class="line"><span class="comment">//【3】我们需要更新所有的应用，保证他们有正确的共享库路径。</span></span><br><span class="line">updateAllSharedLibrariesLPw();</span><br><span class="line"></span><br><span class="line"><span class="comment">//【4】调整所有共享 uid 的 package 的指令集！</span></span><br><span class="line"><span class="keyword">for</span> (SharedUserSetting setting : mSettings.getAllSharedUsersLPw()) &#123;</span><br><span class="line">    adjustCpuAbisForSharedUserLPw(setting.packages, <span class="keyword">null</span> <span class="comment">/* scanned package */</span>,</span><br><span class="line">            <span class="keyword">false</span> <span class="comment">/* boot complete */</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">//【5】更新所有 package 的最新使用时间！</span></span><br><span class="line">mPackageUsage.read(mPackages);</span><br><span class="line">mCompilerStats.read();</span><br></pre></td></tr></table></figure>
<p>到这里，data 分区的扫描就结束了！！</p>
<p>接下来我们重点分析下：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//【5】更新所有 package 的最新使用时间！</span></span><br><span class="line">mPackageUsage.read(mPackages);</span><br><span class="line">mCompilerStats.read();</span><br></pre></td></tr></table></figure>
<p>#3 PackageUsage 和 CompilerStats</p>
<p>在 PMS 的启动时，会创建 PackageUsage 和 CompilerStats 对象！<br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">private</span> <span class="keyword">final</span> PackageUsage mPackageUsage = <span class="keyword">new</span> PackageUsage();</span><br><span class="line"><span class="keyword">private</span> <span class="keyword">final</span> CompilerStats mCompilerStats = <span class="keyword">new</span> CompilerStats();</span><br></pre></td></tr></table></figure></p>
<p>PackageUsage 用来统计 Package 的使用信息！</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">PackageUsage</span> <span class="keyword">extends</span> <span class="title">AbstractStatsBase</span>&lt;<span class="title">Map</span>&lt;<span class="title">String</span>, <span class="title">PackageParser</span>.<span class="title">Package</span>&gt;&gt; </span>&#123;</span><br><span class="line">    PackageUsage() &#123;</span><br><span class="line">        <span class="keyword">super</span>(<span class="string">"package-usage.list"</span>, <span class="string">"PackageUsage_DiskWriter"</span>, <span class="comment">/* lock */</span> <span class="keyword">true</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    ... ... ...</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>PackageUsage 继承了抽象类 AbstractStatsBase，他会从 data/system/package-usage.list 中读取 package 的使用信息！</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">class CompilerStats extends AbstractStatsBase&lt;Void&gt; &#123;</span><br><span class="line">    public CompilerStats() &#123;</span><br><span class="line">        super(&quot;package-cstats.list&quot;, &quot;CompilerStats_DiskWriter&quot;, /* lock */ false);</span><br><span class="line">        packageStats = new HashMap&lt;&gt;();</span><br><span class="line">    &#125;</span><br><span class="line">    ... ... ...</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>CompilerStats 同样继承了抽象类 AbstractStatsBase，他会从 data/system/package-cstats.list 中读取 package 的编译信息！</p>
<p>##3.1 PackageUsage.read</p>
<p>package-usage.list 的格式如下：包名 +　8 个时间戳<br><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">PACKAGE_USAGE__VERSION_1</span><br><span class="line">com.android.providers.telephony 0 0 0 1531174607101 1531246438563 0 1531246438760 0</span><br><span class="line">com.android.providers.calendar 0 1531246463197 0 1531246463181 1531246461258 0 0 0</span><br></pre></td></tr></table></figure></p>
<p>我们来看看他是如何解析的！</p>
<p>read 方法会调用自身的 readInternal 方法！</p>
<p>###3.1.1 PackageUsage.readInternal</p>
<p>我们来看下 readInternal 的方法调用！<br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="function"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title">readInternal</span><span class="params">(Map&lt;String, PackageParser.Package&gt; packages)</span> </span>&#123;</span><br><span class="line">    AtomicFile file = getFile();</span><br><span class="line">    BufferedInputStream in = <span class="keyword">null</span>;</span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">        in = <span class="keyword">new</span> BufferedInputStream(file.openRead());</span><br><span class="line">        StringBuffer sb = <span class="keyword">new</span> StringBuffer();</span><br><span class="line"></span><br><span class="line">        String firstLine = readLine(in, sb);</span><br><span class="line">        <span class="keyword">if</span> (firstLine == <span class="keyword">null</span>) &#123;</span><br><span class="line">        &#125; <span class="keyword">else</span> <span class="keyword">if</span> (USAGE_FILE_MAGIC_VERSION_1.equals(firstLine)) &#123;</span><br><span class="line">            <span class="comment">//【3.1.2】根据第一行，我们会进入这里！</span></span><br><span class="line">            readVersion1LP(packages, in, sb);</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            readVersion0LP(packages, in, sb, firstLine);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125; <span class="keyword">catch</span> (FileNotFoundException expected) &#123;</span><br><span class="line">        mIsHistoricalPackageUsageAvailable = <span class="keyword">false</span>;</span><br><span class="line">    &#125; <span class="keyword">catch</span> (IOException e) &#123;</span><br><span class="line">        Log.w(PackageManagerService.TAG, <span class="string">"Failed to read package usage times"</span>, e);</span><br><span class="line">    &#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">        IoUtils.closeQuietly(in);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>###3.1.2 PackageUsage.readVersion1LP</p>
<p>我们来看下 readVersion1LP 的方法调用！<br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">readVersion1LP</span><span class="params">(Map&lt;String, PackageParser.Package&gt; packages, InputStream in,</span></span></span><br><span class="line"><span class="function"><span class="params">        StringBuffer sb)</span> <span class="keyword">throws</span> IOException </span>&#123;</span><br><span class="line">    String line;</span><br><span class="line">    <span class="keyword">while</span> ((line = readLine(in, sb)) != <span class="keyword">null</span>) &#123;</span><br><span class="line">        <span class="comment">//【1】从 " " 将每一行分割开！</span></span><br><span class="line">        String[] tokens = line.split(<span class="string">" "</span>);</span><br><span class="line">        <span class="keyword">if</span> (tokens.length != PackageManager.NOTIFY_PACKAGE_USE_REASONS_COUNT + <span class="number">1</span>) &#123;</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> IOException(<span class="string">"Failed to parse "</span> + line + <span class="string">" as a timestamp array."</span>);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        String packageName = tokens[<span class="number">0</span>];</span><br><span class="line">        PackageParser.Package pkg = packages.get(packageName);</span><br><span class="line">        <span class="keyword">if</span> (pkg == <span class="keyword">null</span>) &#123;</span><br><span class="line">            <span class="keyword">continue</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        </span><br><span class="line">        <span class="comment">//【2】将这 8 个时间戳保存到 PackageParser.Package.mLastPackageUsageTimeInMills 数组中！</span></span><br><span class="line">        <span class="keyword">for</span> (<span class="keyword">int</span> reason = <span class="number">0</span>;</span><br><span class="line">                reason &lt; PackageManager.NOTIFY_PACKAGE_USE_REASONS_COUNT;</span><br><span class="line">                reason++) &#123;</span><br><span class="line">            pkg.mLastPackageUsageTimeInMills[reason] = parseAsLong(tokens[reason + <span class="number">1</span>]);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>整个流程很简单！</p>
<p>##3.2 CompilerStats.read</p>
<p>package-cstats.list 的格式如下：<br><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">PACKAGE_MANAGER__COMPILER_STATS__1</span><br><span class="line">com.android.storagemanager</span><br><span class="line">-StorageManager.apk:1362</span><br><span class="line">com.android.printspooler</span><br><span class="line">-PrintSpooler.apk:659</span><br></pre></td></tr></table></figure></p>
<p>我们来看看他是如何解析的，CompilerStats.read[0] 会调用 CompilerStats.read(Reader r) 方法！</p>
<p>###3.2.1 CompilerStats.read</p>
<p>CompilerStats 内部有一个 map 表 packageStats 保存了 packageName 和对应的 PackageStats 的映射关系！<br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">private</span> <span class="keyword">final</span> Map&lt;String, PackageStats&gt; packageStats;</span><br></pre></td></tr></table></figure></p>
<p>我们来继续看 read 方法：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">boolean</span> <span class="title">read</span><span class="params">(Reader r)</span> </span>&#123;</span><br><span class="line">     <span class="keyword">synchronized</span> (packageStats) &#123;</span><br><span class="line">         <span class="comment">//【1】清空内部的 packageStats！</span></span><br><span class="line">         packageStats.clear();</span><br><span class="line">         <span class="keyword">try</span> &#123;</span><br><span class="line">             BufferedReader in = <span class="keyword">new</span> BufferedReader(r);</span><br><span class="line"></span><br><span class="line">             <span class="comment">//【2】版本号校验！</span></span><br><span class="line">             String versionLine = in.readLine();</span><br><span class="line">             <span class="keyword">if</span> (versionLine == <span class="keyword">null</span>) &#123;</span><br><span class="line">                 <span class="keyword">throw</span> <span class="keyword">new</span> IllegalArgumentException(<span class="string">"No version line found."</span>);</span><br><span class="line">             &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                 <span class="keyword">if</span> (!versionLine.startsWith(COMPILER_STATS_VERSION_HEADER)) &#123;</span><br><span class="line">                     <span class="keyword">throw</span> <span class="keyword">new</span> IllegalArgumentException(<span class="string">"Invalid version line: "</span> + versionLine);</span><br><span class="line">                 &#125;</span><br><span class="line">                 <span class="keyword">int</span> version = Integer.parseInt(</span><br><span class="line">                         versionLine.substring(COMPILER_STATS_VERSION_HEADER.length()));</span><br><span class="line">                 <span class="keyword">if</span> (version != COMPILER_STATS_VERSION) &#123;</span><br><span class="line">                     <span class="comment">// <span class="doctag">TODO:</span> Upgrade older formats? For now, just reject and regenerate.</span></span><br><span class="line">                     <span class="keyword">throw</span> <span class="keyword">new</span> IllegalArgumentException(<span class="string">"Unexpected version: "</span> + version);</span><br><span class="line">                 &#125;</span><br><span class="line">             &#125;</span><br><span class="line"></span><br><span class="line">             <span class="comment">//【3】创建第一行 package 对应的 PackageStats 对象！</span></span><br><span class="line">             <span class="comment">// 开始读取文件内容！</span></span><br><span class="line">             PackageStats currentPackage = <span class="keyword">new</span> PackageStats(<span class="string">"fake package"</span>);</span><br><span class="line"></span><br><span class="line">             String s = <span class="keyword">null</span>;</span><br><span class="line">             <span class="keyword">while</span> ((s = in.readLine()) != <span class="keyword">null</span>) &#123;</span><br><span class="line">                 <span class="comment">//【3.1】"-" 开头的 line 是 PackageStats 要封装的信息！</span></span><br><span class="line">                 <span class="keyword">if</span> (s.startsWith(<span class="string">"-"</span>)) &#123;</span><br><span class="line">                     <span class="keyword">int</span> colonIndex = s.indexOf(<span class="string">':'</span>); <span class="comment">// 使用 ":" 将每一行分割开！</span></span><br><span class="line">                     <span class="keyword">if</span> (colonIndex == -<span class="number">1</span> || colonIndex == <span class="number">1</span>) &#123;</span><br><span class="line">                         <span class="keyword">throw</span> <span class="keyword">new</span> IllegalArgumentException(<span class="string">"Could not parse data "</span> + s);</span><br><span class="line">                     &#125;</span><br><span class="line">                     String codePath = s.substring(<span class="number">1</span>, colonIndex);</span><br><span class="line">                     <span class="keyword">long</span> time = Long.parseLong(s.substring(colonIndex + <span class="number">1</span>));</span><br><span class="line">                     <span class="comment">//【3.1.1】设置编译文件名和编译时间属性！</span></span><br><span class="line">                     currentPackage.setCompileTime(codePath, time);</span><br><span class="line">                 &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                     <span class="comment">//【3.2.2】创建或者获得下一个 PackageStats 实例！</span></span><br><span class="line">                     currentPackage = getOrCreatePackageStats(s);</span><br><span class="line">                 &#125;</span><br><span class="line">             &#125;</span><br><span class="line">         &#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">             Log.e(PackageManagerService.TAG, <span class="string">"Error parsing compiler stats"</span>, e);</span><br><span class="line">             <span class="keyword">return</span> <span class="keyword">false</span>;</span><br><span class="line">         &#125;</span><br><span class="line"></span><br><span class="line">         <span class="keyword">return</span> <span class="keyword">true</span>;</span><br><span class="line">     &#125;</span><br><span class="line"> &#125;</span><br></pre></td></tr></table></figure>
<p>我们来看看 PackageStats 类：<br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">static</span> <span class="class"><span class="keyword">class</span> <span class="title">PackageStats</span> </span>&#123;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> String packageName;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> Map&lt;String, Long&gt; compileTimePerCodePath;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="title">PackageStats</span><span class="params">(String packageName)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">this</span>.packageName = packageName;</span><br><span class="line">        <span class="comment">// We expect at least one element in here, but let's make it minimal.</span></span><br><span class="line">        compileTimePerCodePath = <span class="keyword">new</span> ArrayMap&lt;&gt;(<span class="number">2</span>);</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure></p>
<p>packageName 是包名，compileTimePerCodePath 用来保存被编译的 code 文件名和编译的时间！</p>
<p>###3.2.2 CompilerStats.getOrCreatePackageStats</p>
<p>getOrCreatePackageStats 方法用来获得或者创建一个新的 PackageStats 对象！<br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> PackageStats <span class="title">getOrCreatePackageStats</span><span class="params">(String packageName)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">synchronized</span> (packageStats) &#123;</span><br><span class="line">        PackageStats existingStats = packageStats.get(packageName);</span><br><span class="line">        <span class="keyword">if</span> (existingStats != <span class="keyword">null</span>) &#123;</span><br><span class="line">            <span class="keyword">return</span> existingStats;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> createPackageStats(packageName);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">public</span> PackageStats <span class="title">createPackageStats</span><span class="params">(String packageName)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">synchronized</span> (packageStats) &#123;</span><br><span class="line">        PackageStats newStats = <span class="keyword">new</span> PackageStats(packageName);</span><br><span class="line">        packageStats.put(packageName, newStats);</span><br><span class="line">        <span class="keyword">return</span> newStats;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>整个方法流程很简单！</p>
</div><hr></div><div class="recent-post-item article-container"><a class="article-title" href="/2018/02/05/PMS 第 3 篇 - PMS_SYSTEM_SCAN_START 阶段/">PMS 第 3 篇 - PMS_SYSTEM_SCAN_START 阶段</a><time class="post-meta__date"><i class="fa fa-calendar" aria-hidden="true"></i> 2018-02-05</time><span class="article-meta"><span class="article-meta__separator">|</span><i class="fa fa-inbox article-meta__icon" aria-hidden="true"></i><a class="article-meta__categories" href="/categories/AndroidFramework源码分析/">AndroidFramework源码分析</a><i class="fa fa-angle-right" aria-hidden="true"></i><i class="fa fa-inbox article-meta__icon" aria-hidden="true"></i><a class="article-meta__categories" href="/categories/AndroidFramework源码分析/PackageManager包管理/">PackageManager包管理</a></span><span class="article-meta tags"><span class="article-meta__separator">|</span><i class="fa fa-tag article-meta__icon" aria-hidden="true"></i><a class="article-meta__tags" href="/tags/PackageManager包管理/">PackageManager包管理</a></span><div class="content"><p>[toc]</p>
<p>基于 Android 7.1.1 源码分析 PackageManagerService 的架构和逻辑实现，本文是作者原创，转载请说明出处！</p>
<h1 id="0-综述"><a href="#0-综述" class="headerlink" title="0 综述"></a>0 综述</h1><p>我们进入第二阶段系统目录扫描来分析，代码比较长，我们来回顾下该阶段的流程：<br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br><span class="line">212</span><br><span class="line">213</span><br></pre></td><td class="code"><pre><span class="line">... ... ... ...<span class="comment">// 接上面</span></span><br><span class="line"><span class="keyword">long</span> startTime = SystemClock.uptimeMillis();</span><br><span class="line"> </span><br><span class="line">EventLog.writeEvent(EventLogTags.BOOT_PROGRESS_PMS_SYSTEM_SCAN_START,</span><br><span class="line">        startTime);</span><br><span class="line"></span><br><span class="line"><span class="comment">// 设置扫描参数！</span></span><br><span class="line"><span class="keyword">final</span> <span class="keyword">int</span> scanFlags = SCAN_NO_PATHS | SCAN_DEFER_DEX | SCAN_BOOTING | SCAN_INITIAL;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 获得环境变量：BOOTCLASSPATH 和 SYSTEMSERVERCLASSPATH！</span></span><br><span class="line"><span class="keyword">final</span> String bootClassPath = System.getenv(<span class="string">"BOOTCLASSPATH"</span>);</span><br><span class="line"><span class="keyword">final</span> String systemServerClassPath = System.getenv(<span class="string">"SYSTEMSERVERCLASSPATH"</span>);</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> (bootClassPath == <span class="keyword">null</span>) &#123;</span><br><span class="line">    Slog.w(TAG, <span class="string">"No BOOTCLASSPATH found!"</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> (systemServerClassPath == <span class="keyword">null</span>) &#123;</span><br><span class="line">    Slog.w(TAG, <span class="string">"No SYSTEMSERVERCLASSPATH found!"</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 获得系统指令集合！</span></span><br><span class="line"><span class="keyword">final</span> List&lt;String&gt; allInstructionSets = InstructionSets.getAllInstructionSets();</span><br><span class="line"><span class="keyword">final</span> String[] dexCodeInstructionSets =</span><br><span class="line">        getDexCodeInstructionSets(</span><br><span class="line">                allInstructionSets.toArray(<span class="keyword">new</span> String[allInstructionSets.size()]));</span><br><span class="line"></span><br><span class="line"><span class="comment">// 对所有的共享库执行 odex 操作！</span></span><br><span class="line"><span class="keyword">if</span> (mSharedLibraries.size() &gt; <span class="number">0</span>) &#123;</span><br><span class="line">    <span class="keyword">for</span> (String dexCodeInstructionSet : dexCodeInstructionSets) &#123;</span><br><span class="line">        <span class="keyword">for</span> (SharedLibraryEntry libEntry : mSharedLibraries.values()) &#123;</span><br><span class="line">            <span class="keyword">final</span> String lib = libEntry.path;</span><br><span class="line">            <span class="keyword">if</span> (lib == <span class="keyword">null</span>) &#123;</span><br><span class="line">                <span class="keyword">continue</span>;</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            <span class="keyword">try</span> &#123;</span><br><span class="line">                <span class="comment">// Shared libraries do not have profiles so we perform a full</span></span><br><span class="line">                <span class="comment">// AOT compilation (if needed).</span></span><br><span class="line">                <span class="keyword">int</span> dexoptNeeded = DexFile.getDexOptNeeded(</span><br><span class="line">                        lib, dexCodeInstructionSet,</span><br><span class="line">                        getCompilerFilterForReason(REASON_SHARED_APK),</span><br><span class="line">                        <span class="keyword">false</span> <span class="comment">/* newProfile */</span>);</span><br><span class="line"></span><br><span class="line">                <span class="keyword">if</span> (dexoptNeeded != DexFile.NO_DEXOPT_NEEDED) &#123;</span><br><span class="line">                    mInstaller.dexopt(lib, Process.SYSTEM_UID, dexCodeInstructionSet,</span><br><span class="line">                            dexoptNeeded, DEXOPT_PUBLIC <span class="comment">/*dexFlags*/</span>,</span><br><span class="line">                            getCompilerFilterForReason(REASON_SHARED_APK),</span><br><span class="line">                            StorageManager.UUID_PRIVATE_INTERNAL,</span><br><span class="line">                            SKIP_SHARED_LIBRARY_CHECK);</span><br><span class="line">                &#125;</span><br><span class="line">            &#125; <span class="keyword">catch</span> (FileNotFoundException e) &#123;</span><br><span class="line">                Slog.w(TAG, <span class="string">"Library not found: "</span> + lib);</span><br><span class="line">            &#125; <span class="keyword">catch</span> (IOException | InstallerException e) &#123;</span><br><span class="line">                Slog.w(TAG, <span class="string">"Cannot dexopt "</span> + lib + <span class="string">"; is it an APK or JAR? "</span></span><br><span class="line">                        + e.getMessage());</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 获得目录 /system/framework，对其目录下的文件进行优化 !</span></span><br><span class="line">File frameworkDir = <span class="keyword">new</span> File(Environment.getRootDirectory(), <span class="string">"framework"</span>);</span><br><span class="line"></span><br><span class="line"><span class="comment">// 获得系统版本信息</span></span><br><span class="line"><span class="keyword">final</span> VersionInfo ver = mSettings.getInternalVersion();</span><br><span class="line"></span><br><span class="line"><span class="comment">// 判断是否是 OTA 升级，如果当前版本的指纹与历史版本的指纹信息不一致，表示当前版本是一次 OTA 升级上来更新版本！</span></span><br><span class="line">mIsUpgrade = !Build.FINGERPRINT.equals(ver.fingerprint);</span><br><span class="line"></span><br><span class="line"><span class="comment">// 判断是否是从 Android M 之前的版本升级过来的，如果是就需要把系统 app 的权限从安装时提高到运行时！</span></span><br><span class="line">mPromoteSystemApps =</span><br><span class="line">        mIsUpgrade &amp;&amp; ver.sdkVersion &lt;= Build.VERSION_CODES.LOLLIPOP_MR1;</span><br><span class="line"></span><br><span class="line"><span class="comment">// When upgrading from pre-N, we need to handle package extraction like first boot,</span></span><br><span class="line"><span class="comment">// as there is no profiling data available.</span></span><br><span class="line"><span class="comment">// 判断是否是从 Android 7.0 升级过来的！</span></span><br><span class="line">mIsPreNUpgrade = mIsUpgrade &amp;&amp; ver.sdkVersion &lt; Build.VERSION_CODES.N;</span><br><span class="line"></span><br><span class="line">mIsPreNMR1Upgrade = mIsUpgrade &amp;&amp; ver.sdkVersion &lt; Build.VERSION_CODES.N_MR1;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 保存从 Android 6.0 升级前已经存在的系统应用，并对他们进行优先扫描！</span></span><br><span class="line"><span class="comment">// 扫描过程会将安装时权限变为运行时权限！</span></span><br><span class="line"><span class="keyword">if</span> (mPromoteSystemApps) &#123;</span><br><span class="line">    Iterator&lt;PackageSetting&gt; pkgSettingIter = mSettings.mPackages.values().iterator();</span><br><span class="line">    <span class="keyword">while</span> (pkgSettingIter.hasNext()) &#123;</span><br><span class="line">        PackageSetting ps = pkgSettingIter.next();</span><br><span class="line">        <span class="keyword">if</span> (isSystemApp(ps)) &#123;</span><br><span class="line">            mExistingSystemPackages.add(ps.name);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">//【1】扫描收集目录 /vendor/overlay 下的供应商应用包！</span></span><br><span class="line">File vendorOverlayDir = <span class="keyword">new</span> File(VENDOR_OVERLAY_DIR);</span><br><span class="line">scanDirTracedLI(vendorOverlayDir, mDefParseFlags</span><br><span class="line">        | PackageParser.PARSE_IS_SYSTEM</span><br><span class="line">        | PackageParser.PARSE_IS_SYSTEM_DIR</span><br><span class="line">        | PackageParser.PARSE_TRUSTED_OVERLAY, scanFlags | SCAN_TRUSTED_OVERLAY, <span class="number">0</span>);</span><br><span class="line"></span><br><span class="line"><span class="comment">// Find base frameworks (resource packages without code).</span></span><br><span class="line"><span class="comment">//【2】扫描收集目录 /system/framework 下的应用包！ </span></span><br><span class="line">scanDirTracedLI(frameworkDir, mDefParseFlags</span><br><span class="line">        | PackageParser.PARSE_IS_SYSTEM</span><br><span class="line">        | PackageParser.PARSE_IS_SYSTEM_DIR</span><br><span class="line">        | PackageParser.PARSE_IS_PRIVILEGED,</span><br><span class="line">        scanFlags | SCAN_NO_DEX, <span class="number">0</span>);</span><br><span class="line"></span><br><span class="line"><span class="comment">//【3】扫描收集目录 /system/priv-app 下的应用包！ </span></span><br><span class="line"><span class="keyword">final</span> File privilegedAppDir = <span class="keyword">new</span> File(Environment.getRootDirectory(), <span class="string">"priv-app"</span>);</span><br><span class="line">scanDirTracedLI(privilegedAppDir, mDefParseFlags</span><br><span class="line">        | PackageParser.PARSE_IS_SYSTEM</span><br><span class="line">        | PackageParser.PARSE_IS_SYSTEM_DIR</span><br><span class="line">        | PackageParser.PARSE_IS_PRIVILEGED, scanFlags, <span class="number">0</span>);</span><br><span class="line"></span><br><span class="line"><span class="comment">//【4】扫描收集目录 /system/app 下的应用包！ </span></span><br><span class="line"><span class="keyword">final</span> File systemAppDir = <span class="keyword">new</span> File(Environment.getRootDirectory(), <span class="string">"app"</span>);</span><br><span class="line">scanDirTracedLI(systemAppDir, mDefParseFlags</span><br><span class="line">        | PackageParser.PARSE_IS_SYSTEM</span><br><span class="line">        | PackageParser.PARSE_IS_SYSTEM_DIR, scanFlags, <span class="number">0</span>);</span><br><span class="line"></span><br><span class="line"><span class="comment">//【5】扫描收集目录 /vendor/app 下的应用包！ </span></span><br><span class="line">File vendorAppDir = <span class="keyword">new</span> File(<span class="string">"/vendor/app"</span>);</span><br><span class="line"><span class="keyword">try</span> &#123;</span><br><span class="line">    vendorAppDir = vendorAppDir.getCanonicalFile();</span><br><span class="line">&#125; <span class="keyword">catch</span> (IOException e) &#123;</span><br><span class="line">    <span class="comment">// failed to look up canonical path, continue with original one</span></span><br><span class="line">&#125;</span><br><span class="line">scanDirTracedLI(vendorAppDir, mDefParseFlags</span><br><span class="line">        | PackageParser.PARSE_IS_SYSTEM</span><br><span class="line">        | PackageParser.PARSE_IS_SYSTEM_DIR, scanFlags, <span class="number">0</span>);</span><br><span class="line"></span><br><span class="line"><span class="comment">//【6】扫描收集目录 /oem/app 下的应用包！ </span></span><br><span class="line"><span class="keyword">final</span> File oemAppDir = <span class="keyword">new</span> File(Environment.getOemDirectory(), <span class="string">"app"</span>);</span><br><span class="line">scanDirTracedLI(oemAppDir, mDefParseFlags</span><br><span class="line">        | PackageParser.PARSE_IS_SYSTEM</span><br><span class="line">        | PackageParser.PARSE_IS_SYSTEM_DIR, scanFlags, <span class="number">0</span>);</span><br><span class="line"></span><br><span class="line"><span class="comment">// 收集可能已经被删掉的系统应用包！</span></span><br><span class="line"><span class="keyword">final</span> List&lt;String&gt; possiblyDeletedUpdatedSystemApps = <span class="keyword">new</span> ArrayList&lt;String&gt;();</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> (!mOnlyCore) &#123;</span><br><span class="line">    <span class="comment">// 遍历上一次安装的信息！</span></span><br><span class="line">    Iterator&lt;PackageSetting&gt; psit = mSettings.mPackages.values().iterator();</span><br><span class="line">    <span class="keyword">while</span> (psit.hasNext()) &#123;</span><br><span class="line">        PackageSetting ps = psit.next();</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 如果不是系统应用，跳过！</span></span><br><span class="line">        <span class="keyword">if</span> ((ps.pkgFlags &amp; ApplicationInfo.FLAG_SYSTEM) == <span class="number">0</span>) &#123;</span><br><span class="line">            <span class="keyword">continue</span>;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">final</span> PackageParser.Package scannedPkg = mPackages.get(ps.name);</span><br><span class="line">        <span class="keyword">if</span> (scannedPkg != <span class="keyword">null</span>) &#123;</span><br><span class="line">            <span class="comment">// 如果系统应用包不仅被扫描过（在mPackages中），并且在不可用列表中！</span></span><br><span class="line">            <span class="comment">// 说明一定是通过覆盖更新的，移除之前扫描的结果，保证之前用户安装的应用能够被扫描！</span></span><br><span class="line">            <span class="keyword">if</span> (mSettings.isDisabledSystemPackageLPr(ps.name)) &#123;</span><br><span class="line">                logCriticalInfo(Log.WARN, <span class="string">"Expecting better updated system app for "</span></span><br><span class="line">                        + ps.name + <span class="string">"; removing system app.  Last known codePath="</span></span><br><span class="line">                        + ps.codePathString + <span class="string">", installStatus="</span> + ps.installStatus</span><br><span class="line">                        + <span class="string">", versionCode="</span> + ps.versionCode + <span class="string">"; scanned versionCode="</span></span><br><span class="line">                        + scannedPkg.mVersionCode);</span><br><span class="line">                </span><br><span class="line">                <span class="comment">// 将之前的扫描结果移除！</span></span><br><span class="line">                removePackageLI(scannedPkg, <span class="keyword">true</span>);</span><br><span class="line">                <span class="comment">// 将这包添加到 mExpectingBetter 列表中！</span></span><br><span class="line">                mExpectingBetter.put(ps.name, ps.codePath);</span><br><span class="line">            &#125;</span><br><span class="line">            </span><br><span class="line">            <span class="comment">// 跳出循环，确保不会被删掉！</span></span><br><span class="line">            <span class="keyword">continue</span>;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 如果系统应用包没有被扫描，并且他也不在不可用的列表中，移除它，这个包不存在！</span></span><br><span class="line">        <span class="keyword">if</span> (!mSettings.isDisabledSystemPackageLPr(ps.name)) &#123;</span><br><span class="line">            psit.remove();</span><br><span class="line">            logCriticalInfo(Log.WARN, <span class="string">"System package "</span> + ps.name</span><br><span class="line">                    + <span class="string">" no longer exists; it's data will be wiped"</span>);</span><br><span class="line">            <span class="comment">// Actual deletion of code and data will be handled by later</span></span><br><span class="line">            <span class="comment">// reconciliation step</span></span><br><span class="line"></span><br><span class="line">        &#125; <span class="keyword">else</span> &#123; </span><br><span class="line">            </span><br><span class="line">            <span class="comment">// 如果系统应用包没有被扫描，却在不可用的列表中，就将他加入到 </span></span><br><span class="line">            <span class="comment">// possiblyDeletedUpdatedSystemApps 集合中，需要被删除！</span></span><br><span class="line">            <span class="keyword">final</span> PackageSetting disabledPs = mSettings.getDisabledSystemPkgLPr(ps.name);</span><br><span class="line">            <span class="keyword">if</span> (disabledPs.codePath == <span class="keyword">null</span> || !disabledPs.codePath.exists()) &#123;</span><br><span class="line">                possiblyDeletedUpdatedSystemApps.add(ps.name);</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 清理所有安装不完全的应用包！</span></span><br><span class="line">ArrayList&lt;PackageSetting&gt; deletePkgsList = mSettings.getListOfIncompleteInstallPackagesLPr();</span><br><span class="line"><span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; deletePkgsList.size(); i++) &#123;</span><br><span class="line">    <span class="comment">// Actual deletion of code and data will be handled by later</span></span><br><span class="line">    <span class="comment">// reconciliation step</span></span><br><span class="line">    <span class="keyword">final</span> String packageName = deletePkgsList.get(i).name;</span><br><span class="line">    logCriticalInfo(Log.WARN, <span class="string">"Cleaning up incompletely installed app: "</span> + packageName);</span><br><span class="line">    <span class="keyword">synchronized</span> (mPackages) &#123;</span><br><span class="line">        mSettings.removePackageLPw(packageName);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 移除临时文件</span></span><br><span class="line">deleteTempPackageFiles();</span><br><span class="line"></span><br><span class="line"><span class="comment">// 移除没有和应用程序包相关联的共享用户 id！</span></span><br><span class="line">mSettings.pruneSharedUsersLPw();</span><br><span class="line"> </span><br><span class="line">... ... ... ...<span class="comment">// 见，第三阶段</span></span><br></pre></td></tr></table></figure></p>
<p>主要流程如下：</p>
<ul>
<li>对所有的共享库执行 odex 操作！</li>
<li>扫描手机系统目录信息！</li>
<li>收集那些可能已经不存在的系统应用包，在扫描完 data 分区后再处理！</li>
<li>清理所有安装不完全的应用包！</li>
</ul>
<p>我们接下来继续分析：</p>
<h1 id="1-对共享库执行-odex-操作"><a href="#1-对共享库执行-odex-操作" class="headerlink" title="1 对共享库执行 odex 操作"></a>1 对共享库执行 odex 操作</h1><p>主要代码块如下：<br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 对所有的共享库执行 odex 操作！</span></span><br><span class="line"><span class="keyword">if</span> (mSharedLibraries.size() &gt; <span class="number">0</span>) &#123;</span><br><span class="line">    <span class="keyword">for</span> (String dexCodeInstructionSet : dexCodeInstructionSets) &#123;</span><br><span class="line">        <span class="keyword">for</span> (SharedLibraryEntry libEntry : mSharedLibraries.values()) &#123;</span><br><span class="line">            <span class="keyword">final</span> String lib = libEntry.path;</span><br><span class="line">            <span class="keyword">if</span> (lib == <span class="keyword">null</span>) &#123;</span><br><span class="line">                <span class="keyword">continue</span>;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">try</span> &#123;</span><br><span class="line">                <span class="comment">// Shared libraries do not have profiles so we perform a full</span></span><br><span class="line">                <span class="comment">// AOT compilation (if needed).</span></span><br><span class="line"></span><br><span class="line">                <span class="comment">// 判断共享库是否需要执行 odex 操作</span></span><br><span class="line">                <span class="keyword">int</span> dexoptNeeded = DexFile.getDexOptNeeded(</span><br><span class="line">                        lib, dexCodeInstructionSet,</span><br><span class="line">                        getCompilerFilterForReason(REASON_SHARED_APK),</span><br><span class="line">                        <span class="keyword">false</span> <span class="comment">/* newProfile */</span>);</span><br><span class="line">                </span><br><span class="line">                <span class="comment">// 如果需要 odex 操作，对共享库进行一次预编译（AOT）</span></span><br><span class="line">                <span class="keyword">if</span> (dexoptNeeded != DexFile.NO_DEXOPT_NEEDED) &#123;</span><br><span class="line">                    mInstaller.dexopt(lib, Process.SYSTEM_UID, dexCodeInstructionSet,</span><br><span class="line">                            dexoptNeeded, DEXOPT_PUBLIC <span class="comment">/*dexFlags*/</span>,</span><br><span class="line">                            getCompilerFilterForReason(REASON_SHARED_APK),</span><br><span class="line">                            StorageManager.UUID_PRIVATE_INTERNAL,</span><br><span class="line">                            SKIP_SHARED_LIBRARY_CHECK);</span><br><span class="line">                &#125;</span><br><span class="line">            &#125; <span class="keyword">catch</span> (FileNotFoundException e) &#123;</span><br><span class="line">                Slog.w(TAG, <span class="string">"Library not found: "</span> + lib);</span><br><span class="line">            &#125; <span class="keyword">catch</span> (IOException | InstallerException e) &#123;</span><br><span class="line">                Slog.w(TAG, <span class="string">"Cannot dexopt "</span> + lib + <span class="string">"; is it an APK or JAR? "</span></span><br><span class="line">                        + e.getMessage());</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>主要流程：</p>
<ul>
<li>判断共享库是否需要执行 odex 操作;</li>
<li>如果需要执行 odex 操作，就对共享库进行预（AOT）处理;</li>
</ul>
<h1 id="2-系统目录扫描-开始阶段"><a href="#2-系统目录扫描-开始阶段" class="headerlink" title="2 系统目录扫描 - 开始阶段"></a>2 系统目录扫描 - 开始阶段</h1><p>主要代码如下：<br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 设置扫描参数！</span></span><br><span class="line"><span class="keyword">final</span> <span class="keyword">int</span> scanFlags = SCAN_NO_PATHS | SCAN_DEFER_DEX | SCAN_BOOTING | SCAN_INITIAL;</span><br><span class="line"></span><br><span class="line">... ... ... ...</span><br><span class="line"></span><br><span class="line"><span class="comment">// 扫描收集目录 /vendor/overlay 下的供应商应用包，用于资源替换！！</span></span><br><span class="line">File vendorOverlayDir = <span class="keyword">new</span> File(VENDOR_OVERLAY_DIR);</span><br><span class="line">scanDirTracedLI(vendorOverlayDir, mDefParseFlags</span><br><span class="line">        | PackageParser.PARSE_IS_SYSTEM</span><br><span class="line">        | PackageParser.PARSE_IS_SYSTEM_DIR</span><br><span class="line">        | PackageParser.PARSE_TRUSTED_OVERLAY, scanFlags | SCAN_TRUSTED_OVERLAY, <span class="number">0</span>);</span><br><span class="line"></span><br><span class="line"><span class="comment">// Find base frameworks (resource packages without code).</span></span><br><span class="line"><span class="comment">// 扫描收集目录 /system/framework 下的应用包！ </span></span><br><span class="line">scanDirTracedLI(frameworkDir, mDefParseFlags</span><br><span class="line">        | PackageParser.PARSE_IS_SYSTEM</span><br><span class="line">        | PackageParser.PARSE_IS_SYSTEM_DIR</span><br><span class="line">        | PackageParser.PARSE_IS_PRIVILEGED,</span><br><span class="line">        scanFlags | SCAN_NO_DEX, <span class="number">0</span>);</span><br><span class="line"></span><br><span class="line"><span class="comment">// 扫描收集目录 /system/priv-app 下的应用包！ </span></span><br><span class="line"><span class="keyword">final</span> File privilegedAppDir = <span class="keyword">new</span> File(Environment.getRootDirectory(), <span class="string">"priv-app"</span>);</span><br><span class="line">scanDirTracedLI(privilegedAppDir, mDefParseFlags</span><br><span class="line">        | PackageParser.PARSE_IS_SYSTEM</span><br><span class="line">        | PackageParser.PARSE_IS_SYSTEM_DIR</span><br><span class="line">        | PackageParser.PARSE_IS_PRIVILEGED, scanFlags, <span class="number">0</span>);</span><br><span class="line"></span><br><span class="line"><span class="comment">// 扫描收集目录 /system/app 下的应用包！ </span></span><br><span class="line"><span class="keyword">final</span> File systemAppDir = <span class="keyword">new</span> File(Environment.getRootDirectory(), <span class="string">"app"</span>);</span><br><span class="line">scanDirTracedLI(systemAppDir, mDefParseFlags</span><br><span class="line">        | PackageParser.PARSE_IS_SYSTEM</span><br><span class="line">        | PackageParser.PARSE_IS_SYSTEM_DIR, scanFlags, <span class="number">0</span>);</span><br><span class="line"></span><br><span class="line"><span class="comment">// 扫描收集目录 /vendor/app 下的应用包！ </span></span><br><span class="line">File vendorAppDir = <span class="keyword">new</span> File(<span class="string">"/vendor/app"</span>);</span><br><span class="line"><span class="keyword">try</span> &#123;</span><br><span class="line">    vendorAppDir = vendorAppDir.getCanonicalFile();</span><br><span class="line">&#125; <span class="keyword">catch</span> (IOException e) &#123;</span><br><span class="line">    <span class="comment">// failed to look up canonical path, continue with original one</span></span><br><span class="line">&#125;</span><br><span class="line">scanDirTracedLI(vendorAppDir, mDefParseFlags</span><br><span class="line">        | PackageParser.PARSE_IS_SYSTEM</span><br><span class="line">        | PackageParser.PARSE_IS_SYSTEM_DIR, scanFlags, <span class="number">0</span>);</span><br><span class="line">        </span><br><span class="line"><span class="comment">// 扫描收集目录 /oem/app 下的应用包！ </span></span><br><span class="line"><span class="keyword">final</span> File oemAppDir = <span class="keyword">new</span> File(Environment.getOemDirectory(), <span class="string">"app"</span>);</span><br><span class="line">scanDirTracedLI(oemAppDir, mDefParseFlags</span><br><span class="line">        | PackageParser.PARSE_IS_SYSTEM</span><br><span class="line">        | PackageParser.PARSE_IS_SYSTEM_DIR, scanFlags, <span class="number">0</span>);</span><br></pre></td></tr></table></figure></p>
<p>扫描参数的设置为：int scanFlags = SCAN_NO_PATHS | SCAN_DEFER_DEX | SCAN_BOOTING | SCAN_INITIAL;</p>
<p>按照顺序扫描的目录有：</p>
<ul>
<li><strong>/vendor/overlay</strong></li>
<li><strong>/system/framework</strong></li>
<li><strong>/system/priv-app</strong></li>
<li><strong>/system/app</strong></li>
<li><strong>/vendor/app</strong></li>
<li><strong>/oem/app</strong></li>
</ul>
<p>调用 PMS.scanDirTracedLI 进行扫描，需要注意的是被扫描目录的顺序，这个顺序意味着：先被扫描到的文件，就是最终被用到的文件。</p>
<p>下面我们以 /system/app 目录为例，跟踪系统路径扫描的全过程！！</p>
<h2 id="2-1-PMS-scanDirTracedLI"><a href="#2-1-PMS-scanDirTracedLI" class="headerlink" title="2.1 PMS.scanDirTracedLI"></a>2.1 PMS.scanDirTracedLI</h2><p>调用 scanDirTracedLI 方法进行目录扫描：<br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">scanDirTracedLI</span><span class="params">(File dir, <span class="keyword">final</span> <span class="keyword">int</span> parseFlags, <span class="keyword">int</span> scanFlags, <span class="keyword">long</span> currentTime)</span> </span>&#123;</span><br><span class="line">    Trace.traceBegin(TRACE_TAG_PACKAGE_MANAGER, <span class="string">"scanDir"</span>);</span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">        </span><br><span class="line">        <span class="comment">//【2.2】进一步调用 scanDirLI 方法！</span></span><br><span class="line">        scanDirLI(dir, parseFlags, scanFlags, currentTime);</span><br><span class="line"></span><br><span class="line">    &#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">        Trace.traceEnd(TRACE_TAG_PACKAGE_MANAGER);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<h2 id="2-2-PMS-scanDirLI"><a href="#2-2-PMS-scanDirLI" class="headerlink" title="2.2 PMS.scanDirLI"></a>2.2 PMS.scanDirLI</h2><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">scanDirLI</span><span class="params">(File dir, <span class="keyword">final</span> <span class="keyword">int</span> parseFlags, <span class="keyword">int</span> scanFlags, <span class="keyword">long</span> currentTime)</span> </span>&#123;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// 获得 dir 目录中的文件集合！</span></span><br><span class="line">    <span class="keyword">final</span> File[] files = dir.listFiles();</span><br><span class="line">    <span class="keyword">if</span> (ArrayUtils.isEmpty(files)) &#123;</span><br><span class="line">        Log.d(TAG, <span class="string">"No files in app dir "</span> + dir);</span><br><span class="line">        <span class="keyword">return</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (DEBUG_PACKAGE_SCANNING) &#123;</span><br><span class="line">        Log.d(TAG, <span class="string">"Scanning app dir "</span> + dir + <span class="string">" scanFlags="</span> + scanFlags</span><br><span class="line">                + <span class="string">" flags=0x"</span> + Integer.toHexString(parseFlags));</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// 遍历 dir 目录下的所有文件！</span></span><br><span class="line">    <span class="keyword">for</span> (File file : files) &#123;</span><br><span class="line">        <span class="comment">//【1】判断 file 是否是 Package，必须要同时满足下面 2 个条件：</span></span><br><span class="line">        <span class="comment">// 1、file 以 ".apk" 结尾或者 file 是一个目录；</span></span><br><span class="line">        <span class="comment">// 2、file 不是存储类型的文件；</span></span><br><span class="line">        <span class="keyword">final</span> <span class="keyword">boolean</span> isPackage = (isApkFile(file) || file.isDirectory())</span><br><span class="line">                &amp;&amp; !PackageInstallerService.isStageName(file.getName());</span><br><span class="line">        <span class="keyword">if</span> (!isPackage) &#123;</span><br><span class="line">            <span class="keyword">continue</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">        </span><br><span class="line">            <span class="comment">//【2.3】如果 file 是 package 类型，继续调用 scanPackageTracedLI 进行扫描！</span></span><br><span class="line">            <span class="comment">// 解析参数增加：必须是 apk！</span></span><br><span class="line">            scanPackageTracedLI(file, parseFlags | PackageParser.PARSE_MUST_BE_APK,</span><br><span class="line">                    scanFlags, currentTime, <span class="keyword">null</span>);</span><br><span class="line"> </span><br><span class="line">        &#125; <span class="keyword">catch</span> (PackageManagerException e) &#123;</span><br><span class="line">            Slog.w(TAG, <span class="string">"Failed to parse "</span> + file + <span class="string">": "</span> + e.getMessage());</span><br><span class="line"></span><br><span class="line">             <span class="comment">// 如果扫描 data 分区的 Apk 失败，则删除 data 分区扫描失败的文件</span></span><br><span class="line">            <span class="keyword">if</span> ((parseFlags &amp; PackageParser.PARSE_IS_SYSTEM) == <span class="number">0</span> &amp;&amp;</span><br><span class="line">                    e.error == PackageManager.INSTALL_FAILED_INVALID_APK) &#123;</span><br><span class="line">                logCriticalInfo(Log.WARN, <span class="string">"Deleting invalid package at "</span> + file);</span><br><span class="line">                removeCodePathLI(file);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>注意这里的 try catch 语句，后面方法抛出的异常都是在这个进行 catch 的！</p>
<p>判断 file 是否是 Package，必须要同时满足下面 2 个条件：</p>
<ul>
<li>file 以 “.apk” 结尾或者 file 是一个目录；</li>
<li>file 不是存储类型的文件：<ul>
<li>file 不以 vmdl 开头且不以 .tmp 结尾；</li>
<li>file 不以 smdl 开头且不以 .tmp 结尾；</li>
<li>file 不以 smdl2tmp 开头；</li>
</ul>
</li>
</ul>
<h2 id="2-3-PMS-scanPackageTracedLI"><a href="#2-3-PMS-scanPackageTracedLI" class="headerlink" title="2.3 PMS.scanPackageTracedLI"></a>2.3 PMS.scanPackageTracedLI</h2><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">private</span> PackageParser.<span class="function">Package <span class="title">scanPackageTracedLI</span><span class="params">(File scanFile, <span class="keyword">final</span> <span class="keyword">int</span> parseFlags,</span></span></span><br><span class="line"><span class="function"><span class="params">        <span class="keyword">int</span> scanFlags, <span class="keyword">long</span> currentTime, UserHandle user)</span> <span class="keyword">throws</span> PackageManagerException </span>&#123;</span><br><span class="line">    Trace.traceBegin(TRACE_TAG_PACKAGE_MANAGER, <span class="string">"scanPackage"</span>);</span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line"></span><br><span class="line">        <span class="comment">//【2.4】继续调用 scanPackageLI，执行扫描解析！</span></span><br><span class="line">        <span class="keyword">return</span> scanPackageLI(scanFile, parseFlags, scanFlags, currentTime, user);</span><br><span class="line">    &#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">        Trace.traceEnd(TRACE_TAG_PACKAGE_MANAGER);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>继续：</p>
<h2 id="2-4-PMS-scanPackageLI"><a href="#2-4-PMS-scanPackageLI" class="headerlink" title="2.4 PMS.scanPackageLI"></a>2.4 PMS.scanPackageLI</h2><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">private</span> PackageParser.<span class="function">Package <span class="title">scanPackageLI</span><span class="params">(File scanFile, <span class="keyword">int</span> parseFlags, <span class="keyword">int</span> scanFlags,</span></span></span><br><span class="line"><span class="function"><span class="params">        <span class="keyword">long</span> currentTime, UserHandle user)</span> <span class="keyword">throws</span> PackageManagerException </span>&#123;</span><br><span class="line">    <span class="keyword">if</span> (DEBUG_INSTALL) Slog.d(TAG, <span class="string">"Parsing: "</span> + scanFile);</span><br><span class="line">    </span><br><span class="line">    <span class="comment">//【1】创建一个 PackageParser 对象，用来执行解析操作！</span></span><br><span class="line">    PackageParser pp = <span class="keyword">new</span> PackageParser();</span><br><span class="line">    pp.setSeparateProcesses(mSeparateProcesses);</span><br><span class="line">    pp.setOnlyCoreApps(mOnlyCore); <span class="comment">// mOnlyCore 为 false！</span></span><br><span class="line">    pp.setDisplayMetrics(mMetrics);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> ((scanFlags &amp; SCAN_TRUSTED_OVERLAY) != <span class="number">0</span>) &#123;</span><br><span class="line">        parseFlags |= PackageParser.PARSE_TRUSTED_OVERLAY;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    Trace.traceBegin(TRACE_TAG_PACKAGE_MANAGER, <span class="string">"parsePackage"</span>);</span><br><span class="line">    </span><br><span class="line">    <span class="comment">//【2】PackageParser.Package 用来保存解析结果！</span></span><br><span class="line">    <span class="keyword">final</span> PackageParser.Package pkg;</span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">        </span><br><span class="line">        <span class="comment">//【3.1】开始扫描解析 scanFile，返回解析结果！</span></span><br><span class="line">        pkg = pp.parsePackage(scanFile, parseFlags);</span><br><span class="line">        </span><br><span class="line">    &#125; <span class="keyword">catch</span> (PackageParserException e) &#123;</span><br><span class="line">        <span class="keyword">throw</span> PackageManagerException.from(e);</span><br><span class="line">    &#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">        Trace.traceEnd(TRACE_TAG_PACKAGE_MANAGER);</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">//【3.2】继续扫描！</span></span><br><span class="line">    <span class="keyword">return</span> scanPackageLI(pkg, scanFile, paraseFlags, scanFlags, currentTime, user);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>下面我们来分析扫描的过程！</p>
<h1 id="3-系统目录扫描-扫描阶段"><a href="#3-系统目录扫描-扫描阶段" class="headerlink" title="3 系统目录扫描 - 扫描阶段"></a>3 系统目录扫描 - 扫描阶段</h1><p>下面，我把 PackageParser 简称为 PParser！</p>
<h2 id="3-1-PParser-parsePackage"><a href="#3-1-PParser-parsePackage" class="headerlink" title="3.1 PParser.parsePackage"></a>3.1 PParser.parsePackage</h2><p>参数 flags 为 parseFlags，不同的目录取值不同：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> Package <span class="title">parsePackage</span><span class="params">(File packageFile, <span class="keyword">int</span> flags)</span> <span class="keyword">throws</span> PackageParserException </span>&#123;</span><br><span class="line">    <span class="keyword">if</span> (packageFile.isDirectory()) &#123;</span><br><span class="line">        <span class="comment">//【3.1.1】Android 5.0 以后进入下面的分支！</span></span><br><span class="line">        <span class="keyword">return</span> parseClusterPackage(packageFile, flags);</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;  </span><br><span class="line">        <span class="comment">//【3.1.2】Android 5.0 以前进入下面的分支！</span></span><br><span class="line">        <span class="keyword">return</span> parseMonolithicPackage(packageFile, flags);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>这里有 2 中解析方式：</p>
<ul>
<li>如果 packageFile 是一个目录的话，比如 /system/app/TimeService，那就采用第一种解析方式！</li>
<li>如果 packageFile 是一个非目录文件的话，比如 /system/app/MyService.apk，那就采用第二种解析方式！</li>
</ul>
<p>这里给大家解释一下：</p>
<p>Android 5.0 以前，apk 都是直接位于 app 目录下的，比如：/system/app/MyService.apk；</p>
<p>从 5.0 以后，谷歌引入了 apk 拆分机制，就是支持将一个 apk 拆分成很多个具有相同签名的子 apk，为了支持 apk 拆分，谷歌增加了一级目录：/system/app/MyService/，这个目录里会存放一到多个 apk，比如 base.apk，split.apk；</p>
<p>pms 在解析 package 时，会把多个 apk 的数据封装成一个 Package，加载到内存中！！</p>
<h3 id="3-1-1-PParser-parseClusterPackage"><a href="#3-1-1-PParser-parseClusterPackage" class="headerlink" title="3.1.1 PParser.parseClusterPackage"></a>3.1.1 PParser.parseClusterPackage</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">private</span> Package <span class="title">parseClusterPackage</span><span class="params">(File packageDir, <span class="keyword">int</span> flags)</span> <span class="keyword">throws</span> PackageParserException </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//【3.1.1.1】继续调用 parseClusterPackageLite 对 packageDir 目录下的！</span></span><br><span class="line">    <span class="keyword">final</span> PackageLite lite = parseClusterPackageLite(packageDir, <span class="number">0</span>);</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 根据前面的解析结果，判断是否有核心的应用，如果 lite 中没有核心应用，退出！</span></span><br><span class="line">    <span class="keyword">if</span> (mOnlyCoreApps &amp;&amp; !lite.coreApp) &#123;</span><br><span class="line">        <span class="keyword">throw</span> <span class="keyword">new</span> PackageParserException(INSTALL_PARSE_FAILED_MANIFEST_MALFORMED,</span><br><span class="line">                <span class="string">"Not a coreApp: "</span> + packageDir);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">final</span> AssetManager assets = <span class="keyword">new</span> AssetManager();</span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 装载应用程序的资源到 AssetManager！</span></span><br><span class="line">        loadApkIntoAssetManager(assets, lite.baseCodePath, flags);</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (!ArrayUtils.isEmpty(lite.splitCodePaths)) &#123; <span class="comment">// 如果 apk 被拆分了，加载子 apk 的资源！</span></span><br><span class="line">            <span class="keyword">for</span> (String path : lite.splitCodePaths) &#123;</span><br><span class="line">                loadApkIntoAssetManager(assets, path, flags);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        </span><br><span class="line">        <span class="comment">//【3.1.1.2】对核心 apk 解析，返回封装核心 apk 信息的 Package 对象 pkg!</span></span><br><span class="line">        <span class="keyword">final</span> File baseApk = <span class="keyword">new</span> File(lite.baseCodePath);</span><br><span class="line">        <span class="keyword">final</span> Package pkg = parseBaseApk(baseApk, assets, flags);</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (pkg == <span class="keyword">null</span>) &#123;</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> PackageParserException(INSTALL_PARSE_FAILED_NOT_APK,</span><br><span class="line">                    <span class="string">"Failed to parse base APK: "</span> + baseApk);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 如果 apk 被拆分了，那就对非核心 apk 也进行处理！</span></span><br><span class="line">        <span class="keyword">if</span> (!ArrayUtils.isEmpty(lite.splitNames)) &#123;</span><br><span class="line">            <span class="keyword">final</span> <span class="keyword">int</span> num = lite.splitNames.length;</span><br><span class="line">            pkg.splitNames = lite.splitNames;</span><br><span class="line">            pkg.splitCodePaths = lite.splitCodePaths;</span><br><span class="line">            pkg.splitRevisionCodes = lite.splitRevisionCodes;</span><br><span class="line">            pkg.splitFlags = <span class="keyword">new</span> <span class="keyword">int</span>[num];</span><br><span class="line">            pkg.splitPrivateFlags = <span class="keyword">new</span> <span class="keyword">int</span>[num];</span><br><span class="line"></span><br><span class="line">            <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; num; i++) &#123;</span><br><span class="line">                <span class="comment">//【3.1.1.3】对拆分后的非核心 apk 也进行解析！</span></span><br><span class="line">                parseSplitApk(pkg, i, assets, flags);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        pkg.setCodePath(packageDir.getAbsolutePath()); <span class="comment">// 设置 package 的 codePath！</span></span><br><span class="line">        pkg.setUse32bitAbi(lite.use32bitAbi);</span><br><span class="line">        </span><br><span class="line">        <span class="comment">// 返回解析对象！</span></span><br><span class="line">        <span class="keyword">return</span> pkg;</span><br><span class="line">    &#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">        IoUtils.closeQuietly(assets);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>这里我们分为 3 个阶段来看：</p>
<ul>
<li>对目录下的所有 apk 进行整体解析；</li>
<li>对目录中的核心 apk 进行解析；</li>
<li>如果 apk 被拆分了，对非核心应用进行解析；</li>
</ul>
<h4 id="3-1-1-1-PParser-parseClusterPackageLite"><a href="#3-1-1-1-PParser-parseClusterPackageLite" class="headerlink" title="3.1.1.1 PParser.parseClusterPackageLite"></a>3.1.1.1 PParser.parseClusterPackageLite</h4><p>首先，对目录下的所有 apk 进行整体解析：<br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">static</span> PackageLite <span class="title">parseClusterPackageLite</span><span class="params">(File packageDir, <span class="keyword">int</span> flags)</span></span></span><br><span class="line"><span class="function">        <span class="keyword">throws</span> PackageParserException </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">final</span> File[] files = packageDir.listFiles();</span><br><span class="line">    <span class="keyword">if</span> (ArrayUtils.isEmpty(files)) &#123;</span><br><span class="line">        <span class="keyword">throw</span> <span class="keyword">new</span> PackageParserException(INSTALL_PARSE_FAILED_NOT_APK,</span><br><span class="line">                <span class="string">"No packages found in split"</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    String packageName = <span class="keyword">null</span>;</span><br><span class="line">    <span class="keyword">int</span> versionCode = <span class="number">0</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">final</span> ArrayMap&lt;String, ApkLite&gt; apks = <span class="keyword">new</span> ArrayMap&lt;&gt;();</span><br><span class="line">    </span><br><span class="line">    <span class="comment">//【1】遍历目录下的所有 apk 文件，包括主 apk 和子 apk！</span></span><br><span class="line">    <span class="keyword">for</span> (File file : files) &#123;</span><br><span class="line">        <span class="keyword">if</span> (isApkFile(file)) &#123;</span><br><span class="line">            </span><br><span class="line">            <span class="comment">//【3.1.1.1.1】解析 apk，将解析数据保存到 ApkLite 中！</span></span><br><span class="line">            <span class="keyword">final</span> ApkLite lite = parseApkLite(file, flags);</span><br><span class="line"></span><br><span class="line">            <span class="keyword">if</span> (packageName == <span class="keyword">null</span>) &#123;</span><br><span class="line">                packageName = lite.packageName;</span><br><span class="line">                versionCode = lite.versionCode;</span><br><span class="line"></span><br><span class="line">            &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                <span class="keyword">if</span> (!packageName.equals(lite.packageName)) &#123;</span><br><span class="line">                    <span class="keyword">throw</span> <span class="keyword">new</span> PackageParserException(INSTALL_PARSE_FAILED_BAD_MANIFEST,</span><br><span class="line">                            <span class="string">"Inconsistent package "</span> + lite.packageName + <span class="string">" in "</span> + file</span><br><span class="line">                            + <span class="string">"; expected "</span> + packageName);</span><br><span class="line">                &#125;</span><br><span class="line">                <span class="keyword">if</span> (versionCode != lite.versionCode) &#123;</span><br><span class="line">                    <span class="keyword">throw</span> <span class="keyword">new</span> PackageParserException(INSTALL_PARSE_FAILED_BAD_MANIFEST,</span><br><span class="line">                            <span class="string">"Inconsistent version "</span> + lite.versionCode + <span class="string">" in "</span> + file</span><br><span class="line">                            + <span class="string">"; expected "</span> + versionCode);</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            <span class="comment">// 将解析得到的 ApkLite 对象添加到一个 ArrayMap 集合中！</span></span><br><span class="line">            <span class="comment">// 注意：对于核心 apk，splitName 为 null！</span></span><br><span class="line">            <span class="keyword">if</span> (apks.put(lite.splitName, lite) != <span class="keyword">null</span>) &#123;</span><br><span class="line">                <span class="keyword">throw</span> <span class="keyword">new</span> PackageParserException(INSTALL_PARSE_FAILED_BAD_MANIFEST,</span><br><span class="line">                        <span class="string">"Split name "</span> + lite.splitName</span><br><span class="line">                        + <span class="string">" defined more than once; most recent was "</span> + file);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//【2】从列表中移除核心 apk，保存到 baseApk 中，之所以 remove null，是因为 base apk 的 splitName 为 null！</span></span><br><span class="line">    <span class="comment">// 如果没有 base apk，那就报错！！</span></span><br><span class="line">    <span class="keyword">final</span> ApkLite baseApk = apks.remove(<span class="keyword">null</span>);</span><br><span class="line">    <span class="keyword">if</span> (baseApk == <span class="keyword">null</span>) &#123;</span><br><span class="line">        <span class="keyword">throw</span> <span class="keyword">new</span> PackageParserException(INSTALL_PARSE_FAILED_BAD_MANIFEST,</span><br><span class="line">                <span class="string">"Missing base APK in "</span> + packageDir);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//【3】处理非核心的 apk！</span></span><br><span class="line">    <span class="keyword">final</span> <span class="keyword">int</span> size = apks.size();</span><br><span class="line">    String[] splitNames = <span class="keyword">null</span>;</span><br><span class="line">    String[] splitCodePaths = <span class="keyword">null</span>;</span><br><span class="line">    <span class="keyword">int</span>[] splitRevisionCodes = <span class="keyword">null</span>;</span><br><span class="line">    <span class="keyword">if</span> (size &gt; <span class="number">0</span>) &#123;</span><br><span class="line">    </span><br><span class="line">        <span class="comment">//【3.1】获得非核心 apk 的 splitName，codePath 和 splitRevisionCodes！</span></span><br><span class="line">        splitNames = <span class="keyword">new</span> String[size];</span><br><span class="line">        splitCodePaths = <span class="keyword">new</span> String[size];</span><br><span class="line">        splitRevisionCodes = <span class="keyword">new</span> <span class="keyword">int</span>[size];</span><br><span class="line"></span><br><span class="line">        splitNames = apks.keySet().toArray(splitNames);</span><br><span class="line">        Arrays.sort(splitNames, sSplitNameComparator);</span><br><span class="line"></span><br><span class="line">        <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; size; i++) &#123;</span><br><span class="line">            splitCodePaths[i] = apks.get(splitNames[i]).codePath;</span><br><span class="line">            splitRevisionCodes[i] = apks.get(splitNames[i]).revisionCode;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">final</span> String codePath = packageDir.getAbsolutePath();</span><br><span class="line">    </span><br><span class="line">    <span class="comment">//【3.1.1.1.2】创建所有应用的 PackageLite 解析对象，返回！</span></span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">new</span> PackageLite(codePath, baseApk, splitNames, splitCodePaths,</span><br><span class="line">            splitRevisionCodes);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>这里调用了 parseApkLite 方法，解析 dir 下的核心 apk 和非核心 apk（如果有），然后获得非核心 apk 的 splitNames、splitCodePaths 和 splitRevisionCodes，最后创建 package 的 PackageLite 对象，并返回！</p>
<h5 id="3-1-1-1-1-PParser-parseApkLite-2"><a href="#3-1-1-1-1-PParser-parseApkLite-2" class="headerlink" title="3.1.1.1.1 PParser.parseApkLite[2]"></a>3.1.1.1.1 PParser.parseApkLite[2]</h5><p>解析 apk 文件！<br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">static</span> ApkLite <span class="title">parseApkLite</span><span class="params">(File apkFile, <span class="keyword">int</span> flags)</span></span></span><br><span class="line"><span class="function">        <span class="keyword">throws</span> PackageParserException </span>&#123;</span><br><span class="line">    <span class="keyword">final</span> String apkPath = apkFile.getAbsolutePath();</span><br><span class="line"></span><br><span class="line">    AssetManager assets = <span class="keyword">null</span>;</span><br><span class="line">    XmlResourceParser parser = <span class="keyword">null</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">    </span><br><span class="line">        <span class="comment">// 创建资源管理器</span></span><br><span class="line">        assets = <span class="keyword">new</span> AssetManager(); </span><br><span class="line">        assets.setConfiguration(<span class="number">0</span>, <span class="number">0</span>, <span class="keyword">null</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>,</span><br><span class="line">                Build.VERSION.RESOURCES_SDK_INT);</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 首先将 apk 中的资源加载到资源管理器 asserts 中。 </span></span><br><span class="line">        <span class="keyword">int</span> cookie = assets.addAssetPath(apkPath);</span><br><span class="line">        <span class="keyword">if</span> (cookie == <span class="number">0</span>) &#123;</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> PackageParserException(INSTALL_PARSE_FAILED_NOT_APK,</span><br><span class="line">                    <span class="string">"Failed to parse "</span> + apkPath);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">final</span> DisplayMetrics metrics = <span class="keyword">new</span> DisplayMetrics();</span><br><span class="line">        metrics.setToDefaults();</span><br><span class="line"></span><br><span class="line">        <span class="keyword">final</span> Resources res = <span class="keyword">new</span> Resources(assets, metrics, <span class="keyword">null</span>);</span><br><span class="line">        </span><br><span class="line">        <span class="comment">//【1】创建解析器，用来解析 apk 的 AndroidMenifest.xml 文件。</span></span><br><span class="line">        parser = assets.openXmlResourceParser(cookie, ANDROID_MANIFEST_FILENAME);</span><br><span class="line"></span><br><span class="line">        <span class="keyword">final</span> Signature[] signatures;</span><br><span class="line">        <span class="keyword">final</span> Certificate[][] certificates;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> ((flags &amp; PARSE_COLLECT_CERTIFICATES) != <span class="number">0</span>) &#123;</span><br><span class="line">            <span class="comment">// <span class="doctag">TODO:</span> factor signature related items out of Package object</span></span><br><span class="line">            <span class="keyword">final</span> Package tempPkg = <span class="keyword">new</span> Package(<span class="keyword">null</span>);</span><br><span class="line">            Trace.traceBegin(TRACE_TAG_PACKAGE_MANAGER, <span class="string">"collectCertificates"</span>);</span><br><span class="line">            <span class="keyword">try</span> &#123;</span><br><span class="line">                </span><br><span class="line">                <span class="comment">// 进行签名验证，并将签名保存在 signatures 中。</span></span><br><span class="line">                collectCertificates(tempPkg, apkFile, <span class="number">0</span> <span class="comment">/*parseFlags*/</span>);</span><br><span class="line">            &#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">                Trace.traceEnd(TRACE_TAG_PACKAGE_MANAGER);</span><br><span class="line">            &#125;</span><br><span class="line">            signatures = tempPkg.mSignatures;</span><br><span class="line">            certificates = tempPkg.mCertificates;</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            signatures = <span class="keyword">null</span>;</span><br><span class="line">            certificates = <span class="keyword">null</span>;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 将 &lt;manifest&gt; 标签的属性付给 attrs！</span></span><br><span class="line">        <span class="keyword">final</span> AttributeSet attrs = parser;</span><br><span class="line">        </span><br><span class="line">        <span class="comment">//【3.1.1.1.1.1】接着调用 parseApkLite 继续解析！</span></span><br><span class="line">        <span class="keyword">return</span> parseApkLite(apkPath, res, parser, attrs, flags, signatures, certificates);</span><br><span class="line"></span><br><span class="line">    &#125; <span class="keyword">catch</span> (XmlPullParserException | IOException | RuntimeException e) &#123;</span><br><span class="line">        <span class="keyword">throw</span> <span class="keyword">new</span> PackageParserException(INSTALL_PARSE_FAILED_UNEXPECTED_EXCEPTION,</span><br><span class="line">                <span class="string">"Failed to parse "</span> + apkPath, e);</span><br><span class="line">    &#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">        IoUtils.closeQuietly(parser);</span><br><span class="line">        IoUtils.closeQuietly(assets);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>调用重载函数 parseApkLite 函数，继续解析，参数传递：</p>
<h6 id="3-1-1-1-1-1-PParser-parseApkLite-7"><a href="#3-1-1-1-1-1-PParser-parseApkLite-7" class="headerlink" title="3.1.1.1.1.1 PParser.parseApkLite[7]"></a>3.1.1.1.1.1 PParser.parseApkLite[7]</h6><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">static</span> ApkLite <span class="title">parseApkLite</span><span class="params">(String codePath, Resources res, XmlPullParser parser,</span></span></span><br><span class="line"><span class="function"><span class="params">                AttributeSet attrs, <span class="keyword">int</span> flags, Signature[] signatures, Certificate[][] certificates)</span></span></span><br><span class="line"><span class="function">                <span class="keyword">throws</span> IOException, XmlPullParserException, PackageParserException </span>&#123;</span><br><span class="line">    <span class="comment">//【3.1.1.1.1.2】解析获得应用的 </span></span><br><span class="line">    <span class="keyword">final</span> Pair&lt;String, String&gt; packageSplit = parsePackageSplitNames(parser, attrs);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">int</span> installLocation = PARSE_DEFAULT_INSTALL_LOCATION;</span><br><span class="line">    <span class="keyword">int</span> versionCode = <span class="number">0</span>;</span><br><span class="line">    <span class="keyword">int</span> revisionCode = <span class="number">0</span>;</span><br><span class="line">    <span class="keyword">boolean</span> coreApp = <span class="keyword">false</span>;</span><br><span class="line">    <span class="keyword">boolean</span> multiArch = <span class="keyword">false</span>;</span><br><span class="line">    <span class="keyword">boolean</span> use32bitAbi = <span class="keyword">false</span>;</span><br><span class="line">    <span class="keyword">boolean</span> extractNativeLibs = <span class="keyword">true</span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//【1】解析 &lt;manifest&gt; 标签的属性！</span></span><br><span class="line">    <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; attrs.getAttributeCount(); i++) &#123;</span><br><span class="line">        <span class="keyword">final</span> String attr = attrs.getAttributeName(i);</span><br><span class="line">        <span class="comment">// 解析 android:installLocation 属性，表示安装位置，取值为 auto|internalOnly|preferExternal</span></span><br><span class="line">        <span class="keyword">if</span> (attr.equals(<span class="string">"installLocation"</span>)) &#123;</span><br><span class="line">            installLocation = attrs.getAttributeIntValue(i,</span><br><span class="line">                    PARSE_DEFAULT_INSTALL_LOCATION);</span><br><span class="line"></span><br><span class="line">        &#125; <span class="keyword">else</span> <span class="keyword">if</span> (attr.equals(<span class="string">"versionCode"</span>)) &#123; <span class="comment">// 解析版本号 versionCode！</span></span><br><span class="line">            versionCode = attrs.getAttributeIntValue(i, <span class="number">0</span>);</span><br><span class="line"></span><br><span class="line">        &#125; <span class="keyword">else</span> <span class="keyword">if</span> (attr.equals(<span class="string">"revisionCode"</span>)) &#123;</span><br><span class="line">            revisionCode = attrs.getAttributeIntValue(i, <span class="number">0</span>);</span><br><span class="line"></span><br><span class="line">        &#125; <span class="keyword">else</span> <span class="keyword">if</span> (attr.equals(<span class="string">"coreApp"</span>)) &#123; <span class="comment">// 是否是核心 apk</span></span><br><span class="line">            coreApp = attrs.getAttributeBooleanValue(i, <span class="keyword">false</span>);</span><br><span class="line"></span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//【2】接着，解析 manifest 标签的直接子标签！</span></span><br><span class="line">    <span class="keyword">int</span> type;</span><br><span class="line">    <span class="keyword">final</span> <span class="keyword">int</span> searchDepth = parser.getDepth() + <span class="number">1</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">final</span> List&lt;VerifierInfo&gt; verifiers = <span class="keyword">new</span> ArrayList&lt;VerifierInfo&gt;();</span><br><span class="line"></span><br><span class="line">    <span class="keyword">while</span> ((type = parser.next()) != XmlPullParser.END_DOCUMENT</span><br><span class="line">            &amp;&amp; (type != XmlPullParser.END_TAG || parser.getDepth() &gt;= searchDepth)) &#123;</span><br><span class="line">        <span class="keyword">if</span> (type == XmlPullParser.END_TAG || type == XmlPullParser.TEXT) &#123;</span><br><span class="line">            <span class="keyword">continue</span>;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment">//【2.1】解析 &lt;package-verifier&gt; 标签的属性！</span></span><br><span class="line">        <span class="keyword">if</span> (parser.getDepth() == searchDepth &amp;&amp; <span class="string">"package-verifier"</span>.equals(parser.getName())) &#123;</span><br><span class="line">            <span class="keyword">final</span> VerifierInfo verifier = parseVerifier(res, parser, attrs, flags);</span><br><span class="line">            <span class="keyword">if</span> (verifier != <span class="keyword">null</span>) &#123;</span><br><span class="line">                verifiers.add(verifier);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment">//【2.2】解析 &lt;application&gt; 标签的属性！</span></span><br><span class="line">        <span class="keyword">if</span> (parser.getDepth() == searchDepth &amp;&amp; <span class="string">"application"</span>.equals(parser.getName())) &#123;</span><br><span class="line">            <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; attrs.getAttributeCount(); ++i) &#123;</span><br><span class="line">                <span class="keyword">final</span> String attr = attrs.getAttributeName(i);</span><br><span class="line">                <span class="keyword">if</span> (<span class="string">"multiArch"</span>.equals(attr)) &#123;</span><br><span class="line">                    multiArch = attrs.getAttributeBooleanValue(i, <span class="keyword">false</span>);</span><br><span class="line">                &#125;</span><br><span class="line">                <span class="keyword">if</span> (<span class="string">"use32bitAbi"</span>.equals(attr)) &#123;</span><br><span class="line">                    use32bitAbi = attrs.getAttributeBooleanValue(i, <span class="keyword">false</span>);</span><br><span class="line">                &#125;</span><br><span class="line">                <span class="keyword">if</span> (<span class="string">"extractNativeLibs"</span>.equals(attr)) &#123;</span><br><span class="line">                    extractNativeLibs = attrs.getAttributeBooleanValue(i, <span class="keyword">true</span>);</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//【3.1.1.1.1.3】创建 apk 对应的 ApkLite 对象！！</span></span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">new</span> ApkLite(codePath, packageSplit.first, packageSplit.second, versionCode,</span><br><span class="line">            revisionCode, installLocation, verifiers, signatures, certificates, coreApp,</span><br><span class="line">            multiArch, use32bitAbi, extractNativeLibs);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h6 id="3-1-1-1-1-2-PParser-parsePackageSplitNames"><a href="#3-1-1-1-1-2-PParser-parsePackageSplitNames" class="headerlink" title="3.1.1.1.1.2 PParser.parsePackageSplitNames"></a>3.1.1.1.1.2 PParser.parsePackageSplitNames</h6><p>该方法用于解析 apk 的 “manifest” 标签的 package 属性和 split 属性！<br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">static</span> Pair&lt;String, String&gt; <span class="title">parsePackageSplitNames</span><span class="params">(XmlPullParser parser,</span></span></span><br><span class="line"><span class="function"><span class="params">        AttributeSet attrs)</span> <span class="keyword">throws</span> IOException, XmlPullParserException,</span></span><br><span class="line"><span class="function">        PackageParserException </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">int</span> type;</span><br><span class="line">    <span class="keyword">while</span> ((type = parser.next()) != XmlPullParser.START_TAG</span><br><span class="line">            &amp;&amp; type != XmlPullParser.END_DOCUMENT) &#123;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (type != XmlPullParser.START_TAG) &#123;</span><br><span class="line">        <span class="keyword">throw</span> <span class="keyword">new</span> PackageParserException(INSTALL_PARSE_FAILED_MANIFEST_MALFORMED,</span><br><span class="line">                <span class="string">"No start tag found"</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span> (!parser.getName().equals(TAG_MANIFEST)) &#123; <span class="comment">// 如果不是 manifest 标签！</span></span><br><span class="line">        <span class="keyword">throw</span> <span class="keyword">new</span> PackageParserException(INSTALL_PARSE_FAILED_MANIFEST_MALFORMED,</span><br><span class="line">                <span class="string">"No &lt;manifest&gt; tag"</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//【1】解析 manifest 标签的 package 属性！</span></span><br><span class="line">    <span class="keyword">final</span> String packageName = attrs.getAttributeValue(<span class="keyword">null</span>, <span class="string">"package"</span>);</span><br><span class="line">    <span class="keyword">if</span> (!<span class="string">"android"</span>.equals(packageName)) &#123;</span><br><span class="line">         <span class="comment">// 如果 package 不是 android，那需要校验格式！</span></span><br><span class="line">        <span class="keyword">final</span> String error = validateName(packageName, <span class="keyword">true</span>, <span class="keyword">true</span>);</span><br><span class="line">        <span class="keyword">if</span> (error != <span class="keyword">null</span>) &#123;</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> PackageParserException(INSTALL_PARSE_FAILED_BAD_PACKAGE_NAME,</span><br><span class="line">                    <span class="string">"Invalid manifest package: "</span> + error);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//【2】解析 manifest 标签的 split 属性！</span></span><br><span class="line">    String splitName = attrs.getAttributeValue(<span class="keyword">null</span>, <span class="string">"split"</span>);</span><br><span class="line">    <span class="keyword">if</span> (splitName != <span class="keyword">null</span>) &#123;</span><br><span class="line">        <span class="keyword">if</span> (splitName.length() == <span class="number">0</span>) &#123;</span><br><span class="line">            splitName = <span class="keyword">null</span>;</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            <span class="keyword">final</span> String error = validateName(splitName, <span class="keyword">false</span>, <span class="keyword">false</span>);</span><br><span class="line">            <span class="keyword">if</span> (error != <span class="keyword">null</span>) &#123;</span><br><span class="line">                <span class="keyword">throw</span> <span class="keyword">new</span> PackageParserException(INSTALL_PARSE_FAILED_BAD_PACKAGE_NAME,</span><br><span class="line">                        <span class="string">"Invalid manifest split: "</span> + error);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">//【3】返回 packageName 和 splitName 的 Pair 对象！</span></span><br><span class="line">    <span class="keyword">return</span> Pair.create(packageName.intern(),</span><br><span class="line">            (splitName != <span class="keyword">null</span>) ? splitName.intern() : splitName);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>接着创建一个 ApkLite 对象，用来封装 apk 的解析信息！</p>
<h6 id="3-1-1-1-1-3-new-ApkLite"><a href="#3-1-1-1-1-3-new-ApkLite" class="headerlink" title="3.1.1.1.1.3 new ApkLite"></a>3.1.1.1.1.3 new ApkLite</h6><p>最后，将结果封装为一个 ApkLite 对象，并返回！<br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> <span class="class"><span class="keyword">class</span> <span class="title">ApkLite</span> </span>&#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">final</span> String codePath;     <span class="comment">// apk 路径，就是 apk 文件的绝对路径！</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">final</span> String packageName;  <span class="comment">// 应用程序包名</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">final</span> String splitName;    <span class="comment">// 非核心 apk 包名</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">final</span> <span class="keyword">int</span> versionCode;     <span class="comment">// 版本号</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">final</span> <span class="keyword">int</span> revisionCode;    <span class="comment">// 修订版本号</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">final</span> <span class="keyword">int</span> installLocation; <span class="comment">// 安装位置</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">final</span> VerifierInfo[] verifiers; <span class="comment">// 校验信息</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">final</span> Signature[] signatures;  <span class="comment">// 签名信息</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">final</span> Certificate[][] certificates; <span class="comment">// 证书信息</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">final</span> <span class="keyword">boolean</span> coreApp;     <span class="comment">// 是否是核心应用</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">final</span> <span class="keyword">boolean</span> multiArch;   <span class="comment">// 是否支持多软件架构</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">final</span> <span class="keyword">boolean</span> use32bitAbi; <span class="comment">// 是否使用 32 位系统指令集</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">final</span> <span class="keyword">boolean</span> extractNativeLibs; <span class="comment">// 是否依赖额外的本地库</span></span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="title">ApkLite</span><span class="params">(String codePath, String packageName, String splitName, <span class="keyword">int</span> versionCode,</span></span></span><br><span class="line"><span class="function"><span class="params">            <span class="keyword">int</span> revisionCode, <span class="keyword">int</span> installLocation, List&lt;VerifierInfo&gt; verifiers,</span></span></span><br><span class="line"><span class="function"><span class="params">            Signature[] signatures, Certificate[][] certificates, <span class="keyword">boolean</span> coreApp,</span></span></span><br><span class="line"><span class="function"><span class="params">            <span class="keyword">boolean</span> multiArch, <span class="keyword">boolean</span> use32bitAbi, <span class="keyword">boolean</span> extractNativeLibs)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">this</span>.codePath = codePath;</span><br><span class="line">        <span class="keyword">this</span>.packageName = packageName;</span><br><span class="line">        <span class="keyword">this</span>.splitName = splitName;</span><br><span class="line">        <span class="keyword">this</span>.versionCode = versionCode;</span><br><span class="line">        <span class="keyword">this</span>.revisionCode = revisionCode;</span><br><span class="line">        <span class="keyword">this</span>.installLocation = installLocation;</span><br><span class="line">        <span class="keyword">this</span>.verifiers = verifiers.toArray(<span class="keyword">new</span> VerifierInfo[verifiers.size()]);</span><br><span class="line">        <span class="keyword">this</span>.signatures = signatures;</span><br><span class="line">        <span class="keyword">this</span>.certificates = certificates;</span><br><span class="line">        <span class="keyword">this</span>.coreApp = coreApp;</span><br><span class="line">        <span class="keyword">this</span>.multiArch = multiArch;</span><br><span class="line">        <span class="keyword">this</span>.use32bitAbi = use32bitAbi;</span><br><span class="line">        <span class="keyword">this</span>.extractNativeLibs = extractNativeLibs;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>然后返回，回到 PP.parseClusterPackageLite 函数中，根据解析的结果，创建 PackageLite 对象：</p>
<h5 id="3-1-1-1-2-new-PackageLite"><a href="#3-1-1-1-2-new-PackageLite" class="headerlink" title="3.1.1.1.2 new PackageLite"></a>3.1.1.1.2 new PackageLite</h5><p>PackageLite 用来封装一个应用程序包的信息，PackageLite 的构造器如下：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> <span class="class"><span class="keyword">class</span> <span class="title">PackageLite</span> </span>&#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">final</span> String packageName; <span class="comment">// base apk 应用程序包名；</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">final</span> <span class="keyword">int</span> versionCode;    <span class="comment">// base apk 的版本号；</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">final</span> <span class="keyword">int</span> installLocation;  <span class="comment">// base apk 的安装位置；</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">final</span> VerifierInfo[] verifiers; <span class="comment">// base apk 的安装位置；</span></span><br><span class="line">    </span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">final</span> String[] splitNames; <span class="comment">// 非核心 apk 的名称；</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">final</span> String codePath;  <span class="comment">// 应用程序包的绝对路径，/system/app/com.coolqi.papapa</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">final</span> String baseCodePath;   <span class="comment">// base apk 的路径，/system/app/com.coolqi.papapa/base.apk</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">final</span> String[] splitCodePaths;  <span class="comment">//非核心 apk 的路径</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">final</span> <span class="keyword">int</span> baseRevisionCode; <span class="comment">// 核心 apk 的修订版版本号</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">final</span> <span class="keyword">int</span>[] splitRevisionCodes; <span class="comment">// 非核心 apk 的修订版版本号</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">final</span> <span class="keyword">boolean</span> coreApp; <span class="comment">// 是否有核心 apk！</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">final</span> <span class="keyword">boolean</span> multiArch; <span class="comment">// 是否支持多软件平台架构！</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">final</span> <span class="keyword">boolean</span> use32bitAbi; <span class="comment">// 是否使用 23 位的系统指令集！</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">final</span> <span class="keyword">boolean</span> extractNativeLibs; <span class="comment">// 是否支持！</span></span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="title">PackageLite</span><span class="params">(String codePath, ApkLite baseApk, String[] splitNames,</span></span></span><br><span class="line"><span class="function"><span class="params">            String[] splitCodePaths, <span class="keyword">int</span>[] splitRevisionCodes)</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">this</span>.packageName = baseApk.packageName;</span><br><span class="line">        <span class="keyword">this</span>.versionCode = baseApk.versionCode;</span><br><span class="line">        <span class="keyword">this</span>.installLocation = baseApk.installLocation;</span><br><span class="line">        <span class="keyword">this</span>.verifiers = baseApk.verifiers;</span><br><span class="line">        <span class="keyword">this</span>.splitNames = splitNames;</span><br><span class="line">        <span class="keyword">this</span>.codePath = codePath;</span><br><span class="line">        <span class="keyword">this</span>.baseCodePath = baseApk.codePath;</span><br><span class="line">        <span class="keyword">this</span>.splitCodePaths = splitCodePaths;</span><br><span class="line">        <span class="keyword">this</span>.baseRevisionCode = baseApk.revisionCode;</span><br><span class="line">        <span class="keyword">this</span>.splitRevisionCodes = splitRevisionCodes;</span><br><span class="line">        <span class="keyword">this</span>.coreApp = baseApk.coreApp;</span><br><span class="line">        <span class="keyword">this</span>.multiArch = baseApk.multiArch;</span><br><span class="line">        <span class="keyword">this</span>.use32bitAbi = baseApk.use32bitAbi;</span><br><span class="line">        <span class="keyword">this</span>.extractNativeLibs = baseApk.extractNativeLibs;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>这里我们不在过多分析！！</p>
<h4 id="3-1-1-2-PParser-parseBaseApk-3"><a href="#3-1-1-2-PParser-parseBaseApk-3" class="headerlink" title="3.1.1.2 PParser.parseBaseApk[3]"></a>3.1.1.2 PParser.parseBaseApk[3]</h4><p>解析 base apk：<br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">private</span> Package <span class="title">parseBaseApk</span><span class="params">(File apkFile, AssetManager assets, <span class="keyword">int</span> flags)</span></span></span><br><span class="line"><span class="function">        <span class="keyword">throws</span> PackageParserException </span>&#123;</span><br><span class="line">    <span class="keyword">final</span> String apkPath = apkFile.getAbsolutePath();</span><br><span class="line"></span><br><span class="line">    String volumeUuid = <span class="keyword">null</span>;</span><br><span class="line">    <span class="keyword">if</span> (apkPath.startsWith(MNT_EXPAND)) &#123; <span class="comment">// 解析 /mnt/expand/</span></span><br><span class="line">        <span class="keyword">final</span> <span class="keyword">int</span> end = apkPath.indexOf(<span class="string">'/'</span>, MNT_EXPAND.length());</span><br><span class="line">        volumeUuid = apkPath.substring(MNT_EXPAND.length(), end);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    mParseError = PackageManager.INSTALL_SUCCEEDED;</span><br><span class="line">    mArchiveSourcePath = apkFile.getAbsolutePath();</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (DEBUG_JAR) Slog.d(TAG, <span class="string">"Scanning base APK: "</span> + apkPath);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">final</span> <span class="keyword">int</span> cookie = loadApkIntoAssetManager(assets, apkPath, flags);</span><br><span class="line"></span><br><span class="line">    Resources res = <span class="keyword">null</span>;</span><br><span class="line">    XmlResourceParser parser = <span class="keyword">null</span>;</span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">        res = <span class="keyword">new</span> Resources(assets, mMetrics, <span class="keyword">null</span>);</span><br><span class="line">        assets.setConfiguration(<span class="number">0</span>, <span class="number">0</span>, <span class="keyword">null</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>,</span><br><span class="line">                Build.VERSION.RESOURCES_SDK_INT);</span><br><span class="line"></span><br><span class="line">        <span class="comment">//【1】用于解析 AndroidManifest.xml 文件！      </span></span><br><span class="line">        parser = assets.openXmlResourceParser(cookie, ANDROID_MANIFEST_FILENAME);</span><br><span class="line"></span><br><span class="line">        <span class="keyword">final</span> String[] outError = <span class="keyword">new</span> String[<span class="number">1</span>];</span><br><span class="line">        </span><br><span class="line">        <span class="comment">//【3.1.1.2】解析核心 apk！</span></span><br><span class="line">        <span class="keyword">final</span> Package pkg = parseBaseApk(res, parser, flags, outError);</span><br><span class="line">        <span class="keyword">if</span> (pkg == <span class="keyword">null</span>) &#123;</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> PackageParserException(mParseError,</span><br><span class="line">                    apkPath + <span class="string">" (at "</span> + parser.getPositionDescription() + <span class="string">"): "</span> + outError[<span class="number">0</span>]);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        pkg.setVolumeUuid(volumeUuid);</span><br><span class="line">        pkg.setApplicationVolumeUuid(volumeUuid);</span><br><span class="line">        pkg.setBaseCodePath(apkPath);</span><br><span class="line">        pkg.setSignatures(<span class="keyword">null</span>);</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> pkg;</span><br><span class="line"></span><br><span class="line">    &#125; <span class="keyword">catch</span> (PackageParserException e) &#123;</span><br><span class="line">        <span class="keyword">throw</span> e;</span><br><span class="line">    &#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">        <span class="keyword">throw</span> <span class="keyword">new</span> PackageParserException(INSTALL_PARSE_FAILED_UNEXPECTED_EXCEPTION,</span><br><span class="line">                <span class="string">"Failed to read manifest from "</span> + apkPath, e);</span><br><span class="line">    &#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">        IoUtils.closeQuietly(parser);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>接着，调用重载 parseBaseApk 方法：</p>
<h5 id="3-1-1-2-1-PParser-parseBaseApk-4"><a href="#3-1-1-2-1-PParser-parseBaseApk-4" class="headerlink" title="3.1.1.2.1 PParser.parseBaseApk[4]"></a>3.1.1.2.1 PParser.parseBaseApk[4]</h5><p>我们继续来看：<br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">private</span> Package <span class="title">parseBaseApk</span><span class="params">(Resources res, XmlResourceParser parser, <span class="keyword">int</span> flags,</span></span></span><br><span class="line"><span class="function"><span class="params">        String[] outError)</span> <span class="keyword">throws</span> XmlPullParserException, IOException </span>&#123;</span><br><span class="line">    <span class="keyword">final</span> String splitName;</span><br><span class="line">    <span class="keyword">final</span> String pkgName;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">        <span class="comment">//【3.1.1.1.1.2】解析 &lt;manifest&gt; 标签，获得 packageName 和 splitName，</span></span><br><span class="line">        <span class="comment">// 以 Pair&lt;packageName, splitName&gt; 的形式返回！</span></span><br><span class="line">        Pair&lt;String, String&gt; packageSplit = parsePackageSplitNames(parser, parser);</span><br><span class="line">        pkgName = packageSplit.first;</span><br><span class="line">        splitName = packageSplit.second;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (!TextUtils.isEmpty(splitName)) &#123;</span><br><span class="line">            outError[<span class="number">0</span>] = <span class="string">"Expected base APK, but found split "</span> + splitName;</span><br><span class="line">            mParseError = PackageManager.INSTALL_PARSE_FAILED_BAD_PACKAGE_NAME;</span><br><span class="line">            <span class="keyword">return</span> <span class="keyword">null</span>;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">    &#125; <span class="keyword">catch</span> (PackageParserException e) &#123;</span><br><span class="line"></span><br><span class="line">        mParseError = PackageManager.INSTALL_PARSE_FAILED_BAD_PACKAGE_NAME;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">null</span>;</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//【3.1.3】创建一个 Package 对象，用于保存最终的解析信息！</span></span><br><span class="line">    <span class="keyword">final</span> Package pkg = <span class="keyword">new</span> Package(pkgName);</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 解析 &lt;manifest&gt; 标签，获得 versionCode、revisionCode、versionName、coreApp 值！</span></span><br><span class="line">    TypedArray sa = res.obtainAttributes(parser,</span><br><span class="line">            com.android.internal.R.styleable.AndroidManifest);</span><br><span class="line">            </span><br><span class="line">    pkg.mVersionCode = pkg.applicationInfo.versionCode = sa.getInteger(</span><br><span class="line">            com.android.internal.R.styleable.AndroidManifest_versionCode, <span class="number">0</span>);</span><br><span class="line">            </span><br><span class="line">    pkg.baseRevisionCode = sa.getInteger(</span><br><span class="line">            com.android.internal.R.styleable.AndroidManifest_revisionCode, <span class="number">0</span>);</span><br><span class="line">            </span><br><span class="line">    pkg.mVersionName = sa.getNonConfigurationString(</span><br><span class="line">            com.android.internal.R.styleable.AndroidManifest_versionName, <span class="number">0</span>);</span><br><span class="line">            </span><br><span class="line">    <span class="keyword">if</span> (pkg.mVersionName != <span class="keyword">null</span>) &#123;</span><br><span class="line">        pkg.mVersionName = pkg.mVersionName.intern();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    pkg.coreApp = parser.getAttributeBooleanValue(<span class="keyword">null</span>, <span class="string">"coreApp"</span>, <span class="keyword">false</span>);</span><br><span class="line"></span><br><span class="line">    sa.recycle();</span><br><span class="line"></span><br><span class="line">    <span class="comment">//【3.1.1.2.2】接着，调用 parseBaseApkCommon 方法，继续解析！</span></span><br><span class="line">    <span class="keyword">return</span> parseBaseApkCommon(pkg, <span class="keyword">null</span>, res, parser, flags, outError);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<h5 id="3-1-1-2-2-PParser-parseBaseApkCommon-6"><a href="#3-1-1-2-2-PParser-parseBaseApkCommon-6" class="headerlink" title="3.1.1.2.2 PParser.parseBaseApkCommon [6]"></a>3.1.1.2.2 PParser.parseBaseApkCommon [6]</h5><p>进入最终的解析方法中：</p>
<ul>
<li>Package pkg：应用程序的信息封装对象；</li>
<li>Set<string> acceptedTags：需要解析的标签，如果传入 null ，表示解析所有，这里传入 null；</string></li>
<li>Resources res：</li>
<li>XmlResourceParser parser：</li>
<li>int flags：</li>
<li>String[] outError：用于保存解析过程中的错误信息；</li>
</ul>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br><span class="line">212</span><br><span class="line">213</span><br><span class="line">214</span><br><span class="line">215</span><br><span class="line">216</span><br><span class="line">217</span><br><span class="line">218</span><br><span class="line">219</span><br><span class="line">220</span><br><span class="line">221</span><br><span class="line">222</span><br><span class="line">223</span><br><span class="line">224</span><br><span class="line">225</span><br><span class="line">226</span><br><span class="line">227</span><br><span class="line">228</span><br><span class="line">229</span><br><span class="line">230</span><br><span class="line">231</span><br><span class="line">232</span><br><span class="line">233</span><br><span class="line">234</span><br><span class="line">235</span><br><span class="line">236</span><br><span class="line">237</span><br><span class="line">238</span><br><span class="line">239</span><br><span class="line">240</span><br><span class="line">241</span><br><span class="line">242</span><br><span class="line">243</span><br><span class="line">244</span><br><span class="line">245</span><br><span class="line">246</span><br><span class="line">247</span><br><span class="line">248</span><br><span class="line">249</span><br><span class="line">250</span><br><span class="line">251</span><br><span class="line">252</span><br><span class="line">253</span><br><span class="line">254</span><br><span class="line">255</span><br><span class="line">256</span><br><span class="line">257</span><br><span class="line">258</span><br><span class="line">259</span><br><span class="line">260</span><br><span class="line">261</span><br><span class="line">262</span><br><span class="line">263</span><br><span class="line">264</span><br><span class="line">265</span><br><span class="line">266</span><br><span class="line">267</span><br><span class="line">268</span><br><span class="line">269</span><br><span class="line">270</span><br><span class="line">271</span><br><span class="line">272</span><br><span class="line">273</span><br><span class="line">274</span><br><span class="line">275</span><br><span class="line">276</span><br><span class="line">277</span><br><span class="line">278</span><br><span class="line">279</span><br><span class="line">280</span><br><span class="line">281</span><br><span class="line">282</span><br><span class="line">283</span><br><span class="line">284</span><br><span class="line">285</span><br><span class="line">286</span><br><span class="line">287</span><br><span class="line">288</span><br><span class="line">289</span><br><span class="line">290</span><br><span class="line">291</span><br><span class="line">292</span><br><span class="line">293</span><br><span class="line">294</span><br><span class="line">295</span><br><span class="line">296</span><br><span class="line">297</span><br><span class="line">298</span><br><span class="line">299</span><br><span class="line">300</span><br><span class="line">301</span><br><span class="line">302</span><br><span class="line">303</span><br><span class="line">304</span><br><span class="line">305</span><br><span class="line">306</span><br><span class="line">307</span><br><span class="line">308</span><br><span class="line">309</span><br><span class="line">310</span><br><span class="line">311</span><br><span class="line">312</span><br><span class="line">313</span><br><span class="line">314</span><br><span class="line">315</span><br><span class="line">316</span><br><span class="line">317</span><br><span class="line">318</span><br><span class="line">319</span><br><span class="line">320</span><br><span class="line">321</span><br><span class="line">322</span><br><span class="line">323</span><br><span class="line">324</span><br><span class="line">325</span><br><span class="line">326</span><br><span class="line">327</span><br><span class="line">328</span><br><span class="line">329</span><br><span class="line">330</span><br><span class="line">331</span><br><span class="line">332</span><br><span class="line">333</span><br><span class="line">334</span><br><span class="line">335</span><br><span class="line">336</span><br><span class="line">337</span><br><span class="line">338</span><br><span class="line">339</span><br><span class="line">340</span><br><span class="line">341</span><br><span class="line">342</span><br><span class="line">343</span><br><span class="line">344</span><br><span class="line">345</span><br><span class="line">346</span><br><span class="line">347</span><br><span class="line">348</span><br><span class="line">349</span><br><span class="line">350</span><br><span class="line">351</span><br><span class="line">352</span><br><span class="line">353</span><br><span class="line">354</span><br><span class="line">355</span><br><span class="line">356</span><br><span class="line">357</span><br><span class="line">358</span><br><span class="line">359</span><br><span class="line">360</span><br><span class="line">361</span><br><span class="line">362</span><br><span class="line">363</span><br><span class="line">364</span><br><span class="line">365</span><br><span class="line">366</span><br><span class="line">367</span><br><span class="line">368</span><br><span class="line">369</span><br><span class="line">370</span><br><span class="line">371</span><br><span class="line">372</span><br><span class="line">373</span><br><span class="line">374</span><br><span class="line">375</span><br><span class="line">376</span><br><span class="line">377</span><br><span class="line">378</span><br><span class="line">379</span><br><span class="line">380</span><br><span class="line">381</span><br><span class="line">382</span><br><span class="line">383</span><br><span class="line">384</span><br><span class="line">385</span><br><span class="line">386</span><br><span class="line">387</span><br><span class="line">388</span><br><span class="line">389</span><br><span class="line">390</span><br><span class="line">391</span><br><span class="line">392</span><br><span class="line">393</span><br><span class="line">394</span><br><span class="line">395</span><br><span class="line">396</span><br><span class="line">397</span><br><span class="line">398</span><br><span class="line">399</span><br><span class="line">400</span><br><span class="line">401</span><br><span class="line">402</span><br><span class="line">403</span><br><span class="line">404</span><br><span class="line">405</span><br><span class="line">406</span><br><span class="line">407</span><br><span class="line">408</span><br><span class="line">409</span><br><span class="line">410</span><br><span class="line">411</span><br><span class="line">412</span><br><span class="line">413</span><br><span class="line">414</span><br><span class="line">415</span><br><span class="line">416</span><br><span class="line">417</span><br><span class="line">418</span><br><span class="line">419</span><br><span class="line">420</span><br><span class="line">421</span><br><span class="line">422</span><br><span class="line">423</span><br><span class="line">424</span><br><span class="line">425</span><br><span class="line">426</span><br><span class="line">427</span><br><span class="line">428</span><br><span class="line">429</span><br><span class="line">430</span><br><span class="line">431</span><br><span class="line">432</span><br><span class="line">433</span><br><span class="line">434</span><br><span class="line">435</span><br><span class="line">436</span><br><span class="line">437</span><br><span class="line">438</span><br><span class="line">439</span><br><span class="line">440</span><br><span class="line">441</span><br><span class="line">442</span><br><span class="line">443</span><br><span class="line">444</span><br><span class="line">445</span><br><span class="line">446</span><br><span class="line">447</span><br><span class="line">448</span><br><span class="line">449</span><br><span class="line">450</span><br><span class="line">451</span><br><span class="line">452</span><br><span class="line">453</span><br><span class="line">454</span><br><span class="line">455</span><br><span class="line">456</span><br><span class="line">457</span><br><span class="line">458</span><br><span class="line">459</span><br><span class="line">460</span><br><span class="line">461</span><br><span class="line">462</span><br><span class="line">463</span><br><span class="line">464</span><br><span class="line">465</span><br><span class="line">466</span><br><span class="line">467</span><br><span class="line">468</span><br><span class="line">469</span><br><span class="line">470</span><br><span class="line">471</span><br><span class="line">472</span><br><span class="line">473</span><br><span class="line">474</span><br><span class="line">475</span><br><span class="line">476</span><br><span class="line">477</span><br><span class="line">478</span><br><span class="line">479</span><br><span class="line">480</span><br><span class="line">481</span><br><span class="line">482</span><br><span class="line">483</span><br><span class="line">484</span><br><span class="line">485</span><br><span class="line">486</span><br><span class="line">487</span><br><span class="line">488</span><br><span class="line">489</span><br><span class="line">490</span><br><span class="line">491</span><br><span class="line">492</span><br><span class="line">493</span><br><span class="line">494</span><br><span class="line">495</span><br><span class="line">496</span><br><span class="line">497</span><br><span class="line">498</span><br><span class="line">499</span><br><span class="line">500</span><br><span class="line">501</span><br><span class="line">502</span><br><span class="line">503</span><br><span class="line">504</span><br><span class="line">505</span><br><span class="line">506</span><br><span class="line">507</span><br><span class="line">508</span><br><span class="line">509</span><br><span class="line">510</span><br><span class="line">511</span><br><span class="line">512</span><br><span class="line">513</span><br><span class="line">514</span><br><span class="line">515</span><br><span class="line">516</span><br><span class="line">517</span><br><span class="line">518</span><br><span class="line">519</span><br><span class="line">520</span><br><span class="line">521</span><br><span class="line">522</span><br><span class="line">523</span><br><span class="line">524</span><br><span class="line">525</span><br><span class="line">526</span><br><span class="line">527</span><br><span class="line">528</span><br><span class="line">529</span><br><span class="line">530</span><br><span class="line">531</span><br><span class="line">532</span><br><span class="line">533</span><br><span class="line">534</span><br><span class="line">535</span><br><span class="line">536</span><br><span class="line">537</span><br><span class="line">538</span><br><span class="line">539</span><br><span class="line">540</span><br><span class="line">541</span><br><span class="line">542</span><br><span class="line">543</span><br><span class="line">544</span><br><span class="line">545</span><br><span class="line">546</span><br><span class="line">547</span><br><span class="line">548</span><br><span class="line">549</span><br><span class="line">550</span><br><span class="line">551</span><br><span class="line">552</span><br><span class="line">553</span><br><span class="line">554</span><br><span class="line">555</span><br><span class="line">556</span><br><span class="line">557</span><br><span class="line">558</span><br><span class="line">559</span><br><span class="line">560</span><br><span class="line">561</span><br><span class="line">562</span><br><span class="line">563</span><br><span class="line">564</span><br><span class="line">565</span><br><span class="line">566</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">private</span> Package <span class="title">parseBaseApkCommon</span><span class="params">(Package pkg, Set&lt;String&gt; acceptedTags, Resources res,</span></span></span><br><span class="line"><span class="function"><span class="params">        XmlResourceParser parser, <span class="keyword">int</span> flags, String[] outError)</span> <span class="keyword">throws</span> XmlPullParserException,</span></span><br><span class="line"><span class="function">        IOException </span>&#123;</span><br><span class="line">    mParseInstrumentationArgs = <span class="keyword">null</span>;</span><br><span class="line">    mParseActivityArgs = <span class="keyword">null</span>;</span><br><span class="line">    mParseServiceArgs = <span class="keyword">null</span>;</span><br><span class="line">    mParseProviderArgs = <span class="keyword">null</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">int</span> type;</span><br><span class="line">    <span class="keyword">boolean</span> foundApp = <span class="keyword">false</span>;</span><br><span class="line"></span><br><span class="line">    TypedArray sa = res.obtainAttributes(parser,</span><br><span class="line">            com.android.internal.R.styleable.AndroidManifest);</span><br><span class="line">    </span><br><span class="line">    <span class="comment">//【1】获得 sharedUserId 属性！</span></span><br><span class="line">    String str = sa.getNonConfigurationString(</span><br><span class="line">            com.android.internal.R.styleable.AndroidManifest_sharedUserId, <span class="number">0</span>);</span><br><span class="line">    <span class="keyword">if</span> (str != <span class="keyword">null</span> &amp;&amp; str.length() &gt; <span class="number">0</span>) &#123;</span><br><span class="line">        String nameError = validateName(str, <span class="keyword">true</span>, <span class="keyword">false</span>);</span><br><span class="line">        <span class="keyword">if</span> (nameError != <span class="keyword">null</span> &amp;&amp; !<span class="string">"android"</span>.equals(pkg.packageName)) &#123;</span><br><span class="line">            outError[<span class="number">0</span>] = <span class="string">"&lt;manifest&gt; specifies bad sharedUserId name \""</span></span><br><span class="line">                + str + <span class="string">"\": "</span> + nameError;</span><br><span class="line">            mParseError = PackageManager.INSTALL_PARSE_FAILED_BAD_SHARED_USER_ID;</span><br><span class="line">            <span class="keyword">return</span> <span class="keyword">null</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        pkg.mSharedUserId = str.intern();</span><br><span class="line">        pkg.mSharedUserLabel = sa.getResourceId(</span><br><span class="line">                com.android.internal.R.styleable.AndroidManifest_sharedUserLabel, <span class="number">0</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//【2】获得 installLocation 属性！</span></span><br><span class="line">    pkg.installLocation = sa.getInteger(</span><br><span class="line">            com.android.internal.R.styleable.AndroidManifest_installLocation,</span><br><span class="line">            PARSE_DEFAULT_INSTALL_LOCATION);</span><br><span class="line">    pkg.applicationInfo.installLocation = pkg.installLocation;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="comment">/* Set the global "forward lock" flag */</span></span><br><span class="line">    <span class="keyword">if</span> ((flags &amp; PARSE_FORWARD_LOCK) != <span class="number">0</span>) &#123;</span><br><span class="line">        pkg.applicationInfo.privateFlags |= ApplicationInfo.PRIVATE_FLAG_FORWARD_LOCK;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/* Set the global "on SD card" flag */</span></span><br><span class="line">    <span class="keyword">if</span> ((flags &amp; PARSE_EXTERNAL_STORAGE) != <span class="number">0</span>) &#123;</span><br><span class="line">        pkg.applicationInfo.flags |= ApplicationInfo.FLAG_EXTERNAL_STORAGE;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> ((flags &amp; PARSE_IS_EPHEMERAL) != <span class="number">0</span>) &#123;</span><br><span class="line">        pkg.applicationInfo.privateFlags |= ApplicationInfo.PRIVATE_FLAG_EPHEMERAL;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// Resource boolean are -1, so 1 means we don't know the value.</span></span><br><span class="line">    <span class="keyword">int</span> supportsSmallScreens = <span class="number">1</span>;</span><br><span class="line">    <span class="keyword">int</span> supportsNormalScreens = <span class="number">1</span>;</span><br><span class="line">    <span class="keyword">int</span> supportsLargeScreens = <span class="number">1</span>;</span><br><span class="line">    <span class="keyword">int</span> supportsXLargeScreens = <span class="number">1</span>;</span><br><span class="line">    <span class="keyword">int</span> resizeable = <span class="number">1</span>;</span><br><span class="line">    <span class="keyword">int</span> anyDensity = <span class="number">1</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">int</span> outerDepth = parser.getDepth();</span><br><span class="line">    <span class="keyword">while</span> ((type = parser.next()) != XmlPullParser.END_DOCUMENT</span><br><span class="line">            &amp;&amp; (type != XmlPullParser.END_TAG || parser.getDepth() &gt; outerDepth)) &#123;</span><br><span class="line">        <span class="keyword">if</span> (type == XmlPullParser.END_TAG || type == XmlPullParser.TEXT) &#123;</span><br><span class="line">            <span class="keyword">continue</span>;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        String tagName = parser.getName();</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (acceptedTags != <span class="keyword">null</span> &amp;&amp; !acceptedTags.contains(tagName)) &#123;</span><br><span class="line">            Slog.w(TAG, <span class="string">"Skipping unsupported element under &lt;manifest&gt;: "</span></span><br><span class="line">                    + tagName + <span class="string">" at "</span> + mArchiveSourcePath + <span class="string">" "</span></span><br><span class="line">                    + parser.getPositionDescription());</span><br><span class="line">            XmlUtils.skipCurrentTag(parser);</span><br><span class="line">            <span class="keyword">continue</span>;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (tagName.equals(TAG_APPLICATION)) &#123; <span class="comment">// 解析 "application" 标签</span></span><br><span class="line">            <span class="keyword">if</span> (foundApp) &#123; </span><br><span class="line">                <span class="keyword">if</span> (RIGID_PARSER) &#123;</span><br><span class="line">                    outError[<span class="number">0</span>] = <span class="string">"&lt;manifest&gt; has more than one &lt;application&gt;"</span>;</span><br><span class="line">                    mParseError = PackageManager.INSTALL_PARSE_FAILED_MANIFEST_MALFORMED;</span><br><span class="line">                    <span class="keyword">return</span> <span class="keyword">null</span>;</span><br><span class="line">                &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                    Slog.w(TAG, <span class="string">"&lt;manifest&gt; has more than one &lt;application&gt;"</span>);</span><br><span class="line">                    XmlUtils.skipCurrentTag(parser);</span><br><span class="line">                    <span class="keyword">continue</span>;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            foundApp = <span class="keyword">true</span>;</span><br><span class="line">            </span><br><span class="line">            <span class="comment">//【3.1.1.2.3】接着调用 parseBaseApplication 方法解析 "application" 标签的属性以及四大组件的信息！</span></span><br><span class="line">            <span class="keyword">if</span> (!parseBaseApplication(pkg, res, parser, flags, outError)) &#123;</span><br><span class="line">                <span class="keyword">return</span> <span class="keyword">null</span>;</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">        &#125; <span class="keyword">else</span> <span class="keyword">if</span> (tagName.equals(TAG_OVERLAY)) &#123; <span class="comment">// 解析 "overlay" 标签</span></span><br><span class="line">            sa = res.obtainAttributes(parser,</span><br><span class="line">                    com.android.internal.R.styleable.AndroidManifestResourceOverlay);</span><br><span class="line">            pkg.mOverlayTarget = sa.getString(</span><br><span class="line">                    com.android.internal.R.styleable.AndroidManifestResourceOverlay_targetPackage);</span><br><span class="line">            pkg.mOverlayPriority = sa.getInt(</span><br><span class="line">                    com.android.internal.R.styleable.AndroidManifestResourceOverlay_priority,</span><br><span class="line">                    -<span class="number">1</span>);</span><br><span class="line">            sa.recycle();</span><br><span class="line"></span><br><span class="line">            <span class="keyword">if</span> (pkg.mOverlayTarget == <span class="keyword">null</span>) &#123;</span><br><span class="line">                outError[<span class="number">0</span>] = <span class="string">"&lt;overlay&gt; does not specify a target package"</span>;</span><br><span class="line">                mParseError = PackageManager.INSTALL_PARSE_FAILED_MANIFEST_MALFORMED;</span><br><span class="line">                <span class="keyword">return</span> <span class="keyword">null</span>;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">if</span> (pkg.mOverlayPriority &lt; <span class="number">0</span> || pkg.mOverlayPriority &gt; <span class="number">9999</span>) &#123;</span><br><span class="line">                outError[<span class="number">0</span>] = <span class="string">"&lt;overlay&gt; priority must be between 0 and 9999"</span>;</span><br><span class="line">                mParseError =</span><br><span class="line">                    PackageManager.INSTALL_PARSE_FAILED_MANIFEST_MALFORMED;</span><br><span class="line">                <span class="keyword">return</span> <span class="keyword">null</span>;</span><br><span class="line">            &#125;</span><br><span class="line">            XmlUtils.skipCurrentTag(parser);</span><br><span class="line"></span><br><span class="line">        &#125; <span class="keyword">else</span> <span class="keyword">if</span> (tagName.equals(TAG_KEY_SETS)) &#123; <span class="comment">// 解析 'key-sets" 标签</span></span><br><span class="line">            <span class="keyword">if</span> (!parseKeySets(pkg, res, parser, outError)) &#123;</span><br><span class="line">                <span class="keyword">return</span> <span class="keyword">null</span>;</span><br><span class="line">            &#125;</span><br><span class="line">            </span><br><span class="line">        &#125; <span class="keyword">else</span> <span class="keyword">if</span> (tagName.equals(TAG_PERMISSION_GROUP)) &#123; <span class="comment">//【3.1.1.2.2.1】解析 'permission-group" 标签</span></span><br><span class="line">            <span class="keyword">if</span> (parsePermissionGroup(pkg, flags, res, parser, outError) == <span class="keyword">null</span>) &#123;</span><br><span class="line">                <span class="keyword">return</span> <span class="keyword">null</span>;</span><br><span class="line">            &#125;</span><br><span class="line">            </span><br><span class="line">        &#125; <span class="keyword">else</span> <span class="keyword">if</span> (tagName.equals(TAG_PERMISSION)) &#123; <span class="comment">//【3.1.1.2.2.2】解析 'permission" 标签</span></span><br><span class="line">            <span class="keyword">if</span> (parsePermission(pkg, res, parser, outError) == <span class="keyword">null</span>) &#123;</span><br><span class="line">                <span class="keyword">return</span> <span class="keyword">null</span>;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125; <span class="keyword">else</span> <span class="keyword">if</span> (tagName.equals(TAG_PERMISSION_TREE)) &#123; <span class="comment">//【3.1.1.2.2.3】解析 'permission-tree" 标签</span></span><br><span class="line">            <span class="keyword">if</span> (parsePermissionTree(pkg, res, parser, outError) == <span class="keyword">null</span>) &#123;</span><br><span class="line">                <span class="keyword">return</span> <span class="keyword">null</span>;</span><br><span class="line">            &#125;</span><br><span class="line">            </span><br><span class="line">        &#125; <span class="keyword">else</span> <span class="keyword">if</span> (tagName.equals(TAG_USES_PERMISSION)) &#123; <span class="comment">//【3.1.1.2.2.4】解析 'uses-permission" 标签</span></span><br><span class="line">            <span class="keyword">if</span> (!parseUsesPermission(pkg, res, parser)) &#123;</span><br><span class="line">                <span class="keyword">return</span> <span class="keyword">null</span>;</span><br><span class="line">            &#125;</span><br><span class="line">            </span><br><span class="line">        &#125; <span class="keyword">else</span> <span class="keyword">if</span> (tagName.equals(TAG_USES_PERMISSION_SDK_M)</span><br><span class="line">                || tagName.equals(TAG_USES_PERMISSION_SDK_23)) &#123; </span><br><span class="line">                </span><br><span class="line">            <span class="comment">// 解析 'uses-permission-sdk-m" 或 "uses-permission-sdk-23" 标签</span></span><br><span class="line">            <span class="keyword">if</span> (!parseUsesPermission(pkg, res, parser)) &#123;</span><br><span class="line">                <span class="keyword">return</span> <span class="keyword">null</span>;</span><br><span class="line">            &#125;</span><br><span class="line">            </span><br><span class="line">        &#125; <span class="keyword">else</span> <span class="keyword">if</span> (tagName.equals(TAG_USES_CONFIGURATION)) &#123; <span class="comment">// 解析 "uses-configuration" 标签</span></span><br><span class="line">            ConfigurationInfo cPref = <span class="keyword">new</span> ConfigurationInfo();</span><br><span class="line">            sa = res.obtainAttributes(parser,</span><br><span class="line">                    com.android.internal.R.styleable.AndroidManifestUsesConfiguration);</span><br><span class="line">            cPref.reqTouchScreen = sa.getInt(</span><br><span class="line">                    com.android.internal.R.styleable.AndroidManifestUsesConfiguration_reqTouchScreen,</span><br><span class="line">                    Configuration.TOUCHSCREEN_UNDEFINED);</span><br><span class="line">            cPref.reqKeyboardType = sa.getInt(</span><br><span class="line">                    com.android.internal.R.styleable.AndroidManifestUsesConfiguration_reqKeyboardType,</span><br><span class="line">                    Configuration.KEYBOARD_UNDEFINED);</span><br><span class="line">            <span class="keyword">if</span> (sa.getBoolean(</span><br><span class="line">                    com.android.internal.R.styleable.AndroidManifestUsesConfiguration_reqHardKeyboard,</span><br><span class="line">                    <span class="keyword">false</span>)) &#123;</span><br><span class="line">                cPref.reqInputFeatures |= ConfigurationInfo.INPUT_FEATURE_HARD_KEYBOARD;</span><br><span class="line">            &#125;</span><br><span class="line">            cPref.reqNavigation = sa.getInt(</span><br><span class="line">                    com.android.internal.R.styleable.AndroidManifestUsesConfiguration_reqNavigation,</span><br><span class="line">                    Configuration.NAVIGATION_UNDEFINED);</span><br><span class="line">            <span class="keyword">if</span> (sa.getBoolean(</span><br><span class="line">                    com.android.internal.R.styleable.AndroidManifestUsesConfiguration_reqFiveWayNav,</span><br><span class="line">                    <span class="keyword">false</span>)) &#123;</span><br><span class="line">                cPref.reqInputFeatures |= ConfigurationInfo.INPUT_FEATURE_FIVE_WAY_NAV;</span><br><span class="line">            &#125;</span><br><span class="line">            sa.recycle();</span><br><span class="line">            pkg.configPreferences = ArrayUtils.add(pkg.configPreferences, cPref);</span><br><span class="line"></span><br><span class="line">            XmlUtils.skipCurrentTag(parser);</span><br><span class="line"></span><br><span class="line">        &#125; <span class="keyword">else</span> <span class="keyword">if</span> (tagName.equals(TAG_USES_FEATURE)) &#123; <span class="comment">// 解析 "uses-feature" 标签</span></span><br><span class="line">            FeatureInfo fi = parseUsesFeature(res, parser);</span><br><span class="line">            pkg.reqFeatures = ArrayUtils.add(pkg.reqFeatures, fi);</span><br><span class="line"></span><br><span class="line">            <span class="keyword">if</span> (fi.name == <span class="keyword">null</span>) &#123;</span><br><span class="line">                ConfigurationInfo cPref = <span class="keyword">new</span> ConfigurationInfo();</span><br><span class="line">                cPref.reqGlEsVersion = fi.reqGlEsVersion;</span><br><span class="line">                pkg.configPreferences = ArrayUtils.add(pkg.configPreferences, cPref);</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            XmlUtils.skipCurrentTag(parser);</span><br><span class="line"></span><br><span class="line">        &#125; <span class="keyword">else</span> <span class="keyword">if</span> (tagName.equals(TAG_FEATURE_GROUP)) &#123;  <span class="comment">// 解析 "feature-group" 标签</span></span><br><span class="line">            FeatureGroupInfo group = <span class="keyword">new</span> FeatureGroupInfo();</span><br><span class="line">            ArrayList&lt;FeatureInfo&gt; features = <span class="keyword">null</span>;</span><br><span class="line">            <span class="keyword">final</span> <span class="keyword">int</span> innerDepth = parser.getDepth();</span><br><span class="line">            <span class="keyword">while</span> ((type = parser.next()) != XmlPullParser.END_DOCUMENT</span><br><span class="line">                    &amp;&amp; (type != XmlPullParser.END_TAG || parser.getDepth() &gt; innerDepth)) &#123;</span><br><span class="line">                <span class="keyword">if</span> (type == XmlPullParser.END_TAG || type == XmlPullParser.TEXT) &#123;</span><br><span class="line">                    <span class="keyword">continue</span>;</span><br><span class="line">                &#125;</span><br><span class="line"></span><br><span class="line">                <span class="keyword">final</span> String innerTagName = parser.getName();</span><br><span class="line">                <span class="keyword">if</span> (innerTagName.equals(<span class="string">"uses-feature"</span>)) &#123;</span><br><span class="line">                    FeatureInfo featureInfo = parseUsesFeature(res, parser);</span><br><span class="line">                    <span class="comment">// FeatureGroups are stricter and mandate that</span></span><br><span class="line">                    <span class="comment">// any &lt;uses-feature&gt; declared are mandatory.</span></span><br><span class="line">                    featureInfo.flags |= FeatureInfo.FLAG_REQUIRED;</span><br><span class="line">                    features = ArrayUtils.add(features, featureInfo);</span><br><span class="line">                &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                    Slog.w(TAG, <span class="string">"Unknown element under &lt;feature-group&gt;: "</span> + innerTagName +</span><br><span class="line">                            <span class="string">" at "</span> + mArchiveSourcePath + <span class="string">" "</span> +</span><br><span class="line">                            parser.getPositionDescription());</span><br><span class="line">                &#125;</span><br><span class="line">                XmlUtils.skipCurrentTag(parser);</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            <span class="keyword">if</span> (features != <span class="keyword">null</span>) &#123;</span><br><span class="line">                group.features = <span class="keyword">new</span> FeatureInfo[features.size()];</span><br><span class="line">                group.features = features.toArray(group.features);</span><br><span class="line">            &#125;</span><br><span class="line">            pkg.featureGroups = ArrayUtils.add(pkg.featureGroups, group);</span><br><span class="line"></span><br><span class="line">        &#125; <span class="keyword">else</span> <span class="keyword">if</span> (tagName.equals(TAG_USES_SDK)) &#123;  <span class="comment">// 解析 "uses-sdk" 标签</span></span><br><span class="line">            <span class="keyword">if</span> (SDK_VERSION &gt; <span class="number">0</span>) &#123;</span><br><span class="line">                sa = res.obtainAttributes(parser,</span><br><span class="line">                        com.android.internal.R.styleable.AndroidManifestUsesSdk);</span><br><span class="line"></span><br><span class="line">                <span class="keyword">int</span> minVers = <span class="number">1</span>;</span><br><span class="line">                String minCode = <span class="keyword">null</span>;</span><br><span class="line">                <span class="keyword">int</span> targetVers = <span class="number">0</span>;</span><br><span class="line">                String targetCode = <span class="keyword">null</span>;</span><br><span class="line"></span><br><span class="line">                TypedValue val = sa.peekValue(</span><br><span class="line">                        com.android.internal.R.styleable.AndroidManifestUsesSdk_minSdkVersion);</span><br><span class="line">                <span class="keyword">if</span> (val != <span class="keyword">null</span>) &#123;</span><br><span class="line">                    <span class="keyword">if</span> (val.type == TypedValue.TYPE_STRING &amp;&amp; val.string != <span class="keyword">null</span>) &#123;</span><br><span class="line">                        targetCode = minCode = val.string.toString();</span><br><span class="line">                    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                        <span class="comment">// If it's not a string, it's an integer.</span></span><br><span class="line">                        targetVers = minVers = val.data;</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;</span><br><span class="line"></span><br><span class="line">                val = sa.peekValue(</span><br><span class="line">                        com.android.internal.R.styleable.AndroidManifestUsesSdk_targetSdkVersion);</span><br><span class="line">                <span class="keyword">if</span> (val != <span class="keyword">null</span>) &#123;</span><br><span class="line">                    <span class="keyword">if</span> (val.type == TypedValue.TYPE_STRING &amp;&amp; val.string != <span class="keyword">null</span>) &#123;</span><br><span class="line">                        targetCode = val.string.toString();</span><br><span class="line">                        <span class="keyword">if</span> (minCode == <span class="keyword">null</span>) &#123;</span><br><span class="line">                            minCode = targetCode;</span><br><span class="line">                        &#125;</span><br><span class="line">                    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                        <span class="comment">// If it's not a string, it's an integer.</span></span><br><span class="line">                        targetVers = val.data;</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;</span><br><span class="line"></span><br><span class="line">                sa.recycle();</span><br><span class="line"></span><br><span class="line">                <span class="keyword">if</span> (minCode != <span class="keyword">null</span>) &#123;</span><br><span class="line">                    <span class="keyword">boolean</span> allowedCodename = <span class="keyword">false</span>;</span><br><span class="line">                    <span class="keyword">for</span> (String codename : SDK_CODENAMES) &#123;</span><br><span class="line">                        <span class="keyword">if</span> (minCode.equals(codename)) &#123;</span><br><span class="line">                            allowedCodename = <span class="keyword">true</span>;</span><br><span class="line">                            <span class="keyword">break</span>;</span><br><span class="line">                        &#125;</span><br><span class="line">                    &#125;</span><br><span class="line">                    <span class="keyword">if</span> (!allowedCodename) &#123;</span><br><span class="line">                        <span class="keyword">if</span> (SDK_CODENAMES.length &gt; <span class="number">0</span>) &#123;</span><br><span class="line">                            outError[<span class="number">0</span>] = <span class="string">"Requires development platform "</span> + minCode</span><br><span class="line">                                    + <span class="string">" (current platform is any of "</span></span><br><span class="line">                                    + Arrays.toString(SDK_CODENAMES) + <span class="string">")"</span>;</span><br><span class="line">                        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                            outError[<span class="number">0</span>] = <span class="string">"Requires development platform "</span> + minCode</span><br><span class="line">                                    + <span class="string">" but this is a release platform."</span>;</span><br><span class="line">                        &#125;</span><br><span class="line">                        mParseError = PackageManager.INSTALL_FAILED_OLDER_SDK;</span><br><span class="line">                        <span class="keyword">return</span> <span class="keyword">null</span>;</span><br><span class="line">                    &#125;</span><br><span class="line">                    pkg.applicationInfo.minSdkVersion =</span><br><span class="line">                            android.os.Build.VERSION_CODES.CUR_DEVELOPMENT;</span><br><span class="line">                &#125; <span class="keyword">else</span> <span class="keyword">if</span> (minVers &gt; SDK_VERSION) &#123;</span><br><span class="line">                    outError[<span class="number">0</span>] = <span class="string">"Requires newer sdk version #"</span> + minVers</span><br><span class="line">                            + <span class="string">" (current version is #"</span> + SDK_VERSION + <span class="string">")"</span>;</span><br><span class="line">                    mParseError = PackageManager.INSTALL_FAILED_OLDER_SDK;</span><br><span class="line">                    <span class="keyword">return</span> <span class="keyword">null</span>;</span><br><span class="line">                &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                    pkg.applicationInfo.minSdkVersion = minVers;</span><br><span class="line">                &#125;</span><br><span class="line"></span><br><span class="line">                <span class="keyword">if</span> (targetCode != <span class="keyword">null</span>) &#123;</span><br><span class="line">                    <span class="keyword">boolean</span> allowedCodename = <span class="keyword">false</span>;</span><br><span class="line">                    <span class="keyword">for</span> (String codename : SDK_CODENAMES) &#123;</span><br><span class="line">                        <span class="keyword">if</span> (targetCode.equals(codename)) &#123;</span><br><span class="line">                            allowedCodename = <span class="keyword">true</span>;</span><br><span class="line">                            <span class="keyword">break</span>;</span><br><span class="line">                        &#125;</span><br><span class="line">                    &#125;</span><br><span class="line">                    <span class="keyword">if</span> (!allowedCodename) &#123;</span><br><span class="line">                        <span class="keyword">if</span> (SDK_CODENAMES.length &gt; <span class="number">0</span>) &#123;</span><br><span class="line">                            outError[<span class="number">0</span>] = <span class="string">"Requires development platform "</span> + targetCode</span><br><span class="line">                                    + <span class="string">" (current platform is any of "</span></span><br><span class="line">                                    + Arrays.toString(SDK_CODENAMES) + <span class="string">")"</span>;</span><br><span class="line">                        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                            outError[<span class="number">0</span>] = <span class="string">"Requires development platform "</span> + targetCode</span><br><span class="line">                                    + <span class="string">" but this is a release platform."</span>;</span><br><span class="line">                        &#125;</span><br><span class="line">                        mParseError = PackageManager.INSTALL_FAILED_OLDER_SDK;</span><br><span class="line">                        <span class="keyword">return</span> <span class="keyword">null</span>;</span><br><span class="line">                    &#125;</span><br><span class="line">                    <span class="comment">// If the code matches, it definitely targets this SDK.</span></span><br><span class="line">                    pkg.applicationInfo.targetSdkVersion</span><br><span class="line">                            = android.os.Build.VERSION_CODES.CUR_DEVELOPMENT;</span><br><span class="line">                &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                    pkg.applicationInfo.targetSdkVersion = targetVers;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            XmlUtils.skipCurrentTag(parser);</span><br><span class="line"></span><br><span class="line">        &#125; <span class="keyword">else</span> <span class="keyword">if</span> (tagName.equals(TAG_SUPPORT_SCREENS)) &#123;  <span class="comment">// 解析 "supports-screens" 标签</span></span><br><span class="line">            sa = res.obtainAttributes(parser,</span><br><span class="line">                    com.android.internal.R.styleable.AndroidManifestSupportsScreens);</span><br><span class="line"></span><br><span class="line">            pkg.applicationInfo.requiresSmallestWidthDp = sa.getInteger(</span><br><span class="line">                    com.android.internal.R.styleable.AndroidManifestSupportsScreens_requiresSmallestWidthDp,</span><br><span class="line">                    <span class="number">0</span>);</span><br><span class="line">            pkg.applicationInfo.compatibleWidthLimitDp = sa.getInteger(</span><br><span class="line">                    com.android.internal.R.styleable.AndroidManifestSupportsScreens_compatibleWidthLimitDp,</span><br><span class="line">                    <span class="number">0</span>);</span><br><span class="line">            pkg.applicationInfo.largestWidthLimitDp = sa.getInteger(</span><br><span class="line">                    com.android.internal.R.styleable.AndroidManifestSupportsScreens_largestWidthLimitDp,</span><br><span class="line">                    <span class="number">0</span>);</span><br><span class="line"></span><br><span class="line">            <span class="comment">// 和屏幕相关的参数解析，屏幕大小等等！</span></span><br><span class="line">            supportsSmallScreens = sa.getInteger(</span><br><span class="line">                    com.android.internal.R.styleable.AndroidManifestSupportsScreens_smallScreens,</span><br><span class="line">                    supportsSmallScreens);</span><br><span class="line">            supportsNormalScreens = sa.getInteger(</span><br><span class="line">                    com.android.internal.R.styleable.AndroidManifestSupportsScreens_normalScreens,</span><br><span class="line">                    supportsNormalScreens);</span><br><span class="line">            supportsLargeScreens = sa.getInteger(</span><br><span class="line">                    com.android.internal.R.styleable.AndroidManifestSupportsScreens_largeScreens,</span><br><span class="line">                    supportsLargeScreens);</span><br><span class="line">            supportsXLargeScreens = sa.getInteger(</span><br><span class="line">                    com.android.internal.R.styleable.AndroidManifestSupportsScreens_xlargeScreens,</span><br><span class="line">                    supportsXLargeScreens);</span><br><span class="line">            resizeable = sa.getInteger(</span><br><span class="line">                    com.android.internal.R.styleable.AndroidManifestSupportsScreens_resizeable,</span><br><span class="line">                    resizeable);</span><br><span class="line">            anyDensity = sa.getInteger(</span><br><span class="line">                    com.android.internal.R.styleable.AndroidManifestSupportsScreens_anyDensity,</span><br><span class="line">                    anyDensity);</span><br><span class="line"></span><br><span class="line">            sa.recycle();</span><br><span class="line"></span><br><span class="line">            XmlUtils.skipCurrentTag(parser);</span><br><span class="line"></span><br><span class="line">        &#125; <span class="keyword">else</span> <span class="keyword">if</span> (tagName.equals(TAG_PROTECTED_BROADCAST)) &#123; <span class="comment">// 解析 "protected-broadcast" 标签</span></span><br><span class="line">            sa = res.obtainAttributes(parser,</span><br><span class="line">                    com.android.internal.R.styleable.AndroidManifestProtectedBroadcast);</span><br><span class="line"></span><br><span class="line">            <span class="comment">// Note: don't allow this value to be a reference to a resource</span></span><br><span class="line">            <span class="comment">// that may change.</span></span><br><span class="line">            String name = sa.getNonResourceString(</span><br><span class="line">                    com.android.internal.R.styleable.AndroidManifestProtectedBroadcast_name);</span><br><span class="line"></span><br><span class="line">            sa.recycle();</span><br><span class="line"></span><br><span class="line">            <span class="keyword">if</span> (name != <span class="keyword">null</span> &amp;&amp; (flags&amp;PARSE_IS_SYSTEM) != <span class="number">0</span>) &#123;</span><br><span class="line">                <span class="keyword">if</span> (pkg.protectedBroadcasts == <span class="keyword">null</span>) &#123;</span><br><span class="line">                    pkg.protectedBroadcasts = <span class="keyword">new</span> ArrayList&lt;String&gt;();</span><br><span class="line">                &#125;</span><br><span class="line">                <span class="keyword">if</span> (!pkg.protectedBroadcasts.contains(name)) &#123;</span><br><span class="line">                    pkg.protectedBroadcasts.add(name.intern());</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            XmlUtils.skipCurrentTag(parser);</span><br><span class="line"></span><br><span class="line">        &#125; <span class="keyword">else</span> <span class="keyword">if</span> (tagName.equals(TAG_INSTRUMENTATION)) &#123;  <span class="comment">// 解析 "instrumentation" 标签</span></span><br><span class="line">            <span class="keyword">if</span> (parseInstrumentation(pkg, res, parser, outError) == <span class="keyword">null</span>) &#123;</span><br><span class="line">                <span class="keyword">return</span> <span class="keyword">null</span>;</span><br><span class="line">            &#125;</span><br><span class="line">        </span><br><span class="line">        &#125; <span class="keyword">else</span> <span class="keyword">if</span> (tagName.equals(TAG_ORIGINAL_PACKAGE)) &#123; <span class="comment">// 解析 "original-package" 标签</span></span><br><span class="line">            sa = res.obtainAttributes(parser,</span><br><span class="line">                    com.android.internal.R.styleable.AndroidManifestOriginalPackage);</span><br><span class="line"></span><br><span class="line">            String orig =sa.getNonConfigurationString(</span><br><span class="line">                    com.android.internal.R.styleable.AndroidManifestOriginalPackage_name, <span class="number">0</span>);</span><br><span class="line">            <span class="keyword">if</span> (!pkg.packageName.equals(orig)) &#123;</span><br><span class="line">                <span class="keyword">if</span> (pkg.mOriginalPackages == <span class="keyword">null</span>) &#123;</span><br><span class="line">                    pkg.mOriginalPackages = <span class="keyword">new</span> ArrayList&lt;String&gt;();</span><br><span class="line">                    pkg.mRealPackage = pkg.packageName;</span><br><span class="line">                &#125;</span><br><span class="line">                pkg.mOriginalPackages.add(orig);</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            sa.recycle();</span><br><span class="line"></span><br><span class="line">            XmlUtils.skipCurrentTag(parser);</span><br><span class="line"></span><br><span class="line">        &#125; <span class="keyword">else</span> <span class="keyword">if</span> (tagName.equals(TAG_ADOPT_PERMISSIONS)) &#123; <span class="comment">// 解析 "adopt-permissions" 标签</span></span><br><span class="line">            sa = res.obtainAttributes(parser,</span><br><span class="line">                    com.android.internal.R.styleable.AndroidManifestOriginalPackage);</span><br><span class="line"></span><br><span class="line">            String name = sa.getNonConfigurationString(</span><br><span class="line">                    com.android.internal.R.styleable.AndroidManifestOriginalPackage_name, <span class="number">0</span>);</span><br><span class="line"></span><br><span class="line">            sa.recycle();</span><br><span class="line"></span><br><span class="line">            <span class="keyword">if</span> (name != <span class="keyword">null</span>) &#123;</span><br><span class="line">                <span class="keyword">if</span> (pkg.mAdoptPermissions == <span class="keyword">null</span>) &#123;</span><br><span class="line">                    pkg.mAdoptPermissions = <span class="keyword">new</span> ArrayList&lt;String&gt;();</span><br><span class="line">                &#125;</span><br><span class="line">                pkg.mAdoptPermissions.add(name);</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            XmlUtils.skipCurrentTag(parser);</span><br><span class="line"></span><br><span class="line">        &#125; <span class="keyword">else</span> <span class="keyword">if</span> (tagName.equals(TAG_USES_GL_TEXTURE)) &#123;  <span class="comment">// 跳过一下标签！</span></span><br><span class="line">            <span class="comment">// Just skip this tag</span></span><br><span class="line">            XmlUtils.skipCurrentTag(parser);</span><br><span class="line">            <span class="keyword">continue</span>;</span><br><span class="line"></span><br><span class="line">        &#125; <span class="keyword">else</span> <span class="keyword">if</span> (tagName.equals(TAG_COMPATIBLE_SCREENS)) &#123;</span><br><span class="line">            <span class="comment">// Just skip this tag</span></span><br><span class="line">            XmlUtils.skipCurrentTag(parser);</span><br><span class="line">            <span class="keyword">continue</span>;</span><br><span class="line">            </span><br><span class="line">        &#125; <span class="keyword">else</span> <span class="keyword">if</span> (tagName.equals(TAG_SUPPORTS_INPUT)) &#123; </span><br><span class="line">            XmlUtils.skipCurrentTag(parser);</span><br><span class="line">            <span class="keyword">continue</span>;</span><br><span class="line"></span><br><span class="line">        &#125; <span class="keyword">else</span> <span class="keyword">if</span> (tagName.equals(TAG_EAT_COMMENT)) &#123; </span><br><span class="line">            <span class="comment">// Just skip this tag</span></span><br><span class="line">            XmlUtils.skipCurrentTag(parser);</span><br><span class="line">            <span class="keyword">continue</span>;</span><br><span class="line"></span><br><span class="line">        &#125; <span class="keyword">else</span> <span class="keyword">if</span> (tagName.equals(TAG_PACKAGE)) &#123; <span class="comment">// 解析 "package" 标签，该标签表示应用的子包！</span></span><br><span class="line">            <span class="keyword">if</span> (!MULTI_PACKAGE_APK_ENABLED) &#123;</span><br><span class="line">                XmlUtils.skipCurrentTag(parser);</span><br><span class="line">                <span class="keyword">continue</span>;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="comment">// 所有的子包都会解析保存到 ArrayList&lt;Package&gt; childPackages 集合中！</span></span><br><span class="line">            <span class="keyword">if</span> (!parseBaseApkChild(pkg, res, parser, flags, outError)) &#123;</span><br><span class="line">                <span class="comment">// If parsing a child failed the error is already set</span></span><br><span class="line">                <span class="keyword">return</span> <span class="keyword">null</span>;</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">        &#125; <span class="keyword">else</span> <span class="keyword">if</span> (tagName.equals(TAG_RESTRICT_UPDATE)) &#123;  <span class="comment">// 解析 "restrict-update" 标签</span></span><br><span class="line">            <span class="keyword">if</span> ((flags &amp; PARSE_IS_SYSTEM_DIR) != <span class="number">0</span>) &#123;</span><br><span class="line">                sa = res.obtainAttributes(parser,</span><br><span class="line">                        com.android.internal.R.styleable.AndroidManifestRestrictUpdate);</span><br><span class="line">                <span class="keyword">final</span> String hash = sa.getNonConfigurationString(</span><br><span class="line">                        com.android.internal.R.styleable.AndroidManifestRestrictUpdate_hash, <span class="number">0</span>);</span><br><span class="line">                sa.recycle();</span><br><span class="line"></span><br><span class="line">                pkg.restrictUpdateHash = <span class="keyword">null</span>;</span><br><span class="line">                <span class="keyword">if</span> (hash != <span class="keyword">null</span>) &#123;</span><br><span class="line">                    <span class="keyword">final</span> <span class="keyword">int</span> hashLength = hash.length();</span><br><span class="line">                    <span class="keyword">final</span> <span class="keyword">byte</span>[] hashBytes = <span class="keyword">new</span> <span class="keyword">byte</span>[hashLength / <span class="number">2</span>];</span><br><span class="line">                    <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; hashLength; i += <span class="number">2</span>)&#123;</span><br><span class="line">                        hashBytes[i/<span class="number">2</span>] = (<span class="keyword">byte</span>) ((Character.digit(hash.charAt(i), <span class="number">16</span>) &lt;&lt; <span class="number">4</span>)</span><br><span class="line">                                + Character.digit(hash.charAt(i + <span class="number">1</span>), <span class="number">16</span>));</span><br><span class="line">                    &#125;</span><br><span class="line">                    pkg.restrictUpdateHash = hashBytes;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            XmlUtils.skipCurrentTag(parser);</span><br><span class="line"></span><br><span class="line">        &#125; <span class="keyword">else</span> <span class="keyword">if</span> (RIGID_PARSER) &#123;</span><br><span class="line">            outError[<span class="number">0</span>] = <span class="string">"Bad element under &lt;manifest&gt;: "</span></span><br><span class="line">                + parser.getName();</span><br><span class="line">            mParseError = PackageManager.INSTALL_PARSE_FAILED_MANIFEST_MALFORMED;</span><br><span class="line">            <span class="keyword">return</span> <span class="keyword">null</span>;</span><br><span class="line"></span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            Slog.w(TAG, <span class="string">"Unknown element under &lt;manifest&gt;: "</span> + parser.getName()</span><br><span class="line">                    + <span class="string">" at "</span> + mArchiveSourcePath + <span class="string">" "</span></span><br><span class="line">                    + parser.getPositionDescription());</span><br><span class="line">            XmlUtils.skipCurrentTag(parser);</span><br><span class="line">            <span class="keyword">continue</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (!foundApp &amp;&amp; pkg.instrumentation.size() == <span class="number">0</span>) &#123;</span><br><span class="line">        outError[<span class="number">0</span>] = <span class="string">"&lt;manifest&gt; does not contain an &lt;application&gt; or &lt;instrumentation&gt;"</span>;</span><br><span class="line">        mParseError = PackageManager.INSTALL_PARSE_FAILED_MANIFEST_EMPTY;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">final</span> <span class="keyword">int</span> NP = PackageParser.NEW_PERMISSIONS.length;</span><br><span class="line">    StringBuilder implicitPerms = <span class="keyword">null</span>;</span><br><span class="line">    <span class="keyword">for</span> (<span class="keyword">int</span> ip=<span class="number">0</span>; ip&lt;NP; ip++) &#123;</span><br><span class="line">        <span class="keyword">final</span> PackageParser.NewPermissionInfo npi</span><br><span class="line">                = PackageParser.NEW_PERMISSIONS[ip];</span><br><span class="line">        <span class="keyword">if</span> (pkg.applicationInfo.targetSdkVersion &gt;= npi.sdkVersion) &#123;</span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">if</span> (!pkg.requestedPermissions.contains(npi.name)) &#123;</span><br><span class="line">            <span class="keyword">if</span> (implicitPerms == <span class="keyword">null</span>) &#123;</span><br><span class="line">                implicitPerms = <span class="keyword">new</span> StringBuilder(<span class="number">128</span>);</span><br><span class="line">                implicitPerms.append(pkg.packageName);</span><br><span class="line">                implicitPerms.append(<span class="string">": compat added "</span>);</span><br><span class="line">            &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                implicitPerms.append(<span class="string">' '</span>);</span><br><span class="line">            &#125;</span><br><span class="line">            implicitPerms.append(npi.name);</span><br><span class="line">            pkg.requestedPermissions.add(npi.name);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span> (implicitPerms != <span class="keyword">null</span>) &#123;</span><br><span class="line">        Slog.i(TAG, implicitPerms.toString());</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">final</span> <span class="keyword">int</span> NS = PackageParser.SPLIT_PERMISSIONS.length;</span><br><span class="line">    <span class="keyword">for</span> (<span class="keyword">int</span> is=<span class="number">0</span>; is&lt;NS; is++) &#123;</span><br><span class="line">        <span class="keyword">final</span> PackageParser.SplitPermissionInfo spi</span><br><span class="line">                = PackageParser.SPLIT_PERMISSIONS[is];</span><br><span class="line">        <span class="keyword">if</span> (pkg.applicationInfo.targetSdkVersion &gt;= spi.targetSdk</span><br><span class="line">                || !pkg.requestedPermissions.contains(spi.rootPerm)) &#123;</span><br><span class="line">            <span class="keyword">continue</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">for</span> (<span class="keyword">int</span> in=<span class="number">0</span>; in&lt;spi.newPerms.length; in++) &#123;</span><br><span class="line">            <span class="keyword">final</span> String perm = spi.newPerms[in];</span><br><span class="line">            <span class="keyword">if</span> (!pkg.requestedPermissions.contains(perm)) &#123;</span><br><span class="line">                pkg.requestedPermissions.add(perm);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 解析屏幕大小、像素密度相关的属性！</span></span><br><span class="line">    <span class="keyword">if</span> (supportsSmallScreens &lt; <span class="number">0</span> || (supportsSmallScreens &gt; <span class="number">0</span></span><br><span class="line">            &amp;&amp; pkg.applicationInfo.targetSdkVersion</span><br><span class="line">                    &gt;= android.os.Build.VERSION_CODES.DONUT)) &#123;</span><br><span class="line">        pkg.applicationInfo.flags |= ApplicationInfo.FLAG_SUPPORTS_SMALL_SCREENS;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span> (supportsNormalScreens != <span class="number">0</span>) &#123;</span><br><span class="line">        pkg.applicationInfo.flags |= ApplicationInfo.FLAG_SUPPORTS_NORMAL_SCREENS;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span> (supportsLargeScreens &lt; <span class="number">0</span> || (supportsLargeScreens &gt; <span class="number">0</span></span><br><span class="line">            &amp;&amp; pkg.applicationInfo.targetSdkVersion</span><br><span class="line">                    &gt;= android.os.Build.VERSION_CODES.DONUT)) &#123;</span><br><span class="line">        pkg.applicationInfo.flags |= ApplicationInfo.FLAG_SUPPORTS_LARGE_SCREENS;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span> (supportsXLargeScreens &lt; <span class="number">0</span> || (supportsXLargeScreens &gt; <span class="number">0</span></span><br><span class="line">            &amp;&amp; pkg.applicationInfo.targetSdkVersion</span><br><span class="line">                    &gt;= android.os.Build.VERSION_CODES.GINGERBREAD)) &#123;</span><br><span class="line">        pkg.applicationInfo.flags |= ApplicationInfo.FLAG_SUPPORTS_XLARGE_SCREENS;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span> (resizeable &lt; <span class="number">0</span> || (resizeable &gt; <span class="number">0</span></span><br><span class="line">            &amp;&amp; pkg.applicationInfo.targetSdkVersion</span><br><span class="line">                    &gt;= android.os.Build.VERSION_CODES.DONUT)) &#123;</span><br><span class="line">        pkg.applicationInfo.flags |= ApplicationInfo.FLAG_RESIZEABLE_FOR_SCREENS;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span> (anyDensity &lt; <span class="number">0</span> || (anyDensity &gt; <span class="number">0</span></span><br><span class="line">            &amp;&amp; pkg.applicationInfo.targetSdkVersion</span><br><span class="line">                    &gt;= android.os.Build.VERSION_CODES.DONUT)) &#123;</span><br><span class="line">        pkg.applicationInfo.flags |= ApplicationInfo.FLAG_SUPPORTS_SCREEN_DENSITIES;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// 返回 Package 对象！</span></span><br><span class="line">    <span class="keyword">return</span> pkg;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>在这个方法中，解析 apk 中的四大组件，权限等信息，核心 apk 解析到此为止！</p>
<h6 id="3-1-1-2-2-1-PParser-parsePermissionGroup-解析-permission-group"><a href="#3-1-1-2-2-1-PParser-parsePermissionGroup-解析-permission-group" class="headerlink" title="3.1.1.2.2.1 PParser.parsePermissionGroup - 解析 permission-group"></a>3.1.1.2.2.1 PParser.parsePermissionGroup - 解析 permission-group</h6><p>parsePermissionGroup 用于解析该应用所使用到的 permission-group：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">private</span> PermissionGroup <span class="title">parsePermissionGroup</span><span class="params">(Package owner, <span class="keyword">int</span> flags, Resources res,</span></span></span><br><span class="line"><span class="function"><span class="params">        XmlResourceParser parser, String[] outError)</span></span></span><br><span class="line"><span class="function">        <span class="keyword">throws</span> XmlPullParserException, IOException </span>&#123;</span><br><span class="line">    <span class="comment">//【1】对于权限组，创建了 PermissionGroup 对象！</span></span><br><span class="line">    PermissionGroup perm = <span class="keyword">new</span> PermissionGroup(owner);</span><br><span class="line"></span><br><span class="line">    TypedArray sa = res.obtainAttributes(parser,</span><br><span class="line">            com.android.internal.R.styleable.AndroidManifestPermissionGroup);</span><br><span class="line">    <span class="keyword">if</span> (!parsePackageItemInfo(owner, perm.info, outError,</span><br><span class="line">            <span class="string">"&lt;permission-group&gt;"</span>, sa, <span class="keyword">true</span> <span class="comment">/*nameRequired*/</span>,</span><br><span class="line">            com.android.internal.R.styleable.AndroidManifestPermissionGroup_name,</span><br><span class="line">            com.android.internal.R.styleable.AndroidManifestPermissionGroup_label,</span><br><span class="line">            com.android.internal.R.styleable.AndroidManifestPermissionGroup_icon,</span><br><span class="line">            com.android.internal.R.styleable.AndroidManifestPermissionGroup_roundIcon,</span><br><span class="line">            com.android.internal.R.styleable.AndroidManifestPermissionGroup_logo,</span><br><span class="line">            com.android.internal.R.styleable.AndroidManifestPermissionGroup_banner)) &#123;</span><br><span class="line">        sa.recycle();</span><br><span class="line">        mParseError = PackageManager.INSTALL_PARSE_FAILED_MANIFEST_MALFORMED;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">null</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">//【2】解析相关的属性</span></span><br><span class="line">    perm.info.descriptionRes = sa.getResourceId(</span><br><span class="line">            com.android.internal.R.styleable.AndroidManifestPermissionGroup_description,</span><br><span class="line">            <span class="number">0</span>);</span><br><span class="line">    perm.info.flags = sa.getInt(</span><br><span class="line">            com.android.internal.R.styleable.AndroidManifestPermissionGroup_permissionGroupFlags, <span class="number">0</span>);</span><br><span class="line">    perm.info.priority = sa.getInt(</span><br><span class="line">            com.android.internal.R.styleable.AndroidManifestPermissionGroup_priority, <span class="number">0</span>);</span><br><span class="line">    <span class="keyword">if</span> (perm.info.priority &gt; <span class="number">0</span> &amp;&amp; (flags&amp;PARSE_IS_SYSTEM) == <span class="number">0</span>) &#123;</span><br><span class="line">        perm.info.priority = <span class="number">0</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    sa.recycle();</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (!parseAllMetaData(res, parser, <span class="string">"&lt;permission-group&gt;"</span>, perm,</span><br><span class="line">            outError)) &#123;</span><br><span class="line">        mParseError = PackageManager.INSTALL_PARSE_FAILED_MANIFEST_MALFORMED;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">null</span>;</span><br><span class="line">    &#125;</span><br><span class="line">     <span class="comment">//【3】保存到 owner.permissionGroups 中！</span></span><br><span class="line">    owner.permissionGroups.add(perm);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> perm;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>这里就不多说了！</p>
<h6 id="3-1-1-2-2-2-PParser-parsePermission-解析-permission"><a href="#3-1-1-2-2-2-PParser-parsePermission-解析-permission" class="headerlink" title="3.1.1.2.2.2 PParser.parsePermission - 解析 permission"></a>3.1.1.2.2.2 PParser.parsePermission - 解析 permission</h6><p>parsePermission 解析该应用中定义的权限！<br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">private</span> Permission <span class="title">parsePermission</span><span class="params">(Package owner, Resources res,</span></span></span><br><span class="line"><span class="function"><span class="params">        XmlResourceParser parser, String[] outError)</span></span></span><br><span class="line"><span class="function">    <span class="keyword">throws</span> XmlPullParserException, IOException </span>&#123;</span><br><span class="line">    <span class="comment">//【1】创建 Permission 对象</span></span><br><span class="line">    Permission perm = <span class="keyword">new</span> Permission(owner);</span><br><span class="line"></span><br><span class="line">    TypedArray sa = res.obtainAttributes(parser,</span><br><span class="line">            com.android.internal.R.styleable.AndroidManifestPermission);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (!parsePackageItemInfo(owner, perm.info, outError,</span><br><span class="line">            <span class="string">"&lt;permission&gt;"</span>, sa, <span class="keyword">true</span> <span class="comment">/*nameRequired*/</span>,</span><br><span class="line">            com.android.internal.R.styleable.AndroidManifestPermission_name,</span><br><span class="line">            com.android.internal.R.styleable.AndroidManifestPermission_label,</span><br><span class="line">            com.android.internal.R.styleable.AndroidManifestPermission_icon,</span><br><span class="line">            com.android.internal.R.styleable.AndroidManifestPermission_roundIcon,</span><br><span class="line">            com.android.internal.R.styleable.AndroidManifestPermission_logo,</span><br><span class="line">            com.android.internal.R.styleable.AndroidManifestPermission_banner)) &#123;</span><br><span class="line">        sa.recycle();</span><br><span class="line">        mParseError = PackageManager.INSTALL_PARSE_FAILED_MANIFEST_MALFORMED;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">null</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 解析 android:permissionGroup 属性</span></span><br><span class="line">    perm.info.group = sa.getNonResourceString(</span><br><span class="line">            com.android.internal.R.styleable.AndroidManifestPermission_permissionGroup);</span><br><span class="line">    <span class="keyword">if</span> (perm.info.group != <span class="keyword">null</span>) &#123;</span><br><span class="line">        perm.info.group = perm.info.group.intern();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    perm.info.descriptionRes = sa.getResourceId(</span><br><span class="line">            com.android.internal.R.styleable.AndroidManifestPermission_description,</span><br><span class="line">            <span class="number">0</span>);</span><br><span class="line">    <span class="comment">// 解析 android:protectionLevel 属性</span></span><br><span class="line">    perm.info.protectionLevel = sa.getInt(</span><br><span class="line">            com.android.internal.R.styleable.AndroidManifestPermission_protectionLevel,</span><br><span class="line">            PermissionInfo.PROTECTION_NORMAL);</span><br><span class="line">    <span class="comment">// 解析 android:permissionFlags 属性</span></span><br><span class="line">    perm.info.flags = sa.getInt(</span><br><span class="line">            com.android.internal.R.styleable.AndroidManifestPermission_permissionFlags, <span class="number">0</span>);</span><br><span class="line"></span><br><span class="line">    sa.recycle();</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (perm.info.protectionLevel == -<span class="number">1</span>) &#123;</span><br><span class="line">        outError[<span class="number">0</span>] = <span class="string">"&lt;permission&gt; does not specify protectionLevel"</span>;</span><br><span class="line">        mParseError = PackageManager.INSTALL_PARSE_FAILED_MANIFEST_MALFORMED;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">null</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    perm.info.protectionLevel = PermissionInfo.fixProtectionLevel(perm.info.protectionLevel);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> ((perm.info.protectionLevel&amp;PermissionInfo.PROTECTION_MASK_FLAGS) != <span class="number">0</span>) &#123;</span><br><span class="line">        <span class="keyword">if</span> ((perm.info.protectionLevel&amp;PermissionInfo.PROTECTION_MASK_BASE) !=</span><br><span class="line">                PermissionInfo.PROTECTION_SIGNATURE) &#123;</span><br><span class="line">            outError[<span class="number">0</span>] = <span class="string">"&lt;permission&gt;  protectionLevel specifies a flag but is "</span></span><br><span class="line">                    + <span class="string">"not based on signature type"</span>;</span><br><span class="line">            mParseError = PackageManager.INSTALL_PARSE_FAILED_MANIFEST_MALFORMED;</span><br><span class="line">            <span class="keyword">return</span> <span class="keyword">null</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (!parseAllMetaData(res, parser, <span class="string">"&lt;permission&gt;"</span>, perm, outError)) &#123;</span><br><span class="line">        mParseError = PackageManager.INSTALL_PARSE_FAILED_MANIFEST_MALFORMED;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">null</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// 将解析的权限信息保存到 owner.permissions 中！</span></span><br><span class="line">    owner.permissions.add(perm);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> perm;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>解析很简单，不多说了！</p>
<h6 id="3-1-1-2-2-3-PParser-parsePermissionTree-解析-permission-tree"><a href="#3-1-1-2-2-3-PParser-parsePermissionTree-解析-permission-tree" class="headerlink" title="3.1.1.2.2.3 PParser.parsePermissionTree - 解析 permission-tree"></a>3.1.1.2.2.3 PParser.parsePermissionTree - 解析 permission-tree</h6><p>parsePermissionTree 用于解析该应用所使用到的 permission-tree：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">private</span> Permission <span class="title">parsePermissionTree</span><span class="params">(Package owner, Resources res,</span></span></span><br><span class="line"><span class="function"><span class="params">        XmlResourceParser parser, String[] outError)</span></span></span><br><span class="line"><span class="function">    <span class="keyword">throws</span> XmlPullParserException, IOException </span>&#123; </span><br><span class="line">    <span class="comment">//【1】可以看到对于 permission-tree，依然是会创建一个 Permission 对象！</span></span><br><span class="line">    Permission perm = <span class="keyword">new</span> Permission(owner);</span><br><span class="line"></span><br><span class="line">    TypedArray sa = res.obtainAttributes(parser,</span><br><span class="line">            com.android.internal.R.styleable.AndroidManifestPermissionTree);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (!parsePackageItemInfo(owner, perm.info, outError,</span><br><span class="line">            <span class="string">"&lt;permission-tree&gt;"</span>, sa, <span class="keyword">true</span> <span class="comment">/*nameRequired*/</span>,</span><br><span class="line">            com.android.internal.R.styleable.AndroidManifestPermissionTree_name,</span><br><span class="line">            com.android.internal.R.styleable.AndroidManifestPermissionTree_label,</span><br><span class="line">            com.android.internal.R.styleable.AndroidManifestPermissionTree_icon,</span><br><span class="line">            com.android.internal.R.styleable.AndroidManifestPermissionTree_roundIcon,</span><br><span class="line">            com.android.internal.R.styleable.AndroidManifestPermissionTree_logo,</span><br><span class="line">            com.android.internal.R.styleable.AndroidManifestPermissionTree_banner)) &#123;</span><br><span class="line">        sa.recycle();</span><br><span class="line">        mParseError = PackageManager.INSTALL_PARSE_FAILED_MANIFEST_MALFORMED;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">null</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    sa.recycle();</span><br><span class="line"></span><br><span class="line">    <span class="comment">//【2】解析权限的属性；</span></span><br><span class="line">    <span class="keyword">int</span> index = perm.info.name.indexOf(<span class="string">'.'</span>);</span><br><span class="line">    <span class="keyword">if</span> (index &gt; <span class="number">0</span>) &#123;</span><br><span class="line">        index = perm.info.name.indexOf(<span class="string">'.'</span>, index+<span class="number">1</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span> (index &lt; <span class="number">0</span>) &#123;</span><br><span class="line">        outError[<span class="number">0</span>] = <span class="string">"&lt;permission-tree&gt; name has less than three segments: "</span></span><br><span class="line">            + perm.info.name;</span><br><span class="line">        mParseError = PackageManager.INSTALL_PARSE_FAILED_MANIFEST_MALFORMED;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">null</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    perm.info.descriptionRes = <span class="number">0</span>;</span><br><span class="line">    perm.info.protectionLevel = PermissionInfo.PROTECTION_NORMAL;</span><br><span class="line">    perm.tree = <span class="keyword">true</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (!parseAllMetaData(res, parser, <span class="string">"&lt;permission-tree&gt;"</span>, perm,</span><br><span class="line">            outError)) &#123; <span class="comment">// 解析 meta-data，这里不关注！</span></span><br><span class="line">        mParseError = PackageManager.INSTALL_PARSE_FAILED_MANIFEST_MALFORMED;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">null</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">//【3】将该 Permission 对象添加到 owner.permissions 中！</span></span><br><span class="line">    owner.permissions.add(perm);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> perm;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h6 id="3-1-1-2-2-4-PParser-parseUsesPermission-解析-uses-permission"><a href="#3-1-1-2-2-4-PParser-parseUsesPermission-解析-uses-permission" class="headerlink" title="3.1.1.2.2.4 PParser.parseUsesPermission - 解析 uses-permission"></a>3.1.1.2.2.4 PParser.parseUsesPermission - 解析 uses-permission</h6><p>parseUsesPermission 解析该应用所使用的权限！</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">boolean</span> <span class="title">parseUsesPermission</span><span class="params">(Package pkg, Resources res, XmlResourceParser parser)</span></span></span><br><span class="line"><span class="function">        <span class="keyword">throws</span> XmlPullParserException, IOException </span>&#123;</span><br><span class="line">    TypedArray sa = res.obtainAttributes(parser,</span><br><span class="line">            com.android.internal.R.styleable.AndroidManifestUsesPermission);</span><br><span class="line"></span><br><span class="line">    String name = sa.getNonResourceString(</span><br><span class="line">            com.android.internal.R.styleable.AndroidManifestUsesPermission_name);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">int</span> maxSdkVersion = <span class="number">0</span>;</span><br><span class="line">    TypedValue val = sa.peekValue(</span><br><span class="line">            com.android.internal.R.styleable.AndroidManifestUsesPermission_maxSdkVersion);</span><br><span class="line">    <span class="keyword">if</span> (val != <span class="keyword">null</span>) &#123;</span><br><span class="line">        <span class="keyword">if</span> (val.type &gt;= TypedValue.TYPE_FIRST_INT &amp;&amp; val.type &lt;= TypedValue.TYPE_LAST_INT) &#123;</span><br><span class="line">            maxSdkVersion = val.data;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    sa.recycle();</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> ((maxSdkVersion == <span class="number">0</span>) || (maxSdkVersion &gt;= Build.VERSION.RESOURCES_SDK_INT)) &#123;</span><br><span class="line">        <span class="keyword">if</span> (name != <span class="keyword">null</span>) &#123;</span><br><span class="line">            <span class="keyword">int</span> index = pkg.requestedPermissions.indexOf(name);</span><br><span class="line">            <span class="keyword">if</span> (index == -<span class="number">1</span>) &#123;</span><br><span class="line">                <span class="comment">//【1】将权限添加到 pkg.requestedPermissions 中去！</span></span><br><span class="line">                pkg.requestedPermissions.add(name.intern());</span><br><span class="line">            &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                Slog.w(TAG, <span class="string">"Ignoring duplicate uses-permissions/uses-permissions-sdk-m: "</span></span><br><span class="line">                        + name + <span class="string">" in package: "</span> + pkg.packageName + <span class="string">" at: "</span></span><br><span class="line">                        + parser.getPositionDescription());</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    XmlUtils.skipCurrentTag(parser);</span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">true</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>解析很简单，不多说了！</p>
<h5 id="3-1-1-2-3-PParser-parseBaseApplication"><a href="#3-1-1-2-3-PParser-parseBaseApplication" class="headerlink" title="3.1.1.2.3 PParser.parseBaseApplication"></a>3.1.1.2.3 PParser.parseBaseApplication</h5><p>调用 parseBaseApplication 方法来解析核心 apk 的 applicaiton 标签和内部的四大组件信息！！<br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br><span class="line">212</span><br><span class="line">213</span><br><span class="line">214</span><br><span class="line">215</span><br><span class="line">216</span><br><span class="line">217</span><br><span class="line">218</span><br><span class="line">219</span><br><span class="line">220</span><br><span class="line">221</span><br><span class="line">222</span><br><span class="line">223</span><br><span class="line">224</span><br><span class="line">225</span><br><span class="line">226</span><br><span class="line">227</span><br><span class="line">228</span><br><span class="line">229</span><br><span class="line">230</span><br><span class="line">231</span><br><span class="line">232</span><br><span class="line">233</span><br><span class="line">234</span><br><span class="line">235</span><br><span class="line">236</span><br><span class="line">237</span><br><span class="line">238</span><br><span class="line">239</span><br><span class="line">240</span><br><span class="line">241</span><br><span class="line">242</span><br><span class="line">243</span><br><span class="line">244</span><br><span class="line">245</span><br><span class="line">246</span><br><span class="line">247</span><br><span class="line">248</span><br><span class="line">249</span><br><span class="line">250</span><br><span class="line">251</span><br><span class="line">252</span><br><span class="line">253</span><br><span class="line">254</span><br><span class="line">255</span><br><span class="line">256</span><br><span class="line">257</span><br><span class="line">258</span><br><span class="line">259</span><br><span class="line">260</span><br><span class="line">261</span><br><span class="line">262</span><br><span class="line">263</span><br><span class="line">264</span><br><span class="line">265</span><br><span class="line">266</span><br><span class="line">267</span><br><span class="line">268</span><br><span class="line">269</span><br><span class="line">270</span><br><span class="line">271</span><br><span class="line">272</span><br><span class="line">273</span><br><span class="line">274</span><br><span class="line">275</span><br><span class="line">276</span><br><span class="line">277</span><br><span class="line">278</span><br><span class="line">279</span><br><span class="line">280</span><br><span class="line">281</span><br><span class="line">282</span><br><span class="line">283</span><br><span class="line">284</span><br><span class="line">285</span><br><span class="line">286</span><br><span class="line">287</span><br><span class="line">288</span><br><span class="line">289</span><br><span class="line">290</span><br><span class="line">291</span><br><span class="line">292</span><br><span class="line">293</span><br><span class="line">294</span><br><span class="line">295</span><br><span class="line">296</span><br><span class="line">297</span><br><span class="line">298</span><br><span class="line">299</span><br><span class="line">300</span><br><span class="line">301</span><br><span class="line">302</span><br><span class="line">303</span><br><span class="line">304</span><br><span class="line">305</span><br><span class="line">306</span><br><span class="line">307</span><br><span class="line">308</span><br><span class="line">309</span><br><span class="line">310</span><br><span class="line">311</span><br><span class="line">312</span><br><span class="line">313</span><br><span class="line">314</span><br><span class="line">315</span><br><span class="line">316</span><br><span class="line">317</span><br><span class="line">318</span><br><span class="line">319</span><br><span class="line">320</span><br><span class="line">321</span><br><span class="line">322</span><br><span class="line">323</span><br><span class="line">324</span><br><span class="line">325</span><br><span class="line">326</span><br><span class="line">327</span><br><span class="line">328</span><br><span class="line">329</span><br><span class="line">330</span><br><span class="line">331</span><br><span class="line">332</span><br><span class="line">333</span><br><span class="line">334</span><br><span class="line">335</span><br><span class="line">336</span><br><span class="line">337</span><br><span class="line">338</span><br><span class="line">339</span><br><span class="line">340</span><br><span class="line">341</span><br><span class="line">342</span><br><span class="line">343</span><br><span class="line">344</span><br><span class="line">345</span><br><span class="line">346</span><br><span class="line">347</span><br><span class="line">348</span><br><span class="line">349</span><br><span class="line">350</span><br><span class="line">351</span><br><span class="line">352</span><br><span class="line">353</span><br><span class="line">354</span><br><span class="line">355</span><br><span class="line">356</span><br><span class="line">357</span><br><span class="line">358</span><br><span class="line">359</span><br><span class="line">360</span><br><span class="line">361</span><br><span class="line">362</span><br><span class="line">363</span><br><span class="line">364</span><br><span class="line">365</span><br><span class="line">366</span><br><span class="line">367</span><br><span class="line">368</span><br><span class="line">369</span><br><span class="line">370</span><br><span class="line">371</span><br><span class="line">372</span><br><span class="line">373</span><br><span class="line">374</span><br><span class="line">375</span><br><span class="line">376</span><br><span class="line">377</span><br><span class="line">378</span><br><span class="line">379</span><br><span class="line">380</span><br><span class="line">381</span><br><span class="line">382</span><br><span class="line">383</span><br><span class="line">384</span><br><span class="line">385</span><br><span class="line">386</span><br><span class="line">387</span><br><span class="line">388</span><br><span class="line">389</span><br><span class="line">390</span><br><span class="line">391</span><br><span class="line">392</span><br><span class="line">393</span><br><span class="line">394</span><br><span class="line">395</span><br><span class="line">396</span><br><span class="line">397</span><br><span class="line">398</span><br><span class="line">399</span><br><span class="line">400</span><br><span class="line">401</span><br><span class="line">402</span><br><span class="line">403</span><br><span class="line">404</span><br><span class="line">405</span><br><span class="line">406</span><br><span class="line">407</span><br><span class="line">408</span><br><span class="line">409</span><br><span class="line">410</span><br><span class="line">411</span><br><span class="line">412</span><br><span class="line">413</span><br><span class="line">414</span><br><span class="line">415</span><br><span class="line">416</span><br><span class="line">417</span><br><span class="line">418</span><br><span class="line">419</span><br><span class="line">420</span><br><span class="line">421</span><br><span class="line">422</span><br><span class="line">423</span><br><span class="line">424</span><br><span class="line">425</span><br><span class="line">426</span><br><span class="line">427</span><br><span class="line">428</span><br><span class="line">429</span><br><span class="line">430</span><br><span class="line">431</span><br><span class="line">432</span><br><span class="line">433</span><br><span class="line">434</span><br><span class="line">435</span><br><span class="line">436</span><br><span class="line">437</span><br><span class="line">438</span><br><span class="line">439</span><br><span class="line">440</span><br><span class="line">441</span><br><span class="line">442</span><br><span class="line">443</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">boolean</span> <span class="title">parseBaseApplication</span><span class="params">(Package owner, Resources res,</span></span></span><br><span class="line"><span class="function"><span class="params">        XmlResourceParser parser, <span class="keyword">int</span> flags, String[] outError)</span></span></span><br><span class="line"><span class="function">    <span class="keyword">throws</span> XmlPullParserException, IOException </span>&#123;</span><br><span class="line">    <span class="comment">//【1】解析 application 标签的属性！</span></span><br><span class="line">    <span class="keyword">final</span> ApplicationInfo ai = owner.applicationInfo;</span><br><span class="line">    <span class="keyword">final</span> String pkgName = owner.applicationInfo.packageName;</span><br><span class="line"></span><br><span class="line">    TypedArray sa = res.obtainAttributes(parser,</span><br><span class="line">            com.android.internal.R.styleable.AndroidManifestApplication);</span><br><span class="line">   </span><br><span class="line">    <span class="comment">// 解析 android:name android:label android:icon android:roundIcon android:logo android:banner 属性！</span></span><br><span class="line">    <span class="keyword">if</span> (!parsePackageItemInfo(owner, ai, outError,</span><br><span class="line">            <span class="string">"&lt;application&gt;"</span>, sa, <span class="keyword">false</span> <span class="comment">/*nameRequired*/</span>,</span><br><span class="line">            com.android.internal.R.styleable.AndroidManifestApplication_name,</span><br><span class="line">            com.android.internal.R.styleable.AndroidManifestApplication_label,</span><br><span class="line">            com.android.internal.R.styleable.AndroidManifestApplication_icon,</span><br><span class="line">            com.android.internal.R.styleable.AndroidManifestApplication_roundIcon,</span><br><span class="line">            com.android.internal.R.styleable.AndroidManifestApplication_logo,</span><br><span class="line">            com.android.internal.R.styleable.AndroidManifestApplication_banner)) &#123;</span><br><span class="line">        sa.recycle();</span><br><span class="line">        mParseError = PackageManager.INSTALL_PARSE_FAILED_MANIFEST_MALFORMED;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">false</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (ai.name != <span class="keyword">null</span>) &#123;</span><br><span class="line">        ai.className = ai.name;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// 解析 android:manageSpaceActivity 属性！</span></span><br><span class="line">    String manageSpaceActivity = sa.getNonConfigurationString(</span><br><span class="line">            com.android.internal.R.styleable.AndroidManifestApplication_manageSpaceActivity,</span><br><span class="line">            Configuration.NATIVE_CONFIG_VERSION);</span><br><span class="line">    <span class="keyword">if</span> (manageSpaceActivity != <span class="keyword">null</span>) &#123;</span><br><span class="line">        ai.manageSpaceActivityName = buildClassName(pkgName, manageSpaceActivity,</span><br><span class="line">                outError);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//【1】解析 android:allowBackup 属性，为 true 表示应用允许备份！</span></span><br><span class="line">    <span class="keyword">boolean</span> allowBackup = sa.getBoolean(</span><br><span class="line">            com.android.internal.R.styleable.AndroidManifestApplication_allowBackup, <span class="keyword">true</span>);</span><br><span class="line">    <span class="keyword">if</span> (allowBackup) &#123;</span><br><span class="line">        ai.flags |= ApplicationInfo.FLAG_ALLOW_BACKUP; <span class="comment">// 如果为 true，设置 FLAG_ALLOW_BACKUP 标志位</span></span><br><span class="line">        </span><br><span class="line">        <span class="comment">// 解析 android:backupAgent 属性！</span></span><br><span class="line">        String backupAgent = sa.getNonConfigurationString(</span><br><span class="line">                com.android.internal.R.styleable.AndroidManifestApplication_backupAgent,</span><br><span class="line">                Configuration.NATIVE_CONFIG_VERSION);</span><br><span class="line">        <span class="keyword">if</span> (backupAgent != <span class="keyword">null</span>) &#123;</span><br><span class="line">            ai.backupAgentName = buildClassName(pkgName, backupAgent, outError);</span><br><span class="line">            <span class="keyword">if</span> (DEBUG_BACKUP) &#123;</span><br><span class="line">                Slog.v(TAG, <span class="string">"android:backupAgent = "</span> + ai.backupAgentName</span><br><span class="line">                        + <span class="string">" from "</span> + pkgName + <span class="string">"+"</span> + backupAgent);</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            <span class="keyword">if</span> (sa.getBoolean(</span><br><span class="line">                    com.android.internal.R.styleable.AndroidManifestApplication_killAfterRestore,</span><br><span class="line">                    <span class="keyword">true</span>)) &#123;</span><br><span class="line">                <span class="comment">// 解析 android:killAfterRestore 属性，为 true 设置 FLAG_KILL_AFTER_RESTORE 标志位</span></span><br><span class="line">                ai.flags |= ApplicationInfo.FLAG_KILL_AFTER_RESTORE;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">if</span> (sa.getBoolean(</span><br><span class="line">                    com.android.internal.R.styleable.AndroidManifestApplication_restoreAnyVersion,</span><br><span class="line">                    <span class="keyword">false</span>)) &#123;</span><br><span class="line">                <span class="comment">// 解析 android:restoreAnyVersion 属性，为 true 设置 FLAG_RESTORE_ANY_VERSION 标志位</span></span><br><span class="line">                ai.flags |= ApplicationInfo.FLAG_RESTORE_ANY_VERSION;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">if</span> (sa.getBoolean(</span><br><span class="line">                    com.android.internal.R.styleable.AndroidManifestApplication_fullBackupOnly,</span><br><span class="line">                    <span class="keyword">false</span>)) &#123;</span><br><span class="line">                <span class="comment">// 解析 android:fullBackupOnly 属性，为 true 设置 FLAG_FULL_BACKUP_ONLY 标志位</span></span><br><span class="line">                ai.flags |= ApplicationInfo.FLAG_FULL_BACKUP_ONLY;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">if</span> (sa.getBoolean(</span><br><span class="line">                    com.android.internal.R.styleable.AndroidManifestApplication_backupInForeground,</span><br><span class="line">                    <span class="keyword">false</span>)) &#123;</span><br><span class="line">                <span class="comment">// 解析 android:backupInForeground 属性，为 true 设置 PRIVATE_FLAG_BACKUP_IN_FOREGROUND 标志位</span></span><br><span class="line">                ai.privateFlags |= ApplicationInfo.PRIVATE_FLAG_BACKUP_IN_FOREGROUND;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        </span><br><span class="line">        <span class="comment">// 解析 android:fullBackupContent 属性！</span></span><br><span class="line">        TypedValue v = sa.peekValue(</span><br><span class="line">                com.android.internal.R.styleable.AndroidManifestApplication_fullBackupContent);</span><br><span class="line">        <span class="keyword">if</span> (v != <span class="keyword">null</span> &amp;&amp; (ai.fullBackupContent = v.resourceId) == <span class="number">0</span>) &#123;</span><br><span class="line">            <span class="keyword">if</span> (DEBUG_BACKUP) &#123;</span><br><span class="line">                Slog.v(TAG, <span class="string">"fullBackupContent specified as boolean="</span> +</span><br><span class="line">                        (v.data == <span class="number">0</span> ? <span class="string">"false"</span> : <span class="string">"true"</span>));</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="comment">// "false" =&gt; -1, "true" =&gt; 0</span></span><br><span class="line">            ai.fullBackupContent = (v.data == <span class="number">0</span> ? -<span class="number">1</span> : <span class="number">0</span>);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">if</span> (DEBUG_BACKUP) &#123;</span><br><span class="line">            Slog.v(TAG, <span class="string">"fullBackupContent="</span> + ai.fullBackupContent + <span class="string">" for "</span> + pkgName);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 解析 android:theme android:description 属性！</span></span><br><span class="line">    ai.theme = sa.getResourceId(</span><br><span class="line">            com.android.internal.R.styleable.AndroidManifestApplication_theme, <span class="number">0</span>);</span><br><span class="line">    ai.descriptionRes = sa.getResourceId(</span><br><span class="line">            com.android.internal.R.styleable.AndroidManifestApplication_description, <span class="number">0</span>);</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 如果设置了 PARSE_IS_SYSTEM，并且 android:persistent 为 true</span></span><br><span class="line">    <span class="comment">// 那么 ai.flags 设置 ApplicationInfo.FLAG_PERSISTENT 标志位，其为 persistent 属性！</span></span><br><span class="line">    <span class="keyword">if</span> ((flags&amp;PARSE_IS_SYSTEM) != <span class="number">0</span>) &#123;</span><br><span class="line">        <span class="keyword">if</span> (sa.getBoolean(</span><br><span class="line">                com.android.internal.R.styleable.AndroidManifestApplication_persistent,</span><br><span class="line">                <span class="keyword">false</span>)) &#123;</span><br><span class="line">            ai.flags |= ApplicationInfo.FLAG_PERSISTENT;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// 解析 android:requiredForAllUsers 属性，为true，表示该应用在所有 user 下都可用！</span></span><br><span class="line">    <span class="keyword">if</span> (sa.getBoolean(</span><br><span class="line">            com.android.internal.R.styleable.AndroidManifestApplication_requiredForAllUsers,</span><br><span class="line">            <span class="keyword">false</span>)) &#123;</span><br><span class="line">        owner.mRequiredForAllUsers = <span class="keyword">true</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 解析 android:requiredAccountType android:restrictedAccountType 的属性！</span></span><br><span class="line">    String restrictedAccountType = sa.getString(com.android.internal.R.styleable</span><br><span class="line">            .AndroidManifestApplication_restrictedAccountType);</span><br><span class="line">    <span class="keyword">if</span> (restrictedAccountType != <span class="keyword">null</span> &amp;&amp; restrictedAccountType.length() &gt; <span class="number">0</span>) &#123;</span><br><span class="line">        owner.mRestrictedAccountType = restrictedAccountType;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    String requiredAccountType = sa.getString(com.android.internal.R.styleable</span><br><span class="line">            .AndroidManifestApplication_requiredAccountType);</span><br><span class="line">    <span class="keyword">if</span> (requiredAccountType != <span class="keyword">null</span> &amp;&amp; requiredAccountType.length() &gt; <span class="number">0</span>) &#123;</span><br><span class="line">        owner.mRequiredAccountType = requiredAccountType;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 解析 android:debuggable android:vmSafeMode 属性！</span></span><br><span class="line">    <span class="keyword">if</span> (sa.getBoolean(</span><br><span class="line">            com.android.internal.R.styleable.AndroidManifestApplication_debuggable,</span><br><span class="line">            <span class="keyword">false</span>)) &#123;</span><br><span class="line">        ai.flags |= ApplicationInfo.FLAG_DEBUGGABLE;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (sa.getBoolean(</span><br><span class="line">            com.android.internal.R.styleable.AndroidManifestApplication_vmSafeMode,</span><br><span class="line">            <span class="keyword">false</span>)) &#123;</span><br><span class="line">        ai.flags |= ApplicationInfo.FLAG_VM_SAFE_MODE;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// 解析 android:hardwareAccelerated 属性！</span></span><br><span class="line">    owner.baseHardwareAccelerated = sa.getBoolean(</span><br><span class="line">            com.android.internal.R.styleable.AndroidManifestApplication_hardwareAccelerated,</span><br><span class="line">            owner.applicationInfo.targetSdkVersion &gt;= Build.VERSION_CODES.ICE_CREAM_SANDWICH);</span><br><span class="line">    <span class="keyword">if</span> (owner.baseHardwareAccelerated) &#123;</span><br><span class="line">        ai.flags |= ApplicationInfo.FLAG_HARDWARE_ACCELERATED;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// 解析 android:hasCode 属性！</span></span><br><span class="line">    <span class="keyword">if</span> (sa.getBoolean(</span><br><span class="line">            com.android.internal.R.styleable.AndroidManifestApplication_hasCode,</span><br><span class="line">            <span class="keyword">true</span>)) &#123;</span><br><span class="line">        ai.flags |= ApplicationInfo.FLAG_HAS_CODE;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 解析 android:allowTaskReparenting 属性，这个属性很重要，决定了 acivity 和 task 的关系</span></span><br><span class="line">    <span class="comment">// 在 application 标签上设置该属性对内部的所有 activity 生效！</span></span><br><span class="line">    <span class="keyword">if</span> (sa.getBoolean(</span><br><span class="line">            com.android.internal.R.styleable.AndroidManifestApplication_allowTaskReparenting,</span><br><span class="line">            <span class="keyword">false</span>)) &#123;</span><br><span class="line">        ai.flags |= ApplicationInfo.FLAG_ALLOW_TASK_REPARENTING;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// 解析 android:allowClearUserData 属性！</span></span><br><span class="line">    <span class="keyword">if</span> (sa.getBoolean(</span><br><span class="line">            com.android.internal.R.styleable.AndroidManifestApplication_allowClearUserData,</span><br><span class="line">            <span class="keyword">true</span>)) &#123;</span><br><span class="line">        ai.flags |= ApplicationInfo.FLAG_ALLOW_CLEAR_USER_DATA;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// The parent package controls installation, hence specify test only installs.</span></span><br><span class="line">    <span class="keyword">if</span> (owner.parentPackage == <span class="keyword">null</span>) &#123;</span><br><span class="line">        <span class="keyword">if</span> (sa.getBoolean(</span><br><span class="line">                com.android.internal.R.styleable.AndroidManifestApplication_testOnly,</span><br><span class="line">                <span class="keyword">false</span>)) &#123;</span><br><span class="line">            ai.flags |= ApplicationInfo.FLAG_TEST_ONLY;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// 解析 android:largeHeap 属性！</span></span><br><span class="line">    <span class="keyword">if</span> (sa.getBoolean(</span><br><span class="line">            com.android.internal.R.styleable.AndroidManifestApplication_largeHeap,</span><br><span class="line">            <span class="keyword">false</span>)) &#123;</span><br><span class="line">        ai.flags |= ApplicationInfo.FLAG_LARGE_HEAP;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// 解析 android:usesCleartextTraffic 属性！</span></span><br><span class="line">    <span class="keyword">if</span> (sa.getBoolean(</span><br><span class="line">            com.android.internal.R.styleable.AndroidManifestApplication_usesCleartextTraffic,</span><br><span class="line">            <span class="keyword">true</span>)) &#123;</span><br><span class="line">        ai.flags |= ApplicationInfo.FLAG_USES_CLEARTEXT_TRAFFIC;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// 解析 android:supportsRtl 属性！</span></span><br><span class="line">    <span class="keyword">if</span> (sa.getBoolean(</span><br><span class="line">            com.android.internal.R.styleable.AndroidManifestApplication_supportsRtl,</span><br><span class="line">            <span class="keyword">false</span> <span class="comment">/* default is no RTL support*/</span>)) &#123;</span><br><span class="line">        ai.flags |= ApplicationInfo.FLAG_SUPPORTS_RTL;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// 解析 android:multiArch 属性！</span></span><br><span class="line">    <span class="keyword">if</span> (sa.getBoolean(</span><br><span class="line">            com.android.internal.R.styleable.AndroidManifestApplication_multiArch,</span><br><span class="line">            <span class="keyword">false</span>)) &#123;</span><br><span class="line">        ai.flags |= ApplicationInfo.FLAG_MULTIARCH;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// 解析 android:extractNativeLibs 属性！</span></span><br><span class="line">    <span class="keyword">if</span> (sa.getBoolean(</span><br><span class="line">            com.android.internal.R.styleable.AndroidManifestApplication_extractNativeLibs,</span><br><span class="line">            <span class="keyword">true</span>)) &#123;</span><br><span class="line">        ai.flags |= ApplicationInfo.FLAG_EXTRACT_NATIVE_LIBS;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// 解析 android:defaultToDeviceProtectedStorage 属性！</span></span><br><span class="line">    <span class="keyword">if</span> (sa.getBoolean(</span><br><span class="line">            R.styleable.AndroidManifestApplication_defaultToDeviceProtectedStorage,</span><br><span class="line">            <span class="keyword">false</span>)) &#123;</span><br><span class="line">        ai.privateFlags |= ApplicationInfo.PRIVATE_FLAG_DEFAULT_TO_DEVICE_PROTECTED_STORAGE;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// 解析 android:directBootAware 属性！</span></span><br><span class="line">    <span class="keyword">if</span> (sa.getBoolean(</span><br><span class="line">            R.styleable.AndroidManifestApplication_directBootAware,</span><br><span class="line">            <span class="keyword">false</span>)) &#123;</span><br><span class="line">        ai.privateFlags |= ApplicationInfo.PRIVATE_FLAG_DIRECT_BOOT_AWARE;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// 解析 android:resizeableActivity 属性！</span></span><br><span class="line">    <span class="keyword">if</span> (sa.getBoolean(R.styleable.AndroidManifestApplication_resizeableActivity,</span><br><span class="line">            owner.applicationInfo.targetSdkVersion &gt;= Build.VERSION_CODES.N)) &#123;</span><br><span class="line">        ai.privateFlags |= PRIVATE_FLAG_RESIZEABLE_ACTIVITIES;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// 解析 android:networkSecurityConfig 属性！</span></span><br><span class="line">    ai.networkSecurityConfigRes = sa.getResourceId(</span><br><span class="line">            com.android.internal.R.styleable.AndroidManifestApplication_networkSecurityConfig,</span><br><span class="line">            <span class="number">0</span>);</span><br><span class="line">    <span class="comment">// 解析 android:permission 属性！</span></span><br><span class="line">    String str;</span><br><span class="line">    str = sa.getNonConfigurationString(</span><br><span class="line">            com.android.internal.R.styleable.AndroidManifestApplication_permission, <span class="number">0</span>);</span><br><span class="line">    ai.permission = (str != <span class="keyword">null</span> &amp;&amp; str.length() &gt; <span class="number">0</span>) ? str.intern() : <span class="keyword">null</span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 解析 android:taskAffinity 属性，这个属性很重要，决定了 acivity 和 task 的关系</span></span><br><span class="line">    <span class="comment">// 在 application 标签上设置该属性对内部的所有 activity 生效！</span></span><br><span class="line">    <span class="keyword">if</span> (owner.applicationInfo.targetSdkVersion &gt;= Build.VERSION_CODES.FROYO) &#123;</span><br><span class="line">        str = sa.getNonConfigurationString(</span><br><span class="line">                com.android.internal.R.styleable.AndroidManifestApplication_taskAffinity,</span><br><span class="line">                Configuration.NATIVE_CONFIG_VERSION);</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        str = sa.getNonResourceString(</span><br><span class="line">                com.android.internal.R.styleable.AndroidManifestApplication_taskAffinity);</span><br><span class="line">    &#125;</span><br><span class="line">    ai.taskAffinity = buildTaskAffinityName(ai.packageName, ai.packageName,</span><br><span class="line">            str, outError);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (outError[<span class="number">0</span>] == <span class="keyword">null</span>) &#123;</span><br><span class="line">        CharSequence pname;</span><br><span class="line">        <span class="comment">// 解析 android:process 属性，这个属性很重要，决定了组件运行所在的进程名</span></span><br><span class="line">        <span class="comment">// 在 application 标签上设置该属性对内部的所有组件生效！</span></span><br><span class="line">        <span class="keyword">if</span> (owner.applicationInfo.targetSdkVersion &gt;= Build.VERSION_CODES.FROYO) &#123;</span><br><span class="line">            pname = sa.getNonConfigurationString(</span><br><span class="line">                    com.android.internal.R.styleable.AndroidManifestApplication_process,</span><br><span class="line">                    Configuration.NATIVE_CONFIG_VERSION);</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">         </span><br><span class="line">            pname = sa.getNonResourceString(</span><br><span class="line">                    com.android.internal.R.styleable.AndroidManifestApplication_process);</span><br><span class="line">        &#125;</span><br><span class="line">        ai.processName = buildProcessName(ai.packageName, <span class="keyword">null</span>, pname,</span><br><span class="line">                flags, mSeparateProcesses, outError);</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 解析 android:isGame android:enabled 属性，</span></span><br><span class="line">        ai.enabled = sa.getBoolean(</span><br><span class="line">                com.android.internal.R.styleable.AndroidManifestApplication_enabled, <span class="keyword">true</span>);</span><br><span class="line">        <span class="keyword">if</span> (sa.getBoolean(</span><br><span class="line">                com.android.internal.R.styleable.AndroidManifestApplication_isGame, <span class="keyword">false</span>)) &#123;</span><br><span class="line">            ai.flags |= ApplicationInfo.FLAG_IS_GAME;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (<span class="keyword">false</span>) &#123;</span><br><span class="line">            <span class="comment">// 解析 android:cantSaveState 属性，这里由于 if 为 false，所以不会解析！</span></span><br><span class="line">            <span class="comment">// 主要用于 height-weight 类型的应用！</span></span><br><span class="line">            <span class="keyword">if</span> (sa.getBoolean(</span><br><span class="line">                    com.android.internal.R.styleable.AndroidManifestApplication_cantSaveState,</span><br><span class="line">                    <span class="keyword">false</span>)) &#123;</span><br><span class="line">                ai.privateFlags |= ApplicationInfo.PRIVATE_FLAG_CANT_SAVE_STATE;</span><br><span class="line"></span><br><span class="line">                <span class="comment">// 对于 height-weight 类型的应用，其所在进程的进程名只能是包名，我们无法自定义其进程名！</span></span><br><span class="line">                <span class="keyword">if</span> (ai.processName != <span class="keyword">null</span> &amp;&amp; ai.processName != ai.packageName) &#123;</span><br><span class="line">                    outError[<span class="number">0</span>] = <span class="string">"cantSaveState applications can not use custom processes"</span>;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// 解析 android:uiOptions 属性！</span></span><br><span class="line">    ai.uiOptions = sa.getInt(</span><br><span class="line">            com.android.internal.R.styleable.AndroidManifestApplication_uiOptions, <span class="number">0</span>);</span><br><span class="line"></span><br><span class="line">    sa.recycle();</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (outError[<span class="number">0</span>] != <span class="keyword">null</span>) &#123;</span><br><span class="line">        mParseError = PackageManager.INSTALL_PARSE_FAILED_MANIFEST_MALFORMED;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">false</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">//【2】解析四大组件！</span></span><br><span class="line">    <span class="keyword">final</span> <span class="keyword">int</span> innerDepth = parser.getDepth();</span><br><span class="line">    <span class="keyword">int</span> type;</span><br><span class="line">    <span class="keyword">while</span> ((type = parser.next()) != XmlPullParser.END_DOCUMENT</span><br><span class="line">            &amp;&amp; (type != XmlPullParser.END_TAG || parser.getDepth() &gt; innerDepth)) &#123;</span><br><span class="line">        <span class="keyword">if</span> (type == XmlPullParser.END_TAG || type == XmlPullParser.TEXT) &#123;</span><br><span class="line">            <span class="keyword">continue</span>;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        String tagName = parser.getName();</span><br><span class="line"></span><br><span class="line">        <span class="comment">//【2.1】解析 "activity" 组件</span></span><br><span class="line">        <span class="keyword">if</span> (tagName.equals(<span class="string">"activity"</span>)) &#123;</span><br><span class="line">            Activity a = parseActivity(owner, res, parser, flags, outError, <span class="keyword">false</span>,</span><br><span class="line">                    owner.baseHardwareAccelerated);</span><br><span class="line">            <span class="keyword">if</span> (a == <span class="keyword">null</span>) &#123;</span><br><span class="line">                mParseError = PackageManager.INSTALL_PARSE_FAILED_MANIFEST_MALFORMED;</span><br><span class="line">                <span class="keyword">return</span> <span class="keyword">false</span>;</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            owner.activities.add(a);</span><br><span class="line"></span><br><span class="line">        <span class="comment">//【2.2】解析 "receiver" 组件</span></span><br><span class="line">        &#125; <span class="keyword">else</span> <span class="keyword">if</span> (tagName.equals(<span class="string">"receiver"</span>)) &#123;</span><br><span class="line">            Activity a = parseActivity(owner, res, parser, flags, outError, <span class="keyword">true</span>, <span class="keyword">false</span>);</span><br><span class="line">            <span class="keyword">if</span> (a == <span class="keyword">null</span>) &#123;</span><br><span class="line">                mParseError = PackageManager.INSTALL_PARSE_FAILED_MANIFEST_MALFORMED;</span><br><span class="line">                <span class="keyword">return</span> <span class="keyword">false</span>;</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            owner.receivers.add(a);</span><br><span class="line"></span><br><span class="line">        <span class="comment">//【2.3】解析 "service" 组件</span></span><br><span class="line">        &#125; <span class="keyword">else</span> <span class="keyword">if</span> (tagName.equals(<span class="string">"service"</span>)) &#123;</span><br><span class="line">            Service s = parseService(owner, res, parser, flags, outError);</span><br><span class="line">            <span class="keyword">if</span> (s == <span class="keyword">null</span>) &#123;</span><br><span class="line">                mParseError = PackageManager.INSTALL_PARSE_FAILED_MANIFEST_MALFORMED;</span><br><span class="line">                <span class="keyword">return</span> <span class="keyword">false</span>;</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            owner.services.add(s);</span><br><span class="line"></span><br><span class="line">        <span class="comment">//【2.4】解析 "provider" 组件</span></span><br><span class="line">        &#125; <span class="keyword">else</span> <span class="keyword">if</span> (tagName.equals(<span class="string">"provider"</span>)) &#123;</span><br><span class="line">            Provider p = parseProvider(owner, res, parser, flags, outError);</span><br><span class="line">            <span class="keyword">if</span> (p == <span class="keyword">null</span>) &#123;</span><br><span class="line">                mParseError = PackageManager.INSTALL_PARSE_FAILED_MANIFEST_MALFORMED;</span><br><span class="line">                <span class="keyword">return</span> <span class="keyword">false</span>;</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            owner.providers.add(p);</span><br><span class="line"></span><br><span class="line">        &#125; <span class="keyword">else</span> <span class="keyword">if</span> (tagName.equals(<span class="string">"activity-alias"</span>)) &#123; </span><br><span class="line">            <span class="comment">//【2.5】解析 "activity-alias" 组件</span></span><br><span class="line">            Activity a = parseActivityAlias(owner, res, parser, flags, outError);</span><br><span class="line">            <span class="keyword">if</span> (a == <span class="keyword">null</span>) &#123;</span><br><span class="line">                mParseError = PackageManager.INSTALL_PARSE_FAILED_MANIFEST_MALFORMED;</span><br><span class="line">                <span class="keyword">return</span> <span class="keyword">false</span>;</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            owner.activities.add(a);</span><br><span class="line"></span><br><span class="line">        &#125; <span class="keyword">else</span> <span class="keyword">if</span> (parser.getName().equals(<span class="string">"meta-data"</span>)) &#123;</span><br><span class="line">            <span class="comment">//【2.6】解析 "meta-data" 组件</span></span><br><span class="line">            <span class="keyword">if</span> ((owner.mAppMetaData = parseMetaData(res, parser, owner.mAppMetaData,</span><br><span class="line">                    outError)) == <span class="keyword">null</span>) &#123;</span><br><span class="line">                mParseError = PackageManager.INSTALL_PARSE_FAILED_MANIFEST_MALFORMED;</span><br><span class="line">                <span class="keyword">return</span> <span class="keyword">false</span>;</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">        &#125; <span class="keyword">else</span> <span class="keyword">if</span> (tagName.equals(<span class="string">"library"</span>)) &#123;</span><br><span class="line">            <span class="comment">//【2.6】解析 "library" 组件</span></span><br><span class="line">            sa = res.obtainAttributes(parser,</span><br><span class="line">                    com.android.internal.R.styleable.AndroidManifestLibrary);</span><br><span class="line">            String lname = sa.getNonResourceString(</span><br><span class="line">                    com.android.internal.R.styleable.AndroidManifestLibrary_name);</span><br><span class="line"></span><br><span class="line">            sa.recycle();</span><br><span class="line"></span><br><span class="line">            <span class="keyword">if</span> (lname != <span class="keyword">null</span>) &#123;</span><br><span class="line">                lname = lname.intern();</span><br><span class="line">                <span class="keyword">if</span> (!ArrayUtils.contains(owner.libraryNames, lname)) &#123;</span><br><span class="line">                    owner.libraryNames = ArrayUtils.add(owner.libraryNames, lname);</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            XmlUtils.skipCurrentTag(parser);</span><br><span class="line"></span><br><span class="line">        &#125; <span class="keyword">else</span> <span class="keyword">if</span> (tagName.equals(<span class="string">"uses-library"</span>)) &#123;</span><br><span class="line">            <span class="comment">//【2.7】解析 "uses-library" 组件</span></span><br><span class="line">            sa = res.obtainAttributes(parser,</span><br><span class="line">                    com.android.internal.R.styleable.AndroidManifestUsesLibrary);</span><br><span class="line"></span><br><span class="line">            <span class="comment">// Note: don't allow this value to be a reference to a resource</span></span><br><span class="line">            <span class="comment">// that may change.</span></span><br><span class="line">            String lname = sa.getNonResourceString(</span><br><span class="line">                    com.android.internal.R.styleable.AndroidManifestUsesLibrary_name);</span><br><span class="line">            <span class="keyword">boolean</span> req = sa.getBoolean(</span><br><span class="line">                    com.android.internal.R.styleable.AndroidManifestUsesLibrary_required,</span><br><span class="line">                    <span class="keyword">true</span>);</span><br><span class="line"></span><br><span class="line">            sa.recycle();</span><br><span class="line"></span><br><span class="line">            <span class="keyword">if</span> (lname != <span class="keyword">null</span>) &#123;</span><br><span class="line">                lname = lname.intern();</span><br><span class="line">                <span class="keyword">if</span> (req) &#123;</span><br><span class="line">                    owner.usesLibraries = ArrayUtils.add(owner.usesLibraries, lname);</span><br><span class="line">                &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                    owner.usesOptionalLibraries = ArrayUtils.add(</span><br><span class="line">                            owner.usesOptionalLibraries, lname);</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            XmlUtils.skipCurrentTag(parser);</span><br><span class="line"></span><br><span class="line">        &#125; <span class="keyword">else</span> <span class="keyword">if</span> (tagName.equals(<span class="string">"uses-package"</span>)) &#123;</span><br><span class="line">            <span class="comment">// Dependencies for app installers; we don't currently try to</span></span><br><span class="line">            <span class="comment">// enforce this.</span></span><br><span class="line">            XmlUtils.skipCurrentTag(parser);</span><br><span class="line"></span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            <span class="keyword">if</span> (!RIGID_PARSER) &#123;</span><br><span class="line">                Slog.w(TAG, <span class="string">"Unknown element under &lt;application&gt;: "</span> + tagName</span><br><span class="line">                        + <span class="string">" at "</span> + mArchiveSourcePath + <span class="string">" "</span></span><br><span class="line">                        + parser.getPositionDescription());</span><br><span class="line">                XmlUtils.skipCurrentTag(parser);</span><br><span class="line">                <span class="keyword">continue</span>;</span><br><span class="line">            &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                outError[<span class="number">0</span>] = <span class="string">"Bad element under &lt;application&gt;: "</span> + tagName;</span><br><span class="line">                mParseError = PackageManager.INSTALL_PARSE_FAILED_MANIFEST_MALFORMED;</span><br><span class="line">                <span class="keyword">return</span> <span class="keyword">false</span>;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    modifySharedLibrariesForBackwardCompatibility(owner);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (hasDomainURLs(owner)) &#123;</span><br><span class="line">        owner.applicationInfo.privateFlags |= ApplicationInfo.PRIVATE_FLAG_HAS_DOMAIN_URLS;</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        owner.applicationInfo.privateFlags &amp;= ~ApplicationInfo.PRIVATE_FLAG_HAS_DOMAIN_URLS;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">true</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>这里重点的是四大组件的解析：</p>
<h6 id="3-1-1-2-3-1-PParser-parseActivity-解析-activity-和-receiver"><a href="#3-1-1-2-3-1-PParser-parseActivity-解析-activity-和-receiver" class="headerlink" title="3.1.1.2.3.1 PParser.parseActivity - 解析 activity 和 receiver"></a>3.1.1.2.3.1 PParser.parseActivity - 解析 activity 和 receiver</h6><p>我们来看看 activity 的解析过程：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br><span class="line">212</span><br><span class="line">213</span><br><span class="line">214</span><br><span class="line">215</span><br><span class="line">216</span><br><span class="line">217</span><br><span class="line">218</span><br><span class="line">219</span><br><span class="line">220</span><br><span class="line">221</span><br><span class="line">222</span><br><span class="line">223</span><br><span class="line">224</span><br><span class="line">225</span><br><span class="line">226</span><br><span class="line">227</span><br><span class="line">228</span><br><span class="line">229</span><br><span class="line">230</span><br><span class="line">231</span><br><span class="line">232</span><br><span class="line">233</span><br><span class="line">234</span><br><span class="line">235</span><br><span class="line">236</span><br><span class="line">237</span><br><span class="line">238</span><br><span class="line">239</span><br><span class="line">240</span><br><span class="line">241</span><br><span class="line">242</span><br><span class="line">243</span><br><span class="line">244</span><br><span class="line">245</span><br><span class="line">246</span><br><span class="line">247</span><br><span class="line">248</span><br><span class="line">249</span><br><span class="line">250</span><br><span class="line">251</span><br><span class="line">252</span><br><span class="line">253</span><br><span class="line">254</span><br><span class="line">255</span><br><span class="line">256</span><br><span class="line">257</span><br><span class="line">258</span><br><span class="line">259</span><br><span class="line">260</span><br><span class="line">261</span><br><span class="line">262</span><br><span class="line">263</span><br><span class="line">264</span><br><span class="line">265</span><br><span class="line">266</span><br><span class="line">267</span><br><span class="line">268</span><br><span class="line">269</span><br><span class="line">270</span><br><span class="line">271</span><br><span class="line">272</span><br><span class="line">273</span><br><span class="line">274</span><br><span class="line">275</span><br><span class="line">276</span><br><span class="line">277</span><br><span class="line">278</span><br><span class="line">279</span><br><span class="line">280</span><br><span class="line">281</span><br><span class="line">282</span><br><span class="line">283</span><br><span class="line">284</span><br><span class="line">285</span><br><span class="line">286</span><br><span class="line">287</span><br><span class="line">288</span><br><span class="line">289</span><br><span class="line">290</span><br><span class="line">291</span><br><span class="line">292</span><br><span class="line">293</span><br><span class="line">294</span><br><span class="line">295</span><br><span class="line">296</span><br><span class="line">297</span><br><span class="line">298</span><br><span class="line">299</span><br><span class="line">300</span><br><span class="line">301</span><br><span class="line">302</span><br><span class="line">303</span><br><span class="line">304</span><br><span class="line">305</span><br><span class="line">306</span><br><span class="line">307</span><br><span class="line">308</span><br><span class="line">309</span><br><span class="line">310</span><br><span class="line">311</span><br><span class="line">312</span><br><span class="line">313</span><br><span class="line">314</span><br><span class="line">315</span><br><span class="line">316</span><br><span class="line">317</span><br><span class="line">318</span><br><span class="line">319</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">private</span> Activity <span class="title">parseActivity</span><span class="params">(Package owner, Resources res,</span></span></span><br><span class="line"><span class="function"><span class="params">        XmlResourceParser parser, <span class="keyword">int</span> flags, String[] outError,</span></span></span><br><span class="line"><span class="function"><span class="params">        <span class="keyword">boolean</span> receiver, <span class="keyword">boolean</span> hardwareAccelerated)</span></span></span><br><span class="line"><span class="function">        <span class="keyword">throws</span> XmlPullParserException, IOException </span>&#123;</span><br><span class="line">    TypedArray sa = res.obtainAttributes(parser, R.styleable.AndroidManifestActivity);</span><br><span class="line">    <span class="comment">// 解析 android:name android:label android:icon android:roundIcon android:logo android:banner 属性！</span></span><br><span class="line">    <span class="keyword">if</span> (mParseActivityArgs == <span class="keyword">null</span>) &#123;</span><br><span class="line">        mParseActivityArgs = <span class="keyword">new</span> ParseComponentArgs(owner, outError,</span><br><span class="line">                R.styleable.AndroidManifestActivity_name,</span><br><span class="line">                R.styleable.AndroidManifestActivity_label,</span><br><span class="line">                R.styleable.AndroidManifestActivity_icon,</span><br><span class="line">                R.styleable.AndroidManifestActivity_roundIcon,</span><br><span class="line">                R.styleable.AndroidManifestActivity_logo,</span><br><span class="line">                R.styleable.AndroidManifestActivity_banner,</span><br><span class="line">                mSeparateProcesses,</span><br><span class="line">                R.styleable.AndroidManifestActivity_process,</span><br><span class="line">                R.styleable.AndroidManifestActivity_description,</span><br><span class="line">                R.styleable.AndroidManifestActivity_enabled);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// 由于 activty 和 receiver 使用的同一个方法，所以需要区分解析的是哪个，此时 receiver 为 false！</span></span><br><span class="line">    mParseActivityArgs.tag = receiver ? <span class="string">"&lt;receiver&gt;"</span> : <span class="string">"&lt;activity&gt;"</span>;</span><br><span class="line">    mParseActivityArgs.sa = sa;</span><br><span class="line">    mParseActivityArgs.flags = flags;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//【2】创建了一个 Activity 对象！</span></span><br><span class="line">    Activity a = <span class="keyword">new</span> Activity(mParseActivityArgs, <span class="keyword">new</span> ActivityInfo());</span><br><span class="line">    <span class="keyword">if</span> (outError[<span class="number">0</span>] != <span class="keyword">null</span>) &#123;</span><br><span class="line">        sa.recycle();</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">null</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// 解析 android:exported 属性！</span></span><br><span class="line">    <span class="keyword">boolean</span> setExported = sa.hasValue(R.styleable.AndroidManifestActivity_exported);</span><br><span class="line">    <span class="keyword">if</span> (setExported) &#123;</span><br><span class="line">        a.info.exported = sa.getBoolean(R.styleable.AndroidManifestActivity_exported, <span class="keyword">false</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// 解析 android:theme 属性！</span></span><br><span class="line">    a.info.theme = sa.getResourceId(R.styleable.AndroidManifestActivity_theme, <span class="number">0</span>);</span><br><span class="line">    <span class="comment">// 解析 android:uiOptions 属性！</span></span><br><span class="line">    a.info.uiOptions = sa.getInt(R.styleable.AndroidManifestActivity_uiOptions,</span><br><span class="line">            a.info.applicationInfo.uiOptions);</span><br><span class="line">    <span class="comment">// 解析 android:parentActivityName 属性！</span></span><br><span class="line">    String parentName = sa.getNonConfigurationString(</span><br><span class="line">            R.styleable.AndroidManifestActivity_parentActivityName,</span><br><span class="line">            Configuration.NATIVE_CONFIG_VERSION);</span><br><span class="line">    <span class="keyword">if</span> (parentName != <span class="keyword">null</span>) &#123;</span><br><span class="line">        String parentClassName = buildClassName(a.info.packageName, parentName, outError);</span><br><span class="line">        <span class="keyword">if</span> (outError[<span class="number">0</span>] == <span class="keyword">null</span>) &#123;</span><br><span class="line">            a.info.parentActivityName = parentClassName;</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            Log.e(TAG, <span class="string">"Activity "</span> + a.info.name + <span class="string">" specified invalid parentActivityName "</span> +</span><br><span class="line">                    parentName);</span><br><span class="line">            outError[<span class="number">0</span>] = <span class="keyword">null</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// 解析 android:permission 属性！</span></span><br><span class="line">    String str;</span><br><span class="line">    str = sa.getNonConfigurationString(R.styleable.AndroidManifestActivity_permission, <span class="number">0</span>);</span><br><span class="line">    <span class="keyword">if</span> (str == <span class="keyword">null</span>) &#123;</span><br><span class="line">        a.info.permission = owner.applicationInfo.permission;</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        a.info.permission = str.length() &gt; <span class="number">0</span> ? str.toString().intern() : <span class="keyword">null</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// 解析 android:taskAffinity 属性，这个属性真重要，能决定该 acitivty 和 task 的关系！！</span></span><br><span class="line">    str = sa.getNonConfigurationString(</span><br><span class="line">            R.styleable.AndroidManifestActivity_taskAffinity,</span><br><span class="line">            Configuration.NATIVE_CONFIG_VERSION);</span><br><span class="line">    a.info.taskAffinity = buildTaskAffinityName(owner.applicationInfo.packageName,</span><br><span class="line">            owner.applicationInfo.taskAffinity, str, outError);</span><br><span class="line"></span><br><span class="line">    a.info.flags = <span class="number">0</span>;</span><br><span class="line">    <span class="comment">// 解析 android:multiprocess 属性</span></span><br><span class="line">    <span class="keyword">if</span> (sa.getBoolean(</span><br><span class="line">            R.styleable.AndroidManifestActivity_multiprocess, <span class="keyword">false</span>)) &#123;</span><br><span class="line">        a.info.flags |= ActivityInfo.FLAG_MULTIPROCESS;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// 解析 android:finishOnTaskLaunch 属性，这个属性真重要，能决定该 acitivty 和 task 的关系！！</span></span><br><span class="line">    <span class="keyword">if</span> (sa.getBoolean(R.styleable.AndroidManifestActivity_finishOnTaskLaunch, <span class="keyword">false</span>)) &#123;</span><br><span class="line">        a.info.flags |= ActivityInfo.FLAG_FINISH_ON_TASK_LAUNCH;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// 解析 android:clearTaskOnLaunch 属性，这个属性真重要，能决定该 acitivty 和 task 的关系！</span></span><br><span class="line">    <span class="keyword">if</span> (sa.getBoolean(R.styleable.AndroidManifestActivity_clearTaskOnLaunch, <span class="keyword">false</span>)) &#123;</span><br><span class="line">        a.info.flags |= ActivityInfo.FLAG_CLEAR_TASK_ON_LAUNCH;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// 解析 android:noHistory 属性，这个属性真重要，能决定该 acitivty 和 task 的关系！</span></span><br><span class="line">    <span class="keyword">if</span> (sa.getBoolean(R.styleable.AndroidManifestActivity_noHistory, <span class="keyword">false</span>)) &#123;</span><br><span class="line">        a.info.flags |= ActivityInfo.FLAG_NO_HISTORY;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// 解析 android:alwaysRetainTaskState 属性，这个属性真重要，能决定该 acitivty 和 task 的关系！</span></span><br><span class="line">    <span class="keyword">if</span> (sa.getBoolean(R.styleable.AndroidManifestActivity_alwaysRetainTaskState, <span class="keyword">false</span>)) &#123;</span><br><span class="line">        a.info.flags |= ActivityInfo.FLAG_ALWAYS_RETAIN_TASK_STATE;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// 解析 android:stateNotNeeded 属性</span></span><br><span class="line">    <span class="keyword">if</span> (sa.getBoolean(R.styleable.AndroidManifestActivity_stateNotNeeded, <span class="keyword">false</span>)) &#123;</span><br><span class="line">        a.info.flags |= ActivityInfo.FLAG_STATE_NOT_NEEDED;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// 解析 android:excludeFromRecents 属性，不再最近任务显示</span></span><br><span class="line">    <span class="keyword">if</span> (sa.getBoolean(R.styleable.AndroidManifestActivity_excludeFromRecents, <span class="keyword">false</span>)) &#123;</span><br><span class="line">        a.info.flags |= ActivityInfo.FLAG_EXCLUDE_FROM_RECENTS;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// 解析 android:allowTaskReparenting 属性，这个属性真重要，能决定该 acitivty 和 task 的关系！</span></span><br><span class="line">    <span class="keyword">if</span> (sa.getBoolean(R.styleable.AndroidManifestActivity_allowTaskReparenting,</span><br><span class="line">            (owner.applicationInfo.flags&amp;ApplicationInfo.FLAG_ALLOW_TASK_REPARENTING) != <span class="number">0</span>)) &#123;</span><br><span class="line">        a.info.flags |= ActivityInfo.FLAG_ALLOW_TASK_REPARENTING;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// 解析 android:finishOnCloseSystemDialogs 属性</span></span><br><span class="line">    <span class="keyword">if</span> (sa.getBoolean(R.styleable.AndroidManifestActivity_finishOnCloseSystemDialogs, <span class="keyword">false</span>)) &#123;</span><br><span class="line">        a.info.flags |= ActivityInfo.FLAG_FINISH_ON_CLOSE_SYSTEM_DIALOGS;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// 解析 android:showOnLockScreen 属性</span></span><br><span class="line">    <span class="keyword">if</span> (sa.getBoolean(R.styleable.AndroidManifestActivity_showOnLockScreen, <span class="keyword">false</span>)</span><br><span class="line">            || sa.getBoolean(R.styleable.AndroidManifestActivity_showForAllUsers, <span class="keyword">false</span>)) &#123;</span><br><span class="line">        a.info.flags |= ActivityInfo.FLAG_SHOW_FOR_ALL_USERS;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// 解析 android:immersive 属性</span></span><br><span class="line">    <span class="keyword">if</span> (sa.getBoolean(R.styleable.AndroidManifestActivity_immersive, <span class="keyword">false</span>)) &#123;</span><br><span class="line">        a.info.flags |= ActivityInfo.FLAG_IMMERSIVE;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// 解析 android:systemUserOnly 属性</span></span><br><span class="line">    <span class="keyword">if</span> (sa.getBoolean(R.styleable.AndroidManifestActivity_systemUserOnly, <span class="keyword">false</span>)) &#123;</span><br><span class="line">        a.info.flags |= ActivityInfo.FLAG_SYSTEM_USER_ONLY;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// 接下来，对于 activity 和 receiver 解析不同的属性！</span></span><br><span class="line">    <span class="keyword">if</span> (!receiver) &#123;</span><br><span class="line">        <span class="comment">// 对于 activity 进入这个！</span></span><br><span class="line">        <span class="comment">// 解析 android:hardwareAccelerated 属性</span></span><br><span class="line">        <span class="keyword">if</span> (sa.getBoolean(R.styleable.AndroidManifestActivity_hardwareAccelerated,</span><br><span class="line">                hardwareAccelerated)) &#123;</span><br><span class="line">            a.info.flags |= ActivityInfo.FLAG_HARDWARE_ACCELERATED;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">// 解析 android:launchMode 属性</span></span><br><span class="line">        a.info.launchMode = sa.getInt(</span><br><span class="line">                R.styleable.AndroidManifestActivity_launchMode, ActivityInfo.LAUNCH_MULTIPLE);</span><br><span class="line">        <span class="comment">// 解析 android:documentLaunchMode 属性</span></span><br><span class="line">        a.info.documentLaunchMode = sa.getInt(</span><br><span class="line">                R.styleable.AndroidManifestActivity_documentLaunchMode,</span><br><span class="line">                ActivityInfo.DOCUMENT_LAUNCH_NONE);</span><br><span class="line">        <span class="comment">// 解析 android:maxRecents 属性</span></span><br><span class="line">        a.info.maxRecents = sa.getInt(</span><br><span class="line">                R.styleable.AndroidManifestActivity_maxRecents,</span><br><span class="line">                ActivityManager.getDefaultAppRecentsLimitStatic());</span><br><span class="line">        <span class="comment">// 解析 android:configChanges 属性</span></span><br><span class="line">        a.info.configChanges = sa.getInt(R.styleable.AndroidManifestActivity_configChanges, <span class="number">0</span>);</span><br><span class="line">        <span class="comment">// 解析 android:windowSoftInputMode 属性</span></span><br><span class="line">        a.info.softInputMode = sa.getInt(</span><br><span class="line">                R.styleable.AndroidManifestActivity_windowSoftInputMode, <span class="number">0</span>);</span><br><span class="line">        <span class="comment">// 解析 android:persistableMode 属性</span></span><br><span class="line">        a.info.persistableMode = sa.getInteger(</span><br><span class="line">                R.styleable.AndroidManifestActivity_persistableMode,</span><br><span class="line">                ActivityInfo.PERSIST_ROOT_ONLY);</span><br><span class="line">        <span class="comment">// 解析 android:allowEmbedded 属性</span></span><br><span class="line">        <span class="keyword">if</span> (sa.getBoolean(R.styleable.AndroidManifestActivity_allowEmbedded, <span class="keyword">false</span>)) &#123;</span><br><span class="line">            a.info.flags |= ActivityInfo.FLAG_ALLOW_EMBEDDED;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">// 解析 android:autoRemoveFromRecents 属性</span></span><br><span class="line">        <span class="keyword">if</span> (sa.getBoolean(R.styleable.AndroidManifestActivity_autoRemoveFromRecents, <span class="keyword">false</span>)) &#123;</span><br><span class="line">            a.info.flags |= ActivityInfo.FLAG_AUTO_REMOVE_FROM_RECENTS;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">// 解析 android:relinquishTaskIdentity 属性</span></span><br><span class="line">        <span class="keyword">if</span> (sa.getBoolean(R.styleable.AndroidManifestActivity_relinquishTaskIdentity, <span class="keyword">false</span>)) &#123;</span><br><span class="line">            a.info.flags |= ActivityInfo.FLAG_RELINQUISH_TASK_IDENTITY;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">// 解析 android:resumeWhilePausing 属性</span></span><br><span class="line">        <span class="keyword">if</span> (sa.getBoolean(R.styleable.AndroidManifestActivity_resumeWhilePausing, <span class="keyword">false</span>)) &#123;</span><br><span class="line">            a.info.flags |= ActivityInfo.FLAG_RESUME_WHILE_PAUSING;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">// 解析 android:screenOrientation 属性</span></span><br><span class="line">        a.info.screenOrientation = sa.getInt(</span><br><span class="line">                R.styleable.AndroidManifestActivity_screenOrientation,</span><br><span class="line">                SCREEN_ORIENTATION_UNSPECIFIED);</span><br><span class="line">        <span class="comment">// 解析 android:resizeableActivity android:supportsPictureInPicture 属性</span></span><br><span class="line">        a.info.resizeMode = RESIZE_MODE_UNRESIZEABLE;</span><br><span class="line">        <span class="keyword">final</span> <span class="keyword">boolean</span> appDefault = (owner.applicationInfo.privateFlags</span><br><span class="line">                &amp; PRIVATE_FLAG_RESIZEABLE_ACTIVITIES) != <span class="number">0</span>;</span><br><span class="line">        <span class="keyword">final</span> <span class="keyword">boolean</span> resizeableSetExplicitly</span><br><span class="line">                = sa.hasValue(R.styleable.AndroidManifestActivity_resizeableActivity);</span><br><span class="line">        <span class="keyword">final</span> <span class="keyword">boolean</span> resizeable = sa.getBoolean(</span><br><span class="line">                R.styleable.AndroidManifestActivity_resizeableActivity, appDefault);</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (resizeable) &#123;</span><br><span class="line">            <span class="keyword">if</span> (sa.getBoolean(R.styleable.AndroidManifestActivity_supportsPictureInPicture,</span><br><span class="line">                    <span class="keyword">false</span>)) &#123;</span><br><span class="line">                a.info.resizeMode = RESIZE_MODE_RESIZEABLE_AND_PIPABLE;</span><br><span class="line">            &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                a.info.resizeMode = RESIZE_MODE_RESIZEABLE;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125; <span class="keyword">else</span> <span class="keyword">if</span> (owner.applicationInfo.targetSdkVersion &gt;= Build.VERSION_CODES.N</span><br><span class="line">                || resizeableSetExplicitly) &#123;</span><br><span class="line">            a.info.resizeMode = RESIZE_MODE_UNRESIZEABLE;</span><br><span class="line">        &#125; <span class="keyword">else</span> <span class="keyword">if</span> (!a.info.isFixedOrientation() &amp;&amp; (a.info.flags &amp; FLAG_IMMERSIVE) == <span class="number">0</span>) &#123;</span><br><span class="line">            a.info.resizeMode = RESIZE_MODE_FORCE_RESIZEABLE;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">// 解析 android:alwaysFocusable 属性</span></span><br><span class="line">        <span class="keyword">if</span> (sa.getBoolean(R.styleable.AndroidManifestActivity_alwaysFocusable, <span class="keyword">false</span>)) &#123;</span><br><span class="line">            a.info.flags |= FLAG_ALWAYS_FOCUSABLE;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">// 解析 android:lockTaskMode 属性</span></span><br><span class="line">        a.info.lockTaskLaunchMode =</span><br><span class="line">                sa.getInt(R.styleable.AndroidManifestActivity_lockTaskMode, <span class="number">0</span>);</span><br><span class="line">        <span class="comment">// 解析 android:directBootAware 属性</span></span><br><span class="line">        a.info.encryptionAware = a.info.directBootAware = sa.getBoolean(</span><br><span class="line">                R.styleable.AndroidManifestActivity_directBootAware,</span><br><span class="line">                <span class="keyword">false</span>);</span><br><span class="line">        <span class="comment">// 解析 android:enableVrMode 属性</span></span><br><span class="line">        a.info.requestedVrComponent =</span><br><span class="line">            sa.getString(R.styleable.AndroidManifestActivity_enableVrMode);</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        <span class="comment">// 对于 receiver，会进入这里！</span></span><br><span class="line">        a.info.launchMode = ActivityInfo.LAUNCH_MULTIPLE;</span><br><span class="line">        a.info.configChanges = <span class="number">0</span>;</span><br><span class="line">        <span class="comment">// 解析 android:singleUser 属性</span></span><br><span class="line">        <span class="keyword">if</span> (sa.getBoolean(R.styleable.AndroidManifestActivity_singleUser, <span class="keyword">false</span>)) &#123;</span><br><span class="line">            a.info.flags |= ActivityInfo.FLAG_SINGLE_USER;</span><br><span class="line">            <span class="keyword">if</span> (a.info.exported &amp;&amp; (flags &amp; PARSE_IS_PRIVILEGED) == <span class="number">0</span>) &#123;</span><br><span class="line">                Slog.w(TAG, <span class="string">"Activity exported request ignored due to singleUser: "</span></span><br><span class="line">                        + a.className + <span class="string">" at "</span> + mArchiveSourcePath + <span class="string">" "</span></span><br><span class="line">                        + parser.getPositionDescription());</span><br><span class="line">                a.info.exported = <span class="keyword">false</span>;</span><br><span class="line">                setExported = <span class="keyword">true</span>;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">// 解析 android:directBootAware 属性</span></span><br><span class="line">        a.info.encryptionAware = a.info.directBootAware = sa.getBoolean(</span><br><span class="line">                R.styleable.AndroidManifestActivity_directBootAware,</span><br><span class="line">                <span class="keyword">false</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (a.info.directBootAware) &#123;</span><br><span class="line">        owner.applicationInfo.privateFlags |=</span><br><span class="line">                ApplicationInfo.PRIVATE_FLAG_PARTIALLY_DIRECT_BOOT_AWARE;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    sa.recycle();</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 如果解析的是 receiver，针对 height-weight 类型的进程做处理</span></span><br><span class="line">    <span class="keyword">if</span> (receiver &amp;&amp; (owner.applicationInfo.privateFlags</span><br><span class="line">            &amp;ApplicationInfo.PRIVATE_FLAG_CANT_SAVE_STATE) != <span class="number">0</span>) &#123;</span><br><span class="line">        <span class="keyword">if</span> (a.info.processName == owner.packageName) &#123;</span><br><span class="line">            outError[<span class="number">0</span>] = <span class="string">"Heavy-weight applications can not have receivers in main process"</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (outError[<span class="number">0</span>] != <span class="keyword">null</span>) &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">null</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">int</span> outerDepth = parser.getDepth();</span><br><span class="line">    <span class="keyword">int</span> type;</span><br><span class="line">    <span class="keyword">while</span> ((type=parser.next()) != XmlPullParser.END_DOCUMENT</span><br><span class="line">           &amp;&amp; (type != XmlPullParser.END_TAG</span><br><span class="line">                   || parser.getDepth() &gt; outerDepth)) &#123;</span><br><span class="line">        <span class="keyword">if</span> (type == XmlPullParser.END_TAG || type == XmlPullParser.TEXT) &#123;</span><br><span class="line">            <span class="keyword">continue</span>;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (parser.getName().equals(<span class="string">"intent-filter"</span>)) &#123; <span class="comment">// 解析 "intent-filter"</span></span><br><span class="line">            ActivityIntentInfo intent = <span class="keyword">new</span> ActivityIntentInfo(a);</span><br><span class="line">            <span class="keyword">if</span> (!parseIntent(res, parser, <span class="keyword">true</span>, <span class="keyword">true</span>, intent, outError)) &#123;</span><br><span class="line">                <span class="keyword">return</span> <span class="keyword">null</span>;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">if</span> (intent.countActions() == <span class="number">0</span>) &#123;</span><br><span class="line">                Slog.w(TAG, <span class="string">"No actions in intent filter at "</span></span><br><span class="line">                        + mArchiveSourcePath + <span class="string">" "</span></span><br><span class="line">                        + parser.getPositionDescription());</span><br><span class="line">            &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                a.intents.add(intent);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125; <span class="keyword">else</span> <span class="keyword">if</span> (!receiver &amp;&amp; parser.getName().equals(<span class="string">"preferred"</span>)) &#123; <span class="comment">// 解析 "preferred"</span></span><br><span class="line">            ActivityIntentInfo intent = <span class="keyword">new</span> ActivityIntentInfo(a);</span><br><span class="line">            <span class="keyword">if</span> (!parseIntent(res, parser, <span class="keyword">false</span>, <span class="keyword">false</span>, intent, outError)) &#123;</span><br><span class="line">                <span class="keyword">return</span> <span class="keyword">null</span>;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">if</span> (intent.countActions() == <span class="number">0</span>) &#123;</span><br><span class="line">                Slog.w(TAG, <span class="string">"No actions in preferred at "</span></span><br><span class="line">                        + mArchiveSourcePath + <span class="string">" "</span></span><br><span class="line">                        + parser.getPositionDescription());</span><br><span class="line">            &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                <span class="keyword">if</span> (owner.preferredActivityFilters == <span class="keyword">null</span>) &#123;</span><br><span class="line">                    owner.preferredActivityFilters = <span class="keyword">new</span> ArrayList&lt;ActivityIntentInfo&gt;();</span><br><span class="line">                &#125;</span><br><span class="line">                owner.preferredActivityFilters.add(intent);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125; <span class="keyword">else</span> <span class="keyword">if</span> (parser.getName().equals(<span class="string">"meta-data"</span>)) &#123; <span class="comment">// 解析 "meta-data"</span></span><br><span class="line">            <span class="keyword">if</span> ((a.metaData = parseMetaData(res, parser, a.metaData,</span><br><span class="line">                    outError)) == <span class="keyword">null</span>) &#123;</span><br><span class="line">                <span class="keyword">return</span> <span class="keyword">null</span>;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125; <span class="keyword">else</span> <span class="keyword">if</span> (!receiver &amp;&amp; parser.getName().equals(<span class="string">"layout"</span>)) &#123; <span class="comment">// 解析 "layout"</span></span><br><span class="line">            parseLayout(res, parser, a);</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            <span class="keyword">if</span> (!RIGID_PARSER) &#123;</span><br><span class="line">                Slog.w(TAG, <span class="string">"Problem in package "</span> + mArchiveSourcePath + <span class="string">":"</span>);</span><br><span class="line">                <span class="keyword">if</span> (receiver) &#123;</span><br><span class="line">                    Slog.w(TAG, <span class="string">"Unknown element under &lt;receiver&gt;: "</span> + parser.getName()</span><br><span class="line">                            + <span class="string">" at "</span> + mArchiveSourcePath + <span class="string">" "</span></span><br><span class="line">                            + parser.getPositionDescription());</span><br><span class="line">                &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                    Slog.w(TAG, <span class="string">"Unknown element under &lt;activity&gt;: "</span> + parser.getName()</span><br><span class="line">                            + <span class="string">" at "</span> + mArchiveSourcePath + <span class="string">" "</span></span><br><span class="line">                            + parser.getPositionDescription());</span><br><span class="line">                &#125;</span><br><span class="line">                XmlUtils.skipCurrentTag(parser);</span><br><span class="line">                <span class="keyword">continue</span>;</span><br><span class="line">            &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                <span class="keyword">if</span> (receiver) &#123;</span><br><span class="line">                    outError[<span class="number">0</span>] = <span class="string">"Bad element under &lt;receiver&gt;: "</span> + parser.getName();</span><br><span class="line">                &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                    outError[<span class="number">0</span>] = <span class="string">"Bad element under &lt;activity&gt;: "</span> + parser.getName();</span><br><span class="line">                &#125;</span><br><span class="line">                <span class="keyword">return</span> <span class="keyword">null</span>;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (!setExported) &#123;</span><br><span class="line">        a.info.exported = a.intents.size() &gt; <span class="number">0</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> a;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>整个解析过程很清晰，就是不断读取对应标签的属性，然后设置 Activity 的属性和标志位！</p>
<p>######3.1.1.2.3.2 PParser.parseService - 解析 service</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br></pre></td><td class="code"><pre><span class="line">private Service parseService(Package owner, Resources res,</span><br><span class="line">        XmlResourceParser parser, int flags, String[] outError)</span><br><span class="line">        throws XmlPullParserException, IOException &#123;</span><br><span class="line">    TypedArray sa = res.obtainAttributes(parser,</span><br><span class="line">            com.android.internal.R.styleable.AndroidManifestService);</span><br><span class="line">    // 解析 android:name android:label android:icon android:roundIcon android:logo android:banner 属性！</span><br><span class="line">    if (mParseServiceArgs == null) &#123;</span><br><span class="line">        mParseServiceArgs = new ParseComponentArgs(owner, outError,</span><br><span class="line">                com.android.internal.R.styleable.AndroidManifestService_name,</span><br><span class="line">                com.android.internal.R.styleable.AndroidManifestService_label,</span><br><span class="line">                com.android.internal.R.styleable.AndroidManifestService_icon,</span><br><span class="line">                com.android.internal.R.styleable.AndroidManifestService_roundIcon,</span><br><span class="line">                com.android.internal.R.styleable.AndroidManifestService_logo,</span><br><span class="line">                com.android.internal.R.styleable.AndroidManifestService_banner,</span><br><span class="line">                mSeparateProcesses,</span><br><span class="line">                com.android.internal.R.styleable.AndroidManifestService_process,</span><br><span class="line">                com.android.internal.R.styleable.AndroidManifestService_description,</span><br><span class="line">                com.android.internal.R.styleable.AndroidManifestService_enabled);</span><br><span class="line">        mParseServiceArgs.tag = &quot;&lt;service&gt;&quot;;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    mParseServiceArgs.sa = sa;</span><br><span class="line">    mParseServiceArgs.flags = flags;</span><br><span class="line">    // 创建 Service 对象！</span><br><span class="line">    Service s = new Service(mParseServiceArgs, new ServiceInfo());</span><br><span class="line">    if (outError[0] != null) &#123;</span><br><span class="line">        sa.recycle();</span><br><span class="line">        return null;</span><br><span class="line">    &#125;</span><br><span class="line">    // 解析 android:exported 属性！</span><br><span class="line">    boolean setExported = sa.hasValue(</span><br><span class="line">            com.android.internal.R.styleable.AndroidManifestService_exported);</span><br><span class="line">    if (setExported) &#123;</span><br><span class="line">        s.info.exported = sa.getBoolean(</span><br><span class="line">                com.android.internal.R.styleable.AndroidManifestService_exported, false);</span><br><span class="line">    &#125;</span><br><span class="line">    // 解析 android:permission 属性！</span><br><span class="line">    String str = sa.getNonConfigurationString(</span><br><span class="line">            com.android.internal.R.styleable.AndroidManifestService_permission, 0);</span><br><span class="line">    if (str == null) &#123;</span><br><span class="line">        s.info.permission = owner.applicationInfo.permission;</span><br><span class="line">    &#125; else &#123;</span><br><span class="line">        s.info.permission = str.length() &gt; 0 ? str.toString().intern() : null;</span><br><span class="line">    &#125;</span><br><span class="line">    // 解析 android:stopWithTask 属性！</span><br><span class="line">    s.info.flags = 0;</span><br><span class="line">    if (sa.getBoolean(</span><br><span class="line">            com.android.internal.R.styleable.AndroidManifestService_stopWithTask,</span><br><span class="line">            false)) &#123;</span><br><span class="line">        s.info.flags |= ServiceInfo.FLAG_STOP_WITH_TASK;</span><br><span class="line">    &#125;</span><br><span class="line">    // 解析 android:isolatedProcess 属性！</span><br><span class="line">    if (sa.getBoolean(</span><br><span class="line">            com.android.internal.R.styleable.AndroidManifestService_isolatedProcess,</span><br><span class="line">            false)) &#123;</span><br><span class="line">        s.info.flags |= ServiceInfo.FLAG_ISOLATED_PROCESS;</span><br><span class="line">    &#125;</span><br><span class="line">    // 解析 android:externalService 属性！</span><br><span class="line">    if (sa.getBoolean(</span><br><span class="line">            com.android.internal.R.styleable.AndroidManifestService_externalService,</span><br><span class="line">            false)) &#123;</span><br><span class="line">        s.info.flags |= ServiceInfo.FLAG_EXTERNAL_SERVICE;</span><br><span class="line">    &#125;</span><br><span class="line">    // 解析 android:singleUser 属性！</span><br><span class="line">    if (sa.getBoolean(</span><br><span class="line">            com.android.internal.R.styleable.AndroidManifestService_singleUser,</span><br><span class="line">            false)) &#123;</span><br><span class="line">        s.info.flags |= ServiceInfo.FLAG_SINGLE_USER;</span><br><span class="line">        if (s.info.exported &amp;&amp; (flags &amp; PARSE_IS_PRIVILEGED) == 0) &#123;</span><br><span class="line">            Slog.w(TAG, &quot;Service exported request ignored due to singleUser: &quot;</span><br><span class="line">                    + s.className + &quot; at &quot; + mArchiveSourcePath + &quot; &quot;</span><br><span class="line">                    + parser.getPositionDescription());</span><br><span class="line">            s.info.exported = false;</span><br><span class="line">            setExported = true;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    // 解析 android:directBootAware 属性！</span><br><span class="line">    s.info.encryptionAware = s.info.directBootAware = sa.getBoolean(</span><br><span class="line">            R.styleable.AndroidManifestService_directBootAware,</span><br><span class="line">            false);</span><br><span class="line">    if (s.info.directBootAware) &#123;</span><br><span class="line">        owner.applicationInfo.privateFlags |=</span><br><span class="line">                ApplicationInfo.PRIVATE_FLAG_PARTIALLY_DIRECT_BOOT_AWARE;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    sa.recycle();</span><br><span class="line">    // 如果应用属于 height-weight 类型的进程，要对进程名做处理！</span><br><span class="line">    if ((owner.applicationInfo.privateFlags&amp;ApplicationInfo.PRIVATE_FLAG_CANT_SAVE_STATE)</span><br><span class="line">            != 0) &#123;</span><br><span class="line">        if (s.info.processName == owner.packageName) &#123;</span><br><span class="line">            outError[0] = &quot;Heavy-weight applications can not have services in main process&quot;;</span><br><span class="line">            return null;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    int outerDepth = parser.getDepth();</span><br><span class="line">    int type;</span><br><span class="line">    while ((type=parser.next()) != XmlPullParser.END_DOCUMENT</span><br><span class="line">           &amp;&amp; (type != XmlPullParser.END_TAG</span><br><span class="line">                   || parser.getDepth() &gt; outerDepth)) &#123;</span><br><span class="line">        if (type == XmlPullParser.END_TAG || type == XmlPullParser.TEXT) &#123;</span><br><span class="line">            continue;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        if (parser.getName().equals(&quot;intent-filter&quot;)) &#123; // 解析 &quot;intent-filter&quot;！</span><br><span class="line">            ServiceIntentInfo intent = new ServiceIntentInfo(s);</span><br><span class="line">            if (!parseIntent(res, parser, true, false, intent, outError)) &#123;</span><br><span class="line">                return null;</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            s.intents.add(intent);</span><br><span class="line">        &#125; else if (parser.getName().equals(&quot;meta-data&quot;)) &#123;</span><br><span class="line">            if ((s.metaData=parseMetaData(res, parser, s.metaData,</span><br><span class="line">                    outError)) == null) &#123;</span><br><span class="line">                return null;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125; else &#123;</span><br><span class="line">            if (!RIGID_PARSER) &#123;</span><br><span class="line">                Slog.w(TAG, &quot;Unknown element under &lt;service&gt;: &quot;</span><br><span class="line">                        + parser.getName() + &quot; at &quot; + mArchiveSourcePath + &quot; &quot;</span><br><span class="line">                        + parser.getPositionDescription());</span><br><span class="line">                XmlUtils.skipCurrentTag(parser);</span><br><span class="line">                continue;</span><br><span class="line">            &#125; else &#123;</span><br><span class="line">                outError[0] = &quot;Bad element under &lt;service&gt;: &quot; + parser.getName();</span><br><span class="line">                return null;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    if (!setExported) &#123;</span><br><span class="line">        s.info.exported = s.intents.size() &gt; 0;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    return s;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>######3.1.1.2.3.3 PParser.parseProvider - 解析 parseProvider</p>
<p>接下来是解析 provider：<br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">private</span> Provider <span class="title">parseProvider</span><span class="params">(Package owner, Resources res,</span></span></span><br><span class="line"><span class="function"><span class="params">        XmlResourceParser parser, <span class="keyword">int</span> flags, String[] outError)</span></span></span><br><span class="line"><span class="function">        <span class="keyword">throws</span> XmlPullParserException, IOException </span>&#123;</span><br><span class="line">    TypedArray sa = res.obtainAttributes(parser,</span><br><span class="line">            com.android.internal.R.styleable.AndroidManifestProvider);</span><br><span class="line">    <span class="comment">// 解析 android:name android:label android:icon android:roundIcon android:logo android:banner 属性！</span></span><br><span class="line">    <span class="keyword">if</span> (mParseProviderArgs == <span class="keyword">null</span>) &#123;</span><br><span class="line">        mParseProviderArgs = <span class="keyword">new</span> ParseComponentArgs(owner, outError,</span><br><span class="line">                com.android.internal.R.styleable.AndroidManifestProvider_name,</span><br><span class="line">                com.android.internal.R.styleable.AndroidManifestProvider_label,</span><br><span class="line">                com.android.internal.R.styleable.AndroidManifestProvider_icon,</span><br><span class="line">                com.android.internal.R.styleable.AndroidManifestProvider_roundIcon,</span><br><span class="line">                com.android.internal.R.styleable.AndroidManifestProvider_logo,</span><br><span class="line">                com.android.internal.R.styleable.AndroidManifestProvider_banner,</span><br><span class="line">                mSeparateProcesses,</span><br><span class="line">                com.android.internal.R.styleable.AndroidManifestProvider_process,</span><br><span class="line">                com.android.internal.R.styleable.AndroidManifestProvider_description,</span><br><span class="line">                com.android.internal.R.styleable.AndroidManifestProvider_enabled);</span><br><span class="line">        mParseProviderArgs.tag = <span class="string">"&lt;provider&gt;"</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    mParseProviderArgs.sa = sa;</span><br><span class="line">    mParseProviderArgs.flags = flags;</span><br><span class="line">    <span class="comment">// 创建一个 Provider 对象！</span></span><br><span class="line">    Provider p = <span class="keyword">new</span> Provider(mParseProviderArgs, <span class="keyword">new</span> ProviderInfo());</span><br><span class="line">    <span class="keyword">if</span> (outError[<span class="number">0</span>] != <span class="keyword">null</span>) &#123;</span><br><span class="line">        sa.recycle();</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">null</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">boolean</span> providerExportedDefault = <span class="keyword">false</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (owner.applicationInfo.targetSdkVersion &lt; Build.VERSION_CODES.JELLY_BEAN_MR1) &#123;</span><br><span class="line">        <span class="comment">// For compatibility, applications targeting API level 16 or lower</span></span><br><span class="line">        <span class="comment">// should have their content providers exported by default, unless they</span></span><br><span class="line">        <span class="comment">// specify otherwise.</span></span><br><span class="line">        providerExportedDefault = <span class="keyword">true</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// 解析 android:exported 属性！</span></span><br><span class="line">    p.info.exported = sa.getBoolean(</span><br><span class="line">            com.android.internal.R.styleable.AndroidManifestProvider_exported,</span><br><span class="line">            providerExportedDefault);</span><br><span class="line">    <span class="comment">// 解析 android:authorities 属性！</span></span><br><span class="line">    String cpname = sa.getNonConfigurationString(</span><br><span class="line">            com.android.internal.R.styleable.AndroidManifestProvider_authorities, <span class="number">0</span>);</span><br><span class="line">    <span class="comment">// 解析 android:syncable 属性！</span></span><br><span class="line">    p.info.isSyncable = sa.getBoolean(</span><br><span class="line">            com.android.internal.R.styleable.AndroidManifestProvider_syncable,</span><br><span class="line">            <span class="keyword">false</span>);</span><br><span class="line">    <span class="comment">// 解析 android:permission 属性！</span></span><br><span class="line">    String permission = sa.getNonConfigurationString(</span><br><span class="line">            com.android.internal.R.styleable.AndroidManifestProvider_permission, <span class="number">0</span>);</span><br><span class="line">    <span class="comment">// 解析 android:readPermission 属性！</span></span><br><span class="line">    String str = sa.getNonConfigurationString(</span><br><span class="line">            com.android.internal.R.styleable.AndroidManifestProvider_readPermission, <span class="number">0</span>);</span><br><span class="line">    <span class="keyword">if</span> (str == <span class="keyword">null</span>) &#123;</span><br><span class="line">        str = permission;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span> (str == <span class="keyword">null</span>) &#123;</span><br><span class="line">        p.info.readPermission = owner.applicationInfo.permission;</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        p.info.readPermission =</span><br><span class="line">            str.length() &gt; <span class="number">0</span> ? str.toString().intern() : <span class="keyword">null</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// 解析 android:writePermission 属性！</span></span><br><span class="line">    str = sa.getNonConfigurationString(</span><br><span class="line">            com.android.internal.R.styleable.AndroidManifestProvider_writePermission, <span class="number">0</span>);</span><br><span class="line">    <span class="keyword">if</span> (str == <span class="keyword">null</span>) &#123;</span><br><span class="line">        str = permission;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span> (str == <span class="keyword">null</span>) &#123;</span><br><span class="line">        p.info.writePermission = owner.applicationInfo.permission;</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        p.info.writePermission =</span><br><span class="line">            str.length() &gt; <span class="number">0</span> ? str.toString().intern() : <span class="keyword">null</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// 解析 android:grantUriPermissions 属性！</span></span><br><span class="line">    p.info.grantUriPermissions = sa.getBoolean(</span><br><span class="line">            com.android.internal.R.styleable.AndroidManifestProvider_grantUriPermissions,</span><br><span class="line">            <span class="keyword">false</span>);</span><br><span class="line">    <span class="comment">// 解析 android:multiprocess 属性！</span></span><br><span class="line">    p.info.multiprocess = sa.getBoolean(</span><br><span class="line">            com.android.internal.R.styleable.AndroidManifestProvider_multiprocess,</span><br><span class="line">            <span class="keyword">false</span>);</span><br><span class="line">    <span class="comment">// 解析 android:initOrder 属性！</span></span><br><span class="line">    p.info.initOrder = sa.getInt(</span><br><span class="line">            com.android.internal.R.styleable.AndroidManifestProvider_initOrder,</span><br><span class="line">            <span class="number">0</span>);</span><br><span class="line"></span><br><span class="line">    p.info.flags = <span class="number">0</span>;</span><br><span class="line">    <span class="comment">// 解析 android:singleUser 属性！</span></span><br><span class="line">    <span class="keyword">if</span> (sa.getBoolean(</span><br><span class="line">            com.android.internal.R.styleable.AndroidManifestProvider_singleUser,</span><br><span class="line">            <span class="keyword">false</span>)) &#123;</span><br><span class="line">        p.info.flags |= ProviderInfo.FLAG_SINGLE_USER;</span><br><span class="line">        <span class="keyword">if</span> (p.info.exported &amp;&amp; (flags &amp; PARSE_IS_PRIVILEGED) == <span class="number">0</span>) &#123;</span><br><span class="line">            Slog.w(TAG, <span class="string">"Provider exported request ignored due to singleUser: "</span></span><br><span class="line">                    + p.className + <span class="string">" at "</span> + mArchiveSourcePath + <span class="string">" "</span></span><br><span class="line">                    + parser.getPositionDescription());</span><br><span class="line">            p.info.exported = <span class="keyword">false</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// 解析 android:directBootAware 属性！</span></span><br><span class="line">    p.info.encryptionAware = p.info.directBootAware = sa.getBoolean(</span><br><span class="line">            R.styleable.AndroidManifestProvider_directBootAware,</span><br><span class="line">            <span class="keyword">false</span>);</span><br><span class="line">    <span class="keyword">if</span> (p.info.directBootAware) &#123;</span><br><span class="line">        owner.applicationInfo.privateFlags |=</span><br><span class="line">                ApplicationInfo.PRIVATE_FLAG_PARTIALLY_DIRECT_BOOT_AWARE;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    sa.recycle();</span><br><span class="line">    <span class="comment">// 如果应用设置为 height-weight 类型的应用，对进程名要做校验！</span></span><br><span class="line">    <span class="keyword">if</span> ((owner.applicationInfo.privateFlags&amp;ApplicationInfo.PRIVATE_FLAG_CANT_SAVE_STATE)</span><br><span class="line">            != <span class="number">0</span>) &#123;</span><br><span class="line">        <span class="keyword">if</span> (p.info.processName == owner.packageName) &#123;</span><br><span class="line">            outError[<span class="number">0</span>] = <span class="string">"Heavy-weight applications can not have providers in main process"</span>;</span><br><span class="line">            <span class="keyword">return</span> <span class="keyword">null</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (cpname == <span class="keyword">null</span>) &#123;</span><br><span class="line">        outError[<span class="number">0</span>] = <span class="string">"&lt;provider&gt; does not include authorities attribute"</span>;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">null</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span> (cpname.length() &lt;= <span class="number">0</span>) &#123;</span><br><span class="line">        outError[<span class="number">0</span>] = <span class="string">"&lt;provider&gt; has empty authorities attribute"</span>;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">null</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    p.info.authority = cpname.intern();</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (!parseProviderTags(res, parser, p, outError)) &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">null</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> p;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>对 provider 的解析就分析到这里！</p>
<h6 id="3-1-1-2-3-4-PParser-parseIntent-解析-intent-filter"><a href="#3-1-1-2-3-4-PParser-parseIntent-解析-intent-filter" class="headerlink" title="3.1.1.2.3.4 PParser.parseIntent - 解析 intent-filter"></a>3.1.1.2.3.4 PParser.parseIntent - 解析 intent-filter</h6><p>接下来，我们来看看对 activity receiver provider 的 intent-filter 的解析！</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">boolean</span> <span class="title">parseIntent</span><span class="params">(Resources res, XmlResourceParser parser,</span></span></span><br><span class="line"><span class="function"><span class="params">        <span class="keyword">boolean</span> allowGlobs, <span class="keyword">boolean</span> allowAutoVerify, IntentInfo outInfo, String[] outError)</span></span></span><br><span class="line"><span class="function">        <span class="keyword">throws</span> XmlPullParserException, IOException </span>&#123;</span><br><span class="line"></span><br><span class="line">    TypedArray sa = res.obtainAttributes(parser,</span><br><span class="line">            com.android.internal.R.styleable.AndroidManifestIntentFilter);</span><br><span class="line">    <span class="comment">// 解析 android:priority 属性！</span></span><br><span class="line">    <span class="keyword">int</span> priority = sa.getInt(</span><br><span class="line">            com.android.internal.R.styleable.AndroidManifestIntentFilter_priority, <span class="number">0</span>);</span><br><span class="line">    outInfo.setPriority(priority);</span><br><span class="line">    <span class="comment">// 解析 android:label 属性！</span></span><br><span class="line">    TypedValue v = sa.peekValue(</span><br><span class="line">            com.android.internal.R.styleable.AndroidManifestIntentFilter_label);</span><br><span class="line">    <span class="keyword">if</span> (v != <span class="keyword">null</span> &amp;&amp; (outInfo.labelRes=v.resourceId) == <span class="number">0</span>) &#123;</span><br><span class="line">        outInfo.nonLocalizedLabel = v.coerceToString();</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// 解析 android:useRoundIcon 属性！</span></span><br><span class="line">    <span class="keyword">final</span> <span class="keyword">boolean</span> useRoundIcon =</span><br><span class="line">            Resources.getSystem().getBoolean(com.android.internal.R.bool.config_useRoundIcon);</span><br><span class="line">    <span class="comment">// 解析 android:roundIcon android:icon 属性！</span></span><br><span class="line">    <span class="keyword">int</span> roundIconVal = useRoundIcon ? sa.getResourceId(</span><br><span class="line">            com.android.internal.R.styleable.AndroidManifestIntentFilter_roundIcon, <span class="number">0</span>) : <span class="number">0</span>;</span><br><span class="line">    <span class="keyword">if</span> (roundIconVal != <span class="number">0</span>) &#123;</span><br><span class="line">        outInfo.icon = roundIconVal;</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        outInfo.icon = sa.getResourceId(</span><br><span class="line">                com.android.internal.R.styleable.AndroidManifestIntentFilter_icon, <span class="number">0</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// 解析 android:logo 属性！</span></span><br><span class="line">    outInfo.logo = sa.getResourceId(</span><br><span class="line">            com.android.internal.R.styleable.AndroidManifestIntentFilter_logo, <span class="number">0</span>);</span><br><span class="line">    <span class="comment">// 解析 android:banner 属性！</span></span><br><span class="line">    outInfo.banner = sa.getResourceId(</span><br><span class="line">            com.android.internal.R.styleable.AndroidManifestIntentFilter_banner, <span class="number">0</span>);</span><br><span class="line">    <span class="comment">// 解析 android:autoVerify 属性！</span></span><br><span class="line">    <span class="keyword">if</span> (allowAutoVerify) &#123;</span><br><span class="line">        outInfo.setAutoVerify(sa.getBoolean(</span><br><span class="line">                com.android.internal.R.styleable.AndroidManifestIntentFilter_autoVerify,</span><br><span class="line">                <span class="keyword">false</span>));</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    sa.recycle();</span><br><span class="line"></span><br><span class="line">    <span class="keyword">int</span> outerDepth = parser.getDepth();</span><br><span class="line">    <span class="keyword">int</span> type;</span><br><span class="line">    <span class="keyword">while</span> ((type = parser.next()) != XmlPullParser.END_DOCUMENT</span><br><span class="line">            &amp;&amp; (type != XmlPullParser.END_TAG || parser.getDepth() &gt; outerDepth)) &#123;</span><br><span class="line">        <span class="keyword">if</span> (type == XmlPullParser.END_TAG || type == XmlPullParser.TEXT) &#123;</span><br><span class="line">            <span class="keyword">continue</span>;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        String nodeName = parser.getName();</span><br><span class="line">        <span class="keyword">if</span> (nodeName.equals(<span class="string">"action"</span>)) &#123; <span class="comment">// 解析 "action" 标签！</span></span><br><span class="line">            String value = parser.getAttributeValue(</span><br><span class="line">                    ANDROID_RESOURCES, <span class="string">"name"</span>);</span><br><span class="line">            <span class="keyword">if</span> (value == <span class="keyword">null</span> || value == <span class="string">""</span>) &#123;</span><br><span class="line">                outError[<span class="number">0</span>] = <span class="string">"No value supplied for &lt;android:name&gt;"</span>;</span><br><span class="line">                <span class="keyword">return</span> <span class="keyword">false</span>;</span><br><span class="line">            &#125;</span><br><span class="line">            XmlUtils.skipCurrentTag(parser);</span><br><span class="line"></span><br><span class="line">            outInfo.addAction(value);</span><br><span class="line">        &#125; <span class="keyword">else</span> <span class="keyword">if</span> (nodeName.equals(<span class="string">"category"</span>)) &#123; <span class="comment">// 解析 "category" 标签！</span></span><br><span class="line">            String value = parser.getAttributeValue(</span><br><span class="line">                    ANDROID_RESOURCES, <span class="string">"name"</span>);</span><br><span class="line">            <span class="keyword">if</span> (value == <span class="keyword">null</span> || value == <span class="string">""</span>) &#123;</span><br><span class="line">                outError[<span class="number">0</span>] = <span class="string">"No value supplied for &lt;android:name&gt;"</span>;</span><br><span class="line">                <span class="keyword">return</span> <span class="keyword">false</span>;</span><br><span class="line">            &#125;</span><br><span class="line">            XmlUtils.skipCurrentTag(parser);</span><br><span class="line"></span><br><span class="line">            outInfo.addCategory(value);</span><br><span class="line"></span><br><span class="line">        &#125; <span class="keyword">else</span> <span class="keyword">if</span> (nodeName.equals(<span class="string">"data"</span>)) &#123;  <span class="comment">// 解析 "data" 标签！</span></span><br><span class="line">            sa = res.obtainAttributes(parser,</span><br><span class="line">                    com.android.internal.R.styleable.AndroidManifestData);</span><br><span class="line">            <span class="comment">// 解析 android:mimeType 属性！</span></span><br><span class="line">            String str = sa.getNonConfigurationString(</span><br><span class="line">                    com.android.internal.R.styleable.AndroidManifestData_mimeType, <span class="number">0</span>);</span><br><span class="line">            <span class="keyword">if</span> (str != <span class="keyword">null</span>) &#123;</span><br><span class="line">                <span class="keyword">try</span> &#123;</span><br><span class="line">                    outInfo.addDataType(str);</span><br><span class="line">                &#125; <span class="keyword">catch</span> (IntentFilter.MalformedMimeTypeException e) &#123;</span><br><span class="line">                    outError[<span class="number">0</span>] = e.toString();</span><br><span class="line">                    sa.recycle();</span><br><span class="line">                    <span class="keyword">return</span> <span class="keyword">false</span>;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="comment">// 解析 android:scheme 属性！</span></span><br><span class="line">            str = sa.getNonConfigurationString(</span><br><span class="line">                    com.android.internal.R.styleable.AndroidManifestData_scheme, <span class="number">0</span>);</span><br><span class="line">            <span class="keyword">if</span> (str != <span class="keyword">null</span>) &#123;</span><br><span class="line">                outInfo.addDataScheme(str);</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="comment">// 解析 android:ssp 属性！</span></span><br><span class="line">            str = sa.getNonConfigurationString(</span><br><span class="line">                    com.android.internal.R.styleable.AndroidManifestData_ssp, <span class="number">0</span>);</span><br><span class="line">            <span class="keyword">if</span> (str != <span class="keyword">null</span>) &#123;</span><br><span class="line">                outInfo.addDataSchemeSpecificPart(str, PatternMatcher.PATTERN_LITERAL);</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="comment">// 解析 android:sspPrefix 属性！</span></span><br><span class="line">            str = sa.getNonConfigurationString(</span><br><span class="line">                    com.android.internal.R.styleable.AndroidManifestData_sspPrefix, <span class="number">0</span>);</span><br><span class="line">            <span class="keyword">if</span> (str != <span class="keyword">null</span>) &#123;</span><br><span class="line">                outInfo.addDataSchemeSpecificPart(str, PatternMatcher.PATTERN_PREFIX);</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="comment">// 解析 android:sspPattern 属性！</span></span><br><span class="line">            str = sa.getNonConfigurationString(</span><br><span class="line">                    com.android.internal.R.styleable.AndroidManifestData_sspPattern, <span class="number">0</span>);</span><br><span class="line">            <span class="keyword">if</span> (str != <span class="keyword">null</span>) &#123;</span><br><span class="line">                <span class="keyword">if</span> (!allowGlobs) &#123;</span><br><span class="line">                    outError[<span class="number">0</span>] = <span class="string">"sspPattern not allowed here; ssp must be literal"</span>;</span><br><span class="line">                    <span class="keyword">return</span> <span class="keyword">false</span>;</span><br><span class="line">                &#125;</span><br><span class="line">                outInfo.addDataSchemeSpecificPart(str, PatternMatcher.PATTERN_SIMPLE_GLOB);</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="comment">// 解析 android:host android:port 属性！</span></span><br><span class="line">            String host = sa.getNonConfigurationString(</span><br><span class="line">                    com.android.internal.R.styleable.AndroidManifestData_host, <span class="number">0</span>);</span><br><span class="line">            String port = sa.getNonConfigurationString(</span><br><span class="line">                    com.android.internal.R.styleable.AndroidManifestData_port, <span class="number">0</span>);</span><br><span class="line">            <span class="keyword">if</span> (host != <span class="keyword">null</span>) &#123;</span><br><span class="line">                outInfo.addDataAuthority(host, port);</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="comment">// 解析 android:path 属性！</span></span><br><span class="line">            str = sa.getNonConfigurationString(</span><br><span class="line">                    com.android.internal.R.styleable.AndroidManifestData_path, <span class="number">0</span>);</span><br><span class="line">            <span class="keyword">if</span> (str != <span class="keyword">null</span>) &#123;</span><br><span class="line">                outInfo.addDataPath(str, PatternMatcher.PATTERN_LITERAL);</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="comment">// 解析 android:pathPrefix 属性！</span></span><br><span class="line">            str = sa.getNonConfigurationString(</span><br><span class="line">                    com.android.internal.R.styleable.AndroidManifestData_pathPrefix, <span class="number">0</span>);</span><br><span class="line">            <span class="keyword">if</span> (str != <span class="keyword">null</span>) &#123;</span><br><span class="line">                outInfo.addDataPath(str, PatternMatcher.PATTERN_PREFIX);</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="comment">// 解析 android:pathPattern 属性！</span></span><br><span class="line">            str = sa.getNonConfigurationString(</span><br><span class="line">                    com.android.internal.R.styleable.AndroidManifestData_pathPattern, <span class="number">0</span>);</span><br><span class="line">            <span class="keyword">if</span> (str != <span class="keyword">null</span>) &#123;</span><br><span class="line">                <span class="keyword">if</span> (!allowGlobs) &#123;</span><br><span class="line">                    outError[<span class="number">0</span>] = <span class="string">"pathPattern not allowed here; path must be literal"</span>;</span><br><span class="line">                    <span class="keyword">return</span> <span class="keyword">false</span>;</span><br><span class="line">                &#125;</span><br><span class="line">                outInfo.addDataPath(str, PatternMatcher.PATTERN_SIMPLE_GLOB);</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            sa.recycle();</span><br><span class="line">            XmlUtils.skipCurrentTag(parser);</span><br><span class="line">        &#125; <span class="keyword">else</span> <span class="keyword">if</span> (!RIGID_PARSER) &#123;</span><br><span class="line">            Slog.w(TAG, <span class="string">"Unknown element under &lt;intent-filter&gt;: "</span></span><br><span class="line">                    + parser.getName() + <span class="string">" at "</span> + mArchiveSourcePath + <span class="string">" "</span></span><br><span class="line">                    + parser.getPositionDescription());</span><br><span class="line">            XmlUtils.skipCurrentTag(parser);</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            outError[<span class="number">0</span>] = <span class="string">"Bad element under &lt;intent-filter&gt;: "</span> + parser.getName();</span><br><span class="line">            <span class="keyword">return</span> <span class="keyword">false</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    outInfo.hasDefault = outInfo.hasCategory(Intent.CATEGORY_DEFAULT);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (DEBUG_PARSER) &#123;</span><br><span class="line">        <span class="keyword">final</span> StringBuilder cats = <span class="keyword">new</span> StringBuilder(<span class="string">"Intent d="</span>);</span><br><span class="line">        cats.append(outInfo.hasDefault);</span><br><span class="line">        cats.append(<span class="string">", cat="</span>);</span><br><span class="line"></span><br><span class="line">        <span class="keyword">final</span> Iterator&lt;String&gt; it = outInfo.categoriesIterator();</span><br><span class="line">        <span class="keyword">if</span> (it != <span class="keyword">null</span>) &#123;</span><br><span class="line">            <span class="keyword">while</span> (it.hasNext()) &#123;</span><br><span class="line">                cats.append(<span class="string">' '</span>);</span><br><span class="line">                cats.append(it.next());</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        Slog.d(TAG, cats.toString());</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">true</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>对 intent-filter 的解析就到这里！</p>
<h4 id="3-1-1-3-PParser-parseSplitApk-4"><a href="#3-1-1-3-PParser-parseSplitApk-4" class="headerlink" title="3.1.1.3 PParser.parseSplitApk[4]"></a>3.1.1.3 PParser.parseSplitApk[4]</h4><p>核心 apk 解析完成后，会返回一个 Package 对象，传入 parseSplitApk，用于解析非核心 apk：<br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">parseSplitApk</span><span class="params">(Package pkg, <span class="keyword">int</span> splitIndex, AssetManager assets, <span class="keyword">int</span> flags)</span></span></span><br><span class="line"><span class="function">        <span class="keyword">throws</span> PackageParserException </span>&#123;</span><br><span class="line">    <span class="keyword">final</span> String apkPath = pkg.splitCodePaths[splitIndex];</span><br><span class="line"></span><br><span class="line">    mParseError = PackageManager.INSTALL_SUCCEEDED;</span><br><span class="line">    mArchiveSourcePath = apkPath;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (DEBUG_JAR) Slog.d(TAG, <span class="string">"Scanning split APK: "</span> + apkPath);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">final</span> <span class="keyword">int</span> cookie = loadApkIntoAssetManager(assets, apkPath, flags);</span><br><span class="line"></span><br><span class="line">    Resources res = <span class="keyword">null</span>;</span><br><span class="line">    XmlResourceParser parser = <span class="keyword">null</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">        res = <span class="keyword">new</span> Resources(assets, mMetrics, <span class="keyword">null</span>);</span><br><span class="line">        assets.setConfiguration(<span class="number">0</span>, <span class="number">0</span>, <span class="keyword">null</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>,</span><br><span class="line">                Build.VERSION.RESOURCES_SDK_INT);</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 用于解析 AndroidManifest.xml 文件！</span></span><br><span class="line">        parser = assets.openXmlResourceParser(cookie, ANDROID_MANIFEST_FILENAME);</span><br><span class="line"></span><br><span class="line">        <span class="keyword">final</span> String[] outError = <span class="keyword">new</span> String[<span class="number">1</span>];</span><br><span class="line">        </span><br><span class="line">        <span class="comment">//【3.1.1.3.1】解析非核心 apk！</span></span><br><span class="line">        pkg = parseSplitApk(pkg, res, parser, flags, splitIndex, outError);</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (pkg == <span class="keyword">null</span>) &#123;</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> PackageParserException(mParseError,</span><br><span class="line">                    apkPath + <span class="string">" (at "</span> + parser.getPositionDescription() + <span class="string">"): "</span> + outError[<span class="number">0</span>]);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">    &#125; <span class="keyword">catch</span> (PackageParserException e) &#123;</span><br><span class="line">        <span class="keyword">throw</span> e;</span><br><span class="line">    &#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">        <span class="keyword">throw</span> <span class="keyword">new</span> PackageParserException(INSTALL_PARSE_FAILED_UNEXPECTED_EXCEPTION,</span><br><span class="line">                <span class="string">"Failed to read manifest from "</span> + apkPath, e);</span><br><span class="line">    &#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">        IoUtils.closeQuietly(parser);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>这个过程个解析 base apk 一样，我们不多关注！</p>
<h5 id="3-1-1-3-1-PParser-parseSplitApk-5"><a href="#3-1-1-3-1-PParser-parseSplitApk-5" class="headerlink" title="3.1.1.3.1 PParser.parseSplitApk[5]"></a>3.1.1.3.1 PParser.parseSplitApk[5]</h5><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">private</span> Package <span class="title">parseSplitApk</span><span class="params">(Package pkg, Resources res, XmlResourceParser parser, <span class="keyword">int</span> flags,</span></span></span><br><span class="line"><span class="function"><span class="params">        <span class="keyword">int</span> splitIndex, String[] outError)</span> <span class="keyword">throws</span> XmlPullParserException, IOException,</span></span><br><span class="line"><span class="function">        PackageParserException </span>&#123;</span><br><span class="line"></span><br><span class="line">    AttributeSet attrs = parser;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//【3.1.1.1.1.2】解析 package 和 sliptName 属性！</span></span><br><span class="line">    parsePackageSplitNames(parser, attrs);</span><br><span class="line"></span><br><span class="line">    mParseInstrumentationArgs = <span class="keyword">null</span>;</span><br><span class="line">    mParseActivityArgs = <span class="keyword">null</span>;</span><br><span class="line">    mParseServiceArgs = <span class="keyword">null</span>;</span><br><span class="line">    mParseProviderArgs = <span class="keyword">null</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">int</span> type;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">boolean</span> foundApp = <span class="keyword">false</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">int</span> outerDepth = parser.getDepth();</span><br><span class="line">    <span class="keyword">while</span> ((type = parser.next()) != XmlPullParser.END_DOCUMENT</span><br><span class="line">            &amp;&amp; (type != XmlPullParser.END_TAG || parser.getDepth() &gt; outerDepth)) &#123;</span><br><span class="line">        <span class="keyword">if</span> (type == XmlPullParser.END_TAG || type == XmlPullParser.TEXT) &#123;</span><br><span class="line">            <span class="keyword">continue</span>;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        String tagName = parser.getName();</span><br><span class="line">        <span class="keyword">if</span> (tagName.equals(<span class="string">"application"</span>)) &#123; <span class="comment">// 解析非核心 apk 的 "application" 标签！</span></span><br><span class="line">            <span class="keyword">if</span> (foundApp) &#123;</span><br><span class="line">                <span class="keyword">if</span> (RIGID_PARSER) &#123;</span><br><span class="line">                    outError[<span class="number">0</span>] = <span class="string">"&lt;manifest&gt; has more than one &lt;application&gt;"</span>;</span><br><span class="line">                    mParseError = PackageManager.INSTALL_PARSE_FAILED_MANIFEST_MALFORMED;</span><br><span class="line">                    <span class="keyword">return</span> <span class="keyword">null</span>;</span><br><span class="line">                &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                    Slog.w(TAG, <span class="string">"&lt;manifest&gt; has more than one &lt;application&gt;"</span>);</span><br><span class="line">                    XmlUtils.skipCurrentTag(parser);</span><br><span class="line">                    <span class="keyword">continue</span>;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            foundApp = <span class="keyword">true</span>;</span><br><span class="line">            </span><br><span class="line">            <span class="comment">//【3.1.1.3.2】调用 parseSplitApplication 方法继续解析！</span></span><br><span class="line">            <span class="keyword">if</span> (!parseSplitApplication(pkg, res, parser, flags, splitIndex, outError)) &#123;</span><br><span class="line">                <span class="keyword">return</span> <span class="keyword">null</span>;</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">        &#125; <span class="keyword">else</span> <span class="keyword">if</span> (RIGID_PARSER) &#123;</span><br><span class="line">            outError[<span class="number">0</span>] = <span class="string">"Bad element under &lt;manifest&gt;: "</span></span><br><span class="line">                + parser.getName();</span><br><span class="line">            mParseError = PackageManager.INSTALL_PARSE_FAILED_MANIFEST_MALFORMED;</span><br><span class="line">            <span class="keyword">return</span> <span class="keyword">null</span>;</span><br><span class="line"></span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            Slog.w(TAG, <span class="string">"Unknown element under &lt;manifest&gt;: "</span> + parser.getName()</span><br><span class="line">                    + <span class="string">" at "</span> + mArchiveSourcePath + <span class="string">" "</span></span><br><span class="line">                    + parser.getPositionDescription());</span><br><span class="line">            XmlUtils.skipCurrentTag(parser);</span><br><span class="line">            <span class="keyword">continue</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (!foundApp) &#123;</span><br><span class="line">        outError[<span class="number">0</span>] = <span class="string">"&lt;manifest&gt; does not contain an &lt;application&gt;"</span>;</span><br><span class="line">        mParseError = PackageManager.INSTALL_PARSE_FAILED_MANIFEST_EMPTY;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">//【3】返回最终的 Package 对象！</span></span><br><span class="line">    <span class="keyword">return</span> pkg;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>进入 parseSplitApplication 方法！</p>
<h5 id="3-1-1-3-2-PParser-parseSplitApplication"><a href="#3-1-1-3-2-PParser-parseSplitApplication" class="headerlink" title="3.1.1.3.2 PParser.parseSplitApplication"></a>3.1.1.3.2 PParser.parseSplitApplication</h5><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">boolean</span> <span class="title">parseSplitApplication</span><span class="params">(Package owner, Resources res, XmlResourceParser parser,</span></span></span><br><span class="line"><span class="function"><span class="params">        <span class="keyword">int</span> flags, <span class="keyword">int</span> splitIndex, String[] outError)</span></span></span><br><span class="line"><span class="function">        <span class="keyword">throws</span> XmlPullParserException, IOException </span>&#123;</span><br><span class="line">        </span><br><span class="line">    <span class="comment">// 获得 "application" 标签的属性，保存到 TypedArray 对象 sa 中！</span></span><br><span class="line">    TypedArray sa = res.obtainAttributes(parser,</span><br><span class="line">            com.android.internal.R.styleable.AndroidManifestApplication);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (sa.getBoolean(</span><br><span class="line">            com.android.internal.R.styleable.AndroidManifestApplication_hasCode, <span class="keyword">true</span>)) &#123;</span><br><span class="line">        owner.splitFlags[splitIndex] |= ApplicationInfo.FLAG_HAS_CODE;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">final</span> <span class="keyword">int</span> innerDepth = parser.getDepth();</span><br><span class="line">    <span class="keyword">int</span> type;</span><br><span class="line">    <span class="keyword">while</span> ((type = parser.next()) != XmlPullParser.END_DOCUMENT</span><br><span class="line">            &amp;&amp; (type != XmlPullParser.END_TAG || parser.getDepth() &gt; innerDepth)) &#123;</span><br><span class="line">        <span class="keyword">if</span> (type == XmlPullParser.END_TAG || type == XmlPullParser.TEXT) &#123;</span><br><span class="line">            <span class="keyword">continue</span>;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        String tagName = parser.getName();</span><br><span class="line">        <span class="keyword">if</span> (tagName.equals(<span class="string">"activity"</span>)) &#123; <span class="comment">// 解析非核心 apk 的 "activity"</span></span><br><span class="line">        </span><br><span class="line">            <span class="comment">//【1】调用 parseActivity</span></span><br><span class="line">            Activity a = parseActivity(owner, res, parser, flags, outError, <span class="keyword">false</span>,</span><br><span class="line">                    owner.baseHardwareAccelerated);</span><br><span class="line">            <span class="keyword">if</span> (a == <span class="keyword">null</span>) &#123;</span><br><span class="line">                mParseError = PackageManager.INSTALL_PARSE_FAILED_MANIFEST_MALFORMED;</span><br><span class="line">                <span class="keyword">return</span> <span class="keyword">false</span>;</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            owner.activities.add(a);</span><br><span class="line"></span><br><span class="line">        &#125; <span class="keyword">else</span> <span class="keyword">if</span> (tagName.equals(<span class="string">"receiver"</span>)) &#123; <span class="comment">// 解析非核心 apk 的 "receiver"</span></span><br><span class="line">        </span><br><span class="line">            <span class="comment">//【2】调用 parseReceiver</span></span><br><span class="line">            Activity a = parseActivity(owner, res, parser, flags, outError, <span class="keyword">true</span>, <span class="keyword">false</span>);</span><br><span class="line">            <span class="keyword">if</span> (a == <span class="keyword">null</span>) &#123;</span><br><span class="line">                mParseError = PackageManager.INSTALL_PARSE_FAILED_MANIFEST_MALFORMED;</span><br><span class="line">                <span class="keyword">return</span> <span class="keyword">false</span>;</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            owner.receivers.add(a);</span><br><span class="line"></span><br><span class="line">        &#125; <span class="keyword">else</span> <span class="keyword">if</span> (tagName.equals(<span class="string">"service"</span>)) &#123;  <span class="comment">// 解析非核心 apk 的 "service"</span></span><br><span class="line">        </span><br><span class="line">            <span class="comment">//【3】调用 parseService</span></span><br><span class="line">            Service s = parseService(owner, res, parser, flags, outError);</span><br><span class="line">            <span class="keyword">if</span> (s == <span class="keyword">null</span>) &#123;</span><br><span class="line">                mParseError = PackageManager.INSTALL_PARSE_FAILED_MANIFEST_MALFORMED;</span><br><span class="line">                <span class="keyword">return</span> <span class="keyword">false</span>;</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            owner.services.add(s);</span><br><span class="line"></span><br><span class="line">        &#125; <span class="keyword">else</span> <span class="keyword">if</span> (tagName.equals(<span class="string">"provider"</span>)) &#123;  <span class="comment">// 解析非核心 apk 的 "provider"</span></span><br><span class="line">            <span class="comment">//【4】调用 parseProvider</span></span><br><span class="line">            Provider p = parseProvider(owner, res, parser, flags, outError);</span><br><span class="line">            <span class="keyword">if</span> (p == <span class="keyword">null</span>) &#123;</span><br><span class="line">                mParseError = PackageManager.INSTALL_PARSE_FAILED_MANIFEST_MALFORMED;</span><br><span class="line">                <span class="keyword">return</span> <span class="keyword">false</span>;</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            owner.providers.add(p);</span><br><span class="line"></span><br><span class="line">        &#125; <span class="keyword">else</span> <span class="keyword">if</span> (tagName.equals(<span class="string">"activity-alias"</span>)) &#123;  <span class="comment">// 解析非核心 apk 的 "activity-alias"</span></span><br><span class="line">            <span class="comment">//【5】调用 parseActivityAlias</span></span><br><span class="line">            Activity a = parseActivityAlias(owner, res, parser, flags, outError);</span><br><span class="line">            <span class="keyword">if</span> (a == <span class="keyword">null</span>) &#123;</span><br><span class="line">                mParseError = PackageManager.INSTALL_PARSE_FAILED_MANIFEST_MALFORMED;</span><br><span class="line">                <span class="keyword">return</span> <span class="keyword">false</span>;</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            owner.activities.add(a);</span><br><span class="line"></span><br><span class="line">        &#125; <span class="keyword">else</span> <span class="keyword">if</span> (parser.getName().equals(<span class="string">"meta-data"</span>)) &#123;  <span class="comment">// 解析非核心 apk 的 "meta-data"</span></span><br><span class="line">            <span class="comment">//【6】调用 parseMetaData</span></span><br><span class="line">            <span class="keyword">if</span> ((owner.mAppMetaData = parseMetaData(res, parser, owner.mAppMetaData,</span><br><span class="line">                    outError)) == <span class="keyword">null</span>) &#123;</span><br><span class="line">                mParseError = PackageManager.INSTALL_PARSE_FAILED_MANIFEST_MALFORMED;</span><br><span class="line">                <span class="keyword">return</span> <span class="keyword">false</span>;</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">        &#125; <span class="keyword">else</span> <span class="keyword">if</span> (tagName.equals(<span class="string">"uses-library"</span>)) &#123;  <span class="comment">// 解析非核心 apk 的 "uses-library"</span></span><br><span class="line">            sa = res.obtainAttributes(parser,</span><br><span class="line">                    com.android.internal.R.styleable.AndroidManifestUsesLibrary);</span><br><span class="line"></span><br><span class="line">            <span class="comment">// lib 库名称！</span></span><br><span class="line">            String lname = sa.getNonResourceString(</span><br><span class="line">                    com.android.internal.R.styleable.AndroidManifestUsesLibrary_name);</span><br><span class="line">            <span class="comment">// lib 库是否强制被使用！</span></span><br><span class="line">            <span class="keyword">boolean</span> req = sa.getBoolean(</span><br><span class="line">                    com.android.internal.R.styleable.AndroidManifestUsesLibrary_required,</span><br><span class="line">                    <span class="keyword">true</span>);</span><br><span class="line"></span><br><span class="line">            sa.recycle();</span><br><span class="line">            </span><br><span class="line">            <span class="comment">// 将 lib 库信息添加到 usesLibraries 或者 usesOptionalLibraries 中！</span></span><br><span class="line">            <span class="keyword">if</span> (lname != <span class="keyword">null</span>) &#123;</span><br><span class="line">                lname = lname.intern();</span><br><span class="line">                <span class="keyword">if</span> (req) &#123;</span><br><span class="line">                    <span class="comment">// Upgrade to treat as stronger constraint</span></span><br><span class="line">                    owner.usesLibraries = ArrayUtils.add(owner.usesLibraries, lname);</span><br><span class="line">                    owner.usesOptionalLibraries = ArrayUtils.remove(</span><br><span class="line">                            owner.usesOptionalLibraries, lname);</span><br><span class="line">                &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                    <span class="comment">// Ignore if someone already defined as required</span></span><br><span class="line">                    <span class="keyword">if</span> (!ArrayUtils.contains(owner.usesLibraries, lname)) &#123;</span><br><span class="line">                        owner.usesOptionalLibraries = ArrayUtils.add(</span><br><span class="line">                                owner.usesOptionalLibraries, lname);</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            XmlUtils.skipCurrentTag(parser);</span><br><span class="line"></span><br><span class="line">        &#125; <span class="keyword">else</span> <span class="keyword">if</span> (tagName.equals(<span class="string">"uses-package"</span>)) &#123; <span class="comment">// 解析非核心 apk 的 "uses-package"，不处理！</span></span><br><span class="line">            <span class="comment">// Dependencies for app installers; we don't currently try to</span></span><br><span class="line">            <span class="comment">// enforce this.</span></span><br><span class="line">            XmlUtils.skipCurrentTag(parser);</span><br><span class="line"></span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            <span class="keyword">if</span> (!RIGID_PARSER) &#123;</span><br><span class="line">                Slog.w(TAG, <span class="string">"Unknown element under &lt;application&gt;: "</span> + tagName</span><br><span class="line">                        + <span class="string">" at "</span> + mArchiveSourcePath + <span class="string">" "</span></span><br><span class="line">                        + parser.getPositionDescription());</span><br><span class="line">                XmlUtils.skipCurrentTag(parser);</span><br><span class="line">                <span class="keyword">continue</span>;</span><br><span class="line">            &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                outError[<span class="number">0</span>] = <span class="string">"Bad element under &lt;application&gt;: "</span> + tagName;</span><br><span class="line">                mParseError = PackageManager.INSTALL_PARSE_FAILED_MANIFEST_MALFORMED;</span><br><span class="line">                <span class="keyword">return</span> <span class="keyword">false</span>;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">true</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>到这里，应用程序包就已经被解析完了，最终，所有 apk 的数据都会封装到一个 Package 对象中返回！</p>
<h3 id="3-1-2-PParser-parseMonolithicPackage"><a href="#3-1-2-PParser-parseMonolithicPackage" class="headerlink" title="3.1.2 PParser.parseMonolithicPackage"></a>3.1.2 PParser.parseMonolithicPackage</h3><p>对于不支持 apk 拆分的 package，PMS 使用 parseMonolithicPackage 进行解析，典型的不支持拆分的 apk，是 /system/framework/framework-res.apk，下面我们来看看这个方法：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Deprecated</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> Package <span class="title">parseMonolithicPackage</span><span class="params">(File apkFile, <span class="keyword">int</span> flags)</span> <span class="keyword">throws</span> PackageParserException </span>&#123;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">//【3.1.2.1】同样的，先对 apk 进行一次整体解析！</span></span><br><span class="line">    <span class="keyword">final</span> PackageLite lite = parseMonolithicPackageLite(apkFile, flags);</span><br><span class="line">    <span class="keyword">if</span> (mOnlyCoreApps) &#123;</span><br><span class="line">        <span class="keyword">if</span> (!lite.coreApp) &#123;</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> PackageParserException(INSTALL_PARSE_FAILED_MANIFEST_MALFORMED,</span><br><span class="line">                    <span class="string">"Not a coreApp: "</span> + apkFile);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">final</span> AssetManager assets = <span class="keyword">new</span> AssetManager();</span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">        </span><br><span class="line">        <span class="comment">//【3.1.1.2】再次调用 parseBaseApk 进行二次解析！</span></span><br><span class="line">        <span class="keyword">final</span> Package pkg = parseBaseApk(apkFile, assets, flags);</span><br><span class="line">        pkg.setCodePath(apkFile.getAbsolutePath());</span><br><span class="line">        pkg.setUse32bitAbi(lite.use32bitAbi);</span><br><span class="line">        <span class="keyword">return</span> pkg;</span><br><span class="line">    &#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">        IoUtils.closeQuietly(assets);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h4 id="3-1-2-1-PParser-parseMonolithicPackageLite"><a href="#3-1-2-1-PParser-parseMonolithicPackageLite" class="headerlink" title="3.1.2.1 PParser.parseMonolithicPackageLite"></a>3.1.2.1 PParser.parseMonolithicPackageLite</h4><p>继续调用 parseMonolithicPackageLite 方法：<br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">static</span> PackageLite <span class="title">parseMonolithicPackageLite</span><span class="params">(File packageFile, <span class="keyword">int</span> flags)</span></span></span><br><span class="line"><span class="function">        <span class="keyword">throws</span> PackageParserException </span>&#123;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// 同样的，调用 parseApkLite 直接对 apk 进行解析，返回 ApkLite 对象！</span></span><br><span class="line">    <span class="keyword">final</span> ApkLite baseApk = parseApkLite(packageFile, flags);</span><br><span class="line">    <span class="keyword">final</span> String packagePath = packageFile.getAbsolutePath();</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// 创建 PackageLite 对象！</span></span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">new</span> PackageLite(packagePath, baseApk, <span class="keyword">null</span>, <span class="keyword">null</span>, <span class="keyword">null</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>最后，同样的，还是返回一个 PackageParser.Package 对象！</p>
<p>这里就不多说了！</p>
<h3 id="3-1-3-Package"><a href="#3-1-3-Package" class="headerlink" title="3.1.3 Package"></a>3.1.3 Package</h3><p>我们来看看 Pacakge 结构体，他用来分装一个应用程序包的完整信息：<br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">final</span> <span class="keyword">static</span> <span class="class"><span class="keyword">class</span> <span class="title">Package</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> String packageName; <span class="comment">// 应用程序包名</span></span><br><span class="line">    <span class="keyword">public</span> String[] splitNames; <span class="comment">// 非核心 apk 的名称</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> String volumeUuid;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> String codePath; <span class="comment">// 应用程序包的路径</span></span><br><span class="line">    <span class="keyword">public</span> String baseCodePath; <span class="comment">// 核心 apk 的路径</span></span><br><span class="line">    <span class="keyword">public</span> String[] splitCodePaths; <span class="comment">// 非核心 apk 的路径</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">int</span> baseRevisionCode; <span class="comment">// 核心 apk </span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">int</span>[] splitRevisionCodes;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">int</span>[] splitFlags;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">int</span>[] splitPrivateFlags;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">boolean</span> baseHardwareAccelerated;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// For now we only support one application per package.</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">final</span> ApplicationInfo applicationInfo = <span class="keyword">new</span> ApplicationInfo(); <span class="comment">// 核心 apk 的 application 对象！</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">final</span> ArrayList&lt;Permission&gt; permissions = <span class="keyword">new</span> ArrayList&lt;Permission&gt;(<span class="number">0</span>);</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">final</span> ArrayList&lt;PermissionGroup&gt; permissionGroups = <span class="keyword">new</span> ArrayList&lt;PermissionGroup&gt;(<span class="number">0</span>);</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">final</span> ArrayList&lt;Activity&gt; activities = <span class="keyword">new</span> ArrayList&lt;Activity&gt;(<span class="number">0</span>);</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">final</span> ArrayList&lt;Activity&gt; receivers = <span class="keyword">new</span> ArrayList&lt;Activity&gt;(<span class="number">0</span>);</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">final</span> ArrayList&lt;Provider&gt; providers = <span class="keyword">new</span> ArrayList&lt;Provider&gt;(<span class="number">0</span>);</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">final</span> ArrayList&lt;Service&gt; services = <span class="keyword">new</span> ArrayList&lt;Service&gt;(<span class="number">0</span>);</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">final</span> ArrayList&lt;Instrumentation&gt; instrumentation = <span class="keyword">new</span> ArrayList&lt;Instrumentation&gt;(<span class="number">0</span>);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">final</span> ArrayList&lt;String&gt; requestedPermissions = <span class="keyword">new</span> ArrayList&lt;String&gt;();</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> ArrayList&lt;String&gt; protectedBroadcasts;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> Package parentPackage;</span><br><span class="line">    <span class="keyword">public</span> ArrayList&lt;Package&gt; childPackages;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> ArrayList&lt;String&gt; libraryNames = <span class="keyword">null</span>;</span><br><span class="line">    <span class="keyword">public</span> ArrayList&lt;String&gt; usesLibraries = <span class="keyword">null</span>;</span><br><span class="line">    <span class="keyword">public</span> ArrayList&lt;String&gt; usesOptionalLibraries = <span class="keyword">null</span>;</span><br><span class="line">    <span class="keyword">public</span> String[] usesLibraryFiles = <span class="keyword">null</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> ArrayList&lt;ActivityIntentInfo&gt; preferredActivityFilters = <span class="keyword">null</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> ArrayList&lt;String&gt; mOriginalPackages = <span class="keyword">null</span>;</span><br><span class="line">    <span class="keyword">public</span> String mRealPackage = <span class="keyword">null</span>;</span><br><span class="line">    <span class="keyword">public</span> ArrayList&lt;String&gt; mAdoptPermissions = <span class="keyword">null</span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// We store the application meta-data independently to avoid multiple unwanted references</span></span><br><span class="line">    <span class="keyword">public</span> Bundle mAppMetaData = <span class="keyword">null</span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// The version code declared for this package.</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">int</span> mVersionCode;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// The version name declared for this package.</span></span><br><span class="line">    <span class="keyword">public</span> String mVersionName;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// The shared user id that this package wants to use.</span></span><br><span class="line">    <span class="keyword">public</span> String mSharedUserId;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// The shared user label that this package wants to use.</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">int</span> mSharedUserLabel;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// Signatures that were read from the package.</span></span><br><span class="line">    <span class="keyword">public</span> Signature[] mSignatures;</span><br><span class="line">    <span class="keyword">public</span> Certificate[][] mCertificates;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// For use by package manager service for quick lookup of</span></span><br><span class="line">    <span class="comment">// preferred up order.</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">int</span> mPreferredOrder = <span class="number">0</span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// For use by package manager to keep track of when a package was last used.</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">long</span>[] mLastPackageUsageTimeInMills =</span><br><span class="line">            <span class="keyword">new</span> <span class="keyword">long</span>[PackageManager.NOTIFY_PACKAGE_USE_REASONS_COUNT];</span><br><span class="line"></span><br><span class="line">    <span class="comment">// // User set enabled state.</span></span><br><span class="line">    <span class="comment">// public int mSetEnabled = PackageManager.COMPONENT_ENABLED_STATE_DEFAULT;</span></span><br><span class="line">    <span class="comment">//</span></span><br><span class="line">    <span class="comment">// // Whether the package has been stopped.</span></span><br><span class="line">    <span class="comment">// public boolean mSetStopped = false;</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">// Additional data supplied by callers.</span></span><br><span class="line">    <span class="keyword">public</span> Object mExtras;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// Applications hardware preferences</span></span><br><span class="line">    <span class="keyword">public</span> ArrayList&lt;ConfigurationInfo&gt; configPreferences = <span class="keyword">null</span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// Applications requested features</span></span><br><span class="line">    <span class="keyword">public</span> ArrayList&lt;FeatureInfo&gt; reqFeatures = <span class="keyword">null</span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// Applications requested feature groups</span></span><br><span class="line">    <span class="keyword">public</span> ArrayList&lt;FeatureGroupInfo&gt; featureGroups = <span class="keyword">null</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">int</span> installLocation;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">boolean</span> coreApp;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/* An app that's required for all users and cannot be uninstalled for a user */</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">boolean</span> mRequiredForAllUsers;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/* The restricted account authenticator type that is used by this application */</span></span><br><span class="line">    <span class="keyword">public</span> String mRestrictedAccountType;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/* The required account type without which this application will not function */</span></span><br><span class="line">    <span class="keyword">public</span> String mRequiredAccountType;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> String mOverlayTarget;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">int</span> mOverlayPriority;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">boolean</span> mTrustedOverlay;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> ArraySet&lt;PublicKey&gt; mSigningKeys;</span><br><span class="line">    <span class="keyword">public</span> ArraySet&lt;String&gt; mUpgradeKeySets;</span><br><span class="line">    <span class="keyword">public</span> ArrayMap&lt;String, ArraySet&lt;PublicKey&gt;&gt; mKeySetMapping;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> String cpuAbiOverride;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">boolean</span> use32bitAbi;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">byte</span>[] restrictUpdateHash;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="title">Package</span><span class="params">(String packageName)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">this</span>.packageName = packageName;</span><br><span class="line">        applicationInfo.packageName = packageName;</span><br><span class="line">        applicationInfo.uid = -<span class="number">1</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    ... ... ... ...</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>通过 PParser.parsePackage 方法，最终会返回一个 Package 对象，封装了应用程序包的所有信息！！</p>
<h2 id="3-2-PMS-scanPackageLI"><a href="#3-2-PMS-scanPackageLI" class="headerlink" title="3.2 PMS.scanPackageLI"></a>3.2 PMS.scanPackageLI</h2><p>参数 policyFlags 为 paraseFlags！</p>
<p>前一个阶段，通过解析获得了 package 的信息，接着继续扫描：<br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">private</span> PackageParser.<span class="function">Package <span class="title">scanPackageLI</span><span class="params">(PackageParser.Package pkg, File scanFile,</span></span></span><br><span class="line"><span class="function"><span class="params">        <span class="keyword">final</span> <span class="keyword">int</span> policyFlags, <span class="keyword">int</span> scanFlags, <span class="keyword">long</span> currentTime, UserHandle user)</span></span></span><br><span class="line"><span class="function">        <span class="keyword">throws</span> PackageManagerException </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//【1】SCAN_CHECK_ONLY 标签是为了检测是否所有的包（parent 和 child）都可以被成功的扫描到！</span></span><br><span class="line">    <span class="keyword">if</span> ((scanFlags &amp; SCAN_CHECK_ONLY) == <span class="number">0</span>) &#123; </span><br><span class="line">        <span class="keyword">if</span> (pkg.childPackages != <span class="keyword">null</span> &amp;&amp; pkg.childPackages.size() &gt; <span class="number">0</span>) &#123;</span><br><span class="line">            scanFlags |= SCAN_CHECK_ONLY;  <span class="comment">// 设置 SCAN_CHECK_ONLY 位！</span></span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        scanFlags &amp;= ~SCAN_CHECK_ONLY; <span class="comment">// 取消 SCAN_CHECK_ONLY 位！</span></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//【3.2.1】继续扫描当前 package，返回扫描结果 scannedPkg！</span></span><br><span class="line">    PackageParser.Package scannedPkg = scanPackageInternalLI(pkg, scanFile, policyFlags,</span><br><span class="line">            scanFlags, currentTime, user);</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 扫描当前 package 的子 pacakge（如果有）</span></span><br><span class="line">    <span class="keyword">final</span> <span class="keyword">int</span> childCount = (pkg.childPackages != <span class="keyword">null</span>) ? pkg.childPackages.size() : <span class="number">0</span>;</span><br><span class="line">    <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; childCount; i++) &#123;</span><br><span class="line">        PackageParser.Package childPackage = pkg.childPackages.get(i);</span><br><span class="line">        <span class="comment">// 解析子包！</span></span><br><span class="line">        scanPackageInternalLI(childPackage, scanFile, policyFlags, scanFlags,</span><br><span class="line">                currentTime, user);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> ((scanFlags &amp; SCAN_CHECK_ONLY) != <span class="number">0</span>) &#123;</span><br><span class="line">        <span class="comment">// 如果设置了 SCAN_CHECK_ONLY 位， 就调用自身，再次处理！</span></span><br><span class="line">        <span class="keyword">return</span> scanPackageLI(pkg, scanFile, policyFlags, scanFlags, currentTime, user);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> scannedPkg;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>如果被扫描的 package 有 child package，并且是第一次进入该方法的话，就需要检测是否所有的包（parent 和 child）都可以被成功的扫描到，scanFlags 本来是没有 SCAN_CHECK_ONLY 位的，所以这里会将其 SCAN_CHECK_ONLY 置为 1，这样在方法的最后，又会调用自身，这次又会将 SCAN_CHECK_ONLY 位置为 0！</p>
<p>继续看：</p>
<h3 id="3-2-1-PMS-scanPackageInternalLI"><a href="#3-2-1-PMS-scanPackageInternalLI" class="headerlink" title="3.2.1 PMS.scanPackageInternalLI"></a>3.2.1 PMS.scanPackageInternalLI</h3><p>我们继续来看，通过前面的扫描解析，我们获得了应用程序的 PackageParser.Package 对象，同时，我们也已经获得了上一次的安装信息，接下来，就是要处理解析获得的数据：<br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br><span class="line">212</span><br><span class="line">213</span><br><span class="line">214</span><br><span class="line">215</span><br><span class="line">216</span><br><span class="line">217</span><br><span class="line">218</span><br><span class="line">219</span><br><span class="line">220</span><br><span class="line">221</span><br><span class="line">222</span><br><span class="line">223</span><br><span class="line">224</span><br><span class="line">225</span><br><span class="line">226</span><br><span class="line">227</span><br><span class="line">228</span><br><span class="line">229</span><br><span class="line">230</span><br><span class="line">231</span><br><span class="line">232</span><br><span class="line">233</span><br><span class="line">234</span><br><span class="line">235</span><br><span class="line">236</span><br><span class="line">237</span><br><span class="line">238</span><br><span class="line">239</span><br><span class="line">240</span><br><span class="line">241</span><br><span class="line">242</span><br><span class="line">243</span><br><span class="line">244</span><br><span class="line">245</span><br><span class="line">246</span><br><span class="line">247</span><br><span class="line">248</span><br><span class="line">249</span><br><span class="line">250</span><br><span class="line">251</span><br><span class="line">252</span><br><span class="line">253</span><br><span class="line">254</span><br><span class="line">255</span><br><span class="line">256</span><br><span class="line">257</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">private</span> PackageParser.<span class="function">Package <span class="title">scanPackageInternalLI</span><span class="params">(PackageParser.Package pkg, File scanFile,</span></span></span><br><span class="line"><span class="function"><span class="params">        <span class="keyword">int</span> policyFlags, <span class="keyword">int</span> scanFlags, <span class="keyword">long</span> currentTime, UserHandle user)</span></span></span><br><span class="line"><span class="function">        <span class="keyword">throws</span> PackageManagerException </span>&#123;</span><br><span class="line"></span><br><span class="line">    PackageSetting ps = <span class="keyword">null</span>;</span><br><span class="line">    PackageSetting updatedPkg;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">synchronized</span> (mPackages) &#123;</span><br><span class="line">        <span class="comment">// package 是否被重命名过，有的话，获得其 oldName！</span></span><br><span class="line">        String oldName = mSettings.mRenamedPackages.get(pkg.packageName);</span><br><span class="line">        </span><br><span class="line">        <span class="comment">//【3.2.1.1】如果 package 有源包，并且源包的名字是当前扫描的 package 的旧名字，</span></span><br><span class="line">        <span class="comment">// 那就用源包的 PackageSetting 作为当前 package 的数据！</span></span><br><span class="line">        <span class="keyword">if</span> (pkg.mOriginalPackages != <span class="keyword">null</span> &amp;&amp; pkg.mOriginalPackages.contains(oldName)) &#123;</span><br><span class="line">            ps = mSettings.peekPackageLPr(oldName);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 如果没有源包，就用当前 package 的包名查找一个已的 PackageSetting！</span></span><br><span class="line">        <span class="keyword">if</span> (ps == <span class="keyword">null</span>) &#123;</span><br><span class="line">            ps = mSettings.peekPackageLPr(pkg.packageName);</span><br><span class="line">        &#125;</span><br><span class="line">    </span><br><span class="line">        <span class="comment">//【3.2.1.2】如果当前系统 package 被更新过，就查找到被更新之前的 PackageSetting！</span></span><br><span class="line">        updatedPkg = mSettings.getDisabledSystemPkgLPr(ps != <span class="keyword">null</span> ? ps.name : pkg.packageName);</span><br><span class="line">        <span class="keyword">if</span> (DEBUG_INSTALL &amp;&amp; updatedPkg != <span class="keyword">null</span>) Slog.d(TAG, <span class="string">"updatedPkg = "</span> + updatedPkg);</span><br><span class="line">        </span><br><span class="line">        <span class="comment">// 如果系统 package，并且被更新过，需要处理新旧 child package 的差异！</span></span><br><span class="line">        <span class="comment">// 比较更新后的 child package 和更新前的 child package，如果更新前的 child package 不存在了；</span></span><br><span class="line">        <span class="comment">// 就要移除！</span></span><br><span class="line">        <span class="keyword">if</span> ((policyFlags &amp; PackageParser.PARSE_IS_SYSTEM) != <span class="number">0</span>) &#123; </span><br><span class="line">            PackageSetting disabledPs = mSettings.getDisabledSystemPkgLPr(pkg.packageName);</span><br><span class="line">            <span class="keyword">if</span> (disabledPs != <span class="keyword">null</span>) &#123;</span><br><span class="line">                <span class="comment">// 当前 package 的 child package 个数！</span></span><br><span class="line">                <span class="keyword">final</span> <span class="keyword">int</span> scannedChildCount = (pkg.childPackages != <span class="keyword">null</span>)</span><br><span class="line">                        ? pkg.childPackages.size() : <span class="number">0</span>;</span><br><span class="line">                <span class="comment">// 更新之前的 child package 个数！</span></span><br><span class="line">                <span class="keyword">final</span> <span class="keyword">int</span> disabledChildCount = disabledPs.childPackageNames != <span class="keyword">null</span></span><br><span class="line">                        ? disabledPs.childPackageNames.size() : <span class="number">0</span>;</span><br><span class="line"></span><br><span class="line">                <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; disabledChildCount; i++) &#123;</span><br><span class="line">                    String disabledChildPackageName = disabledPs.childPackageNames.get(i);</span><br><span class="line">                    <span class="keyword">boolean</span> disabledPackageAvailable = <span class="keyword">false</span>;</span><br><span class="line">                    </span><br><span class="line">                    <span class="keyword">for</span> (<span class="keyword">int</span> j = <span class="number">0</span>; j &lt; scannedChildCount; j++) &#123;</span><br><span class="line">                        PackageParser.Package childPkg = pkg.childPackages.get(j);</span><br><span class="line">                        <span class="keyword">if</span> (childPkg.packageName.equals(disabledChildPackageName)) &#123;</span><br><span class="line">                        </span><br><span class="line">                            disabledPackageAvailable = <span class="keyword">true</span>;</span><br><span class="line">                            <span class="keyword">break</span>;</span><br><span class="line">                        &#125;</span><br><span class="line">                     &#125;</span><br><span class="line">    </span><br><span class="line">                     <span class="keyword">if</span> (!disabledPackageAvailable) &#123;</span><br><span class="line">                         <span class="comment">//【3.2.1.3】更新前的 child package，不包含在更新后的 child package 中，无效，</span></span><br><span class="line">                         <span class="comment">// 就从 mDisabledSysPackages 中删除掉！</span></span><br><span class="line">                         mSettings.removeDisabledSystemPackageLPw(disabledChildPackageName);</span><br><span class="line">                     &#125;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">boolean</span> updatedPkgBetter = <span class="keyword">false</span>; </span><br><span class="line"></span><br><span class="line">    <span class="comment">//【A】处理覆盖更新的情况！</span></span><br><span class="line">    <span class="comment">// 如果当前解析的系统 apk，并且他之前被覆盖更新过！</span></span><br><span class="line">    <span class="comment">// 注意：ps 是上次安装的信息，updatedPkg 是由于覆盖安装更新前的信息！，pkg 则是本次扫描的 system app 的信息！</span></span><br><span class="line">    <span class="keyword">if</span> (updatedPkg != <span class="keyword">null</span> &amp;&amp; (policyFlags &amp; PackageParser.PARSE_IS_SYSTEM) != <span class="number">0</span>) &#123;</span><br><span class="line">        <span class="keyword">if</span> (locationIsPrivileged(scanFile)) &#123; </span><br><span class="line">            <span class="comment">// 对于 /system/priv-app 目录下的 app，需要增加 ApplicationInfo.PRIVATE_FLAG_PRIVILEGED 的 flag！</span></span><br><span class="line">            updatedPkg.pkgPrivateFlags |= ApplicationInfo.PRIVATE_FLAG_PRIVILEGED;</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            updatedPkg.pkgPrivateFlags &amp;= ~ApplicationInfo.PRIVATE_FLAG_PRIVILEGED;</span><br><span class="line">        &#125;</span><br><span class="line">        </span><br><span class="line">        <span class="comment">// 上次更新后的应用路径和这次扫描解析的路径不一样，上次更新到了 data 分区，而这次扫描的是 system 分区，</span></span><br><span class="line">        <span class="comment">// 就需要比较一下 versionCode 的大小，</span></span><br><span class="line">        <span class="keyword">if</span> (ps != <span class="keyword">null</span> &amp;&amp; !ps.codePath.equals(scanFile)) &#123;</span><br><span class="line">            <span class="keyword">if</span> (DEBUG_INSTALL) Slog.d(TAG, <span class="string">"Path changing from "</span> + ps.codePath);</span><br><span class="line">            <span class="comment">// pkg 的 versioncode 小于等于上次更新后的 versioncode，说明 data 分区的 apk 仍然是最新的</span></span><br><span class="line">            <span class="comment">// 那就用本次扫描解析的数据，来更新上次更新前的旧数据！</span></span><br><span class="line">            <span class="keyword">if</span> (pkg.mVersionCode &lt;= ps.versionCode) &#123;</span><br><span class="line"></span><br><span class="line">                <span class="keyword">if</span> (DEBUG_INSTALL) Slog.i(TAG, <span class="string">"Package "</span> + ps.name + <span class="string">" at "</span> + scanFile</span><br><span class="line">                        + <span class="string">" ignored: updated version "</span> + ps.versionCode</span><br><span class="line">                        + <span class="string">" better than this "</span> + pkg.mVersionCode);</span><br><span class="line"></span><br><span class="line">                <span class="comment">// updatedPkg.codePath 不等于当前的扫描目录，说明该 system app 目录发生了变化！</span></span><br><span class="line">                <span class="comment">// 而该 system apk 是被覆盖更新了，所以也需要更新 updatedPkg 的数据～</span></span><br><span class="line">                <span class="keyword">if</span> (!updatedPkg.codePath.equals(scanFile)) &#123;</span><br><span class="line">                    Slog.w(PackageManagerService.TAG, <span class="string">"Code path for hidden system pkg "</span></span><br><span class="line">                            + ps.name + <span class="string">" changing from "</span> + updatedPkg.codePathString</span><br><span class="line">                            + <span class="string">" to "</span> + scanFile);</span><br><span class="line"></span><br><span class="line">                    updatedPkg.codePath = scanFile;</span><br><span class="line">                    updatedPkg.codePathString = scanFile.toString();</span><br><span class="line">                    updatedPkg.resourcePath = scanFile;</span><br><span class="line">                    updatedPkg.resourcePathString = scanFile.toString();</span><br><span class="line">                &#125;</span><br><span class="line">                </span><br><span class="line">                updatedPkg.pkg = pkg;</span><br><span class="line">                updatedPkg.versionCode = pkg.mVersionCode;</span><br><span class="line"></span><br><span class="line">                <span class="keyword">final</span> <span class="keyword">int</span> childCount = updatedPkg.childPackageNames != <span class="keyword">null</span></span><br><span class="line">                        ? updatedPkg.childPackageNames.size() : <span class="number">0</span>;</span><br><span class="line"></span><br><span class="line">                <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; childCount; i++) &#123;</span><br><span class="line">                    String childPackageName = updatedPkg.childPackageNames.get(i);</span><br><span class="line">                    PackageSetting updatedChildPkg = mSettings.getDisabledSystemPkgLPr(</span><br><span class="line">                            childPackageName);</span><br><span class="line"></span><br><span class="line">                    <span class="keyword">if</span> (updatedChildPkg != <span class="keyword">null</span>) &#123;</span><br><span class="line">                        updatedChildPkg.pkg = pkg;</span><br><span class="line">                        updatedChildPkg.versionCode = pkg.mVersionCode;</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;</span><br><span class="line"></span><br><span class="line">                <span class="keyword">throw</span> <span class="keyword">new</span> PackageManagerException(Log.WARN, <span class="string">"Package "</span> + ps.name + <span class="string">" at "</span></span><br><span class="line">                        + scanFile + <span class="string">" ignored: updated version "</span> + ps.versionCode</span><br><span class="line">                        + <span class="string">" better than this "</span> + pkg.mVersionCode);</span><br><span class="line">            &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                <span class="comment">// pkg 的 versioncode 大于上次更新后的 versioncode，</span></span><br><span class="line">                <span class="comment">// 说明当前在 system 分区的 apk 要比 data 分区的新，这说明 system app 又通过 OTA 升级更新了</span></span><br><span class="line">                <span class="comment">// 那就要保留本次扫描解析的数据，删除上一次更新的数据！</span></span><br><span class="line">                <span class="keyword">synchronized</span> (mPackages) &#123;</span><br><span class="line">                    <span class="comment">// 从 PMS.mPackages 中删除上一次的扫描数据！</span></span><br><span class="line">                    mPackages.remove(ps.name);</span><br><span class="line">                &#125;</span><br><span class="line"></span><br><span class="line">                logCriticalInfo(Log.WARN, <span class="string">"Package "</span> + ps.name + <span class="string">" at "</span> + scanFile</span><br><span class="line">                        + <span class="string">" reverting from "</span> + ps.codePathString</span><br><span class="line">                        + <span class="string">": new version "</span> + pkg.mVersionCode</span><br><span class="line">                        + <span class="string">" better than installed "</span> + ps.versionCode);</span><br><span class="line">                </span><br><span class="line">                <span class="comment">// 创建一个安装参数对象，封装了上次安装的信息！！</span></span><br><span class="line">                InstallArgs args = createInstallArgsForExisting(packageFlagsToInstallFlags(ps),</span><br><span class="line">                        ps.codePathString, ps.resourcePathString, getAppDexInstructionSets(ps));</span><br><span class="line"></span><br><span class="line">                <span class="keyword">synchronized</span> (mInstallLock) &#123;</span><br><span class="line">                    <span class="comment">// 移除 data 分区的 apk 和 相应的 dex 文件！</span></span><br><span class="line">                    args.cleanUpResourcesLI();</span><br><span class="line">                &#125;</span><br><span class="line">                </span><br><span class="line">                <span class="keyword">synchronized</span> (mPackages) &#123;</span><br><span class="line">                    <span class="comment">//【3.2.1.4】将更新前的旧数据 PackageSetting ，从 mDisabledSysPackages 中移除，</span></span><br><span class="line">                    <span class="comment">// 并复用旧数据，创建一个新的PackageSetting，添加到 Setting 的 mPackage 中！</span></span><br><span class="line">                    mSettings.enableSystemPackageLPw(ps.name);</span><br><span class="line">                &#125;</span><br><span class="line">                </span><br><span class="line">                updatedPkgBetter = <span class="keyword">true</span>; <span class="comment">// 设置 updatedPkgBetter 为 true！</span></span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (updatedPkg != <span class="keyword">null</span>) &#123; <span class="comment">// 对于被更新的系统 app 的 flag 进行设置！</span></span><br><span class="line">        policyFlags |= PackageParser.PARSE_IS_SYSTEM;</span><br><span class="line">        <span class="keyword">if</span> ((updatedPkg.pkgPrivateFlags &amp; ApplicationInfo.PRIVATE_FLAG_PRIVILEGED) != <span class="number">0</span>) &#123;</span><br><span class="line">            policyFlags |= PackageParser.PARSE_IS_PRIVILEGED;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    collectCertificatesLI(ps, pkg, scanFile, policyFlags);</span><br><span class="line"></span><br><span class="line">    <span class="comment">//【B】处理没有覆盖，但是 data 和 system 分区出现了相同的 apk 的情况！</span></span><br><span class="line">    <span class="comment">// package 并没有发生覆盖更新，但之前 apk 是安装在 data 分区，而后来出现了相同包名的新 apk 安装在了 system 分区</span></span><br><span class="line">    <span class="comment">//（比如系统 OTA 升级导致的 apk 分区改变，或者 root 后 push 一个相同 apk 到 system 分区然后重启）！</span></span><br><span class="line">    <span class="comment">// 或者还有一种是之前安装在 data 分区，然后应用移动到了 system 分区！</span></span><br><span class="line">    <span class="comment">// 那就要判断是否隐藏 system 分区的这个 apk 了！</span></span><br><span class="line">    <span class="keyword">boolean</span> shouldHideSystemApp = <span class="keyword">false</span>; </span><br><span class="line">    <span class="keyword">if</span> (updatedPkg == <span class="keyword">null</span> &amp;&amp; ps != <span class="keyword">null</span></span><br><span class="line">            &amp;&amp; (policyFlags &amp; PackageParser.PARSE_IS_SYSTEM_DIR) != <span class="number">0</span> &amp;&amp; !isSystemApp(ps)) &#123;</span><br><span class="line">        <span class="comment">// 校验签名，如果不匹配的话，就冻结掉安装在 system 分区的 apk，并清除数据！</span></span><br><span class="line">        <span class="keyword">if</span> (compareSignatures(ps.signatures.mSignatures, pkg.mSignatures)</span><br><span class="line">                != PackageManager.SIGNATURE_MATCH) &#123;</span><br><span class="line">                </span><br><span class="line">            logCriticalInfo(Log.WARN, <span class="string">"Package "</span> + ps.name + <span class="string">" appeared on system, but"</span></span><br><span class="line">                    + <span class="string">" signatures don't match existing userdata copy; removing"</span>);</span><br><span class="line">            </span><br><span class="line">            <span class="comment">// 创建一个 PackageFreezer 用来冻结指定的 package！</span></span><br><span class="line">            <span class="keyword">try</span> (PackageFreezer freezer = freezePackage(pkg.packageName,</span><br><span class="line">                    <span class="string">"scanPackageInternalLI"</span>)) &#123;</span><br><span class="line">                deletePackageLIF(pkg.packageName, <span class="keyword">null</span>, <span class="keyword">true</span>, <span class="keyword">null</span>, <span class="number">0</span>, <span class="keyword">null</span>, <span class="keyword">false</span>, <span class="keyword">null</span>);</span><br><span class="line">            &#125;</span><br><span class="line">            ps = <span class="keyword">null</span>;</span><br><span class="line"></span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            <span class="comment">// 如果新添加的位于 system 分区的 apk 的版本号小于等于位于 data 分区的 apk；</span></span><br><span class="line">            <span class="comment">// 那就要隐藏 system 分区的 apk；</span></span><br><span class="line">            <span class="keyword">if</span> (pkg.mVersionCode &lt;= ps.versionCode) &#123;</span><br><span class="line">                shouldHideSystemApp = <span class="keyword">true</span>; <span class="comment">// 设置 shouldHideSystemApp 为 true！</span></span><br><span class="line">                logCriticalInfo(Log.INFO, <span class="string">"Package "</span> + ps.name + <span class="string">" appeared at "</span> + scanFile</span><br><span class="line">                        + <span class="string">" but new version "</span> + pkg.mVersionCode + <span class="string">" better than installed "</span></span><br><span class="line">                        + ps.versionCode + <span class="string">"; hiding system"</span>);</span><br><span class="line">            &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                <span class="comment">// system 分区的应用版本更高，删除 data 分区的 apk，同时保留数据！</span></span><br><span class="line">                logCriticalInfo(Log.WARN, <span class="string">"Package "</span> + ps.name + <span class="string">" at "</span> + scanFile</span><br><span class="line">                        + <span class="string">" reverting from "</span> + ps.codePathString + <span class="string">": new version "</span></span><br><span class="line">                        + pkg.mVersionCode + <span class="string">" better than installed "</span> + ps.versionCode);</span><br><span class="line">                        </span><br><span class="line">                <span class="comment">// 创建一个安装参数！        </span></span><br><span class="line">                InstallArgs args = createInstallArgsForExisting(packageFlagsToInstallFlags(ps),</span><br><span class="line">                        ps.codePathString, ps.resourcePathString, getAppDexInstructionSets(ps));</span><br><span class="line">                        </span><br><span class="line">                <span class="keyword">synchronized</span> (mInstallLock) &#123;</span><br><span class="line">                    <span class="comment">// 删除 data 分区的 apk，并保留用户数据！</span></span><br><span class="line">                    args.cleanUpResourcesLI();</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 系统 apk 不进入！</span></span><br><span class="line">    <span class="keyword">if</span> ((policyFlags &amp; PackageParser.PARSE_IS_SYSTEM_DIR) == <span class="number">0</span>) &#123;</span><br><span class="line">        <span class="keyword">if</span> (ps != <span class="keyword">null</span> &amp;&amp; !ps.codePath.equals(ps.resourcePath)) &#123;</span><br><span class="line">            policyFlags |= PackageParser.PARSE_FORWARD_LOCK;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    String resourcePath = <span class="keyword">null</span>;</span><br><span class="line">    String baseResourcePath = <span class="keyword">null</span>;</span><br><span class="line">    <span class="keyword">if</span> ((policyFlags &amp; PackageParser.PARSE_FORWARD_LOCK) != <span class="number">0</span> &amp;&amp; !updatedPkgBetter) &#123;</span><br><span class="line">        <span class="keyword">if</span> (ps != <span class="keyword">null</span> &amp;&amp; ps.resourcePathString != <span class="keyword">null</span>) &#123;</span><br><span class="line">            resourcePath = ps.resourcePathString;</span><br><span class="line">            baseResourcePath = ps.resourcePathString;</span><br><span class="line"></span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            Slog.e(TAG, <span class="string">"Resource path not set for package "</span> + pkg.packageName);</span><br><span class="line"></span><br><span class="line">        &#125;</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        resourcePath = pkg.codePath;</span><br><span class="line">        baseResourcePath = pkg.baseCodePath;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 设置 Package.ApplicationInfo 对象的 path 属性！</span></span><br><span class="line">    pkg.setApplicationVolumeUuid(pkg.volumeUuid);</span><br><span class="line">    pkg.setApplicationInfoCodePath(pkg.codePath);</span><br><span class="line">    pkg.setApplicationInfoBaseCodePath(pkg.baseCodePath);</span><br><span class="line">    pkg.setApplicationInfoSplitCodePaths(pkg.splitCodePaths);</span><br><span class="line">    pkg.setApplicationInfoResourcePath(resourcePath);</span><br><span class="line">    pkg.setApplicationInfoBaseResourcePath(baseResourcePath);</span><br><span class="line">    pkg.setApplicationInfoSplitResourcePaths(pkg.splitCodePaths);</span><br><span class="line"></span><br><span class="line">    <span class="comment">//【3.2.1.7】接着调用 scanPackageLI，继续处理扫描数据！</span></span><br><span class="line">    PackageParser.Package scannedPkg = scanPackageLI(pkg, policyFlags, scanFlags</span><br><span class="line">            | SCAN_UPDATE_SIGNATURE, currentTime, user);</span><br><span class="line"></span><br><span class="line">    <span class="comment">//【3.2.1.8】如果确认 data 分区的 apk 版本比 system 分区的版本高</span></span><br><span class="line">    <span class="comment">// 就隐藏 system 分区的 app，让 data 分区的 apk 显示出来！</span></span><br><span class="line">    <span class="keyword">if</span> (shouldHideSystemApp) &#123;</span><br><span class="line">        <span class="keyword">synchronized</span> (mPackages) &#123;</span><br><span class="line">            mSettings.disableSystemPackageLPw(pkg.packageName, <span class="keyword">true</span>);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> scannedPkg;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>到这里，我们先来总结一下，对于一个系统 app 而言， app 升级有如下两种途径：</p>
<ul>
<li>覆盖安装：这种方式 PMS 会动态修改 packages.xml 文件！</li>
<li>OTA 升级方式：这种方式并不会动态修改 package.xml 文件！</li>
</ul>
<p>下面我们来分开分析一下：</p>
<ul>
<li>覆盖安装<ul>
<li>对于系统 app，覆盖安装的话，新的 app 会安装到 data 分区，packages.xml 中相应数据会发生如下变化：<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"> <span class="tag">&lt;<span class="name">package</span> <span class="attr">name</span>=<span class="string">"com.android.pic"</span> <span class="attr">codePath</span>=<span class="string">"/data/app/com.android.pic-1"</span> <span class="attr">nativeLibraryPath</span>=<span class="string">"/data/app/com.android.pic-1/lib"</span></span></span><br><span class="line"><span class="tag">          <span class="attr">primaryCpuAbi</span>=<span class="string">"arm64-v8a"</span> <span class="attr">publicFlags</span>=<span class="string">"944258757"</span> <span class="attr">privateFlags</span>=<span class="string">"0"</span> <span class="attr">ft</span>=<span class="string">"15c38695c40"</span> <span class="attr">it</span>=<span class="string">"15baf6278f0"</span> </span></span><br><span class="line"><span class="tag">          <span class="attr">ut</span>=<span class="string">"15c38695e98"</span> <span class="attr">version</span>=<span class="string">"3002"</span> <span class="attr">sharedUserId</span>=<span class="string">"1000"</span> <span class="attr">installer</span>=<span class="string">"com.android.packageinstaller"</span> <span class="attr">isOrphaned</span>=<span class="string">"true"</span>&gt;</span></span><br><span class="line"> <span class="tag">&lt;/<span class="name">package</span>&gt;</span></span><br><span class="line">        </span><br><span class="line"><span class="tag">&lt;<span class="name">updated-package</span> <span class="attr">name</span>=<span class="string">"com.android.pic"</span> <span class="attr">codePath</span>=<span class="string">"/system/app/pic"</span> </span></span><br><span class="line"><span class="tag">          <span class="attr">ft</span>=<span class="string">"15baf6278f0"</span> <span class="attr">it</span>=<span class="string">"15baf6278f0"</span> <span class="attr">ut</span>=<span class="string">"15baf6278f0"</span> <span class="attr">version</span>=<span class="string">"3002"</span> </span></span><br><span class="line"><span class="tag">          <span class="attr">nativeLibraryPath</span>=<span class="string">"/system/app/pic/lib"</span> <span class="attr">primaryCpuAbi</span>=<span class="string">"arm64-v8a"</span> <span class="attr">sharedUserId</span>=<span class="string">"1000"</span> /&gt;</span></span><br></pre></td></tr></table></figure>
</li>
</ul>
</li>
</ul>
<p>可以看到，package 的 codePath、nativeLibraryPath 都发生了变化，根据上面的解析过程，data 分区的覆盖安装的 apk 将被保存到 mPackages 中，system 分区原来的旧 apk 将被保存到 mDisablePackage 中！</p>
<ul>
<li>OTA 升级方式<ul>
<li>这种方式是通过进入 Recovery 升级（或者是 A/B 升级方式），通过 patch 和文件覆盖方式来升级，这种方式不会即时更改 Packages.xml 文件，真正的修改是在重启后的 PMS 中去做的！</li>
</ul>
</li>
</ul>
<h4 id="3-2-1-1-Settings-peekPackageLPr"><a href="#3-2-1-1-Settings-peekPackageLPr" class="headerlink" title="3.2.1.1 Settings.peekPackageLPr"></a>3.2.1.1 Settings.peekPackageLPr</h4><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="function">PackageSetting <span class="title">peekPackageLPr</span><span class="params">(String name)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">return</span> mPackages.get(name);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>该方法用于获得 packageName 对应的 PackageSetting 对象！</p>
<h4 id="3-2-1-2-Settings-getDisabledSystemPkgLPr"><a href="#3-2-1-2-Settings-getDisabledSystemPkgLPr" class="headerlink" title="3.2.1.2 Settings.getDisabledSystemPkgLPr"></a>3.2.1.2 Settings.getDisabledSystemPkgLPr</h4><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> PackageSetting <span class="title">getDisabledSystemPkgLPr</span><span class="params">(String name)</span> </span>&#123;</span><br><span class="line">    PackageSetting ps = mDisabledSysPackages.get(name);</span><br><span class="line">    <span class="keyword">return</span> ps;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>我们知道 mDisabledSysPackages 中的数据来自 updated-package 标签！</p>
<h4 id="3-2-1-3-Settings-removeDisabledSystemPackageLPw"><a href="#3-2-1-3-Settings-removeDisabledSystemPackageLPw" class="headerlink" title="3.2.1.3 Settings.removeDisabledSystemPackageLPw"></a>3.2.1.3 Settings.removeDisabledSystemPackageLPw</h4><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">removeDisabledSystemPackageLPw</span><span class="params">(String name)</span> </span>&#123;</span><br><span class="line">    mDisabledSysPackages.remove(name);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h4 id="3-2-1-4-Settings-enableSystemPackageLPw"><a href="#3-2-1-4-Settings-enableSystemPackageLPw" class="headerlink" title="3.2.1.4 Settings.enableSystemPackageLPw"></a>3.2.1.4 Settings.enableSystemPackageLPw</h4><p>这里用于恢复一个 system pacakge！</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="function">PackageSetting <span class="title">enableSystemPackageLPw</span><span class="params">(String name)</span> </span>&#123;</span><br><span class="line">    <span class="comment">// 从 mDisabledSysPackages 中获得被更新前的 PackageSettings！</span></span><br><span class="line">    PackageSetting p = mDisabledSysPackages.get(name);</span><br><span class="line">    <span class="keyword">if</span>(p == <span class="keyword">null</span>) &#123;</span><br><span class="line">        Log.w(PackageManagerService.TAG, <span class="string">"Package "</span> + name + <span class="string">" is not disabled"</span>);</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">null</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// 去掉 ApplicationInfo.FLAG_UPDATED_SYSTEM_APP 标志位！</span></span><br><span class="line">    <span class="keyword">if</span>((p.pkg != <span class="keyword">null</span>) &amp;&amp; (p.pkg.applicationInfo != <span class="keyword">null</span>)) &#123;</span><br><span class="line">        p.pkg.applicationInfo.flags &amp;= ~ApplicationInfo.FLAG_UPDATED_SYSTEM_APP;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// 复用数据，创建一个新的 PackageSetting，并根据 uid 添加到指定集合中！ </span></span><br><span class="line">    PackageSetting ret = addPackageLPw(name, p.realName, p.codePath, p.resourcePath,</span><br><span class="line">            p.legacyNativeLibraryPathString, p.primaryCpuAbiString,</span><br><span class="line">            p.secondaryCpuAbiString, p.cpuAbiOverrideString,</span><br><span class="line">            p.appId, p.versionCode, p.pkgFlags, p.pkgPrivateFlags,</span><br><span class="line">            p.parentPackageName, p.childPackageNames);</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 从 mDisabledSysPackages 移除这个 package</span></span><br><span class="line">    mDisabledSysPackages.remove(name);</span><br><span class="line">    <span class="keyword">return</span> ret;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>方法的流程很简单，不多说了！</p>
<h4 id="3-2-1-6-PMS-deletePackageLIF"><a href="#3-2-1-6-PMS-deletePackageLIF" class="headerlink" title="3.2.1.6 PMS.deletePackageLIF"></a>3.2.1.6 PMS.deletePackageLIF</h4><p>对于之前 apk 是安装在 data 分区，而后来出现了相同包名的新 apk 安装在了 system 分区这种情况，需要校验签名，如果不匹配的话，就要删掉 data 分区的 apk！</p>
<p>首先创建了一个 PackageFreezer 对象，用来冻结这个应用！<br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="title">PackageFreezer</span><span class="params">(String packageName, <span class="keyword">int</span> userId, String killReason)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">synchronized</span> (mPackages) &#123;</span><br><span class="line">        <span class="comment">// 添加到 mFrozenPackages 集合中！</span></span><br><span class="line">        mPackageName = packageName;</span><br><span class="line">        mWeFroze = mFrozenPackages.add(mPackageName);</span><br><span class="line"></span><br><span class="line">        <span class="keyword">final</span> PackageSetting ps = mSettings.mPackages.get(mPackageName);</span><br><span class="line">        <span class="keyword">if</span> (ps != <span class="keyword">null</span>) &#123;</span><br><span class="line">            <span class="comment">// 杀掉应用的进程</span></span><br><span class="line">            killApplication(ps.name, ps.appId, userId, killReason);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 对子包进行相同的操作！</span></span><br><span class="line">        <span class="keyword">final</span> PackageParser.Package p = mPackages.get(packageName);</span><br><span class="line">        <span class="keyword">if</span> (p != <span class="keyword">null</span> &amp;&amp; p.childPackages != <span class="keyword">null</span>) &#123;</span><br><span class="line"></span><br><span class="line">            <span class="keyword">final</span> <span class="keyword">int</span> N = p.childPackages.size();</span><br><span class="line">            mChildren = <span class="keyword">new</span> PackageFreezer[N];</span><br><span class="line">            <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; N; i++) &#123;</span><br><span class="line">                mChildren[i] = <span class="keyword">new</span> PackageFreezer(p.childPackages.get(i).packageName,</span><br><span class="line">                        userId, killReason);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            mChildren = <span class="keyword">null</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    mCloseGuard.open(<span class="string">"close"</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>接着，调用 deletePackageLIF 方法来处理这个 package，传入参数：</p>
<ul>
<li>String packageName：传入 pkg.packageName；</li>
<li>UserHandle user：传入 null；</li>
<li>boolean deleteCodeAndResources：传入 true；</li>
<li>int[] allUserHandles：传入 null；</li>
<li>int flags：传入 0；</li>
<li>PackageRemovedInfo outInfo：传入 null；</li>
<li>boolean writeSettings：传入 false；</li>
<li>PackageParser.Package replacingPackage：传入 null;</li>
</ul>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">boolean</span> <span class="title">deletePackageLIF</span><span class="params">(String packageName, UserHandle user,</span></span></span><br><span class="line"><span class="function"><span class="params">        <span class="keyword">boolean</span> deleteCodeAndResources, <span class="keyword">int</span>[] allUserHandles, <span class="keyword">int</span> flags,</span></span></span><br><span class="line"><span class="function"><span class="params">        PackageRemovedInfo outInfo, <span class="keyword">boolean</span> writeSettings,</span></span></span><br><span class="line"><span class="function"><span class="params">        PackageParser.Package replacingPackage)</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (packageName == <span class="keyword">null</span>) &#123;</span><br><span class="line">        Slog.w(TAG, <span class="string">"Attempt to delete null packageName."</span>);</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">false</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (DEBUG_REMOVE) Slog.d(TAG, <span class="string">"deletePackageLI: "</span> + packageName + <span class="string">" user "</span> + user);</span><br><span class="line"></span><br><span class="line">    PackageSetting ps;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">synchronized</span> (mPackages) &#123;</span><br><span class="line">        </span><br><span class="line">        <span class="comment">// 获得之前安装的信息，如果为 null，谁明这个</span></span><br><span class="line">        ps = mSettings.mPackages.get(packageName);</span><br><span class="line">        <span class="keyword">if</span> (ps == <span class="keyword">null</span>) &#123;</span><br><span class="line">            Slog.w(TAG, <span class="string">"Package named '"</span> + packageName + <span class="string">"' doesn't exist."</span>);</span><br><span class="line">            <span class="keyword">return</span> <span class="keyword">false</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        </span><br><span class="line">        <span class="comment">// 如果当前的 package 是 child package，且不是系统 apk 的话，进入这个分支！</span></span><br><span class="line">        <span class="keyword">if</span> (ps.parentPackageName != <span class="keyword">null</span> &amp;&amp; (!isSystemApp(ps)</span><br><span class="line">                || (flags &amp; PackageManager.DELETE_SYSTEM_APP) != <span class="number">0</span>)) &#123;</span><br><span class="line"></span><br><span class="line">            <span class="keyword">if</span> (DEBUG_REMOVE) &#123;</span><br><span class="line">                Slog.d(TAG, <span class="string">"Uninstalled child package:"</span> + packageName + <span class="string">" for user:"</span></span><br><span class="line">                        + ((user == <span class="keyword">null</span>) ? UserHandle.USER_ALL : user));</span><br><span class="line">            &#125;</span><br><span class="line">            </span><br><span class="line">            <span class="comment">// 根据参数传递，removedUserId 的值为 UserHandle.USER_ALL；</span></span><br><span class="line">            <span class="keyword">final</span> <span class="keyword">int</span> removedUserId = (user != <span class="keyword">null</span>) ? user.getIdentifier()</span><br><span class="line">                    : UserHandle.USER_ALL;</span><br><span class="line"></span><br><span class="line">            <span class="keyword">if</span> (!clearPackageStateForUserLIF(ps, removedUserId, outInfo)) &#123;</span><br><span class="line">                <span class="keyword">return</span> <span class="keyword">false</span>;</span><br><span class="line">            &#125;</span><br><span class="line">            </span><br><span class="line">            markPackageUninstalledForUserLPw(ps, user);</span><br><span class="line">            scheduleWritePackageRestrictionsLocked(user);</span><br><span class="line">            </span><br><span class="line">            <span class="keyword">return</span> <span class="keyword">true</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 当 user 不为 null 才会进入这里，表示为指定的设备用户删除该 apk！</span></span><br><span class="line">    <span class="keyword">if</span> (((!isSystemApp(ps) || (flags&amp;PackageManager.DELETE_SYSTEM_APP) != <span class="number">0</span>) &amp;&amp; user != <span class="keyword">null</span></span><br><span class="line">            &amp;&amp; user.getIdentifier() != UserHandle.USER_ALL)) &#123;</span><br><span class="line">        ... ... ... ...</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 这里也不进入！</span></span><br><span class="line">    <span class="keyword">if</span> (ps.childPackageNames != <span class="keyword">null</span> &amp;&amp; outInfo != <span class="keyword">null</span>) &#123;</span><br><span class="line">        ... ... ... ...</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">boolean</span> ret = <span class="keyword">false</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (isSystemApp(ps)) &#123;</span><br><span class="line">        <span class="keyword">if</span> (DEBUG_REMOVE) Slog.d(TAG, <span class="string">"Removing system package: "</span> + ps.name);</span><br><span class="line">        <span class="comment">// When an updated system application is deleted we delete the existing resources</span></span><br><span class="line">        <span class="comment">// as well and fall back to existing code in system partition</span></span><br><span class="line">        ret = deleteSystemPackageLIF(ps.pkg, ps, allUserHandles, flags, outInfo, writeSettings);</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        <span class="keyword">if</span> (DEBUG_REMOVE) Slog.d(TAG, <span class="string">"Removing non-system package: "</span> + ps.name);</span><br><span class="line">        </span><br><span class="line">        <span class="comment">// 进入这个分支，因为 data 分区的 apk 已经存在，所以进入这个分支，删除掉非系统 apk！</span></span><br><span class="line">        ret = deleteInstalledPackageLIF(ps, deleteCodeAndResources, flags, allUserHandles,</span><br><span class="line">                outInfo, writeSettings, replacingPackage);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 根据参数，不会进入这个分支</span></span><br><span class="line">    <span class="keyword">if</span> (outInfo != <span class="keyword">null</span>) &#123;</span><br><span class="line">        ... ... ... </span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> ret;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>关于 apk 删除的逻辑，我们在另开一篇讲解，这个的逻辑是会删掉之前已经安装的 data 分区的 apk 的！</p>
<p>继续看：</p>
<h4 id="3-2-1-7-PMS-scanPackageLI"><a href="#3-2-1-7-PMS-scanPackageLI" class="headerlink" title="3.2.1.7 PMS.scanPackageLI"></a>3.2.1.7 PMS.scanPackageLI</h4><p>接下来，进一步的扫描：<br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">private</span> PackageParser.<span class="function">Package <span class="title">scanPackageLI</span><span class="params">(PackageParser.Package pkg, <span class="keyword">final</span> <span class="keyword">int</span> policyFlags,</span></span></span><br><span class="line"><span class="function"><span class="params">        <span class="keyword">int</span> scanFlags, <span class="keyword">long</span> currentTime, UserHandle user)</span> <span class="keyword">throws</span> PackageManagerException </span>&#123;</span><br><span class="line">    <span class="keyword">boolean</span> success = <span class="keyword">false</span>;</span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">    </span><br><span class="line">        <span class="comment">//【3.2.1.7.1】继续调用 scanPackageDirtyLI 处理扫描数据！</span></span><br><span class="line">        <span class="keyword">final</span> PackageParser.Package res = scanPackageDirtyLI(pkg, policyFlags, scanFlags,</span><br><span class="line">                currentTime, user);</span><br><span class="line">                </span><br><span class="line">        success = <span class="keyword">true</span>;</span><br><span class="line">        <span class="keyword">return</span> res;</span><br><span class="line">    &#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">        <span class="keyword">if</span> (!success &amp;&amp; (scanFlags &amp; SCAN_DELETE_DATA_ON_FAILURES) != <span class="number">0</span>) &#123;</span><br><span class="line">            <span class="comment">// DELETE_DATA_ON_FAILURES is only used by frozen paths</span></span><br><span class="line">            <span class="comment">// 失败了就清楚掉数据！</span></span><br><span class="line">            destroyAppDataLIF(pkg, UserHandle.USER_ALL,</span><br><span class="line">                    StorageManager.FLAG_STORAGE_DE | StorageManager.FLAG_STORAGE_CE);</span><br><span class="line">            destroyAppProfilesLIF(pkg, UserHandle.USER_ALL);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>下面，我们继续看 scanPackageDirtyLI 方法中的逻辑！</p>
<h5 id="3-2-1-7-1-PMS-scanPackageDirtyLI"><a href="#3-2-1-7-1-PMS-scanPackageDirtyLI" class="headerlink" title="3.2.1.7.1 *PMS.scanPackageDirtyLI"></a>3.2.1.7.1 *PMS.scanPackageDirtyLI</h5><p>最终调用 scanPackageDirtyLI 方法处理扫描得到的数据：</p>
<p>因为我们本次扫描的是 system app，所以 PackageParser.Package pkg 分装了扫描的结果信息！<br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br><span class="line">212</span><br><span class="line">213</span><br><span class="line">214</span><br><span class="line">215</span><br><span class="line">216</span><br><span class="line">217</span><br><span class="line">218</span><br><span class="line">219</span><br><span class="line">220</span><br><span class="line">221</span><br><span class="line">222</span><br><span class="line">223</span><br><span class="line">224</span><br><span class="line">225</span><br><span class="line">226</span><br><span class="line">227</span><br><span class="line">228</span><br><span class="line">229</span><br><span class="line">230</span><br><span class="line">231</span><br><span class="line">232</span><br><span class="line">233</span><br><span class="line">234</span><br><span class="line">235</span><br><span class="line">236</span><br><span class="line">237</span><br><span class="line">238</span><br><span class="line">239</span><br><span class="line">240</span><br><span class="line">241</span><br><span class="line">242</span><br><span class="line">243</span><br><span class="line">244</span><br><span class="line">245</span><br><span class="line">246</span><br><span class="line">247</span><br><span class="line">248</span><br><span class="line">249</span><br><span class="line">250</span><br><span class="line">251</span><br><span class="line">252</span><br><span class="line">253</span><br><span class="line">254</span><br><span class="line">255</span><br><span class="line">256</span><br><span class="line">257</span><br><span class="line">258</span><br><span class="line">259</span><br><span class="line">260</span><br><span class="line">261</span><br><span class="line">262</span><br><span class="line">263</span><br><span class="line">264</span><br><span class="line">265</span><br><span class="line">266</span><br><span class="line">267</span><br><span class="line">268</span><br><span class="line">269</span><br><span class="line">270</span><br><span class="line">271</span><br><span class="line">272</span><br><span class="line">273</span><br><span class="line">274</span><br><span class="line">275</span><br><span class="line">276</span><br><span class="line">277</span><br><span class="line">278</span><br><span class="line">279</span><br><span class="line">280</span><br><span class="line">281</span><br><span class="line">282</span><br><span class="line">283</span><br><span class="line">284</span><br><span class="line">285</span><br><span class="line">286</span><br><span class="line">287</span><br><span class="line">288</span><br><span class="line">289</span><br><span class="line">290</span><br><span class="line">291</span><br><span class="line">292</span><br><span class="line">293</span><br><span class="line">294</span><br><span class="line">295</span><br><span class="line">296</span><br><span class="line">297</span><br><span class="line">298</span><br><span class="line">299</span><br><span class="line">300</span><br><span class="line">301</span><br><span class="line">302</span><br><span class="line">303</span><br><span class="line">304</span><br><span class="line">305</span><br><span class="line">306</span><br><span class="line">307</span><br><span class="line">308</span><br><span class="line">309</span><br><span class="line">310</span><br><span class="line">311</span><br><span class="line">312</span><br><span class="line">313</span><br><span class="line">314</span><br><span class="line">315</span><br><span class="line">316</span><br><span class="line">317</span><br><span class="line">318</span><br><span class="line">319</span><br><span class="line">320</span><br><span class="line">321</span><br><span class="line">322</span><br><span class="line">323</span><br><span class="line">324</span><br><span class="line">325</span><br><span class="line">326</span><br><span class="line">327</span><br><span class="line">328</span><br><span class="line">329</span><br><span class="line">330</span><br><span class="line">331</span><br><span class="line">332</span><br><span class="line">333</span><br><span class="line">334</span><br><span class="line">335</span><br><span class="line">336</span><br><span class="line">337</span><br><span class="line">338</span><br><span class="line">339</span><br><span class="line">340</span><br><span class="line">341</span><br><span class="line">342</span><br><span class="line">343</span><br><span class="line">344</span><br><span class="line">345</span><br><span class="line">346</span><br><span class="line">347</span><br><span class="line">348</span><br><span class="line">349</span><br><span class="line">350</span><br><span class="line">351</span><br><span class="line">352</span><br><span class="line">353</span><br><span class="line">354</span><br><span class="line">355</span><br><span class="line">356</span><br><span class="line">357</span><br><span class="line">358</span><br><span class="line">359</span><br><span class="line">360</span><br><span class="line">361</span><br><span class="line">362</span><br><span class="line">363</span><br><span class="line">364</span><br><span class="line">365</span><br><span class="line">366</span><br><span class="line">367</span><br><span class="line">368</span><br><span class="line">369</span><br><span class="line">370</span><br><span class="line">371</span><br><span class="line">372</span><br><span class="line">373</span><br><span class="line">374</span><br><span class="line">375</span><br><span class="line">376</span><br><span class="line">377</span><br><span class="line">378</span><br><span class="line">379</span><br><span class="line">380</span><br><span class="line">381</span><br><span class="line">382</span><br><span class="line">383</span><br><span class="line">384</span><br><span class="line">385</span><br><span class="line">386</span><br><span class="line">387</span><br><span class="line">388</span><br><span class="line">389</span><br><span class="line">390</span><br><span class="line">391</span><br><span class="line">392</span><br><span class="line">393</span><br><span class="line">394</span><br><span class="line">395</span><br><span class="line">396</span><br><span class="line">397</span><br><span class="line">398</span><br><span class="line">399</span><br><span class="line">400</span><br><span class="line">401</span><br><span class="line">402</span><br><span class="line">403</span><br><span class="line">404</span><br><span class="line">405</span><br><span class="line">406</span><br><span class="line">407</span><br><span class="line">408</span><br><span class="line">409</span><br><span class="line">410</span><br><span class="line">411</span><br><span class="line">412</span><br><span class="line">413</span><br><span class="line">414</span><br><span class="line">415</span><br><span class="line">416</span><br><span class="line">417</span><br><span class="line">418</span><br><span class="line">419</span><br><span class="line">420</span><br><span class="line">421</span><br><span class="line">422</span><br><span class="line">423</span><br><span class="line">424</span><br><span class="line">425</span><br><span class="line">426</span><br><span class="line">427</span><br><span class="line">428</span><br><span class="line">429</span><br><span class="line">430</span><br><span class="line">431</span><br><span class="line">432</span><br><span class="line">433</span><br><span class="line">434</span><br><span class="line">435</span><br><span class="line">436</span><br><span class="line">437</span><br><span class="line">438</span><br><span class="line">439</span><br><span class="line">440</span><br><span class="line">441</span><br><span class="line">442</span><br><span class="line">443</span><br><span class="line">444</span><br><span class="line">445</span><br><span class="line">446</span><br><span class="line">447</span><br><span class="line">448</span><br><span class="line">449</span><br><span class="line">450</span><br><span class="line">451</span><br><span class="line">452</span><br><span class="line">453</span><br><span class="line">454</span><br><span class="line">455</span><br><span class="line">456</span><br><span class="line">457</span><br><span class="line">458</span><br><span class="line">459</span><br><span class="line">460</span><br><span class="line">461</span><br><span class="line">462</span><br><span class="line">463</span><br><span class="line">464</span><br><span class="line">465</span><br><span class="line">466</span><br><span class="line">467</span><br><span class="line">468</span><br><span class="line">469</span><br><span class="line">470</span><br><span class="line">471</span><br><span class="line">472</span><br><span class="line">473</span><br><span class="line">474</span><br><span class="line">475</span><br><span class="line">476</span><br><span class="line">477</span><br><span class="line">478</span><br><span class="line">479</span><br><span class="line">480</span><br><span class="line">481</span><br><span class="line">482</span><br><span class="line">483</span><br><span class="line">484</span><br><span class="line">485</span><br><span class="line">486</span><br><span class="line">487</span><br><span class="line">488</span><br><span class="line">489</span><br><span class="line">490</span><br><span class="line">491</span><br><span class="line">492</span><br><span class="line">493</span><br><span class="line">494</span><br><span class="line">495</span><br><span class="line">496</span><br><span class="line">497</span><br><span class="line">498</span><br><span class="line">499</span><br><span class="line">500</span><br><span class="line">501</span><br><span class="line">502</span><br><span class="line">503</span><br><span class="line">504</span><br><span class="line">505</span><br><span class="line">506</span><br><span class="line">507</span><br><span class="line">508</span><br><span class="line">509</span><br><span class="line">510</span><br><span class="line">511</span><br><span class="line">512</span><br><span class="line">513</span><br><span class="line">514</span><br><span class="line">515</span><br><span class="line">516</span><br><span class="line">517</span><br><span class="line">518</span><br><span class="line">519</span><br><span class="line">520</span><br><span class="line">521</span><br><span class="line">522</span><br><span class="line">523</span><br><span class="line">524</span><br><span class="line">525</span><br><span class="line">526</span><br><span class="line">527</span><br><span class="line">528</span><br><span class="line">529</span><br><span class="line">530</span><br><span class="line">531</span><br><span class="line">532</span><br><span class="line">533</span><br><span class="line">534</span><br><span class="line">535</span><br><span class="line">536</span><br><span class="line">537</span><br><span class="line">538</span><br><span class="line">539</span><br><span class="line">540</span><br><span class="line">541</span><br><span class="line">542</span><br><span class="line">543</span><br><span class="line">544</span><br><span class="line">545</span><br><span class="line">546</span><br><span class="line">547</span><br><span class="line">548</span><br><span class="line">549</span><br><span class="line">550</span><br><span class="line">551</span><br><span class="line">552</span><br><span class="line">553</span><br><span class="line">554</span><br><span class="line">555</span><br><span class="line">556</span><br><span class="line">557</span><br><span class="line">558</span><br><span class="line">559</span><br><span class="line">560</span><br><span class="line">561</span><br><span class="line">562</span><br><span class="line">563</span><br><span class="line">564</span><br><span class="line">565</span><br><span class="line">566</span><br><span class="line">567</span><br><span class="line">568</span><br><span class="line">569</span><br><span class="line">570</span><br><span class="line">571</span><br><span class="line">572</span><br><span class="line">573</span><br><span class="line">574</span><br><span class="line">575</span><br><span class="line">576</span><br><span class="line">577</span><br><span class="line">578</span><br><span class="line">579</span><br><span class="line">580</span><br><span class="line">581</span><br><span class="line">582</span><br><span class="line">583</span><br><span class="line">584</span><br><span class="line">585</span><br><span class="line">586</span><br><span class="line">587</span><br><span class="line">588</span><br><span class="line">589</span><br><span class="line">590</span><br><span class="line">591</span><br><span class="line">592</span><br><span class="line">593</span><br><span class="line">594</span><br><span class="line">595</span><br><span class="line">596</span><br><span class="line">597</span><br><span class="line">598</span><br><span class="line">599</span><br><span class="line">600</span><br><span class="line">601</span><br><span class="line">602</span><br><span class="line">603</span><br><span class="line">604</span><br><span class="line">605</span><br><span class="line">606</span><br><span class="line">607</span><br><span class="line">608</span><br><span class="line">609</span><br><span class="line">610</span><br><span class="line">611</span><br><span class="line">612</span><br><span class="line">613</span><br><span class="line">614</span><br><span class="line">615</span><br><span class="line">616</span><br><span class="line">617</span><br><span class="line">618</span><br><span class="line">619</span><br><span class="line">620</span><br><span class="line">621</span><br><span class="line">622</span><br><span class="line">623</span><br><span class="line">624</span><br><span class="line">625</span><br><span class="line">626</span><br><span class="line">627</span><br><span class="line">628</span><br><span class="line">629</span><br><span class="line">630</span><br><span class="line">631</span><br><span class="line">632</span><br><span class="line">633</span><br><span class="line">634</span><br><span class="line">635</span><br><span class="line">636</span><br><span class="line">637</span><br><span class="line">638</span><br><span class="line">639</span><br><span class="line">640</span><br><span class="line">641</span><br><span class="line">642</span><br><span class="line">643</span><br><span class="line">644</span><br><span class="line">645</span><br><span class="line">646</span><br><span class="line">647</span><br><span class="line">648</span><br><span class="line">649</span><br><span class="line">650</span><br><span class="line">651</span><br><span class="line">652</span><br><span class="line">653</span><br><span class="line">654</span><br><span class="line">655</span><br><span class="line">656</span><br><span class="line">657</span><br><span class="line">658</span><br><span class="line">659</span><br><span class="line">660</span><br><span class="line">661</span><br><span class="line">662</span><br><span class="line">663</span><br><span class="line">664</span><br><span class="line">665</span><br><span class="line">666</span><br><span class="line">667</span><br><span class="line">668</span><br><span class="line">669</span><br><span class="line">670</span><br><span class="line">671</span><br><span class="line">672</span><br><span class="line">673</span><br><span class="line">674</span><br><span class="line">675</span><br><span class="line">676</span><br><span class="line">677</span><br><span class="line">678</span><br><span class="line">679</span><br><span class="line">680</span><br><span class="line">681</span><br><span class="line">682</span><br><span class="line">683</span><br><span class="line">684</span><br><span class="line">685</span><br><span class="line">686</span><br><span class="line">687</span><br><span class="line">688</span><br><span class="line">689</span><br><span class="line">690</span><br><span class="line">691</span><br><span class="line">692</span><br><span class="line">693</span><br><span class="line">694</span><br><span class="line">695</span><br><span class="line">696</span><br><span class="line">697</span><br><span class="line">698</span><br><span class="line">699</span><br><span class="line">700</span><br><span class="line">701</span><br><span class="line">702</span><br><span class="line">703</span><br><span class="line">704</span><br><span class="line">705</span><br><span class="line">706</span><br><span class="line">707</span><br><span class="line">708</span><br><span class="line">709</span><br><span class="line">710</span><br><span class="line">711</span><br><span class="line">712</span><br><span class="line">713</span><br><span class="line">714</span><br><span class="line">715</span><br><span class="line">716</span><br><span class="line">717</span><br><span class="line">718</span><br><span class="line">719</span><br><span class="line">720</span><br><span class="line">721</span><br><span class="line">722</span><br><span class="line">723</span><br><span class="line">724</span><br><span class="line">725</span><br><span class="line">726</span><br><span class="line">727</span><br><span class="line">728</span><br><span class="line">729</span><br><span class="line">730</span><br><span class="line">731</span><br><span class="line">732</span><br><span class="line">733</span><br><span class="line">734</span><br><span class="line">735</span><br><span class="line">736</span><br><span class="line">737</span><br><span class="line">738</span><br><span class="line">739</span><br><span class="line">740</span><br><span class="line">741</span><br><span class="line">742</span><br><span class="line">743</span><br><span class="line">744</span><br><span class="line">745</span><br><span class="line">746</span><br><span class="line">747</span><br><span class="line">748</span><br><span class="line">749</span><br><span class="line">750</span><br><span class="line">751</span><br><span class="line">752</span><br><span class="line">753</span><br><span class="line">754</span><br><span class="line">755</span><br><span class="line">756</span><br><span class="line">757</span><br><span class="line">758</span><br><span class="line">759</span><br><span class="line">760</span><br><span class="line">761</span><br><span class="line">762</span><br><span class="line">763</span><br><span class="line">764</span><br><span class="line">765</span><br><span class="line">766</span><br><span class="line">767</span><br><span class="line">768</span><br><span class="line">769</span><br><span class="line">770</span><br><span class="line">771</span><br><span class="line">772</span><br><span class="line">773</span><br><span class="line">774</span><br><span class="line">775</span><br><span class="line">776</span><br><span class="line">777</span><br><span class="line">778</span><br><span class="line">779</span><br><span class="line">780</span><br><span class="line">781</span><br><span class="line">782</span><br><span class="line">783</span><br><span class="line">784</span><br><span class="line">785</span><br><span class="line">786</span><br><span class="line">787</span><br><span class="line">788</span><br><span class="line">789</span><br><span class="line">790</span><br><span class="line">791</span><br><span class="line">792</span><br><span class="line">793</span><br><span class="line">794</span><br><span class="line">795</span><br><span class="line">796</span><br><span class="line">797</span><br><span class="line">798</span><br><span class="line">799</span><br><span class="line">800</span><br><span class="line">801</span><br><span class="line">802</span><br><span class="line">803</span><br><span class="line">804</span><br><span class="line">805</span><br><span class="line">806</span><br><span class="line">807</span><br><span class="line">808</span><br><span class="line">809</span><br><span class="line">810</span><br><span class="line">811</span><br><span class="line">812</span><br><span class="line">813</span><br><span class="line">814</span><br><span class="line">815</span><br><span class="line">816</span><br><span class="line">817</span><br><span class="line">818</span><br><span class="line">819</span><br><span class="line">820</span><br><span class="line">821</span><br><span class="line">822</span><br><span class="line">823</span><br><span class="line">824</span><br><span class="line">825</span><br><span class="line">826</span><br><span class="line">827</span><br><span class="line">828</span><br><span class="line">829</span><br><span class="line">830</span><br><span class="line">831</span><br><span class="line">832</span><br><span class="line">833</span><br><span class="line">834</span><br><span class="line">835</span><br><span class="line">836</span><br><span class="line">837</span><br><span class="line">838</span><br><span class="line">839</span><br><span class="line">840</span><br><span class="line">841</span><br><span class="line">842</span><br><span class="line">843</span><br><span class="line">844</span><br><span class="line">845</span><br><span class="line">846</span><br><span class="line">847</span><br><span class="line">848</span><br><span class="line">849</span><br><span class="line">850</span><br><span class="line">851</span><br><span class="line">852</span><br><span class="line">853</span><br><span class="line">854</span><br><span class="line">855</span><br><span class="line">856</span><br><span class="line">857</span><br><span class="line">858</span><br><span class="line">859</span><br><span class="line">860</span><br><span class="line">861</span><br><span class="line">862</span><br><span class="line">863</span><br><span class="line">864</span><br><span class="line">865</span><br><span class="line">866</span><br><span class="line">867</span><br><span class="line">868</span><br><span class="line">869</span><br><span class="line">870</span><br><span class="line">871</span><br><span class="line">872</span><br><span class="line">873</span><br><span class="line">874</span><br><span class="line">875</span><br><span class="line">876</span><br><span class="line">877</span><br><span class="line">878</span><br><span class="line">879</span><br><span class="line">880</span><br><span class="line">881</span><br><span class="line">882</span><br><span class="line">883</span><br><span class="line">884</span><br><span class="line">885</span><br><span class="line">886</span><br><span class="line">887</span><br><span class="line">888</span><br><span class="line">889</span><br><span class="line">890</span><br><span class="line">891</span><br><span class="line">892</span><br><span class="line">893</span><br><span class="line">894</span><br><span class="line">895</span><br><span class="line">896</span><br><span class="line">897</span><br><span class="line">898</span><br><span class="line">899</span><br><span class="line">900</span><br><span class="line">901</span><br><span class="line">902</span><br><span class="line">903</span><br><span class="line">904</span><br><span class="line">905</span><br><span class="line">906</span><br><span class="line">907</span><br><span class="line">908</span><br><span class="line">909</span><br><span class="line">910</span><br><span class="line">911</span><br><span class="line">912</span><br><span class="line">913</span><br><span class="line">914</span><br><span class="line">915</span><br><span class="line">916</span><br><span class="line">917</span><br><span class="line">918</span><br><span class="line">919</span><br><span class="line">920</span><br><span class="line">921</span><br><span class="line">922</span><br><span class="line">923</span><br><span class="line">924</span><br><span class="line">925</span><br><span class="line">926</span><br><span class="line">927</span><br><span class="line">928</span><br><span class="line">929</span><br><span class="line">930</span><br><span class="line">931</span><br><span class="line">932</span><br><span class="line">933</span><br><span class="line">934</span><br><span class="line">935</span><br><span class="line">936</span><br><span class="line">937</span><br><span class="line">938</span><br><span class="line">939</span><br><span class="line">940</span><br><span class="line">941</span><br><span class="line">942</span><br><span class="line">943</span><br><span class="line">944</span><br><span class="line">945</span><br><span class="line">946</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">private</span> PackageParser.<span class="function">Package <span class="title">scanPackageDirtyLI</span><span class="params">(PackageParser.Package pkg,</span></span></span><br><span class="line"><span class="function"><span class="params">        <span class="keyword">final</span> <span class="keyword">int</span> policyFlags, <span class="keyword">final</span> <span class="keyword">int</span> scanFlags, <span class="keyword">long</span> currentTime, UserHandle user)</span></span></span><br><span class="line"><span class="function">        <span class="keyword">throws</span> PackageManagerException </span>&#123;</span><br><span class="line">    <span class="keyword">final</span> File scanFile = <span class="keyword">new</span> File(pkg.codePath);</span><br><span class="line">    <span class="keyword">if</span> (pkg.applicationInfo.getCodePath() == <span class="keyword">null</span> ||</span><br><span class="line">            pkg.applicationInfo.getResourcePath() == <span class="keyword">null</span>) &#123;</span><br><span class="line">        <span class="keyword">throw</span> <span class="keyword">new</span> PackageManagerException(INSTALL_FAILED_INVALID_APK,</span><br><span class="line">                <span class="string">"Code and resource paths haven't been set correctly"</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//【1】处理系统 apk 标志位；</span></span><br><span class="line">    <span class="keyword">if</span> ((policyFlags &amp; PackageParser.PARSE_IS_SYSTEM) != <span class="number">0</span>) &#123; </span><br><span class="line">        <span class="comment">// 对于系统 app，增加 ApplicationInfo.FLAG_SYSTEM 的 flags，表示是系统 apk！</span></span><br><span class="line">        <span class="comment">//【1.1】注意系统和非系统的区别是，apk 所在的目录！</span></span><br><span class="line">        pkg.applicationInfo.flags |= ApplicationInfo.FLAG_SYSTEM;</span><br><span class="line">        <span class="comment">// 处理 Direct Boot Mode 属性，设备启动后进入的一个新模式，直到用户解锁（unlock）设备此阶段结束！</span></span><br><span class="line">        <span class="keyword">if</span> (pkg.applicationInfo.isDirectBootAware()) &#123;</span><br><span class="line">            <span class="keyword">for</span> (PackageParser.Service s : pkg.services) &#123;</span><br><span class="line">                s.info.encryptionAware = s.info.directBootAware = <span class="keyword">true</span>;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">for</span> (PackageParser.Provider p : pkg.providers) &#123;</span><br><span class="line">                p.info.encryptionAware = p.info.directBootAware = <span class="keyword">true</span>;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">for</span> (PackageParser.Activity a : pkg.activities) &#123;</span><br><span class="line">                a.info.encryptionAware = a.info.directBootAware = <span class="keyword">true</span>;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">for</span> (PackageParser.Activity r : pkg.receivers) &#123;</span><br><span class="line">                r.info.encryptionAware = r.info.directBootAware = <span class="keyword">true</span>;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        pkg.coreApp = <span class="keyword">false</span>;</span><br><span class="line">        pkg.applicationInfo.privateFlags &amp;=</span><br><span class="line">                ~ApplicationInfo.PRIVATE_FLAG_DEFAULT_TO_DEVICE_PROTECTED_STORAGE;</span><br><span class="line">        pkg.applicationInfo.privateFlags &amp;=</span><br><span class="line">                ~ApplicationInfo.PRIVATE_FLAG_DIRECT_BOOT_AWARE;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    pkg.mTrustedOverlay = (policyFlags&amp;PackageParser.PARSE_TRUSTED_OVERLAY) != <span class="number">0</span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//【2】设置 ApplicationInfo.PRIVATE_FLAG_PRIVILEGED 标记位，说明这个 apk 是特权 apk！</span></span><br><span class="line">    <span class="keyword">if</span> ((policyFlags&amp;PackageParser.PARSE_IS_PRIVILEGED) != <span class="number">0</span>) &#123;</span><br><span class="line">        pkg.applicationInfo.privateFlags |= ApplicationInfo.PRIVATE_FLAG_PRIVILEGED;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> ((policyFlags &amp; PackageParser.PARSE_ENFORCE_CODE) != <span class="number">0</span>) &#123;</span><br><span class="line">        enforceCodePolicy(pkg);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (mCustomResolverComponentName != <span class="keyword">null</span> &amp;&amp;</span><br><span class="line">            mCustomResolverComponentName.getPackageName().equals(pkg.packageName)) &#123;</span><br><span class="line">        setUpCustomResolverActivity(pkg);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//【3】处理包名为 "android" 的 apk，也就是 framework-res.apk，属于系统平台包！</span></span><br><span class="line">    <span class="keyword">if</span> (pkg.packageName.equals(<span class="string">"android"</span>)) &#123;</span><br><span class="line">        <span class="keyword">synchronized</span> (mPackages) &#123;</span><br><span class="line">            <span class="keyword">if</span> (mAndroidApplication != <span class="keyword">null</span>) &#123;</span><br><span class="line">                Slog.w(TAG, <span class="string">"*************************************************"</span>);</span><br><span class="line">                Slog.w(TAG, <span class="string">"Core android package being redefined.  Skipping."</span>);</span><br><span class="line">                Slog.w(TAG, <span class="string">" file="</span> + scanFile);</span><br><span class="line">                Slog.w(TAG, <span class="string">"*************************************************"</span>);</span><br><span class="line">                <span class="keyword">throw</span> <span class="keyword">new</span> PackageManagerException(INSTALL_FAILED_DUPLICATE_PACKAGE,</span><br><span class="line">                        <span class="string">"Core android package being redefined.  Skipping."</span>);</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            <span class="keyword">if</span> ((scanFlags &amp; SCAN_CHECK_ONLY) == <span class="number">0</span>) &#123; <span class="comment">// 进入该分支，设置系统平台包相关的属性！</span></span><br><span class="line">                <span class="comment">// Set up information for our fall-back user intent resolution activity.</span></span><br><span class="line">                mPlatformPackage = pkg;</span><br><span class="line">                pkg.mVersionCode = mSdkVersion;</span><br><span class="line">                mAndroidApplication = pkg.applicationInfo;</span><br><span class="line"></span><br><span class="line">                <span class="keyword">if</span> (!mResolverReplaced) &#123; <span class="comment">// 建立 ResolverActivity 的内存对象。</span></span><br><span class="line">                    mResolveActivity.applicationInfo = mAndroidApplication;</span><br><span class="line">                    mResolveActivity.name = ResolverActivity.class.getName();</span><br><span class="line">                    mResolveActivity.packageName = mAndroidApplication.packageName;</span><br><span class="line">                    mResolveActivity.processName = <span class="string">"system:ui"</span>;</span><br><span class="line">                    mResolveActivity.launchMode = ActivityInfo.LAUNCH_MULTIPLE;</span><br><span class="line">                    mResolveActivity.documentLaunchMode = ActivityInfo.DOCUMENT_LAUNCH_NEVER;</span><br><span class="line">                    mResolveActivity.flags = ActivityInfo.FLAG_EXCLUDE_FROM_RECENTS;</span><br><span class="line">                    mResolveActivity.theme = R.style.Theme_Material_Dialog_Alert;</span><br><span class="line">                    mResolveActivity.exported = <span class="keyword">true</span>;</span><br><span class="line">                    mResolveActivity.enabled = <span class="keyword">true</span>;</span><br><span class="line">                    mResolveActivity.resizeMode = ActivityInfo.RESIZE_MODE_RESIZEABLE;</span><br><span class="line">                    mResolveActivity.configChanges = ActivityInfo.CONFIG_SCREEN_SIZE</span><br><span class="line">                            | ActivityInfo.CONFIG_SMALLEST_SCREEN_SIZE</span><br><span class="line">                            | ActivityInfo.CONFIG_SCREEN_LAYOUT</span><br><span class="line">                            | ActivityInfo.CONFIG_ORIENTATION</span><br><span class="line">                            | ActivityInfo.CONFIG_KEYBOARD</span><br><span class="line">                            | ActivityInfo.CONFIG_KEYBOARD_HIDDEN;</span><br><span class="line">                    mResolveInfo.activityInfo = mResolveActivity;</span><br><span class="line">                    mResolveInfo.priority = <span class="number">0</span>;</span><br><span class="line">                    mResolveInfo.preferredOrder = <span class="number">0</span>;</span><br><span class="line">                    mResolveInfo.match = <span class="number">0</span>;</span><br><span class="line">                    mResolveComponentName = <span class="keyword">new</span> ComponentName(</span><br><span class="line">                            mAndroidApplication.packageName, mResolveActivity.name);</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (DEBUG_PACKAGE_SCANNING) &#123;</span><br><span class="line">        <span class="keyword">if</span> ((policyFlags &amp; PackageParser.PARSE_CHATTY) != <span class="number">0</span>)</span><br><span class="line">            Log.d(TAG, <span class="string">"Scanning package "</span> + pkg.packageName);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">synchronized</span> (mPackages) &#123;</span><br><span class="line">        <span class="comment">//【4】如果 PMS.mPackages 已经包含当前的 Package，说明这个包已经被扫描过了，抛异常，不继续处理！</span></span><br><span class="line">        <span class="keyword">if</span> (mPackages.containsKey(pkg.packageName)</span><br><span class="line">                || mSharedLibraries.containsKey(pkg.packageName)) &#123;</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> PackageManagerException(INSTALL_FAILED_DUPLICATE_PACKAGE,</span><br><span class="line">                    <span class="string">"Application package "</span> + pkg.packageName</span><br><span class="line">                            + <span class="string">" already installed.  Skipping duplicate."</span>);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">        <span class="comment">//【5】系统 apk 不进入这个分支，SCAN_REQUIRE_KNOWN 只有在扫描 data 分区是才会被设置！！</span></span><br><span class="line">        <span class="keyword">if</span> ((scanFlags &amp; SCAN_REQUIRE_KNOWN) != <span class="number">0</span>) &#123;</span><br><span class="line">            <span class="comment">//【5.1】扫描 data 分区时，会判断 mExpectingBetter 中是否包含该 package！</span></span><br><span class="line">            <span class="keyword">if</span> (mExpectingBetter.containsKey(pkg.packageName)) &#123;</span><br><span class="line">                logCriticalInfo(Log.WARN,</span><br><span class="line">                        <span class="string">"Relax SCAN_REQUIRE_KNOWN requirement for package "</span> + pkg.packageName);</span><br><span class="line">            &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                PackageSetting known = mSettings.peekPackageLPr(pkg.packageName);</span><br><span class="line">                <span class="keyword">if</span> (known != <span class="keyword">null</span>) &#123;</span><br><span class="line">                    <span class="keyword">if</span> (DEBUG_PACKAGE_SCANNING) &#123;</span><br><span class="line">                        Log.d(TAG, <span class="string">"Examining "</span> + pkg.codePath</span><br><span class="line">                                + <span class="string">" and requiring known paths "</span> + known.codePathString</span><br><span class="line">                                + <span class="string">" &amp; "</span> + known.resourcePathString);</span><br><span class="line">                    &#125;</span><br><span class="line">                    <span class="keyword">if</span> (!pkg.applicationInfo.getCodePath().equals(known.codePathString)</span><br><span class="line">                            || !pkg.applicationInfo.getResourcePath().equals(</span><br><span class="line">                            known.resourcePathString)) &#123;</span><br><span class="line">                        <span class="keyword">throw</span> <span class="keyword">new</span> PackageManagerException(INSTALL_FAILED_PACKAGE_CHANGED,</span><br><span class="line">                                <span class="string">"Application package "</span> + pkg.packageName</span><br><span class="line">                                        + <span class="string">" found at "</span> + pkg.applicationInfo.getCodePath()</span><br><span class="line">                                        + <span class="string">" but expected at "</span> + known.codePathString</span><br><span class="line">                                        + <span class="string">"; ignoring."</span>);</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//【6】获得扫描到的 apk 和资源的路径，下面会用到！</span></span><br><span class="line">    File destCodeFile = <span class="keyword">new</span> File(pkg.applicationInfo.getCodePath());</span><br><span class="line">    File destResourceFile = <span class="keyword">new</span> File(pkg.applicationInfo.getResourcePath());</span><br><span class="line"></span><br><span class="line">    SharedUserSetting suid = <span class="keyword">null</span>;</span><br><span class="line">    PackageSetting pkgSetting = <span class="keyword">null</span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//【7】系统 apk 才能有 mOriginalPackages，mRealPackage 和 mAdoptPermissions！</span></span><br><span class="line">    <span class="keyword">if</span> (!isSystemApp(pkg)) &#123;</span><br><span class="line">        pkg.mOriginalPackages = <span class="keyword">null</span>;</span><br><span class="line">        pkg.mRealPackage = <span class="keyword">null</span>;</span><br><span class="line">        pkg.mAdoptPermissions = <span class="keyword">null</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// Getting the package setting may have a side-effect, so if we</span></span><br><span class="line">    <span class="comment">// are only checking if scan would succeed, stash a copy of the</span></span><br><span class="line">    <span class="comment">// old setting to restore at the end.</span></span><br><span class="line">    PackageSetting nonMutatedPs = <span class="keyword">null</span>;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="keyword">synchronized</span> (mPackages) &#123;</span><br><span class="line">        <span class="comment">//【8】当前的系统（三方） package 是共享 uid 的，要判断其对应的共享 uid 是否存在，</span></span><br><span class="line">        <span class="comment">// 不存在就抛出异常！</span></span><br><span class="line">        <span class="keyword">if</span> (pkg.mSharedUserId != <span class="keyword">null</span>) &#123;</span><br><span class="line">            suid = mSettings.getSharedUserLPw(pkg.mSharedUserId, <span class="number">0</span>, <span class="number">0</span>, <span class="keyword">true</span>);</span><br><span class="line">            <span class="keyword">if</span> (suid == <span class="keyword">null</span>) &#123;</span><br><span class="line">                <span class="keyword">throw</span> <span class="keyword">new</span> PackageManagerException(INSTALL_FAILED_INSUFFICIENT_STORAGE,</span><br><span class="line">                        <span class="string">"Creating application package "</span> + pkg.packageName</span><br><span class="line">                        + <span class="string">" for shared user failed"</span>);</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            <span class="keyword">if</span> (DEBUG_PACKAGE_SCANNING) &#123;</span><br><span class="line">                <span class="keyword">if</span> ((policyFlags &amp; PackageParser.PARSE_CHATTY) != <span class="number">0</span>)</span><br><span class="line">                    Log.d(TAG, <span class="string">"Shared UserID "</span> + pkg.mSharedUserId + <span class="string">" (uid="</span> + suid.userId</span><br><span class="line">                            + <span class="string">"): packages="</span> + suid.packages);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">        <span class="comment">//【9】对于系统 package，如果有源包，那就要尝试将 package 的名字改为源包的名字！</span></span><br><span class="line">        <span class="comment">// 需要找到一个合适的源包，用来改名！</span></span><br><span class="line">        PackageSetting origPackage = <span class="keyword">null</span>;</span><br><span class="line">        String realName = <span class="keyword">null</span></span><br><span class="line">        <span class="keyword">if</span> (pkg.mOriginalPackages != <span class="keyword">null</span>) &#123;</span><br><span class="line">            <span class="keyword">final</span> String renamed = mSettings.mRenamedPackages.get(pkg.mRealPackage);</span><br><span class="line">            <span class="comment">//【9.1】如果当前 package 被重命名过，并且有源包的名字是重命名前的名字，就将 package 的名字改为以前的！</span></span><br><span class="line">            <span class="keyword">if</span> (pkg.mOriginalPackages.contains(renamed)) &#123;</span><br><span class="line">                realName = pkg.mRealPackage;</span><br><span class="line">                <span class="keyword">if</span> (!pkg.packageName.equals(renamed)) &#123;</span><br><span class="line">                    pkg.setPackageName(renamed);</span><br><span class="line">                &#125;</span><br><span class="line"></span><br><span class="line">            &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                <span class="keyword">for</span> (<span class="keyword">int</span> i=pkg.mOriginalPackages.size()-<span class="number">1</span>; i&gt;=<span class="number">0</span>; i--) &#123;</span><br><span class="line">                    <span class="keyword">if</span> ((origPackage = mSettings.peekPackageLPr(</span><br><span class="line">                            pkg.mOriginalPackages.get(i))) != <span class="keyword">null</span>) &#123;</span><br><span class="line">                        <span class="comment">//【9.2】对当前 package 和其源包进行校验</span></span><br><span class="line">                        <span class="comment">// 如果源包是非系统 package，不是同一分区，无法重命名为源包名，返回 false；</span></span><br><span class="line">                        <span class="comment">// 或者源包是系统 package，但是 PMS.mPackage 中仍然有其扫描数据，源包仍然存在，返回 false；</span></span><br><span class="line">                        <span class="keyword">if</span> (!verifyPackageUpdateLPr(origPackage, pkg)) &#123;</span><br><span class="line">                            origPackage = <span class="keyword">null</span>;</span><br><span class="line">                            <span class="keyword">continue</span>;</span><br><span class="line">                            </span><br><span class="line">                        &#125; <span class="keyword">else</span> <span class="keyword">if</span> (origPackage.sharedUser != <span class="keyword">null</span>) &#123;</span><br><span class="line">                            <span class="comment">//【9.3】源包是系统 package，并且共享用户 uid；</span></span><br><span class="line">                            <span class="comment">// 如果当前的 package 和源包的共享 uid 不匹配，也会返回 false！</span></span><br><span class="line">                            <span class="comment">// 表示无法迁移数据；</span></span><br><span class="line">                            <span class="keyword">if</span> (!origPackage.sharedUser.name.equals(pkg.mSharedUserId)) &#123;</span><br><span class="line">                                Slog.w(TAG, <span class="string">"Unable to migrate data from "</span> + origPackage.name</span><br><span class="line">                                        + <span class="string">" to "</span> + pkg.packageName + <span class="string">": old uid "</span></span><br><span class="line">                                        + origPackage.sharedUser.name</span><br><span class="line">                                        + <span class="string">" differs from "</span> + pkg.mSharedUserId);</span><br><span class="line">                                origPackage = <span class="keyword">null</span>;</span><br><span class="line">                                <span class="keyword">continue</span>;</span><br><span class="line">                            &#125;</span><br><span class="line">                        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                            <span class="comment">// 可以看到，如果找到用于重命名的源包，origPackage 不会为 null！</span></span><br><span class="line">                            <span class="keyword">if</span> (DEBUG_UPGRADE) Log.v(TAG, <span class="string">"Renaming new package "</span></span><br><span class="line">                                    + pkg.packageName + <span class="string">" to old name "</span> + origPackage.name);</span><br><span class="line">                        &#125;</span><br><span class="line">                        <span class="keyword">break</span>;</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">   </span><br><span class="line">        <span class="comment">// mTransferedPackages 用于保存那些自身数据已经被转移到其他 package 的 package！</span></span><br><span class="line">        <span class="keyword">if</span> (mTransferedPackages.contains(pkg.packageName)) &#123;</span><br><span class="line">            Slog.w(TAG, <span class="string">"Package "</span> + pkg.packageName</span><br><span class="line">                    + <span class="string">" was transferred to another, but its .apk remains"</span>);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// See comments in nonMutatedPs declaration</span></span><br><span class="line">        <span class="keyword">if</span> ((scanFlags &amp; SCAN_CHECK_ONLY) != <span class="number">0</span>) &#123;</span><br><span class="line">            PackageSetting foundPs = mSettings.peekPackageLPr(pkg.packageName);</span><br><span class="line">            <span class="keyword">if</span> (foundPs != <span class="keyword">null</span>) &#123;</span><br><span class="line">                nonMutatedPs = <span class="keyword">new</span> PackageSetting(foundPs);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        </span><br><span class="line">        <span class="comment">//【3.2.1.7.1.1】获得当前扫描的这个 package 对应的 packageSetting 对象，如果已经存在就直接返回，</span></span><br><span class="line">        <span class="comment">// 不存在就创建！如果 origPackage 不为 null，创建新的需要重命名为源包的名字！</span></span><br><span class="line">        pkgSetting = mSettings.getPackageLPw(pkg, origPackage, realName, suid, destCodeFile,</span><br><span class="line">                destResourceFile, pkg.applicationInfo.nativeLibraryRootDir,</span><br><span class="line">                pkg.applicationInfo.primaryCpuAbi,</span><br><span class="line">                pkg.applicationInfo.secondaryCpuAbi,</span><br><span class="line">                pkg.applicationInfo.flags, pkg.applicationInfo.privateFlags,</span><br><span class="line">                user, <span class="keyword">false</span>);</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (pkgSetting == <span class="keyword">null</span>) &#123;</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> PackageManagerException(INSTALL_FAILED_INSUFFICIENT_STORAGE,</span><br><span class="line">                    <span class="string">"Creating application package "</span> + pkg.packageName + <span class="string">" failed"</span>);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment">//【11】对于系统 package，如果 origPackage 不为 null，改名为源包的名字！</span></span><br><span class="line">        <span class="keyword">if</span> (pkgSetting.origPackage != <span class="keyword">null</span>) &#123;</span><br><span class="line">            pkg.setPackageName(origPackage.name);</span><br><span class="line"></span><br><span class="line">            String msg = <span class="string">"New package "</span> + pkgSetting.realName</span><br><span class="line">                    + <span class="string">" renamed to replace old package "</span> + pkgSetting.name;</span><br><span class="line">            reportSettingsProblem(Log.WARN, msg);</span><br><span class="line"></span><br><span class="line">            <span class="keyword">if</span> ((scanFlags &amp; SCAN_CHECK_ONLY) == <span class="number">0</span>) &#123; </span><br><span class="line">                <span class="comment">// 如果没有设置 SCAN_CHECK_ONLY，并且源包是存在的，就将源包添加到 mTransferedPackages 中！</span></span><br><span class="line">                mTransferedPackages.add(origPackage.name);</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            <span class="comment">// 清空 originPackage 属性！</span></span><br><span class="line">            pkgSetting.origPackage = <span class="keyword">null</span>;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> ((scanFlags &amp; SCAN_CHECK_ONLY) == <span class="number">0</span> &amp;&amp; realName != <span class="keyword">null</span>) &#123;</span><br><span class="line">            mTransferedPackages.add(pkg.packageName);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment">//【12】如果当前的系统 apk 被覆盖更新过，就添加 ApplicationInfo.FLAG_UPDATED_SYSTEM_APP 标签！</span></span><br><span class="line">        <span class="keyword">if</span> (mSettings.isDisabledSystemPackageLPr(pkg.packageName)) &#123; </span><br><span class="line">            pkg.applicationInfo.flags |= ApplicationInfo.FLAG_UPDATED_SYSTEM_APP;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> ((policyFlags &amp; PackageParser.PARSE_IS_SYSTEM_DIR) == <span class="number">0</span>) &#123;</span><br><span class="line">            updateSharedLibrariesLPw(pkg, <span class="keyword">null</span>);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (mFoundPolicyFile) &#123;</span><br><span class="line">            <span class="comment">//【13】给当前的 Package 分配一个标签，用于 seLinux！</span></span><br><span class="line">            SELinuxMMAC.assignSeinfoValue(pkg);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        pkg.applicationInfo.uid = pkgSetting.appId;</span><br><span class="line">        pkg.mExtras = pkgSetting;</span><br><span class="line"></span><br><span class="line">        <span class="comment">//【13】处理 keySet 更新和签名校验！</span></span><br><span class="line">        <span class="keyword">if</span> (shouldCheckUpgradeKeySetLP(pkgSetting, scanFlags)) &#123;</span><br><span class="line">            <span class="keyword">if</span> (checkUpgradeKeySetLP(pkgSetting, pkg)) &#123;</span><br><span class="line">                <span class="comment">// 签名正确，更新本地的签名信息！</span></span><br><span class="line">                pkgSetting.signatures.mSignatures = pkg.mSignatures;</span><br><span class="line">            &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                <span class="comment">// 签名异常处理</span></span><br><span class="line">                <span class="keyword">if</span> ((policyFlags &amp; PackageParser.PARSE_IS_SYSTEM_DIR) == <span class="number">0</span>) &#123;</span><br><span class="line">                    <span class="keyword">throw</span> <span class="keyword">new</span> PackageManagerException(INSTALL_FAILED_UPDATE_INCOMPATIBLE,</span><br><span class="line">                            <span class="string">"Package "</span> + pkg.packageName + <span class="string">" upgrade keys do not match the "</span></span><br><span class="line">                            + <span class="string">"previously installed version"</span>);</span><br><span class="line">                &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                    pkgSetting.signatures.mSignatures = pkg.mSignatures;</span><br><span class="line">                    String msg = <span class="string">"System package "</span> + pkg.packageName</span><br><span class="line">                        + <span class="string">" signature changed; retaining data."</span>;</span><br><span class="line">                    reportSettingsProblem(Log.WARN, msg);</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            <span class="comment">// 如果不检查 KetSet 更新的话，就直接校验签名！</span></span><br><span class="line">            <span class="keyword">try</span> &#123;</span><br><span class="line">                verifySignaturesLP(pkgSetting, pkg);</span><br><span class="line">                pkgSetting.signatures.mSignatures = pkg.mSignatures;</span><br><span class="line">                </span><br><span class="line">            &#125; <span class="keyword">catch</span> (PackageManagerException e) &#123;</span><br><span class="line">                <span class="keyword">if</span> ((policyFlags &amp; PackageParser.PARSE_IS_SYSTEM_DIR) == <span class="number">0</span>) &#123;</span><br><span class="line">                    <span class="keyword">throw</span> e;</span><br><span class="line">                &#125;</span><br><span class="line">                <span class="comment">// 如果签名校验出现问题，这里会先恢复成本次解析的签名！</span></span><br><span class="line">                pkgSetting.signatures.mSignatures = pkg.mSignatures;</span><br><span class="line">                <span class="comment">// 但是如果是 sharedUser 的情况，就会报错！</span></span><br><span class="line">                <span class="keyword">if</span> (pkgSetting.sharedUser != <span class="keyword">null</span>) &#123;</span><br><span class="line">                    <span class="keyword">if</span> (compareSignatures(pkgSetting.sharedUser.signatures.mSignatures,</span><br><span class="line">                                          pkg.mSignatures) != PackageManager.SIGNATURE_MATCH) &#123;</span><br><span class="line">                        <span class="keyword">throw</span> <span class="keyword">new</span> PackageManagerException(</span><br><span class="line">                                INSTALL_PARSE_FAILED_INCONSISTENT_CERTIFICATES,</span><br><span class="line">                                        <span class="string">"Signature mismatch for shared user: "</span></span><br><span class="line">                                        + pkgSetting.sharedUser);</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;</span><br><span class="line">                String msg = <span class="string">"System package "</span> + pkg.packageName</span><br><span class="line">                    + <span class="string">" signature changed; retaining data."</span>;</span><br><span class="line">                reportSettingsProblem(Log.WARN, msg);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment">//【14】安装的时候才会进入这个分支，这里不看！</span></span><br><span class="line">        <span class="comment">// 判断这个 package 使用的 content providers 是否和已经存在 package 冲突！</span></span><br><span class="line">        <span class="keyword">if</span> ((scanFlags &amp; SCAN_NEW_INSTALL) != <span class="number">0</span>) &#123; </span><br><span class="line">            <span class="keyword">final</span> <span class="keyword">int</span> N = pkg.providers.size();</span><br><span class="line">            <span class="keyword">int</span> i;</span><br><span class="line">            <span class="keyword">for</span> (i=<span class="number">0</span>; i&lt;N; i++) &#123;</span><br><span class="line">                PackageParser.Provider p = pkg.providers.get(i);</span><br><span class="line">                <span class="keyword">if</span> (p.info.authority != <span class="keyword">null</span>) &#123;</span><br><span class="line">                    String names[] = p.info.authority.split(<span class="string">";"</span>);</span><br><span class="line">                    <span class="keyword">for</span> (<span class="keyword">int</span> j = <span class="number">0</span>; j &lt; names.length; j++) &#123;</span><br><span class="line">                        <span class="keyword">if</span> (mProvidersByAuthority.containsKey(names[j])) &#123;</span><br><span class="line">                            PackageParser.Provider other = mProvidersByAuthority.get(names[j]);</span><br><span class="line">                            <span class="keyword">final</span> String otherPackageName =</span><br><span class="line">                                    ((other != <span class="keyword">null</span> &amp;&amp; other.getComponentName() != <span class="keyword">null</span>) ?</span><br><span class="line">                                            other.getComponentName().getPackageName() : <span class="string">"?"</span>);</span><br><span class="line">                            <span class="keyword">throw</span> <span class="keyword">new</span> PackageManagerException(</span><br><span class="line">                                    INSTALL_FAILED_CONFLICTING_PROVIDER,</span><br><span class="line">                                            <span class="string">"Can't install because provider name "</span> + names[j]</span><br><span class="line">                                            + <span class="string">" (in package "</span> + pkg.applicationInfo.packageName</span><br><span class="line">                                            + <span class="string">") is already used by "</span> + otherPackageName);</span><br><span class="line">                        &#125;</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment">//【15】同样的，只有系统 apk 才能进入该分支，用于权限继承！</span></span><br><span class="line">        <span class="keyword">if</span> ((scanFlags &amp; SCAN_CHECK_ONLY) == <span class="number">0</span> &amp;&amp; pkg.mAdoptPermissions != <span class="keyword">null</span>) &#123;</span><br><span class="line">            <span class="keyword">for</span> (<span class="keyword">int</span> i = pkg.mAdoptPermissions.size() - <span class="number">1</span>; i &gt;= <span class="number">0</span>; i--) &#123;</span><br><span class="line">                <span class="keyword">final</span> String origName = pkg.mAdoptPermissions.get(i);</span><br><span class="line">                <span class="keyword">final</span> PackageSetting orig = mSettings.peekPackageLPr(origName);</span><br><span class="line">                <span class="keyword">if</span> (orig != <span class="keyword">null</span>) &#123;</span><br><span class="line">                    <span class="comment">//【15.1】校验要被继承权限的 package 一是否存在，二是否是系统应用！</span></span><br><span class="line">                    <span class="comment">// 条件不满足，无法权限继承！</span></span><br><span class="line">                    <span class="keyword">if</span> (verifyPackageUpdateLPr(orig, pkg)) &#123;</span><br><span class="line">                        Slog.i(TAG, <span class="string">"Adopting permissions from "</span> + origName + <span class="string">" to "</span></span><br><span class="line">                                + pkg.packageName);</span><br><span class="line">                        mSettings.transferPermissionsLPw(origName, pkg.packageName);</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">final</span> String pkgName = pkg.packageName;</span><br><span class="line">    <span class="comment">// 从 base.apk 和其 split.apk（如果有）中选择修改时间最晚的作为扫描时间！</span></span><br><span class="line">    <span class="keyword">final</span> <span class="keyword">long</span> scanFileTime = getLastModifiedTime(pkg, scanFile);</span><br><span class="line">    <span class="keyword">final</span> <span class="keyword">boolean</span> forceDex = (scanFlags &amp; SCAN_FORCE_DEX) != <span class="number">0</span>; <span class="comment">// 没用到，应该是废弃代码！</span></span><br><span class="line">    </span><br><span class="line">    <span class="comment">//【16】设置 pacakge 对应的进程名，如果 processName 为 null，默认进程名为包名！</span></span><br><span class="line">    pkg.applicationInfo.processName = fixProcessName(</span><br><span class="line">            pkg.applicationInfo.packageName,</span><br><span class="line">            pkg.applicationInfo.processName,</span><br><span class="line">            pkg.applicationInfo.uid);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (pkg != mPlatformPackage) &#123;</span><br><span class="line">        <span class="comment">// Get all of our default paths setup</span></span><br><span class="line">        pkg.applicationInfo.initForUser(UserHandle.USER_SYSTEM);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">final</span> String path = scanFile.getPath();</span><br><span class="line">    <span class="keyword">final</span> String cpuAbiOverride = deriveAbiOverride(pkg.cpuAbiOverride, pkgSetting);</span><br><span class="line"></span><br><span class="line">    <span class="comment">//【17】下面是设置本地库和系统平台相关的属性！！</span></span><br><span class="line">    <span class="keyword">if</span> ((scanFlags &amp; SCAN_NEW_INSTALL) == <span class="number">0</span>) &#123;</span><br><span class="line">        derivePackageAbi(pkg, scanFile, cpuAbiOverride, <span class="keyword">true</span> <span class="comment">/* extract libs */</span>);</span><br><span class="line">        <span class="keyword">if</span> (isSystemApp(pkg) &amp;&amp; !pkg.isUpdatedSystemApp() &amp;&amp;</span><br><span class="line">                pkg.applicationInfo.primaryCpuAbi == <span class="keyword">null</span>) &#123;</span><br><span class="line">            setBundledAppAbisAndRoots(pkg, pkgSetting);</span><br><span class="line">            setNativeLibraryPaths(pkg);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        <span class="keyword">if</span> ((scanFlags &amp; SCAN_MOVE) != <span class="number">0</span>) &#123;</span><br><span class="line">            pkg.applicationInfo.primaryCpuAbi = pkgSetting.primaryCpuAbiString;</span><br><span class="line">            pkg.applicationInfo.secondaryCpuAbi = pkgSetting.secondaryCpuAbiString;</span><br><span class="line">        &#125;</span><br><span class="line">        setNativeLibraryPaths(pkg);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (mPlatformPackage == pkg) &#123;</span><br><span class="line">        pkg.applicationInfo.primaryCpuAbi = VMRuntime.getRuntime().is64Bit() ?</span><br><span class="line">                Build.SUPPORTED_64_BIT_ABIS[<span class="number">0</span>] : Build.SUPPORTED_32_BIT_ABIS[<span class="number">0</span>];</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> ((scanFlags &amp; SCAN_NO_DEX) == <span class="number">0</span> &amp;&amp; (scanFlags &amp; SCAN_NEW_INSTALL) != <span class="number">0</span>) &#123;</span><br><span class="line">        <span class="keyword">if</span> (cpuAbiOverride == <span class="keyword">null</span> &amp;&amp; pkgSetting.cpuAbiOverrideString != <span class="keyword">null</span>) &#123;</span><br><span class="line">            Slog.w(TAG, <span class="string">"Ignoring persisted ABI override "</span> + cpuAbiOverride +</span><br><span class="line">                    <span class="string">" for package "</span> + pkg.packageName);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    pkgSetting.primaryCpuAbiString = pkg.applicationInfo.primaryCpuAbi;</span><br><span class="line">    pkgSetting.secondaryCpuAbiString = pkg.applicationInfo.secondaryCpuAbi;</span><br><span class="line">    pkgSetting.cpuAbiOverrideString = cpuAbiOverride;</span><br><span class="line"></span><br><span class="line">    pkg.cpuAbiOverride = cpuAbiOverride;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (DEBUG_ABI_SELECTION) &#123;</span><br><span class="line">        Slog.d(TAG, <span class="string">"Resolved nativeLibraryRoot for "</span> + pkg.applicationInfo.packageName</span><br><span class="line">                + <span class="string">" to root="</span> + pkg.applicationInfo.nativeLibraryRootDir + <span class="string">", isa="</span></span><br><span class="line">                + pkg.applicationInfo.nativeLibraryRootRequiresIsa);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    pkgSetting.legacyNativeLibraryPathString = pkg.applicationInfo.nativeLibraryRootDir;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (DEBUG_ABI_SELECTION) &#123;</span><br><span class="line">        Log.d(TAG, <span class="string">"Abis for package["</span> + pkg.packageName + <span class="string">"] are"</span> +</span><br><span class="line">                <span class="string">" primary="</span> + pkg.applicationInfo.primaryCpuAbi +</span><br><span class="line">                <span class="string">" secondary="</span> + pkg.applicationInfo.secondaryCpuAbi);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> ((scanFlags &amp; SCAN_BOOTING) == <span class="number">0</span> &amp;&amp; pkgSetting.sharedUser != <span class="keyword">null</span>) &#123;</span><br><span class="line">        adjustCpuAbisForSharedUserLPw(pkgSetting.sharedUser.packages,</span><br><span class="line">                pkg, <span class="keyword">true</span> <span class="comment">/* boot complete */</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (mFactoryTest &amp;&amp; pkg.requestedPermissions.contains(</span><br><span class="line">            android.Manifest.permission.FACTORY_TEST)) &#123;</span><br><span class="line">        pkg.applicationInfo.flags |= ApplicationInfo.FLAG_FACTORY_TEST;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 如果是系统 package，设置 isOrphaned 的属性为 true！</span></span><br><span class="line">    <span class="keyword">if</span> (isSystemApp(pkg)) &#123;</span><br><span class="line">        pkgSetting.isOrphaned = <span class="keyword">true</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    ArrayList&lt;PackageParser.Package&gt; clientLibPkgs = <span class="keyword">null</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> ((scanFlags &amp; SCAN_CHECK_ONLY) != <span class="number">0</span>) &#123;</span><br><span class="line">        <span class="keyword">if</span> (nonMutatedPs != <span class="keyword">null</span>) &#123;</span><br><span class="line">            <span class="keyword">synchronized</span> (mPackages) &#123;</span><br><span class="line">                mSettings.mPackages.put(nonMutatedPs.name, nonMutatedPs);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> pkg;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//【18】处理特权 apk 的子包，只有特权 apk 才能添加子包；</span></span><br><span class="line">    <span class="comment">// 特权 apk 包括两部分：</span></span><br><span class="line">    <span class="comment">// 1、特定 uid 的 app</span></span><br><span class="line">    <span class="comment">// 2、framework-res.apk 和 system/priv-app 目录下的 apk！</span></span><br><span class="line">    <span class="keyword">if</span> (pkg.childPackages != <span class="keyword">null</span> &amp;&amp; !pkg.childPackages.isEmpty()) &#123;</span><br><span class="line">        <span class="keyword">if</span> ((policyFlags &amp; PARSE_IS_PRIVILEGED) == <span class="number">0</span>) &#123;</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> PackageManagerException(<span class="string">"Only privileged apps and updated "</span></span><br><span class="line">                    + <span class="string">"privileged apps can add child packages. Ignoring package "</span></span><br><span class="line">                    + pkg.packageName);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">final</span> <span class="keyword">int</span> childCount = pkg.childPackages.size();</span><br><span class="line">        <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; childCount; i++) &#123;</span><br><span class="line">            PackageParser.Package childPkg = pkg.childPackages.get(i);</span><br><span class="line">            <span class="keyword">if</span> (mSettings.hasOtherDisabledSystemPkgWithChildLPr(pkg.packageName,</span><br><span class="line">                    childPkg.packageName)) &#123;</span><br><span class="line">                <span class="keyword">throw</span> <span class="keyword">new</span> PackageManagerException(<span class="string">"Cannot override a child package of "</span></span><br><span class="line">                        + <span class="string">"another disabled system app. Ignoring package "</span> + pkg.packageName);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">synchronized</span> (mPackages) &#123;</span><br><span class="line">        <span class="comment">//【19】如果是系统 package，并且他之前更新过，就要尝试对共享库 lib 进行更新！</span></span><br><span class="line">        <span class="comment">// 只有系统 package 才能添加共享 lib</span></span><br><span class="line">        <span class="keyword">if</span> ((pkg.applicationInfo.flags &amp; ApplicationInfo.FLAG_SYSTEM) != <span class="number">0</span>) &#123;</span><br><span class="line">            <span class="keyword">if</span> (pkg.libraryNames != <span class="keyword">null</span>) &#123;</span><br><span class="line">                <span class="keyword">for</span> (<span class="keyword">int</span> i=<span class="number">0</span>; i&lt;pkg.libraryNames.size(); i++) &#123;</span><br><span class="line">                    String name = pkg.libraryNames.get(i);</span><br><span class="line">                    <span class="keyword">boolean</span> allowed = <span class="keyword">false</span>;</span><br><span class="line">                    <span class="keyword">if</span> (pkg.isUpdatedSystemApp()) &#123;</span><br><span class="line">                        <span class="keyword">final</span> PackageSetting sysPs = mSettings</span><br><span class="line">                                .getDisabledSystemPkgLPr(pkg.packageName);</span><br><span class="line">                        <span class="keyword">if</span> (sysPs.pkg != <span class="keyword">null</span> &amp;&amp; sysPs.pkg.libraryNames != <span class="keyword">null</span>) &#123;</span><br><span class="line">                            <span class="keyword">for</span> (<span class="keyword">int</span> j=<span class="number">0</span>; j&lt;sysPs.pkg.libraryNames.size(); j++) &#123;</span><br><span class="line">                                <span class="keyword">if</span> (name.equals(sysPs.pkg.libraryNames.get(j))) &#123;</span><br><span class="line">                                    allowed = <span class="keyword">true</span>;</span><br><span class="line">                                    <span class="keyword">break</span>;</span><br><span class="line">                                &#125;</span><br><span class="line">                            &#125;</span><br><span class="line">                        &#125;</span><br><span class="line">                    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                        allowed = <span class="keyword">true</span>;</span><br><span class="line">                    &#125;</span><br><span class="line">                    <span class="keyword">if</span> (allowed) &#123;</span><br><span class="line">                        <span class="keyword">if</span> (!mSharedLibraries.containsKey(name)) &#123;</span><br><span class="line">                            mSharedLibraries.put(name, <span class="keyword">new</span> SharedLibraryEntry(<span class="keyword">null</span>, pkg.packageName));</span><br><span class="line">                            </span><br><span class="line">                        &#125; <span class="keyword">else</span> <span class="keyword">if</span> (!name.equals(pkg.packageName)) &#123;</span><br><span class="line">                            Slog.w(TAG, <span class="string">"Package "</span> + pkg.packageName + <span class="string">" library "</span></span><br><span class="line">                                    + name + <span class="string">" already exists; skipping"</span>);</span><br><span class="line">                        &#125;</span><br><span class="line">                    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                        Slog.w(TAG, <span class="string">"Package "</span> + pkg.packageName + <span class="string">" declares lib "</span></span><br><span class="line">                                + name + <span class="string">" that is not declared on system image; skipping"</span>);</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;</span><br><span class="line">                <span class="keyword">if</span> ((scanFlags &amp; SCAN_BOOTING) == <span class="number">0</span>) &#123;</span><br><span class="line">                    <span class="comment">// 如果不是开机扫描，我们需要更新下该应用的共享库，对于开机扫描的情况，我们会在扫描完成后自动更新</span></span><br><span class="line">                    clientLibPkgs = updateAllSharedLibrariesLPw(pkg);</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//【20】处理和冻结相关的逻辑</span></span><br><span class="line">    <span class="keyword">if</span> ((scanFlags &amp; SCAN_BOOTING) != <span class="number">0</span>) &#123;</span><br><span class="line">        <span class="comment">// 如果是开机扫描，不需要冻结，因为没有应用在此时可以运行！</span></span><br><span class="line">    &#125; <span class="keyword">else</span> <span class="keyword">if</span> ((scanFlags &amp; SCAN_DONT_KILL_APP) != <span class="number">0</span>) &#123;</span><br><span class="line">        <span class="comment">// 如果扫描过程中不允许 kill app，那就不会冻结！</span></span><br><span class="line">    &#125; <span class="keyword">else</span> <span class="keyword">if</span> ((scanFlags &amp; SCAN_IGNORE_FROZEN) != <span class="number">0</span>) &#123;</span><br><span class="line">        <span class="comment">// 如果扫描过程中显式指定忽略冻结，那就不会冻结！</span></span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        <span class="comment">// 其他情况，我们会默认冻结该应用，防止其启动！</span></span><br><span class="line">        checkPackageFrozen(pkgName);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//【21】杀掉所以依赖于库文件的应用，因为库发生了更新！</span></span><br><span class="line">    <span class="keyword">if</span> (clientLibPkgs != <span class="keyword">null</span>) &#123;</span><br><span class="line">        <span class="keyword">for</span> (<span class="keyword">int</span> i=<span class="number">0</span>; i&lt;clientLibPkgs.size(); i++) &#123;</span><br><span class="line">            PackageParser.Package clientPkg = clientLibPkgs.get(i);</span><br><span class="line">            killApplication(clientPkg.applicationInfo.packageName,</span><br><span class="line">                    clientPkg.applicationInfo.uid, <span class="string">"update lib"</span>);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    KeySetManagerService ksms = mSettings.mKeySetManagerService; <span class="comment">// 校验 keyset 的真实性</span></span><br><span class="line">    ksms.assertScannedPackageValid(pkg);</span><br><span class="line"></span><br><span class="line">    Trace.traceBegin(TRACE_TAG_PACKAGE_MANAGER, <span class="string">"updateSettings"</span>); <span class="comment">// 记录 trace 事件！</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">boolean</span> createIdmapFailed = <span class="keyword">false</span>;</span><br><span class="line">    <span class="keyword">synchronized</span> (mPackages) &#123;</span><br><span class="line">        <span class="comment">// We don't expect installation to fail beyond this point</span></span><br><span class="line">        <span class="keyword">if</span> (pkgSetting.pkg != <span class="keyword">null</span>) &#123;</span><br><span class="line">            <span class="comment">// Note that |user| might be null during the initial boot scan. If a codePath</span></span><br><span class="line">            <span class="comment">// for an app has changed during a boot scan, it's due to an app update that's</span></span><br><span class="line">            <span class="comment">// part of the system partition and marker changes must be applied to all users.</span></span><br><span class="line">            maybeRenameForeignDexMarkers(pkgSetting.pkg, pkg,</span><br><span class="line">                (user != <span class="keyword">null</span>) ? user : UserHandle.ALL);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment">//【3.2.1.7.1.2 important】将新创建或者更新后的 PackageSetting 重新添加到 mSettings 中！</span></span><br><span class="line">        mSettings.insertPackageSettingLPw(pkgSetting, pkg);</span><br><span class="line">        </span><br><span class="line">        <span class="comment">//【important】将本次扫描的 Package 添加到 PMS.mPackages 中去！</span></span><br><span class="line">        mPackages.put(pkg.applicationInfo.packageName, pkg);</span><br><span class="line">        </span><br><span class="line">        <span class="comment">//【22】将当前的 package 从 mSettings.mPackagesToBeCleaned 中移除，防止被清除！</span></span><br><span class="line">        <span class="keyword">final</span> Iterator&lt;PackageCleanItem&gt; iter = mSettings.mPackagesToBeCleaned.iterator();</span><br><span class="line">        <span class="keyword">while</span> (iter.hasNext()) &#123;</span><br><span class="line">            PackageCleanItem item = iter.next();</span><br><span class="line">            <span class="keyword">if</span> (pkgName.equals(item.packageName)) &#123;</span><br><span class="line">                iter.remove();</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment">//【23】处理 package 的第一次安装时间和最近更新时间！</span></span><br><span class="line">        <span class="keyword">if</span> (currentTime != <span class="number">0</span>) &#123;</span><br><span class="line">            <span class="keyword">if</span> (pkgSetting.firstInstallTime == <span class="number">0</span>) &#123;</span><br><span class="line">                pkgSetting.firstInstallTime = pkgSetting.lastUpdateTime = currentTime;</span><br><span class="line"></span><br><span class="line">            &#125; <span class="keyword">else</span> <span class="keyword">if</span> ((scanFlags &amp; SCAN_UPDATE_TIME) != <span class="number">0</span>) &#123;</span><br><span class="line">                pkgSetting.lastUpdateTime = currentTime;</span><br><span class="line"></span><br><span class="line">            &#125;</span><br><span class="line">        &#125; <span class="keyword">else</span> <span class="keyword">if</span> (pkgSetting.firstInstallTime == <span class="number">0</span>) &#123;</span><br><span class="line">            pkgSetting.firstInstallTime = pkgSetting.lastUpdateTime = scanFileTime;</span><br><span class="line">            </span><br><span class="line">        &#125; <span class="keyword">else</span> <span class="keyword">if</span> ((policyFlags &amp; PackageParser.PARSE_IS_SYSTEM_DIR) != <span class="number">0</span>) &#123;</span><br><span class="line">            <span class="keyword">if</span> (scanFileTime != pkgSetting.timeStamp) &#123;</span><br><span class="line">                pkgSetting.lastUpdateTime = scanFileTime;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        ksms.addScannedPackageLPw(pkg); <span class="comment">// 将 package 的 KeySets 添加到 KeySetManagerService 中！</span></span><br><span class="line">       </span><br><span class="line">        <span class="comment">//【24】处理四大组件！ </span></span><br><span class="line">        <span class="comment">//【24.1】处理该 Package 中 的 Provider 信息，添加到 PMS.mProviders 中！</span></span><br><span class="line">        <span class="keyword">int</span> N = pkg.providers.size();</span><br><span class="line">        StringBuilder r = <span class="keyword">null</span>;</span><br><span class="line">        <span class="keyword">int</span> i;</span><br><span class="line">        <span class="keyword">for</span> (i=<span class="number">0</span>; i&lt;N; i++) &#123;</span><br><span class="line">            PackageParser.Provider p = pkg.providers.get(i);</span><br><span class="line">            p.info.processName = fixProcessName(pkg.applicationInfo.processName,</span><br><span class="line">                    p.info.processName, pkg.applicationInfo.uid);</span><br><span class="line">            mProviders.addProvider(p); <span class="comment">// 添加到 PMS.mProviders 中！</span></span><br><span class="line">            p.syncable = p.info.isSyncable;</span><br><span class="line">            <span class="keyword">if</span> (p.info.authority != <span class="keyword">null</span>) &#123;</span><br><span class="line">                String names[] = p.info.authority.split(<span class="string">";"</span>);</span><br><span class="line">                p.info.authority = <span class="keyword">null</span>;</span><br><span class="line">                <span class="keyword">for</span> (<span class="keyword">int</span> j = <span class="number">0</span>; j &lt; names.length; j++) &#123;</span><br><span class="line">                    <span class="keyword">if</span> (j == <span class="number">1</span> &amp;&amp; p.syncable) &#123;</span><br><span class="line">                        <span class="comment">// We only want the first authority for a provider to possibly be</span></span><br><span class="line">                        <span class="comment">// syncable, so if we already added this provider using a different</span></span><br><span class="line">                        <span class="comment">// authority clear the syncable flag. We copy the provider before</span></span><br><span class="line">                        <span class="comment">// changing it because the mProviders object contains a reference</span></span><br><span class="line">                        <span class="comment">// to a provider that we don't want to change.</span></span><br><span class="line">                        <span class="comment">// Only do this for the second authority since the resulting provider</span></span><br><span class="line">                        <span class="comment">// object can be the same for all future authorities for this provider.</span></span><br><span class="line">                        p = <span class="keyword">new</span> PackageParser.Provider(p);</span><br><span class="line">                        p.syncable = <span class="keyword">false</span>;</span><br><span class="line">                    &#125;</span><br><span class="line">                    <span class="keyword">if</span> (!mProvidersByAuthority.containsKey(names[j])) &#123;</span><br><span class="line">                        mProvidersByAuthority.put(names[j], p);</span><br><span class="line">                        <span class="keyword">if</span> (p.info.authority == <span class="keyword">null</span>) &#123;</span><br><span class="line">                            p.info.authority = names[j];</span><br><span class="line">                        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                            p.info.authority = p.info.authority + <span class="string">";"</span> + names[j];</span><br><span class="line">                        &#125;</span><br><span class="line">                        <span class="keyword">if</span> (DEBUG_PACKAGE_SCANNING) &#123;</span><br><span class="line">                            <span class="keyword">if</span> ((policyFlags &amp; PackageParser.PARSE_CHATTY) != <span class="number">0</span>)</span><br><span class="line">                                Log.d(TAG, <span class="string">"Registered content provider: "</span> + names[j]</span><br><span class="line">                                        + <span class="string">", className = "</span> + p.info.name + <span class="string">", isSyncable = "</span></span><br><span class="line">                                        + p.info.isSyncable);</span><br><span class="line">                        &#125;</span><br><span class="line">                    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                        PackageParser.Provider other = mProvidersByAuthority.get(names[j]);</span><br><span class="line">                        Slog.w(TAG, <span class="string">"Skipping provider name "</span> + names[j] +</span><br><span class="line">                                <span class="string">" (in package "</span> + pkg.applicationInfo.packageName +</span><br><span class="line">                                <span class="string">"): name already used by "</span></span><br><span class="line">                                + ((other != <span class="keyword">null</span> &amp;&amp; other.getComponentName() != <span class="keyword">null</span>)</span><br><span class="line">                                        ? other.getComponentName().getPackageName() : <span class="string">"?"</span>));</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">if</span> ((policyFlags&amp;PackageParser.PARSE_CHATTY) != <span class="number">0</span>) &#123;</span><br><span class="line">                <span class="keyword">if</span> (r == <span class="keyword">null</span>) &#123;</span><br><span class="line">                    r = <span class="keyword">new</span> StringBuilder(<span class="number">256</span>);</span><br><span class="line">                &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                    r.append(<span class="string">' '</span>);</span><br><span class="line">                &#125;</span><br><span class="line">                r.append(p.info.name);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">if</span> (r != <span class="keyword">null</span>) &#123;</span><br><span class="line">            <span class="keyword">if</span> (DEBUG_PACKAGE_SCANNING) Log.d(TAG, <span class="string">"  Providers: "</span> + r);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment">//【24.2】处理该 Package 中的 Service 信息，添加到 PMS.mService 中！</span></span><br><span class="line">        N = pkg.services.size();</span><br><span class="line">        r = <span class="keyword">null</span>;</span><br><span class="line">        <span class="keyword">for</span> (i=<span class="number">0</span>; i&lt;N; i++) &#123;</span><br><span class="line">            PackageParser.Service s = pkg.services.get(i);</span><br><span class="line">            s.info.processName = fixProcessName(pkg.applicationInfo.processName,</span><br><span class="line">                    s.info.processName, pkg.applicationInfo.uid);</span><br><span class="line">            mServices.addService(s); <span class="comment">// 添加到 PMS.mServices 中！</span></span><br><span class="line">            <span class="keyword">if</span> ((policyFlags&amp;PackageParser.PARSE_CHATTY) != <span class="number">0</span>) &#123;</span><br><span class="line">                <span class="keyword">if</span> (r == <span class="keyword">null</span>) &#123;</span><br><span class="line">                    r = <span class="keyword">new</span> StringBuilder(<span class="number">256</span>);</span><br><span class="line">                &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                    r.append(<span class="string">' '</span>);</span><br><span class="line">                &#125;</span><br><span class="line">                r.append(s.info.name);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">if</span> (r != <span class="keyword">null</span>) &#123;</span><br><span class="line">            <span class="keyword">if</span> (DEBUG_PACKAGE_SCANNING) Log.d(TAG, <span class="string">"  Services: "</span> + r);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment">//【24.3】处理该 Package 中的 BroadcastReceiver 信息,添加到 PMS.mReceivers 中。</span></span><br><span class="line">        N = pkg.receivers.size();</span><br><span class="line">        r = <span class="keyword">null</span>;</span><br><span class="line">        <span class="keyword">for</span> (i=<span class="number">0</span>; i&lt;N; i++) &#123;</span><br><span class="line">            PackageParser.Activity a = pkg.receivers.get(i);</span><br><span class="line">            a.info.processName = fixProcessName(pkg.applicationInfo.processName,</span><br><span class="line">                    a.info.processName, pkg.applicationInfo.uid);</span><br><span class="line">            mReceivers.addActivity(a, <span class="string">"receiver"</span>); <span class="comment">// 添加到 PMS.mReceivers 中！</span></span><br><span class="line">            <span class="keyword">if</span> ((policyFlags&amp;PackageParser.PARSE_CHATTY) != <span class="number">0</span>) &#123;</span><br><span class="line">                <span class="keyword">if</span> (r == <span class="keyword">null</span>) &#123;</span><br><span class="line">                    r = <span class="keyword">new</span> StringBuilder(<span class="number">256</span>);</span><br><span class="line">                &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                    r.append(<span class="string">' '</span>);</span><br><span class="line">                &#125;</span><br><span class="line">                r.append(a.info.name);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">if</span> (r != <span class="keyword">null</span>) &#123;</span><br><span class="line">            <span class="keyword">if</span> (DEBUG_PACKAGE_SCANNING) Log.d(TAG, <span class="string">"  Receivers: "</span> + r);</span><br><span class="line">        &#125;</span><br><span class="line">        </span><br><span class="line">        <span class="comment">//【24.4】处理该 Package 中的 activity 信息，添加到 PMS.mActivities 中！</span></span><br><span class="line">        N = pkg.activities.size();</span><br><span class="line">        r = <span class="keyword">null</span>;</span><br><span class="line">        <span class="keyword">for</span> (i=<span class="number">0</span>; i&lt;N; i++) &#123;</span><br><span class="line">            PackageParser.Activity a = pkg.activities.get(i);</span><br><span class="line">            a.info.processName = fixProcessName(pkg.applicationInfo.processName,</span><br><span class="line">                    a.info.processName, pkg.applicationInfo.uid);</span><br><span class="line">            mActivities.addActivity(a, <span class="string">"activity"</span>); <span class="comment">// 添加到 PMS.mActivities 中！</span></span><br><span class="line">            <span class="keyword">if</span> ((policyFlags&amp;PackageParser.PARSE_CHATTY) != <span class="number">0</span>) &#123;</span><br><span class="line">                <span class="keyword">if</span> (r == <span class="keyword">null</span>) &#123;</span><br><span class="line">                    r = <span class="keyword">new</span> StringBuilder(<span class="number">256</span>);</span><br><span class="line">                &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                    r.append(<span class="string">' '</span>);</span><br><span class="line">                &#125;</span><br><span class="line">                r.append(a.info.name);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">if</span> (r != <span class="keyword">null</span>) &#123;</span><br><span class="line">            <span class="keyword">if</span> (DEBUG_PACKAGE_SCANNING) Log.d(TAG, <span class="string">"  Activities: "</span> + r);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment">//【24.5】处理该 Package 中的 PermissionGroups 信息，添加到 PMS.mPermissionGroups 中！</span></span><br><span class="line">        N = pkg.permissionGroups.size();</span><br><span class="line">        r = <span class="keyword">null</span>;</span><br><span class="line">        <span class="keyword">for</span> (i=<span class="number">0</span>; i&lt;N; i++) &#123;</span><br><span class="line">            PackageParser.PermissionGroup pg = pkg.permissionGroups.get(i);</span><br><span class="line">            PackageParser.PermissionGroup cur = mPermissionGroups.get(pg.info.name);</span><br><span class="line">            <span class="keyword">final</span> String curPackageName = cur == <span class="keyword">null</span> ? <span class="keyword">null</span> : cur.info.packageName;</span><br><span class="line">            <span class="comment">//【5.1】如果 isPackageUpdate 为 true，说明要更新权限组的信息！</span></span><br><span class="line">            <span class="comment">// 如果 cur 为 null，说明是新添加的权限组信息！</span></span><br><span class="line">            <span class="keyword">final</span> <span class="keyword">boolean</span> isPackageUpdate = pg.info.packageName.equals(curPackageName);</span><br><span class="line">            <span class="keyword">if</span> (cur == <span class="keyword">null</span> || isPackageUpdate) &#123;</span><br><span class="line">                mPermissionGroups.put(pg.info.name, pg); <span class="comment">// 添加到 PMS.mPermissionGroups 中！</span></span><br><span class="line">                <span class="keyword">if</span> ((policyFlags&amp;PackageParser.PARSE_CHATTY) != <span class="number">0</span>) &#123;</span><br><span class="line">                    <span class="keyword">if</span> (r == <span class="keyword">null</span>) &#123;</span><br><span class="line">                        r = <span class="keyword">new</span> StringBuilder(<span class="number">256</span>);</span><br><span class="line">                    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                        r.append(<span class="string">' '</span>);</span><br><span class="line">                    &#125;</span><br><span class="line">                    <span class="keyword">if</span> (isPackageUpdate) &#123;</span><br><span class="line">                        r.append(<span class="string">"UPD:"</span>);</span><br><span class="line">                    &#125;</span><br><span class="line">                    r.append(pg.info.name);</span><br><span class="line">                &#125;</span><br><span class="line">            &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                Slog.w(TAG, <span class="string">"Permission group "</span> + pg.info.name + <span class="string">" from package "</span></span><br><span class="line">                        + pg.info.packageName + <span class="string">" ignored: original from "</span></span><br><span class="line">                        + cur.info.packageName);</span><br><span class="line">                <span class="keyword">if</span> ((policyFlags&amp;PackageParser.PARSE_CHATTY) != <span class="number">0</span>) &#123;</span><br><span class="line">                    <span class="keyword">if</span> (r == <span class="keyword">null</span>) &#123;</span><br><span class="line">                        r = <span class="keyword">new</span> StringBuilder(<span class="number">256</span>);</span><br><span class="line">                    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                        r.append(<span class="string">' '</span>);</span><br><span class="line">                    &#125;</span><br><span class="line">                    r.append(<span class="string">"DUP:"</span>);</span><br><span class="line">                    r.append(pg.info.name);</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">if</span> (r != <span class="keyword">null</span>) &#123;</span><br><span class="line">            <span class="keyword">if</span> (DEBUG_PACKAGE_SCANNING) Log.d(TAG, <span class="string">"  Permission Groups: "</span> + r);</span><br><span class="line">        &#125;</span><br><span class="line">        </span><br><span class="line">        <span class="comment">//【24.6】处理该 Package 中的定义 Permission 和 Permission-tree 信息！</span></span><br><span class="line">        N = pkg.permissions.size();</span><br><span class="line">        r = <span class="keyword">null</span>;</span><br><span class="line">        <span class="keyword">for</span> (i=<span class="number">0</span>; i&lt;N; i++) &#123;</span><br><span class="line">            PackageParser.Permission p = pkg.permissions.get(i);</span><br><span class="line">            <span class="comment">// 默认取消掉 PermissionInfo.FLAG_INSTALLED 标志位！</span></span><br><span class="line">            p.info.flags &amp;= ~PermissionInfo.FLAG_INSTALLED;</span><br><span class="line"></span><br><span class="line">            <span class="comment">//【6.1】设置权限所属的 group，前提是只有 Android5.1 以后才支持 Permission Groups！</span></span><br><span class="line">            <span class="keyword">if</span> (pkg.applicationInfo.targetSdkVersion &gt; Build.VERSION_CODES.LOLLIPOP_MR1) &#123;</span><br><span class="line">                p.group = mPermissionGroups.get(p.info.group);</span><br><span class="line">                <span class="keyword">if</span> (p.info.group != <span class="keyword">null</span> &amp;&amp; p.group == <span class="keyword">null</span>) &#123;</span><br><span class="line">                    Slog.w(TAG, <span class="string">"Permission "</span> + p.info.name + <span class="string">" from package "</span></span><br><span class="line">                            + p.info.packageName + <span class="string">" in an unknown group "</span> + p.info.group);</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            <span class="comment">//【6.2】从 Settings 中获得权限管理集合，如果该权限是一个 Permission-tree，</span></span><br><span class="line">            <span class="comment">// 那就返回 mSettings.mPermissionTrees；否则，返回 mSettings.mPermissions！</span></span><br><span class="line">            ArrayMap&lt;String, BasePermission&gt; permissionMap =</span><br><span class="line">                    p.tree ? mSettings.mPermissionTrees</span><br><span class="line">                            : mSettings.mPermissions;</span><br><span class="line"></span><br><span class="line">            <span class="comment">//【6.3】尝试获得上次安装时该权限对应的 BasePermission 对象！</span></span><br><span class="line">            BasePermission bp = permissionMap.get(p.info.name);</span><br><span class="line"></span><br><span class="line">            <span class="comment">//【6.4】允许系统应用来重新定义非系统权限！</span></span><br><span class="line">            <span class="comment">// 如果上次安装时的 BasePermission 不为 null，但是当前解析的 package 不是上次安装时该权限的定义者！</span></span><br><span class="line">            <span class="keyword">if</span> (bp != <span class="keyword">null</span> &amp;&amp; !Objects.equals(bp.sourcePackage, p.info.packageName)) &#123;</span><br><span class="line">                <span class="comment">//【6.4.1】判断上一次安装时，定义该权限的 package 是否是系统应用！</span></span><br><span class="line">                <span class="comment">// 如果是 currentOwnerIsSystem 为 true！</span></span><br><span class="line">                <span class="keyword">final</span> <span class="keyword">boolean</span> currentOwnerIsSystem = (bp.perm != <span class="keyword">null</span></span><br><span class="line">                        &amp;&amp; isSystemApp(bp.perm.owner));</span><br><span class="line">                </span><br><span class="line">                <span class="comment">// 如果当前解析的定义了该权限的 package 是系统 app，那么进入这里！     </span></span><br><span class="line">                <span class="keyword">if</span> (isSystemApp(p.owner)) &#123;</span><br><span class="line">                    <span class="comment">// 如果上次安装时，该权限是一个 BasePermission.TYPE_BUILTIN 系统权限，且 bp.perm 为 null，</span></span><br><span class="line">                    <span class="comment">// 即：拥有者未知，那么这里我们将这个 system package 分配给这个权限！</span></span><br><span class="line">                    <span class="keyword">if</span> (bp.type == BasePermission.TYPE_BUILTIN &amp;&amp; bp.perm == <span class="keyword">null</span>) &#123;</span><br><span class="line">                        bp.packageSetting = pkgSetting;</span><br><span class="line">                        bp.perm = p;</span><br><span class="line">                        bp.uid = pkg.applicationInfo.uid;</span><br><span class="line">                        bp.sourcePackage = p.info.packageName;</span><br><span class="line">                        p.info.flags |= PermissionInfo.FLAG_INSTALLED;</span><br><span class="line">                    </span><br><span class="line">                    <span class="comment">// 判断上一次安装时，定义该权限的 package 不是系统应用，而定义相同权限的</span></span><br><span class="line">                    <span class="comment">// 本次解析的 package 是系统应用，那么该权限会被系统应用重新定义！</span></span><br><span class="line">                    &#125; <span class="keyword">else</span> <span class="keyword">if</span> (!currentOwnerIsSystem) &#123;</span><br><span class="line">                        String msg = <span class="string">"New decl "</span> + p.owner + <span class="string">" of permission  "</span></span><br><span class="line">                                + p.info.name + <span class="string">" is system; overriding "</span> + bp.sourcePackage;</span><br><span class="line">                        reportSettingsProblem(Log.WARN, msg);</span><br><span class="line">                        <span class="comment">// 设置 bp 为 null！</span></span><br><span class="line">                        bp = <span class="keyword">null</span>;</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            <span class="comment">// 因为 bp 为 null，所谓我们会使用系统应用重新定义权限，如果是 permission-tree，会被添加到 </span></span><br><span class="line">            <span class="comment">// mSettings.mPermissionTrees 中！</span></span><br><span class="line">            <span class="keyword">if</span> (bp == <span class="keyword">null</span>) &#123;</span><br><span class="line">                bp = <span class="keyword">new</span> BasePermission(p.info.name, p.info.packageName,</span><br><span class="line">                        BasePermission.TYPE_NORMAL);</span><br><span class="line">                permissionMap.put(p.info.name, bp);</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="comment">// 重新分配拥有者为该系统应用！</span></span><br><span class="line">            <span class="keyword">if</span> (bp.perm == <span class="keyword">null</span>) &#123;</span><br><span class="line">                <span class="keyword">if</span> (bp.sourcePackage == <span class="keyword">null</span></span><br><span class="line">                        || bp.sourcePackage.equals(p.info.packageName)) &#123;</span><br><span class="line">                    BasePermission tree = findPermissionTreeLP(p.info.name);</span><br><span class="line">                    <span class="keyword">if</span> (tree == <span class="keyword">null</span></span><br><span class="line">                            || tree.sourcePackage.equals(p.info.packageName)) &#123;</span><br><span class="line">                        bp.packageSetting = pkgSetting;</span><br><span class="line">                        bp.perm = p;</span><br><span class="line">                        bp.uid = pkg.applicationInfo.uid;</span><br><span class="line">                        bp.sourcePackage = p.info.packageName;</span><br><span class="line">                        p.info.flags |= PermissionInfo.FLAG_INSTALLED;</span><br><span class="line">                        <span class="keyword">if</span> ((policyFlags&amp;PackageParser.PARSE_CHATTY) != <span class="number">0</span>) &#123;</span><br><span class="line">                            <span class="keyword">if</span> (r == <span class="keyword">null</span>) &#123;</span><br><span class="line">                                r = <span class="keyword">new</span> StringBuilder(<span class="number">256</span>);</span><br><span class="line">                            &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                                r.append(<span class="string">' '</span>);</span><br><span class="line">                            &#125;</span><br><span class="line">                            r.append(p.info.name);</span><br><span class="line">                        &#125;</span><br><span class="line">                    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                        Slog.w(TAG, <span class="string">"Permission "</span> + p.info.name + <span class="string">" from package "</span></span><br><span class="line">                                + p.info.packageName + <span class="string">" ignored: base tree "</span></span><br><span class="line">                                + tree.name + <span class="string">" is from package "</span></span><br><span class="line">                                + tree.sourcePackage);</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                    Slog.w(TAG, <span class="string">"Permission "</span> + p.info.name + <span class="string">" from package "</span></span><br><span class="line">                            + p.info.packageName + <span class="string">" ignored: original from "</span></span><br><span class="line">                            + bp.sourcePackage);</span><br><span class="line">                &#125;</span><br><span class="line">            &#125; <span class="keyword">else</span> <span class="keyword">if</span> ((policyFlags&amp;PackageParser.PARSE_CHATTY) != <span class="number">0</span>) &#123;</span><br><span class="line">                <span class="keyword">if</span> (r == <span class="keyword">null</span>) &#123;</span><br><span class="line">                    r = <span class="keyword">new</span> StringBuilder(<span class="number">256</span>);</span><br><span class="line">                &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                    r.append(<span class="string">' '</span>);</span><br><span class="line">                &#125;</span><br><span class="line">                r.append(<span class="string">"DUP:"</span>);</span><br><span class="line">                r.append(p.info.name);</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="comment">// 如果上次安装时的权限的定义者，就是本次解析的 package，设置 protectionLevel！</span></span><br><span class="line">            <span class="keyword">if</span> (bp.perm == p) &#123;</span><br><span class="line">                bp.protectionLevel = p.info.protectionLevel;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (r != <span class="keyword">null</span>) &#123;</span><br><span class="line">            <span class="keyword">if</span> (DEBUG_PACKAGE_SCANNING) Log.d(TAG, <span class="string">"  Permissions: "</span> + r);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        N = pkg.instrumentation.size();</span><br><span class="line">        r = <span class="keyword">null</span>;</span><br><span class="line">        <span class="keyword">for</span> (i=<span class="number">0</span>; i&lt;N; i++) &#123;</span><br><span class="line">            ... ... ... ...<span class="comment">// 这里省略掉，暂时不看！</span></span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">if</span> (r != <span class="keyword">null</span>) &#123;</span><br><span class="line">            <span class="keyword">if</span> (DEBUG_PACKAGE_SCANNING) Log.d(TAG, <span class="string">"  Instrumentation: "</span> + r);</span><br><span class="line">        &#125;</span><br><span class="line">        </span><br><span class="line">        <span class="comment">//【25】处理该 Package 中的 protectedBroadcasts 信息！</span></span><br><span class="line">        <span class="keyword">if</span> (pkg.protectedBroadcasts != <span class="keyword">null</span>) &#123;</span><br><span class="line">            N = pkg.protectedBroadcasts.size();</span><br><span class="line">            <span class="keyword">for</span> (i=<span class="number">0</span>; i&lt;N; i++) &#123;</span><br><span class="line">                mProtectedBroadcasts.add(pkg.protectedBroadcasts.get(i));</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">//【27】更新 PackageSettings 中的时间戳！</span></span><br><span class="line">        pkgSetting.setTimeStamp(scanFileTime);</span><br><span class="line"></span><br><span class="line">        <span class="comment">// Create idmap files for pairs of (packages, overlay packages).</span></span><br><span class="line">        <span class="comment">// Note: "android", ie framework-res.apk, is handled by native layers.</span></span><br><span class="line">        <span class="keyword">if</span> (pkg.mOverlayTarget != <span class="keyword">null</span>) &#123;</span><br><span class="line">            <span class="comment">// This is an overlay package.</span></span><br><span class="line">            <span class="keyword">if</span> (pkg.mOverlayTarget != <span class="keyword">null</span> &amp;&amp; !pkg.mOverlayTarget.equals(<span class="string">"android"</span>)) &#123;</span><br><span class="line">                <span class="keyword">if</span> (!mOverlays.containsKey(pkg.mOverlayTarget)) &#123;</span><br><span class="line">                    mOverlays.put(pkg.mOverlayTarget,</span><br><span class="line">                            <span class="keyword">new</span> ArrayMap&lt;String, PackageParser.Package&gt;());</span><br><span class="line">                &#125;</span><br><span class="line">                ArrayMap&lt;String, PackageParser.Package&gt; map = mOverlays.get(pkg.mOverlayTarget);</span><br><span class="line">                map.put(pkg.packageName, pkg);</span><br><span class="line">                PackageParser.Package orig = mPackages.get(pkg.mOverlayTarget);</span><br><span class="line">                <span class="keyword">if</span> (orig != <span class="keyword">null</span> &amp;&amp; !createIdmapForPackagePairLI(orig, pkg)) &#123;</span><br><span class="line">                    createIdmapFailed = <span class="keyword">true</span>;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125; <span class="keyword">else</span> <span class="keyword">if</span> (mOverlays.containsKey(pkg.packageName) &amp;&amp;</span><br><span class="line">                !pkg.packageName.equals(<span class="string">"android"</span>)) &#123;</span><br><span class="line">            <span class="comment">// This is a regular package, with one or more known overlay packages.</span></span><br><span class="line">            createIdmapsForPackageLI(pkg);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    Trace.traceEnd(TRACE_TAG_PACKAGE_MANAGER);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (createIdmapFailed) &#123;</span><br><span class="line">        <span class="keyword">throw</span> <span class="keyword">new</span> PackageManagerException(INSTALL_FAILED_UPDATE_INCOMPATIBLE,</span><br><span class="line">                <span class="string">"scanPackageLI failed to createIdmap"</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> pkg;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>到这里，对于扫描的 package 的数据就处理完了！</p>
<h6 id="3-2-1-7-1-1-Settings-getPackageLPw"><a href="#3-2-1-7-1-1-Settings-getPackageLPw" class="headerlink" title="3.2.1.7.1.1 Settings.getPackageLPw"></a>3.2.1.7.1.1 Settings.getPackageLPw</h6><p>上面又再次调用了 getPackageLPw 方法，注意根据参数传递：</p>
<ul>
<li>boolean add：传入的值为 false！</li>
<li>boolean allowInstall：传入的值为 true；</li>
</ul>
<p>该方法传入的参数的是本次扫描解析获得的 apk 的数据！</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 最终进入这个方法！</span></span><br><span class="line"><span class="function"><span class="keyword">private</span> PackageSetting <span class="title">getPackageLPw</span><span class="params">(String name, PackageSetting origPackage,</span></span></span><br><span class="line"><span class="function"><span class="params">        String realName, SharedUserSetting sharedUser, File codePath, File resourcePath,</span></span></span><br><span class="line"><span class="function"><span class="params">        String legacyNativeLibraryPathString, String primaryCpuAbiString,</span></span></span><br><span class="line"><span class="function"><span class="params">        String secondaryCpuAbiString, <span class="keyword">int</span> vc, <span class="keyword">int</span> pkgFlags, <span class="keyword">int</span> pkgPrivateFlags,</span></span></span><br><span class="line"><span class="function"><span class="params">        UserHandle installUser, <span class="keyword">boolean</span> add, <span class="keyword">boolean</span> allowInstall, String parentPackage,</span></span></span><br><span class="line"><span class="function"><span class="params">        List&lt;String&gt; childPackageNames)</span> </span>&#123;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">//【1】尝试获得之前的安装数据！</span></span><br><span class="line">    PackageSetting p = mPackages.get(name);</span><br><span class="line">    UserManagerService userManager = UserManagerService.getInstance();</span><br><span class="line">    </span><br><span class="line">    <span class="comment">//【2】如果 p 不为 null，说明这个 apk 之前就存在！</span></span><br><span class="line">    <span class="comment">// 下面就要比较 codePath！</span></span><br><span class="line">    <span class="keyword">if</span> (p != <span class="keyword">null</span>) &#123;</span><br><span class="line">        p.primaryCpuAbiString = primaryCpuAbiString;</span><br><span class="line">        p.secondaryCpuAbiString = secondaryCpuAbiString;</span><br><span class="line">        <span class="keyword">if</span> (childPackageNames != <span class="keyword">null</span>) &#123;</span><br><span class="line">            p.childPackageNames = <span class="keyword">new</span> ArrayList&lt;&gt;(childPackageNames);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (!p.codePath.equals(codePath)) &#123;</span><br><span class="line">            <span class="keyword">if</span> ((p.pkgFlags &amp; ApplicationInfo.FLAG_SYSTEM) != <span class="number">0</span>) &#123;</span><br><span class="line">                <span class="comment">// 这是被更新的 system app 的情况，此时在 system 分区和 app 分区都会有该 apk，我们只需要</span></span><br><span class="line">                <span class="comment">// 将高 versionCode 的 apk 显示出来即可！</span></span><br><span class="line">                Slog.w(PackageManagerService.TAG, <span class="string">"Trying to update system app code path from "</span></span><br><span class="line">                        + p.codePathString + <span class="string">" to "</span> + codePath.toString());</span><br><span class="line">            &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                <span class="comment">// 这种情况是说明这个 system apk 的路径发生了变化！</span></span><br><span class="line">                <span class="comment">// 或者说这个应用是一个三方应用！</span></span><br><span class="line">                Slog.i(PackageManagerService.TAG, <span class="string">"Package "</span> + name + <span class="string">" codePath changed from "</span></span><br><span class="line">                        + p.codePath + <span class="string">" to "</span> + codePath + <span class="string">"; Retaining data and using new"</span>);</span><br><span class="line">                <span class="comment">// 如果当前扫描的是 system apk，并且其不是被覆盖安装的，即 getDisabledSystemPkgLPr 为 null；</span></span><br><span class="line">                <span class="comment">// 更新所有用户下的安装状态为 true！</span></span><br><span class="line">                <span class="keyword">if</span> ((pkgFlags &amp; ApplicationInfo.FLAG_SYSTEM) != <span class="number">0</span> &amp;&amp;</span><br><span class="line">                        getDisabledSystemPkgLPr(name) == <span class="keyword">null</span>) &#123;</span><br><span class="line"></span><br><span class="line">                    List&lt;UserInfo&gt; allUserInfos = getAllUsers();</span><br><span class="line">                    <span class="keyword">if</span> (allUserInfos != <span class="keyword">null</span>) &#123;</span><br><span class="line">                        <span class="keyword">for</span> (UserInfo userInfo : allUserInfos) &#123;</span><br><span class="line">                            p.setInstalled(<span class="keyword">true</span>, userInfo.id);</span><br><span class="line">                        &#125;</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;</span><br><span class="line"></span><br><span class="line">                p.legacyNativeLibraryPathString = legacyNativeLibraryPathString;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        </span><br><span class="line">        <span class="keyword">if</span> (p.sharedUser != sharedUser) &#123; </span><br><span class="line">            <span class="comment">// 如果共享 uid 不匹配，就需要创建新的 PackageSetting 替换以前的！</span></span><br><span class="line">            PackageManagerService.reportSettingsProblem(Log.WARN,</span><br><span class="line">                    <span class="string">"Package "</span> + name + <span class="string">" shared user changed from "</span></span><br><span class="line">                    + (p.sharedUser != <span class="keyword">null</span> ? p.sharedUser.name : <span class="string">"&lt;nothing&gt;"</span>)</span><br><span class="line">                    + <span class="string">" to "</span></span><br><span class="line">                    + (sharedUser != <span class="keyword">null</span> ? sharedUser.name : <span class="string">"&lt;nothing&gt;"</span>)</span><br><span class="line">                    + <span class="string">"; replacing with new"</span>);</span><br><span class="line">            p = <span class="keyword">null</span>;</span><br><span class="line">            </span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            <span class="comment">// 如果共享 uid 匹配，或者没有使用共享，进入这里！</span></span><br><span class="line">            <span class="comment">// 如果我们扫描的是一个 system 分区的 apk,  无论其之前是否在 data 分区存在！</span></span><br><span class="line">            <span class="comment">// 我们都会给上一次的安装信息设置 FLAG_SYSTEM 和 PRIVATE_FLAG_PRIVILEGED 标志位；</span></span><br><span class="line">            <span class="comment">// 这里和【3.2.1】【B】有关联</span></span><br><span class="line">            p.pkgFlags |= pkgFlags &amp; ApplicationInfo.FLAG_SYSTEM;</span><br><span class="line">            p.pkgPrivateFlags |= pkgPrivateFlags &amp; ApplicationInfo.PRIVATE_FLAG_PRIVILEGED;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">//【3】处理需要重新创建 PackageSetting 的情况！</span></span><br><span class="line">    <span class="comment">// 如果 p 为 null，说明这个系统 apk 是通过 OTA 升级方式新添加的，或者 shareUserId 不匹配！</span></span><br><span class="line">    <span class="comment">// 如果有源包，就用源包的命名，创建新的 PackageSetting 对象，并源包的数据来初始化！</span></span><br><span class="line">    <span class="comment">// 没有源包，就用当前包的命名，创建新的 PackageSetting 对象！</span></span><br><span class="line">    <span class="keyword">if</span> (p == <span class="keyword">null</span>) &#123;</span><br><span class="line">        <span class="keyword">if</span> (origPackage != <span class="keyword">null</span>) &#123;</span><br><span class="line">            <span class="comment">//【3.1】源包不为 null 的情况，进入这里，使用本次扫描的信息创建新的 PackageSetting！</span></span><br><span class="line">            p = <span class="keyword">new</span> PackageSetting(origPackage.name, name, codePath, resourcePath,</span><br><span class="line">                    legacyNativeLibraryPathString, primaryCpuAbiString, secondaryCpuAbiString,</span><br><span class="line">                    <span class="keyword">null</span> <span class="comment">/* cpuAbiOverrideString */</span>, vc, pkgFlags, pkgPrivateFlags,</span><br><span class="line">                    parentPackage, childPackageNames);</span><br><span class="line"></span><br><span class="line">            <span class="keyword">if</span> (PackageManagerService.DEBUG_UPGRADE) Log.v(PackageManagerService.TAG, <span class="string">"Package "</span></span><br><span class="line">                    + name + <span class="string">" is adopting original package "</span> + origPackage.name);</span><br><span class="line"></span><br><span class="line">            PackageSignatures s = p.signatures;</span><br><span class="line">            p.copyFrom(origPackage);</span><br><span class="line">            p.signatures = s;</span><br><span class="line">            p.sharedUser = origPackage.sharedUser;</span><br><span class="line">            p.appId = origPackage.appId;</span><br><span class="line">            p.origPackage = origPackage;</span><br><span class="line">            p.getPermissionsState().copyFrom(origPackage.getPermissionsState());</span><br><span class="line">            </span><br><span class="line">            <span class="comment">// 重命名为源包的名字后，将新旧名字加入 mRenamedPackages 集合！</span></span><br><span class="line">            mRenamedPackages.put(name, origPackage.name);</span><br><span class="line">            name = origPackage.name;</span><br><span class="line"></span><br><span class="line">            p.setTimeStamp(codePath.lastModified());</span><br><span class="line"></span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            <span class="comment">//【3.2】源包为 null 的情况，进入这里，使用本次扫描的信息创建新的 PackageSetting！</span></span><br><span class="line">            p = <span class="keyword">new</span> PackageSetting(name, realName, codePath, resourcePath,</span><br><span class="line">                    legacyNativeLibraryPathString, primaryCpuAbiString, secondaryCpuAbiString,</span><br><span class="line">                    <span class="keyword">null</span> <span class="comment">/* cpuAbiOverrideString */</span>, vc, pkgFlags, pkgPrivateFlags,</span><br><span class="line">                    parentPackage, childPackageNames);</span><br><span class="line"></span><br><span class="line">            p.setTimeStamp(codePath.lastModified());</span><br><span class="line">            p.sharedUser = sharedUser;</span><br><span class="line"></span><br><span class="line">            <span class="comment">// 系统 apk 不会进入这个分支！</span></span><br><span class="line">            <span class="keyword">if</span> ((pkgFlags&amp;ApplicationInfo.FLAG_SYSTEM) == <span class="number">0</span>) &#123;</span><br><span class="line">                <span class="keyword">if</span> (DEBUG_STOPPED) &#123;</span><br><span class="line">                    RuntimeException e = <span class="keyword">new</span> RuntimeException(<span class="string">"here"</span>);</span><br><span class="line">                    e.fillInStackTrace();</span><br><span class="line">                    Slog.i(PackageManagerService.TAG, <span class="string">"Stopping package "</span> + name, e);</span><br><span class="line">                &#125;</span><br><span class="line">                List&lt;UserInfo&gt; users = getAllUsers();</span><br><span class="line">                <span class="keyword">final</span> <span class="keyword">int</span> installUserId = installUser != <span class="keyword">null</span> ? installUser.getIdentifier() : <span class="number">0</span>;</span><br><span class="line">                <span class="keyword">if</span> (users != <span class="keyword">null</span> &amp;&amp; allowInstall) &#123;</span><br><span class="line">                    <span class="keyword">for</span> (UserInfo user : users) &#123;</span><br><span class="line">                        <span class="keyword">final</span> <span class="keyword">boolean</span> installed = installUser == <span class="keyword">null</span></span><br><span class="line">                                || (installUserId == UserHandle.USER_ALL</span><br><span class="line">                                    &amp;&amp; !isAdbInstallDisallowed(userManager, user.id))</span><br><span class="line">                                || installUserId == user.id;</span><br><span class="line">                        p.setUserState(user.id, <span class="number">0</span>, COMPONENT_ENABLED_STATE_DEFAULT,</span><br><span class="line">                                installed,</span><br><span class="line">                                <span class="keyword">true</span>, <span class="comment">// stopped,</span></span><br><span class="line">                                <span class="keyword">true</span>, <span class="comment">// notLaunched</span></span><br><span class="line">                                <span class="keyword">false</span>, <span class="comment">// hidden</span></span><br><span class="line">                                <span class="keyword">false</span>, <span class="comment">// suspended</span></span><br><span class="line">                                <span class="keyword">null</span>, <span class="keyword">null</span>, <span class="keyword">null</span>,</span><br><span class="line">                                <span class="keyword">false</span>, <span class="comment">// blockUninstall</span></span><br><span class="line">                                INTENT_FILTER_DOMAIN_VERIFICATION_STATUS_UNDEFINED, <span class="number">0</span>);</span><br><span class="line">                        writePackageRestrictionsLPr(user.id);</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">            </span><br><span class="line">            <span class="comment">// 设置系统 package 的 appid</span></span><br><span class="line">            <span class="comment">// 如果是共享用户 id，那 appId 就是共享用户 id；</span></span><br><span class="line">            <span class="comment">// 如果不是共享用户 id，就看系统 app 是否被覆盖更新过，如果有，就克隆更新前的旧数据，初始化 appId，权限等等</span></span><br><span class="line">            <span class="comment">// 如果系统 app 没有被覆盖更新过，就创建新的 uid！</span></span><br><span class="line">            <span class="keyword">if</span> (sharedUser != <span class="keyword">null</span>) &#123;</span><br><span class="line">                p.appId = sharedUser.userId;</span><br><span class="line">                </span><br><span class="line">            &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                PackageSetting dis = mDisabledSysPackages.get(name);</span><br><span class="line">                <span class="keyword">if</span> (dis != <span class="keyword">null</span>) &#123;</span><br><span class="line">                </span><br><span class="line">                    <span class="keyword">if</span> (dis.signatures.mSignatures != <span class="keyword">null</span>) &#123;</span><br><span class="line">                        p.signatures.mSignatures = dis.signatures.mSignatures.clone();</span><br><span class="line">                    &#125;</span><br><span class="line">                    p.appId = dis.appId;</span><br><span class="line">                    </span><br><span class="line">                    p.getPermissionsState().copyFrom(dis.getPermissionsState());</span><br><span class="line">                    </span><br><span class="line">                    List&lt;UserInfo&gt; users = getAllUsers();</span><br><span class="line">                    <span class="keyword">if</span> (users != <span class="keyword">null</span>) &#123;</span><br><span class="line">                        <span class="keyword">for</span> (UserInfo user : users) &#123;</span><br><span class="line">                            <span class="keyword">int</span> userId = user.id;</span><br><span class="line">                            p.setDisabledComponentsCopy(</span><br><span class="line">                                    dis.getDisabledComponents(userId), userId);</span><br><span class="line">                            p.setEnabledComponentsCopy(</span><br><span class="line">                                    dis.getEnabledComponents(userId), userId);</span><br><span class="line">                        &#125;</span><br><span class="line">                    &#125;</span><br><span class="line">                    </span><br><span class="line">                    <span class="comment">// 将这个新的 PackageSetting 根据 uid 添加到 mUserIds 或者 mOtherUserIds 中！</span></span><br><span class="line">                    addUserIdLPw(p.appId, p, name);</span><br><span class="line">                &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                </span><br><span class="line">                    <span class="comment">// 分配一个新的 uid，并将映射关系保存到 mUserIds 中！</span></span><br><span class="line">                    p.appId = newUserIdLPw(p);</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (p.appId &lt; <span class="number">0</span>) &#123;</span><br><span class="line">            PackageManagerService.reportSettingsProblem(Log.WARN,</span><br><span class="line">                    <span class="string">"Package "</span> + name + <span class="string">" could not be assigned a valid uid"</span>);</span><br><span class="line">            <span class="keyword">return</span> <span class="keyword">null</span>;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (add) &#123; <span class="comment">// add 为 false，这里不添加，添加的操作在 PMS.scanPackageDirtyLI 方法中！</span></span><br><span class="line">            addPackageSettingLPw(p, name, sharedUser);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        <span class="keyword">if</span> (installUser != <span class="keyword">null</span> &amp;&amp; allowInstall) &#123;</span><br><span class="line">            <span class="comment">// The caller has explicitly specified the user they want this</span></span><br><span class="line">            <span class="comment">// package installed for, and the package already exists.</span></span><br><span class="line">            <span class="comment">// Make sure it conforms to the new request.</span></span><br><span class="line">            List&lt;UserInfo&gt; users = getAllUsers();</span><br><span class="line">            <span class="keyword">if</span> (users != <span class="keyword">null</span>) &#123;</span><br><span class="line">                <span class="keyword">for</span> (UserInfo user : users) &#123;</span><br><span class="line">                    <span class="keyword">if</span> ((installUser.getIdentifier() == UserHandle.USER_ALL</span><br><span class="line">                                &amp;&amp; !isAdbInstallDisallowed(userManager, user.id))</span><br><span class="line">                            || installUser.getIdentifier() == user.id) &#123;</span><br><span class="line">                        <span class="keyword">boolean</span> installed = p.getInstalled(user.id);</span><br><span class="line">                        <span class="keyword">if</span> (!installed) &#123;</span><br><span class="line">                            p.setInstalled(<span class="keyword">true</span>, user.id);</span><br><span class="line">                            writePackageRestrictionsLPr(user.id);</span><br><span class="line">                        &#125;</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">//【4】返回查到或者是创建的新的系统 package 对应的 PackageSetting 对象！</span></span><br><span class="line">    <span class="keyword">return</span> p;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h6 id="3-2-1-7-1-2-Settings-insertPackageSettingLPw"><a href="#3-2-1-7-1-2-Settings-insertPackageSettingLPw" class="headerlink" title="3.2.1.7.1.2 Settings.insertPackageSettingLPw"></a>3.2.1.7.1.2 Settings.insertPackageSettingLPw</h6><p>该方法会将 PackageSetting 保存到 mUserIds 或 mOtherIds 中去，同时用本次扫描的的 Package 更新 PackageSetting！</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">insertPackageSettingLPw</span><span class="params">(PackageSetting p, PackageParser.Package pkg)</span> </span>&#123;</span><br><span class="line">    p.pkg = pkg; <span class="comment">//【1】建立引用关系！</span></span><br><span class="line">    <span class="comment">// pkg.mSetEnabled = p.getEnabled(userId);</span></span><br><span class="line">    <span class="comment">// pkg.mSetStopped = p.getStopped(userId);</span></span><br><span class="line">    <span class="keyword">final</span> String volumeUuid = pkg.applicationInfo.volumeUuid;</span><br><span class="line">    <span class="keyword">final</span> String codePath = pkg.applicationInfo.getCodePath();</span><br><span class="line">    <span class="keyword">final</span> String resourcePath = pkg.applicationInfo.getResourcePath();</span><br><span class="line">    <span class="keyword">final</span> String legacyNativeLibraryPath = pkg.applicationInfo.nativeLibraryRootDir;</span><br><span class="line">    <span class="comment">// Update volume if needed</span></span><br><span class="line">    <span class="keyword">if</span> (!Objects.equals(volumeUuid, p.volumeUuid)) &#123;</span><br><span class="line">        Slog.w(PackageManagerService.TAG, <span class="string">"Volume for "</span> + p.pkg.packageName +</span><br><span class="line">                <span class="string">" changing from "</span> + p.volumeUuid + <span class="string">" to "</span> + volumeUuid);</span><br><span class="line">        p.volumeUuid = volumeUuid;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// Update code path if needed</span></span><br><span class="line">    <span class="keyword">if</span> (!Objects.equals(codePath, p.codePathString)) &#123;</span><br><span class="line">        Slog.w(PackageManagerService.TAG, <span class="string">"Code path for "</span> + p.pkg.packageName +</span><br><span class="line">                <span class="string">" changing from "</span> + p.codePathString + <span class="string">" to "</span> + codePath);</span><br><span class="line">        p.codePath = <span class="keyword">new</span> File(codePath);</span><br><span class="line">        p.codePathString = codePath;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">//Update resource path if needed</span></span><br><span class="line">    <span class="keyword">if</span> (!Objects.equals(resourcePath, p.resourcePathString)) &#123;</span><br><span class="line">        Slog.w(PackageManagerService.TAG, <span class="string">"Resource path for "</span> + p.pkg.packageName +</span><br><span class="line">                <span class="string">" changing from "</span> + p.resourcePathString + <span class="string">" to "</span> + resourcePath);</span><br><span class="line">        p.resourcePath = <span class="keyword">new</span> File(resourcePath);</span><br><span class="line">        p.resourcePathString = resourcePath;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// Update the native library paths if needed</span></span><br><span class="line">    <span class="keyword">if</span> (!Objects.equals(legacyNativeLibraryPath, p.legacyNativeLibraryPathString)) &#123;</span><br><span class="line">        p.legacyNativeLibraryPathString = legacyNativeLibraryPath;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// Update the required Cpu Abi</span></span><br><span class="line">    p.primaryCpuAbiString = pkg.applicationInfo.primaryCpuAbi;</span><br><span class="line">    p.secondaryCpuAbiString = pkg.applicationInfo.secondaryCpuAbi;</span><br><span class="line">    p.cpuAbiOverrideString = pkg.cpuAbiOverride;</span><br><span class="line">    <span class="comment">// Update version code if needed</span></span><br><span class="line">    <span class="keyword">if</span> (pkg.mVersionCode != p.versionCode) &#123;</span><br><span class="line">        p.versionCode = pkg.mVersionCode;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// Update signatures if needed.</span></span><br><span class="line">    <span class="keyword">if</span> (p.signatures.mSignatures == <span class="keyword">null</span>) &#123;</span><br><span class="line">        p.signatures.assignSignatures(pkg.mSignatures);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// Update flags if needed.</span></span><br><span class="line">    <span class="keyword">if</span> (pkg.applicationInfo.flags != p.pkgFlags) &#123;</span><br><span class="line">        p.pkgFlags = pkg.applicationInfo.flags;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// If this app defines a shared user id initialize</span></span><br><span class="line">    <span class="comment">// the shared user signatures as well.</span></span><br><span class="line">    <span class="keyword">if</span> (p.sharedUser != <span class="keyword">null</span> &amp;&amp; p.sharedUser.signatures.mSignatures == <span class="keyword">null</span>) &#123;</span><br><span class="line">        p.sharedUser.signatures.assignSignatures(pkg.mSignatures);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">//【2】将 PackageSetting 保存到 mUserIds 或则会 mOtherIds 中去</span></span><br><span class="line">    addPackageSettingLPw(p, pkg.packageName, p.sharedUser);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>这里就不多说了！</p>
<p>######3.2.1.7.1.3 ActivityIntentResolver.addActivity - 添加 activity</p>
<h4 id="3-2-1-8-Settings-disableSystemPackageLPw"><a href="#3-2-1-8-Settings-disableSystemPackageLPw" class="headerlink" title="3.2.1.8 Settings.disableSystemPackageLPw"></a>3.2.1.8 Settings.disableSystemPackageLPw</h4><p>当需要隐藏掉 system app 的时候，会调用 disableSystemPackageLPw 方法：</p>
<p>参数传递：</p>
<ul>
<li>boolean replaced：true！</li>
</ul>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">boolean</span> <span class="title">disableSystemPackageLPw</span><span class="params">(String name, <span class="keyword">boolean</span> replaced)</span> </span>&#123;</span><br><span class="line">    <span class="comment">// 判断一下，这个系统 apk 是否已经安装，没有安装就不用 disable！</span></span><br><span class="line">    <span class="keyword">final</span> PackageSetting p = mPackages.get(name);</span><br><span class="line">    <span class="keyword">if</span>(p == <span class="keyword">null</span>) &#123;</span><br><span class="line">        Log.w(PackageManagerService.TAG, <span class="string">"Package "</span> + name + <span class="string">" is not an installed package"</span>);</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">false</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// 系统 apk 已经安装了，并且之前没有被覆盖更新过，</span></span><br><span class="line">    <span class="comment">// 且之前没有添加 ApplicationInfo.FLAG_UPDATED_SYSTEM_APP 标签！</span></span><br><span class="line">    <span class="keyword">final</span> PackageSetting dp = mDisabledSysPackages.get(name);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (dp == <span class="keyword">null</span> &amp;&amp; p.pkg != <span class="keyword">null</span> &amp;&amp; p.pkg.isSystemApp() &amp;&amp; !p.pkg.isUpdatedSystemApp()) &#123;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span>((p.pkg != <span class="keyword">null</span>) &amp;&amp; (p.pkg.applicationInfo != <span class="keyword">null</span>)) &#123;</span><br><span class="line">            p.pkg.applicationInfo.flags |= ApplicationInfo.FLAG_UPDATED_SYSTEM_APP;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">// 将其添加到 mDisabledSysPackages 列表中！</span></span><br><span class="line">        mDisabledSysPackages.put(name, p);</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (replaced) &#123; <span class="comment">// 这里为 true</span></span><br><span class="line">            <span class="comment">//【3.2.1.8.1】为更新的后的应用重新创建一个 PackageSetting，添加到 mPackages 中</span></span><br><span class="line">            <span class="comment">// 因为旧的 PackageSetting 被添加到了 mDisabledSysPackages！</span></span><br><span class="line">            PackageSetting newp = <span class="keyword">new</span> PackageSetting(p);</span><br><span class="line">            replacePackageLPw(name, newp);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">true</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">false</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>这里面会设置到 pkgFlags 和 pkgPrivateFlags 的设置：<br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">setFlags</span><span class="params">(<span class="keyword">int</span> pkgFlags)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">this</span>.pkgFlags = pkgFlags</span><br><span class="line">            &amp; (ApplicationInfo.FLAG_SYSTEM</span><br><span class="line">                    | ApplicationInfo.FLAG_EXTERNAL_STORAGE);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">setPrivateFlags</span><span class="params">(<span class="keyword">int</span> pkgPrivateFlags)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">this</span>.pkgPrivateFlags = pkgPrivateFlags</span><br><span class="line">            &amp; (ApplicationInfo.PRIVATE_FLAG_PRIVILEGED</span><br><span class="line">            | ApplicationInfo.PRIVATE_FLAG_FORWARD_LOCK</span><br><span class="line">            | ApplicationInfo.PRIVATE_FLAG_REQUIRED_FOR_SYSTEM_USER);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>到这里 system 分区的扫描流程就结束了！</p>
<h5 id="3-2-1-8-1-Settings-replacePackageLPw"><a href="#3-2-1-8-1-Settings-replacePackageLPw" class="headerlink" title="3.2.1.8.1 Settings.replacePackageLPw"></a>3.2.1.8.1 Settings.replacePackageLPw</h5><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">replacePackageLPw</span><span class="params">(String name, PackageSetting newp)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">final</span> PackageSetting p = mPackages.get(name);</span><br><span class="line">    <span class="keyword">if</span> (p != <span class="keyword">null</span>) &#123;</span><br><span class="line">        <span class="keyword">if</span> (p.sharedUser != <span class="keyword">null</span>) &#123;</span><br><span class="line">            p.sharedUser.removePackage(p);</span><br><span class="line">            p.sharedUser.addPackage(newp);</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            replaceUserIdLPw(p.appId, newp);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    mPackages.put(name, newp);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>更新 mPackages 中的数据！</p>
<h6 id="3-2-1-8-1-1-Settings-replaceUserIdLPw"><a href="#3-2-1-8-1-1-Settings-replaceUserIdLPw" class="headerlink" title="3.2.1.8.1.1 Settings.replaceUserIdLPw"></a>3.2.1.8.1.1 Settings.replaceUserIdLPw</h6><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">replaceUserIdLPw</span><span class="params">(<span class="keyword">int</span> uid, Object obj)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">if</span> (uid &gt;= Process.FIRST_APPLICATION_UID) &#123;</span><br><span class="line">        <span class="keyword">final</span> <span class="keyword">int</span> N = mUserIds.size();</span><br><span class="line">        <span class="keyword">final</span> <span class="keyword">int</span> index = uid - Process.FIRST_APPLICATION_UID;</span><br><span class="line">        <span class="keyword">if</span> (index &lt; N) mUserIds.set(index, obj);</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        mOtherUserIds.put(uid, obj);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>更新 mOtherUserIds 和 mUserIds 中的数据！</p>
<h2 id="3-3-扫描总结"><a href="#3-3-扫描总结" class="headerlink" title="3.3 扫描总结"></a>3.3 扫描总结</h2><p>下面我们来总结下扫描过程：</p>
<h3 id="3-3-1-扫描过程总结"><a href="#3-3-1-扫描过程总结" class="headerlink" title="3.3.1 扫描过程总结"></a>3.3.1 扫描过程总结</h3><p>接下来，用一张图来总结一下，扫描的过程：<br><img src="http://static.zybuluo.com/Coolqi/dwx0jucpjl1q26m8u7i735wn/%E6%89%AB%E6%8F%8F%E7%B3%BB%E7%BB%9F%E7%9B%AE%E5%BD%95.png" alt="扫描系统目录.png-116.5kB"></p>
<p>流程很清晰了，不多说。</p>
<h3 id="3-3-2-数据关系总结"><a href="#3-3-2-数据关系总结" class="headerlink" title="3.3.2 数据关系总结"></a>3.3.2 数据关系总结</h3><p>下面我们来看看解析获得的数据之间的关系：<br><img src="http://static.zybuluo.com/Coolqi/lxyqc0fppux003uv2ynu4c5d/%E6%89%AB%E6%8F%8F%E6%95%B0%E6%8D%AE%E5%85%B3%E7%B3%BB%E5%9B%BE.png" alt="扫描数据关系图.png-354.6kB"></p>
<p>这个图展示了解析得到的一个 Package 对象在内存中的结果。</p>
<ul>
<li>组件的基类是 Component，AndroidManifest.xml 中定义的组件 activity，service，provider，permission等，都继承了 Component；</li>
<li>activity，service 这样的组件，都可以配置 <intent-filter> 属性，在 pms 中体现在 IntentInfo 这个数据结构中，从上图可以看到，每一种组件所依赖的 intentInfo 不同，Component 和 IntentInfo 之间的依赖关系采用了桥接模式，通过泛型实现！</intent-filter></li>
</ul>
<h1 id="4-系统目录扫描-收尾阶段"><a href="#4-系统目录扫描-收尾阶段" class="headerlink" title="4 系统目录扫描 - 收尾阶段"></a>4 系统目录扫描 - 收尾阶段</h1><p>接下来，是收集可能被删掉的系统应用包！<br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//【×】用于收集可能已经被删掉的系统应用包！</span></span><br><span class="line"><span class="keyword">final</span> List&lt;String&gt; possiblyDeletedUpdatedSystemApps = <span class="keyword">new</span> ArrayList&lt;String&gt;();</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> (!mOnlyCore) &#123;</span><br><span class="line">    <span class="comment">// 遍历上次安装的所有的 package！</span></span><br><span class="line">    Iterator&lt;PackageSetting&gt; psit = mSettings.mPackages.values().iterator();</span><br><span class="line">    <span class="keyword">while</span> (psit.hasNext()) &#123;</span><br><span class="line">        PackageSetting ps = psit.next();</span><br><span class="line">        <span class="comment">//【×】如果是非系统应用，跳过，如果是被覆盖安装！</span></span><br><span class="line">        <span class="keyword">if</span> ((ps.pkgFlags &amp; ApplicationInfo.FLAG_SYSTEM) == <span class="number">0</span>) &#123;</span><br><span class="line">            <span class="keyword">continue</span>;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">final</span> PackageParser.Package scannedPkg = mPackages.get(ps.name);</span><br><span class="line">        <span class="keyword">if</span> (scannedPkg != <span class="keyword">null</span>) &#123;</span><br><span class="line">            <span class="comment">//【4.1】如果系统应用包不仅被扫描过（在mPackages中），并且在不可用列表中！</span></span><br><span class="line">            <span class="comment">// 说明一定是通过覆盖安装的，移除之前扫描的结果，保证之前用户安装的应用能够被扫描！</span></span><br><span class="line">            <span class="keyword">if</span> (mSettings.isDisabledSystemPackageLPr(ps.name)) &#123;</span><br><span class="line">                logCriticalInfo(Log.WARN, <span class="string">"Expecting better updated system app for "</span></span><br><span class="line">                        + ps.name + <span class="string">"; removing system app.  Last known codePath="</span></span><br><span class="line">                        + ps.codePathString + <span class="string">", installStatus="</span> + ps.installStatus</span><br><span class="line">                        + <span class="string">", versionCode="</span> + ps.versionCode + <span class="string">"; scanned versionCode="</span></span><br><span class="line">                        + scannedPkg.mVersionCode);</span><br><span class="line">                </span><br><span class="line">                <span class="comment">//【4.2】将之前的扫描结果移除！</span></span><br><span class="line">                removePackageLI(scannedPkg, <span class="keyword">true</span>);</span><br><span class="line">                <span class="comment">// 将这包添加到 mExpectingBetter 列表中！</span></span><br><span class="line">                mExpectingBetter.put(ps.name, ps.codePath);</span><br><span class="line">            &#125;</span><br><span class="line">            </span><br><span class="line">            <span class="comment">// 跳出循环，确保不会被删掉！</span></span><br><span class="line">            <span class="keyword">continue</span>;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (!mSettings.isDisabledSystemPackageLPr(ps.name)) &#123;</span><br><span class="line">            <span class="comment">// 如果系统应用包没有被扫描，并且他也不在不可用的列表中，说明其没有被更新过，</span></span><br><span class="line">            <span class="comment">// 可能被删除了，也可能被移动到了 data 分区，那就清楚其前面的数据！</span></span><br><span class="line">            <span class="comment">// 如果移动到了 data 分区，那就在扫描 data 的过程中处理！</span></span><br><span class="line">            psit.remove();</span><br><span class="line">            logCriticalInfo(Log.WARN, <span class="string">"System package "</span> + ps.name</span><br><span class="line">                    + <span class="string">" no longer exists; it's data will be wiped"</span>);</span><br><span class="line"></span><br><span class="line">        &#125; <span class="keyword">else</span> &#123; </span><br><span class="line">            <span class="comment">// 如果系统应用包没有被扫描，却在不可用的列表中，说明其被更新过了，但是 apk 被删除了</span></span><br><span class="line">            <span class="comment">// 就将他加入到 possiblyDeletedUpdatedSystemApps 集合中！</span></span><br><span class="line">            <span class="keyword">final</span> PackageSetting disabledPs = mSettings.getDisabledSystemPkgLPr(ps.name);</span><br><span class="line">            <span class="keyword">if</span> (disabledPs.codePath == <span class="keyword">null</span> || !disabledPs.codePath.exists()) &#123;</span><br><span class="line">                possiblyDeletedUpdatedSystemApps.add(ps.name);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">//【×】清理所有安装不完全的应用包！</span></span><br><span class="line">ArrayList&lt;PackageSetting&gt; deletePkgsList = mSettings.getListOfIncompleteInstallPackagesLPr();</span><br><span class="line"><span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; deletePkgsList.size(); i++) &#123;</span><br><span class="line">    <span class="keyword">final</span> String packageName = deletePkgsList.get(i).name;</span><br><span class="line">    logCriticalInfo(Log.WARN, <span class="string">"Cleaning up incompletely installed app: "</span> + packageName);</span><br><span class="line">    <span class="keyword">synchronized</span> (mPackages) &#123;</span><br><span class="line">        mSettings.removePackageLPw(packageName);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 移除临时文件</span></span><br><span class="line">deleteTempPackageFiles();</span><br><span class="line"></span><br><span class="line"><span class="comment">// 移除没有和应用程序包相关联的共享用户 id！</span></span><br><span class="line">mSettings.pruneSharedUsersLPw();</span><br></pre></td></tr></table></figure></p>
<p>对于已经被扫描到的系统 app，如果发现他存在于被更新过的列表中，说明这个系统 apk 在 data 分区有更新的版本了，那就需要把之前扫描的清楚掉，这样我们要确保在扫描 data 分区时，data 分区的 app 能够显示出来！！</p>
<h2 id="4-1-PMS-isDisabledSystemPackageLPr"><a href="#4-1-PMS-isDisabledSystemPackageLPr" class="headerlink" title="4.1 PMS.isDisabledSystemPackageLPr"></a>4.1 PMS.isDisabledSystemPackageLPr</h2><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">boolean</span> <span class="title">isDisabledSystemPackageLPr</span><span class="params">(String name)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">return</span> mDisabledSysPackages.containsKey(name);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h2 id="4-2-PMS-removePackageLI"><a href="#4-2-PMS-removePackageLI" class="headerlink" title="4.2 PMS.removePackageLI"></a>4.2 PMS.removePackageLI</h2><p>removePackageLI 会移除指定 pacakge 的扫描结果！</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">removePackageLI</span><span class="params">(PackageParser.Package pkg, <span class="keyword">boolean</span> chatty)</span> </span>&#123;</span><br><span class="line">    <span class="comment">// Remove the parent package setting</span></span><br><span class="line">    PackageSetting ps = (PackageSetting) pkg.mExtras;</span><br><span class="line">    <span class="keyword">if</span> (ps != <span class="keyword">null</span>) &#123;</span><br><span class="line">        removePackageLI(ps, chatty);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// Remove the child package setting</span></span><br><span class="line">    <span class="keyword">final</span> <span class="keyword">int</span> childCount = (pkg.childPackages != <span class="keyword">null</span>) ? pkg.childPackages.size() : <span class="number">0</span>;</span><br><span class="line">    <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; childCount; i++) &#123;</span><br><span class="line">        PackageParser.Package childPkg = pkg.childPackages.get(i);</span><br><span class="line">        ps = (PackageSetting) childPkg.mExtras;</span><br><span class="line">        <span class="keyword">if</span> (ps != <span class="keyword">null</span>) &#123;</span><br><span class="line">            removePackageLI(ps, chatty);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">removePackageLI</span><span class="params">(PackageSetting ps, <span class="keyword">boolean</span> chatty)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">if</span> (DEBUG_INSTALL) &#123;</span><br><span class="line">        <span class="keyword">if</span> (chatty)</span><br><span class="line">            Log.d(TAG, <span class="string">"Removing package "</span> + ps.name);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// writer</span></span><br><span class="line">    <span class="keyword">synchronized</span> (mPackages) &#123;</span><br><span class="line">        mPackages.remove(ps.name);</span><br><span class="line">        <span class="keyword">final</span> PackageParser.Package pkg = ps.pkg;</span><br><span class="line">        <span class="keyword">if</span> (pkg != <span class="keyword">null</span>) &#123;</span><br><span class="line">            cleanPackageDataStructuresLILPw(pkg, chatty);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h1 id="5-总结"><a href="#5-总结" class="headerlink" title="5 总结"></a>5 总结</h1><p>我们用一张流程图来总结一下系统 apk 的扫描解析处理过程：</p>
<ul>
<li>需要隐藏的系统 apk 都会被添加到 mExpectingBetter 列表中：<br>1、系统 apk 被覆盖安装过，且 system 分区的 versionCode 的是不高于 data 分区的；<br>2、之前已经有一相同包名的 apk 安装在 data 分区中了，这次有同样的包名的 app 出现在了 system 分区， versionCode 不高于 data 分区的；</li>
</ul>
</div><hr></div><div class="recent-post-item article-container"><a class="article-title" href="/2018/01/26/PMS 第 2 篇 - PMS_START 阶段/">PMS 第 2 篇 - PMS_START 阶段</a><time class="post-meta__date"><i class="fa fa-calendar" aria-hidden="true"></i> 2018-01-26</time><span class="article-meta"><span class="article-meta__separator">|</span><i class="fa fa-inbox article-meta__icon" aria-hidden="true"></i><a class="article-meta__categories" href="/categories/AndroidFramework源码分析/">AndroidFramework源码分析</a><i class="fa fa-angle-right" aria-hidden="true"></i><i class="fa fa-inbox article-meta__icon" aria-hidden="true"></i><a class="article-meta__categories" href="/categories/AndroidFramework源码分析/PackageManager包管理/">PackageManager包管理</a></span><span class="article-meta tags"><span class="article-meta__separator">|</span><i class="fa fa-tag article-meta__icon" aria-hidden="true"></i><a class="article-meta__tags" href="/tags/PackageManager包管理/">PackageManager包管理</a></span><div class="content"><p>[toc]</p>
<p>基于 Android 7.1.1 源码分析 PackageManagerService 的架构和逻辑实现，本文是作者原创，转载请说明出处！</p>
<h1 id="0-综述"><a href="#0-综述" class="headerlink" title="0 综述"></a>0 综述</h1><p>我们进入第一阶段来分析，代码比较长，我们先来个总体的阶段回顾：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="title">PackageManagerService</span><span class="params">(Context context, Installer installer,</span></span></span><br><span class="line"><span class="function"><span class="params">     <span class="keyword">boolean</span> factoryTest, <span class="keyword">boolean</span> onlyCore)</span> </span>&#123;</span><br><span class="line"> EventLog.writeEvent(EventLogTags.BOOT_PROGRESS_PMS_START,</span><br><span class="line">         SystemClock.uptimeMillis());</span><br><span class="line"></span><br><span class="line"> <span class="keyword">if</span> (mSdkVersion &lt;= <span class="number">0</span>) &#123;</span><br><span class="line">     <span class="comment">// mSdkVersion 是 PKMS 的成员变量，定义的时候进行赋值，</span></span><br><span class="line">     <span class="comment">// 其值取自系统属性 ro.build.version.sdk，即编译的 SDK 版本。</span></span><br><span class="line">     Slog.w(TAG, <span class="string">"**** ro.build.version.sdk not set!"</span>);</span><br><span class="line"> &#125;</span><br><span class="line"></span><br><span class="line"> mContext = context; <span class="comment">// 系统进程的上下文实例！</span></span><br><span class="line"> mFactoryTest = factoryTest; <span class="comment">// 默认为 false，即运行在非工厂模式下</span></span><br><span class="line"> mOnlyCore = onlyCore; <span class="comment">// 默认为 false，标记是否是只加载核心服务</span></span><br><span class="line"> </span><br><span class="line"> <span class="comment">// 用于存储与显示屏相关的一些属性，例如屏幕的宽 / 高尺寸，分辨率等信息。</span></span><br><span class="line"> mMetrics = <span class="keyword">new</span> DisplayMetrics(); </span><br><span class="line"></span><br><span class="line"> <span class="comment">//【1】在 Settings 中，创建 packages.xml、packages-backup.xml、packages.list 等文件对象</span></span><br><span class="line"> <span class="comment">// 并添加 system, phone, log, nfc, bluetooth, shell 这六种 shareUserId 到 mSettings，后面扫描和安装有用！</span></span><br><span class="line"> mSettings = <span class="keyword">new</span> Settings(mPackages);</span><br><span class="line"> mSettings.addSharedUserLPw(<span class="string">"android.uid.system"</span>, Process.SYSTEM_UID,</span><br><span class="line">         ApplicationInfo.FLAG_SYSTEM, ApplicationInfo.PRIVATE_FLAG_PRIVILEGED);</span><br><span class="line"> mSettings.addSharedUserLPw(<span class="string">"android.uid.phone"</span>, RADIO_UID,</span><br><span class="line">         ApplicationInfo.FLAG_SYSTEM, ApplicationInfo.PRIVATE_FLAG_PRIVILEGED);</span><br><span class="line"> mSettings.addSharedUserLPw(<span class="string">"android.uid.log"</span>, LOG_UID,</span><br><span class="line">         ApplicationInfo.FLAG_SYSTEM, ApplicationInfo.PRIVATE_FLAG_PRIVILEGED);</span><br><span class="line"> mSettings.addSharedUserLPw(<span class="string">"android.uid.nfc"</span>, NFC_UID,</span><br><span class="line">         ApplicationInfo.FLAG_SYSTEM, ApplicationInfo.PRIVATE_FLAG_PRIVILEGED);</span><br><span class="line"> mSettings.addSharedUserLPw(<span class="string">"android.uid.bluetooth"</span>, BLUETOOTH_UID,</span><br><span class="line">         ApplicationInfo.FLAG_SYSTEM, ApplicationInfo.PRIVATE_FLAG_PRIVILEGED);</span><br><span class="line"> mSettings.addSharedUserLPw(<span class="string">"android.uid.shell"</span>, SHELL_UID,</span><br><span class="line">         ApplicationInfo.FLAG_SYSTEM, ApplicationInfo.PRIVATE_FLAG_PRIVILEGED);</span><br><span class="line"></span><br><span class="line"> String separateProcesses = SystemProperties.get(<span class="string">"debug.separate_processes"</span>);</span><br><span class="line"> <span class="keyword">if</span> (separateProcesses != <span class="keyword">null</span> &amp;&amp; separateProcesses.length() &gt; <span class="number">0</span>) &#123;</span><br><span class="line">     <span class="keyword">if</span> (<span class="string">"*"</span>.equals(separateProcesses)) &#123;</span><br><span class="line">         mDefParseFlags = PackageParser.PARSE_IGNORE_PROCESSES;</span><br><span class="line">         mSeparateProcesses = <span class="keyword">null</span>;</span><br><span class="line">         Slog.w(TAG, <span class="string">"Running with debug.separate_processes: * (ALL)"</span>);</span><br><span class="line">     &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">         mDefParseFlags = <span class="number">0</span>;</span><br><span class="line">         mSeparateProcesses = separateProcesses.split(<span class="string">","</span>);</span><br><span class="line">         Slog.w(TAG, <span class="string">"Running with debug.separate_processes: "</span></span><br><span class="line">                 + separateProcesses);</span><br><span class="line">     &#125;</span><br><span class="line"> &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">     mDefParseFlags = <span class="number">0</span>;</span><br><span class="line">     mSeparateProcesses = <span class="keyword">null</span>;</span><br><span class="line"> &#125;</span><br><span class="line"></span><br><span class="line"> <span class="comment">// 初始化 mInstaller 对象，installer 对象和 Native 进程 installd 交互，以后分析 installd 时再来讨论它的作用！</span></span><br><span class="line"> mInstaller = installer;</span><br><span class="line"> </span><br><span class="line"> <span class="comment">//【2】创建 PackageDexOptimizer 对象，用于 dex 优化！</span></span><br><span class="line"> mPackageDexOptimizer = <span class="keyword">new</span> PackageDexOptimizer(installer, mInstallLock, context,</span><br><span class="line">         <span class="string">"*dexopt*"</span>);</span><br><span class="line">         </span><br><span class="line"> <span class="comment">//【3】创建 MoveCallbacks 对象，用于操作回滚！</span></span><br><span class="line"> mMoveCallbacks = <span class="keyword">new</span> MoveCallbacks(FgThread.get().getLooper());</span><br><span class="line"> </span><br><span class="line"> <span class="comment">//【4】创建 OnPermissionChangeListeners 对象，用于监听权限改变！</span></span><br><span class="line"> mOnPermissionChangeListeners = <span class="keyword">new</span> OnPermissionChangeListeners(</span><br><span class="line">         FgThread.get().getLooper());</span><br><span class="line"></span><br><span class="line"> getDefaultDisplayMetrics(context, mMetrics);</span><br><span class="line"></span><br><span class="line"> <span class="comment">//【5】创建 SystemConfig 对象，用于获取系统配置信息</span></span><br><span class="line"> <span class="comment">// 主要有 /system/etc/ 目录和 /system/etc/ 目录下的 sysconfig 和 permissions 文件夹中的 xml 文件</span></span><br><span class="line"> SystemConfig systemConfig = SystemConfig.getInstance();</span><br><span class="line"> mGlobalGids = systemConfig.getGlobalGids();</span><br><span class="line"> mSystemPermissions = systemConfig.getSystemPermissions();</span><br><span class="line"> mAvailableFeatures = systemConfig.getAvailableFeatures();</span><br><span class="line"></span><br><span class="line"> mProtectedPackages = <span class="keyword">new</span> ProtectedPackages(mContext);</span><br><span class="line"></span><br><span class="line"> <span class="keyword">synchronized</span> (mInstallLock) &#123;</span><br><span class="line"> <span class="comment">// writer</span></span><br><span class="line"> <span class="keyword">synchronized</span> (mPackages) &#123;</span><br><span class="line">     <span class="comment">//【6】建立并启动一个名为 “PackageManager” 的 HandlerThread，类型是 ServiceThread，处理安装卸载的消息！</span></span><br><span class="line">     mHandlerThread = <span class="keyword">new</span> ServiceThread(TAG,</span><br><span class="line">             Process.THREAD_PRIORITY_BACKGROUND, <span class="keyword">true</span> <span class="comment">/*allowIo*/</span>);</span><br><span class="line">     mHandlerThread.start();</span><br><span class="line">     </span><br><span class="line">     <span class="comment">//【7】创建一个 PackageHandler 对象，绑定前面创建的 HandlerThread！</span></span><br><span class="line">     mHandler = <span class="keyword">new</span> PackageHandler(mHandlerThread.getLooper());</span><br><span class="line"></span><br><span class="line">     mProcessLoggingHandler = <span class="keyword">new</span> ProcessLoggingHandler();</span><br><span class="line">     Watchdog.getInstance().addThread(mHandler, WATCHDOG_TIMEOUT);</span><br><span class="line">     </span><br><span class="line">     <span class="comment">//【8】创建默认权限管理对象，用于给某些预制的 apk 给予权限，也可以撤销！</span></span><br><span class="line">     mDefaultPermissionPolicy = <span class="keyword">new</span> DefaultPermissionGrantPolicy(<span class="keyword">this</span>);</span><br><span class="line">     </span><br><span class="line">     <span class="comment">// 创建需要扫描检测的目录文件对象，为扫描做准备！</span></span><br><span class="line">     File dataDir = Environment.getDataDirectory();</span><br><span class="line">     mAppInstallDir = <span class="keyword">new</span> File(dataDir, <span class="string">"app"</span>); <span class="comment">// /data/data，存放应用程序的数据</span></span><br><span class="line">     mAppLib32InstallDir = <span class="keyword">new</span> File(dataDir, <span class="string">"app-lib"</span>);  <span class="comment">// /data/app-lib，用于存放用户自己安装的第三方应用程序</span></span><br><span class="line">     mEphemeralInstallDir = <span class="keyword">new</span> File(dataDir, <span class="string">"app-ephemeral"</span>);  <span class="comment">// /data/app-ephemeral</span></span><br><span class="line">     mAsecInternalPath = <span class="keyword">new</span> File(dataDir, <span class="string">"app-asec"</span>).getPath();  <span class="comment">// /data/app-asec</span></span><br><span class="line">     mDrmAppPrivateInstallDir = <span class="keyword">new</span> File(dataDir, <span class="string">"app-private"</span>);  <span class="comment">// /data/app-private，存放私有应用程序！</span></span><br><span class="line"></span><br><span class="line">     <span class="comment">//【9】创建用户管理服务！    </span></span><br><span class="line">     sUserManager = <span class="keyword">new</span> UserManagerService(context, <span class="keyword">this</span>, mPackages);</span><br><span class="line"></span><br><span class="line">     <span class="comment">//【10】将前面 SystemConfig 获得的系统权限保存到 mSettings.mPermissions 中！</span></span><br><span class="line">     ArrayMap&lt;String, SystemConfig.PermissionEntry&gt; permConfig</span><br><span class="line">             = systemConfig.getPermissions();</span><br><span class="line">     <span class="keyword">for</span> (<span class="keyword">int</span> i=<span class="number">0</span>; i&lt;permConfig.size(); i++) &#123;</span><br><span class="line">         SystemConfig.PermissionEntry perm = permConfig.valueAt(i);</span><br><span class="line">         BasePermission bp = mSettings.mPermissions.get(perm.name);</span><br><span class="line"></span><br><span class="line">         <span class="keyword">if</span> (bp == <span class="keyword">null</span>) &#123;</span><br><span class="line">             bp = <span class="keyword">new</span> BasePermission(perm.name, <span class="string">"android"</span>, BasePermission.TYPE_BUILTIN);</span><br><span class="line">             mSettings.mPermissions.put(perm.name, bp);</span><br><span class="line">         &#125;</span><br><span class="line"></span><br><span class="line">         <span class="keyword">if</span> (perm.gids != <span class="keyword">null</span>) &#123;</span><br><span class="line">             bp.setGids(perm.gids, perm.perUser);</span><br><span class="line">         &#125;</span><br><span class="line">     &#125;</span><br><span class="line"></span><br><span class="line">     <span class="comment">//【11】处理共享库！</span></span><br><span class="line">     ArrayMap&lt;String, String&gt; libConfig = systemConfig.getSharedLibraries();</span><br><span class="line">     <span class="keyword">for</span> (<span class="keyword">int</span> i=<span class="number">0</span>; i&lt;libConfig.size(); i++) &#123;</span><br><span class="line">         mSharedLibraries.put(libConfig.keyAt(i),</span><br><span class="line">                 <span class="keyword">new</span> SharedLibraryEntry(libConfig.valueAt(i), <span class="keyword">null</span>));</span><br><span class="line">     &#125;</span><br><span class="line">     </span><br><span class="line">     <span class="comment">//【12】从 /etc/security/mac_permissions.xml 读取 SELinux 信息！</span></span><br><span class="line">     mFoundPolicyFile = SELinuxMMAC.readInstallPolicy();</span><br><span class="line">     </span><br><span class="line">     <span class="comment">//【13】解析 packages.xml 文件，获得上一次的安装信息。返回值表示是否是第一次开机！</span></span><br><span class="line">     <span class="comment">// 如果是第一次开机，那么是读不到上次的数据的！</span></span><br><span class="line">     mFirstBoot = !mSettings.readLPw(sUserManager.getUsers(<span class="keyword">false</span>));</span><br><span class="line"></span><br><span class="line">     <span class="comment">//【14】如果应用是被更新过的系统应用，且位于 data 分区的 apk 文件不存在了</span></span><br><span class="line">     <span class="comment">// 那就移除上一次的 data 分区的安装信息，恢复为 system 分区的安装信息！</span></span><br><span class="line">     <span class="comment">// 这里貌似是为了解决一个 bug:32321269!</span></span><br><span class="line">     <span class="keyword">final</span> <span class="keyword">int</span> packageSettingCount = mSettings.mPackages.size();</span><br><span class="line">     <span class="keyword">for</span> (<span class="keyword">int</span> i = packageSettingCount - <span class="number">1</span>; i &gt;= <span class="number">0</span>; i--) &#123;</span><br><span class="line">         PackageSetting ps = mSettings.mPackages.valueAt(i);</span><br><span class="line">         <span class="keyword">if</span> (!isExternal(ps) &amp;&amp; (ps.codePath == <span class="keyword">null</span> || !ps.codePath.exists())</span><br><span class="line">                 &amp;&amp; mSettings.getDisabledSystemPkgLPr(ps.name) != <span class="keyword">null</span>) &#123;</span><br><span class="line">             mSettings.mPackages.removeAt(i);</span><br><span class="line">             mSettings.enableSystemPackageLPw(ps.name);</span><br><span class="line">         &#125;</span><br><span class="line">     &#125;</span><br><span class="line"></span><br><span class="line">     <span class="keyword">if</span> (mFirstBoot) &#123;</span><br><span class="line">         <span class="comment">//【15】如果是第一次开机，从另外一个系统拷贝 odex 文件到当前系统的 data 分区</span></span><br><span class="line">         <span class="comment">// Android 7.1 引进了 AB 升级，这个是 AB 升级的特性，可以先不看！</span></span><br><span class="line">         requestCopyPreoptedFiles();</span><br><span class="line">     &#125;</span><br><span class="line"></span><br><span class="line">     String customResolverActivity = Resources.getSystem().getString(</span><br><span class="line">             R.string.config_customResolverActivity);</span><br><span class="line">     <span class="keyword">if</span> (TextUtils.isEmpty(customResolverActivity)) &#123;</span><br><span class="line">         customResolverActivity = <span class="keyword">null</span>;</span><br><span class="line">     &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">         mCustomResolverComponentName = ComponentName.unflattenFromString(</span><br><span class="line">                 customResolverActivity);</span><br><span class="line">     &#125;</span><br><span class="line">      </span><br><span class="line">     ... ... ... ...<span class="comment">// 见，第二阶段</span></span><br></pre></td></tr></table></figure>
<p>下面我们来逐一分析这个阶段的过程：</p>
<h1 id="1-Settings"><a href="#1-Settings" class="headerlink" title="1 Settings"></a>1 Settings</h1><p>首先，创建了 Settings 对象：！</p>
<p>参数传递：</p>
<ul>
<li>Object lock：mPackage 对象！</li>
</ul>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">Settings(Object lock) &#123;</span><br><span class="line">    <span class="comment">// 调用第二个构造器！</span></span><br><span class="line">    <span class="keyword">this</span>(Environment.getDataDirectory(), lock);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>接着调用第二个构造函数：<br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line">Settings(File dataDir, Object lock) &#123;</span><br><span class="line">    mLock = lock;</span><br><span class="line">    <span class="comment">// 用于处理运行时权限相关的操作！</span></span><br><span class="line">    mRuntimePermissionsPersistence = <span class="keyword">new</span> RuntimePermissionPersistence(mLock);</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// 创建 /data/system 目录，并设置该目录的权限！</span></span><br><span class="line">    mSystemDir = <span class="keyword">new</span> File(dataDir, <span class="string">"system"</span>);</span><br><span class="line">    mSystemDir.mkdirs();</span><br><span class="line">    FileUtils.setPermissions(mSystemDir.toString(),</span><br><span class="line">            FileUtils.S_IRWXU|FileUtils.S_IRWXG</span><br><span class="line">            |FileUtils.S_IROTH|FileUtils.S_IXOTH,</span><br><span class="line">            -<span class="number">1</span>, -<span class="number">1</span>);</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// 创建 packages.xml 和 packages-backup.xml 文件对象</span></span><br><span class="line">    mSettingsFilename = <span class="keyword">new</span> File(mSystemDir, <span class="string">"packages.xml"</span>);</span><br><span class="line">    mBackupSettingsFilename = <span class="keyword">new</span> File(mSystemDir, <span class="string">"packages-backup.xml"</span>);</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 创建 packages.list 文件对象，并设置权限信息！</span></span><br><span class="line">    mPackageListFilename = <span class="keyword">new</span> File(mSystemDir, <span class="string">"packages.list"</span>);</span><br><span class="line">    FileUtils.setPermissions(mPackageListFilename, <span class="number">0640</span>, SYSTEM_UID, PACKAGE_INFO_GID);</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 创建 sdcardfs 文件对象！</span></span><br><span class="line">    <span class="keyword">final</span> File kernelDir = <span class="keyword">new</span> File(<span class="string">"/config/sdcardfs"</span>);</span><br><span class="line">    mKernelMappingFilename = kernelDir.exists() ? kernelDir : <span class="keyword">null</span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 创建 packages-stopped.xml 和 packages-stopped-backup.xml 文件对象！</span></span><br><span class="line">    mStoppedPackagesFilename = <span class="keyword">new</span> File(mSystemDir, <span class="string">"packages-stopped.xml"</span>);</span><br><span class="line">    mBackupStoppedPackagesFilename = <span class="keyword">new</span> File(mSystemDir, <span class="string">"packages-stopped-backup.xml"</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>Settings 对象的构造器很简单，这里要重点说明一下；</p>
<ul>
<li>packages.xml 和 packages-backup.xml 文件是一组，用于描述系统中所安装的所有 Package 信息，PMS 会先把数据写入 packages-backup.xml，信息写成功后，再改名为 packages.xml ！</li>
<li>packages.list 文件同样保存了系统中所有的应用的信息！</li>
<li>packages-stopped.xml 和 packages-stopped-backup.xml 文件是一组，用于描述被强行停止运行的 package 信息！</li>
</ul>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">com.android.settings <span class="number">1000</span> <span class="number">0</span> /data/user_de/<span class="number">0</span>/com.android.settings platform:privapp <span class="number">2001</span>,<span class="number">3009</span>,<span class="number">3002</span>,<span class="number">1023</span>,<span class="number">1015</span>,<span class="number">3003</span>,<span class="number">3001</span>,<span class="number">1004</span>,<span class="number">2002</span>,<span class="number">1007</span>,<span class="number">3006</span>,<span class="number">3188</span></span><br></pre></td></tr></table></figure>
<h2 id="1-1-new-RuntimePermissionPersistence"><a href="#1-1-new-RuntimePermissionPersistence" class="headerlink" title="1.1 new RuntimePermissionPersistence"></a>1.1 new RuntimePermissionPersistence</h2><p>创建运行时权限管理对象！</p>
<h2 id="1-2-Settings-addSharedUserLPw"><a href="#1-2-Settings-addSharedUserLPw" class="headerlink" title="1.2 Settings.addSharedUserLPw"></a>1.2 Settings.addSharedUserLPw</h2><p>接着调用了 <strong>addSharedUserLPw</strong> 方法，添加了几个系统共享用户，参数传递：</p>
<ul>
<li><strong>String name：</strong>共享用户名，下面是传入的用户名：<ul>
<li>android.uid.system</li>
<li>android.uid.phone</li>
<li>android.uid.log</li>
<li>android.uid.nfc</li>
<li>android.uid.bluetooth</li>
<li>android.uid.shell</li>
</ul>
</li>
<li><strong>int uid：</strong>共享用户 id，下面的用户名和上面的 id 一一对应！<ul>
<li>Process.SYSTEM_UID</li>
<li>RADIO_UID</li>
<li>LOG_UID</li>
<li>NFC_UID</li>
<li>BLUETOOTH_UID</li>
<li>SHELL_UID</li>
</ul>
</li>
<li><strong>int pkgFlags：</strong><ul>
<li>ApplicationInfo.FLAG_SYSTEM </li>
</ul>
</li>
<li><strong>int pkgPrivateFlags：</strong><ul>
<li>ApplicationInfo.PRIVATE_FLAG_PRIVILEGED</li>
</ul>
</li>
</ul>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="function">SharedUserSetting <span class="title">addSharedUserLPw</span><span class="params">(String name, <span class="keyword">int</span> uid, <span class="keyword">int</span> pkgFlags, <span class="keyword">int</span> pkgPrivateFlags)</span> </span>&#123;</span><br><span class="line">    SharedUserSetting s = mSharedUsers.get(name);</span><br><span class="line">    <span class="keyword">if</span> (s != <span class="keyword">null</span>) &#123;</span><br><span class="line">        <span class="keyword">if</span> (s.userId == uid) &#123;</span><br><span class="line">            <span class="keyword">return</span> s;</span><br><span class="line">        &#125;</span><br><span class="line">        PackageManagerService.reportSettingsProblem(Log.ERROR,</span><br><span class="line">                <span class="string">"Adding duplicate shared user, keeping first: "</span> + name);</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">null</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//【1.1.1】创建 SharedUserSetting 对象，封装 SharedUserId！</span></span><br><span class="line">    s = <span class="keyword">new</span> SharedUserSetting(name, pkgFlags, pkgPrivateFlags);</span><br><span class="line">    s.userId = uid;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">//【1.1.2】根据 uid 的范围，保存到到 mUserIds 或 mOtherUserIds 中！</span></span><br><span class="line">    <span class="keyword">if</span> (addUserIdLPw(uid, s, name)) &#123;</span><br><span class="line">        <span class="comment">//【1.1.2.1】添加到 mSharedUsers 中！</span></span><br><span class="line">        mSharedUsers.put(name, s);</span><br><span class="line">        <span class="keyword">return</span> s;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">null</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h3 id="1-2-1-SharedUserSetting"><a href="#1-2-1-SharedUserSetting" class="headerlink" title="1.2.1 SharedUserSetting"></a>1.2.1 SharedUserSetting</h3><p>我们来看看 SharedUserSetting 这个对象：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">final</span> <span class="class"><span class="keyword">class</span> <span class="title">SharedUserSetting</span> <span class="keyword">extends</span> <span class="title">SettingBase</span> </span>&#123;</span><br><span class="line">    <span class="comment">// 共享 uid 的名称</span></span><br><span class="line">    <span class="keyword">final</span> String name;</span><br><span class="line">    <span class="comment">// uid 值</span></span><br><span class="line">    <span class="keyword">int</span> userId;</span><br><span class="line">    <span class="comment">// 和这个 sharedUserId 相关的 flags</span></span><br><span class="line">    <span class="keyword">int</span> uidFlags; <span class="comment">// 取值为 ApplicationInfo.FLAG_SYSTEM</span></span><br><span class="line">    <span class="keyword">int</span> uidPrivateFlags; <span class="comment">// 取值为 ApplicationInfo.FLAG_SYSTEM</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">// 使用这个共享 uid 的所有应用程序 package！</span></span><br><span class="line">    <span class="keyword">final</span> ArraySet&lt;PackageSetting&gt; packages = <span class="keyword">new</span> ArraySet&lt;PackageSetting&gt;();</span><br><span class="line"></span><br><span class="line">    <span class="keyword">final</span> PackageSignatures signatures = <span class="keyword">new</span> PackageSignatures();</span><br><span class="line"></span><br><span class="line">    SharedUserSetting(String _name, <span class="keyword">int</span> _pkgFlags, <span class="keyword">int</span> _pkgPrivateFlags) &#123;</span><br><span class="line">        <span class="keyword">super</span>(_pkgFlags, _pkgPrivateFlags);</span><br><span class="line">        uidFlags =  _pkgFlags;</span><br><span class="line">        uidPrivateFlags = _pkgPrivateFlags;</span><br><span class="line">        name = _name;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> String <span class="title">toString</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="string">"SharedUserSetting&#123;"</span> + Integer.toHexString(System.identityHashCode(<span class="keyword">this</span>)) + <span class="string">" "</span></span><br><span class="line">                + name + <span class="string">"/"</span> + userId + <span class="string">"&#125;"</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    ... ... ...</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>代码很简单，这里就不多说了！</p>
<h3 id="1-2-2-Settings-addUserIdLPw"><a href="#1-2-2-Settings-addUserIdLPw" class="headerlink" title="1.2.2 Settings.addUserIdLPw"></a>1.2.2 Settings.addUserIdLPw</h3><p>addUserIdLPw 用于将创建的 sharedUserId 对象根据其 uid 是系统 uid 还是非系统 uid ，添加到指定的集合中！</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">boolean</span> <span class="title">addUserIdLPw</span><span class="params">(<span class="keyword">int</span> uid, Object obj, Object name)</span> </span>&#123;</span><br><span class="line">    <span class="comment">// uid 不能超过限制！</span></span><br><span class="line">    <span class="keyword">if</span> (uid &gt; Process.LAST_APPLICATION_UID) &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">false</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//【1】如果 uid 属于非系统应用，将其加入到 mUserIds 集合中！</span></span><br><span class="line">    <span class="keyword">if</span> (uid &gt;= Process.FIRST_APPLICATION_UID) &#123;</span><br><span class="line">        <span class="keyword">int</span> N = mUserIds.size();</span><br><span class="line">        <span class="keyword">final</span> <span class="keyword">int</span> index = uid - Process.FIRST_APPLICATION_UID;</span><br><span class="line">        <span class="keyword">while</span> (index &gt;= N) &#123;</span><br><span class="line">            mUserIds.add(<span class="keyword">null</span>);</span><br><span class="line">            N++;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">if</span> (mUserIds.get(index) != <span class="keyword">null</span>) &#123;</span><br><span class="line">            PackageManagerService.reportSettingsProblem(Log.ERROR,</span><br><span class="line">                    <span class="string">"Adding duplicate user id: "</span> + uid</span><br><span class="line">                    + <span class="string">" name="</span> + name);</span><br><span class="line">            <span class="keyword">return</span> <span class="keyword">false</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        mUserIds.set(index, obj);</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">    </span><br><span class="line">        <span class="comment">//【2】如果 uid 属于系统应用，将其加入到 mOtherUserIds 集合中！</span></span><br><span class="line">        <span class="keyword">if</span> (mOtherUserIds.get(uid) != <span class="keyword">null</span>) &#123;</span><br><span class="line">            PackageManagerService.reportSettingsProblem(Log.ERROR,</span><br><span class="line">                    <span class="string">"Adding duplicate shared id: "</span> + uid</span><br><span class="line">                            + <span class="string">" name="</span> + name);</span><br><span class="line">            <span class="keyword">return</span> <span class="keyword">false</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        mOtherUserIds.put(uid, obj);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">true</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>这里来说明一下：</p>
<blockquote>
<p>涉及的常量</p>
</blockquote>
<ul>
<li>Process.FIRST_APPLICATION_UID：取值 10000，用来区分系统应用 uid 和非系统应用的 uid。非系统应用的 uid 大于等于 10000，小于等于 19999，系统应用的 uid 小于 10000；</li>
<li>Process.LAST_APPLICATION_UID：取值 19999，表示应用程序的 uid 最大为 19999！</li>
</ul>
<blockquote>
<p>总结</p>
</blockquote>
<ul>
<li>mSharedUsers 集合用来保存所有的共享用户id！</li>
<li>mUserIds 集合中会保存非系统应用的 uid，包括共享和非共享！</li>
<li>mOtherUserIds 集合中会保存系统应用的 uid，包括共享和非共享！</li>
</ul>
<h1 id="2-PackageDexOptimizer"><a href="#2-PackageDexOptimizer" class="headerlink" title="2 PackageDexOptimizer"></a>2 PackageDexOptimizer</h1><p>PackageDexOptimizer 用于进行 odex 优化，我们来先简单的看看代码，参数传递：</p>
<ul>
<li>Installer installer：installer 对象，用于安装程序；</li>
<li>Object installLock：Object() 锁对象！</li>
<li>Context context：系统进程上下文实例！</li>
<li>String wakeLockTag：传入”<em>dexopt</em>“</li>
</ul>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">PackageDexOptimizer</span> </span>&#123;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> String TAG = <span class="string">"PackageManager.DexOptimizer"</span>;</span><br><span class="line">    <span class="keyword">static</span> <span class="keyword">final</span> String OAT_DIR_NAME = <span class="string">"oat"</span>;</span><br><span class="line">    <span class="comment">// TODO b/19550105 Remove error codes and use exceptions</span></span><br><span class="line">    <span class="keyword">static</span> <span class="keyword">final</span> <span class="keyword">int</span> DEX_OPT_SKIPPED = <span class="number">0</span>;</span><br><span class="line">    <span class="keyword">static</span> <span class="keyword">final</span> <span class="keyword">int</span> DEX_OPT_PERFORMED = <span class="number">1</span>;</span><br><span class="line">    <span class="keyword">static</span> <span class="keyword">final</span> <span class="keyword">int</span> DEX_OPT_FAILED = -<span class="number">1</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> Installer mInstaller;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> Object mInstallLock;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> PowerManager.WakeLock mDexoptWakeLock;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">volatile</span> <span class="keyword">boolean</span> mSystemReady;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 调用的这个构造器！</span></span><br><span class="line">    PackageDexOptimizer(Installer installer, Object installLock, Context context,</span><br><span class="line">            String wakeLockTag) &#123;</span><br><span class="line">        <span class="keyword">this</span>.mInstaller = installer;</span><br><span class="line">        <span class="keyword">this</span>.mInstallLock = installLock;</span><br><span class="line"></span><br><span class="line">        PowerManager powerManager = (PowerManager)context.getSystemService(Context.POWER_SERVICE);</span><br><span class="line">        mDexoptWakeLock = powerManager.newWakeLock(PowerManager.PARTIAL_WAKE_LOCK, wakeLockTag);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">protected</span> <span class="title">PackageDexOptimizer</span><span class="params">(PackageDexOptimizer from)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">this</span>.mInstaller = from.mInstaller;</span><br><span class="line">        <span class="keyword">this</span>.mInstallLock = from.mInstallLock;</span><br><span class="line">        <span class="keyword">this</span>.mDexoptWakeLock = from.mDexoptWakeLock;</span><br><span class="line">        <span class="keyword">this</span>.mSystemReady = from.mSystemReady;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    ... ... ... ...</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>这里创建了 PackageDexOptimizer 对象，后续执行 odex 优化会用到！</p>
<h1 id="3-MoveCallbacks"><a href="#3-MoveCallbacks" class="headerlink" title="3 MoveCallbacks"></a>3 MoveCallbacks</h1><p>用于监听 package 的 move 操作！！</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">private</span> <span class="keyword">static</span> <span class="class"><span class="keyword">class</span> <span class="title">MoveCallbacks</span> <span class="keyword">extends</span> <span class="title">Handler</span> </span>&#123;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="keyword">int</span> MSG_CREATED = <span class="number">1</span>;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="keyword">int</span> MSG_STATUS_CHANGED = <span class="number">2</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> RemoteCallbackList&lt;IPackageMoveObserver&gt;</span><br><span class="line">            mCallbacks = <span class="keyword">new</span> RemoteCallbackList&lt;&gt;();</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> SparseIntArray mLastStatus = <span class="keyword">new</span> SparseIntArray();</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="title">MoveCallbacks</span><span class="params">(Looper looper)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">super</span>(looper);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">register</span><span class="params">(IPackageMoveObserver callback)</span> </span>&#123;</span><br><span class="line">        mCallbacks.register(callback);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">unregister</span><span class="params">(IPackageMoveObserver callback)</span> </span>&#123;</span><br><span class="line">        mCallbacks.unregister(callback);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">handleMessage</span><span class="params">(Message msg)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">final</span> SomeArgs args = (SomeArgs) msg.obj;</span><br><span class="line">        <span class="keyword">final</span> <span class="keyword">int</span> n = mCallbacks.beginBroadcast();</span><br><span class="line">        <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; n; i++) &#123;</span><br><span class="line">            <span class="keyword">final</span> IPackageMoveObserver callback = mCallbacks.getBroadcastItem(i);</span><br><span class="line">            <span class="keyword">try</span> &#123;</span><br><span class="line">                invokeCallback(callback, msg.what, args);</span><br><span class="line">            &#125; <span class="keyword">catch</span> (RemoteException ignored) &#123;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        mCallbacks.finishBroadcast();</span><br><span class="line">        args.recycle();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">invokeCallback</span><span class="params">(IPackageMoveObserver callback, <span class="keyword">int</span> what, SomeArgs args)</span></span></span><br><span class="line"><span class="function">            <span class="keyword">throws</span> RemoteException </span>&#123;</span><br><span class="line">        <span class="keyword">switch</span> (what) &#123;</span><br><span class="line">            <span class="keyword">case</span> MSG_CREATED: &#123;</span><br><span class="line">                callback.onCreated(args.argi1, (Bundle) args.arg2);</span><br><span class="line">                <span class="keyword">break</span>;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">case</span> MSG_STATUS_CHANGED: &#123;</span><br><span class="line">                callback.onStatusChanged(args.argi1, args.argi2, (<span class="keyword">long</span>) args.arg3);</span><br><span class="line">                <span class="keyword">break</span>;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">notifyCreated</span><span class="params">(<span class="keyword">int</span> moveId, Bundle extras)</span> </span>&#123;</span><br><span class="line">        Slog.v(TAG, <span class="string">"Move "</span> + moveId + <span class="string">" created "</span> + extras.toString());</span><br><span class="line"></span><br><span class="line">        <span class="keyword">final</span> SomeArgs args = SomeArgs.obtain();</span><br><span class="line">        args.argi1 = moveId;</span><br><span class="line">        args.arg2 = extras;</span><br><span class="line">        obtainMessage(MSG_CREATED, args).sendToTarget();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">notifyStatusChanged</span><span class="params">(<span class="keyword">int</span> moveId, <span class="keyword">int</span> status)</span> </span>&#123;</span><br><span class="line">        notifyStatusChanged(moveId, status, -<span class="number">1</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">notifyStatusChanged</span><span class="params">(<span class="keyword">int</span> moveId, <span class="keyword">int</span> status, <span class="keyword">long</span> estMillis)</span> </span>&#123;</span><br><span class="line">        Slog.v(TAG, <span class="string">"Move "</span> + moveId + <span class="string">" status "</span> + status);</span><br><span class="line"></span><br><span class="line">        <span class="keyword">final</span> SomeArgs args = SomeArgs.obtain();</span><br><span class="line">        args.argi1 = moveId;</span><br><span class="line">        args.argi2 = status;</span><br><span class="line">        args.arg3 = estMillis;</span><br><span class="line">        obtainMessage(MSG_STATUS_CHANGED, args).sendToTarget();</span><br><span class="line"></span><br><span class="line">        <span class="keyword">synchronized</span> (mLastStatus) &#123;</span><br><span class="line">            mLastStatus.put(moveId, status);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h1 id="4-OnPermissionChangeListeners"><a href="#4-OnPermissionChangeListeners" class="headerlink" title="4 OnPermissionChangeListeners"></a>4 OnPermissionChangeListeners</h1><p>创建 OnPermissionChangeListeners 对象！<br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 创建 OnPermissionChangeListeners 对象，用于监听权限改变！</span></span><br><span class="line">mOnPermissionChangeListeners = <span class="keyword">new</span> OnPermissionChangeListeners(</span><br><span class="line">        FgThread.get().getLooper());</span><br></pre></td></tr></table></figure></p>
<p>OnPermissionChangeListeners 用于监听权限的改变：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">private</span> <span class="keyword">final</span> <span class="keyword">static</span> <span class="class"><span class="keyword">class</span> <span class="title">OnPermissionChangeListeners</span> <span class="keyword">extends</span> <span class="title">Handler</span> </span>&#123;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="keyword">int</span> MSG_ON_PERMISSIONS_CHANGED = <span class="number">1</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> RemoteCallbackList&lt;IOnPermissionsChangeListener&gt; mPermissionListeners =</span><br><span class="line">            <span class="keyword">new</span> RemoteCallbackList&lt;&gt;();</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="title">OnPermissionChangeListeners</span><span class="params">(Looper looper)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">super</span>(looper);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">handleMessage</span><span class="params">(Message msg)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">switch</span> (msg.what) &#123;</span><br><span class="line">            <span class="comment">//【2】处理 MSG_ON_PERMISSIONS_CHANGED 消息！</span></span><br><span class="line">            <span class="keyword">case</span> MSG_ON_PERMISSIONS_CHANGED: &#123;</span><br><span class="line">                <span class="keyword">final</span> <span class="keyword">int</span> uid = msg.arg1;</span><br><span class="line">                handleOnPermissionsChanged(uid);</span><br><span class="line">            &#125; <span class="keyword">break</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 添加权限改变监听器！</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">addListenerLocked</span><span class="params">(IOnPermissionsChangeListener listener)</span> </span>&#123;</span><br><span class="line">        mPermissionListeners.register(listener);</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// 移除权限改变监听器！</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">removeListenerLocked</span><span class="params">(IOnPermissionsChangeListener listener)</span> </span>&#123;</span><br><span class="line">        mPermissionListeners.unregister(listener);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onPermissionsChanged</span><span class="params">(<span class="keyword">int</span> uid)</span> </span>&#123;</span><br><span class="line">        <span class="comment">//【1】uid 的权限改变后，会触发这个方法，发送 MSG_ON_PERMISSIONS_CHANGED 消息！</span></span><br><span class="line">        <span class="keyword">if</span> (mPermissionListeners.getRegisteredCallbackCount() &gt; <span class="number">0</span>) &#123;</span><br><span class="line">            obtainMessage(MSG_ON_PERMISSIONS_CHANGED, uid, <span class="number">0</span>).sendToTarget();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//【3】uid 对应的应用程序的权限发生了变化！</span></span><br><span class="line">    <span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">handleOnPermissionsChanged</span><span class="params">(<span class="keyword">int</span> uid)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">final</span> <span class="keyword">int</span> count = mPermissionListeners.beginBroadcast();</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; count; i++) &#123;</span><br><span class="line">                IOnPermissionsChangeListener callback = mPermissionListeners</span><br><span class="line">                        .getBroadcastItem(i);</span><br><span class="line">                <span class="keyword">try</span> &#123;</span><br><span class="line">                    callback.onPermissionsChanged(uid);</span><br><span class="line">                &#125; <span class="keyword">catch</span> (RemoteException e) &#123;</span><br><span class="line">                    Log.e(TAG, <span class="string">"Permission listener is dead"</span>, e);</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">            mPermissionListeners.finishBroadcast();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>当指定 uid 的权限发生变化后，会调用 IOnPermissionsChangeListener 的 onPermissionsChanged 方法，通过 Binder 机制，最终会调用 ApplicationPackageManager 的 OnPermissionsChangeListenerDelegate 中的 onPermissionsChanged 方法！<br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">OnPermissionsChangeListenerDelegate</span> <span class="keyword">extends</span> <span class="title">IOnPermissionsChangeListener</span>.<span class="title">Stub</span></span></span><br><span class="line"><span class="class">        <span class="keyword">implements</span> <span class="title">Handler</span>.<span class="title">Callback</span></span>&#123;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="keyword">int</span> MSG_PERMISSIONS_CHANGED = <span class="number">1</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> OnPermissionsChangedListener mListener;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> Handler mHandler;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="title">OnPermissionsChangeListenerDelegate</span><span class="params">(OnPermissionsChangedListener listener,</span></span></span><br><span class="line"><span class="function"><span class="params">            Looper looper)</span> </span>&#123;</span><br><span class="line">        mListener = listener;</span><br><span class="line">        mHandler = <span class="keyword">new</span> Handler(looper, <span class="keyword">this</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onPermissionsChanged</span><span class="params">(<span class="keyword">int</span> uid)</span> </span>&#123;</span><br><span class="line">        mHandler.obtainMessage(MSG_PERMISSIONS_CHANGED, uid, <span class="number">0</span>).sendToTarget();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">boolean</span> <span class="title">handleMessage</span><span class="params">(Message msg)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">switch</span> (msg.what) &#123;</span><br><span class="line">            <span class="keyword">case</span> MSG_PERMISSIONS_CHANGED: &#123;</span><br><span class="line">                <span class="keyword">final</span> <span class="keyword">int</span> uid = msg.arg1;</span><br><span class="line">                </span><br><span class="line">                <span class="comment">// 最后调用 OnPermissionsChangedListener 的 onPermissionsChanged 方法！</span></span><br><span class="line">                mListener.onPermissionsChanged(uid);</span><br><span class="line">                <span class="keyword">return</span> <span class="keyword">true</span>;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">false</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>OnPermissionsChangedListener 是一个接口，定义在 PackageManager 中：<br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@SystemApi</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">interface</span> <span class="title">OnPermissionsChangedListener</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * Called when the permissions for a UID change.</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> uid The UID with a change.</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onPermissionsChanged</span><span class="params">(<span class="keyword">int</span> uid)</span></span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>具体的实现是在 LocationManagerService 中：<br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">systemRunning</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    <span class="keyword">synchronized</span> (mLock) &#123;</span><br><span class="line">        <span class="keyword">if</span> (D) Log.d(TAG, <span class="string">"systemRunning()"</span>);</span><br><span class="line"></span><br><span class="line">        ... ... ... ...</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 这里创建了一个 OnPermissionsChangedListener 对象，并添加到 PackageManagerervice 中！</span></span><br><span class="line">        PackageManager.OnPermissionsChangedListener permissionListener</span><br><span class="line">                = <span class="keyword">new</span> PackageManager.OnPermissionsChangedListener() &#123;</span><br><span class="line">            <span class="meta">@Override</span></span><br><span class="line">            <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onPermissionsChanged</span><span class="params">(<span class="keyword">final</span> <span class="keyword">int</span> uid)</span> </span>&#123;</span><br><span class="line">                <span class="keyword">synchronized</span> (mLock) &#123;</span><br><span class="line">                    applyAllProviderRequirementsLocked();</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;;</span><br><span class="line">        mPackageManager.addOnPermissionsChangeListener(permissionListener);</span><br><span class="line"></span><br><span class="line">        ... ... ...</span><br><span class="line">        </span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure></p>
<p>进入 PackageManagerService 中：<br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">addOnPermissionsChangeListener</span><span class="params">(IOnPermissionsChangeListener listener)</span> </span>&#123;</span><br><span class="line">    mContext.enforceCallingOrSelfPermission(</span><br><span class="line">            Manifest.permission.OBSERVE_GRANT_REVOKE_PERMISSIONS,</span><br><span class="line">            <span class="string">"addOnPermissionsChangeListener"</span>);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">synchronized</span> (mPackages) &#123;</span><br><span class="line">        </span><br><span class="line">        <span class="comment">// 添加到 mOnPermissionChangeListeners 内部的集合中！</span></span><br><span class="line">        mOnPermissionChangeListeners.addListenerLocked(listener);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>这里先看到这里吧！</p>
<h1 id="5-SystemConfig"><a href="#5-SystemConfig" class="headerlink" title="5 SystemConfig"></a>5 SystemConfig</h1><p>SystemConfig 是用来存储系统全局的配置信息的数据结构，有系统配置信息，权限信息，Gid 等等！<br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 单例模式！</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">static</span> SystemConfig <span class="title">getInstance</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    <span class="keyword">synchronized</span> (SystemConfig.class) &#123;</span><br><span class="line">        <span class="keyword">if</span> (sInstance == <span class="keyword">null</span>) &#123;</span><br><span class="line">            sInstance = <span class="keyword">new</span> SystemConfig();</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> sInstance;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>下面我们来看看 SystemConfig 构造器中的相关方法：<br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 其构造器会调用方法读取系统配置信息！</span></span><br><span class="line">SystemConfig() &#123;</span><br><span class="line">    <span class="comment">// 读取配置信息：/etc/sysconfig</span></span><br><span class="line">    readPermissions(Environment.buildPath(</span><br><span class="line">            Environment.getRootDirectory(), <span class="string">"etc"</span>, <span class="string">"sysconfig"</span>), ALLOW_ALL);</span><br><span class="line">            </span><br><span class="line">    <span class="comment">// 读取配置信息：/etc/permissions</span></span><br><span class="line">    readPermissions(Environment.buildPath(</span><br><span class="line">            Environment.getRootDirectory(), <span class="string">"etc"</span>, <span class="string">"permissions"</span>), ALLOW_ALL);</span><br><span class="line">            </span><br><span class="line">    <span class="comment">// 读取配置信息：/odm/etc/sysconfig，/odm/etc/permissions</span></span><br><span class="line">    <span class="keyword">int</span> odmPermissionFlag = ALLOW_LIBS | ALLOW_FEATURES | ALLOW_APP_CONFIGS;</span><br><span class="line">    readPermissions(Environment.buildPath(</span><br><span class="line">            Environment.getOdmDirectory(), <span class="string">"etc"</span>, <span class="string">"sysconfig"</span>), odmPermissionFlag);</span><br><span class="line">    readPermissions(Environment.buildPath(</span><br><span class="line">            Environment.getOdmDirectory(), <span class="string">"etc"</span>, <span class="string">"permissions"</span>), odmPermissionFlag);</span><br><span class="line">            </span><br><span class="line">    <span class="comment">// 读取配置信息：/oem/etc/sysconfig，/oem/etc/permissions</span></span><br><span class="line">    readPermissions(Environment.buildPath(</span><br><span class="line">            Environment.getOemDirectory(), <span class="string">"etc"</span>, <span class="string">"sysconfig"</span>), ALLOW_FEATURES);</span><br><span class="line">    readPermissions(Environment.buildPath(</span><br><span class="line">            Environment.getOemDirectory(), <span class="string">"etc"</span>, <span class="string">"permissions"</span>), ALLOW_FEATURES);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>第一个参数，表示可以访问的目录，这些目录包括：</p>
<ul>
<li>/etc/sysconfig：ALLOW_ALL</li>
<li>/etc/permissions：ALLOW_ALL</li>
<li>/odm/etc/sysconfig：ALLOW_LIBS | ALLOW_FEATURES | ALLOW_APP_CONFIGS</li>
<li>/odm/etc/permissions：ALLOW_LIBS | ALLOW_FEATURES | ALLOW_APP_CONFIGS</li>
<li>/oem/etc/sysconfig：ALLOW_FEATURES</li>
<li>/oem/etc/permissions：ALLOW_FEATURES</li>
</ul>
<p>第二个参数，表示这个目录可以设置的配置信息的类型，同样的，PMS 在解析时，也只会解析和读取参数指定的配置属性：</p>
<ul>
<li>oem：只能设置 features！</li>
<li>odm：只能设置 libs，features 和 app configs！</li>
<li>/system/etc/sysconfig，/system/etc/permissions：可以设置所有的配置，libs，permissions，features，app configs 等等！</li>
</ul>
<p>下面是 flag 的取值：<br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="keyword">int</span> ALLOW_FEATURES = <span class="number">0x01</span>;</span><br><span class="line"><span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="keyword">int</span> ALLOW_LIBS = <span class="number">0x02</span>;</span><br><span class="line"><span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="keyword">int</span> ALLOW_PERMISSIONS = <span class="number">0x04</span>;</span><br><span class="line"><span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="keyword">int</span> ALLOW_APP_CONFIGS = <span class="number">0x08</span>;</span><br><span class="line"><span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="keyword">int</span> ALLOW_ALL = ~<span class="number">0</span>;</span><br></pre></td></tr></table></figure></p>
<p>继续看！</p>
<h2 id="2-1-SystemConfig-readPermissions"><a href="#2-1-SystemConfig-readPermissions" class="headerlink" title="2.1 SystemConfig.readPermissions"></a>2.1 SystemConfig.readPermissions</h2><p>我们来看看读取的过程：<br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">readPermissions</span><span class="params">(File libraryDir, <span class="keyword">int</span> permissionFlag)</span> </span>&#123;</span><br><span class="line">    <span class="comment">// 校验目录可读性！</span></span><br><span class="line">    <span class="keyword">if</span> (!libraryDir.exists() || !libraryDir.isDirectory()) &#123;</span><br><span class="line">        <span class="keyword">if</span> (permissionFlag == ALLOW_ALL) &#123;</span><br><span class="line">            Slog.w(TAG, <span class="string">"No directory "</span> + libraryDir + <span class="string">", skipping"</span>);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span> (!libraryDir.canRead()) &#123;</span><br><span class="line">        Slog.w(TAG, <span class="string">"Directory "</span> + libraryDir + <span class="string">" cannot be read"</span>);</span><br><span class="line">        <span class="keyword">return</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 遍历解析目录下的所有 .xml 文件！</span></span><br><span class="line">    File platformFile = <span class="keyword">null</span>;</span><br><span class="line">    <span class="keyword">for</span> (File f : libraryDir.listFiles()) &#123;</span><br><span class="line">        <span class="comment">//【1】对于 etc/permissions/platform.xml 文件，最后再处理！</span></span><br><span class="line">        <span class="keyword">if</span> (f.getPath().endsWith(<span class="string">"etc/permissions/platform.xml"</span>)) &#123;</span><br><span class="line">            platformFile = f;</span><br><span class="line">            <span class="keyword">continue</span>;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (!f.getPath().endsWith(<span class="string">".xml"</span>)) &#123;</span><br><span class="line">            Slog.i(TAG, <span class="string">"Non-xml file "</span> + f + <span class="string">" in "</span> + libraryDir + <span class="string">" directory, ignoring"</span>);</span><br><span class="line">            <span class="keyword">continue</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">if</span> (!f.canRead()) &#123;</span><br><span class="line">            Slog.w(TAG, <span class="string">"Permissions library file "</span> + f + <span class="string">" cannot be read"</span>);</span><br><span class="line">            <span class="keyword">continue</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        </span><br><span class="line">        <span class="comment">//【2】进一步解析文件！</span></span><br><span class="line">        readPermissionsFromXml(f, permissionFlag);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//【3】读取和解析 platform.xml 文件！</span></span><br><span class="line">    <span class="keyword">if</span> (platformFile != <span class="keyword">null</span>) &#123;</span><br><span class="line">        readPermissionsFromXml(platformFile, permissionFlag);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>这个方法的主要过程是：</p>
<ul>
<li>先解析该目录下的其他的 xml 文件；</li>
<li>最后解析 etc/permissions/platform.xml 文件（如果有）；</li>
</ul>
<h2 id="2-2-SystemConfig-readPermissionsFromXml"><a href="#2-2-SystemConfig-readPermissionsFromXml" class="headerlink" title="2.2 SystemConfig.readPermissionsFromXml"></a>2.2 SystemConfig.readPermissionsFromXml</h2><p>继续调用 readPermissionsFromXml 方法，这里我们重点看一些 tag：<br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br><span class="line">212</span><br><span class="line">213</span><br><span class="line">214</span><br><span class="line">215</span><br><span class="line">216</span><br><span class="line">217</span><br><span class="line">218</span><br><span class="line">219</span><br><span class="line">220</span><br><span class="line">221</span><br><span class="line">222</span><br><span class="line">223</span><br><span class="line">224</span><br><span class="line">225</span><br><span class="line">226</span><br><span class="line">227</span><br><span class="line">228</span><br><span class="line">229</span><br><span class="line">230</span><br><span class="line">231</span><br><span class="line">232</span><br><span class="line">233</span><br><span class="line">234</span><br><span class="line">235</span><br><span class="line">236</span><br><span class="line">237</span><br><span class="line">238</span><br><span class="line">239</span><br><span class="line">240</span><br><span class="line">241</span><br><span class="line">242</span><br><span class="line">243</span><br><span class="line">244</span><br><span class="line">245</span><br><span class="line">246</span><br><span class="line">247</span><br><span class="line">248</span><br><span class="line">249</span><br><span class="line">250</span><br><span class="line">251</span><br><span class="line">252</span><br><span class="line">253</span><br><span class="line">254</span><br><span class="line">255</span><br><span class="line">256</span><br><span class="line">257</span><br><span class="line">258</span><br><span class="line">259</span><br><span class="line">260</span><br><span class="line">261</span><br><span class="line">262</span><br><span class="line">263</span><br><span class="line">264</span><br><span class="line">265</span><br><span class="line">266</span><br><span class="line">267</span><br><span class="line">268</span><br><span class="line">269</span><br><span class="line">270</span><br><span class="line">271</span><br><span class="line">272</span><br><span class="line">273</span><br><span class="line">274</span><br><span class="line">275</span><br><span class="line">276</span><br><span class="line">277</span><br><span class="line">278</span><br><span class="line">279</span><br><span class="line">280</span><br><span class="line">281</span><br><span class="line">282</span><br><span class="line">283</span><br><span class="line">284</span><br><span class="line">285</span><br><span class="line">286</span><br><span class="line">287</span><br><span class="line">288</span><br><span class="line">289</span><br><span class="line">290</span><br><span class="line">291</span><br><span class="line">292</span><br><span class="line">293</span><br><span class="line">294</span><br><span class="line">295</span><br><span class="line">296</span><br><span class="line">297</span><br><span class="line">298</span><br><span class="line">299</span><br><span class="line">300</span><br><span class="line">301</span><br><span class="line">302</span><br><span class="line">303</span><br><span class="line">304</span><br><span class="line">305</span><br><span class="line">306</span><br><span class="line">307</span><br><span class="line">308</span><br><span class="line">309</span><br><span class="line">310</span><br><span class="line">311</span><br><span class="line">312</span><br><span class="line">313</span><br><span class="line">314</span><br><span class="line">315</span><br><span class="line">316</span><br><span class="line">317</span><br><span class="line">318</span><br><span class="line">319</span><br><span class="line">320</span><br><span class="line">321</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">readPermissionsFromXml</span><span class="params">(File permFile, <span class="keyword">int</span> permissionFlag)</span> </span>&#123;</span><br><span class="line">    FileReader permReader = <span class="keyword">null</span>;</span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">        permReader = <span class="keyword">new</span> FileReader(permFile);</span><br><span class="line">    &#125; <span class="keyword">catch</span> (FileNotFoundException e) &#123;</span><br><span class="line">        Slog.w(TAG, <span class="string">"Couldn't find or open permissions file "</span> + permFile);</span><br><span class="line">        <span class="keyword">return</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//【1】判读设备是否是低内存！</span></span><br><span class="line">    <span class="keyword">final</span> <span class="keyword">boolean</span> lowRam = ActivityManager.isLowRamDeviceStatic();</span><br><span class="line"></span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">        XmlPullParser parser = Xml.newPullParser();</span><br><span class="line">        parser.setInput(permReader);</span><br><span class="line"></span><br><span class="line">        <span class="keyword">int</span> type;</span><br><span class="line">        <span class="keyword">while</span> ((type=parser.next()) != parser.START_TAG</span><br><span class="line">                   &amp;&amp; type != parser.END_DOCUMENT) &#123;</span><br><span class="line">            ;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (type != parser.START_TAG) &#123;</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> XmlPullParserException(<span class="string">"No start tag found"</span>);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (!parser.getName().equals(<span class="string">"permissions"</span>) &amp;&amp; !parser.getName().equals(<span class="string">"config"</span>)) &#123;</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> XmlPullParserException(<span class="string">"Unexpected start tag in "</span> + permFile</span><br><span class="line">                    + <span class="string">": found "</span> + parser.getName() + <span class="string">", expected 'permissions' or 'config'"</span>);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment">//【2】解析 Flag，指定二进制位为 1 ，即表示该条件满足，如果 flag 是 ALLOW_ALL，</span></span><br><span class="line">        <span class="comment">// 那么其他的条件均满足！</span></span><br><span class="line">        <span class="keyword">boolean</span> allowAll = permissionFlag == ALLOW_ALL;</span><br><span class="line">        <span class="keyword">boolean</span> allowLibs = (permissionFlag &amp; ALLOW_LIBS) != <span class="number">0</span>;</span><br><span class="line">        <span class="keyword">boolean</span> allowFeatures = (permissionFlag &amp; ALLOW_FEATURES) != <span class="number">0</span>;</span><br><span class="line">        <span class="keyword">boolean</span> allowPermissions = (permissionFlag &amp; ALLOW_PERMISSIONS) != <span class="number">0</span>;</span><br><span class="line">        <span class="keyword">boolean</span> allowAppConfigs = (permissionFlag &amp; ALLOW_APP_CONFIGS) != <span class="number">0</span>;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">while</span> (<span class="keyword">true</span>) &#123;</span><br><span class="line">            <span class="comment">// 解析下一个标签！</span></span><br><span class="line">            XmlUtils.nextElement(parser);</span><br><span class="line">            <span class="keyword">if</span> (parser.getEventType() == XmlPullParser.END_DOCUMENT) &#123;</span><br><span class="line">                <span class="keyword">break</span>;</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            String name = parser.getName();</span><br><span class="line">            <span class="keyword">if</span> (<span class="string">"group"</span>.equals(name) &amp;&amp; allowAll) &#123; </span><br><span class="line">                <span class="comment">//【1】allowAll 为 true，解析 "group" 标签；</span></span><br><span class="line">                <span class="comment">// 解析系统中所有的 Gid 信息！</span></span><br><span class="line">                String gidStr = parser.getAttributeValue(<span class="keyword">null</span>, <span class="string">"gid"</span>);</span><br><span class="line">                <span class="keyword">if</span> (gidStr != <span class="keyword">null</span>) &#123;</span><br><span class="line">                    <span class="keyword">int</span> gid = android.os.Process.getGidForName(gidStr);</span><br><span class="line">                    mGlobalGids = appendInt(mGlobalGids, gid);</span><br><span class="line">                &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                    Slog.w(TAG, <span class="string">"&lt;group&gt; without gid in "</span> + permFile + <span class="string">" at "</span></span><br><span class="line">                            + parser.getPositionDescription());</span><br><span class="line">                &#125;</span><br><span class="line"></span><br><span class="line">                XmlUtils.skipCurrentTag(parser);</span><br><span class="line">                <span class="keyword">continue</span>;</span><br><span class="line">                </span><br><span class="line">            &#125; <span class="keyword">else</span> <span class="keyword">if</span> (<span class="string">"permission"</span>.equals(name) &amp;&amp; allowPermissions) &#123;  </span><br><span class="line">                <span class="comment">//【2】allowPermissions 为 true，解析 "permission" 标签</span></span><br><span class="line">                <span class="comment">// 解析系统中所有权限和其所属 gid 的信息！</span></span><br><span class="line">                String perm = parser.getAttributeValue(<span class="keyword">null</span>, <span class="string">"name"</span>);</span><br><span class="line">                <span class="keyword">if</span> (perm == <span class="keyword">null</span>) &#123;</span><br><span class="line">                    Slog.w(TAG, <span class="string">"&lt;permission&gt; without name in "</span> + permFile + <span class="string">" at "</span></span><br><span class="line">                            + parser.getPositionDescription());</span><br><span class="line">                    XmlUtils.skipCurrentTag(parser);</span><br><span class="line">                    <span class="keyword">continue</span>;</span><br><span class="line">                &#125;</span><br><span class="line">                perm = perm.intern();</span><br><span class="line">                readPermission(parser, perm); <span class="comment">// 调用 readPermission 继续解析权限</span></span><br><span class="line"></span><br><span class="line">            &#125; <span class="keyword">else</span> <span class="keyword">if</span> (<span class="string">"assign-permission"</span>.equals(name) &amp;&amp; allowPermissions) &#123; </span><br><span class="line">                <span class="comment">//【3】如果 allowPermissions 为 true，解析 "assign-permission" 标签</span></span><br><span class="line">                <span class="comment">// 解析系统中 uid 和其所持有的权限的关系！</span></span><br><span class="line">                String perm = parser.getAttributeValue(<span class="keyword">null</span>, <span class="string">"name"</span>); <span class="comment">// 权限名</span></span><br><span class="line">                <span class="keyword">if</span> (perm == <span class="keyword">null</span>) &#123;</span><br><span class="line">                    Slog.w(TAG, <span class="string">"&lt;assign-permission&gt; without name in "</span> + permFile + <span class="string">" at "</span></span><br><span class="line">                            + parser.getPositionDescription());</span><br><span class="line">                    XmlUtils.skipCurrentTag(parser);</span><br><span class="line">                    <span class="keyword">continue</span>;</span><br><span class="line">                &#125;</span><br><span class="line">                String uidStr = parser.getAttributeValue(<span class="keyword">null</span>, <span class="string">"uid"</span>); <span class="comment">// 拥有该权限的 uid</span></span><br><span class="line">                <span class="keyword">if</span> (uidStr == <span class="keyword">null</span>) &#123;</span><br><span class="line">                    Slog.w(TAG, <span class="string">"&lt;assign-permission&gt; without uid in "</span> + permFile + <span class="string">" at "</span></span><br><span class="line">                            + parser.getPositionDescription());</span><br><span class="line">                    XmlUtils.skipCurrentTag(parser);</span><br><span class="line">                    <span class="keyword">continue</span>;</span><br><span class="line">                &#125;</span><br><span class="line">                <span class="keyword">int</span> uid = Process.getUidForName(uidStr); <span class="comment">// 将 uid 转为 int 值！</span></span><br><span class="line">                <span class="keyword">if</span> (uid &lt; <span class="number">0</span>) &#123;</span><br><span class="line">                    Slog.w(TAG, <span class="string">"&lt;assign-permission&gt; with unknown uid \""</span></span><br><span class="line">                            + uidStr + <span class="string">"  in "</span> + permFile + <span class="string">" at "</span></span><br><span class="line">                            + parser.getPositionDescription());</span><br><span class="line">                    XmlUtils.skipCurrentTag(parser);</span><br><span class="line">                    <span class="keyword">continue</span>;</span><br><span class="line">                &#125;</span><br><span class="line">                perm = perm.intern();</span><br><span class="line">                ArraySet&lt;String&gt; perms = mSystemPermissions.get(uid);</span><br><span class="line">                <span class="keyword">if</span> (perms == <span class="keyword">null</span>) &#123;</span><br><span class="line">                    perms = <span class="keyword">new</span> ArraySet&lt;String&gt;();</span><br><span class="line">                    mSystemPermissions.put(uid, perms);</span><br><span class="line">                &#125;</span><br><span class="line">                perms.add(perm);</span><br><span class="line">                XmlUtils.skipCurrentTag(parser);</span><br><span class="line"></span><br><span class="line">            &#125; <span class="keyword">else</span> <span class="keyword">if</span> (<span class="string">"library"</span>.equals(name) &amp;&amp; allowLibs) &#123; </span><br><span class="line">                <span class="comment">//【4】如果 allowLibs 为 true，解析 "library" 标签</span></span><br><span class="line">                <span class="comment">// 获得系统中所有共享库的信息！</span></span><br><span class="line">                String lname = parser.getAttributeValue(<span class="keyword">null</span>, <span class="string">"name"</span>);</span><br><span class="line">                String lfile = parser.getAttributeValue(<span class="keyword">null</span>, <span class="string">"file"</span>);</span><br><span class="line">                <span class="keyword">if</span> (lname == <span class="keyword">null</span>) &#123;</span><br><span class="line">                    Slog.w(TAG, <span class="string">"&lt;library&gt; without name in "</span> + permFile + <span class="string">" at "</span></span><br><span class="line">                            + parser.getPositionDescription());</span><br><span class="line">                &#125; <span class="keyword">else</span> <span class="keyword">if</span> (lfile == <span class="keyword">null</span>) &#123;</span><br><span class="line">                    Slog.w(TAG, <span class="string">"&lt;library&gt; without file in "</span> + permFile + <span class="string">" at "</span></span><br><span class="line">                            + parser.getPositionDescription());</span><br><span class="line">                &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                    <span class="comment">//Log.i(TAG, "Got library " + lname + " in " + lfile);</span></span><br><span class="line">                    mSharedLibraries.put(lname, lfile);</span><br><span class="line">                &#125;</span><br><span class="line">                XmlUtils.skipCurrentTag(parser);</span><br><span class="line">                <span class="keyword">continue</span>;</span><br><span class="line"></span><br><span class="line">            &#125; <span class="keyword">else</span> <span class="keyword">if</span> (<span class="string">"feature"</span>.equals(name) &amp;&amp; allowFeatures) &#123; </span><br><span class="line">                <span class="comment">//【5】如果 allowFeatures 为 true，解析 "feature" 标签</span></span><br><span class="line">                <span class="comment">// 获得系统中所有可用特性的信息！</span></span><br><span class="line">                String fname = parser.getAttributeValue(<span class="keyword">null</span>, <span class="string">"name"</span>);</span><br><span class="line">                <span class="keyword">int</span> fversion = XmlUtils.readIntAttribute(parser, <span class="string">"version"</span>, <span class="number">0</span>);</span><br><span class="line">                <span class="keyword">boolean</span> allowed;</span><br><span class="line">                </span><br><span class="line">                <span class="keyword">if</span> (!lowRam) &#123;</span><br><span class="line">                    allowed = <span class="keyword">true</span>;</span><br><span class="line">                &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                    <span class="comment">// 内存不足时，配置了 notLowRam 的 feature 不会在加载！</span></span><br><span class="line">                    String notLowRam = parser.getAttributeValue(<span class="keyword">null</span>, <span class="string">"notLowRam"</span>);</span><br><span class="line">                    allowed = !<span class="string">"true"</span>.equals(notLowRam);</span><br><span class="line">                &#125;</span><br><span class="line">                <span class="keyword">if</span> (fname == <span class="keyword">null</span>) &#123;</span><br><span class="line">                    Slog.w(TAG, <span class="string">"&lt;feature&gt; without name in "</span> + permFile + <span class="string">" at "</span></span><br><span class="line">                            + parser.getPositionDescription());</span><br><span class="line">                &#125; <span class="keyword">else</span> <span class="keyword">if</span> (allowed) &#123;</span><br><span class="line">                    <span class="comment">// 将 feature 构造成 featureInfo，加入到 mAvailableFeatures 对象中！</span></span><br><span class="line">                    addFeature(fname, fversion);</span><br><span class="line">                &#125;</span><br><span class="line">                XmlUtils.skipCurrentTag(parser);</span><br><span class="line">                <span class="keyword">continue</span>;</span><br><span class="line"></span><br><span class="line">            &#125; <span class="keyword">else</span> <span class="keyword">if</span> (<span class="string">"unavailable-feature"</span>.equals(name) &amp;&amp; allowFeatures) &#123; </span><br><span class="line">                <span class="comment">//【6】如果 allowFeatures 为 true，解析 "unavailable-feature" 标签</span></span><br><span class="line">                <span class="comment">// 获得系统中所有不可用特性的信息！</span></span><br><span class="line">                String fname = parser.getAttributeValue(<span class="keyword">null</span>, <span class="string">"name"</span>);</span><br><span class="line">                <span class="keyword">if</span> (fname == <span class="keyword">null</span>) &#123;</span><br><span class="line">                    Slog.w(TAG, <span class="string">"&lt;unavailable-feature&gt; without name in "</span> + permFile + <span class="string">" at "</span></span><br><span class="line">                            + parser.getPositionDescription());</span><br><span class="line">                &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                    mUnavailableFeatures.add(fname);</span><br><span class="line">                &#125;</span><br><span class="line">                XmlUtils.skipCurrentTag(parser);</span><br><span class="line">                <span class="keyword">continue</span>;</span><br><span class="line"></span><br><span class="line">            &#125; <span class="keyword">else</span> <span class="keyword">if</span> (<span class="string">"allow-in-power-save-except-idle"</span>.equals(name) &amp;&amp; allowAll) &#123;</span><br><span class="line">                <span class="comment">//【7】解析 "allow-in-power-save-except-idle" 标签</span></span><br><span class="line">                <span class="comment">// 用于获得系统中处于省电模式白名单，而没有在 idle 模式白名单中的应用信息！</span></span><br><span class="line">                <span class="comment">// 这些应用可以在后台运行！</span></span><br><span class="line">                String pkgname = parser.getAttributeValue(<span class="keyword">null</span>, <span class="string">"package"</span>);</span><br><span class="line">                <span class="keyword">if</span> (pkgname == <span class="keyword">null</span>) &#123;</span><br><span class="line">                    Slog.w(TAG, <span class="string">"&lt;allow-in-power-save-except-idle&gt; without package in "</span></span><br><span class="line">                            + permFile + <span class="string">" at "</span> + parser.getPositionDescription());</span><br><span class="line">                &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                    mAllowInPowerSaveExceptIdle.add(pkgname);</span><br><span class="line">                &#125;</span><br><span class="line">                XmlUtils.skipCurrentTag(parser);</span><br><span class="line">                <span class="keyword">continue</span>;</span><br><span class="line"></span><br><span class="line">            &#125; <span class="keyword">else</span> <span class="keyword">if</span> (<span class="string">"allow-in-power-save"</span>.equals(name) &amp;&amp; allowAll) &#123; </span><br><span class="line">                <span class="comment">//【8】解析 "allow-in-power-save" 标签</span></span><br><span class="line">                <span class="comment">// 获得哪些处于 doze 模式白名单中的应用信息！</span></span><br><span class="line">                String pkgname = parser.getAttributeValue(<span class="keyword">null</span>, <span class="string">"package"</span>);</span><br><span class="line">                <span class="keyword">if</span> (pkgname == <span class="keyword">null</span>) &#123;</span><br><span class="line">                    Slog.w(TAG, <span class="string">"&lt;allow-in-power-save&gt; without package in "</span> + permFile + <span class="string">" at "</span></span><br><span class="line">                            + parser.getPositionDescription());</span><br><span class="line">                &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                    mAllowInPowerSave.add(pkgname);</span><br><span class="line">                &#125;</span><br><span class="line">                XmlUtils.skipCurrentTag(parser);</span><br><span class="line">                <span class="keyword">continue</span>;</span><br><span class="line"></span><br><span class="line">            &#125; <span class="keyword">else</span> <span class="keyword">if</span> (<span class="string">"allow-in-data-usage-save"</span>.equals(name) &amp;&amp; allowAll) &#123;  </span><br><span class="line">                <span class="comment">//【9】解析 "allow-in-data-usage-save" 标签，</span></span><br><span class="line">                <span class="comment">// 获得哪些处于流量节省模式白名单中的应用的信息，在白名单中的应用，当系统处于</span></span><br><span class="line">                <span class="comment">// 流量节省模式时，可以在后台运行！</span></span><br><span class="line">                String pkgname = parser.getAttributeValue(<span class="keyword">null</span>, <span class="string">"package"</span>);</span><br><span class="line">                <span class="keyword">if</span> (pkgname == <span class="keyword">null</span>) &#123;</span><br><span class="line">                    Slog.w(TAG, <span class="string">"&lt;allow-in-data-usage-save&gt; without package in "</span> + permFile</span><br><span class="line">                            + <span class="string">" at "</span> + parser.getPositionDescription());</span><br><span class="line">                &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                    mAllowInDataUsageSave.add(pkgname);</span><br><span class="line">                &#125;</span><br><span class="line">                XmlUtils.skipCurrentTag(parser);</span><br><span class="line">                <span class="keyword">continue</span>;</span><br><span class="line"></span><br><span class="line">            &#125; <span class="keyword">else</span> <span class="keyword">if</span> (<span class="string">"app-link"</span>.equals(name) &amp;&amp; allowAppConfigs) &#123;  </span><br><span class="line">                <span class="comment">//【10】解析 "app-link" 标签</span></span><br><span class="line">                String pkgname = parser.getAttributeValue(<span class="keyword">null</span>, <span class="string">"package"</span>);</span><br><span class="line">                <span class="keyword">if</span> (pkgname == <span class="keyword">null</span>) &#123;</span><br><span class="line">                    Slog.w(TAG, <span class="string">"&lt;app-link&gt; without package in "</span> + permFile + <span class="string">" at "</span></span><br><span class="line">                            + parser.getPositionDescription());</span><br><span class="line">                &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                    mLinkedApps.add(pkgname);</span><br><span class="line">                &#125;</span><br><span class="line">                XmlUtils.skipCurrentTag(parser);</span><br><span class="line"></span><br><span class="line">            &#125; <span class="keyword">else</span> <span class="keyword">if</span> (<span class="string">"system-user-whitelisted-app"</span>.equals(name) &amp;&amp; allowAppConfigs) &#123; </span><br><span class="line">                <span class="comment">//【11】解析 "system-user-whitelisted-app" 标签</span></span><br><span class="line">                <span class="comment">// 获得哪些在 system user 下可以运行的应用信息！</span></span><br><span class="line">                String pkgname = parser.getAttributeValue(<span class="keyword">null</span>, <span class="string">"package"</span>);</span><br><span class="line">                <span class="keyword">if</span> (pkgname == <span class="keyword">null</span>) &#123;</span><br><span class="line">                    Slog.w(TAG, <span class="string">"&lt;system-user-whitelisted-app&gt; without package in "</span></span><br><span class="line">                    + permFile + <span class="string">" at "</span> + parser.getPositionDescription());</span><br><span class="line">                &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                    mSystemUserWhitelistedApps.add(pkgname);</span><br><span class="line">                &#125;</span><br><span class="line">                XmlUtils.skipCurrentTag(parser);</span><br><span class="line"></span><br><span class="line">            &#125; <span class="keyword">else</span> <span class="keyword">if</span> (<span class="string">"system-user-blacklisted-app"</span>.equals(name) &amp;&amp; allowAppConfigs) &#123; </span><br><span class="line">                <span class="comment">//【12】解析 "system-user-blacklisted-app" 标签</span></span><br><span class="line">                <span class="comment">// 获得哪些在 system user 下不可以运行的应用信息！</span></span><br><span class="line">                String pkgname = parser.getAttributeValue(<span class="keyword">null</span>, <span class="string">"package"</span>);</span><br><span class="line">                <span class="keyword">if</span> (pkgname == <span class="keyword">null</span>) &#123;</span><br><span class="line">                    Slog.w(TAG, <span class="string">"&lt;system-user-blacklisted-app without package in "</span> + permFile</span><br><span class="line">                            + <span class="string">" at "</span> + parser.getPositionDescription());</span><br><span class="line">                &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                    mSystemUserBlacklistedApps.add(pkgname);</span><br><span class="line">                &#125;</span><br><span class="line">                XmlUtils.skipCurrentTag(parser);</span><br><span class="line"></span><br><span class="line">            &#125; <span class="keyword">else</span> <span class="keyword">if</span> (<span class="string">"default-enabled-vr-app"</span>.equals(name) &amp;&amp; allowAppConfigs) &#123; </span><br><span class="line">                <span class="comment">//【13】解析 "default-enabled-vr-app" 标签</span></span><br><span class="line">                String pkgname = parser.getAttributeValue(<span class="keyword">null</span>, <span class="string">"package"</span>);</span><br><span class="line">                String clsname = parser.getAttributeValue(<span class="keyword">null</span>, <span class="string">"class"</span>);</span><br><span class="line">                <span class="keyword">if</span> (pkgname == <span class="keyword">null</span>) &#123;</span><br><span class="line">                    Slog.w(TAG, <span class="string">"&lt;default-enabled-vr-app without package in "</span> + permFile</span><br><span class="line">                            + <span class="string">" at "</span> + parser.getPositionDescription());</span><br><span class="line">                &#125; <span class="keyword">else</span> <span class="keyword">if</span> (clsname == <span class="keyword">null</span>) &#123;</span><br><span class="line">                    Slog.w(TAG, <span class="string">"&lt;default-enabled-vr-app without class in "</span> + permFile</span><br><span class="line">                            + <span class="string">" at "</span> + parser.getPositionDescription());</span><br><span class="line">                &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                    mDefaultVrComponents.add(<span class="keyword">new</span> ComponentName(pkgname, clsname));</span><br><span class="line">                &#125;</span><br><span class="line">                XmlUtils.skipCurrentTag(parser);</span><br><span class="line"></span><br><span class="line">            &#125; <span class="keyword">else</span> <span class="keyword">if</span> (<span class="string">"backup-transport-whitelisted-service"</span>.equals(name) &amp;&amp; allowFeatures) &#123;  </span><br><span class="line">                <span class="comment">//【14】解析 "backup-transport-whitelisted-service" 标签</span></span><br><span class="line">                String serviceName = parser.getAttributeValue(<span class="keyword">null</span>, <span class="string">"service"</span>);</span><br><span class="line">                <span class="keyword">if</span> (serviceName == <span class="keyword">null</span>) &#123;</span><br><span class="line">                    Slog.w(TAG, <span class="string">"&lt;backup-transport-whitelisted-service&gt; without service in "</span></span><br><span class="line">                            + permFile + <span class="string">" at "</span> + parser.getPositionDescription());</span><br><span class="line">                &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                    ComponentName cn = ComponentName.unflattenFromString(serviceName);</span><br><span class="line">                    <span class="keyword">if</span> (cn == <span class="keyword">null</span>) &#123;</span><br><span class="line">                        Slog.w(TAG,</span><br><span class="line">                                <span class="string">"&lt;backup-transport-whitelisted-service&gt; with invalid service name "</span></span><br><span class="line">                                + serviceName + <span class="string">" in "</span>+ permFile</span><br><span class="line">                                + <span class="string">" at "</span> + parser.getPositionDescription());</span><br><span class="line">                    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                        mBackupTransportWhitelist.add(cn);</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;</span><br><span class="line">                XmlUtils.skipCurrentTag(parser);</span><br><span class="line"></span><br><span class="line">            &#125; <span class="keyword">else</span> <span class="keyword">if</span> (<span class="string">"disabled-until-used-preinstalled-carrier-associated-app"</span>.equals(name)</span><br><span class="line">                    &amp;&amp; allowAppConfigs) &#123;  </span><br><span class="line">                <span class="comment">//【15】解析 "disabled-until-used-preinstalled-carrier-associated-app" 标签</span></span><br><span class="line">                String pkgname = parser.getAttributeValue(<span class="keyword">null</span>, <span class="string">"package"</span>);</span><br><span class="line">                String carrierPkgname = parser.getAttributeValue(<span class="keyword">null</span>, <span class="string">"carrierAppPackage"</span>);</span><br><span class="line">                <span class="keyword">if</span> (pkgname == <span class="keyword">null</span> || carrierPkgname == <span class="keyword">null</span>) &#123;</span><br><span class="line">                    Slog.w(TAG, <span class="string">"&lt;disabled-until-used-preinstalled-carrier-associated-app"</span></span><br><span class="line">                            + <span class="string">" without package or carrierAppPackage in "</span> + permFile + <span class="string">" at "</span></span><br><span class="line">                            + parser.getPositionDescription());</span><br><span class="line">                &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                    List&lt;String&gt; associatedPkgs =</span><br><span class="line">                            mDisabledUntilUsedPreinstalledCarrierAssociatedApps.get(</span><br><span class="line">                                    carrierPkgname);</span><br><span class="line">                    <span class="keyword">if</span> (associatedPkgs == <span class="keyword">null</span>) &#123;</span><br><span class="line">                        associatedPkgs = <span class="keyword">new</span> ArrayList&lt;&gt;();</span><br><span class="line">                        mDisabledUntilUsedPreinstalledCarrierAssociatedApps.put(</span><br><span class="line">                                carrierPkgname, associatedPkgs);</span><br><span class="line">                    &#125;</span><br><span class="line">                    associatedPkgs.add(pkgname);</span><br><span class="line">                &#125;</span><br><span class="line">                XmlUtils.skipCurrentTag(parser);</span><br><span class="line">            &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                XmlUtils.skipCurrentTag(parser);</span><br><span class="line">                <span class="keyword">continue</span>;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125; <span class="keyword">catch</span> (XmlPullParserException e) &#123;</span><br><span class="line">        Slog.w(TAG, <span class="string">"Got exception parsing permissions."</span>, e);</span><br><span class="line">    &#125; <span class="keyword">catch</span> (IOException e) &#123;</span><br><span class="line">        Slog.w(TAG, <span class="string">"Got exception parsing permissions."</span>, e);</span><br><span class="line">    &#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">        IoUtils.closeQuietly(permReader);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// Some devices can be field-converted to FBE, so offer to splice in</span></span><br><span class="line">    <span class="comment">// those features if not already defined by the static config</span></span><br><span class="line">    <span class="comment">// 加密相关的 feature!</span></span><br><span class="line">    <span class="keyword">if</span> (StorageManager.isFileEncryptedNativeOnly()) &#123;</span><br><span class="line">        addFeature(PackageManager.FEATURE_FILE_BASED_ENCRYPTION, <span class="number">0</span>);</span><br><span class="line">        addFeature(PackageManager.FEATURE_SECURELY_REMOVES_USERS, <span class="number">0</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 从 mAvailableFeatures 移除不支持的 feature！</span></span><br><span class="line">    <span class="keyword">for</span> (String featureName : mUnavailableFeatures) &#123;</span><br><span class="line">        removeFeature(featureName);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>这个方法的流程如下：</p>
<ul>
<li>解析 “group” 标签；</li>
<li>解析 “permission” 标签；</li>
<li>解析 “assign-permission” 标签；</li>
<li>解析 “library” 标签 </li>
<li>解析 “feature” 标签 </li>
<li>解析 “unavailable-feature” 标签</li>
<li>解析 “allow-in-power-save-except-idle” 标签</li>
<li>解析 “allow-in-power-save” 标签</li>
<li>解析 “allow-in-data-usage-save” 标签</li>
<li>解析 “app-link” 标签</li>
<li>解析 “system-user-whitelisted-app” 标签</li>
<li>解析 “system-user-blacklisted-app” 标签</li>
<li>解析 “default-enabled-vr-app” 标签</li>
<li>解析 “backup-transport-whitelisted-service” 标签</li>
<li>解析 “disabled-until-used-preinstalled-carrier-associated-app” 标签</li>
</ul>
<p>这些解析后的数据都会保存到下面的集合中：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br></pre></td><td class="code"><pre><span class="line">public class SystemConfig &#123;</span><br><span class="line"></span><br><span class="line">    // 系统定义的所有的 gid！</span><br><span class="line">    int[] mGlobalGids;</span><br><span class="line"></span><br><span class="line">    // 保存了 uid 和其所有的权限信息的映射关系！</span><br><span class="line">    final SparseArray&lt;ArraySet&lt;String&gt;&gt; mSystemPermissions = new SparseArray&lt;&gt;();</span><br><span class="line"></span><br><span class="line">    // 系统所有的共享库信息，key 是 lib name，value 是 lib path！</span><br><span class="line">    final ArrayMap&lt;String, String&gt; mSharedLibraries  = new ArrayMap&lt;&gt;();</span><br><span class="line"></span><br><span class="line">    // 系统中可用的 feature！</span><br><span class="line">    final ArrayMap&lt;String, FeatureInfo&gt; mAvailableFeatures = new ArrayMap&lt;&gt;();</span><br><span class="line"></span><br><span class="line">    // 系统中不可用的 feature！</span><br><span class="line">    final ArraySet&lt;String&gt; mUnavailableFeatures = new ArraySet&lt;&gt;();</span><br><span class="line"></span><br><span class="line">    // 保存了 gid 和其所拥有的权限的映射关系！</span><br><span class="line">    final ArrayMap&lt;String, PermissionEntry&gt; mPermissions = new ArrayMap&lt;&gt;();</span><br><span class="line"></span><br><span class="line">    final ArraySet&lt;String&gt; mAllowInPowerSaveExceptIdle = new ArraySet&lt;&gt;();</span><br><span class="line">    final ArraySet&lt;String&gt; mAllowInPowerSave = new ArraySet&lt;&gt;();</span><br><span class="line">    final ArraySet&lt;String&gt; mAllowInDataUsageSave = new ArraySet&lt;&gt;();</span><br><span class="line"></span><br><span class="line">    final ArraySet&lt;String&gt; mLinkedApps = new ArraySet&lt;&gt;();</span><br><span class="line">    final ArraySet&lt;String&gt; mSystemUserWhitelistedApps = new ArraySet&lt;&gt;();</span><br><span class="line">    final ArraySet&lt;String&gt; mSystemUserBlacklistedApps = new ArraySet&lt;&gt;();</span><br><span class="line"></span><br><span class="line">    // 默认的 VR 组件信息！</span><br><span class="line">    final ArraySet&lt;ComponentName&gt; mDefaultVrComponents = new ArraySet&lt;&gt;();</span><br><span class="line">    final ArraySet&lt;ComponentName&gt; mBackupTransportWhitelist = new ArraySet&lt;&gt;();</span><br><span class="line">    final ArrayMap&lt;String, List&lt;String&gt;&gt; mDisabledUntilUsedPreinstalledCarrierAssociatedApps =</span><br><span class="line">            new ArrayMap&lt;&gt;();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>下面，我们重点分析几个配置解析，以 /system/etc/permissions 为例，该目录所有的 xml 文件的根节点都是：<br><figure class="highlight"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">&lt;permissions&gt;</span><br><span class="line"></span><br><span class="line">&lt;/permissions&gt;</span><br></pre></td></tr></table></figure></p>
<p>下面我们继续来看：</p>
<h3 id="2-2-1-解析-“group”-获得系统中的所有-gid"><a href="#2-2-1-解析-“group”-获得系统中的所有-gid" class="headerlink" title="2.2.1 解析 “group” - 获得系统中的所有 gid"></a>2.2.1 解析 “group” - 获得系统中的所有 gid</h3><p>和 “group” 相关的 xml 内容如下，可以看到  “group” 并不是单独存在的，而是和  “permission” 一起配合使用！</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">permissions</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">permission</span> <span class="attr">name</span>=<span class="string">"android.permission.BLUETOOTH_ADMIN"</span> &gt;</span></span><br><span class="line">        <span class="comment">&lt;!--解析 group 标签--&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">group</span> <span class="attr">gid</span>=<span class="string">"net_bt_admin"</span> /&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">permission</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">permissions</span>&gt;</span></span><br></pre></td></tr></table></figure>
<p>下面是解析过程：<br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">if</span> (<span class="string">"group"</span>.equals(name) &amp;&amp; allowAll) &#123; </span><br><span class="line">    <span class="comment">//【1】解析 "group" 标签</span></span><br><span class="line">    String gidStr = parser.getAttributeValue(<span class="keyword">null</span>, <span class="string">"gid"</span>);</span><br><span class="line">    <span class="keyword">if</span> (gidStr != <span class="keyword">null</span>) &#123;</span><br><span class="line">        <span class="comment">// 将 Gid 从字符串形式转为对应的 int 形式！</span></span><br><span class="line">        <span class="keyword">int</span> gid = android.os.Process.getGidForName(gidStr);</span><br><span class="line">        mGlobalGids = appendInt(mGlobalGids, gid);</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        Slog.w(TAG, <span class="string">"&lt;group&gt; without gid in "</span> + permFile + <span class="string">" at "</span></span><br><span class="line">                    + parser.getPositionDescription());</span><br><span class="line">    &#125;</span><br><span class="line">    XmlUtils.skipCurrentTag(parser);</span><br><span class="line">    <span class="keyword">continue</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>根据组名称，调用 android.os.Process.getGidForName 转为 gid，保存到 mGlobalGids！</p>
<h3 id="2-2-2-解析-“permission”-获得系统权限和所属的-gid"><a href="#2-2-2-解析-“permission”-获得系统权限和所属的-gid" class="headerlink" title="2.2.2 解析 “permission” - 获得系统权限和所属的 gid"></a>2.2.2 解析 “permission” - 获得系统权限和所属的 gid</h3><p>xml 信息如下：<br><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">permissions</span>&gt;</span></span><br><span class="line">    <span class="comment">&lt;!--解析 permission 标签--&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">permission</span> <span class="attr">name</span>=<span class="string">"android.permission.BLUETOOTH_ADMIN"</span> &gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">group</span> <span class="attr">gid</span>=<span class="string">"net_bt_admin"</span> /&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">permission</span>&gt;</span></span><br><span class="line"></span><br><span class="line">    <span class="tag">&lt;<span class="name">permission</span> <span class="attr">name</span>=<span class="string">"android.permission.BLUETOOTH"</span> &gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">group</span> <span class="attr">gid</span>=<span class="string">"net_bt"</span> /&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">permission</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">permissions</span>&gt;</span></span><br></pre></td></tr></table></figure></p>
<p>下面是解析过程：<br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"> &#125; <span class="keyword">else</span> <span class="keyword">if</span> (<span class="string">"permission"</span>.equals(name) &amp;&amp; allowPermissions) &#123; </span><br><span class="line">    <span class="comment">//【1】解析 "permission" 标签，获得权限的名称 perm！</span></span><br><span class="line">    String perm = parser.getAttributeValue(<span class="keyword">null</span>, <span class="string">"name"</span>);</span><br><span class="line">    <span class="keyword">if</span> (perm == <span class="keyword">null</span>) &#123;</span><br><span class="line">        Slog.w(TAG, <span class="string">"&lt;permission&gt; without name in "</span> + permFile + <span class="string">" at "</span></span><br><span class="line">                 + parser.getPositionDescription());</span><br><span class="line">        XmlUtils.skipCurrentTag(parser);</span><br><span class="line">        <span class="keyword">continue</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    perm = perm.intern();</span><br><span class="line">            </span><br><span class="line">    <span class="comment">//【2】调用 readPermission 继续解析权限</span></span><br><span class="line">    readPermission(parser, perm);</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>进一步调用 readPermission 方法：<br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">readPermission</span><span class="params">(XmlPullParser parser, String name)</span></span></span><br><span class="line"><span class="function">        <span class="keyword">throws</span> IOException, XmlPullParserException </span>&#123;</span><br><span class="line">    <span class="comment">//【1】如果 mPermissions 已经包含这个权限，解析冲突！</span></span><br><span class="line">    <span class="keyword">if</span> (mPermissions.containsKey(name)) &#123;</span><br><span class="line">        <span class="keyword">throw</span> <span class="keyword">new</span> IllegalStateException(<span class="string">"Duplicate permission definition for "</span> + name);</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">//【2】perUser 表示该权限的 gid 是否针对设备用户 id 进行调整，默认为 false！</span></span><br><span class="line">    <span class="keyword">final</span> <span class="keyword">boolean</span> perUser = XmlUtils.readBooleanAttribute(parser, <span class="string">"perUser"</span>, <span class="keyword">false</span>);</span><br><span class="line">    </span><br><span class="line">    <span class="comment">//【3】创建 PermissionEntry，并添加到 mPermissions 中！</span></span><br><span class="line">    <span class="keyword">final</span> PermissionEntry perm = <span class="keyword">new</span> PermissionEntry(name, perUser);</span><br><span class="line">    mPermissions.put(name, perm);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">int</span> outerDepth = parser.getDepth();</span><br><span class="line">    <span class="keyword">int</span> type;</span><br><span class="line">    <span class="keyword">while</span> ((type=parser.next()) != XmlPullParser.END_DOCUMENT</span><br><span class="line">           &amp;&amp; (type != XmlPullParser.END_TAG</span><br><span class="line">                   || parser.getDepth() &gt; outerDepth)) &#123;</span><br><span class="line">        <span class="keyword">if</span> (type == XmlPullParser.END_TAG</span><br><span class="line">                || type == XmlPullParser.TEXT) &#123;</span><br><span class="line">            <span class="keyword">continue</span>;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        String tagName = parser.getName();</span><br><span class="line"></span><br><span class="line">        <span class="comment">//【4】解析内部 "group" 标签，获得权限所属的 gid，将其添加到 PermissionEntry 的 gids 数组中！</span></span><br><span class="line">        <span class="keyword">if</span> (<span class="string">"group"</span>.equals(tagName)) &#123;</span><br><span class="line">            String gidStr = parser.getAttributeValue(<span class="keyword">null</span>, <span class="string">"gid"</span>);</span><br><span class="line">            <span class="keyword">if</span> (gidStr != <span class="keyword">null</span>) &#123;</span><br><span class="line">                <span class="keyword">int</span> gid = Process.getGidForName(gidStr);</span><br><span class="line">                perm.gids = appendInt(perm.gids, gid);</span><br><span class="line">            &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                Slog.w(TAG, <span class="string">"&lt;group&gt; without gid at "</span></span><br><span class="line">                        + parser.getPositionDescription());</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        XmlUtils.skipCurrentTag(parser);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>可以看到，解析 “permission” 标签以及其内部的标签 “group”，获得了 gid 和权限的映射关系，保存到了 mPermissions 中，一个权限可以对应多个 gid！</p>
<h3 id="2-2-3-解析-“assign-permission”-给指定的-uid-分配权限"><a href="#2-2-3-解析-“assign-permission”-给指定的-uid-分配权限" class="headerlink" title="2.2.3 解析 “assign-permission” - 给指定的 uid 分配权限"></a>2.2.3 解析 “assign-permission” - 给指定的 uid 分配权限</h3><p>“assign-permission” 的 xml 内容如下：<br><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">assign-permission</span> <span class="attr">name</span>=<span class="string">"android.permission.MODIFY_AUDIO_SETTINGS"</span> <span class="attr">uid</span>=<span class="string">"media"</span> /&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">assign-permission</span> <span class="attr">name</span>=<span class="string">"android.permission.ACCESS_SURFACE_FLINGER"</span> <span class="attr">uid</span>=<span class="string">"media"</span> /&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">assign-permission</span> <span class="attr">name</span>=<span class="string">"android.permission.WAKE_LOCK"</span> <span class="attr">uid</span>=<span class="string">"media"</span> /&gt;</span></span><br></pre></td></tr></table></figure></p>
<p>下面是解析过程：<br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br></pre></td><td class="code"><pre><span class="line">&#125; <span class="keyword">else</span> <span class="keyword">if</span> (<span class="string">"assign-permission"</span>.equals(name) &amp;&amp; allowPermissions) &#123; </span><br><span class="line">    <span class="comment">//【1】解析 "name" 属性，获得权限的名称！</span></span><br><span class="line">    String perm = parser.getAttributeValue(<span class="keyword">null</span>, <span class="string">"name"</span>);</span><br><span class="line">    <span class="keyword">if</span> (perm == <span class="keyword">null</span>) &#123;</span><br><span class="line">        Slog.w(TAG, <span class="string">"&lt;assign-permission&gt; without name in "</span> + permFile + <span class="string">" at "</span></span><br><span class="line">                        + parser.getPositionDescription());</span><br><span class="line">        XmlUtils.skipCurrentTag(parser);</span><br><span class="line">        <span class="keyword">continue</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">//【2】获得权限所属用户的名称！</span></span><br><span class="line">    String uidStr = parser.getAttributeValue(<span class="keyword">null</span>, <span class="string">"uid"</span>);</span><br><span class="line">    <span class="keyword">if</span> (uidStr == <span class="keyword">null</span>) &#123;</span><br><span class="line">        Slog.w(TAG, <span class="string">"&lt;assign-permission&gt; without uid in "</span> + permFile + <span class="string">" at "</span></span><br><span class="line">                    + parser.getPositionDescription());</span><br><span class="line">        XmlUtils.skipCurrentTag(parser);</span><br><span class="line">        <span class="keyword">continue</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">//【3】获得用户 uid！</span></span><br><span class="line">    <span class="keyword">int</span> uid = Process.getUidForName(uidStr);</span><br><span class="line">    <span class="keyword">if</span> (uid &lt; <span class="number">0</span>) &#123;</span><br><span class="line">        Slog.w(TAG, <span class="string">"&lt;assign-permission&gt; with unknown uid \""</span></span><br><span class="line">                + uidStr + <span class="string">"  in "</span> + permFile + <span class="string">" at "</span></span><br><span class="line">                + parser.getPositionDescription());</span><br><span class="line">        XmlUtils.skipCurrentTag(parser);</span><br><span class="line">        <span class="keyword">continue</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    perm = perm.intern();</span><br><span class="line">    ArraySet&lt;String&gt; perms = mSystemPermissions.get(uid);</span><br><span class="line">    <span class="keyword">if</span> (perms == <span class="keyword">null</span>) &#123;</span><br><span class="line">        perms = <span class="keyword">new</span> ArraySet&lt;String&gt;();</span><br><span class="line">        mSystemPermissions.put(uid, perms);</span><br><span class="line">    &#125;</span><br><span class="line">    perms.add(perm);</span><br><span class="line">    XmlUtils.skipCurrentTag(parser);</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>可以看到，解析 “assign-permission” 标签，获得了 uid 和权限的映射关系，保存到了 mSystemPermissions 中，一个 uid 可以对应多个权限！</p>
<h3 id="2-2-4-解析-“library”-获得共享库信息"><a href="#2-2-4-解析-“library”-获得共享库信息" class="headerlink" title="2.2.4 解析 “library” - 获得共享库信息"></a>2.2.4 解析 “library” - 获得共享库信息</h3><p>xml 信息如下：<br><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">library</span> <span class="attr">name</span>=<span class="string">"android.test.runner"</span></span></span><br><span class="line"><span class="tag">        <span class="attr">file</span>=<span class="string">"/system/framework/android.test.runner.jar"</span> /&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">library</span> <span class="attr">name</span>=<span class="string">"javax.obex"</span></span></span><br><span class="line"><span class="tag">        <span class="attr">file</span>=<span class="string">"/system/framework/javax.obex.jar"</span> /&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">library</span> <span class="attr">name</span>=<span class="string">"org.apache.http.legacy"</span></span></span><br><span class="line"><span class="tag">        <span class="attr">file</span>=<span class="string">"/system/framework/org.apache.http.legacy.jar"</span> /&gt;</span></span><br></pre></td></tr></table></figure></p>
<p>下面是解析过程：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line">&#125; <span class="keyword">else</span> <span class="keyword">if</span> (<span class="string">"library"</span>.equals(name) &amp;&amp; allowLibs) &#123; </span><br><span class="line">    <span class="comment">//【1】解析 "library" 标签</span></span><br><span class="line">    String lname = parser.getAttributeValue(<span class="keyword">null</span>, <span class="string">"name"</span>);</span><br><span class="line">    String lfile = parser.getAttributeValue(<span class="keyword">null</span>, <span class="string">"file"</span>);</span><br><span class="line">    <span class="keyword">if</span> (lname == <span class="keyword">null</span>) &#123;</span><br><span class="line">        Slog.w(TAG, <span class="string">"&lt;library&gt; without name in "</span> + permFile + <span class="string">" at "</span></span><br><span class="line">                + parser.getPositionDescription());</span><br><span class="line">    &#125; <span class="keyword">else</span> <span class="keyword">if</span> (lfile == <span class="keyword">null</span>) &#123;</span><br><span class="line">        Slog.w(TAG, <span class="string">"&lt;library&gt; without file in "</span> + permFile + <span class="string">" at "</span></span><br><span class="line">                + parser.getPositionDescription());</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        <span class="comment">//Log.i(TAG, "Got library " + lname + " in " + lfile);</span></span><br><span class="line">        mSharedLibraries.put(lname, lfile);</span><br><span class="line">    &#125;</span><br><span class="line">    XmlUtils.skipCurrentTag(parser);</span><br><span class="line">    <span class="keyword">continue</span>;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>解析共享库信息，保存到 mSharedLibraries 中，key 为 共享库名称，value 为共享库路径！</p>
<h3 id="2-2-5-解析-“feature”-获得系统特性配置信息"><a href="#2-2-5-解析-“feature”-获得系统特性配置信息" class="headerlink" title="2.2.5 解析 “feature” - 获得系统特性配置信息"></a>2.2.5 解析 “feature” - 获得系统特性配置信息</h3><p>“feature” 的 xml 内容如下：<br><figure class="highlight"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">&lt;permissions&gt;</span><br><span class="line">    &lt;feature name=<span class="string">"android.hardware.bluetooth"</span> /&gt;</span><br><span class="line">&lt;/permissions&gt;</span><br></pre></td></tr></table></figure></p>
<p>下面是解析过程：<br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br></pre></td><td class="code"><pre><span class="line">&#125; <span class="keyword">else</span> <span class="keyword">if</span> (<span class="string">"feature"</span>.equals(name) &amp;&amp; allowFeatures) &#123; </span><br><span class="line"></span><br><span class="line">    <span class="comment">//【1】解析 "feature" 标签</span></span><br><span class="line">    <span class="comment">// 获得 feature 的名称和版本号</span></span><br><span class="line">    String fname = parser.getAttributeValue(<span class="keyword">null</span>, <span class="string">"name"</span>);</span><br><span class="line">    <span class="keyword">int</span> fversion = XmlUtils.readIntAttribute(parser, <span class="string">"version"</span>, <span class="number">0</span>);</span><br><span class="line">    <span class="keyword">boolean</span> allowed;</span><br><span class="line">    <span class="keyword">if</span> (!lowRam) &#123;</span><br><span class="line">        allowed = <span class="keyword">true</span>;</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        String notLowRam = parser.getAttributeValue(<span class="keyword">null</span>, <span class="string">"notLowRam"</span>);</span><br><span class="line">        allowed = !<span class="string">"true"</span>.equals(notLowRam);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span> (fname == <span class="keyword">null</span>) &#123;</span><br><span class="line">        Slog.w(TAG, <span class="string">"&lt;feature&gt; without name in "</span> + permFile + <span class="string">" at "</span></span><br><span class="line">                + parser.getPositionDescription());</span><br><span class="line">    &#125; <span class="keyword">else</span> <span class="keyword">if</span> (allowed) &#123;</span><br><span class="line">        addFeature(fname, fversion);</span><br><span class="line">    &#125;</span><br><span class="line">    XmlUtils.skipCurrentTag(parser);</span><br><span class="line">    <span class="keyword">continue</span>;</span><br><span class="line"></span><br><span class="line">&#125; <span class="keyword">else</span> <span class="keyword">if</span> (<span class="string">"unavailable-feature"</span>.equals(name) &amp;&amp; allowFeatures) &#123;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//【2】解析 "unavailable-feature" 标签</span></span><br><span class="line">    String fname = parser.getAttributeValue(<span class="keyword">null</span>, <span class="string">"name"</span>);</span><br><span class="line">    <span class="keyword">if</span> (fname == <span class="keyword">null</span>) &#123;</span><br><span class="line">        Slog.w(TAG, <span class="string">"&lt;unavailable-feature&gt; without name in "</span> + permFile + <span class="string">" at "</span></span><br><span class="line">                + parser.getPositionDescription());</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        mUnavailableFeatures.add(fname);</span><br><span class="line">    &#125;</span><br><span class="line">    XmlUtils.skipCurrentTag(parser);</span><br><span class="line">    <span class="keyword">continue</span>;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>上面会把配置文件中的 feature 解析出来，可用 feature 会被添加到 mAvailableFeatures 中，不可用 feature 会被添加到 mUnavailableFeatures 中！</p>
<h3 id="2-2-6-解析其他的标签"><a href="#2-2-6-解析其他的标签" class="headerlink" title="2.2.6 解析其他的标签"></a>2.2.6 解析其他的标签</h3><p>其他的标签有如下几个:</p>
<ul>
<li>解析 <strong>“allow-in-power-save-except-idle”</strong>，这个是省电模式的白名单，该白名单不包括 idle 白名单！<ul>
<li>mAllowInPowerSaveExceptIdle.add(pkgname);</li>
</ul>
</li>
</ul>
<ul>
<li><p>解析 <strong>“allow-in-power-save”</strong>，这个是省电模式的白名单！</p>
<ul>
<li>mAllowInPowerSave.add(pkgname);</li>
</ul>
</li>
<li><p>解析 <strong>“allow-in-data-usage-save”</strong></p>
<ul>
<li>mAllowInDataUsageSave.add(pkgname);</li>
</ul>
</li>
<li><p>解析 <strong>“app-link”</strong></p>
<ul>
<li>mLinkedApps.add(pkgname);</li>
</ul>
</li>
<li><p>解析 <strong>“system-user-whitelisted-app”</strong></p>
<ul>
<li>mSystemUserWhitelistedApps.add(pkgname);</li>
</ul>
</li>
<li><p>解析 <strong>“default-enabled-vr-app”</strong></p>
<ul>
<li>mDefaultVrComponents.add(new ComponentName(pkgname, clsname));</li>
</ul>
</li>
<li><p>解析 <strong>“backup-transport-whitelisted-service”</strong></p>
<ul>
<li>ComponentName cn = ComponentName.unflattenFromString(serviceName);  </li>
<li>mBackupTransportWhitelist.add(cn);</li>
</ul>
</li>
<li><p>解析 <strong>“disabled-until-used-preinstalled-carrier-associated-app”</strong></p>
<ul>
<li>associatedPkgs = new ArrayList&lt;&gt;();</li>
<li>mDisabledUntilUsedPreinstalledCarrierAssociatedApps.put(carrierPkgname, associatedPkgs);</li>
<li>associatedPkgs.add(pkgname);</li>
</ul>
</li>
</ul>
<p>SystemConfig 内部的数据关系图：</p>
<p><img src="http://static.zybuluo.com/Coolqi/0g1rmxre4lcm4b8u2vg0wwv5/SystemConfig.png" alt="SystemConfig.png-199.2kB"></p>
<h2 id="2-3-PMS-对于-SystemConfig-的后续处理"><a href="#2-3-PMS-对于-SystemConfig-的后续处理" class="headerlink" title="2.3 PMS 对于 SystemConfig 的后续处理"></a>2.3 PMS 对于 SystemConfig 的后续处理</h2><p>然后，回到 PMS 的构造器中：<br>将 SystemConfig 中的 mGlobalGids，mSystemPermissions 和 mAvailableFeatures 拷贝一份保存到 PMS 中！<br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//【1】保存到 PMS 中！</span></span><br><span class="line">mGlobalGids = systemConfig.getGlobalGids();</span><br><span class="line">mSystemPermissions = systemConfig.getSystemPermissions();</span><br><span class="line">mAvailableFeatures = systemConfig.getAvailableFeatures();</span><br></pre></td></tr></table></figure></p>
<p>接着，处理权限信息和共享库信息，将解析出来的 mPermissions 信息保存到 Setting 的 mPermissions 中，权限所属的包名为 android !</p>
<p>因为 SystemConfig.mPermissions 保存的是系统中定义的权限和对应的 Gid 的关系！！<br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//【2】从获得 SystemConfig 加载的系统权限集合 mPermissions！</span></span><br><span class="line">ArrayMap&lt;String, SystemConfig.PermissionEntry&gt; permConfig</span><br><span class="line">        = systemConfig.getPermissions();</span><br><span class="line"></span><br><span class="line"><span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; permConfig.size(); i++) &#123;</span><br><span class="line">    SystemConfig.PermissionEntry perm = permConfig.valueAt(i);</span><br><span class="line">    BasePermission bp = mSettings.mPermissions.get(perm.name);</span><br><span class="line">    </span><br><span class="line">    <span class="comment">//【2】加入到 Settings 的 mPermissions 中，SystemConfig 解析的权限的包名都为 “android”！</span></span><br><span class="line">    <span class="keyword">if</span> (bp == <span class="keyword">null</span>) &#123;</span><br><span class="line">        <span class="comment">// BasePermission.TYPE_BUILTIN 表示的是在编译时期就确定好的，系统要提供的权限！</span></span><br><span class="line">        bp = <span class="keyword">new</span> BasePermission(perm.name, <span class="string">"android"</span>, BasePermission.TYPE_BUILTIN);</span><br><span class="line">        mSettings.mPermissions.put(perm.name, bp);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// 如果系统权限有所属的 gids，将其添加到 BasePermission 对象中！</span></span><br><span class="line">    <span class="keyword">if</span> (perm.gids != <span class="keyword">null</span>) &#123;</span><br><span class="line">        bp.setGids(perm.gids, perm.perUser);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">//【3】处理共享库，将共享库信息也保存一份在 PMS 中！</span></span><br><span class="line">ArrayMap&lt;String, String&gt; libConfig = systemConfig.getSharedLibraries();</span><br><span class="line"><span class="keyword">for</span> (<span class="keyword">int</span> i=<span class="number">0</span>; i&lt;libConfig.size(); i++) &#123;</span><br><span class="line">    mSharedLibraries.put(libConfig.keyAt(i),</span><br><span class="line">            <span class="keyword">new</span> SharedLibraryEntry(libConfig.valueAt(i), <span class="keyword">null</span>));</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>创建了一个 BasePermission 对象，封装系统权限！！<br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">BasePermission(String _name, String _sourcePackage, <span class="keyword">int</span> _type) &#123;</span><br><span class="line">    name = _name; <span class="comment">// 权限名；</span></span><br><span class="line">    sourcePackage = _sourcePackage; <span class="comment">// 定义权限的包名；</span></span><br><span class="line">    type = _type; <span class="comment">// 权限类型！</span></span><br><span class="line">    <span class="comment">// Default to most conservative protection level.</span></span><br><span class="line">    protectionLevel = PermissionInfo.PROTECTION_SIGNATURE; <span class="comment">// 权限界别！</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>同时设置系统权限的 gid：<br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">setGids</span><span class="params">(<span class="keyword">int</span>[] gids, <span class="keyword">boolean</span> perUser)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">this</span>.gids = gids; <span class="comment">// 设置 gids</span></span><br><span class="line">    <span class="keyword">this</span>.perUser = perUser;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>可以看到，SystemConfig 保存的均是和系统相关的属性信息，比如系统权限，系统特性， Gid 等等，而 Settings 中则保存的系统和和应用所有的信息，所以，这里需要将 SystemConfig 中的权限信息保存过来！</p>
<p>这里就先分析到这里，后面会继续补充！</p>
<h2 id="2-4-阶段总结"><a href="#2-4-阶段总结" class="headerlink" title="2.4 阶段总结"></a>2.4 阶段总结</h2><p>我们来总结一下，SystemConfig、Settings 以及 PackageManagerService 之间的数据关系：</p>
<p><img src="http://static.zybuluo.com/Coolqi/k8x8t2wuygcwxb03ecqvp29k/pic.png" alt="pic.png-81.1kB"></p>
<p>通过 SystemConfig 解析，我们可以系统定义的一些配置信息：</p>
<ul>
<li>系统定义的一些 gid；</li>
<li>系统定义的权限和 uid 的映射关系；</li>
<li>系统定义的权限和 gid 的映射关系；</li>
<li>系统共享库和feature；</li>
</ul>
<p>我们继续看！</p>
<h1 id="6-PackageHandler"><a href="#6-PackageHandler" class="headerlink" title="6 PackageHandler"></a>6 PackageHandler</h1><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 建立并启动一个名为 “PackageManager” 的 ServiceThread，用于处理一些耗时的操作！</span></span><br><span class="line">mHandlerThread = <span class="keyword">new</span> ServiceThread(TAG,</span><br><span class="line">            Process.THREAD_PRIORITY_BACKGROUND, <span class="keyword">true</span> <span class="comment">/*allowIo*/</span>);</span><br><span class="line">mHandlerThread.start();</span><br><span class="line"><span class="comment">// 创建一个 PackageHandler 对象，绑定前面创建的 HandlerThread！</span></span><br><span class="line">mHandler = <span class="keyword">new</span> PackageHandler(mHandlerThread.getLooper());</span><br></pre></td></tr></table></figure>
<p>这里的 ServiceThread 继承了 HandlerThread，专门为系统服务定义的！</p>
<p>PackageHandler 处理的 msg 有如下：<br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">static</span> <span class="keyword">final</span> <span class="keyword">int</span> SEND_PENDING_BROADCAST = <span class="number">1</span>;</span><br><span class="line"><span class="keyword">static</span> <span class="keyword">final</span> <span class="keyword">int</span> MCS_BOUND = <span class="number">3</span>;</span><br><span class="line"><span class="keyword">static</span> <span class="keyword">final</span> <span class="keyword">int</span> END_COPY = <span class="number">4</span>;</span><br><span class="line"><span class="keyword">static</span> <span class="keyword">final</span> <span class="keyword">int</span> INIT_COPY = <span class="number">5</span>;</span><br><span class="line"><span class="keyword">static</span> <span class="keyword">final</span> <span class="keyword">int</span> MCS_UNBIND = <span class="number">6</span>;</span><br><span class="line"><span class="keyword">static</span> <span class="keyword">final</span> <span class="keyword">int</span> START_CLEANING_PACKAGE = <span class="number">7</span>; <span class="comment">// 清楚 package</span></span><br><span class="line"><span class="keyword">static</span> <span class="keyword">final</span> <span class="keyword">int</span> FIND_INSTALL_LOC = <span class="number">8</span>;</span><br><span class="line"><span class="keyword">static</span> <span class="keyword">final</span> <span class="keyword">int</span> POST_INSTALL = <span class="number">9</span>; <span class="comment">// 安装 package</span></span><br><span class="line"><span class="keyword">static</span> <span class="keyword">final</span> <span class="keyword">int</span> MCS_RECONNECT = <span class="number">10</span>;</span><br><span class="line"><span class="keyword">static</span> <span class="keyword">final</span> <span class="keyword">int</span> MCS_GIVE_UP = <span class="number">11</span>;</span><br><span class="line"><span class="keyword">static</span> <span class="keyword">final</span> <span class="keyword">int</span> UPDATED_MEDIA_STATUS = <span class="number">12</span>;</span><br><span class="line"><span class="keyword">static</span> <span class="keyword">final</span> <span class="keyword">int</span> WRITE_SETTINGS = <span class="number">13</span>;</span><br><span class="line"><span class="keyword">static</span> <span class="keyword">final</span> <span class="keyword">int</span> WRITE_PACKAGE_RESTRICTIONS = <span class="number">14</span>;</span><br><span class="line"><span class="keyword">static</span> <span class="keyword">final</span> <span class="keyword">int</span> PACKAGE_VERIFIED = <span class="number">15</span>; <span class="comment">// 校验 package</span></span><br><span class="line"><span class="keyword">static</span> <span class="keyword">final</span> <span class="keyword">int</span> CHECK_PENDING_VERIFICATION = <span class="number">16</span>;</span><br><span class="line"><span class="keyword">static</span> <span class="keyword">final</span> <span class="keyword">int</span> START_INTENT_FILTER_VERIFICATIONS = <span class="number">17</span>;</span><br><span class="line"><span class="keyword">static</span> <span class="keyword">final</span> <span class="keyword">int</span> INTENT_FILTER_VERIFIED = <span class="number">18</span>;</span><br><span class="line"><span class="keyword">static</span> <span class="keyword">final</span> <span class="keyword">int</span> WRITE_PACKAGE_LIST = <span class="number">19</span>;</span><br></pre></td></tr></table></figure></p>
<p>一些耗时的操作，pms 都会交给 PackageHandler 去做，比如安装应用，卸载应用等等的操作，这个以后再分析！</p>
<h1 id="7-SELinuxMMAC-readInstallPolicy"><a href="#7-SELinuxMMAC-readInstallPolicy" class="headerlink" title="7 SELinuxMMAC.readInstallPolicy"></a>7 SELinuxMMAC.readInstallPolicy</h1><p>调用 SELinuxMMAC.readInstallPolicy 读取 /etc/security/mac_permissions.xml 文件中的 selinux 配置，设置应用程序的安全上下文！<br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">boolean</span> <span class="title">readInstallPolicy</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    <span class="comment">// Temp structure to hold the rules while we parse the xml file</span></span><br><span class="line">    List&lt;Policy&gt; policies = <span class="keyword">new</span> ArrayList&lt;&gt;();</span><br><span class="line"></span><br><span class="line">    FileReader policyFile = <span class="keyword">null</span>;</span><br><span class="line">    XmlPullParser parser = Xml.newPullParser();</span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">        <span class="comment">//【1】获得 /etc/security/mac_permissions.xml 文件引用！</span></span><br><span class="line">        policyFile = <span class="keyword">new</span> FileReader(MAC_PERMISSIONS);</span><br><span class="line">        Slog.d(TAG, <span class="string">"Using policy file "</span> + MAC_PERMISSIONS);</span><br><span class="line"></span><br><span class="line">        parser.setInput(policyFile);</span><br><span class="line">        parser.nextTag();</span><br><span class="line">        parser.require(XmlPullParser.START_TAG, <span class="keyword">null</span>, <span class="string">"policy"</span>);</span><br><span class="line"></span><br><span class="line">        <span class="keyword">while</span> (parser.next() != XmlPullParser.END_TAG) &#123;</span><br><span class="line">            <span class="keyword">if</span> (parser.getEventType() != XmlPullParser.START_TAG) &#123;</span><br><span class="line">                <span class="keyword">continue</span>;</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            <span class="keyword">switch</span> (parser.getName()) &#123;</span><br><span class="line">                <span class="keyword">case</span> <span class="string">"signer"</span>: <span class="comment">//【7.1】解析 "signer" 标签的内容，返回一个 Policy 对象！！</span></span><br><span class="line">                    policies.add(readSignerOrThrow(parser));</span><br><span class="line">                    <span class="keyword">break</span>;</span><br><span class="line">                <span class="keyword">default</span>:</span><br><span class="line">                    skip(parser);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125; <span class="keyword">catch</span> (IllegalStateException | IllegalArgumentException |</span><br><span class="line">            XmlPullParserException ex) &#123;</span><br><span class="line">        ... ... ... ...</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">false</span>;</span><br><span class="line">    &#125; <span class="keyword">catch</span> (IOException ioe) &#123;</span><br><span class="line">        Slog.w(TAG, <span class="string">"Exception parsing "</span> + MAC_PERMISSIONS, ioe);</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">false</span>;</span><br><span class="line">    &#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">        IoUtils.closeQuietly(policyFile);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//【3】使用比较器对其进行排序！</span></span><br><span class="line">    PolicyComparator policySort = <span class="keyword">new</span> PolicyComparator();</span><br><span class="line">    Collections.sort(policies, policySort);</span><br><span class="line">    <span class="keyword">if</span> (policySort.foundDuplicate()) &#123;</span><br><span class="line">        Slog.w(TAG, <span class="string">"ERROR! Duplicate entries found parsing "</span> + MAC_PERMISSIONS);</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">false</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    </span><br><span class="line">    <span class="keyword">synchronized</span> (sPolicies) &#123;</span><br><span class="line">        sPolicies = policies;</span><br><span class="line">        <span class="keyword">if</span> (DEBUG_POLICY_ORDER) &#123;</span><br><span class="line">            <span class="keyword">for</span> (Policy policy : sPolicies) &#123;</span><br><span class="line">                Slog.d(TAG, <span class="string">"Policy: "</span> + policy.toString());</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">true</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>这里用到了一个文件对象！<br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> File MAC_PERMISSIONS = <span class="keyword">new</span> File(Environment.getRootDirectory(),</span><br><span class="line">        <span class="string">"/etc/security/mac_permissions.xml"</span>);</span><br></pre></td></tr></table></figure></p>
<p>我们来看下该文件的内容；<br><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">policy</span>&gt;</span></span><br><span class="line">    <span class="comment">&lt;!-- Platform dev key in AOSP --&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">signer</span> <span class="attr">signature</span>=<span class="string">"@PLATFORM"</span> &gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">seinfo</span> <span class="attr">value</span>=<span class="string">"platform"</span> /&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">signer</span>&gt;</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">&lt;!-- Media key in AOSP --&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">signer</span> <span class="attr">signature</span>=<span class="string">"@MEDIA"</span> &gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">seinfo</span> <span class="attr">value</span>=<span class="string">"media"</span> /&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">signer</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">policy</span>&gt;</span></span><br></pre></td></tr></table></figure></p>
<p>在 Android 引入 SeLinux 以后，Android 会为每个文件打上 SE Label，对于 APK 而言，打 SE Label 的准则就是签名，即根据签名信息打上不同的 SE Label。</p>
<p>Android 将签名分类成为 platform，testkey，media等，签名与类别的映射关系就存在一个叫 mac_permission.xml 的文件中。</p>
<p>所以，需要读取该文件的内容。</p>
<p>根据 mac_permissions.xml 的定义，如果 App 是在 Android 源码编译环境下，其 Android.mk 中指定了 LOCAL_CERTIFICATE : = platform 的话，它的 seinfo 就是 platform。如果 Android.mk 中不进行对应的设置，setinfo 为默认值 default。</p>
<p>对于第三方 APK，其 seinfo 值通常为 default。</p>
<p>当 mac_permissions.xml 编译进 system/etc 目录时，@PLATFORM 将被实际的签名信息替换：</p>
<figure class="highlight"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">&lt;?xml version=<span class="string">"1.0"</span> encoding=<span class="string">"iso-8859-1"</span>?&gt;</span><br><span class="line">&lt;!-- AUTOGENERATED FILE DO NOT MODIFY --&gt;</span><br><span class="line">&lt;policy&gt;</span><br><span class="line">    &lt;signer signature=<span class="string">"308204......232e4fe9bd961394c6300e5138e3cfd285e6e4e483538cb8b1b357"</span>&gt;</span><br><span class="line">        &lt;seinfo value=<span class="string">"platform"</span>/&gt;</span><br><span class="line">    &lt;/signer&gt;</span><br><span class="line">    &lt;<span class="keyword">default</span>&gt;</span><br><span class="line">        &lt;seinfo value=<span class="string">"default"</span>/&gt;</span><br><span class="line">    &lt;/default&gt;</span><br><span class="line">&lt;/policy&gt;</span><br></pre></td></tr></table></figure>
<p>这里不多说了。</p>
<h2 id="7-1-SELinuxMMAC-readSignerOrThrow"><a href="#7-1-SELinuxMMAC-readSignerOrThrow" class="headerlink" title="7.1 SELinuxMMAC.readSignerOrThrow"></a>7.1 SELinuxMMAC.readSignerOrThrow</h2><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">static</span> Policy <span class="title">readSignerOrThrow</span><span class="params">(XmlPullParser parser)</span> <span class="keyword">throws</span> IOException,</span></span><br><span class="line"><span class="function">        XmlPullParserException </span>&#123;</span><br><span class="line">    parser.require(XmlPullParser.START_TAG, <span class="keyword">null</span>, <span class="string">"signer"</span>);</span><br><span class="line">    Policy.PolicyBuilder pb = <span class="keyword">new</span> Policy.PolicyBuilder();</span><br><span class="line">    <span class="comment">//【1】解析 signature 属性</span></span><br><span class="line">    String cert = parser.getAttributeValue(<span class="keyword">null</span>, <span class="string">"signature"</span>);</span><br><span class="line">    <span class="keyword">if</span> (cert != <span class="keyword">null</span>) &#123;</span><br><span class="line">        pb.addSignature(cert);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">while</span> (parser.next() != XmlPullParser.END_TAG) &#123;</span><br><span class="line">        <span class="keyword">if</span> (parser.getEventType() != XmlPullParser.START_TAG) &#123;</span><br><span class="line">            <span class="keyword">continue</span>;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        String tagName = parser.getName();</span><br><span class="line">        <span class="keyword">if</span> (<span class="string">"seinfo"</span>.equals(tagName)) &#123; <span class="comment">//【2】解析子标签 seinfo！</span></span><br><span class="line">            String seinfo = parser.getAttributeValue(<span class="keyword">null</span>, <span class="string">"value"</span>);</span><br><span class="line">            pb.setGlobalSeinfoOrThrow(seinfo);</span><br><span class="line">            readSeinfo(parser);</span><br><span class="line">        &#125; <span class="keyword">else</span> <span class="keyword">if</span> (<span class="string">"package"</span>.equals(tagName)) &#123; <span class="comment">//【3】解析子标签 package！</span></span><br><span class="line">            readPackageOrThrow(parser, pb);</span><br><span class="line">        &#125; <span class="keyword">else</span> <span class="keyword">if</span> (<span class="string">"cert"</span>.equals(tagName)) &#123; <span class="comment">//【4】解析子标签 cert！</span></span><br><span class="line">            String sig = parser.getAttributeValue(<span class="keyword">null</span>, <span class="string">"signature"</span>);</span><br><span class="line">            pb.addSignature(sig);</span><br><span class="line">            readCert(parser);</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            skip(parser);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> pb.build();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>可以看到，readSignerOrThrow 方法会解析 signer 标签和其子标签，然后将结果通过 buidler 模式，封装成一个 Policy 对象返回！</p>
<h1 id="8-Settings-readLPw"><a href="#8-Settings-readLPw" class="headerlink" title="8 Settings.readLPw"></a>8 Settings.readLPw</h1><p>继续看：<br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">mFirstBoot = !mSettings.readLPw(sUserManager.getUsers(<span class="keyword">false</span>));</span><br></pre></td></tr></table></figure></p>
<p>这个方法用来恢复上一次安装的信息，参数传递：</p>
<ul>
<li>List<userinfo> users：当前是设备用户 id！</userinfo></li>
</ul>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br><span class="line">212</span><br><span class="line">213</span><br><span class="line">214</span><br><span class="line">215</span><br><span class="line">216</span><br><span class="line">217</span><br><span class="line">218</span><br><span class="line">219</span><br><span class="line">220</span><br><span class="line">221</span><br><span class="line">222</span><br><span class="line">223</span><br><span class="line">224</span><br><span class="line">225</span><br><span class="line">226</span><br><span class="line">227</span><br><span class="line">228</span><br><span class="line">229</span><br><span class="line">230</span><br><span class="line">231</span><br><span class="line">232</span><br><span class="line">233</span><br><span class="line">234</span><br><span class="line">235</span><br><span class="line">236</span><br><span class="line">237</span><br><span class="line">238</span><br><span class="line">239</span><br><span class="line">240</span><br><span class="line">241</span><br><span class="line">242</span><br><span class="line">243</span><br><span class="line">244</span><br><span class="line">245</span><br><span class="line">246</span><br><span class="line">247</span><br><span class="line">248</span><br><span class="line">249</span><br><span class="line">250</span><br><span class="line">251</span><br><span class="line">252</span><br><span class="line">253</span><br><span class="line">254</span><br><span class="line">255</span><br><span class="line">256</span><br><span class="line">257</span><br><span class="line">258</span><br><span class="line">259</span><br><span class="line">260</span><br><span class="line">261</span><br><span class="line">262</span><br><span class="line">263</span><br><span class="line">264</span><br><span class="line">265</span><br><span class="line">266</span><br><span class="line">267</span><br><span class="line">268</span><br><span class="line">269</span><br><span class="line">270</span><br><span class="line">271</span><br><span class="line">272</span><br><span class="line">273</span><br><span class="line">274</span><br><span class="line">275</span><br><span class="line">276</span><br><span class="line">277</span><br><span class="line">278</span><br><span class="line">279</span><br><span class="line">280</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">boolean</span> <span class="title">readLPw</span><span class="params">(@NonNull List&lt;UserInfo&gt; users)</span> </span>&#123;</span><br><span class="line">    FileInputStream str = <span class="keyword">null</span>;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">//【1】如果 packages-backup.xml 存在，就从 packages-backup.xml 中读取</span></span><br><span class="line">    <span class="keyword">if</span> (mBackupSettingsFilename.exists()) &#123;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            str = <span class="keyword">new</span> FileInputStream(mBackupSettingsFilename);</span><br><span class="line">            mReadMessages.append(<span class="string">"Reading from backup settings file\n"</span>);</span><br><span class="line">            PackageManagerService.reportSettingsProblem(Log.INFO,</span><br><span class="line">                    <span class="string">"Need to read from backup settings file"</span>);</span><br><span class="line">            </span><br><span class="line">            <span class="comment">// 如果 packages.xml 存在，删除！</span></span><br><span class="line">            <span class="keyword">if</span> (mSettingsFilename.exists()) &#123;</span><br><span class="line">                Slog.w(PackageManagerService.TAG, <span class="string">"Cleaning up settings file "</span></span><br><span class="line">                        + mSettingsFilename);</span><br><span class="line">                mSettingsFilename.delete();</span><br><span class="line">            &#125;</span><br><span class="line">        &#125; <span class="keyword">catch</span> (java.io.IOException e) &#123;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 清空一些集合，防止异常问题！</span></span><br><span class="line">    mPendingPackages.clear();</span><br><span class="line">    mPastSignatures.clear();</span><br><span class="line">    mKeySetRefs.clear();</span><br><span class="line">    mInstallerPackages.clear();</span><br><span class="line"></span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">    </span><br><span class="line">        <span class="comment">//【2】如果 packages-backup.xml 不存在，就从 packages.xml 中读取！ </span></span><br><span class="line">        <span class="keyword">if</span> (str == <span class="keyword">null</span>) &#123;</span><br><span class="line">            <span class="keyword">if</span> (!mSettingsFilename.exists()) &#123;</span><br><span class="line">                mReadMessages.append(<span class="string">"No settings file found\n"</span>);</span><br><span class="line">                PackageManagerService.reportSettingsProblem(Log.INFO,</span><br><span class="line">                        <span class="string">"No settings file; creating initial state"</span>);</span><br><span class="line">                <span class="comment">// It's enough to just touch version details to create them</span></span><br><span class="line">                <span class="comment">// with default values</span></span><br><span class="line">                findOrCreateVersion(StorageManager.UUID_PRIVATE_INTERNAL);</span><br><span class="line">                findOrCreateVersion(StorageManager.UUID_PRIMARY_PHYSICAL);</span><br><span class="line">                <span class="keyword">return</span> <span class="keyword">false</span>;</span><br><span class="line">            &#125;</span><br><span class="line">            str = <span class="keyword">new</span> FileInputStream(mSettingsFilename);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        XmlPullParser parser = Xml.newPullParser();</span><br><span class="line">        parser.setInput(str, StandardCharsets.UTF_8.name());</span><br><span class="line"></span><br><span class="line">        <span class="keyword">int</span> type;</span><br><span class="line">        <span class="keyword">while</span> ((type = parser.next()) != XmlPullParser.START_TAG</span><br><span class="line">                &amp;&amp; type != XmlPullParser.END_DOCUMENT) &#123;</span><br><span class="line">            ;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (type != XmlPullParser.START_TAG) &#123;</span><br><span class="line">            mReadMessages.append(<span class="string">"No start tag found in settings file\n"</span>);</span><br><span class="line">            PackageManagerService.reportSettingsProblem(Log.WARN,</span><br><span class="line">                    <span class="string">"No start tag found in package manager settings"</span>);</span><br><span class="line">            Slog.wtf(PackageManagerService.TAG,</span><br><span class="line">                    <span class="string">"No start tag found in package manager settings"</span>);</span><br><span class="line">            <span class="keyword">return</span> <span class="keyword">false</span>;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">int</span> outerDepth = parser.getDepth();</span><br><span class="line">        <span class="keyword">while</span> ((type = parser.next()) != XmlPullParser.END_DOCUMENT</span><br><span class="line">                &amp;&amp; (type != XmlPullParser.END_TAG || parser.getDepth() &gt; outerDepth)) &#123;</span><br><span class="line">            <span class="keyword">if</span> (type == XmlPullParser.END_TAG || type == XmlPullParser.TEXT) &#123;</span><br><span class="line">                <span class="keyword">continue</span>;</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            String tagName = parser.getName();</span><br><span class="line">            <span class="keyword">if</span> (tagName.equals(<span class="string">"package"</span>)) &#123; <span class="comment">//【2.1】解析 "package"</span></span><br><span class="line">                readPackageLPw(parser);</span><br><span class="line">                </span><br><span class="line">            &#125; <span class="keyword">else</span> <span class="keyword">if</span> (tagName.equals(<span class="string">"permissions"</span>)) &#123; <span class="comment">//【2.2】解析 "permissions"</span></span><br><span class="line">                readPermissionsLPw(mPermissions, parser);</span><br><span class="line">                </span><br><span class="line">            &#125; <span class="keyword">else</span> <span class="keyword">if</span> (tagName.equals(<span class="string">"permission-trees"</span>)) &#123;  <span class="comment">//【2.3】解析 "permission-trees"</span></span><br><span class="line">                readPermissionsLPw(mPermissionTrees, parser);</span><br><span class="line">                </span><br><span class="line">            &#125; <span class="keyword">else</span> <span class="keyword">if</span> (tagName.equals(<span class="string">"shared-user"</span>)) &#123; <span class="comment">//【2.4】解析 "shared-user"</span></span><br><span class="line">                readSharedUserLPw(parser);</span><br><span class="line">                </span><br><span class="line">            &#125; <span class="keyword">else</span> <span class="keyword">if</span> (tagName.equals(<span class="string">"preferred-packages"</span>)) &#123; </span><br><span class="line">                <span class="comment">// no longer used.</span></span><br><span class="line"></span><br><span class="line">            &#125; <span class="keyword">else</span> <span class="keyword">if</span> (tagName.equals(<span class="string">"preferred-activities"</span>)) &#123; <span class="comment">//【2.5】解析 "preferred-activities"</span></span><br><span class="line">                readPreferredActivitiesLPw(parser, <span class="number">0</span>);</span><br><span class="line">                </span><br><span class="line">            &#125; <span class="keyword">else</span> <span class="keyword">if</span> (tagName.equals(TAG_PERSISTENT_PREFERRED_ACTIVITIES)) &#123; </span><br><span class="line">                <span class="comment">// 解析 "persistent-preferred-activities"</span></span><br><span class="line">                <span class="comment">// Android 7.1.1 的默认应用已经不在 packages.xml 中定义了！</span></span><br><span class="line">                <span class="comment">// 而是在 package-restrictions 文件中定义，这里是为了兼容以前的版本！</span></span><br><span class="line">                readPersistentPreferredActivitiesLPw(parser, <span class="number">0</span>); </span><br><span class="line">                </span><br><span class="line">            &#125; <span class="keyword">else</span> <span class="keyword">if</span> (tagName.equals(TAG_CROSS_PROFILE_INTENT_FILTERS)) &#123;</span><br><span class="line">                <span class="comment">// 解析 "crossProfile-intent-filters"</span></span><br><span class="line">                readCrossProfileIntentFiltersLPw(parser, <span class="number">0</span>);</span><br><span class="line">                </span><br><span class="line">            &#125; <span class="keyword">else</span> <span class="keyword">if</span> (tagName.equals(TAG_DEFAULT_BROWSER)) &#123; <span class="comment">//【2.6】解析 "default-browser"</span></span><br><span class="line">                readDefaultAppsLPw(parser, <span class="number">0</span>);</span><br><span class="line">                </span><br><span class="line">            &#125; <span class="keyword">else</span> <span class="keyword">if</span> (tagName.equals(<span class="string">"updated-package"</span>)) &#123; <span class="comment">//【2.7】解析 "updated-package"</span></span><br><span class="line">                readDisabledSysPackageLPw(parser);</span><br><span class="line">                </span><br><span class="line">            &#125; <span class="keyword">else</span> <span class="keyword">if</span> (tagName.equals(<span class="string">"cleaning-package"</span>)) &#123; <span class="comment">//【2.8】解析 "cleaning-package"</span></span><br><span class="line">                String name = parser.getAttributeValue(<span class="keyword">null</span>, ATTR_NAME);</span><br><span class="line">                String userStr = parser.getAttributeValue(<span class="keyword">null</span>, ATTR_USER);</span><br><span class="line">                String codeStr = parser.getAttributeValue(<span class="keyword">null</span>, ATTR_CODE);</span><br><span class="line">                <span class="keyword">if</span> (name != <span class="keyword">null</span>) &#123;</span><br><span class="line">                    <span class="keyword">int</span> userId = UserHandle.USER_SYSTEM;</span><br><span class="line">                    <span class="keyword">boolean</span> andCode = <span class="keyword">true</span>;</span><br><span class="line">                    <span class="keyword">try</span> &#123;</span><br><span class="line">                        <span class="keyword">if</span> (userStr != <span class="keyword">null</span>) &#123;</span><br><span class="line">                            userId = Integer.parseInt(userStr);</span><br><span class="line">                        &#125;</span><br><span class="line">                    &#125; <span class="keyword">catch</span> (NumberFormatException e) &#123;</span><br><span class="line">                    &#125;</span><br><span class="line">                    <span class="keyword">if</span> (codeStr != <span class="keyword">null</span>) &#123;</span><br><span class="line">                        andCode = Boolean.parseBoolean(codeStr);</span><br><span class="line">                    &#125;</span><br><span class="line">                    addPackageToCleanLPw(<span class="keyword">new</span> PackageCleanItem(userId, name, andCode));</span><br><span class="line">                &#125;</span><br><span class="line">                </span><br><span class="line">            &#125; <span class="keyword">else</span> <span class="keyword">if</span> (tagName.equals(<span class="string">"renamed-package"</span>)) &#123; <span class="comment">//【2.9】解析 "renamed-package"</span></span><br><span class="line">                String nname = parser.getAttributeValue(<span class="keyword">null</span>, <span class="string">"new"</span>);</span><br><span class="line">                String oname = parser.getAttributeValue(<span class="keyword">null</span>, <span class="string">"old"</span>);</span><br><span class="line">                <span class="keyword">if</span> (nname != <span class="keyword">null</span> &amp;&amp; oname != <span class="keyword">null</span>) &#123;</span><br><span class="line">                    mRenamedPackages.put(nname, oname);</span><br><span class="line">                &#125;</span><br><span class="line">                </span><br><span class="line">            &#125; <span class="keyword">else</span> <span class="keyword">if</span> (tagName.equals(<span class="string">"restored-ivi"</span>)) &#123; <span class="comment">// 解析 "restored-ivi"</span></span><br><span class="line">                readRestoredIntentFilterVerifications(parser);</span><br><span class="line">                </span><br><span class="line">            &#125; <span class="keyword">else</span> <span class="keyword">if</span> (tagName.equals(<span class="string">"last-platform-version"</span>)) &#123; <span class="comment">// 解析 "last-platform-version"</span></span><br><span class="line">                <span class="comment">// Upgrade from older XML schema</span></span><br><span class="line">                <span class="keyword">final</span> VersionInfo internal = findOrCreateVersion(</span><br><span class="line">                        StorageManager.UUID_PRIVATE_INTERNAL);</span><br><span class="line">                <span class="keyword">final</span> VersionInfo external = findOrCreateVersion(</span><br><span class="line">                        StorageManager.UUID_PRIMARY_PHYSICAL);</span><br><span class="line"></span><br><span class="line">                internal.sdkVersion = XmlUtils.readIntAttribute(parser, <span class="string">"internal"</span>, <span class="number">0</span>);</span><br><span class="line">                external.sdkVersion = XmlUtils.readIntAttribute(parser, <span class="string">"external"</span>, <span class="number">0</span>);</span><br><span class="line">                internal.fingerprint = external.fingerprint =</span><br><span class="line">                        XmlUtils.readStringAttribute(parser, <span class="string">"fingerprint"</span>);</span><br><span class="line"></span><br><span class="line">            &#125; <span class="keyword">else</span> <span class="keyword">if</span> (tagName.equals(<span class="string">"database-version"</span>)) &#123; <span class="comment">// 解析 "database-version"</span></span><br><span class="line">                <span class="comment">// Upgrade from older XML schema</span></span><br><span class="line">                <span class="keyword">final</span> VersionInfo internal = findOrCreateVersion(</span><br><span class="line">                        StorageManager.UUID_PRIVATE_INTERNAL);</span><br><span class="line">                <span class="keyword">final</span> VersionInfo external = findOrCreateVersion(</span><br><span class="line">                        StorageManager.UUID_PRIMARY_PHYSICAL);</span><br><span class="line"></span><br><span class="line">                internal.databaseVersion = XmlUtils.readIntAttribute(parser, <span class="string">"internal"</span>, <span class="number">0</span>);</span><br><span class="line">                external.databaseVersion = XmlUtils.readIntAttribute(parser, <span class="string">"external"</span>, <span class="number">0</span>);</span><br><span class="line"></span><br><span class="line">            &#125; <span class="keyword">else</span> <span class="keyword">if</span> (tagName.equals(<span class="string">"verifier"</span>)) &#123; <span class="comment">// 解析 "verifier"</span></span><br><span class="line">                <span class="keyword">final</span> String deviceIdentity = parser.getAttributeValue(<span class="keyword">null</span>, <span class="string">"device"</span>);</span><br><span class="line">                <span class="keyword">try</span> &#123;</span><br><span class="line">                    mVerifierDeviceIdentity = VerifierDeviceIdentity.parse(deviceIdentity);</span><br><span class="line">                &#125; <span class="keyword">catch</span> (IllegalArgumentException e) &#123;</span><br><span class="line">                    Slog.w(PackageManagerService.TAG, <span class="string">"Discard invalid verifier device id: "</span></span><br><span class="line">                            + e.getMessage());</span><br><span class="line">                &#125;</span><br><span class="line">                </span><br><span class="line">            &#125; <span class="keyword">else</span> <span class="keyword">if</span> (TAG_READ_EXTERNAL_STORAGE.equals(tagName)) &#123; <span class="comment">// 解析 "read-external-storage"</span></span><br><span class="line">                <span class="keyword">final</span> String enforcement = parser.getAttributeValue(<span class="keyword">null</span>, ATTR_ENFORCEMENT);</span><br><span class="line">                mReadExternalStorageEnforced = <span class="string">"1"</span>.equals(enforcement);</span><br><span class="line">                </span><br><span class="line">            &#125; <span class="keyword">else</span> <span class="keyword">if</span> (tagName.equals(<span class="string">"keyset-settings"</span>)) &#123; <span class="comment">// 解析 "keyset-settings"</span></span><br><span class="line">                mKeySetManagerService.readKeySetsLPw(parser, mKeySetRefs);</span><br><span class="line">                </span><br><span class="line">            &#125; <span class="keyword">else</span> <span class="keyword">if</span> (TAG_VERSION.equals(tagName)) &#123; <span class="comment">// 解析 "version"</span></span><br><span class="line">                <span class="keyword">final</span> String volumeUuid = XmlUtils.readStringAttribute(parser,</span><br><span class="line">                        ATTR_VOLUME_UUID);</span><br><span class="line">                <span class="keyword">final</span> VersionInfo ver = findOrCreateVersion(volumeUuid);</span><br><span class="line">                ver.sdkVersion = XmlUtils.readIntAttribute(parser, ATTR_SDK_VERSION);</span><br><span class="line">                ver.databaseVersion = XmlUtils.readIntAttribute(parser, ATTR_SDK_VERSION);</span><br><span class="line">                ver.fingerprint = XmlUtils.readStringAttribute(parser, ATTR_FINGERPRINT);</span><br><span class="line">                </span><br><span class="line">            &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                Slog.w(PackageManagerService.TAG, <span class="string">"Unknown element under &lt;packages&gt;: "</span></span><br><span class="line">                        + parser.getName());</span><br><span class="line">                XmlUtils.skipCurrentTag(parser);</span><br><span class="line">                </span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        str.close();</span><br><span class="line"></span><br><span class="line">    &#125; <span class="keyword">catch</span> (XmlPullParserException e) &#123;</span><br><span class="line">        ... ...</span><br><span class="line"></span><br><span class="line">    &#125; <span class="keyword">catch</span> (java.io.IOException e) &#123;</span><br><span class="line">        ... ...</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//【3】If the build is setup to drop runtime permissions</span></span><br><span class="line">    <span class="comment">// on update drop the files before loading them.</span></span><br><span class="line">    <span class="keyword">if</span> (PackageManagerService.CLEAR_RUNTIME_PERMISSIONS_ON_UPGRADE) &#123;</span><br><span class="line">        <span class="keyword">final</span> VersionInfo internal = getInternalVersion();</span><br><span class="line">        <span class="keyword">if</span> (!Build.FINGERPRINT.equals(internal.fingerprint)) &#123;</span><br><span class="line">            <span class="keyword">for</span> (UserInfo user : users) &#123;</span><br><span class="line">                mRuntimePermissionsPersistence.deleteUserRuntimePermissionsFile(user.id);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//【4】接着，对 mPendingPackages 集合中的需要验证共享用户 id 有效性的 package，进行共享用户 id 有效性的验证!</span></span><br><span class="line">    <span class="keyword">final</span> <span class="keyword">int</span> N = mPendingPackages.size();</span><br><span class="line">    <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; N; i++) &#123;</span><br><span class="line">        <span class="keyword">final</span> PendingPackage pp = mPendingPackages.get(i);</span><br><span class="line">        </span><br><span class="line">        <span class="comment">// 看 sharedId 是否能对应找到一个 ShardUserSetting 对象!</span></span><br><span class="line">        Object idObj = getUserIdLPr(pp.sharedId);</span><br><span class="line">        </span><br><span class="line">        <span class="keyword">if</span> (idObj != <span class="keyword">null</span> &amp;&amp; idObj <span class="keyword">instanceof</span> SharedUserSetting) &#123; <span class="comment">// 能找到，说明共享用户 ID 是有效的!</span></span><br><span class="line">            PackageSetting p = getPackageLPw(pp.name, <span class="keyword">null</span>, pp.realName,</span><br><span class="line">                    (SharedUserSetting) idObj, pp.codePath, pp.resourcePath,</span><br><span class="line">                    pp.legacyNativeLibraryPathString, pp.primaryCpuAbiString,</span><br><span class="line">                    pp.secondaryCpuAbiString, pp.versionCode, pp.pkgFlags, pp.pkgPrivateFlags,</span><br><span class="line">                    <span class="keyword">null</span>, <span class="keyword">true</span> <span class="comment">/* add */</span>, <span class="keyword">false</span> <span class="comment">/* allowInstall */</span>, pp.parentPackageName,</span><br><span class="line">                    pp.childPackageNames);</span><br><span class="line"></span><br><span class="line">            <span class="keyword">if</span> (p == <span class="keyword">null</span>) &#123;</span><br><span class="line">                PackageManagerService.reportSettingsProblem(Log.WARN,</span><br><span class="line">                        <span class="string">"Unable to create application package for "</span> + pp.name);</span><br><span class="line">                <span class="keyword">continue</span>;</span><br><span class="line">            &#125;</span><br><span class="line">            p.copyFrom(pp); <span class="comment">// 保存到 Settings.mPackages 对象中，表明 ID 有效，已经分配 ID 了！</span></span><br><span class="line"></span><br><span class="line">        &#125; <span class="keyword">else</span> <span class="keyword">if</span> (idObj != <span class="keyword">null</span>) &#123;</span><br><span class="line">            ... ... ... </span><br><span class="line"></span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            ... ... ...</span><br><span class="line"></span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    mPendingPackages.clear(); <span class="comment">// 清空 </span></span><br><span class="line"></span><br><span class="line">    <span class="comment">//【8.3】读取 packages-stopped-backup.xml 和 packages_stopped.xml 文件 ！</span></span><br><span class="line">    <span class="keyword">if</span> (mBackupStoppedPackagesFilename.exists()</span><br><span class="line">            || mStoppedPackagesFilename.exists()) &#123;</span><br><span class="line">        <span class="comment">//【8.3.1】如果 packages_stopped.xml 存在，我们先会读取文件数据，然后删除 packages_stopped.xml 相关文件！</span></span><br><span class="line">        readStoppedLPw();</span><br><span class="line">        mBackupStoppedPackagesFilename.delete();</span><br><span class="line">        mStoppedPackagesFilename.delete();</span><br><span class="line">        <span class="comment">//【8.3.2】然后用最新的数据更新偏好设置！</span></span><br><span class="line">        writePackageRestrictionsLPr(UserHandle.USER_SYSTEM);</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        <span class="comment">//【8.3.3】否则，我们直接读取已有的偏好设置，更新上次安装的信息！</span></span><br><span class="line">        <span class="keyword">for</span> (UserInfo user : users) &#123;</span><br><span class="line">            readPackageRestrictionsLPr(user.id);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//【8.4】读取每个 user 下的运行是权限信息！</span></span><br><span class="line">    <span class="keyword">for</span> (UserInfo user : users) &#123;</span><br><span class="line">        mRuntimePermissionsPersistence.readStateForUserSyncLPr(user.id);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// mDisabledSysPackages 里面保存着所有被替换的 Package 信息，如果这些 package 之前配置的是共享用户 uid</span></span><br><span class="line">    <span class="comment">// 那这里要建立 package 和 共享用户 id 的关联！</span></span><br><span class="line">    <span class="keyword">final</span> Iterator&lt;PackageSetting&gt; disabledIt = mDisabledSysPackages.values().iterator();</span><br><span class="line">    <span class="keyword">while</span> (disabledIt.hasNext()) &#123;</span><br><span class="line">        <span class="keyword">final</span> PackageSetting disabledPs = disabledIt.next();</span><br><span class="line">        <span class="keyword">final</span> Object id = getUserIdLPr(disabledPs.appId);</span><br><span class="line">        <span class="keyword">if</span> (id != <span class="keyword">null</span> &amp;&amp; id <span class="keyword">instanceof</span> SharedUserSetting) &#123;</span><br><span class="line">            disabledPs.sharedUser = (SharedUserSetting) id;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    mReadMessages.append(<span class="string">"Read completed successfully: "</span> + mPackages.size() + <span class="string">" packages, "</span></span><br><span class="line">            + mSharedUsers.size() + <span class="string">" shared uids\n"</span>);</span><br><span class="line"></span><br><span class="line">    writeKernelMappingLPr();</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">true</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>这个方法的主要流程是：</p>
<ul>
<li>读取 packages-backup.xml 或者 packages.xml 文件中的数据并解析，获得上一次应用的安装和使用信息！</li>
<li>校验共享用户id 的应用程序包的 uid 的有效性！</li>
<li>读取 packages-stopped-backup.xml 和 packages_stopped.xml 文件中的数据并解析！</li>
<li>处理被替换的系统应用的共享用户 id 和自身的关系！</li>
</ul>
<p>下面我们来看下重要的属性的解析：</p>
<h2 id="8-1-读取-pacakges-xml-文件"><a href="#8-1-读取-pacakges-xml-文件" class="headerlink" title="8.1 读取 pacakges.xml 文件"></a>8.1 读取 pacakges.xml 文件</h2><p>这个流程主要会解析如下的标签：</p>
<table>
<thead>
<tr>
<th style="text-align:left">标签</th>
<th style="text-align:left">标签解释</th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align:left">“package”</td>
<td style="text-align:left">系统中所有应用程序包的信息</td>
</tr>
<tr>
<td style="text-align:left">“permissions”</td>
<td style="text-align:left">系统中定义的所有的权限</td>
</tr>
<tr>
<td style="text-align:left">“permission-trees”</td>
<td style="text-align:left">系统中定义的权限树</td>
</tr>
<tr>
<td style="text-align:left">“shared-user”</td>
<td style="text-align:left">系统中定义的共享用户</td>
</tr>
<tr>
<td style="text-align:left">“preferred-activities”</td>
<td style="text-align:left">系统默认应用相关</td>
</tr>
<tr>
<td style="text-align:left">“persistent-preferred-activities”</td>
<td style="text-align:left">系统默认应用相关</td>
</tr>
<tr>
<td style="text-align:left">“crossProfile-intent-filters”</td>
<td style="text-align:left"></td>
</tr>
<tr>
<td style="text-align:left">“default-browser”</td>
<td style="text-align:left">默认的浏览器</td>
</tr>
<tr>
<td style="text-align:left">“updated-package”</td>
<td style="text-align:left">系统中被更新的应用程序包</td>
</tr>
<tr>
<td style="text-align:left">“cleaning-package”</td>
<td style="text-align:left">系统中被清除掉的应用程序包</td>
</tr>
<tr>
<td style="text-align:left">“renamed-package”</td>
<td style="text-align:left">系统中被重命名的应用程序包</td>
</tr>
<tr>
<td style="text-align:left">“restored-ivi”</td>
<td style="text-align:left"></td>
</tr>
<tr>
<td style="text-align:left">“last-platform-version”</td>
<td style="text-align:left">系统升级之前的版本</td>
</tr>
<tr>
<td style="text-align:left">“database-version”</td>
<td style="text-align:left">数据库版本</td>
</tr>
<tr>
<td style="text-align:left">“verifier”</td>
<td style="text-align:left"></td>
</tr>
<tr>
<td style="text-align:left">“read-external-storage”</td>
<td style="text-align:left"></td>
</tr>
<tr>
<td style="text-align:left">“keyset-settings”</td>
<td style="text-align:left"></td>
</tr>
<tr>
<td style="text-align:left">“version”</td>
<td style="text-align:left">当前系统的版本</td>
</tr>
</tbody>
</table>
<p>我们重点分析和 package、permission，shared-user 相关的内容，其他的内容我们后续接触到在分析！</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">packages</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">version</span> <span class="attr">sdkVersion</span>=<span class="string">"27"</span> <span class="attr">databaseVersion</span>=<span class="string">"3"</span> <span class="attr">fingerprint</span>=<span class="string">"../release-keys"</span> /&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">version</span> <span class="attr">volumeUuid</span>=<span class="string">"primary_physical"</span> <span class="attr">sdkVersion</span>=<span class="string">"27"</span> <span class="attr">databaseVersion</span>=<span class="string">"27"</span></span></span><br><span class="line"><span class="tag">             <span class="attr">fingerprint</span>=<span class="string">".../release-keys"</span> /&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">permission-trees</span> /&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">permissions</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">item</span> <span class="attr">name</span>=<span class="string">"android.permission.REAL_GET_TASKS"</span> <span class="attr">package</span>=<span class="string">"android"</span> <span class="attr">protection</span>=<span class="string">"18"</span> /&gt;</span></span><br><span class="line">        <span class="comment">&lt;!-- ... ... ...--&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">permissions</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">package</span> <span class="attr">name</span>=<span class="string">"com.android.providers.calendar"</span> <span class="attr">codePath</span>=<span class="string">"/system/priv-app/CalendarProvider"</span> </span></span><br><span class="line"><span class="tag">                    <span class="attr">nativeLibraryPath</span>=<span class="string">"/system/priv-app/CalendarProvider/lib"</span> </span></span><br><span class="line"><span class="tag">					<span class="attr">primaryCpuAbi</span>=<span class="string">"armeabi-v7a"</span> <span class="attr">publicFlags</span>=<span class="string">"940064325"</span> <span class="attr">privateFlags</span>=<span class="string">"8"</span> </span></span><br><span class="line"><span class="tag">					<span class="attr">ft</span>=<span class="string">"1624a4dcee0"</span> <span class="attr">it</span>=<span class="string">"1624a4dcee0"</span> <span class="attr">ut</span>=<span class="string">"1624a4dcee0"</span></span></span><br><span class="line"><span class="tag">					<span class="attr">version</span>=<span class="string">"0"</span> <span class="attr">sharedUserId</span>=<span class="string">"10006"</span> <span class="attr">isOrphaned</span>=<span class="string">"true"</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">sigs</span> <span class="attr">count</span>=<span class="string">"1"</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">cert</span> <span class="attr">index</span>=<span class="string">"0"</span> /&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">sigs</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">perms</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">item</span> <span class="attr">name</span>=<span class="string">"android.permission.WRITE_SETTINGS"</span> <span class="attr">granted</span>=<span class="string">"true"</span> <span class="attr">flags</span>=<span class="string">"0"</span> /&gt;</span></span><br><span class="line">			<span class="comment">&lt;!-- ... ... ...--&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">perms</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">proper-signing-keyset</span> <span class="attr">identifier</span>=<span class="string">"1"</span> /&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">package</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">updated-package</span> <span class="attr">name</span>=<span class="string">"com.coolqi.papapa"</span> <span class="attr">codePath</span>=<span class="string">"/system/app/papapa"</span> </span></span><br><span class="line"><span class="tag">					 <span class="attr">ft</span>=<span class="string">"1624a6f0ab0"</span> <span class="attr">it</span>=<span class="string">"1624a6f0ab0"</span> <span class="attr">ut</span>=<span class="string">"1624a6f0ab0"</span> <span class="attr">version</span>=<span class="string">"5023"</span> </span></span><br><span class="line"><span class="tag">					 <span class="attr">nativeLibraryPath</span>=<span class="string">"/system/app/papapa/lib"</span> <span class="attr">primaryCpuAbi</span>=<span class="string">"arm64-v8a"</span></span></span><br><span class="line"><span class="tag">					 <span class="attr">sharedUserId</span>=<span class="string">"1000"</span> /&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">shared-user</span> <span class="attr">name</span>=<span class="string">"android.uid.bluetooth"</span> <span class="attr">userId</span>=<span class="string">"1002"</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">sigs</span> <span class="attr">count</span>=<span class="string">"1"</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">cert</span> <span class="attr">index</span>=<span class="string">"0"</span> /&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">sigs</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">perms</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">item</span> <span class="attr">name</span>=<span class="string">"android.permission.REAL_GET_TASKS"</span> <span class="attr">granted</span>=<span class="string">"true"</span> <span class="attr">flags</span>=<span class="string">"0"</span> /&gt;</span></span><br><span class="line">			<span class="comment">&lt;!-- ... ... --&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">perms</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">shared-user</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">keyset-settings</span> <span class="attr">version</span>=<span class="string">"1"</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">keys</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">public-key</span> <span class="attr">identifier</span>=<span class="string">"1"</span> <span class="attr">value</span>=<span class="string">"MIIBIjjYLv....uhfiUDQIDAQAB"</span> /&gt;</span></span><br><span class="line">            <span class="comment">&lt;!-- ... ... --&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">keys</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">keysets</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">keyset</span> <span class="attr">identifier</span>=<span class="string">"1"</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">key-id</span> <span class="attr">identifier</span>=<span class="string">"1"</span> /&gt;</span></span><br><span class="line">            <span class="tag">&lt;/<span class="name">keyset</span>&gt;</span></span><br><span class="line">            <span class="comment">&lt;!-- ... ... --&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">keysets</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">lastIssuedKeyId</span> <span class="attr">value</span>=<span class="string">"16"</span> /&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">lastIssuedKeySetId</span> <span class="attr">value</span>=<span class="string">"16"</span> /&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">keyset-settings</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">packages</span>&gt;</span></span><br></pre></td></tr></table></figure>
<p>上面是 pacakges.xml 的主要内容！</p>
<h3 id="8-1-1-解析-“package”-标签"><a href="#8-1-1-解析-“package”-标签" class="headerlink" title="8.1.1 解析 “package” 标签"></a>8.1.1 解析 “package” 标签</h3><p>和 “package” 相关内容如下：<br><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">package</span> <span class="attr">name</span>=<span class="string">"com.qualcomm.qti.haven.telemetry.service"</span> <span class="attr">codePath</span>=<span class="string">"/system/app/TelemetryService"</span> </span></span><br><span class="line"><span class="tag">        <span class="attr">nativeLibraryPath</span>=<span class="string">"/system/app/TelemetryService/lib"</span> </span></span><br><span class="line"><span class="tag">        <span class="attr">publicFlags</span>=<span class="string">"940097093"</span> <span class="attr">privateFlags</span>=<span class="string">"0"</span> <span class="attr">ft</span>=<span class="string">"11e8dc5d800"</span> <span class="attr">it</span>=<span class="string">"11e8dc5d800"</span> <span class="attr">ut</span>=<span class="string">"11e8dc5d800"</span> </span></span><br><span class="line"><span class="tag">        <span class="attr">version</span>=<span class="string">"25"</span> <span class="attr">userId</span>=<span class="string">"10091"</span> <span class="attr">isOrphaned</span>=<span class="string">"true"</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">sigs</span> <span class="attr">count</span>=<span class="string">"1"</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">cert</span> <span class="attr">index</span>=<span class="string">"0"</span> /&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">sigs</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">perms</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">item</span> <span class="attr">name</span>=<span class="string">"android.permission.REAL_GET_TASKS"</span> <span class="attr">granted</span>=<span class="string">"true"</span> <span class="attr">flags</span>=<span class="string">"0"</span> /&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">item</span> <span class="attr">name</span>=<span class="string">"android.permission.RECEIVE_BOOT_COMPLETED"</span> <span class="attr">granted</span>=<span class="string">"true"</span> <span class="attr">flags</span>=<span class="string">"0"</span> /&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">item</span> <span class="attr">name</span>=<span class="string">"android.permission.INTERNET"</span> <span class="attr">granted</span>=<span class="string">"true"</span> <span class="attr">flags</span>=<span class="string">"0"</span> /&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">item</span> <span class="attr">name</span>=<span class="string">"android.permission.ACCESS_NETWORK_STATE"</span> <span class="attr">granted</span>=<span class="string">"true"</span> <span class="attr">flags</span>=<span class="string">"0"</span> /&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">perms</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">proper-signing-keyset</span> <span class="attr">identifier</span>=<span class="string">"1"</span> /&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">package</span>&gt;</span></span><br></pre></td></tr></table></figure></p>
<p>接下来，看看具体的解析过程：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">if</span> (tagName.equals(<span class="string">"package"</span>)) &#123;</span><br><span class="line">    readPackageLPw(parser);     </span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h4 id="8-1-1-1-Settings-readPackageLPw"><a href="#8-1-1-1-Settings-readPackageLPw" class="headerlink" title="8.1.1.1 Settings.readPackageLPw"></a>8.1.1.1 Settings.readPackageLPw</h4><p>调用 readPackageLPw 方法！<br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br><span class="line">212</span><br><span class="line">213</span><br><span class="line">214</span><br><span class="line">215</span><br><span class="line">216</span><br><span class="line">217</span><br><span class="line">218</span><br><span class="line">219</span><br><span class="line">220</span><br><span class="line">221</span><br><span class="line">222</span><br><span class="line">223</span><br><span class="line">224</span><br><span class="line">225</span><br><span class="line">226</span><br><span class="line">227</span><br><span class="line">228</span><br><span class="line">229</span><br><span class="line">230</span><br><span class="line">231</span><br><span class="line">232</span><br><span class="line">233</span><br><span class="line">234</span><br><span class="line">235</span><br><span class="line">236</span><br><span class="line">237</span><br><span class="line">238</span><br><span class="line">239</span><br><span class="line">240</span><br><span class="line">241</span><br><span class="line">242</span><br><span class="line">243</span><br><span class="line">244</span><br><span class="line">245</span><br><span class="line">246</span><br><span class="line">247</span><br><span class="line">248</span><br><span class="line">249</span><br><span class="line">250</span><br><span class="line">251</span><br><span class="line">252</span><br><span class="line">253</span><br><span class="line">254</span><br><span class="line">255</span><br><span class="line">256</span><br><span class="line">257</span><br><span class="line">258</span><br><span class="line">259</span><br><span class="line">260</span><br><span class="line">261</span><br><span class="line">262</span><br><span class="line">263</span><br><span class="line">264</span><br><span class="line">265</span><br><span class="line">266</span><br><span class="line">267</span><br><span class="line">268</span><br><span class="line">269</span><br><span class="line">270</span><br><span class="line">271</span><br><span class="line">272</span><br><span class="line">273</span><br><span class="line">274</span><br><span class="line">275</span><br><span class="line">276</span><br><span class="line">277</span><br><span class="line">278</span><br><span class="line">279</span><br><span class="line">280</span><br><span class="line">281</span><br><span class="line">282</span><br><span class="line">283</span><br><span class="line">284</span><br><span class="line">285</span><br><span class="line">286</span><br><span class="line">287</span><br><span class="line">288</span><br><span class="line">289</span><br><span class="line">290</span><br><span class="line">291</span><br><span class="line">292</span><br><span class="line">293</span><br><span class="line">294</span><br><span class="line">295</span><br><span class="line">296</span><br><span class="line">297</span><br><span class="line">298</span><br><span class="line">299</span><br><span class="line">300</span><br><span class="line">301</span><br><span class="line">302</span><br><span class="line">303</span><br><span class="line">304</span><br><span class="line">305</span><br><span class="line">306</span><br><span class="line">307</span><br><span class="line">308</span><br><span class="line">309</span><br><span class="line">310</span><br><span class="line">311</span><br><span class="line">312</span><br><span class="line">313</span><br><span class="line">314</span><br><span class="line">315</span><br><span class="line">316</span><br><span class="line">317</span><br><span class="line">318</span><br><span class="line">319</span><br><span class="line">320</span><br><span class="line">321</span><br><span class="line">322</span><br><span class="line">323</span><br><span class="line">324</span><br><span class="line">325</span><br><span class="line">326</span><br><span class="line">327</span><br><span class="line">328</span><br><span class="line">329</span><br><span class="line">330</span><br><span class="line">331</span><br><span class="line">332</span><br><span class="line">333</span><br><span class="line">334</span><br><span class="line">335</span><br><span class="line">336</span><br><span class="line">337</span><br><span class="line">338</span><br><span class="line">339</span><br><span class="line">340</span><br><span class="line">341</span><br><span class="line">342</span><br><span class="line">343</span><br><span class="line">344</span><br><span class="line">345</span><br><span class="line">346</span><br><span class="line">347</span><br><span class="line">348</span><br><span class="line">349</span><br><span class="line">350</span><br><span class="line">351</span><br><span class="line">352</span><br><span class="line">353</span><br><span class="line">354</span><br><span class="line">355</span><br><span class="line">356</span><br><span class="line">357</span><br><span class="line">358</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">readPackageLPw</span><span class="params">(XmlPullParser parser)</span> <span class="keyword">throws</span> XmlPullParserException, IOException </span>&#123;</span><br><span class="line">    <span class="comment">// 需要解析的属性</span></span><br><span class="line">    String name = <span class="keyword">null</span>;</span><br><span class="line">    String realName = <span class="keyword">null</span>;</span><br><span class="line">    String idStr = <span class="keyword">null</span>;</span><br><span class="line">    String sharedIdStr = <span class="keyword">null</span>;</span><br><span class="line">    String codePathStr = <span class="keyword">null</span>;</span><br><span class="line">    String resourcePathStr = <span class="keyword">null</span>;</span><br><span class="line">    String legacyCpuAbiString = <span class="keyword">null</span>;</span><br><span class="line">    String legacyNativeLibraryPathStr = <span class="keyword">null</span>;</span><br><span class="line">    String primaryCpuAbiString = <span class="keyword">null</span>;</span><br><span class="line">    String secondaryCpuAbiString = <span class="keyword">null</span>;</span><br><span class="line">    String cpuAbiOverrideString = <span class="keyword">null</span>;</span><br><span class="line">    String systemStr = <span class="keyword">null</span>;</span><br><span class="line">    String installerPackageName = <span class="keyword">null</span>;</span><br><span class="line">    String isOrphaned = <span class="keyword">null</span>;</span><br><span class="line">    String volumeUuid = <span class="keyword">null</span>;</span><br><span class="line">    String uidError = <span class="keyword">null</span>;</span><br><span class="line">    <span class="keyword">int</span> pkgFlags = <span class="number">0</span>;</span><br><span class="line">    <span class="keyword">int</span> pkgPrivateFlags = <span class="number">0</span>;</span><br><span class="line">    <span class="keyword">long</span> timeStamp = <span class="number">0</span>;</span><br><span class="line">    <span class="keyword">long</span> firstInstallTime = <span class="number">0</span>;</span><br><span class="line">    <span class="keyword">long</span> lastUpdateTime = <span class="number">0</span>;</span><br><span class="line">    PackageSettingBase packageSetting = <span class="keyword">null</span>;</span><br><span class="line">    String version = <span class="keyword">null</span>;</span><br><span class="line">    <span class="keyword">int</span> versionCode = <span class="number">0</span>;</span><br><span class="line">    String parentPackageName;</span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">        </span><br><span class="line">        <span class="comment">//【1】获得应用的 name！</span></span><br><span class="line">        name = parser.getAttributeValue(<span class="keyword">null</span>, ATTR_NAME);</span><br><span class="line">        realName = parser.getAttributeValue(<span class="keyword">null</span>, <span class="string">"realName"</span>);</span><br><span class="line">        </span><br><span class="line">        <span class="comment">//【2】获得 userId 和 sharedId 的名称, userId 和 sharedIdStr 不能同时存在！</span></span><br><span class="line">        idStr = parser.getAttributeValue(<span class="keyword">null</span>, <span class="string">"userId"</span>);</span><br><span class="line">        uidError = parser.getAttributeValue(<span class="keyword">null</span>, <span class="string">"uidError"</span>);</span><br><span class="line">        sharedIdStr = parser.getAttributeValue(<span class="keyword">null</span>, <span class="string">"sharedUserId"</span>);</span><br><span class="line">        </span><br><span class="line">        <span class="comment">//【3】获得应用程序包的路径，例如：/system/priv-app/CalendarProvider！</span></span><br><span class="line">        codePathStr = parser.getAttributeValue(<span class="keyword">null</span>, <span class="string">"codePath"</span>);</span><br><span class="line">        resourcePathStr = parser.getAttributeValue(<span class="keyword">null</span>, <span class="string">"resourcePath"</span>);</span><br><span class="line"></span><br><span class="line">        legacyCpuAbiString = parser.getAttributeValue(<span class="keyword">null</span>, <span class="string">"requiredCpuAbi"</span>);</span><br><span class="line"></span><br><span class="line">        parentPackageName = parser.getAttributeValue(<span class="keyword">null</span>, <span class="string">"parentPackageName"</span>);</span><br><span class="line"></span><br><span class="line">        legacyNativeLibraryPathStr = parser.getAttributeValue(<span class="keyword">null</span>, <span class="string">"nativeLibraryPath"</span>);</span><br><span class="line">        primaryCpuAbiString = parser.getAttributeValue(<span class="keyword">null</span>, <span class="string">"primaryCpuAbi"</span>);</span><br><span class="line">        secondaryCpuAbiString = parser.getAttributeValue(<span class="keyword">null</span>, <span class="string">"secondaryCpuAbi"</span>);</span><br><span class="line">        cpuAbiOverrideString = parser.getAttributeValue(<span class="keyword">null</span>, <span class="string">"cpuAbiOverride"</span>);</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (primaryCpuAbiString == <span class="keyword">null</span> &amp;&amp; legacyCpuAbiString != <span class="keyword">null</span>) &#123;</span><br><span class="line">            primaryCpuAbiString = legacyCpuAbiString;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment">//【4】获得版本号！</span></span><br><span class="line">        version = parser.getAttributeValue(<span class="keyword">null</span>, <span class="string">"version"</span>);</span><br><span class="line">        <span class="keyword">if</span> (version != <span class="keyword">null</span>) &#123;</span><br><span class="line">            <span class="keyword">try</span> &#123;</span><br><span class="line">                versionCode = Integer.parseInt(version);</span><br><span class="line">            &#125; <span class="keyword">catch</span> (NumberFormatException e) &#123;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 获得安装器的名称！</span></span><br><span class="line">        installerPackageName = parser.getAttributeValue(<span class="keyword">null</span>, <span class="string">"installer"</span>);</span><br><span class="line">        isOrphaned = parser.getAttributeValue(<span class="keyword">null</span>, <span class="string">"isOrphaned"</span>);</span><br><span class="line">        volumeUuid = parser.getAttributeValue(<span class="keyword">null</span>, <span class="string">"volumeUuid"</span>);</span><br><span class="line">        </span><br><span class="line">        <span class="comment">//【5】获得flags相关信息，读取顺序为：publicFlags 和 privateFlags、flags、system;</span></span><br><span class="line">        systemStr = parser.getAttributeValue(<span class="keyword">null</span>, <span class="string">"publicFlags"</span>);</span><br><span class="line">        <span class="keyword">if</span> (systemStr != <span class="keyword">null</span>) &#123;</span><br><span class="line">            <span class="keyword">try</span> &#123;</span><br><span class="line">                pkgFlags = Integer.parseInt(systemStr);</span><br><span class="line">            &#125; <span class="keyword">catch</span> (NumberFormatException e) &#123;</span><br><span class="line">            &#125;</span><br><span class="line">            systemStr = parser.getAttributeValue(<span class="keyword">null</span>, <span class="string">"privateFlags"</span>);</span><br><span class="line">            <span class="keyword">if</span> (systemStr != <span class="keyword">null</span>) &#123;</span><br><span class="line">                <span class="keyword">try</span> &#123;</span><br><span class="line">                    pkgPrivateFlags = Integer.parseInt(systemStr);</span><br><span class="line">                &#125; <span class="keyword">catch</span> (NumberFormatException e) &#123;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            <span class="comment">// 在 Android M 之前，是没有 publicFlags 和 privateFlags 之分的，所有的标志位都存放在 flags 中！</span></span><br><span class="line">            systemStr = parser.getAttributeValue(<span class="keyword">null</span>, <span class="string">"flags"</span>);</span><br><span class="line">            <span class="keyword">if</span> (systemStr != <span class="keyword">null</span>) &#123;</span><br><span class="line">                <span class="keyword">try</span> &#123;</span><br><span class="line">                    pkgFlags = Integer.parseInt(systemStr);</span><br><span class="line">                &#125; <span class="keyword">catch</span> (NumberFormatException e) &#123;</span><br><span class="line">                &#125;</span><br><span class="line">                <span class="keyword">if</span> ((pkgFlags &amp; PRE_M_APP_INFO_FLAG_HIDDEN) != <span class="number">0</span>) &#123;</span><br><span class="line">                    pkgPrivateFlags |= ApplicationInfo.PRIVATE_FLAG_HIDDEN;</span><br><span class="line">                &#125;</span><br><span class="line">                <span class="keyword">if</span> ((pkgFlags &amp; PRE_M_APP_INFO_FLAG_CANT_SAVE_STATE) != <span class="number">0</span>) &#123;</span><br><span class="line">                    pkgPrivateFlags |= ApplicationInfo.PRIVATE_FLAG_CANT_SAVE_STATE;</span><br><span class="line">                &#125;</span><br><span class="line">                <span class="keyword">if</span> ((pkgFlags &amp; PRE_M_APP_INFO_FLAG_FORWARD_LOCK) != <span class="number">0</span>) &#123;</span><br><span class="line">                    pkgPrivateFlags |= ApplicationInfo.PRIVATE_FLAG_FORWARD_LOCK;</span><br><span class="line">                &#125;</span><br><span class="line">                <span class="keyword">if</span> ((pkgFlags &amp; PRE_M_APP_INFO_FLAG_PRIVILEGED) != <span class="number">0</span>) &#123;</span><br><span class="line">                    pkgPrivateFlags |= ApplicationInfo.PRIVATE_FLAG_PRIVILEGED;</span><br><span class="line">                &#125;</span><br><span class="line">                pkgFlags &amp;= ~(PRE_M_APP_INFO_FLAG_HIDDEN</span><br><span class="line">                        | PRE_M_APP_INFO_FLAG_CANT_SAVE_STATE</span><br><span class="line">                        | PRE_M_APP_INFO_FLAG_FORWARD_LOCK</span><br><span class="line">                        | PRE_M_APP_INFO_FLAG_PRIVILEGED);</span><br><span class="line">            &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                <span class="comment">// For backward compatibility</span></span><br><span class="line">                systemStr = parser.getAttributeValue(<span class="keyword">null</span>, <span class="string">"system"</span>);</span><br><span class="line">                <span class="keyword">if</span> (systemStr != <span class="keyword">null</span>) &#123;</span><br><span class="line">                    pkgFlags |= (<span class="string">"true"</span>.equalsIgnoreCase(systemStr)) ? ApplicationInfo.FLAG_SYSTEM</span><br><span class="line">                            : <span class="number">0</span>;</span><br><span class="line">                &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                    <span class="comment">// Old settings that don't specify system... just treat</span></span><br><span class="line">                    <span class="comment">// them as system, good enough.</span></span><br><span class="line">                    pkgFlags |= ApplicationInfo.FLAG_SYSTEM;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        </span><br><span class="line">        <span class="comment">// 获得时间戳！</span></span><br><span class="line">        String timeStampStr = parser.getAttributeValue(<span class="keyword">null</span>, <span class="string">"ft"</span>);</span><br><span class="line">        <span class="keyword">if</span> (timeStampStr != <span class="keyword">null</span>) &#123;</span><br><span class="line">            <span class="keyword">try</span> &#123;</span><br><span class="line">                timeStamp = Long.parseLong(timeStampStr, <span class="number">16</span>);</span><br><span class="line">            &#125; <span class="keyword">catch</span> (NumberFormatException e) &#123;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            timeStampStr = parser.getAttributeValue(<span class="keyword">null</span>, <span class="string">"ts"</span>);</span><br><span class="line">            <span class="keyword">if</span> (timeStampStr != <span class="keyword">null</span>) &#123;</span><br><span class="line">                <span class="keyword">try</span> &#123;</span><br><span class="line">                    timeStamp = Long.parseLong(timeStampStr);</span><br><span class="line">                &#125; <span class="keyword">catch</span> (NumberFormatException e) &#123;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        </span><br><span class="line">        <span class="comment">//【6】获得第一次安装时间</span></span><br><span class="line">        timeStampStr = parser.getAttributeValue(<span class="keyword">null</span>, <span class="string">"it"</span>);</span><br><span class="line">        <span class="keyword">if</span> (timeStampStr != <span class="keyword">null</span>) &#123;</span><br><span class="line">            <span class="keyword">try</span> &#123;</span><br><span class="line">                firstInstallTime = Long.parseLong(timeStampStr, <span class="number">16</span>);</span><br><span class="line">            &#125; <span class="keyword">catch</span> (NumberFormatException e) &#123;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        </span><br><span class="line">        <span class="comment">//【7】获得最近更新时间！</span></span><br><span class="line">        timeStampStr = parser.getAttributeValue(<span class="keyword">null</span>, <span class="string">"ut"</span>);</span><br><span class="line">        <span class="keyword">if</span> (timeStampStr != <span class="keyword">null</span>) &#123;</span><br><span class="line">            <span class="keyword">try</span> &#123;</span><br><span class="line">                lastUpdateTime = Long.parseLong(timeStampStr, <span class="number">16</span>);</span><br><span class="line">            &#125; <span class="keyword">catch</span> (NumberFormatException e) &#123;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">if</span> (PackageManagerService.DEBUG_SETTINGS)</span><br><span class="line">            Log.v(PackageManagerService.TAG, <span class="string">"Reading package: "</span> + name + <span class="string">" userId="</span> + idStr</span><br><span class="line">                    + <span class="string">" sharedUserId="</span> + sharedIdStr);</span><br><span class="line">                    </span><br><span class="line">        <span class="comment">//【8】获得 userId 的 int 值，如果 AndroidManifest.xml 有设置 android:sharedUserId 属性，</span></span><br><span class="line">        <span class="comment">// 那么应用的 userId 就为 0！！</span></span><br><span class="line">        <span class="keyword">int</span> userId = idStr != <span class="keyword">null</span> ? Integer.parseInt(idStr) : <span class="number">0</span>;</span><br><span class="line">        <span class="keyword">if</span> (resourcePathStr == <span class="keyword">null</span>) &#123;</span><br><span class="line">            resourcePathStr = codePathStr;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">if</span> (realName != <span class="keyword">null</span>) &#123;</span><br><span class="line">            realName = realName.intern();</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">if</span> (name == <span class="keyword">null</span>) &#123;</span><br><span class="line">            PackageManagerService.reportSettingsProblem(Log.WARN,</span><br><span class="line">                    <span class="string">"Error in package manager settings: &lt;package&gt; has no name at "</span></span><br><span class="line">                            + parser.getPositionDescription());</span><br><span class="line">        &#125; <span class="keyword">else</span> <span class="keyword">if</span> (codePathStr == <span class="keyword">null</span>) &#123;</span><br><span class="line">            PackageManagerService.reportSettingsProblem(Log.WARN,</span><br><span class="line">                    <span class="string">"Error in package manager settings: &lt;package&gt; has no codePath at "</span></span><br><span class="line">                            + parser.getPositionDescription());</span><br><span class="line">        &#125; <span class="keyword">else</span> <span class="keyword">if</span> (userId &gt; <span class="number">0</span>) &#123;</span><br><span class="line">            <span class="comment">//【8.1】如果 userId 大于0，说明 package 是独立用户 id</span></span><br><span class="line">            <span class="comment">// 调用 addPackageLPw 方法保存这个有独立的 Linux 用户 ID 的 Package!</span></span><br><span class="line">            packageSetting = addPackageLPw(name.intern(), realName, <span class="keyword">new</span> File(codePathStr),</span><br><span class="line">                    <span class="keyword">new</span> File(resourcePathStr), legacyNativeLibraryPathStr, primaryCpuAbiString,</span><br><span class="line">                    secondaryCpuAbiString, cpuAbiOverrideString, userId, versionCode, pkgFlags,</span><br><span class="line">                    pkgPrivateFlags, parentPackageName, <span class="keyword">null</span>);</span><br><span class="line"></span><br><span class="line">            <span class="keyword">if</span> (PackageManagerService.DEBUG_SETTINGS)</span><br><span class="line">                Log.i(PackageManagerService.TAG, <span class="string">"Reading package "</span> + name + <span class="string">": userId="</span></span><br><span class="line">                        + userId + <span class="string">" pkg="</span> + packageSetting);</span><br><span class="line">            <span class="keyword">if</span> (packageSetting == <span class="keyword">null</span>) &#123;</span><br><span class="line">                PackageManagerService.reportSettingsProblem(Log.ERROR, <span class="string">"Failure adding uid "</span></span><br><span class="line">                        + userId + <span class="string">" while parsing settings at "</span></span><br><span class="line">                        + parser.getPositionDescription());</span><br><span class="line">            &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                <span class="comment">// 设置时间戳，第一次安装时间，最近更新时间</span></span><br><span class="line">                packageSetting.setTimeStamp(timeStamp);</span><br><span class="line">                packageSetting.firstInstallTime = firstInstallTime;</span><br><span class="line">                packageSetting.lastUpdateTime = lastUpdateTime;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125; <span class="keyword">else</span> <span class="keyword">if</span> (sharedIdStr != <span class="keyword">null</span>) &#123;</span><br><span class="line">        </span><br><span class="line">            <span class="comment">//【8.2】sharedIdStr 不为 null，说明 package 设置了共享用户 id！</span></span><br><span class="line">            userId = sharedIdStr != <span class="keyword">null</span> ? Integer.parseInt(sharedIdStr) : <span class="number">0</span>;</span><br><span class="line">            <span class="keyword">if</span> (userId &gt; <span class="number">0</span>) &#123;</span><br><span class="line">                <span class="comment">// 对于共享用户 ID 这种情况，还需要验证其有效性!</span></span><br><span class="line">                <span class="comment">// 创建一个 PendingPackage 对象，来封装这个有共享用户 ID 的 package 的信息!</span></span><br><span class="line">                packageSetting = <span class="keyword">new</span> PendingPackage(name.intern(), realName, <span class="keyword">new</span> File(</span><br><span class="line">                        codePathStr), <span class="keyword">new</span> File(resourcePathStr), legacyNativeLibraryPathStr,</span><br><span class="line">                        primaryCpuAbiString, secondaryCpuAbiString, cpuAbiOverrideString,</span><br><span class="line">                        userId, versionCode, pkgFlags, pkgPrivateFlags, parentPackageName,</span><br><span class="line">                        <span class="keyword">null</span>);</span><br><span class="line">                   </span><br><span class="line">                <span class="comment">// 设置时间戳，第一次安装时间，最近更新时间！     </span></span><br><span class="line">                packageSetting.setTimeStamp(timeStamp);</span><br><span class="line">                packageSetting.firstInstallTime = firstInstallTime;</span><br><span class="line">                packageSetting.lastUpdateTime = lastUpdateTime;</span><br><span class="line">                </span><br><span class="line">                <span class="comment">//【8.2.1】添加到 mPendingPackages 中，因为后续需要确定 shareUserId 的有效性！</span></span><br><span class="line">                mPendingPackages.add((PendingPackage) packageSetting);</span><br><span class="line">                </span><br><span class="line">                <span class="keyword">if</span> (PackageManagerService.DEBUG_SETTINGS)</span><br><span class="line">                    Log.i(PackageManagerService.TAG, <span class="string">"Reading package "</span> + name</span><br><span class="line">                            + <span class="string">": sharedUserId="</span> + userId + <span class="string">" pkg="</span> + packageSetting);</span><br><span class="line">            &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                PackageManagerService.reportSettingsProblem(Log.WARN,</span><br><span class="line">                        <span class="string">"Error in package manager settings: package "</span> + name</span><br><span class="line">                                + <span class="string">" has bad sharedId "</span> + sharedIdStr + <span class="string">" at "</span></span><br><span class="line">                                + parser.getPositionDescription());</span><br><span class="line">            &#125;</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            PackageManagerService.reportSettingsProblem(Log.WARN,</span><br><span class="line">                    <span class="string">"Error in package manager settings: package "</span> + name + <span class="string">" has bad userId "</span></span><br><span class="line">                            + idStr + <span class="string">" at "</span> + parser.getPositionDescription());</span><br><span class="line">        &#125;</span><br><span class="line">    &#125; <span class="keyword">catch</span> (NumberFormatException e) &#123;</span><br><span class="line">        PackageManagerService.reportSettingsProblem(Log.WARN,</span><br><span class="line">                <span class="string">"Error in package manager settings: package "</span> + name + <span class="string">" has bad userId "</span></span><br><span class="line">                        + idStr + <span class="string">" at "</span> + parser.getPositionDescription());</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">//【9】接下来设置其他的属性值。</span></span><br><span class="line">    <span class="keyword">if</span> (packageSetting != <span class="keyword">null</span>) &#123;</span><br><span class="line">        packageSetting.uidError = <span class="string">"true"</span>.equals(uidError);</span><br><span class="line">        packageSetting.installerPackageName = installerPackageName;</span><br><span class="line">        packageSetting.isOrphaned = <span class="string">"true"</span>.equals(isOrphaned);</span><br><span class="line">        packageSetting.volumeUuid = volumeUuid;</span><br><span class="line">        packageSetting.legacyNativeLibraryPathString = legacyNativeLibraryPathStr;</span><br><span class="line">        packageSetting.primaryCpuAbiString = primaryCpuAbiString;</span><br><span class="line">        packageSetting.secondaryCpuAbiString = secondaryCpuAbiString;</span><br><span class="line">        <span class="comment">// Handle legacy string here for single-user mode</span></span><br><span class="line">        <span class="keyword">final</span> String enabledStr = parser.getAttributeValue(<span class="keyword">null</span>, ATTR_ENABLED);</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (enabledStr != <span class="keyword">null</span>) &#123;</span><br><span class="line">            <span class="keyword">try</span> &#123;</span><br><span class="line">                packageSetting.setEnabled(Integer.parseInt(enabledStr), <span class="number">0</span> <span class="comment">/* userId */</span>, <span class="keyword">null</span>);</span><br><span class="line">            &#125; <span class="keyword">catch</span> (NumberFormatException e) &#123;</span><br><span class="line">                <span class="keyword">if</span> (enabledStr.equalsIgnoreCase(<span class="string">"true"</span>)) &#123;</span><br><span class="line">                    packageSetting.setEnabled(COMPONENT_ENABLED_STATE_ENABLED, <span class="number">0</span>, <span class="keyword">null</span>);</span><br><span class="line">                &#125; <span class="keyword">else</span> <span class="keyword">if</span> (enabledStr.equalsIgnoreCase(<span class="string">"false"</span>)) &#123;</span><br><span class="line">                    packageSetting.setEnabled(COMPONENT_ENABLED_STATE_DISABLED, <span class="number">0</span>, <span class="keyword">null</span>);</span><br><span class="line">                &#125; <span class="keyword">else</span> <span class="keyword">if</span> (enabledStr.equalsIgnoreCase(<span class="string">"default"</span>)) &#123;</span><br><span class="line">                    packageSetting.setEnabled(COMPONENT_ENABLED_STATE_DEFAULT, <span class="number">0</span>, <span class="keyword">null</span>);</span><br><span class="line">                &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                    PackageManagerService.reportSettingsProblem(Log.WARN,</span><br><span class="line">                            <span class="string">"Error in package manager settings: package "</span> + name</span><br><span class="line">                                    + <span class="string">" has bad enabled value: "</span> + idStr + <span class="string">" at "</span></span><br><span class="line">                                    + parser.getPositionDescription());</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            packageSetting.setEnabled(COMPONENT_ENABLED_STATE_DEFAULT, <span class="number">0</span>, <span class="keyword">null</span>);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (installerPackageName != <span class="keyword">null</span>) &#123;</span><br><span class="line">            mInstallerPackages.add(installerPackageName);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">// package 安装状态！</span></span><br><span class="line">        <span class="keyword">final</span> String installStatusStr = parser.getAttributeValue(<span class="keyword">null</span>, <span class="string">"installStatus"</span>);</span><br><span class="line">        <span class="keyword">if</span> (installStatusStr != <span class="keyword">null</span>) &#123;</span><br><span class="line">            <span class="keyword">if</span> (installStatusStr.equalsIgnoreCase(<span class="string">"false"</span>)) &#123;</span><br><span class="line">                packageSetting.installStatus = PackageSettingBase.PKG_INSTALL_INCOMPLETE;</span><br><span class="line">            &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                packageSetting.installStatus = PackageSettingBase.PKG_INSTALL_COMPLETE;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">int</span> outerDepth = parser.getDepth();</span><br><span class="line">        <span class="keyword">int</span> type;</span><br><span class="line">        <span class="keyword">while</span> ((type = parser.next()) != XmlPullParser.END_DOCUMENT</span><br><span class="line">                &amp;&amp; (type != XmlPullParser.END_TAG || parser.getDepth() &gt; outerDepth)) &#123;</span><br><span class="line">            <span class="keyword">if</span> (type == XmlPullParser.END_TAG || type == XmlPullParser.TEXT) &#123;</span><br><span class="line">                <span class="keyword">continue</span>;</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            String tagName = parser.getName();</span><br><span class="line">            <span class="comment">// Legacy</span></span><br><span class="line">            <span class="keyword">if</span> (tagName.equals(TAG_DISABLED_COMPONENTS)) &#123;</span><br><span class="line">                <span class="comment">//【8.1.1.3】解析 "disabled-components"</span></span><br><span class="line">                readDisabledComponentsLPw(packageSetting, parser, <span class="number">0</span>);</span><br><span class="line">                </span><br><span class="line">            &#125; <span class="keyword">else</span> <span class="keyword">if</span> (tagName.equals(TAG_ENABLED_COMPONENTS)) &#123;</span><br><span class="line">                <span class="comment">//【8.1.1.3】解析 "enabled-components"</span></span><br><span class="line">                readEnabledComponentsLPw(packageSetting, parser, <span class="number">0</span>);</span><br><span class="line">                </span><br><span class="line">            &#125; <span class="keyword">else</span> <span class="keyword">if</span> (tagName.equals(<span class="string">"sigs"</span>)) &#123; <span class="comment">// 解析 "sigs"</span></span><br><span class="line">                packageSetting.signatures.readXml(parser, mPastSignatures);</span><br><span class="line">                </span><br><span class="line">            &#125; <span class="keyword">else</span> <span class="keyword">if</span> (tagName.equals(TAG_PERMISSIONS)) &#123; <span class="comment">// 解析 perms</span></span><br><span class="line">                <span class="comment">//【8.1.1.4】解析 "perms" 获得这个 package 的权限管理对象！</span></span><br><span class="line">                readInstallPermissionsLPr(parser, packageSetting.getPermissionsState());</span><br><span class="line">                packageSetting.installPermissionsFixed = <span class="keyword">true</span>;</span><br><span class="line">                </span><br><span class="line">            &#125; <span class="keyword">else</span> <span class="keyword">if</span> (tagName.equals(<span class="string">"proper-signing-keyset"</span>)) &#123;</span><br><span class="line">                <span class="keyword">long</span> id = Long.parseLong(parser.getAttributeValue(<span class="keyword">null</span>, <span class="string">"identifier"</span>));</span><br><span class="line">                Integer refCt = mKeySetRefs.get(id);</span><br><span class="line">                <span class="keyword">if</span> (refCt != <span class="keyword">null</span>) &#123;</span><br><span class="line">                    mKeySetRefs.put(id, refCt + <span class="number">1</span>);</span><br><span class="line">                &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                    mKeySetRefs.put(id, <span class="number">1</span>);</span><br><span class="line">                &#125;</span><br><span class="line">                packageSetting.keySetData.setProperSigningKeySet(id);</span><br><span class="line">                </span><br><span class="line">            &#125; <span class="keyword">else</span> <span class="keyword">if</span> (tagName.equals(<span class="string">"signing-keyset"</span>)) &#123;</span><br><span class="line">                <span class="comment">// from v1 of keysetmanagerservice - no longer used</span></span><br><span class="line">            &#125; <span class="keyword">else</span> <span class="keyword">if</span> (tagName.equals(<span class="string">"upgrade-keyset"</span>)) &#123;</span><br><span class="line">                <span class="keyword">long</span> id = Long.parseLong(parser.getAttributeValue(<span class="keyword">null</span>, <span class="string">"identifier"</span>));</span><br><span class="line">                packageSetting.keySetData.addUpgradeKeySetById(id);</span><br><span class="line">                </span><br><span class="line">            &#125; <span class="keyword">else</span> <span class="keyword">if</span> (tagName.equals(<span class="string">"defined-keyset"</span>)) &#123;</span><br><span class="line">                <span class="keyword">long</span> id = Long.parseLong(parser.getAttributeValue(<span class="keyword">null</span>, <span class="string">"identifier"</span>));</span><br><span class="line">                String alias = parser.getAttributeValue(<span class="keyword">null</span>, <span class="string">"alias"</span>);</span><br><span class="line">                Integer refCt = mKeySetRefs.get(id);</span><br><span class="line">                <span class="keyword">if</span> (refCt != <span class="keyword">null</span>) &#123;</span><br><span class="line">                    mKeySetRefs.put(id, refCt + <span class="number">1</span>);</span><br><span class="line">                &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                    mKeySetRefs.put(id, <span class="number">1</span>);</span><br><span class="line">                &#125;</span><br><span class="line">                packageSetting.keySetData.addDefinedKeySet(id, alias);</span><br><span class="line">                </span><br><span class="line">            &#125; <span class="keyword">else</span> <span class="keyword">if</span> (tagName.equals(TAG_DOMAIN_VERIFICATION)) &#123; <span class="comment">// 解析 "domain-verification"</span></span><br><span class="line">                readDomainVerificationLPw(parser, packageSetting);</span><br><span class="line">                </span><br><span class="line">            &#125; <span class="keyword">else</span> <span class="keyword">if</span> (tagName.equals(TAG_CHILD_PACKAGE)) &#123; <span class="comment">// 解析 "child-package"</span></span><br><span class="line">                String childPackageName = parser.getAttributeValue(<span class="keyword">null</span>, ATTR_NAME);</span><br><span class="line">                <span class="keyword">if</span> (packageSetting.childPackageNames == <span class="keyword">null</span>) &#123;</span><br><span class="line">                    packageSetting.childPackageNames = <span class="keyword">new</span> ArrayList&lt;&gt;();</span><br><span class="line">                &#125;</span><br><span class="line">                packageSetting.childPackageNames.add(childPackageName);</span><br><span class="line">                </span><br><span class="line">            &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                PackageManagerService.reportSettingsProblem(Log.WARN,</span><br><span class="line">                        <span class="string">"Unknown element under &lt;package&gt;: "</span> + parser.getName());</span><br><span class="line">                XmlUtils.skipCurrentTag(parser);</span><br><span class="line">                </span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        XmlUtils.skipCurrentTag(parser);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>流程总结：</p>
<ul>
<li>对于分配了独立的 uid 的 package，创建 PackageSetting 对象，添加到 mPackage 中，并且将自身和 uid 的引用关心保存到 mUsersId 或者 mOthersId 中；</li>
<li>对于分配了共享的 uid 的 package，创建 PendingPackage 对象，添加到 mPendingPackages 中，后续会对其共享 uid 的有效性进行校验！</li>
</ul>
<h4 id="8-1-1-2-Settings-addPackageLPw"><a href="#8-1-1-2-Settings-addPackageLPw" class="headerlink" title="8.1.1.2 Settings.addPackageLPw"></a>8.1.1.2 Settings.addPackageLPw</h4><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br></pre></td><td class="code"><pre><span class="line"><span class="function">PackageSetting <span class="title">addPackageLPw</span><span class="params">(String name, String realName, File codePath, File resourcePath,</span></span></span><br><span class="line"><span class="function"><span class="params">        String legacyNativeLibraryPathString, String primaryCpuAbiString,</span></span></span><br><span class="line"><span class="function"><span class="params">        String secondaryCpuAbiString, String cpuAbiOverrideString, <span class="keyword">int</span> uid, <span class="keyword">int</span> vc, <span class="keyword">int</span></span></span></span><br><span class="line"><span class="function"><span class="params">        pkgFlags, <span class="keyword">int</span> pkgPrivateFlags, String parentPackageName,</span></span></span><br><span class="line"><span class="function"><span class="params">        List&lt;String&gt; childPackageNames)</span> </span>&#123;</span><br><span class="line">    <span class="comment">//【1】根据 name 值从 mPackage 集合中查询 name 对应的 PackageSettings 对象。</span></span><br><span class="line">    PackageSetting p = mPackages.get(name);</span><br><span class="line">    <span class="keyword">if</span> (p != <span class="keyword">null</span>) &#123;</span><br><span class="line">        <span class="comment">// 如果能得到，且两个 uid 相等，说明已经创建过了，那就直接返回！</span></span><br><span class="line">        <span class="keyword">if</span> (p.appId == uid) &#123;</span><br><span class="line">            <span class="keyword">return</span> p;</span><br><span class="line">        &#125;</span><br><span class="line">        PackageManagerService.reportSettingsProblem(Log.ERROR,</span><br><span class="line">                <span class="string">"Adding duplicate package, keeping first: "</span> + name);</span><br><span class="line">        <span class="comment">// 如果发现 uid 变化了，那就不会读取上一次的安装信息！</span></span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">null</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">//【2】否则，就创建一个 PackageSettings 对象来封装这个应用程序的信息。</span></span><br><span class="line">    p = <span class="keyword">new</span> PackageSetting(name, realName, codePath, resourcePath,</span><br><span class="line">            legacyNativeLibraryPathString, primaryCpuAbiString, secondaryCpuAbiString,</span><br><span class="line">            cpuAbiOverrideString, vc, pkgFlags, pkgPrivateFlags, parentPackageName,</span><br><span class="line">            childPackageNames);</span><br><span class="line">    </span><br><span class="line">    <span class="comment">//【3】他的 appid        </span></span><br><span class="line">    p.appId = uid;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">//【8.1.1.2.1】在系统中保留值为 uid 的 Linux 用户 ID，添加到 mUserIds 或者 mOtherUserIds 中！</span></span><br><span class="line">    <span class="keyword">if</span> (addUserIdLPw(uid, p, name)) &#123;</span><br><span class="line">    </span><br><span class="line">        <span class="comment">//【4.1】将这个 PackageSettings 对象保存在 Settings.mPackages 中！！</span></span><br><span class="line">        mPackages.put(name, p);</span><br><span class="line">        <span class="keyword">return</span> p;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">null</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>这里会调用 addUserIdLPw 方法，将 package 的 uid 进行封装，根据其范围，将其添加到 mUserIds 或者 mOtherUserIds 中！</p>
<h5 id="8-1-1-2-1-Settings-addUserIdLPw"><a href="#8-1-1-2-1-Settings-addUserIdLPw" class="headerlink" title="8.1.1.2.1 Settings.addUserIdLPw"></a>8.1.1.2.1 Settings.addUserIdLPw</h5><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">boolean</span> <span class="title">addUserIdLPw</span><span class="params">(<span class="keyword">int</span> uid, Object obj, Object name)</span> </span>&#123;</span><br><span class="line">    <span class="comment">//【1】当 uid &gt; Process.LAST_APPLICATION_UID 时，超过了系统给应用程序分配的 uid 的最大值，这是非法的 uid</span></span><br><span class="line">    <span class="keyword">if</span> (uid &gt; Process.LAST_APPLICATION_UID) &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">false</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//【2】当 uid 介于 Process.FIRST_APPLICATION_UID 和 Process.LAST_APPLICATION_UID 之间时，</span></span><br><span class="line">    <span class="comment">// 说明这是保留给应用程序使用的。</span></span><br><span class="line">    <span class="keyword">if</span> (uid &gt;= Process.FIRST_APPLICATION_UID) &#123;</span><br><span class="line">        <span class="keyword">int</span> N = mUserIds.size();</span><br><span class="line">        </span><br><span class="line">        <span class="comment">//【2.1】根据 uid 来计算在 idex！</span></span><br><span class="line">        <span class="keyword">final</span> <span class="keyword">int</span> index = uid - Process.FIRST_APPLICATION_UID;</span><br><span class="line">        <span class="keyword">while</span> (index &gt;= N) &#123;</span><br><span class="line">            mUserIds.add(<span class="keyword">null</span>);</span><br><span class="line">            N++;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">if</span> (mUserIds.get(index) != <span class="keyword">null</span>) &#123;</span><br><span class="line">            PackageManagerService.reportSettingsProblem(Log.ERROR,</span><br><span class="line">                    <span class="string">"Adding duplicate user id: "</span> + uid</span><br><span class="line">                    + <span class="string">" name="</span> + name);</span><br><span class="line">            <span class="keyword">return</span> <span class="keyword">false</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        </span><br><span class="line">        <span class="comment">//【2.2】把这个应用程序 PackageSettings 对象保存在这个列表中</span></span><br><span class="line">        mUserIds.set(index, obj);</span><br><span class="line">        </span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        <span class="comment">//【2.3】当 uid &lt; Process.FIRST_APPLICATION_UID，说明是给系统使用的用户 id。</span></span><br><span class="line">        <span class="keyword">if</span> (mOtherUserIds.get(uid) != <span class="keyword">null</span>) &#123;</span><br><span class="line">            PackageManagerService.reportSettingsProblem(Log.ERROR,</span><br><span class="line">                    <span class="string">"Adding duplicate shared id: "</span> + uid</span><br><span class="line">                            + <span class="string">" name="</span> + name);</span><br><span class="line">            <span class="keyword">return</span> <span class="keyword">false</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        </span><br><span class="line">        <span class="comment">//【2.4】同理</span></span><br><span class="line">        mOtherUserIds.put(uid, obj);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">true</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>到这里，我们解析 /data/system/packages.xml 里 “package” 标签对应的 xml 元素，对于 “package” 标签的子标签 “perms”，我们最后在再分析！</p>
<h4 id="8-1-1-3-解析-“disabled-components”-“enabled-component-子标签"><a href="#8-1-1-3-解析-“disabled-components”-“enabled-component-子标签" class="headerlink" title="8.1.1.3 解析 “disabled-components” / “enabled-component 子标签"></a>8.1.1.3 解析 “disabled-components” / “enabled-component 子标签</h4><p>下面是解析可用和不可用组件的过程：</p>
<h5 id="8-1-1-3-1-Settings-readDisabledComponentsLPw"><a href="#8-1-1-3-1-Settings-readDisabledComponentsLPw" class="headerlink" title="8.1.1.3.1 Settings.readDisabledComponentsLPw"></a>8.1.1.3.1 Settings.readDisabledComponentsLPw</h5><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">readDisabledComponentsLPw</span><span class="params">(PackageSettingBase packageSetting, XmlPullParser parser,</span></span></span><br><span class="line"><span class="function"><span class="params">        <span class="keyword">int</span> userId)</span> <span class="keyword">throws</span> IOException, XmlPullParserException </span>&#123;</span><br><span class="line">    <span class="keyword">int</span> outerDepth = parser.getDepth();</span><br><span class="line">    <span class="keyword">int</span> type;</span><br><span class="line">    <span class="keyword">while</span> ((type = parser.next()) != XmlPullParser.END_DOCUMENT</span><br><span class="line">            &amp;&amp; (type != XmlPullParser.END_TAG || parser.getDepth() &gt; outerDepth)) &#123;</span><br><span class="line">        <span class="keyword">if</span> (type == XmlPullParser.END_TAG || type == XmlPullParser.TEXT) &#123;</span><br><span class="line">            <span class="keyword">continue</span>;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        String tagName = parser.getName();</span><br><span class="line">        <span class="keyword">if</span> (tagName.equals(TAG_ITEM)) &#123; <span class="comment">// item 标签</span></span><br><span class="line">            String name = parser.getAttributeValue(<span class="keyword">null</span>, ATTR_NAME); <span class="comment">// 解析 name 属性</span></span><br><span class="line">            <span class="keyword">if</span> (name != <span class="keyword">null</span>) &#123;</span><br><span class="line">                packageSetting.addDisabledComponent(name.intern(), userId); </span><br><span class="line">            &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                PackageManagerService.reportSettingsProblem(Log.WARN,</span><br><span class="line">                        <span class="string">"Error in package manager settings: &lt;disabled-components&gt; has"</span></span><br><span class="line">                                + <span class="string">" no name at "</span> + parser.getPositionDescription());</span><br><span class="line">            &#125;</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            PackageManagerService.reportSettingsProblem(Log.WARN,</span><br><span class="line">                    <span class="string">"Unknown element under &lt;disabled-components&gt;: "</span> + parser.getName());</span><br><span class="line">        &#125;</span><br><span class="line">        XmlUtils.skipCurrentTag(parser);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>这里调用了 PackageSettingBase 的 addDisabledComponent 方法！<br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">addDisabledComponent</span><span class="params">(String componentClassName, <span class="keyword">int</span> userId)</span> </span>&#123;</span><br><span class="line">    modifyUserStateComponents(userId, <span class="keyword">true</span>, <span class="keyword">false</span>).disabledComponents.add(componentClassName);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>这里要看下 PackageSettingBase 的 modifyUserStateComponents 方法！</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="function">PackageUserState <span class="title">modifyUserStateComponents</span><span class="params">(<span class="keyword">int</span> userId, <span class="keyword">boolean</span> disabled, <span class="keyword">boolean</span> enabled)</span> </span>&#123;</span><br><span class="line">    <span class="comment">//【1】创建该 package 在当前 userId 下的 PackageUserState 对象！</span></span><br><span class="line">    PackageUserState state = modifyUserState(userId);</span><br><span class="line">    <span class="keyword">if</span> (disabled &amp;&amp; state.disabledComponents == <span class="keyword">null</span>) &#123;</span><br><span class="line">        state.disabledComponents = <span class="keyword">new</span> ArraySet&lt;String&gt;(<span class="number">1</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span> (enabled &amp;&amp; state.enabledComponents == <span class="keyword">null</span>) &#123;</span><br><span class="line">        state.enabledComponents = <span class="keyword">new</span> ArraySet&lt;String&gt;(<span class="number">1</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> state;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>PackageSettingBase 有一个 userState 成员变量，用于保存该 package 在不同 userId 下的使用情况！<br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">private</span> <span class="keyword">final</span> SparseArray&lt;PackageUserState&gt; userState = <span class="keyword">new</span> SparseArray&lt;PackageUserState&gt;();</span><br></pre></td></tr></table></figure></p>
<p>PackageSettingBase.modifyUserState 返回 userId 下该 package 的 PackageUserState 对象，若没还有就会创建新的！<br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">private</span> PackageUserState <span class="title">modifyUserState</span><span class="params">(<span class="keyword">int</span> userId)</span> </span>&#123;</span><br><span class="line">    PackageUserState state = userState.get(userId);</span><br><span class="line">    <span class="keyword">if</span> (state == <span class="keyword">null</span>) &#123;</span><br><span class="line">        state = <span class="keyword">new</span> PackageUserState();</span><br><span class="line">        userState.put(userId, state);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> state;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>PackageUserState 的属性如下，调用了默认的构造器，这里先不多说！<br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">PackageUserState</span> </span>&#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">long</span> ceDataInode;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">boolean</span> installed;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">boolean</span> stopped;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">boolean</span> notLaunched;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">boolean</span> hidden; <span class="comment">// Is the app restricted by owner / admin</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">boolean</span> suspended;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">boolean</span> blockUninstall;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">int</span> enabled;</span><br><span class="line">    <span class="keyword">public</span> String lastDisableAppCaller;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">int</span> domainVerificationStatus;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">int</span> appLinkGeneration;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> ArraySet&lt;String&gt; disabledComponents; <span class="comment">// 保存不可用的组件</span></span><br><span class="line">    <span class="keyword">public</span> ArraySet&lt;String&gt; enabledComponents; <span class="comment">// 保存可用组件！</span></span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="title">PackageUserState</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        installed = <span class="keyword">true</span>;</span><br><span class="line">        hidden = <span class="keyword">false</span>;</span><br><span class="line">        suspended = <span class="keyword">false</span>;</span><br><span class="line">        enabled = COMPONENT_ENABLED_STATE_DEFAULT;</span><br><span class="line">        domainVerificationStatus =</span><br><span class="line">                PackageManager.INTENT_FILTER_DOMAIN_VERIFICATION_STATUS_UNDEFINED;</span><br><span class="line">    &#125;</span><br><span class="line">    ... ... ... ...</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>解析不可用组件的过程到这里就结束了！</p>
<h5 id="8-1-1-3-2-Settings-readEnabledComponentsLPw"><a href="#8-1-1-3-2-Settings-readEnabledComponentsLPw" class="headerlink" title="8.1.1.3.2 Settings.readEnabledComponentsLPw"></a>8.1.1.3.2 Settings.readEnabledComponentsLPw</h5><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">readEnabledComponentsLPw</span><span class="params">(PackageSettingBase packageSetting, XmlPullParser parser,</span></span></span><br><span class="line"><span class="function"><span class="params">        <span class="keyword">int</span> userId)</span> <span class="keyword">throws</span> IOException, XmlPullParserException </span>&#123;</span><br><span class="line">    <span class="keyword">int</span> outerDepth = parser.getDepth();</span><br><span class="line">    <span class="keyword">int</span> type;</span><br><span class="line">    <span class="keyword">while</span> ((type = parser.next()) != XmlPullParser.END_DOCUMENT</span><br><span class="line">            &amp;&amp; (type != XmlPullParser.END_TAG || parser.getDepth() &gt; outerDepth)) &#123;</span><br><span class="line">        <span class="keyword">if</span> (type == XmlPullParser.END_TAG || type == XmlPullParser.TEXT) &#123;</span><br><span class="line">            <span class="keyword">continue</span>;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        String tagName = parser.getName();</span><br><span class="line">        <span class="keyword">if</span> (tagName.equals(TAG_ITEM)) &#123; <span class="comment">// item 标签</span></span><br><span class="line">            String name = parser.getAttributeValue(<span class="keyword">null</span>, ATTR_NAME); <span class="comment">// 解析 name 属性</span></span><br><span class="line">            <span class="keyword">if</span> (name != <span class="keyword">null</span>) &#123;</span><br><span class="line">                packageSetting.addEnabledComponent(name.intern(), userId);</span><br><span class="line">            &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                PackageManagerService.reportSettingsProblem(Log.WARN,</span><br><span class="line">                        <span class="string">"Error in package manager settings: &lt;enabled-components&gt; has"</span></span><br><span class="line">                                + <span class="string">" no name at "</span> + parser.getPositionDescription());</span><br><span class="line">            &#125;</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            PackageManagerService.reportSettingsProblem(Log.WARN,</span><br><span class="line">                    <span class="string">"Unknown element under &lt;enabled-components&gt;: "</span> + parser.getName());</span><br><span class="line">        &#125;</span><br><span class="line">        XmlUtils.skipCurrentTag(parser);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>同样的，这里调用了 PackageSettingBase 的 addEnabledComponent 方法：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">addEnabledComponent</span><span class="params">(String componentClassName, <span class="keyword">int</span> userId)</span> </span>&#123;</span><br><span class="line">    modifyUserStateComponents(userId, <span class="keyword">false</span>, <span class="keyword">true</span>).enabledComponents.add(componentClassName);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>这里就不在分析了！</p>
<h4 id="8-1-1-4-解析-“perms”-子标签-解析安装时权限授予情况"><a href="#8-1-1-4-解析-“perms”-子标签-解析安装时权限授予情况" class="headerlink" title="8.1.1.4 解析 “perms” 子标签 - 解析安装时权限授予情况"></a>8.1.1.4 解析 “perms” 子标签 - 解析安装时权限授予情况</h4><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">perms</span>&gt;</span></span><br><span class="line">     <span class="tag">&lt;<span class="name">item</span> <span class="attr">name</span>=<span class="string">"android.permission.REAL_GET_TASKS"</span> <span class="attr">granted</span>=<span class="string">"true"</span> <span class="attr">flags</span>=<span class="string">"0"</span> /&gt;</span></span><br><span class="line">     <span class="tag">&lt;<span class="name">item</span> <span class="attr">name</span>=<span class="string">"android.permission.RECEIVE_BOOT_COMPLETED"</span> <span class="attr">granted</span>=<span class="string">"true"</span> <span class="attr">flags</span>=<span class="string">"0"</span> /&gt;</span></span><br><span class="line">     <span class="tag">&lt;<span class="name">item</span> <span class="attr">name</span>=<span class="string">"android.permission.INTERNET"</span> <span class="attr">granted</span>=<span class="string">"true"</span> <span class="attr">flags</span>=<span class="string">"0"</span> /&gt;</span></span><br><span class="line">     <span class="tag">&lt;<span class="name">item</span> <span class="attr">name</span>=<span class="string">"android.permission.ACCESS_NETWORK_STATE"</span> <span class="attr">granted</span>=<span class="string">"true"</span> <span class="attr">flags</span>=<span class="string">"0"</span> /&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">perms</span>&gt;</span></span><br></pre></td></tr></table></figure>
<p>对于 PackageSetting 和 SharedUserSetting 都有自己的权限管理对象 PermissionsState，用于保存和管理 package 和 SharedUser 所有的权限，其权限通过解析子标签 “perms” 获得，具体的解析方法是 readInstallPermissionsLPr！</p>
<p>这里会涉及到一个对象，每一个 PackageSetting 对象都有一个 PermissionsState 对象，用于管理 package 的权限！<br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">PermissionsState</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="keyword">int</span> PERMISSION_OPERATION_FAILURE = -<span class="number">1</span>; <span class="comment">// 返回值：权限操作失败</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="keyword">int</span> PERMISSION_OPERATION_SUCCESS = <span class="number">0</span>; <span class="comment">// 返回值：权限操作成功，gid 没有改变！</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="keyword">int</span> PERMISSION_OPERATION_SUCCESS_GIDS_CHANGED = <span class="number">1</span>; <span class="comment">// 返回值：权限操作成功，gid 改变！</span></span><br><span class="line">    </span><br><span class="line">    <span class="keyword">private</span> ArrayMap&lt;String, PermissionData&gt; mPermissions; <span class="comment">// 用于封装这个应用程序的所有权限！</span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">int</span>[] mGlobalGids = NO_GIDS;  </span><br><span class="line">    </span><br><span class="line">    ... ... ...</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>我们继续分析：</p>
<h5 id="8-1-1-4-1-Setting-readInstallPermissionsLPr"><a href="#8-1-1-4-1-Setting-readInstallPermissionsLPr" class="headerlink" title="8.1.1.4.1 Setting.readInstallPermissionsLPr"></a>8.1.1.4.1 Setting.readInstallPermissionsLPr</h5><p>参数传递：</p>
<ul>
<li>XmlPullParser parser：xml解析类对象，指向子标签 “perms” </li>
<li>PermissionsState permissionsState：PackageSetting.getPermissionsState 或者 SharedUserSetting.getPermissionsState!</li>
</ul>
<p><br></p>
<p>接着，调用了 readInstallPermissionsLPr 来解析 package 所使用的权限和其授予情况！</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">readInstallPermissionsLPr</span><span class="params">(XmlPullParser parser,</span></span></span><br><span class="line"><span class="function"><span class="params">        PermissionsState permissionsState)</span> <span class="keyword">throws</span> IOException, XmlPullParserException </span>&#123;</span><br><span class="line">    <span class="keyword">int</span> outerDepth = parser.getDepth();</span><br><span class="line">    <span class="keyword">int</span> type;</span><br><span class="line">    <span class="keyword">while</span> ((type=parser.next()) != XmlPullParser.END_DOCUMENT</span><br><span class="line">            &amp;&amp; (type != XmlPullParser.END_TAG</span><br><span class="line">            || parser.getDepth() &gt; outerDepth)) &#123;</span><br><span class="line">        <span class="keyword">if</span> (type == XmlPullParser.END_TAG</span><br><span class="line">                || type == XmlPullParser.TEXT) &#123;</span><br><span class="line">            <span class="keyword">continue</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        String tagName = parser.getName();</span><br><span class="line">        <span class="keyword">if</span> (tagName.equals(TAG_ITEM)) &#123; <span class="comment">// 解析 "item"</span></span><br><span class="line">            String name = parser.getAttributeValue(<span class="keyword">null</span>, ATTR_NAME); <span class="comment">// 接续 "name"，权限名称！</span></span><br><span class="line">            <span class="comment">//【1】从之前解析的 Settings.mPermissions 获得对应的权限；</span></span><br><span class="line">            BasePermission bp = mPermissions.get(name);</span><br><span class="line">            <span class="keyword">if</span> (bp == <span class="keyword">null</span>) &#123;</span><br><span class="line">                Slog.w(PackageManagerService.TAG, <span class="string">"Unknown permission: "</span> + name);</span><br><span class="line">                XmlUtils.skipCurrentTag(parser);</span><br><span class="line">                <span class="keyword">continue</span>;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="comment">//【2】解析 "granted" 标签，获得授予情况，如果没有该属性或者设置为 true，那么表示授予！</span></span><br><span class="line">            String grantedStr = parser.getAttributeValue(<span class="keyword">null</span>, ATTR_GRANTED);</span><br><span class="line">            <span class="keyword">final</span> <span class="keyword">boolean</span> granted = grantedStr == <span class="keyword">null</span></span><br><span class="line">                    || Boolean.parseBoolean(grantedStr);</span><br><span class="line"></span><br><span class="line">            <span class="comment">//【3】解析 "flags"标签</span></span><br><span class="line">            String flagsStr = parser.getAttributeValue(<span class="keyword">null</span>, ATTR_FLAGS);</span><br><span class="line">            <span class="keyword">final</span> <span class="keyword">int</span> flags = (flagsStr != <span class="keyword">null</span>)</span><br><span class="line">                    ? Integer.parseInt(flagsStr, <span class="number">16</span>) : <span class="number">0</span>;</span><br><span class="line"></span><br><span class="line">            <span class="comment">//【4】处理权限授予情况！</span></span><br><span class="line">            <span class="keyword">if</span> (granted) &#123; </span><br><span class="line">                <span class="comment">//【9.1】默认授予的情况！</span></span><br><span class="line">                <span class="keyword">if</span> (permissionsState.grantInstallPermission(bp) ==</span><br><span class="line">                        PermissionsState.PERMISSION_OPERATION_FAILURE) &#123;</span><br><span class="line">                    Slog.w(PackageManagerService.TAG, <span class="string">"Permission already added: "</span> + name);</span><br><span class="line">                    XmlUtils.skipCurrentTag(parser);</span><br><span class="line">                &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                    permissionsState.updatePermissionFlags(bp, UserHandle.USER_ALL,</span><br><span class="line">                            PackageManager.MASK_PERMISSION_FLAGS, flags);</span><br><span class="line">                &#125;</span><br><span class="line">            &#125; <span class="keyword">else</span> &#123; </span><br><span class="line">                <span class="comment">//【9.2】默认不授予的情况！</span></span><br><span class="line">                <span class="keyword">if</span> (permissionsState.revokeInstallPermission(bp) ==</span><br><span class="line">                        PermissionsState.PERMISSION_OPERATION_FAILURE) &#123;</span><br><span class="line">                    Slog.w(PackageManagerService.TAG, <span class="string">"Permission already added: "</span> + name);</span><br><span class="line">                    XmlUtils.skipCurrentTag(parser);</span><br><span class="line">                &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                    <span class="comment">//【9.3】更新权限标志位！</span></span><br><span class="line">                    permissionsState.updatePermissionFlags(bp, UserHandle.USER_ALL,</span><br><span class="line">                            PackageManager.MASK_PERMISSION_FLAGS, flags);</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            Slog.w(PackageManagerService.TAG, <span class="string">"Unknown element under &lt;permissions&gt;: "</span></span><br><span class="line">                    + parser.getName());</span><br><span class="line">            XmlUtils.skipCurrentTag(parser);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>Settings.mPermissions 中保存的权限来自两部分，一个是 SystemConfig.mPermissions 中解析到了系统定义的权限，还有一部分，来自继续 packages.xml 中获得的权限信息！</p>
<p>这里要简答的说下 flags 属性，其可以取一下的几个或者多个值：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@SystemApi</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="keyword">int</span> FLAG_PERMISSION_USER_SET = <span class="number">1</span> &lt;&lt; <span class="number">0</span>;</span><br><span class="line"></span><br><span class="line"><span class="meta">@SystemApi</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="keyword">int</span> FLAG_PERMISSION_USER_FIXED =  <span class="number">1</span> &lt;&lt; <span class="number">1</span>;</span><br><span class="line"></span><br><span class="line"><span class="meta">@SystemApi</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="keyword">int</span> FLAG_PERMISSION_POLICY_FIXED =  <span class="number">1</span> &lt;&lt; <span class="number">2</span>;</span><br><span class="line"></span><br><span class="line"><span class="meta">@SystemApi</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="keyword">int</span> FLAG_PERMISSION_REVOKE_ON_UPGRADE =  <span class="number">1</span> &lt;&lt; <span class="number">3</span>;</span><br><span class="line"></span><br><span class="line"><span class="meta">@SystemApi</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="keyword">int</span> FLAG_PERMISSION_SYSTEM_FIXED =  <span class="number">1</span> &lt;&lt; <span class="number">4</span>;</span><br><span class="line"></span><br><span class="line"><span class="meta">@SystemApi</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="keyword">int</span> FLAG_PERMISSION_GRANTED_BY_DEFAULT =  <span class="number">1</span> &lt;&lt; <span class="number">5</span>;</span><br><span class="line"></span><br><span class="line"><span class="meta">@SystemApi</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="keyword">int</span> FLAG_PERMISSION_REVIEW_REQUIRED =  <span class="number">1</span> &lt;&lt; <span class="number">6</span>;</span><br></pre></td></tr></table></figure>
<p>这里简单的解释下这个这些 flags 的作用！</p>
<h3 id="8-1-2-解析-“permissions”-“permission-trees”-标签"><a href="#8-1-2-解析-“permissions”-“permission-trees”-标签" class="headerlink" title="8.1.2 解析 “permissions” “permission-trees” 标签"></a>8.1.2 解析 “permissions” “permission-trees” 标签</h3><p>我们先来看看 “permissions” 标签的内容，可以看到该标签的内容是：权限和定义权限的包名<br><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">permissions</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">item</span> <span class="attr">name</span>=<span class="string">"android.permission.REAL_GET_TASKS"</span> <span class="attr">package</span>=<span class="string">"android"</span> <span class="attr">protection</span>=<span class="string">"18"</span> /&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">item</span> <span class="attr">name</span>=<span class="string">"android.permission.SEND_RECEIVE_STK_INTENT"</span> <span class="attr">package</span>=<span class="string">"com.android.stk"</span> <span class="attr">protection</span>=<span class="string">"2"</span> /&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">item</span> <span class="attr">name</span>=<span class="string">"android.permission.ACCESS_CACHE_FILESYSTEM"</span> <span class="attr">package</span>=<span class="string">"android"</span> <span class="attr">protection</span>=<span class="string">"18"</span> /&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">item</span> <span class="attr">name</span>=<span class="string">"android.permission.REMOTE_AUDIO_PLAYBACK"</span> <span class="attr">package</span>=<span class="string">"android"</span> <span class="attr">protection</span>=<span class="string">"2"</span> /&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">item</span> <span class="attr">name</span>=<span class="string">"android.permission.DOWNLOAD_WITHOUT_NOTIFICATION"</span> <span class="attr">package</span>=<span class="string">"com.android.providers.downloads"</span> /&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">item</span> <span class="attr">name</span>=<span class="string">"android.permission.REGISTER_WINDOW_MANAGER_LISTENERS"</span> <span class="attr">package</span>=<span class="string">"android"</span> <span class="attr">protection</span>=<span class="string">"2"</span> /&gt;</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">&lt;!----&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">permissions</span>&gt;</span></span><br></pre></td></tr></table></figure></p>
<p>下面是具体的解析过程，<strong>注意 “permissions” 的内容是最先解析的</strong>！</p>
<p>对于 “permission-trees” 和 “permissions” 解析的方法都是 readPermissionsLPw，但是 permissions 的解析结果，会保存到 mPermissions 中，而 permission-trees 的解析结果，会保存到 mPermissionTrees 中；</p>
<h4 id="8-1-2-1-Settings-readPermissionsLPw"><a href="#8-1-2-1-Settings-readPermissionsLPw" class="headerlink" title="8.1.2.1 Settings.readPermissionsLPw"></a>8.1.2.1 Settings.readPermissionsLPw</h4><p>这里的 ArrayMap&lt;String, BasePermission&gt; out 分别是 Settings.permissions 和 Settings.mPermissionTrees：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">final</span> ArrayMap&lt;String, BasePermission&gt; mPermissions = <span class="keyword">new</span> ArrayMap&lt;String, BasePermission&gt;();</span><br><span class="line"><span class="keyword">final</span> ArrayMap&lt;String, BasePermission&gt; mPermissionTrees = <span class="keyword">new</span> ArrayMap&lt;String, BasePermission&gt;();</span><br></pre></td></tr></table></figure>
<p>下面我们来看看 readPermissionsLPw 方法的逻辑：<br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">readPermissionsLPw</span><span class="params">(ArrayMap&lt;String, BasePermission&gt; out, XmlPullParser parser)</span></span></span><br><span class="line"><span class="function">        <span class="keyword">throws</span> IOException, XmlPullParserException </span>&#123;</span><br><span class="line">    <span class="keyword">int</span> outerDepth = parser.getDepth();</span><br><span class="line">    <span class="keyword">int</span> type;</span><br><span class="line">    <span class="keyword">while</span> ((type = parser.next()) != XmlPullParser.END_DOCUMENT</span><br><span class="line">            &amp;&amp; (type != XmlPullParser.END_TAG || parser.getDepth() &gt; outerDepth)) &#123;</span><br><span class="line">        <span class="keyword">if</span> (type == XmlPullParser.END_TAG || type == XmlPullParser.TEXT) &#123;</span><br><span class="line">            <span class="keyword">continue</span>;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">final</span> String tagName = parser.getName();</span><br><span class="line">        <span class="keyword">if</span> (tagName.equals(TAG_ITEM)) &#123; <span class="comment">// 解析 item 标签</span></span><br><span class="line">            <span class="keyword">final</span> String name = parser.getAttributeValue(<span class="keyword">null</span>, ATTR_NAME); <span class="comment">// 获得 permission 的名称！</span></span><br><span class="line">            <span class="keyword">final</span> String sourcePackage = parser.getAttributeValue(<span class="keyword">null</span>, <span class="string">"package"</span>); <span class="comment">// 获得定义 permission 包名!</span></span><br><span class="line">            <span class="keyword">final</span> String ptype = parser.getAttributeValue(<span class="keyword">null</span>, <span class="string">"type"</span>); <span class="comment">// 解析 type 类型！</span></span><br><span class="line">            </span><br><span class="line">            <span class="keyword">if</span> (name != <span class="keyword">null</span> &amp;&amp; sourcePackage != <span class="keyword">null</span>) &#123;</span><br><span class="line">                <span class="keyword">final</span> <span class="keyword">boolean</span> dynamic = <span class="string">"dynamic"</span>.equals(ptype);</span><br><span class="line">                <span class="comment">//【1】尝试从 Settings 对应集合中获得权限 bp！</span></span><br><span class="line">                BasePermission bp = out.get(name);</span><br><span class="line"></span><br><span class="line">                <span class="comment">//【2】如果 bp 为 null 或者</span></span><br><span class="line">                <span class="comment">// bp 不为 null 且其类型不是 BasePermission.TYPE_BUILTIN，就创建一个新的！</span></span><br><span class="line">                <span class="comment">// BasePermission.TYPE_BUILTIN 类型的权限是系统权限，前面已经解析过！</span></span><br><span class="line">                <span class="comment">// BasePermission.TYPE_DYNAMIC 类型是针对于权限树的类型的！</span></span><br><span class="line">                <span class="keyword">if</span> (bp == <span class="keyword">null</span> || bp.type != BasePermission.TYPE_BUILTIN) &#123;</span><br><span class="line">                    bp = <span class="keyword">new</span> BasePermission(name.intern(), sourcePackage,</span><br><span class="line">                            dynamic ? BasePermission.TYPE_DYNAMIC : BasePermission.TYPE_NORMAL);</span><br><span class="line">                &#125;</span><br><span class="line"></span><br><span class="line">                <span class="comment">//【3】获得定义 permission 的级别，默认为 PROTECTION_NORMAL，然后对保护级别修正! </span></span><br><span class="line">                bp.protectionLevel = readInt(parser, <span class="keyword">null</span>, <span class="string">"protection"</span>, PermissionInfo.PROTECTION_NORMAL);</span><br><span class="line">                bp.protectionLevel = PermissionInfo.fixProtectionLevel(bp.protectionLevel);</span><br><span class="line"></span><br><span class="line">                <span class="keyword">if</span> (dynamic) &#123; </span><br><span class="line">                    <span class="comment">//【3.1】如果是动态权限，进一步处理，动态权限会封装为 PermissionInfo！</span></span><br><span class="line">                    <span class="comment">// 动态权限是可以动态添加和移除的权限！通过权限树指定！</span></span><br><span class="line">                    PermissionInfo pi = <span class="keyword">new</span> PermissionInfo();</span><br><span class="line">                    pi.packageName = sourcePackage.intern();</span><br><span class="line">                    pi.name = name.intern();</span><br><span class="line">                    pi.icon = readInt(parser, <span class="keyword">null</span>, <span class="string">"icon"</span>, <span class="number">0</span>);</span><br><span class="line">                    pi.nonLocalizedLabel = parser.getAttributeValue(<span class="keyword">null</span>, <span class="string">"label"</span>);</span><br><span class="line">                    pi.protectionLevel = bp.protectionLevel;</span><br><span class="line">                    bp.pendingInfo = pi;</span><br><span class="line">                &#125;</span><br><span class="line">                </span><br><span class="line">                <span class="comment">//【4】封装成 BasePermission 保存到 mPermissions 集合中!</span></span><br><span class="line">                out.put(bp.name, bp);</span><br><span class="line">            &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                ... ... ... ...</span><br><span class="line">            &#125;</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            ... ... ... ...</span><br><span class="line">        &#125;</span><br><span class="line">        XmlUtils.skipCurrentTag(parser);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>所有的非动态权限信息最终都会被解析保存到 Setting.mPermissions 中了！！</p>
<p>而动态权限信息会被保存在 Setting.mPermissionTrees 中了！！</p>
<h3 id="8-1-3-解析-“shared-user”-标签"><a href="#8-1-3-解析-“shared-user”-标签" class="headerlink" title="8.1.3 解析 “shared-user” 标签"></a>8.1.3 解析 “shared-user” 标签</h3><p>共享用户相关数据如下：<br><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">shared-user</span> <span class="attr">name</span>=<span class="string">"android.media"</span> <span class="attr">userId</span>=<span class="string">"10014"</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">sigs</span> <span class="attr">count</span>=<span class="string">"1"</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">cert</span> <span class="attr">index</span>=<span class="string">"3"</span> /&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">sigs</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">perms</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">item</span> <span class="attr">name</span>=<span class="string">"android.permission.WRITE_SETTINGS"</span> <span class="attr">granted</span>=<span class="string">"true"</span> <span class="attr">flags</span>=<span class="string">"0"</span> /&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">item</span> <span class="attr">name</span>=<span class="string">"android.permission.RECEIVE_BOOT_COMPLETED"</span> <span class="attr">granted</span>=<span class="string">"true"</span> <span class="attr">flags</span>=<span class="string">"0"</span> /&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">item</span> <span class="attr">name</span>=<span class="string">"android.permission.WRITE_MEDIA_STORAGE"</span> <span class="attr">granted</span>=<span class="string">"true"</span> <span class="attr">flags</span>=<span class="string">"0"</span> /&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">item</span> <span class="attr">name</span>=<span class="string">"android.permission.INTERNET"</span> <span class="attr">granted</span>=<span class="string">"true"</span> <span class="attr">flags</span>=<span class="string">"0"</span> /&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">item</span> <span class="attr">name</span>=<span class="string">"android.permission.MANAGE_USB"</span> <span class="attr">granted</span>=<span class="string">"true"</span> <span class="attr">flags</span>=<span class="string">"0"</span> /&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">item</span> <span class="attr">name</span>=<span class="string">"android.permission.MANAGE_USERS"</span> <span class="attr">granted</span>=<span class="string">"true"</span> <span class="attr">flags</span>=<span class="string">"0"</span> /&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">item</span> <span class="attr">name</span>=<span class="string">"android.permission.ACCESS_NETWORK_STATE"</span> <span class="attr">granted</span>=<span class="string">"true"</span> <span class="attr">flags</span>=<span class="string">"0"</span> /&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">item</span> <span class="attr">name</span>=<span class="string">"android.permission.ACCESS_MTP"</span> <span class="attr">granted</span>=<span class="string">"true"</span> <span class="attr">flags</span>=<span class="string">"0"</span> /&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">item</span> <span class="attr">name</span>=<span class="string">"android.permission.READ_LOGS"</span> <span class="attr">granted</span>=<span class="string">"true"</span> <span class="attr">flags</span>=<span class="string">"0"</span> /&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">item</span> <span class="attr">name</span>=<span class="string">"android.permission.INTERACT_ACROSS_USERS"</span> <span class="attr">granted</span>=<span class="string">"true"</span> <span class="attr">flags</span>=<span class="string">"0"</span> /&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">item</span> <span class="attr">name</span>=<span class="string">"android.permission.ACCESS_WIFI_STATE"</span> <span class="attr">granted</span>=<span class="string">"true"</span> <span class="attr">flags</span>=<span class="string">"0"</span> /&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">item</span> <span class="attr">name</span>=<span class="string">"oppo.permission.OPPO_COMPONENT_SAFE"</span> <span class="attr">granted</span>=<span class="string">"true"</span> <span class="attr">flags</span>=<span class="string">"0"</span> /&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">item</span> <span class="attr">name</span>=<span class="string">"android.permission.WAKE_LOCK"</span> <span class="attr">granted</span>=<span class="string">"true"</span> <span class="attr">flags</span>=<span class="string">"0"</span> /&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">perms</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">shared-user</span>&gt;</span></span><br></pre></td></tr></table></figure></p>
<h4 id="8-1-3-1-Settings-readSharedUserLPw"><a href="#8-1-3-1-Settings-readSharedUserLPw" class="headerlink" title="8.1.3.1 Settings.readSharedUserLPw"></a>8.1.3.1 Settings.readSharedUserLPw</h4><p>解析系统定义的共享用户 id：<br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">readSharedUserLPw</span><span class="params">(XmlPullParser parser)</span> <span class="keyword">throws</span> XmlPullParserException,IOException </span>&#123;</span><br><span class="line">    String name = <span class="keyword">null</span>;</span><br><span class="line">    String idStr = <span class="keyword">null</span>;</span><br><span class="line">    <span class="keyword">int</span> pkgFlags = <span class="number">0</span>;</span><br><span class="line">    <span class="keyword">int</span> pkgPrivateFlags = <span class="number">0</span>;</span><br><span class="line">    SharedUserSetting su = <span class="keyword">null</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">        name = parser.getAttributeValue(<span class="keyword">null</span>, ATTR_NAME); <span class="comment">// 获得共享用户的名称</span></span><br><span class="line">        idStr = parser.getAttributeValue(<span class="keyword">null</span>, <span class="string">"userId"</span>);  <span class="comment">// 获得共享用户的id</span></span><br><span class="line">        <span class="keyword">int</span> userId = idStr != <span class="keyword">null</span> ? Integer.parseInt(idStr) : <span class="number">0</span>;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (<span class="string">"true"</span>.equals(parser.getAttributeValue(<span class="keyword">null</span>, <span class="string">"system"</span>))) &#123; <span class="comment">// 是否是系统的用户 id！</span></span><br><span class="line">            pkgFlags |= ApplicationInfo.FLAG_SYSTEM;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (name == <span class="keyword">null</span>) &#123;</span><br><span class="line">            PackageManagerService.reportSettingsProblem(Log.WARN,</span><br><span class="line">                    <span class="string">"Error in package manager settings: &lt;shared-user&gt; has no name at "</span></span><br><span class="line">                            + parser.getPositionDescription());</span><br><span class="line">        &#125; <span class="keyword">else</span> <span class="keyword">if</span> (userId == <span class="number">0</span>) &#123;</span><br><span class="line">            PackageManagerService.reportSettingsProblem(Log.WARN,</span><br><span class="line">                    <span class="string">"Error in package manager settings: shared-user "</span> + name</span><br><span class="line">                            + <span class="string">" has bad userId "</span> + idStr + <span class="string">" at "</span></span><br><span class="line">                            + parser.getPositionDescription());</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line"></span><br><span class="line">            <span class="comment">//【8.1.3.2】调用 addSharedUserLPw 方法，将这个共享用户和对应的 uid 保存下来！</span></span><br><span class="line">            <span class="keyword">if</span> ((su = addSharedUserLPw(name.intern(), userId, pkgFlags, pkgPrivateFlags))</span><br><span class="line">                    == <span class="keyword">null</span>) &#123;</span><br><span class="line">                PackageManagerService</span><br><span class="line">                        .reportSettingsProblem(Log.ERROR, <span class="string">"Occurred while parsing settings at "</span></span><br><span class="line">                                + parser.getPositionDescription());</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125; <span class="keyword">catch</span> (NumberFormatException e) &#123;</span><br><span class="line">        PackageManagerService.reportSettingsProblem(Log.WARN,</span><br><span class="line">                <span class="string">"Error in package manager settings: package "</span> + name + <span class="string">" has bad userId "</span></span><br><span class="line">                        + idStr + <span class="string">" at "</span> + parser.getPositionDescription());</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (su != <span class="keyword">null</span>) &#123; <span class="comment">// 解析子标签！</span></span><br><span class="line">        <span class="keyword">int</span> outerDepth = parser.getDepth();</span><br><span class="line">        <span class="keyword">int</span> type;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">while</span> ((type = parser.next()) != XmlPullParser.END_DOCUMENT</span><br><span class="line">                &amp;&amp; (type != XmlPullParser.END_TAG || parser.getDepth() &gt; outerDepth)) &#123;</span><br><span class="line">            <span class="keyword">if</span> (type == XmlPullParser.END_TAG || type == XmlPullParser.TEXT) &#123;</span><br><span class="line">                <span class="keyword">continue</span>;</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            String tagName = parser.getName();</span><br><span class="line">            <span class="keyword">if</span> (tagName.equals(<span class="string">"sigs"</span>)) &#123;</span><br><span class="line">                su.signatures.readXml(parser, mPastSignatures);</span><br><span class="line">                </span><br><span class="line">            &#125; <span class="keyword">else</span> <span class="keyword">if</span> (tagName.equals(<span class="string">"perms"</span>)) &#123; <span class="comment">// 解析 "perms" 标签</span></span><br><span class="line">                <span class="comment">//【8.1.1.3.1】解析共享用户的权限信息！</span></span><br><span class="line">                readInstallPermissionsLPr(parser, su.getPermissionsState());</span><br><span class="line">                </span><br><span class="line">            &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                PackageManagerService.reportSettingsProblem(Log.WARN,</span><br><span class="line">                        <span class="string">"Unknown element under &lt;shared-user&gt;: "</span> + parser.getName());</span><br><span class="line">                XmlUtils.skipCurrentTag(parser);</span><br><span class="line"></span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        XmlUtils.skipCurrentTag(parser);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<h4 id="8-1-3-2-Settings-addSharedUserLPw"><a href="#8-1-3-2-Settings-addSharedUserLPw" class="headerlink" title="8.1.3.2 Settings.addSharedUserLPw"></a>8.1.3.2 Settings.addSharedUserLPw</h4><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="function">SharedUserSetting <span class="title">addSharedUserLPw</span><span class="params">(String name, <span class="keyword">int</span> uid, <span class="keyword">int</span> pkgFlags, <span class="keyword">int</span> pkgPrivateFlags)</span> </span>&#123;</span><br><span class="line">    <span class="comment">// 创建共享用户对应的 SharedUserSetting 对象！</span></span><br><span class="line">    SharedUserSetting s = mSharedUsers.get(name);</span><br><span class="line">    <span class="keyword">if</span> (s != <span class="keyword">null</span>) &#123;</span><br><span class="line">        <span class="keyword">if</span> (s.userId == uid) &#123;</span><br><span class="line">            <span class="keyword">return</span> s;</span><br><span class="line">        &#125;</span><br><span class="line">        PackageManagerService.reportSettingsProblem(Log.ERROR,</span><br><span class="line">                <span class="string">"Adding duplicate shared user, keeping first: "</span> + name);</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">null</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    s = <span class="keyword">new</span> SharedUserSetting(name, pkgFlags, pkgPrivateFlags);</span><br><span class="line">    s.userId = uid;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">//【8.1.1.2.1】根据 uid 的范围，保存到 mUsersId 和 mOthersId 中！</span></span><br><span class="line">    <span class="keyword">if</span> (addUserIdLPw(uid, s, name)) &#123;</span><br><span class="line">        <span class="comment">// 将其添加到 mSharedUsers 集合中！</span></span><br><span class="line">        mSharedUsers.put(name, s);</span><br><span class="line">        <span class="keyword">return</span> s;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">null</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>流程总结：</p>
<ul>
<li>解析 “shared-user” ，将其分装成 SharedUserSetting 对象，保存到 mSharedUsers，并根据 uid 的取值将其保存到 mUserIds 或者 mOtherIds 中！</li>
<li>解析 “shared-user” 子标签 “perm” 等等，解析共享用户的权限，每个权限对应一个 PermissionData 对象，保存进入 PermisssionState 中，用于管理共享用户的权限！</li>
</ul>
<h3 id="8-1-4-解析-“preferred-activities”-相关标签"><a href="#8-1-4-解析-“preferred-activities”-相关标签" class="headerlink" title="8.1.4 解析 “preferred-activities” 相关标签"></a>8.1.4 解析 “preferred-activities” 相关标签</h3><h4 id="8-1-4-1-Settings-readPreferredActivitiesLPw"><a href="#8-1-4-1-Settings-readPreferredActivitiesLPw" class="headerlink" title="8.1.4.1 Settings.readPreferredActivitiesLPw"></a>8.1.4.1 Settings.readPreferredActivitiesLPw</h4><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">readPreferredActivitiesLPw</span><span class="params">(XmlPullParser parser, <span class="keyword">int</span> userId)</span></span></span><br><span class="line"><span class="function">        <span class="keyword">throws</span> XmlPullParserException, IOException </span>&#123;</span><br><span class="line">    <span class="keyword">int</span> outerDepth = parser.getDepth();</span><br><span class="line">    <span class="keyword">int</span> type;</span><br><span class="line">    <span class="keyword">while</span> ((type = parser.next()) != XmlPullParser.END_DOCUMENT</span><br><span class="line">            &amp;&amp; (type != XmlPullParser.END_TAG || parser.getDepth() &gt; outerDepth)) &#123;</span><br><span class="line">        <span class="keyword">if</span> (type == XmlPullParser.END_TAG || type == XmlPullParser.TEXT) &#123;</span><br><span class="line">            <span class="keyword">continue</span>;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        String tagName = parser.getName();</span><br><span class="line">        <span class="keyword">if</span> (tagName.equals(TAG_ITEM)) &#123;</span><br><span class="line">        </span><br><span class="line">            <span class="comment">// 创建 PreferredActivity 对象！</span></span><br><span class="line">            PreferredActivity pa = <span class="keyword">new</span> PreferredActivity(parser);</span><br><span class="line">            <span class="keyword">if</span> (pa.mPref.getParseError() == <span class="keyword">null</span>) &#123;</span><br><span class="line">                editPreferredActivitiesLPw(userId).addFilter(pa);</span><br><span class="line">            &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                PackageManagerService.reportSettingsProblem(Log.WARN,</span><br><span class="line">                        <span class="string">"Error in package manager settings: &lt;preferred-activity&gt; "</span></span><br><span class="line">                                + pa.mPref.getParseError() + <span class="string">" at "</span></span><br><span class="line">                                + parser.getPositionDescription());</span><br><span class="line">            &#125;</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            PackageManagerService.reportSettingsProblem(Log.WARN,</span><br><span class="line">                    <span class="string">"Unknown element under &lt;preferred-activities&gt;: "</span> + parser.getName());</span><br><span class="line">            XmlUtils.skipCurrentTag(parser);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h4 id="8-1-4-2-Settings-readPersistentPreferredActivitiesLPw"><a href="#8-1-4-2-Settings-readPersistentPreferredActivitiesLPw" class="headerlink" title="8.1.4.2 Settings.readPersistentPreferredActivitiesLPw"></a>8.1.4.2 Settings.readPersistentPreferredActivitiesLPw</h4><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line">   <span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">readPersistentPreferredActivitiesLPw</span><span class="params">(XmlPullParser parser, <span class="keyword">int</span> userId)</span></span></span><br><span class="line"><span class="function">        <span class="keyword">throws</span> XmlPullParserException, IOException </span>&#123;</span><br><span class="line">    <span class="keyword">int</span> outerDepth = parser.getDepth();</span><br><span class="line">    <span class="keyword">int</span> type;</span><br><span class="line">    <span class="keyword">while</span> ((type = parser.next()) != XmlPullParser.END_DOCUMENT</span><br><span class="line">            &amp;&amp; (type != XmlPullParser.END_TAG || parser.getDepth() &gt; outerDepth)) &#123;</span><br><span class="line">        <span class="keyword">if</span> (type == XmlPullParser.END_TAG || type == XmlPullParser.TEXT) &#123;</span><br><span class="line">            <span class="keyword">continue</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        String tagName = parser.getName();</span><br><span class="line">        <span class="keyword">if</span> (tagName.equals(TAG_ITEM)) &#123;</span><br><span class="line">        </span><br><span class="line">            <span class="comment">//【1】创建 PersistentPreferredActivity 对象！</span></span><br><span class="line">            PersistentPreferredActivity ppa = <span class="keyword">new</span> PersistentPreferredActivity(parser);</span><br><span class="line">            editPersistentPreferredActivitiesLPw(userId).addFilter(ppa);</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            PackageManagerService.reportSettingsProblem(Log.WARN,</span><br><span class="line">                    <span class="string">"Unknown element under &lt;"</span> + TAG_PERSISTENT_PREFERRED_ACTIVITIES + <span class="string">"&gt;: "</span></span><br><span class="line">                    + parser.getName());</span><br><span class="line">            XmlUtils.skipCurrentTag(parser);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>不多说了！！</p>
<h3 id="8-1-5-解析-“updated-package”-标签"><a href="#8-1-5-解析-“updated-package”-标签" class="headerlink" title="8.1.5 解析 “updated-package” 标签"></a>8.1.5 解析 “updated-package” 标签</h3><p>我们来看看这个标签的内容，进行对比：<br><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">package</span> <span class="attr">name</span>=<span class="string">"com.android.xxxx"</span> </span></span><br><span class="line"><span class="tag">         <span class="attr">codePath</span>=<span class="string">"/data/app/com.android.xxxx-1"</span> </span></span><br><span class="line"><span class="tag">         <span class="attr">nativeLibraryPath</span>=<span class="string">"/data/app/com.android.xxxx-2/lib"</span> </span></span><br><span class="line"><span class="tag">         <span class="attr">publicFlags</span>=<span class="string">"944258757"</span> </span></span><br><span class="line"><span class="tag">         <span class="attr">privateFlags</span>=<span class="string">"0"</span> </span></span><br><span class="line"><span class="tag">         <span class="attr">ft</span>=<span class="string">"15920cea638"</span> <span class="attr">it</span>=<span class="string">"15920cea638"</span> <span class="attr">ut</span>=<span class="string">"15920cea638"</span> <span class="attr">version</span>=<span class="string">"1000"</span> <span class="attr">userId</span>=<span class="string">"10053"</span>  </span></span><br><span class="line"><span class="tag">         <span class="attr">installer</span>=<span class="string">"com.android.packageinstaller"</span>&gt;</span></span><br><span class="line">         <span class="tag">&lt;<span class="name">perms</span>&gt;</span></span><br><span class="line">            <span class="comment">&lt;!----&gt;</span></span><br><span class="line">         <span class="tag">&lt;/<span class="name">perms</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">package</span>&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="tag">&lt;<span class="name">updated-package</span> <span class="attr">name</span>=<span class="string">"com.android.xxxx"</span> </span></span><br><span class="line"><span class="tag">         <span class="attr">codePath</span>=<span class="string">"/data/app/com.android.xxxx-1"</span> </span></span><br><span class="line"><span class="tag">         <span class="attr">ft</span>=<span class="string">"158ff005268"</span> <span class="attr">it</span>=<span class="string">"158ff005268"</span> <span class="attr">ut</span>=<span class="string">"158ff005268"</span> <span class="attr">version</span>=<span class="string">"845"</span>         </span></span><br><span class="line"><span class="tag">         <span class="attr">nativeLibraryPath</span>=<span class="string">"/data/app/com.android.xxxx-1/lib"</span> <span class="attr">userId</span>=<span class="string">"10053"</span>&gt;</span></span><br><span class="line">         <span class="tag">&lt;<span class="name">perms</span>&gt;</span></span><br><span class="line">            <span class="comment">&lt;!----&gt;</span></span><br><span class="line">         <span class="tag">&lt;/<span class="name">perms</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">updated-package</span>&gt;</span></span><br></pre></td></tr></table></figure></p>
<p>接下里，我们去看看解析过程：</p>
<h4 id="8-1-5-1-Settings-readDisabledSysPackageLPw"><a href="#8-1-5-1-Settings-readDisabledSysPackageLPw" class="headerlink" title="8.1.5.1 Settings.readDisabledSysPackageLPw"></a>8.1.5.1 Settings.readDisabledSysPackageLPw</h4><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">readDisabledSysPackageLPw</span><span class="params">(XmlPullParser parser)</span> <span class="keyword">throws</span> XmlPullParserException,</span></span><br><span class="line"><span class="function">        IOException </span>&#123;</span><br><span class="line">    String name = parser.getAttributeValue(<span class="keyword">null</span>, ATTR_NAME);</span><br><span class="line">    String realName = parser.getAttributeValue(<span class="keyword">null</span>, <span class="string">"realName"</span>);</span><br><span class="line">    String codePathStr = parser.getAttributeValue(<span class="keyword">null</span>, <span class="string">"codePath"</span>);</span><br><span class="line">    String resourcePathStr = parser.getAttributeValue(<span class="keyword">null</span>, <span class="string">"resourcePath"</span>);</span><br><span class="line"></span><br><span class="line">    String legacyCpuAbiStr = parser.getAttributeValue(<span class="keyword">null</span>, <span class="string">"requiredCpuAbi"</span>);</span><br><span class="line">    String legacyNativeLibraryPathStr = parser.getAttributeValue(<span class="keyword">null</span>, <span class="string">"nativeLibraryPath"</span>);</span><br><span class="line"></span><br><span class="line">    String parentPackageName = parser.getAttributeValue(<span class="keyword">null</span>, <span class="string">"parentPackageName"</span>);</span><br><span class="line"></span><br><span class="line">    String primaryCpuAbiStr = parser.getAttributeValue(<span class="keyword">null</span>, <span class="string">"primaryCpuAbi"</span>);</span><br><span class="line">    String secondaryCpuAbiStr = parser.getAttributeValue(<span class="keyword">null</span>, <span class="string">"secondaryCpuAbi"</span>);</span><br><span class="line">    String cpuAbiOverrideStr = parser.getAttributeValue(<span class="keyword">null</span>, <span class="string">"cpuAbiOverride"</span>);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (primaryCpuAbiStr == <span class="keyword">null</span> &amp;&amp; legacyCpuAbiStr != <span class="keyword">null</span>) &#123;</span><br><span class="line">        primaryCpuAbiStr = legacyCpuAbiStr;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (resourcePathStr == <span class="keyword">null</span>) &#123;</span><br><span class="line">        resourcePathStr = codePathStr;</span><br><span class="line">    &#125;</span><br><span class="line">    String version = parser.getAttributeValue(<span class="keyword">null</span>, <span class="string">"version"</span>);</span><br><span class="line">    <span class="keyword">int</span> versionCode = <span class="number">0</span>;</span><br><span class="line">    <span class="keyword">if</span> (version != <span class="keyword">null</span>) &#123;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            versionCode = Integer.parseInt(version);</span><br><span class="line">        &#125; <span class="keyword">catch</span> (NumberFormatException e) &#123;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">int</span> pkgFlags = <span class="number">0</span>;</span><br><span class="line">    <span class="keyword">int</span> pkgPrivateFlags = <span class="number">0</span>;</span><br><span class="line">    pkgFlags |= ApplicationInfo.FLAG_SYSTEM;</span><br><span class="line">    <span class="keyword">final</span> File codePathFile = <span class="keyword">new</span> File(codePathStr);</span><br><span class="line">    <span class="keyword">if</span> (PackageManagerService.locationIsPrivileged(codePathFile)) &#123;</span><br><span class="line">        pkgPrivateFlags |= ApplicationInfo.PRIVATE_FLAG_PRIVILEGED;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// 封装成 PackageSetting 对象</span></span><br><span class="line">    PackageSetting ps = <span class="keyword">new</span> PackageSetting(name, realName, codePathFile,</span><br><span class="line">            <span class="keyword">new</span> File(resourcePathStr), legacyNativeLibraryPathStr, primaryCpuAbiStr,</span><br><span class="line">            secondaryCpuAbiStr, cpuAbiOverrideStr, versionCode, pkgFlags, pkgPrivateFlags,</span><br><span class="line">            parentPackageName, <span class="keyword">null</span>);</span><br><span class="line">            </span><br><span class="line">    <span class="comment">// 获得时间戳，第一次安装时间，最后一次更新时间，省略！</span></span><br><span class="line">    ... ... ... ...</span><br><span class="line"> </span><br><span class="line">    <span class="comment">// 处理其独立 uid 或者共享 uid 信息！</span></span><br><span class="line">    String idStr = parser.getAttributeValue(<span class="keyword">null</span>, <span class="string">"userId"</span>);</span><br><span class="line">    ps.appId = idStr != <span class="keyword">null</span> ? Integer.parseInt(idStr) : <span class="number">0</span>;</span><br><span class="line">    <span class="keyword">if</span> (ps.appId &lt;= <span class="number">0</span>) &#123;</span><br><span class="line">        String sharedIdStr = parser.getAttributeValue(<span class="keyword">null</span>, <span class="string">"sharedUserId"</span>);</span><br><span class="line">        ps.appId = sharedIdStr != <span class="keyword">null</span> ? Integer.parseInt(sharedIdStr) : <span class="number">0</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">int</span> outerDepth = parser.getDepth();</span><br><span class="line">    <span class="keyword">int</span> type;</span><br><span class="line">    <span class="keyword">while</span> ((type = parser.next()) != XmlPullParser.END_DOCUMENT</span><br><span class="line">            &amp;&amp; (type != XmlPullParser.END_TAG || parser.getDepth() &gt; outerDepth)) &#123;</span><br><span class="line">        <span class="keyword">if</span> (type == XmlPullParser.END_TAG || type == XmlPullParser.TEXT) &#123;</span><br><span class="line">            <span class="keyword">continue</span>;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (parser.getName().equals(TAG_PERMISSIONS)) &#123; <span class="comment">// 解析 "perms" 标签！</span></span><br><span class="line">            <span class="comment">// ps.getPermissionsState() 是 package 的权限管理对象！</span></span><br><span class="line">            readInstallPermissionsLPr(parser, ps.getPermissionsState());</span><br><span class="line">            </span><br><span class="line">        &#125; <span class="keyword">else</span> <span class="keyword">if</span> (parser.getName().equals(TAG_CHILD_PACKAGE)) &#123;</span><br><span class="line">            String childPackageName = parser.getAttributeValue(<span class="keyword">null</span>, ATTR_NAME);</span><br><span class="line">            <span class="keyword">if</span> (ps.childPackageNames == <span class="keyword">null</span>) &#123;</span><br><span class="line">                ps.childPackageNames = <span class="keyword">new</span> ArrayList&lt;&gt;();</span><br><span class="line">            &#125;</span><br><span class="line">            ps.childPackageNames.add(childPackageName);</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            PackageManagerService.reportSettingsProblem(Log.WARN,</span><br><span class="line">                    <span class="string">"Unknown element under &lt;updated-package&gt;: "</span> + parser.getName());</span><br><span class="line">            XmlUtils.skipCurrentTag(parser);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">//【1】保存到 mDisabledSysPackages 中！</span></span><br><span class="line">    mDisabledSysPackages.put(name, ps);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h3 id="8-1-6-解析-“cleaning-package”-标签"><a href="#8-1-6-解析-“cleaning-package”-标签" class="headerlink" title="8.1.6 解析 “cleaning-package” 标签"></a>8.1.6 解析 “cleaning-package” 标签</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line">&#125; <span class="keyword">else</span> <span class="keyword">if</span> (tagName.equals(<span class="string">"cleaning-package"</span>)) &#123;</span><br><span class="line">    String name = parser.getAttributeValue(<span class="keyword">null</span>, ATTR_NAME);</span><br><span class="line">    String userStr = parser.getAttributeValue(<span class="keyword">null</span>, ATTR_USER);</span><br><span class="line">    String codeStr = parser.getAttributeValue(<span class="keyword">null</span>, ATTR_CODE);</span><br><span class="line">    <span class="keyword">if</span> (name != <span class="keyword">null</span>) &#123;</span><br><span class="line">        <span class="keyword">int</span> userId = UserHandle.USER_SYSTEM;</span><br><span class="line">        <span class="keyword">boolean</span> andCode = <span class="keyword">true</span>;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            <span class="keyword">if</span> (userStr != <span class="keyword">null</span>) &#123;</span><br><span class="line">                userId = Integer.parseInt(userStr);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125; <span class="keyword">catch</span> (NumberFormatException e) &#123;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">if</span> (codeStr != <span class="keyword">null</span>) &#123;</span><br><span class="line">            andCode = Boolean.parseBoolean(codeStr);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">// 创建一个 PackageCleanItem 对象！</span></span><br><span class="line">        addPackageToCleanLPw(<span class="keyword">new</span> PackageCleanItem(userId, name, andCode));</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>调用 addPackageToCleanLPw 方法；<br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">addPackageToCleanLPw</span><span class="params">(PackageCleanItem pkg)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">if</span> (!mPackagesToBeCleaned.contains(pkg)) &#123;</span><br><span class="line">        </span><br><span class="line">        <span class="comment">//【1】添加到 mPackagesToBeCleaned！</span></span><br><span class="line">        mPackagesToBeCleaned.add(pkg);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>这个方法很简单！</p>
<h3 id="8-1-7-解析-“renamed-package”-标签"><a href="#8-1-7-解析-“renamed-package”-标签" class="headerlink" title="8.1.7 解析 “renamed-package” 标签"></a>8.1.7 解析 “renamed-package” 标签</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">else</span> <span class="keyword">if</span> (tagName.equals(<span class="string">"renamed-package"</span>)) &#123;</span><br><span class="line">    String nname = parser.getAttributeValue(<span class="keyword">null</span>, <span class="string">"new"</span>);</span><br><span class="line">    String oname = parser.getAttributeValue(<span class="keyword">null</span>, <span class="string">"old"</span>);</span><br><span class="line">    <span class="keyword">if</span> (nname != <span class="keyword">null</span> &amp;&amp; oname != <span class="keyword">null</span>) &#123;</span><br><span class="line">        mRenamedPackages.put(nname, oname);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>代码很简单，将重新命名的应用的数据，key 为 新名字。value 为旧名字，添加到 mRenamedPackages 中！</p>
<h3 id="8-1-8-阶段总结"><a href="#8-1-8-阶段总结" class="headerlink" title="8.1.8 阶段总结"></a>8.1.8 阶段总结</h3><p>我们来用一张图总结一下，PermissionsState 和 PackageSetting，SharedUserSetting 的关系！<br>![未命名文件.png-59.5kB][3]</p>
<ul>
<li>如果 pacakge 是共享用户 id，那么所有 uid 为共享用户 id 的 package，其权限是一样的，都是共享用户的权限;</li>
<li>如果 pacakge 是独立用户 id，那么这个 package 有自己独立的权限！</li>
</ul>
<h2 id="8-2-确定共享-uid-有效性"><a href="#8-2-确定共享-uid-有效性" class="headerlink" title="8.2 确定共享 uid 有效性"></a>8.2 确定共享 uid 有效性</h2><p>主要逻辑如下：<br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//【1】对 mPendingPackages 集合中的需要验证共享用户 id 有效性的 package，进行共享用户 id 有效性的验证!</span></span><br><span class="line"><span class="keyword">final</span> <span class="keyword">int</span> N = mPendingPackages.size();</span><br><span class="line"><span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; N; i++) &#123;</span><br><span class="line">    <span class="keyword">final</span> PendingPackage pp = mPendingPackages.get(i);</span><br><span class="line"></span><br><span class="line">    <span class="comment">//【8.2.1】看 sharedId 是否能对应找到一个 ShardUserSetting 对象!</span></span><br><span class="line">    Object idObj = getUserIdLPr(pp.sharedId);</span><br><span class="line">    <span class="keyword">if</span> (idObj != <span class="keyword">null</span> &amp;&amp; idObj <span class="keyword">instanceof</span> SharedUserSetting) &#123; <span class="comment">// 能找到，说明共享用户 ID 是有效的!</span></span><br><span class="line">    </span><br><span class="line">        <span class="comment">//【8.2.2】创建 PackageSetting！</span></span><br><span class="line">        PackageSetting p = getPackageLPw(pp.name, <span class="keyword">null</span>, pp.realName,</span><br><span class="line">                (SharedUserSetting) idObj, pp.codePath, pp.resourcePath,</span><br><span class="line">                pp.legacyNativeLibraryPathString, pp.primaryCpuAbiString,</span><br><span class="line">                pp.secondaryCpuAbiString, pp.versionCode, pp.pkgFlags, pp.pkgPrivateFlags,</span><br><span class="line">                <span class="keyword">null</span>, <span class="keyword">true</span> <span class="comment">/* add */</span>, <span class="keyword">false</span> <span class="comment">/* allowInstall */</span>, pp.parentPackageName,</span><br><span class="line">                pp.childPackageNames);</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (p == <span class="keyword">null</span>) &#123;</span><br><span class="line">            PackageManagerService.reportSettingsProblem(Log.WARN,</span><br><span class="line">                    <span class="string">"Unable to create application package for "</span> + pp.name);</span><br><span class="line">            <span class="keyword">continue</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        </span><br><span class="line">        <span class="comment">// 将 PendingPackage 的其他数据拷贝到 PackageSetting 中！</span></span><br><span class="line">        p.copyFrom(pp); </span><br><span class="line"></span><br><span class="line">    &#125; <span class="keyword">else</span> <span class="keyword">if</span> (idObj != <span class="keyword">null</span>) &#123;</span><br><span class="line">        String msg = <span class="string">"Bad package setting: package "</span> + pp.name + <span class="string">" has shared uid "</span></span><br><span class="line">                + pp.sharedId + <span class="string">" that is not a shared uid\n"</span>;</span><br><span class="line">        mReadMessages.append(msg);</span><br><span class="line">        PackageManagerService.reportSettingsProblem(Log.ERROR, msg);</span><br><span class="line"></span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        String msg = <span class="string">"Bad package setting: package "</span> + pp.name + <span class="string">" has shared uid "</span></span><br><span class="line">                + pp.sharedId + <span class="string">" that is not defined\n"</span>;</span><br><span class="line">        mReadMessages.append(msg);</span><br><span class="line">        PackageManagerService.reportSettingsProblem(Log.ERROR, msg);</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line">mPendingPackages.clear(); <span class="comment">// 清空 mPendingPackages</span></span><br></pre></td></tr></table></figure></p>
<p>这里调用 getUserIdLPr 来从 mUserIds 或 mOtherUserIds 中获得一个共享用户对象！</p>
<h3 id="8-2-1-Settings-getUserIdLPr"><a href="#8-2-1-Settings-getUserIdLPr" class="headerlink" title="8.2.1 Settings.getUserIdLPr"></a>8.2.1 Settings.getUserIdLPr</h3><p>获得指定 uid 对应的 Object，可能是一个 PackageSetting 或者是 SharedUserSetting！<br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> Object <span class="title">getUserIdLPr</span><span class="params">(<span class="keyword">int</span> uid)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">if</span> (uid &gt;= Process.FIRST_APPLICATION_UID) &#123;</span><br><span class="line">        <span class="keyword">final</span> <span class="keyword">int</span> N = mUserIds.size();</span><br><span class="line">        <span class="keyword">final</span> <span class="keyword">int</span> index = uid - Process.FIRST_APPLICATION_UID;</span><br><span class="line">        <span class="keyword">return</span> index &lt; N ? mUserIds.get(index) : <span class="keyword">null</span>;</span><br><span class="line"></span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> mOtherUserIds.get(uid);</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>之前在分析解析 “shared-user” 的时候，就知道 SharedUserSetting 会被保存到这两个几个当中的，这里就不多说了！</p>
<p>接着，调用 getPackageLPw 方法来创建这个 PendingPackage 对应的 PackageSetting 对象！</p>
<h3 id="8-2-2-Settings-getPackageLPw"><a href="#8-2-2-Settings-getPackageLPw" class="headerlink" title="8.2.2 Settings.getPackageLPw"></a>8.2.2 Settings.getPackageLPw</h3><p>参数传递：</p>
<ul>
<li>PackageSetting origPackage：表示源包，传入 null；</li>
<li>SharedUserSetting sharedUser：共享 uid 对象，这里是不为 null！</li>
<li>UserHandle installUser：为 null；</li>
<li>add：true；</li>
</ul>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">private</span> PackageSetting <span class="title">getPackageLPw</span><span class="params">(String name, PackageSetting origPackage,</span></span></span><br><span class="line"><span class="function"><span class="params">        String realName, SharedUserSetting sharedUser, File codePath, File resourcePath,</span></span></span><br><span class="line"><span class="function"><span class="params">        String legacyNativeLibraryPathString, String primaryCpuAbiString,</span></span></span><br><span class="line"><span class="function"><span class="params">        String secondaryCpuAbiString, <span class="keyword">int</span> vc, <span class="keyword">int</span> pkgFlags, <span class="keyword">int</span> pkgPrivateFlags,</span></span></span><br><span class="line"><span class="function"><span class="params">        UserHandle installUser, <span class="keyword">boolean</span> add, <span class="keyword">boolean</span> allowInstall, String parentPackage,</span></span></span><br><span class="line"><span class="function"><span class="params">        List&lt;String&gt; childPackageNames)</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    PackageSetting p = mPackages.get(name); <span class="comment">//【1】看是否之前有添加过这个包！</span></span><br><span class="line">    UserManagerService userManager = UserManagerService.getInstance();</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (p != <span class="keyword">null</span>) &#123; </span><br><span class="line">        ... ... ...<span class="comment">// 如果已经添加了，这显然是不可能的，这里不会走这个分支！</span></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (p == <span class="keyword">null</span>) &#123;  <span class="comment">//【2】之前没有添加过，那就需要创建新的 PackageSetting 对象!</span></span><br><span class="line">    </span><br><span class="line">        <span class="keyword">if</span> (origPackage != <span class="keyword">null</span>) &#123; </span><br><span class="line">        </span><br><span class="line">           ... ... ... ... ...<span class="comment">// 如果有原包的话，这里不进入这个发分支！</span></span><br><span class="line">            </span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        </span><br><span class="line">            <span class="comment">//【3】如果这个 package 没有原包的话，就以参数 name 为包名，创建 PackageSetting 对象。</span></span><br><span class="line">            p = <span class="keyword">new</span> PackageSetting(name, realName, codePath, resourcePath,</span><br><span class="line">                    legacyNativeLibraryPathString, primaryCpuAbiString, secondaryCpuAbiString,</span><br><span class="line">                    <span class="keyword">null</span> <span class="comment">/* cpuAbiOverrideString */</span>, vc, pkgFlags, pkgPrivateFlags,</span><br><span class="line">                    parentPackage, childPackageNames);</span><br><span class="line"></span><br><span class="line">            p.setTimeStamp(codePath.lastModified());</span><br><span class="line"></span><br><span class="line">            <span class="comment">//【4】设置其 sharedUser 属性，因为它是共享 uid 的！</span></span><br><span class="line">            p.sharedUser = sharedUser;</span><br><span class="line"></span><br><span class="line">            <span class="comment">//【5】如果是非系统的应用，设置他在每个设备用户下的安装状态！</span></span><br><span class="line">            <span class="keyword">if</span> ((pkgFlags &amp; ApplicationInfo.FLAG_SYSTEM) == <span class="number">0</span>) &#123;</span><br><span class="line">                <span class="keyword">if</span> (DEBUG_STOPPED) &#123;</span><br><span class="line">                    RuntimeException e = <span class="keyword">new</span> RuntimeException(<span class="string">"here"</span>);</span><br><span class="line">                    e.fillInStackTrace();</span><br><span class="line">                    Slog.i(PackageManagerService.TAG, <span class="string">"Stopping package "</span> + name, e);</span><br><span class="line">                &#125;</span><br><span class="line"></span><br><span class="line">                List&lt;UserInfo&gt; users = getAllUsers();</span><br><span class="line">                <span class="keyword">final</span> <span class="keyword">int</span> installUserId = installUser != <span class="keyword">null</span> ? installUser.getIdentifier() : <span class="number">0</span>;</span><br><span class="line">                </span><br><span class="line">                <span class="keyword">if</span> (users != <span class="keyword">null</span> &amp;&amp; allowInstall) &#123;</span><br><span class="line">                    <span class="keyword">for</span> (UserInfo user : users) &#123;</span><br><span class="line"></span><br><span class="line">                        <span class="keyword">final</span> <span class="keyword">boolean</span> installed = installUser == <span class="keyword">null</span></span><br><span class="line">                                || (installUserId == UserHandle.USER_ALL</span><br><span class="line">                                    &amp;&amp; !isAdbInstallDisallowed(userManager, user.id))</span><br><span class="line">                                || installUserId == user.id;</span><br><span class="line">                                </span><br><span class="line">                        p.setUserState(user.id, <span class="number">0</span>, COMPONENT_ENABLED_STATE_DEFAULT,</span><br><span class="line">                                installed,</span><br><span class="line">                                <span class="keyword">true</span>, <span class="comment">// stopped,</span></span><br><span class="line">                                <span class="keyword">true</span>, <span class="comment">// notLaunched</span></span><br><span class="line">                                <span class="keyword">false</span>, <span class="comment">// hidden</span></span><br><span class="line">                                <span class="keyword">false</span>, <span class="comment">// suspended</span></span><br><span class="line">                                <span class="keyword">null</span>, <span class="keyword">null</span>, <span class="keyword">null</span>,</span><br><span class="line">                                <span class="keyword">false</span>, <span class="comment">// blockUninstall</span></span><br><span class="line">                                INTENT_FILTER_DOMAIN_VERIFICATION_STATUS_UNDEFINED, <span class="number">0</span>);</span><br><span class="line">                            </span><br><span class="line">                        writePackageRestrictionsLPr(user.id);</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">            </span><br><span class="line">            <span class="comment">//【6】设置他的 appId，在默认设备用户下，appId 等于 uid！</span></span><br><span class="line">            <span class="keyword">if</span> (sharedUser != <span class="keyword">null</span>) &#123;</span><br><span class="line">                p.appId = sharedUser.userId;</span><br><span class="line"></span><br><span class="line">            &#125; <span class="keyword">else</span> &#123;</span><br><span class="line"></span><br><span class="line">                ... ... ... ...<span class="comment">// 根据前面的分析，显然 sharedUser 不为 null，不进入这个分支！</span></span><br><span class="line">            </span><br><span class="line">            &#125;</span><br><span class="line"> </span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (p.appId &lt; <span class="number">0</span>) &#123;</span><br><span class="line">            PackageManagerService.reportSettingsProblem(Log.WARN,</span><br><span class="line">                    <span class="string">"Package "</span> + name + <span class="string">" could not be assigned a valid uid"</span>);</span><br><span class="line">            <span class="keyword">return</span> <span class="keyword">null</span>;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (add) &#123; </span><br><span class="line"></span><br><span class="line">            <span class="comment">//【7】add 为 true，进入这个分支：</span></span><br><span class="line">            <span class="comment">// 将确定了共享用户 id 的 PackageSetting 对象，添加到 mPackages 中！</span></span><br><span class="line">            addPackageSettingLPw(p, name, sharedUser);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line"> </span><br><span class="line">        ... ... ... <span class="comment">// 这个分支也不走！</span></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> p;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>继续看：</p>
<h4 id="8-2-2-1-Settings-addPackageSettingLPw"><a href="#8-2-2-1-Settings-addPackageSettingLPw" class="headerlink" title="8.2.2.1 Settings.addPackageSettingLPw"></a>8.2.2.1 Settings.addPackageSettingLPw</h4><p>将确定了共享用户 id 的 PackageSetting 对象，添加到 mPackages 中！</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">addPackageSettingLPw</span><span class="params">(PackageSetting p, String name, SharedUserSetting sharedUser)</span> </span>&#123;</span><br><span class="line">    <span class="comment">//【1】添加到 mPackages 中！</span></span><br><span class="line">    mPackages.put(name, p);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (sharedUser != <span class="keyword">null</span>) &#123; <span class="comment">// 进入这里！</span></span><br><span class="line">        <span class="keyword">if</span> (p.sharedUser != <span class="keyword">null</span> &amp;&amp; p.sharedUser != sharedUser) &#123;</span><br><span class="line">            PackageManagerService.reportSettingsProblem(Log.ERROR,</span><br><span class="line">                    <span class="string">"Package "</span> + p.name + <span class="string">" was user "</span></span><br><span class="line">                    + p.sharedUser + <span class="string">" but is now "</span> + sharedUser</span><br><span class="line">                    + <span class="string">"; I am not changing its files so it will probably fail!"</span>);</span><br><span class="line">            p.sharedUser.removePackage(p);</span><br><span class="line"></span><br><span class="line">        &#125; <span class="keyword">else</span> <span class="keyword">if</span> (p.appId != sharedUser.userId) &#123;</span><br><span class="line">            PackageManagerService.reportSettingsProblem(Log.ERROR,</span><br><span class="line">                <span class="string">"Package "</span> + p.name + <span class="string">" was user id "</span> + p.appId</span><br><span class="line">                + <span class="string">" but is now user "</span> + sharedUser</span><br><span class="line">                + <span class="string">" with id "</span> + sharedUser.userId</span><br><span class="line">                + <span class="string">"; I am not changing its files so it will probably fail!"</span>);</span><br><span class="line">        &#125;</span><br><span class="line">        </span><br><span class="line">        <span class="comment">// 确保 sharedUser 和 PackageSetting 相互引用正确！</span></span><br><span class="line">        sharedUser.addPackage(p);</span><br><span class="line">        p.sharedUser = sharedUser;</span><br><span class="line">        p.appId = sharedUser.userId;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//【2】获得这个 package 对应的 SharedUserSetting 对象！</span></span><br><span class="line">    Object userIdPs = getUserIdLPr(p.appId);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (sharedUser == <span class="keyword">null</span>) &#123;</span><br><span class="line">        <span class="comment">//【2.1】如果 sharedUser 为 null，说明共享用户无效，那就将创建的 PackageSetting 添加进来！</span></span><br><span class="line">        <span class="keyword">if</span> (userIdPs != <span class="keyword">null</span> &amp;&amp; userIdPs != p) &#123;</span><br><span class="line">            replaceUserIdLPw(p.appId, p);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        <span class="comment">//【2.2】进入这个分支：</span></span><br><span class="line">        <span class="keyword">if</span> (userIdPs != <span class="keyword">null</span> &amp;&amp; userIdPs != sharedUser) &#123;</span><br><span class="line">            <span class="comment">// 更新 uid 和 SharedUserSetting 的关系！</span></span><br><span class="line">            replaceUserIdLPw(p.appId, sharedUser);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    IntentFilterVerificationInfo ivi = mRestoredIntentFilterVerifications.get(name);</span><br><span class="line">    <span class="keyword">if</span> (ivi != <span class="keyword">null</span>) &#123;</span><br><span class="line">        <span class="keyword">if</span> (DEBUG_DOMAIN_VERIFICATION) &#123;</span><br><span class="line">            Slog.i(TAG, <span class="string">"Applying restored IVI for "</span> + name + <span class="string">" : "</span> + ivi.getStatusString());</span><br><span class="line">        &#125;</span><br><span class="line">        mRestoredIntentFilterVerifications.remove(name);</span><br><span class="line">        p.setIntentFilterVerificationInfo(ivi);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>下面是 replaceUserIdLPw 方法：<br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"> <span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">replaceUserIdLPw</span><span class="params">(<span class="keyword">int</span> uid, Object obj)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">if</span> (uid &gt;= Process.FIRST_APPLICATION_UID) &#123;</span><br><span class="line">        <span class="keyword">final</span> <span class="keyword">int</span> N = mUserIds.size();</span><br><span class="line">        <span class="keyword">final</span> <span class="keyword">int</span> index = uid - Process.FIRST_APPLICATION_UID;</span><br><span class="line">        <span class="keyword">if</span> (index &lt; N) mUserIds.set(index, obj);</span><br><span class="line">        </span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        mOtherUserIds.put(uid, obj);</span><br><span class="line">        </span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<h2 id="8-3-读取-packages-stopped-xml-文件，偏好设置"><a href="#8-3-读取-packages-stopped-xml-文件，偏好设置" class="headerlink" title="8.3 读取 packages_stopped.xml 文件，偏好设置"></a>8.3 读取 packages_stopped.xml 文件，偏好设置</h2><p>代码段如下：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">if</span> (mBackupStoppedPackagesFilename.exists()</span><br><span class="line">        || mStoppedPackagesFilename.exists()) &#123;</span><br><span class="line">    <span class="comment">// Read old file</span></span><br><span class="line">    readStoppedLPw();</span><br><span class="line">    mBackupStoppedPackagesFilename.delete();</span><br><span class="line">    mStoppedPackagesFilename.delete();</span><br><span class="line">    <span class="comment">// Migrate to new file format</span></span><br><span class="line">    writePackageRestrictionsLPr(UserHandle.USER_SYSTEM);</span><br><span class="line">&#125; <span class="keyword">else</span> &#123;</span><br><span class="line">    <span class="keyword">for</span> (UserInfo user : users) &#123;</span><br><span class="line">        readPackageRestrictionsLPr(user.id);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>读取 packages_stopped.xml 文件调用的是 readStoppedLPw 方法：  </p>
<h3 id="8-3-1-Settings-readStoppedLPw"><a href="#8-3-1-Settings-readStoppedLPw" class="headerlink" title="8.3.1 Settings.readStoppedLPw"></a>8.3.1 Settings.readStoppedLPw</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">readStoppedLPw</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    FileInputStream str = <span class="keyword">null</span>;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">//【1】如果 packages-stopped-backup.xml 文件存在，就读取它！</span></span><br><span class="line">    <span class="keyword">if</span> (mBackupStoppedPackagesFilename.exists()) &#123;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            str = <span class="keyword">new</span> FileInputStream(mBackupStoppedPackagesFilename);</span><br><span class="line">            mReadMessages.append(<span class="string">"Reading from backup stopped packages file\n"</span>);</span><br><span class="line">            PackageManagerService.reportSettingsProblem(Log.INFO,</span><br><span class="line">                    <span class="string">"Need to read from backup stopped packages file"</span>);</span><br><span class="line">            <span class="keyword">if</span> (mSettingsFilename.exists()) &#123;</span><br><span class="line">                Slog.w(PackageManagerService.TAG, <span class="string">"Cleaning up stopped packages file "</span></span><br><span class="line">                        + mStoppedPackagesFilename);</span><br><span class="line">                        </span><br><span class="line">                <span class="comment">//【1.1】如果，两个文件都存在，使用 back_up 文件，删掉 packages-stopped.xml 文件！</span></span><br><span class="line">                mStoppedPackagesFilename.delete();</span><br><span class="line">            &#125;</span><br><span class="line">        &#125; <span class="keyword">catch</span> (java.io.IOException e) &#123;</span><br><span class="line">            <span class="comment">// We'll try for the normal settings file.</span></span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//【2】如果 packages-stopped-backup.xml 文件不存在，就读取 packages-stopped.xml 文件！</span></span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">        <span class="keyword">if</span> (str == <span class="keyword">null</span>) &#123;</span><br><span class="line">            <span class="keyword">if</span> (!mStoppedPackagesFilename.exists()) &#123;</span><br><span class="line">                ... ... ...<span class="comment">// log</span></span><br><span class="line">                </span><br><span class="line">                <span class="comment">//【2.1】如果  packages-stopped.xml 也不存在，说明没有 package 处于 stop 状态；</span></span><br><span class="line">                <span class="comment">// 同时，第一次开机，所有的 package 也都不会处于 stop 状态！</span></span><br><span class="line">                <span class="keyword">for</span> (PackageSetting pkg : mPackages.values()) &#123;</span><br><span class="line">                    pkg.setStopped(<span class="keyword">false</span>, <span class="number">0</span>); <span class="comment">// 没有被 stop！</span></span><br><span class="line">                    pkg.setNotLaunched(<span class="keyword">false</span>, <span class="number">0</span>); <span class="comment">// 也没有被启动过！</span></span><br><span class="line">                &#125;</span><br><span class="line">                <span class="keyword">return</span>;</span><br><span class="line">            &#125;</span><br><span class="line">            str = <span class="keyword">new</span> FileInputStream(mStoppedPackagesFilename);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">final</span> XmlPullParser parser = Xml.newPullParser();</span><br><span class="line">        parser.setInput(str, <span class="keyword">null</span>);</span><br><span class="line"></span><br><span class="line">        <span class="keyword">int</span> type;</span><br><span class="line">        <span class="keyword">while</span> ((type=parser.next()) != XmlPullParser.START_TAG</span><br><span class="line">                   &amp;&amp; type != XmlPullParser.END_DOCUMENT) &#123;</span><br><span class="line">            ;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (type != XmlPullParser.START_TAG) &#123;</span><br><span class="line">            mReadMessages.append(<span class="string">"No start tag found in stopped packages file\n"</span>);</span><br><span class="line">            PackageManagerService.reportSettingsProblem(Log.WARN,</span><br><span class="line">                    <span class="string">"No start tag found in package manager stopped packages"</span>);</span><br><span class="line">            <span class="keyword">return</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">//【3】开始解析！</span></span><br><span class="line">        <span class="keyword">int</span> outerDepth = parser.getDepth();</span><br><span class="line">        <span class="keyword">while</span> ((type=parser.next()) != XmlPullParser.END_DOCUMENT</span><br><span class="line">               &amp;&amp; (type != XmlPullParser.END_TAG</span><br><span class="line">                       || parser.getDepth() &gt; outerDepth)) &#123;</span><br><span class="line">            <span class="keyword">if</span> (type == XmlPullParser.END_TAG</span><br><span class="line">                    || type == XmlPullParser.TEXT) &#123;</span><br><span class="line">                <span class="keyword">continue</span>;</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            String tagName = parser.getName();</span><br><span class="line"></span><br><span class="line">            <span class="comment">//【3.1】解析 stop 的 package 数据！</span></span><br><span class="line">            <span class="keyword">if</span> (tagName.equals(TAG_PACKAGE)) &#123;</span><br><span class="line">                String name = parser.getAttributeValue(<span class="keyword">null</span>, ATTR_NAME); <span class="comment">// 解析 "name" 标签</span></span><br><span class="line">                </span><br><span class="line">                <span class="comment">// 从之前安装的 mPackages 中，获得包名为 name 的 package 数据！</span></span><br><span class="line">                PackageSetting ps = mPackages.get(name);</span><br><span class="line">                <span class="keyword">if</span> (ps != <span class="keyword">null</span>) &#123;</span><br><span class="line">                    <span class="comment">//【3.1.1】设置 stopped 属性！</span></span><br><span class="line">                    ps.setStopped(<span class="keyword">true</span>, <span class="number">0</span>);</span><br><span class="line">                    <span class="keyword">if</span> (<span class="string">"1"</span>.equals(parser.getAttributeValue(<span class="keyword">null</span>, ATTR_NOT_LAUNCHED))) &#123; <span class="comment">// 解析 "nl" 标签</span></span><br><span class="line">                        <span class="comment">//【3.1.2】设置 notLaunched 属性！</span></span><br><span class="line">                        ps.setNotLaunched(<span class="keyword">true</span>, <span class="number">0</span>);</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                    Slog.w(PackageManagerService.TAG,</span><br><span class="line">                            <span class="string">"No package known for stopped package "</span> + name);</span><br><span class="line">                &#125;</span><br><span class="line">                XmlUtils.skipCurrentTag(parser);</span><br><span class="line">            &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                Slog.w(PackageManagerService.TAG, <span class="string">"Unknown element under &lt;stopped-packages&gt;: "</span></span><br><span class="line">                      + parser.getName());</span><br><span class="line">                XmlUtils.skipCurrentTag(parser);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        str.close();</span><br><span class="line"></span><br><span class="line">    &#125; <span class="keyword">catch</span> (XmlPullParserException e) &#123;</span><br><span class="line">        ... ... ... ...</span><br><span class="line"></span><br><span class="line">    &#125; <span class="keyword">catch</span> (java.io.IOException e) &#123;</span><br><span class="line">        ... ... ... ...</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>这个过程很简单，解析 packages-stopped-backup.xml 或 packages-stopped.xml 文件，设置 package 的 stopped 和 notLaunched 属性！</p>
<h3 id="8-3-2-Settings-writePackageRestrictionsLPr"><a href="#8-3-2-Settings-writePackageRestrictionsLPr" class="headerlink" title="8.3.2 Settings.writePackageRestrictionsLPr"></a>8.3.2 Settings.writePackageRestrictionsLPr</h3><p>writePackageRestrictionsLPr 方法用户保存用户对于系统应用的一些偏好设置，通过获得 package 在指定用户下的状态信息，我们就知道那些应用被 stop，那些应用被 hidden 等等！</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">writePackageRestrictionsLPr</span><span class="params">(<span class="keyword">int</span> userId)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">if</span> (DEBUG_MU) &#123;</span><br><span class="line">        Log.i(TAG, <span class="string">"Writing package restrictions for user="</span> + userId);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 获得 data/system/users/0/package-restrictions.xml 文件对象！</span></span><br><span class="line">    File userPackagesStateFile = getUserPackagesStateFile(userId);</span><br><span class="line">    <span class="comment">// 获得 data/system/users/0/package-restrictions-backup.xml 文件对象！</span></span><br><span class="line">    File backupFile = getUserPackagesStateBackupFile(userId);</span><br><span class="line">    <span class="keyword">new</span> File(userPackagesStateFile.getParent()).mkdirs();</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// 如果备份文件不存在的话，那么我们会现将 package-restrictions.xml 备份再操作！</span></span><br><span class="line">    <span class="keyword">if</span> (userPackagesStateFile.exists()) &#123;</span><br><span class="line">        <span class="keyword">if</span> (!backupFile.exists()) &#123;</span><br><span class="line">            <span class="keyword">if</span> (!userPackagesStateFile.renameTo(backupFile)) &#123;</span><br><span class="line">                Slog.wtf(PackageManagerService.TAG,</span><br><span class="line">                        <span class="string">"Unable to backup user packages state file, "</span></span><br><span class="line">                        + <span class="string">"current changes will be lost at reboot"</span>);</span><br><span class="line">                <span class="keyword">return</span>;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            userPackagesStateFile.delete();</span><br><span class="line">            Slog.w(PackageManagerService.TAG, <span class="string">"Preserving older stopped packages backup"</span>);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// 开始解析 xml 文件！</span></span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">        <span class="keyword">final</span> FileOutputStream fstr = <span class="keyword">new</span> FileOutputStream(userPackagesStateFile);</span><br><span class="line">        <span class="keyword">final</span> BufferedOutputStream str = <span class="keyword">new</span> BufferedOutputStream(fstr);</span><br><span class="line"></span><br><span class="line">        <span class="keyword">final</span> XmlSerializer serializer = <span class="keyword">new</span> FastXmlSerializer();</span><br><span class="line">        serializer.setOutput(str, StandardCharsets.UTF_8.name());</span><br><span class="line">        serializer.startDocument(<span class="keyword">null</span>, <span class="keyword">true</span>);</span><br><span class="line">        serializer.setFeature(<span class="string">"http://xmlpull.org/v1/doc/features.html#indent-output"</span>, <span class="keyword">true</span>);</span><br><span class="line"></span><br><span class="line">        serializer.startTag(<span class="keyword">null</span>, TAG_PACKAGE_RESTRICTIONS); <span class="comment">// "package-restrictions" 标签</span></span><br><span class="line"></span><br><span class="line">        <span class="keyword">for</span> (<span class="keyword">final</span> PackageSetting pkg : mPackages.values()) &#123;</span><br><span class="line">            <span class="keyword">final</span> PackageUserState ustate = pkg.readUserState(userId);</span><br><span class="line">            <span class="keyword">if</span> (DEBUG_MU) Log.i(TAG, <span class="string">"  pkg="</span> + pkg.name + <span class="string">", state="</span> + ustate.enabled);</span><br><span class="line"></span><br><span class="line">            serializer.startTag(<span class="keyword">null</span>, TAG_PACKAGE); <span class="comment">// pkg 标签</span></span><br><span class="line">            serializer.attribute(<span class="keyword">null</span>, ATTR_NAME, pkg.name); <span class="comment">// name 属性</span></span><br><span class="line">            <span class="keyword">if</span> (ustate.ceDataInode != <span class="number">0</span>) &#123;</span><br><span class="line">                XmlUtils.writeLongAttribute(serializer, ATTR_CE_DATA_INODE, ustate.ceDataInode);</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">if</span> (!ustate.installed) &#123; </span><br><span class="line">                serializer.attribute(<span class="keyword">null</span>, ATTR_INSTALLED, <span class="string">"false"</span>); <span class="comment">// inst 属性</span></span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">if</span> (ustate.stopped) &#123;</span><br><span class="line">                serializer.attribute(<span class="keyword">null</span>, ATTR_STOPPED, <span class="string">"true"</span>); <span class="comment">// stopped 属性</span></span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">if</span> (ustate.notLaunched) &#123;</span><br><span class="line">                serializer.attribute(<span class="keyword">null</span>, ATTR_NOT_LAUNCHED, <span class="string">"true"</span>); <span class="comment">// nl 属性</span></span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">if</span> (ustate.hidden) &#123;</span><br><span class="line">                serializer.attribute(<span class="keyword">null</span>, ATTR_HIDDEN, <span class="string">"true"</span>); <span class="comment">// hidden 属性</span></span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">if</span> (ustate.suspended) &#123;</span><br><span class="line">                serializer.attribute(<span class="keyword">null</span>, ATTR_SUSPENDED, <span class="string">"true"</span>); <span class="comment">// suspended 属性</span></span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">if</span> (ustate.blockUninstall) &#123;</span><br><span class="line">                serializer.attribute(<span class="keyword">null</span>, ATTR_BLOCK_UNINSTALL, <span class="string">"true"</span>); <span class="comment">// blockUninstall 属性</span></span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">if</span> (ustate.enabled != COMPONENT_ENABLED_STATE_DEFAULT) &#123; <span class="comment">// 包默认是否可用</span></span><br><span class="line">                serializer.attribute(<span class="keyword">null</span>, ATTR_ENABLED, <span class="comment">// enabled 属性</span></span><br><span class="line">                        Integer.toString(ustate.enabled));</span><br><span class="line">                <span class="keyword">if</span> (ustate.lastDisableAppCaller != <span class="keyword">null</span>) &#123;</span><br><span class="line">                    serializer.attribute(<span class="keyword">null</span>, ATTR_ENABLED_CALLER, <span class="comment">// enabledCaller 属性</span></span><br><span class="line">                            ustate.lastDisableAppCaller);</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">if</span> (ustate.domainVerificationStatus !=</span><br><span class="line">                    PackageManager.INTENT_FILTER_DOMAIN_VERIFICATION_STATUS_UNDEFINED) &#123;</span><br><span class="line">                XmlUtils.writeIntAttribute(serializer, ATTR_DOMAIN_VERIFICATON_STATE,</span><br><span class="line">                        ustate.domainVerificationStatus);</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">if</span> (ustate.appLinkGeneration != <span class="number">0</span>) &#123;</span><br><span class="line">                XmlUtils.writeIntAttribute(serializer, ATTR_APP_LINK_GENERATION,</span><br><span class="line">                        ustate.appLinkGeneration);</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">if</span> (!ArrayUtils.isEmpty(ustate.enabledComponents)) &#123; <span class="comment">// 可用组件</span></span><br><span class="line">                serializer.startTag(<span class="keyword">null</span>, TAG_ENABLED_COMPONENTS);</span><br><span class="line">                <span class="keyword">for</span> (<span class="keyword">final</span> String name : ustate.enabledComponents) &#123;</span><br><span class="line">                    serializer.startTag(<span class="keyword">null</span>, TAG_ITEM);</span><br><span class="line">                    serializer.attribute(<span class="keyword">null</span>, ATTR_NAME, name);</span><br><span class="line">                    serializer.endTag(<span class="keyword">null</span>, TAG_ITEM);</span><br><span class="line">                &#125;</span><br><span class="line">                serializer.endTag(<span class="keyword">null</span>, TAG_ENABLED_COMPONENTS);</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">if</span> (!ArrayUtils.isEmpty(ustate.disabledComponents)) &#123; <span class="comment">// 不可用组件</span></span><br><span class="line">                serializer.startTag(<span class="keyword">null</span>, TAG_DISABLED_COMPONENTS);</span><br><span class="line">                <span class="keyword">for</span> (<span class="keyword">final</span> String name : ustate.disabledComponents) &#123;</span><br><span class="line">                    serializer.startTag(<span class="keyword">null</span>, TAG_ITEM);</span><br><span class="line">                    serializer.attribute(<span class="keyword">null</span>, ATTR_NAME, name);</span><br><span class="line">                    serializer.endTag(<span class="keyword">null</span>, TAG_ITEM);</span><br><span class="line">                &#125;</span><br><span class="line">                serializer.endTag(<span class="keyword">null</span>, TAG_DISABLED_COMPONENTS);</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            serializer.endTag(<span class="keyword">null</span>, TAG_PACKAGE);</span><br><span class="line">        &#125;</span><br><span class="line">        </span><br><span class="line">        <span class="comment">// 接下来会处理默认应用的处理，这里先不看！</span></span><br><span class="line">        writePreferredActivitiesLPr(serializer, userId, <span class="keyword">true</span>);</span><br><span class="line">        writePersistentPreferredActivitiesLPr(serializer, userId);</span><br><span class="line">        writeCrossProfileIntentFiltersLPr(serializer, userId);</span><br><span class="line">        writeDefaultAppsLPr(serializer, userId);</span><br><span class="line"></span><br><span class="line">        serializer.endTag(<span class="keyword">null</span>, TAG_PACKAGE_RESTRICTIONS);</span><br><span class="line"></span><br><span class="line">        serializer.endDocument();</span><br><span class="line"></span><br><span class="line">        str.flush();</span><br><span class="line">        FileUtils.sync(fstr);</span><br><span class="line">        str.close();</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 删除备份文件，并设置主文件的权限！</span></span><br><span class="line">        backupFile.delete();</span><br><span class="line">        FileUtils.setPermissions(userPackagesStateFile.toString(),</span><br><span class="line">                FileUtils.S_IRUSR|FileUtils.S_IWUSR</span><br><span class="line">                |FileUtils.S_IRGRP|FileUtils.S_IWGRP,</span><br><span class="line">                -<span class="number">1</span>, -<span class="number">1</span>);</span><br><span class="line"></span><br><span class="line">        <span class="comment">// Done, all is good!</span></span><br><span class="line">        <span class="keyword">return</span>;</span><br><span class="line">    &#125; <span class="keyword">catch</span>(java.io.IOException e) &#123;</span><br><span class="line">        Slog.wtf(PackageManagerService.TAG,</span><br><span class="line">                <span class="string">"Unable to write package manager user packages state, "</span></span><br><span class="line">                + <span class="string">" current changes will be lost at reboot"</span>, e);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 异常情况，清除偏好设置文件！</span></span><br><span class="line">    <span class="keyword">if</span> (userPackagesStateFile.exists()) &#123;</span><br><span class="line">        <span class="keyword">if</span> (!userPackagesStateFile.delete()) &#123;</span><br><span class="line">            Log.i(PackageManagerService.TAG, <span class="string">"Failed to clean up mangled file: "</span></span><br><span class="line">                    + mStoppedPackagesFilename);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>我们来看下偏好设置的 xml 的内容！</p>
<figure class="highlight"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line">&lt;?xml version=<span class="string">'1.0'</span> encoding=<span class="string">'utf-8'</span> standalone=<span class="string">'yes'</span> ?&gt;</span><br><span class="line">&lt;<span class="keyword">package</span>-restrictions&gt;</span><br><span class="line">    &lt;pkg name=<span class="string">"com.papapa.activation"</span> ceDataInode=<span class="string">"3940"</span>&gt;</span><br><span class="line">        &lt;disabled-components&gt;</span><br><span class="line">            &lt;item name=<span class="string">"com.papapa.activation.BootReceiver"</span> /&gt;</span><br><span class="line">        &lt;/disabled-components&gt;</span><br><span class="line">    &lt;/pkg&gt;</span><br><span class="line"></span><br><span class="line">    &lt;preferred-activities&gt;</span><br><span class="line">        &lt;item name=<span class="string">"com.android.mms/.ui.ComposeMessageActivity"</span> match=<span class="string">"200000"</span> always=<span class="string">"true"</span> set=<span class="string">"1"</span>&gt;</span><br><span class="line">            &lt;set name=<span class="string">"com.android.mms/.ui.ComposeMessageActivity"</span> /&gt;</span><br><span class="line">            &lt;filter&gt;</span><br><span class="line">                &lt;action name=<span class="string">"android.intent.action.SENDTO"</span> /&gt;</span><br><span class="line">                &lt;cat name=<span class="string">"android.intent.category.DEFAULT"</span> /&gt;</span><br><span class="line">                &lt;scheme name=<span class="string">"mmsto"</span> /&gt;</span><br><span class="line">            &lt;/filter&gt;</span><br><span class="line">        &lt;/item&gt;</span><br><span class="line">    &lt;/preferred-activities&gt;</span><br><span class="line">    &lt;persistent-preferred-activities /&gt;</span><br><span class="line">    &lt;crossProfile-intent-filters /&gt;</span><br><span class="line">    &lt;<span class="keyword">default</span>-apps&gt;</span><br><span class="line">        &lt;<span class="keyword">default</span>-dialer packageName=<span class="string">"com.android.contacts"</span> /&gt;</span><br><span class="line">    &lt;/default-apps&gt;</span><br><span class="line">&lt;/package-restrictions&gt;</span><br></pre></td></tr></table></figure>
<p>这里只列出了一部分的内容，其他的很类似，不再多说！</p>
<h3 id="8-3-3-Settings-readPackageRestrictionsLPr"><a href="#8-3-3-Settings-readPackageRestrictionsLPr" class="headerlink" title="8.3.3 Settings.readPackageRestrictionsLPr"></a>8.3.3 Settings.readPackageRestrictionsLPr</h3><p>该方法用于读取已有的偏好设置，更新 package 安装的信息！<br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">readPackageRestrictionsLPr</span><span class="params">(<span class="keyword">int</span> userId)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">if</span> (DEBUG_MU) &#123;</span><br><span class="line">        Log.i(TAG, <span class="string">"Reading package restrictions for user="</span> + userId);</span><br><span class="line">    &#125;</span><br><span class="line">    FileInputStream str = <span class="keyword">null</span>;</span><br><span class="line">    <span class="comment">// 同样的，获得 data/system/users/0/package-restrictions.xml 和 </span></span><br><span class="line">    <span class="comment">// data/system/users/0/package-restrictions-backup.xml 文件对象！</span></span><br><span class="line">    File userPackagesStateFile = getUserPackagesStateFile(userId);</span><br><span class="line">    File backupFile = getUserPackagesStateBackupFile(userId);</span><br><span class="line">    <span class="comment">// 优先从 backupFile 读取，如果两个文件都存在，那就会删除非备份文件！</span></span><br><span class="line">    <span class="keyword">if</span> (backupFile.exists()) &#123;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            str = <span class="keyword">new</span> FileInputStream(backupFile);</span><br><span class="line">            mReadMessages.append(<span class="string">"Reading from backup stopped packages file\n"</span>);</span><br><span class="line">            PackageManagerService.reportSettingsProblem(Log.INFO,</span><br><span class="line">                    <span class="string">"Need to read from backup stopped packages file"</span>);</span><br><span class="line">            <span class="keyword">if</span> (userPackagesStateFile.exists()) &#123;</span><br><span class="line">                Slog.w(PackageManagerService.TAG, <span class="string">"Cleaning up stopped packages file "</span></span><br><span class="line">                        + userPackagesStateFile);</span><br><span class="line">                userPackagesStateFile.delete();</span><br><span class="line">            &#125;</span><br><span class="line">        &#125; <span class="keyword">catch</span> (java.io.IOException e) &#123;</span><br><span class="line">            <span class="comment">// We'll try for the normal settings file.</span></span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">        <span class="keyword">if</span> (str == <span class="keyword">null</span>) &#123;</span><br><span class="line">            <span class="keyword">if</span> (!userPackagesStateFile.exists()) &#123;</span><br><span class="line">                mReadMessages.append(<span class="string">"No stopped packages file found\n"</span>);</span><br><span class="line">                PackageManagerService.reportSettingsProblem(Log.INFO,</span><br><span class="line">                        <span class="string">"No stopped packages file; "</span></span><br><span class="line">                        + <span class="string">"assuming all started"</span>);</span><br><span class="line">                <span class="comment">// 对于第一次启动，这里会初始化操作，并返回！！</span></span><br><span class="line">                <span class="keyword">for</span> (PackageSetting pkg : mPackages.values()) &#123;</span><br><span class="line">                    pkg.setUserState(userId, <span class="number">0</span>, COMPONENT_ENABLED_STATE_DEFAULT,</span><br><span class="line">                            <span class="keyword">true</span>,   <span class="comment">// installed</span></span><br><span class="line">                            <span class="keyword">false</span>,  <span class="comment">// stopped</span></span><br><span class="line">                            <span class="keyword">false</span>,  <span class="comment">// notLaunched</span></span><br><span class="line">                            <span class="keyword">false</span>,  <span class="comment">// hidden</span></span><br><span class="line">                            <span class="keyword">false</span>,  <span class="comment">// suspended</span></span><br><span class="line">                            <span class="keyword">null</span>, <span class="keyword">null</span>, <span class="keyword">null</span>,</span><br><span class="line">                            <span class="keyword">false</span>, <span class="comment">// blockUninstall</span></span><br><span class="line">                            INTENT_FILTER_DOMAIN_VERIFICATION_STATUS_UNDEFINED, <span class="number">0</span>);</span><br><span class="line">                &#125;</span><br><span class="line">                <span class="keyword">return</span>;</span><br><span class="line">            &#125;</span><br><span class="line">            str = <span class="keyword">new</span> FileInputStream(userPackagesStateFile);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">final</span> XmlPullParser parser = Xml.newPullParser();</span><br><span class="line">        parser.setInput(str, StandardCharsets.UTF_8.name());</span><br><span class="line"></span><br><span class="line">        <span class="keyword">int</span> type;</span><br><span class="line">        <span class="keyword">while</span> ((type=parser.next()) != XmlPullParser.START_TAG</span><br><span class="line">                   &amp;&amp; type != XmlPullParser.END_DOCUMENT) &#123;</span><br><span class="line">            ;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (type != XmlPullParser.START_TAG) &#123;</span><br><span class="line">            mReadMessages.append(<span class="string">"No start tag found in package restrictions file\n"</span>);</span><br><span class="line">            PackageManagerService.reportSettingsProblem(Log.WARN,</span><br><span class="line">                    <span class="string">"No start tag found in package manager stopped packages"</span>);</span><br><span class="line">            <span class="keyword">return</span>;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">int</span> maxAppLinkGeneration = <span class="number">0</span>;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">int</span> outerDepth = parser.getDepth();</span><br><span class="line">        PackageSetting ps = <span class="keyword">null</span>;</span><br><span class="line">        <span class="keyword">while</span> ((type=parser.next()) != XmlPullParser.END_DOCUMENT</span><br><span class="line">               &amp;&amp; (type != XmlPullParser.END_TAG</span><br><span class="line">                       || parser.getDepth() &gt; outerDepth)) &#123;</span><br><span class="line">            <span class="keyword">if</span> (type == XmlPullParser.END_TAG</span><br><span class="line">                    || type == XmlPullParser.TEXT) &#123;</span><br><span class="line">                <span class="keyword">continue</span>;</span><br><span class="line">            &#125;</span><br><span class="line">            </span><br><span class="line">            <span class="comment">//【1】解析 pkg 标签的属性！</span></span><br><span class="line">            String tagName = parser.getName();</span><br><span class="line">            <span class="keyword">if</span> (tagName.equals(TAG_PACKAGE)) &#123;</span><br><span class="line">                String name = parser.getAttributeValue(<span class="keyword">null</span>, ATTR_NAME);</span><br><span class="line">                ps = mPackages.get(name);</span><br><span class="line">                <span class="keyword">if</span> (ps == <span class="keyword">null</span>) &#123;</span><br><span class="line">                    Slog.w(PackageManagerService.TAG, <span class="string">"No package known for stopped package "</span></span><br><span class="line">                            + name);</span><br><span class="line">                    XmlUtils.skipCurrentTag(parser);</span><br><span class="line">                    <span class="keyword">continue</span>;</span><br><span class="line">                &#125;</span><br><span class="line"></span><br><span class="line">                <span class="keyword">final</span> <span class="keyword">long</span> ceDataInode = XmlUtils.readLongAttribute(parser, ATTR_CE_DATA_INODE,</span><br><span class="line">                        <span class="number">0</span>);</span><br><span class="line">                <span class="keyword">final</span> <span class="keyword">boolean</span> installed = XmlUtils.readBooleanAttribute(parser, ATTR_INSTALLED,</span><br><span class="line">                        <span class="keyword">true</span>);</span><br><span class="line">                <span class="keyword">final</span> <span class="keyword">boolean</span> stopped = XmlUtils.readBooleanAttribute(parser, ATTR_STOPPED,</span><br><span class="line">                        <span class="keyword">false</span>);</span><br><span class="line">                <span class="keyword">final</span> <span class="keyword">boolean</span> notLaunched = XmlUtils.readBooleanAttribute(parser,</span><br><span class="line">                        ATTR_NOT_LAUNCHED, <span class="keyword">false</span>);</span><br><span class="line"></span><br><span class="line">                <span class="comment">// For backwards compatibility with the previous name of "blocked", which</span></span><br><span class="line">                <span class="comment">// now means hidden, read the old attribute as well.</span></span><br><span class="line">                <span class="keyword">final</span> String blockedStr = parser.getAttributeValue(<span class="keyword">null</span>, ATTR_BLOCKED);</span><br><span class="line">                <span class="keyword">boolean</span> hidden = blockedStr == <span class="keyword">null</span></span><br><span class="line">                        ? <span class="keyword">false</span> : Boolean.parseBoolean(blockedStr);</span><br><span class="line">                <span class="keyword">final</span> String hiddenStr = parser.getAttributeValue(<span class="keyword">null</span>, ATTR_HIDDEN);</span><br><span class="line">                hidden = hiddenStr == <span class="keyword">null</span></span><br><span class="line">                        ? hidden : Boolean.parseBoolean(hiddenStr);</span><br><span class="line"></span><br><span class="line">                <span class="keyword">final</span> <span class="keyword">boolean</span> suspended = XmlUtils.readBooleanAttribute(parser, ATTR_SUSPENDED,</span><br><span class="line">                        <span class="keyword">false</span>);</span><br><span class="line">                <span class="keyword">final</span> <span class="keyword">boolean</span> blockUninstall = XmlUtils.readBooleanAttribute(parser,</span><br><span class="line">                        ATTR_BLOCK_UNINSTALL, <span class="keyword">false</span>);</span><br><span class="line">                <span class="keyword">final</span> <span class="keyword">int</span> enabled = XmlUtils.readIntAttribute(parser, ATTR_ENABLED,</span><br><span class="line">                        COMPONENT_ENABLED_STATE_DEFAULT);</span><br><span class="line">                <span class="keyword">final</span> String enabledCaller = parser.getAttributeValue(<span class="keyword">null</span>,</span><br><span class="line">                        ATTR_ENABLED_CALLER);</span><br><span class="line"></span><br><span class="line">                <span class="keyword">final</span> <span class="keyword">int</span> verifState = XmlUtils.readIntAttribute(parser,</span><br><span class="line">                        ATTR_DOMAIN_VERIFICATON_STATE,</span><br><span class="line">                        PackageManager.INTENT_FILTER_DOMAIN_VERIFICATION_STATUS_UNDEFINED);</span><br><span class="line">                <span class="keyword">final</span> <span class="keyword">int</span> linkGeneration = XmlUtils.readIntAttribute(parser,</span><br><span class="line">                        ATTR_APP_LINK_GENERATION, <span class="number">0</span>);</span><br><span class="line">                <span class="keyword">if</span> (linkGeneration &gt; maxAppLinkGeneration) &#123;</span><br><span class="line">                    maxAppLinkGeneration = linkGeneration;</span><br><span class="line">                &#125;</span><br><span class="line"></span><br><span class="line">                ArraySet&lt;String&gt; enabledComponents = <span class="keyword">null</span>;</span><br><span class="line">                ArraySet&lt;String&gt; disabledComponents = <span class="keyword">null</span>;</span><br><span class="line"></span><br><span class="line">                <span class="keyword">int</span> packageDepth = parser.getDepth();</span><br><span class="line">                <span class="keyword">while</span> ((type=parser.next()) != XmlPullParser.END_DOCUMENT</span><br><span class="line">                        &amp;&amp; (type != XmlPullParser.END_TAG</span><br><span class="line">                        || parser.getDepth() &gt; packageDepth)) &#123;</span><br><span class="line">                    <span class="keyword">if</span> (type == XmlPullParser.END_TAG</span><br><span class="line">                            || type == XmlPullParser.TEXT) &#123;</span><br><span class="line">                        <span class="keyword">continue</span>;</span><br><span class="line">                    &#125;</span><br><span class="line">                    tagName = parser.getName();</span><br><span class="line">                    <span class="keyword">if</span> (tagName.equals(TAG_ENABLED_COMPONENTS)) &#123;</span><br><span class="line">                        enabledComponents = readComponentsLPr(parser);</span><br><span class="line">                    &#125; <span class="keyword">else</span> <span class="keyword">if</span> (tagName.equals(TAG_DISABLED_COMPONENTS)) &#123;</span><br><span class="line">                        disabledComponents = readComponentsLPr(parser);</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;</span><br><span class="line">                <span class="comment">//【2】通过解析到的偏好设置，来更新安装的 package 的信息！</span></span><br><span class="line">                ps.setUserState(userId, ceDataInode, enabled, installed, stopped, notLaunched,</span><br><span class="line">                        hidden, suspended, enabledCaller, enabledComponents, disabledComponents,</span><br><span class="line">                        blockUninstall, verifState, linkGeneration);</span><br><span class="line">            &#125; <span class="keyword">else</span> <span class="keyword">if</span> (tagName.equals(<span class="string">"preferred-activities"</span>)) &#123; <span class="comment">// 解析默认应用的属性！</span></span><br><span class="line">                readPreferredActivitiesLPw(parser, userId);</span><br><span class="line">            &#125; <span class="keyword">else</span> <span class="keyword">if</span> (tagName.equals(TAG_PERSISTENT_PREFERRED_ACTIVITIES)) &#123;</span><br><span class="line">                readPersistentPreferredActivitiesLPw(parser, userId);</span><br><span class="line">            &#125; <span class="keyword">else</span> <span class="keyword">if</span> (tagName.equals(TAG_CROSS_PROFILE_INTENT_FILTERS)) &#123;</span><br><span class="line">                readCrossProfileIntentFiltersLPw(parser, userId);</span><br><span class="line">            &#125; <span class="keyword">else</span> <span class="keyword">if</span> (tagName.equals(TAG_DEFAULT_APPS)) &#123;</span><br><span class="line">                readDefaultAppsLPw(parser, userId);</span><br><span class="line">            &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                Slog.w(PackageManagerService.TAG, <span class="string">"Unknown element under &lt;stopped-packages&gt;: "</span></span><br><span class="line">                      + parser.getName());</span><br><span class="line">                XmlUtils.skipCurrentTag(parser);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        str.close();</span><br><span class="line"></span><br><span class="line">        mNextAppLinkGeneration.put(userId, maxAppLinkGeneration + <span class="number">1</span>);</span><br><span class="line"></span><br><span class="line">    &#125; <span class="keyword">catch</span> (XmlPullParserException e) &#123;</span><br><span class="line">        mReadMessages.append(<span class="string">"Error reading: "</span> + e.toString());</span><br><span class="line">        PackageManagerService.reportSettingsProblem(Log.ERROR,</span><br><span class="line">                <span class="string">"Error reading stopped packages: "</span> + e);</span><br><span class="line">        Slog.wtf(PackageManagerService.TAG, <span class="string">"Error reading package manager stopped packages"</span>,</span><br><span class="line">                e);</span><br><span class="line"></span><br><span class="line">    &#125; <span class="keyword">catch</span> (java.io.IOException e) &#123;</span><br><span class="line">        mReadMessages.append(<span class="string">"Error reading: "</span> + e.toString());</span><br><span class="line">        PackageManagerService.reportSettingsProblem(Log.ERROR, <span class="string">"Error reading settings: "</span> + e);</span><br><span class="line">        Slog.wtf(PackageManagerService.TAG, <span class="string">"Error reading package manager stopped packages"</span>,</span><br><span class="line">                e);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>逻辑很简单，我们就不多说了！</p>
<h2 id="8-4-读取运行时权限信息，并处理授予情况！"><a href="#8-4-读取运行时权限信息，并处理授予情况！" class="headerlink" title="8.4 读取运行时权限信息，并处理授予情况！"></a>8.4 读取运行时权限信息，并处理授予情况！</h2><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//【8.4】读取每个 user 下的运行是权限信息！</span></span><br><span class="line"><span class="keyword">for</span> (UserInfo user : users) &#123;</span><br><span class="line">    mRuntimePermissionsPersistence.readStateForUserSyncLPr(user.id);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>mRuntimePermissionsPersistence 对象我们前面介绍过，其专门用于处理运行时权限！</p>
<h3 id="8-4-1-RuntimePermissionsPersistence-readStateForUserSyncLPr"><a href="#8-4-1-RuntimePermissionsPersistence-readStateForUserSyncLPr" class="headerlink" title="8.4.1 RuntimePermissionsPersistence.readStateForUserSyncLPr"></a>8.4.1 RuntimePermissionsPersistence.readStateForUserSyncLPr</h3><p>该方法会读取指定的 userId 下的运行时权限信息！</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">readStateForUserSyncLPr</span><span class="params">(<span class="keyword">int</span> userId)</span> </span>&#123;</span><br><span class="line">    <span class="comment">//【1】获得运行时权限文件对象！</span></span><br><span class="line">    File permissionsFile = getUserRuntimePermissionsFile(userId);</span><br><span class="line">    <span class="keyword">if</span> (!permissionsFile.exists()) &#123;</span><br><span class="line">        <span class="keyword">return</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    FileInputStream in;</span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">        in = <span class="keyword">new</span> AtomicFile(permissionsFile).openRead();</span><br><span class="line">    &#125; <span class="keyword">catch</span> (FileNotFoundException fnfe) &#123;</span><br><span class="line">        Slog.i(PackageManagerService.TAG, <span class="string">"No permissions state"</span>);</span><br><span class="line">        <span class="keyword">return</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">        XmlPullParser parser = Xml.newPullParser();</span><br><span class="line">        parser.setInput(in, <span class="keyword">null</span>);</span><br><span class="line">        <span class="comment">// 解析运行时权限数据！</span></span><br><span class="line">        parseRuntimePermissionsLPr(parser, userId);</span><br><span class="line"></span><br><span class="line">    &#125; <span class="keyword">catch</span> (XmlPullParserException | IOException e) &#123;</span><br><span class="line">        <span class="keyword">throw</span> <span class="keyword">new</span> IllegalStateException(<span class="string">"Failed parsing permissions file: "</span></span><br><span class="line">                + permissionsFile , e);</span><br><span class="line">    &#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">        IoUtils.closeQuietly(in);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>首先，会获得保存了运行时权限的文件对象！<br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">private</span> File <span class="title">getUserRuntimePermissionsFile</span><span class="params">(<span class="keyword">int</span> userId)</span> </span>&#123;</span><br><span class="line">    File userDir = <span class="keyword">new</span> File(<span class="keyword">new</span> File(mSystemDir, <span class="string">"users"</span>), Integer.toString(userId));</span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">new</span> File(userDir, RUNTIME_PERMISSIONS_FILE_NAME);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>该文件位于 /data/system/users/0/runtime-permissions.xml，和偏好设置的文件位于同一个目录下，我们来简单的看下该文件的具体内容：</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">&lt;?xml version='1.0' encoding='UTF-8' standalone='yes' ?&gt;</span><br><span class="line"><span class="tag">&lt;<span class="name">runtime-permissions</span> <span class="attr">fingerprint</span>=<span class="string">"OPPO/R11s/R11s:8.1.0/OPM1.171019.011/1519198279:user/release-keys"</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">pkg</span> <span class="attr">name</span>=<span class="string">"com.sohu.inputmethod.sogouoem"</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">item</span> <span class="attr">name</span>=<span class="string">"android.permission.ACCESS_FINE_LOCATION"</span> <span class="attr">granted</span>=<span class="string">"true"</span> <span class="attr">flags</span>=<span class="string">"20"</span> /&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">item</span> <span class="attr">name</span>=<span class="string">"android.permission.READ_EXTERNAL_STORAGE"</span> <span class="attr">granted</span>=<span class="string">"true"</span> <span class="attr">flags</span>=<span class="string">"20"</span> /&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">item</span> <span class="attr">name</span>=<span class="string">"android.permission.ACCESS_COARSE_LOCATION"</span> <span class="attr">granted</span>=<span class="string">"true"</span> <span class="attr">flags</span>=<span class="string">"20"</span> /&gt;</span></span><br><span class="line">    ... ... ...</span><br><span class="line">  <span class="tag">&lt;/<span class="name">pkg</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">shared-user</span> <span class="attr">name</span>=<span class="string">"android.uid.calendar"</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">item</span> <span class="attr">name</span>=<span class="string">"android.permission.READ_CALENDAR"</span> <span class="attr">granted</span>=<span class="string">"true"</span> <span class="attr">flags</span>=<span class="string">"20"</span> /&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">item</span> <span class="attr">name</span>=<span class="string">"android.permission.ACCESS_FINE_LOCATION"</span> <span class="attr">granted</span>=<span class="string">"true"</span> <span class="attr">flags</span>=<span class="string">"20"</span> /&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">item</span> <span class="attr">name</span>=<span class="string">"android.permission.READ_EXTERNAL_STORAGE"</span> <span class="attr">granted</span>=<span class="string">"true"</span> <span class="attr">flags</span>=<span class="string">"20"</span> /&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">item</span> <span class="attr">name</span>=<span class="string">"android.permission.ACCESS_COARSE_LOCATION"</span> <span class="attr">granted</span>=<span class="string">"true"</span> <span class="attr">flags</span>=<span class="string">"20"</span> /&gt;</span></span><br><span class="line">    ... ... ...</span><br><span class="line"><span class="tag">&lt;/<span class="name">runtime-permissions</span>&gt;</span></span><br></pre></td></tr></table></figure>
<h3 id="8-4-2-Settings-parseRuntimePermissionsLPr"><a href="#8-4-2-Settings-parseRuntimePermissionsLPr" class="headerlink" title="8.4.2 Settings.parseRuntimePermissionsLPr"></a>8.4.2 Settings.parseRuntimePermissionsLPr</h3><p>用于解析运行时权限文件，获得运行时权限相关的信息！<br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">parseRuntimePermissionsLPr</span><span class="params">(XmlPullParser parser, <span class="keyword">int</span> userId)</span></span></span><br><span class="line"><span class="function">        <span class="keyword">throws</span> IOException, XmlPullParserException </span>&#123;</span><br><span class="line">    <span class="keyword">final</span> <span class="keyword">int</span> outerDepth = parser.getDepth();</span><br><span class="line">    <span class="keyword">int</span> type;</span><br><span class="line">    <span class="keyword">while</span> ((type = parser.next()) != XmlPullParser.END_DOCUMENT</span><br><span class="line">            &amp;&amp; (type != XmlPullParser.END_TAG || parser.getDepth() &gt; outerDepth)) &#123;</span><br><span class="line">        <span class="keyword">if</span> (type == XmlPullParser.END_TAG || type == XmlPullParser.TEXT) &#123;</span><br><span class="line">            <span class="keyword">continue</span>;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">switch</span> (parser.getName()) &#123;</span><br><span class="line">            <span class="keyword">case</span> TAG_RUNTIME_PERMISSIONS: &#123; <span class="comment">// runtime-permissions 标签</span></span><br><span class="line">                String fingerprint = parser.getAttributeValue(<span class="keyword">null</span>, ATTR_FINGERPRINT); <span class="comment">// fingerprint 属性</span></span><br><span class="line">                mFingerprints.put(userId, fingerprint); <span class="comment">// 保存 fingerprint 到 mFingerprints 中！</span></span><br><span class="line">                <span class="comment">// 然后判断是否对该设备用户授予默认的权限，添加到 mDefaultPermissionsGranted 中！</span></span><br><span class="line">                <span class="keyword">final</span> <span class="keyword">boolean</span> defaultsGranted = Build.FINGERPRINT.equals(fingerprint);</span><br><span class="line">                mDefaultPermissionsGranted.put(userId, defaultsGranted);</span><br><span class="line">            &#125; <span class="keyword">break</span>;</span><br><span class="line"></span><br><span class="line">            <span class="keyword">case</span> TAG_PACKAGE: &#123;  <span class="comment">//【1】pkg 标签</span></span><br><span class="line">                String name = parser.getAttributeValue(<span class="keyword">null</span>, ATTR_NAME);</span><br><span class="line">                PackageSetting ps = mPackages.get(name);</span><br><span class="line">                <span class="keyword">if</span> (ps == <span class="keyword">null</span>) &#123;</span><br><span class="line">                    Slog.w(PackageManagerService.TAG, <span class="string">"Unknown package:"</span> + name);</span><br><span class="line">                    XmlUtils.skipCurrentTag(parser);</span><br><span class="line">                    <span class="keyword">continue</span>;</span><br><span class="line">                &#125;</span><br><span class="line">                <span class="comment">//【8.4.2.1】解析并处理 package 的运行时权限授予情况！</span></span><br><span class="line">                parsePermissionsLPr(parser, ps.getPermissionsState(), userId);</span><br><span class="line">            &#125; <span class="keyword">break</span>;</span><br><span class="line"></span><br><span class="line">            <span class="keyword">case</span> TAG_SHARED_USER: &#123;   <span class="comment">//【2】shared-user 标签</span></span><br><span class="line">                String name = parser.getAttributeValue(<span class="keyword">null</span>, ATTR_NAME);</span><br><span class="line">                SharedUserSetting sus = mSharedUsers.get(name);</span><br><span class="line">                <span class="keyword">if</span> (sus == <span class="keyword">null</span>) &#123;</span><br><span class="line">                    Slog.w(PackageManagerService.TAG, <span class="string">"Unknown shared user:"</span> + name);</span><br><span class="line">                    XmlUtils.skipCurrentTag(parser);</span><br><span class="line">                    <span class="keyword">continue</span>;</span><br><span class="line">                &#125;</span><br><span class="line">                <span class="comment">//【8.4.2.1】解析并处理 shared-user 的运行时权限授予情况！</span></span><br><span class="line">                parsePermissionsLPr(parser, sus.getPermissionsState(), userId);</span><br><span class="line">            &#125; <span class="keyword">break</span>;</span><br><span class="line"></span><br><span class="line">            <span class="keyword">case</span> TAG_RESTORED_RUNTIME_PERMISSIONS: &#123; <span class="comment">//【3】restored-perms 标签</span></span><br><span class="line">                <span class="comment">//【3.1】解析要被恢复的权限所属的应用包名！</span></span><br><span class="line">                <span class="keyword">final</span> String pkgName = parser.getAttributeValue(<span class="keyword">null</span>, ATTR_PACKAGE_NAME);</span><br><span class="line">                <span class="comment">//【8.4.2.2】解析 restored-perms!</span></span><br><span class="line">                parseRestoredRuntimePermissionsLPr(parser, pkgName, userId);</span><br><span class="line">            &#125; <span class="keyword">break</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>这个过程主要工作：</p>
<ul>
<li>解析并处理 package 的运行时权限授予情况；</li>
<li>解析并处理 shared-user 的运行时权限授予情况；</li>
</ul>
<h4 id="8-4-2-1-Settings-parsePermissionsLPr"><a href="#8-4-2-1-Settings-parsePermissionsLPr" class="headerlink" title="8.4.2.1 Settings.parsePermissionsLPr"></a>8.4.2.1 Settings.parsePermissionsLPr</h4><p>我们来看下 parsePermissionsLPr 是如何解析和处理运行时权限的！<br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">parsePermissionsLPr</span><span class="params">(XmlPullParser parser, PermissionsState permissionsState,</span></span></span><br><span class="line"><span class="function"><span class="params">        <span class="keyword">int</span> userId)</span> <span class="keyword">throws</span> IOException, XmlPullParserException </span>&#123;</span><br><span class="line">    <span class="keyword">final</span> <span class="keyword">int</span> outerDepth = parser.getDepth();</span><br><span class="line">    <span class="keyword">int</span> type;</span><br><span class="line">    <span class="keyword">while</span> ((type = parser.next()) != XmlPullParser.END_DOCUMENT</span><br><span class="line">            &amp;&amp; (type != XmlPullParser.END_TAG || parser.getDepth() &gt; outerDepth)) &#123;</span><br><span class="line">        <span class="keyword">if</span> (type == XmlPullParser.END_TAG || type == XmlPullParser.TEXT) &#123;</span><br><span class="line">            <span class="keyword">continue</span>;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">switch</span> (parser.getName()) &#123;</span><br><span class="line">            <span class="keyword">case</span> TAG_ITEM: &#123;</span><br><span class="line">                String name = parser.getAttributeValue(<span class="keyword">null</span>, ATTR_NAME); <span class="comment">// name 属性！</span></span><br><span class="line">                BasePermission bp = mPermissions.get(name);</span><br><span class="line">                <span class="keyword">if</span> (bp == <span class="keyword">null</span>) &#123;</span><br><span class="line">                    Slog.w(PackageManagerService.TAG, <span class="string">"Unknown permission:"</span> + name);</span><br><span class="line">                    XmlUtils.skipCurrentTag(parser);</span><br><span class="line">                    <span class="keyword">continue</span>;</span><br><span class="line">                &#125;</span><br><span class="line"></span><br><span class="line">                String grantedStr = parser.getAttributeValue(<span class="keyword">null</span>, ATTR_GRANTED);  <span class="comment">// granted 属性！</span></span><br><span class="line">                <span class="keyword">final</span> <span class="keyword">boolean</span> granted = grantedStr == <span class="keyword">null</span></span><br><span class="line">                        || Boolean.parseBoolean(grantedStr);</span><br><span class="line"></span><br><span class="line">                String flagsStr = parser.getAttributeValue(<span class="keyword">null</span>, ATTR_FLAGS); <span class="comment">// flags 属性！</span></span><br><span class="line">                <span class="keyword">final</span> <span class="keyword">int</span> flags = (flagsStr != <span class="keyword">null</span>)</span><br><span class="line">                        ? Integer.parseInt(flagsStr, <span class="number">16</span>) : <span class="number">0</span>;</span><br><span class="line"></span><br><span class="line">                <span class="comment">//【8.4.2.1.1】处理运行时权限的授予情况，这里和处理安装时权限很类似！</span></span><br><span class="line">                <span class="keyword">if</span> (granted) &#123;</span><br><span class="line">                    <span class="comment">// 如果上次安装时，该运行时权限处于授予状态，接着更新 flags！</span></span><br><span class="line">                    permissionsState.grantRuntimePermission(bp, userId);</span><br><span class="line">                    permissionsState.updatePermissionFlags(bp, userId,</span><br><span class="line">                                PackageManager.MASK_PERMISSION_FLAGS, flags);</span><br><span class="line">                &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                    <span class="comment">// 如果上次安装时，该运行时权限处于未授予状态，只更新 flags！</span></span><br><span class="line">                    permissionsState.updatePermissionFlags(bp, userId,</span><br><span class="line">                            PackageManager.MASK_PERMISSION_FLAGS, flags);</span><br><span class="line">                &#125;</span><br><span class="line"></span><br><span class="line">            &#125; <span class="keyword">break</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>我们看到，对于运行时权限已授予的情况，我们会先进行一次运行时权限授予，然后更新权限的 flags；对于运行时权限未授予的情况，只是更新 flags 即可！</p>
<h5 id="8-4-2-1-1-Permissions-grantRuntimePermission"><a href="#8-4-2-1-1-Permissions-grantRuntimePermission" class="headerlink" title="8.4.2.1.1 Permissions.grantRuntimePermission"></a>8.4.2.1.1 Permissions.grantRuntimePermission</h5><p>处理运行时权限的授予！</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">int</span> <span class="title">grantRuntimePermission</span><span class="params">(BasePermission permission, <span class="keyword">int</span> userId)</span> </span>&#123;</span><br><span class="line">    enforceValidUserId(userId);</span><br><span class="line">    <span class="comment">//【1】可以看到，对于运行时权限，userId 只能为当前设备用户，不能为 USER_ALL</span></span><br><span class="line">    <span class="keyword">if</span> (userId == UserHandle.USER_ALL) &#123;</span><br><span class="line">        <span class="keyword">return</span> PERMISSION_OPERATION_FAILURE;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">//【2】接下来，就和处理安装时权限一样了！</span></span><br><span class="line">    <span class="keyword">return</span> grantPermission(permission, userId);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>这里不多说！</p>
<h4 id="8-4-2-2-Settings-parseRestoredRuntimePermissionsLPr"><a href="#8-4-2-2-Settings-parseRestoredRuntimePermissionsLPr" class="headerlink" title="8.4.2.2 Settings.parseRestoredRuntimePermissionsLPr"></a>8.4.2.2 Settings.parseRestoredRuntimePermissionsLPr</h4><p>解析那些需要恢复的权限信息：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">parseRestoredRuntimePermissionsLPr</span><span class="params">(XmlPullParser parser,</span></span></span><br><span class="line"><span class="function"><span class="params">        <span class="keyword">final</span> String pkgName, <span class="keyword">final</span> <span class="keyword">int</span> userId)</span> <span class="keyword">throws</span> IOException, XmlPullParserException </span>&#123;</span><br><span class="line">    <span class="keyword">final</span> <span class="keyword">int</span> outerDepth = parser.getDepth();</span><br><span class="line">    <span class="keyword">int</span> type;</span><br><span class="line">    <span class="keyword">while</span> ((type = parser.next()) != XmlPullParser.END_DOCUMENT</span><br><span class="line">            &amp;&amp; (type != XmlPullParser.END_TAG || parser.getDepth() &gt; outerDepth)) &#123;</span><br><span class="line">        <span class="keyword">if</span> (type == XmlPullParser.END_TAG || type == XmlPullParser.TEXT) &#123;</span><br><span class="line">            <span class="keyword">continue</span>;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">switch</span> (parser.getName()) &#123;</span><br><span class="line">            <span class="comment">//【1】解析 perm 标签！</span></span><br><span class="line">            <span class="keyword">case</span> TAG_PERMISSION_ENTRY: &#123;</span><br><span class="line">                <span class="comment">//【1.1】解析 name 属性，获得权限的名称；</span></span><br><span class="line">                <span class="keyword">final</span> String permName = parser.getAttributeValue(<span class="keyword">null</span>, ATTR_NAME);</span><br><span class="line">                <span class="comment">//【1.2】解析 granted 属性，获得权限的授予情况；</span></span><br><span class="line">                <span class="keyword">final</span> <span class="keyword">boolean</span> isGranted = <span class="string">"true"</span>.equals(</span><br><span class="line">                        parser.getAttributeValue(<span class="keyword">null</span>, ATTR_GRANTED));</span><br><span class="line">                <span class="comment">//【1.3】解析获得权限的 flags 设置！</span></span><br><span class="line">                <span class="keyword">int</span> permBits = <span class="number">0</span>;</span><br><span class="line">                <span class="keyword">if</span> (<span class="string">"true"</span>.equals(parser.getAttributeValue(<span class="keyword">null</span>, ATTR_USER_SET))) &#123;</span><br><span class="line">                    permBits |= FLAG_PERMISSION_USER_SET;</span><br><span class="line">                &#125;</span><br><span class="line">                <span class="keyword">if</span> (<span class="string">"true"</span>.equals(parser.getAttributeValue(<span class="keyword">null</span>, ATTR_USER_FIXED))) &#123;</span><br><span class="line">                    permBits |= FLAG_PERMISSION_USER_FIXED;</span><br><span class="line">                &#125;</span><br><span class="line">                <span class="keyword">if</span> (<span class="string">"true"</span>.equals(parser.getAttributeValue(<span class="keyword">null</span>, ATTR_REVOKE_ON_UPGRADE))) &#123;</span><br><span class="line">                    permBits |= FLAG_PERMISSION_REVOKE_ON_UPGRADE;</span><br><span class="line">                &#125;</span><br><span class="line">                <span class="keyword">if</span> (isGranted || permBits != <span class="number">0</span>) &#123;</span><br><span class="line">                    <span class="comment">//【8.4.2.2.1】如果权限是授予状态，或者其 flags 不为 null！</span></span><br><span class="line">                    <span class="comment">// 那么我们会将其记录到内充中！</span></span><br><span class="line">                    rememberRestoredUserGrantLPr(pkgName, permName, isGranted, permBits, userId);</span><br><span class="line">                &#125;</span><br><span class="line">            &#125; <span class="keyword">break</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>如果权限是被授予的状态，或者其 flags 不为 null，那么会调用 rememberRestoredUserGrantLPr 方法，保存到 Settings.mRestoredUserGrants 中！</p>
<p>#####8.4.2.2.1 Settings.rememberRestoredUserGrantLPr<br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">rememberRestoredUserGrantLPr</span><span class="params">(String pkgName, String permission,</span></span></span><br><span class="line"><span class="function"><span class="params">        <span class="keyword">boolean</span> isGranted, <span class="keyword">int</span> restoredFlagSet, <span class="keyword">int</span> userId)</span> </span>&#123;</span><br><span class="line">    <span class="comment">//【1】获得该 userId 下的 restore perms 数据集合，是一个 Map！</span></span><br><span class="line">    <span class="comment">// 如果为 null，就初始化！</span></span><br><span class="line">    ArrayMap&lt;String, ArraySet&lt;RestoredPermissionGrant&gt;&gt; grantsByPackage =</span><br><span class="line">            mRestoredUserGrants.get(userId);</span><br><span class="line">    <span class="keyword">if</span> (grantsByPackage == <span class="keyword">null</span>) &#123;</span><br><span class="line">        grantsByPackage = <span class="keyword">new</span> ArrayMap&lt;String, ArraySet&lt;RestoredPermissionGrant&gt;&gt;();</span><br><span class="line">        mRestoredUserGrants.put(userId, grantsByPackage);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">//【2】获得该 package 的 restore perms 数据集合，如果为 null，就初始化！</span></span><br><span class="line">    ArraySet&lt;RestoredPermissionGrant&gt; grants = grantsByPackage.get(pkgName);</span><br><span class="line">    <span class="keyword">if</span> (grants == <span class="keyword">null</span>) &#123;</span><br><span class="line">        grants = <span class="keyword">new</span> ArraySet&lt;RestoredPermissionGrant&gt;();</span><br><span class="line">        grantsByPackage.put(pkgName, grants);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">//【3】将 retore 的权限封装成一个 RestoredPermissionGrant，添加到集合中！</span></span><br><span class="line">    RestoredPermissionGrant grant = <span class="keyword">new</span> RestoredPermissionGrant(permission,</span><br><span class="line">            isGranted, restoredFlagSet);</span><br><span class="line">    grants.add(grant);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>Settings 内部有一个 SparseArray：<br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">private</span> <span class="keyword">final</span> SparseArray&lt;ArrayMap&lt;String, ArraySet&lt;RestoredPermissionGrant&gt;&gt;&gt;</span><br><span class="line">         mRestoredUserGrants =</span><br><span class="line">             <span class="keyword">new</span> SparseArray&lt;ArrayMap&lt;String, ArraySet&lt;RestoredPermissionGrant&gt;&gt;&gt;();</span><br></pre></td></tr></table></figure></p>
<p>下标是 userId，值是一个 ArrayMap&lt;String, ArraySet<restoredpermissiongrant>&gt;，封装了该 userId 下所有 package的 retore perms！</restoredpermissiongrant></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">final</span> <span class="class"><span class="keyword">class</span> <span class="title">RestoredPermissionGrant</span> </span>&#123;</span><br><span class="line">    String permissionName;</span><br><span class="line">    <span class="keyword">boolean</span> granted;</span><br><span class="line">    <span class="keyword">int</span> grantBits;</span><br><span class="line"></span><br><span class="line">    RestoredPermissionGrant(String name, <span class="keyword">boolean</span> isGranted, <span class="keyword">int</span> theGrantBits) &#123;</span><br><span class="line">        permissionName = name;</span><br><span class="line">        granted = isGranted;</span><br><span class="line">        grantBits = theGrantBits;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>RestoredPermissionGrant 内部的结构很简单，不多说了！！</p>
<h1 id="9-安装时权限处理过程分析-接-8-1-1-4"><a href="#9-安装时权限处理过程分析-接-8-1-1-4" class="headerlink" title="9 安装时权限处理过程分析 - 接 8.1.1.4"></a>9 安装时权限处理过程分析 - 接 8.1.1.4</h1><p>markdown 只支持 6 级标题，所以这里接 8.1.1.4 继续分析！</p>
<p>下面来较为深入的分析下解析 “perms” 标签，并通过解析结果授予安装时权限的过程：</p>
<figure class="highlight"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">&lt;perms&gt;</span><br><span class="line">     &lt;item name=<span class="string">"android.permission.REAL_GET_TASKS"</span> granted=<span class="string">"true"</span> flags=<span class="string">"0"</span> /&gt;</span><br><span class="line">     &lt;item name=<span class="string">"android.permission.RECEIVE_BOOT_COMPLETED"</span> granted=<span class="string">"true"</span> flags=<span class="string">"0"</span> /&gt;</span><br><span class="line">     &lt;item name=<span class="string">"android.permission.INTERNET"</span> granted=<span class="string">"true"</span> flags=<span class="string">"0"</span> /&gt;</span><br><span class="line">     &lt;item name=<span class="string">"android.permission.ACCESS_NETWORK_STATE"</span> granted=<span class="string">"true"</span> flags=<span class="string">"0"</span> /&gt;</span><br><span class="line">&lt;/perms&gt;</span><br></pre></td></tr></table></figure>
<p>回顾一下，Settings.readInstallPermissionsLPr 的方法：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">readInstallPermissionsLPr</span><span class="params">(XmlPullParser parser, PermissionsState permissionsState)</span> </span></span><br><span class="line"><span class="function">                                                    <span class="keyword">throws</span> IOException, XmlPullParserException </span>&#123;</span><br><span class="line">    <span class="keyword">int</span> outerDepth = parser.getDepth();</span><br><span class="line">    <span class="keyword">int</span> type;</span><br><span class="line">    <span class="keyword">while</span> ((type=parser.next()) != XmlPullParser.END_DOCUMENT</span><br><span class="line">            &amp;&amp; (type != XmlPullParser.END_TAG</span><br><span class="line">            || parser.getDepth() &gt; outerDepth)) &#123;</span><br><span class="line">        <span class="keyword">if</span> (type == XmlPullParser.END_TAG</span><br><span class="line">                || type == XmlPullParser.TEXT) &#123;</span><br><span class="line">            <span class="keyword">continue</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        String tagName = parser.getName();</span><br><span class="line">        <span class="keyword">if</span> (tagName.equals(TAG_ITEM)) &#123; <span class="comment">// 解析 "item"</span></span><br><span class="line">            String name = parser.getAttributeValue(<span class="keyword">null</span>, ATTR_NAME); <span class="comment">// 接续 "name"，权限名称！</span></span><br><span class="line">            <span class="comment">//【1】从之前解析的 Settings.mPermissions 获得对应的权限；</span></span><br><span class="line">            BasePermission bp = mPermissions.get(name);</span><br><span class="line">            <span class="keyword">if</span> (bp == <span class="keyword">null</span>) &#123;</span><br><span class="line">                Slog.w(PackageManagerService.TAG, <span class="string">"Unknown permission: "</span> + name);</span><br><span class="line">                XmlUtils.skipCurrentTag(parser);</span><br><span class="line">                <span class="keyword">continue</span>;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="comment">//【2】解析 "granted" 标签，获得授予情况！</span></span><br><span class="line">            String grantedStr = parser.getAttributeValue(<span class="keyword">null</span>, ATTR_GRANTED);</span><br><span class="line">            <span class="keyword">final</span> <span class="keyword">boolean</span> granted = grantedStr == <span class="keyword">null</span></span><br><span class="line">                    || Boolean.parseBoolean(grantedStr);</span><br><span class="line">            <span class="comment">// 解析 "flags"标签</span></span><br><span class="line">            String flagsStr = parser.getAttributeValue(<span class="keyword">null</span>, ATTR_FLAGS);</span><br><span class="line">            <span class="keyword">final</span> <span class="keyword">int</span> flags = (flagsStr != <span class="keyword">null</span>)</span><br><span class="line">                    ? Integer.parseInt(flagsStr, <span class="number">16</span>) : <span class="number">0</span>;</span><br><span class="line"></span><br><span class="line">            <span class="comment">//【3】处理权限授予的操作！</span></span><br><span class="line">            <span class="keyword">if</span> (granted) &#123; </span><br><span class="line">                <span class="comment">//【9.1】处理默认授予的情况！</span></span><br><span class="line">                <span class="keyword">if</span> (permissionsState.grantInstallPermission(bp) ==</span><br><span class="line">                        PermissionsState.PERMISSION_OPERATION_FAILURE) &#123;</span><br><span class="line">                    Slog.w(PackageManagerService.TAG, <span class="string">"Permission already added: "</span> + name);</span><br><span class="line">                    XmlUtils.skipCurrentTag(parser);</span><br><span class="line">                &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                    permissionsState.updatePermissionFlags(bp, UserHandle.USER_ALL,</span><br><span class="line">                            PackageManager.MASK_PERMISSION_FLAGS, flags);</span><br><span class="line">                &#125;</span><br><span class="line">            &#125; <span class="keyword">else</span> &#123; </span><br><span class="line">                <span class="comment">//【9.2】处理默认不授予的情况！</span></span><br><span class="line">                <span class="keyword">if</span> (permissionsState.revokeInstallPermission(bp) ==</span><br><span class="line">                        PermissionsState.PERMISSION_OPERATION_FAILURE) &#123;</span><br><span class="line">                    Slog.w(PackageManagerService.TAG, <span class="string">"Permission already added: "</span> + name);</span><br><span class="line">                    XmlUtils.skipCurrentTag(parser);</span><br><span class="line">                &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                    <span class="comment">//【9.3】更新应用权限信息！</span></span><br><span class="line">                    permissionsState.updatePermissionFlags(bp, UserHandle.USER_ALL,</span><br><span class="line">                            PackageManager.MASK_PERMISSION_FLAGS, flags);</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            Slog.w(PackageManagerService.TAG, <span class="string">"Unknown element under &lt;permissions&gt;: "</span></span><br><span class="line">                    + parser.getName());</span><br><span class="line">            XmlUtils.skipCurrentTag(parser);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>接下来，我们看一看，这个流程是如何处理权限的：</p>
<p>这里有涉及到 permissionsState 对象，每一个 PackageSetting 和 SharedUserSetting 都有一个 permissionsState 对象，用来保存其权限的状态信息！</p>
<p>在创建 PackageSetting 和 SharedUserSetting 的时候，都会默认创建一个 PermissionsState 对象！</p>
<p>PermissionsState 内部有一个 ArrayMap&lt;String, PermissionData&gt; mPermissions 用来保存权限名和其对应权限信息数据！</p>
<p>下面为了简化分析过程，PermissionsState 统一化为 PermissionsS</p>
<h2 id="9-1-PermissionsS-grantInstallPermission-处理授予情况"><a href="#9-1-PermissionsS-grantInstallPermission-处理授予情况" class="headerlink" title="9.1 PermissionsS.grantInstallPermission - 处理授予情况"></a>9.1 PermissionsS.grantInstallPermission - 处理授予情况</h2><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 授予一个安装时权限，可以看到，安装时权限是对所有用户都默认授予的！</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">int</span> <span class="title">grantInstallPermission</span><span class="params">(BasePermission permission)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">return</span> grantPermission(permission, UserHandle.USER_ALL);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>我们继续看，参数传入：</p>
<ul>
<li><strong>BasePermission permission</strong>：权限封装对象</li>
<li><strong>int userId</strong>：设备用户，因为是安装时权限，所以对所有设备用户都是一样，这里传入 <strong>UserHandle.USER_ALL</strong>！<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">int</span> <span class="title">grantPermission</span><span class="params">(BasePermission permission, <span class="keyword">int</span> userId)</span> </span>&#123;</span><br><span class="line">    <span class="comment">//【9.1.1】如果之前有权限，本次授予失败！</span></span><br><span class="line">    <span class="keyword">if</span> (hasPermission(permission.name, userId)) &#123;</span><br><span class="line">        <span class="keyword">return</span> PERMISSION_OPERATION_FAILURE;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">//【9.1.2】判断权限 BasePermission 在 userId 下是否有映射 gid，如果有，那 hasGids 为 true！</span></span><br><span class="line">    <span class="keyword">final</span> <span class="keyword">boolean</span> hasGids = !ArrayUtils.isEmpty(permission.computeGids(userId));</span><br><span class="line"></span><br><span class="line">    <span class="comment">//【9.1.3】如果权限 BasePermission 有映射的 gid，那就计算下该 package 的所属的 Gid 组！</span></span><br><span class="line">    <span class="keyword">final</span> <span class="keyword">int</span>[] oldGids = hasGids ? computeGids(userId) : NO_GIDS;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">//【9.1.4】创建权限的 permissionData 对象，并添加到 PermissionState.mPermissions 中！</span></span><br><span class="line">    PermissionData permissionData = ensurePermissionData(permission);</span><br><span class="line"></span><br><span class="line">    <span class="comment">//【9.1.5】授予权限！</span></span><br><span class="line">    <span class="keyword">if</span> (!permissionData.grant(userId)) &#123; <span class="comment">// 授权失败，就返回 PERMISSION_OPERATION_FAILURE！</span></span><br><span class="line">        <span class="keyword">return</span> PERMISSION_OPERATION_FAILURE;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 如果权限有映射的 gid，在授予权限后，再次计算该 package 的所有映射的 gid！</span></span><br><span class="line">    <span class="comment">// 比较授权前后，gid 组是否发生了变化，如果有，返回 PERMISSION_OPERATION_SUCCESS_GIDS_CHANGED！</span></span><br><span class="line">    <span class="keyword">if</span> (hasGids) &#123;</span><br><span class="line">        <span class="keyword">final</span> <span class="keyword">int</span>[] newGids = computeGids(userId);</span><br><span class="line">        <span class="keyword">if</span> (oldGids.length != newGids.length) &#123;</span><br><span class="line">            <span class="keyword">return</span> PERMISSION_OPERATION_SUCCESS_GIDS_CHANGED;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> PERMISSION_OPERATION_SUCCESS; <span class="comment">// 返回 PERMISSION_OPERATION_SUCCESS！</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
</li>
</ul>
<p>方法逻辑如下：</p>
<ul>
<li>如果已经授予权限，那就不处理，返回 PERMISSION_OPERATION_FAILURE；</li>
<li>如果授予权限失败，那就不处理，返回 PERMISSION_OPERATION_FAILURE；</li>
<li>如果授予权限成功，但是发现权限所属的 gid 发生了变化，返回 PERMISSION_OPERATION_SUCCESS_GIDS_CHANGED；</li>
<li>如果授予权限成功，但是发现权限所属的 gid 没有发生变化，返回 PERMISSION_OPERATION_SUCCESS；</li>
</ul>
<h3 id="9-1-1-PermissionsS-hasPermission"><a href="#9-1-1-PermissionsS-hasPermission" class="headerlink" title="9.1.1 PermissionsS.hasPermission"></a>9.1.1 PermissionsS.hasPermission</h3><p>hasPermission 用来判断是否已经授予的该权限！<br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">boolean</span> <span class="title">hasPermission</span><span class="params">(String name, <span class="keyword">int</span> userId)</span> </span>&#123;</span><br><span class="line">    <span class="comment">// 校验 uid 的有效性！</span></span><br><span class="line">    enforceValidUserId(userId);</span><br><span class="line">    <span class="keyword">if</span> (mPermissions == <span class="keyword">null</span>) &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">false</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">//【1】获得该权限对应的 permissionData 对象！</span></span><br><span class="line">    PermissionData permissionData = mPermissions.get(name);</span><br><span class="line">    <span class="comment">//【9.1.1.1】判断是否已经授予了该权限！</span></span><br><span class="line">    <span class="keyword">return</span> permissionData != <span class="keyword">null</span> &amp;&amp; permissionData.isGranted(userId);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>授予该权限的条件是，其对应的 PermissionData 不为 null，同时该权限属于已经授予的状态；</p>
<h4 id="9-1-1-1-PermissionData-isGranted"><a href="#9-1-1-1-PermissionData-isGranted" class="headerlink" title="9.1.1.1 PermissionData.isGranted"></a>9.1.1.1 PermissionData.isGranted</h4><p>PermissionData 的 isGranted 用于判断该权限在 userId 所在的设备用户下是否是授予状态！<br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">boolean</span> <span class="title">isGranted</span><span class="params">(<span class="keyword">int</span> userId)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">if</span> (isInstallPermission()) &#123; <span class="comment">// 如果是安装时权限，userId 即 key 为 USER_ALL！</span></span><br><span class="line">        userId = UserHandle.USER_ALL;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    PermissionState userState = mUserStates.get(userId);</span><br><span class="line">    <span class="keyword">if</span> (userState == <span class="keyword">null</span>) &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">false</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> userState.mGranted; <span class="comment">// 返回是否授予！</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>isInstallPermission 方法用来判断，该权限是否是一个安装时的权限：<br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">boolean</span> <span class="title">isInstallPermission</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    <span class="keyword">return</span> mUserStates.size() == <span class="number">1</span></span><br><span class="line">            &amp;&amp; mUserStates.get(UserHandle.USER_ALL) != <span class="keyword">null</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>判断依据很简单，对于安装时权限，所有的设备用户都一样，所以 mUserStates 大小为 1，且 key 为 UserHandle.USER_ALL！</p>
<h3 id="9-1-2-BasePermission-computeGids"><a href="#9-1-2-BasePermission-computeGids" class="headerlink" title="9.1.2 BasePermission.computeGids"></a>9.1.2 BasePermission.computeGids</h3><p>BasePermission 的 computeGids 方法用于通过 userId 来调整该权限所映射的 gids！</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">int</span>[] computeGids(<span class="keyword">int</span> userId) &#123;</span><br><span class="line">    <span class="keyword">if</span> (perUser) &#123;</span><br><span class="line">        <span class="keyword">final</span> <span class="keyword">int</span>[] userGids = <span class="keyword">new</span> <span class="keyword">int</span>[gids.length];</span><br><span class="line">        <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; gids.length; i++) &#123;</span><br><span class="line">            userGids[i] = UserHandle.getUid(userId, gids[i]);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> userGids;</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> gids;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>如果 perUser 为 true，表示需要根据当前应用所在的 userId，调整映射的 gid，那么会通过 UserHandle.getUid 方法计算出当前 userId 下的该权限所映射的 gid！</p>
<p>如果 perUser 为 false，那么该权限在所有的设备用户下映射的 gid 是一样的！</p>
<h3 id="9-1-3-PermissionsS-computeGids"><a href="#9-1-3-PermissionsS-computeGids" class="headerlink" title="9.1.3 PermissionsS.computeGids"></a>9.1.3 PermissionsS.computeGids</h3><p>返回指定设备用户 id 下，该 package 当前被授予的所有权限映射的 gid 数组！！<br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">int</span>[] computeGids(<span class="keyword">int</span> userId) &#123;</span><br><span class="line">    enforceValidUserId(userId);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">int</span>[] gids = mGlobalGids;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (mPermissions != <span class="keyword">null</span>) &#123;</span><br><span class="line">        <span class="keyword">final</span> <span class="keyword">int</span> permissionCount = mPermissions.size();</span><br><span class="line">        <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; permissionCount; i++) &#123;</span><br><span class="line">            <span class="comment">//【1】遍历该 package 的已经被授予的所有权限！</span></span><br><span class="line">            <span class="comment">// 没有授予就跳过！</span></span><br><span class="line">            String permission = mPermissions.keyAt(i);</span><br><span class="line">            <span class="keyword">if</span> (!hasPermission(permission, userId)) &#123;</span><br><span class="line">                <span class="keyword">continue</span>;</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            PermissionData permissionData = mPermissions.valueAt(i);</span><br><span class="line">            <span class="comment">//【9.1.3.1】计算该权限在当前设备用户下的 gid，将其添加到 gids！</span></span><br><span class="line">            <span class="keyword">final</span> <span class="keyword">int</span>[] permGids = permissionData.computeGids(userId);</span><br><span class="line">            <span class="keyword">if</span> (permGids != NO_GIDS) &#123;</span><br><span class="line">                gids = appendInts(gids, permGids);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// 并返回 gids！！</span></span><br><span class="line">    <span class="keyword">return</span> gids;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>mGlobalGids 是 PermissionsState 的成员变量，默认取值为：<br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="keyword">int</span>[] NO_GIDS = &#123;&#125;;</span><br><span class="line"><span class="keyword">private</span> <span class="keyword">int</span>[] mGlobalGids = NO_GIDS;</span><br></pre></td></tr></table></figure></p>
<h4 id="9-1-3-1-PermissionData-computeGids"><a href="#9-1-3-1-PermissionData-computeGids" class="headerlink" title="9.1.3.1 PermissionData.computeGids"></a>9.1.3.1 PermissionData.computeGids</h4><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="class"><span class="keyword">class</span> <span class="title">PermissionData</span> </span>&#123;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> BasePermission mPerm;</span><br><span class="line">    ... ... ...</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">int</span>[] computeGids(<span class="keyword">int</span> userId) &#123;</span><br><span class="line">        <span class="comment">// 计算该权限所属的 gid！</span></span><br><span class="line">        <span class="keyword">return</span> mPerm.computeGids(userId);</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure>
<p>PermissionData.computeGids 方法最后调用的是 BasePermission.computeGids 方法，这里不多说了。</p>
<h3 id="9-1-4-PermissionsS-ensurePermissionData"><a href="#9-1-4-PermissionsS-ensurePermissionData" class="headerlink" title="9.1.4 PermissionsS.ensurePermissionData"></a>9.1.4 PermissionsS.ensurePermissionData</h3><p>创建 PermissionData，并添加到 PermissionsState 内部的 mPermissions 集合中！<br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">private</span> PermissionData <span class="title">ensurePermissionData</span><span class="params">(BasePermission permission)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">if</span> (mPermissions == <span class="keyword">null</span>) &#123;</span><br><span class="line">        mPermissions = <span class="keyword">new</span> ArrayMap&lt;&gt;();</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">//【9.1.2.1】创建权限对应的 PermissionData 对象！</span></span><br><span class="line">    PermissionData permissionData = mPermissions.get(permission.name);</span><br><span class="line">    <span class="keyword">if</span> (permissionData == <span class="keyword">null</span>) &#123;</span><br><span class="line">        permissionData = <span class="keyword">new</span> PermissionData(permission);</span><br><span class="line">        mPermissions.put(permission.name, permissionData);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> permissionData;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>可以看到，在 PermissionsState 中有一个 mPermissions 表，保存了 permission.name 和 PermissionData 的映射关系，如果是第一次创建某个权限的 PermissionData，会创建 PermissionData 实例！</p>
<h4 id="9-1-4-1-new-PermissionData"><a href="#9-1-4-1-new-PermissionData" class="headerlink" title="9.1.4.1 new PermissionData"></a>9.1.4.1 new PermissionData</h4><p>创建 PermissionData 对象！</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="class"><span class="keyword">class</span> <span class="title">PermissionData</span> </span>&#123;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> BasePermission mPerm;</span><br><span class="line">    <span class="comment">//【1】用于保存该权限在不同 userId 下的授予情况！</span></span><br><span class="line">    <span class="keyword">private</span> SparseArray&lt;PermissionState&gt; mUserStates = <span class="keyword">new</span> SparseArray&lt;&gt;();</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="title">PermissionData</span><span class="params">(BasePermission perm)</span> </span>&#123;</span><br><span class="line">        mPerm = perm;</span><br><span class="line">    &#125;</span><br><span class="line">    ... ... ... ...</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>创建 PermissionData 对象！</p>
<p>mUserStates 是以 userId 为下标，存储了每个设备用户下该应用的这个权限的状态信息！</p>
<h3 id="9-1-5-PermissionData-grant"><a href="#9-1-5-PermissionData-grant" class="headerlink" title="9.1.5 PermissionData.grant"></a>9.1.5 PermissionData.grant</h3><p>下面我们来看看具体的权限授予过程！<br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">boolean</span> <span class="title">grant</span><span class="params">(<span class="keyword">int</span> userId)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">if</span> (!isCompatibleUserId(userId)) &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">false</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (isGranted(userId)) &#123; <span class="comment">// 如果已经授予，那就返回 false！</span></span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">false</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 获得该权限对应在 userId 下对应的 PermissionState 对象，没有的话就创建新的！</span></span><br><span class="line">    PermissionState userState = mUserStates.get(userId);</span><br><span class="line">    <span class="keyword">if</span> (userState == <span class="keyword">null</span>) &#123;</span><br><span class="line">        userState = <span class="keyword">new</span> PermissionState(mPerm.name);</span><br><span class="line">        mUserStates.put(userId, userState);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// 设置在该 userId 下的权限状态为 true！</span></span><br><span class="line">    userState.mGranted = <span class="keyword">true</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">true</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>首先，判断 userId 的兼容性！</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">boolean</span> <span class="title">isCompatibleUserId</span><span class="params">(<span class="keyword">int</span> userId)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">return</span> isDefault() || !(isInstallPermission() ^ isInstallPermissionKey(userId));</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>userId 要满足兼容性要求，需要至少满足其中之一条件：</p>
<ul>
<li>PermissionData.mUserStates 的大小 &lt;= 0，意味着该权限还没有初始化在该 userId 下的状态！</li>
</ul>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">boolean</span> <span class="title">isDefault</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    <span class="keyword">return</span> mUserStates.size() &lt;= <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<ul>
<li>要么，该权限是安装时权限，同时 userId 只能为 UserHandle.USER_ALL; 要么，该权限不是安装时权限，同时 userId 不能为 UserHandle.USER_ALL;</li>
</ul>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">boolean</span> <span class="title">isInstallPermissionKey</span><span class="params">(<span class="keyword">int</span> userId)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">return</span> userId == UserHandle.USER_ALL;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>对于 isInstallPermission 方法，前面已经分析了，不多说了！</p>
<h2 id="9-2-PermissionsS-revokeInstallPermission-处理不授予情况"><a href="#9-2-PermissionsS-revokeInstallPermission-处理不授予情况" class="headerlink" title="9.2 PermissionsS.revokeInstallPermission  - 处理不授予情况"></a>9.2 PermissionsS.revokeInstallPermission  - 处理不授予情况</h2><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">int</span> <span class="title">revokeInstallPermission</span><span class="params">(BasePermission permission)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">return</span> revokePermission(permission, UserHandle.USER_ALL);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>我们继续看，参数传入;</p>
<ul>
<li>BasePermission permission：权限封装对象</li>
<li>int userId：设备用户，因为是安装时权限，所以对所有设备用户都是一样，这里传入：UserHandle.USER_ALL</li>
</ul>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">int</span> <span class="title">revokePermission</span><span class="params">(BasePermission permission, <span class="keyword">int</span> userId)</span> </span>&#123;</span><br><span class="line">    <span class="comment">//【1】如果没有授予该权限，那就返回 PERMISSION_OPERATION_FAILURE！</span></span><br><span class="line">    <span class="keyword">if</span> (!hasPermission(permission.name, userId)) &#123;</span><br><span class="line">        <span class="keyword">return</span> PERMISSION_OPERATION_FAILURE;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//【2】同样，计算该权限是否有映射 gid，如果有 gid，计算当前 package 持有的权限映射的所有 gid！</span></span><br><span class="line">    <span class="comment">// 保存到 oldGids 中！</span></span><br><span class="line">    <span class="keyword">final</span> <span class="keyword">boolean</span> hasGids = !ArrayUtils.isEmpty(permission.computeGids(userId));</span><br><span class="line">    <span class="keyword">final</span> <span class="keyword">int</span>[] oldGids = hasGids ? computeGids(userId) : NO_GIDS;</span><br><span class="line"></span><br><span class="line">    PermissionData permissionData = mPermissions.get(permission.name);</span><br><span class="line"></span><br><span class="line">    <span class="comment">//【9.2.1】取消权限的授予！</span></span><br><span class="line">    <span class="keyword">if</span> (!permissionData.revoke(userId)) &#123;</span><br><span class="line">        <span class="keyword">return</span> PERMISSION_OPERATION_FAILURE;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//【9.2.2】如果该权限在所有设备用户下均没有授予该 package，即 mUserStates.size() &lt;= 0；</span></span><br><span class="line">    <span class="comment">// 那么我们要移除该权限！</span></span><br><span class="line">    <span class="keyword">if</span> (permissionData.isDefault()) &#123;</span><br><span class="line">        ensureNoPermissionData(permission.name);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//【3】这里是比较，在撤销安装时权限后，该 package 所持有的 gid 是否发生变化！</span></span><br><span class="line">    <span class="keyword">if</span> (hasGids) &#123;</span><br><span class="line">        <span class="keyword">final</span> <span class="keyword">int</span>[] newGids = computeGids(userId);</span><br><span class="line">        <span class="keyword">if</span> (oldGids.length != newGids.length) &#123;</span><br><span class="line">            <span class="keyword">return</span> PERMISSION_OPERATION_SUCCESS_GIDS_CHANGED;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> PERMISSION_OPERATION_SUCCESS;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>撤销安装时权限的过程，和授予有很多类似的地方，我们重点看那些不同的地方！</p>
<h3 id="9-2-1-PermissionData-revoke"><a href="#9-2-1-PermissionData-revoke" class="headerlink" title="9.2.1 PermissionData.revoke"></a>9.2.1 PermissionData.revoke</h3><p>接下来看看安装时权限撤销的过程！<br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">boolean</span> <span class="title">revoke</span><span class="params">(<span class="keyword">int</span> userId)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">if</span> (!isCompatibleUserId(userId)) &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">false</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// 如果权限还没有被授予，无法撤销！</span></span><br><span class="line">    <span class="keyword">if</span> (!isGranted(userId)) &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">false</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">//【1】将权限在该 userId 下的状态设置为非授予的情况！</span></span><br><span class="line">    PermissionState userState = mUserStates.get(userId);</span><br><span class="line">    userState.mGranted = <span class="keyword">false</span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 如果该权限恢复了默认状态，从 mUserStates 中移除掉它！</span></span><br><span class="line">    <span class="keyword">if</span> (userState.isDefault()) &#123;</span><br><span class="line">        mUserStates.remove(userId);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">true</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<h3 id="9-2-2-PermissionsS-ensureNoPermissionData"><a href="#9-2-2-PermissionsS-ensureNoPermissionData" class="headerlink" title="9.2.2 PermissionsS.ensureNoPermissionData"></a>9.2.2 PermissionsS.ensureNoPermissionData</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">ensureNoPermissionData</span><span class="params">(String name)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">if</span> (mPermissions == <span class="keyword">null</span>) &#123;</span><br><span class="line">        <span class="keyword">return</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    mPermissions.remove(name);</span><br><span class="line">    <span class="keyword">if</span> (mPermissions.isEmpty()) &#123;</span><br><span class="line">        mPermissions = <span class="keyword">null</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>ensureNoPermissionData 用于从当前的 package 中移除该权限数据！</p>
<h2 id="9-3-PermissionsS-updatePermissionFlags-更新权限标志位"><a href="#9-3-PermissionsS-updatePermissionFlags-更新权限标志位" class="headerlink" title="9.3 PermissionsS.updatePermissionFlags  - 更新权限标志位"></a>9.3 PermissionsS.updatePermissionFlags  - 更新权限标志位</h2><p>当 revokeInstallPermission 或者 grantInstallPermission 方法返回的是 PERMISSION_OPERATION_SUCCESS_GIDS_CHANGED 或者 PERMISSION_OPERATION_SUCCESS 的时候，我们需要更新权限的标志位！</p>
<p>参数传递：</p>
<ul>
<li>userId 传入的是 UserHandle.USER_ALL；</li>
<li>flagMask 传入的是 PackageManager.MASK_PERMISSION_FLAGS，取值为 0xFF，转为二进制就是 11111</li>
<li>flagValues 则是解析上次安装信息时，解析该 package 的 perms 标签时，每一个权限的 flags！</li>
</ul>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">boolean</span> <span class="title">updatePermissionFlags</span><span class="params">(BasePermission permission, <span class="keyword">int</span> userId,</span></span></span><br><span class="line"><span class="function"><span class="params">        <span class="keyword">int</span> flagMask, <span class="keyword">int</span> flagValues)</span> </span>&#123;</span><br><span class="line">    enforceValidUserId(userId);</span><br><span class="line">  </span><br><span class="line">    <span class="keyword">final</span> <span class="keyword">boolean</span> mayChangeFlags = flagValues != <span class="number">0</span> || flagMask != <span class="number">0</span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//【1】如果 mPermissions 为 null，且需要更新 flags，那么会初始化 mPermissions，将 permission 添加进入！</span></span><br><span class="line">    <span class="keyword">if</span> (mPermissions == <span class="keyword">null</span>) &#123;</span><br><span class="line">        <span class="keyword">if</span> (!mayChangeFlags) &#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="keyword">false</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        ensurePermissionData(permission);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">//【2】如果该权限 permission 没有对应的 PermissionData，且需要更新 flags，那么我们会创建 PermissionData 添加！</span></span><br><span class="line">    PermissionData permissionData = mPermissions.get(permission.name);</span><br><span class="line">    <span class="keyword">if</span> (permissionData == <span class="keyword">null</span>) &#123;</span><br><span class="line">        <span class="keyword">if</span> (!mayChangeFlags) &#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="keyword">false</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        permissionData = ensurePermissionData(permission);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//【3】获得该权限的旧的 flags，用于后续对比！</span></span><br><span class="line">    <span class="keyword">final</span> <span class="keyword">int</span> oldFlags = permissionData.getFlags(userId);</span><br><span class="line"> </span><br><span class="line">    <span class="comment">//【9.3.1】更新权限标志位！</span></span><br><span class="line">    <span class="keyword">final</span> <span class="keyword">boolean</span> updated = permissionData.updateFlags(userId, flagMask, flagValues);</span><br><span class="line"></span><br><span class="line">    <span class="comment">//【4】如果权限的状态发生了变化，那就判断是否需要重新申请！</span></span><br><span class="line">    <span class="keyword">if</span> (updated) &#123;</span><br><span class="line">        <span class="keyword">final</span> <span class="keyword">int</span> newFlags = permissionData.getFlags(userId);</span><br><span class="line">        <span class="keyword">if</span> ((oldFlags &amp; PackageManager.FLAG_PERMISSION_REVIEW_REQUIRED) == <span class="number">0</span></span><br><span class="line">                &amp;&amp; (newFlags &amp; PackageManager.FLAG_PERMISSION_REVIEW_REQUIRED) != <span class="number">0</span>) &#123;</span><br><span class="line">            <span class="keyword">if</span> (mPermissionReviewRequired == <span class="keyword">null</span>) &#123;</span><br><span class="line">                mPermissionReviewRequired = <span class="keyword">new</span> SparseBooleanArray();</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="comment">//【4.1】如果在该 userId 下需要重新申请，那么就将其添加到 mPermissionReviewRequired 中！</span></span><br><span class="line">            mPermissionReviewRequired.put(userId, <span class="keyword">true</span>);</span><br><span class="line">        &#125; <span class="keyword">else</span> <span class="keyword">if</span> ((oldFlags &amp; PackageManager.FLAG_PERMISSION_REVIEW_REQUIRED) != <span class="number">0</span></span><br><span class="line">                &amp;&amp; (newFlags &amp; PackageManager.FLAG_PERMISSION_REVIEW_REQUIRED) == <span class="number">0</span>) &#123;</span><br><span class="line">            <span class="comment">//【4.2】如果在该 userId 下不需要重新申请，那么就将其从 mPermissionReviewRequired 中移除！</span></span><br><span class="line">            <span class="keyword">if</span> (mPermissionReviewRequired != <span class="keyword">null</span>) &#123;</span><br><span class="line">                mPermissionReviewRequired.delete(userId);</span><br><span class="line">                <span class="keyword">if</span> (mPermissionReviewRequired.size() &lt;= <span class="number">0</span>) &#123;</span><br><span class="line">                    mPermissionReviewRequired = <span class="keyword">null</span>;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> updated;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>对于 mayChangeFlags，由于我们 flagMask 传入的是 PackageManager.MASK_PERMISSION_FLAGS，那就意味了需要更新 flags！</p>
<p>可以看到，如果 mayChangeFlags 为 true 的话，即使没有权限对应的 PermissionData 也会创建，因为这次会更新 flags！</p>
<p>PermissionData.getFlags 方法会获得权限旧的 flags！</p>
<p>重点的操作在 PermissionData.updateFlag 方法中：</p>
<h3 id="9-3-1-PermissionData-updateFlags"><a href="#9-3-1-PermissionData-updateFlags" class="headerlink" title="9.3.1 PermissionData.updateFlags"></a>9.3.1 PermissionData.updateFlags</h3><p>更新指定权限的 flags，flagValues 是本次解析获得的 flags！！</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">boolean</span> <span class="title">updateFlags</span><span class="params">(<span class="keyword">int</span> userId, <span class="keyword">int</span> flagMask, <span class="keyword">int</span> flagValues)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">if</span> (isInstallPermission()) &#123; <span class="comment">// 如果是安装时权限，那么 userId 为 UserHandle.USER_ALL;</span></span><br><span class="line">        userId = UserHandle.USER_ALL;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span> (!isCompatibleUserId(userId)) &#123; <span class="comment">// 如果 userId 不兼容，那么会直接返回！</span></span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">false</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">//【1】这里进行 &amp; 操作，保留了 flagValues 和 flagMask 相同的位！</span></span><br><span class="line">    <span class="keyword">final</span> <span class="keyword">int</span> newFlags = flagValues &amp; flagMask;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">//【2】获得该 userId 下的权限状态值！</span></span><br><span class="line">    PermissionState userState = mUserStates.get(userId);</span><br><span class="line">    <span class="keyword">if</span> (userState != <span class="keyword">null</span>) &#123;</span><br><span class="line">        <span class="keyword">final</span> <span class="keyword">int</span> oldFlags = userState.mFlags;</span><br><span class="line">        <span class="comment">// 取消旧的 flags，设置新的 flags！</span></span><br><span class="line">        userState.mFlags = (userState.mFlags &amp; ~flagMask) | newFlags;</span><br><span class="line">        <span class="keyword">if</span> (userState.isDefault()) &#123;</span><br><span class="line">            mUserStates.remove(userId);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">// 判断 flags 是否发生变化，如果发生了变化，那就返回 true！</span></span><br><span class="line">        <span class="keyword">return</span> userState.mFlags != oldFlags;</span><br><span class="line">    &#125; <span class="keyword">else</span> <span class="keyword">if</span> (newFlags != <span class="number">0</span>) &#123;</span><br><span class="line">        <span class="comment">// 如果该权限在该 userId 下没有状态信息，那就创建状态信息，直接设置新的 flags，返回 true！</span></span><br><span class="line">        userState = <span class="keyword">new</span> PermissionState(mPerm.name);</span><br><span class="line">        userState.mFlags = newFlags;</span><br><span class="line">        mUserStates.put(userId, userState);</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">true</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">false</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>这里有一个操作：</p>
<ul>
<li>首先，进行 &amp; 操作，保留了 flagValues 和 flagMask 相同的位，为 newFlags；</li>
<li>接着，userState.mFlags 表示旧的 flags，这里在 userState.mFlags 和 ~flagMask 中做了 &amp; 操作，等价于取了 userState.mFlags 和 flagMask 不同的位，然后加上 newFlags，作为新的 flags！</li>
</ul>
<h1 id="10-阶段总结"><a href="#10-阶段总结" class="headerlink" title="10 阶段总结"></a>10 阶段总结</h1><p>在这个阶段，PMS 主要完成了如下了几个过程：</p>
<p>一、解析 SystemConfig 系统配置，主要会解析一下系统属性：</p>
<p>1、group：系统中定义的 gid，保存到了 SystemConfig.mGlobalGids 中！</p>
<p>2、permission：系统权限，每一个权限都创建一个 PermissionEntry，保存到 SystemConfig.mPermissions 中；<br>               PermissionEntry 有如下属性：name 权限名：perUser：表示该权限的 gid 是否针对不同的 userId 做调整；gids：该权限所属 gid</p>
<p>3、assign-permission：系统 uid 和其具有的权限，保存到了 SystemConfig.mSystemPermissions 中！每一个 uid 都对应一个或多个权限；</p>
<p>4、library：共享库信息，保存到了 SystemConfig.mSharedLibraries 中！</p>
<p>5、feature：特性信息，保存到了 SystemConfig.mAvailableFeatures 和 SystemConfig.mUnavailableFeatures 中！</p>
<p>这里我们重点看一些属性的解析，其他的属性我们先不关注！</p>
<p>然后将 SystemConfig 中的一些解析结果保存到 Settings 中：</p>
<p>Settings.mGlobalGids = systemConfig.getGlobalGids();<br>Settings.mSystemPermissions = systemConfig.getSystemPermissions();<br>Settings.mAvailableFeatures = systemConfig.getAvailableFeatures();</p>
<p>接着处理 SystemConfig.mPermissions 中解析到的系统权限！</p>
<p>对于每一个 PermissionEntry 创建一个 BasePermission 对象：<br>    在创建时会设置 BasePermission.name 为权限名；<br>    设置 BasePermission.sourcePackage 为定义权限的源包，因为是系统权限，所以为 android；<br>    设置 BasePermission.type 权限类型为 BasePermission.TYPE_BUILTIN；<br>    设置 BasePermission.protectionLevel 权限级别默认为 PermissionInfo.PROTECTION_SIGNATURE;</p>
<p>同时会设置 BasePermission.perUser 为 PermissionEntry.perUser；<br>同时会设置 BasePermission.gids 为 PermissionEntry.gids；</p>
<p>最后新创建的 BasePermission，会添加到 Settings.mPermissions 集合中！</p>
<p>二、读取上一次的安装信息！</p>
</div><hr></div><div class="recent-post-item article-container"><a class="article-title" href="/2018/01/03/PMS 第 1 篇 - PackageManagerService 初始化/">PMS 第 1 篇 - PackageManagerService 初始化</a><time class="post-meta__date"><i class="fa fa-calendar" aria-hidden="true"></i> 2018-01-03</time><span class="article-meta"><span class="article-meta__separator">|</span><i class="fa fa-inbox article-meta__icon" aria-hidden="true"></i><a class="article-meta__categories" href="/categories/AndroidFramework源码分析/">AndroidFramework源码分析</a><i class="fa fa-angle-right" aria-hidden="true"></i><i class="fa fa-inbox article-meta__icon" aria-hidden="true"></i><a class="article-meta__categories" href="/categories/AndroidFramework源码分析/PackageManager包管理/">PackageManager包管理</a></span><span class="article-meta tags"><span class="article-meta__separator">|</span><i class="fa fa-tag article-meta__icon" aria-hidden="true"></i><a class="article-meta__tags" href="/tags/PackageManager包管理/">PackageManager包管理</a></span><div class="content"><p>[toc]</p>
<p>本文基于 Android 7.1.1 系统源码，分析 PackageManagerService 的架构和主要业务实现，本文是作者原创，转载请说明出处！</p>
<h1 id="前言"><a href="#前言" class="headerlink" title="前言"></a>前言</h1><p>PMS 用来管理所有的 package 信息，包括安装、卸载、更新以及解析 AndroidManifest.xml 以组织相应的数据结构，这些数据结构将会被 其他 service 和 application 使用到。</p>
<h1 id="1-PMS-的启动"><a href="#1-PMS-的启动" class="headerlink" title="1 PMS 的启动"></a>1 PMS 的启动</h1><p>先来看 SystemServer 中 PackageManagerService 的启动代码：<br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 这里的 installer 也是一个系统服务</span></span><br><span class="line">mPackageManagerService = PackageManagerService.main(mSystemContext, installer, </span><br><span class="line">                                                    mFactoryTestMode != FactoryTest.FACTORY_TEST_OFF, mOnlyCore);</span><br><span class="line">mFirstBoot = mPackageManagerService.isFirstBoot();</span><br><span class="line">mPackageManager = mSystemContext.getPackageManager();</span><br></pre></td></tr></table></figure></p>
<p>main 函数很简单，只有短短几行代码，执行时间却较长，主要原因是 PKMS 在其构造函数中做了很多“重体力活”，这也是 Android 启动速度慢的主要原因之一。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 先来看看PackageManangerService的main方法：</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">static</span> PackageManagerService <span class="title">main</span><span class="params">(Context context, Installer installer,</span></span></span><br><span class="line"><span class="function"><span class="params">        <span class="keyword">boolean</span> factoryTest, <span class="keyword">boolean</span> onlyCore)</span> </span>&#123;</span><br><span class="line">    <span class="comment">// Self-check for initial settings.</span></span><br><span class="line">    PackageManagerServiceCompilerMapping.checkProperties();</span><br><span class="line"></span><br><span class="line">    PackageManagerService m = <span class="keyword">new</span> PackageManagerService(context, installer,</span><br><span class="line">            factoryTest, onlyCore);</span><br><span class="line">    m.enableSystemUserPackages();</span><br><span class="line">    ServiceManager.addService(<span class="string">"package"</span>, m);</span><br><span class="line">    <span class="keyword">return</span> m;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>首先构造一个 PMS 对象，然后调用 ServiceManager 的 addService 注册 PackageManagerService 服务。</p>
<p>构造函数有如下 4 个参数：</p>
<ul>
<li>第一个参数：系统进程的上下文实例；</li>
<li>第二个参数：Installer 对象，用于和 Installd 通信使用，我们后面分析 Installd 再来介绍；</li>
<li>第三个参数：factoryTest 为出厂测试，默认为 false；</li>
<li>第四个参数：onlyCore 表示是否只加载核心的应用，默认也为 false。</li>
</ul>
<h1 id="2-PMS-的初始化"><a href="#2-PMS-的初始化" class="headerlink" title="2 PMS 的初始化"></a>2 PMS 的初始化</h1><p>PackageManagerService 的构造器代码结构如下：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="title">PackageManagerService</span><span class="params">(Context context, Installer installer,</span></span></span><br><span class="line"><span class="function"><span class="params">        <span class="keyword">boolean</span> factoryTest, <span class="keyword">boolean</span> onlyCore)</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    EventLog.writeEvent(EventLogTags.BOOT_PROGRESS_PMS_START, SystemClock.uptimeMillis());</span><br><span class="line"></span><br><span class="line">    ...</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">synchronized</span> (mInstallLock) &#123;</span><br><span class="line">        <span class="keyword">synchronized</span> (mPackages) &#123;</span><br><span class="line">            </span><br><span class="line">            ...</span><br><span class="line">            </span><br><span class="line">            EventLog.writeEvent(EventLogTags.BOOT_PROGRESS_PMS_SYSTEM_SCAN_START, startTime);</span><br><span class="line">            </span><br><span class="line">            ...</span><br><span class="line">            </span><br><span class="line">            <span class="keyword">if</span> (!mOnlyCore) &#123;</span><br><span class="line">                EventLog.writeEvent(EventLogTags.BOOT_PROGRESS_PMS_DATA_SCAN_START, SystemClock.uptimeMillis());</span><br><span class="line">            </span><br><span class="line">            &#125;</span><br><span class="line">            </span><br><span class="line">            ...</span><br><span class="line">            </span><br><span class="line">            EventLog.writeEvent(EventLogTags.BOOT_PROGRESS_PMS_SCAN_END, SystemClock.uptimeMillis());</span><br><span class="line">            </span><br><span class="line">            ...</span><br><span class="line">            </span><br><span class="line">            EventLog.writeEvent(EventLogTags.BOOT_PROGRESS_PMS_READY, SystemClock.uptimeMillis());</span><br><span class="line">            </span><br><span class="line">            ...</span><br><span class="line">        &#125; </span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    Runtime.getRuntime().gc();</span><br><span class="line"></span><br><span class="line">    LocalServices.addService(PackageManagerInternal.class, <span class="keyword">new</span> PackageManagerInternalImpl());</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>我们根据 EventLog 可以将 PMS 的初始化分为以下几个过程：</p>
<ul>
<li>阶段1：BOOT_PROGRESS_PMS_START</li>
<li>阶段2：BOOT_PROGRESS_PMS_SYSTEM_SCAN_START</li>
<li>阶段3：BOOT_PROGRESS_PMS_DATA_SCAN_START</li>
<li>阶段4：BOOT_PROGRESS_PMS_SCAN_END</li>
<li>阶段5：BOOT_PROGRESS_PMS_READY</li>
</ul>
<p>下面，来看看 PackageManangerService 的构造器方法代码，为了便于分析，我们把 PackageManagerService 构造器的代码分为如下几个部分：</p>
<h2 id="2-1-PMS-START"><a href="#2-1-PMS-START" class="headerlink" title="2.1 PMS_START"></a><strong>2.1 PMS_START</strong></h2><p>这个的阶段的代码，如下 ：<br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="title">PackageManagerService</span><span class="params">(Context context, Installer installer,</span></span></span><br><span class="line"><span class="function"><span class="params">     <span class="keyword">boolean</span> factoryTest, <span class="keyword">boolean</span> onlyCore)</span> </span>&#123;</span><br><span class="line"> EventLog.writeEvent(EventLogTags.BOOT_PROGRESS_PMS_START,</span><br><span class="line">         SystemClock.uptimeMillis());</span><br><span class="line"></span><br><span class="line"> <span class="keyword">if</span> (mSdkVersion &lt;= <span class="number">0</span>) &#123;</span><br><span class="line">     <span class="comment">//【1】mSdkVersion 是 PKMS 的成员变量，定义的时候进行赋值，</span></span><br><span class="line">     <span class="comment">// 其值取自系统属性“ro.build.version.sdk”，即编译的 SDK 版本。</span></span><br><span class="line">     Slog.w(TAG, <span class="string">"**** ro.build.version.sdk not set!"</span>);</span><br><span class="line"> &#125;</span><br><span class="line"></span><br><span class="line"> mContext = context;</span><br><span class="line"> mFactoryTest = factoryTest; <span class="comment">// 默认为 false，即运行在非工厂模式下</span></span><br><span class="line"> mOnlyCore = onlyCore; <span class="comment">// 默认为 false,标记是否是只加载核心服务</span></span><br><span class="line"> </span><br><span class="line"> <span class="comment">//【2】用于存储与显示屏相关的一些属性，例如屏幕的宽 / 高尺寸，分辨率等信息。</span></span><br><span class="line"> mMetrics = <span class="keyword">new</span> DisplayMetrics(); </span><br><span class="line"></span><br><span class="line"> <span class="comment">//【3】在 Settings 中，创建 packages.xml、packages-backup.xml、packages.list 等文件对象</span></span><br><span class="line"> <span class="comment">// 并添加 system, phone, log, nfc, bluetooth, shell 这六种 shareUserId 到 mSettings，后面扫描和安装有用！</span></span><br><span class="line"> mSettings = <span class="keyword">new</span> Settings(mPackages);</span><br><span class="line"> mSettings.addSharedUserLPw(<span class="string">"android.uid.system"</span>, Process.SYSTEM_UID,</span><br><span class="line">         ApplicationInfo.FLAG_SYSTEM, ApplicationInfo.PRIVATE_FLAG_PRIVILEGED);</span><br><span class="line"> mSettings.addSharedUserLPw(<span class="string">"android.uid.phone"</span>, RADIO_UID,</span><br><span class="line">         ApplicationInfo.FLAG_SYSTEM, ApplicationInfo.PRIVATE_FLAG_PRIVILEGED);</span><br><span class="line"> mSettings.addSharedUserLPw(<span class="string">"android.uid.log"</span>, LOG_UID,</span><br><span class="line">         ApplicationInfo.FLAG_SYSTEM, ApplicationInfo.PRIVATE_FLAG_PRIVILEGED);</span><br><span class="line"> mSettings.addSharedUserLPw(<span class="string">"android.uid.nfc"</span>, NFC_UID,</span><br><span class="line">         ApplicationInfo.FLAG_SYSTEM, ApplicationInfo.PRIVATE_FLAG_PRIVILEGED);</span><br><span class="line"> mSettings.addSharedUserLPw(<span class="string">"android.uid.bluetooth"</span>, BLUETOOTH_UID,</span><br><span class="line">         ApplicationInfo.FLAG_SYSTEM, ApplicationInfo.PRIVATE_FLAG_PRIVILEGED);</span><br><span class="line"> mSettings.addSharedUserLPw(<span class="string">"android.uid.shell"</span>, SHELL_UID,</span><br><span class="line">         ApplicationInfo.FLAG_SYSTEM, ApplicationInfo.PRIVATE_FLAG_PRIVILEGED);</span><br><span class="line"></span><br><span class="line"> String separateProcesses = SystemProperties.get(<span class="string">"debug.separate_processes"</span>);</span><br><span class="line"> <span class="keyword">if</span> (separateProcesses != <span class="keyword">null</span> &amp;&amp; separateProcesses.length() &gt; <span class="number">0</span>) &#123;</span><br><span class="line">     <span class="keyword">if</span> (<span class="string">"*"</span>.equals(separateProcesses)) &#123;</span><br><span class="line">         mDefParseFlags = PackageParser.PARSE_IGNORE_PROCESSES;</span><br><span class="line">         mSeparateProcesses = <span class="keyword">null</span>;</span><br><span class="line">         Slog.w(TAG, <span class="string">"Running with debug.separate_processes: * (ALL)"</span>);</span><br><span class="line">     &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">         mDefParseFlags = <span class="number">0</span>;</span><br><span class="line">         mSeparateProcesses = separateProcesses.split(<span class="string">","</span>);</span><br><span class="line">         Slog.w(TAG, <span class="string">"Running with debug.separate_processes: "</span></span><br><span class="line">                 + separateProcesses);</span><br><span class="line">     &#125;</span><br><span class="line"> &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">     mDefParseFlags = <span class="number">0</span>;</span><br><span class="line">     mSeparateProcesses = <span class="keyword">null</span>;</span><br><span class="line"> &#125;</span><br><span class="line"></span><br><span class="line"> <span class="comment">//【3】初始化 mInstaller 对象，installer 对象和 Native 进程 installd 交互！</span></span><br><span class="line"> mInstaller = installer;</span><br><span class="line"> </span><br><span class="line"> <span class="comment">//【4】创建 PackageDexOptimizer 对象，用于 dex 优化！</span></span><br><span class="line"> mPackageDexOptimizer = <span class="keyword">new</span> PackageDexOptimizer(installer, mInstallLock, context,</span><br><span class="line">         <span class="string">"*dexopt*"</span>);</span><br><span class="line">         </span><br><span class="line"> <span class="comment">//【5】创建 MoveCallbacks 对象，用于操作回滚！</span></span><br><span class="line"> mMoveCallbacks = <span class="keyword">new</span> MoveCallbacks(FgThread.get().getLooper());</span><br><span class="line"> </span><br><span class="line"> <span class="comment">//【6】创建 OnPermissionChangeListeners 对象，用于监听权限改变！</span></span><br><span class="line"> mOnPermissionChangeListeners = <span class="keyword">new</span> OnPermissionChangeListeners(</span><br><span class="line">         FgThread.get().getLooper());</span><br><span class="line"></span><br><span class="line"> getDefaultDisplayMetrics(context, mMetrics); <span class="comment">// 获得默认的显示</span></span><br><span class="line"></span><br><span class="line"> <span class="comment">//【7】创建 SystemConfig 对象，用于获取系统配置信息</span></span><br><span class="line"> <span class="comment">// 主要有 /system/etc/ 目录和 /system/etc/sysconfig 目录下的 sysconfig 和 permissions 文件夹xml文件</span></span><br><span class="line"> SystemConfig systemConfig = SystemConfig.getInstance();</span><br><span class="line"> mGlobalGids = systemConfig.getGlobalGids();</span><br><span class="line"> mSystemPermissions = systemConfig.getSystemPermissions();</span><br><span class="line"> mAvailableFeatures = systemConfig.getAvailableFeatures();</span><br><span class="line"></span><br><span class="line"> mProtectedPackages = <span class="keyword">new</span> ProtectedPackages(mContext);</span><br><span class="line"></span><br><span class="line"> <span class="keyword">synchronized</span> (mInstallLock) &#123;</span><br><span class="line"> <span class="comment">// writer</span></span><br><span class="line"> <span class="keyword">synchronized</span> (mPackages) &#123;</span><br><span class="line"> </span><br><span class="line">     <span class="comment">//【8】建立并启动一个名为 “PackageManager” 的 HandlerThread，类型是 ServiceThread，处理安装卸载的消息！</span></span><br><span class="line">     mHandlerThread = <span class="keyword">new</span> ServiceThread(TAG,</span><br><span class="line">             Process.THREAD_PRIORITY_BACKGROUND, <span class="keyword">true</span> <span class="comment">/*allowIo*/</span>);</span><br><span class="line">     mHandlerThread.start();</span><br><span class="line">     </span><br><span class="line">     <span class="comment">//【9】创建一个 PackageHandler 对象，绑定前面创建的 HandlerThread！</span></span><br><span class="line">     mHandler = <span class="keyword">new</span> PackageHandler(mHandlerThread.getLooper());</span><br><span class="line">     mProcessLoggingHandler = <span class="keyword">new</span> ProcessLoggingHandler();</span><br><span class="line">     Watchdog.getInstance().addThread(mHandler, WATCHDOG_TIMEOUT);</span><br><span class="line"></span><br><span class="line">     <span class="comment">//【10】创建 DefaultPermissionGrantPolicy 对象，用于给某些预制的apk，给予权限,也可以撤销</span></span><br><span class="line">     mDefaultPermissionPolicy = <span class="keyword">new</span> DefaultPermissionGrantPolicy(<span class="keyword">this</span>);</span><br><span class="line">     </span><br><span class="line">     <span class="comment">//【11】创建需要扫描检测的目录文件对象，为扫描做准备！</span></span><br><span class="line">     File dataDir = Environment.getDataDirectory();</span><br><span class="line">     mAppInstallDir = <span class="keyword">new</span> File(dataDir, <span class="string">"app"</span>); <span class="comment">// 目录 /data/data，存放应用程序的数据；</span></span><br><span class="line">     mAppLib32InstallDir = <span class="keyword">new</span> File(dataDir, <span class="string">"app-lib"</span>);  <span class="comment">// 目录 /data/app-lib；</span></span><br><span class="line">     mEphemeralInstallDir = <span class="keyword">new</span> File(dataDir, <span class="string">"app-ephemeral"</span>);  <span class="comment">// 目录 /data/app-ephemeral；</span></span><br><span class="line">     mAsecInternalPath = <span class="keyword">new</span> File(dataDir, <span class="string">"app-asec"</span>).getPath();  <span class="comment">// 目录 /data/app-asec；</span></span><br><span class="line">     mDrmAppPrivateInstallDir = <span class="keyword">new</span> File(dataDir, <span class="string">"app-private"</span>);  <span class="comment">// 目录 /data/app-private，私有应用程序！</span></span><br><span class="line">         </span><br><span class="line">     <span class="comment">//【11】创建用户管理服务！    </span></span><br><span class="line">     sUserManager = <span class="keyword">new</span> UserManagerService(context, <span class="keyword">this</span>, mPackages);</span><br><span class="line"></span><br><span class="line">     <span class="comment">//【12】获得权限信息！</span></span><br><span class="line">     ArrayMap&lt;String, SystemConfig.PermissionEntry&gt; permConfig</span><br><span class="line">             = systemConfig.getPermissions();</span><br><span class="line">     <span class="keyword">for</span> (<span class="keyword">int</span> i=<span class="number">0</span>; i &lt; permConfig.size(); i++) &#123;</span><br><span class="line">         SystemConfig.PermissionEntry perm = permConfig.valueAt(i);</span><br><span class="line">         BasePermission bp = mSettings.mPermissions.get(perm.name);</span><br><span class="line"></span><br><span class="line">         <span class="keyword">if</span> (bp == <span class="keyword">null</span>) &#123;</span><br><span class="line">             bp = <span class="keyword">new</span> BasePermission(perm.name, <span class="string">"android"</span>, BasePermission.TYPE_BUILTIN);</span><br><span class="line">             mSettings.mPermissions.put(perm.name, bp);</span><br><span class="line">         &#125;</span><br><span class="line"></span><br><span class="line">         <span class="keyword">if</span> (perm.gids != <span class="keyword">null</span>) &#123;</span><br><span class="line">             bp.setGids(perm.gids, perm.perUser);</span><br><span class="line">         &#125;</span><br><span class="line">     &#125;</span><br><span class="line"></span><br><span class="line">     <span class="comment">//【13】处理共享库！</span></span><br><span class="line">     ArrayMap&lt;String, String&gt; libConfig = systemConfig.getSharedLibraries();</span><br><span class="line">     <span class="keyword">for</span> (<span class="keyword">int</span> i=<span class="number">0</span>; i&lt;libConfig.size(); i++) &#123;</span><br><span class="line">         mSharedLibraries.put(libConfig.keyAt(i),</span><br><span class="line">                 <span class="keyword">new</span> SharedLibraryEntry(libConfig.valueAt(i), <span class="keyword">null</span>));</span><br><span class="line">     &#125;</span><br><span class="line"></span><br><span class="line">     mFoundPolicyFile = SELinuxMMAC.readInstallPolicy();</span><br><span class="line">     </span><br><span class="line">     <span class="comment">// 判断是否是第一次开机！</span></span><br><span class="line">     <span class="comment">// 并获得上一次的安装信息！</span></span><br><span class="line">     mFirstBoot = !mSettings.readLPw(sUserManager.getUsers(<span class="keyword">false</span>));</span><br><span class="line"></span><br><span class="line">     <span class="comment">// 移除哪些 codePath 无效的 Package，恢复处于 system 目录下的同名 package</span></span><br><span class="line">     <span class="keyword">final</span> <span class="keyword">int</span> packageSettingCount = mSettings.mPackages.size();</span><br><span class="line">     <span class="keyword">for</span> (<span class="keyword">int</span> i = packageSettingCount - <span class="number">1</span>; i &gt;= <span class="number">0</span>; i--) &#123;</span><br><span class="line">         PackageSetting ps = mSettings.mPackages.valueAt(i);</span><br><span class="line"></span><br><span class="line">         <span class="keyword">if</span> (!isExternal(ps) &amp;&amp; (ps.codePath == <span class="keyword">null</span> || !ps.codePath.exists())</span><br><span class="line">                 &amp;&amp; mSettings.getDisabledSystemPkgLPr(ps.name) != <span class="keyword">null</span>) &#123;</span><br><span class="line">             mSettings.mPackages.removeAt(i);</span><br><span class="line">             mSettings.enableSystemPackageLPw(ps.name);</span><br><span class="line">         &#125;</span><br><span class="line">     &#125;</span><br><span class="line"></span><br><span class="line">     <span class="keyword">if</span> (mFirstBoot) &#123;</span><br><span class="line">         <span class="comment">// 如果是第一次开机，从另外一个系统拷贝 odex 文件到当前系统的 data 分区</span></span><br><span class="line">         <span class="comment">// Android 7.1 引进了 AB 升级，这个是 AB 升级的特性，可以先不看！</span></span><br><span class="line">         requestCopyPreoptedFiles();</span><br><span class="line">     &#125;</span><br><span class="line"></span><br><span class="line">     String customResolverActivity = Resources.getSystem().getString(</span><br><span class="line">             R.string.config_customResolverActivity);</span><br><span class="line">     <span class="keyword">if</span> (TextUtils.isEmpty(customResolverActivity)) &#123;</span><br><span class="line">         customResolverActivity = <span class="keyword">null</span>;</span><br><span class="line">     &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">         mCustomResolverComponentName = ComponentName.unflattenFromString(</span><br><span class="line">                 customResolverActivity);</span><br><span class="line">     &#125;</span><br><span class="line">      </span><br><span class="line">     ... ... ... ...<span class="comment">// 见，第二阶段</span></span><br></pre></td></tr></table></figure></p>
<p>第一阶段，主要是做一些初始化工作，为后续的扫描做准备！</p>
<h3 id="1-2-1-主要流程"><a href="#1-2-1-主要流程" class="headerlink" title="1.2.1 主要流程"></a><strong>1.2.1 主要流程</strong></h3><ul>
<li>创建 Settings 对象，创建 packages.xml、packages-backup.xml、packages.list 等文件对象并添加 system, phone, log, nfc, bluetooth, shell 这六种 shareUserId 到 mSettings，后面扫描和安装有用；</li>
<li>初始化 mInstaller 对象，用于和 installed 交互；</li>
<li>创建 PackageDexOptimizer 对象，用于 dex 优化；</li>
<li>创建 OnPermissionChangeListeners 对象，用于监听权限改变；</li>
<li>创建 SystemConfig 对象，用于获取系统配置信息；</li>
<li>创建用户管理服务！  </li>
<li>获得权限信息！</li>
<li>获得系统共享库！</li>
</ul>
<h2 id="2-2-PMS-SYSTEM-SCAN-START"><a href="#2-2-PMS-SYSTEM-SCAN-START" class="headerlink" title="2.2 PMS_SYSTEM_SCAN_START"></a><strong>2.2 PMS_SYSTEM_SCAN_START</strong></h2><p>下面是系统扫描阶段：<br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br><span class="line">212</span><br><span class="line">213</span><br><span class="line">214</span><br><span class="line">215</span><br><span class="line">216</span><br><span class="line">217</span><br><span class="line">218</span><br><span class="line">219</span><br><span class="line">220</span><br><span class="line">221</span><br><span class="line">222</span><br><span class="line">223</span><br><span class="line">224</span><br><span class="line">225</span><br><span class="line">226</span><br><span class="line">227</span><br><span class="line">228</span><br><span class="line">229</span><br><span class="line">230</span><br><span class="line">231</span><br></pre></td><td class="code"><pre><span class="line">... ... ... ...<span class="comment">// 接上面</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">long</span> startTime = SystemClock.uptimeMillis();</span><br><span class="line"> </span><br><span class="line">EventLog.writeEvent(EventLogTags.BOOT_PROGRESS_PMS_SYSTEM_SCAN_START,</span><br><span class="line">        startTime);</span><br><span class="line"></span><br><span class="line"><span class="comment">// Set flag to monitor and not change apk file paths when</span></span><br><span class="line"><span class="comment">// scanning install directories.</span></span><br><span class="line"><span class="comment">// 设置扫描参数！</span></span><br><span class="line"><span class="keyword">final</span> <span class="keyword">int</span> scanFlags = SCAN_NO_PATHS | SCAN_DEFER_DEX | SCAN_BOOTING | SCAN_INITIAL;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 获得环境变量：BOOTCLASSPATH 和 SYSTEMSERVERCLASSPATH！</span></span><br><span class="line"><span class="keyword">final</span> String bootClassPath = System.getenv(<span class="string">"BOOTCLASSPATH"</span>);</span><br><span class="line"><span class="keyword">final</span> String systemServerClassPath = System.getenv(<span class="string">"SYSTEMSERVERCLASSPATH"</span>);</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> (bootClassPath == <span class="keyword">null</span>) &#123;</span><br><span class="line">    Slog.w(TAG, <span class="string">"No BOOTCLASSPATH found!"</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> (systemServerClassPath == <span class="keyword">null</span>) &#123;</span><br><span class="line">    Slog.w(TAG, <span class="string">"No SYSTEMSERVERCLASSPATH found!"</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 获得系统指令集合！</span></span><br><span class="line"><span class="keyword">final</span> List&lt;String&gt; allInstructionSets = InstructionSets.getAllInstructionSets();</span><br><span class="line"><span class="keyword">final</span> String[] dexCodeInstructionSets =</span><br><span class="line">        getDexCodeInstructionSets(</span><br><span class="line">                allInstructionSets.toArray(<span class="keyword">new</span> String[allInstructionSets.size()]));</span><br><span class="line"></span><br><span class="line"><span class="comment">// 对所有的共享库执行 odex 操作！</span></span><br><span class="line"><span class="keyword">if</span> (mSharedLibraries.size() &gt; <span class="number">0</span>) &#123;</span><br><span class="line">    <span class="comment">// <span class="doctag">NOTE:</span> For now, we're compiling these system "shared libraries"</span></span><br><span class="line">    <span class="comment">// (and framework jars) into all available architectures. It's possible</span></span><br><span class="line">    <span class="comment">// to compile them only when we come across an app that uses them (there's</span></span><br><span class="line">    <span class="comment">// already logic for that in scanPackageLI) but that adds some complexity.</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">for</span> (String dexCodeInstructionSet : dexCodeInstructionSets) &#123;</span><br><span class="line">        <span class="keyword">for</span> (SharedLibraryEntry libEntry : mSharedLibraries.values()) &#123;</span><br><span class="line">            <span class="keyword">final</span> String lib = libEntry.path;</span><br><span class="line">            <span class="keyword">if</span> (lib == <span class="keyword">null</span>) &#123;</span><br><span class="line">                <span class="keyword">continue</span>;</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            <span class="keyword">try</span> &#123;</span><br><span class="line">                <span class="comment">// Shared libraries do not have profiles so we perform a full</span></span><br><span class="line">                <span class="comment">// AOT compilation (if needed).</span></span><br><span class="line">                <span class="keyword">int</span> dexoptNeeded = DexFile.getDexOptNeeded(</span><br><span class="line">                        lib, dexCodeInstructionSet,</span><br><span class="line">                        getCompilerFilterForReason(REASON_SHARED_APK),</span><br><span class="line">                        <span class="keyword">false</span> <span class="comment">/* newProfile */</span>);</span><br><span class="line">                <span class="keyword">if</span> (dexoptNeeded != DexFile.NO_DEXOPT_NEEDED) &#123;</span><br><span class="line">                    mInstaller.dexopt(lib, Process.SYSTEM_UID, dexCodeInstructionSet,</span><br><span class="line">                            dexoptNeeded, DEXOPT_PUBLIC <span class="comment">/*dexFlags*/</span>,</span><br><span class="line">                            getCompilerFilterForReason(REASON_SHARED_APK),</span><br><span class="line">                            StorageManager.UUID_PRIVATE_INTERNAL,</span><br><span class="line">                            SKIP_SHARED_LIBRARY_CHECK);</span><br><span class="line">                &#125;</span><br><span class="line">            &#125; <span class="keyword">catch</span> (FileNotFoundException e) &#123;</span><br><span class="line">                Slog.w(TAG, <span class="string">"Library not found: "</span> + lib);</span><br><span class="line">            &#125; <span class="keyword">catch</span> (IOException | InstallerException e) &#123;</span><br><span class="line">                Slog.w(TAG, <span class="string">"Cannot dexopt "</span> + lib + <span class="string">"; is it an APK or JAR? "</span></span><br><span class="line">                        + e.getMessage());</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 获得目录 /system/framework，对其目录下的文件进行优化 !</span></span><br><span class="line">File frameworkDir = <span class="keyword">new</span> File(Environment.getRootDirectory(), <span class="string">"framework"</span>);</span><br><span class="line"></span><br><span class="line"><span class="comment">// 获得系统版本信息</span></span><br><span class="line"><span class="keyword">final</span> VersionInfo ver = mSettings.getInternalVersion();</span><br><span class="line"><span class="comment">// 判断是否是 OTA 升级！</span></span><br><span class="line">mIsUpgrade = !Build.FINGERPRINT.equals(ver.fingerprint);</span><br><span class="line"></span><br><span class="line"><span class="comment">// 判断是否是从 Android 6.0 升级过来的，如果是就需要把系统 app 的权限从安装时提高到运行时</span></span><br><span class="line">mPromoteSystemApps =</span><br><span class="line">        mIsUpgrade &amp;&amp; ver.sdkVersion &lt;= Build.VERSION_CODES.LOLLIPOP_MR1;</span><br><span class="line"></span><br><span class="line"><span class="comment">// When upgrading from pre-N, we need to handle package extraction like first boot,</span></span><br><span class="line"><span class="comment">// as there is no profiling data available.</span></span><br><span class="line"><span class="comment">// 判断是否是从 Android 7.0 升级过来的！</span></span><br><span class="line">mIsPreNUpgrade = mIsUpgrade &amp;&amp; ver.sdkVersion &lt; Build.VERSION_CODES.N;</span><br><span class="line"></span><br><span class="line">mIsPreNMR1Upgrade = mIsUpgrade &amp;&amp; ver.sdkVersion &lt; Build.VERSION_CODES.N_MR1;</span><br><span class="line"></span><br><span class="line"><span class="comment">// save off the names of pre-existing system packages prior to scanning; we don't</span></span><br><span class="line"><span class="comment">// want to automatically grant runtime permissions for new system apps</span></span><br><span class="line"><span class="comment">// 保存从 Android 6.0 升级前已经存在的系统应用包，并对他们进行优先扫描！</span></span><br><span class="line"><span class="keyword">if</span> (mPromoteSystemApps) &#123;</span><br><span class="line">    Iterator&lt;PackageSetting&gt; pkgSettingIter = mSettings.mPackages.values().iterator();</span><br><span class="line">    <span class="keyword">while</span> (pkgSettingIter.hasNext()) &#123;</span><br><span class="line">        PackageSetting ps = pkgSettingIter.next();</span><br><span class="line">        <span class="keyword">if</span> (isSystemApp(ps)) &#123;</span><br><span class="line">            mExistingSystemPackages.add(ps.name);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// Collect vendor overlay packages.</span></span><br><span class="line"><span class="comment">// (Do this before scanning any apps.)</span></span><br><span class="line"><span class="comment">// For security and version matching reason, only consider</span></span><br><span class="line"><span class="comment">// overlay packages if they reside in VENDOR_OVERLAY_DIR.</span></span><br><span class="line"><span class="comment">// 扫描收集目录 /vendor/overlay 下的供应商应用包！</span></span><br><span class="line">File vendorOverlayDir = <span class="keyword">new</span> File(VENDOR_OVERLAY_DIR);</span><br><span class="line">          </span><br><span class="line">scanDirTracedLI(vendorOverlayDir, mDefParseFlags</span><br><span class="line">        | PackageParser.PARSE_IS_SYSTEM</span><br><span class="line">        | PackageParser.PARSE_IS_SYSTEM_DIR</span><br><span class="line">        | PackageParser.PARSE_TRUSTED_OVERLAY, scanFlags | SCAN_TRUSTED_OVERLAY, <span class="number">0</span>);</span><br><span class="line"></span><br><span class="line"><span class="comment">// Find base frameworks (resource packages without code).</span></span><br><span class="line"><span class="comment">// 扫描收集目录 /system/framework 下的应用包！ </span></span><br><span class="line">scanDirTracedLI(frameworkDir, mDefParseFlags</span><br><span class="line">        | PackageParser.PARSE_IS_SYSTEM</span><br><span class="line">        | PackageParser.PARSE_IS_SYSTEM_DIR</span><br><span class="line">        | PackageParser.PARSE_IS_PRIVILEGED,</span><br><span class="line">        scanFlags | SCAN_NO_DEX, <span class="number">0</span>);</span><br><span class="line"></span><br><span class="line"><span class="comment">// 扫描收集目录 /system/priv-app 下的应用包！ </span></span><br><span class="line"><span class="keyword">final</span> File privilegedAppDir = <span class="keyword">new</span> File(Environment.getRootDirectory(), <span class="string">"priv-app"</span>);</span><br><span class="line">scanDirTracedLI(privilegedAppDir, mDefParseFlags</span><br><span class="line">        | PackageParser.PARSE_IS_SYSTEM</span><br><span class="line">        | PackageParser.PARSE_IS_SYSTEM_DIR</span><br><span class="line">        | PackageParser.PARSE_IS_PRIVILEGED, scanFlags, <span class="number">0</span>);</span><br><span class="line"></span><br><span class="line"><span class="comment">// 扫描收集目录 /system/app 下的应用包！ </span></span><br><span class="line"><span class="keyword">final</span> File systemAppDir = <span class="keyword">new</span> File(Environment.getRootDirectory(), <span class="string">"app"</span>);</span><br><span class="line">scanDirTracedLI(systemAppDir, mDefParseFlags</span><br><span class="line">        | PackageParser.PARSE_IS_SYSTEM</span><br><span class="line">        | PackageParser.PARSE_IS_SYSTEM_DIR, scanFlags, <span class="number">0</span>);</span><br><span class="line"></span><br><span class="line"><span class="comment">// 扫描收集目录 /vendor/app 下的应用包！ </span></span><br><span class="line">File vendorAppDir = <span class="keyword">new</span> File(<span class="string">"/vendor/app"</span>);</span><br><span class="line"><span class="keyword">try</span> &#123;</span><br><span class="line">    vendorAppDir = vendorAppDir.getCanonicalFile();</span><br><span class="line">&#125; <span class="keyword">catch</span> (IOException e) &#123;</span><br><span class="line">    <span class="comment">// failed to look up canonical path, continue with original one</span></span><br><span class="line">&#125;</span><br><span class="line">scanDirTracedLI(vendorAppDir, mDefParseFlags</span><br><span class="line">        | PackageParser.PARSE_IS_SYSTEM</span><br><span class="line">        | PackageParser.PARSE_IS_SYSTEM_DIR, scanFlags, <span class="number">0</span>);</span><br><span class="line"></span><br><span class="line"><span class="comment">// 扫描收集目录 /oem/app 下的应用包！ </span></span><br><span class="line"><span class="keyword">final</span> File oemAppDir = <span class="keyword">new</span> File(Environment.getOemDirectory(), <span class="string">"app"</span>);</span><br><span class="line">scanDirTracedLI(oemAppDir, mDefParseFlags</span><br><span class="line">        | PackageParser.PARSE_IS_SYSTEM</span><br><span class="line">        | PackageParser.PARSE_IS_SYSTEM_DIR, scanFlags, <span class="number">0</span>);</span><br><span class="line"></span><br><span class="line"><span class="comment">// 删除已经不存在的系统应用包！</span></span><br><span class="line"><span class="keyword">final</span> List&lt;String&gt; possiblyDeletedUpdatedSystemApps = <span class="keyword">new</span> ArrayList&lt;String&gt;();</span><br><span class="line"><span class="keyword">if</span> (!mOnlyCore) &#123;</span><br><span class="line">    Iterator&lt;PackageSetting&gt; psit = mSettings.mPackages.values().iterator();</span><br><span class="line">    <span class="keyword">while</span> (psit.hasNext()) &#123;</span><br><span class="line">        PackageSetting ps = psit.next();</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 如果不是系统应用，跳过！</span></span><br><span class="line">        <span class="keyword">if</span> ((ps.pkgFlags &amp; ApplicationInfo.FLAG_SYSTEM) == <span class="number">0</span>) &#123;</span><br><span class="line">            <span class="keyword">continue</span>;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 如果系统应用包已经被扫描到了（scannedPkg ！= null），就不会被删掉！</span></span><br><span class="line">        <span class="keyword">final</span> PackageParser.Package scannedPkg = mPackages.get(ps.name);</span><br><span class="line">        <span class="keyword">if</span> (scannedPkg != <span class="keyword">null</span>) &#123;</span><br><span class="line">            <span class="comment">/*</span></span><br><span class="line"><span class="comment">             * If the system app is both scanned and in the</span></span><br><span class="line"><span class="comment">             * disabled packages list, then it must have been</span></span><br><span class="line"><span class="comment">             * added via OTA. Remove it from the currently</span></span><br><span class="line"><span class="comment">             * scanned package so the previously user-installed</span></span><br><span class="line"><span class="comment">             * application can be scanned.</span></span><br><span class="line"><span class="comment">             */</span></span><br><span class="line">            <span class="comment">// 如果系统应用包不仅被扫描过（在mPackages中），并且在不可用列表中！</span></span><br><span class="line">            <span class="comment">// 说明一定是通过覆盖安装的，移除之前扫描的结果，保证之前用户安装的应用能够被扫描！</span></span><br><span class="line">            <span class="keyword">if</span> (mSettings.isDisabledSystemPackageLPr(ps.name)) &#123;</span><br><span class="line">                logCriticalInfo(Log.WARN, <span class="string">"Expecting better updated system app for "</span></span><br><span class="line">                        + ps.name + <span class="string">"; removing system app.  Last known codePath="</span></span><br><span class="line">                        + ps.codePathString + <span class="string">", installStatus="</span> + ps.installStatus</span><br><span class="line">                        + <span class="string">", versionCode="</span> + ps.versionCode + <span class="string">"; scanned versionCode="</span></span><br><span class="line">                        + scannedPkg.mVersionCode);</span><br><span class="line">                </span><br><span class="line">                <span class="comment">// 将之前的扫描结果移除！</span></span><br><span class="line">                removePackageLI(scannedPkg, <span class="keyword">true</span>);</span><br><span class="line">                <span class="comment">// 将这包添加到 mExpectingBetter 列表中！</span></span><br><span class="line">                mExpectingBetter.put(ps.name, ps.codePath);</span><br><span class="line">            &#125;</span><br><span class="line">            </span><br><span class="line">            <span class="comment">// 跳出循环，确保不会被删掉！</span></span><br><span class="line">            <span class="keyword">continue</span>;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 如果系统应用包没有被扫描，并且他也不在不可用的列表中，移除它，这个包不存在！</span></span><br><span class="line">        <span class="keyword">if</span> (!mSettings.isDisabledSystemPackageLPr(ps.name)) &#123;</span><br><span class="line">            psit.remove();</span><br><span class="line">            logCriticalInfo(Log.WARN, <span class="string">"System package "</span> + ps.name</span><br><span class="line">                    + <span class="string">" no longer exists; it's data will be wiped"</span>);</span><br><span class="line">            <span class="comment">// Actual deletion of code and data will be handled by later</span></span><br><span class="line">            <span class="comment">// reconciliation step</span></span><br><span class="line"></span><br><span class="line">        &#125; <span class="keyword">else</span> &#123; </span><br><span class="line">            </span><br><span class="line">            <span class="comment">// 如果系统应用包没有被扫描，却在不可用的列表中，就将他加入到 </span></span><br><span class="line">            <span class="comment">// possiblyDeletedUpdatedSystemApps 集合中，需要被删除！</span></span><br><span class="line">            <span class="keyword">final</span> PackageSetting disabledPs = mSettings.getDisabledSystemPkgLPr(ps.name);</span><br><span class="line">            <span class="keyword">if</span> (disabledPs.codePath == <span class="keyword">null</span> || !disabledPs.codePath.exists()) &#123;</span><br><span class="line">                possiblyDeletedUpdatedSystemApps.add(ps.name);</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 清理所有安装不完全的应用包！</span></span><br><span class="line">ArrayList&lt;PackageSetting&gt; deletePkgsList = mSettings.getListOfIncompleteInstallPackagesLPr();</span><br><span class="line"><span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; deletePkgsList.size(); i++) &#123;</span><br><span class="line">    <span class="comment">// Actual deletion of code and data will be handled by later</span></span><br><span class="line">    <span class="comment">// reconciliation step</span></span><br><span class="line">    <span class="keyword">final</span> String packageName = deletePkgsList.get(i).name;</span><br><span class="line">    logCriticalInfo(Log.WARN, <span class="string">"Cleaning up incompletely installed app: "</span> + packageName);</span><br><span class="line">    <span class="keyword">synchronized</span> (mPackages) &#123;</span><br><span class="line">        mSettings.removePackageLPw(packageName);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 移除临时文件</span></span><br><span class="line">deleteTempPackageFiles();</span><br><span class="line"></span><br><span class="line"><span class="comment">// 移除没有和应用程序包相关联的共享用户 id！</span></span><br><span class="line">mSettings.pruneSharedUsersLPw();</span><br><span class="line"> </span><br><span class="line">... ... ... ...<span class="comment">// 见，第三阶段</span></span><br></pre></td></tr></table></figure></p>
<p>总结一下第二阶段：</p>
<h3 id="2-2-1-主要流程"><a href="#2-2-1-主要流程" class="headerlink" title="2.2.1 主要流程"></a><strong>2.2.1 主要流程</strong></h3><ul>
<li>获得环境变量：BOOTCLASSPATH 和 SYSTEMSERVERCLASSPATH！</li>
<li>对共享库进行 odex 优化操作！</li>
<li>判断是否是通过 OTA 升级的<ul>
<li>如果是从 6.0 升级过来的，保存从 Android 6.0 升级前已经存在的系统应用包，并对他们进行优先扫描！</li>
</ul>
</li>
<li>扫描收集以下目录中的供应商应用包！<ul>
<li>/vendor/overlay     </li>
<li>/system/framework     </li>
<li>/system/priv-app     </li>
<li>/system/app</li>
<li>/vendor/app     </li>
<li>/oem/app</li>
</ul>
</li>
<li>删除已经不存在的系统应用包！</li>
<li>清理所有安装不完全的应用包！</li>
<li>移除临时文件</li>
<li>移除没有和应用程序包相关联的共享用户 id</li>
</ul>
<h3 id="2-2-2-细节分析"><a href="#2-2-2-细节分析" class="headerlink" title="2.2.2 细节分析"></a><strong>2.2.2 细节分析</strong></h3><h4 id="2-2-2-1-环境变量"><a href="#2-2-2-1-环境变量" class="headerlink" title="2.2.2.1 环境变量"></a><strong>2.2.2.1 环境变量</strong></h4><p>我们可以通过 adb shell env 来查看系统所有的环境变量及相应值。也可通过命令：adb shell echo $var 来看指定的环境变量的值！</p>
<ul>
<li><p><strong>SYSTEMSERVERCLASSPATH</strong>：</p>
<ul>
<li>主要是系统服务 jar 包的路径！</li>
<li>主要文件如下：<pre><code>- /system/framework/services.jar
- /system/framework/ethernet-service.jar
- /system/framework/wifi-service.jar
</code></pre></li>
</ul>
</li>
<li><p><strong>BOOTCLASSPATH</strong>：</p>
<ul>
<li>该环境变量内容较多，第三方定制的系统可能有所不同，原生内容包含 /system/framework目录下的framework.jar，ext.jar，core-libart.jar，telephony-common.jar，ims-common.jar，core-junit.jar等文件！</li>
<li>主要文件如下：<pre><code>- /system/framework/core-libart.jar 
- /system/framework/conscrypt.jar
- /system/framework/okhttp.jar 
- /system/framework/core-junit.jar
- /system/framework/bouncycastle.jar 
- /system/framework/ext.jar
- /system/framework/framework.jar
- /system/framework/telephony-common.jar
- /system/framework/voip-common.jar 
- /system/framework/ims-common.jar
- /system/framework/apache-xml.jar
- /system/framework/org.apache.http.legacy.boot.jar
- /system/framework/ifaamanager.jar 
- /system/framework/tcmiface.jar
- /system/framework/WfdCommon.jar
- /system/framework/com.qti.dpmframework.jar
- /system/framework/dpmapi.jar
- /system/framework/com.qti.location.sdk.jar
- /system/framework/qcom.fmradio.jar
- /system/framework/qcmediaplayer.jar
</code></pre></li>
</ul>
</li>
</ul>
<h4 id="2-2-2-2-dexopt-优化"><a href="#2-2-2-2-dexopt-优化" class="headerlink" title="2.2.2.2  dexopt 优化"></a><strong>2.2.2.2  dexopt 优化</strong></h4><p>执行 dex 优化操作的文件有以下几类：</p>
<ul>
<li>mSharedLibraries：该共享库下的所有文件，是由 SystemConfig 构造函数中赋值的；</li>
<li>/system/framework：该目录的所有 apk 和 jar 文件；</li>
</ul>
<h4 id="2-2-2-3-scanDirLI-扫描系统目录"><a href="#2-2-2-3-scanDirLI-扫描系统目录" class="headerlink" title="2.2.2.3 scanDirLI 扫描系统目录"></a><strong>2.2.2.3 scanDirLI 扫描系统目录</strong></h4><p>扫描指定目录下的 apk 文件，最终调用 PackageParser.parseBaseApk 来完成 AndroidManifest.xml 文件的解析，生成 Application，activity，service，broadcast，provider 等信息。</p>
<ul>
<li>/vendor/overlay</li>
<li>/system/framework</li>
<li>/system/priv-app</li>
<li>/system/app</li>
<li>/vendor/app</li>
<li>/oem/app</li>
</ul>
<h2 id="2-3-PMS-DATA-SCAN-START"><a href="#2-3-PMS-DATA-SCAN-START" class="headerlink" title="2.3 PMS_DATA_SCAN_START"></a>2.3 PMS_DATA_SCAN_START</h2><p>接下来，进入第三阶段：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br></pre></td><td class="code"><pre><span class="line">... ... ... ...<span class="comment">// 第三阶段</span></span><br><span class="line"><span class="keyword">if</span> (!mOnlyCore) &#123;</span><br><span class="line">    EventLog.writeEvent(EventLogTags.BOOT_PROGRESS_PMS_DATA_SCAN_START,</span><br><span class="line">            SystemClock.uptimeMillis());</span><br><span class="line">            </span><br><span class="line">    <span class="comment">// 同理，扫描 /data/app 目录和 /data/app-private 目录！</span></span><br><span class="line">    scanDirTracedLI(mAppInstallDir, <span class="number">0</span>, scanFlags | SCAN_REQUIRE_KNOWN, <span class="number">0</span>);</span><br><span class="line"></span><br><span class="line">    scanDirTracedLI(mDrmAppPrivateInstallDir, mDefParseFlags</span><br><span class="line">            | PackageParser.PARSE_FORWARD_LOCK,</span><br><span class="line">            scanFlags | SCAN_REQUIRE_KNOWN, <span class="number">0</span>);</span><br><span class="line"></span><br><span class="line">    scanDirLI(mEphemeralInstallDir, mDefParseFlags</span><br><span class="line">            | PackageParser.PARSE_IS_EPHEMERAL,</span><br><span class="line">            scanFlags | SCAN_REQUIRE_KNOWN, <span class="number">0</span>);</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * Remove disable package settings for any updated system</span></span><br><span class="line"><span class="comment">     * apps that were removed via an OTA. If they're not a</span></span><br><span class="line"><span class="comment">     * previously-updated app, remove them completely.</span></span><br><span class="line"><span class="comment">     * Otherwise, just revoke their system-level permissions.</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">for</span> (String deletedAppName : possiblyDeletedUpdatedSystemApps) &#123;</span><br><span class="line">        PackageParser.Package deletedPkg = mPackages.get(deletedAppName);</span><br><span class="line">        mSettings.removeDisabledSystemPackageLPw(deletedAppName);</span><br><span class="line"></span><br><span class="line">        String msg;</span><br><span class="line">        <span class="keyword">if</span> (deletedPkg == <span class="keyword">null</span>) &#123;</span><br><span class="line">            msg = <span class="string">"Updated system package "</span> + deletedAppName</span><br><span class="line">                    + <span class="string">" no longer exists; it's data will be wiped"</span>;</span><br><span class="line">            <span class="comment">// Actual deletion of code and data will be handled by later</span></span><br><span class="line">            <span class="comment">// reconciliation step</span></span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            msg = <span class="string">"Updated system app + "</span> + deletedAppName</span><br><span class="line">                    + <span class="string">" no longer present; removing system privileges for "</span></span><br><span class="line">                    + deletedAppName;</span><br><span class="line"></span><br><span class="line">            deletedPkg.applicationInfo.flags &amp;= ~ApplicationInfo.FLAG_SYSTEM;</span><br><span class="line"></span><br><span class="line">            PackageSetting deletedPs = mSettings.mPackages.get(deletedAppName);</span><br><span class="line">            deletedPs.pkgFlags &amp;= ~ApplicationInfo.FLAG_SYSTEM;</span><br><span class="line">        &#125;</span><br><span class="line">        logCriticalInfo(Log.WARN, msg);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 确保所有在用户 data 分区的应用都显示出来了，如果无法显示</span></span><br><span class="line">    <span class="comment">// 那就回滚，显示 system 分区的！</span></span><br><span class="line">    <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; mExpectingBetter.size(); i++) &#123;</span><br><span class="line">        <span class="keyword">final</span> String packageName = mExpectingBetter.keyAt(i);</span><br><span class="line">        <span class="keyword">if</span> (!mPackages.containsKey(packageName)) &#123;</span><br><span class="line">            <span class="keyword">final</span> File scanFile = mExpectingBetter.valueAt(i);</span><br><span class="line"></span><br><span class="line">            logCriticalInfo(Log.WARN, <span class="string">"Expected better "</span> + packageName</span><br><span class="line">                    + <span class="string">" but never showed up; reverting to system"</span>);</span><br><span class="line">            </span><br><span class="line">            <span class="comment">// 设置扫描参数，不同的目录，扫描参数不同！</span></span><br><span class="line">            <span class="keyword">int</span> reparseFlags = mDefParseFlags;</span><br><span class="line">            <span class="keyword">if</span> (FileUtils.contains(privilegedAppDir, scanFile)) &#123;</span><br><span class="line">                reparseFlags = PackageParser.PARSE_IS_SYSTEM</span><br><span class="line">                        | PackageParser.PARSE_IS_SYSTEM_DIR</span><br><span class="line">                        | PackageParser.PARSE_IS_PRIVILEGED;</span><br><span class="line">            &#125; <span class="keyword">else</span> <span class="keyword">if</span> (FileUtils.contains(systemAppDir, scanFile)) &#123;</span><br><span class="line">                reparseFlags = PackageParser.PARSE_IS_SYSTEM</span><br><span class="line">                        | PackageParser.PARSE_IS_SYSTEM_DIR;</span><br><span class="line">            &#125; <span class="keyword">else</span> <span class="keyword">if</span> (FileUtils.contains(vendorAppDir, scanFile)) &#123;</span><br><span class="line">                reparseFlags = PackageParser.PARSE_IS_SYSTEM</span><br><span class="line">                        | PackageParser.PARSE_IS_SYSTEM_DIR;</span><br><span class="line">            &#125; <span class="keyword">else</span> <span class="keyword">if</span> (FileUtils.contains(oemAppDir, scanFile)) &#123;</span><br><span class="line">                reparseFlags = PackageParser.PARSE_IS_SYSTEM</span><br><span class="line">                        | PackageParser.PARSE_IS_SYSTEM_DIR;</span><br><span class="line">            &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                Slog.e(TAG, <span class="string">"Ignoring unexpected fallback path "</span> + scanFile);</span><br><span class="line">                <span class="keyword">continue</span>;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="comment">// 设置系统 package 可用！</span></span><br><span class="line">            mSettings.enableSystemPackageLPw(packageName);</span><br><span class="line">            <span class="comment">// 重新解析 system 分区的 package！</span></span><br><span class="line">            <span class="keyword">try</span> &#123;</span><br><span class="line">                scanPackageTracedLI(scanFile, reparseFlags, scanFlags, <span class="number">0</span>, <span class="keyword">null</span>);</span><br><span class="line">            &#125; <span class="keyword">catch</span> (PackageManagerException e) &#123;</span><br><span class="line">                Slog.e(TAG, <span class="string">"Failed to parse original system package: "</span></span><br><span class="line">                        + e.getMessage());</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line">mExpectingBetter.clear(); <span class="comment">// 清空 mExpectingBetter 列表！</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// Resolve the storage manager.</span></span><br><span class="line">mStorageManagerPackage = getStorageManagerPackageName();</span><br><span class="line"></span><br><span class="line"><span class="comment">// Resolve protected action filters. Only the setup wizard is allowed to</span></span><br><span class="line"><span class="comment">// have a high priority filter for these actions.</span></span><br><span class="line">mSetupWizardPackage = getSetupWizardPackageName();</span><br><span class="line"><span class="keyword">if</span> (mProtectedFilters.size() &gt; <span class="number">0</span>) &#123;</span><br><span class="line">    <span class="keyword">if</span> (DEBUG_FILTERS &amp;&amp; mSetupWizardPackage == <span class="keyword">null</span>) &#123;</span><br><span class="line">        Slog.i(TAG, <span class="string">"No setup wizard;"</span></span><br><span class="line">            + <span class="string">" All protected intents capped to priority 0"</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">for</span> (ActivityIntentInfo filter : mProtectedFilters) &#123;</span><br><span class="line">        <span class="keyword">if</span> (filter.activity.info.packageName.equals(mSetupWizardPackage)) &#123;</span><br><span class="line">            <span class="keyword">if</span> (DEBUG_FILTERS) &#123;</span><br><span class="line">                Slog.i(TAG, <span class="string">"Found setup wizard;"</span></span><br><span class="line">                    + <span class="string">" allow priority "</span> + filter.getPriority() + <span class="string">";"</span></span><br><span class="line">                    + <span class="string">" package: "</span> + filter.activity.info.packageName</span><br><span class="line">                    + <span class="string">" activity: "</span> + filter.activity.className</span><br><span class="line">                    + <span class="string">" priority: "</span> + filter.getPriority());</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="comment">// skip setup wizard; allow it to keep the high priority filter</span></span><br><span class="line">            <span class="keyword">continue</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        Slog.w(TAG, <span class="string">"Protected action; cap priority to 0;"</span></span><br><span class="line">                + <span class="string">" package: "</span> + filter.activity.info.packageName</span><br><span class="line">                + <span class="string">" activity: "</span> + filter.activity.className</span><br><span class="line">                + <span class="string">" origPrio: "</span> + filter.getPriority());</span><br><span class="line">        filter.setPriority(<span class="number">0</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line">mDeferProtectedFilters = <span class="keyword">false</span>;</span><br><span class="line">mProtectedFilters.clear();</span><br><span class="line"></span><br><span class="line"><span class="comment">// 这里，我们已经找到了所有的共享库文件！</span></span><br><span class="line"><span class="comment">// 我们需要更新所有的应用，保证他们有正确的共享库路径。</span></span><br><span class="line">updateAllSharedLibrariesLPw();</span><br><span class="line"></span><br><span class="line"><span class="keyword">for</span> (SharedUserSetting setting : mSettings.getAllSharedUsersLPw()) &#123;</span><br><span class="line">    <span class="comment">// <span class="doctag">NOTE:</span> We ignore potential failures here during a system scan (like</span></span><br><span class="line">    <span class="comment">// the rest of the commands above) because there's precious little we</span></span><br><span class="line">    <span class="comment">// can do about it. A settings error is reported, though.</span></span><br><span class="line">    adjustCpuAbisForSharedUserLPw(setting.packages, <span class="keyword">null</span> <span class="comment">/* scanned package */</span>,</span><br><span class="line">            <span class="keyword">false</span> <span class="comment">/* boot complete */</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 到这里，系统中所有的 package 都被扫描刀了，这里是更新他们上一次的使用信息！</span></span><br><span class="line">mPackageUsage.read(mPackages);</span><br><span class="line">mCompilerStats.read();</span><br><span class="line"></span><br><span class="line">... ... ... ...<span class="comment">// 见，第四阶段</span></span><br></pre></td></tr></table></figure>
<p>当mOnlyCore = false时，则 scanDirLI 还会收集如下目录中的 apk 的信息！</p>
<ul>
<li>/data/app</li>
<li>/data/app-private</li>
</ul>
<h3 id="2-3-1-主要流程"><a href="#2-3-1-主要流程" class="headerlink" title="2.3.1 主要流程"></a>2.3.1 主要流程</h3><h2 id="2-4-PMS-SCAN-END"><a href="#2-4-PMS-SCAN-END" class="headerlink" title="2.4 PMS_SCAN_END"></a>2.4 PMS_SCAN_END</h2><p>下面是第四阶段：<br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br></pre></td><td class="code"><pre><span class="line">... ... ... ...<span class="comment">// 第四阶段</span></span><br><span class="line"></span><br><span class="line">EventLog.writeEvent(EventLogTags.BOOT_PROGRESS_PMS_SCAN_END,</span><br><span class="line">        SystemClock.uptimeMillis());</span><br><span class="line">Slog.i(TAG, <span class="string">"Time to scan packages: "</span></span><br><span class="line">        + ((SystemClock.uptimeMillis()-startTime)/<span class="number">1000f</span>)</span><br><span class="line">        + <span class="string">" seconds"</span>);</span><br><span class="line"></span><br><span class="line"><span class="comment">// If the platform SDK has changed since the last time we booted,</span></span><br><span class="line"><span class="comment">// we need to re-grant app permission to catch any new ones that</span></span><br><span class="line"><span class="comment">// appear.  This is really a hack, and means that apps can in some</span></span><br><span class="line"><span class="comment">// cases get permissions that the user didn't initially explicitly</span></span><br><span class="line"><span class="comment">// allow...  it would be nice to have some better way to handle</span></span><br><span class="line"><span class="comment">// this situation.</span></span><br><span class="line"><span class="comment">// 如果从我们上次启动，SDK 平台被改变了，我们需要重新授予应用程序权限。</span></span><br><span class="line"><span class="keyword">int</span> updateFlags = UPDATE_PERMISSIONS_ALL;</span><br><span class="line"><span class="keyword">if</span> (ver.sdkVersion != mSdkVersion) &#123;</span><br><span class="line">    Slog.i(TAG, <span class="string">"Platform changed from "</span> + ver.sdkVersion + <span class="string">" to "</span></span><br><span class="line">            + mSdkVersion + <span class="string">"; regranting permissions for internal storage"</span>);</span><br><span class="line">    updateFlags |= UPDATE_PERMISSIONS_REPLACE_PKG | UPDATE_PERMISSIONS_REPLACE_ALL;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 赋予 package 相应请求的权限 </span></span><br><span class="line">updatePermissionsLPw(<span class="keyword">null</span>, <span class="keyword">null</span>, StorageManager.UUID_PRIVATE_INTERNAL, updateFlags);</span><br><span class="line">ver.sdkVersion = mSdkVersion;</span><br><span class="line"></span><br><span class="line"><span class="comment">// If this is the first boot or an update from pre-M, and it is a normal</span></span><br><span class="line"><span class="comment">// boot, then we need to initialize the default preferred apps across</span></span><br><span class="line"><span class="comment">// all defined users.</span></span><br><span class="line"><span class="comment">// 如果这是第一次开机或前-M的更新，这是一个正常的启动，然后我们需要初始化默认的首选应用程序给所有已经定义的用户。</span></span><br><span class="line"><span class="keyword">if</span> (!onlyCore &amp;&amp; (mPromoteSystemApps || mFirstBoot)) &#123;</span><br><span class="line">    <span class="keyword">for</span> (UserInfo user : sUserManager.getUsers(<span class="keyword">true</span>)) &#123;</span><br><span class="line">        mSettings.applyDefaultPreferredAppsLPw(<span class="keyword">this</span>, user.id);</span><br><span class="line">        applyFactoryDefaultBrowserLPw(user.id);</span><br><span class="line">        primeDomainVerificationsLPw(user.id);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// Prepare storage for system user really early during boot,</span></span><br><span class="line"><span class="comment">// since core system apps like SettingsProvider and SystemUI</span></span><br><span class="line"><span class="comment">// can't wait for user to start</span></span><br><span class="line"><span class="keyword">final</span> <span class="keyword">int</span> storageFlags;</span><br><span class="line"><span class="keyword">if</span> (StorageManager.isFileEncryptedNativeOrEmulated()) &#123;</span><br><span class="line">    storageFlags = StorageManager.FLAG_STORAGE_DE;</span><br><span class="line">&#125; <span class="keyword">else</span> &#123;</span><br><span class="line">    storageFlags = StorageManager.FLAG_STORAGE_DE | StorageManager.FLAG_STORAGE_CE;</span><br><span class="line">&#125;</span><br><span class="line">reconcileAppsDataLI(StorageManager.UUID_PRIVATE_INTERNAL, UserHandle.USER_SYSTEM,</span><br><span class="line">        storageFlags);</span><br><span class="line"></span><br><span class="line"><span class="comment">// If this is first boot after an OTA, and a normal boot, then</span></span><br><span class="line"><span class="comment">// we need to clear code cache directories.</span></span><br><span class="line"><span class="comment">// Note that we do *not* clear the application profiles. These remain valid</span></span><br><span class="line"><span class="comment">// across OTAs and are used to drive profile verification (post OTA) and</span></span><br><span class="line"><span class="comment">// profile compilation (without waiting to collect a fresh set of profiles).</span></span><br><span class="line"><span class="comment">// 如果这是在OTA升级后第一启动，这是正常的启动，然后我们需要清除代码缓存目录。</span></span><br><span class="line"><span class="keyword">if</span> (mIsUpgrade &amp;&amp; !onlyCore) &#123;</span><br><span class="line">    Slog.i(TAG, <span class="string">"Build fingerprint changed; clearing code caches"</span>);</span><br><span class="line">    <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; mSettings.mPackages.size(); i++) &#123;</span><br><span class="line">        <span class="keyword">final</span> PackageSetting ps = mSettings.mPackages.valueAt(i);</span><br><span class="line">        <span class="keyword">if</span> (Objects.equals(StorageManager.UUID_PRIVATE_INTERNAL, ps.volumeUuid)) &#123;</span><br><span class="line">            <span class="comment">// No apps are running this early, so no need to freeze</span></span><br><span class="line">            clearAppDataLIF(ps.pkg, UserHandle.USER_ALL,</span><br><span class="line">                    StorageManager.FLAG_STORAGE_DE | StorageManager.FLAG_STORAGE_CE</span><br><span class="line">                            | Installer.FLAG_CLEAR_CODE_CACHE_ONLY);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    ver.fingerprint = Build.FINGERPRINT;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">checkDefaultBrowser();</span><br><span class="line"></span><br><span class="line"><span class="comment">// clear only after permissions and other defaults have been updated</span></span><br><span class="line"><span class="comment">// 当权限和其他默认设置被更新后，执行清除操作。</span></span><br><span class="line">mExistingSystemPackages.clear();</span><br><span class="line">mPromoteSystemApps = <span class="keyword">false</span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">// All the changes are done during package scanning.</span></span><br><span class="line">ver.databaseVersion = Settings.CURRENT_DATABASE_VERSION;</span><br><span class="line"></span><br><span class="line"><span class="comment">// can downgrade to reader</span></span><br><span class="line"><span class="comment">// 信息写回 packages.xml 文件</span></span><br><span class="line">mSettings.writeLPr();</span><br><span class="line"></span><br><span class="line"><span class="comment">// Perform dexopt on all apps that mark themselves as coreApps. We do this pretty</span></span><br><span class="line"><span class="comment">// early on (before the package manager declares itself as early) because other</span></span><br><span class="line"><span class="comment">// components in the system server might ask for package contexts for these apps.</span></span><br><span class="line"><span class="comment">//</span></span><br><span class="line"><span class="comment">// Note that "onlyCore" in this context means the system is encrypted or encrypting</span></span><br><span class="line"><span class="comment">// (i.e, that the data partition is unavailable).</span></span><br><span class="line"><span class="keyword">if</span> ((isFirstBoot() || isUpgrade() || VMRuntime.didPruneDalvikCache()) &amp;&amp; !onlyCore) &#123;</span><br><span class="line">    <span class="keyword">long</span> start = System.nanoTime();</span><br><span class="line">    List&lt;PackageParser.Package&gt; coreApps = <span class="keyword">new</span> ArrayList&lt;&gt;();</span><br><span class="line">    <span class="keyword">for</span> (PackageParser.Package pkg : mPackages.values()) &#123;</span><br><span class="line">        <span class="keyword">if</span> (pkg.coreApp) &#123;</span><br><span class="line">            coreApps.add(pkg);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">int</span>[] stats = performDexOptUpgrade(coreApps, <span class="keyword">false</span>,</span><br><span class="line">            getCompilerFilterForReason(REASON_CORE_APP));</span><br><span class="line"></span><br><span class="line">    <span class="keyword">final</span> <span class="keyword">int</span> elapsedTimeSeconds =</span><br><span class="line">            (<span class="keyword">int</span>) TimeUnit.NANOSECONDS.toSeconds(System.nanoTime() - start);</span><br><span class="line">    MetricsLogger.histogram(mContext, <span class="string">"opt_coreapps_time_s"</span>, elapsedTimeSeconds);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (DEBUG_DEXOPT) &#123;</span><br><span class="line">        Slog.i(TAG, <span class="string">"Dex-opt core apps took : "</span> + elapsedTimeSeconds + <span class="string">" seconds ("</span> +</span><br><span class="line">                stats[<span class="number">0</span>] + <span class="string">", "</span> + stats[<span class="number">1</span>] + <span class="string">", "</span> + stats[<span class="number">2</span>] + <span class="string">")"</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="comment">// <span class="doctag">TODO:</span> Should we log these stats to tron too ?</span></span><br><span class="line">    <span class="comment">// MetricsLogger.histogram(mContext, "opt_coreapps_num_dexopted", stats[0]);</span></span><br><span class="line">    <span class="comment">// MetricsLogger.histogram(mContext, "opt_coreapps_num_skipped", stats[1]);</span></span><br><span class="line">    <span class="comment">// MetricsLogger.histogram(mContext, "opt_coreapps_num_failed", stats[2]);</span></span><br><span class="line">    <span class="comment">// MetricsLogger.histogram(mContext, "opt_coreapps_num_total", coreApps.size());</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">... ... ... ...<span class="comment">// 见，第五阶段</span></span><br></pre></td></tr></table></figure></p>
<p>暂时先写到这里！</p>
<h3 id="2-4-1-主要流程"><a href="#2-4-1-主要流程" class="headerlink" title="2.4.1 主要流程"></a>2.4.1 主要流程</h3><h2 id="2-5-PMS-READY"><a href="#2-5-PMS-READY" class="headerlink" title="2.5 PMS_READY"></a>2.5 PMS_READY</h2><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br></pre></td><td class="code"><pre><span class="line">        ... ... ... ...<span class="comment">// 第五阶段</span></span><br><span class="line">        EventLog.writeEvent(EventLogTags.BOOT_PROGRESS_PMS_READY,</span><br><span class="line">                SystemClock.uptimeMillis());</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (!mOnlyCore) &#123;</span><br><span class="line">            mRequiredVerifierPackage = getRequiredButNotReallyRequiredVerifierLPr();</span><br><span class="line">            mRequiredInstallerPackage = getRequiredInstallerLPr();</span><br><span class="line">            mRequiredUninstallerPackage = getRequiredUninstallerLPr();</span><br><span class="line">            mIntentFilterVerifierComponent = getIntentFilterVerifierComponentNameLPr();</span><br><span class="line">            mIntentFilterVerifier = <span class="keyword">new</span> IntentVerifierProxy(mContext,</span><br><span class="line">                    mIntentFilterVerifierComponent);</span><br><span class="line">            mServicesSystemSharedLibraryPackageName = getRequiredSharedLibraryLPr(</span><br><span class="line">                    PackageManager.SYSTEM_SHARED_LIBRARY_SERVICES);</span><br><span class="line">            mSharedSystemSharedLibraryPackageName = getRequiredSharedLibraryLPr(</span><br><span class="line">                    PackageManager.SYSTEM_SHARED_LIBRARY_SHARED);</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            mRequiredVerifierPackage = <span class="keyword">null</span>;</span><br><span class="line">            mRequiredInstallerPackage = <span class="keyword">null</span>;</span><br><span class="line">            mRequiredUninstallerPackage = <span class="keyword">null</span>;</span><br><span class="line">            mIntentFilterVerifierComponent = <span class="keyword">null</span>;</span><br><span class="line">            mIntentFilterVerifier = <span class="keyword">null</span>;</span><br><span class="line">            mServicesSystemSharedLibraryPackageName = <span class="keyword">null</span>;</span><br><span class="line">            mSharedSystemSharedLibraryPackageName = <span class="keyword">null</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        </span><br><span class="line">        <span class="comment">// 建立 PackageInstallerService 服务对象</span></span><br><span class="line">        mInstallerService = <span class="keyword">new</span> PackageInstallerService(context, <span class="keyword">this</span>);</span><br><span class="line"></span><br><span class="line">        <span class="keyword">final</span> ComponentName ephemeralResolverComponent = getEphemeralResolverLPr();</span><br><span class="line">        <span class="keyword">final</span> ComponentName ephemeralInstallerComponent = getEphemeralInstallerLPr();</span><br><span class="line">        <span class="comment">// both the installer and resolver must be present to enable ephemeral</span></span><br><span class="line">        <span class="keyword">if</span> (ephemeralInstallerComponent != <span class="keyword">null</span> &amp;&amp; ephemeralResolverComponent != <span class="keyword">null</span>) &#123;</span><br><span class="line">            <span class="keyword">if</span> (DEBUG_EPHEMERAL) &#123;</span><br><span class="line">                Slog.i(TAG, <span class="string">"Ephemeral activated; resolver: "</span> + ephemeralResolverComponent</span><br><span class="line">                        + <span class="string">" installer:"</span> + ephemeralInstallerComponent);</span><br><span class="line">            &#125;</span><br><span class="line">            mEphemeralResolverComponent = ephemeralResolverComponent;</span><br><span class="line">            mEphemeralInstallerComponent = ephemeralInstallerComponent;</span><br><span class="line">            setUpEphemeralInstallerActivityLP(mEphemeralInstallerComponent);</span><br><span class="line">            mEphemeralResolverConnection =</span><br><span class="line">                    <span class="keyword">new</span> EphemeralResolverConnection(mContext, mEphemeralResolverComponent);</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            <span class="keyword">if</span> (DEBUG_EPHEMERAL) &#123;</span><br><span class="line">                <span class="keyword">final</span> String missingComponent =</span><br><span class="line">                        (ephemeralResolverComponent == <span class="keyword">null</span>)</span><br><span class="line">                        ? (ephemeralInstallerComponent == <span class="keyword">null</span>)</span><br><span class="line">                                ? <span class="string">"resolver and installer"</span></span><br><span class="line">                                : <span class="string">"resolver"</span></span><br><span class="line">                        : <span class="string">"installer"</span>;</span><br><span class="line">                Slog.i(TAG, <span class="string">"Ephemeral deactivated; missing "</span> + missingComponent);</span><br><span class="line">            &#125;</span><br><span class="line">            mEphemeralResolverComponent = <span class="keyword">null</span>;</span><br><span class="line">            mEphemeralInstallerComponent = <span class="keyword">null</span>;</span><br><span class="line">            mEphemeralResolverConnection = <span class="keyword">null</span>;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        mEphemeralApplicationRegistry = <span class="keyword">new</span> EphemeralApplicationRegistry(<span class="keyword">this</span>);</span><br><span class="line">    &#125; <span class="comment">// synchronized (mPackages)</span></span><br><span class="line">    &#125; <span class="comment">// synchronized (mInstallLock)</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">// Now after opening every single application zip, make sure they</span></span><br><span class="line">    <span class="comment">// are all flushed.  Not really needed, but keeps things nice and</span></span><br><span class="line">    <span class="comment">// tidy.</span></span><br><span class="line">    Runtime.getRuntime().gc();</span><br><span class="line"></span><br><span class="line">    <span class="comment">// The initial scanning above does many calls into installd while</span></span><br><span class="line">    <span class="comment">// holding the mPackages lock, but we're mostly interested in yelling</span></span><br><span class="line">    <span class="comment">// once we have a booted system.</span></span><br><span class="line">    mInstaller.setWarnIfHeld(mPackages);</span><br><span class="line"></span><br><span class="line">    <span class="comment">// Expose private service for system components to use.</span></span><br><span class="line">    LocalServices.addService(PackageManagerInternal.class, <span class="keyword">new</span> PackageManagerInternalImpl());</span><br><span class="line">    </span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>PKMS 初始化完成阶段，还会创建一个 PackageInstaller 服务。</p>
<h1 id="3-总结"><a href="#3-总结" class="headerlink" title="3 总结"></a>3 总结</h1><p>PackageManagerService 的初始化工作都是在它的构造函数中完成的，主要完成一下任务：</p>
<p>1、  添加一些用户 id，如 system、phone 等；<br>2、  解析 /system/etc/permission 下的 xml 文件，主要 是 platform.xml，建立 permission 和 gid 之间的关系，可以指定一个权限与几个组对应，当一个 apk 被授予这个权限时它也同时属于这几个组，readPermission(parser， perm)；<br>        给一些底层用户分配一些权限，如 shell 授予各种 permission，把一个权限赋予一个 uid，当 apk 使用这个 uid 运行时，就具备了这个权限系统增加的一些应用需要 link 的扩展的 jar 库，系统每增加一个硬件，都要添加相应的 featrue，将解析结果放入 mAvailableFeatures;<br>3、  建立并启动 PackageHandler 消息循环，用于处理 apk 安装请求如 adb install，package installer 安装 apk 时就会发送消息；<br>4、  检查 /data/system/packages.xml 是否存在，里面记录了系统的 permission，以及每个apk的 name，codePath，flags，ts，version，userid 等，这些信息主要是通过 apk 安装的时候解析 AndroidManifest.xml 获取到的，解析完 apk 后将更新信息写入这个文件并保存到 flash，下次开机直接从里面读取相关信息添加到内存相关列表中，当有 apk 安装，升级，删除时会更新这个文件；<br>5、  检查 BootClassPath，mSharedLibraries 及 /system/framework 下的jar是否需要 dexopt ，需要则通过 dexopt 进行优化，这里面主要是调用 mInstaller.dexopt 进行相应的优化；<br>6、  建立 java 层的 installer 与 c 层的 installd 的 socket 联接，使得在上层的 install，remove，dexopt 等功能最终由 installd 在底层实现；<br>7、  启动 AppDirObserver 线程往中监测 /system/framework，/system/app，/data/app/data/app-private 目录的事件，主要监听 add 和 remove 事件，对于目录监听底层通过 inotify 机制实现，inotify 是一种文件系统的变化通知机制如文件增加、删除等事件可以立刻让用户态得知，它为用户态监视文件系统的变化提供了强大的支持，当有 add event 时调用 scanPackageLI(File，in，int) 处理，当有 remove event 时调用 removePackageLI 处理；<br>8、  调用 scanDirLI 启动 apk 解析，解析目录包括：/system/framework、/system/app、/vendor/app、/data/app、/data/app-private；<br>9、  移除临时文件；<br>10、 赋予 package 相应请求的权限；<br>11、 将解析出的 Package 的相关信息保存到相关全局变量，还有文件。</p>
<p>后面我们会分析每个阶段的主要流程，不要着急！</p>
</div><hr></div><div class="recent-post-item article-container"><a class="article-title" href="/2017/11/25/Doze模式第 2 篇 - DeviceIdleController 动态机制/">Doze模式第 2 篇 - DeviceIdleController 动态机制</a><time class="post-meta__date"><i class="fa fa-calendar" aria-hidden="true"></i> 2017-11-25</time><span class="article-meta"><span class="article-meta__separator">|</span><i class="fa fa-inbox article-meta__icon" aria-hidden="true"></i><a class="article-meta__categories" href="/categories/AndroidFramework源码分析/">AndroidFramework源码分析</a><i class="fa fa-angle-right" aria-hidden="true"></i><i class="fa fa-inbox article-meta__icon" aria-hidden="true"></i><a class="article-meta__categories" href="/categories/AndroidFramework源码分析/Doze假寐模式/">Doze假寐模式</a></span><span class="article-meta tags"><span class="article-meta__separator">|</span><i class="fa fa-tag article-meta__icon" aria-hidden="true"></i><a class="article-meta__tags" href="/tags/Doze假寐模式/">Doze假寐模式</a></span><div class="content"><p>[toc]</p>
<p>基于 Android 7.1.1 源码，分析 doze 模式的原理！</p>
<h1 id="0-综述"><a href="#0-综述" class="headerlink" title="0 综述"></a>0 综述</h1><p>在 doze 模式下，应用会受到以下限制：</p>
<ul>
<li>暂停访问 <strong>network</strong>。</li>
<li>系统将忽略 <strong>wake locks</strong>。</li>
<li>标准 <strong>AlarmManager</strong> 闹铃（包括 setExact() 和 setWindow()）推迟到 doze 模式的下一个 maintenance window 时间窗。<ul>
<li>如果您需要设置在低电耗模式下触发的闹铃，请使用 setAndAllowWhileIdle() 或 setExactAndAllowWhileIdle()。</li>
<li>一般情况下，使用 setAlarmClock() 设置的闹铃将继续触发，但系统会在这些闹铃触发之前不久退出低电耗模式。</li>
</ul>
</li>
<li>系统不执行 <strong>Wi-Fi 扫描</strong>。</li>
<li>系统不允许运行 <strong>同步适配器</strong>。</li>
<li>系统不允许运行 <strong>JobScheduler</strong>。</li>
</ul>
<p>下面先分析下 doze 模式内部机制是如何调控的：</p>
<h1 id="1-动态监听机制"><a href="#1-动态监听机制" class="headerlink" title="1 动态监听机制"></a>1 动态监听机制</h1><h2 id="1-1-monitor-display"><a href="#1-1-monitor-display" class="headerlink" title="1.1 monitor display"></a>1.1 monitor display</h2><h3 id="1-1-1-updateDisplayLocked"><a href="#1-1-1-updateDisplayLocked" class="headerlink" title="1.1.1 updateDisplayLocked"></a>1.1.1 updateDisplayLocked</h3><p>监控屏幕状态：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">private</span> <span class="keyword">final</span> DisplayManager.DisplayListener mDisplayListener</span><br><span class="line">        = <span class="keyword">new</span> DisplayManager.DisplayListener() &#123;</span><br><span class="line">    <span class="meta">@Override</span> <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onDisplayAdded</span><span class="params">(<span class="keyword">int</span> displayId)</span> </span>&#123;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span> <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onDisplayRemoved</span><span class="params">(<span class="keyword">int</span> displayId)</span> </span>&#123;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span> <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onDisplayChanged</span><span class="params">(<span class="keyword">int</span> displayId)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">if</span> (displayId == Display.DEFAULT_DISPLAY) &#123;</span><br><span class="line">            <span class="keyword">synchronized</span> (DeviceIdleController.<span class="keyword">this</span>) &#123;</span><br><span class="line">                <span class="comment">//【1】当屏幕状态发生变化后，会触发该方法！</span></span><br><span class="line">                updateDisplayLocked();</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>
<p>我们去看看 DeviceIdleController.updateDisplayLocked 方法！</p>
<p>updateDisplayLocked 用于更新屏幕的状态！</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">updateDisplayLocked</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    <span class="comment">//【1】获取屏幕当前的状态，并判断是否是亮屏状态！</span></span><br><span class="line">    mCurDisplay = mDisplayManager.getDisplay(Display.DEFAULT_DISPLAY);</span><br><span class="line">    <span class="keyword">boolean</span> screenOn = mCurDisplay.getState() == Display.STATE_ON;</span><br><span class="line">    <span class="keyword">if</span> (DEBUG) Slog.d(TAG, <span class="string">"updateDisplayLocked: screenOn="</span> + screenOn);</span><br><span class="line">    <span class="keyword">if</span> (!screenOn &amp;&amp; mScreenOn) &#123;</span><br><span class="line">        <span class="comment">//【2.1】如果是从亮屏转为熄屏，设置 mScreenOn 为 false！</span></span><br><span class="line">        <span class="comment">// 同时，尝试进入 Doze 模式；</span></span><br><span class="line">        mScreenOn = <span class="keyword">false</span>;</span><br><span class="line">        <span class="keyword">if</span> (!mForceIdle) &#123;</span><br><span class="line">            becomeInactiveIfAppropriateLocked(); </span><br><span class="line">        &#125;</span><br><span class="line">    &#125; <span class="keyword">else</span> <span class="keyword">if</span> (screenOn) &#123;</span><br><span class="line">        <span class="comment">//【2.2】如果是从熄屏转亮屏，设置 mScreenOn 为 true！</span></span><br><span class="line">        <span class="comment">// 同时，退出 Doze 模式；</span></span><br><span class="line">        mScreenOn = <span class="keyword">true</span>;</span><br><span class="line">        <span class="keyword">if</span> (!mForceIdle) &#123;</span><br><span class="line">            becomeActiveLocked(<span class="string">"screen"</span>, Process.myUid());</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>mForceIdle 表示是否强制进入 idle 状态，默认为 false 的，目前唯一的开启方式是通过 adb shell，执行 dumpsys 命令，触发 force-idle，force-inactive 相关指令，强制进入 idle 状态！！</p>
<p>这里看到：</p>
<ul>
<li><p>当熄屏后，设置 mScreenOn 为 false，会调用 becomeInactiveIfAppropriateLocked 方法，进入 doze 模式；</p>
</li>
<li><p>当亮屏后，设置 mScreenOn 为 true，会调用 becomeActiveLocked 方法，退出 doze 模式；</p>
</li>
</ul>
<h2 id="1-2-monitor-battey"><a href="#1-2-monitor-battey" class="headerlink" title="1.2 monitor battey"></a>1.2 monitor battey</h2><h3 id="1-2-1-updateChargingLocked"><a href="#1-2-1-updateChargingLocked" class="headerlink" title="1.2.1 updateChargingLocked"></a>1.2.1 updateChargingLocked</h3><p>监控电池状态：<br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">private</span> <span class="keyword">final</span> BroadcastReceiver mReceiver = <span class="keyword">new</span> BroadcastReceiver() &#123;</span><br><span class="line">    <span class="meta">@Override</span> <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onReceive</span><span class="params">(Context context, Intent intent)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">switch</span> (intent.getAction()) &#123;</span><br><span class="line">            ... ... ...</span><br><span class="line">            <span class="keyword">case</span> Intent.ACTION_BATTERY_CHANGED: &#123;</span><br><span class="line">                <span class="keyword">synchronized</span> (DeviceIdleController.<span class="keyword">this</span>) &#123;</span><br><span class="line">                    <span class="keyword">int</span> plugged = intent.getIntExtra(<span class="string">"plugged"</span>, <span class="number">0</span>);</span><br><span class="line">                    updateChargingLocked(plugged != <span class="number">0</span>); <span class="comment">//【1】电量变化</span></span><br><span class="line">                &#125;</span><br><span class="line">            &#125; <span class="keyword">break</span>;</span><br><span class="line">            ... ... ...</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure></p>
<p>我们继续看 DeviceIdleController.updateChargingLocked 方法！<br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">updateChargingLocked</span><span class="params">(<span class="keyword">boolean</span> charging)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">if</span> (DEBUG) Slog.i(TAG, <span class="string">"updateChargingLocked: charging="</span> + charging);</span><br><span class="line">    <span class="keyword">if</span> (!charging &amp;&amp; mCharging) &#123;</span><br><span class="line">        <span class="comment">//【1】结束充电！</span></span><br><span class="line">        mCharging = <span class="keyword">false</span>;</span><br><span class="line">        <span class="keyword">if</span> (!mForceIdle) &#123;</span><br><span class="line">            <span class="comment">//【2.1】尝试进入 doze 模式！</span></span><br><span class="line">            becomeInactiveIfAppropriateLocked();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125; <span class="keyword">else</span> <span class="keyword">if</span> (charging) &#123;</span><br><span class="line">        <span class="comment">//【2】开始充电！</span></span><br><span class="line">        mCharging = charging;</span><br><span class="line">        <span class="keyword">if</span> (!mForceIdle) &#123;</span><br><span class="line">            <span class="comment">//【2.2】退出 doze 模式！</span></span><br><span class="line">            becomeActiveLocked(<span class="string">"charging"</span>, Process.myUid());</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>这里看到：</p>
<ul>
<li><p>当结束充电后，设置 mCharging 为 false，会调用 becomeInactiveIfAppropriateLocked 方法，进入 doze 模式；</p>
</li>
<li><p>当开始充电后，设置 mCharging 为 true，会调用 becomeActiveLocked 方法，退出 doze 模式；</p>
</li>
</ul>
<h2 id="1-3-monitor-connectivity"><a href="#1-3-monitor-connectivity" class="headerlink" title="1.3 monitor connectivity"></a>1.3 monitor connectivity</h2><h3 id="1-3-1-updateConnectivityState"><a href="#1-3-1-updateConnectivityState" class="headerlink" title="1.3.1 updateConnectivityState"></a>1.3.1 updateConnectivityState</h3><p>监控网络连接状态：<br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">private</span> <span class="keyword">final</span> BroadcastReceiver mReceiver = <span class="keyword">new</span> BroadcastReceiver() &#123;</span><br><span class="line">    <span class="meta">@Override</span> <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onReceive</span><span class="params">(Context context, Intent intent)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">switch</span> (intent.getAction()) &#123;</span><br><span class="line">            <span class="keyword">case</span> ConnectivityManager.CONNECTIVITY_ACTION: &#123;</span><br><span class="line">                <span class="comment">//【1】更新网络连接状态！</span></span><br><span class="line">                updateConnectivityState(intent);</span><br><span class="line">            &#125; <span class="keyword">break</span>;</span><br><span class="line">            ... ... ...</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure></p>
<p>我们继续看 DeviceIdleController.updateConnectivityState 方法！<br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">updateConnectivityState</span><span class="params">(Intent connIntent)</span> </span>&#123;</span><br><span class="line">    ConnectivityService cm;</span><br><span class="line">    <span class="keyword">synchronized</span> (<span class="keyword">this</span>) &#123;</span><br><span class="line">        cm = mConnectivityService;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span> (cm == <span class="keyword">null</span>) &#123;</span><br><span class="line">        <span class="keyword">return</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    NetworkInfo ni = cm.getActiveNetworkInfo();</span><br><span class="line">    <span class="keyword">synchronized</span> (<span class="keyword">this</span>) &#123;</span><br><span class="line">        <span class="keyword">boolean</span> conn;</span><br><span class="line">        <span class="keyword">if</span> (ni == <span class="keyword">null</span>) &#123;</span><br><span class="line">            conn = <span class="keyword">false</span>; <span class="comment">//【1】网络断开，conn 为 false；</span></span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            <span class="comment">//【2】获得网络的连接状态；</span></span><br><span class="line">            <span class="keyword">if</span> (connIntent == <span class="keyword">null</span>) &#123;</span><br><span class="line">                conn = ni.isConnected();</span><br><span class="line">            &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                <span class="keyword">final</span> <span class="keyword">int</span> networkType =</span><br><span class="line">                        connIntent.getIntExtra(ConnectivityManager.EXTRA_NETWORK_TYPE,</span><br><span class="line">                                ConnectivityManager.TYPE_NONE);</span><br><span class="line">                <span class="keyword">if</span> (ni.getType() != networkType) &#123;</span><br><span class="line">                    <span class="keyword">return</span>;</span><br><span class="line">                &#125;</span><br><span class="line">                conn = !connIntent.getBooleanExtra(ConnectivityManager.EXTRA_NO_CONNECTIVITY,</span><br><span class="line">                        <span class="keyword">false</span>);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">//【3】处理连接状态，如果当前状态和之前的状态发生了变化，更新 mNetworkConnected 的值！</span></span><br><span class="line">        <span class="keyword">if</span> (conn != mNetworkConnected) &#123;</span><br><span class="line">            mNetworkConnected = conn;</span><br><span class="line">            <span class="keyword">if</span> (conn &amp;&amp; mLightState == LIGHT_STATE_WAITING_FOR_NETWORK) &#123;</span><br><span class="line">                <span class="comment">//【2.3】如果本次状态是处于连接中，并且 mLightState 值为 LIGHT_STATE_WAITING_FOR_NETWORK！</span></span><br><span class="line">                <span class="comment">// 调用 stepLightIdleStateLocked 方法！</span></span><br><span class="line">                stepLightIdleStateLocked(<span class="string">"network"</span>);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>mNetworkConnected 表示之前的网络连接！</p>
<h2 id="1-4-monitor-Motion"><a href="#1-4-monitor-Motion" class="headerlink" title="1.4 monitor Motion"></a>1.4 monitor Motion</h2><h3 id="1-4-1-startMonitoringMotionLocked"><a href="#1-4-1-startMonitoringMotionLocked" class="headerlink" title="1.4.1 startMonitoringMotionLocked"></a>1.4.1 startMonitoringMotionLocked</h3><p>监听设备的运动：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">startMonitoringMotionLocked</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    <span class="keyword">if</span> (DEBUG) Slog.d(TAG, <span class="string">"startMonitoringMotionLocked()"</span>);</span><br><span class="line">    <span class="keyword">if</span> (mMotionSensor != <span class="keyword">null</span> &amp;&amp; !mMotionListener.active) &#123;</span><br><span class="line">        mMotionListener.registerLocked();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>DeviceIdleController 内部有一个 mMotionListener 对象，用于监听传感器的变化！</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">private</span> <span class="keyword">final</span> MotionListener mMotionListener = <span class="keyword">new</span> MotionListener();</span><br></pre></td></tr></table></figure>
<p>我们来看下 MotionListener 中的方法！</p>
<h4 id="1-4-1-1-mMotionListener-registerLocked"><a href="#1-4-1-1-mMotionListener-registerLocked" class="headerlink" title="1.4.1.1 mMotionListener.registerLocked"></a>1.4.1.1 mMotionListener.registerLocked</h4><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">private</span> <span class="keyword">final</span> <span class="class"><span class="keyword">class</span> <span class="title">MotionListener</span> <span class="keyword">extends</span> <span class="title">TriggerEventListener</span></span></span><br><span class="line"><span class="class">        <span class="keyword">implements</span> <span class="title">SensorEventListener</span> </span>&#123;</span><br><span class="line">    <span class="keyword">boolean</span> active = <span class="keyword">false</span>; <span class="comment">// 表示 MotionListener 是否被注册！</span></span><br><span class="line">    </span><br><span class="line">    <span class="comment">//【1】当传感器的被触发后，会调用 onTrigger()</span></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onTrigger</span><span class="params">(TriggerEvent event)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">synchronized</span> (DeviceIdleController.<span class="keyword">this</span>) &#123;</span><br><span class="line">            active = <span class="keyword">false</span>;</span><br><span class="line">            <span class="comment">//【1.4.1.2】调用 motionLocked 方法！</span></span><br><span class="line">            motionLocked();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">//【2】当传感器的值发生变化时，会调用 OnSensorChanged()</span></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onSensorChanged</span><span class="params">(SensorEvent event)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">synchronized</span> (DeviceIdleController.<span class="keyword">this</span>) &#123;</span><br><span class="line">            mSensorManager.unregisterListener(<span class="keyword">this</span>, mMotionSensor);</span><br><span class="line">            active = <span class="keyword">false</span>;</span><br><span class="line">            <span class="comment">//【1.4.1.2】调用 motionLocked 方法！</span></span><br><span class="line">            motionLocked();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 当传感器的精度发生变化时会调用 OnAccuracyChanged() 方法!</span></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onAccuracyChanged</span><span class="params">(Sensor sensor, <span class="keyword">int</span> accuracy)</span> </span>&#123;&#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//【3】注册 MotionListener！</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">boolean</span> <span class="title">registerLocked</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">boolean</span> success;</span><br><span class="line">        <span class="comment">//【1.1】调用了 mSensorManager 的相关方法注册监听器！</span></span><br><span class="line">        <span class="keyword">if</span> (mMotionSensor.getReportingMode() == Sensor.REPORTING_MODE_ONE_SHOT) &#123;</span><br><span class="line">            success = mSensorManager.requestTriggerSensor(mMotionListener, mMotionSensor);</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            success = mSensorManager.registerListener(</span><br><span class="line">                    mMotionListener, mMotionSensor, SensorManager.SENSOR_DELAY_NORMAL);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">if</span> (success) &#123;</span><br><span class="line">            active = <span class="keyword">true</span>; <span class="comment">//【1.2】设置监听器为活跃状态！</span></span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            Slog.e(TAG, <span class="string">"Unable to register for "</span> + mMotionSensor);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> success;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//【4】解除注册 MotionListener！</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">unregisterLocked</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">if</span> (mMotionSensor.getReportingMode() == Sensor.REPORTING_MODE_ONE_SHOT) &#123;</span><br><span class="line">            mSensorManager.cancelTriggerSensor(mMotionListener, mMotionSensor);</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            mSensorManager.unregisterListener(mMotionListener);</span><br><span class="line">        &#125;</span><br><span class="line">        active = <span class="keyword">false</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>继续看：</p>
<h4 id="1-4-1-2-DeviceIdleC-motionLocked"><a href="#1-4-1-2-DeviceIdleC-motionLocked" class="headerlink" title="1.4.1.2 DeviceIdleC.motionLocked"></a>1.4.1.2 DeviceIdleC.motionLocked</h4><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">motionLocked</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    <span class="keyword">if</span> (DEBUG) Slog.d(TAG, <span class="string">"motionLocked()"</span>);</span><br><span class="line">    <span class="comment">//【1.4.1.3】调用 handleMotionDetectedLocked 处理传感器变化！</span></span><br><span class="line">    handleMotionDetectedLocked(mConstants.MOTION_INACTIVE_TIMEOUT, <span class="string">"motion"</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h4 id="1-4-1-3-DeviceIdleC-handleMotionDetectedLocked"><a href="#1-4-1-3-DeviceIdleC-handleMotionDetectedLocked" class="headerlink" title="1.4.1.3 DeviceIdleC.handleMotionDetectedLocked"></a>1.4.1.3 DeviceIdleC.handleMotionDetectedLocked</h4><p>由于此时传感器被触发或者值发生了变化，那么此时我们不能进入 doze 模式，需要回退到 active 状态！！</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">handleMotionDetectedLocked</span><span class="params">(<span class="keyword">long</span> timeout, String type)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">boolean</span> becomeInactive = <span class="keyword">false</span>;</span><br><span class="line">    <span class="comment">//【1】处理 deep idle 模式的退出！！</span></span><br><span class="line">    <span class="keyword">if</span> (mState != STATE_ACTIVE) &#123;</span><br><span class="line">        <span class="comment">//【2.2.1】调用了 scheduleReportActiveLocked，退出 doze 模式，恢复 active 状态！</span></span><br><span class="line">        scheduleReportActiveLocked(type, Process.myUid());</span><br><span class="line">        mState = STATE_ACTIVE;</span><br><span class="line">        mInactiveTimeout = timeout;</span><br><span class="line">        mCurIdleBudget = <span class="number">0</span>;</span><br><span class="line">        mMaintenanceStartTime = <span class="number">0</span>;</span><br><span class="line">        </span><br><span class="line">        EventLogTags.writeDeviceIdle(mState, type);</span><br><span class="line">        addEvent(EVENT_NORMAL);</span><br><span class="line"></span><br><span class="line">        becomeInactive = <span class="keyword">true</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">//【1】处理 light idle 模式的退出，我们只有在退出 deep idle 时才会同时退出 light idle！！</span></span><br><span class="line">    <span class="keyword">if</span> (mLightState == LIGHT_STATE_OVERRIDE) &#123;</span><br><span class="line">        mLightState = STATE_ACTIVE;</span><br><span class="line">        EventLogTags.writeDeviceIdleLight(mLightState, type);</span><br><span class="line">        becomeInactive = <span class="keyword">true</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//【2.1】这里 becomeInactive 为 true 时，会重新调用 becomeInactiveIfAppropriateLocked 方法</span></span><br><span class="line">    <span class="comment">// 重新开始了阶段条件的判断！</span></span><br><span class="line">    <span class="keyword">if</span> (becomeInactive) &#123;</span><br><span class="line">        becomeInactiveIfAppropriateLocked();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>这里就先分析到这里！</p>
<h2 id="1-5-monitor-Angle"><a href="#1-5-monitor-Angle" class="headerlink" title="1.5 monitor Angle"></a>1.5 monitor Angle</h2><h3 id="1-5-1-AnyMotionDetector-checkForAnyMotion"><a href="#1-5-1-AnyMotionDetector-checkForAnyMotion" class="headerlink" title="1.5.1 AnyMotionDetector.checkForAnyMotion"></a>1.5.1 AnyMotionDetector.checkForAnyMotion</h3><p>监听设备的角度变化，我们在 onStart 方法中有创建一个 AnyMotionDetector 实例，用于监听设备的角度变化是否超过阈值！</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//【1】获得角度阈值；</span></span><br><span class="line"><span class="keyword">float</span> angleThreshold = getContext().getResources().getInteger(</span><br><span class="line">        com.android.internal.R.integer.config_autoPowerModeThresholdAngle) / <span class="number">100f</span>;</span><br><span class="line"><span class="comment">//【2】创建角度变化监听器；</span></span><br><span class="line">mAnyMotionDetector = <span class="keyword">new</span> AnyMotionDetector(</span><br><span class="line">        (PowerManager) getContext().getSystemService(Context.POWER_SERVICE),</span><br><span class="line">        mHandler, mSensorManager, <span class="keyword">this</span>, angleThreshold);</span><br></pre></td></tr></table></figure>
<p>这里面最关键的一个参数是 AnyMotionDetector 的倒数第二个参数：DeviceIdleCallback callback，这里传入的是 DeviceIdleController，因为 DeviceIdleController 实现了 AnyMotionDetector.DeviceIdleCallback！</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">AnyMotionDetector</span> </span>&#123;</span><br><span class="line">    <span class="class"><span class="keyword">interface</span> <span class="title">DeviceIdleCallback</span> </span>&#123;</span><br><span class="line">        <span class="comment">//【1.5.2】onAnyMotionResult 处理角度的变化；</span></span><br><span class="line">        <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onAnyMotionResult</span><span class="params">(<span class="keyword">int</span> result)</span></span>;</span><br><span class="line">    &#125;</span><br><span class="line">    ... ... ...</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>当角度发生变化后，会触发 onAnyMotionResult 回调！</p>
<h3 id="1-5-2-DeviceIdleC-onAnyMotionResult"><a href="#1-5-2-DeviceIdleC-onAnyMotionResult" class="headerlink" title="1.5.2 DeviceIdleC.onAnyMotionResult"></a>1.5.2 DeviceIdleC.onAnyMotionResult</h3><p>我们来看看 onAnyMotionResult 方法！<br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onAnyMotionResult</span><span class="params">(<span class="keyword">int</span> result)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">if</span> (DEBUG) Slog.d(TAG, <span class="string">"onAnyMotionResult("</span> + result + <span class="string">")"</span>);</span><br><span class="line">    <span class="comment">//【1】正常情况，首先取消 mSensingTimeoutAlarmListener；</span></span><br><span class="line">    <span class="keyword">if</span> (result != AnyMotionDetector.RESULT_UNKNOWN) &#123;</span><br><span class="line">        <span class="keyword">synchronized</span> (<span class="keyword">this</span>) &#123;</span><br><span class="line">            <span class="comment">//【1.1.1.1.2】调用 cancelSensingTimeoutAlarmLocked 取消；</span></span><br><span class="line">            cancelSensingTimeoutAlarmLocked();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//【2】当 result 为 RESULT_MOVED，说明角度变化超过了阈值；</span></span><br><span class="line">    <span class="keyword">if</span> ((result == AnyMotionDetector.RESULT_MOVED) ||</span><br><span class="line">        (result == AnyMotionDetector.RESULT_UNKNOWN)) &#123;</span><br><span class="line">        <span class="keyword">synchronized</span> (<span class="keyword">this</span>) &#123;</span><br><span class="line">            <span class="comment">//【1.4.3】不处于静止状态，又调用了 handleMotionDetectedLocked 方法，恢复 active 状态；</span></span><br><span class="line">            handleMotionDetectedLocked(mConstants.INACTIVE_TIMEOUT, <span class="string">"non_stationary"</span>);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">    &#125; <span class="keyword">else</span> <span class="keyword">if</span> (result == AnyMotionDetector.RESULT_STATIONARY) &#123;</span><br><span class="line">        <span class="comment">//【3】当 result 为 RESULT_STATIONARY，说明角度并没有发生超过阈值的变化；</span></span><br><span class="line">        <span class="keyword">if</span> (mState == STATE_SENSING) &#123;</span><br><span class="line">            <span class="comment">//【3.1】当 mState 是 STATE_SENSING，那么我们会进入下一阶段；</span></span><br><span class="line">            <span class="keyword">synchronized</span> (<span class="keyword">this</span>) &#123;</span><br><span class="line">                <span class="comment">// 设置 STATE_SENSING 为 true！</span></span><br><span class="line">                mNotMoving = <span class="keyword">true</span>; </span><br><span class="line">                stepIdleStateLocked(<span class="string">"s:stationary"</span>);</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">        &#125; <span class="keyword">else</span> <span class="keyword">if</span> (mState == STATE_LOCATING) &#123;</span><br><span class="line">            <span class="comment">//【3.1】当 mState 是 STATE_LOCATING，那么我们同样会进入下一阶段；</span></span><br><span class="line">            <span class="keyword">synchronized</span> (<span class="keyword">this</span>) &#123;</span><br><span class="line">                mNotMoving = <span class="keyword">true</span>;</span><br><span class="line">                <span class="keyword">if</span> (mLocated) &#123;</span><br><span class="line">                    stepIdleStateLocked(<span class="string">"s:stationary"</span>);</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<h2 id="1-6-monitor-Location-监听位置"><a href="#1-6-monitor-Location-监听位置" class="headerlink" title="1.6 monitor Location - 监听位置"></a>1.6 monitor Location - 监听位置</h2><p>监控定位：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//【1】监听网络定位 network location provider！</span></span><br><span class="line"><span class="keyword">if</span> (mLocationManager != <span class="keyword">null</span></span><br><span class="line">        &amp;&amp; mLocationManager.getProvider(LocationManager.NETWORK_PROVIDER) != <span class="keyword">null</span>) &#123;</span><br><span class="line">    mLocationManager.requestLocationUpdates(mLocationRequest,</span><br><span class="line">            mGenericLocationListener, mHandler.getLooper()); <span class="comment">//【1.6.1】</span></span><br><span class="line">    mLocating = <span class="keyword">true</span>;</span><br><span class="line">&#125; <span class="keyword">else</span> &#123;</span><br><span class="line">    mHasNetworkLocation = <span class="keyword">false</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">//【2】监听 GPS location provider！</span></span><br><span class="line"><span class="keyword">if</span> (mLocationManager != <span class="keyword">null</span></span><br><span class="line">        &amp;&amp; mLocationManager.getProvider(LocationManager.GPS_PROVIDER) != <span class="keyword">null</span>) &#123;</span><br><span class="line">    mHasGps = <span class="keyword">true</span>;</span><br><span class="line">    mLocationManager.requestLocationUpdates(LocationManager.GPS_PROVIDER, <span class="number">1000</span>, <span class="number">5</span>,</span><br><span class="line">            mGpsLocationListener, mHandler.getLooper());  <span class="comment">//【1.6.2】</span></span><br><span class="line">    mLocating = <span class="keyword">true</span>;</span><br><span class="line">&#125; <span class="keyword">else</span> &#123;</span><br><span class="line">    mHasGps = <span class="keyword">false</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>我们看到，这里向 LocationManager 中注册了两个监听器：mGenericLocationListener 和 mGpsLocationListener！</p>
<h3 id="1-6-1-mGenericLocationListener-onLocationChanged"><a href="#1-6-1-mGenericLocationListener-onLocationChanged" class="headerlink" title="1.6.1 mGenericLocationListener.onLocationChanged"></a>1.6.1 mGenericLocationListener.onLocationChanged</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">private</span> <span class="keyword">final</span> LocationListener mGenericLocationListener = <span class="keyword">new</span> LocationListener() &#123;</span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onLocationChanged</span><span class="params">(Location location)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">synchronized</span> (DeviceIdleController.<span class="keyword">this</span>) &#123;</span><br><span class="line">            <span class="comment">//【1.6.1.1】处理定位的变化！</span></span><br><span class="line">            receivedGenericLocationLocked(location);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    ... ... ... ... <span class="comment">// 省去无需关注！</span></span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>
<p>当定位发生变化后，onLocationChanged 触发！</p>
<h4 id="1-6-1-1-DeviceIdleC-receivedGenericLocationLocked"><a href="#1-6-1-1-DeviceIdleC-receivedGenericLocationLocked" class="headerlink" title="1.6.1.1 DeviceIdleC.receivedGenericLocationLocked"></a>1.6.1.1 DeviceIdleC.receivedGenericLocationLocked</h4><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">receivedGenericLocationLocked</span><span class="params">(Location location)</span> </span>&#123;</span><br><span class="line">    <span class="comment">//【1】判断下 mState，如果不是 STATE_LOCATING，就调用 cancelLocatingLocked，取消定位监听！</span></span><br><span class="line">    <span class="keyword">if</span> (mState != STATE_LOCATING) &#123;</span><br><span class="line">        cancelLocatingLocked();</span><br><span class="line">        <span class="keyword">return</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span> (DEBUG) Slog.d(TAG, <span class="string">"Generic location: "</span> + location);</span><br><span class="line">    <span class="comment">//【2】将定位信息保存到 mLastGenericLocation 中，用于 dumpsys！</span></span><br><span class="line">    mLastGenericLocation = <span class="keyword">new</span> Location(location);</span><br><span class="line">    <span class="comment">// 如果定位精度超过 mConstants.LOCATION_ACCURACY(20meter)，直接返回，不进入下一阶段；</span></span><br><span class="line">    <span class="keyword">if</span> (location.getAccuracy() &gt; mConstants.LOCATION_ACCURACY &amp;&amp; mHasGps) &#123;</span><br><span class="line">        <span class="keyword">return</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">//【3】设置 mLocated 为 true，表示定位完成！</span></span><br><span class="line">    mLocated = <span class="keyword">true</span>;</span><br><span class="line">    <span class="keyword">if</span> (mNotMoving) &#123;</span><br><span class="line">        <span class="comment">//【3.1】如果此时手机没有发生移动，调用 stepIdleStateLocked 处理 STATE_LOCATING 状态！</span></span><br><span class="line">        stepIdleStateLocked(<span class="string">"s:location"</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>不多说！</p>
<h3 id="1-6-2-mGpsLocationListener-onLocationChanged"><a href="#1-6-2-mGpsLocationListener-onLocationChanged" class="headerlink" title="1.6.2 mGpsLocationListener.onLocationChanged"></a>1.6.2 mGpsLocationListener.onLocationChanged</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">private final LocationListener mGpsLocationListener = new LocationListener() &#123;</span><br><span class="line">    @Override</span><br><span class="line">    public void onLocationChanged(Location location) &#123;</span><br><span class="line">        synchronized (DeviceIdleController.this) &#123;</span><br><span class="line">            //【1.6.2.1】处理定位的变化！</span><br><span class="line">            receivedGpsLocationLocked(location);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    ... ... ... ... ... // 省去无需关注！</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>
<p>当定位发生变化后，onLocationChanged 触发！</p>
<h4 id="1-6-2-1-DeviceIdleC-receivedGpsLocationLocked"><a href="#1-6-2-1-DeviceIdleC-receivedGpsLocationLocked" class="headerlink" title="1.6.2.1 DeviceIdleC.receivedGpsLocationLocked"></a>1.6.2.1 DeviceIdleC.receivedGpsLocationLocked</h4><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">receivedGpsLocationLocked</span><span class="params">(Location location)</span> </span>&#123;</span><br><span class="line">    <span class="comment">//【1】判断下 mState，如果不是 STATE_LOCATING，就调用 cancelLocatingLocked，取消定位监听！</span></span><br><span class="line">    <span class="keyword">if</span> (mState != STATE_LOCATING) &#123;</span><br><span class="line">        cancelLocatingLocked();</span><br><span class="line">        <span class="keyword">return</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span> (DEBUG) Slog.d(TAG, <span class="string">"GPS location: "</span> + location);</span><br><span class="line">    <span class="comment">//【2】将定位信息保存到 mLastGpsLocation 中，用于 dumpsys！</span></span><br><span class="line">    mLastGpsLocation = <span class="keyword">new</span> Location(location);</span><br><span class="line">    <span class="comment">// 如果定位精度超过 mConstants.LOCATION_ACCURACY(20meter)，直接返回，不进入下一阶段；</span></span><br><span class="line">    <span class="keyword">if</span> (location.getAccuracy() &gt; mConstants.LOCATION_ACCURACY) &#123;</span><br><span class="line">        <span class="keyword">return</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">//【3】设置 mLocated 为 true，表示定位完成！</span></span><br><span class="line">    mLocated = <span class="keyword">true</span>;</span><br><span class="line">    <span class="keyword">if</span> (mNotMoving) &#123;</span><br><span class="line">        <span class="comment">//【3.1】如果此时手机没有发生移动，调用 stepIdleStateLocked 处理 STATE_LOCATING 状态！</span></span><br><span class="line">        stepIdleStateLocked(<span class="string">"s:gps"</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>不多说！</p>
<h1 id="2-核心逻辑分析"><a href="#2-核心逻辑分析" class="headerlink" title="2 核心逻辑分析"></a>2 核心逻辑分析</h1><h2 id="2-1-DeviceIdleC-becomeInactiveIfAppropriateLocked"><a href="#2-1-DeviceIdleC-becomeInactiveIfAppropriateLocked" class="headerlink" title="2.1 DeviceIdleC.becomeInactiveIfAppropriateLocked"></a>2.1 DeviceIdleC.becomeInactiveIfAppropriateLocked</h2><p>尝试进入 doze 模式，这里会对 doze 模式第一阶段的条件做一个处理！！<br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">becomeInactiveIfAppropriateLocked</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    <span class="keyword">if</span> (DEBUG) Slog.d(TAG, <span class="string">"becomeInactiveIfAppropriateLocked()"</span>);</span><br><span class="line">    <span class="comment">//【1】如果是熄屏并且没有充电的充电的情况下，或者是强制进入 idle 状态下！</span></span><br><span class="line">    <span class="keyword">if</span> ((!mScreenOn &amp;&amp; !mCharging) || mForceIdle) &#123;</span><br><span class="line">        <span class="comment">//【1.1】处理 deep idle 模式逻辑！！</span></span><br><span class="line">        <span class="keyword">if</span> (mState == STATE_ACTIVE &amp;&amp; mDeepEnabled) &#123;</span><br><span class="line">            mState = STATE_INACTIVE;</span><br><span class="line">            <span class="keyword">if</span> (DEBUG) Slog.d(TAG, <span class="string">"Moved from STATE_ACTIVE to STATE_INACTIVE"</span>);</span><br><span class="line">            <span class="comment">//【5.1】重置相关变量！！</span></span><br><span class="line">            resetIdleManagementLocked();</span><br><span class="line">            <span class="comment">//【2.1.1.1】设置 alarm，用于进入下一阶段！！</span></span><br><span class="line">            scheduleAlarmLocked(mInactiveTimeout, <span class="keyword">false</span>);</span><br><span class="line"></span><br><span class="line">            EventLogTags.writeDeviceIdle(mState, <span class="string">"no activity"</span>);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">//【1.2】处理 light idle 模式逻辑！！</span></span><br><span class="line">        <span class="keyword">if</span> (mLightState == LIGHT_STATE_ACTIVE &amp;&amp; mLightEnabled) &#123;</span><br><span class="line">            mLightState = LIGHT_STATE_INACTIVE;</span><br><span class="line">            <span class="keyword">if</span> (DEBUG) Slog.d(TAG, <span class="string">"Moved from LIGHT_STATE_ACTIVE to LIGHT_STATE_INACTIVE"</span>);</span><br><span class="line">            <span class="comment">//【5.2】重置相关变量！！</span></span><br><span class="line">            resetLightIdleManagementLocked();</span><br><span class="line">            <span class="comment">//【2.1.2.1】设置 alarm！！</span></span><br><span class="line">            scheduleLightAlarmLocked(mConstants.LIGHT_IDLE_AFTER_INACTIVE_TIMEOUT);</span><br><span class="line"></span><br><span class="line">            EventLogTags.writeDeviceIdleLight(mLightState, <span class="string">"no activity"</span>);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>首先判断了条件：</p>
<ul>
<li>如果是熄屏并且没有充电的充电的情况下，或者是强制进入 idle 状态下！</li>
</ul>
<p>然后针对 deep idle 和 light idle 两种模式，做了不同的处理！</p>
<h3 id="2-1-1-deep-idle-逻辑"><a href="#2-1-1-deep-idle-逻辑" class="headerlink" title="2.1.1 deep idle 逻辑"></a>2.1.1 deep idle 逻辑</h3><p>首先，设置 mState 从 STATE_ACTIVE 为 STATE_INACTIVE；</p>
<p>然后，重置 deep idle 逻辑相关的变量，取消 Alarm 和监控器！！</p>
<p>最后，设置 deep idle 的 Alarm：</p>
<h4 id="2-1-1-1-scheduleAlarmLocked"><a href="#2-1-1-1-scheduleAlarmLocked" class="headerlink" title="2.1.1.1 scheduleAlarmLocked"></a>2.1.1.1 scheduleAlarmLocked</h4><p>设置 deep idle 的 Alarm：</p>
<p>参数传递：</p>
<ul>
<li><p>long delay 传入的是 mInactiveTimeout，mInactiveTimeout 在 onStat 方法中被初始化为 mConstants.INACTIVE_TIMEOUT 为 30 mins;</p>
</li>
<li><p>boolean idleUntil 传入的是 false，因为还没有进入 idle 状态！</p>
</li>
</ul>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">scheduleAlarmLocked</span><span class="params">(<span class="keyword">long</span> delay, <span class="keyword">boolean</span> idleUntil)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">if</span> (DEBUG) Slog.d(TAG, <span class="string">"scheduleAlarmLocked("</span> + delay + <span class="string">", "</span> + idleUntil + <span class="string">")"</span>);</span><br><span class="line">    <span class="keyword">if</span> (mMotionSensor == <span class="keyword">null</span>) &#123;</span><br><span class="line">        <span class="comment">//【1】如果当前设备没有运动传感器，那就不会设置 alarm，因为无法判断设备是否移动！</span></span><br><span class="line">        <span class="keyword">return</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">//【2】计算 alarm 的触发时间！</span></span><br><span class="line">    mNextAlarmTime = SystemClock.elapsedRealtime() + delay;</span><br><span class="line">    <span class="keyword">if</span> (idleUntil) &#123;</span><br><span class="line">        mAlarmManager.setIdleUntil(AlarmManager.ELAPSED_REALTIME_WAKEUP,</span><br><span class="line">                mNextAlarmTime, <span class="string">"DeviceIdleController.deep"</span>, mDeepAlarmListener, mHandler);</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        <span class="comment">//【2.1.1.2】idleUntil 为 false，设置一个 delay 时间间隔后的 Alarm！</span></span><br><span class="line">        mAlarmManager.set(AlarmManager.ELAPSED_REALTIME_WAKEUP,</span><br><span class="line">                mNextAlarmTime, <span class="string">"DeviceIdleController.deep"</span>, mDeepAlarmListener, mHandler);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>在 delay 时间间隔后会触发 mDeepAlarmListener，在 mHandler 所在的线程执行！</p>
<h4 id="2-1-1-2-mDeepAlarmListener-onAlarm"><a href="#2-1-1-2-mDeepAlarmListener-onAlarm" class="headerlink" title="2.1.1.2 mDeepAlarmListener.onAlarm"></a>2.1.1.2 mDeepAlarmListener.onAlarm</h4><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">private</span> <span class="keyword">final</span> AlarmManager.OnAlarmListener mDeepAlarmListener</span><br><span class="line">        = <span class="keyword">new</span> AlarmManager.OnAlarmListener() &#123;</span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onAlarm</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">synchronized</span> (DeviceIdleController.<span class="keyword">this</span>) &#123;</span><br><span class="line"></span><br><span class="line">            <span class="comment">//【2.3】第一阶段条件满足！</span></span><br><span class="line">            stepIdleStateLocked(<span class="string">"s:alarm"</span>);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>
<p>当设备处于熄屏并且未充电 30 mins 以后，DeepAlarmListener 会被触发，这时 deep idle 模式的第一阶段条件满足，执行 stepIdleStateLocked 方法！</p>
<h3 id="2-1-2-light-idle-逻辑"><a href="#2-1-2-light-idle-逻辑" class="headerlink" title="2.1.2 light idle 逻辑"></a>2.1.2 light idle 逻辑</h3><p>回顾下流程：</p>
<ul>
<li>首先，设置 mLightState 从 LIGHT_STATE_ACTIVE 变为 LIGHT_STATE_INACTIVE；</li>
<li>然后，同样的重置相关变量；</li>
<li>最后，设置 light idle 的 alarm；</li>
</ul>
<h4 id="2-1-2-1-scheduleLightAlarmLocked"><a href="#2-1-2-1-scheduleLightAlarmLocked" class="headerlink" title="2.1.2.1 scheduleLightAlarmLocked"></a>2.1.2.1 scheduleLightAlarmLocked</h4><p>设置 light idle 的 Alarm，参数 long delay 传入：mConstants.LIGHT_IDLE_AFTER_INACTIVE_TIMEOUT 为 5 mins！<br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">scheduleLightAlarmLocked</span><span class="params">(<span class="keyword">long</span> delay)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">if</span> (DEBUG) Slog.d(TAG, <span class="string">"scheduleLightAlarmLocked("</span> + delay + <span class="string">")"</span>);</span><br><span class="line">    mNextLightAlarmTime = SystemClock.elapsedRealtime() + delay;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//【2.1.2.2】设置一个时间间隔为 delay 后的 alarm，用于触发 mLightAlarmListener！</span></span><br><span class="line">    mAlarmManager.set(AlarmManager.ELAPSED_REALTIME_WAKEUP,</span><br><span class="line">            mNextLightAlarmTime, <span class="string">"DeviceIdleController.light"</span>, mLightAlarmListener, mHandler);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>设置一个时间间隔为 delay 后的 alarm，用于触发 mLightAlarmListener！</p>
<h4 id="2-1-2-2-mLightAlarmListener-onAlarm"><a href="#2-1-2-2-mLightAlarmListener-onAlarm" class="headerlink" title="2.1.2.2 mLightAlarmListener.onAlarm"></a>2.1.2.2 mLightAlarmListener.onAlarm</h4><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">private</span> <span class="keyword">final</span> AlarmManager.OnAlarmListener mLightAlarmListener</span><br><span class="line">        = <span class="keyword">new</span> AlarmManager.OnAlarmListener() &#123;</span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onAlarm</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">synchronized</span> (DeviceIdleController.<span class="keyword">this</span>) &#123;</span><br><span class="line">            <span class="comment">//【3.2】进入 light idle 模式的第一阶段条件满足！</span></span><br><span class="line">            stepLightIdleStateLocked(<span class="string">"s:alarm"</span>);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>
<p>当设备处于熄屏并且未充电 5 mins 以后，mLightAlarmListener.onAlarm 会被触发，这时 light idle 模式的第一阶段条件满足，执行 stepIdleStateLocked 方法！</p>
<h2 id="2-2-DeviceIdleC-becomeActiveLocked-退出-doze-模式"><a href="#2-2-DeviceIdleC-becomeActiveLocked-退出-doze-模式" class="headerlink" title="2.2 DeviceIdleC.becomeActiveLocked - 退出 doze 模式"></a>2.2 DeviceIdleC.becomeActiveLocked - 退出 doze 模式</h2><p>退出 doze 模式！</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">becomeActiveLocked</span><span class="params">(String activeReason, <span class="keyword">int</span> activeUid)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">if</span> (DEBUG) Slog.i(TAG, <span class="string">"becomeActiveLocked, reason = "</span> + activeReason);</span><br><span class="line">    <span class="comment">//【1】如果 mState 不等于 STATE_ACTIVE 或者 mLightState 不等于 STATE_ACTIVE！</span></span><br><span class="line">    <span class="keyword">if</span> (mState != STATE_ACTIVE || mLightState != STATE_ACTIVE) &#123;</span><br><span class="line">        EventLogTags.writeDeviceIdle(STATE_ACTIVE, activeReason);</span><br><span class="line">        EventLogTags.writeDeviceIdleLight(LIGHT_STATE_ACTIVE, activeReason);</span><br><span class="line">        </span><br><span class="line">        <span class="comment">//【2.2.1】调用了 scheduleReportActiveLocked，退出 doze 模式，恢复 active 状态！</span></span><br><span class="line">        scheduleReportActiveLocked(activeReason, activeUid);</span><br><span class="line">        </span><br><span class="line">        <span class="comment">// 重置关键变量！</span></span><br><span class="line">        mState = STATE_ACTIVE;</span><br><span class="line">        mLightState = LIGHT_STATE_ACTIVE;</span><br><span class="line">        mInactiveTimeout = mConstants.INACTIVE_TIMEOUT;</span><br><span class="line">        mCurIdleBudget = <span class="number">0</span>;</span><br><span class="line">        mMaintenanceStartTime = <span class="number">0</span>;</span><br><span class="line">        </span><br><span class="line">        <span class="comment">//【5.1】重置 deep idle 模式</span></span><br><span class="line">        resetIdleManagementLocked();</span><br><span class="line">        <span class="comment">//【5.2】重置 light idle 模式</span></span><br><span class="line">        resetLightIdleManagementLocked();</span><br><span class="line">        addEvent(EVENT_NORMAL);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>首先判断了下状态：</p>
<ul>
<li>如果 mState 不等于 STATE_ACTIVE 或者 mLightState 不等于 STATE_ACTIVE，执行退出操作！</li>
<li>设置 mState 为 STATE_ACTIVE；</li>
<li>设置 mLightState 为 LIGHT_STATE_ACTIVE；</li>
</ul>
<h3 id="2-2-1-scheduleReportActiveLocked"><a href="#2-2-1-scheduleReportActiveLocked" class="headerlink" title="2.2.1 scheduleReportActiveLocked"></a>2.2.1 scheduleReportActiveLocked</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">scheduleReportActiveLocked</span><span class="params">(String activeReason, <span class="keyword">int</span> activeUid)</span> </span>&#123;</span><br><span class="line">    <span class="comment">//【4.4】发送 MSG_REPORT_ACTIVE 给 MyHandler，退出 doze 模式！</span></span><br><span class="line">    Message msg = mHandler.obtainMessage(MSG_REPORT_ACTIVE, activeUid, <span class="number">0</span>, activeReason);</span><br><span class="line">    mHandler.sendMessage(msg);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h1 id="3-Doze-模式状态处理"><a href="#3-Doze-模式状态处理" class="headerlink" title="3 Doze 模式状态处理"></a>3 Doze 模式状态处理</h1><h2 id="3-1-DeviceIdleC-stepIdleStateLocked"><a href="#3-1-DeviceIdleC-stepIdleStateLocked" class="headerlink" title="3.1 DeviceIdleC.stepIdleStateLocked"></a>3.1 DeviceIdleC.stepIdleStateLocked</h2><p>对于 deep idle 模式来说，是通过 stepIdleStateLocked 方法处理每个阶段的状态的！</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">stepIdleStateLocked</span><span class="params">(String reason)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">if</span> (DEBUG) Slog.d(TAG, <span class="string">"stepIdleStateLocked: mState="</span> + mState);</span><br><span class="line">    EventLogTags.writeDeviceIdleStep();</span><br><span class="line"></span><br><span class="line">    <span class="keyword">final</span> <span class="keyword">long</span> now = SystemClock.elapsedRealtime();</span><br><span class="line">    <span class="comment">//【1】如果在 1 小时之内有会在 idle 状态下唤醒设备的 Alarm，那么我们不会进入 idle 状态！</span></span><br><span class="line">    <span class="keyword">if</span> ((now + mConstants.MIN_TIME_TO_ALARM) &gt; mAlarmManager.getNextWakeFromIdleTime()) &#123;</span><br><span class="line">        <span class="keyword">if</span> (mState != STATE_ACTIVE) &#123;</span><br><span class="line">            <span class="comment">//【1.1】退出 doze 模式！</span></span><br><span class="line">            becomeActiveLocked(<span class="string">"alarm"</span>, Process.myUid());</span><br><span class="line">            <span class="comment">//【2.1】再次调用 becomeInactiveIfAppropriateLocked 重新从第一阶段开始处理！</span></span><br><span class="line">            becomeInactiveIfAppropriateLocked();</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//【2】下面进入状态的判断！</span></span><br><span class="line">    <span class="keyword">switch</span> (mState) &#123;</span><br><span class="line">        <span class="keyword">case</span> STATE_INACTIVE:</span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line">            </span><br><span class="line">        <span class="keyword">case</span> STATE_IDLE_PENDING:</span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line">            </span><br><span class="line">        <span class="keyword">case</span> STATE_SENSING:</span><br><span class="line"></span><br><span class="line">        <span class="keyword">case</span> STATE_LOCATING:</span><br><span class="line"></span><br><span class="line">        <span class="keyword">case</span> STATE_IDLE_MAINTENANCE:</span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">case</span> STATE_IDLE:</span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>我们来重点看看，deep idle 状态处理如下：</p>
<h3 id="3-1-1-状态：STATE-INACTIVE"><a href="#3-1-1-状态：STATE-INACTIVE" class="headerlink" title="3.1.1 状态：STATE_INACTIVE"></a>3.1.1 状态：STATE_INACTIVE</h3><p>此时，设备已经在熄屏且为充电的状态下 30mins 了，这个时候，准备进入第二阶段：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//【1.4】启动传感器监听，判断设备是否有移动！</span></span><br><span class="line">startMonitoringMotionLocked();</span><br><span class="line"><span class="comment">//【2.1.1.2】启动下一个阶段的 alarm 触发！</span></span><br><span class="line">scheduleAlarmLocked(mConstants.IDLE_AFTER_INACTIVE_TIMEOUT, <span class="keyword">false</span>);</span><br><span class="line"></span><br><span class="line"><span class="comment">// Reset the upcoming idle delays.</span></span><br><span class="line">mNextIdlePendingDelay = mConstants.IDLE_PENDING_TIMEOUT;</span><br><span class="line">mNextIdleDelay = mConstants.IDLE_TIMEOUT;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 设置状态为 STATE_IDLE_PENDING</span></span><br><span class="line">mState = STATE_IDLE_PENDING;</span><br></pre></td></tr></table></figure>
<ul>
<li>流程分析：</li>
</ul>
<p>通过 startMonitoringMotionLocked 启动了传感器监听，监听设备是否运动！</p>
<p>又<strong>设置了一个时间间隔为 mConstants.IDLE_AFTER_INACTIVE_TIMEOUT 30mins 的 Alarm</strong>，触发的仍然是 mDeepAlarmListener！</p>
<p><strong>mState 状态被设置为了 STATE_IDLE_PENDING</strong>！</p>
<ul>
<li>第二阶段条件：</li>
</ul>
<p><strong>这里我们看到了第二阶段条件：熄屏且不充电，同时设备不移动 30mins 后</strong>！</p>
<p>条件满足后，依然会调用 stepIdleStateLocked 方法！</p>
<h3 id="3-1-2-状态：STATE-IDLE-PENDING"><a href="#3-1-2-状态：STATE-IDLE-PENDING" class="headerlink" title="3.1.2 状态：STATE_IDLE_PENDING"></a>3.1.2 状态：STATE_IDLE_PENDING</h3><p>此时，设备熄屏且不充电 60mins，同时设备不移动 30mins 了，这个时候，准备进入第三阶段：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">case</span> STATE_IDLE_PENDING:</span><br><span class="line">    <span class="comment">//【2.2】熄屏且不充电 60mins，设备不移动 30mins 后，第二阶段条件满足，mState 为 STATE_IDLE_PENDING，</span></span><br><span class="line">    <span class="comment">// 那么我们会进入第三阶段！</span></span><br><span class="line">    mState = STATE_SENSING;</span><br><span class="line">    <span class="keyword">if</span> (DEBUG) Slog.d(TAG, <span class="string">"Moved from STATE_IDLE_PENDING to STATE_SENSING."</span>);</span><br><span class="line">    EventLogTags.writeDeviceIdle(mState, reason);</span><br><span class="line">    <span class="comment">//【3.1.2.1】启动角度监听！</span></span><br><span class="line">    scheduleSensingTimeoutAlarmLocked(mConstants.SENSING_TIMEOUT);</span><br><span class="line">    <span class="comment">//【1.1.1.1.3】取消定位监听，因为定位是下一个阶段的！</span></span><br><span class="line">    cancelLocatingLocked();</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// 初始化一些变量！</span></span><br><span class="line">    mNotMoving = <span class="keyword">false</span>;</span><br><span class="line">    mLocated = <span class="keyword">false</span>;</span><br><span class="line">    mLastGenericLocation = <span class="keyword">null</span>;</span><br><span class="line">    mLastGpsLocation = <span class="keyword">null</span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//【1.5】启动角度变化监听！</span></span><br><span class="line">    mAnyMotionDetector.checkForAnyMotion();</span><br><span class="line">    <span class="keyword">break</span>;</span><br></pre></td></tr></table></figure>
<ul>
<li>流程分析：</li>
</ul>
<p>通过 startMonitoringMotionLocked 启动了传感器监听，监听设备是否运动！</p>
<p>又<strong>设置了一个时间间隔为 mConstants.IDLE_AFTER_INACTIVE_TIMEOUT 30mins 的 Alarm，触发的仍然是 mDeepAlarmListener</strong>！</p>
<p><strong>mState 状态被设置为了 STATE_SENSING</strong>！</p>
<ul>
<li>第三阶段条件：</li>
</ul>
<p><strong>熄屏且不充电，设备不移动，设备没发生角度变化 4 mins</strong>，以后！</p>
<h4 id="3-1-2-1-DeviceIdleC-scheduleSensingTimeoutAlarmLocked"><a href="#3-1-2-1-DeviceIdleC-scheduleSensingTimeoutAlarmLocked" class="headerlink" title="3.1.2.1 DeviceIdleC.scheduleSensingTimeoutAlarmLocked"></a>3.1.2.1 DeviceIdleC.scheduleSensingTimeoutAlarmLocked</h4><p>接着设置第三阶段的 Alarm，参数传入的是 mConstants.SENSING_TIMEOUT 4mins：<br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">scheduleSensingTimeoutAlarmLocked</span><span class="params">(<span class="keyword">long</span> delay)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">if</span> (DEBUG) Slog.d(TAG, <span class="string">"scheduleSensingAlarmLocked("</span> + delay + <span class="string">")"</span>);</span><br><span class="line"></span><br><span class="line">    mNextSensingTimeoutAlarmTime = SystemClock.elapsedRealtime() + delay;</span><br><span class="line">    <span class="comment">//【3.1.2.2】4mins 后触发 mSensingTimeoutAlarmListener！</span></span><br><span class="line">    mAlarmManager.set(AlarmManager.ELAPSED_REALTIME_WAKEUP, mNextSensingTimeoutAlarmTime,</span><br><span class="line">        <span class="string">"DeviceIdleController.sensing"</span>, mSensingTimeoutAlarmListener, mHandler);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>接着，设置了一个新的 Alarm，Alarm 触发后，会执行 mSensingTimeoutAlarmListener.onAlarm 方法！</p>
<h4 id="3-1-2-2-mSensingTimeoutAlarmListener-onAlarm"><a href="#3-1-2-2-mSensingTimeoutAlarmListener-onAlarm" class="headerlink" title="3.1.2.2 mSensingTimeoutAlarmListener.onAlarm"></a>3.1.2.2 mSensingTimeoutAlarmListener.onAlarm</h4><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">private</span> <span class="keyword">final</span> AlarmManager.OnAlarmListener mSensingTimeoutAlarmListener</span><br><span class="line">        = <span class="keyword">new</span> AlarmManager.OnAlarmListener() &#123;</span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onAlarm</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">if</span> (mState == STATE_SENSING) &#123;</span><br><span class="line">            <span class="keyword">synchronized</span> (DeviceIdleController.<span class="keyword">this</span>) &#123;</span><br><span class="line">                <span class="comment">//【2.1】进入下一个阶段！</span></span><br><span class="line">                becomeInactiveIfAppropriateLocked();</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>
<p>当 mSensingTimeoutAlarmListener 触发后，继续进入了 becomeInactiveIfAppropriateLocked 方法！</p>
<h3 id="3-1-3-状态：STATE-SENSING-and-STATE-LOCATING-and-STATE-IDLE-MAINTENANCE"><a href="#3-1-3-状态：STATE-SENSING-and-STATE-LOCATING-and-STATE-IDLE-MAINTENANCE" class="headerlink" title="3.1.3 状态：STATE_SENSING and STATE_LOCATING and STATE_IDLE_MAINTENANCE"></a>3.1.3 状态：STATE_SENSING and STATE_LOCATING and STATE_IDLE_MAINTENANCE</h3><p>接下来，我们把 STATE_SENSING 和 STATE_LOCATING 和 STATE_IDLE_MAINTENANCE 放在一起看，因为这几个有关联！</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">case</span> STATE_SENSING:</span><br><span class="line">    <span class="comment">//【2.3】熄屏且不充电，设备不移动，没发生角度变化 4 mins 后，第三阶段条件满足，</span></span><br><span class="line">    <span class="comment">// 此时 mState 为 STATE_SENSING，</span></span><br><span class="line">    <span class="comment">// 那么我们会进入第四阶段！</span></span><br><span class="line">    <span class="comment">//【1.1.1.1.2】取消 mSensingTimeoutAlarmListener！</span></span><br><span class="line">    cancelSensingTimeoutAlarmLocked();</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// 设置 mState 为 STATE_LOCATING！</span></span><br><span class="line">    mState = STATE_LOCATING;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">if</span> (DEBUG) Slog.d(TAG, <span class="string">"Moved from STATE_SENSING to STATE_LOCATING."</span>);</span><br><span class="line">    EventLogTags.writeDeviceIdle(mState, reason);</span><br><span class="line">    </span><br><span class="line">    <span class="comment">//【2.1.1.2】设置该阶段的 Alarm，时间间隔为 mConstants.LOCATING_TIMEOUT 30s！</span></span><br><span class="line">    scheduleAlarmLocked(mConstants.LOCATING_TIMEOUT, <span class="keyword">false</span>);</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// 注册定位监听器，如果注册成功，mLocating 为 true！</span></span><br><span class="line">    <span class="keyword">if</span> (mLocationManager != <span class="keyword">null</span></span><br><span class="line">            &amp;&amp; mLocationManager.getProvider(LocationManager.NETWORK_PROVIDER) != <span class="keyword">null</span>) &#123;</span><br><span class="line">        mLocationManager.requestLocationUpdates(mLocationRequest,</span><br><span class="line">                mGenericLocationListener, mHandler.getLooper());</span><br><span class="line">        mLocating = <span class="keyword">true</span>;</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        mHasNetworkLocation = <span class="keyword">false</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span> (mLocationManager != <span class="keyword">null</span></span><br><span class="line">            &amp;&amp; mLocationManager.getProvider(LocationManager.GPS_PROVIDER) != <span class="keyword">null</span>) &#123;</span><br><span class="line">        mHasGps = <span class="keyword">true</span>;</span><br><span class="line">        mLocationManager.requestLocationUpdates(LocationManager.GPS_PROVIDER, <span class="number">1000</span>, <span class="number">5</span>,</span><br><span class="line">                mGpsLocationListener, mHandler.getLooper());</span><br><span class="line">        mLocating = <span class="keyword">true</span>;</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        mHasGps = <span class="keyword">false</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="comment">// 如果注册成功， mLocating 为 true，那么就等定位的结果返回</span></span><br><span class="line">    <span class="comment">// 如果注册失败，系统中没有 location provider，那就直接进入 STATE_LOCATING 状态！</span></span><br><span class="line">    <span class="keyword">if</span> (mLocating) &#123;</span><br><span class="line">        <span class="keyword">break</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">case</span> STATE_LOCATING:</span><br><span class="line">    <span class="comment">//【2.4】处理状态 STATE_LOCATING，这里会取消 Alarm，然后会直接进入 STATE_IDLE_MAINTENANCE</span></span><br><span class="line">    <span class="comment">//【5.1.1】取消 mDeepAlarmListener；</span></span><br><span class="line">    cancelAlarmLocked();</span><br><span class="line">    <span class="comment">//【5.1.3】取消 mGenericLocationListener，mGpsLocationListener；</span></span><br><span class="line">    cancelLocatingLocked();</span><br><span class="line">    <span class="comment">// 停止监听角度变化！</span></span><br><span class="line">    mAnyMotionDetector.stop();</span><br><span class="line"></span><br><span class="line"><span class="keyword">case</span> STATE_IDLE_MAINTENANCE:</span><br><span class="line">    <span class="comment">//【2.5】处理状态 STATE_IDLE_MAINTENANCE，这里设置新的 Alarm，用于进入下一个 STATE_IDLE_MAINTENANCE；</span></span><br><span class="line">    <span class="comment">// 时间检测是 mNextIdleDelay，注意这里第二个参数是 true，会触发 mAlarmManager.setIdleUntil 方法！</span></span><br><span class="line">    scheduleAlarmLocked(mNextIdleDelay, <span class="keyword">true</span>);</span><br><span class="line">    <span class="keyword">if</span> (DEBUG) Slog.d(TAG, <span class="string">"Moved to STATE_IDLE. Next alarm in "</span> + mNextIdleDelay +</span><br><span class="line">            <span class="string">" ms."</span>);</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// 计算下一个 mNextIdleDelay 时间间隔，在当前的 mNextIdleDelay 基础上，乘以时间因子！</span></span><br><span class="line">    <span class="comment">// 然后在 mNextIdleDelay 和 mConstants.MAX_IDLE_TIMEOUT(6h) 中选择最小的值</span></span><br><span class="line">    <span class="comment">// 最后，在 mNextIdleDelay 和 mConstants.IDLE_TIMEOUT(60min) 中选择最大值</span></span><br><span class="line">    mNextIdleDelay = (<span class="keyword">long</span>)(mNextIdleDelay * mConstants.IDLE_FACTOR);</span><br><span class="line">    <span class="keyword">if</span> (DEBUG) Slog.d(TAG, <span class="string">"Setting mNextIdleDelay = "</span> + mNextIdleDelay);</span><br><span class="line">    mNextIdleDelay = Math.min(mNextIdleDelay, mConstants.MAX_IDLE_TIMEOUT);</span><br><span class="line">    <span class="keyword">if</span> (mNextIdleDelay &lt; mConstants.IDLE_TIMEOUT) &#123;</span><br><span class="line">        mNextIdleDelay = mConstants.IDLE_TIMEOUT;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// 同时，设置状态为 STATE_IDLE</span></span><br><span class="line">    mState = STATE_IDLE;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// 如果此时 light idle 的状态，不为 LIGHT_STATE_OVERRIDE，由于现在要进入 deep idle 状态了</span></span><br><span class="line">    <span class="comment">// 所以 light idle 会失效，这里会取消 light idle 的 Alarm！</span></span><br><span class="line">    <span class="keyword">if</span> (mLightState != LIGHT_STATE_OVERRIDE) &#123;</span><br><span class="line">        mLightState = LIGHT_STATE_OVERRIDE;</span><br><span class="line">        cancelLightAlarmLocked();</span><br><span class="line">    &#125;</span><br><span class="line">    EventLogTags.writeDeviceIdle(mState, reason);</span><br><span class="line">    addEvent(EVENT_DEEP_IDLE);</span><br><span class="line">    </span><br><span class="line">    <span class="comment">//【4.1】进入 idle 状态！</span></span><br><span class="line">    mHandler.sendEmptyMessage(MSG_REPORT_IDLE_ON);</span><br><span class="line">    <span class="keyword">break</span>;</span><br></pre></td></tr></table></figure>
<ul>
<li><strong>1. STATE_SENSING</strong></li>
</ul>
<p>当熄屏且不充电，设备不移动，没发生角度变化 4 mins 后，就会进入 STATE_SENSING 阶段！</p>
<p>接着，会<strong>设置 mState 为 STATE_LOCATING</strong>，然后设置一个 30s 的 Alarm，如果在 30s 内，条件没有发生变化，那么会进入 STATE_LOCATING 阶段！</p>
<p>接着会注册定位监听器，如果注册成功，那就等待 30s 的 Alarm 触发；如果注册失败，那就直接进入 STATE_LOCATING；</p>
<p>所以该阶段设置的条件是：</p>
<ul>
<li>熄屏且不充电，设备不移动，没发生角度变化后，开始定位，保持 30s 以后；</li>
<li><p>熄屏且不充电，设备不移动，没发生角度变化后，直接进入下一个条件；</p>
</li>
<li><p><strong>2. STATE_LOCATING</strong></p>
</li>
</ul>
<p>该状态会直接取消 mDeepAlarmListener，mGenericLocationListener，mGpsLocationListener，同时停止监听角度变化！</p>
<p>然后会立刻进入 STATE_IDLE_MAINTENANCE 状态！</p>
<ul>
<li><strong>3. STATE_IDLE_MAINTENANCE</strong></li>
</ul>
<p>进入该阶段后，我们就即将进入 deep idle 状态了，接下来，如果所有条件都满足，那么，设备的状态将会在 STATE_IDLE_MAINTENANCE 和 STATE_IDLE 直接切换！</p>
<p>在 STATE_IDLE_MAINTENANCE 阶段，我们设置了一个 Alarm，时间间隔是 mNextIdleDelay, 在 STATE_INACTIVE 阶段 mNextIdleDelay 初始化为了</p>
<p>mConstants.IDLE_TIMEOUT(60mins)</p>
<p>第一次进入 STATE_IDLE_MAINTENANCE 阶段，我们的 Alarm 的时间间隔为 mConstants.IDLE_TIMEOUT(60mins)，接着对时间间隔 mNextIdleDelay 进行了调整，用于下一次设置 Alarm！</p>
<p>计算下一个 mNextIdleDelay 时间间隔，在当前的 mNextIdleDelay 基础上，乘以时间因子；然后在 mNextIdleDelay 和 mConstants.MAX_IDLE_TIMEOUT(6h) 中选择最小的值；在 mNextIdleDelay 和 mConstants.IDLE_TIMEOUT(60min) 中选择最大值<br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">mNextIdleDelay = (<span class="keyword">long</span>)(mNextIdleDelay * mConstants.IDLE_FACTOR);</span><br><span class="line">mNextIdleDelay = Math.min(mNextIdleDelay, mConstants.MAX_IDLE_TIMEOUT);</span><br><span class="line"><span class="keyword">if</span> (mNextIdleDelay &lt; mConstants.IDLE_TIMEOUT) &#123;</span><br><span class="line">    mNextIdleDelay = mConstants.IDLE_TIMEOUT;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>那么，这个时间间隔为 mNextIdleDelay 的 Alarm 作用是什么呢？我们知道，当设备进入 doze 模式后，隔一段时间后，会进入一个 maintenance window 时间窗，这时，设备会从 idle 状态暂时恢复，集中处理任务！</p>
<p>所以这个时间间隔 mNextIdleDelay，既是 doze 模式的时间间隔，又是进入 maintenance window 的时间间隔！</p>
<p><strong>设置 mState 为 STATE_IDLE</strong>！</p>
<p>此时，设备已经进入了 idle 状态！</p>
<p>如果此时 light idle 的状态，不为 LIGHT_STATE_OVERRIDE，由于现在要进入 deep idle 状态了，所以 light idle 会失效，这里会取消 light idle 的 Alarm！</p>
<p>最后发送 MSG_REPORT_IDLE_ON 给 MyHandler，通知其他服务，设备进入了 idle 状态！</p>
<p>注意这里会调用 scheduleAlarmLocked 方法，但是第二个参数传入的是 true：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">scheduleAlarmLocked</span><span class="params">(<span class="keyword">long</span> delay, <span class="keyword">boolean</span> idleUntil)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">if</span> (idleUntil) &#123;</span><br><span class="line">        <span class="comment">//【1】执行 setIdleUntil 方法！</span></span><br><span class="line">        mAlarmManager.setIdleUntil(AlarmManager.ELAPSED_REALTIME_WAKEUP,</span><br><span class="line">                mNextAlarmTime, <span class="string">"DeviceIdleController.deep"</span>, mDeepAlarmListener, mHandler);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>分析 AlarmManagerService 的时候，我们又说过 setIdleUntil，该方法会让 AlarmManagerService 进入 doze 模式，直到该 Alarm 触发！该 Alarm 触发后，状态会变为 STATE_IDLE_MAINTENANCE，也就是进入时间窗，同时 Alarm 恢复了！</p>
<h3 id="3-1-4-状态：STATE-IDLE"><a href="#3-1-4-状态：STATE-IDLE" class="headerlink" title="3.1.4 状态：STATE_IDLE"></a>3.1.4 状态：STATE_IDLE</h3><p>当 mNextIdleDelay 时间间隔的 Alarm 触发后，设备会暂时退出 doze 模式，进入 maintenance window，集中处理任务！</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">case</span> STATE_IDLE:</span><br><span class="line">    <span class="comment">//【2.5】处理状态 STATE_IDLE，这里会设置新的 Alarm，用于进入下一次 STATE_IDLE 状态！</span></span><br><span class="line">    <span class="comment">// 同时更新状态为 STATE_IDLE_MAINTENANCE，进入 maintenance window！</span></span><br><span class="line">    mActiveIdleOpCount = <span class="number">1</span>; <span class="comment">// 计数设置为 1；</span></span><br><span class="line">    mActiveIdleWakeLock.acquire();</span><br><span class="line">    scheduleAlarmLocked(mNextIdlePendingDelay, <span class="keyword">false</span>);</span><br><span class="line">    <span class="keyword">if</span> (DEBUG) Slog.d(TAG, <span class="string">"Moved from STATE_IDLE to STATE_IDLE_MAINTENANCE. "</span> +</span><br><span class="line">            <span class="string">"Next alarm in "</span> + mNextIdlePendingDelay + <span class="string">" ms."</span>);</span><br><span class="line">            </span><br><span class="line">    <span class="comment">//【1】计算进入 maintenance window 的时间点！</span></span><br><span class="line">    mMaintenanceStartTime = SystemClock.elapsedRealtime();</span><br><span class="line">    </span><br><span class="line">    <span class="comment">//【2】计算下一次进入 deep idle 状态的 Alarm 时间间隔！</span></span><br><span class="line">    mNextIdlePendingDelay = Math.min(mConstants.MAX_IDLE_PENDING_TIMEOUT,</span><br><span class="line">            (<span class="keyword">long</span>)(mNextIdlePendingDelay * mConstants.IDLE_PENDING_FACTOR));</span><br><span class="line">    <span class="keyword">if</span> (mNextIdlePendingDelay &lt; mConstants.IDLE_PENDING_TIMEOUT) &#123;</span><br><span class="line">        mNextIdlePendingDelay = mConstants.IDLE_PENDING_TIMEOUT;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">//【3】设置状态为 STATE_IDLE_MAINTENANCE！</span></span><br><span class="line">    mState = STATE_IDLE_MAINTENANCE;</span><br><span class="line">    EventLogTags.writeDeviceIdle(mState, reason);</span><br><span class="line">    addEvent(EVENT_DEEP_MAINTENANCE);</span><br><span class="line">    </span><br><span class="line">    <span class="comment">//【4.1】退出 idle 状态！</span></span><br><span class="line">    mHandler.sendEmptyMessage(MSG_REPORT_IDLE_OFF);</span><br><span class="line">    <span class="keyword">break</span>;</span><br></pre></td></tr></table></figure>
<p>进入该阶段后，我们就即将进入 maintenance window 了！</p>
<p>mActiveIdleOpCount 用于统计进入 maintenance window 的次数！</p>
<p>在 STATE_IDLE 阶段，我们再次设置了一个 Alarm，时间间隔是 mNextIdlePendingDelay, 在 STATE_INACTIVE 阶段 mNextIdleDelay 初始化为了</p>
<p>mConstants.IDLE_TIMEOUT(60mins)</p>
<p>第一次进入 STATE_IDLE_MAINTENANCE 阶段，我们的 Alarm 的时间间隔为 mConstants.IDLE_PENDING_TIMEOUT(5mins)，接着对时间间隔 mNextIdlePendingDelay 进行了调整，用于下一次设置 Alarm！</p>
<ul>
<li>计算下一个 mNextIdlePendingDelay 时间间隔：</li>
</ul>
<p>在当前的 mNextIdlePendingDelay 基础上，乘以时间因子；然后在 mNextIdlePendingDelay 和 mConstants.MAX_IDLE_PENDING_TIMEOUT(10mins) 中选择最小的值；在 mNextIdlePendingDelay 和 mConstants.IDLE_PENDING_TIMEOUT(5mins) 中选择最大值：<br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">mNextIdlePendingDelay = Math.min(mConstants.MAX_IDLE_PENDING_TIMEOUT,</span><br><span class="line">        (<span class="keyword">long</span>)(mNextIdlePendingDelay * mConstants.IDLE_PENDING_FACTOR));</span><br><span class="line"><span class="keyword">if</span> (mNextIdlePendingDelay &lt; mConstants.IDLE_PENDING_TIMEOUT) &#123;</span><br><span class="line">    mNextIdlePendingDelay = mConstants.IDLE_PENDING_TIMEOUT;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>那么，这个时间间隔为 mNextIdlePendingDelay 的 Alarm 作用是什么呢？</p>
<ul>
<li>我们知道，当设备进入 maintenance window 时间窗后，会退出 idle 状态，这时，设备会集中处理任务，但是设备在 maintenance window 时间窗结束后，又要进入 deep idle 状态的！</li>
<li>所以这个时间间隔 mNextIdlePendingDelay，既是 deep idle 模式的maintenance window 时间窗长度，又是再次进入 idle 的时间间隔！</li>
</ul>
<p>最后发送 MSG_REPORT_IDLE_OFF 给 MyHandler，同时其他服务，设备退出了 idle 状态！</p>
<h2 id="3-2-DeviceIdleC-stepLightIdleStateLocked"><a href="#3-2-DeviceIdleC-stepLightIdleStateLocked" class="headerlink" title="3.2 DeviceIdleC.stepLightIdleStateLocked"></a>3.2 DeviceIdleC.stepLightIdleStateLocked</h2><p>看完了 deep idle 的状态调度，我们来看看 light idle 的状态调度！</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">stepLightIdleStateLocked</span><span class="params">(String reason)</span> </span>&#123;</span><br><span class="line">    <span class="comment">//【1】如果 mLightState 为 LIGHT_STATE_OVERRIDE，说明我们已经处于 deep idle 状态了！</span></span><br><span class="line">    <span class="comment">// 那么忽略 light idle！</span></span><br><span class="line">    <span class="keyword">if</span> (mLightState == LIGHT_STATE_OVERRIDE) &#123;</span><br><span class="line">        <span class="keyword">return</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (DEBUG) Slog.d(TAG, <span class="string">"stepLightIdleStateLocked: mLightState="</span> + mLightState);</span><br><span class="line">    EventLogTags.writeDeviceIdleLightStep();</span><br><span class="line">    <span class="comment">//【2】处理 mLightState 的状态！</span></span><br><span class="line">    <span class="keyword">switch</span> (mLightState) &#123;</span><br><span class="line">        <span class="keyword">case</span> LIGHT_STATE_INACTIVE:</span><br><span class="line">            ... ... ...</span><br><span class="line">        <span class="keyword">case</span> LIGHT_STATE_PRE_IDLE:</span><br><span class="line">        <span class="keyword">case</span> LIGHT_STATE_IDLE_MAINTENANCE:</span><br><span class="line">            ... ... ...</span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line">            </span><br><span class="line">        <span class="keyword">case</span> LIGHT_STATE_IDLE:</span><br><span class="line">        <span class="keyword">case</span> LIGHT_STATE_WAITING_FOR_NETWORK:</span><br><span class="line">            ... ... ...</span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>继续看！</p>
<h3 id="3-1-1-状态：LIGHT-STATE-INACTIVE"><a href="#3-1-1-状态：LIGHT-STATE-INACTIVE" class="headerlink" title="3.1.1 状态：LIGHT_STATE_INACTIVE"></a>3.1.1 状态：LIGHT_STATE_INACTIVE</h3><p>如果是熄屏并且没有充电的充电的情况下，或者是强制进入 idle 状态下，mLightState 会从 LIGHT_STATE_ACTIVE 变为 LIGHT_STATE_INACTIVE</p>
<p>同时会设置一个 Alarm，时间间隔为 mConstants.LIGHT_IDLE_AFTER_INACTIVE_TIMEOUT 为(5 mins)，Alarm 触发后 mLightAlarmListener.onAlarm 方法会被回调，进入 stepLightIdleStateLocked！</p>
<p>我们来看看 LIGHT_STATE_INACTIVE 状态的处理！<br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">case</span> LIGHT_STATE_INACTIVE:</span><br><span class="line">    mCurIdleBudget = mConstants.LIGHT_IDLE_MAINTENANCE_MIN_BUDGET;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//【1】重置了 mNextLightIdleDelay 和 mMaintenanceStartTime</span></span><br><span class="line">    <span class="comment">// 后面设置时间窗会用到！</span></span><br><span class="line">    mNextLightIdleDelay = mConstants.LIGHT_IDLE_TIMEOUT;</span><br><span class="line">    mMaintenanceStartTime = <span class="number">0</span>;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">//【2】判断当前设备是否还有任务和操作要执行！</span></span><br><span class="line">    <span class="keyword">if</span> (!isOpsInactiveLocked()) &#123;</span><br><span class="line">        <span class="comment">// 如果还有任务要执行，那就不能直接进入 LIGHT_STATE_PRE_IDLE 状态</span></span><br><span class="line">        <span class="comment">// 而是设置了一个 Alarm，等待任务执行完！</span></span><br><span class="line">        <span class="comment">//【2.1】设置 mLightState 为 LIGHT_STATE_PRE_IDLE！</span></span><br><span class="line">        mLightState = LIGHT_STATE_PRE_IDLE;</span><br><span class="line">        EventLogTags.writeDeviceIdleLight(mLightState, reason);</span><br><span class="line">        <span class="comment">//【2.1.2.1】设置 Alarm！</span></span><br><span class="line">        scheduleLightAlarmLocked(mConstants.LIGHT_PRE_IDLE_TIMEOUT);</span><br><span class="line">        <span class="keyword">break</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">//【3】没有任务在做，直接进入下一阶段！</span></span><br><span class="line"><span class="keyword">case</span> LIGHT_STATE_PRE_IDLE:</span><br></pre></td></tr></table></figure></p>
<p>这里调用了 isOpsInactiveLocked 方法，用于判断当前设备是否还有任务和操作要执行！</p>
<ul>
<li><p>当其返回 false 时，说明当前设备还有任务和操作要执行！</p>
<ul>
<li>那么就不能直接进入 LIGHT_STATE_IDLE 状态，这里先设置为 LIGHT_STATE_PRE_IDLE，可以看作是 idle 前的一个临时状态！</li>
<li>同时 scheduleLightAlarmLocked 设置了一个时间间隔为 mConstants.LIGHT_PRE_IDLE_TIMEOUT(10mins) 的 Alarm，等待那些要执行的工作执行完成，然后进入下一个阶段的处理！</li>
</ul>
</li>
</ul>
<ul>
<li><p>当其返回 true 时，说明当前设备没有任务和操作要执行了！</p>
<ul>
<li>那么这种情况，直接进入 idle 状态，具体的逻辑处理是在 3.1.2 LIGHT_STATE_PRE_IDLE/LIGHT_STATE_IDLE_MAINTENANCE 里！</li>
</ul>
</li>
</ul>
<h3 id="3-1-2-状态：LIGHT-STATE-PRE-IDLE-and-LIGHT-STATE-IDLE-MAINTENANCE"><a href="#3-1-2-状态：LIGHT-STATE-PRE-IDLE-and-LIGHT-STATE-IDLE-MAINTENANCE" class="headerlink" title="3.1.2 状态：LIGHT_STATE_PRE_IDLE and LIGHT_STATE_IDLE_MAINTENANCE"></a>3.1.2 状态：LIGHT_STATE_PRE_IDLE and LIGHT_STATE_IDLE_MAINTENANCE</h3><p>进入该阶段有两种情况：</p>
<ul>
<li>设备没有任务和操作要执行，从 LIGHT_STATE_INACTIVE 直接进入；</li>
<li>设备没有任务和操作要执行，Alarm 触发后，从 LIGHT_STATE_PRE_IDLE 进入；</li>
</ul>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// Nothing active, fall through to immediately idle.</span></span><br><span class="line"><span class="keyword">case</span> LIGHT_STATE_PRE_IDLE:</span><br><span class="line"><span class="keyword">case</span> LIGHT_STATE_IDLE_MAINTENANCE:</span><br><span class="line">    <span class="comment">//【1】根据 mMaintenanceStartTime 调整 mCurIdleBudget！</span></span><br><span class="line">    <span class="keyword">if</span> (mMaintenanceStartTime != <span class="number">0</span>) &#123;</span><br><span class="line">        <span class="keyword">long</span> duration = SystemClock.elapsedRealtime() - mMaintenanceStartTime;</span><br><span class="line">        <span class="keyword">if</span> (duration &lt; mConstants.LIGHT_IDLE_MAINTENANCE_MIN_BUDGET) &#123;</span><br><span class="line">            <span class="comment">// We didn't use up all of our minimum budget; add this to the reserve.</span></span><br><span class="line">            mCurIdleBudget += (mConstants.LIGHT_IDLE_MAINTENANCE_MIN_BUDGET-duration);</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            <span class="comment">// We used more than our minimum budget; this comes out of the reserve.</span></span><br><span class="line">            mCurIdleBudget -= (duration-mConstants.LIGHT_IDLE_MAINTENANCE_MIN_BUDGET);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    mMaintenanceStartTime = <span class="number">0</span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//【2】设置一个新的 Alarm，时间间隔为 mNextLightIdleDelay，mNextLightIdleDelay 默认为</span></span><br><span class="line">    <span class="comment">// mConstants.LIGHT_IDLE_TIMEOUT(5mins)</span></span><br><span class="line">    scheduleLightAlarmLocked(mNextLightIdleDelay);</span><br><span class="line"></span><br><span class="line">    <span class="comment">//【3】计算下一次 Alarm 的时间间隔！</span></span><br><span class="line">    mNextLightIdleDelay = Math.min(mConstants.LIGHT_MAX_IDLE_TIMEOUT,</span><br><span class="line">            (<span class="keyword">long</span>)(mNextLightIdleDelay * mConstants.LIGHT_IDLE_FACTOR));</span><br><span class="line">    <span class="keyword">if</span> (mNextLightIdleDelay &lt; mConstants.LIGHT_IDLE_TIMEOUT) &#123;</span><br><span class="line">        mNextLightIdleDelay = mConstants.LIGHT_IDLE_TIMEOUT;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span> (DEBUG) Slog.d(TAG, <span class="string">"Moved to LIGHT_STATE_IDLE."</span>);</span><br><span class="line">    </span><br><span class="line">    <span class="comment">//【4】设置 mLightState 为 LIGHT_STATE_IDLE，进入 light idle 状态！</span></span><br><span class="line">    mLightState = LIGHT_STATE_IDLE;</span><br><span class="line">    EventLogTags.writeDeviceIdleLight(mLightState, reason);</span><br><span class="line">    addEvent(EVENT_LIGHT_IDLE);</span><br><span class="line">    </span><br><span class="line">    <span class="comment">//【4.2】发送 MSG_REPORT_IDLE_ON_LIGHT 给 MyHandler，进入 light idle 状态！</span></span><br><span class="line">    mHandler.sendEmptyMessage(MSG_REPORT_IDLE_ON_LIGHT);</span><br><span class="line">    <span class="keyword">break</span>;</span><br></pre></td></tr></table></figure>
<p>该阶段，我们将 mLightState 设置为了 LIGHT_STATE_IDLE，表示已经进入了 light idle 状态！</p>
<p>接着，设置一个 Alarm，时间间隔为 mNextLightIdleDelay，第一次设置的时候 mNextLightIdleDelay 使用的默认值 mConstants.LIGHT_IDLE_TIMEOUT(5mins)！</p>
<p>然后计算下一个 mNextLightIdleDelay 时间间隔：</p>
<ul>
<li>在当前的 mNextLightIdleDelay 基础上，乘以时间因子；</li>
<li>然后在 mNextLightIdleDelay 和 mConstants.LIGHT_MAX_IDLE_TIMEOUT(15mins) 中选择最小的值；</li>
<li>在 mNextIdleDelay 和 mConstants.LIGHT_IDLE_TIMEOUT(5mins) 中选择最大值：</li>
</ul>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">mNextLightIdleDelay = Math.min(mConstants.LIGHT_MAX_IDLE_TIMEOUT,</span><br><span class="line">        (<span class="keyword">long</span>)(mNextLightIdleDelay * mConstants.LIGHT_IDLE_FACTOR));</span><br><span class="line"><span class="keyword">if</span> (mNextLightIdleDelay &lt; mConstants.LIGHT_IDLE_TIMEOUT) &#123;</span><br><span class="line">    mNextLightIdleDelay = mConstants.LIGHT_IDLE_TIMEOUT;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>这个时间间隔 mNextLightIdleDelay，既是 light idle 模式的 idle 状态时间间隔，又是进入 maintenance window 的时间间隔！</p>
<p>等待 alarm 触发，进入下一阶段！</p>
<h3 id="3-1-3-状态：LIGHT-STATE-IDLE-and-LIGHT-STATE-WAITING-FOR-NETWORK"><a href="#3-1-3-状态：LIGHT-STATE-IDLE-and-LIGHT-STATE-WAITING-FOR-NETWORK" class="headerlink" title="3.1.3 状态：LIGHT_STATE_IDLE and LIGHT_STATE_WAITING_FOR_NETWORK"></a>3.1.3 状态：LIGHT_STATE_IDLE and LIGHT_STATE_WAITING_FOR_NETWORK</h3><p>接着我们来看下对于 LIGHT_STATE_IDLE 和 LIGHT_STATE_WAITING_FOR_NETWORK 的处理，当 light idle 时间间隔过去后，会进入 maintenance window，执行任务！<br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">case</span> LIGHT_STATE_IDLE:</span><br><span class="line"><span class="keyword">case</span> LIGHT_STATE_WAITING_FOR_NETWORK:</span><br><span class="line">    <span class="keyword">if</span> (mNetworkConnected || mLightState == LIGHT_STATE_WAITING_FOR_NETWORK) &#123;</span><br><span class="line">        <span class="comment">//【1】如果此时网络连接，或者 mLightState 的状态为 LIGHT_STATE_WAITING_FOR_NETWORK</span></span><br><span class="line">        <span class="comment">// 此时 Alarm 已经触发，进入 maintenance window 时间窗，执行任务！</span></span><br><span class="line">        mActiveIdleOpCount = <span class="number">1</span>; <span class="comment">// mActiveIdleOpCount 置为 1；</span></span><br><span class="line">        mActiveIdleWakeLock.acquire();</span><br><span class="line">        </span><br><span class="line">        <span class="comment">//【2】计算当前的 maintenance window 的开始时间</span></span><br><span class="line">        mMaintenanceStartTime = SystemClock.elapsedRealtime();</span><br><span class="line">        <span class="keyword">if</span> (mCurIdleBudget &lt; mConstants.LIGHT_IDLE_MAINTENANCE_MIN_BUDGET) &#123;</span><br><span class="line">            mCurIdleBudget = mConstants.LIGHT_IDLE_MAINTENANCE_MIN_BUDGET;</span><br><span class="line">        &#125; <span class="keyword">else</span> <span class="keyword">if</span> (mCurIdleBudget &gt; mConstants.LIGHT_IDLE_MAINTENANCE_MAX_BUDGET) &#123;</span><br><span class="line">            mCurIdleBudget = mConstants.LIGHT_IDLE_MAINTENANCE_MAX_BUDGET;</span><br><span class="line">        &#125;</span><br><span class="line">        </span><br><span class="line">        <span class="comment">//【3】再次设置 Alarm，时间间隔为 mCurIdleBudget，该 Alarm 用于再次进入 idle 状态！</span></span><br><span class="line">        scheduleLightAlarmLocked(mCurIdleBudget);</span><br><span class="line">        </span><br><span class="line">        <span class="keyword">if</span> (DEBUG) Slog.d(TAG,</span><br><span class="line">                <span class="string">"Moved from LIGHT_STATE_IDLE to LIGHT_STATE_IDLE_MAINTENANCE."</span>);</span><br><span class="line">                </span><br><span class="line">        <span class="comment">// 设置 mLightState 为 LIGHT_STATE_IDLE_MAINTENANCE，表示此时处于时间窗中！</span></span><br><span class="line">        mLightState = LIGHT_STATE_IDLE_MAINTENANCE;</span><br><span class="line"></span><br><span class="line">        EventLogTags.writeDeviceIdleLight(mLightState, reason);</span><br><span class="line">        addEvent(EVENT_LIGHT_MAINTENANCE);</span><br><span class="line">        </span><br><span class="line">        <span class="comment">//【4.3】发送 MSG_REPORT_IDLE_OFF 给 MyHandler，通知其他服务，退出 idle 状态！</span></span><br><span class="line">        mHandler.sendEmptyMessage(MSG_REPORT_IDLE_OFF);</span><br><span class="line"></span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        <span class="comment">//【2】此时本应该进入 maintenance window，执行任务，但是由于没有网络连接，那么需要等待网络连接</span></span><br><span class="line">        <span class="comment">// 设置一个 Alarm，时间间隔为 mNextLightIdleDelay，等待网络连接！</span></span><br><span class="line">        <span class="comment">// 如果在 Alarm 触发之前，网络连接了，那么会再次触发 stepLightIdleStateLocked 方法！</span></span><br><span class="line">        <span class="comment">// 如果在 Alarm 触发时，网络仍然没有连接，那就会直接进入 maintenance window 时间窗，执行任务！</span></span><br><span class="line">        scheduleLightAlarmLocked(mNextLightIdleDelay);</span><br><span class="line">        </span><br><span class="line">        <span class="keyword">if</span> (DEBUG) Slog.d(TAG, <span class="string">"Moved to LIGHT_WAITING_FOR_NETWORK."</span>);</span><br><span class="line">        </span><br><span class="line">        <span class="comment">// 设置 mLightState 为 LIGHT_STATE_WAITING_FOR_NETWORK</span></span><br><span class="line">        mLightState = LIGHT_STATE_WAITING_FOR_NETWORK;</span><br><span class="line">        EventLogTags.writeDeviceIdleLight(mLightState, reason);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">break</span>;</span><br></pre></td></tr></table></figure></p>
<p>我们分析下流程：</p>
<p>此时 idle 状态时间到了，需要进入时间窗执行任务，这里会对 network state 和 mLightState 进行一个判断：</p>
<ul>
<li>如果 mNetworkConnected 为 true 或者 mLightState == LIGHT_STATE_WAITING_FOR_NETWOR：<ul>
<li>表示当前网络已经连接，或者当前网络没有连接但是 light idle 正在等待网络，那么就进入 maintenance window 时间窗，执行任务！</li>
<li>同时设置 mLightState 为 LIGHT_STATE_IDLE_MAINTENANCE；</li>
<li>接着设置了一个 再次设置 Alarm，时间间隔为 mCurIdleBudget，该 Alarm 用于再次进入 idle 状态！时间间隔 mCurIdleBudget 取值在 [mConstants.LIGHT_IDLE_MAINTENANCE_MIN_BUDGET(1mins), mConstants.LIGHT_IDLE_MAINTENANCE_MAX_BUDGET(5mins)] 之间！</li>
<li>最后发送 MSG_REPORT_IDLE_OFF 给 MyHandler，通知其他服务，退出 idle 状态！！</li>
</ul>
</li>
</ul>
<p><br></p>
<ul>
<li>如果 mNetworkConnected 为 false 且 mLightState != LIGHT_STATE_WAITING_FOR_NETWOR:<ul>
<li>那么这个时候，light idle 状态不会立刻进入 maintenance window 时间窗；</li>
<li>会设置一个时间间隔 mNextLightIdleDelay 的 Alarm，等待网络连接；</li>
<li>同时设置 mLightState 为 LIGHT_STATE_WAITING_FOR_NETWORK；<ul>
<li>如果在 Alarm 触发之前，网络连接了，那么会再次触发 stepLightIdleStateLocked 方法，进入 if 分支！</li>
<li>如果在 Alarm 触发时，网络仍然没有连接，那就会直接进入 if 分支！ </li>
</ul>
</li>
</ul>
</li>
</ul>
<h1 id="4-MyHandler-逻辑分析"><a href="#4-MyHandler-逻辑分析" class="headerlink" title="4 MyHandler 逻辑分析"></a>4 MyHandler 逻辑分析</h1><p>我们来看下 MyHandler 逻辑分析：<br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">final</span> <span class="class"><span class="keyword">class</span> <span class="title">MyHandler</span> <span class="keyword">extends</span> <span class="title">Handler</span> </span>&#123;</span><br><span class="line">    MyHandler(Looper looper) &#123;</span><br><span class="line">        <span class="keyword">super</span>(looper);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span> <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">handleMessage</span><span class="params">(Message msg)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">if</span> (DEBUG) Slog.d(TAG, <span class="string">"handleMessage("</span> + msg.what + <span class="string">")"</span>);</span><br><span class="line">        <span class="keyword">switch</span> (msg.what) &#123;</span><br><span class="line">            <span class="keyword">case</span> MSG_WRITE_CONFIG: &#123;</span><br><span class="line">            &#125; <span class="keyword">break</span>;</span><br><span class="line">            </span><br><span class="line">            <span class="keyword">case</span> MSG_REPORT_IDLE_ON:</span><br><span class="line">            <span class="keyword">case</span> MSG_REPORT_IDLE_ON_LIGHT: &#123;</span><br><span class="line"></span><br><span class="line">            &#125; <span class="keyword">break</span>;</span><br><span class="line">            </span><br><span class="line">            <span class="keyword">case</span> MSG_REPORT_IDLE_OFF: &#123;</span><br><span class="line">            &#125; <span class="keyword">break</span>;</span><br><span class="line">            </span><br><span class="line">            <span class="keyword">case</span> MSG_REPORT_ACTIVE: &#123;</span><br><span class="line">            &#125; <span class="keyword">break</span>;</span><br><span class="line">            </span><br><span class="line">            <span class="keyword">case</span> MSG_TEMP_APP_WHITELIST_TIMEOUT: &#123;</span><br><span class="line">            &#125; <span class="keyword">break</span>;</span><br><span class="line">            </span><br><span class="line">            <span class="keyword">case</span> MSG_REPORT_MAINTENANCE_ACTIVITY: &#123;</span><br><span class="line">            &#125; <span class="keyword">break</span>;</span><br><span class="line">            </span><br><span class="line">            <span class="keyword">case</span> MSG_FINISH_IDLE_OP: &#123;</span><br><span class="line">            &#125; <span class="keyword">break</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>下面分析下每个消息的具体处理！</p>
<h2 id="4-1-消息：MSG-WRITE-CONFIG"><a href="#4-1-消息：MSG-WRITE-CONFIG" class="headerlink" title="4.1 消息：MSG_WRITE_CONFIG"></a>4.1 消息：MSG_WRITE_CONFIG</h2><p>更新本地持久化文件：<br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">case</span> MSG_WRITE_CONFIG: &#123;</span><br><span class="line">    <span class="comment">//【4.1.1】持久化文件！</span></span><br><span class="line">    handleWriteConfigFile();</span><br><span class="line">&#125; <span class="keyword">break</span>;</span><br></pre></td></tr></table></figure></p>
<h3 id="4-1-1-handleWriteConfigFile"><a href="#4-1-1-handleWriteConfigFile" class="headerlink" title="4.1.1 handleWriteConfigFile"></a>4.1.1 handleWriteConfigFile</h3><p>更新本地持久化文件：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">handleWriteConfigFile</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    <span class="keyword">final</span> ByteArrayOutputStream memStream = <span class="keyword">new</span> ByteArrayOutputStream();</span><br><span class="line"></span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">        <span class="keyword">synchronized</span> (<span class="keyword">this</span>) &#123;</span><br><span class="line">            XmlSerializer out = <span class="keyword">new</span> FastXmlSerializer();</span><br><span class="line">            out.setOutput(memStream, StandardCharsets.UTF_8.name());</span><br><span class="line">            writeConfigFileLocked(out);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125; <span class="keyword">catch</span> (IOException e) &#123;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">synchronized</span> (mConfigFile) &#123;</span><br><span class="line">        FileOutputStream stream = <span class="keyword">null</span>;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            stream = mConfigFile.startWrite();</span><br><span class="line">            memStream.writeTo(stream);</span><br><span class="line">            stream.flush();</span><br><span class="line">            FileUtils.sync(stream);</span><br><span class="line">            stream.close();</span><br><span class="line">            mConfigFile.finishWrite(stream);</span><br><span class="line">        &#125; <span class="keyword">catch</span> (IOException e) &#123;</span><br><span class="line">            Slog.w(TAG, <span class="string">"Error writing config file"</span>, e);</span><br><span class="line">            mConfigFile.failWrite(stream);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>最后调用 writeConfigFileLocked 方法<br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">writeConfigFileLocked</span><span class="params">(XmlSerializer out)</span> <span class="keyword">throws</span> IOException </span>&#123;</span><br><span class="line">    out.startDocument(<span class="keyword">null</span>, <span class="keyword">true</span>);</span><br><span class="line">    out.startTag(<span class="keyword">null</span>, <span class="string">"config"</span>);</span><br><span class="line">    <span class="keyword">for</span> (<span class="keyword">int</span> i=<span class="number">0</span>; i&lt;mPowerSaveWhitelistUserApps.size(); i++) &#123;</span><br><span class="line">        String name = mPowerSaveWhitelistUserApps.keyAt(i);</span><br><span class="line">        out.startTag(<span class="keyword">null</span>, <span class="string">"wl"</span>);</span><br><span class="line">        out.attribute(<span class="keyword">null</span>, <span class="string">"n"</span>, name);</span><br><span class="line">        out.endTag(<span class="keyword">null</span>, <span class="string">"wl"</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    out.endTag(<span class="keyword">null</span>, <span class="string">"config"</span>);</span><br></pre></td></tr></table></figure></p>
<p>每一个白名单都是以 wl 标签开始和结束，n 属性为包名！</p>
<h2 id="4-2-消息：MSG-REPORT-IDLE-ON-and-MSG-REPORT-IDLE-ON-LIGHT"><a href="#4-2-消息：MSG-REPORT-IDLE-ON-and-MSG-REPORT-IDLE-ON-LIGHT" class="headerlink" title="4.2 消息：MSG_REPORT_IDLE_ON and MSG_REPORT_IDLE_ON_LIGHT"></a>4.2 消息：MSG_REPORT_IDLE_ON and MSG_REPORT_IDLE_ON_LIGHT</h2><p>进入 doze 模式，MSG_REPORT_IDLE_ON 表示的是 deep idle，而 MSG_REPORT_IDLE_ON_LIGHT 而是 light idle！</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">case</span> MSG_REPORT_IDLE_ON:</span><br><span class="line"><span class="keyword">case</span> MSG_REPORT_IDLE_ON_LIGHT: &#123; <span class="comment">// 进入 idle 状态！</span></span><br><span class="line">    EventLogTags.writeDeviceIdleOnStart();</span><br><span class="line">    <span class="keyword">final</span> <span class="keyword">boolean</span> deepChanged;</span><br><span class="line">    <span class="keyword">final</span> <span class="keyword">boolean</span> lightChanged;</span><br><span class="line">    <span class="comment">//【1】针对于 deep 和 light，PowerManager 做不同的处理！</span></span><br><span class="line">    <span class="keyword">if</span> (msg.what == MSG_REPORT_IDLE_ON) &#123;</span><br><span class="line">        <span class="comment">//【1.1】进入 deep idle！</span></span><br><span class="line">        deepChanged = mLocalPowerManager.setDeviceIdleMode(<span class="keyword">true</span>);</span><br><span class="line">        lightChanged = mLocalPowerManager.setLightDeviceIdleMode(<span class="keyword">false</span>);</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        <span class="comment">//【1.2】进入 light idle！</span></span><br><span class="line">        deepChanged = mLocalPowerManager.setDeviceIdleMode(<span class="keyword">false</span>);</span><br><span class="line">        lightChanged = mLocalPowerManager.setLightDeviceIdleMode(<span class="keyword">true</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">//【2】NetworkPolicy 和 BatteryStats 设置不同的状态；</span></span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">        mNetworkPolicyManager.setDeviceIdleMode(<span class="keyword">true</span>);</span><br><span class="line">        mBatteryStats.noteDeviceIdleMode(msg.what == MSG_REPORT_IDLE_ON</span><br><span class="line">                ? BatteryStats.DEVICE_IDLE_MODE_DEEP</span><br><span class="line">                : BatteryStats.DEVICE_IDLE_MODE_LIGHT, <span class="keyword">null</span>, Process.myUid());</span><br><span class="line">    &#125; <span class="keyword">catch</span> (RemoteException e) &#123;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">//【3】发送广播，给监听 doze 模式的进程！</span></span><br><span class="line">    <span class="keyword">if</span> (deepChanged) &#123;</span><br><span class="line">        getContext().sendBroadcastAsUser(mIdleIntent, UserHandle.ALL);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span> (lightChanged) &#123;</span><br><span class="line">        getContext().sendBroadcastAsUser(mLightIdleIntent, UserHandle.ALL);</span><br><span class="line">    &#125;</span><br><span class="line">    EventLogTags.writeDeviceIdleOnComplete();</span><br><span class="line">&#125; <span class="keyword">break</span>;</span><br></pre></td></tr></table></figure>
<p>在进入 idle 状态的时候，我们会发送相应的广播！！</p>
<h2 id="4-3-消息：MSG-REPORT-IDLE-OFF"><a href="#4-3-消息：MSG-REPORT-IDLE-OFF" class="headerlink" title="4.3 消息：MSG_REPORT_IDLE_OFF"></a>4.3 消息：MSG_REPORT_IDLE_OFF</h2><p>MSG_REPORT_IDLE_OFF 表示暂时退出 idle 状态，进入了时间窗，执行任务！</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">case</span> MSG_REPORT_IDLE_OFF: &#123;</span><br><span class="line">    EventLogTags.writeDeviceIdleOffStart(<span class="string">"unknown"</span>);</span><br><span class="line">    <span class="comment">//【1】退出 deep idle 和 light idle 模式，更新 PowerManager 状态！</span></span><br><span class="line">    <span class="keyword">final</span> <span class="keyword">boolean</span> deepChanged = mLocalPowerManager.setDeviceIdleMode(<span class="keyword">false</span>);</span><br><span class="line">    <span class="keyword">final</span> <span class="keyword">boolean</span> lightChanged = mLocalPowerManager.setLightDeviceIdleMode(<span class="keyword">false</span>);</span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">        mNetworkPolicyManager.setDeviceIdleMode(<span class="keyword">false</span>);</span><br><span class="line">        mBatteryStats.noteDeviceIdleMode(BatteryStats.DEVICE_IDLE_MODE_OFF,</span><br><span class="line">                <span class="keyword">null</span>, Process.myUid());</span><br><span class="line">    &#125; <span class="keyword">catch</span> (RemoteException e) &#123;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//【2】如果 deep idle(light idle) 状态发生了变化，那就更新 mActiveIdleOpCount 计数；</span></span><br><span class="line">    <span class="comment">// 同时有序发送通知广播，最后自身也会接受广播！</span></span><br><span class="line">    <span class="keyword">if</span> (deepChanged) &#123;</span><br><span class="line">        <span class="comment">//【4.3.1】增加引用计数 mActiveIdleOpCount！</span></span><br><span class="line">        incActiveIdleOps();</span><br><span class="line">        <span class="comment">//【4.3.2】自身也会监听 doze 模式变化的广播！</span></span><br><span class="line">        getContext().sendOrderedBroadcastAsUser(mIdleIntent, UserHandle.ALL,</span><br><span class="line">                <span class="keyword">null</span>, mIdleStartedDoneReceiver, <span class="keyword">null</span>, <span class="number">0</span>, <span class="keyword">null</span>, <span class="keyword">null</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span> (lightChanged) &#123;</span><br><span class="line">        incActiveIdleOps(); <span class="comment">// 同上！</span></span><br><span class="line">        getContext().sendOrderedBroadcastAsUser(mLightIdleIntent, UserHandle.ALL,</span><br><span class="line">                <span class="keyword">null</span>, mIdleStartedDoneReceiver, <span class="keyword">null</span>, <span class="number">0</span>, <span class="keyword">null</span>, <span class="keyword">null</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//【4.3.3】减少 mActiveIdleOpCount 计数，尝试提前退出时间窗！</span></span><br><span class="line">    decActiveIdleOps();</span><br><span class="line"></span><br><span class="line">    EventLogTags.writeDeviceIdleOffComplete();</span><br><span class="line">&#125; <span class="keyword">break</span>;</span><br></pre></td></tr></table></figure>
<p>处理 MSG_REPORT_IDLE_OFF 消息比较特殊，这里我们是有序的发送广播，同时在发送 mIdleIntent 或者 mLightIdleIntent 广播的时候，我们额外传入了 mIdleStartedDoneReceiver，是最后有序队列中的最后一个接收者：</p>
<h3 id="4-3-1-IdleStartedDoneReceiver"><a href="#4-3-1-IdleStartedDoneReceiver" class="headerlink" title="4.3.1 IdleStartedDoneReceiver"></a>4.3.1 IdleStartedDoneReceiver</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">private</span> <span class="keyword">final</span> BroadcastReceiver mIdleStartedDoneReceiver = <span class="keyword">new</span> BroadcastReceiver() &#123;</span><br><span class="line">    <span class="meta">@Override</span> <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onReceive</span><span class="params">(Context context, Intent intent)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">if</span> (PowerManager.ACTION_DEVICE_IDLE_MODE_CHANGED.equals(intent.getAction())) &#123;</span><br><span class="line">            <span class="comment">//【4.7】如果是 deep idle 模式发生了变化，延迟 mConstants.MIN_DEEP_MAINTENANCE_TIME(30s)</span></span><br><span class="line">            <span class="comment">// 发送 MSG_FINISH_IDLE_OP 消息！</span></span><br><span class="line">            mHandler.sendEmptyMessageDelayed(MSG_FINISH_IDLE_OP,</span><br><span class="line">                    mConstants.MIN_DEEP_MAINTENANCE_TIME);</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            <span class="comment">//【4.7】如果是 light idle 模式发生了变化，延迟 mConstants.MIN_LIGHT_MAINTENANCE_TIME(5s) </span></span><br><span class="line">            <span class="comment">// 发送 MSG_FINISH_IDLE_OP 消息！</span></span><br><span class="line">            mHandler.sendEmptyMessageDelayed(MSG_FINISH_IDLE_OP,</span><br><span class="line">                    mConstants.MIN_LIGHT_MAINTENANCE_TIME);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>
<p>对于暂时退出 idle 状态来说，mIdleIntent 或者 mLightIdleIntent 广播的时候，除了要发送给其他服务，DeviceIdleController 自身作为最后一个接收者，也会接受该广播！</p>
<p>当 DeviceIdleController 接收到广播后，会判断下是退出 deep idle 还是 light idle 状态！</p>
<ul>
<li>如果退出 deep idle，延迟延迟 mConstants.MIN_DEEP_MAINTENANCE_TIME (30s)，发送 MSG_FINISH_IDLE_OP 消息给 MyHandler；</li>
<li>如果退出 light idle，延迟延迟  mConstants.MIN_LIGHT_MAINTENANCE_TIME (5s)，发送 MSG_FINISH_IDLE_OP 消息给 MyHandler；</li>
</ul>
<p>MyHandler 在接收到 MSG_FINISH_IDLE_OP 消息后，会减少 mActiveIdleOpCount 计数，同时会尝试提前退出时间窗！</p>
<h3 id="4-3-2-incActiveIdleOps"><a href="#4-3-2-incActiveIdleOps" class="headerlink" title="4.3.2 incActiveIdleOps"></a>4.3.2 incActiveIdleOps</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">incActiveIdleOps</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    <span class="keyword">synchronized</span> (<span class="keyword">this</span>) &#123;</span><br><span class="line">        mActiveIdleOpCount++;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>incActiveIdleOps 主要是将 mActiveIdleOpCount 加 1，表示此时我们进入时间窗，执行相关的操作；</p>
<h3 id="4-3-3-decActiveIdleOps"><a href="#4-3-3-decActiveIdleOps" class="headerlink" title="4.3.3 decActiveIdleOps"></a>4.3.3 decActiveIdleOps</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">decActiveIdleOps</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    <span class="keyword">synchronized</span> (<span class="keyword">this</span>) &#123;</span><br><span class="line">        mActiveIdleOpCount--;</span><br><span class="line">        <span class="keyword">if</span> (mActiveIdleOpCount &lt;= <span class="number">0</span>) &#123;</span><br><span class="line">            <span class="comment">//【4.3.2.1】尝试提前退出时间窗！</span></span><br><span class="line">            exitMaintenanceEarlyIfNeededLocked();</span><br><span class="line">            mActiveIdleWakeLock.release();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>decActiveIdleOps 方法会先将 mActiveIdleOpCount 减 1；如果此时 mActiveIdleOpCount &lt;= 0，那么会尝试提前退出时间窗：</p>
<h4 id="4-3-2-1-exitMaintenanceEarlyIfNeededLocked-提前退出时间窗"><a href="#4-3-2-1-exitMaintenanceEarlyIfNeededLocked-提前退出时间窗" class="headerlink" title="4.3.2.1 exitMaintenanceEarlyIfNeededLocked - 提前退出时间窗"></a>4.3.2.1 exitMaintenanceEarlyIfNeededLocked - 提前退出时间窗</h4><p>我们来看尝试提前退出时间窗的逻辑！<br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">exitMaintenanceEarlyIfNeededLocked</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    <span class="comment">//【1】首先，对状态做一个判断！</span></span><br><span class="line">    <span class="keyword">if</span> (mState == STATE_IDLE_MAINTENANCE || mLightState == LIGHT_STATE_IDLE_MAINTENANCE</span><br><span class="line">            || mLightState == LIGHT_STATE_PRE_IDLE) &#123;</span><br><span class="line">        <span class="comment">//【4.3.2.2】判断时间窗内是否还有任务执行，如果返回 true，表明可以提前退出时间窗！</span></span><br><span class="line">        <span class="keyword">if</span> (isOpsInactiveLocked()) &#123;</span><br><span class="line">            <span class="keyword">final</span> <span class="keyword">long</span> now = SystemClock.elapsedRealtime();</span><br><span class="line">            <span class="keyword">if</span> (DEBUG) &#123;</span><br><span class="line">                StringBuilder sb = <span class="keyword">new</span> StringBuilder();</span><br><span class="line">                sb.append(<span class="string">"Exit: start="</span>);</span><br><span class="line">                TimeUtils.formatDuration(mMaintenanceStartTime, sb);</span><br><span class="line">                sb.append(<span class="string">" now="</span>);</span><br><span class="line">                TimeUtils.formatDuration(now, sb);</span><br><span class="line">                Slog.d(TAG, sb.toString());</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            <span class="comment">//【2】如果是 deep idle 模式，且状态为 STATE_IDLE_MAINTENANCE，调用 stepIdleStateLocked</span></span><br><span class="line">            <span class="comment">// 提前退出时间窗，如果是 light idle 模式，调用 stepLightIdleStateLocked 退出时间窗！</span></span><br><span class="line">            <span class="keyword">if</span> (mState == STATE_IDLE_MAINTENANCE) &#123;</span><br><span class="line">                stepIdleStateLocked(<span class="string">"s:early"</span>); <span class="comment">//【3.1】</span></span><br><span class="line">            &#125; <span class="keyword">else</span> <span class="keyword">if</span> (mLightState == LIGHT_STATE_PRE_IDLE) &#123;</span><br><span class="line">                stepLightIdleStateLocked(<span class="string">"s:predone"</span>);<span class="comment">//【3.2】</span></span><br><span class="line">            &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                stepLightIdleStateLocked(<span class="string">"s:early"</span>);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>提前退出时间窗的意义在于，很可能在很短的时间内，时间窗内的工作已经完成了，我们就没有必要等到时间窗结束了！</p>
<p>首先对状态做了判断：</p>
<ul>
<li>deep idle 为 STATE_IDLE_MAINTENANCE；light idle 为 LIGHT_STATE_IDLE_MAINTENANCE/LIGHT_STATE_PRE_IDLE</li>
</ul>
<p>然后调用 isOpsInactiveLocked 方法，判断此时是否没有 active op，avtive job 和 active alarm！</p>
<h4 id="4-3-2-2-isOpsInactiveLocked"><a href="#4-3-2-2-isOpsInactiveLocked" class="headerlink" title="4.3.2.2 isOpsInactiveLocked"></a>4.3.2.2 isOpsInactiveLocked</h4><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">boolean</span> <span class="title">isOpsInactiveLocked</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    <span class="keyword">return</span> mActiveIdleOpCount &lt;= <span class="number">0</span> &amp;&amp; !mJobsActive &amp;&amp; !mAlarmsActive;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>该方法用于判断时间窗内是否还有任务执行：</p>
<p>如果 mActiveIdleOpCount &lt;= 0，同时没有 JobService，Alarms 处于活跃状态，那么 isOpsInactiveLocked 就返回 true！</p>
<h2 id="4-4-消息：MSG-REPORT-ACTIVE"><a href="#4-4-消息：MSG-REPORT-ACTIVE" class="headerlink" title="4.4 消息：MSG_REPORT_ACTIVE"></a>4.4 消息：MSG_REPORT_ACTIVE</h2><p>当 idle 状态的条件不满足后，会退出 doze 模式，恢复 STATE_ACTIVE 状态，发送 MSG_REPORT_ACTIVE 给 MyHandler！</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">case</span> MSG_REPORT_ACTIVE: &#123;</span><br><span class="line">    String activeReason = (String)msg.obj;</span><br><span class="line">    <span class="keyword">int</span> activeUid = msg.arg1;</span><br><span class="line">    EventLogTags.writeDeviceIdleOffStart(</span><br><span class="line">            activeReason != <span class="keyword">null</span> ? activeReason : <span class="string">"unknown"</span>);</span><br><span class="line">    <span class="comment">//【1】通知 PowerManager 退出 deep idle 和 light idle 状态！</span></span><br><span class="line">    <span class="keyword">final</span> <span class="keyword">boolean</span> deepChanged = mLocalPowerManager.setDeviceIdleMode(<span class="keyword">false</span>);</span><br><span class="line">    <span class="keyword">final</span> <span class="keyword">boolean</span> lightChanged = mLocalPowerManager.setLightDeviceIdleMode(<span class="keyword">false</span>);</span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">        <span class="comment">//【2】通知 NetworkPolicy 和 BatteryStats 退出 idle 状态！</span></span><br><span class="line">        mNetworkPolicyManager.setDeviceIdleMode(<span class="keyword">false</span>);</span><br><span class="line">        mBatteryStats.noteDeviceIdleMode(BatteryStats.DEVICE_IDLE_MODE_OFF,</span><br><span class="line">                activeReason, activeUid);</span><br><span class="line">    &#125; <span class="keyword">catch</span> (RemoteException e) &#123;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//【3】如果是退出 deep idle，发送广播通知其他服务！ </span></span><br><span class="line">    <span class="keyword">if</span> (deepChanged) &#123;</span><br><span class="line">        getContext().sendBroadcastAsUser(mIdleIntent, UserHandle.ALL);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">//【4】如果是退出 light idle，发送广播通知其他服务！ </span></span><br><span class="line">    <span class="keyword">if</span> (lightChanged) &#123;</span><br><span class="line">        getContext().sendBroadcastAsUser(mLightIdleIntent, UserHandle.ALL);</span><br><span class="line">    &#125;</span><br><span class="line">    EventLogTags.writeDeviceIdleOffComplete();</span><br><span class="line">&#125; <span class="keyword">break</span>;</span><br></pre></td></tr></table></figure>
<p>方法很简单，不多说了！</p>
<h2 id="4-5-消息：MSG-TEMP-APP-WHITELIST-TIMEOUT"><a href="#4-5-消息：MSG-TEMP-APP-WHITELIST-TIMEOUT" class="headerlink" title="4.5 消息：MSG_TEMP_APP_WHITELIST_TIMEOUT"></a>4.5 消息：MSG_TEMP_APP_WHITELIST_TIMEOUT</h2><p>我们可以将用户应用程序动态添加到 doze 模式的用户白名单中，使得应用可以在 doze 模式下运行，这种方式一旦添加，就一直生效，因为他会持久化到本地文件；</p>
<p>同时，我们还可以动态添加应用到临时缓存白名单中，使得该应用能够临时获得 doze 模式下的 network 和 wakelocks 访问，在添加时要指定临时的访问截至时间。时间过后，名单失效！！</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 临时缓存白名单，在该名单中的 uid 被临时标记为在 doze 模式下允许访问网络并获取唤醒锁；</span></span><br><span class="line"><span class="comment">// MutableLong 用于指定临时时间！</span></span><br><span class="line"><span class="keyword">private</span> <span class="keyword">final</span> SparseArray&lt;Pair&lt;MutableLong, String&gt;&gt; mTempWhitelistAppIdEndTimes</span><br><span class="line">        = <span class="keyword">new</span> SparseArray&lt;&gt;();</span><br><span class="line"></span><br><span class="line"> <span class="comment">// 当 mTempWhitelistAppIdEndTimes 发生变化后，用于通知 NetworkPolicyManagerService 执行任务！</span></span><br><span class="line">Runnable mNetworkPolicyTempWhitelistCallback;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 用于记录缓存 mTempWhitelistAppIdEndTimes 中的所有应用的 uid；</span></span><br><span class="line"><span class="keyword">private</span> <span class="keyword">int</span>[] mTempWhitelistAppIdArray = <span class="keyword">new</span> <span class="keyword">int</span>[<span class="number">0</span>];</span><br></pre></td></tr></table></figure>
<p>那么 MSG_TEMP_APP_WHITELIST_TIMEOUT 消息的所用是什么呢？就是不断的检查 mTempWhitelistAppIdEndTimes，mTempWhitelistAppIdArray，如果有过期名单，移除！</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">case</span> MSG_TEMP_APP_WHITELIST_TIMEOUT: &#123;</span><br><span class="line">    <span class="keyword">int</span> uid = msg.arg1;</span><br><span class="line">    <span class="comment">//【4.5.1】调用 checkTempAppWhitelistTimeout 方法！</span></span><br><span class="line">    checkTempAppWhitelistTimeout(uid);</span><br><span class="line">&#125; <span class="keyword">break</span>;</span><br></pre></td></tr></table></figure>
<p>核心方法在 checkTempAppWhitelistTimeout 中！</p>
<h3 id="4-5-1-checkTempAppWhitelistTimeout"><a href="#4-5-1-checkTempAppWhitelistTimeout" class="headerlink" title="4.5.1 checkTempAppWhitelistTimeout"></a>4.5.1 checkTempAppWhitelistTimeout</h3><p>检查缓存白名单中是否有应用过期！<br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">checkTempAppWhitelistTimeout</span><span class="params">(<span class="keyword">int</span> uid)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">final</span> <span class="keyword">long</span> timeNow = SystemClock.elapsedRealtime();</span><br><span class="line">    <span class="keyword">if</span> (DEBUG) &#123;</span><br><span class="line">        Slog.d(TAG, <span class="string">"checkTempAppWhitelistTimeout: uid="</span> + uid + <span class="string">", timeNow="</span> + timeNow);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">synchronized</span> (<span class="keyword">this</span>) &#123;</span><br><span class="line">        <span class="comment">//【1】判断临时缓存白名单中是否有该 uid！</span></span><br><span class="line">        Pair&lt;MutableLong, String&gt; entry = mTempWhitelistAppIdEndTimes.get(uid);</span><br><span class="line">        <span class="keyword">if</span> (entry == <span class="keyword">null</span>) &#123;</span><br><span class="line">            <span class="keyword">return</span>;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (timeNow &gt;= entry.first.value) &#123;</span><br><span class="line">            <span class="comment">//【2】当前时间 timeNow 超过了白名单中应用的有效期时间；</span></span><br><span class="line">            <span class="comment">// 将该应用从白名单中删除！</span></span><br><span class="line">            mTempWhitelistAppIdEndTimes.delete(uid);</span><br><span class="line">            <span class="keyword">if</span> (DEBUG) &#123;</span><br><span class="line">                Slog.d(TAG, <span class="string">"Removing UID "</span> + uid + <span class="string">" from temp whitelist"</span>);</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="comment">//【4.5.2.1】更新 PowerManager 中缓存白名单！</span></span><br><span class="line">            updateTempWhitelistAppIdsLocked();</span><br><span class="line">            <span class="keyword">if</span> (mNetworkPolicyTempWhitelistCallback != <span class="keyword">null</span>) &#123;</span><br><span class="line">                mHandler.post(mNetworkPolicyTempWhitelistCallback); <span class="comment">// 更新 NetworkPolicy 内部名单！</span></span><br><span class="line">            &#125;</span><br><span class="line">            <span class="comment">//【4.5.2.2】通知其他服务，缓存白名单发生了变化！</span></span><br><span class="line">            reportTempWhitelistChangedLocked();</span><br><span class="line">            <span class="keyword">try</span> &#123;</span><br><span class="line">                mBatteryStats.noteEvent(BatteryStats.HistoryItem.EVENT_TEMP_WHITELIST_FINISH,</span><br><span class="line">                        entry.second, uid);</span><br><span class="line">            &#125; <span class="keyword">catch</span> (RemoteException e) &#123;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            <span class="comment">//【3】如果当前时间 timeNow 还没有超过白名单中应用的有效期时间；</span></span><br><span class="line">            <span class="comment">// 延迟 entry.first.value - timeNow 时间间隔再次发送 MSG_TEMP_APP_WHITELIST_TIMEOUT 消息！</span></span><br><span class="line">            <span class="keyword">if</span> (DEBUG) &#123;</span><br><span class="line">                Slog.d(TAG, <span class="string">"Time to remove UID "</span> + uid + <span class="string">": "</span> + entry.first.value);</span><br><span class="line">            &#125;</span><br><span class="line">            postTempActiveTimeoutMessage(uid, entry.first.value - timeNow);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<h4 id="4-5-2-1-updateTempWhitelistAppIdsLocked"><a href="#4-5-2-1-updateTempWhitelistAppIdsLocked" class="headerlink" title="4.5.2.1 updateTempWhitelistAppIdsLocked"></a>4.5.2.1 updateTempWhitelistAppIdsLocked</h4><p>更新缓存白名单 mTempWhitelistAppIdEndTimes！<br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">updateTempWhitelistAppIdsLocked</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    <span class="comment">//【1】获得最新的 mTempWhitelistAppIdEndTimes 记录，更新 mTempWhitelistAppIdArray！</span></span><br><span class="line">    <span class="keyword">final</span> <span class="keyword">int</span> size = mTempWhitelistAppIdEndTimes.size();</span><br><span class="line">    <span class="keyword">if</span> (mTempWhitelistAppIdArray.length != size) &#123;</span><br><span class="line">        mTempWhitelistAppIdArray = <span class="keyword">new</span> <span class="keyword">int</span>[size];</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; size; i++) &#123;</span><br><span class="line">        mTempWhitelistAppIdArray[i] = mTempWhitelistAppIdEndTimes.keyAt(i);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">//【2】将最新的 mTempWhitelistAppIdArray 添加到 PowerManager 中！</span></span><br><span class="line">    <span class="keyword">if</span> (mLocalPowerManager != <span class="keyword">null</span>) &#123;</span><br><span class="line">        <span class="keyword">if</span> (DEBUG) &#123;</span><br><span class="line">            Slog.d(TAG, <span class="string">"Setting wakelock temp whitelist to "</span></span><br><span class="line">                    + Arrays.toString(mTempWhitelistAppIdArray));</span><br><span class="line">        &#125;</span><br><span class="line">        mLocalPowerManager.setDeviceIdleTempWhitelist(mTempWhitelistAppIdArray);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>mTempWhitelistAppIdArray 数组中用来保存缓存白名单的应用的 uid，和 mTempWhitelistAppIdEndTimes 是不同的描述角度！</p>
<h4 id="4-5-2-2-reportTempWhitelistChangedLocked"><a href="#4-5-2-2-reportTempWhitelistChangedLocked" class="headerlink" title="4.5.2.2 reportTempWhitelistChangedLocked"></a>4.5.2.2 reportTempWhitelistChangedLocked</h4><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">reportTempWhitelistChangedLocked</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    Intent intent = <span class="keyword">new</span> Intent(PowerManager.ACTION_POWER_SAVE_TEMP_WHITELIST_CHANGED);</span><br><span class="line">    intent.addFlags(Intent.FLAG_RECEIVER_REGISTERED_ONLY);</span><br><span class="line">    getContext().sendBroadcastAsUser(intent, UserHandle.SYSTEM);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>其实就是发送了 PowerManager.ACTION_POWER_SAVE_TEMP_WHITELIST_CHANGED 广播！</p>
<h2 id="4-6-消息：MSG-REPORT-MAINTENANCE-ACTIVITY"><a href="#4-6-消息：MSG-REPORT-MAINTENANCE-ACTIVITY" class="headerlink" title="4.6 消息：MSG_REPORT_MAINTENANCE_ACTIVITY"></a>4.6 消息：MSG_REPORT_MAINTENANCE_ACTIVITY</h2><p>当设备退出了 idle 状态后，系统中的 JobService 会开始执行，JobSchedulerService 会调用 DeviceIdleC.setJobsActive(true) 方法，将 JobService 的状态保存到 DeviceIdleController 中去！</p>
<h3 id="4-6-1-DeviceIdleC-setJobsActive"><a href="#4-6-1-DeviceIdleC-setJobsActive" class="headerlink" title="4.6.1 DeviceIdleC.setJobsActive"></a>4.6.1 DeviceIdleC.setJobsActive</h3><p>setJobsActive 用于设置 JobService 的活跃状态：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">setJobsActive</span><span class="params">(<span class="keyword">boolean</span> active)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">synchronized</span> (<span class="keyword">this</span>) &#123;</span><br><span class="line">        <span class="comment">//【1】将 mJobsActive 为 active 的值！</span></span><br><span class="line">        mJobsActive = active;</span><br><span class="line">        <span class="comment">//【4.6.1.1】JobService 的活跃状态发生了变化！</span></span><br><span class="line">        reportMaintenanceActivityIfNeededLocked();</span><br><span class="line"></span><br><span class="line">        <span class="comment">//【2】如果 active 为 false，说明此时没有 JobService 活跃了，</span></span><br><span class="line">        <span class="comment">// 那就尝试提前退出时间窗；</span></span><br><span class="line">        <span class="keyword">if</span> (!active) &#123;</span><br><span class="line">            exitMaintenanceEarlyIfNeededLocked();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h4 id="4-6-1-1-DeviceIdleC-reportMaintenanceActivityIfNeededLocked"><a href="#4-6-1-1-DeviceIdleC-reportMaintenanceActivityIfNeededLocked" class="headerlink" title="4.6.1.1 DeviceIdleC.reportMaintenanceActivityIfNeededLocked"></a>4.6.1.1 DeviceIdleC.reportMaintenanceActivityIfNeededLocked</h4><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">reportMaintenanceActivityIfNeededLocked</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    <span class="keyword">boolean</span> active = mJobsActive;</span><br><span class="line">    <span class="keyword">if</span> (active == mReportedMaintenanceActivity) &#123;</span><br><span class="line">        <span class="keyword">return</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    mReportedMaintenanceActivity = active;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//【2】发送 MSG_REPORT_MAINTENANCE_ACTIVITY 给 MyHandler！</span></span><br><span class="line">    Message msg = mHandler.obtainMessage(MSG_REPORT_MAINTENANCE_ACTIVITY,</span><br><span class="line">            mReportedMaintenanceActivity ? <span class="number">1</span> : <span class="number">0</span>, <span class="number">0</span>);</span><br><span class="line">    mHandler.sendMessage(msg);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>我们来看下 MyHandler 对于 MSG_REPORT_MAINTENANCE_ACTIVITY 消息的处理：<br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">case</span> MSG_REPORT_MAINTENANCE_ACTIVITY: &#123;</span><br><span class="line">    <span class="keyword">boolean</span> active = (msg.arg1 == <span class="number">1</span>);</span><br><span class="line">    <span class="keyword">final</span> <span class="keyword">int</span> size = mMaintenanceActivityListeners.beginBroadcast();</span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">        <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; size; i++) &#123;</span><br><span class="line">            <span class="keyword">try</span> &#123;</span><br><span class="line">                mMaintenanceActivityListeners.getBroadcastItem(i)</span><br><span class="line">                        .onMaintenanceActivityChanged(active);</span><br><span class="line">            &#125; <span class="keyword">catch</span> (RemoteException ignored) &#123;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">        mMaintenanceActivityListeners.finishBroadcast();</span><br><span class="line">    &#125;</span><br><span class="line">&#125; <span class="keyword">break</span>;</span><br></pre></td></tr></table></figure></p>
<h2 id="4-7-消息：MSG-FINISH-IDLE-OP"><a href="#4-7-消息：MSG-FINISH-IDLE-OP" class="headerlink" title="4.7 消息：MSG_FINISH_IDLE_OP"></a>4.7 消息：MSG_FINISH_IDLE_OP</h2><p>对于 MSG_FINISH_IDLE_OP 消息的处理很简单，就是调用 decActiveIdleOps 减少 mActiveIdleOpCount 引用计数！</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">case</span> MSG_FINISH_IDLE_OP: &#123;</span><br><span class="line">    <span class="comment">//【4.7.1】减少 </span></span><br><span class="line">    decActiveIdleOps();</span><br><span class="line">&#125; <span class="keyword">break</span>;</span><br></pre></td></tr></table></figure>
<h3 id="4-7-1-decActiveIdleOps"><a href="#4-7-1-decActiveIdleOps" class="headerlink" title="4.7.1 decActiveIdleOps"></a>4.7.1 decActiveIdleOps</h3><p>我们来看看 decActiveIdleOps 方法：<br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">decActiveIdleOps</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    <span class="keyword">synchronized</span> (<span class="keyword">this</span>) &#123;</span><br><span class="line">        <span class="comment">//【1】减少 mActiveIdleOpCount 计数；</span></span><br><span class="line">        mActiveIdleOpCount--;</span><br><span class="line">        <span class="keyword">if</span> (mActiveIdleOpCount &lt;= <span class="number">0</span>) &#123;</span><br><span class="line">            <span class="comment">//【4.3.2.1】尝试提前退出时间窗！</span></span><br><span class="line">            exitMaintenanceEarlyIfNeededLocked();</span><br><span class="line">            mActiveIdleWakeLock.release();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>这里的逻辑我们之前见过！</p>
<p>进入时间窗的时候 mActiveIdleOpCount 会被加 1，退出时间窗的时候，mActiveIdleOpCount 会被减 1；</p>
<h1 id="5-重置操作"><a href="#5-重置操作" class="headerlink" title="5 重置操作"></a>5 重置操作</h1><p>对于重置操作，我们放到这里来一起分析下；</p>
<p>然后，重置 deep idle 逻辑相关的变量，取消 Alarm 和监控器！！</p>
<h2 id="5-1-resetIdleManagementLocked"><a href="#5-1-resetIdleManagementLocked" class="headerlink" title="5.1 resetIdleManagementLocked"></a>5.1 resetIdleManagementLocked</h2><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">resetIdleManagementLocked</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    mNextIdlePendingDelay = <span class="number">0</span>;</span><br><span class="line">    mNextIdleDelay = <span class="number">0</span>;</span><br><span class="line">    mNextLightIdleDelay = <span class="number">0</span>;</span><br><span class="line">    <span class="comment">//【1.1.1.1.1】取消 mDeepAlarmListener</span></span><br><span class="line">    cancelAlarmLocked();</span><br><span class="line">    <span class="comment">//【1.1.1.1.2】取消 mSensingTimeoutAlarmListener</span></span><br><span class="line">    cancelSensingTimeoutAlarmLocked();</span><br><span class="line">    <span class="comment">//【1.1.1.1.3】取消 mGenericLocationListener，mGpsLocationListener</span></span><br><span class="line">    cancelLocatingLocked();</span><br><span class="line">    <span class="comment">//【1.1.1.1.4】取消 mMotionListener</span></span><br><span class="line">    stopMonitoringMotionLocked();</span><br><span class="line">    mAnyMotionDetector.stop();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h3 id="5-1-1-cancelAlarmLocked"><a href="#5-1-1-cancelAlarmLocked" class="headerlink" title="5.1.1 cancelAlarmLocked"></a>5.1.1 cancelAlarmLocked</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">cancelAlarmLocked</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    <span class="keyword">if</span> (mNextAlarmTime != <span class="number">0</span>) &#123;</span><br><span class="line">        mNextAlarmTime = <span class="number">0</span>;</span><br><span class="line">        mAlarmManager.cancel(mDeepAlarmListener);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>取消 mDeepAlarmListener！</p>
<p>该 mDeepAlarmListener 触发后会执行 stepIdleStateLocked 方法！</p>
<h3 id="5-1-2-cancelSensingTimeoutAlarmLocked"><a href="#5-1-2-cancelSensingTimeoutAlarmLocked" class="headerlink" title="5.1.2 cancelSensingTimeoutAlarmLocked"></a>5.1.2 cancelSensingTimeoutAlarmLocked</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">cancelSensingTimeoutAlarmLocked</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    <span class="keyword">if</span> (mNextSensingTimeoutAlarmTime != <span class="number">0</span>) &#123;</span><br><span class="line">        mNextSensingTimeoutAlarmTime = <span class="number">0</span>;</span><br><span class="line">        mAlarmManager.cancel(mSensingTimeoutAlarmListener);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>取消 mSensingTimeoutAlarmListener！</p>
<p>mSensingTimeoutAlarmListener 触发后，如果 mState 为 STATE_SENSING，这时会执行 1.1：becomeInactiveIfAppropriateLocked 方法！</p>
<h3 id="5-1-3-cancelLocatingLocked"><a href="#5-1-3-cancelLocatingLocked" class="headerlink" title="5.1.3 cancelLocatingLocked"></a>5.1.3 cancelLocatingLocked</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">cancelLocatingLocked</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    <span class="keyword">if</span> (mLocating) &#123;</span><br><span class="line">        mLocationManager.removeUpdates(mGenericLocationListener);</span><br><span class="line">        mLocationManager.removeUpdates(mGpsLocationListener);</span><br><span class="line">        mLocating = <span class="keyword">false</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>取消 mGenericLocationListener，mGpsLocationListener！</p>
<ul>
<li><p>mGenericLocationListener 触发后，会执行 receivedGenericLocationLocked 方法；</p>
</li>
<li><p>mGpsLocationListener 触发后，会执行 receivedGpsLocationLocked 方法；</p>
</li>
</ul>
<h3 id="5-1-4-stopMonitoringMotionLocked"><a href="#5-1-4-stopMonitoringMotionLocked" class="headerlink" title="5.1.4 stopMonitoringMotionLocked"></a>5.1.4 stopMonitoringMotionLocked</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">stopMonitoringMotionLocked</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    <span class="keyword">if</span> (DEBUG) Slog.d(TAG, <span class="string">"stopMonitoringMotionLocked()"</span>);</span><br><span class="line">    <span class="keyword">if</span> (mMotionSensor != <span class="keyword">null</span> &amp;&amp; mMotionListener.active) &#123;</span><br><span class="line">        mMotionListener.unregisterLocked();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>取消 mMotionListener！</p>
<h2 id="5-2-resetLightIdleManagementLocked"><a href="#5-2-resetLightIdleManagementLocked" class="headerlink" title="5.2 resetLightIdleManagementLocked"></a>5.2 resetLightIdleManagementLocked</h2><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">resetLightIdleManagementLocked</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    <span class="comment">//【1.1.2.1.1】取消之前设置的 light idle alarm！</span></span><br><span class="line">    cancelLightAlarmLocked();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>light idle 模式的重置相关变量过程很简单，只是取消 mLightAlarmListener！</p>
<h3 id="5-2-1-cancelLightAlarmLocked"><a href="#5-2-1-cancelLightAlarmLocked" class="headerlink" title="5.2.1 cancelLightAlarmLocked"></a>5.2.1 cancelLightAlarmLocked</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">cancelLightAlarmLocked</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    <span class="keyword">if</span> (mNextLightAlarmTime != <span class="number">0</span>) &#123;</span><br><span class="line">        mNextLightAlarmTime = <span class="number">0</span>;</span><br><span class="line">        <span class="comment">//【1】取消 mLightAlarmListener！</span></span><br><span class="line">        mAlarmManager.cancel(mLightAlarmListener);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>取消 mLightAlarmListener！</p>
<h1 id="6-提前退出时间窗"><a href="#6-提前退出时间窗" class="headerlink" title="6 提前退出时间窗"></a>6 提前退出时间窗</h1><h1 id="7-总结"><a href="#7-总结" class="headerlink" title="7 总结"></a>7 总结</h1><p>我们来看看 doze 模式下的监听器有哪些，下图是 doze 模式的所有监听器，监听不同的条件是否满足：</p>
<h2 id="7-1-状态监听器"><a href="#7-1-状态监听器" class="headerlink" title="7.1 状态监听器"></a>7.1 状态监听器</h2><p>下面的几张图是监听手机状态的监听器的逻辑：</p>
<h2 id="7-2-deep-idle"><a href="#7-2-deep-idle" class="headerlink" title="7.2 deep idle"></a>7.2 deep idle</h2><p>我们来总结下 deep idle 状态的流程：</p>
<p><img src="http://static.zybuluo.com/Coolqi/z8dwe5k2u6l2j81acr8alj32/deep%20idle%20%E6%B5%81%E7%A8%8B%E5%88%86%E6%9E%90.png" alt="deep idle 流程分析.png-269.1kB"></p>
<h2 id="7-3-light-idle"><a href="#7-3-light-idle" class="headerlink" title="7.3 light idle"></a>7.3 light idle</h2><p>我们来总结下 light idle 状态的流程：</p>
<p><img src="http://static.zybuluo.com/Coolqi/6lrmy3lq61spwiqi9k04r2za/light%20idle%20%E6%B5%81%E7%A8%8B.png" alt="light idle 流程.png-281.7kB"></p>
</div><hr></div><div class="recent-post-item article-container"><a class="article-title" href="/2017/10/01/Doze模式第 1 篇 - DeviceIdleController 的启动/">Doze模式第 1 篇 - DeviceIdleController 的启动</a><time class="post-meta__date"><i class="fa fa-calendar" aria-hidden="true"></i> 2017-10-01</time><span class="article-meta"><span class="article-meta__separator">|</span><i class="fa fa-inbox article-meta__icon" aria-hidden="true"></i><a class="article-meta__categories" href="/categories/AndroidFramework源码分析/">AndroidFramework源码分析</a><i class="fa fa-angle-right" aria-hidden="true"></i><i class="fa fa-inbox article-meta__icon" aria-hidden="true"></i><a class="article-meta__categories" href="/categories/AndroidFramework源码分析/Doze假寐模式/">Doze假寐模式</a></span><span class="article-meta tags"><span class="article-meta__separator">|</span><i class="fa fa-tag article-meta__icon" aria-hidden="true"></i><a class="article-meta__tags" href="/tags/Doze假寐模式/">Doze假寐模式</a></span><div class="content"><p>[toc]</p>
<p>基于 Android 7.1.1 源码，分析 doze 模式的原理！</p>
<h1 id="0-综述"><a href="#0-综述" class="headerlink" title="0 综述"></a>0 综述</h1><p>下面是 Android devoloper 网站对于 doze 模式的介绍：</p>
<p><img src="http://static.zybuluo.com/Coolqi/pd1xtpoar5dltrz0ze180ark/image.png" alt="image.png-61.3kB"></p>
<p>从 Android 6.0（API 级别 23）开始，Android 引入了两个省电功能，可通过管理应用在设备未连接至电源时的行为方式为用户延长电池寿命。</p>
<ul>
<li><p>低电耗模式（doze）通过在设备长时间处于闲置状态时推迟应用的后台 CPU 和网络操作来减少电池消耗。</p>
</li>
<li><p>应用待机模式可推迟用户近期未与之交互的应用的后台 Activity 的网络操作。</p>
</li>
</ul>
<p>假设一个用户停止充电 (on battery: 利用电池供电)，关闭屏幕 (screen off)。手机处于静止状态 (stationary)。保持以上条件一段时间之后，系统就会进入 Doze 模式。一旦进入 Doze 模式。系统就降低 (延缓) 应用对网络的訪问、以及对 CPU 的占用，来节省电池电量。</p>
<p>这一系列的文章先来分析下低电耗模式!</p>
<p>在低电耗 doze 模式下，应用会受到以下限制：</p>
<ul>
<li>暂停访问 <strong>Network</strong>。</li>
<li>系统将忽略 <strong>Wake Locks</strong>。</li>
<li>标准 <strong>AlarmManager</strong> 闹铃（包括 setExact() 和 setWindow()）推迟到 doze 模式的下一个 maintenance window 时间窗。<ul>
<li>如果您需要设置在低电耗模式下触发的闹铃，请使用 setAndAllowWhileIdle() 或 setExactAndAllowWhileIdle()。</li>
<li>一般情况下，使用 setAlarmClock() 设置的闹铃将继续触发，但系统会在这些闹铃触发之前不久退出低电耗模式。</li>
</ul>
</li>
<li>系统不执行 <strong>WiFi</strong> 扫描。</li>
<li>系统不允许运行 <strong>Sync</strong> 同步适配器。</li>
<li>系统不允许运行 <strong>JobScheduler</strong>。</li>
</ul>
<p>doze 模式的核心实现在 DeviceIdleController 中，下面我们来看看 DeviceIdleController 的启动！</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">startOtherServices</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    <span class="keyword">final</span> Context context = mSystemContext;</span><br><span class="line">    ... ... ...</span><br><span class="line">    <span class="keyword">if</span> (mFactoryTestMode != FactoryTest.FACTORY_TEST_LOW_LEVEL) &#123;</span><br><span class="line">        <span class="keyword">if</span> (!disableNonCoreServices) &#123;</span><br><span class="line">            traceBeginAndSlog(<span class="string">"StartLockSettingsService"</span>);</span><br><span class="line">            <span class="keyword">try</span> &#123;</span><br><span class="line">                mSystemServiceManager.startService(LOCK_SETTINGS_SERVICE_CLASS);</span><br><span class="line">                lockSettings = ILockSettings.Stub.asInterface(</span><br><span class="line">                        ServiceManager.getService(<span class="string">"lock_settings"</span>));</span><br><span class="line">            &#125; <span class="keyword">catch</span> (Throwable e) &#123;</span><br><span class="line">                reportWtf(<span class="string">"starting LockSettingsService service"</span>, e);</span><br><span class="line">            &#125;</span><br><span class="line">            Trace.traceEnd(Trace.TRACE_TAG_SYSTEM_SERVER);</span><br><span class="line"></span><br><span class="line">            <span class="keyword">if</span> (!SystemProperties.get(PERSISTENT_DATA_BLOCK_PROP).equals(<span class="string">""</span>)) &#123;</span><br><span class="line">                mSystemServiceManager.startService(PersistentDataBlockService.class);</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="comment">//【1】启动 DeviceIdleController 服务！</span></span><br><span class="line">            mSystemServiceManager.startService(DeviceIdleController.class);</span><br><span class="line"></span><br><span class="line">            <span class="comment">// Always start the Device Policy Manager, so that the API is compatible with</span></span><br><span class="line">            <span class="comment">// API8.</span></span><br><span class="line">            mSystemServiceManager.startService(DevicePolicyManagerService.Lifecycle.class);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        ... ... ...</span><br><span class="line">    &#125;</span><br><span class="line">    ... ... ... ...</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>启动 DeviceIdleController 的时机是在 SystemServer.startOtherServices 方法中！</p>
<h1 id="1-new-DeviceIdleController"><a href="#1-new-DeviceIdleController" class="headerlink" title="1 new DeviceIdleController"></a>1 new DeviceIdleController</h1><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="title">DeviceIdleController</span><span class="params">(Context context)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">super</span>(context);</span><br><span class="line">    mConfigFile = <span class="keyword">new</span> AtomicFile(<span class="keyword">new</span> File(getSystemDir(), <span class="string">"deviceidle.xml"</span>));</span><br><span class="line">    <span class="comment">//【1.1】处理耗时操作！</span></span><br><span class="line">    mHandler = <span class="keyword">new</span> MyHandler(BackgroundThread.getHandler().getLooper());</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>配置文件：</p>
<p>位于 /data/system/deviceidle.xml 中！</p>
<h2 id="1-1-new-MyHandler"><a href="#1-1-new-MyHandler" class="headerlink" title="1.1 new MyHandler"></a>1.1 new MyHandler</h2><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">final</span> <span class="class"><span class="keyword">class</span> <span class="title">MyHandler</span> <span class="keyword">extends</span> <span class="title">Handler</span> </span>&#123;</span><br><span class="line">    MyHandler(Looper looper) &#123;</span><br><span class="line">        <span class="keyword">super</span>(looper);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span> <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">handleMessage</span><span class="params">(Message msg)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">if</span> (DEBUG) Slog.d(TAG, <span class="string">"handleMessage("</span> + msg.what + <span class="string">")"</span>);</span><br><span class="line">        <span class="keyword">switch</span> (msg.what) &#123;</span><br><span class="line">            <span class="keyword">case</span> MSG_WRITE_CONFIG: &#123; <span class="comment">//【1】更新持久化文件！</span></span><br><span class="line">                handleWriteConfigFile();</span><br><span class="line">            &#125; <span class="keyword">break</span>;</span><br><span class="line">            </span><br><span class="line">            <span class="keyword">case</span> MSG_REPORT_IDLE_ON: <span class="comment">//【2】进入 device idle 状态</span></span><br><span class="line">            <span class="keyword">case</span> MSG_REPORT_IDLE_ON_LIGHT: &#123;</span><br><span class="line">                ... ... ...</span><br><span class="line">            &#125; <span class="keyword">break</span>;</span><br><span class="line">            </span><br><span class="line">            <span class="keyword">case</span> MSG_REPORT_IDLE_OFF: &#123; <span class="comment">//【3】进入时间窗 window </span></span><br><span class="line">                ... ... ...</span><br><span class="line">            &#125; <span class="keyword">break</span>;</span><br><span class="line">            </span><br><span class="line">            <span class="keyword">case</span> MSG_REPORT_ACTIVE: &#123;<span class="comment">//【4】退出 doze 模式，处于 active 状态</span></span><br><span class="line">                ... ... ...</span><br><span class="line">            &#125; <span class="keyword">break</span>;</span><br><span class="line">            </span><br><span class="line">            <span class="keyword">case</span> MSG_TEMP_APP_WHITELIST_TIMEOUT: &#123; <span class="comment">//【5】device idle 临时白名单超时移除操作！</span></span><br><span class="line">                <span class="keyword">int</span> uid = msg.arg1; </span><br><span class="line">                checkTempAppWhitelistTimeout(uid);</span><br><span class="line">            &#125; <span class="keyword">break</span>;</span><br><span class="line">            </span><br><span class="line">            <span class="keyword">case</span> MSG_REPORT_MAINTENANCE_ACTIVITY: &#123;</span><br><span class="line">                <span class="keyword">boolean</span> active = (msg.arg1 == <span class="number">1</span>);</span><br><span class="line">                <span class="keyword">final</span> <span class="keyword">int</span> size = mMaintenanceActivityListeners.beginBroadcast();</span><br><span class="line">                <span class="keyword">try</span> &#123;</span><br><span class="line">                    <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; size; i++) &#123;</span><br><span class="line">                        <span class="keyword">try</span> &#123;</span><br><span class="line">                            mMaintenanceActivityListeners.getBroadcastItem(i)</span><br><span class="line">                                    .onMaintenanceActivityChanged(active);</span><br><span class="line">                        &#125; <span class="keyword">catch</span> (RemoteException ignored) &#123;</span><br><span class="line">                        &#125;</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">                    mMaintenanceActivityListeners.finishBroadcast();</span><br><span class="line">                &#125;</span><br><span class="line">            &#125; <span class="keyword">break</span>;</span><br><span class="line">            </span><br><span class="line">            <span class="keyword">case</span> MSG_FINISH_IDLE_OP: &#123;</span><br><span class="line">                decActiveIdleOps();</span><br><span class="line">            &#125; <span class="keyword">break</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>我们看到，MyHandler 绑定到了一个后台线程，他会在后台线程中做一些比较耗时的操作！</p>
<h1 id="2-DeviceIdleController-onStart"><a href="#2-DeviceIdleController-onStart" class="headerlink" title="2 DeviceIdleController.onStart"></a>2 DeviceIdleController.onStart</h1><p>接着是进入 onStart 方法！</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onStart</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    <span class="keyword">final</span> PackageManager pm = getContext().getPackageManager();</span><br><span class="line"></span><br><span class="line">    <span class="keyword">synchronized</span> (<span class="keyword">this</span>) &#123;</span><br><span class="line">        <span class="comment">//【1】获得 deep mode 和 light mode 的属性配置！</span></span><br><span class="line">        mLightEnabled = mDeepEnabled = getContext().getResources().getBoolean(</span><br><span class="line">                com.android.internal.R.bool.config_enableAutoPowerModes);</span><br><span class="line">                </span><br><span class="line">        <span class="comment">//【2】从 SystemConfig 中获得解析到了 doze 模式白名单！</span></span><br><span class="line">        <span class="comment">// 获取在 power save 模式下可以运行，但在 device Idle (doze) 模式下不能运行的系统应用名单！</span></span><br><span class="line">        SystemConfig sysConfig = SystemConfig.getInstance();</span><br><span class="line">        ArraySet&lt;String&gt; allowPowerExceptIdle = sysConfig.getAllowInPowerSaveExceptIdle();</span><br><span class="line">        <span class="keyword">for</span> (<span class="keyword">int</span> i=<span class="number">0</span>; i&lt;allowPowerExceptIdle.size(); i++) &#123;</span><br><span class="line">            String pkg = allowPowerExceptIdle.valueAt(i);</span><br><span class="line">            <span class="keyword">try</span> &#123;</span><br><span class="line">                ApplicationInfo ai = pm.getApplicationInfo(pkg,</span><br><span class="line">                        PackageManager.MATCH_SYSTEM_ONLY);</span><br><span class="line">                <span class="keyword">int</span> appid = UserHandle.getAppId(ai.uid);</span><br><span class="line">                mPowerSaveWhitelistAppsExceptIdle.put(ai.packageName, appid);</span><br><span class="line">                mPowerSaveWhitelistSystemAppIdsExceptIdle.put(appid, <span class="keyword">true</span>);</span><br><span class="line">            &#125; <span class="keyword">catch</span> (PackageManager.NameNotFoundException e) &#123;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment">//【3】获取在 power save 模式下能够执行的系统应用名单！</span></span><br><span class="line">        ArraySet&lt;String&gt; allowPower = sysConfig.getAllowInPowerSave();</span><br><span class="line">        <span class="keyword">for</span> (<span class="keyword">int</span> i=<span class="number">0</span>; i&lt;allowPower.size(); i++) &#123;</span><br><span class="line">            String pkg = allowPower.valueAt(i);</span><br><span class="line">            <span class="keyword">try</span> &#123;</span><br><span class="line">                ApplicationInfo ai = pm.getApplicationInfo(pkg,</span><br><span class="line">                        PackageManager.MATCH_SYSTEM_ONLY);</span><br><span class="line">                <span class="keyword">int</span> appid = UserHandle.getAppId(ai.uid);</span><br><span class="line">                <span class="comment">//【3.1】在 power save 模式下能够执行的系统应用，也不能在 doze 模式下运行，</span></span><br><span class="line">                <span class="comment">// 所以也加入了上面的集合！</span></span><br><span class="line">                mPowerSaveWhitelistAppsExceptIdle.put(ai.packageName, appid);</span><br><span class="line">                mPowerSaveWhitelistSystemAppIdsExceptIdle.put(appid, <span class="keyword">true</span>);</span><br><span class="line"></span><br><span class="line">                mPowerSaveWhitelistApps.put(ai.packageName, appid);</span><br><span class="line">                mPowerSaveWhitelistSystemAppIds.put(appid, <span class="keyword">true</span>);</span><br><span class="line">            &#125; <span class="keyword">catch</span> (PackageManager.NameNotFoundException e) &#123;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment">//【*2.1】创建 Constants 实例，继承 ContentObserver，用于监控数据库变化，</span></span><br><span class="line">        <span class="comment">// 同时也定义了 Doze 模式中的一些时间间隔常量！</span></span><br><span class="line">        mConstants = <span class="keyword">new</span> Constants(mHandler, getContext().getContentResolver());</span><br><span class="line">        </span><br><span class="line">        <span class="comment">//【*2.2】读取持久化的配置 deviceidle.xml，并将当中定义的 package </span></span><br><span class="line">        <span class="comment">// 增加到 mPowerSaveWhitelistUserApps 中！</span></span><br><span class="line">        readConfigFileLocked();</span><br><span class="line"></span><br><span class="line">        <span class="comment">//【*2.3】更新名单！</span></span><br><span class="line">        updateWhitelistAppIdsLocked();</span><br><span class="line">        </span><br><span class="line">        <span class="comment">//【4】初始化状态变量！</span></span><br><span class="line">        mNetworkConnected = <span class="keyword">true</span>;</span><br><span class="line">        mScreenOn = <span class="keyword">true</span>;</span><br><span class="line">        mCharging = <span class="keyword">true</span>;</span><br><span class="line">        mState = STATE_ACTIVE;</span><br><span class="line">        mLightState = LIGHT_STATE_ACTIVE;</span><br><span class="line">        mInactiveTimeout = mConstants.INACTIVE_TIMEOUT;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//【2.4】创建 BinderService 对象，作为 DeviceIdleController 服务桩对象，</span></span><br><span class="line">    <span class="comment">// 并添加到 ServiceManager 中，用于和其他进程通信！</span></span><br><span class="line">    mBinderService = <span class="keyword">new</span> BinderService();</span><br><span class="line">    publishBinderService(Context.DEVICE_IDLE_CONTROLLER, mBinderService);</span><br><span class="line"></span><br><span class="line">    <span class="comment">//【2.5】创建对应的 LocalService，方便于进程内部通信！</span></span><br><span class="line">    publishLocalService(LocalService.class, <span class="keyword">new</span> LocalService());</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p><strong>SystemConfig</strong> 我们之前在分析 PMS 的启动的时候有涉及到，SystemConfig 会用来解析系统的配置信息！</p>
<p>这里涉及到了两个内部变量！</p>
<p>DeviceIdleController 提供了 2 中模式： mLightEnabled 和 mDeepEnabled！</p>
<ul>
<li><p><strong>deep idle 模式</strong>：会禁止 NetWork、Wakelock，还会禁止 Alarm。</p>
</li>
<li><p><strong>light idle 模式</strong>：会禁止 NetWork、Wakelock，但是不会禁止 Alarm。</p>
</li>
</ul>
<p>通过 config_enableAutoPowerModes 属性进行初始化，默认是 mLightEnabled = mDeepEnabled = false！</p>
<p>我们再来看下这里涉及到的重要集合：</p>
<ul>
<li><p><strong>mPowerSaveWhitelistAppsExceptIdle</strong>：保存在 power save 模式下可以后台运行，但在 doze 模式下不能后台运行的系统应用名单，packageName 和 appId 的映射！</p>
</li>
<li><p><strong>mPowerSaveWhitelistSystemAppIdsExceptIdle</strong>：保存在 power save 模式下后台运行运行，但在 doze 模式下不能后台运行的系统应用名单，appId 和 true 的映射！</p>
</li>
<li><p><strong>mPowerSaveWhitelistApps</strong>：保存在 power save 模式下可以后台运行的系统应用程序，packageName 和 appId 的映射！</p>
</li>
<li><p><strong>mPowerSaveWhitelistSystemAppIds</strong>：保存在 power save 模式下可以后台运行的系统应用程序，appId 和 true 的映射！</p>
</li>
</ul>
<h2 id="2-1-new-Constants"><a href="#2-1-new-Constants" class="headerlink" title="2.1 new Constants"></a>2.1 new Constants</h2><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="title">Constants</span><span class="params">(Handler handler, ContentResolver resolver)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">super</span>(handler);</span><br><span class="line">    mResolver = resolver;</span><br><span class="line">    mHasWatch = getContext().getPackageManager().hasSystemFeature(</span><br><span class="line">            PackageManager.FEATURE_WATCH);</span><br><span class="line">    <span class="comment">//【1】监控数据的变化！</span></span><br><span class="line">    mResolver.registerContentObserver(Settings.Global.getUriFor(</span><br><span class="line">            mHasWatch ? Settings.Global.DEVICE_IDLE_CONSTANTS_WATCH</span><br><span class="line">                      : Settings.Global.DEVICE_IDLE_CONSTANTS),</span><br><span class="line">            <span class="keyword">false</span>, <span class="keyword">this</span>);</span><br><span class="line">    <span class="comment">//【2.1.1】更新常量值！</span></span><br><span class="line">    updateConstants();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>可以看到 Constants 会监控数据库的变化，这里先做了一个 feature 的判断：PackageManager.FEATURE_WATCH，判断当前设备是否是可穿戴设备：watch！</p>
<p>因为这里我们关注的是手机设备，所以 Constants 监控的数据库是：Settings.Global.DEVICE_IDLE_CONSTANTS（device_idle_constants）</p>
<h3 id="2-1-1-Constants-updateConstants"><a href="#2-1-1-Constants-updateConstants" class="headerlink" title="2.1.1 Constants.updateConstants"></a>2.1.1 Constants.updateConstants</h3><p>updateConstants 会从 device_idle_constants 数据库中读取属性值，初始化一些关键的常量信息，如果读取不到，会初始化为默认值！</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">updateConstants</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    <span class="keyword">synchronized</span> (DeviceIdleController.<span class="keyword">this</span>) &#123;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            <span class="comment">//【1】读取数据库的值！</span></span><br><span class="line">            mParser.setString(Settings.Global.getString(mResolver,</span><br><span class="line">                    mHasWatch ? Settings.Global.DEVICE_IDLE_CONSTANTS_WATCH</span><br><span class="line">                              : Settings.Global.DEVICE_IDLE_CONSTANTS));</span><br><span class="line">        &#125; <span class="keyword">catch</span> (IllegalArgumentException e) &#123;</span><br><span class="line">            Slog.e(TAG, <span class="string">"Bad device idle settings"</span>, e);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">//【2】初始化关键性常量！</span></span><br><span class="line">        LIGHT_IDLE_AFTER_INACTIVE_TIMEOUT = mParser.getLong(</span><br><span class="line">                KEY_LIGHT_IDLE_AFTER_INACTIVE_TIMEOUT,</span><br><span class="line">                !COMPRESS_TIME ? <span class="number">5</span> * <span class="number">60</span> * <span class="number">1000L</span> : <span class="number">15</span> * <span class="number">1000L</span>);</span><br><span class="line">        LIGHT_PRE_IDLE_TIMEOUT = mParser.getLong(KEY_LIGHT_PRE_IDLE_TIMEOUT,</span><br><span class="line">                !COMPRESS_TIME ? <span class="number">10</span> * <span class="number">60</span> * <span class="number">1000L</span> : <span class="number">30</span> * <span class="number">1000L</span>);</span><br><span class="line">        LIGHT_IDLE_TIMEOUT = mParser.getLong(KEY_LIGHT_IDLE_TIMEOUT,</span><br><span class="line">                !COMPRESS_TIME ? <span class="number">5</span> * <span class="number">60</span> * <span class="number">1000L</span> : <span class="number">15</span> * <span class="number">1000L</span>);</span><br><span class="line">        LIGHT_IDLE_FACTOR = mParser.getFloat(KEY_LIGHT_IDLE_FACTOR,</span><br><span class="line">                <span class="number">2f</span>);</span><br><span class="line">        LIGHT_MAX_IDLE_TIMEOUT = mParser.getLong(KEY_LIGHT_MAX_IDLE_TIMEOUT,</span><br><span class="line">                !COMPRESS_TIME ? <span class="number">15</span> * <span class="number">60</span> * <span class="number">1000L</span> : <span class="number">60</span> * <span class="number">1000L</span>);</span><br><span class="line">        LIGHT_IDLE_MAINTENANCE_MIN_BUDGET = mParser.getLong(</span><br><span class="line">                KEY_LIGHT_IDLE_MAINTENANCE_MIN_BUDGET,</span><br><span class="line">                !COMPRESS_TIME ? <span class="number">1</span> * <span class="number">60</span> * <span class="number">1000L</span> : <span class="number">15</span> * <span class="number">1000L</span>);</span><br><span class="line">        LIGHT_IDLE_MAINTENANCE_MAX_BUDGET = mParser.getLong(</span><br><span class="line">                KEY_LIGHT_IDLE_MAINTENANCE_MAX_BUDGET,</span><br><span class="line">                !COMPRESS_TIME ? <span class="number">5</span> * <span class="number">60</span> * <span class="number">1000L</span> : <span class="number">30</span> * <span class="number">1000L</span>);</span><br><span class="line">        MIN_LIGHT_MAINTENANCE_TIME = mParser.getLong(</span><br><span class="line">                KEY_MIN_LIGHT_MAINTENANCE_TIME,</span><br><span class="line">                !COMPRESS_TIME ? <span class="number">5</span> * <span class="number">1000L</span> : <span class="number">1</span> * <span class="number">1000L</span>);</span><br><span class="line">        MIN_DEEP_MAINTENANCE_TIME = mParser.getLong(</span><br><span class="line">                KEY_MIN_DEEP_MAINTENANCE_TIME,</span><br><span class="line">                !COMPRESS_TIME ? <span class="number">30</span> * <span class="number">1000L</span> : <span class="number">5</span> * <span class="number">1000L</span>);</span><br><span class="line">        <span class="keyword">long</span> inactiveTimeoutDefault = (mHasWatch ? <span class="number">15</span> : <span class="number">30</span>) * <span class="number">60</span> * <span class="number">1000L</span>;</span><br><span class="line">        INACTIVE_TIMEOUT = mParser.getLong(KEY_INACTIVE_TIMEOUT,</span><br><span class="line">                !COMPRESS_TIME ? inactiveTimeoutDefault : (inactiveTimeoutDefault / <span class="number">10</span>));</span><br><span class="line">        SENSING_TIMEOUT = mParser.getLong(KEY_SENSING_TIMEOUT,</span><br><span class="line">                !DEBUG ? <span class="number">4</span> * <span class="number">60</span> * <span class="number">1000L</span> : <span class="number">60</span> * <span class="number">1000L</span>);</span><br><span class="line">        LOCATING_TIMEOUT = mParser.getLong(KEY_LOCATING_TIMEOUT,</span><br><span class="line">                !DEBUG ? <span class="number">30</span> * <span class="number">1000L</span> : <span class="number">15</span> * <span class="number">1000L</span>);</span><br><span class="line">        LOCATION_ACCURACY = mParser.getFloat(KEY_LOCATION_ACCURACY, <span class="number">20</span>);</span><br><span class="line">        MOTION_INACTIVE_TIMEOUT = mParser.getLong(KEY_MOTION_INACTIVE_TIMEOUT,</span><br><span class="line">                !COMPRESS_TIME ? <span class="number">10</span> * <span class="number">60</span> * <span class="number">1000L</span> : <span class="number">60</span> * <span class="number">1000L</span>);</span><br><span class="line">        <span class="keyword">long</span> idleAfterInactiveTimeout = (mHasWatch ? <span class="number">15</span> : <span class="number">30</span>) * <span class="number">60</span> * <span class="number">1000L</span>;</span><br><span class="line">        IDLE_AFTER_INACTIVE_TIMEOUT = mParser.getLong(KEY_IDLE_AFTER_INACTIVE_TIMEOUT,</span><br><span class="line">                !COMPRESS_TIME ? idleAfterInactiveTimeout</span><br><span class="line">                               : (idleAfterInactiveTimeout / <span class="number">10</span>));</span><br><span class="line">        IDLE_PENDING_TIMEOUT = mParser.getLong(KEY_IDLE_PENDING_TIMEOUT,</span><br><span class="line">                !COMPRESS_TIME ? <span class="number">5</span> * <span class="number">60</span> * <span class="number">1000L</span> : <span class="number">30</span> * <span class="number">1000L</span>);</span><br><span class="line">        MAX_IDLE_PENDING_TIMEOUT = mParser.getLong(KEY_MAX_IDLE_PENDING_TIMEOUT,</span><br><span class="line">                !COMPRESS_TIME ? <span class="number">10</span> * <span class="number">60</span> * <span class="number">1000L</span> : <span class="number">60</span> * <span class="number">1000L</span>);</span><br><span class="line">        IDLE_PENDING_FACTOR = mParser.getFloat(KEY_IDLE_PENDING_FACTOR,</span><br><span class="line">                <span class="number">2f</span>);</span><br><span class="line">        IDLE_TIMEOUT = mParser.getLong(KEY_IDLE_TIMEOUT,</span><br><span class="line">                !COMPRESS_TIME ? <span class="number">60</span> * <span class="number">60</span> * <span class="number">1000L</span> : <span class="number">6</span> * <span class="number">60</span> * <span class="number">1000L</span>);</span><br><span class="line">        MAX_IDLE_TIMEOUT = mParser.getLong(KEY_MAX_IDLE_TIMEOUT,</span><br><span class="line">                !COMPRESS_TIME ? <span class="number">6</span> * <span class="number">60</span> * <span class="number">60</span> * <span class="number">1000L</span> : <span class="number">30</span> * <span class="number">60</span> * <span class="number">1000L</span>);</span><br><span class="line">        IDLE_FACTOR = mParser.getFloat(KEY_IDLE_FACTOR,</span><br><span class="line">                <span class="number">2f</span>);</span><br><span class="line">        MIN_TIME_TO_ALARM = mParser.getLong(KEY_MIN_TIME_TO_ALARM,</span><br><span class="line">                !COMPRESS_TIME ? <span class="number">60</span> * <span class="number">60</span> * <span class="number">1000L</span> : <span class="number">6</span> * <span class="number">60</span> * <span class="number">1000L</span>);</span><br><span class="line">        MAX_TEMP_APP_WHITELIST_DURATION = mParser.getLong(</span><br><span class="line">                KEY_MAX_TEMP_APP_WHITELIST_DURATION, <span class="number">5</span> * <span class="number">60</span> * <span class="number">1000L</span>);</span><br><span class="line">        MMS_TEMP_APP_WHITELIST_DURATION = mParser.getLong(</span><br><span class="line">                KEY_MMS_TEMP_APP_WHITELIST_DURATION, <span class="number">60</span> * <span class="number">1000L</span>);</span><br><span class="line">        SMS_TEMP_APP_WHITELIST_DURATION = mParser.getLong(</span><br><span class="line">                KEY_SMS_TEMP_APP_WHITELIST_DURATION, <span class="number">20</span> * <span class="number">1000L</span>);</span><br><span class="line">        NOTIFICATION_WHITELIST_DURATION = mParser.getLong(</span><br><span class="line">                KEY_NOTIFICATION_WHITELIST_DURATION, <span class="number">30</span> * <span class="number">1000L</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>这里的 COMPRESS_TIME 为 false！</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="keyword">boolean</span> COMPRESS_TIME = <span class="keyword">false</span>;</span><br></pre></td></tr></table></figure>
<h3 id="2-1-2-Constants-常量"><a href="#2-1-2-Constants-常量" class="headerlink" title="2.1.2 Constants 常量"></a>2.1.2 Constants 常量</h3><p>从上面可以看到，doze 模式下涉及到很多和时间相关的值，这里我们来解释一下：</p>
<h4 id="2-1-2-1-Light-Idle-常量"><a href="#2-1-2-1-Light-Idle-常量" class="headerlink" title="2.1.2.1 Light Idle 常量"></a>2.1.2.1 Light Idle 常量</h4><ul>
<li><strong>LIGHT_IDLE_AFTER_INACTIVE_TIMEOUT</strong><br>light idle 时间属性，取值为 5 mins，当设备进入灭屏不充电的状态时，需要持续的时间!</li>
</ul>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">LIGHT_IDLE_AFTER_INACTIVE_TIMEOUT = mParser.getLong(</span><br><span class="line">        KEY_LIGHT_IDLE_AFTER_INACTIVE_TIMEOUT,</span><br><span class="line">        !COMPRESS_TIME ? <span class="number">5</span> * <span class="number">60</span> * <span class="number">1000L</span> : <span class="number">15</span> * <span class="number">1000L</span>);</span><br></pre></td></tr></table></figure>
<ul>
<li><strong>LIGHT_PRE_IDLE_TIMEOUT</strong><br>light idle 时间属性，取值为 10 mins，在进入 LIGHT_STATE_PRE_IDLE 阶段之前，如果判断设备有活跃操作执行的话，我们会设置一个 10mins 以后的 Alarm，等待这些操作执行完成，再进入 LIGHT_STATE_PRE_IDLE 阶段的处理！ </li>
</ul>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">LIGHT_PRE_IDLE_TIMEOUT = mParser.getLong(KEY_LIGHT_PRE_IDLE_TIMEOUT,</span><br><span class="line">        !COMPRESS_TIME ? <span class="number">10</span> * <span class="number">60</span> * <span class="number">1000L</span> : <span class="number">30</span> * <span class="number">1000L</span>);</span><br></pre></td></tr></table></figure>
<ul>
<li><strong>LIGHT_IDLE_TIMEOUT</strong><br>light idle 时间属性，取值为 5 mins，表示 light idle 的最小持续时间，也是第一次进入 light idle 的持续时间！</li>
</ul>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">LIGHT_IDLE_TIMEOUT = mParser.getLong(KEY_LIGHT_IDLE_TIMEOUT,</span><br><span class="line">        !COMPRESS_TIME ? <span class="number">5</span> * <span class="number">60</span> * <span class="number">1000L</span> : <span class="number">15</span> * <span class="number">1000L</span>);</span><br></pre></td></tr></table></figure>
<ul>
<li><strong>LIGHT_IDLE_FACTOR</strong><br>light idle 时间属性，取值为 2f, light idle 持续时间因子！</li>
</ul>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">LIGHT_IDLE_FACTOR = mParser.getFloat(KEY_LIGHT_IDLE_FACTOR, <span class="number">2f</span>);</span><br></pre></td></tr></table></figure>
<ul>
<li><strong>LIGHT_MAX_IDLE_TIMEOUT</strong><br>light idle 时间属性，取值为 15 mins，表示 light idle 的最大持续时间！</li>
</ul>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">LIGHT_MAX_IDLE_TIMEOUT = mParser.getLong(KEY_LIGHT_MAX_IDLE_TIMEOUT,</span><br><span class="line">        !COMPRESS_TIME ? <span class="number">15</span> * <span class="number">60</span> * <span class="number">1000L</span> : <span class="number">60</span> * <span class="number">1000L</span>);</span><br></pre></td></tr></table></figure>
<ul>
<li><strong>LIGHT_IDLE_MAINTENANCE_MIN_BUDGET</strong><br>light idle 时间属性，取值为 1mins, light idle 的最小时间窗！</li>
</ul>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">LIGHT_IDLE_MAINTENANCE_MIN_BUDGET = mParser.getLong(</span><br><span class="line">        KEY_LIGHT_IDLE_MAINTENANCE_MIN_BUDGET,</span><br><span class="line">        !COMPRESS_TIME ? <span class="number">1</span> * <span class="number">60</span> * <span class="number">1000L</span> : <span class="number">15</span> * <span class="number">1000L</span>);</span><br></pre></td></tr></table></figure>
<ul>
<li><p><strong>LIGHT_IDLE_MAINTENANCE_MAX_BUDGET</strong><br>light idle 时间属性，取值为 5mins, light idle 的最大时间窗！</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">LIGHT_IDLE_MAINTENANCE_MAX_BUDGET = mParser.getLong(</span><br><span class="line">        KEY_LIGHT_IDLE_MAINTENANCE_MAX_BUDGET,</span><br><span class="line">        !COMPRESS_TIME ? <span class="number">5</span> * <span class="number">60</span> * <span class="number">1000L</span> : <span class="number">30</span> * <span class="number">1000L</span>);</span><br></pre></td></tr></table></figure>
</li>
<li><p><strong>MIN_LIGHT_MAINTENANCE_TIME</strong><br>light idle 时间属性，取值为 5s, 用于判断是否提前退出时间窗！</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">MIN_LIGHT_MAINTENANCE_TIME = mParser.getLong(</span><br><span class="line">        KEY_MIN_LIGHT_MAINTENANCE_TIME,</span><br><span class="line">        !COMPRESS_TIME ? <span class="number">5</span> * <span class="number">1000L</span> : <span class="number">1</span> * <span class="number">1000L</span>);</span><br></pre></td></tr></table></figure>
</li>
</ul>
<h4 id="2-1-2-2-Deep-Idle-常量"><a href="#2-1-2-2-Deep-Idle-常量" class="headerlink" title="2.1.2.2 Deep Idle 常量"></a>2.1.2.2 Deep Idle 常量</h4><ul>
<li><p><strong>MIN_DEEP_MAINTENANCE_TIME</strong><br>deep idle 时间属性，取值为 30s, 用于判断是否提前退出时间窗！</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">MIN_DEEP_MAINTENANCE_TIME = mParser.getLong(</span><br><span class="line">        KEY_MIN_DEEP_MAINTENANCE_TIME,</span><br><span class="line">        !COMPRESS_TIME ? <span class="number">30</span> * <span class="number">1000L</span> : <span class="number">5</span> * <span class="number">1000L</span>);</span><br></pre></td></tr></table></figure>
</li>
<li><p><strong>INACTIVE_TIMEOUT</strong><br>deep idle 时间属性，取值为 30 mins，当设备的角度发生变化后，会回到 STATE_ACTIVE 状态，当下次满足灭屏不充电时，需要持续该时间才能进入 STATE_INACTIVE 状态；第一次进入满足灭屏不充电时，时间值也由 INACTIVE_TIMEOUT 设置  ！！</p>
</li>
</ul>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">long</span> inactiveTimeoutDefault = (mHasWatch ? <span class="number">15</span> : <span class="number">30</span>) * <span class="number">60</span> * <span class="number">1000L</span>;</span><br><span class="line">INACTIVE_TIMEOUT = mParser.getLong(KEY_INACTIVE_TIMEOUT,</span><br><span class="line">        !COMPRESS_TIME ? inactiveTimeoutDefault : (inactiveTimeoutDefault / <span class="number">10</span>));</span><br></pre></td></tr></table></figure>
<ul>
<li><strong>SENSING_TIMEOUT</strong><br>deep idle 时间属性，取值为 4 mins！<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">SENSING_TIMEOUT = mParser.getLong(KEY_SENSING_TIMEOUT,</span><br><span class="line">        !DEBUG ? <span class="number">4</span> * <span class="number">60</span> * <span class="number">1000L</span> : <span class="number">60</span> * <span class="number">1000L</span>);</span><br></pre></td></tr></table></figure>
</li>
</ul>
<ul>
<li><p><strong>LOCATING_TIMEOUT</strong><br>deep idle 时间属性，取值为 30s，当处于定位阶段时，要持续的时间！</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">LOCATING_TIMEOUT = mParser.getLong(KEY_LOCATING_TIMEOUT,</span><br><span class="line">        !DEBUG ? <span class="number">30</span> * <span class="number">1000L</span> : <span class="number">15</span> * <span class="number">1000L</span>);</span><br></pre></td></tr></table></figure>
</li>
<li><p><strong>LOCATION_ACCURACY</strong><br>deep idle 定位属性，取值为 20meter，定位精度！</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">LOCATION_ACCURACY = mParser.getFloat(KEY_LOCATION_ACCURACY, <span class="number">20</span>);</span><br></pre></td></tr></table></figure>
</li>
<li><p><strong>MOTION_INACTIVE_TIMEOUT</strong><br>deep idle 时间属性，取值为 10mins，当 sensor 被触发后，会回到 STATE_ACTIVE 状态，当下次满足灭屏不充电时，持续的时间就由 30mins 缩短为 10mins！</p>
</li>
</ul>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">MOTION_INACTIVE_TIMEOUT = mParser.getLong(KEY_MOTION_INACTIVE_TIMEOUT,</span><br><span class="line">        !COMPRESS_TIME ? <span class="number">10</span> * <span class="number">60</span> * <span class="number">1000L</span> : <span class="number">60</span> * <span class="number">1000L</span>);</span><br></pre></td></tr></table></figure>
<ul>
<li><strong>IDLE_AFTER_INACTIVE_TIMEOUT</strong><br>deep idle 时间属性，取值为 30 mins，当设备在 STATE_INACTIVE 阶段是会监听设备运动，需要保持不运动 30mins 才能进入 STATE_IDLE_PENDING 阶段！!</li>
</ul>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">long idleAfterInactiveTimeout = (mHasWatch ? 15 : 30) * 60 * 1000L;</span><br><span class="line">IDLE_AFTER_INACTIVE_TIMEOUT = mParser.getLong(KEY_IDLE_AFTER_INACTIVE_TIMEOUT,</span><br><span class="line">        !COMPRESS_TIME ? idleAfterInactiveTimeout</span><br><span class="line">                       : (idleAfterInactiveTimeout / 10));</span><br></pre></td></tr></table></figure>
<ul>
<li><strong>IDLE_PENDING_TIMEOUT</strong><br>deep idle 时间属性，取值为 5 mins，在 deep idle 状态下的初始时间窗！</li>
</ul>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">IDLE_PENDING_TIMEOUT = mParser.getLong(KEY_IDLE_PENDING_TIMEOUT,</span><br><span class="line">        !COMPRESS_TIME ? <span class="number">5</span> * <span class="number">60</span> * <span class="number">1000L</span> : <span class="number">30</span> * <span class="number">1000L</span>);</span><br></pre></td></tr></table></figure>
<ul>
<li><p><strong>MAX_IDLE_PENDING_TIMEOUT</strong><br>deep idle 时间属性，取值为 10 mins，在 deep idle 状态下的最大时间窗！</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">MAX_IDLE_PENDING_TIMEOUT = mParser.getLong(KEY_MAX_IDLE_PENDING_TIMEOUT,</span><br><span class="line">        !COMPRESS_TIME ? <span class="number">10</span> * <span class="number">60</span> * <span class="number">1000L</span> : <span class="number">60</span> * <span class="number">1000L</span>);</span><br></pre></td></tr></table></figure>
</li>
<li><p><strong>IDLE_PENDING_FACTOR</strong><br>deep idle 因子属性，取值为 2f，用于调整 deep idle 的时间窗！</p>
</li>
</ul>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">IDLE_PENDING_FACTOR = mParser.getFloat(KEY_IDLE_PENDING_FACTOR,</span><br><span class="line">        <span class="number">2f</span>);</span><br></pre></td></tr></table></figure>
<ul>
<li><p><strong>IDLE_TIMEOUT</strong><br>deep idle 时间属性，取值为 60 mins，deep idle 状态的初始持续时间！</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">IDLE_TIMEOUT = mParser.getLong(KEY_IDLE_TIMEOUT,</span><br><span class="line">        !COMPRESS_TIME ? <span class="number">60</span> * <span class="number">60</span> * <span class="number">1000L</span> : <span class="number">6</span> * <span class="number">60</span> * <span class="number">1000L</span>);</span><br></pre></td></tr></table></figure>
</li>
<li><p><strong>MAX_IDLE_TIMEOUT</strong><br>deep idle 时间属性，取值为 6 hours，deep idle 状态的最大持续时间！</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">MAX_IDLE_TIMEOUT = mParser.getLong(KEY_MAX_IDLE_TIMEOUT,</span><br><span class="line">        !COMPRESS_TIME ? <span class="number">6</span> * <span class="number">60</span> * <span class="number">60</span> * <span class="number">1000L</span> : <span class="number">30</span> * <span class="number">60</span> * <span class="number">1000L</span>);</span><br></pre></td></tr></table></figure>
</li>
<li><p><strong>IDLE_FACTOR</strong><br>deep idle 因子属性，取值为 2f，用于调整 deep idle 的时间窗！</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">IDLE_FACTOR = mParser.getFloat(KEY_IDLE_FACTOR, <span class="number">2f</span>);</span><br></pre></td></tr></table></figure>
</li>
<li><p><strong>MIN_TIME_TO_ALARM</strong><br>deep idle 时间属性，取值为 60mins，在每次改变 deep 状态时，会判断是否有 Alarm 在该时间内触发，如果有，不会进入 deep idle 状态！</p>
</li>
</ul>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">MIN_TIME_TO_ALARM = mParser.getLong(KEY_MIN_TIME_TO_ALARM,</span><br><span class="line">        !COMPRESS_TIME ? <span class="number">60</span> * <span class="number">60</span> * <span class="number">1000L</span> : <span class="number">6</span> * <span class="number">60</span> * <span class="number">1000L</span>);</span><br></pre></td></tr></table></figure>
<h4 id="2-1-2-3-其他相关变量"><a href="#2-1-2-3-其他相关变量" class="headerlink" title="2.1.2.3 其他相关变量"></a>2.1.2.3 其他相关变量</h4><ul>
<li><p><strong>MAX_TEMP_APP_WHITELIST_DURATION</strong><br>doze 模式的临时缓存白名单的最大有效时间，取值为 5mins！</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">MAX_TEMP_APP_WHITELIST_DURATION = mParser.getLong(</span><br><span class="line">        KEY_MAX_TEMP_APP_WHITELIST_DURATION, <span class="number">5</span> * <span class="number">60</span> * <span class="number">1000L</span>);</span><br></pre></td></tr></table></figure>
</li>
<li><p><strong>MMS_TEMP_APP_WHITELIST_DURATION</strong><br>MMS 应用的 doze 模式的临时缓存白名单的有效时间，60s</p>
</li>
</ul>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">MMS_TEMP_APP_WHITELIST_DURATION = mParser.getLong(</span><br><span class="line">        KEY_MMS_TEMP_APP_WHITELIST_DURATION, <span class="number">60</span> * <span class="number">1000L</span>);</span><br></pre></td></tr></table></figure>
<ul>
<li><p><strong>SMS_TEMP_APP_WHITELIST_DURATION</strong><br>SMS 应用的 doze 模式的临时缓存白名单的有效时间，20s</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">SMS_TEMP_APP_WHITELIST_DURATION = mParser.getLong(</span><br><span class="line">        KEY_SMS_TEMP_APP_WHITELIST_DURATION, <span class="number">20</span> * <span class="number">1000L</span>);</span><br></pre></td></tr></table></figure>
</li>
<li><p><strong>NOTIFICATION_WHITELIST_DURATION</strong><br>通知的白名单时间间隔，30s</p>
</li>
</ul>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">NOTIFICATION_WHITELIST_DURATION = mParser.getLong(</span><br><span class="line">        KEY_NOTIFICATION_WHITELIST_DURATION, <span class="number">30</span> * <span class="number">1000L</span>);</span><br></pre></td></tr></table></figure>
<p>对于这些变量的使用，我们后续再分析！</p>
<h2 id="2-2-DeviceIdleController-readConfigFileLocked"><a href="#2-2-DeviceIdleController-readConfigFileLocked" class="headerlink" title="2.2 DeviceIdleController.readConfigFileLocked"></a>2.2 DeviceIdleController.readConfigFileLocked</h2><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">readConfigFileLocked</span><span class="params">()</span> </span>&#123;</span><br><span class="line">     <span class="keyword">if</span> (DEBUG) Slog.d(TAG, <span class="string">"Reading config from "</span> + mConfigFile.getBaseFile());</span><br><span class="line">     <span class="comment">//【1】清空 mPowerSaveWhitelistUserApps 集合！</span></span><br><span class="line">     mPowerSaveWhitelistUserApps.clear();</span><br><span class="line">     FileInputStream stream;</span><br><span class="line">     <span class="keyword">try</span> &#123;</span><br><span class="line">         stream = mConfigFile.openRead(); <span class="comment">//【2】创建 /data/system/deviceidle.xml 输入流！</span></span><br><span class="line">     &#125; <span class="keyword">catch</span> (FileNotFoundException e) &#123;</span><br><span class="line">         <span class="keyword">return</span>;</span><br><span class="line">     &#125;</span><br><span class="line">     <span class="keyword">try</span> &#123;</span><br><span class="line">         XmlPullParser parser = Xml.newPullParser();</span><br><span class="line">         parser.setInput(stream, StandardCharsets.UTF_8.name());</span><br><span class="line">         <span class="comment">//【2.2.1】读取文件！</span></span><br><span class="line">         readConfigFileLocked(parser);</span><br><span class="line">     &#125; <span class="keyword">catch</span> (XmlPullParserException e) &#123;</span><br><span class="line">     &#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">         <span class="keyword">try</span> &#123;</span><br><span class="line">             stream.close();</span><br><span class="line">         &#125; <span class="keyword">catch</span> (IOException e) &#123;</span><br><span class="line">         &#125;</span><br><span class="line">     &#125;</span><br><span class="line"> &#125;</span><br></pre></td></tr></table></figure>
<p>继续调用另一个 readConfigFileLocked 方法！<br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">readConfigFileLocked</span><span class="params">(XmlPullParser parser)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">final</span> PackageManager pm = getContext().getPackageManager();</span><br><span class="line"></span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">        <span class="keyword">int</span> type;</span><br><span class="line">        <span class="keyword">while</span> ((type = parser.next()) != XmlPullParser.START_TAG</span><br><span class="line">                &amp;&amp; type != XmlPullParser.END_DOCUMENT) &#123;</span><br><span class="line">            ;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (type != XmlPullParser.START_TAG) &#123;</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> IllegalStateException(<span class="string">"no start tag found"</span>);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">int</span> outerDepth = parser.getDepth();</span><br><span class="line">        <span class="keyword">while</span> ((type = parser.next()) != XmlPullParser.END_DOCUMENT</span><br><span class="line">                &amp;&amp; (type != XmlPullParser.END_TAG || parser.getDepth() &gt; outerDepth)) &#123;</span><br><span class="line">            <span class="keyword">if</span> (type == XmlPullParser.END_TAG || type == XmlPullParser.TEXT) &#123;</span><br><span class="line">                <span class="keyword">continue</span>;</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            String tagName = parser.getName();</span><br><span class="line">            <span class="keyword">if</span> (tagName.equals(<span class="string">"wl"</span>)) &#123;</span><br><span class="line">                String name = parser.getAttributeValue(<span class="keyword">null</span>, <span class="string">"n"</span>);</span><br><span class="line">                <span class="keyword">if</span> (name != <span class="keyword">null</span>) &#123;</span><br><span class="line">                    <span class="keyword">try</span> &#123;</span><br><span class="line">                        ApplicationInfo ai = pm.getApplicationInfo(name,</span><br><span class="line">                                PackageManager.MATCH_UNINSTALLED_PACKAGES);</span><br><span class="line">                        <span class="comment">//【1】将用户应用程序的包名和 appId 加入到 mPowerSaveWhitelistUserApps 中；</span></span><br><span class="line">                        mPowerSaveWhitelistUserApps.put(ai.packageName,</span><br><span class="line">                                UserHandle.getAppId(ai.uid));</span><br><span class="line">                    &#125; <span class="keyword">catch</span> (PackageManager.NameNotFoundException e) &#123;</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                Slog.w(TAG, <span class="string">"Unknown element under &lt;config&gt;: "</span></span><br><span class="line">                        + parser.getName());</span><br><span class="line">                XmlUtils.skipCurrentTag(parser);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">    &#125; <span class="keyword">catch</span> (IllegalStateException e) &#123;</span><br><span class="line">        Slog.w(TAG, <span class="string">"Failed parsing config "</span> + e);</span><br><span class="line">    &#125; <span class="keyword">catch</span> (NullPointerException e) &#123;</span><br><span class="line">        Slog.w(TAG, <span class="string">"Failed parsing config "</span> + e);</span><br><span class="line">    &#125; <span class="keyword">catch</span> (NumberFormatException e) &#123;</span><br><span class="line">        Slog.w(TAG, <span class="string">"Failed parsing config "</span> + e);</span><br><span class="line">    &#125; <span class="keyword">catch</span> (XmlPullParserException e) &#123;</span><br><span class="line">        Slog.w(TAG, <span class="string">"Failed parsing config "</span> + e);</span><br><span class="line">    &#125; <span class="keyword">catch</span> (IOException e) &#123;</span><br><span class="line">        Slog.w(TAG, <span class="string">"Failed parsing config "</span> + e);</span><br><span class="line">    &#125; <span class="keyword">catch</span> (IndexOutOfBoundsException e) &#123;</span><br><span class="line">        Slog.w(TAG, <span class="string">"Failed parsing config "</span> + e);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>可以看到，readConfigFileLocked 方法最终解析 /data/system/deviceidle.xml 文件。</p>
<p>该文件中保存的是在 device mode 模式下，能够后台运行的用户应用白名单！</p>
<p>最终的解析结果，保存到了 <strong>mPowerSaveWhitelistUserApps</strong> 集合中，packageName 和 appId 的映射！</p>
<h2 id="2-3-DeviceIdleController-updateWhitelistAppIdsLocked"><a href="#2-3-DeviceIdleController-updateWhitelistAppIdsLocked" class="headerlink" title="2.3 DeviceIdleController.updateWhitelistAppIdsLocked"></a>2.3 DeviceIdleController.updateWhitelistAppIdsLocked</h2><p>我们先来回顾下前面涉及到的几个集合：</p>
<ul>
<li><p><strong>mPowerSaveWhitelistAppsExceptIdle</strong>：保存在 power save 模式下可以后台运行，但在 doze 模式下不能后台运行的系统应用名单，packageName 和 appId 的映射！</p>
</li>
<li><p><strong>mPowerSaveWhitelistSystemAppIdsExceptIdle</strong>：保存在 power save 模式下可以后台运行，但在 doze 模式下不能后台运行的系统应用名单，appId 和 true 的映射！</p>
</li>
<li><p><strong>mPowerSaveWhitelistApps</strong>：保存在 power save 模式下可以后台运行的系统应用，packageName 和 appId 的映射！</p>
</li>
<li><p><strong>mPowerSaveWhitelistSystemAppIds</strong>：保存在 power save 模式下可以后台运行的系统应用，appId 和 true 的映射！</p>
</li>
</ul>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">updateWhitelistAppIdsLocked</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    <span class="comment">//【1】合并白名单！</span></span><br><span class="line">    mPowerSaveWhitelistExceptIdleAppIdArray = buildAppIdArray(mPowerSaveWhitelistAppsExceptIdle,</span><br><span class="line">            mPowerSaveWhitelistUserApps, mPowerSaveWhitelistExceptIdleAppIds);</span><br><span class="line"></span><br><span class="line">    mPowerSaveWhitelistAllAppIdArray = buildAppIdArray(mPowerSaveWhitelistApps,</span><br><span class="line">            mPowerSaveWhitelistUserApps, mPowerSaveWhitelistAllAppIds);</span><br><span class="line"></span><br><span class="line">    mPowerSaveWhitelistUserAppIdArray = buildAppIdArray(<span class="keyword">null</span>,</span><br><span class="line">            mPowerSaveWhitelistUserApps, mPowerSaveWhitelistUserAppIds);</span><br><span class="line">    </span><br><span class="line">    <span class="comment">//【2】将白名单设置到 PowerManager 和 AlarmManager 中！</span></span><br><span class="line">    <span class="keyword">if</span> (mLocalPowerManager != <span class="keyword">null</span>) &#123;</span><br><span class="line">        <span class="keyword">if</span> (DEBUG) &#123;</span><br><span class="line">            Slog.d(TAG, <span class="string">"Setting wakelock whitelist to "</span></span><br><span class="line">                    + Arrays.toString(mPowerSaveWhitelistAllAppIdArray));</span><br><span class="line">        &#125;</span><br><span class="line">        mLocalPowerManager.setDeviceIdleWhitelist(mPowerSaveWhitelistAllAppIdArray);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span> (mLocalAlarmManager != <span class="keyword">null</span>) &#123;</span><br><span class="line">        <span class="keyword">if</span> (DEBUG) &#123;</span><br><span class="line">            Slog.d(TAG, <span class="string">"Setting alarm whitelist to "</span></span><br><span class="line">                    + Arrays.toString(mPowerSaveWhitelistUserAppIdArray));</span><br><span class="line">        &#125;</span><br><span class="line">        mLocalAlarmManager.setDeviceIdleUserWhitelist(mPowerSaveWhitelistUserAppIdArray);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>1、这里又设计到了几个重要集合：</p>
<ul>
<li><strong>mPowerSaveWhitelistExceptIdleAppIds</strong>：</li>
</ul>
<p>保存在 power save 模式下可以后台运行，但在 doze 模式下不能后台运行的系统和用户应用，packageName 和 appId 的映射；</p>
<p>集合来自 mPowerSaveWhitelistAppsExceptIdle 和 mPowerSaveWhitelistUserApps 的合并；</p>
<ul>
<li><strong>mPowerSaveWhitelistExceptIdleAppIdArray</strong>：</li>
</ul>
<p>保存在 power save 模式下可以后台运行，但在 doze 模式下不能后台运行的系统和用户应用 appId；</p>
<p>集合来自 mPowerSaveWhitelistAppsExceptIdle 和 mPowerSaveWhitelistUserApps 的合并；</p>
<ul>
<li><strong>mPowerSaveWhitelistAllAppIds</strong>：</li>
</ul>
<p>保存在 power save 模式下可以后台运行的系统和用户应用 (appId 和 true 的映射)；</p>
<p>集合来自 mPowerSaveWhitelistApps 和 mPowerSaveWhitelistUserApps 的合并；</p>
<ul>
<li><strong>mPowerSaveWhitelistAllAppIdArray</strong>：</li>
</ul>
<p>保存在 power save 模式下可以后台运行的系统和用户应用 appId；</p>
<p>集合来自 mPowerSaveWhitelistApps 和 mPowerSaveWhitelistUserApps 的合并；</p>
<ul>
<li><strong>mPowerSaveWhitelistUserAppIds</strong>：</li>
</ul>
<p>保存在 power save 模式下可以后台运行的用户应用 (appId 和 true 的映射)；</p>
<p>集合来自 mPowerSaveWhitelistUserApps；</p>
<ul>
<li><strong>mPowerSaveWhitelistUserAppIdArray</strong>：</li>
</ul>
<p>保存在 power save 模式下可以后台运行的用户应用 appId；</p>
<p>集合来自 mPowerSaveWhitelistUserApps；</p>
<p><br></p>
<p>2、传递名单</p>
<p>接着，将 mPowerSaveWhitelistAllAppIdArray 传递给了 PowerManagerService；</p>
<p>然后，将 mPowerSaveWhitelistUserAppIdArray 传递给了 AlarmManagerService；</p>
<h3 id="2-3-1-DeviceIdleController-buildAppIdArray"><a href="#2-3-1-DeviceIdleController-buildAppIdArray" class="headerlink" title="2.3.1 DeviceIdleController.buildAppIdArray"></a>2.3.1 DeviceIdleController.buildAppIdArray</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">int</span>[] buildAppIdArray(ArrayMap&lt;String, Integer&gt; systemApps,</span><br><span class="line">        ArrayMap&lt;String, Integer&gt; userApps, SparseBooleanArray outAppIds) &#123;</span><br><span class="line">    outAppIds.clear();</span><br><span class="line">    <span class="comment">//【1】将 systemApps 和 userApps 合并到 outAppIds 中，appId 和 true 值的映射！</span></span><br><span class="line">    <span class="keyword">if</span> (systemApps != <span class="keyword">null</span>) &#123;</span><br><span class="line">        <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; systemApps.size(); i++) &#123;</span><br><span class="line">            outAppIds.put(systemApps.valueAt(i), <span class="keyword">true</span>);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span> (userApps != <span class="keyword">null</span>) &#123;</span><br><span class="line">        <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; userApps.size(); i++) &#123;</span><br><span class="line">            outAppIds.put(userApps.valueAt(i), <span class="keyword">true</span>);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">//【2】将 outAppIds 中的所有 appId 保存到数组 appids 中，并返回！</span></span><br><span class="line">    <span class="keyword">int</span> size = outAppIds.size();</span><br><span class="line">    <span class="keyword">int</span>[] appids = <span class="keyword">new</span> <span class="keyword">int</span>[size];</span><br><span class="line">    <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; size; i++) &#123;</span><br><span class="line">        appids[i] = outAppIds.keyAt(i);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> appids;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h2 id="2-4-new-BinderService"><a href="#2-4-new-BinderService" class="headerlink" title="2.4 new BinderService"></a>2.4 new BinderService</h2><p>创建了一个 BinderService 对象，继承了 IDeviceIdleController.Stub，作为服务端桩对象，用于其它进程访问 DeviceIdleController 内部接口！！</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">private</span> <span class="keyword">final</span> <span class="class"><span class="keyword">class</span> <span class="title">BinderService</span> <span class="keyword">extends</span> <span class="title">IDeviceIdleController</span>.<span class="title">Stub</span> </span>&#123;</span><br><span class="line">    <span class="comment">//【1】添加应用到 power save 应用白名单中！</span></span><br><span class="line">    <span class="meta">@Override</span> <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">addPowerSaveWhitelistApp</span><span class="params">(String name)</span> </span>&#123;</span><br><span class="line">        getContext().enforceCallingOrSelfPermission(android.Manifest.permission.DEVICE_POWER,</span><br><span class="line">                <span class="keyword">null</span>);</span><br><span class="line">        <span class="keyword">long</span> ident = Binder.clearCallingIdentity();</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            addPowerSaveWhitelistAppInternal(name);</span><br><span class="line">        &#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">            Binder.restoreCallingIdentity(ident);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">//【2】移除应用从 power save 应用白名单中！</span></span><br><span class="line">    <span class="meta">@Override</span> <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">removePowerSaveWhitelistApp</span><span class="params">(String name)</span> </span>&#123;</span><br><span class="line">        getContext().enforceCallingOrSelfPermission(android.Manifest.permission.DEVICE_POWER,</span><br><span class="line">                <span class="keyword">null</span>);</span><br><span class="line">        <span class="keyword">long</span> ident = Binder.clearCallingIdentity();</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            removePowerSaveWhitelistAppInternal(name);</span><br><span class="line">        &#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">            Binder.restoreCallingIdentity(ident);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">//【3】获取在 power save 模式下可以后台运行但是在 device idle 状态下不能后台运行的白名单！</span></span><br><span class="line">    <span class="meta">@Override</span> <span class="keyword">public</span> String[] getSystemPowerWhitelistExceptIdle() &#123;</span><br><span class="line">        <span class="keyword">return</span> getSystemPowerWhitelistExceptIdleInternal();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span> <span class="keyword">public</span> String[] getSystemPowerWhitelist() &#123;</span><br><span class="line">        <span class="keyword">return</span> getSystemPowerWhitelistInternal();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span> <span class="keyword">public</span> String[] getUserPowerWhitelist() &#123;</span><br><span class="line">        <span class="keyword">return</span> getUserPowerWhitelistInternal();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span> <span class="keyword">public</span> String[] getFullPowerWhitelistExceptIdle() &#123;</span><br><span class="line">        <span class="keyword">return</span> getFullPowerWhitelistExceptIdleInternal();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span> <span class="keyword">public</span> String[] getFullPowerWhitelist() &#123;</span><br><span class="line">        <span class="keyword">return</span> getFullPowerWhitelistInternal();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span> <span class="keyword">public</span> <span class="keyword">int</span>[] getAppIdWhitelistExceptIdle() &#123;</span><br><span class="line">        <span class="keyword">return</span> getAppIdWhitelistExceptIdleInternal();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span> <span class="keyword">public</span> <span class="keyword">int</span>[] getAppIdWhitelist() &#123;</span><br><span class="line">        <span class="keyword">return</span> getAppIdWhitelistInternal();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span> <span class="keyword">public</span> <span class="keyword">int</span>[] getAppIdUserWhitelist() &#123;</span><br><span class="line">        <span class="keyword">return</span> getAppIdUserWhitelistInternal();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span> <span class="keyword">public</span> <span class="keyword">int</span>[] getAppIdTempWhitelist() &#123;</span><br><span class="line">        <span class="keyword">return</span> getAppIdTempWhitelistInternal();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span> <span class="function"><span class="keyword">public</span> <span class="keyword">boolean</span> <span class="title">isPowerSaveWhitelistExceptIdleApp</span><span class="params">(String name)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> isPowerSaveWhitelistExceptIdleAppInternal(name);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span> <span class="function"><span class="keyword">public</span> <span class="keyword">boolean</span> <span class="title">isPowerSaveWhitelistApp</span><span class="params">(String name)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> isPowerSaveWhitelistAppInternal(name);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span> <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">addPowerSaveTempWhitelistApp</span><span class="params">(String packageName, <span class="keyword">long</span> duration,</span></span></span><br><span class="line"><span class="function"><span class="params">            <span class="keyword">int</span> userId, String reason)</span> <span class="keyword">throws</span> RemoteException </span>&#123;</span><br><span class="line">        addPowerSaveTempWhitelistAppChecked(packageName, duration, userId, reason);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span> <span class="function"><span class="keyword">public</span> <span class="keyword">long</span> <span class="title">addPowerSaveTempWhitelistAppForMms</span><span class="params">(String packageName,</span></span></span><br><span class="line"><span class="function"><span class="params">            <span class="keyword">int</span> userId, String reason)</span> <span class="keyword">throws</span> RemoteException </span>&#123;</span><br><span class="line">        <span class="keyword">long</span> duration = mConstants.MMS_TEMP_APP_WHITELIST_DURATION;</span><br><span class="line">        addPowerSaveTempWhitelistAppChecked(packageName, duration, userId, reason);</span><br><span class="line">        <span class="keyword">return</span> duration;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span> <span class="function"><span class="keyword">public</span> <span class="keyword">long</span> <span class="title">addPowerSaveTempWhitelistAppForSms</span><span class="params">(String packageName,</span></span></span><br><span class="line"><span class="function"><span class="params">            <span class="keyword">int</span> userId, String reason)</span> <span class="keyword">throws</span> RemoteException </span>&#123;</span><br><span class="line">        <span class="keyword">long</span> duration = mConstants.SMS_TEMP_APP_WHITELIST_DURATION;</span><br><span class="line">        addPowerSaveTempWhitelistAppChecked(packageName, duration, userId, reason);</span><br><span class="line">        <span class="keyword">return</span> duration;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span> <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">exitIdle</span><span class="params">(String reason)</span> </span>&#123;</span><br><span class="line">        getContext().enforceCallingOrSelfPermission(Manifest.permission.DEVICE_POWER,</span><br><span class="line">                <span class="keyword">null</span>);</span><br><span class="line">        <span class="keyword">long</span> ident = Binder.clearCallingIdentity();</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            exitIdleInternal(reason);</span><br><span class="line">        &#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">            Binder.restoreCallingIdentity(ident);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span> <span class="function"><span class="keyword">public</span> <span class="keyword">boolean</span> <span class="title">registerMaintenanceActivityListener</span><span class="params">(</span></span></span><br><span class="line"><span class="function"><span class="params">            IMaintenanceActivityListener listener)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> DeviceIdleController.<span class="keyword">this</span>.registerMaintenanceActivityListener(listener);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span> <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">unregisterMaintenanceActivityListener</span><span class="params">(</span></span></span><br><span class="line"><span class="function"><span class="params">            IMaintenanceActivityListener listener)</span> </span>&#123;</span><br><span class="line">        DeviceIdleController.<span class="keyword">this</span>.unregisterMaintenanceActivityListener(listener);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span> <span class="function"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title">dump</span><span class="params">(FileDescriptor fd, PrintWriter pw, String[] args)</span> </span>&#123;</span><br><span class="line">        DeviceIdleController.<span class="keyword">this</span>.dump(fd, pw, args);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span> <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onShellCommand</span><span class="params">(FileDescriptor in, FileDescriptor out,</span></span></span><br><span class="line"><span class="function"><span class="params">            FileDescriptor err, String[] args, ResultReceiver resultReceiver)</span> </span>&#123;</span><br><span class="line">        (<span class="keyword">new</span> Shell()).exec(<span class="keyword">this</span>, in, out, err, args, resultReceiver);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>这里的接口，我们先不详细看！</p>
<p>最后，将桩对象注册到了 ServiceManager 中！</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">publishBinderService(Context.DEVICE_IDLE_CONTROLLER, mBinderService);</span><br></pre></td></tr></table></figure>
<h2 id="2-5-new-LocalService"><a href="#2-5-new-LocalService" class="headerlink" title="2.5 new LocalService"></a>2.5 new LocalService</h2><p>创建了本地服务对象，方便进程内部通信！<br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">final</span> <span class="class"><span class="keyword">class</span> <span class="title">LocalService</span> </span>&#123;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">addPowerSaveTempWhitelistAppDirect</span><span class="params">(<span class="keyword">int</span> appId, <span class="keyword">long</span> duration, <span class="keyword">boolean</span> sync,</span></span></span><br><span class="line"><span class="function"><span class="params">            String reason)</span> </span>&#123;</span><br><span class="line">        addPowerSaveTempWhitelistAppDirectInternal(<span class="number">0</span>, appId, duration, sync, reason);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">long</span> <span class="title">getNotificationWhitelistDuration</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> mConstants.NOTIFICATION_WHITELIST_DURATION;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">setNetworkPolicyTempWhitelistCallback</span><span class="params">(Runnable callback)</span> </span>&#123;</span><br><span class="line">        setNetworkPolicyTempWhitelistCallbackInternal(callback);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">setJobsActive</span><span class="params">(<span class="keyword">boolean</span> active)</span> </span>&#123;</span><br><span class="line">        DeviceIdleController.<span class="keyword">this</span>.setJobsActive(active);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// Up-call from alarm manager.</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">setAlarmsActive</span><span class="params">(<span class="keyword">boolean</span> active)</span> </span>&#123;</span><br><span class="line">        DeviceIdleController.<span class="keyword">this</span>.setAlarmsActive(active);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">int</span>[] getPowerSaveWhitelistUserAppIds() &#123;</span><br><span class="line">        <span class="keyword">return</span> DeviceIdleController.<span class="keyword">this</span>.getPowerSaveWhitelistUserAppIds();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<h1 id="3-DeviceIdleController-onBootPhase"><a href="#3-DeviceIdleController-onBootPhase" class="headerlink" title="3 DeviceIdleController.onBootPhase"></a>3 DeviceIdleController.onBootPhase</h1><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onBootPhase</span><span class="params">(<span class="keyword">int</span> phase)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">if</span> (phase == PHASE_SYSTEM_SERVICES_READY) &#123;</span><br><span class="line">        <span class="keyword">synchronized</span> (<span class="keyword">this</span>) &#123;</span><br><span class="line">            <span class="comment">//【1】获得了一些重要的系统服务：AlarmManager，BatteryStats，PowerManager，ConnectivityService</span></span><br><span class="line">            <span class="comment">// NetworkPolicyManager，DisplayManager 和 SensorManager；</span></span><br><span class="line">            mAlarmManager = (AlarmManager) getContext().getSystemService(Context.ALARM_SERVICE);</span><br><span class="line">            mBatteryStats = BatteryStatsService.getService();</span><br><span class="line">            mLocalPowerManager = getLocalService(PowerManagerInternal.class);</span><br><span class="line">            mPowerManager = getContext().getSystemService(PowerManager.class);</span><br><span class="line">            mActiveIdleWakeLock = mPowerManager.newWakeLock(PowerManager.PARTIAL_WAKE_LOCK,</span><br><span class="line">                    <span class="string">"deviceidle_maint"</span>);</span><br><span class="line">            mActiveIdleWakeLock.setReferenceCounted(<span class="keyword">false</span>);</span><br><span class="line">            mConnectivityService = (ConnectivityService)ServiceManager.getService(</span><br><span class="line">                    Context.CONNECTIVITY_SERVICE);</span><br><span class="line">            mLocalAlarmManager = getLocalService(AlarmManagerService.LocalService.class);</span><br><span class="line">            mNetworkPolicyManager = INetworkPolicyManager.Stub.asInterface(</span><br><span class="line">                    ServiceManager.getService(Context.NETWORK_POLICY_SERVICE));</span><br><span class="line">            mDisplayManager = (DisplayManager) getContext().getSystemService(</span><br><span class="line">                    Context.DISPLAY_SERVICE);</span><br><span class="line"></span><br><span class="line">            <span class="comment">// 获得 SensorManager，用于获得系统的传感器信息！</span></span><br><span class="line">            mSensorManager = (SensorManager) getContext().getSystemService(Context.SENSOR_SERVICE);</span><br><span class="line">            <span class="keyword">int</span> sigMotionSensorId = getContext().getResources().getInteger(</span><br><span class="line">                    com.android.internal.R.integer.config_autoPowerModeAnyMotionSensor);</span><br><span class="line">            <span class="comment">// 获得运动传感器对象，监听手机位置变化！</span></span><br><span class="line">            <span class="keyword">if</span> (sigMotionSensorId &gt; <span class="number">0</span>) &#123;</span><br><span class="line">                mMotionSensor = mSensorManager.getDefaultSensor(sigMotionSensorId, <span class="keyword">true</span>);</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">if</span> (mMotionSensor == <span class="keyword">null</span> &amp;&amp; getContext().getResources().getBoolean(</span><br><span class="line">                    com.android.internal.R.bool.config_autoPowerModePreferWristTilt)) &#123;</span><br><span class="line">                mMotionSensor = mSensorManager.getDefaultSensor(</span><br><span class="line">                        Sensor.TYPE_WRIST_TILT_GESTURE, <span class="keyword">true</span>);</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">if</span> (mMotionSensor == <span class="keyword">null</span>) &#123;</span><br><span class="line">                mMotionSensor = mSensorManager.getDefaultSensor(</span><br><span class="line">                        Sensor.TYPE_SIGNIFICANT_MOTION, <span class="keyword">true</span>);</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            <span class="keyword">if</span> (getContext().getResources().getBoolean(</span><br><span class="line">                    com.android.internal.R.bool.config_autoPowerModePrefetchLocation)) &#123;</span><br><span class="line">                mLocationManager = (LocationManager) getContext().getSystemService(</span><br><span class="line">                        Context.LOCATION_SERVICE);</span><br><span class="line">                mLocationRequest = <span class="keyword">new</span> LocationRequest()</span><br><span class="line">                    .setQuality(LocationRequest.ACCURACY_FINE)</span><br><span class="line">                    .setInterval(<span class="number">0</span>)</span><br><span class="line">                    .setFastestInterval(<span class="number">0</span>)</span><br><span class="line">                    .setNumUpdates(<span class="number">1</span>);</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="comment">// 通过配置文件。得到角度变化的阈值！</span></span><br><span class="line">            <span class="comment">// 创建一个 AnyMotionDetector，同一时候将 DeviceIdleController 注冊到当中</span></span><br><span class="line">            <span class="comment">// 当 AnyMotionDetector 检測到手机变化角度超过阈值时。就会回调 DeviceIdleController 的接口</span></span><br><span class="line">            <span class="keyword">float</span> angleThreshold = getContext().getResources().getInteger(</span><br><span class="line">                    com.android.internal.R.integer.config_autoPowerModeThresholdAngle) / <span class="number">100f</span>;</span><br><span class="line">            mAnyMotionDetector = <span class="keyword">new</span> AnyMotionDetector(</span><br><span class="line">                    (PowerManager) getContext().getSystemService(Context.POWER_SERVICE),</span><br><span class="line">                    mHandler, mSensorManager, <span class="keyword">this</span>, angleThreshold);</span><br><span class="line">            </span><br><span class="line">            <span class="comment">// 创建了两个广播对象，一个用于通知 deep doze 模式变化；另一个用于通知 light doze 模式变化！</span></span><br><span class="line">            mIdleIntent = <span class="keyword">new</span> Intent(PowerManager.ACTION_DEVICE_IDLE_MODE_CHANGED);</span><br><span class="line">            mIdleIntent.addFlags(Intent.FLAG_RECEIVER_REGISTERED_ONLY</span><br><span class="line">                    | Intent.FLAG_RECEIVER_FOREGROUND);</span><br><span class="line">            mLightIdleIntent = <span class="keyword">new</span> Intent(PowerManager.ACTION_LIGHT_DEVICE_IDLE_MODE_CHANGED);</span><br><span class="line">            mLightIdleIntent.addFlags(Intent.FLAG_RECEIVER_REGISTERED_ONLY</span><br><span class="line">                    | Intent.FLAG_RECEIVER_FOREGROUND);</span><br><span class="line"></span><br><span class="line">            <span class="comment">//【3.1】监听电池变化的广播！</span></span><br><span class="line">            IntentFilter filter = <span class="keyword">new</span> IntentFilter();</span><br><span class="line">            filter.addAction(Intent.ACTION_BATTERY_CHANGED);</span><br><span class="line">            getContext().registerReceiver(mReceiver, filter);</span><br><span class="line"></span><br><span class="line">            <span class="comment">//【3】监听 package 变化的广播！</span></span><br><span class="line">            filter = <span class="keyword">new</span> IntentFilter();</span><br><span class="line">            filter.addAction(Intent.ACTION_PACKAGE_REMOVED);</span><br><span class="line">            filter.addDataScheme(<span class="string">"package"</span>);</span><br><span class="line">            getContext().registerReceiver(mReceiver, filter);</span><br><span class="line"></span><br><span class="line">            <span class="comment">//【4】监听网络变化的广播！</span></span><br><span class="line">            filter = <span class="keyword">new</span> IntentFilter();</span><br><span class="line">            filter.addAction(ConnectivityManager.CONNECTIVITY_ACTION);</span><br><span class="line">            getContext().registerReceiver(mReceiver, filter);</span><br><span class="line"></span><br><span class="line">            <span class="comment">//【5】再次将 mPowerSaveWhitelistAllAppIdArray 传递给了 PowerManagerService；</span></span><br><span class="line">            <span class="comment">// 将 mPowerSaveWhitelistUserAppIdArray 传递给了 AlarmManagerService；</span></span><br><span class="line">            mLocalPowerManager.setDeviceIdleWhitelist(mPowerSaveWhitelistAllAppIdArray);</span><br><span class="line">            mLocalAlarmManager.setDeviceIdleUserWhitelist(mPowerSaveWhitelistUserAppIdArray);</span><br><span class="line"></span><br><span class="line">            <span class="comment">//【3.2】注册 DisplayListener 监听熄屏亮屏状态，同时更新屏幕状态！</span></span><br><span class="line">            mDisplayManager.registerDisplayListener(mDisplayListener, <span class="keyword">null</span>);</span><br><span class="line">            updateDisplayLocked();</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">//【3.3】更新网络连接状态！</span></span><br><span class="line">        updateConnectivityState(<span class="keyword">null</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>这里我们来看看 DisplayListener 对象！</p>
<h2 id="3-1-new-BroadcastReceiver"><a href="#3-1-new-BroadcastReceiver" class="headerlink" title="3.1 new BroadcastReceiver"></a>3.1 new BroadcastReceiver</h2><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">private</span> <span class="keyword">final</span> BroadcastReceiver mReceiver = <span class="keyword">new</span> BroadcastReceiver() &#123;</span><br><span class="line">    <span class="meta">@Override</span> <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onReceive</span><span class="params">(Context context, Intent intent)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">switch</span> (intent.getAction()) &#123;</span><br><span class="line">            <span class="keyword">case</span> ConnectivityManager.CONNECTIVITY_ACTION: &#123;</span><br><span class="line">                updateConnectivityState(intent); <span class="comment">// 网络变化</span></span><br><span class="line">            &#125; <span class="keyword">break</span>;</span><br><span class="line">            <span class="keyword">case</span> Intent.ACTION_BATTERY_CHANGED: &#123;</span><br><span class="line">                <span class="keyword">synchronized</span> (DeviceIdleController.<span class="keyword">this</span>) &#123;</span><br><span class="line">                    <span class="keyword">int</span> plugged = intent.getIntExtra(<span class="string">"plugged"</span>, <span class="number">0</span>);</span><br><span class="line">                    updateChargingLocked(plugged != <span class="number">0</span>); <span class="comment">// 电量变化</span></span><br><span class="line">                &#125;</span><br><span class="line">            &#125; <span class="keyword">break</span>;</span><br><span class="line">            <span class="keyword">case</span> Intent.ACTION_PACKAGE_REMOVED: &#123; <span class="comment">// 升级包移除！</span></span><br><span class="line">                <span class="keyword">if</span> (!intent.getBooleanExtra(Intent.EXTRA_REPLACING, <span class="keyword">false</span>)) &#123;</span><br><span class="line">                    Uri data = intent.getData();</span><br><span class="line">                    String ssp;</span><br><span class="line">                    <span class="keyword">if</span> (data != <span class="keyword">null</span> &amp;&amp; (ssp = data.getSchemeSpecificPart()) != <span class="keyword">null</span>) &#123;</span><br><span class="line">                        <span class="comment">//【3.1.1】更新用户应用白名单！</span></span><br><span class="line">                        removePowerSaveWhitelistAppInternal(ssp);</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125; <span class="keyword">break</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>
<p>创建了一个 BroadcastReceiver 对象，监听 CONNECTIVITY_ACTION，ACTION_BATTERY_CHANGED，ACTION_PACKAGE_REMOVED 广播！</p>
<p>关于监听到变化后的动态处理，这里我们先不分析！</p>
<h3 id="3-1-1-DeviceIdleController-removePowerSaveWhitelistAppInternal"><a href="#3-1-1-DeviceIdleController-removePowerSaveWhitelistAppInternal" class="headerlink" title="3.1.1 DeviceIdleController.removePowerSaveWhitelistAppInternal"></a>3.1.1 DeviceIdleController.removePowerSaveWhitelistAppInternal</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">boolean</span> <span class="title">removePowerSaveWhitelistAppInternal</span><span class="params">(String name)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">synchronized</span> (<span class="keyword">this</span>) &#123;</span><br><span class="line">        <span class="keyword">if</span> (mPowerSaveWhitelistUserApps.remove(name) != <span class="keyword">null</span>) &#123;</span><br><span class="line">            <span class="comment">//【1】发送 ACTION_POWER_SAVE_WHITELIST_CHANGED 广播！</span></span><br><span class="line">            reportPowerSaveWhitelistChangedLocked();</span><br><span class="line">            <span class="comment">//【2.3.1】更新名单列表，同时</span></span><br><span class="line">            updateWhitelistAppIdsLocked();</span><br><span class="line">            <span class="comment">//【3】更新本地持久化文件！</span></span><br><span class="line">            writeConfigFileLocked();</span><br><span class="line">            <span class="keyword">return</span> <span class="keyword">true</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">false</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>reportPowerSaveWhitelistChangedLocked 方法会发送 PowerManager.ACTION_POWER_SAVE_WHITELIST_CHANGED 广播！<br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">reportPowerSaveWhitelistChangedLocked</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    Intent intent = <span class="keyword">new</span> Intent(PowerManager.ACTION_POWER_SAVE_WHITELIST_CHANGED);</span><br><span class="line">    intent.addFlags(Intent.FLAG_RECEIVER_REGISTERED_ONLY);</span><br><span class="line">    getContext().sendBroadcastAsUser(intent, UserHandle.SYSTEM);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>writeConfigFileLocked 方法会发送 MSG_WRITE_CONFIG 消息给 MyHandler。MyHandler 会处理消息，调用 handleWriteConfigFile -&gt; writeConfigFileLocked(XmlSerializer out) 方法，更新本地名单！<br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">writeConfigFileLocked</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    mHandler.removeMessages(MSG_WRITE_CONFIG);</span><br><span class="line">    mHandler.sendEmptyMessageDelayed(MSG_WRITE_CONFIG, <span class="number">5000</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>继续看！</p>
<h2 id="3-2-register-DisplayListener"><a href="#3-2-register-DisplayListener" class="headerlink" title="3.2 register DisplayListener"></a>3.2 register DisplayListener</h2><p>mDisplayListener 用于监听屏幕的状态！<br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">private</span> <span class="keyword">final</span> DisplayManager.DisplayListener mDisplayListener</span><br><span class="line">        = <span class="keyword">new</span> DisplayManager.DisplayListener() &#123;</span><br><span class="line">    <span class="meta">@Override</span> <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onDisplayAdded</span><span class="params">(<span class="keyword">int</span> displayId)</span> </span>&#123;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span> <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onDisplayRemoved</span><span class="params">(<span class="keyword">int</span> displayId)</span> </span>&#123;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span> <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onDisplayChanged</span><span class="params">(<span class="keyword">int</span> displayId)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">if</span> (displayId == Display.DEFAULT_DISPLAY) &#123;</span><br><span class="line">            <span class="keyword">synchronized</span> (DeviceIdleController.<span class="keyword">this</span>) &#123;</span><br><span class="line">                <span class="comment">//【3.1.1】当屏幕状态发生变化后，onDisplayChanged 方法被触发！</span></span><br><span class="line">                <span class="comment">// 执行了 DeviceIdleController.updateDisplayLocked 方法！</span></span><br><span class="line">                updateDisplayLocked();</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure></p>
<h3 id="3-2-1-DeviceIdleController-updateDisplayLocked"><a href="#3-2-1-DeviceIdleController-updateDisplayLocked" class="headerlink" title="3.2.1 DeviceIdleController.updateDisplayLocked"></a>3.2.1 DeviceIdleController.updateDisplayLocked</h3><p>updateDisplayLocked 用于更新屏幕的状态！<br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">updateDisplayLocked</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    <span class="comment">//【1】获取屏幕当前的状态，并判断是否是亮屏状态！</span></span><br><span class="line">    mCurDisplay = mDisplayManager.getDisplay(Display.DEFAULT_DISPLAY);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">boolean</span> screenOn = mCurDisplay.getState() == Display.STATE_ON;</span><br><span class="line">    <span class="keyword">if</span> (DEBUG) Slog.d(TAG, <span class="string">"updateDisplayLocked: screenOn="</span> + screenOn);</span><br><span class="line">    <span class="keyword">if</span> (!screenOn &amp;&amp; mScreenOn) &#123;</span><br><span class="line">        <span class="comment">//【2.1】如果是从亮屏转为熄屏，设置 mScreenOn 为 false！</span></span><br><span class="line">        mScreenOn = <span class="keyword">false</span>;</span><br><span class="line">        <span class="keyword">if</span> (!mForceIdle) &#123;</span><br><span class="line">            becomeInactiveIfAppropriateLocked(); <span class="comment">// 进入 Doze 模式；</span></span><br><span class="line">        &#125;</span><br><span class="line">    &#125; <span class="keyword">else</span> <span class="keyword">if</span> (screenOn) &#123;</span><br><span class="line">        <span class="comment">//【2.2】如果是从熄屏转亮屏，设置 mScreenOn 为 true！</span></span><br><span class="line">        mScreenOn = <span class="keyword">true</span>;</span><br><span class="line">        <span class="keyword">if</span> (!mForceIdle) &#123;</span><br><span class="line">            becomeActiveLocked(<span class="string">"screen"</span>, Process.myUid()); <span class="comment">// 退出 Doze 模式；</span></span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>mForceIdle 表示是否强制进入 idle 状态，默认为 false 的，目前唯一的开启方式是通过 adb shell，执行 dumpsys 命令，触发 force-idle，force-inactive 相关指令，强制进入 idle 状态！！</p>
<p>这里看到，当熄屏后，会调用 becomeInactiveIfAppropriateLocked 方法，进入 doze 模式；当亮屏后，会调用 becomeActiveLocked 方法，退出 doze！</p>
<h2 id="3-3-DeviceIdleController-updateConnectivityState"><a href="#3-3-DeviceIdleController-updateConnectivityState" class="headerlink" title="3.3 DeviceIdleController.updateConnectivityState"></a>3.3 DeviceIdleController.updateConnectivityState</h2><p>更新网络状态！<br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">updateConnectivityState</span><span class="params">(Intent connIntent)</span> </span>&#123;</span><br><span class="line">    ConnectivityService cm;</span><br><span class="line">    <span class="keyword">synchronized</span> (<span class="keyword">this</span>) &#123;</span><br><span class="line">        cm = mConnectivityService;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span> (cm == <span class="keyword">null</span>) &#123;</span><br><span class="line">        <span class="keyword">return</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    NetworkInfo ni = cm.getActiveNetworkInfo();</span><br><span class="line">    <span class="keyword">synchronized</span> (<span class="keyword">this</span>) &#123;</span><br><span class="line">        <span class="keyword">boolean</span> conn;</span><br><span class="line">        <span class="keyword">if</span> (ni == <span class="keyword">null</span>) &#123;</span><br><span class="line">            <span class="comment">//【1】网络断开，conn 为 false；</span></span><br><span class="line">            conn = <span class="keyword">false</span>;</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            <span class="comment">//【2】获得网络的连接状态；</span></span><br><span class="line">            <span class="keyword">if</span> (connIntent == <span class="keyword">null</span>) &#123;</span><br><span class="line">                conn = ni.isConnected();</span><br><span class="line">            &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                <span class="keyword">final</span> <span class="keyword">int</span> networkType =</span><br><span class="line">                        connIntent.getIntExtra(ConnectivityManager.EXTRA_NETWORK_TYPE,</span><br><span class="line">                                ConnectivityManager.TYPE_NONE);</span><br><span class="line">                <span class="keyword">if</span> (ni.getType() != networkType) &#123;</span><br><span class="line">                    <span class="keyword">return</span>;</span><br><span class="line">                &#125;</span><br><span class="line">                conn = !connIntent.getBooleanExtra(ConnectivityManager.EXTRA_NO_CONNECTIVITY,</span><br><span class="line">                        <span class="keyword">false</span>);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">//【3】处理连接状态，如果当前状态和之前的状态发生了变化，更新 mNetworkConnected 的值</span></span><br><span class="line">        <span class="keyword">if</span> (conn != mNetworkConnected) &#123;</span><br><span class="line">            mNetworkConnected = conn;</span><br><span class="line">            <span class="comment">//【4】如果本次状态是处于连接中，并且 light idle 正在等待网络，那就继续处理状态！！</span></span><br><span class="line">            <span class="keyword">if</span> (conn &amp;&amp; mLightState == LIGHT_STATE_WAITING_FOR_NETWORK) &#123;</span><br><span class="line">                stepLightIdleStateLocked(<span class="string">"network"</span>);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>可以看到 DeviceIdleController 的启动流程还是很简单的！</p>
<h1 id="4-启动总结"><a href="#4-启动总结" class="headerlink" title="4 启动总结"></a>4 启动总结</h1><p>我们通过一张图来看看 DeviceIdleController 的整个启动过程！</p>
<p><img src="http://static.zybuluo.com/Coolqi/tbg4pb5gnbv170z6lujwzifn/DeviceIdleController%E5%90%AF%E5%8A%A8%E6%B5%81%E7%A8%8B.png" alt="DeviceIdleController启动流程.png-75kB"></p>
<p>其他优秀博客！！</p>
<p><a href="https://blog.csdn.net/kc58236582/article/details/54923406" target="_blank" rel="noopener">https://blog.csdn.net/kc58236582/article/details/54923406</a><br><a href="https://www.cnblogs.com/gavanwanggw/p/7327832.html" target="_blank" rel="noopener">https://www.cnblogs.com/gavanwanggw/p/7327832.html</a></p>
</div><hr></div><div class="recent-post-item article-container"><a class="article-title" href="/2017/09/27/AlarmManager第 4 篇 - AlarmManagerService属性总结/">AlarmManager第 4 篇 - AlarmManagerService属性总结</a><time class="post-meta__date"><i class="fa fa-calendar" aria-hidden="true"></i> 2017-09-27</time><span class="article-meta"><span class="article-meta__separator">|</span><i class="fa fa-inbox article-meta__icon" aria-hidden="true"></i><a class="article-meta__categories" href="/categories/AndroidFramework源码分析/">AndroidFramework源码分析</a><i class="fa fa-angle-right" aria-hidden="true"></i><i class="fa fa-inbox article-meta__icon" aria-hidden="true"></i><a class="article-meta__categories" href="/categories/AndroidFramework源码分析/AlarmManager闹钟管理/">AlarmManager闹钟管理</a></span><span class="article-meta tags"><span class="article-meta__separator">|</span><i class="fa fa-tag article-meta__icon" aria-hidden="true"></i><a class="article-meta__tags" href="/tags/AlarmManager闹钟管理/">AlarmManager闹钟管理</a></span><div class="content"><p>首先我们来看看 AlarmManagerService 中的一些成员变量：</p>
<p>1、首先是一些二进制标志位：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//【1】alarm 的类型，用二进制表示！</span></span><br><span class="line"><span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="keyword">int</span> RTC_WAKEUP_MASK = <span class="number">1</span> &lt;&lt; RTC_WAKEUP; <span class="comment">// 1 &lt;&lt; 0</span></span><br><span class="line"><span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="keyword">int</span> RTC_MASK = <span class="number">1</span> &lt;&lt; RTC;  <span class="comment">// 1 &lt;&lt; 1</span></span><br><span class="line"><span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="keyword">int</span> ELAPSED_REALTIME_WAKEUP_MASK = <span class="number">1</span> &lt;&lt; ELAPSED_REALTIME_WAKEUP; <span class="comment">// // 1 &lt;&lt; 2</span></span><br><span class="line"><span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="keyword">int</span> ELAPSED_REALTIME_MASK = <span class="number">1</span> &lt;&lt; ELAPSED_REALTIME;  <span class="comment">// 1 &lt;&lt; 3</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// 时间是否改变</span></span><br><span class="line"><span class="keyword">static</span> <span class="keyword">final</span> <span class="keyword">int</span> TIME_CHANGED_MASK = <span class="number">1</span> &lt;&lt; <span class="number">16</span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 该 alarm 是否是 wake up 类型的</span></span><br><span class="line"><span class="keyword">static</span> <span class="keyword">final</span> <span class="keyword">int</span> IS_WAKEUP_MASK = RTC_WAKEUP_MASK|ELAPSED_REALTIME_WAKEUP_MASK;</span><br><span class="line"></span><br><span class="line"><span class="comment">// Mask for testing whether a given alarm type is wakeup vs non-wakeup</span></span><br><span class="line"><span class="keyword">static</span> <span class="keyword">final</span> <span class="keyword">int</span> TYPE_NONWAKEUP_MASK = <span class="number">0x1</span>; <span class="comment">// low bit =&gt; non-wakeup</span></span><br></pre></td></tr></table></figure>
<p>RTC_WAKEUP，RTC，ELAPSED_REALTIME_WAKEUP，ELAPSED_REALTIME 定义在 AlarmManager 中，其代表了 4 种 alarm 类型！</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 这种 alarm 的时间计算方法为 System.currentTimeMillis()，不包括休眠时间！</span></span><br><span class="line"><span class="comment">// 该 alarm 触发会唤醒设备！</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="keyword">int</span> RTC_WAKEUP = <span class="number">0</span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 这种 alarm 的时间计算方法为 System.currentTimeMillis()，不包括休眠时间！</span></span><br><span class="line"><span class="comment">// 这种类型的 alarm 不会唤醒设备，如果其在设备休眠时候触发，直到设备被唤醒后，才被被分发出去！</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="keyword">int</span> RTC = <span class="number">1</span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 这种 alarm 的时间计算方法为 SystemClock.elapsedRealtime()，包括休眠时间！</span></span><br><span class="line"><span class="comment">// 这种类型的 alarm 触发时会唤醒设备；</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="keyword">int</span> ELAPSED_REALTIME_WAKEUP = <span class="number">2</span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 这种 alarm 的时间计算方法为 SystemClock.elapsedRealtime()，包括休眠时间！</span></span><br><span class="line"><span class="comment">// 这种类型的 alarm 不会唤醒设备，如果其在设备休眠时候触发，直到设备下次被唤醒后，才被被分发出去！</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="keyword">int</span> ELAPSED_REALTIME = <span class="number">3</span>;</span><br></pre></td></tr></table></figure>
<p>2、和 debug 相关的 alarm，这里不关注！</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">static</span> <span class="keyword">final</span> String TAG = <span class="string">"AlarmManager"</span>;</span><br><span class="line"><span class="keyword">static</span> <span class="keyword">final</span> <span class="keyword">boolean</span> localLOGV = <span class="keyword">false</span>;</span><br><span class="line"><span class="keyword">static</span> <span class="keyword">final</span> <span class="keyword">boolean</span> DEBUG_BATCH = localLOGV || <span class="keyword">false</span>;</span><br><span class="line"><span class="keyword">static</span> <span class="keyword">final</span> <span class="keyword">boolean</span> DEBUG_VALIDATE = localLOGV || <span class="keyword">false</span>;</span><br><span class="line"><span class="keyword">static</span> <span class="keyword">final</span> <span class="keyword">boolean</span> DEBUG_ALARM_CLOCK = localLOGV || <span class="keyword">false</span>;</span><br><span class="line"><span class="keyword">static</span> <span class="keyword">final</span> <span class="keyword">boolean</span> DEBUG_LISTENER_CALLBACK = localLOGV || <span class="keyword">false</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">final</span> LocalLog mLog = <span class="keyword">new</span> LocalLog(TAG);</span><br><span class="line"></span><br><span class="line"><span class="keyword">boolean</span> mLastWakeLockUnimportantForLogging;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 用于 dump wake up 状态信息！</span></span><br><span class="line"><span class="keyword">static</span> <span class="keyword">final</span> <span class="keyword">boolean</span> WAKEUP_STATS = <span class="keyword">false</span>;</span><br></pre></td></tr></table></figure>
<p>3、广播以及关闭广播接受者</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 后台广播，用于分发 alarm！</span></span><br><span class="line"><span class="keyword">private</span> <span class="keyword">final</span> Intent mBackgroundIntent</span><br><span class="line">        = <span class="keyword">new</span> Intent().addFlags(Intent.FLAG_FROM_BACKGROUND);</span><br><span class="line">        </span><br><span class="line"><span class="comment">// 下一个 alarm 时间发生改变的广播！</span></span><br><span class="line"><span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> Intent NEXT_ALARM_CLOCK_CHANGED_INTENT =</span><br><span class="line">        <span class="keyword">new</span> Intent(AlarmManager.ACTION_NEXT_ALARM_CLOCK_CHANGED)</span><br><span class="line">                .addFlags(Intent.FLAG_RECEIVER_REPLACE_PENDING);</span><br><span class="line">                </span><br><span class="line"><span class="comment">// 用于监听时间改变和日期改变的广播！</span></span><br><span class="line">ClockReceiver mClockReceiver;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 用于监听熄屏亮屏广播</span></span><br><span class="line">InteractiveStateReceiver mInteractiveStateReceiver;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 用于监听 package 相关的广播！</span></span><br><span class="line"><span class="keyword">private</span> UninstallReceiver mUninstallReceiver;</span><br><span class="line"></span><br><span class="line">PendingIntent mTimeTickSender; <span class="comment">// 时间改变的广播；</span></span><br><span class="line">PendingIntent mDateChangeSender; <span class="comment">// 日期改变的广播；</span></span><br></pre></td></tr></table></figure>
<p>4、时间相关</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">private</span> <span class="keyword">long</span> mNextWakeup; <span class="comment">// 下一个包含 wakeup 的 batch 的开始时间 </span></span><br><span class="line"><span class="keyword">private</span> <span class="keyword">long</span> mNextNonWakeup; <span class="comment">// 下一个包含 no wake up 的 batch 的开始时间  </span></span><br><span class="line"><span class="keyword">private</span> <span class="keyword">long</span> mLastWakeupSet;</span><br><span class="line"><span class="keyword">private</span> <span class="keyword">long</span> mLastWakeup;</span><br><span class="line"></span><br><span class="line"><span class="keyword">boolean</span> mInteractive = <span class="keyword">true</span>; <span class="comment">// 熄屏亮屏状态，亮屏为 true</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">long</span> mNonInteractiveStartTime; <span class="comment">// 熄灭屏幕的开始时间；</span></span><br><span class="line"><span class="keyword">long</span> mNonInteractiveTime; <span class="comment">// 熄灭屏幕的最长时间间隔；</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">long</span> mLastAlarmDeliveryTime; <span class="comment">// 上一个 alarm 的分发时间！</span></span><br><span class="line"><span class="keyword">long</span> mStartCurrentDelayTime; <span class="comment">// 需要延迟执行的非 wake up 类型的 alarm 开始延迟的时间！</span></span><br><span class="line"><span class="keyword">long</span> mNextNonWakeupDeliveryTime; <span class="comment">// 下一次非 wake up 类型的 alarm 分发时间！</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">long</span> mLastTimeChangeClockTime; <span class="comment">// 上一次时间发生改变的时间点，取值为 System.currentTimeMillis()；</span></span><br><span class="line"><span class="keyword">long</span> mLastTimeChangeRealtime; <span class="comment">// 上一次时间发生改变的时间点，取值为 SystemClock.elapsedRealtime()；</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">long</span> mAllowWhileIdleMinTime; <span class="comment">// 可以开始执行 flag 为 ALLOW_WHILE_IDLE 的 alarm 的最小时间间隔！</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">long</span> mTotalDelayTime = <span class="number">0</span>;</span><br><span class="line"><span class="keyword">long</span> mMaxDelayTime = <span class="number">0</span>; <span class="comment">//</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">int</span> mNumTimeChanged; <span class="comment">// 时间改变的次数！</span></span><br><span class="line"><span class="keyword">int</span> mNumDelayedAlarms = <span class="number">0</span>;</span><br></pre></td></tr></table></figure>
<p>5、集合<br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 延迟执行的 no wake up 类型的 alarm 列表！</span></span><br><span class="line">ArrayList&lt;Alarm&gt; mPendingNonWakeupAlarms = <span class="keyword">new</span> ArrayList&lt;&gt;();</span><br><span class="line"></span><br><span class="line"><span class="comment">// 正在执行中的 alarm 列表！</span></span><br><span class="line">ArrayList&lt;InFlight&gt; mInFlight = <span class="keyword">new</span> ArrayList&lt;&gt;();</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * For each uid, this is the last time we dispatched an "allow while idle" alarm,</span></span><br><span class="line"><span class="comment"> * used to determine the earliest we can dispatch the next such alarm.</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">final</span> SparseLongArray mLastAllowWhileIdleDispatch = <span class="keyword">new</span> SparseLongArray();</span><br><span class="line"></span><br><span class="line"><span class="keyword">final</span> ArrayList&lt;IdleDispatchEntry&gt; mAllowWhileIdleDispatches = <span class="keyword">new</span> ArrayList();</span><br><span class="line"></span><br><span class="line"><span class="keyword">private</span> <span class="keyword">final</span> SparseArray&lt;AlarmManager.AlarmClockInfo&gt; mNextAlarmClockForUser =</span><br><span class="line">        <span class="keyword">new</span> SparseArray&lt;&gt;();</span><br><span class="line">        </span><br><span class="line"><span class="keyword">private</span> <span class="keyword">final</span> SparseArray&lt;AlarmManager.AlarmClockInfo&gt; mTmpSparseAlarmClockArray =</span><br><span class="line">        <span class="keyword">new</span> SparseArray&lt;&gt;();</span><br><span class="line">        </span><br><span class="line"><span class="keyword">private</span> <span class="keyword">final</span> SparseBooleanArray mPendingSendNextAlarmClockChangedForUser =</span><br><span class="line">        <span class="keyword">new</span> SparseBooleanArray();</span><br><span class="line">        </span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * The current set of user whitelisted apps for device idle mode, meaning these are allowed</span></span><br><span class="line"><span class="comment"> * to freely schedule alarms.</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">int</span>[] mDeviceIdleUserWhitelist = <span class="keyword">new</span> <span class="keyword">int</span>[<span class="number">0</span>];</span><br><span class="line"></span><br><span class="line">ArrayList&lt;Alarm&gt; mPendingWhileIdleAlarms = <span class="keyword">new</span> ArrayList&lt;&gt;();</span><br><span class="line"></span><br><span class="line"><span class="keyword">final</span> SparseArray&lt;ArrayMap&lt;String, BroadcastStats&gt;&gt; mBroadcastStats</span><br><span class="line">        = <span class="keyword">new</span> SparseArray&lt;ArrayMap&lt;String, BroadcastStats&gt;&gt;();</span><br><span class="line">        </span><br><span class="line"><span class="comment">// May only use on mHandler's thread, locking not required.</span></span><br><span class="line"><span class="keyword">private</span> <span class="keyword">final</span> SparseArray&lt;AlarmManager.AlarmClockInfo&gt; mHandlerSparseAlarmClockArray =</span><br><span class="line">        <span class="keyword">new</span> SparseArray&lt;&gt;();</span><br><span class="line">        </span><br><span class="line"><span class="keyword">final</span> LinkedList&lt;WakeupEvent&gt; mRecentWakeups = <span class="keyword">new</span> LinkedList&lt;WakeupEvent&gt;();</span><br><span class="line"></span><br><span class="line"><span class="keyword">final</span> HashMap&lt;String, PriorityClass&gt; mPriorities = <span class="keyword">new</span> HashMap&lt;&gt;();</span><br><span class="line"></span><br><span class="line"><span class="comment">// // alarm批处理对象列表  </span></span><br><span class="line"><span class="keyword">final</span> ArrayList&lt;Batch&gt; mAlarmBatches = <span class="keyword">new</span> ArrayList&lt;&gt;();</span><br></pre></td></tr></table></figure></p>
<p>6、比较器</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 时间比较器！</span></span><br><span class="line"><span class="keyword">static</span> <span class="keyword">final</span> IncreasingTimeOrder sIncreasingTimeOrder = <span class="keyword">new</span> IncreasingTimeOrder();</span><br><span class="line"></span><br><span class="line"><span class="keyword">static</span> <span class="keyword">final</span> BatchTimeOrder sBatchOrder = <span class="keyword">new</span> BatchTimeOrder();</span><br><span class="line"></span><br><span class="line"><span class="keyword">final</span> Comparator&lt;Alarm&gt; mAlarmDispatchComparator = <span class="keyword">new</span> Comparator&lt;Alarm&gt;() &#123;</span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">int</span> <span class="title">compare</span><span class="params">(Alarm lhs, Alarm rhs)</span> </span>&#123;</span><br><span class="line">        <span class="comment">// priority class trumps everything.  TICK &lt; WAKEUP &lt; NORMAL</span></span><br><span class="line">        <span class="keyword">if</span> (lhs.priorityClass.priority &lt; rhs.priorityClass.priority) &#123;</span><br><span class="line">            <span class="keyword">return</span> -<span class="number">1</span>;</span><br><span class="line">        &#125; <span class="keyword">else</span> <span class="keyword">if</span> (lhs.priorityClass.priority &gt; rhs.priorityClass.priority) &#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="number">1</span>;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// within each class, sort by nominal delivery time</span></span><br><span class="line">        <span class="keyword">if</span> (lhs.whenElapsed &lt; rhs.whenElapsed) &#123;</span><br><span class="line">            <span class="keyword">return</span> -<span class="number">1</span>;</span><br><span class="line">        &#125; <span class="keyword">else</span> <span class="keyword">if</span> (lhs.whenElapsed &gt; rhs.whenElapsed) &#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="number">1</span>;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// same priority class + same target delivery time</span></span><br><span class="line">        <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">static</span> <span class="keyword">final</span> <span class="keyword">boolean</span> RECORD_ALARMS_IN_HISTORY = <span class="keyword">true</span>; <span class="comment">// 是否将 alarm 保存到历史信息中！</span></span><br><span class="line"><span class="keyword">static</span> <span class="keyword">final</span> <span class="keyword">boolean</span> RECORD_DEVICE_IDLE_ALARMS = <span class="keyword">false</span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 消息 id，AlarmHandler 处理！</span></span><br><span class="line"><span class="keyword">static</span> <span class="keyword">final</span> <span class="keyword">int</span> ALARM_EVENT = <span class="number">1</span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 系统属性用于获取时区信息，更新 kernel 的时区信息！</span></span><br><span class="line"><span class="keyword">static</span> <span class="keyword">final</span> String TIMEZONE_PROPERTY = <span class="string">"persist.sys.timezone"</span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">// appOps 管理对象！</span></span><br><span class="line">AppOpsManager mAppOps;</span><br><span class="line"><span class="comment">// doze 模式</span></span><br><span class="line">DeviceIdleController.LocalService mLocalDeviceIdleController;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 锁对象，访问 mConstants 的时候，必须持有锁！</span></span><br><span class="line"><span class="keyword">final</span> Object mLock = <span class="keyword">new</span> Object();</span><br><span class="line"></span><br><span class="line"><span class="comment">// alarm 驱动指针！</span></span><br><span class="line"><span class="keyword">long</span> mNativeData;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 用于标记当前正在分发处理的 alarm 个数！</span></span><br><span class="line"><span class="keyword">int</span> mBroadcastRefCount = <span class="number">0</span>;</span><br><span class="line"></span><br><span class="line">PowerManager.WakeLock mWakeLock;</span><br><span class="line"></span><br><span class="line"><span class="keyword">final</span> AlarmHandler mHandler = <span class="keyword">new</span> AlarmHandler();</span><br><span class="line"></span><br><span class="line"><span class="comment">// alarm 分发监控器</span></span><br><span class="line"><span class="keyword">final</span> DeliveryTracker mDeliveryTracker = <span class="keyword">new</span> DeliveryTracker();</span><br><span class="line"></span><br><span class="line">Random mRandom;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * Broadcast options to use for FLAG_ALLOW_WHILE_IDLE.</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line">Bundle mIdleOptions;</span><br><span class="line"></span><br><span class="line"><span class="keyword">private</span> <span class="keyword">boolean</span> mNextAlarmClockMayChange; <span class="comment">// 下一个 alarm 的触发时间是否会改变！</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">final</span> Constants mConstants; <span class="comment">// 常量类！</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// Alarm delivery ordering bookkeeping</span></span><br><span class="line"><span class="keyword">static</span> <span class="keyword">final</span> <span class="keyword">int</span> PRIO_TICK = <span class="number">0</span>;</span><br><span class="line"><span class="keyword">static</span> <span class="keyword">final</span> <span class="keyword">int</span> PRIO_WAKEUP = <span class="number">1</span>;</span><br><span class="line"><span class="keyword">static</span> <span class="keyword">final</span> <span class="keyword">int</span> PRIO_NORMAL = <span class="number">2</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">int</span> mCurrentSeq = <span class="number">0</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">final</span> <span class="keyword">long</span> RECENT_WAKEUP_PERIOD = <span class="number">1000L</span> * <span class="number">60</span> * <span class="number">60</span> * <span class="number">24</span>; <span class="comment">// one day</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// minimum recurrence period or alarm futurity for us to be able to fuzz it</span></span><br><span class="line"><span class="keyword">static</span> <span class="keyword">final</span> <span class="keyword">long</span> MIN_FUZZABLE_INTERVAL = <span class="number">10000</span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">// set to null if in idle mode; while in this mode, any alarms we don't want</span></span><br><span class="line"><span class="comment">// to run during this time are placed in mPendingWhileIdleAlarms</span></span><br><span class="line">Alarm mPendingIdleUntil = <span class="keyword">null</span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 下一个请求退出 idle 模式的 alarm  </span></span><br><span class="line">Alarm mNextWakeFromIdle = <span class="keyword">null</span>;</span><br></pre></td></tr></table></figure>
<p>以上的只是对主要的变量进行了解释和说明，其具体的作用，我们后续在分析 alarm manager 机制的时候会分析！</p>
</div><hr></div><div class="recent-post-item article-container"><a class="article-title" href="/2017/09/10/AppOps 第 3 篇 - AppOps 权限相关方法/">AppOps 第 3 篇 - AppOps 权限相关方法</a><time class="post-meta__date"><i class="fa fa-calendar" aria-hidden="true"></i> 2017-09-10</time><span class="article-meta"><span class="article-meta__separator">|</span><i class="fa fa-inbox article-meta__icon" aria-hidden="true"></i><a class="article-meta__categories" href="/categories/AndroidFramework源码分析/">AndroidFramework源码分析</a><i class="fa fa-angle-right" aria-hidden="true"></i><i class="fa fa-inbox article-meta__icon" aria-hidden="true"></i><a class="article-meta__categories" href="/categories/AndroidFramework源码分析/AppOps应用操作管理/">AppOps应用操作管理</a></span><span class="article-meta tags"><span class="article-meta__separator">|</span><i class="fa fa-tag article-meta__icon" aria-hidden="true"></i><a class="article-meta__tags" href="/tags/AppOps应用操作管理/">AppOps应用操作管理</a></span><div class="content"><p>本文基于 Android 7.1.1 源码分析，如有错误，欢迎指正，谢谢！</p>
<p>[toc]</p>
<h1 id="0-综述"><a href="#0-综述" class="headerlink" title="0 综述"></a>0 综述</h1><p>前面分析了 AppOpsManager 中的一些接口，最终都会调用 AppOpservice 中的相应接口，下面我们来看下 AppOpservice 中的权限操作！</p>
<p>涉及的类如下：</p>
<ul>
<li>Settings 上层应用入口：</li>
</ul>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">packages/apps/Settings/src/com/android/settings/applications/AppOpsCategory.java</span><br><span class="line">packages/apps/Settings/src/com/android/settings/applications/AppOpsDetails.java</span><br><span class="line">packages/apps/Settings/src/com/android/settings/applications/AppOpsState.java</span><br><span class="line">packages/apps/Settings/src/com/android/settings/applications/AppOpsSummary.java</span><br></pre></td></tr></table></figure>
<ul>
<li>appops 的可执行文件：</li>
</ul>
<p>位于 /system/bin/ 目录下！</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">frameworks/native/libs/binder/AppOpsManager.cpp</span><br><span class="line">frameworks/native/include/binder/AppOpsManager.h</span><br></pre></td></tr></table></figure>
<ul>
<li>框架层 AppOps 核心实现类：</li>
</ul>
<p>AppOpsService 是功能具体实现；AppOpsManager 是 AppOpsService 提供给其他进程的一个入口； AppOpsPolicy大概意思是，系统出厂时预制的系统 App(System-app)和用户 app（User-app）的一些默认的权限！<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">frameworks/base/services/core/java/com/android/server/AppOpsService.java</span><br><span class="line">frameworks/base/core/java/android/app/AppOpsManager.java</span><br></pre></td></tr></table></figure></p>
<p>这里我们重点关注核心服务 AppOpsService  的实现，下面分析下一些核心的方法接口！</p>
<h1 id="1-AppOpsService-checkOperation-检查操作权限"><a href="#1-AppOpsService-checkOperation-检查操作权限" class="headerlink" title="1 AppOpsService.checkOperation - 检查操作权限"></a>1 AppOpsService.checkOperation - 检查操作权限</h1><p>checkOperation 用于检查指定 package 是否有权限执行指定操作！</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">int</span> <span class="title">checkOperation</span><span class="params">(<span class="keyword">int</span> code, <span class="keyword">int</span> uid, String packageName)</span> </span>&#123;</span><br><span class="line">    <span class="comment">//【×1.1】校验 uid 是否有 UPDATE_APP_OPS_STATS 权限；</span></span><br><span class="line">    verifyIncomingUid(uid);</span><br><span class="line">    <span class="comment">//【×1.2】校验 op code 是否正确！</span></span><br><span class="line">    verifyIncomingOp(code);</span><br><span class="line">    <span class="comment">//【×1.3】处理包名！</span></span><br><span class="line">    String resolvedPackageName = resolvePackageName(uid, packageName);</span><br><span class="line">    <span class="keyword">if</span> (resolvedPackageName == <span class="keyword">null</span>) &#123;</span><br><span class="line">        <span class="keyword">return</span> AppOpsManager.MODE_IGNORED; <span class="comment">// 如果 package 为 null，返回 MODE_IGNORED！</span></span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">synchronized</span> (<span class="keyword">this</span>) &#123;</span><br><span class="line">        <span class="comment">//【×1.4】判断该 operation 是否收到用户限制，如果有，返回 MODE_IGNORED！</span></span><br><span class="line">        <span class="keyword">if</span> (isOpRestrictedLocked(uid, code, resolvedPackageName)) &#123;</span><br><span class="line">            <span class="keyword">return</span> AppOpsManager.MODE_IGNORED;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">//【2】获得决定 code 指定 op 的模式的 op，调用 AppOpsManager.opToSwitch 方法！</span></span><br><span class="line">        code = AppOpsManager.opToSwitch(code);</span><br><span class="line"></span><br><span class="line">        <span class="comment">//【×1.5】判断该 uid 是否允许执行该操作，如果不允许，返回已有的模式状态；</span></span><br><span class="line">        UidState uidState = getUidStateLocked(uid, <span class="keyword">false</span>);</span><br><span class="line">        <span class="keyword">if</span> (uidState != <span class="keyword">null</span> &amp;&amp; uidState.opModes != <span class="keyword">null</span>) &#123;</span><br><span class="line">            <span class="keyword">final</span> <span class="keyword">int</span> uidMode = uidState.opModes.get(code);</span><br><span class="line">            <span class="keyword">if</span> (uidMode != AppOpsManager.MODE_ALLOWED) &#123;</span><br><span class="line">                <span class="keyword">return</span> uidMode;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">//【×1.6】如果该 uid 允许执行该操作，那就进一步判断该 package 是否允许执行该操作，</span></span><br><span class="line">        <span class="comment">// 如果没有定义，返回默认状态；否则返回已有的模式状态；</span></span><br><span class="line">        Op op = getOpLocked(code, uid, resolvedPackageName, <span class="keyword">false</span>);</span><br><span class="line">        <span class="keyword">if</span> (op == <span class="keyword">null</span>) &#123;</span><br><span class="line">            <span class="keyword">return</span> AppOpsManager.opToDefaultMode(code);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> op.mode;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>其实我们知道，该方法返回值有如下几种：MODE_ALLOWED，MODE_IGNORED，MODE_ERRORED 和 MODE_DEFAULT！</p>
<h2 id="1-1-verifyIncomingUid"><a href="#1-1-verifyIncomingUid" class="headerlink" title="1.1 verifyIncomingUid"></a>1.1 verifyIncomingUid</h2><p>校验 uid 是否具有 android.Manifest.permission.UPDATE_APP_OPS_STATS 权限！</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">verifyIncomingUid</span><span class="params">(<span class="keyword">int</span> uid)</span> </span>&#123;</span><br><span class="line">    <span class="comment">//【1】如果是 uid 自身调用，不需要检验！</span></span><br><span class="line">    <span class="keyword">if</span> (uid == Binder.getCallingUid()) &#123;</span><br><span class="line">        <span class="keyword">return</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">//【2】如果是当前进程自己调用的，najiu</span></span><br><span class="line">    <span class="keyword">if</span> (Binder.getCallingPid() == Process.myPid()) &#123;</span><br><span class="line">        <span class="keyword">return</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    mContext.enforcePermission(android.Manifest.permission.UPDATE_APP_OPS_STATS,</span><br><span class="line">            Binder.getCallingPid(), Binder.getCallingUid(), <span class="keyword">null</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>如果 uid 没有 android.Manifest.permission.UPDATE_APP_OPS_STATS 权限，抛出异常！</p>
<h2 id="1-2-verifyIncomingOp"><a href="#1-2-verifyIncomingOp" class="headerlink" title="1.2 verifyIncomingOp"></a>1.2 verifyIncomingOp</h2><p>校验 op 是否正确！<br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">verifyIncomingOp</span><span class="params">(<span class="keyword">int</span> op)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">if</span> (op &gt;= <span class="number">0</span> &amp;&amp; op &lt; AppOpsManager._NUM_OP) &#123;</span><br><span class="line">        <span class="keyword">return</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">throw</span> <span class="keyword">new</span> IllegalArgumentException(<span class="string">"Bad operation #"</span> + op);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>如果 op 不在 [0， AppOpsManager._NUM_OP) 范围内，抛出异常；</p>
<h2 id="1-3-resolvePackageName"><a href="#1-3-resolvePackageName" class="headerlink" title="1.3 resolvePackageName"></a>1.3 resolvePackageName</h2><p>处理一些特殊 uid 所属包名！</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">static</span> String <span class="title">resolvePackageName</span><span class="params">(<span class="keyword">int</span> uid, String packageName)</span>  </span>&#123;</span><br><span class="line">    <span class="keyword">if</span> (uid == <span class="number">0</span>) &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="string">"root"</span>;</span><br><span class="line">    &#125; <span class="keyword">else</span> <span class="keyword">if</span> (uid == Process.SHELL_UID) &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="string">"com.android.shell"</span>;</span><br><span class="line">    &#125; <span class="keyword">else</span> <span class="keyword">if</span> (uid == Process.SYSTEM_UID &amp;&amp; packageName == <span class="keyword">null</span>) &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="string">"android"</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> packageName;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>不多说！</p>
<h2 id="1-4-isOpRestrictedLocked"><a href="#1-4-isOpRestrictedLocked" class="headerlink" title="1.4 isOpRestrictedLocked"></a>1.4 isOpRestrictedLocked</h2><p>判断该操作是否被用户限制！<br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">boolean</span> <span class="title">isOpRestrictedLocked</span><span class="params">(<span class="keyword">int</span> uid, <span class="keyword">int</span> code, String packageName)</span> </span>&#123;</span><br><span class="line">    <span class="comment">//【1】获得该 uid 所属的 userId！</span></span><br><span class="line">    <span class="keyword">int</span> userHandle = UserHandle.getUserId(uid);</span><br><span class="line">    <span class="keyword">final</span> <span class="keyword">int</span> restrictionSetCount = mOpUserRestrictions.size();</span><br><span class="line"></span><br><span class="line">    <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; restrictionSetCount; i++) &#123;</span><br><span class="line">        <span class="comment">//【2】遍历每一个 ClientRestrictionState，检查该 op 是否在 uid 所在的用户下被限制，同时也检查</span></span><br><span class="line">        <span class="comment">// 属于该 uid 的 package 是否在白名单中，如果在白名单中，那就不受限制！</span></span><br><span class="line">        ClientRestrictionState restrictionState = mOpUserRestrictions.valueAt(i);</span><br><span class="line">        <span class="comment">//【×1.4.1】校验该 package 的 op 在指定的 userid 下是否收到限制，如果有返回 true！</span></span><br><span class="line">        <span class="keyword">if</span> (restrictionState.hasRestriction(code, packageName, userHandle)) &#123;</span><br><span class="line">            <span class="comment">//【3】如果确实在该 userId 下受到限制，那就在判断下是否允许 system/system ui 绕过限制！</span></span><br><span class="line">            <span class="keyword">if</span> (AppOpsManager.opAllowSystemBypassRestriction(code)) &#123;</span><br><span class="line">                <span class="keyword">synchronized</span> (<span class="keyword">this</span>) &#123;</span><br><span class="line">                    <span class="comment">//【*1.4.2】获得该 package 的所有 op 操作</span></span><br><span class="line">                    Ops ops = getOpsRawLocked(uid, packageName, <span class="keyword">true</span>);</span><br><span class="line">                    <span class="keyword">if</span> ((ops != <span class="keyword">null</span>) &amp;&amp; ops.isPrivileged) &#123;</span><br><span class="line">                        <span class="comment">//【3.1】如果 ops.isPrivileged 为 true，说明该 package 是特权应用，要绕过用户限制！</span></span><br><span class="line">                        <span class="keyword">return</span> <span class="keyword">false</span>;</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="comment">//【3.2】受到限制但是不允许绕过！</span></span><br><span class="line">            <span class="keyword">return</span> <span class="keyword">true</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">false</span>; <span class="comment">// 不受限制返回 false；</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>AppOpsService 用一个 ArrayMap 保存所有的用户限制状态信息！<br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">private</span> <span class="keyword">final</span> ArrayMap&lt;IBinder, ClientRestrictionState&gt; mOpUserRestrictions = <span class="keyword">new</span> ArrayMap&lt;&gt;();</span><br></pre></td></tr></table></figure></p>
<h3 id="1-4-1-ClientRestrictionState-hasRestriction"><a href="#1-4-1-ClientRestrictionState-hasRestriction" class="headerlink" title="1.4.1 ClientRestrictionState.hasRestriction"></a>1.4.1 ClientRestrictionState.hasRestriction</h3><p>该方法用于判断指定 package 的指定 op 是否在 userId 下收到限制！<br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">boolean</span> <span class="title">hasRestriction</span><span class="params">(<span class="keyword">int</span> restriction, String packageName, <span class="keyword">int</span> userId)</span> </span>&#123;</span><br><span class="line">    <span class="comment">//【1】如果 perUserRestrictions 为 null，不受限制！</span></span><br><span class="line">    <span class="keyword">if</span> (perUserRestrictions == <span class="keyword">null</span>) &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">false</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">//【2】如果在 userId 下没有限制信息，不受限制！</span></span><br><span class="line">    <span class="keyword">boolean</span>[] restrictions = perUserRestrictions.get(userId);</span><br><span class="line">    <span class="keyword">if</span> (restrictions == <span class="keyword">null</span>) &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">false</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">//【3】如果在 userId 下，restrictions[restriction] 为 false，不受限制！</span></span><br><span class="line">    <span class="keyword">if</span> (!restrictions[restriction]) &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">false</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">//【4】如果在 userId 下，restrictions[restriction] 为 true，说明在该用户下，该 op 是受限制的</span></span><br><span class="line">    <span class="comment">// 那就要看下 package 是否在白名单中，如果没有白名单，那么就是首先的！</span></span><br><span class="line">    <span class="keyword">if</span> (perUserExcludedPackages == <span class="keyword">null</span>) &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">true</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    String[] perUserExclusions = perUserExcludedPackages.get(userId);</span><br><span class="line">    <span class="keyword">if</span> (perUserExclusions == <span class="keyword">null</span>) &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">true</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">//【5】如果该 package 是在白名单中，那么就是不受限的，返回 false；</span></span><br><span class="line">    <span class="keyword">return</span> !ArrayUtils.contains(perUserExclusions, packageName);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>方法很简单，不多说了！</p>
<h3 id="1-4-2-getOpsRawLocked"><a href="#1-4-2-getOpsRawLocked" class="headerlink" title="1.4.2 getOpsRawLocked"></a>1.4.2 getOpsRawLocked</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">private</span> Ops <span class="title">getOpsRawLocked</span><span class="params">(<span class="keyword">int</span> uid, String packageName, <span class="keyword">boolean</span> edit)</span> </span>&#123;</span><br><span class="line">    <span class="comment">//【*1.5】获得 uid 的 UidState 对象！</span></span><br><span class="line">    UidState uidState = getUidStateLocked(uid, edit);</span><br><span class="line">    <span class="keyword">if</span> (uidState == <span class="keyword">null</span>) &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">null</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (uidState.pkgOps == <span class="keyword">null</span>) &#123;</span><br><span class="line">        <span class="keyword">if</span> (!edit) &#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="keyword">null</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        uidState.pkgOps = <span class="keyword">new</span> ArrayMap&lt;&gt;();</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">//【1】获得 packageName 指定的应用的 op 限制！</span></span><br><span class="line">    Ops ops = uidState.pkgOps.get(packageName);</span><br><span class="line">    <span class="keyword">if</span> (ops == <span class="keyword">null</span>) &#123;</span><br><span class="line">        <span class="keyword">if</span> (!edit) &#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="keyword">null</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">boolean</span> isPrivileged = <span class="keyword">false</span>;</span><br><span class="line">        <span class="comment">//【2】下面会判断 package 和 uid 的对应关系是否有效！</span></span><br><span class="line">        <span class="keyword">if</span> (uid != <span class="number">0</span>) &#123;</span><br><span class="line">            <span class="keyword">final</span> <span class="keyword">long</span> ident = Binder.clearCallingIdentity();</span><br><span class="line">            <span class="keyword">try</span> &#123;</span><br><span class="line">                <span class="keyword">int</span> pkgUid = -<span class="number">1</span>;</span><br><span class="line">                <span class="keyword">try</span> &#123;</span><br><span class="line">                    <span class="comment">//【2.1】获得 packageName 对应的应用程序信息 ApplicationInfo！</span></span><br><span class="line">                    ApplicationInfo appInfo = ActivityThread.getPackageManager()</span><br><span class="line">                            .getApplicationInfo(packageName,</span><br><span class="line">                                    PackageManager.MATCH_DEBUG_TRIAGED_MISSING,</span><br><span class="line">                                    UserHandle.getUserId(uid));</span><br><span class="line">                    <span class="keyword">if</span> (appInfo != <span class="keyword">null</span>) &#123;</span><br><span class="line">                        <span class="comment">//【2.2】获得 package 的 uid，判断其是否是特权应用；</span></span><br><span class="line">                        pkgUid = appInfo.uid;</span><br><span class="line">                        isPrivileged = (appInfo.privateFlags</span><br><span class="line">                                &amp; ApplicationInfo.PRIVATE_FLAG_PRIVILEGED) != <span class="number">0</span>;</span><br><span class="line">                    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                        <span class="comment">//【2.3】针对一些特殊没有安装信息的 package，这里做一个处理！</span></span><br><span class="line">                        <span class="keyword">if</span> (<span class="string">"media"</span>.equals(packageName)) &#123;</span><br><span class="line">                            pkgUid = Process.MEDIA_UID;</span><br><span class="line">                            isPrivileged = <span class="keyword">false</span>;</span><br><span class="line">                        &#125; <span class="keyword">else</span> <span class="keyword">if</span> (<span class="string">"audioserver"</span>.equals(packageName)) &#123;</span><br><span class="line">                            pkgUid = Process.AUDIOSERVER_UID;</span><br><span class="line">                            isPrivileged = <span class="keyword">false</span>;</span><br><span class="line">                        &#125; <span class="keyword">else</span> <span class="keyword">if</span> (<span class="string">"cameraserver"</span>.equals(packageName)) &#123;</span><br><span class="line">                            pkgUid = Process.CAMERASERVER_UID;</span><br><span class="line">                            isPrivileged = <span class="keyword">false</span>;</span><br><span class="line">                        &#125;</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125; <span class="keyword">catch</span> (RemoteException e) &#123;</span><br><span class="line">                    Slog.w(TAG, <span class="string">"Could not contact PackageManager"</span>, e);</span><br><span class="line">                &#125;</span><br><span class="line">                <span class="comment">//【2.4】判读 package 和 uid 的对应关系是否有效，如果 package 现在的 uid 不是 AppOps</span></span><br><span class="line">                <span class="comment">// 中记录的 uid，那么输出异常，并返回；</span></span><br><span class="line">                <span class="keyword">if</span> (pkgUid != uid) &#123;</span><br><span class="line">                    RuntimeException ex = <span class="keyword">new</span> RuntimeException(<span class="string">"here"</span>);</span><br><span class="line">                    ex.fillInStackTrace();</span><br><span class="line">                    Slog.w(TAG, <span class="string">"Bad call: specified package "</span> + packageName</span><br><span class="line">                            + <span class="string">" under uid "</span> + uid + <span class="string">" but it is really "</span> + pkgUid, ex);</span><br><span class="line">                    <span class="keyword">return</span> <span class="keyword">null</span>;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">                Binder.restoreCallingIdentity(ident);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">//【3】对于 edit 为 true 的情况，会做初始化操作！！</span></span><br><span class="line">        ops = <span class="keyword">new</span> Ops(packageName, uidState, isPrivileged);</span><br><span class="line">        uidState.pkgOps.put(packageName, ops);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> ops;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>不多说了！</p>
<h2 id="1-5-getUidStateLocked"><a href="#1-5-getUidStateLocked" class="headerlink" title="1.5 getUidStateLocked"></a>1.5 getUidStateLocked</h2><p>获得 uid 的 op 管理信息：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">private</span> UidState <span class="title">getUidStateLocked</span><span class="params">(<span class="keyword">int</span> uid, <span class="keyword">boolean</span> edit)</span> </span>&#123;</span><br><span class="line">    UidState uidState = mUidStates.get(uid);</span><br><span class="line">    <span class="keyword">if</span> (uidState == <span class="keyword">null</span>) &#123;</span><br><span class="line">        <span class="keyword">if</span> (!edit) &#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="keyword">null</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        uidState = <span class="keyword">new</span> UidState(uid);</span><br><span class="line">        <span class="comment">//【1】从 mUidStates 获取！</span></span><br><span class="line">        mUidStates.put(uid, uidState);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> uidState;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>不多说！</p>
<h2 id="1-6-getOpLocked"><a href="#1-6-getOpLocked" class="headerlink" title="1.6 getOpLocked"></a>1.6 getOpLocked</h2><p>getOpLocked 用于获得指定 package 的特定 op 对应的 Op 对象，该 Op 对象封装了操作的模式等相关信息，参数 boolean edit 这里传入的是 true！</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">private</span> Op <span class="title">getOpLocked</span><span class="params">(<span class="keyword">int</span> code, <span class="keyword">int</span> uid, String packageName, <span class="keyword">boolean</span> edit)</span> </span>&#123;</span><br><span class="line">   <span class="comment">//【1】获得该 package 的所有的 op 信息，封装在 Ops 对象中！</span></span><br><span class="line">    Ops ops = getOpsRawLocked(uid, packageName, edit);</span><br><span class="line">    <span class="keyword">if</span> (ops == <span class="keyword">null</span>) &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">null</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">//【2】返回指定 op 对应的信息！</span></span><br><span class="line">    <span class="keyword">return</span> getOpLocked(ops, code, edit);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>调用了三参数函数 getOpLocked！<br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">private</span> Op <span class="title">getOpLocked</span><span class="params">(Ops ops, <span class="keyword">int</span> code, <span class="keyword">boolean</span> edit)</span> </span>&#123;</span><br><span class="line">    <span class="comment">//【1】获得 code 对应的 Op 对象！</span></span><br><span class="line">    Op op = ops.get(code);</span><br><span class="line">    <span class="keyword">if</span> (op == <span class="keyword">null</span>) &#123;</span><br><span class="line">        <span class="keyword">if</span> (!edit) &#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="keyword">null</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">// 如果没有，由于 edit 为 true，这里会默认初始化创建一个 Op 对象！</span></span><br><span class="line">        op = <span class="keyword">new</span> Op(ops.uidState.uid, ops.packageName, code);</span><br><span class="line">        ops.put(code, op);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span> (edit) &#123; <span class="comment">// 同时更新本地持久化文件！</span></span><br><span class="line">        scheduleWriteLocked();</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> op; <span class="comment">// 返回！</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<h1 id="2-AppOpsService-noteOperation-检查操作权限"><a href="#2-AppOpsService-noteOperation-检查操作权限" class="headerlink" title="2 AppOpsService.noteOperation - 检查操作权限"></a>2 AppOpsService.noteOperation - 检查操作权限</h1><p>检查指定的 package 是否允许执行 op 对应的操作，同时会更新 op 相关的信息！</p>
<p>noteOperation 用于短期权限的检查。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">int</span> <span class="title">noteOperation</span><span class="params">(<span class="keyword">int</span> code, <span class="keyword">int</span> uid, String packageName)</span> </span>&#123;</span><br><span class="line">    verifyIncomingUid(uid);</span><br><span class="line">    verifyIncomingOp(code);</span><br><span class="line">    String resolvedPackageName = resolvePackageName(uid, packageName);</span><br><span class="line">    <span class="keyword">if</span> (resolvedPackageName == <span class="keyword">null</span>) &#123;</span><br><span class="line">        <span class="keyword">return</span> AppOpsManager.MODE_IGNORED;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">//【*2.1】调用了 5 参函数！</span></span><br><span class="line">    <span class="keyword">return</span> noteOperationUnchecked(code, uid, resolvedPackageName, <span class="number">0</span>, <span class="keyword">null</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>继续分析：</p>
<h2 id="2-1-noteOperationUnchecked"><a href="#2-1-noteOperationUnchecked" class="headerlink" title="2.1 noteOperationUnchecked"></a>2.1 noteOperationUnchecked</h2><p>我们去看看 5 参函数：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">int</span> <span class="title">noteOperationUnchecked</span><span class="params">(<span class="keyword">int</span> code, <span class="keyword">int</span> uid, String packageName,</span></span></span><br><span class="line"><span class="function"><span class="params">        <span class="keyword">int</span> proxyUid, String proxyPackageName)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">synchronized</span> (<span class="keyword">this</span>) &#123;</span><br><span class="line">        <span class="comment">//【*1.4.2】获得该 package 的所有 Op 信息！</span></span><br><span class="line">        Ops ops = getOpsRawLocked(uid, packageName, <span class="keyword">true</span>);</span><br><span class="line">        <span class="keyword">if</span> (ops == <span class="keyword">null</span>) &#123;</span><br><span class="line">            <span class="keyword">if</span> (DEBUG) Log.d(TAG, <span class="string">"noteOperation: no op for code "</span> + code + <span class="string">" uid "</span> + uid</span><br><span class="line">                    + <span class="string">" package "</span> + packageName);</span><br><span class="line">            <span class="keyword">return</span> AppOpsManager.MODE_ERRORED;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">//【*1.5】获得 code 指定的 Op 信息！</span></span><br><span class="line">        Op op = getOpLocked(ops, code, <span class="keyword">true</span>);</span><br><span class="line"></span><br><span class="line">        <span class="comment">//【*1.4】如果该 op 在 uid 所在的用户下受限，返回 MODE_IGNORED ！</span></span><br><span class="line">        <span class="keyword">if</span> (isOpRestrictedLocked(uid, code, packageName)) &#123;</span><br><span class="line">            <span class="keyword">return</span> AppOpsManager.MODE_IGNORED;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">if</span> (op.duration == -<span class="number">1</span>) &#123;</span><br><span class="line">            Slog.w(TAG, <span class="string">"Noting op not finished: uid "</span> + uid + <span class="string">" pkg "</span> + packageName</span><br><span class="line">                    + <span class="string">" code "</span> + code + <span class="string">" time="</span> + op.time + <span class="string">" duration="</span> + op.duration);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        op.duration = <span class="number">0</span>;</span><br><span class="line"></span><br><span class="line">        <span class="comment">//【2】获得决定 code 指定 op 模式的 switchCode，其实是另外一个 op！</span></span><br><span class="line">        <span class="keyword">final</span> <span class="keyword">int</span> switchCode = AppOpsManager.opToSwitch(code);</span><br><span class="line">        <span class="comment">//【3】获得该 package 所属 uid 的 op 限制！</span></span><br><span class="line">        UidState uidState = ops.uidState;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (uidState.opModes != <span class="keyword">null</span> &amp;&amp; uidState.opModes.indexOfKey(switchCode) &gt;= <span class="number">0</span>) &#123;</span><br><span class="line">            <span class="comment">//【3.1】如果该 uid 有 switchCode，那么 uid 的 switchCode 模式优先级更高！</span></span><br><span class="line">            <span class="comment">// 如果 uid 不允许执行该操作，返回的是该 uid 的 switchCode 模式！</span></span><br><span class="line">            <span class="keyword">final</span> <span class="keyword">int</span> uidMode = uidState.opModes.get(switchCode);</span><br><span class="line">            <span class="keyword">if</span> (uidMode != AppOpsManager.MODE_ALLOWED) &#123;</span><br><span class="line">                <span class="keyword">if</span> (DEBUG) Log.d(TAG, <span class="string">"noteOperation: reject #"</span> + op.mode + <span class="string">" for code "</span></span><br><span class="line">                        + switchCode + <span class="string">" ("</span> + code + <span class="string">") uid "</span> + uid + <span class="string">" package "</span></span><br><span class="line">                        + packageName);</span><br><span class="line"></span><br><span class="line">                <span class="comment">//【3.1.1】uid 不被允许的执行该 switchCode 在指定的操作，</span></span><br><span class="line">                <span class="comment">// 那么更新 code 对应 op 的 rejectTime 值！</span></span><br><span class="line">                op.rejectTime = System.currentTimeMillis();</span><br><span class="line">                <span class="keyword">return</span> uidMode;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            <span class="comment">//【3.2】如果该 uid 没有该 switchCode，那就读取 package 的 switchCode 模式！</span></span><br><span class="line">            <span class="comment">//【×1.6】通过 getOpLocked 获得指定的 op 信息！</span></span><br><span class="line">            <span class="keyword">final</span> Op switchOp = switchCode != code ? getOpLocked(ops, switchCode, <span class="keyword">true</span>) : op;</span><br><span class="line">            <span class="keyword">if</span> (switchOp.mode != AppOpsManager.MODE_ALLOWED) &#123;</span><br><span class="line">                <span class="keyword">if</span> (DEBUG) Log.d(TAG, <span class="string">"noteOperation: reject #"</span> + op.mode + <span class="string">" for code "</span></span><br><span class="line">                        + switchCode + <span class="string">" ("</span> + code + <span class="string">") uid "</span> + uid + <span class="string">" package "</span></span><br><span class="line">                        + packageName);</span><br><span class="line">                <span class="comment">//【3.2.1】package 不被允许的执行该 switchCode 在指定的操作，</span></span><br><span class="line">                <span class="comment">// 那么更新 code 对应 op 的 rejectTime 值！</span></span><br><span class="line">                <span class="keyword">return</span> switchOp.mode;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (DEBUG) Log.d(TAG, <span class="string">"noteOperation: allowing code "</span> + code + <span class="string">" uid "</span> + uid</span><br><span class="line">                + <span class="string">" package "</span> + packageName);</span><br><span class="line"></span><br><span class="line">        <span class="comment">//【4】更新 code 对应的 op 的相关信息！</span></span><br><span class="line">        op.time = System.currentTimeMillis();</span><br><span class="line">        op.rejectTime = <span class="number">0</span>;</span><br><span class="line">        op.proxyUid = proxyUid;</span><br><span class="line">        op.proxyPackageName = proxyPackageName;</span><br><span class="line">        <span class="keyword">return</span> AppOpsManager.MODE_ALLOWED;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>方法很简单，不多说了！</p>
<h1 id="3-AppOpsService-setUidMode-设置-uid-的-op-模式"><a href="#3-AppOpsService-setUidMode-设置-uid-的-op-模式" class="headerlink" title="3 AppOpsService.setUidMode - 设置 uid 的 op 模式"></a>3 AppOpsService.setUidMode - 设置 uid 的 op 模式</h1><p>设置指定 uid 的相应 op 的模式，如果 uid 的 op 模式发生后，那么属于该 uid 的所有 package 也会受到影响！！</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">setUidMode</span><span class="params">(<span class="keyword">int</span> code, <span class="keyword">int</span> uid, <span class="keyword">int</span> mode)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">if</span> (Binder.getCallingPid() != Process.myPid()) &#123;</span><br><span class="line">        mContext.enforcePermission(android.Manifest.permission.UPDATE_APP_OPS_STATS,</span><br><span class="line">                Binder.getCallingPid(), Binder.getCallingUid(), <span class="keyword">null</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">//【×1.2】校验 op 是否有效！</span></span><br><span class="line">    verifyIncomingOp(code);</span><br><span class="line">    <span class="comment">//【1】获得决定 code 指定 op 模式的 switchCode，其实是另外一个 op！</span></span><br><span class="line">    code = AppOpsManager.opToSwitch(code);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">synchronized</span> (<span class="keyword">this</span>) &#123;</span><br><span class="line">        <span class="comment">//【2】首先，获得该 op 的默认模式 defaultMode！</span></span><br><span class="line">        <span class="keyword">final</span> <span class="keyword">int</span> defaultMode = AppOpsManager.opToDefaultMode(code);</span><br><span class="line"></span><br><span class="line">        <span class="comment">//【×1.5】获得该 uid 对应的 UidState 对象！</span></span><br><span class="line">        UidState uidState = getUidStateLocked(uid, <span class="keyword">false</span>);</span><br><span class="line">        <span class="keyword">if</span> (uidState == <span class="keyword">null</span>) &#123;</span><br><span class="line">            <span class="comment">//【2.1】如果该 uid 没有相关的记录，且本次设置的模式是默认模式，不处理。直接返回！</span></span><br><span class="line">            <span class="keyword">if</span> (mode == defaultMode) &#123;</span><br><span class="line">                <span class="keyword">return</span>;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="comment">// 否则，创建 UidState 对象，将 code 和 mode 的关系添加进去！</span></span><br><span class="line">            uidState = <span class="keyword">new</span> UidState(uid);</span><br><span class="line">            uidState.opModes = <span class="keyword">new</span> SparseIntArray();</span><br><span class="line">            uidState.opModes.put(code, mode);</span><br><span class="line">            mUidStates.put(uid, uidState);</span><br><span class="line">            <span class="comment">// 更新本地文件；</span></span><br><span class="line">            scheduleWriteLocked();</span><br><span class="line">            </span><br><span class="line">        &#125; <span class="keyword">else</span> <span class="keyword">if</span> (uidState.opModes == <span class="keyword">null</span>) &#123;</span><br><span class="line">            <span class="comment">//【2.2】如果该 uid 没有 op 相关的记录，且本次设置的模式是默认模式，不处理！</span></span><br><span class="line">            <span class="comment">// 否则初始化 uidState.opModes，将 code 和 mode 的关系添加进去！</span></span><br><span class="line">            <span class="keyword">if</span> (mode != defaultMode) &#123;</span><br><span class="line">                uidState.opModes = <span class="keyword">new</span> SparseIntArray();</span><br><span class="line">                uidState.opModes.put(code, mode);</span><br><span class="line">                <span class="comment">// 更新本地文件；</span></span><br><span class="line">                scheduleWriteLocked();</span><br><span class="line">            &#125;</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            <span class="comment">//【2.3】如果该 uid 下的 op 已有模式和本次设置的一样，不处理，直接返回！</span></span><br><span class="line">            <span class="keyword">if</span> (uidState.opModes.get(code) == mode) &#123;</span><br><span class="line">                <span class="keyword">return</span>;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="comment">// 如果该 uid 下的 op 已有模式不是默认模式，但是要设置为默认模式，直接从 uidState.opModes 中删除 op！</span></span><br><span class="line">            <span class="comment">// 否则，更新 mode 的值！</span></span><br><span class="line">            <span class="keyword">if</span> (mode == defaultMode) &#123;</span><br><span class="line">                uidState.opModes.delete(code);</span><br><span class="line">                <span class="keyword">if</span> (uidState.opModes.size() &lt;= <span class="number">0</span>) &#123;</span><br><span class="line">                    uidState.opModes = <span class="keyword">null</span>;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                uidState.opModes.put(code, mode);</span><br><span class="line">            &#125;</span><br><span class="line">            scheduleWriteLocked();  <span class="comment">// 更新本地文件；</span></span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">//【3】获得该 uid 下的所有 package！</span></span><br><span class="line">    String[] uidPackageNames = getPackagesForUid(uid);</span><br><span class="line">    ArrayMap&lt;Callback, ArraySet&lt;String&gt;&gt; callbackSpecs = <span class="keyword">null</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">synchronized</span> (<span class="keyword">this</span>) &#123;</span><br><span class="line">        <span class="comment">//【3.1】收集所有监听该 uid 下该 op 模式变化的 Callback，用于触发回调！！</span></span><br><span class="line">        ArrayList&lt;Callback&gt; callbacks = mOpModeWatchers.get(code);</span><br><span class="line">        <span class="keyword">if</span> (callbacks != <span class="keyword">null</span>) &#123;</span><br><span class="line">            <span class="keyword">final</span> <span class="keyword">int</span> callbackCount = callbacks.size();</span><br><span class="line">            <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; callbackCount; i++) &#123;</span><br><span class="line">                Callback callback = callbacks.get(i);</span><br><span class="line">                ArraySet&lt;String&gt; changedPackages = <span class="keyword">new</span> ArraySet&lt;&gt;();</span><br><span class="line">                </span><br><span class="line">                <span class="comment">//【3.1.1】将该 uid 下的所有 package 保存到 changedPackages 中，然后将</span></span><br><span class="line">                <span class="comment">// 每个 Callback 和 changedPackages 的映射关系保存到 callbackSpecs 中！</span></span><br><span class="line">                Collections.addAll(changedPackages, uidPackageNames);</span><br><span class="line">                callbackSpecs = <span class="keyword">new</span> ArrayMap&lt;&gt;();</span><br><span class="line">                callbackSpecs.put(callback, changedPackages);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">//【3.2】收集所有监听该 uid 下 package 的 op 模式变化的 Callback！</span></span><br><span class="line">        <span class="keyword">for</span> (String uidPackageName : uidPackageNames) &#123;</span><br><span class="line">            callbacks = mPackageModeWatchers.get(uidPackageName);</span><br><span class="line">            <span class="keyword">if</span> (callbacks != <span class="keyword">null</span>) &#123;</span><br><span class="line">                <span class="keyword">if</span> (callbackSpecs == <span class="keyword">null</span>) &#123;</span><br><span class="line">                    callbackSpecs = <span class="keyword">new</span> ArrayMap&lt;&gt;();</span><br><span class="line">                &#125;</span><br><span class="line">                <span class="keyword">final</span> <span class="keyword">int</span> callbackCount = callbacks.size();</span><br><span class="line">                <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; callbackCount; i++) &#123;</span><br><span class="line">                    Callback callback = callbacks.get(i);</span><br><span class="line">                    <span class="comment">//【3.2.1】获得之前已经添加的 packageName！！</span></span><br><span class="line">                    ArraySet&lt;String&gt; changedPackages = callbackSpecs.get(callback);</span><br><span class="line">                    <span class="keyword">if</span> (changedPackages == <span class="keyword">null</span>) &#123;</span><br><span class="line">                        changedPackages = <span class="keyword">new</span> ArraySet&lt;&gt;();</span><br><span class="line">                        callbackSpecs.put(callback, changedPackages);</span><br><span class="line">                    &#125;</span><br><span class="line">                    <span class="comment">//【3.2.2】将 package 添加到对应关系中！</span></span><br><span class="line">                    changedPackages.add(uidPackageName);</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (callbackSpecs == <span class="keyword">null</span>) &#123;</span><br><span class="line">        <span class="keyword">return</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">//【4】处理回调，通知该 uid 下的 op 发生了变化，如果 uid 下有 pkg，也会将 pkg 传递过去！！</span></span><br><span class="line">    <span class="keyword">final</span> <span class="keyword">long</span> identity = Binder.clearCallingIdentity();</span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">        <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; callbackSpecs.size(); i++) &#123;</span><br><span class="line">            Callback callback = callbackSpecs.keyAt(i);</span><br><span class="line">            ArraySet&lt;String&gt; reportedPackageNames = callbackSpecs.valueAt(i);</span><br><span class="line">            <span class="keyword">try</span> &#123;</span><br><span class="line">                <span class="keyword">if</span> (reportedPackageNames == <span class="keyword">null</span>) &#123;</span><br><span class="line">                    callback.mCallback.opChanged(code, uid, <span class="keyword">null</span>);</span><br><span class="line">                &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                    <span class="keyword">final</span> <span class="keyword">int</span> reportedPackageCount = reportedPackageNames.size();</span><br><span class="line">                    <span class="keyword">for</span> (<span class="keyword">int</span> j = <span class="number">0</span>; j &lt; reportedPackageCount; j++) &#123;</span><br><span class="line">                        String reportedPackageName = reportedPackageNames.valueAt(j);</span><br><span class="line">                        <span class="comment">//【4.1】触发回调！</span></span><br><span class="line">                        callback.mCallback.opChanged(code, uid, reportedPackageName);</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125; <span class="keyword">catch</span> (RemoteException e) &#123;</span><br><span class="line">                Log.w(TAG, <span class="string">"Error dispatching op op change"</span>, e);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">        Binder.restoreCallingIdentity(identity);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>设置完 uid 的 op 后，会触发那些监听 op 变化的回调！</p>
<h1 id="4-AppOpsService-setMode-设置-package-的-op-模式"><a href="#4-AppOpsService-setMode-设置-package-的-op-模式" class="headerlink" title="4 AppOpsService.setMode - 设置 package 的 op 模式"></a>4 AppOpsService.setMode - 设置 package 的 op 模式</h1><p>设置指定 package 的指定 op 的模式值，参数 int uid 是该 package 所属的 uid！<br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">setMode</span><span class="params">(<span class="keyword">int</span> code, <span class="keyword">int</span> uid, String packageName, <span class="keyword">int</span> mode)</span> </span>&#123;</span><br><span class="line">    <span class="comment">//【1】校验权限，因为 setMode 方法只能是系统调用，系统是默认有 UPDATE_APP_OPS_STATS 权限的！</span></span><br><span class="line">    <span class="keyword">if</span> (Binder.getCallingPid() != Process.myPid()) &#123;</span><br><span class="line">        mContext.enforcePermission(android.Manifest.permission.UPDATE_APP_OPS_STATS,</span><br><span class="line">                Binder.getCallingPid(), Binder.getCallingUid(), <span class="keyword">null</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    verifyIncomingOp(code);</span><br><span class="line">    ArrayList&lt;Callback&gt; repCbs = <span class="keyword">null</span>;</span><br><span class="line">    <span class="comment">//【2】获得决定 code 指定的 op 的模式的 op，调用 AppOpsManager.opToSwitch 方法！</span></span><br><span class="line">    code = AppOpsManager.opToSwitch(code);</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">synchronized</span> (<span class="keyword">this</span>) &#123;</span><br><span class="line">        <span class="comment">//【3】获得 uid 对应的 UidState 对象！</span></span><br><span class="line">        UidState uidState = getUidStateLocked(uid, <span class="keyword">false</span>);</span><br><span class="line">        <span class="comment">//【×1.5】获得 code（switch） 对应的 Op 对象！</span></span><br><span class="line">        Op op = getOpLocked(code, uid, packageName, <span class="keyword">true</span>);</span><br><span class="line">        <span class="keyword">if</span> (op != <span class="keyword">null</span>) &#123;</span><br><span class="line">            <span class="comment">//【5】如果 op 的现有模式和本次要设置的模式不同，更新模式值！</span></span><br><span class="line">            <span class="keyword">if</span> (op.mode != mode) &#123;</span><br><span class="line">                op.mode = mode;</span><br><span class="line">                <span class="comment">//【5.1】更新了模式值后，收集所有监听该 op 模式变化的观察者！</span></span><br><span class="line">                ArrayList&lt;Callback&gt; cbs = mOpModeWatchers.get(code);</span><br><span class="line">                <span class="keyword">if</span> (cbs != <span class="keyword">null</span>) &#123;</span><br><span class="line">                    <span class="keyword">if</span> (repCbs == <span class="keyword">null</span>) &#123;</span><br><span class="line">                        repCbs = <span class="keyword">new</span> ArrayList&lt;Callback&gt;();</span><br><span class="line">                    &#125;</span><br><span class="line">                    repCbs.addAll(cbs);</span><br><span class="line">                &#125;</span><br><span class="line">                <span class="comment">//【5.2】更新了模式值后，收集所有监听该 packageName 操作模式变化的观察者！</span></span><br><span class="line">                cbs = mPackageModeWatchers.get(packageName);</span><br><span class="line">                <span class="keyword">if</span> (cbs != <span class="keyword">null</span>) &#123;</span><br><span class="line">                    <span class="keyword">if</span> (repCbs == <span class="keyword">null</span>) &#123;</span><br><span class="line">                        repCbs = <span class="keyword">new</span> ArrayList&lt;Callback&gt;();</span><br><span class="line">                    &#125;</span><br><span class="line">                    repCbs.addAll(cbs);</span><br><span class="line">                &#125;</span><br><span class="line">                <span class="comment">//【×4.1】如果本次设置是恢复默认模式，那么就移除该 op；</span></span><br><span class="line">                <span class="keyword">if</span> (mode == AppOpsManager.opToDefaultMode(op.op)) &#123;</span><br><span class="line">                    pruneOp(op, uid, packageName);</span><br><span class="line">                &#125;</span><br><span class="line">                <span class="comment">//【×4.2】更新本地文件；</span></span><br><span class="line">                scheduleFastWriteLocked();</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">//【6】当 repCbs 不为 null，通知所有监听者！</span></span><br><span class="line">    <span class="keyword">if</span> (repCbs != <span class="keyword">null</span>) &#123;</span><br><span class="line">        <span class="comment">// 将远程调用者的 uid/pid 转为系统进程的 uid/pid 防止权限相关问题！</span></span><br><span class="line">        <span class="keyword">final</span> <span class="keyword">long</span> identity = Binder.clearCallingIdentity();</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; repCbs.size(); i++) &#123;</span><br><span class="line">                <span class="keyword">try</span> &#123;</span><br><span class="line">                    <span class="comment">//【6.1】触发 callback 的 opChanged 回调！</span></span><br><span class="line">                    repCbs.get(i).mCallback.opChanged(code, uid, packageName);</span><br><span class="line">                &#125; <span class="keyword">catch</span> (RemoteException e) &#123;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">            Binder.restoreCallingIdentity(identity);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>方法流程很简单，不多说了！</p>
<h2 id="4-1-pruneOp"><a href="#4-1-pruneOp" class="headerlink" title="4.1 pruneOp"></a>4.1 pruneOp</h2><p>移除指定的 Op！<br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">pruneOp</span><span class="params">(Op op, <span class="keyword">int</span> uid, String packageName)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">if</span> (op.time == <span class="number">0</span> &amp;&amp; op.rejectTime == <span class="number">0</span>) &#123;</span><br><span class="line">        <span class="comment">//【1】返回该 uid 下该 package 的所有 Op 信息！</span></span><br><span class="line">        Ops ops = getOpsRawLocked(uid, packageName, <span class="keyword">false</span>);</span><br><span class="line">        <span class="keyword">if</span> (ops != <span class="keyword">null</span>) &#123;</span><br><span class="line">            <span class="comment">//【2】从中移除该 op！</span></span><br><span class="line">            ops.remove(op.op);</span><br><span class="line">            <span class="comment">//【3】如果该 package 已经没有任何 Op，那就从所属于的 UidState 中移除相关记录！</span></span><br><span class="line">            <span class="keyword">if</span> (ops.size() &lt;= <span class="number">0</span>) &#123;</span><br><span class="line">                UidState uidState = ops.uidState;</span><br><span class="line">                ArrayMap&lt;String, Ops&gt; pkgOps = uidState.pkgOps;</span><br><span class="line">                <span class="keyword">if</span> (pkgOps != <span class="keyword">null</span>) &#123;</span><br><span class="line">                    pkgOps.remove(ops.packageName);</span><br><span class="line">                    <span class="keyword">if</span> (pkgOps.isEmpty()) &#123;</span><br><span class="line">                        uidState.pkgOps = <span class="keyword">null</span>;</span><br><span class="line">                    &#125;</span><br><span class="line">                    <span class="keyword">if</span> (uidState.isDefault()) &#123;</span><br><span class="line">                        mUidStates.remove(uid);</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>整个过程很简单，不多说了！</p>
<h2 id="4-2-scheduleFastWriteLocked"><a href="#4-2-scheduleFastWriteLocked" class="headerlink" title="4.2 scheduleFastWriteLocked"></a>4.2 scheduleFastWriteLocked</h2><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">scheduleFastWriteLocked</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    <span class="keyword">if</span> (!mFastWriteScheduled) &#123;</span><br><span class="line">        mWriteScheduled = <span class="keyword">true</span>;</span><br><span class="line">        mFastWriteScheduled = <span class="keyword">true</span>;</span><br><span class="line">        mHandler.removeCallbacks(mWriteRunner);</span><br><span class="line">        mHandler.postDelayed(mWriteRunner, <span class="number">10</span>*<span class="number">1000</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>更新本地持久化文件，执行一个 Runnable 对象 mWriteRunner，在启动篇的时候，我们看过了，这里就不再多说了！</p>
<h1 id="5-AppOpsService-startWatchingMode-监听-op-变化"><a href="#5-AppOpsService-startWatchingMode-监听-op-变化" class="headerlink" title="5 AppOpsService.startWatchingMode - 监听 op 变化"></a>5 AppOpsService.startWatchingMode - 监听 op 变化</h1><p>startWatchingMode 用于启动一个监听，他能够监听指定 package 的指定 op 操作的模式变化，当发生会变化后，会回调 callback！<br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">startWatchingMode</span><span class="params">(<span class="keyword">int</span> op, String packageName, IAppOpsCallback callback)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">if</span> (callback == <span class="keyword">null</span>) &#123;</span><br><span class="line">        <span class="keyword">return</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">synchronized</span> (<span class="keyword">this</span>) &#123;</span><br><span class="line">        <span class="comment">//【1】获得决定 op 模式的 op 操作！</span></span><br><span class="line">        op = (op != AppOpsManager.OP_NONE) ? AppOpsManager.opToSwitch(op) : op;</span><br><span class="line">        <span class="comment">//【3.1】将 callback 转为客户端代理，封装为一个 Callback 对象，添加到 mModeWatchers 中！</span></span><br><span class="line">        Callback cb = mModeWatchers.get(callback.asBinder());</span><br><span class="line">        <span class="keyword">if</span> (cb == <span class="keyword">null</span>) &#123;</span><br><span class="line">            <span class="comment">// 创建了一个 Callback 对象，用于监听远程 Binder 对象的死亡布告对象</span></span><br><span class="line">            <span class="comment">// 这样当 IAppOpsCallback.Stub 死亡后，可以停止监听！</span></span><br><span class="line">            cb = <span class="keyword">new</span> Callback(callback);</span><br><span class="line">            <span class="comment">// 将 IAppOpsCallback.Stub 和 Callback 的映射保存到 mModeWatchers 中！</span></span><br><span class="line">            mModeWatchers.put(callback.asBinder(), cb);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">//【3.2】将要监听的 op 操作和对应的监听回调 Callback 的映射关系保存到 mOpModeWatchers 中！</span></span><br><span class="line">        <span class="keyword">if</span> (op != AppOpsManager.OP_NONE) &#123;</span><br><span class="line">            ArrayList&lt;Callback&gt; cbs = mOpModeWatchers.get(op);</span><br><span class="line">            <span class="keyword">if</span> (cbs == <span class="keyword">null</span>) &#123;</span><br><span class="line">                cbs = <span class="keyword">new</span> ArrayList&lt;Callback&gt;();</span><br><span class="line">                mOpModeWatchers.put(op, cbs);</span><br><span class="line">            &#125;</span><br><span class="line">            cbs.add(cb);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">//【3.3】将要监听的 package 和对应的监听回调 Callback 的映射关系保存到 mPackageModeWatchers 中！</span></span><br><span class="line">        <span class="keyword">if</span> (packageName != <span class="keyword">null</span>) &#123;</span><br><span class="line">            ArrayList&lt;Callback&gt; cbs = mPackageModeWatchers.get(packageName);</span><br><span class="line">            <span class="keyword">if</span> (cbs == <span class="keyword">null</span>) &#123;</span><br><span class="line">                cbs = <span class="keyword">new</span> ArrayList&lt;Callback&gt;();</span><br><span class="line">                mPackageModeWatchers.put(packageName, cbs);</span><br><span class="line">            &#125;</span><br><span class="line">            cbs.add(cb);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>AppOpsService 内部有多个集合：<br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//【1】用与 IBinder 作和对应的回调 Callback 的映射关系！</span></span><br><span class="line"><span class="keyword">final</span> ArrayMap&lt;IBinder, Callback&gt; mModeWatchers</span><br><span class="line">        = <span class="keyword">new</span> ArrayMap&lt;IBinder, Callback&gt;();</span><br></pre></td></tr></table></figure></p>
<p>用于保存远程回调 IAppOpsCallback.Stub 和其对应的死亡仆告对象 Callback 的映射关系，当 IAppOpsCallback.Stub 死亡后，Callback.binderDied 会被触发！！</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//【2】用与保存 op 操作和对应的回调 Callback 的映射关系！</span></span><br><span class="line"><span class="keyword">final</span> SparseArray&lt;ArrayList&lt;Callback&gt;&gt; mOpModeWatchers</span><br><span class="line">        = <span class="keyword">new</span> SparseArray&lt;ArrayList&lt;Callback&gt;&gt;();</span><br><span class="line"><span class="comment">//【3】用与保存 package 和对应的回调 Callback 的映射关系！</span></span><br><span class="line"><span class="keyword">final</span> ArrayMap&lt;String, ArrayList&lt;Callback&gt;&gt; mPackageModeWatchers</span><br><span class="line">        = <span class="keyword">new</span> ArrayMap&lt;String, ArrayList&lt;Callback&gt;&gt;();</span><br></pre></td></tr></table></figure>
<p>而 mOpModeWatchers 和 mPackageModeWatchers 则是从不同的角度来建立监听关系：mOpModeWatchers 是从具体 op 的角度，而 mPackageModeWatchers 则是从 package 的角度！</p>
<p>可以看到 Callback 的作用是作为远程回调的死亡仆告对象，用于停止监听。</p>
<h2 id="5-1-new-Callback"><a href="#5-1-new-Callback" class="headerlink" title="5.1 new Callback"></a>5.1 new Callback</h2><p>我们来看下 Callback 对象的创建，Callback 是一个回调对象，用于处理 op 变化后的操作；同时又是一个 DeathRecipient 对象，用来监听远程 IAppOpsCallback 桩对象是否死亡！<br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">final</span> <span class="class"><span class="keyword">class</span> <span class="title">Callback</span> <span class="keyword">implements</span> <span class="title">DeathRecipient</span> </span>&#123;</span><br><span class="line">    <span class="keyword">final</span> IAppOpsCallback mCallback;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="title">Callback</span><span class="params">(IAppOpsCallback callback)</span> </span>&#123;</span><br><span class="line">        mCallback = callback;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            <span class="comment">//【1】将自身注册为一个死亡仆告对象！</span></span><br><span class="line">            mCallback.asBinder().linkToDeath(<span class="keyword">this</span>, <span class="number">0</span>);</span><br><span class="line">        &#125; <span class="keyword">catch</span> (RemoteException e) &#123;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">unlinkToDeath</span><span class="params">()</span> </span>&#123; <span class="comment">//【2】解除注册！</span></span><br><span class="line">        mCallback.asBinder().unlinkToDeath(<span class="keyword">this</span>, <span class="number">0</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">binderDied</span><span class="params">()</span> </span>&#123; <span class="comment">//【1.6】当远程桩对象死亡后，停止监听！</span></span><br><span class="line">        stopWatchingMode(mCallback);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>当远程的 IAppOpsCallback.Stub 死亡后，AppOpsService.stopWatchingMode 会被执行！</p>
<h1 id="6-AppOpsService-stopWatchingMode-停止-op-监听"><a href="#6-AppOpsService-stopWatchingMode-停止-op-监听" class="headerlink" title="6 AppOpsService.stopWatchingMode - 停止 op 监听"></a>6 AppOpsService.stopWatchingMode - 停止 op 监听</h1><p>startWatchingMode 用于停止一个监听！<br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">stopWatchingMode</span><span class="params">(IAppOpsCallback callback)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">if</span> (callback == <span class="keyword">null</span>) &#123;</span><br><span class="line">        <span class="keyword">return</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">synchronized</span> (<span class="keyword">this</span>) &#123;</span><br><span class="line">        <span class="comment">//【1】从 mModeWatchers 中移除 Callback！</span></span><br><span class="line">        Callback cb = mModeWatchers.remove(callback.asBinder());</span><br><span class="line">        <span class="keyword">if</span> (cb != <span class="keyword">null</span>) &#123;</span><br><span class="line">            <span class="comment">// 解除死亡仆告对象注册！</span></span><br><span class="line">            cb.unlinkToDeath();</span><br><span class="line">            <span class="comment">//【2】从 mOpModeWatchers 移除该 Callback！</span></span><br><span class="line">            <span class="keyword">for</span> (<span class="keyword">int</span> i=mOpModeWatchers.size()-<span class="number">1</span>; i&gt;=<span class="number">0</span>; i--) &#123;</span><br><span class="line">                ArrayList&lt;Callback&gt; cbs = mOpModeWatchers.valueAt(i);</span><br><span class="line">                cbs.remove(cb);</span><br><span class="line">                <span class="keyword">if</span> (cbs.size() &lt;= <span class="number">0</span>) &#123;</span><br><span class="line">                    mOpModeWatchers.removeAt(i);</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="comment">//【3】从 mPackageModeWatchers 移除该 Callback！</span></span><br><span class="line">            <span class="keyword">for</span> (<span class="keyword">int</span> i=mPackageModeWatchers.size()-<span class="number">1</span>; i&gt;=<span class="number">0</span>; i--) &#123;</span><br><span class="line">                ArrayList&lt;Callback&gt; cbs = mPackageModeWatchers.valueAt(i);</span><br><span class="line">                cbs.remove(cb);</span><br><span class="line">                <span class="keyword">if</span> (cbs.size() &lt;= <span class="number">0</span>) &#123;</span><br><span class="line">                    mPackageModeWatchers.removeAt(i);</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>方法很简单，就不多说了！</p>
<h1 id="7-AppOpsService-startOperation-开始监视操作"><a href="#7-AppOpsService-startOperation-开始监视操作" class="headerlink" title="7 AppOpsService.startOperation - 开始监视操作"></a>7 AppOpsService.startOperation - 开始监视操作</h1><p>startOperation 用于监控一些长时间工作的操作，比如 Gps，像 Vibrator 等等，可以使用 startOperation 开始监视权限，使用 finishOperation 结束监视，要监视 op 前提是被监视者有权限执行 op 操作！！</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">int</span> <span class="title">startOperation</span><span class="params">(IBinder token, <span class="keyword">int</span> code, <span class="keyword">int</span> uid, String packageName)</span> </span>&#123;</span><br><span class="line">    verifyIncomingUid(uid);</span><br><span class="line">    verifyIncomingOp(code);</span><br><span class="line">    <span class="comment">//【1】处理包名！</span></span><br><span class="line">    String resolvedPackageName = resolvePackageName(uid, packageName);</span><br><span class="line">    <span class="keyword">if</span> (resolvedPackageName == <span class="keyword">null</span>) &#123;</span><br><span class="line">        <span class="keyword">return</span>  AppOpsManager.MODE_IGNORED;</span><br><span class="line">    &#125;</span><br><span class="line">    ClientState client = (ClientState)token;</span><br><span class="line">    <span class="keyword">synchronized</span> (<span class="keyword">this</span>) &#123;</span><br><span class="line">        <span class="comment">//【*1.4.1】获得该 package 的所有 Op 信息！</span></span><br><span class="line">        Ops ops = getOpsRawLocked(uid, resolvedPackageName, <span class="keyword">true</span>);</span><br><span class="line">        <span class="keyword">if</span> (ops == <span class="keyword">null</span>) &#123;</span><br><span class="line">            <span class="keyword">if</span> (DEBUG) Log.d(TAG, <span class="string">"startOperation: no op for code "</span> + code + <span class="string">" uid "</span> + uid</span><br><span class="line">                    + <span class="string">" package "</span> + resolvedPackageName);</span><br><span class="line">            <span class="keyword">return</span> AppOpsManager.MODE_ERRORED;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">//【*1.5】获得 code 指定的 Op 信息！</span></span><br><span class="line">        Op op = getOpLocked(ops, code, <span class="keyword">true</span>);</span><br><span class="line"></span><br><span class="line">        <span class="comment">//【*1.4】如果该 op 在 uid 所在的用户下受限，返回 MODE_IGNORED ！</span></span><br><span class="line">        <span class="keyword">if</span> (isOpRestrictedLocked(uid, code, resolvedPackageName)) &#123;</span><br><span class="line">            <span class="keyword">return</span> AppOpsManager.MODE_IGNORED;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">//【2】获得决定 code 指定 op 模式的 switchCode，其实是另外一个 op！</span></span><br><span class="line">        <span class="keyword">final</span> <span class="keyword">int</span> switchCode = AppOpsManager.opToSwitch(code);</span><br><span class="line">        UidState uidState = ops.uidState;</span><br><span class="line">        <span class="keyword">if</span> (uidState.opModes != <span class="keyword">null</span>) &#123;</span><br><span class="line">            <span class="comment">//【3.1】如果该 uid 有 switchCode 对应的操作，那么 uid 的 switchCode 模式优先级更高！</span></span><br><span class="line">            <span class="comment">// 所以，最后返回的是该 uid 的 switchCode 模式！</span></span><br><span class="line">            <span class="keyword">final</span> <span class="keyword">int</span> uidMode = uidState.opModes.get(switchCode);</span><br><span class="line">            <span class="keyword">if</span> (uidMode != AppOpsManager.MODE_ALLOWED) &#123;</span><br><span class="line">                <span class="keyword">if</span> (DEBUG) Log.d(TAG, <span class="string">"noteOperation: reject #"</span> + op.mode + <span class="string">" for code "</span></span><br><span class="line">                        + switchCode + <span class="string">" ("</span> + code + <span class="string">") uid "</span> + uid + <span class="string">" package "</span></span><br><span class="line">                        + resolvedPackageName);</span><br><span class="line">                <span class="comment">//【3.1.1】uid 不被允许的执行该 switchCode 指定的操作，</span></span><br><span class="line">                <span class="comment">// 那么更新 code 对应 op 的 rejectTime 值！</span></span><br><span class="line">                op.rejectTime = System.currentTimeMillis();</span><br><span class="line">                <span class="keyword">return</span> uidMode;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">//【3.2】如果该 uid 没有该 switchCode 对应的操作，那就读取 package 的 switchCode 操作模式！</span></span><br><span class="line">        <span class="comment">// 所以，最后返回的是该 package 的 switchCode 模式！</span></span><br><span class="line">        <span class="keyword">final</span> Op switchOp = switchCode != code ? getOpLocked(ops, switchCode, <span class="keyword">true</span>) : op;</span><br><span class="line">        <span class="keyword">if</span> (switchOp.mode != AppOpsManager.MODE_ALLOWED) &#123;</span><br><span class="line">            <span class="keyword">if</span> (DEBUG) Log.d(TAG, <span class="string">"startOperation: reject #"</span> + op.mode + <span class="string">" for code "</span></span><br><span class="line">                    + switchCode + <span class="string">" ("</span> + code + <span class="string">") uid "</span> + uid + <span class="string">" package "</span></span><br><span class="line">                    + resolvedPackageName);</span><br><span class="line">            <span class="comment">//【3.2.1】package 不被允许的执行该 switchCode 在指定的操作，</span></span><br><span class="line">            <span class="comment">// 那么更新 code 对应 op 的 rejectTime 值！</span></span><br><span class="line">            op.rejectTime = System.currentTimeMillis();</span><br><span class="line">            <span class="keyword">return</span> switchOp.mode;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">if</span> (DEBUG) Log.d(TAG, <span class="string">"startOperation: allowing code "</span> + code + <span class="string">" uid "</span> + uid</span><br><span class="line">                + <span class="string">" package "</span> + resolvedPackageName);</span><br><span class="line">        </span><br><span class="line">        <span class="comment">// 进入到这里，表示该操作是被允许的，这里会更新 op 的数据，然后返回 MODE_ALLOWED！</span></span><br><span class="line">        <span class="keyword">if</span> (op.nesting == <span class="number">0</span>) &#123;</span><br><span class="line">            op.time = System.currentTimeMillis(); <span class="comment">// 更新允许时间</span></span><br><span class="line">            op.rejectTime = <span class="number">0</span>; <span class="comment">// 设置拒绝时间为 0；</span></span><br><span class="line">            op.duration = -<span class="number">1</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        op.nesting++; <span class="comment">// start 次数加 1；</span></span><br><span class="line">        <span class="keyword">if</span> (client.mStartedOps != <span class="keyword">null</span>) &#123;</span><br><span class="line">            client.mStartedOps.add(op); <span class="comment">// 将 start 的 Op 添加到 ClientState.mStartedOps 中监控！</span></span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> AppOpsManager.MODE_ALLOWED;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>startOperation 的第一个参数是一个 IBinder token，这个 token 通过如下方式获得：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">AppOpsManager.getToken(mAppOpsService)</span><br></pre></td></tr></table></figure>
<p>在 AppOpsManager 中我们有分析过这个方法，其返回的是一个 ClientState 对象！</p>
<h2 id="7-1-AppOpsManager-getToken"><a href="#7-1-AppOpsManager-getToken" class="headerlink" title="7.1 AppOpsManager.getToken"></a>7.1 AppOpsManager.getToken</h2><p>我们来看看 getToken 方法，传入的是 mService。mService 是 AppOpsManager 的成员变量：<br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">IAppOpsService mService;</span><br></pre></td></tr></table></figure></p>
<p>其实 mService 就是 AppOpsService 的 Proxy 对象！</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">/** @hide */</span><br><span class="line">public static IBinder getToken(IAppOpsService service) &#123;</span><br><span class="line">    synchronized (AppOpsManager.class) &#123;</span><br><span class="line">        if (sToken != null) &#123;</span><br><span class="line">            return sToken;</span><br><span class="line">        &#125;</span><br><span class="line">        try &#123;</span><br><span class="line">            //【1】这里创建了一个 new Binder 对象，同时调用 AppOpsService.getToken 方法！</span><br><span class="line">            // 该方法会返回一个 Binder 对象，保存到 AppOpsManager.sToken 变量中;</span><br><span class="line">            sToken = service.getToken(new Binder());</span><br><span class="line">        &#125; catch (RemoteException e) &#123;</span><br><span class="line">            throw e.rethrowFromSystemServer();</span><br><span class="line">        &#125;</span><br><span class="line">        return sToken;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>这里会创建一个 Binder 对象，表示当前进程实体！</p>
<p>sToken 也是一个 Binder 对象：<br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">static</span> IBinder sToken;</span><br></pre></td></tr></table></figure></p>
<p>用于保存 AppOpsService 返回的 ClientState 对象！</p>
<h2 id="7-2-AppOpsService-getToken"><a href="#7-2-AppOpsService-getToken" class="headerlink" title="7.2 AppOpsService.getToken"></a>7.2 AppOpsService.getToken</h2><p>通过 Binder 通信，AppOpsManager 创建的 Binder 对象，传递到了 AppOpsService.getToken 方法中！<br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> IBinder <span class="title">getToken</span><span class="params">(IBinder clientToken)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">synchronized</span> (<span class="keyword">this</span>) &#123;</span><br><span class="line">        ClientState cs = mClients.get(clientToken);</span><br><span class="line">        <span class="keyword">if</span> (cs == <span class="keyword">null</span>) &#123;</span><br><span class="line">            <span class="comment">//【×7.2.1】创建一个 ClientState 对象，保存到 mClients 中！</span></span><br><span class="line">            cs = <span class="keyword">new</span> ClientState(clientToken);</span><br><span class="line">            mClients.put(clientToken, cs);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> cs;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>这里的 ClientToken，就是前面 new Binder 创建的实体!</p>
<p>AppOpsService 内部有一个 mClients 变量，用于保存调用方进程的 Binder 对象和对应的 ClientState 的映射关系！<br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">final</span> ArrayMap&lt;IBinder, ClientState&gt; mClients = <span class="keyword">new</span> ArrayMap&lt;IBinder, ClientState&gt;();</span><br></pre></td></tr></table></figure></p>
<p>这个 ClientState 会记录调用方进程的 op 状态，同时其也实现了 DeathRecipient 接口，能够监听调用方进程的 Binder 对象是否死亡！</p>
<h3 id="7-2-1-new-ClientState-被监控的实体信息"><a href="#7-2-1-new-ClientState-被监控的实体信息" class="headerlink" title="7.2.1 new ClientState - 被监控的实体信息"></a>7.2.1 new ClientState - 被监控的实体信息</h3><p>我们来看下 ClientState 的结构！</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">final</span> <span class="class"><span class="keyword">class</span> <span class="title">ClientState</span> <span class="keyword">extends</span> <span class="title">Binder</span> <span class="keyword">implements</span> <span class="title">DeathRecipient</span> </span>&#123;</span><br><span class="line">    <span class="keyword">final</span> IBinder mAppToken; <span class="comment">// 调用方进程 token！</span></span><br><span class="line">    <span class="keyword">final</span> <span class="keyword">int</span> mPid; <span class="comment">// 调用方进程的 pid</span></span><br><span class="line">    <span class="keyword">final</span> ArrayList&lt;Op&gt; mStartedOps; <span class="comment">// 用于保存调用方被 start 的所有 Op 操作！</span></span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="title">ClientState</span><span class="params">(IBinder appToken)</span> </span>&#123;</span><br><span class="line">        mAppToken = appToken; <span class="comment">// 保存调用方的 Binder 对象！</span></span><br><span class="line">        mPid = Binder.getCallingPid(); <span class="comment">// 获得调用方进程的 pid！</span></span><br><span class="line">        <span class="keyword">if</span> (appToken <span class="keyword">instanceof</span> Binder) &#123;</span><br><span class="line">            <span class="comment">// 如果调用方传来的 appToken 是 Binder 的实例，那说明调用方就是系统进程内部的某个 client！</span></span><br><span class="line">            <span class="comment">// 这种中情况，无需监控被 start 的 op 操作！</span></span><br><span class="line">            mStartedOps = <span class="keyword">null</span>;</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            <span class="comment">// 如果调用方处于非系统进程，那么我们需要监控其 start 的 op 操作！</span></span><br><span class="line">            mStartedOps = <span class="keyword">new</span> ArrayList&lt;Op&gt;();</span><br><span class="line">            <span class="keyword">try</span> &#123;</span><br><span class="line">                mAppToken.linkToDeath(<span class="keyword">this</span>, <span class="number">0</span>);</span><br><span class="line">            &#125; <span class="keyword">catch</span> (RemoteException e) &#123;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">binderDied</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="comment">// 当远程调用进程死亡后，会调用 ClientState.binderDied 方法，该方法会 finish 掉远程进程</span></span><br><span class="line">        <span class="comment">// 持有的所有被 start 的 op 操作！</span></span><br><span class="line">        <span class="keyword">synchronized</span> (AppOpsService.<span class="keyword">this</span>) &#123;</span><br><span class="line">            <span class="keyword">for</span> (<span class="keyword">int</span> i=mStartedOps.size()-<span class="number">1</span>; i&gt;=<span class="number">0</span>; i--) &#123;</span><br><span class="line">                <span class="comment">//【*8.1】调用了 finishOperation 方法！</span></span><br><span class="line">                finishOperationLocked(mStartedOps.get(i));</span><br><span class="line">            &#125;</span><br><span class="line">            mClients.remove(mAppToken);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>对于 ClientState 的分析就到这里！</p>
<h1 id="8-AppOpsService-finishOperation-结束监视操作"><a href="#8-AppOpsService-finishOperation-结束监视操作" class="headerlink" title="8 AppOpsService.finishOperation - 结束监视操作"></a>8 AppOpsService.finishOperation - 结束监视操作</h1><p>finishOperation</p>
<p>第一个参数 IBinder token，必须是 ClientState 对象！也就是说，必须在调用了 startOperation 后，finishOperation 才有意义！</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">finishOperation</span><span class="params">(IBinder token, <span class="keyword">int</span> code, <span class="keyword">int</span> uid, String packageName)</span> </span>&#123;</span><br><span class="line">    verifyIncomingUid(uid);</span><br><span class="line">    verifyIncomingOp(code);</span><br><span class="line">    String resolvedPackageName = resolvePackageName(uid, packageName);</span><br><span class="line">    <span class="keyword">if</span> (resolvedPackageName == <span class="keyword">null</span>) &#123;</span><br><span class="line">        <span class="keyword">return</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span> (!(token <span class="keyword">instanceof</span> ClientState)) &#123;</span><br><span class="line">        <span class="keyword">return</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    ClientState client = (ClientState) token;</span><br><span class="line">    <span class="keyword">synchronized</span> (<span class="keyword">this</span>) &#123;</span><br><span class="line">        <span class="comment">//【×1.5】获得 uid 下该 package 的 code 操作对应的 Op 实例！</span></span><br><span class="line">        Op op = getOpLocked(code, uid, resolvedPackageName, <span class="keyword">true</span>);</span><br><span class="line">        <span class="keyword">if</span> (op == <span class="keyword">null</span>) &#123;</span><br><span class="line">            <span class="keyword">return</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">//【2】从 ClientState.mStartedOps 中移除该 Op！！</span></span><br><span class="line">        <span class="keyword">if</span> (client.mStartedOps != <span class="keyword">null</span>) &#123;</span><br><span class="line">            <span class="keyword">if</span> (!client.mStartedOps.remove(op)) &#123;</span><br><span class="line">                <span class="keyword">throw</span> <span class="keyword">new</span> IllegalStateException(<span class="string">"Operation not started: uid"</span> + op.uid</span><br><span class="line">                        + <span class="string">" pkg="</span> + op.packageName + <span class="string">" op="</span> + op.op);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">//【×8.1】调用了 finishOperationLocked 方法，继续处理！</span></span><br><span class="line">        finishOperationLocked(op);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>整个方法很简单，不所说了！</p>
<h2 id="8-1-finishOperationLocked"><a href="#8-1-finishOperationLocked" class="headerlink" title="8.1 finishOperationLocked"></a>8.1 finishOperationLocked</h2><p>finishOperationLocked 方法中会对该 Op 的属性进行更新！<br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">finishOperationLocked</span><span class="params">(Op op)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">if</span> (op.nesting &lt;= <span class="number">1</span>) &#123;</span><br><span class="line">        <span class="keyword">if</span> (op.nesting == <span class="number">1</span>) &#123;</span><br><span class="line">            <span class="comment">//【1】更新该操作的执行时长！</span></span><br><span class="line">            op.duration = (<span class="keyword">int</span>)(System.currentTimeMillis() - op.time);</span><br><span class="line">            <span class="comment">//【2】更新操作 op 的最新允许时间！</span></span><br><span class="line">            op.time += op.duration;</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            Slog.w(TAG, <span class="string">"Finishing op nesting under-run: uid "</span> + op.uid + <span class="string">" pkg "</span></span><br><span class="line">                    + op.packageName + <span class="string">" code "</span> + op.op + <span class="string">" time="</span> + op.time</span><br><span class="line">                    + <span class="string">" duration="</span> + op.duration + <span class="string">" nesting="</span> + op.nesting);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">// 将 op.nesting 置为 0，表示 Op 的 start 操作完全结束！</span></span><br><span class="line">        op.nesting = <span class="number">0</span>;</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        op.nesting--; <span class="comment">// start 次数减 1；</span></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<h1 id="9-AppOpsService-setUserRestriction-设置用户限制"><a href="#9-AppOpsService-setUserRestriction-设置用户限制" class="headerlink" title="9 AppOpsService.setUserRestriction - 设置用户限制"></a>9 AppOpsService.setUserRestriction - 设置用户限制</h1><p>setUserRestriction 主要是在 UserManagerService 方法中使用！</p>
<p>setUserRestriction 方法用于设置用户限制，他有 2 个重载函数，第一个 setUserRestriction 方法会设置所有 op 的用户限制！</p>
<p>参数 IBinder token 是一个 Binder 对象，用于表示远程调用者，UserManagerService 中直接传入的是一个 new Bindler 对象！<br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">setUserRestrictions</span><span class="params">(Bundle restrictions, IBinder token, <span class="keyword">int</span> userHandle)</span> </span>&#123;</span><br><span class="line">    checkSystemUid(<span class="string">"setUserRestrictions"</span>); / 如果不是系统进程调用会抛出异常！</span><br><span class="line">    Preconditions.checkNotNull(restrictions);</span><br><span class="line">    Preconditions.checkNotNull(token);</span><br><span class="line">    <span class="comment">//【1】处理定义的每一个 operation，获得其所受的用户限制！</span></span><br><span class="line">    <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; AppOpsManager._NUM_OP; i++) &#123;</span><br><span class="line">        String restriction = AppOpsManager.opToRestriction(i);</span><br><span class="line">        <span class="comment">// 如果该 op 确实会受到用户限制，继续处理！</span></span><br><span class="line">        <span class="keyword">if</span> (restriction != <span class="keyword">null</span>) &#123;</span><br><span class="line">            <span class="comment">//【×9.1】调用了 setUserRestrictionNoCheck 方法，进一步设置用户限制！</span></span><br><span class="line">            setUserRestrictionNoCheck(i, restrictions.getBoolean(restriction, <span class="keyword">false</span>), token,</span><br><span class="line">                    userHandle, <span class="keyword">null</span>);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>第二个 setUserRestriction 方法，第一个方法会设置指定 op 是否受到用户限制，同时额外传入了一个 String[] exceptionPackages，表示白名单，在该白名单中的 package 可以不受用户限制：<br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">setUserRestriction</span><span class="params">(<span class="keyword">int</span> code, <span class="keyword">boolean</span> restricted, IBinder token, <span class="keyword">int</span> userHandle,</span></span></span><br><span class="line"><span class="function"><span class="params">        String[] exceptionPackages)</span> </span>&#123;</span><br><span class="line">    <span class="comment">//【1】当不是当前进程调用，强制校验是否有 MANAGE_APP_OPS_RESTRICTIONS 权限！</span></span><br><span class="line">    <span class="keyword">if</span> (Binder.getCallingPid() != Process.myPid()) &#123;</span><br><span class="line">        mContext.enforcePermission(Manifest.permission.MANAGE_APP_OPS_RESTRICTIONS,</span><br><span class="line">                Binder.getCallingPid(), Binder.getCallingUid(), <span class="keyword">null</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">//【2】如果是跨用户调用，要校验是否有 INTERACT_ACROSS_USERS_FULL 和 INTERACT_ACROSS_USERS 权限！</span></span><br><span class="line">    <span class="keyword">if</span> (userHandle != UserHandle.getCallingUserId()) &#123;</span><br><span class="line">        <span class="keyword">if</span> (mContext.checkCallingOrSelfPermission(Manifest.permission</span><br><span class="line">                .INTERACT_ACROSS_USERS_FULL ) != PackageManager.PERMISSION_GRANTED</span><br><span class="line">            &amp;&amp; mContext.checkCallingOrSelfPermission(Manifest.permission</span><br><span class="line">                .INTERACT_ACROSS_USERS) != PackageManager.PERMISSION_GRANTED) &#123;</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> SecurityException(<span class="string">"Need INTERACT_ACROSS_USERS_FULL or"</span></span><br><span class="line">                    + <span class="string">" INTERACT_ACROSS_USERS to interact cross user "</span>);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    verifyIncomingOp(code);</span><br><span class="line">    Preconditions.checkNotNull(token);</span><br><span class="line">    <span class="comment">//【×9.1】调用了 setUserRestrictionNoCheck 方法，进一步设置用户限制！</span></span><br><span class="line">    setUserRestrictionNoCheck(code, restricted, token, userHandle, exceptionPackages);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<h2 id="9-1-setUserRestrictionNoCheck"><a href="#9-1-setUserRestrictionNoCheck" class="headerlink" title="9.1 setUserRestrictionNoCheck"></a>9.1 setUserRestrictionNoCheck</h2><p>参数 boolean restricted 表示是否限制，为 true 的话，表示打开限制！</p>
<p>这里的 token 来自 UserManagerService 中：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> IBinder mUserRestriconToken = <span class="keyword">new</span> Binder();</span><br></pre></td></tr></table></figure>
<p>本质上是一个 Binder 对象！！<br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">setUserRestrictionNoCheck</span><span class="params">(<span class="keyword">int</span> code, <span class="keyword">boolean</span> restricted, IBinder token,</span></span></span><br><span class="line"><span class="function"><span class="params">        <span class="keyword">int</span> userHandle, String[] exceptionPackages)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">boolean</span> notifyChange = <span class="keyword">false</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">synchronized</span> (AppOpsService.<span class="keyword">this</span>) &#123;</span><br><span class="line">        <span class="comment">//【×9.2】从 mOpUserRestrictions 获得 IBinder 对应的 ClientRestrictionState 对象！</span></span><br><span class="line">        <span class="comment">// 如果没有，就会创建一个新的实例，加入 mOpUserRestrictions！</span></span><br><span class="line">        ClientRestrictionState restrictionState = mOpUserRestrictions.get(token);</span><br><span class="line">        <span class="keyword">if</span> (restrictionState == <span class="keyword">null</span>) &#123;</span><br><span class="line">            <span class="keyword">try</span> &#123;</span><br><span class="line">                restrictionState = <span class="keyword">new</span> ClientRestrictionState(token);</span><br><span class="line">            &#125; <span class="keyword">catch</span> (RemoteException e) &#123;</span><br><span class="line">                <span class="keyword">return</span>;</span><br><span class="line">            &#125;</span><br><span class="line">            mOpUserRestrictions.put(token, restrictionState);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">//【×9.3】设置用户限制，如果有 op 的限制发生了变化，或者不受限制白名单发生了变化！</span></span><br><span class="line">        <span class="keyword">if</span> (restrictionState.setRestriction(code, restricted, exceptionPackages, userHandle)) &#123;</span><br><span class="line">            notifyChange = <span class="keyword">true</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">//【×9.3.1】如果该 bindler 对应的 ClientRestrictionState 恢复了默认状态，那就移除！</span></span><br><span class="line">        <span class="keyword">if</span> (restrictionState.isDefault()) &#123;</span><br><span class="line">            mOpUserRestrictions.remove(token);</span><br><span class="line">            restrictionState.destroy();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">//【×9.4】通知所有的监听者，该操作的用户限制状态发生了变化！</span></span><br><span class="line">    <span class="keyword">if</span> (notifyChange) &#123;</span><br><span class="line">        notifyWatchersOfChange(code);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>AppOpsService 有一个 mOpUserRestrictions 的哈希表，用与保存所有的用于限制信息！<br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">private</span> <span class="keyword">final</span> ArrayMap&lt;IBinder, ClientRestrictionState&gt; mOpUserRestrictions = <span class="keyword">new</span> ArrayMap&lt;&gt;();</span><br></pre></td></tr></table></figure></p>
<h2 id="9-2-new-ClientRestrictionState"><a href="#9-2-new-ClientRestrictionState" class="headerlink" title="9.2 new ClientRestrictionState"></a>9.2 new ClientRestrictionState</h2><p>当第一次设置用户限制时，会创建 ClientRestrictionState 对象。保存用户限制状态！<br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">private</span> <span class="keyword">final</span> <span class="class"><span class="keyword">class</span> <span class="title">ClientRestrictionState</span> <span class="keyword">implements</span> <span class="title">DeathRecipient</span> </span>&#123;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> IBinder token;</span><br><span class="line">    SparseArray&lt;<span class="keyword">boolean</span>[]&gt; perUserRestrictions; <span class="comment">// 见下面；</span></span><br><span class="line">    SparseArray&lt;String[]&gt; perUserExcludedPackages; <span class="comment">// 见下面；</span></span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="title">ClientRestrictionState</span><span class="params">(IBinder token)</span></span></span><br><span class="line"><span class="function">            <span class="keyword">throws</span> RemoteException </span>&#123;</span><br><span class="line">        <span class="comment">//【1】绑定远程进程的 Binder 对象！</span></span><br><span class="line">        token.linkToDeath(<span class="keyword">this</span>, <span class="number">0</span>);</span><br><span class="line">        <span class="keyword">this</span>.token = token;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">binderDied</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">synchronized</span> (AppOpsService.<span class="keyword">this</span>) &#123;</span><br><span class="line">            <span class="comment">//【2】从 mOpUserRestrictions 中该 token 相应关系，解除了用户限制！</span></span><br><span class="line">            mOpUserRestrictions.remove(token);</span><br><span class="line">            <span class="keyword">if</span> (perUserRestrictions == <span class="keyword">null</span>) &#123;</span><br><span class="line">                <span class="keyword">return</span>;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">final</span> <span class="keyword">int</span> userCount = perUserRestrictions.size();</span><br><span class="line">            <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; userCount; i++) &#123;</span><br><span class="line">                <span class="keyword">final</span> <span class="keyword">boolean</span>[] restrictions = perUserRestrictions.valueAt(i);</span><br><span class="line">                <span class="keyword">final</span> <span class="keyword">int</span> restrictionCount = restrictions.length;</span><br><span class="line">                <span class="keyword">for</span> (<span class="keyword">int</span> j = <span class="number">0</span>; j &lt; restrictionCount; j++) &#123;</span><br><span class="line">                    <span class="comment">//【1】如果有 op 之前是开启了用户限制，那么需要通知所有监听 op 状态变化的回调</span></span><br><span class="line">                    <span class="comment">//【1.9.4】调用了 notifyWatchersOfChange 方法！</span></span><br><span class="line">                    <span class="keyword">if</span> (restrictions[j]) &#123;</span><br><span class="line">                        <span class="keyword">final</span> <span class="keyword">int</span> changedCode = j;</span><br><span class="line">                        mHandler.post(() -&gt; notifyWatchersOfChange(changedCode));</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">            destroy();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>ClientRestrictionState 实现了 DeathRecipient 接口，当和其绑定的远程 Binder 对象死亡后会触发其 binderDied 方法！</p>
<ul>
<li><p><strong>perUserRestrictions</strong> 是一个 SparseArray，下标为 userId，而 SparseArray[i] 则是一个 boolean[] 数组，该数组长度为 AppOpsManager._NUM_OP 表示在 userId 下，每个 op 的限制情况，为 true 表示限制，为 false 表示不限制！</p>
</li>
<li><p><strong>perUserExcludedPackages</strong> 也是一个 SparseArray，下标为 userId，而 SparseArray[i] 则是一个 String[] 数组，该数字保存白名单，在该名单中的应用不会受到用户限制！</p>
</li>
</ul>
<p>当 token 对应的远程 Binder 对象死亡后，会触发 ClientRestrictionState.binderDied 方法</p>
<h2 id="9-3-ClientRestrictionState-setRestriction"><a href="#9-3-ClientRestrictionState-setRestriction" class="headerlink" title="9.3 ClientRestrictionState.setRestriction"></a>9.3 ClientRestrictionState.setRestriction</h2><p>设置用户限制，restricted 表示是否限制！<br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">boolean</span> <span class="title">setRestriction</span><span class="params">(<span class="keyword">int</span> code, <span class="keyword">boolean</span> restricted, String[] excludedPackages, <span class="keyword">int</span> userId)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">boolean</span> changed = <span class="keyword">false</span>;</span><br><span class="line">    <span class="keyword">if</span> (perUserRestrictions == <span class="keyword">null</span> &amp;&amp; restricted) &#123;</span><br><span class="line">        perUserRestrictions = <span class="keyword">new</span> SparseArray&lt;&gt;();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (perUserRestrictions != <span class="keyword">null</span>) &#123;</span><br><span class="line">        <span class="comment">//【1】获得 userId 下，所有 op 的限制情况！</span></span><br><span class="line">        <span class="keyword">boolean</span>[] userRestrictions = perUserRestrictions.get(userId);</span><br><span class="line">        <span class="keyword">if</span> (userRestrictions == <span class="keyword">null</span> &amp;&amp; restricted) &#123;</span><br><span class="line">            <span class="comment">//【1.1】如果 userRestrictions 为 null，且当前要设置为限制，那就会初始化 userRestrictions</span></span><br><span class="line">            <span class="comment">// 为一个 AppOpsManager._NUM_OP 大小的数组，添加到 perUserRestrictions 中！</span></span><br><span class="line">            userRestrictions = <span class="keyword">new</span> <span class="keyword">boolean</span>[AppOpsManager._NUM_OP];</span><br><span class="line">            perUserRestrictions.put(userId, userRestrictions);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">//【2】尝试更新 userRestrictions[code] 的值，userRestrictions[code] 表示的是 op 的限制状态！</span></span><br><span class="line">        <span class="comment">// 只有当限制状态变化时，才会更新！</span></span><br><span class="line">        <span class="keyword">if</span> (userRestrictions != <span class="keyword">null</span> &amp;&amp; userRestrictions[code] != restricted) &#123;</span><br><span class="line">            <span class="comment">// 更新 userRestrictions[code]；</span></span><br><span class="line">            userRestrictions[code] = restricted;</span><br><span class="line">            <span class="comment">//【×9.3.1】如果本次是取消用户限制，并且 userId 下的所有的 op 都是不开启限制的！</span></span><br><span class="line">            <span class="comment">// 那么从 perUserRestrictions 中移除该 userId 的记录！</span></span><br><span class="line">            <span class="keyword">if</span> (!restricted &amp;&amp; isDefault(userRestrictions)) &#123;</span><br><span class="line">                perUserRestrictions.remove(userId);</span><br><span class="line">                userRestrictions = <span class="keyword">null</span>;</span><br><span class="line">            &#125;</span><br><span class="line">            changed = <span class="keyword">true</span>; <span class="comment">// 表示发生了更新！</span></span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment">//【3】userRestrictions 不为 null，说明在该 userId 下对某些 op 进行了用户限制！</span></span><br><span class="line">        <span class="keyword">if</span> (userRestrictions != <span class="keyword">null</span>) &#123;</span><br><span class="line">            <span class="keyword">final</span> <span class="keyword">boolean</span> noExcludedPackages = ArrayUtils.isEmpty(excludedPackages);</span><br><span class="line">            <span class="keyword">if</span> (perUserExcludedPackages == <span class="keyword">null</span> &amp;&amp; !noExcludedPackages) &#123;</span><br><span class="line">                <span class="comment">//【3.1】如果本次指定了白名单，并且 perUserExcludedPackages 为 null</span></span><br><span class="line">                <span class="comment">// 那么会进行初始化；</span></span><br><span class="line">                perUserExcludedPackages = <span class="keyword">new</span> SparseArray&lt;&gt;();</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="comment">//【3.2】本次指定的白名单 excludedPackages 和该 userId 下已有的名单不一样！</span></span><br><span class="line">            <span class="comment">// 如果本次未指定白名单，那就移除该 userId 下已有的名单；</span></span><br><span class="line">            <span class="comment">// 如果本次指定了白名单，那就更新该 userId 下已有的名单；</span></span><br><span class="line">            <span class="keyword">if</span> (perUserExcludedPackages != <span class="keyword">null</span> &amp;&amp; !Arrays.equals(excludedPackages,</span><br><span class="line">                    perUserExcludedPackages.get(userId))) &#123;</span><br><span class="line">                <span class="keyword">if</span> (noExcludedPackages) &#123;</span><br><span class="line">                    perUserExcludedPackages.remove(userId);</span><br><span class="line">                    <span class="keyword">if</span> (perUserExcludedPackages.size() &lt;= <span class="number">0</span>) &#123;</span><br><span class="line">                        perUserExcludedPackages = <span class="keyword">null</span>;</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                    perUserExcludedPackages.put(userId, excludedPackages);</span><br><span class="line">                &#125;</span><br><span class="line">                <span class="comment">//【3.1】名单更新了，设置 changed 为 true！</span></span><br><span class="line">                changed = <span class="keyword">true</span>;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> changed;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>继续分析！</p>
<h3 id="9-3-1-ClientRestrictionState-isDefault"><a href="#9-3-1-ClientRestrictionState-isDefault" class="headerlink" title="9.3.1 ClientRestrictionState.isDefault"></a>9.3.1 ClientRestrictionState.isDefault</h3><p>有两个 default 方法：<br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">boolean</span> <span class="title">isDefault</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    <span class="keyword">return</span> perUserRestrictions == <span class="keyword">null</span> || perUserRestrictions.size() &lt;= <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>无参数 isDefault 方法用来判断该 ClientRestrictionState 对象是否是默认状态！</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">boolean</span> <span class="title">isDefault</span><span class="params">(<span class="keyword">boolean</span>[] array)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">if</span> (ArrayUtils.isEmpty(array)) &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">true</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">for</span> (<span class="keyword">boolean</span> value : array) &#123;</span><br><span class="line">        <span class="keyword">if</span> (value) &#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="keyword">false</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">true</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>一参数 isDefault 方法用来判断指定 ClientRestrictionState.perUserRestrictions 中指定 userId 下的用户限制是否是默认状态！</p>
<h2 id="9-4-notifyWatchersOfChange"><a href="#9-4-notifyWatchersOfChange" class="headerlink" title="9.4 notifyWatchersOfChange"></a>9.4 notifyWatchersOfChange</h2><p>当用户限制状态发生变化后，AppOpsService 会调用 notifyWatchersOfChange 通知所有监听 op 变化的监听者！</p>
<p>int code 参数表示用户限制状态发生变化的 op code！</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">notifyWatchersOfChange</span><span class="params">(<span class="keyword">int</span> code)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">final</span> ArrayList&lt;Callback&gt; clonedCallbacks;</span><br><span class="line">    <span class="comment">//【1】从 mOpModeWatchers 中获得该 op 变化后需要出发的回调列表！</span></span><br><span class="line">    <span class="keyword">synchronized</span> (<span class="keyword">this</span>) &#123;</span><br><span class="line">        ArrayList&lt;Callback&gt; callbacks = mOpModeWatchers.get(code);</span><br><span class="line">        <span class="keyword">if</span> (callbacks == <span class="keyword">null</span>) &#123;</span><br><span class="line">            <span class="keyword">return</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        clonedCallbacks = <span class="keyword">new</span> ArrayList&lt;&gt;(callbacks);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">final</span> <span class="keyword">long</span> identity = Binder.clearCallingIdentity();</span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">        <span class="keyword">final</span> <span class="keyword">int</span> callbackCount = clonedCallbacks.size();</span><br><span class="line">        <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; callbackCount; i++) &#123;</span><br><span class="line">            Callback callback = clonedCallbacks.get(i);</span><br><span class="line">            <span class="keyword">try</span> &#123;</span><br><span class="line">                <span class="comment">//【2】执行回调的 opChanged 方法！</span></span><br><span class="line">                callback.mCallback.opChanged(code, -<span class="number">1</span>, <span class="keyword">null</span>);</span><br><span class="line">            &#125; <span class="keyword">catch</span> (RemoteException e) &#123;</span><br><span class="line">                Log.w(TAG, <span class="string">"Error dispatching op op change"</span>, e);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">        Binder.restoreCallingIdentity(identity);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></div><hr></div><div class="recent-post-item article-container"><a class="article-title" href="/2017/08/25/Permission第 5 篇 - grantPermission 权限授予/">Permission第 5 篇 - grantPermission 权限授予</a><time class="post-meta__date"><i class="fa fa-calendar" aria-hidden="true"></i> 2017-08-25</time><span class="article-meta"><span class="article-meta__separator">|</span><i class="fa fa-inbox article-meta__icon" aria-hidden="true"></i><a class="article-meta__categories" href="/categories/AndroidFramework源码分析/">AndroidFramework源码分析</a><i class="fa fa-angle-right" aria-hidden="true"></i><i class="fa fa-inbox article-meta__icon" aria-hidden="true"></i><a class="article-meta__categories" href="/categories/AndroidFramework源码分析/Permission权限管理/">Permission权限管理</a></span><span class="article-meta tags"><span class="article-meta__separator">|</span><i class="fa fa-tag article-meta__icon" aria-hidden="true"></i><a class="article-meta__tags" href="/tags/Permission权限管理/">Permission权限管理</a></span><div class="content"><p>[TOC]</p>
<h1 id="0-综述"><a href="#0-综述" class="headerlink" title="0 综述"></a>0 综述</h1><p>基于 Android 7.1.1 源码，分析系统的权限管理机制！</p>
<p>本片文章总结一下权限授予的相关接口。</p>
<p>对于 dangrous 权限，应用程序需要显式的弹出弹窗，让用户主动的选择。当用户撤销或者授予时，会主动的调用！</p>
<p>但是对于 normal permission，siginature permission 以及 uri permission 都是无需弹窗申请的！</p>
<p>那么我们来看下系统中有那些和其相关的接口！</p>
<h1 id="1-grantPermission-ContextImpl"><a href="#1-grantPermission-ContextImpl" class="headerlink" title="1 grantPermission - ContextImpl"></a>1 grantPermission - ContextImpl</h1><p>在 ContextImpl 中提供了一个 grantUriPermission 方法：</p>
<h2 id="1-1-grantUriPermission"><a href="#1-1-grantUriPermission" class="headerlink" title="1.1 grantUriPermission"></a>1.1 grantUriPermission</h2><p>该方法由于是在 ContextImpl 暴露的，所以应用程序可以通过该方法 grant uri permission 给其他应用程序：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">grantUriPermission</span><span class="params">(String toPackage, Uri uri, <span class="keyword">int</span> modeFlags)</span> </span>&#123;</span><br><span class="line">     <span class="keyword">try</span> &#123;</span><br><span class="line">        <span class="comment">//【*2.1】继续授予：</span></span><br><span class="line">        ActivityManagerNative.getDefault().grantUriPermission(</span><br><span class="line">                mMainThread.getApplicationThread(), toPackage,</span><br><span class="line">                ContentProvider.getUriWithoutUserId(uri), modeFlags, resolveUserId(uri));</span><br><span class="line">    &#125; <span class="keyword">catch</span> (RemoteException e) &#123;</span><br><span class="line">        <span class="keyword">throw</span> e.rethrowFromSystemServer();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>不多说了!</p>
<h1 id="2-grantPermission-ActivityManagerService"><a href="#2-grantPermission-ActivityManagerService" class="headerlink" title="2 grantPermission - ActivityManagerService"></a>2 grantPermission - ActivityManagerService</h1><p>ActivityManagerService 内部提供了一些和 uri permission 相关的接口：</p>
<h2 id="2-1-grantUriPermission"><a href="#2-1-grantUriPermission" class="headerlink" title="2.1 grantUriPermission"></a>2.1 grantUriPermission</h2><p>授予一个 uri permisson 给 target package，这个方法授予的 permission 是一个 global permisson；</p>
<p>因为其在调用 grantUriPermissionLocked 时传入的 UriPermissionOwner owner 为 null；</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">grantUriPermission</span><span class="params">(IApplicationThread caller, String targetPkg, Uri uri,</span></span></span><br><span class="line"><span class="function"><span class="params">        <span class="keyword">final</span> <span class="keyword">int</span> modeFlags, <span class="keyword">int</span> userId)</span> </span>&#123;</span><br><span class="line">    enforceNotIsolatedCaller(<span class="string">"grantUriPermission"</span>);</span><br><span class="line">    <span class="comment">//【*2.1.1】创建了一个 GrantUri 对象！</span></span><br><span class="line">    GrantUri grantUri = <span class="keyword">new</span> GrantUri(userId, uri, <span class="keyword">false</span>);</span><br><span class="line">    <span class="keyword">synchronized</span>(<span class="keyword">this</span>) &#123;</span><br><span class="line">        <span class="keyword">final</span> ProcessRecord r = getRecordForAppLocked(caller);</span><br><span class="line">        <span class="keyword">if</span> (r == <span class="keyword">null</span>) &#123;</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> SecurityException(<span class="string">"Unable to find app for caller "</span></span><br><span class="line">                    + caller</span><br><span class="line">                    + <span class="string">" when granting permission to uri "</span> + grantUri);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">if</span> (targetPkg == <span class="keyword">null</span>) &#123;</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> IllegalArgumentException(<span class="string">"null target"</span>);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">if</span> (grantUri == <span class="keyword">null</span>) &#123;</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> IllegalArgumentException(<span class="string">"null uri"</span>);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">//【1】强制检查下 intent 的 flags 标志位！</span></span><br><span class="line">        Preconditions.checkFlagsArgument(modeFlags, Intent.FLAG_GRANT_READ_URI_PERMISSION</span><br><span class="line">                | Intent.FLAG_GRANT_WRITE_URI_PERMISSION</span><br><span class="line">                | Intent.FLAG_GRANT_PERSISTABLE_URI_PERMISSION</span><br><span class="line">                | Intent.FLAG_GRANT_PREFIX_URI_PERMISSION);</span><br><span class="line">        <span class="comment">//【*2.2】调用了另外一个方法！</span></span><br><span class="line">        grantUriPermissionLocked(r.uid, targetPkg, grantUri, modeFlags, <span class="keyword">null</span>,</span><br><span class="line">                UserHandle.getUserId(r.uid));</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h3 id="2-1-1-new-GrantUri"><a href="#2-1-1-new-GrantUri" class="headerlink" title="2.1.1 new GrantUri"></a>2.1.1 new GrantUri</h3><p>GrantUri 实例是对 uri 信息的简单封装：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> <span class="class"><span class="keyword">class</span> <span class="title">GrantUri</span> </span>&#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">final</span> <span class="keyword">int</span> sourceUserId;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">final</span> Uri uri;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">boolean</span> prefix;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="title">GrantUri</span><span class="params">(<span class="keyword">int</span> sourceUserId, Uri uri, <span class="keyword">boolean</span> prefix)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">this</span>.sourceUserId = sourceUserId;</span><br><span class="line">        <span class="keyword">this</span>.uri = uri;</span><br><span class="line">        <span class="keyword">this</span>.prefix = prefix;</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure>
<h3 id="2-1-2-跨进程调用"><a href="#2-1-2-跨进程调用" class="headerlink" title="2.1.2 跨进程调用"></a>2.1.2 跨进程调用</h3><p>ContextImpl 的 grantUriPermission 可以跨进程调用该方法：</p>
<ul>
<li><strong>ActivityManagerProxy</strong></li>
</ul>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">grantUriPermission</span><span class="params">(IApplicationThread caller, String targetPkg,</span></span></span><br><span class="line"><span class="function"><span class="params">        Uri uri, <span class="keyword">int</span> mode, <span class="keyword">int</span> userId)</span> <span class="keyword">throws</span> RemoteException </span>&#123;</span><br><span class="line">    Parcel data = Parcel.obtain();</span><br><span class="line">    Parcel reply = Parcel.obtain();</span><br><span class="line">    data.writeInterfaceToken(IActivityManager.descriptor);</span><br><span class="line">    data.writeStrongBinder(caller.asBinder());</span><br><span class="line">    data.writeString(targetPkg);</span><br><span class="line">    uri.writeToParcel(data, <span class="number">0</span>);</span><br><span class="line">    data.writeInt(mode);</span><br><span class="line">    data.writeInt(userId);</span><br><span class="line">    mRemote.transact(GRANT_URI_PERMISSION_TRANSACTION, data, reply, <span class="number">0</span>);</span><br><span class="line">    reply.readException();</span><br><span class="line">    data.recycle();</span><br><span class="line">    reply.recycle();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<ul>
<li><strong>ActivityManagerNative</strong></li>
</ul>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">case</span> GRANT_URI_PERMISSION_TRANSACTION: &#123;</span><br><span class="line">    data.enforceInterface(IActivityManager.descriptor);</span><br><span class="line">    IBinder b = data.readStrongBinder();</span><br><span class="line">    IApplicationThread app = ApplicationThreadNative.asInterface(b);</span><br><span class="line">    String targetPkg = data.readString();</span><br><span class="line">    Uri uri = Uri.CREATOR.createFromParcel(data);</span><br><span class="line">    <span class="keyword">int</span> mode = data.readInt();</span><br><span class="line">    <span class="keyword">int</span> userId = data.readInt();</span><br><span class="line">    grantUriPermission(app, targetPkg, uri, mode, userId);</span><br><span class="line">    reply.writeNoException();</span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">true</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h2 id="2-2-grantUriPermissionLocked-内部调用"><a href="#2-2-grantUriPermissionLocked-内部调用" class="headerlink" title="2.2 grantUriPermissionLocked - 内部调用"></a>2.2 grantUriPermissionLocked - 内部调用</h2><p>该方法的特点是，系统在调用时，会持有 AMS 大锁，所以此时系统进程的其他需要 AMS 大锁的线程会等待：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">grantUriPermissionLocked</span><span class="params">(<span class="keyword">int</span> callingUid, String targetPkg, GrantUri grantUri,</span></span></span><br><span class="line"><span class="function"><span class="params">        <span class="keyword">final</span> <span class="keyword">int</span> modeFlags, UriPermissionOwner owner, <span class="keyword">int</span> targetUserId)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">if</span> (targetPkg == <span class="keyword">null</span>) &#123;</span><br><span class="line">        <span class="keyword">throw</span> <span class="keyword">new</span> NullPointerException(<span class="string">"targetPkg"</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">int</span> targetUid;</span><br><span class="line">    <span class="keyword">final</span> IPackageManager pm = AppGlobals.getPackageManager();</span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">        targetUid = pm.getPackageUid(targetPkg, MATCH_DEBUG_TRIAGED_MISSING, targetUserId);</span><br><span class="line">    &#125; <span class="keyword">catch</span> (RemoteException ex) &#123;</span><br><span class="line">        <span class="keyword">return</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">//【1】检查是否需要授予 uri 权限，</span></span><br><span class="line">    targetUid = checkGrantUriPermissionLocked(callingUid, targetPkg, grantUri, modeFlags,</span><br><span class="line">            targetUid);</span><br><span class="line">    <span class="keyword">if</span> (targetUid &lt; <span class="number">0</span>) &#123;</span><br><span class="line">        <span class="keyword">return</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">//【*2.3】调用了另外一个方法！</span></span><br><span class="line">    grantUriPermissionUncheckedLocked(targetUid, targetPkg, grantUri, modeFlags,</span><br><span class="line">            owner);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>这里调用了 checkGrantUriPermissionLocked 方法，检查是否需要授予 uri 权限！</p>
<p>checkGrantUriPermissionLocked 方法会判断是否已经有 uri 权限，以及发送包含 uri 的 intent 程序是否有权限访问 uri 等等！！</p>
<p>只有发送方对 uri 有权限，接收者才能被授予权限！！</p>
<h3 id="2-2-1-调用时机"><a href="#2-2-1-调用时机" class="headerlink" title="2.2.1 调用时机"></a>2.2.1 调用时机</h3><ul>
<li>第二个是在 1.1 grantUriPermission 中调用的；</li>
<li>第二个是在 1.6 grantUriPermissionFromOwner 中调用的；</li>
</ul>
<p>该方法也是一个内部方法！</p>
<h2 id="2-3-grantUriPermissionUncheckedLocked-内部调用，核心接口"><a href="#2-3-grantUriPermissionUncheckedLocked-内部调用，核心接口" class="headerlink" title="2.3 grantUriPermissionUncheckedLocked - 内部调用，核心接口"></a>2.3 grantUriPermissionUncheckedLocked - 内部调用，核心接口</h2><p>这个方法不会做一些 check 操作，所以最好不要直接调用，默认发送方对 uri 是有权限的：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">grantUriPermissionUncheckedLocked</span><span class="params">(<span class="keyword">int</span> targetUid, String targetPkg, GrantUri grantUri,</span></span></span><br><span class="line"><span class="function"><span class="params">        <span class="keyword">final</span> <span class="keyword">int</span> modeFlags, UriPermissionOwner owner)</span> </span>&#123;</span><br><span class="line">    <span class="comment">//【1】这个方法之前有讲过，判断是否设置了和 uri 下相关的标志位！</span></span><br><span class="line">    <span class="keyword">if</span> (!Intent.isAccessUriMode(modeFlags)) &#123;</span><br><span class="line">        <span class="keyword">return</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (DEBUG_URI_PERMISSION) Slog.v(TAG_URI_PERMISSION,</span><br><span class="line">            <span class="string">"Granting "</span> + targetPkg + <span class="string">"/"</span> + targetUid + <span class="string">" permission to "</span> + grantUri);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">final</span> String authority = grantUri.uri.getAuthority();</span><br><span class="line">    <span class="comment">//【2】根据 uri 找到对应的 provider！</span></span><br><span class="line">    <span class="keyword">final</span> ProviderInfo pi = getProviderInfoLocked(authority, grantUri.sourceUserId,</span><br><span class="line">            MATCH_DEBUG_TRIAGED_MISSING);</span><br><span class="line">    <span class="keyword">if</span> (pi == <span class="keyword">null</span>) &#123;</span><br><span class="line">        Slog.w(TAG, <span class="string">"No content provider found for grant: "</span> + grantUri.toSafeString());</span><br><span class="line">        <span class="keyword">return</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">//【3】判断是否仅仅匹配 uri 前缀！</span></span><br><span class="line">    <span class="keyword">if</span> ((modeFlags &amp; Intent.FLAG_GRANT_PREFIX_URI_PERMISSION) != <span class="number">0</span>) &#123;</span><br><span class="line">        grantUri.prefix = <span class="keyword">true</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">//【*2.3.1】找到已存在或者新建的 UriPermission 实例；</span></span><br><span class="line">    <span class="keyword">final</span> UriPermission perm = findOrCreateUriPermissionLocked(</span><br><span class="line">            pi.packageName, targetPkg, targetUid, grantUri);</span><br><span class="line">    <span class="comment">//【*2.3.2】授予该权限；</span></span><br><span class="line">    perm.grantModes(modeFlags, owner);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>所以我们看到，对于 uri permission，其管理是在 AMS 中的！</p>
<h3 id="2-3-1-findOrCreateUriPermissionLocked"><a href="#2-3-1-findOrCreateUriPermissionLocked" class="headerlink" title="2.3.1 findOrCreateUriPermissionLocked"></a>2.3.1 findOrCreateUriPermissionLocked</h3><p>找到一个已存在或者新建的 UriPermission 实例：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">private</span> UriPermission <span class="title">findOrCreateUriPermissionLocked</span><span class="params">(String sourcePkg,</span></span></span><br><span class="line"><span class="function"><span class="params">        String targetPkg, <span class="keyword">int</span> targetUid, GrantUri grantUri)</span> </span>&#123;</span><br><span class="line">    <span class="comment">//【1】尝试找到 targetUid 被授予的所有 uri permission 集合</span></span><br><span class="line">    ArrayMap&lt;GrantUri, UriPermission&gt; targetUris = mGrantedUriPermissions.get(targetUid);</span><br><span class="line">    <span class="comment">//【2】如果没有的话，下面会做初始化工作！</span></span><br><span class="line">    <span class="keyword">if</span> (targetUris == <span class="keyword">null</span>) &#123;</span><br><span class="line">        targetUris = Maps.newArrayMap();</span><br><span class="line">        mGrantedUriPermissions.put(targetUid, targetUris);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">//【*2.3.1.1】同理，创建一个新的 UriPermission！</span></span><br><span class="line">    UriPermission perm = targetUris.get(grantUri);</span><br><span class="line">    <span class="keyword">if</span> (perm == <span class="keyword">null</span>) &#123;</span><br><span class="line">        perm = <span class="keyword">new</span> UriPermission(sourcePkg, targetPkg, targetUid, grantUri);</span><br><span class="line">        targetUris.put(grantUri, perm);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">//【3】返回 UriPermission 实例！</span></span><br><span class="line">    <span class="keyword">return</span> perm;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>在 ActivityManagerService 内部是有一个 mGrantedUriPermissions 数组：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//【1】用于保存所有已经被授予的 uri permissions；</span></span><br><span class="line"><span class="meta">@GuardedBy</span>(<span class="string">"this"</span>)</span><br><span class="line">        mGrantedUriPermissions = <span class="keyword">new</span> SparseArray&lt;ArrayMap&lt;GrantUri, UriPermission&gt;&gt;();</span><br></pre></td></tr></table></figure>
<p>SparseArray 的下标是被授予 uri permission 的目标 uid，值是一个 ArrayMap&lt;GrantUri, UriPermission&gt;，保存了 uri 和对应的 UriPermission 的映射关系！</p>
<h4 id="2-3-1-1-new-UriPermission"><a href="#2-3-1-1-new-UriPermission" class="headerlink" title="2.3.1.1 new UriPermission"></a>2.3.1.1 new UriPermission</h4><p>创建一个更新的 UriPermission：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">final</span> <span class="class"><span class="keyword">class</span> <span class="title">UriPermission</span> </span>&#123;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> String TAG = <span class="string">"UriPermission"</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="keyword">int</span> STRENGTH_NONE = <span class="number">0</span>;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="keyword">int</span> STRENGTH_OWNED = <span class="number">1</span>;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="keyword">int</span> STRENGTH_GLOBAL = <span class="number">2</span>;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="keyword">int</span> STRENGTH_PERSISTABLE = <span class="number">3</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">final</span> <span class="keyword">int</span> targetUserId; <span class="comment">// 目标 userId；</span></span><br><span class="line">    <span class="keyword">final</span> String sourcePkg; <span class="comment">// 源 pkg；</span></span><br><span class="line">    <span class="keyword">final</span> String targetPkg; <span class="comment">// 目标 pkg；</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">// 目标 uid，用于缓存 targetPkg 对应的 uid，不会被 persist；</span></span><br><span class="line">    <span class="keyword">final</span> <span class="keyword">int</span> targetUid;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">final</span> GrantUri uri; <span class="comment">// 对应的 uri；</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">// 允许模式，是其他四个 mode 的结合，所有的 uri permission 都要用该 mode 标志处理权限检查和授予；</span></span><br><span class="line">    <span class="keyword">int</span> modeFlags = <span class="number">0</span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 允许模式，当该模式被设置，表示该 uri permission 有非全局的显式 owner；</span></span><br><span class="line">    <span class="keyword">int</span> ownedModeFlags = <span class="number">0</span>;</span><br><span class="line">    <span class="comment">// 允许模式，当该模式被设置，表示该 uri permission 是全局 global 的；</span></span><br><span class="line">    <span class="keyword">int</span> globalModeFlags = <span class="number">0</span>;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// 允许模式，当该模式被设置，表示该 uri permission 可能需要被持久化；</span></span><br><span class="line">    <span class="keyword">int</span> persistableModeFlags = <span class="number">0</span>;</span><br><span class="line">    <span class="comment">// 允许模式，当该模式被设置，表示该 uri permission 需要被持久化；</span></span><br><span class="line">    <span class="keyword">int</span> persistedModeFlags = <span class="number">0</span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * Timestamp when &#123;<span class="doctag">@link</span> #persistedModeFlags&#125; was first defined in</span></span><br><span class="line"><span class="comment">     * &#123;<span class="doctag">@link</span> System#currentTimeMillis()&#125; time base.</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">long</span> persistedCreateTime = INVALID_TIME;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="keyword">long</span> INVALID_TIME = Long.MIN_VALUE;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> ArraySet&lt;UriPermissionOwner&gt; mReadOwners; <span class="comment">// 保存所有读权限的拥有者；</span></span><br><span class="line">    <span class="keyword">private</span> ArraySet&lt;UriPermissionOwner&gt; mWriteOwners; <span class="comment">// 保存所有写权限的拥有者；</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> String stringName;</span><br><span class="line"></span><br><span class="line">    UriPermission(String sourcePkg, String targetPkg, <span class="keyword">int</span> targetUid, GrantUri uri) &#123;</span><br><span class="line">        <span class="keyword">this</span>.targetUserId = UserHandle.getUserId(targetUid);</span><br><span class="line">        <span class="keyword">this</span>.sourcePkg = sourcePkg;</span><br><span class="line">        <span class="keyword">this</span>.targetPkg = targetPkg;</span><br><span class="line">        <span class="keyword">this</span>.targetUid = targetUid;</span><br><span class="line">        <span class="keyword">this</span>.uri = uri;</span><br><span class="line">    &#125;</span><br><span class="line">    ... ... ... ...</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>上面只是简单的介绍了下 UriPermission  内部的一些主要的属性，后面我们遇到了具体的逻辑时再分析！</p>
<h3 id="2-3-2-UriPermission-grantModes"><a href="#2-3-2-UriPermission-grantModes" class="headerlink" title="2.3.2 UriPermission.grantModes"></a>2.3.2 UriPermission.grantModes</h3><p>授予 uri permission：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">grantModes</span><span class="params">(<span class="keyword">int</span> modeFlags, UriPermissionOwner owner)</span> </span>&#123;</span><br><span class="line">    <span class="comment">//【1】判断是否需要 persist 该权限！</span></span><br><span class="line">    <span class="keyword">final</span> <span class="keyword">boolean</span> persistable = (modeFlags &amp; Intent.FLAG_GRANT_PERSISTABLE_URI_PERMISSION) != <span class="number">0</span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//【2】只保留 modeFlags 中的 FLAG_GRANT_READ_URI_PERMISSION 和 FLAG_GRANT_WRITE_URI_PERMISSION 位！</span></span><br><span class="line">    modeFlags &amp;= (Intent.FLAG_GRANT_READ_URI_PERMISSION</span><br><span class="line">            | Intent.FLAG_GRANT_WRITE_URI_PERMISSION);</span><br><span class="line"></span><br><span class="line">    <span class="comment">//【2】如果 intent 设置了 FLAG_GRANT_PERSISTABLE_URI_PERMISSION 标志位；</span></span><br><span class="line">    <span class="comment">// 说明该权限可能需要 persisit 所以设置 persistableModeFlags 标志位</span></span><br><span class="line">    <span class="keyword">if</span> (persistable) &#123;</span><br><span class="line">        persistableModeFlags |= modeFlags;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">//【3】如果 owner 为 null，那么该权限就是一个全局 uri permission！</span></span><br><span class="line">    <span class="comment">// 设置 globalModeFlags 标志位；</span></span><br><span class="line">    <span class="keyword">if</span> (owner == <span class="keyword">null</span>) &#123;</span><br><span class="line">        globalModeFlags |= modeFlags;</span><br><span class="line"></span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        <span class="comment">//【4】如果传入了指定的 owner，那么该权限就不是一个全局 uri permission！</span></span><br><span class="line">        <span class="keyword">if</span> ((modeFlags &amp; Intent.FLAG_GRANT_READ_URI_PERMISSION) != <span class="number">0</span>) &#123;</span><br><span class="line">            <span class="comment">//【*2.3.2.1】添加读权限的拥有者；</span></span><br><span class="line">            addReadOwner(owner);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">if</span> ((modeFlags &amp; Intent.FLAG_GRANT_WRITE_URI_PERMISSION) != <span class="number">0</span>) &#123;</span><br><span class="line">            <span class="comment">//【*2.3.2.2】添加写权限的拥有者；</span></span><br><span class="line">            addWriteOwner(owner);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">//【*2.3.2.3】更新 modeFlags 标志位；</span></span><br><span class="line">    updateModeFlags ();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<ul>
<li><strong>方法流程</strong>：</li>
</ul>
<p>首先，判断是否需要 persist，同时对传入的 modeFlags 作如下处理：<br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">modeFlags &amp;= (Intent.FLAG_GRANT_READ_URI_PERMISSION | Intent.FLAG_GRANT_WRITE_URI_PERMISSION);</span><br></pre></td></tr></table></figure></p>
<p>只保留 modeFlags 中的这两位，也就是说，此时，modeFlags 要么择其一，要么二者都有；</p>
<p>如果 modeFlags 需要 persistable，那么设置 persistableModeFlags；</p>
<p>接着，判断是否指定 UriPermissionOwner：</p>
<ul>
<li>如果没有，那么该权限就是 global 的，更新 globalModeFlags 标志位；</li>
<li>如果有，说明这是一个有指定 owner 的权限，那就添加到如下集合中：</li>
</ul>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">private</span> ArraySet&lt;UriPermissionOwner&gt; mReadOwners; <span class="comment">// 保存所有非全局读权限的拥有者</span></span><br><span class="line"><span class="keyword">private</span> ArraySet&lt;UriPermissionOwner&gt; mWriteOwners; <span class="comment">// 保存所有非全局写权限的拥有者</span></span><br></pre></td></tr></table></figure>
<p>同时，更新 ownedModeFlags 的标志位（只有在初始化的 mReadOwners 和 mWriteOwners，第一次添加 owner 时)</p>
<p>最后，调用 updateModeFlags 更新 modeFlags </p>
<ul>
<li><strong>总结</strong>：</li>
</ul>
<p>其实整个过程就是对传入的 modeFlags 的标志位进行一一拆解，然后保存到 ownedModeFlags | globalModeFlags | persistableModeFlags | persistedModeFlags 中，最后在 updateModeFlags 中，用这几个标志位更新 modeFlags；</p>
<h4 id="2-3-2-1-addReadOwner"><a href="#2-3-2-1-addReadOwner" class="headerlink" title="2.3.2.1 addReadOwner"></a>2.3.2.1 addReadOwner</h4><p>UriPermission 内部方法，，用于添加一个对该 uri 有非全局，读权限的拥有者；<br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">addReadOwner</span><span class="params">(UriPermissionOwner owner)</span> </span>&#123;</span><br><span class="line">    <span class="comment">//【1】初始化 mReadOwners， </span></span><br><span class="line">    <span class="keyword">if</span> (mReadOwners == <span class="keyword">null</span>) &#123;</span><br><span class="line">        mReadOwners = Sets.newArraySet();</span><br><span class="line">        <span class="comment">//【1.1】更新 ownedModeFlags 标志位；</span></span><br><span class="line">        ownedModeFlags |= Intent.FLAG_GRANT_READ_URI_PERMISSION;</span><br><span class="line">        <span class="comment">//【*2.3.2.3】ownedModeFlags 变化了，更新 modeFlags；</span></span><br><span class="line">        updateModeFlags();</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">//【2】建立相互引用关系！</span></span><br><span class="line">    <span class="keyword">if</span> (mReadOwners.add(owner)) &#123;</span><br><span class="line">        owner.addReadPermission(<span class="keyword">this</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>因为 mReadOwners 默认为 null，所以如果有最开始要初始化 mReadOwners，我们可以看到：</p>
<ul>
<li>只有在第一次初始化 mReadOwners 时，才会设置 ownedModeFlags 标志位；</li>
<li>以后在添加新的 owner 时，就不在处理了！</li>
</ul>
<h4 id="2-3-2-2-addWriteOwner"><a href="#2-3-2-2-addWriteOwner" class="headerlink" title="2.3.2.2 addWriteOwner"></a>2.3.2.2 addWriteOwner</h4><p>UriPermission 内部方法，用于添加一个对该 uri 有非全局，写权限的拥有者；</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">addWriteOwner</span><span class="params">(UriPermissionOwner owner)</span> </span>&#123;</span><br><span class="line">    <span class="comment">//【1】初始化 mWriteOwners，</span></span><br><span class="line">    <span class="keyword">if</span> (mWriteOwners == <span class="keyword">null</span>) &#123;</span><br><span class="line">        mWriteOwners = Sets.newArraySet();</span><br><span class="line">        <span class="comment">//【1.1】更新 ownedModeFlags 标志位；</span></span><br><span class="line">        ownedModeFlags |= Intent.FLAG_GRANT_WRITE_URI_PERMISSION;</span><br><span class="line">        <span class="comment">//【*2.3.2.3】ownedModeFlags 变化了，更新 modeFlags；</span></span><br><span class="line">        updateModeFlags();</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">//【2】建立相互引用关系！</span></span><br><span class="line">    <span class="keyword">if</span> (mWriteOwners.add(owner)) &#123;</span><br><span class="line">        owner.addWritePermission(<span class="keyword">this</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>因为 mWriteOwners 默认为 null，所以如果有最开始要初始化 mWriteOwners，我们可以看到：</p>
<ul>
<li>只有在第一次初始化 mWriteOwners 时，才会设置 ownedModeFlags 标志位；</li>
<li>以后在添加新的 owner 时，就不在处理了！</li>
</ul>
<h4 id="2-3-2-3-updateModeFlags"><a href="#2-3-2-3-updateModeFlags" class="headerlink" title="2.3.2.3 updateModeFlags"></a>2.3.2.3 updateModeFlags</h4><p>UriPermission 内部方法，更新 modeFlags 标志位；</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">updateModeFlags</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    <span class="keyword">final</span> <span class="keyword">int</span> oldModeFlags = modeFlags;</span><br><span class="line">    <span class="comment">//【1】可以看到，就是使用其他四个标志位更新 modeFlags！</span></span><br><span class="line">    modeFlags = ownedModeFlags | globalModeFlags | persistableModeFlags | persistedModeFlags;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (Log.isLoggable(TAG, Log.VERBOSE) &amp;&amp; (modeFlags != oldModeFlags)) &#123;</span><br><span class="line">        Slog.d(TAG,</span><br><span class="line">                <span class="string">"Permission for "</span> + targetPkg + <span class="string">" to "</span> + uri + <span class="string">" is changing from 0x"</span></span><br><span class="line">                        + Integer.toHexString(oldModeFlags) + <span class="string">" to 0x"</span></span><br><span class="line">                        + Integer.toHexString(modeFlags),</span><br><span class="line">                <span class="keyword">new</span> Throwable());</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>不多说了！</p>
<h3 id="2-3-3-调用时机"><a href="#2-3-3-调用时机" class="headerlink" title="2.3.3 调用时机"></a>2.3.3 调用时机</h3><ul>
<li>第二个是在 1.2 grantUriPermissionLocked 中调用的；</li>
<li>第二个是在 1.5 grantUriPermissionUncheckedFromIntentLocked 中调用的；</li>
</ul>
<p>可以看出，均是内部调用，因为该方法不做 check 所以，不建议直接调用；</p>
<h2 id="2-4-grantUriPermissionFromIntentLocked"><a href="#2-4-grantUriPermissionFromIntentLocked" class="headerlink" title="2.4 grantUriPermissionFromIntentLocked"></a>2.4 grantUriPermissionFromIntentLocked</h2><p>通过 intent 授予 targetPkg uri permission，该方法会先去 check 看是否需要授予权限：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">grantUriPermissionFromIntentLocked</span><span class="params">(<span class="keyword">int</span> callingUid,</span></span></span><br><span class="line"><span class="function"><span class="params">        String targetPkg, Intent intent, UriPermissionOwner owner, <span class="keyword">int</span> targetUserId)</span> </span>&#123;</span><br><span class="line">    <span class="comment">//【1】检查是否需要授予权限；</span></span><br><span class="line">    NeededUriGrants needed = checkGrantUriPermissionFromIntentLocked(callingUid, targetPkg,</span><br><span class="line">            intent, intent != <span class="keyword">null</span> ? intent.getFlags() : <span class="number">0</span>, <span class="keyword">null</span>, targetUserId);</span><br><span class="line">    <span class="keyword">if</span> (needed == <span class="keyword">null</span>) &#123;</span><br><span class="line">        <span class="comment">//【1.1】如果不需要，那就返回！</span></span><br><span class="line">        <span class="keyword">return</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">//【*2.5】进一步授予 uri pemission；</span></span><br><span class="line">    grantUriPermissionUncheckedFromIntentLocked(needed, owner);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h3 id="2-4-1-调用时机"><a href="#2-4-1-调用时机" class="headerlink" title="2.4.1 调用时机"></a>2.4.1 调用时机</h3><p>我们来看下该方法的调用时机，框架中主要的调用均是在和 activity 启动，finish，已经结果返回相关的地方：</p>
<h4 id="2-4-1-1-finishActivityResultsLocked-ActivityStack"><a href="#2-4-1-1-finishActivityResultsLocked-ActivityStack" class="headerlink" title="2.4.1.1 finishActivityResultsLocked - ActivityStack"></a>2.4.1.1 finishActivityResultsLocked - ActivityStack</h4><p>在退出一个 activity 的时候，如果我们要返回结果给启动者 activity 的时候：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">final</span> <span class="keyword">void</span> <span class="title">finishActivityResultsLocked</span><span class="params">(ActivityRecord r, <span class="keyword">int</span> resultCode, Intent resultData)</span> </span>&#123;</span><br><span class="line">    ActivityRecord resultTo = r.resultTo;</span><br><span class="line">    <span class="keyword">if</span> (resultTo != <span class="keyword">null</span>) &#123;</span><br><span class="line">        <span class="keyword">if</span> (DEBUG_RESULTS) Slog.v(TAG_RESULTS, <span class="string">"Adding result to "</span> + resultTo</span><br><span class="line">                + <span class="string">" who="</span> + r.resultWho + <span class="string">" req="</span> + r.requestCode</span><br><span class="line">                + <span class="string">" res="</span> + resultCode + <span class="string">" data="</span> + resultData);</span><br><span class="line">        <span class="keyword">if</span> (resultTo.userId != r.userId) &#123;</span><br><span class="line">            <span class="keyword">if</span> (resultData != <span class="keyword">null</span>) &#123;</span><br><span class="line">                resultData.prepareToLeaveUser(r.userId);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">//【1】关键点，判断了下启动者 acitivty 的 uid 是否大于 0；</span></span><br><span class="line">        <span class="keyword">if</span> (r.info.applicationInfo.uid &gt; <span class="number">0</span>) &#123;</span><br><span class="line">            <span class="comment">//【*2.4】授予启动者 acitivty 访问 uri 的权限，传入的 callingUid 是被启动的 activity 的 uid；</span></span><br><span class="line">            <span class="comment">//【*2.4.1.3.1】获得 activity 对应的 UriPermissionsOwner；</span></span><br><span class="line">            mService.grantUriPermissionFromIntentLocked(r.info.applicationInfo.uid,</span><br><span class="line">                    resultTo.packageName, resultData,</span><br><span class="line">                    resultTo.getUriPermissionsLocked(), resultTo.userId);</span><br><span class="line">        &#125;</span><br><span class="line">        resultTo.addResultLocked(r, r.resultWho, r.requestCode, resultCode,</span><br><span class="line">                                 resultData);</span><br><span class="line">        r.resultTo = <span class="keyword">null</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">else</span> <span class="keyword">if</span> (DEBUG_RESULTS) Slog.v(TAG_RESULTS, <span class="string">"No result destination from "</span> + r);</span><br><span class="line">    </span><br><span class="line">    r.results = <span class="keyword">null</span>;</span><br><span class="line">    r.pendingResults = <span class="keyword">null</span>;</span><br><span class="line">    r.newIntents = <span class="keyword">null</span>;</span><br><span class="line">    r.icicle = <span class="keyword">null</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h4 id="2-4-1-2-sendActivityResultLocked-ActivityStack"><a href="#2-4-1-2-sendActivityResultLocked-ActivityStack" class="headerlink" title="2.4.1.2 sendActivityResultLocked  - ActivityStack"></a>2.4.1.2 sendActivityResultLocked  - ActivityStack</h4><p>发送启动返回结果给 activity：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">sendActivityResultLocked</span><span class="params">(<span class="keyword">int</span> callingUid, ActivityRecord r,</span></span></span><br><span class="line"><span class="function"><span class="params">        String resultWho, <span class="keyword">int</span> requestCode, <span class="keyword">int</span> resultCode, Intent data)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">if</span> (callingUid &gt; <span class="number">0</span>) &#123;</span><br><span class="line">        <span class="comment">//【*2.4】授予 acitivty 访问 uri 的权限！</span></span><br><span class="line">        <span class="comment">//【*2.4.1.3.1】获得 activity 对应的 UriPermissionsOwner；</span></span><br><span class="line">        mService.grantUriPermissionFromIntentLocked(callingUid, r.packageName,</span><br><span class="line">                data, r.getUriPermissionsLocked(), r.userId);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (DEBUG_RESULTS) Slog.v(TAG, <span class="string">"Send activity result to "</span> + r</span><br><span class="line">            + <span class="string">" : who="</span> + resultWho + <span class="string">" req="</span> + requestCode</span><br><span class="line">            + <span class="string">" res="</span> + resultCode + <span class="string">" data="</span> + data);</span><br><span class="line">    <span class="keyword">if</span> (mResumedActivity == r &amp;&amp; r.app != <span class="keyword">null</span> &amp;&amp; r.app.thread != <span class="keyword">null</span>) &#123;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            ArrayList&lt;ResultInfo&gt; list = <span class="keyword">new</span> ArrayList&lt;ResultInfo&gt;();</span><br><span class="line">            list.add(<span class="keyword">new</span> ResultInfo(resultWho, requestCode,</span><br><span class="line">                    resultCode, data));</span><br><span class="line">            <span class="comment">//【1】发送启动结果！</span></span><br><span class="line">            r.app.thread.scheduleSendResult(r.appToken, list);</span><br><span class="line">            <span class="keyword">return</span>;</span><br><span class="line">        &#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">            Slog.w(TAG, <span class="string">"Exception thrown sending result to "</span> + r, e);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    r.addResultLocked(<span class="keyword">null</span>, resultWho, requestCode, resultCode, data);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>不多说了！</p>
<h4 id="2-4-1-3-deliverNewIntentLocked-ActivityRecord"><a href="#2-4-1-3-deliverNewIntentLocked-ActivityRecord" class="headerlink" title="2.4.1.3 deliverNewIntentLocked  - ActivityRecord"></a>2.4.1.3 deliverNewIntentLocked  - ActivityRecord</h4><p>该方法会拉起一个 activity 的 onNewIntent 方法：<br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">final</span> <span class="keyword">void</span> <span class="title">deliverNewIntentLocked</span><span class="params">(<span class="keyword">int</span> callingUid, Intent intent, String referrer)</span> </span>&#123;</span><br><span class="line">    <span class="comment">//【*2.4】授予要启动的 activity 访问 intent 中 uri 的权限！</span></span><br><span class="line">    <span class="comment">//【*2.4.1.3.1】获得 activity 对应的 UriPermissionsOwner</span></span><br><span class="line">    service.grantUriPermissionFromIntentLocked(callingUid, packageName,</span><br><span class="line">            intent, getUriPermissionsLocked(), userId);</span><br><span class="line">    <span class="keyword">final</span> ReferrerIntent rintent = <span class="keyword">new</span> ReferrerIntent(intent, referrer);</span><br><span class="line">    <span class="keyword">boolean</span> unsent = <span class="keyword">true</span>;</span><br><span class="line">    <span class="keyword">final</span> ActivityStack stack = task.stack;</span><br><span class="line">    <span class="keyword">final</span> <span class="keyword">boolean</span> isTopActivityInStack =</span><br><span class="line">            stack != <span class="keyword">null</span> &amp;&amp; stack.topRunningActivityLocked() == <span class="keyword">this</span>;</span><br><span class="line">    <span class="keyword">final</span> <span class="keyword">boolean</span> isTopActivityWhileSleeping =</span><br><span class="line">            service.isSleepingLocked() &amp;&amp; isTopActivityInStack;</span><br><span class="line">    <span class="keyword">if</span> ((state == ActivityState.RESUMED || state == ActivityState.PAUSED</span><br><span class="line">            || isTopActivityWhileSleeping) &amp;&amp; app != <span class="keyword">null</span> &amp;&amp; app.thread != <span class="keyword">null</span>) &#123;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            ArrayList&lt;ReferrerIntent&gt; ar = <span class="keyword">new</span> ArrayList&lt;&gt;(<span class="number">1</span>);</span><br><span class="line">            ar.add(rintent);</span><br><span class="line">            <span class="comment">//【1】拉起 onNewIntent 方法：</span></span><br><span class="line">            app.thread.scheduleNewIntent(</span><br><span class="line">                    ar, appToken, state == ActivityState.PAUSED <span class="comment">/* andPause */</span>);</span><br><span class="line">            unsent = <span class="keyword">false</span>;</span><br><span class="line">        &#125; <span class="keyword">catch</span> (RemoteException e) &#123;</span><br><span class="line">            Slog.w(TAG, <span class="string">"Exception thrown sending new intent to "</span> + <span class="keyword">this</span>, e);</span><br><span class="line">        &#125; <span class="keyword">catch</span> (NullPointerException e) &#123;</span><br><span class="line">            Slog.w(TAG, <span class="string">"Exception thrown sending new intent to "</span> + <span class="keyword">this</span>, e);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span> (unsent) &#123;</span><br><span class="line">        addNewIntentLocked(rintent);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<h5 id="2-4-1-3-1-getUriPermissionsLocked"><a href="#2-4-1-3-1-getUriPermissionsLocked" class="headerlink" title="2.4.1.3.1 getUriPermissionsLocked"></a>2.4.1.3.1 getUriPermissionsLocked</h5><p>同样的，ActivityRecord 内部也有一个 getUriPermissionsLocked 方法，用来获得其对应的 UriPermissionOwner 实例：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="function">UriPermissionOwner <span class="title">getUriPermissionsLocked</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    <span class="keyword">if</span> (uriPermissions == <span class="keyword">null</span>) &#123;</span><br><span class="line">        <span class="comment">//【*2.6.1.1】创建一个新的 UriPermissionOwner 实例！                                                               </span></span><br><span class="line">        uriPermissions = <span class="keyword">new</span> UriPermissionOwner(service, <span class="keyword">this</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> uriPermissions;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h4 id="2-4-1-4-startActivityUnchecked-ActivityStarter"><a href="#2-4-1-4-startActivityUnchecked-ActivityStarter" class="headerlink" title="2.4.1.4 startActivityUnchecked - ActivityStarter"></a>2.4.1.4 startActivityUnchecked - ActivityStarter</h4><p>在启动一个新的 acitivity 的时候：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">int</span> <span class="title">startActivityUnchecked</span><span class="params">(<span class="keyword">final</span> ActivityRecord r, ActivityRecord sourceRecord,</span></span></span><br><span class="line"><span class="function"><span class="params">        IVoiceInteractionSession voiceSession, IVoiceInteractor voiceInteractor,</span></span></span><br><span class="line"><span class="function"><span class="params">        <span class="keyword">int</span> startFlags, <span class="keyword">boolean</span> doResume, ActivityOptions options, TaskRecord inTask)</span> </span>&#123;</span><br><span class="line">    setInitialState(r, options, inTask, doResume, startFlags, sourceRecord, voiceSession,</span><br><span class="line">            voiceInteractor);</span><br><span class="line">    computeLaunchingTaskFlags();</span><br><span class="line">    computeSourceStack();</span><br><span class="line">    mIntent.setFlags(mLaunchFlags);</span><br><span class="line">    mReusedActivity = getReusableIntentActivity();</span><br><span class="line">    <span class="keyword">final</span> <span class="keyword">int</span> preferredLaunchStackId =</span><br><span class="line">            (mOptions != <span class="keyword">null</span>) ? mOptions.getLaunchStackId() : INVALID_STACK_ID;</span><br><span class="line"></span><br><span class="line">    ... ... ...</span><br><span class="line"></span><br><span class="line">    <span class="comment">//【*2.4】授予要启动的 activity 访问 intent 中 uri 的权限！</span></span><br><span class="line">    <span class="comment">//【*2.4.1.3.1】获得 activity 对应的 UriPermissionsOwner</span></span><br><span class="line">    mService.grantUriPermissionFromIntentLocked(mCallingUid, mStartActivity.packageName,</span><br><span class="line">            mIntent, mStartActivity.getUriPermissionsLocked(), mStartActivity.userId);</span><br><span class="line"></span><br><span class="line">    ... ... ...</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> START_SUCCESS;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>不多说了！</p>
<h2 id="2-5-grantUriPermissionUncheckedFromIntentLocked"><a href="#2-5-grantUriPermissionUncheckedFromIntentLocked" class="headerlink" title="2.5 grantUriPermissionUncheckedFromIntentLocked"></a>2.5 grantUriPermissionUncheckedFromIntentLocked</h2><p>通过 intent 授予 uri permission，但是该方法不会 check 是否需要授予权限，所以尽量不要直接调用这个函数；</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">grantUriPermissionUncheckedFromIntentLocked</span><span class="params">(NeededUriGrants needed,</span></span></span><br><span class="line"><span class="function"><span class="params">        UriPermissionOwner owner)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">if</span> (needed != <span class="keyword">null</span>) &#123;</span><br><span class="line">        <span class="keyword">for</span> (<span class="keyword">int</span> i=<span class="number">0</span>; i&lt;needed.size(); i++) &#123;</span><br><span class="line">            GrantUri grantUri = needed.get(i);</span><br><span class="line">            <span class="comment">//【*2.3】调用了 grantUriPermissionUncheckedLocked 方法，继续授予！</span></span><br><span class="line">            grantUriPermissionUncheckedLocked(needed.targetUid, needed.targetPkg,</span><br><span class="line">                    grantUri, needed.flags, owner);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>首先遍历所有的 GrantUri，处理每一个 GrantUri 的授予！</p>
<h3 id="2-5-1-调用时机"><a href="#2-5-1-调用时机" class="headerlink" title="2.5.1 调用时机"></a>2.5.1 调用时机</h3><h4 id="2-5-1-1-sendServiceArgsLocked"><a href="#2-5-1-1-sendServiceArgsLocked" class="headerlink" title="2.5.1.1 sendServiceArgsLocked"></a>2.5.1.1 sendServiceArgsLocked</h4><p>在我们启动 Service 的时候，我们会将启动参数 StartItems 发送给 Service：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">final</span> <span class="keyword">void</span> <span class="title">sendServiceArgsLocked</span><span class="params">(ServiceRecord r, <span class="keyword">boolean</span> execInFg,</span></span></span><br><span class="line"><span class="function"><span class="params">        <span class="keyword">boolean</span> oomAdjusted)</span> <span class="keyword">throws</span> TransactionTooLargeException </span>&#123;</span><br><span class="line">    <span class="keyword">final</span> <span class="keyword">int</span> N = r.pendingStarts.size();</span><br><span class="line">    <span class="keyword">if</span> (N == <span class="number">0</span>) &#123;</span><br><span class="line">        <span class="keyword">return</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">//【1】如果 Service 有等待处理的启动项目！</span></span><br><span class="line">    <span class="keyword">while</span> (r.pendingStarts.size() &gt; <span class="number">0</span>) &#123;</span><br><span class="line">        Exception caughtException = <span class="keyword">null</span>;</span><br><span class="line">        ServiceRecord.StartItem si = <span class="keyword">null</span>;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            si = r.pendingStarts.remove(<span class="number">0</span>);</span><br><span class="line">            <span class="keyword">if</span> (DEBUG_SERVICE) Slog.v(TAG_SERVICE, <span class="string">"Sending arguments to: "</span></span><br><span class="line">                    + r + <span class="string">" "</span> + r.intent + <span class="string">" args="</span> + si.intent);</span><br><span class="line">            <span class="keyword">if</span> (si.intent == <span class="keyword">null</span> &amp;&amp; N &gt; <span class="number">1</span>) &#123;</span><br><span class="line">                <span class="keyword">continue</span>;</span><br><span class="line">            &#125;</span><br><span class="line">            si.deliveredTime = SystemClock.uptimeMillis();</span><br><span class="line">            r.deliveredStarts.add(si);</span><br><span class="line">            si.deliveryCount++;</span><br><span class="line">            <span class="comment">//【1】关键地方是在这里，如果启动项有 neededGrants，那么会授予被启动这 uri permission！</span></span><br><span class="line">            <span class="keyword">if</span> (si.neededGrants != <span class="keyword">null</span>) &#123;</span><br><span class="line">                <span class="comment">//【*2.5】授予 uri 权限！</span></span><br><span class="line">                <span class="comment">//【*2.5.1.2】通过 StartItem 创建一个新的 UriPermissionOwner 实例！</span></span><br><span class="line">                mAm.grantUriPermissionUncheckedFromIntentLocked(si.neededGrants,</span><br><span class="line">                        si.getUriPermissionsLocked());</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="comment">//【2】超时处理；</span></span><br><span class="line">            bumpServiceExecutingLocked(r, execInFg, <span class="string">"start"</span>);</span><br><span class="line">            <span class="keyword">if</span> (!oomAdjusted) &#123;</span><br><span class="line">                oomAdjusted = <span class="keyword">true</span>;</span><br><span class="line">                mAm.updateOomAdjLocked(r.app);</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">int</span> flags = <span class="number">0</span>;</span><br><span class="line">            <span class="keyword">if</span> (si.deliveryCount &gt; <span class="number">1</span>) &#123;</span><br><span class="line">                flags |= Service.START_FLAG_RETRY;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">if</span> (si.doneExecutingCount &gt; <span class="number">0</span>) &#123;</span><br><span class="line">                flags |= Service.START_FLAG_REDELIVERY;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="comment">//【3】启动服务！</span></span><br><span class="line">            r.app.thread.scheduleServiceArgs(r, si.taskRemoved, si.id, flags, si.intent);</span><br><span class="line">        &#125; <span class="keyword">catch</span> (TransactionTooLargeException e) &#123;</span><br><span class="line">            <span class="keyword">if</span> (DEBUG_SERVICE) Slog.v(TAG_SERVICE, <span class="string">"Transaction too large: intent="</span></span><br><span class="line">                    + si.intent);</span><br><span class="line">            caughtException = e;</span><br><span class="line">        &#125; <span class="keyword">catch</span> (RemoteException e) &#123;</span><br><span class="line">            <span class="comment">// Remote process gone...  we'll let the normal cleanup take care of this.</span></span><br><span class="line">            <span class="keyword">if</span> (DEBUG_SERVICE) Slog.v(TAG_SERVICE, <span class="string">"Crashed while sending args: "</span> + r);</span><br><span class="line">            caughtException = e;</span><br><span class="line">        &#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">            Slog.w(TAG, <span class="string">"Unexpected exception"</span>, e);</span><br><span class="line">            caughtException = e;</span><br><span class="line">        &#125;</span><br><span class="line">        ... ... ... ...</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>逻辑很简单，不多说了！</p>
<h4 id="2-5-1-2-StartItem-getUriPermissionsLocked"><a href="#2-5-1-2-StartItem-getUriPermissionsLocked" class="headerlink" title="2.5.1.2 StartItem.getUriPermissionsLocked"></a>2.5.1.2 StartItem.getUriPermissionsLocked</h4><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="function">UriPermissionOwner <span class="title">getUriPermissionsLocked</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    <span class="keyword">if</span> (uriPermissions == <span class="keyword">null</span>) &#123;</span><br><span class="line">        <span class="comment">//【*2.6.1.1】新建一个 UriPermissionOwner 实例！</span></span><br><span class="line">        uriPermissions = <span class="keyword">new</span> UriPermissionOwner(sr.ams, <span class="keyword">this</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> uriPermissions;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h2 id="2-6-grantUriPermissionFromOwner"><a href="#2-6-grantUriPermissionFromOwner" class="headerlink" title="2.6 grantUriPermissionFromOwner"></a>2.6 grantUriPermissionFromOwner</h2><p>授予 UriPermissionOwner owner 访问 uri 的 permission，这里的 UriPermissionOwner 是通过 IBinder token 转换而来！</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">grantUriPermissionFromOwner</span><span class="params">(IBinder token, <span class="keyword">int</span> fromUid, String targetPkg, Uri uri,</span></span></span><br><span class="line"><span class="function"><span class="params">        <span class="keyword">final</span> <span class="keyword">int</span> modeFlags, <span class="keyword">int</span> sourceUserId, <span class="keyword">int</span> targetUserId)</span> </span>&#123;</span><br><span class="line">    <span class="comment">//【1】计算下 targetUserId！</span></span><br><span class="line">    targetUserId = mUserController.handleIncomingUser(Binder.getCallingPid(),</span><br><span class="line">            Binder.getCallingUid(), targetUserId, <span class="keyword">false</span>, ALLOW_FULL_ONLY,</span><br><span class="line">            <span class="string">"grantUriPermissionFromOwner"</span>, <span class="keyword">null</span>);</span><br><span class="line">    <span class="keyword">synchronized</span>(<span class="keyword">this</span>) &#123;</span><br><span class="line">        <span class="comment">//【*2.6.1.3】通过 token 找到对应的 UriPermissionOwner，如果没有就会抛出异常！</span></span><br><span class="line">        UriPermissionOwner owner = UriPermissionOwner.fromExternalToken(token);</span><br><span class="line">        <span class="keyword">if</span> (owner == <span class="keyword">null</span>) &#123;</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> IllegalArgumentException(<span class="string">"Unknown owner: "</span> + token);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">//【1.1】fromUid 表示该 grant 操作来自哪个 uid；</span></span><br><span class="line">        <span class="comment">// Binder.getCallingUid() 表示调用该方法的 uid，一般情况 fromUid 和 callingUid 应该是一样的；</span></span><br><span class="line">        <span class="comment">// 如果不一样，callingUid 必须是 system uid！</span></span><br><span class="line">        <span class="keyword">if</span> (fromUid != Binder.getCallingUid()) &#123;</span><br><span class="line">            <span class="keyword">if</span> (Binder.getCallingUid() != Process.myUid()) &#123;</span><br><span class="line">                <span class="keyword">throw</span> <span class="keyword">new</span> SecurityException(<span class="string">"nice try"</span>);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">if</span> (targetPkg == <span class="keyword">null</span>) &#123;</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> IllegalArgumentException(<span class="string">"null target"</span>);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">if</span> (uri == <span class="keyword">null</span>) &#123;</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> IllegalArgumentException(<span class="string">"null uri"</span>);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">//【*2.2】继续处理 grant 操作！</span></span><br><span class="line">        grantUriPermissionLocked(fromUid, targetPkg, <span class="keyword">new</span> GrantUri(sourceUserId, uri, <span class="keyword">false</span>),</span><br><span class="line">                modeFlags, owner, targetUserId);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>可以看到，grantUriPermissionFromOwner 可以提供跨进程的支持，也就是说应用程序可以通过 grantUriPermissionFromOwner 来授予其他应用 uri 权限；</p>
<p>同时，我们还看到要调用该方法，必须要存在一个 UriPermissionOwner，我们去看下如何创建一个 UriPermissionOwner：</p>
<h3 id="2-6-1-newUriPermissionOwner"><a href="#2-6-1-newUriPermissionOwner" class="headerlink" title="2.6.1 newUriPermissionOwner"></a>2.6.1 newUriPermissionOwner</h3><p>同样的，AMS 提供了一个 newUriPermissionOwner 方法，来实现创建一个新的 UriPermissionOwner，其支持跨进程调用：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> IBinder <span class="title">newUriPermissionOwner</span><span class="params">(String name)</span> </span>&#123;</span><br><span class="line">    enforceNotIsolatedCaller(<span class="string">"newUriPermissionOwner"</span>);</span><br><span class="line">    <span class="keyword">synchronized</span>(<span class="keyword">this</span>) &#123;</span><br><span class="line">        <span class="comment">//【*2.6.1.1】创建一个新的 UriPermissionOwner；</span></span><br><span class="line">        UriPermissionOwner owner = <span class="keyword">new</span> UriPermissionOwner(<span class="keyword">this</span>, name);</span><br><span class="line">        <span class="comment">//【*2.6.1.2】返回一个新的</span></span><br><span class="line">        <span class="keyword">return</span> owner.getExternalTokenLocked();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h4 id="2-6-1-1-new-UriPermissionOwner"><a href="#2-6-1-1-new-UriPermissionOwner" class="headerlink" title="2.6.1.1 new UriPermissionOwner"></a>2.6.1.1 new UriPermissionOwner</h4><p>新建一个 UriPermissionOwner 实例：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">final</span> <span class="class"><span class="keyword">class</span> <span class="title">UriPermissionOwner</span> </span>&#123;</span><br><span class="line">    <span class="keyword">final</span> ActivityManagerService service; <span class="comment">// ams 对象！</span></span><br><span class="line">    <span class="keyword">final</span> Object owner; <span class="comment">// 用于表示所有者，</span></span><br><span class="line"></span><br><span class="line">    Binder externalToken; <span class="comment">// 用于 token，跨进程的表示同一个 owner</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> ArraySet&lt;UriPermission&gt; mReadPerms; <span class="comment">// 该 owner 持有的所有的 read uri permission</span></span><br><span class="line">    <span class="keyword">private</span> ArraySet&lt;UriPermission&gt; mWritePerms; <span class="comment">// 该 owner 持有的所有的 write uri permission</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">// 内部类，用于初始化 externalToken！</span></span><br><span class="line">    <span class="class"><span class="keyword">class</span> <span class="title">ExternalToken</span> <span class="keyword">extends</span> <span class="title">Binder</span> </span>&#123;</span><br><span class="line">        <span class="function">UriPermissionOwner <span class="title">getOwner</span><span class="params">()</span> </span>&#123;</span><br><span class="line">            <span class="keyword">return</span> UriPermissionOwner.<span class="keyword">this</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    UriPermissionOwner(ActivityManagerService service, Object owner) &#123;</span><br><span class="line">        <span class="keyword">this</span>.service = service;</span><br><span class="line">        <span class="keyword">this</span>.owner = owner;</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure>
<h4 id="2-6-1-2-getExternalTokenLocked"><a href="#2-6-1-2-getExternalTokenLocked" class="headerlink" title="2.6.1.2 getExternalTokenLocked"></a>2.6.1.2 getExternalTokenLocked</h4><p>返回 UriPermissionOwner 的 Binder 对象 token：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="function">Binder <span class="title">getExternalTokenLocked</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    <span class="keyword">if</span> (externalToken == <span class="keyword">null</span>) &#123;</span><br><span class="line">        externalToken = <span class="keyword">new</span> ExternalToken();</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> externalToken;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>不多说了！</p>
<h4 id="2-6-1-3-fromExternalToken"><a href="#2-6-1-3-fromExternalToken" class="headerlink" title="2.6.1.3 fromExternalToken"></a>2.6.1.3 fromExternalToken</h4><p>UriPermissionOwner 有一个方法，通过 token 找到对应的 UriPermissionOwner 实例：<br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">static</span> UriPermissionOwner <span class="title">fromExternalToken</span><span class="params">(IBinder token)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">if</span> (token <span class="keyword">instanceof</span> ExternalToken) &#123;</span><br><span class="line">        <span class="keyword">return</span> ((ExternalToken)token).getOwner();</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">null</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>不多说了！</p>
<h3 id="2-6-2-调用时机"><a href="#2-6-2-调用时机" class="headerlink" title="2.6.2 调用时机"></a>2.6.2 调用时机</h3><p>我们来看下该方法的具体调用，用 VoiceInteraction 举个例子！</p>
<h4 id="2-6-2-1-new-VoiceInteractionSessionConnection"><a href="#2-6-2-1-new-VoiceInteractionSessionConnection" class="headerlink" title="2.6.2.1 new VoiceInteractionSessionConnection"></a>2.6.2.1 new VoiceInteractionSessionConnection</h4><p>首先，在创建 VoiceInteractionSessionConnection 时，我们为这个 ComponentName component 对应的组件创建了一个 UriPermissionOwner，并返回了其 Binder token！</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="title">VoiceInteractionSessionConnection</span><span class="params">(Object lock, ComponentName component, <span class="keyword">int</span> user,</span></span></span><br><span class="line"><span class="function"><span class="params">        Context context, Callback callback, <span class="keyword">int</span> callingUid, Handler handler)</span> </span>&#123;</span><br><span class="line">    mLock = lock;</span><br><span class="line">    mSessionComponentName = component;</span><br><span class="line">    mUser = user;</span><br><span class="line">    mContext = context;</span><br><span class="line">    mCallback = callback;</span><br><span class="line">    mCallingUid = callingUid;</span><br><span class="line">    mHandler = handler;</span><br><span class="line">    mAm = ActivityManagerNative.getDefault();</span><br><span class="line">    ... ... ...</span><br><span class="line">    IBinder permOwner = <span class="keyword">null</span>;</span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">        <span class="comment">//【1】为这个 ComponentName component 对应的组件创建了一个 UriPermissionOwner，</span></span><br><span class="line">        <span class="comment">// 并返回了其 Binder token！</span></span><br><span class="line">        permOwner = mAm.newUriPermissionOwner(<span class="string">"voicesession:"</span></span><br><span class="line">                + component.flattenToShortString());</span><br><span class="line">    &#125; <span class="keyword">catch</span> (RemoteException e) &#123;</span><br><span class="line">        Slog.w(<span class="string">"voicesession"</span>, <span class="string">"AM dead"</span>, e);</span><br><span class="line">    &#125;</span><br><span class="line">    mPermissionOwner = permOwner;</span><br><span class="line">    ... ... ...</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h4 id="2-6-2-2-deliverSessionDataLocked-VoiceInteractionSessionConnection"><a href="#2-6-2-2-deliverSessionDataLocked-VoiceInteractionSessionConnection" class="headerlink" title="2.6.2.2 deliverSessionDataLocked - VoiceInteractionSessionConnection"></a>2.6.2.2 deliverSessionDataLocked - VoiceInteractionSessionConnection</h4><p>在 VoiceInteractionSessionConnection 的 deliverSessionDataLocked 分发语音事务是，会授予 uri permission！</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">deliverSessionDataLocked</span><span class="params">(AssistDataForActivity assistDataForActivity)</span> </span>&#123;</span><br><span class="line">    Bundle assistData = assistDataForActivity.data.getBundle(</span><br><span class="line">            VoiceInteractionSession.KEY_DATA);</span><br><span class="line">    AssistStructure structure = assistDataForActivity.data.getParcelable(</span><br><span class="line">            VoiceInteractionSession.KEY_STRUCTURE);</span><br><span class="line">    AssistContent content = assistDataForActivity.data.getParcelable(</span><br><span class="line">            VoiceInteractionSession.KEY_CONTENT);</span><br><span class="line">    <span class="keyword">int</span> uid = assistDataForActivity.data.getInt(Intent.EXTRA_ASSIST_UID, -<span class="number">1</span>);</span><br><span class="line">    <span class="keyword">if</span> (uid &gt;= <span class="number">0</span> &amp;&amp; content != <span class="keyword">null</span>) &#123;</span><br><span class="line">        Intent intent = content.getIntent();</span><br><span class="line">        <span class="keyword">if</span> (intent != <span class="keyword">null</span>) &#123;</span><br><span class="line">            ClipData data = intent.getClipData();</span><br><span class="line">            <span class="keyword">if</span> (data != <span class="keyword">null</span> &amp;&amp; Intent.isAccessUriMode(intent.getFlags())) &#123;</span><br><span class="line">                <span class="comment">//【1】授予权限！</span></span><br><span class="line">                grantClipDataPermissions(data, intent.getFlags(), uid,</span><br><span class="line">                        mCallingUid, mSessionComponentName.getPackageName());</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        ClipData data = content.getClipData();</span><br><span class="line">        <span class="keyword">if</span> (data != <span class="keyword">null</span>) &#123;</span><br><span class="line">            <span class="comment">//【1】授予权限！</span></span><br><span class="line">            grantClipDataPermissions(data,</span><br><span class="line">                    Intent.FLAG_GRANT_READ_URI_PERMISSION,</span><br><span class="line">                    uid, mCallingUid, mSessionComponentName.getPackageName());</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">        mSession.handleAssist(assistData, structure, content,</span><br><span class="line">                assistDataForActivity.activityIndex, assistDataForActivity.activityCount);</span><br><span class="line">    &#125; <span class="keyword">catch</span> (RemoteException e) &#123;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>这里我们省略掉中间过程，大家可以请自去看源码：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">grantClipDataPermissions(...)  -&gt; grantClipDataItemPermission(...) -&gt; grantUriPermission(...)</span><br></pre></td></tr></table></figure>
<h4 id="2-6-2-3-grantUriPermission-VoiceInteractionSessionConnection"><a href="#2-6-2-3-grantUriPermission-VoiceInteractionSessionConnection" class="headerlink" title="2.6.2.3 grantUriPermission - VoiceInteractionSessionConnection"></a>2.6.2.3 grantUriPermission - VoiceInteractionSessionConnection</h4><p>grant 指定的 uid uri permission：<br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">grantUriPermission</span><span class="params">(Uri uri, <span class="keyword">int</span> mode, <span class="keyword">int</span> srcUid, <span class="keyword">int</span> destUid, String destPkg)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">if</span> (!<span class="string">"content"</span>.equals(uri.getScheme())) &#123;</span><br><span class="line">        <span class="keyword">return</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">long</span> ident = Binder.clearCallingIdentity();</span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">        <span class="comment">//【1】这里首先检查了 srcUid 是否已经有权限，这里我们在 check 的时候有讲过！</span></span><br><span class="line">        <span class="comment">// 如果该方法不抛出异常，那就可以 grant！</span></span><br><span class="line">        mAm.checkGrantUriPermission(srcUid, <span class="keyword">null</span>, ContentProvider.getUriWithoutUserId(uri),</span><br><span class="line">                mode, ContentProvider.getUserIdFromUri(uri, UserHandle.getUserId(srcUid)));</span><br><span class="line"></span><br><span class="line">        <span class="keyword">int</span> sourceUserId = ContentProvider.getUserIdFromUri(uri, mUser);</span><br><span class="line">        uri = ContentProvider.getUriWithoutUserId(uri);</span><br><span class="line"></span><br><span class="line">        <span class="comment">//【*1.6】授予 uri 权限！</span></span><br><span class="line">        mAm.grantUriPermissionFromOwner(mPermissionOwner, srcUid, destPkg,</span><br><span class="line">                uri, Intent.FLAG_GRANT_READ_URI_PERMISSION, sourceUserId, mUser);</span><br><span class="line">    &#125; <span class="keyword">catch</span> (RemoteException e) &#123;</span><br><span class="line">    &#125; <span class="keyword">catch</span> (SecurityException e) &#123;</span><br><span class="line">        Slog.w(TAG, <span class="string">"Can't propagate permission"</span>, e);</span><br><span class="line">    &#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">        Binder.restoreCallingIdentity(ident);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>这里传入的 mPermissionOwner 是我们前面创建的 Binder token！</p>
<h3 id="2-6-3-跨进程通信"><a href="#2-6-3-跨进程通信" class="headerlink" title="2.6.3 跨进程通信"></a>2.6.3 跨进程通信</h3><p>ActivityManagerProxy 中提供了相关的接口：</p>
<ul>
<li><strong>ActivityManagerProxy</strong></li>
</ul>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">grantUriPermissionFromOwner</span><span class="params">(IBinder owner, <span class="keyword">int</span> fromUid, String targetPkg,</span></span></span><br><span class="line"><span class="function"><span class="params">        Uri uri, <span class="keyword">int</span> mode, <span class="keyword">int</span> sourceUserId, <span class="keyword">int</span> targetUserId)</span> <span class="keyword">throws</span> RemoteException </span>&#123;</span><br><span class="line">    Parcel data = Parcel.obtain();</span><br><span class="line">    Parcel reply = Parcel.obtain();</span><br><span class="line">    data.writeInterfaceToken(IActivityManager.descriptor);</span><br><span class="line">    data.writeStrongBinder(owner);</span><br><span class="line">    data.writeInt(fromUid);</span><br><span class="line">    data.writeString(targetPkg);</span><br><span class="line">    uri.writeToParcel(data, <span class="number">0</span>);</span><br><span class="line">    data.writeInt(mode);</span><br><span class="line">    data.writeInt(sourceUserId);</span><br><span class="line">    data.writeInt(targetUserId);</span><br><span class="line">    <span class="comment">//【1】这里我改正了错误：</span></span><br><span class="line">    mRemote.transact(GRANT_URI_PERMISSION_FROM_OWNER_TRANSACTION, data, reply, <span class="number">0</span>);</span><br><span class="line">    reply.readException();</span><br><span class="line">    data.recycle();</span><br><span class="line">    reply.recycle();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>7.1.1 的源码有一个问题：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">GRANT_URI_PERMISSION_FROM_OWNER_TRANSACTION 被写成了 GRANT_URI_PERMISSION_TRANSACTION</span><br></pre></td></tr></table></figure>
<p>我个人觉得是一个错误！</p>
<ul>
<li><strong>ActivityManagerNative</strong></li>
</ul>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">case</span> GRANT_URI_PERMISSION_FROM_OWNER_TRANSACTION: &#123;</span><br><span class="line">    data.enforceInterface(IActivityManager.descriptor);</span><br><span class="line">    IBinder owner = data.readStrongBinder();</span><br><span class="line">    <span class="keyword">int</span> fromUid = data.readInt();</span><br><span class="line">    String targetPkg = data.readString();</span><br><span class="line">    Uri uri = Uri.CREATOR.createFromParcel(data);</span><br><span class="line">    <span class="keyword">int</span> mode = data.readInt();</span><br><span class="line">    <span class="keyword">int</span> sourceUserId = data.readInt();</span><br><span class="line">    <span class="keyword">int</span> targetUserId = data.readInt();</span><br><span class="line">    grantUriPermissionFromOwner(owner, fromUid, targetPkg, uri, mode, sourceUserId,</span><br><span class="line">            targetUserId);</span><br><span class="line">    reply.writeNoException();</span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">true</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h1 id="3-grantPermission-PackageManagerService"><a href="#3-grantPermission-PackageManagerService" class="headerlink" title="3 grantPermission - PackageManagerService"></a>3 grantPermission - PackageManagerService</h1><p>权限的授予核心接口是在 PackageManagerService 中，包括运行时和安装时权限：</p>
<h2 id="3-1-grantPermissionsLPw-权限更新时调用重新授予"><a href="#3-1-grantPermissionsLPw-权限更新时调用重新授予" class="headerlink" title="3.1 grantPermissionsLPw - 权限更新时调用重新授予"></a>3.1 grantPermissionsLPw - 权限更新时调用重新授予</h2><p>在更新过权限后，会再次授予应用权限，因为可能有些权限已经失效并且被移除！</p>
<p>这里的 replace 为 true，由于我们是更新所有的 pacakge，所以 packageOfInterest 均为 null，参数 pkg 是需要更新权限授予信息的应用！</p>
<p>该方法主要是在 updatePermissionsLPw 方法</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br><span class="line">212</span><br><span class="line">213</span><br><span class="line">214</span><br><span class="line">215</span><br><span class="line">216</span><br><span class="line">217</span><br><span class="line">218</span><br><span class="line">219</span><br><span class="line">220</span><br><span class="line">221</span><br><span class="line">222</span><br><span class="line">223</span><br><span class="line">224</span><br><span class="line">225</span><br><span class="line">226</span><br><span class="line">227</span><br><span class="line">228</span><br><span class="line">229</span><br><span class="line">230</span><br><span class="line">231</span><br><span class="line">232</span><br><span class="line">233</span><br><span class="line">234</span><br><span class="line">235</span><br><span class="line">236</span><br><span class="line">237</span><br><span class="line">238</span><br><span class="line">239</span><br><span class="line">240</span><br><span class="line">241</span><br><span class="line">242</span><br><span class="line">243</span><br><span class="line">244</span><br><span class="line">245</span><br><span class="line">246</span><br><span class="line">247</span><br><span class="line">248</span><br><span class="line">249</span><br><span class="line">250</span><br><span class="line">251</span><br><span class="line">252</span><br><span class="line">253</span><br><span class="line">254</span><br><span class="line">255</span><br><span class="line">256</span><br><span class="line">257</span><br><span class="line">258</span><br><span class="line">259</span><br><span class="line">260</span><br><span class="line">261</span><br><span class="line">262</span><br><span class="line">263</span><br><span class="line">264</span><br><span class="line">265</span><br><span class="line">266</span><br><span class="line">267</span><br><span class="line">268</span><br><span class="line">269</span><br><span class="line">270</span><br><span class="line">271</span><br><span class="line">272</span><br><span class="line">273</span><br><span class="line">274</span><br><span class="line">275</span><br><span class="line">276</span><br><span class="line">277</span><br><span class="line">278</span><br><span class="line">279</span><br><span class="line">280</span><br><span class="line">281</span><br><span class="line">282</span><br><span class="line">283</span><br><span class="line">284</span><br><span class="line">285</span><br><span class="line">286</span><br><span class="line">287</span><br><span class="line">288</span><br><span class="line">289</span><br><span class="line">290</span><br><span class="line">291</span><br><span class="line">292</span><br><span class="line">293</span><br><span class="line">294</span><br><span class="line">295</span><br><span class="line">296</span><br><span class="line">297</span><br><span class="line">298</span><br><span class="line">299</span><br><span class="line">300</span><br><span class="line">301</span><br><span class="line">302</span><br><span class="line">303</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">grantPermissionsLPw</span><span class="params">(PackageParser.Package pkg, <span class="keyword">boolean</span> replace,</span></span></span><br><span class="line"><span class="function"><span class="params">        String packageOfInterest)</span> </span>&#123;</span><br><span class="line">    <span class="comment">//【1】如果该应用的 PackageSetting 没有，那么不处理！</span></span><br><span class="line">    <span class="keyword">final</span> PackageSetting ps = (PackageSetting) pkg.mExtras;</span><br><span class="line">    <span class="keyword">if</span> (ps == <span class="keyword">null</span>) &#123;</span><br><span class="line">        <span class="keyword">return</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    Trace.traceBegin(TRACE_TAG_PACKAGE_MANAGER, <span class="string">"grantPermissions"</span>);</span><br><span class="line">    </span><br><span class="line">    <span class="comment">//【2】获得该 package 的权限管理对象，此时这个权限管理对象是解析上次安装信息时恢复的！</span></span><br><span class="line">    <span class="comment">// 我们将其保存到 origPermissions 中，作为原始数据！</span></span><br><span class="line">    PermissionsState permissionsState = ps.getPermissionsState();</span><br><span class="line">    PermissionsState origPermissions = permissionsState;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">final</span> <span class="keyword">int</span>[] currentUserIds = UserManagerService.getInstance().getUserIds();</span><br><span class="line"></span><br><span class="line">    <span class="keyword">boolean</span> runtimePermissionsRevoked = <span class="keyword">false</span>;</span><br><span class="line">    <span class="keyword">int</span>[] changedRuntimePermissionUserIds = EMPTY_INT_ARRAY;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">boolean</span> changedInstallPermission = <span class="keyword">false</span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//【3】如果 replace 的值为 true，进入这里！</span></span><br><span class="line">    <span class="keyword">if</span> (replace) &#123;</span><br><span class="line">        <span class="comment">// 设置 installPermissionsFixed 为 true，因为下面会对权限信息调整！</span></span><br><span class="line">        ps.installPermissionsFixed = <span class="keyword">false</span>;</span><br><span class="line">        <span class="keyword">if</span> (!ps.isSharedUser()) &#123;</span><br><span class="line">            <span class="comment">//【3.1】如果该 package 不是共享 uid 的，那就重置 permissionsState，但是会将</span></span><br><span class="line">            <span class="comment">// 原始信息 copy到 origPermissions 中！</span></span><br><span class="line">            origPermissions = <span class="keyword">new</span> PermissionsState(permissionsState);</span><br><span class="line">            permissionsState.reset();</span><br><span class="line"></span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            <span class="comment">//【3.2】如果该 package 是共享 uid 的，那么我们会拒绝那些不用的共享 uid 相关权限信息！</span></span><br><span class="line">            changedRuntimePermissionUserIds = revokeUnusedSharedUserPermissionsLPw(</span><br><span class="line">                    ps.sharedUser, UserManagerService.getInstance().getUserIds());</span><br><span class="line">            <span class="keyword">if</span> (!ArrayUtils.isEmpty(changedRuntimePermissionUserIds)) &#123;</span><br><span class="line">                runtimePermissionsRevoked = <span class="keyword">true</span>;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    permissionsState.setGlobalGids(mGlobalGids);</span><br><span class="line"></span><br><span class="line">    <span class="comment">//【4】处理该 package 请求的所有权限！</span></span><br><span class="line">    <span class="keyword">final</span> <span class="keyword">int</span> N = pkg.requestedPermissions.size();</span><br><span class="line">    <span class="keyword">for</span> (<span class="keyword">int</span> i=<span class="number">0</span>; i &lt; N; i++) &#123;</span><br><span class="line">        <span class="keyword">final</span> String name = pkg.requestedPermissions.get(i);</span><br><span class="line">        <span class="keyword">final</span> BasePermission bp = mSettings.mPermissions.get(name);</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (DEBUG_INSTALL) &#123;</span><br><span class="line">            Log.i(TAG, <span class="string">"Package "</span> + pkg.packageName + <span class="string">" checking "</span> + name + <span class="string">": "</span> + bp);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">//【4.1】如果该权限没有定义，那么跳过！！</span></span><br><span class="line">        <span class="keyword">if</span> (bp == <span class="keyword">null</span> || bp.packageSetting == <span class="keyword">null</span>) &#123;</span><br><span class="line">            <span class="keyword">if</span> (packageOfInterest == <span class="keyword">null</span> || packageOfInterest.equals(pkg.packageName)) &#123;</span><br><span class="line">                Slog.w(TAG, <span class="string">"Unknown permission "</span> + name</span><br><span class="line">                        + <span class="string">" in package "</span> + pkg.packageName);</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">continue</span>;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">final</span> String perm = bp.name;</span><br><span class="line">        <span class="keyword">boolean</span> allowedSig = <span class="keyword">false</span>;</span><br><span class="line">        <span class="keyword">int</span> grant = GRANT_DENIED; <span class="comment">// 用于保存每个权限的授予情况！</span></span><br><span class="line"></span><br><span class="line">        <span class="comment">//【4.2】如果申请的权限设置了 PROTECTION_FLAG_APPOP 标志位，</span></span><br><span class="line">        <span class="comment">// 我们会将其添加到 mAppOpPermissionPackages 进行监控！</span></span><br><span class="line">        <span class="keyword">if</span> ((bp.protectionLevel &amp; PermissionInfo.PROTECTION_FLAG_APPOP) != <span class="number">0</span>) &#123;</span><br><span class="line">            ArraySet&lt;String&gt; pkgs = mAppOpPermissionPackages.get(bp.name);</span><br><span class="line">            <span class="keyword">if</span> (pkgs == <span class="keyword">null</span>) &#123;</span><br><span class="line">                pkgs = <span class="keyword">new</span> ArraySet&lt;&gt;();</span><br><span class="line">                mAppOpPermissionPackages.put(bp.name, pkgs);</span><br><span class="line">            &#125;</span><br><span class="line">            pkgs.add(pkg.packageName);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment">//【4.3】计算权限的基本类型，并判断应用是否支持运行时权限！！！</span></span><br><span class="line">        <span class="keyword">final</span> <span class="keyword">int</span> level = bp.protectionLevel &amp; PermissionInfo.PROTECTION_MASK_BASE;</span><br><span class="line">        <span class="keyword">final</span> <span class="keyword">boolean</span> appSupportsRuntimePermissions = pkg.applicationInfo.targetSdkVersion</span><br><span class="line">                &gt;= Build.VERSION_CODES.M;</span><br><span class="line"></span><br><span class="line">        <span class="comment">//【4.4】根据权限的基本类型，判断权限的授予情况！！</span></span><br><span class="line">        <span class="keyword">switch</span> (level) &#123;</span><br><span class="line">            <span class="keyword">case</span> PermissionInfo.PROTECTION_NORMAL: &#123; </span><br><span class="line">                <span class="comment">//【4.4.1】基本类型为 normal，为安装时权限，默认授予！</span></span><br><span class="line">                grant = GRANT_INSTALL;</span><br><span class="line">            &#125; <span class="keyword">break</span>;</span><br><span class="line"></span><br><span class="line">            <span class="keyword">case</span> PermissionInfo.PROTECTION_DANGEROUS: &#123;</span><br><span class="line">                <span class="comment">//【4.4.2】基本类型为 dangerous，那么我们要分不同的情况！！</span></span><br><span class="line">                <span class="keyword">if</span> (!appSupportsRuntimePermissions &amp;&amp; !Build.PERMISSIONS_REVIEW_REQUIRED) &#123;</span><br><span class="line">                    <span class="comment">//【4.4.2.1】如果 legacy apps，同时也不需要在组件启动之前重新 review 权限</span></span><br><span class="line">                    <span class="comment">// 说明应用的 targetSDKVersion &lt; 23 是 legacy apps，那么运行时权限视为安装时权限；</span></span><br><span class="line">                    grant = GRANT_INSTALL;</span><br><span class="line">                    </span><br><span class="line">                &#125; <span class="keyword">else</span> <span class="keyword">if</span> (origPermissions.hasInstallPermission(bp.name)) &#123;</span><br><span class="line">                    <span class="comment">//【4.4.2.2】如果应用支持安装是权限，或者需要在组件启动之前重新 review 权限</span></span><br><span class="line">                    <span class="comment">// 并且该运行时权限之前是属于安装时权限，那么就要升级为运行时权限（系统升级会出现）</span></span><br><span class="line">                    grant = GRANT_UPGRADE;</span><br><span class="line">                    </span><br><span class="line">                &#125; <span class="keyword">else</span> <span class="keyword">if</span> (mPromoteSystemApps</span><br><span class="line">                        &amp;&amp; isSystemApp(ps)</span><br><span class="line">                        &amp;&amp; mExistingSystemPackages.contains(ps.name)) &#123;</span><br><span class="line">                    <span class="comment">//【4.4.2.3】如果是从 API 22 升级上来的话，对于 Promote System Apps，</span></span><br><span class="line">                    <span class="comment">// 那么安装时权限就要升级为运行时权限；</span></span><br><span class="line">                    grant = GRANT_UPGRADE;</span><br><span class="line">                    </span><br><span class="line">                &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                    <span class="comment">//【4.4.2.4】其他情况，直接视为安装时权限！</span></span><br><span class="line">                    grant = GRANT_RUNTIME;</span><br><span class="line">                    </span><br><span class="line">                &#125;</span><br><span class="line">            &#125; <span class="keyword">break</span>;</span><br><span class="line"></span><br><span class="line">            <span class="keyword">case</span> PermissionInfo.PROTECTION_SIGNATURE: &#123;</span><br><span class="line">                <span class="comment">//【4.4.3】基本类型为 signature 的权限，需要校验签名！！</span></span><br><span class="line">                <span class="comment">//【*1.2.2-important】校验签名是否匹配，如果是的话，是为安装时权限！</span></span><br><span class="line">                allowedSig = grantSignaturePermission(perm, pkg, bp, origPermissions);</span><br><span class="line">                <span class="keyword">if</span> (allowedSig) &#123;</span><br><span class="line">                    <span class="comment">// 如果签名校验通过，直接视为安装时权限！</span></span><br><span class="line">                    grant = GRANT_INSTALL;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125; <span class="keyword">break</span>;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (DEBUG_INSTALL) &#123;</span><br><span class="line">            Log.i(TAG, <span class="string">"Package "</span> + pkg.packageName + <span class="string">" granting "</span> + perm);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment">//【4.5】处理授予情况，如果授予情况不是拒绝 GRANT_DENIED，进入 IF 分支；</span></span><br><span class="line">        <span class="comment">// 如果授予情况是拒绝 GRANT_DENIED，进入 ELSE 分支！</span></span><br><span class="line">        <span class="keyword">if</span> (grant != GRANT_DENIED) &#123;</span><br><span class="line">            <span class="keyword">if</span> (!isSystemApp(ps) &amp;&amp; ps.installPermissionsFixed) &#123;</span><br><span class="line">                <span class="comment">//【4.5.1】如果这是一个已经被安装了的非系统的应用，同时本次申请的权限之前不属于安装时权限</span></span><br><span class="line">                <span class="comment">// 除非该权限属于 new platform permission 不然的话，我们是不会授予他这个权限的；</span></span><br><span class="line">                <span class="keyword">if</span> (!allowedSig &amp;&amp; !origPermissions.hasInstallPermission(perm)) &#123;</span><br><span class="line">                    <span class="keyword">if</span> (!isNewPlatformPermissionForPackage(perm, pkg)) &#123;</span><br><span class="line">                        grant = GRANT_DENIED;</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="comment">//【4.5.2】处理权限的授予状态！</span></span><br><span class="line">            <span class="keyword">switch</span> (grant) &#123;</span><br><span class="line">                <span class="keyword">case</span> GRANT_INSTALL: &#123; <span class="comment">// 处理安装时权限；</span></span><br><span class="line">                    <span class="comment">//【4.5.2.1.1】首先，判断该权限之前是否是运行时权限，如果是的话，那就要撤销之前的授予！</span></span><br><span class="line">                    <span class="keyword">for</span> (<span class="keyword">int</span> userId : UserManagerService.getInstance().getUserIds()) &#123;</span><br><span class="line">                        <span class="keyword">if</span> (origPermissions.getRuntimePermissionState(</span><br><span class="line">                                bp.name, userId) != <span class="keyword">null</span>) &#123;</span><br><span class="line">                            <span class="comment">// 撤销权限，并取消所有的标志位；</span></span><br><span class="line">                            origPermissions.revokeRuntimePermission(bp, userId);</span><br><span class="line">                            origPermissions.updatePermissionFlags(bp, userId,</span><br><span class="line">                                  PackageManager.MASK_PERMISSION_FLAGS, <span class="number">0</span>);</span><br><span class="line">                            <span class="comment">// 将运行时权限授予状态发生变化的 userId 记录下来，后面用于持久化数据！</span></span><br><span class="line">                            changedRuntimePermissionUserIds = ArrayUtils.appendInt(</span><br><span class="line">                                    changedRuntimePermissionUserIds, userId);</span><br><span class="line">                        &#125;</span><br><span class="line">                    &#125;</span><br><span class="line">                    <span class="comment">//【4.5.2.1.2】授予安装时权限；</span></span><br><span class="line">                    <span class="keyword">if</span> (permissionsState.grantInstallPermission(bp) !=</span><br><span class="line">                            PermissionsState.PERMISSION_OPERATION_FAILURE) &#123;</span><br><span class="line">                        changedInstallPermission = <span class="keyword">true</span>;</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125; <span class="keyword">break</span>;</span><br><span class="line"></span><br><span class="line">                <span class="keyword">case</span> GRANT_RUNTIME: &#123; <span class="comment">// 处理运行时权限；</span></span><br><span class="line">                    <span class="comment">//【4.5.2.1.3】授予之前被授予的运行时权限；</span></span><br><span class="line">                    <span class="keyword">for</span> (<span class="keyword">int</span> userId : UserManagerService.getInstance().getUserIds()) &#123;</span><br><span class="line">                        <span class="comment">//【4.5.2.1.3.1】获得每个 userId 下的该运行时权限对象和其 flags；</span></span><br><span class="line">                        PermissionState permissionState = origPermissions</span><br><span class="line">                                .getRuntimePermissionState(bp.name, userId);</span><br><span class="line">                        <span class="keyword">int</span> flags = permissionState != <span class="keyword">null</span></span><br><span class="line">                                ? permissionState.getFlags() : <span class="number">0</span>;</span><br><span class="line">                        </span><br><span class="line">                        <span class="comment">//【4.5.2.1.3.2】如果本次授予的权限是已经申请的，那么我们就再次授予！</span></span><br><span class="line">                        <span class="keyword">if</span> (origPermissions.hasRuntimePermission(bp.name, userId)) &#123;</span><br><span class="line">                            <span class="comment">//【4.5.2.1.3.2.1】授予运行时权限，如果失败的话，意味着本次无法授予，那就更新</span></span><br><span class="line">                            <span class="comment">// changedRuntimePermissionUserIds 列表；</span></span><br><span class="line">                            <span class="keyword">if</span> (permissionsState.grantRuntimePermission(bp, userId) ==</span><br><span class="line">                                    PermissionsState.PERMISSION_OPERATION_FAILURE) &#123;</span><br><span class="line">                                changedRuntimePermissionUserIds = ArrayUtils.appendInt(</span><br><span class="line">                                        changedRuntimePermissionUserIds, userId);</span><br><span class="line">                            &#125;</span><br><span class="line">                            <span class="comment">//【4.5.2.1.3.2.2】如果应用支持运行时权限，该权限之前是需要 review 的</span></span><br><span class="line">                            <span class="comment">// 那么这里会取消 review 的标志位！</span></span><br><span class="line">                            <span class="keyword">if</span> (Build.PERMISSIONS_REVIEW_REQUIRED</span><br><span class="line">                                    &amp;&amp; appSupportsRuntimePermissions</span><br><span class="line">                                    &amp;&amp; (flags &amp; PackageManager</span><br><span class="line">                                            .FLAG_PERMISSION_REVIEW_REQUIRED) != <span class="number">0</span>) &#123;</span><br><span class="line">                                flags &amp;= ~PackageManager.FLAG_PERMISSION_REVIEW_REQUIRED;</span><br><span class="line">                                <span class="comment">// 标志位变了，那就更新 changedRuntimePermissionUserIds 列表；</span></span><br><span class="line">                                changedRuntimePermissionUserIds = ArrayUtils.appendInt(</span><br><span class="line">                                        changedRuntimePermissionUserIds, userId);</span><br><span class="line">                            &#125;</span><br><span class="line"></span><br><span class="line">                        &#125; <span class="keyword">else</span> <span class="keyword">if</span> (Build.PERMISSIONS_REVIEW_REQUIRED</span><br><span class="line">                                &amp;&amp; !appSupportsRuntimePermissions) &#123;</span><br><span class="line">                            <span class="comment">//【4.5.2.1.3.2】如果应用不支持运行时权限，但是系统需要权限 review</span></span><br><span class="line">                            <span class="comment">// 每一个被授予的新的运行时权限，都要被 review！</span></span><br><span class="line">                            <span class="comment">// 如果是系统权限，强制增加 FLAG_PERMISSION_REVIEW_REQUIRED 标志位</span></span><br><span class="line">                            <span class="keyword">if</span> (PLATFORM_PACKAGE_NAME.equals(bp.sourcePackage)) &#123;</span><br><span class="line">                                <span class="keyword">if</span> ((flags &amp; FLAG_PERMISSION_REVIEW_REQUIRED) == <span class="number">0</span>) &#123;</span><br><span class="line">                                    flags |= FLAG_PERMISSION_REVIEW_REQUIRED;</span><br><span class="line">                                    <span class="comment">// 标志位变了，那就更新 changedRuntimePermissionUserIds 列表；</span></span><br><span class="line">                                    changedRuntimePermissionUserIds = ArrayUtils.appendInt(</span><br><span class="line">                                            changedRuntimePermissionUserIds, userId);</span><br><span class="line">                                &#125;</span><br><span class="line">                            &#125;</span><br><span class="line">                            <span class="comment">// 授予这个新的运行时权限，如果授予失败，更新 changedRuntimePermissionUserIds 列表；</span></span><br><span class="line">                            <span class="keyword">if</span> (permissionsState.grantRuntimePermission(bp, userId)</span><br><span class="line">                                    != PermissionsState.PERMISSION_OPERATION_FAILURE) &#123;</span><br><span class="line">                                changedRuntimePermissionUserIds = ArrayUtils.appendInt(</span><br><span class="line">                                        changedRuntimePermissionUserIds, userId);</span><br><span class="line">                            &#125;</span><br><span class="line">                        &#125;</span><br><span class="line">                        <span class="comment">//【4.5.2.1.3.2.1】更新权限的 flags！</span></span><br><span class="line">                        permissionsState.updatePermissionFlags(bp, userId, flags, flags);</span><br><span class="line"></span><br><span class="line">                    &#125;</span><br><span class="line">                &#125; <span class="keyword">break</span>;</span><br><span class="line"></span><br><span class="line">                <span class="keyword">case</span> GRANT_UPGRADE: &#123; <span class="comment">// 处理安装时权限升级为运行时权限</span></span><br><span class="line">                    <span class="comment">//【4.5.2.1.4】授予安装时升级为运行时的权限；</span></span><br><span class="line">                    <span class="comment">// 获得权限管理对象和 flags；</span></span><br><span class="line">                    PermissionState permissionState = origPermissions</span><br><span class="line">                            .getInstallPermissionState(bp.name);</span><br><span class="line">                    <span class="keyword">final</span> <span class="keyword">int</span> flags = permissionState != <span class="keyword">null</span> ? permissionState.getFlags() : <span class="number">0</span>;</span><br><span class="line"></span><br><span class="line">                    <span class="comment">//【4.5.2.1.4.1】撤销之前的安装时权限，并清空 flags；</span></span><br><span class="line">                    <span class="keyword">if</span> (origPermissions.revokeInstallPermission(bp)</span><br><span class="line">                            != PermissionsState.PERMISSION_OPERATION_FAILURE) &#123;</span><br><span class="line">                        origPermissions.updatePermissionFlags(bp, UserHandle.USER_ALL,</span><br><span class="line">                                PackageManager.MASK_PERMISSION_FLAGS, <span class="number">0</span>);</span><br><span class="line">                        changedInstallPermission = <span class="keyword">true</span>;</span><br><span class="line">                    &#125;</span><br><span class="line"></span><br><span class="line">                    <span class="comment">//【4.5.2.1.4.2】如果该权限没有设置 FLAG_PERMISSION_REVOKE_ON_UPGRADE，</span></span><br><span class="line">                    <span class="comment">// 表示在升级后可以授予，那么我们就授予运行时权限；</span></span><br><span class="line">                    <span class="keyword">if</span> ((flags &amp; PackageManager.FLAG_PERMISSION_REVOKE_ON_UPGRADE) == <span class="number">0</span>) &#123;</span><br><span class="line">                        <span class="keyword">for</span> (<span class="keyword">int</span> userId : currentUserIds) &#123;</span><br><span class="line">                            <span class="keyword">if</span> (permissionsState.grantRuntimePermission(bp, userId) !=</span><br><span class="line">                                    PermissionsState.PERMISSION_OPERATION_FAILURE) &#123;</span><br><span class="line">                                <span class="comment">// 将旧的 flags 更新到运行时权限；</span></span><br><span class="line">                                permissionsState.updatePermissionFlags(bp, userId,</span><br><span class="line">                                        flags, flags);</span><br><span class="line">                                <span class="comment">// 标志位变了，那就更新 changedRuntimePermissionUserIds 列表；</span></span><br><span class="line">                                changedRuntimePermissionUserIds = ArrayUtils.appendInt(</span><br><span class="line">                                        changedRuntimePermissionUserIds, userId);</span><br><span class="line">                            &#125;</span><br><span class="line">                        &#125;</span><br><span class="line">                    &#125;</span><br><span class="line"></span><br><span class="line">                &#125; <span class="keyword">break</span>;</span><br><span class="line"></span><br><span class="line">                <span class="keyword">default</span>: &#123;</span><br><span class="line">                    <span class="keyword">if</span> (packageOfInterest == <span class="keyword">null</span></span><br><span class="line">                            || packageOfInterest.equals(pkg.packageName)) &#123;</span><br><span class="line">                        Slog.w(TAG, <span class="string">"Not granting permission "</span> + perm</span><br><span class="line">                                + <span class="string">" to package "</span> + pkg.packageName</span><br><span class="line">                                + <span class="string">" because it was previously installed without"</span>);</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125; <span class="keyword">break</span>;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            <span class="comment">//【4.6】处理撤销情况，撤销该权限，同时清空所有的标志位；</span></span><br><span class="line">            <span class="keyword">if</span> (permissionsState.revokeInstallPermission(bp) !=</span><br><span class="line">                    PermissionsState.PERMISSION_OPERATION_FAILURE) &#123;</span><br><span class="line">                <span class="comment">// 清空标志位；</span></span><br><span class="line">                permissionsState.updatePermissionFlags(bp, UserHandle.USER_ALL,</span><br><span class="line">                        PackageManager.MASK_PERMISSION_FLAGS, <span class="number">0</span>);</span><br><span class="line">                changedInstallPermission = <span class="keyword">true</span>;</span><br><span class="line">                Slog.i(TAG, <span class="string">"Un-granting permission "</span> + perm</span><br><span class="line">                        + <span class="string">" from package "</span> + pkg.packageName</span><br><span class="line">                        + <span class="string">" (protectionLevel="</span> + bp.protectionLevel</span><br><span class="line">                        + <span class="string">" flags=0x"</span> + Integer.toHexString(pkg.applicationInfo.flags)</span><br><span class="line">                        + <span class="string">")"</span>);</span><br><span class="line">            &#125; <span class="keyword">else</span> <span class="keyword">if</span> ((bp.protectionLevel&amp;PermissionInfo.PROTECTION_FLAG_APPOP) == <span class="number">0</span>) &#123;</span><br><span class="line">                <span class="comment">//【4.6.1】如果撤销失败，但是该权限和一个 appOp 相关联，这种情况可以不处理。因为</span></span><br><span class="line">                <span class="comment">// 对于这类权限，我们不处理，因为我们会通过 appOps 进行控制，通过 ui 给用户选择；</span></span><br><span class="line">                <span class="keyword">if</span> (packageOfInterest == <span class="keyword">null</span> || packageOfInterest.equals(pkg.packageName)) &#123;</span><br><span class="line">                    Slog.w(TAG, <span class="string">"Not granting permission "</span> + perm</span><br><span class="line">                            + <span class="string">" to package "</span> + pkg.packageName</span><br><span class="line">                            + <span class="string">" (protectionLevel="</span> + bp.protectionLevel</span><br><span class="line">                            + <span class="string">" flags=0x"</span> + Integer.toHexString(pkg.applicationInfo.flags)</span><br><span class="line">                            + <span class="string">")"</span>);</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span> ((changedInstallPermission || replace) &amp;&amp; !ps.installPermissionsFixed &amp;&amp;</span><br><span class="line">            !isSystemApp(ps) || isUpdatedSystemApp(ps))&#123;</span><br><span class="line">        <span class="comment">// 这是我们第一次听说过这个包，所以我们现在选择的权限是固定的，直到明确更改为止。</span></span><br><span class="line">        <span class="comment">// 没看懂这段逻辑...</span></span><br><span class="line">        ps.installPermissionsFixed = <span class="keyword">true</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//【5】持久化变化调整后的运行时权限数据！</span></span><br><span class="line">    <span class="keyword">for</span> (<span class="keyword">int</span> userId : changedRuntimePermissionUserIds) &#123;</span><br><span class="line">        mSettings.writeRuntimePermissionsForUserLPr(userId, runtimePermissionsRevoked);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    Trace.traceEnd(TRACE_TAG_PACKAGE_MANAGER);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h3 id="3-2-1-grantSignaturePermission-Signature-权限授予核心接口"><a href="#3-2-1-grantSignaturePermission-Signature-权限授予核心接口" class="headerlink" title="3.2.1 grantSignaturePermission - Signature 权限授予核心接口"></a>3.2.1 grantSignaturePermission - Signature 权限授予核心接口</h3><p>grantSignaturePermission 方法用于判断签名是否能校验通过，我们在这里先忽略掉签名校验的过程，假设要么校验成功，要么校验失败！</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">boolean</span> <span class="title">grantSignaturePermission</span><span class="params">(String perm, PackageParser.Package pkg,</span></span></span><br><span class="line"><span class="function"><span class="params">        BasePermission bp, PermissionsState origPermissions)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">boolean</span> allowed;</span><br><span class="line">    <span class="comment">//【1】判断应用的签名和权限定义者签名或者平台签名是否匹配！</span></span><br><span class="line">    allowed = (compareSignatures(</span><br><span class="line">            bp.packageSetting.signatures.mSignatures, pkg.mSignatures)</span><br><span class="line">                    == PackageManager.SIGNATURE_MATCH)</span><br><span class="line">            || (compareSignatures(mPlatformPackage.mSignatures, pkg.mSignatures)</span><br><span class="line">                    == PackageManager.SIGNATURE_MATCH);</span><br><span class="line">                    </span><br><span class="line">    <span class="comment">//【2】如果和权限定义者签名或者平台签名不匹配，并且该权限是 PRIVILEGED 的，进行进一步的判断！</span></span><br><span class="line">    <span class="keyword">if</span> (!allowed &amp;&amp; (bp.protectionLevel</span><br><span class="line">            &amp; PermissionInfo.PROTECTION_FLAG_PRIVILEGED) != <span class="number">0</span>) &#123;</span><br><span class="line">        </span><br><span class="line">        <span class="keyword">if</span> (isSystemApp(pkg)) &#123; <span class="comment">// 对于 PRIVILEGED 类型的权限，首先必须是系统应用！</span></span><br><span class="line">            <span class="comment">//【2.1】如果该应用是一个被更新过的系统应用，那么只有更新前的旧 apk 被授予了这个权限，</span></span><br><span class="line">            <span class="comment">// 新的 apk 才能被授予这个权限！</span></span><br><span class="line">            <span class="keyword">if</span> (pkg.isUpdatedSystemApp()) &#123;</span><br><span class="line">                <span class="comment">// 获得更新前的安装数据(system)！</span></span><br><span class="line">                <span class="keyword">final</span> PackageSetting sysPs = mSettings</span><br><span class="line">                        .getDisabledSystemPkgLPr(pkg.packageName);</span><br><span class="line"></span><br><span class="line">                <span class="keyword">if</span> (sysPs != <span class="keyword">null</span> &amp;&amp; sysPs.getPermissionsState().hasInstallPermission(perm)) &#123;</span><br><span class="line">                    <span class="comment">//【2.1.1】如果更新前，其已经被授予了该权限，并且其是一个特权应用，</span></span><br><span class="line">                    <span class="comment">// 那么本次也允许授予！！</span></span><br><span class="line">                    <span class="keyword">if</span> (sysPs.isPrivileged()) &#123;</span><br><span class="line">                        allowed = <span class="keyword">true</span>;</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                    <span class="comment">//【2.1.2】如果更新前，并没有被授予该权限，该权限是更新后新申请的权限！</span></span><br><span class="line">                    <span class="comment">// 那就要看之前是否有请求该权限，只有请求了该权限，才允许授予；</span></span><br><span class="line">                    <span class="keyword">if</span> (sysPs != <span class="keyword">null</span> &amp;&amp; sysPs.pkg != <span class="keyword">null</span> &amp;&amp; sysPs.isPrivileged()) &#123;</span><br><span class="line">                        <span class="keyword">for</span> (<span class="keyword">int</span> j = <span class="number">0</span>; j &lt; sysPs.pkg.requestedPermissions.size(); j++) &#123;</span><br><span class="line">                            <span class="keyword">if</span> (perm.equals(sysPs.pkg.requestedPermissions.get(j))) &#123;</span><br><span class="line">                                allowed = <span class="keyword">true</span>;</span><br><span class="line">                                <span class="keyword">break</span>;</span><br><span class="line">                            &#125;</span><br><span class="line">                        &#125;</span><br><span class="line">                    &#125;</span><br><span class="line"></span><br><span class="line">                    <span class="comment">// 此外，如果系统映像上的特权父包或其父包任何子代请求特权权限，则更新的子包也可以获得该许可。</span></span><br><span class="line">                    <span class="keyword">if</span> (pkg.parentPackage != <span class="keyword">null</span>) &#123;</span><br><span class="line">                        <span class="keyword">final</span> PackageSetting disabledSysParentPs = mSettings</span><br><span class="line">                                .getDisabledSystemPkgLPr(pkg.parentPackage.packageName);</span><br><span class="line">                        <span class="keyword">if</span> (disabledSysParentPs != <span class="keyword">null</span> &amp;&amp; disabledSysParentPs.pkg != <span class="keyword">null</span></span><br><span class="line">                                &amp;&amp; disabledSysParentPs.isPrivileged()) &#123;</span><br><span class="line">                            <span class="keyword">if</span> (isPackageRequestingPermission(disabledSysParentPs.pkg, perm)) &#123;</span><br><span class="line">                                allowed = <span class="keyword">true</span>;</span><br><span class="line">                            &#125; <span class="keyword">else</span> <span class="keyword">if</span> (disabledSysParentPs.pkg.childPackages != <span class="keyword">null</span>) &#123;</span><br><span class="line">                                <span class="keyword">final</span> <span class="keyword">int</span> count = disabledSysParentPs.pkg.childPackages.size();</span><br><span class="line">                                <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; count; i++) &#123;</span><br><span class="line">                                    PackageParser.Package disabledSysChildPkg =</span><br><span class="line">                                            disabledSysParentPs.pkg.childPackages.get(i);</span><br><span class="line">                                    <span class="keyword">if</span> (isPackageRequestingPermission(disabledSysChildPkg,</span><br><span class="line">                                            perm)) &#123;</span><br><span class="line">                                        allowed = <span class="keyword">true</span>;</span><br><span class="line">                                        <span class="keyword">break</span>;</span><br><span class="line">                                    &#125;</span><br><span class="line">                                &#125;</span><br><span class="line">                            &#125;</span><br><span class="line">                        &#125;</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                <span class="comment">//【2.2】如果该应用是一个没有被更新过的系统应用，那就要判读其是否是特权应用！</span></span><br><span class="line">                allowed = isPrivilegedApp(pkg);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">//【3】经过了上面的判断，依然不允许，接着进行下一步的判断，下面会根据额外的标志位继续判断！</span></span><br><span class="line">    <span class="keyword">if</span> (!allowed) &#123;</span><br><span class="line">        <span class="keyword">if</span> (!allowed &amp;&amp; (bp.protectionLevel</span><br><span class="line">                &amp; PermissionInfo.PROTECTION_FLAG_PRE23) != <span class="number">0</span></span><br><span class="line">                &amp;&amp; pkg.applicationInfo.targetSdkVersion &lt; Build.VERSION_CODES.M) &#123;</span><br><span class="line">            <span class="comment">//【3.1】PROTECTION_FLAG_PRE23 指定此权限会自动授予低于 M（在引入运行时权限之前）的 API 级别的应用程序。</span></span><br><span class="line">            <span class="comment">// 如果应用的 targetSdkVersion 是小于 M 的，那么我们授予他签名权限！</span></span><br><span class="line">            allowed = <span class="keyword">true</span>;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (!allowed &amp;&amp; (bp.protectionLevel &amp; PermissionInfo.PROTECTION_FLAG_INSTALLER) != <span class="number">0</span></span><br><span class="line">                &amp;&amp; pkg.packageName.equals(mRequiredInstallerPackage)) &#123;</span><br><span class="line">            <span class="comment">//【3.2】PROTECTION_FLAG_INSTALLER 指定此权限可以自动授予包软件应用程序。</span></span><br><span class="line">            <span class="comment">// 而此时的 apk 就是 packageInstaller，那么授予他签名权限！</span></span><br><span class="line">            allowed = <span class="keyword">true</span>;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (!allowed &amp;&amp; (bp.protectionLevel &amp; PermissionInfo.PROTECTION_FLAG_VERIFIER) != <span class="number">0</span></span><br><span class="line">                &amp;&amp; pkg.packageName.equals(mRequiredVerifierPackage)) &#123;</span><br><span class="line">            <span class="comment">//【3.3】PROTECTION_FLAG_INSTALLER 指定此权限可以被自动授予给验证软件包的系统应用程序。</span></span><br><span class="line">            <span class="comment">// 而此时的 apk 就是 VerifierPackage，那么授予他签名权限！</span></span><br><span class="line">            allowed = <span class="keyword">true</span>;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (!allowed &amp;&amp; (bp.protectionLevel</span><br><span class="line">                &amp; PermissionInfo.PROTECTION_FLAG_PREINSTALLED) != <span class="number">0</span></span><br><span class="line">                &amp;&amp; isSystemApp(pkg)) &#123;</span><br><span class="line">            <span class="comment">//【3.4】PROTECTION_FLAG_PREINSTALLED 指定此权限可以自动授予 system 分区预先安装的任何应用程序</span></span><br><span class="line">            <span class="comment">// 而此时的 apk 就是 system app，那么授予他签名权限！</span></span><br><span class="line">            allowed = <span class="keyword">true</span>;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (!allowed &amp;&amp; (bp.protectionLevel</span><br><span class="line">                &amp; PermissionInfo.PROTECTION_FLAG_DEVELOPMENT) != <span class="number">0</span>) &#123;</span><br><span class="line">            <span class="comment">//【3.4】PROTECTION_FLAG_DEVELOPMENT 指定此权限可以授予（可选）给开发应用程序</span></span><br><span class="line">            <span class="comment">// 而上一次应用是被授予了这个权限，那么一次也不被授予</span></span><br><span class="line">            allowed = origPermissions.hasInstallPermission(perm);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (!allowed &amp;&amp; (bp.protectionLevel &amp; PermissionInfo.PROTECTION_FLAG_SETUP) != <span class="number">0</span></span><br><span class="line">                &amp;&amp; pkg.packageName.equals(mSetupWizardPackage)) &#123;</span><br><span class="line">            <span class="comment">//【3.5】PROTECTION_FLAG_SETUP 指定此权限可以被自动授予给开机向导应用程序</span></span><br><span class="line">            <span class="comment">// 而此时的 apk 就是开机向导，那么授予他签名权限！.</span></span><br><span class="line">            allowed = <span class="keyword">true</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> allowed;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>可以看到，这里对 Signature 类型的权限做了详细的处理！</p>
<h2 id="3-2-grantRuntimePermission-运行时权限授予核心接口"><a href="#3-2-grantRuntimePermission-运行时权限授予核心接口" class="headerlink" title="3.2 grantRuntimePermission - 运行时权限授予核心接口"></a>3.2 grantRuntimePermission - 运行时权限授予核心接口</h2><p>授予运行时权限，其主要是在应用运行的时候，显示一个伪弹窗的 acitivity</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">grantRuntimePermission</span><span class="params">(String packageName, String name, <span class="keyword">final</span> <span class="keyword">int</span> userId)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">if</span> (!sUserManager.exists(userId)) &#123; <span class="comment">//【1】校验用户是否存在！</span></span><br><span class="line">        Log.e(TAG, <span class="string">"No such user:"</span> + userId);</span><br><span class="line">        <span class="keyword">return</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    mContext.enforceCallingOrSelfPermission( <span class="comment">//【2】校验调用者是否有相应权限；</span></span><br><span class="line">            android.Manifest.permission.GRANT_RUNTIME_PERMISSIONS,</span><br><span class="line">            <span class="string">"grantRuntimePermission"</span>);</span><br><span class="line"></span><br><span class="line">    enforceCrossUserPermission(Binder.getCallingUid(), userId,</span><br><span class="line">            <span class="keyword">true</span> <span class="comment">/* requireFullPermission */</span>, <span class="keyword">true</span> <span class="comment">/* checkShell */</span>,</span><br><span class="line">            <span class="string">"grantRuntimePermission"</span>);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">final</span> <span class="keyword">int</span> uid;</span><br><span class="line">    <span class="keyword">final</span> SettingBase sb;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">synchronized</span> (mPackages) &#123;</span><br><span class="line">        <span class="keyword">final</span> PackageParser.Package pkg = mPackages.get(packageName);</span><br><span class="line">        <span class="keyword">if</span> (pkg == <span class="keyword">null</span>) &#123; <span class="comment">//【3】package 不存在，异常！</span></span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> IllegalArgumentException(<span class="string">"Unknown package: "</span> + packageName);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">final</span> BasePermission bp = mSettings.mPermissions.get(name);</span><br><span class="line">        <span class="keyword">if</span> (bp == <span class="keyword">null</span>) &#123; <span class="comment">//【4】权限不存在，异常！</span></span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> IllegalArgumentException(<span class="string">"Unknown permission: "</span> + name);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        enforceDeclaredAsUsedAndRuntimeOrDevelopmentPermission(pkg, bp);</span><br><span class="line"></span><br><span class="line">        <span class="comment">//【5】如果 targetSdkVersion 小于 M，那么是不支持运行时权限的，我们在安装的时候会自动授予运行时权限！</span></span><br><span class="line">        <span class="keyword">if</span> (Build.PERMISSIONS_REVIEW_REQUIRED</span><br><span class="line">                &amp;&amp; pkg.applicationInfo.targetSdkVersion &lt; Build.VERSION_CODES.M</span><br><span class="line">                &amp;&amp; bp.isRuntime()) &#123;</span><br><span class="line">            <span class="keyword">return</span>;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        uid = UserHandle.getUid(userId, pkg.applicationInfo.uid);</span><br><span class="line">        sb = (SettingBase) pkg.mExtras;</span><br><span class="line">        <span class="keyword">if</span> (sb == <span class="keyword">null</span>) &#123; <span class="comment">//【6】升级包未安装过，异常！</span></span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> IllegalArgumentException(<span class="string">"Unknown package: "</span> + packageName);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">final</span> PermissionsState permissionsState = sb.getPermissionsState();</span><br><span class="line">        <span class="comment">//【7】获得权限的 flags 标志位，如果该权限是被 system fix 的，我们不能操作这样的权限！</span></span><br><span class="line">        <span class="keyword">final</span> <span class="keyword">int</span> flags = permissionsState.getPermissionFlags(name, userId);</span><br><span class="line">        <span class="keyword">if</span> ((flags &amp; PackageManager.FLAG_PERMISSION_SYSTEM_FIXED) != <span class="number">0</span>) &#123;</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> SecurityException(<span class="string">"Cannot grant system fixed permission "</span></span><br><span class="line">                    + name + <span class="string">" for package "</span> + packageName);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment">//【8】如果该权限是开发者权限，特殊处理，作为安装时权限，立刻授予！</span></span><br><span class="line">        <span class="comment">// 授予成功，会触发 Settings.writeLPr 方法，该方法会更新多个文件</span></span><br><span class="line">        <span class="comment">// 包括 pacakges.xml，pacakges.list，runtime-permissions.xml 等文件！</span></span><br><span class="line">        <span class="keyword">if</span> (bp.isDevelopment()) &#123;</span><br><span class="line">            <span class="keyword">if</span> (permissionsState.grantInstallPermission(bp) !=</span><br><span class="line">                    PermissionsState.PERMISSION_OPERATION_FAILURE) &#123;</span><br><span class="line">                scheduleWriteSettingsLocked();</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">return</span>;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (pkg.applicationInfo.targetSdkVersion &lt; Build.VERSION_CODES.M) &#123;</span><br><span class="line">            Slog.w(TAG, <span class="string">"Cannot grant runtime permission to a legacy app"</span>);</span><br><span class="line">            <span class="keyword">return</span>;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment">//【9】授予权限，并处理授予结果！！</span></span><br><span class="line">        <span class="keyword">final</span> <span class="keyword">int</span> result = permissionsState.grantRuntimePermission(bp, userId);</span><br><span class="line">        <span class="keyword">switch</span> (result) &#123;</span><br><span class="line">            <span class="keyword">case</span> PermissionsState.PERMISSION_OPERATION_FAILURE: &#123;</span><br><span class="line">                <span class="comment">//【9.1】授予失败，可能应用已经被授予权限了！</span></span><br><span class="line">                <span class="keyword">return</span>;</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            <span class="keyword">case</span> PermissionsState.PERMISSION_OPERATION_SUCCESS_GIDS_CHANGED: &#123;</span><br><span class="line">                <span class="comment">//【9.2】授予成功，但是应用映射的 gids 变化了！</span></span><br><span class="line">                <span class="keyword">final</span> <span class="keyword">int</span> appId = UserHandle.getAppId(pkg.applicationInfo.uid);</span><br><span class="line">                mHandler.post(<span class="keyword">new</span> Runnable() &#123;</span><br><span class="line">                    <span class="meta">@Override</span></span><br><span class="line">                    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">run</span><span class="params">()</span> </span>&#123;</span><br><span class="line">                        <span class="comment">//【9.2.1】杀掉应用的进程，应用后续会重启！</span></span><br><span class="line">                        killUid(appId, userId, KILL_APP_REASON_GIDS_CHANGED);</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;);</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        mOnPermissionChangeListeners.onPermissionsChanged(uid);</span><br><span class="line"></span><br><span class="line">        <span class="comment">//【10】更新 runtime-permissions.xml 文件！</span></span><br><span class="line">        mSettings.writeRuntimePermissionsForUserLPr(userId, <span class="keyword">false</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// Only need to do this if user is initialized. Otherwise it's a new user</span></span><br><span class="line">    <span class="comment">// and there are no processes running as the user yet and there's no need</span></span><br><span class="line">    <span class="comment">// to make an expensive call to remount processes for the changed permissions.</span></span><br><span class="line">    <span class="keyword">if</span> (READ_EXTERNAL_STORAGE.equals(name)</span><br><span class="line">            || WRITE_EXTERNAL_STORAGE.equals(name)) &#123;</span><br><span class="line">        <span class="keyword">final</span> <span class="keyword">long</span> token = Binder.clearCallingIdentity();</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            <span class="keyword">if</span> (sUserManager.isInitialized(userId)) &#123;</span><br><span class="line">                MountServiceInternal mountServiceInternal = LocalServices.getService(</span><br><span class="line">                        MountServiceInternal.class);</span><br><span class="line">                mountServiceInternal.onExternalStoragePolicyChanged(uid, packageName);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">            Binder.restoreCallingIdentity(token);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h2 id="3-3-grantRequestedRuntimePermissions-安装时授予运行时权限"><a href="#3-3-grantRequestedRuntimePermissions-安装时授予运行时权限" class="headerlink" title="3.3 grantRequestedRuntimePermissions - 安装时授予运行时权限"></a>3.3 grantRequestedRuntimePermissions - 安装时授予运行时权限</h2><p>在签名分析 pkg install 的时候，我们有看 handlePackagePostInstall 方法：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">handlePackagePostInstall</span><span class="params">(PackageInstalledInfo res, <span class="keyword">boolean</span> grantPermissions,</span></span></span><br><span class="line"><span class="function"><span class="params">        <span class="keyword">boolean</span> killApp, String[] grantedPermissions,</span></span></span><br><span class="line"><span class="function"><span class="params">        <span class="keyword">boolean</span> launchedForRestore, String installerPackage,</span></span></span><br><span class="line"><span class="function"><span class="params">        IPackageInstallObserver2 installObserver)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">if</span> (res.returnCode == PackageManager.INSTALL_SUCCEEDED) &#123;</span><br><span class="line">        <span class="comment">// Send the removed broadcasts</span></span><br><span class="line">        <span class="keyword">if</span> (res.removedInfo != <span class="keyword">null</span>) &#123;</span><br><span class="line">            res.removedInfo.sendPackageRemovedBroadcasts(killApp);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment">//【1】如果我们指定了在安装时授予其运行时权限，那么就会调用 grantRequestedRuntimePermissions 方法：</span></span><br><span class="line">        <span class="keyword">if</span> (grantPermissions &amp;&amp; res.pkg.applicationInfo.targetSdkVersion</span><br><span class="line">                &gt;= Build.VERSION_CODES.M) &#123;</span><br><span class="line">            grantRequestedRuntimePermissions(res.pkg, res.newUsers, grantedPermissions);</span><br><span class="line">        &#125;</span><br></pre></td></tr></table></figure>
<p>继续来分析：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">grantRequestedRuntimePermissions</span><span class="params">(PackageParser.Package pkg, <span class="keyword">int</span>[] userIds,</span></span></span><br><span class="line"><span class="function"><span class="params">        String[] grantedPermissions)</span> </span>&#123;</span><br><span class="line">    <span class="comment">//【3.3.1】授予每个设备用户下的运行时权限！</span></span><br><span class="line">    <span class="keyword">for</span> (<span class="keyword">int</span> userId : userIds) &#123;</span><br><span class="line">        grantRequestedRuntimePermissionsForUser(pkg, userId, grantedPermissions);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// We could have touched GID membership, so flush out packages.list</span></span><br><span class="line">    <span class="keyword">synchronized</span> (mPackages) &#123;</span><br><span class="line">        mSettings.writePackageListLPr();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>继续跟踪：</p>
<h3 id="3-3-1-grantRequestedRuntimePermissionsForUser"><a href="#3-3-1-grantRequestedRuntimePermissionsForUser" class="headerlink" title="3.3.1 grantRequestedRuntimePermissionsForUser"></a>3.3.1 grantRequestedRuntimePermissionsForUser</h3><p>下面的代码很简单：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">grantRequestedRuntimePermissionsForUser</span><span class="params">(PackageParser.Package pkg, <span class="keyword">int</span> userId,</span></span></span><br><span class="line"><span class="function"><span class="params">        String[] grantedPermissions)</span> </span>&#123;</span><br><span class="line">    SettingBase sb = (SettingBase) pkg.mExtras;</span><br><span class="line">    <span class="keyword">if</span> (sb == <span class="keyword">null</span>) &#123;</span><br><span class="line">        <span class="keyword">return</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    PermissionsState permissionsState = sb.getPermissionsState();</span><br><span class="line"></span><br><span class="line">    <span class="comment">//【1】对于 installer 他没有权限去改变 SYSTEM_FIXED 和 POLICY_FIXED 的权限状态！</span></span><br><span class="line">    <span class="keyword">final</span> <span class="keyword">int</span> immutableFlags = PackageManager.FLAG_PERMISSION_SYSTEM_FIXED</span><br><span class="line">            | PackageManager.FLAG_PERMISSION_POLICY_FIXED;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">for</span> (String permission : pkg.requestedPermissions) &#123;</span><br><span class="line">        <span class="keyword">final</span> BasePermission bp;</span><br><span class="line">        <span class="keyword">synchronized</span> (mPackages) &#123;</span><br><span class="line">            bp = mSettings.mPermissions.get(permission);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">if</span> (bp != <span class="keyword">null</span> &amp;&amp; (bp.isRuntime() || bp.isDevelopment())</span><br><span class="line">                &amp;&amp; (grantedPermissions == <span class="keyword">null</span></span><br><span class="line">                       || ArrayUtils.contains(grantedPermissions, permission))) &#123;</span><br><span class="line">            <span class="keyword">final</span> <span class="keyword">int</span> flags = permissionsState.getPermissionFlags(permission, userId);</span><br><span class="line">            <span class="comment">//【2】禁止修改！</span></span><br><span class="line">            <span class="keyword">if</span> ((flags &amp; immutableFlags) == <span class="number">0</span>) &#123;</span><br><span class="line">                <span class="comment">//【×3.2】授予运行时权限！</span></span><br><span class="line">                grantRuntimePermission(pkg.packageName, permission, userId);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></div><hr></div><div class="recent-post-item article-container"><a class="article-title" href="/2017/08/15/AlarmManager第 3 篇 - trigger Alarm 流程分析/">AlarmManager第 3 篇 - trigger Alarm 流程分析</a><time class="post-meta__date"><i class="fa fa-calendar" aria-hidden="true"></i> 2017-08-15</time><span class="article-meta"><span class="article-meta__separator">|</span><i class="fa fa-inbox article-meta__icon" aria-hidden="true"></i><a class="article-meta__categories" href="/categories/AndroidFramework源码分析/">AndroidFramework源码分析</a><i class="fa fa-angle-right" aria-hidden="true"></i><i class="fa fa-inbox article-meta__icon" aria-hidden="true"></i><a class="article-meta__categories" href="/categories/AndroidFramework源码分析/AlarmManager闹钟管理/">AlarmManager闹钟管理</a></span><span class="article-meta tags"><span class="article-meta__separator">|</span><i class="fa fa-tag article-meta__icon" aria-hidden="true"></i><a class="article-meta__tags" href="/tags/AlarmManager闹钟管理/">AlarmManager闹钟管理</a></span><div class="content"><p>[toc]</p>
<p>基于 Android7.1.1 源码，分析 AlarmManagerService 的架构和逻辑，本篇文章来分析下 trigger Alarm 的流程！</p>
<h1 id="0-回顾"><a href="#0-回顾" class="headerlink" title="0 回顾"></a>0 回顾</h1><p>在上一篇 set Alarm 文章中，我们知道, set 方法会调用 AlarmMS.rescheduleKernelAlarmsLocked 方法来设置下一个 alarm！</p>
<p>该方法用于设置下一个 Alarm！</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">rescheduleKernelAlarmsLocked</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    <span class="keyword">long</span> nextNonWakeup = <span class="number">0</span>;</span><br><span class="line">    <span class="comment">// 设置最早的 ELAPSED_REALTIME_WAKEUP 类型的 alarm！</span></span><br><span class="line">    <span class="keyword">if</span> (mAlarmBatches.size() &gt; <span class="number">0</span>) &#123;</span><br><span class="line"></span><br><span class="line">        <span class="comment">//【3.4.4.1】从 mAlarmBatches 中找到第一个包含 wake up 类型 alarm 的 Batch！</span></span><br><span class="line">        <span class="keyword">final</span> Batch firstWakeup = findFirstWakeupBatchLocked();</span><br><span class="line">        </span><br><span class="line">        <span class="comment">//【2】从 mAlarmBatches 中找到第一个的 Batch！</span></span><br><span class="line">        <span class="keyword">final</span> Batch firstBatch = mAlarmBatches.get(<span class="number">0</span>);</span><br><span class="line"></span><br><span class="line">        <span class="comment">//【3】如果 firstWakeup 不为 null，且 firstWakeup 中的开始触发时间 start，不等于 mNextWakeup！</span></span><br><span class="line">        <span class="comment">// 那就要更新 mNextWakeup，调整下一个 wake up alarm 的触发时间！</span></span><br><span class="line">        <span class="keyword">if</span> (firstWakeup != <span class="keyword">null</span> &amp;&amp; mNextWakeup != firstWakeup.start) &#123;</span><br><span class="line">            <span class="comment">// 更新 mNextWakeup 和 mLastWakeupSet！</span></span><br><span class="line">            mNextWakeup = firstWakeup.start;</span><br><span class="line">            mLastWakeupSet = SystemClock.elapsedRealtime();</span><br><span class="line">            </span><br><span class="line">            <span class="comment">//【3.4.4.2】设置下一个要触发的 wake up 类型的 alarm！</span></span><br><span class="line">            setLocked(ELAPSED_REALTIME_WAKEUP, firstWakeup.start);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment">//【4】如果 firstBatch 不等于 firstWakeup，说明 firstBatch 中不包含 wake up 类型的 alarm！</span></span><br><span class="line">        <span class="comment">// 那就设置下一个非 wake up alarm 的触发时间！</span></span><br><span class="line">        <span class="keyword">if</span> (firstBatch != firstWakeup) &#123;</span><br><span class="line">            nextNonWakeup = firstBatch.start;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// mPendingNonWakeupAlarms 不为 empty，说明系统中存在处于等待状态的 no wakeup 类型的 alarm！</span></span><br><span class="line">    <span class="comment">// 那么如果 nextNonWakeup 为 0，或者 mNextNonWakeupDeliveryTime 小于 nextNonWakeup！</span></span><br><span class="line">    <span class="comment">// 那么更新 nextNonWakeup 为 mNextNonWakeupDeliveryTime 的值！</span></span><br><span class="line">    <span class="keyword">if</span> (mPendingNonWakeupAlarms.size() &gt; <span class="number">0</span>) &#123;</span><br><span class="line">        <span class="keyword">if</span> (nextNonWakeup == <span class="number">0</span> || mNextNonWakeupDeliveryTime &lt; nextNonWakeup) &#123;</span><br><span class="line">            nextNonWakeup = mNextNonWakeupDeliveryTime;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// 最后如果，本次计算的下一个要触发的 no wake up alarm 的时间和之前的不同，更新 mNextNonWakeup 的值</span></span><br><span class="line">    <span class="comment">// 并设置下一个 no wake up 的 alarm！</span></span><br><span class="line">    <span class="keyword">if</span> (nextNonWakeup != <span class="number">0</span> &amp;&amp; mNextNonWakeup != nextNonWakeup) &#123;</span><br><span class="line">        mNextNonWakeup = nextNonWakeup;</span><br><span class="line">        <span class="comment">//【3.4.4.2】设置下一个要触发的 no wake up 类型的 alarm！</span></span><br><span class="line">        setLocked(ELAPSED_REALTIME, nextNonWakeup);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>下一个要执行的 wake up alarm 和 no wake up alarm 最终会通过 setLocked 方法进行设置！</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">setLocked</span><span class="params">(<span class="keyword">int</span> type, <span class="keyword">long</span> when)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">if</span> (mNativeData != <span class="number">0</span>) &#123;</span><br><span class="line">        <span class="comment">// The kernel never triggers alarms with negative wakeup times</span></span><br><span class="line">        <span class="comment">// so we ensure they are positive.</span></span><br><span class="line">        <span class="keyword">long</span> alarmSeconds, alarmNanoseconds;</span><br><span class="line">        <span class="keyword">if</span> (when &lt; <span class="number">0</span>) &#123;</span><br><span class="line">            alarmSeconds = <span class="number">0</span>;</span><br><span class="line">            alarmNanoseconds = <span class="number">0</span>;</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            alarmSeconds = when / <span class="number">1000</span>;</span><br><span class="line">            alarmNanoseconds = (when % <span class="number">1000</span>) * <span class="number">1000</span> * <span class="number">1000</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        </span><br><span class="line">        set(mNativeData, type, alarmSeconds, alarmNanoseconds);</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        Message msg = Message.obtain();</span><br><span class="line">        msg.what = ALARM_EVENT;</span><br><span class="line">        </span><br><span class="line">        mHandler.removeMessages(ALARM_EVENT);</span><br><span class="line">        mHandler.sendMessageAtTime(msg, when);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>setLocked 中提供了 2 种方法来设置 Alarm：</p>
<ul>
<li>一种是通过 Alarm 驱动来设置 Alarm，同时启动一个 AlarmThread 来监听 Alarm 驱动的消息，处理触发的 Alarm！</li>
<li>一种是通过自身的消息循环来设置和触发 Alarm；</li>
</ul>
<p>正常情况下，Alarm 驱动是存在的，那么，我们先来看看正常情况！</p>
<h1 id="1-AlarmThread-run"><a href="#1-AlarmThread-run" class="headerlink" title="1 AlarmThread.run"></a>1 AlarmThread.run</h1><p>AlarmThread 内部有一个 while 循环，条件为 true，通过不断循环，来处理来自 Kernel 的消息，下面我们来看卡 AlarmThread 的 run 方法！</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">run</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    ArrayList&lt;Alarm&gt; triggerList = <span class="keyword">new</span> ArrayList&lt;Alarm&gt;();</span><br><span class="line">    <span class="keyword">while</span> (<span class="keyword">true</span>) &#123;   </span><br><span class="line">        <span class="comment">//【*1.1】waitForAlarm 最终会调用 native 层的方法，是同步阻塞的，如果该方法没有返回值</span></span><br><span class="line">        <span class="comment">// 那 AlarmThread 将一直阻塞在这里，当其返回，说明有 alarm 触发了！</span></span><br><span class="line">        <span class="keyword">int</span> result = waitForAlarm(mNativeData);</span><br><span class="line">        mLastWakeup = SystemClock.elapsedRealtime(); <span class="comment">// 更新上一次唤醒的时间</span></span><br><span class="line">        </span><br><span class="line">        <span class="comment">//【1】清空 triggerList，triggerList 用于保存已经触发的 Alarm！</span></span><br><span class="line">        triggerList.clear();</span><br><span class="line"></span><br><span class="line">        <span class="keyword">final</span> <span class="keyword">long</span> nowRTC = System.currentTimeMillis();</span><br><span class="line">        <span class="keyword">final</span> <span class="keyword">long</span> nowELAPSED = SystemClock.elapsedRealtime();</span><br><span class="line"></span><br><span class="line">        <span class="comment">//【2】如果只是时间发生改变，而不是闹钟触发，进入这里！</span></span><br><span class="line">        <span class="keyword">if</span> ((result &amp; TIME_CHANGED_MASK) != <span class="number">0</span>) &#123;</span><br><span class="line">            <span class="comment">//【2.1】由于内核内部的一些微小调整，其会返回给系统一些实际上并不是闹钟出发引起的时间变化通知</span></span><br><span class="line">            <span class="comment">// 这里会过滤掉这些时间变化！</span></span><br><span class="line">            <span class="keyword">final</span> <span class="keyword">long</span> lastTimeChangeClockTime;</span><br><span class="line">            <span class="keyword">final</span> <span class="keyword">long</span> expectedClockTime;</span><br><span class="line">            <span class="keyword">synchronized</span> (mLock) &#123;</span><br><span class="line">                lastTimeChangeClockTime = mLastTimeChangeClockTime;</span><br><span class="line">                expectedClockTime = lastTimeChangeClockTime</span><br><span class="line">                        + (nowELAPSED - mLastTimeChangeRealtime);</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">if</span> (lastTimeChangeClockTime == <span class="number">0</span> || nowRTC &lt; (expectedClockTime-<span class="number">500</span>)</span><br><span class="line">                    || nowRTC &gt; (expectedClockTime+<span class="number">500</span>)) &#123;</span><br><span class="line">                <span class="comment">// The change is by at least +/- 500 ms (or this is the first change),</span></span><br><span class="line">                <span class="comment">// let's do it!</span></span><br><span class="line">                <span class="comment">// </span></span><br><span class="line">                <span class="keyword">if</span> (DEBUG_BATCH) &#123;</span><br><span class="line">                    Slog.v(TAG, <span class="string">"Time changed notification from kernel; rebatching"</span>);</span><br><span class="line">                &#125;</span><br><span class="line">                </span><br><span class="line">                <span class="comment">// 从管理列表 mAlarmBatches 移除时间改变和日期改变的 Alarm 对象！</span></span><br><span class="line">                <span class="comment">// 该方法也会触发 rebatch 过程！</span></span><br><span class="line">                removeImpl(mTimeTickSender);</span><br><span class="line">                removeImpl(mDateChangeSender);</span><br><span class="line">                </span><br><span class="line">                <span class="comment">// 重新对系统中所有的 Alarm 进行排序和批处理！</span></span><br><span class="line">                rebatchAllAlarms();</span><br><span class="line">                </span><br><span class="line">                <span class="comment">// 设置下一个发送 Intent.ACTION_TIME_TICK 和 Intent.ACTION_DATE_CHANGED 的 Alarm！</span></span><br><span class="line">                <span class="comment">// 该方法会调用 setImpl 方法！</span></span><br><span class="line">                mClockReceiver.scheduleTimeTickEvent();</span><br><span class="line">                mClockReceiver.scheduleDateChangedEvent();</span><br><span class="line"></span><br><span class="line">                <span class="keyword">synchronized</span> (mLock) &#123;</span><br><span class="line">                    <span class="comment">// 记录时间改变的次数，同时记录上一次发生时间改变的时间点！</span></span><br><span class="line">                    mNumTimeChanged++;</span><br><span class="line">                    mLastTimeChangeClockTime = nowRTC;</span><br><span class="line">                    mLastTimeChangeRealtime = nowELAPSED;</span><br><span class="line">                &#125;</span><br><span class="line">                </span><br><span class="line">                <span class="comment">// 发送时间改变的广播给所有的 userId!</span></span><br><span class="line">                Intent intent = <span class="keyword">new</span> Intent(Intent.ACTION_TIME_CHANGED);</span><br><span class="line">                intent.addFlags(Intent.FLAG_RECEIVER_REPLACE_PENDING</span><br><span class="line">                        | Intent.FLAG_RECEIVER_REGISTERED_ONLY_BEFORE_BOOT);</span><br><span class="line">                getContext().sendBroadcastAsUser(intent, UserHandle.ALL);</span><br><span class="line"></span><br><span class="line">                <span class="comment">// The world has changed on us, so we need to re-evaluate alarms</span></span><br><span class="line">                <span class="comment">// regardless of whether the kernel has told us one went off.</span></span><br><span class="line">                result |= IS_WAKEUP_MASK;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment">//【4】闹钟触发，会进入这个流程！</span></span><br><span class="line">        <span class="keyword">if</span> (result != TIME_CHANGED_MASK) &#123;</span><br><span class="line">            <span class="comment">// If this was anything besides just a time change, then figure what if</span></span><br><span class="line">            <span class="comment">// anything to do about alarms.</span></span><br><span class="line">            <span class="keyword">synchronized</span> (mLock) &#123;</span><br><span class="line">                <span class="keyword">if</span> (localLOGV) Slog.v(</span><br><span class="line">                    TAG, <span class="string">"Checking for alarms... rtc="</span> + nowRTC</span><br><span class="line">                    + <span class="string">", elapsed="</span> + nowELAPSED);</span><br><span class="line"></span><br><span class="line">                <span class="keyword">if</span> (WAKEUP_STATS) &#123;</span><br><span class="line">                    <span class="keyword">if</span> ((result &amp; IS_WAKEUP_MASK) != <span class="number">0</span>) &#123;</span><br><span class="line">                        <span class="keyword">long</span> newEarliest = nowRTC - RECENT_WAKEUP_PERIOD;</span><br><span class="line">                        <span class="keyword">int</span> n = <span class="number">0</span>;</span><br><span class="line">                        <span class="keyword">for</span> (WakeupEvent event : mRecentWakeups) &#123;</span><br><span class="line">                            <span class="keyword">if</span> (event.when &gt; newEarliest) <span class="keyword">break</span>;</span><br><span class="line">                            n++; <span class="comment">// number of now-stale entries at the list head</span></span><br><span class="line">                        &#125;</span><br><span class="line">                        <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; n; i++) &#123;</span><br><span class="line">                            mRecentWakeups.remove();</span><br><span class="line">                        &#125;</span><br><span class="line"></span><br><span class="line">                        recordWakeupAlarms(mAlarmBatches, nowELAPSED, nowRTC);</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;</span><br><span class="line">                <span class="comment">//【4.1】收集那些触发时间已经到了的 Alarm，该函数返回值表示是否有 wake up 类型的 alarm！！</span></span><br><span class="line">                <span class="comment">// triggerAlarmsLocked 方法会将触发列表中的 alarm 排序！</span></span><br><span class="line">                <span class="keyword">boolean</span> hasWakeup = triggerAlarmsLocked(triggerList, nowELAPSED, nowRTC);</span><br><span class="line"></span><br><span class="line">                <span class="comment">//【4.2】如果 hasWakeup 为 false，说明无 wake up 类型的 alarm ，</span></span><br><span class="line">                <span class="comment">// 如果 checkAllowNonWakeupDelayLocked 返回 true，说明该列表中的 alarm 要延迟发送！</span></span><br><span class="line">                <span class="keyword">if</span> (!hasWakeup &amp;&amp; checkAllowNonWakeupDelayLocked(nowELAPSED)) &#123;</span><br><span class="line"></span><br><span class="line">                    <span class="comment">// 如果没有 no wake up alarms 要分发，如果此时处于 screen off 或者其他一些特殊的情况！</span></span><br><span class="line">                    <span class="comment">// 我们会将 triggerList 添加到延迟列表 mPendingNonWakeupAlarms 中延迟分发！</span></span><br><span class="line">                    <span class="keyword">if</span> (mPendingNonWakeupAlarms.size() == <span class="number">0</span>) &#123;</span><br><span class="line"></span><br><span class="line">                        <span class="comment">// 如果 mPendingNonWakeupAlarms 为 empty，初始化延迟分发时间！</span></span><br><span class="line">                        mStartCurrentDelayTime = nowELAPSED; <span class="comment">// 设置 delay 的时间点！</span></span><br><span class="line">                        mNextNonWakeupDeliveryTime = nowELAPSED</span><br><span class="line">                                + ((currentNonWakeupFuzzLocked(nowELAPSED)*<span class="number">3</span>)/<span class="number">2</span>);</span><br><span class="line">                    &#125;</span><br><span class="line"></span><br><span class="line">                    mPendingNonWakeupAlarms.addAll(triggerList); <span class="comment">// 添加到延迟集合中</span></span><br><span class="line">                    mNumDelayedAlarms += triggerList.size(); <span class="comment">// 统计延迟分发的 Alarm 个数</span></span><br><span class="line">                    </span><br><span class="line">                    <span class="comment">//【4.2.1】rebatch 所有的 Alarm，更新下一个 AlarmClock！</span></span><br><span class="line">                    rescheduleKernelAlarmsLocked();</span><br><span class="line">                    updateNextAlarmClockLocked();</span><br><span class="line"></span><br><span class="line">                &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                    <span class="comment">//【4.3】进入这里的，就开始要分发 Alarm 了！</span></span><br><span class="line">                    <span class="comment">// now deliver the alarm intents; if there are pending non-wakeup</span></span><br><span class="line">                    <span class="comment">// alarms, we need to merge them in to the list.  note we don't</span></span><br><span class="line">                    <span class="comment">// just deliver them first because we generally want non-wakeup</span></span><br><span class="line">                    <span class="comment">// alarms delivered after wakeup alarms.</span></span><br><span class="line">                    <span class="comment">//【4.3.1】rebatch 所有的 Alarm，更新下一个 AlarmClock！</span></span><br><span class="line">                    rescheduleKernelAlarmsLocked();</span><br><span class="line">                    updateNextAlarmClockLocked();</span><br><span class="line">                    </span><br><span class="line">                    <span class="comment">// 如果 mPendingNonWakeupAlarms 不为 empty，那么，我们也要分发这些 Alarm！</span></span><br><span class="line">                    <span class="keyword">if</span> (mPendingNonWakeupAlarms.size() &gt; <span class="number">0</span>) &#123;</span><br><span class="line"></span><br><span class="line">                        <span class="comment">//【1.2.1】这里对 mPendingNonWakeupAlarms 列表中的 Alarm 计算优先级！</span></span><br><span class="line">                        <span class="comment">// 然后将 alarms 添加到 triggerList 中，然后在进行排序！</span></span><br><span class="line">                        calculateDeliveryPriorities(mPendingNonWakeupAlarms);</span><br><span class="line">                        triggerList.addAll(mPendingNonWakeupAlarms);</span><br><span class="line">                        Collections.sort(triggerList, mAlarmDispatchComparator);</span><br><span class="line"></span><br><span class="line">                        <span class="keyword">final</span> <span class="keyword">long</span> thisDelayTime = nowELAPSED - mStartCurrentDelayTime;</span><br><span class="line">                        mTotalDelayTime += thisDelayTime; <span class="comment">// 累计延迟的时间段；</span></span><br><span class="line">                        <span class="keyword">if</span> (mMaxDelayTime &lt; thisDelayTime) &#123;</span><br><span class="line">                            mMaxDelayTime = thisDelayTime; <span class="comment">// 最大延迟的时间段；</span></span><br><span class="line">                        &#125;</span><br><span class="line">                        mPendingNonWakeupAlarms.clear(); <span class="comment">// 清空 mPendingNonWakeupAlarms！</span></span><br><span class="line">                    &#125;</span><br><span class="line">                    </span><br><span class="line">                    <span class="comment">// 分发本次要触发的 Alarm！</span></span><br><span class="line">                    deliverAlarmsLocked(triggerList, nowELAPSED);</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            <span class="comment">// Just in case -- even though no wakeup flag was set, make sure</span></span><br><span class="line">            <span class="comment">// we have updated the kernel to the next alarm time.</span></span><br><span class="line">            <span class="keyword">synchronized</span> (mLock) &#123;</span><br><span class="line">                rescheduleKernelAlarmsLocked();</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>waitForAlarm 会调用 static jint android_server_AlarmManagerService_waitForAlarm 这个 native 方法，对 /dev/alarm 驱动文件进行操作！</p>
<h2 id="1-1-AlarmMS-waitForAlarm"><a href="#1-1-AlarmMS-waitForAlarm" class="headerlink" title="1.1 AlarmMS.waitForAlarm"></a>1.1 AlarmMS.waitForAlarm</h2><p>waitForAlarm 方法用来等待 Alarm 驱动的返回，其实阻塞性的！</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">native</span> <span class="keyword">int</span> <span class="title">waitForAlarm</span><span class="params">(<span class="keyword">long</span> nativeData)</span></span>;</span><br></pre></td></tr></table></figure>
<p>该方法最后会调用 navtive 的方法，位于 frameworks/base/services/core/jni/com_android_server_AlarmManagerService.cpp 文件中：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line"></span><br></pre></td></tr></table></figure>
<h2 id="1-2-AlarmMS-triggerAlarmsLocked"><a href="#1-2-AlarmMS-triggerAlarmsLocked" class="headerlink" title="1.2 AlarmMS.triggerAlarmsLocked"></a>1.2 AlarmMS.triggerAlarmsLocked</h2><p>triggerAlarmsLocked 方法用于分发那些触发时间已到的 Alarm！</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">boolean</span> <span class="title">triggerAlarmsLocked</span><span class="params">(ArrayList&lt;Alarm&gt; triggerList, <span class="keyword">final</span> <span class="keyword">long</span> nowELAPSED,</span></span></span><br><span class="line"><span class="function"><span class="params">        <span class="keyword">final</span> <span class="keyword">long</span> nowRTC)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">boolean</span> hasWakeup = <span class="keyword">false</span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//【1】mAlarmBatches 中的 Batch 都是按照触发时间点升序排列，</span></span><br><span class="line">    <span class="comment">// 接下来会遍历 mAlarmBatches，分发那些触发时间已到的 Alarm！</span></span><br><span class="line">    <span class="keyword">while</span> (mAlarmBatches.size() &gt; <span class="number">0</span>) &#123;</span><br><span class="line">        <span class="comment">// 获得触发事件最早的 Batch！</span></span><br><span class="line">        Batch batch = mAlarmBatches.get(<span class="number">0</span>);</span><br><span class="line">        <span class="comment">// 如果时间最早的 Batch 的触发时间还没到，那就不作任何操作，退出循环！</span></span><br><span class="line">        <span class="keyword">if</span> (batch.start &gt; nowELAPSED) &#123;</span><br><span class="line">            <span class="comment">// Everything else is scheduled for the future</span></span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment">//【1.1】能够走到这里，说明 batch 的触发时间已经到了，那么我们要移除这个 Batch，防止重复分发！</span></span><br><span class="line">        mAlarmBatches.remove(<span class="number">0</span>);</span><br><span class="line"></span><br><span class="line">        <span class="comment">//【1.2】分发这个 Batch 中的所有的 Alarm！</span></span><br><span class="line">        <span class="keyword">final</span> <span class="keyword">int</span> N = batch.size();</span><br><span class="line">        <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; N; i++) &#123;</span><br><span class="line">            Alarm alarm = batch.get(i);</span><br><span class="line">            </span><br><span class="line">            <span class="comment">//【1.2.1】如果 Alarm 设置了 AlarmManager.FLAG_ALLOW_WHILE_IDLE 标志位，</span></span><br><span class="line">            <span class="comment">// 说明其在系统处于 idle 状态也可以触发！</span></span><br><span class="line">            <span class="keyword">if</span> ((alarm.flags&amp;AlarmManager.FLAG_ALLOW_WHILE_IDLE) != <span class="number">0</span>) &#123;</span><br><span class="line"></span><br><span class="line">                <span class="comment">// 对于 allow while idle 类型的 Alarm，我们要检验其触发时间，看其距离上次触发事件是否</span></span><br><span class="line">                <span class="comment">// 不小于规定的最小时间间隔：mAllowWhileIdleMinTime</span></span><br><span class="line">                <span class="keyword">long</span> lastTime = mLastAllowWhileIdleDispatch.get(alarm.uid, <span class="number">0</span>);</span><br><span class="line">                <span class="keyword">long</span> minTime = lastTime + mAllowWhileIdleMinTime;</span><br><span class="line">                </span><br><span class="line">                <span class="comment">// 如果 nowELAPSED &lt; minTime，说明虽然该 alarm 的触发时间到了，但是时间小于规定的最小时间</span></span><br><span class="line">                <span class="comment">// 那么，按照最小时间重新设置 alarm！</span></span><br><span class="line">                <span class="keyword">if</span> (nowELAPSED &lt; minTime) &#123;</span><br><span class="line"></span><br><span class="line">                    <span class="comment">// 设置 alarm 的触发时间为 minTime，最大触发时间至少为 minTime！</span></span><br><span class="line">                    alarm.whenElapsed = minTime;</span><br><span class="line">                    <span class="keyword">if</span> (alarm.maxWhenElapsed &lt; minTime) &#123;</span><br><span class="line">                        alarm.maxWhenElapsed = minTime;</span><br><span class="line">                    &#125;</span><br><span class="line"></span><br><span class="line">                    <span class="keyword">if</span> (RECORD_DEVICE_IDLE_ALARMS) &#123;</span><br><span class="line">                        IdleDispatchEntry ent = <span class="keyword">new</span> IdleDispatchEntry();</span><br><span class="line">                        ent.uid = alarm.uid;</span><br><span class="line">                        ent.pkg = alarm.operation.getCreatorPackage();</span><br><span class="line">                        ent.tag = alarm.operation.getTag(<span class="string">""</span>);</span><br><span class="line">                        ent.op = <span class="string">"RESCHEDULE"</span>;</span><br><span class="line">                        ent.elapsedRealtime = nowELAPSED;</span><br><span class="line">                        ent.argRealtime = lastTime;</span><br><span class="line">                        mAllowWhileIdleDispatches.add(ent);</span><br><span class="line">                    &#125;</span><br><span class="line"></span><br><span class="line">                    <span class="comment">// 按照最小时间，重新设置 alarm，然后继续处理下一个 alarm！！</span></span><br><span class="line">                    setImplLocked(alarm, <span class="keyword">true</span>, <span class="keyword">false</span>);</span><br><span class="line">                    <span class="keyword">continue</span>;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">            </span><br><span class="line">            <span class="comment">//【1.2.2】进入这里，说明 Alarm 此时需要被分发！</span></span><br><span class="line">            alarm.count = <span class="number">1</span>; <span class="comment">// Alarm 闹钟的触发次数初始化为 1；</span></span><br><span class="line">            </span><br><span class="line">            triggerList.add(alarm); <span class="comment">// 将这个 alarm 添加到 triggerList 中去！</span></span><br><span class="line">            </span><br><span class="line">            <span class="comment">// 如果 alarm 是 wake from idle 类型的，在 event log 文件中打印出来，方便调试！</span></span><br><span class="line">            <span class="keyword">if</span> ((alarm.flags&amp;AlarmManager.FLAG_WAKE_FROM_IDLE) != <span class="number">0</span>) &#123;</span><br><span class="line">                EventLogTags.writeDeviceIdleWakeFromIdle(mPendingIdleUntil != <span class="keyword">null</span> ? <span class="number">1</span> : <span class="number">0</span>,</span><br><span class="line">                        alarm.statsTag);</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            <span class="comment">//【1.2.3】如果此时要触发的 Alarm 是 mPendingIdleUntil，那么说明系统要从 idle 状态恢复了，那么</span></span><br><span class="line">            <span class="comment">// 设置 mPendingIdleUntil 为 null，同时 rebatch 其他的 alarm，恢复因为 idle 状态而处于等待状态的 alarm</span></span><br><span class="line">            <span class="keyword">if</span> (mPendingIdleUntil == alarm) &#123;</span><br><span class="line">                mPendingIdleUntil = <span class="keyword">null</span>;</span><br><span class="line">                rebatchAllAlarmsLocked(<span class="keyword">false</span>);</span><br><span class="line">                restorePendingWhileIdleAlarmsLocked();</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            <span class="comment">//【1.2.3】如果此时要触发的 Alarm 是 mNextWakeFromIdle，说明该 alarm 会将系统从 idle 状态唤醒！</span></span><br><span class="line">            <span class="comment">// 那么设置 mNextWakeFromIdle 为 null，同时 rebatch 其他的 alarm！</span></span><br><span class="line">            <span class="keyword">if</span> (mNextWakeFromIdle == alarm) &#123;</span><br><span class="line">                mNextWakeFromIdle = <span class="keyword">null</span>;</span><br><span class="line">                rebatchAllAlarmsLocked(<span class="keyword">false</span>);</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            <span class="comment">//【1.2.3】如果 alarm.repeatInterval 大于 0，说明该 alarm 是一个 repeating alarm！</span></span><br><span class="line">            <span class="comment">// 我们计算下一次触发的时间，再次设置 alarm！</span></span><br><span class="line">            <span class="comment">// 这里要注意一点，因为系统可能进入休眠或者关机，alarm 可能错过了多个周期时间的触发！</span></span><br><span class="line">            <span class="keyword">if</span> (alarm.repeatInterval &gt; <span class="number">0</span>) &#123;</span><br><span class="line"></span><br><span class="line">                <span class="comment">// 这里是计算，我们可能因为系统休眠或者关机，错过了几个周期，当然该结果是可以为 0 的；</span></span><br><span class="line">                <span class="comment">// 我们需要把错过的触发次数也统计进去！！</span></span><br><span class="line">                alarm.count += (nowELAPSED - alarm.whenElapsed) / alarm.repeatInterval;</span><br><span class="line"></span><br><span class="line">                <span class="comment">// 计算下次的触发时间！</span></span><br><span class="line">                <span class="keyword">final</span> <span class="keyword">long</span> delta = alarm.count * alarm.repeatInterval;</span><br><span class="line">                <span class="keyword">final</span> <span class="keyword">long</span> nextElapsed = alarm.whenElapsed + delta;</span><br><span class="line"></span><br><span class="line">                <span class="comment">// 设置 alarm！</span></span><br><span class="line">                setImplLocked(alarm.type, alarm.when + delta, nextElapsed, alarm.windowLength,</span><br><span class="line">                        maxTriggerTime(nowELAPSED, nextElapsed, alarm.repeatInterval),</span><br><span class="line">                        alarm.repeatInterval, alarm.operation, <span class="keyword">null</span>, <span class="keyword">null</span>, alarm.flags, <span class="keyword">true</span>,</span><br><span class="line">                        alarm.workSource, alarm.alarmClock, alarm.uid, alarm.packageName);</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            <span class="comment">// 如果该 alarm 是 wake up 类型的，hasWakeup 为 true！</span></span><br><span class="line">            <span class="keyword">if</span> (alarm.wakeup) &#123;</span><br><span class="line">                hasWakeup = <span class="keyword">true</span>;</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            <span class="comment">// 该 alarm 是通过 setAlarmClock 方法设置的，当该 alarm 触发后，我们会计算下一个 AlarmClock</span></span><br><span class="line">            <span class="keyword">if</span> (alarm.alarmClock != <span class="keyword">null</span>) &#123;</span><br><span class="line">                mNextAlarmClockMayChange = <span class="keyword">true</span>;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 用于记录分发次数。每分发一个新的 alarm 集，该值会加 1；</span></span><br><span class="line">    mCurrentSeq++;</span><br><span class="line">    <span class="comment">//【2】计算分发优先级！</span></span><br><span class="line">    calculateDeliveryPriorities(triggerList);</span><br><span class="line">    <span class="comment">//【3】对要分发的 alarm 进行排序，先依据优先级，优先级相同，按照时间升序排序！</span></span><br><span class="line">    Collections.sort(triggerList, mAlarmDispatchComparator);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (localLOGV) &#123;</span><br><span class="line">        <span class="keyword">for</span> (<span class="keyword">int</span> i=<span class="number">0</span>; i&lt;triggerList.size(); i++) &#123;</span><br><span class="line">            Slog.v(TAG, <span class="string">"Triggering alarm #"</span> + i + <span class="string">": "</span> + triggerList.get(i));</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> hasWakeup;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h3 id="1-2-1-AlarmMS-calculateDeliveryPriorities"><a href="#1-2-1-AlarmMS-calculateDeliveryPriorities" class="headerlink" title="1.2.1 AlarmMS.calculateDeliveryPriorities"></a>1.2.1 AlarmMS.calculateDeliveryPriorities</h3><p>calculateDeliveryPriorities 方法用于计算分发的优先级！参数 alarms 表示所有需要触发的 alarm</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">calculateDeliveryPriorities</span><span class="params">(ArrayList&lt;Alarm&gt; alarms)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">final</span> <span class="keyword">int</span> N = alarms.size();</span><br><span class="line">    <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; N; i++) &#123;</span><br><span class="line">        Alarm a = alarms.get(i);</span><br><span class="line">        </span><br><span class="line">        <span class="comment">//【1】计算 alarm 优先级！</span></span><br><span class="line">        <span class="keyword">final</span> <span class="keyword">int</span> alarmPrio;</span><br><span class="line">        <span class="keyword">if</span> (a.operation != <span class="keyword">null</span></span><br><span class="line">                &amp;&amp; Intent.ACTION_TIME_TICK.equals(a.operation.getIntent().getAction())) &#123;</span><br><span class="line">            <span class="comment">//【1.1】如果该 alarm 是 Intent.ACTION_TIME_TICK，那么优先级为 PRIO_TICK</span></span><br><span class="line">            alarmPrio = PRIO_TICK;</span><br><span class="line">        &#125; <span class="keyword">else</span> <span class="keyword">if</span> (a.wakeup) &#123;</span><br><span class="line">            <span class="comment">//【1.2】如果该 alarm 是 wake up 类型的，那么优先级为 PRIO_WAKEUP</span></span><br><span class="line">            alarmPrio = PRIO_WAKEUP;</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            <span class="comment">//【1.3】其他类型的 alarm 优先级为 PRIO_NORMAL</span></span><br><span class="line">            alarmPrio = PRIO_NORMAL;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment">//【2】获得 alarm 的优先级对象，和其发送者 packageName</span></span><br><span class="line">        PriorityClass packagePrio = a.priorityClass;</span><br><span class="line">        String alarmPackage = (a.operation != <span class="keyword">null</span>)</span><br><span class="line">                ? a.operation.getCreatorPackage()</span><br><span class="line">                : a.packageName;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 如果 packagePrio 为 null，那就优先在缓存 mPriorities 中找，找不到；创建新的，并加入到缓存中！</span></span><br><span class="line">        <span class="keyword">if</span> (packagePrio == <span class="keyword">null</span>) packagePrio = mPriorities.get(alarmPackage);</span><br><span class="line">        <span class="keyword">if</span> (packagePrio == <span class="keyword">null</span>) &#123;</span><br><span class="line">            packagePrio = a.priorityClass = <span class="keyword">new</span> PriorityClass(); <span class="comment">// lowest prio &amp; stale sequence</span></span><br><span class="line">            mPriorities.put(alarmPackage, packagePrio);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 更新 alarm 的 priorityClass 优先级对象!</span></span><br><span class="line">        a.priorityClass = packagePrio;</span><br><span class="line"></span><br><span class="line">        <span class="comment">//【3】更新 alarm 优先级！</span></span><br><span class="line">        <span class="keyword">if</span> (packagePrio.seq != mCurrentSeq) &#123;</span><br><span class="line">            <span class="comment">//【3.1】如果 packagePrio.seq 不等于 mCurrentSeq，说明在本次的发送列表中，这是来自这个包的第一个 Alarm</span></span><br><span class="line">            <span class="comment">// 那么执行初始化操作！</span></span><br><span class="line">            packagePrio.priority = alarmPrio;</span><br><span class="line">            packagePrio.seq = mCurrentSeq;</span><br><span class="line"></span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            <span class="comment">//【3.2】如果 packagePrio.seq == mCurrentSeq，说明在发送列表中，有来自同一个 package 的多个 Alarm。</span></span><br><span class="line">            <span class="comment">// 那就调整优先级，规则： TICK &lt; WAKEUP &lt; NORMAL</span></span><br><span class="line">            <span class="keyword">if</span> (alarmPrio &lt; packagePrio.priority) &#123;</span><br><span class="line">                packagePrio.priority = alarmPrio;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>这里设置到了如下的几种 alarm 优先级，值越小，优先级越高！</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">static</span> <span class="keyword">final</span> <span class="keyword">int</span> PRIO_TICK = <span class="number">0</span>; <span class="comment">// 时间改变!</span></span><br><span class="line"><span class="keyword">static</span> <span class="keyword">final</span> <span class="keyword">int</span> PRIO_WAKEUP = <span class="number">1</span>; <span class="comment">// 唤醒!</span></span><br><span class="line"><span class="keyword">static</span> <span class="keyword">final</span> <span class="keyword">int</span> PRIO_NORMAL = <span class="number">2</span>; <span class="comment">// 正常!</span></span><br></pre></td></tr></table></figure>
<p>同时有一个集合 mPriorities，用于保存发送者的 package 和其对应 Alarm 优先级：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">final</span> <span class="class"><span class="keyword">class</span> <span class="title">PriorityClass</span> </span>&#123;</span><br><span class="line">    <span class="keyword">int</span> seq;</span><br><span class="line">    <span class="keyword">int</span> priority;</span><br><span class="line"></span><br><span class="line">    PriorityClass() &#123;</span><br><span class="line">        seq = mCurrentSeq - <span class="number">1</span>;</span><br><span class="line">        priority = PRIO_NORMAL;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">final</span> HashMap&lt;String, PriorityClass&gt; mPriorities = <span class="keyword">new</span> HashMap&lt;&gt;();</span><br><span class="line"><span class="keyword">int</span> mCurrentSeq = <span class="number">0</span>;</span><br></pre></td></tr></table></figure>
<p>PriorityClass 用于表示优先级别！</p>
<h3 id="1-2-2-Collections-sort-triggerList-mAlarmDispatchComparator"><a href="#1-2-2-Collections-sort-triggerList-mAlarmDispatchComparator" class="headerlink" title="1.2.2 Collections.sort(triggerList, mAlarmDispatchComparator)"></a>1.2.2 Collections.sort(triggerList, mAlarmDispatchComparator)</h3><p>接下来，对 triggerList 进行排序，这里用到了一个比较器 mAlarmDispatchComparator！</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">final</span> Comparator&lt;Alarm&gt; mAlarmDispatchComparator = <span class="keyword">new</span> Comparator&lt;Alarm&gt;() &#123;</span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">int</span> <span class="title">compare</span><span class="params">(Alarm lhs, Alarm rhs)</span> </span>&#123;</span><br><span class="line">        <span class="comment">// priority class trumps everything.  TICK &lt; WAKEUP &lt; NORMAL</span></span><br><span class="line">        <span class="keyword">if</span> (lhs.priorityClass.priority &lt; rhs.priorityClass.priority) &#123;</span><br><span class="line">            <span class="keyword">return</span> -<span class="number">1</span>;</span><br><span class="line">        &#125; <span class="keyword">else</span> <span class="keyword">if</span> (lhs.priorityClass.priority &gt; rhs.priorityClass.priority) &#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="number">1</span>;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// within each class, sort by nominal delivery time</span></span><br><span class="line">        <span class="keyword">if</span> (lhs.whenElapsed &lt; rhs.whenElapsed) &#123;</span><br><span class="line">            <span class="keyword">return</span> -<span class="number">1</span>;</span><br><span class="line">        &#125; <span class="keyword">else</span> <span class="keyword">if</span> (lhs.whenElapsed &gt; rhs.whenElapsed) &#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="number">1</span>;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// same priority class + same target delivery time</span></span><br><span class="line">        <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>
<p>首先按照优先级从高到低进行排序，然后按照触发时间从小到大进行排序，如果优先级和时间相同，保持先后顺序不变！</p>
<h2 id="1-3-AlarmMS-checkAllowNonWakeupDelayLocked"><a href="#1-3-AlarmMS-checkAllowNonWakeupDelayLocked" class="headerlink" title="1.3 AlarmMS.checkAllowNonWakeupDelayLocked"></a>1.3 AlarmMS.checkAllowNonWakeupDelayLocked</h2><p>该方法用于检查是否需要延迟 no wake up 类型的 Alarm 的分发！</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">boolean</span> <span class="title">checkAllowNonWakeupDelayLocked</span><span class="params">(<span class="keyword">long</span> nowELAPSED)</span> </span>&#123;</span><br><span class="line">    <span class="comment">//【1】如果此时处于亮屏状态，无需延迟！</span></span><br><span class="line">    <span class="keyword">if</span> (mInteractive) &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">false</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">//【2】如果此时处于熄屏状态，但是我们还没有分发过任何 Alarm，无需延迟！</span></span><br><span class="line">    <span class="keyword">if</span> (mLastAlarmDeliveryTime &lt;= <span class="number">0</span>) &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">false</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">//【3】如果此时系统中有等待中的 no wake up 类型的 alarm，但是其分发时间 mNextNonWakeupDeliveryTime 已经过去了</span></span><br><span class="line">    <span class="comment">// 那就无需延迟（看注释是为了解决一个在 Looper 中卡住的 bugs）！</span></span><br><span class="line">    <span class="keyword">if</span> (mPendingNonWakeupAlarms.size() &gt; <span class="number">0</span> &amp;&amp; mNextNonWakeupDeliveryTime &lt; nowELAPSED) &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">false</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// 计算当前时间距离上次分发的时间间隔，比较其和熄屏时间间隔的大小！！</span></span><br><span class="line">    <span class="keyword">long</span> timeSinceLast = nowELAPSED - mLastAlarmDeliveryTime;</span><br><span class="line">    <span class="keyword">return</span> timeSinceLast &lt;= currentNonWakeupFuzzLocked(nowELAPSED);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>规则如下：</p>
<ul>
<li>如果此时处于亮屏状态，无需延迟！</li>
<li>如果此时处于熄屏状态，但是我们还没有分发过任何 Alarm，无需延迟！</li>
<li>如果此时处于熄屏状态，我们之前也分发过 Alarm，那么如果 此时系统中有等待中的 no wake up 类型的 alarm，其分发时间已经过去了，无需延迟；</li>
<li>如果上面三个条件都不满足，那么如果距离上次分发 Alarm 的时间超过了 no wake up 类型 alarm 的最大延迟分发时间，那就无需延迟！</li>
</ul>
<p>currentNonWakeupFuzzLocked 用来计算了 no wake up 类型 alarm 的最大延迟分发时间</p>
<h3 id="1-3-1-AlarmMS-currentNonWakeupFuzzLocked"><a href="#1-3-1-AlarmMS-currentNonWakeupFuzzLocked" class="headerlink" title="1.3.1 AlarmMS.currentNonWakeupFuzzLocked"></a>1.3.1 AlarmMS.currentNonWakeupFuzzLocked</h3><p>该方法是用来计算熄屏幕的时长，然后根据时常，来确定 no wake up 类型的 alarm 的延迟触发的最长时间！！</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">long</span> <span class="title">currentNonWakeupFuzzLocked</span><span class="params">(<span class="keyword">long</span> nowELAPSED)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">long</span> timeSinceOn = nowELAPSED - mNonInteractiveStartTime;</span><br><span class="line">    <span class="comment">//【1】如果熄屏时间小于 5 mins，那么延迟最多 2 mins</span></span><br><span class="line">    <span class="keyword">if</span> (timeSinceOn &lt; <span class="number">5</span>*<span class="number">60</span>*<span class="number">1000</span>) &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="number">2</span>*<span class="number">60</span>*<span class="number">1000</span>;</span><br><span class="line">        </span><br><span class="line">    <span class="comment">//【2】如果熄屏时间小于 30 mins，那么延迟最多 15 mins</span></span><br><span class="line">    &#125; <span class="keyword">else</span> <span class="keyword">if</span> (timeSinceOn &lt; <span class="number">30</span>*<span class="number">60</span>*<span class="number">1000</span>) &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="number">15</span>*<span class="number">60</span>*<span class="number">1000</span>;</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">    <span class="comment">//【3】其他情况，那么延迟最多 60 mins</span></span><br><span class="line">        <span class="keyword">return</span> <span class="number">60</span>*<span class="number">60</span>*<span class="number">1000</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>不多说了！</p>
<h2 id="1-4-AlarmMS-deliverAlarmsLocked"><a href="#1-4-AlarmMS-deliverAlarmsLocked" class="headerlink" title="1.4 AlarmMS.deliverAlarmsLocked"></a>1.4 AlarmMS.deliverAlarmsLocked</h2><p>deliverAlarmsLocked 方法用于分发已经出发的 Alarm！</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">deliverAlarmsLocked</span><span class="params">(ArrayList&lt;Alarm&gt; triggerList, <span class="keyword">long</span> nowELAPSED)</span> </span>&#123;</span><br><span class="line">    <span class="comment">//【1】设置上一次的发送时间点！</span></span><br><span class="line">    mLastAlarmDeliveryTime = nowELAPSED;</span><br><span class="line">    <span class="comment">//【2】遍历 triggerList，分发 Alarm！</span></span><br><span class="line">    <span class="keyword">for</span> (<span class="keyword">int</span> i=<span class="number">0</span>; i&lt;triggerList.size(); i++) &#123;</span><br><span class="line">        Alarm alarm = triggerList.get(i);</span><br><span class="line">        <span class="comment">//【2.1】判断该 Alarm 是否是 allow while idle 的！</span></span><br><span class="line">        <span class="keyword">final</span> <span class="keyword">boolean</span> allowWhileIdle = (alarm.flags&amp;AlarmManager.FLAG_ALLOW_WHILE_IDLE) != <span class="number">0</span>;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            <span class="keyword">if</span> (localLOGV) &#123;</span><br><span class="line">                Slog.v(TAG, <span class="string">"sending alarm "</span> + alarm);</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">if</span> (RECORD_ALARMS_IN_HISTORY) &#123; <span class="comment">// 用于系统记录信息！</span></span><br><span class="line">                <span class="keyword">if</span> (alarm.workSource != <span class="keyword">null</span> &amp;&amp; alarm.workSource.size() &gt; <span class="number">0</span>) &#123;</span><br><span class="line">                    <span class="keyword">for</span> (<span class="keyword">int</span> wi=<span class="number">0</span>; wi&lt;alarm.workSource.size(); wi++) &#123;</span><br><span class="line">                        ActivityManagerNative.noteAlarmStart(</span><br><span class="line">                                alarm.operation, alarm.workSource.get(wi), alarm.statsTag);</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                    ActivityManagerNative.noteAlarmStart(</span><br><span class="line">                            alarm.operation, alarm.uid, alarm.statsTag);</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="comment">//【1.5】调用 DeliveryTracker 的 deliverLocked 方法，分发 Alarm！</span></span><br><span class="line">            mDeliveryTracker.deliverLocked(alarm, nowELAPSED, allowWhileIdle);</span><br><span class="line">        &#125; <span class="keyword">catch</span> (RuntimeException e) &#123;</span><br><span class="line">            Slog.w(TAG, <span class="string">"Failure sending alarm."</span>, e);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>接下来，我们去看看 DeliveryTracker：</p>
<h2 id="1-5-DeliveryTracker-deliverLocked"><a href="#1-5-DeliveryTracker-deliverLocked" class="headerlink" title="1.5 DeliveryTracker.deliverLocked"></a>1.5 DeliveryTracker.deliverLocked</h2><p>DeliveryTracker 用以监控和跟踪 Alarm 的分发！</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">DeliveryTracker</span> <span class="keyword">extends</span> <span class="title">IAlarmCompleteListener</span>.<span class="title">Stub</span> <span class="keyword">implements</span> <span class="title">PendingIntent</span>.<span class="title">OnFinished</span> </span>&#123;</span><br><span class="line">    ... ... ... ...</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * Deliver an alarm and set up the post-delivery handling appropriately</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">deliverLocked</span><span class="params">(Alarm alarm, <span class="keyword">long</span> nowELAPSED, <span class="keyword">boolean</span> allowWhileIdle)</span> </span>&#123;</span><br><span class="line">        <span class="comment">//【1】针对于 Alarm 的触发方式，做不同的处理！</span></span><br><span class="line">        <span class="keyword">if</span> (alarm.operation != <span class="keyword">null</span>) &#123;</span><br><span class="line">            <span class="comment">//【1.1】如果是通过 PendingIntent 触发，进入这里，这里会调用 PendingIntent 的 send 方法，将 Intent</span></span><br><span class="line">            <span class="comment">// 发送给接收方！</span></span><br><span class="line">            <span class="keyword">try</span> &#123;</span><br><span class="line">                alarm.operation.send(getContext(), <span class="number">0</span>,</span><br><span class="line">                        mBackgroundIntent.putExtra(</span><br><span class="line">                                Intent.EXTRA_ALARM_COUNT, alarm.count),</span><br><span class="line">                                mDeliveryTracker, mHandler, <span class="keyword">null</span>,</span><br><span class="line">                                allowWhileIdle ? mIdleOptions : <span class="keyword">null</span>);</span><br><span class="line"></span><br><span class="line">            &#125; <span class="keyword">catch</span> (PendingIntent.CanceledException e) &#123;</span><br><span class="line">                <span class="comment">// 如果 send 出现异常，那么如果是重复闹钟，那就将这个 Alarm 移除；否则，直接 return 掉！</span></span><br><span class="line">                <span class="keyword">if</span> (alarm.repeatInterval &gt; <span class="number">0</span>) &#123;</span><br><span class="line">                    removeImpl(alarm.operation); <span class="comment">//  该方法会 rebatch 其他的 A</span></span><br><span class="line">                &#125;</span><br><span class="line">                <span class="keyword">return</span>;</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            <span class="comment">//【1.2】如果是通过 onAlarmListener 接收，进入这里，调用其 doAlarm 方法！</span></span><br><span class="line">            <span class="keyword">try</span> &#123;</span><br><span class="line">                <span class="keyword">if</span> (DEBUG_LISTENER_CALLBACK) &#123;</span><br><span class="line">                    Slog.v(TAG, <span class="string">"Alarm to uid="</span> + alarm.uid</span><br><span class="line">                            + <span class="string">" listener="</span> + alarm.listener.asBinder());</span><br><span class="line">                &#125;</span><br><span class="line">                <span class="comment">// 跨进程调用应用进程中的 onAlarmListener 的 doAlarm 方法！</span></span><br><span class="line">                alarm.listener.doAlarm(<span class="keyword">this</span>);</span><br><span class="line"></span><br><span class="line">                <span class="comment">// 设置监听超时处理！</span></span><br><span class="line">                mHandler.sendMessageDelayed(</span><br><span class="line">                        mHandler.obtainMessage(AlarmHandler.LISTENER_TIMEOUT,</span><br><span class="line">                                alarm.listener.asBinder()),</span><br><span class="line">                        mConstants.LISTENER_TIMEOUT);</span><br><span class="line">            &#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">                <span class="comment">// 如果分发出现异常，那就 return，不做处理！！</span></span><br><span class="line">                <span class="keyword">if</span> (DEBUG_LISTENER_CALLBACK) &#123;</span><br><span class="line">                    Slog.i(TAG, <span class="string">"Alarm undeliverable to listener "</span></span><br><span class="line">                            + alarm.listener.asBinder(), e);</span><br><span class="line">                &#125;</span><br><span class="line">                <span class="keyword">return</span>;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment">//【2】alarm 要开始准备分发了，开始统计跟踪 wakelock 和 status！</span></span><br><span class="line">        <span class="keyword">if</span> (mBroadcastRefCount == <span class="number">0</span>) &#123;</span><br><span class="line">            setWakelockWorkSource(alarm.operation, alarm.workSource,</span><br><span class="line">                    alarm.type, alarm.statsTag, (alarm.operation == <span class="keyword">null</span>) ? alarm.uid : -<span class="number">1</span>,</span><br><span class="line">                    <span class="keyword">true</span>);</span><br><span class="line">            mWakeLock.acquire(); <span class="comment">// 申请 wakeLock 锁，防止分发过程睡下去！</span></span><br><span class="line">            <span class="comment">// 发送 REPORT_ALARMS_ACTIVE 给 AlarmHandler，AlarmHandler 会通知 DeviceIdleController</span></span><br><span class="line">            <span class="comment">//，有 alarm 处于 active 状态！</span></span><br><span class="line">            mHandler.obtainMessage(AlarmHandler.REPORT_ALARMS_ACTIVE, <span class="number">1</span>).sendToTarget();</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment">//【3】创建 InFlight 对象，表示该 Alarm 正在分发过程中！</span></span><br><span class="line">        <span class="keyword">final</span> InFlight inflight = <span class="keyword">new</span> InFlight(AlarmManagerService.<span class="keyword">this</span>,</span><br><span class="line">                alarm.operation, alarm.listener, alarm.workSource, alarm.uid,</span><br><span class="line">                alarm.packageName, alarm.type, alarm.statsTag, nowELAPSED);</span><br><span class="line">        mInFlight.add(inflight);</span><br><span class="line"></span><br><span class="line">        mBroadcastRefCount++; <span class="comment">// 引用计数加 1；</span></span><br><span class="line"></span><br><span class="line">        <span class="comment">//【4】如果这个 alarm 是 allow while idle 的，那就要记录下该 alarm 的上一次分发时间</span></span><br><span class="line">        <span class="comment">// 保存到 mLastAllowWhileIdleDispatch 中！</span></span><br><span class="line">        <span class="keyword">if</span> (allowWhileIdle) &#123;</span><br><span class="line">            mLastAllowWhileIdleDispatch.put(alarm.uid, nowELAPSED);</span><br><span class="line">            </span><br><span class="line">            <span class="keyword">if</span> (RECORD_DEVICE_IDLE_ALARMS) &#123; <span class="comment">// 用于 dump 操作，不关注！</span></span><br><span class="line">                IdleDispatchEntry ent = <span class="keyword">new</span> IdleDispatchEntry();</span><br><span class="line">                ent.uid = alarm.uid;</span><br><span class="line">                ent.pkg = alarm.packageName;</span><br><span class="line">                ent.tag = alarm.statsTag;</span><br><span class="line">                ent.op = <span class="string">"DELIVER"</span>;</span><br><span class="line">                ent.elapsedRealtime = nowELAPSED;</span><br><span class="line">                mAllowWhileIdleDispatches.add(ent);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment">//【5】设置 alarm 状态！</span></span><br><span class="line">        <span class="keyword">final</span> BroadcastStats bs = inflight.mBroadcastStats;</span><br><span class="line">        bs.count++;</span><br><span class="line">        <span class="keyword">if</span> (bs.nesting == <span class="number">0</span>) &#123;</span><br><span class="line">            bs.nesting = <span class="number">1</span>;</span><br><span class="line">            bs.startTime = nowELAPSED;</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            bs.nesting++;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">final</span> FilterStats fs = inflight.mFilterStats;</span><br><span class="line">        fs.count++;</span><br><span class="line">        <span class="keyword">if</span> (fs.nesting == <span class="number">0</span>) &#123;</span><br><span class="line">            fs.nesting = <span class="number">1</span>;</span><br><span class="line">            fs.startTime = nowELAPSED;</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            fs.nesting++;</span><br><span class="line">        &#125;</span><br><span class="line">        </span><br><span class="line">        <span class="comment">//【6】如果 alarm 是 wake up 类型的！</span></span><br><span class="line">        <span class="keyword">if</span> (alarm.type == ELAPSED_REALTIME_WAKEUP</span><br><span class="line">                || alarm.type == RTC_WAKEUP) &#123;</span><br><span class="line">            bs.numWakeup++; <span class="comment">// 更新 wake up 的次数！</span></span><br><span class="line">            fs.numWakeup++;</span><br><span class="line">            <span class="keyword">if</span> (alarm.workSource != <span class="keyword">null</span> &amp;&amp; alarm.workSource.size() &gt; <span class="number">0</span>) &#123;</span><br><span class="line">                <span class="keyword">for</span> (<span class="keyword">int</span> wi=<span class="number">0</span>; wi&lt;alarm.workSource.size(); wi++) &#123;</span><br><span class="line">                    <span class="keyword">final</span> String wsName = alarm.workSource.getName(wi);</span><br><span class="line">                    ActivityManagerNative.noteWakeupAlarm(</span><br><span class="line">                            alarm.operation, alarm.workSource.get(wi),</span><br><span class="line">                            (wsName != <span class="keyword">null</span>) ? wsName : alarm.packageName,</span><br><span class="line">                            alarm.statsTag);</span><br><span class="line">                &#125;</span><br><span class="line">            &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                ActivityManagerNative.noteWakeupAlarm(</span><br><span class="line">                        alarm.operation, alarm.uid, alarm.packageName, alarm.statsTag);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>mDeliveryTracker 是 AlarmManagerService 的内部变量，用于监控分发的过程！</p>
<p>这里我们看到，DeliveryTracker 继承了 IAlarmCompleteListener.Stub，这个是由 IAlarmCompleteListener.aidl 文件生成的一个服务端“桩”对象，作用很明显了，用于跨进程通信，即：系统进程和应用进程！</p>
<p>原因很简单，DeliveryTracker 用于监控 Alarm 的分发，所以系统需要知道客户端对 Alarm 的分发和处理结果，所以应用进程那边一定会有 DeliveryTracker 的代理对象的！</p>
<p>同时 DeliveryTracker 还实现了 PendingIntent.OnFinished 接口，用于另外一种分发方式！</p>
<p>我们继续看！</p>
<h3 id="1-5-1-new-InFlight"><a href="#1-5-1-new-InFlight" class="headerlink" title="1.5.1 new InFlight"></a>1.5.1 new InFlight</h3><p>系统会对每一个 Alarm 都创建其 InFlight 对象，并保存到 mInFlight！</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">static</span> <span class="keyword">final</span> <span class="class"><span class="keyword">class</span> <span class="title">InFlight</span> </span>&#123;</span><br><span class="line">    <span class="keyword">final</span> PendingIntent mPendingIntent;</span><br><span class="line">    <span class="keyword">final</span> IBinder mListener;</span><br><span class="line">    <span class="keyword">final</span> WorkSource mWorkSource;</span><br><span class="line">    <span class="keyword">final</span> <span class="keyword">int</span> mUid;</span><br><span class="line">    <span class="keyword">final</span> String mTag;</span><br><span class="line">    <span class="keyword">final</span> BroadcastStats mBroadcastStats;</span><br><span class="line">    <span class="keyword">final</span> FilterStats mFilterStats;</span><br><span class="line">    <span class="keyword">final</span> <span class="keyword">int</span> mAlarmType;</span><br><span class="line"></span><br><span class="line">    InFlight(AlarmManagerService service, PendingIntent pendingIntent, IAlarmListener listener,</span><br><span class="line">            WorkSource workSource, <span class="keyword">int</span> uid, String alarmPkg, <span class="keyword">int</span> alarmType, String tag,</span><br><span class="line">            <span class="keyword">long</span> nowELAPSED) &#123;</span><br><span class="line">        mPendingIntent = pendingIntent; <span class="comment">// PendingIntent 对象！</span></span><br><span class="line">        mListener = listener != <span class="keyword">null</span> ? listener.asBinder() : <span class="keyword">null</span>; <span class="comment">// AlarmListener 对象！</span></span><br><span class="line">        mWorkSource = workSource;</span><br><span class="line">        mUid = uid;</span><br><span class="line">        mTag = tag;</span><br><span class="line">        mBroadcastStats = (pendingIntent != <span class="keyword">null</span>)</span><br><span class="line">                ? service.getStatsLocked(pendingIntent)</span><br><span class="line">                : service.getStatsLocked(uid, alarmPkg);</span><br><span class="line">        FilterStats fs = mBroadcastStats.filterStats.get(mTag);</span><br><span class="line">        <span class="keyword">if</span> (fs == <span class="keyword">null</span>) &#123;</span><br><span class="line">            fs = <span class="keyword">new</span> FilterStats(mBroadcastStats, mTag);</span><br><span class="line">            mBroadcastStats.filterStats.put(mTag, fs);</span><br><span class="line">        &#125;</span><br><span class="line">        fs.lastTime = nowELAPSED;</span><br><span class="line">        mFilterStats = fs;</span><br><span class="line">        mAlarmType = alarmType; <span class="comment">// Alarm 的类型！</span></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h4 id="1-5-1-1-AlarmMS-getStatsLocked"><a href="#1-5-1-1-AlarmMS-getStatsLocked" class="headerlink" title="1.5.1.1 AlarmMS.getStatsLocked"></a>1.5.1.1 AlarmMS.getStatsLocked</h4><p>getStatsLocked 用于获得 Alarm 对应的 BroadcastStats 对象！</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">final</span> BroadcastStats <span class="title">getStatsLocked</span><span class="params">(PendingIntent pi)</span> </span>&#123;</span><br><span class="line">    String pkg = pi.getCreatorPackage();</span><br><span class="line">    <span class="keyword">int</span> uid = pi.getCreatorUid();</span><br><span class="line">    <span class="keyword">return</span> getStatsLocked(uid, pkg);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">final</span> BroadcastStats <span class="title">getStatsLocked</span><span class="params">(<span class="keyword">int</span> uid, String pkgName)</span> </span>&#123;</span><br><span class="line">    ArrayMap&lt;String, BroadcastStats&gt; uidStats = mBroadcastStats.get(uid);</span><br><span class="line">    <span class="keyword">if</span> (uidStats == <span class="keyword">null</span>) &#123;</span><br><span class="line">        uidStats = <span class="keyword">new</span> ArrayMap&lt;String, BroadcastStats&gt;();</span><br><span class="line">        mBroadcastStats.put(uid, uidStats);</span><br><span class="line">    &#125;</span><br><span class="line">    BroadcastStats bs = uidStats.get(pkgName);</span><br><span class="line">    <span class="keyword">if</span> (bs == <span class="keyword">null</span>) &#123;</span><br><span class="line">        bs = <span class="keyword">new</span> BroadcastStats(uid, pkgName);</span><br><span class="line">        uidStats.put(pkgName, bs);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> bs;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>每一个 Alarm 都会有一个 BroadcastStats，用于保存该 Alarm 的分发状态！</p>
<p>同时，AlarmManagerService 也有一个集合：mBroadcastStats，来管理每个 uid 对应的广播分发状态！</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">final</span> SparseArray&lt;ArrayMap&lt;String, BroadcastStats&gt;&gt; mBroadcastStats</span><br><span class="line">        = <span class="keyword">new</span> SparseArray&lt;ArrayMap&lt;String, BroadcastStats&gt;&gt;();</span><br></pre></td></tr></table></figure>
<p>映射关系：<strong>create uid</strong> -&gt; ArrayMap：<strong>create packageName</strong> -&gt; <strong>BroadcastStats</strong>！</p>
<h1 id="2-分发的流程"><a href="#2-分发的流程" class="headerlink" title="2 分发的流程"></a>2 分发的流程</h1><p>前面我们看到，如果 setAlarm 是通过 PendingIntent 的方式来设置的，系统会通过如下方式分发 Alarm！</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">alarm.operation.send(getContext(), <span class="number">0</span>,</span><br><span class="line">        mBackgroundIntent.putExtra(</span><br><span class="line">                Intent.EXTRA_ALARM_COUNT, alarm.count),</span><br><span class="line">                mDeliveryTracker, mHandler, <span class="keyword">null</span>,</span><br><span class="line">                allowWhileIdle ? mIdleOptions : <span class="keyword">null</span>);</span><br></pre></td></tr></table></figure>
<p>如果 setAlarm 是通过 AlarmListener 的方式来设置的，系统会通过如下方式分发 Alarm！</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 跨进程调用应用进程中的 onAlarmListener 的 doAlarm 方法！</span></span><br><span class="line">alarm.listener.doAlarm(<span class="keyword">this</span>);</span><br><span class="line"><span class="comment">// 设置监听超时处理！</span></span><br><span class="line">mHandler.sendMessageDelayed(</span><br><span class="line">        mHandler.obtainMessage(AlarmHandler.LISTENER_TIMEOUT,</span><br><span class="line">                alarm.listener.asBinder()),</span><br><span class="line">        mConstants.LISTENER_TIMEOUT);</span><br></pre></td></tr></table></figure>
<p>下面我们来看看二者的区别！</p>
<h2 id="2-1-Alarm-PendingIntent-send"><a href="#2-1-Alarm-PendingIntent-send" class="headerlink" title="2.1 Alarm.PendingIntent.send"></a>2.1 Alarm.PendingIntent.send</h2><p>我们可以看到，对于 PendingIntent，我们会将 Alarm 的重复分发次数通过 Intent.EXTRA_ALARM_COUNT 发送给处理方！</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">send</span><span class="params">(Context context, <span class="keyword">int</span> code, @Nullable Intent intent,</span></span></span><br><span class="line"><span class="function"><span class="params">        @Nullable OnFinished onFinished, @Nullable Handler handler,</span></span></span><br><span class="line"><span class="function"><span class="params">        @Nullable String requiredPermission, @Nullable Bundle options)</span></span></span><br><span class="line"><span class="function">        <span class="keyword">throws</span> CanceledException </span>&#123;</span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">        String resolvedType = intent != <span class="keyword">null</span> ?</span><br><span class="line">                intent.resolveTypeIfNeeded(context.getContentResolver())</span><br><span class="line">                : <span class="keyword">null</span>;</span><br><span class="line"></span><br><span class="line">        <span class="comment">//【1】调用 AMS 的 sendIntentSender 方法发送这个 Alarm！！</span></span><br><span class="line">        <span class="keyword">int</span> res = ActivityManagerNative.getDefault().sendIntentSender(</span><br><span class="line">                mTarget, code, intent, resolvedType,</span><br><span class="line">                onFinished != <span class="keyword">null</span></span><br><span class="line">                        ? <span class="keyword">new</span> FinishedDispatcher(<span class="keyword">this</span>, onFinished, handler) <span class="comment">// 创建了 FinishedDispatcher 对象！</span></span><br><span class="line">                        : <span class="keyword">null</span>,</span><br><span class="line">                requiredPermission, options);</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (res &lt; <span class="number">0</span>) &#123;</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> CanceledException();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125; <span class="keyword">catch</span> (RemoteException e) &#123;</span><br><span class="line">        <span class="keyword">throw</span> <span class="keyword">new</span> CanceledException(e);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>这里要注意，我们传入的参数 onFinished 实现对象是 mDeliveryTracker！</p>
<p>这里我们要简单提一下 mTarget，他是 PendingIntent 的内部成员变量，是一个 IIntentSender Binder 对象！我们在调用 PendingIntent.getService 等方法的时候，会有如下的逻辑：</p>
<h3 id="2-1-1-new-FinishedDispatcher"><a href="#2-1-1-new-FinishedDispatcher" class="headerlink" title="2.1.1 new FinishedDispatcher"></a>2.1.1 new FinishedDispatcher</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">private</span> <span class="keyword">static</span> <span class="class"><span class="keyword">class</span> <span class="title">FinishedDispatcher</span> <span class="keyword">extends</span> <span class="title">IIntentReceiver</span>.<span class="title">Stub</span></span></span><br><span class="line"><span class="class">        <span class="keyword">implements</span> <span class="title">Runnable</span> </span>&#123;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> PendingIntent mPendingIntent;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> OnFinished mWho; <span class="comment">// mDeliveryTracker 对象！</span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> Handler mHandler;</span><br><span class="line">    <span class="keyword">private</span> Intent mIntent;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">int</span> mResultCode;</span><br><span class="line">    <span class="keyword">private</span> String mResultData;</span><br><span class="line">    <span class="keyword">private</span> Bundle mResultExtras;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> Handler sDefaultSystemHandler;</span><br><span class="line"></span><br><span class="line">    FinishedDispatcher(PendingIntent pi, OnFinished who, Handler handler) &#123;</span><br><span class="line">        mPendingIntent = pi;</span><br><span class="line">        mWho = who;</span><br><span class="line">        <span class="keyword">if</span> (handler == <span class="keyword">null</span> &amp;&amp; ActivityThread.isSystem()) &#123;</span><br><span class="line">            <span class="keyword">if</span> (sDefaultSystemHandler == <span class="keyword">null</span>) &#123;</span><br><span class="line">                sDefaultSystemHandler = <span class="keyword">new</span> Handler(Looper.getMainLooper());</span><br><span class="line">            &#125;</span><br><span class="line">            mHandler = sDefaultSystemHandler;</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            mHandler = handler;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>如果没有传入指定的 Handler，</p>
<h3 id="2-1-2-ActivityMS-sendIntentSender"><a href="#2-1-2-ActivityMS-sendIntentSender" class="headerlink" title="2.1.2 ActivityMS.sendIntentSender"></a>2.1.2 ActivityMS.sendIntentSender</h3><p>PendingIntent.send 方法最终会调用 AMS.sendIntentSender 方法，当然这里涉及到了 PendingIntent 架构和逻辑，这里不做过多的讨论！</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">int</span> <span class="title">sendIntentSender</span><span class="params">(IIntentSender target, <span class="keyword">int</span> code, Intent intent, String resolvedType,</span></span></span><br><span class="line"><span class="function"><span class="params">        IIntentReceiver finishedReceiver, String requiredPermission, Bundle options)</span> </span>&#123;</span><br><span class="line">    <span class="comment">//【1】一般情况，每一个 PendingIntent 都会有一个 PendingIntentRecord 在系统中与之对应！</span></span><br><span class="line">    <span class="comment">// 默认情况下会调用 PendingIntentRecord 的 sendWithResult 方法！</span></span><br><span class="line">    <span class="keyword">if</span> (target <span class="keyword">instanceof</span> PendingIntentRecord) &#123;</span><br><span class="line">        <span class="keyword">return</span> ((PendingIntentRecord)target).sendWithResult(code, intent, resolvedType,</span><br><span class="line">                finishedReceiver, requiredPermission, options);</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        <span class="comment">// 下面是特殊情况，我们不关注！</span></span><br><span class="line">        <span class="keyword">if</span> (intent == <span class="keyword">null</span>) &#123;</span><br><span class="line">            Slog.wtf(TAG, <span class="string">"Can't use null intent with direct IIntentSender call"</span>);</span><br><span class="line">            intent = <span class="keyword">new</span> Intent(Intent.ACTION_MAIN);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            target.send(code, intent, resolvedType, <span class="keyword">null</span>, requiredPermission, options);</span><br><span class="line">        &#125; <span class="keyword">catch</span> (RemoteException e) &#123;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">if</span> (finishedReceiver != <span class="keyword">null</span>) &#123;</span><br><span class="line">            <span class="keyword">try</span> &#123;</span><br><span class="line">                <span class="comment">// 处理分发结果！</span></span><br><span class="line">                finishedReceiver.performReceive(intent, <span class="number">0</span>,</span><br><span class="line">                        <span class="keyword">null</span>, <span class="keyword">null</span>, <span class="keyword">false</span>, <span class="keyword">false</span>, UserHandle.getCallingUserId());</span><br><span class="line">            &#125; <span class="keyword">catch</span> (RemoteException e) &#123;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>正常情况下，会调用 PendingIntentRecord.sendWithResult 分发 alarm！</p>
<h3 id="2-1-3-PendingIntentRecord-sendWithResult"><a href="#2-1-3-PendingIntentRecord-sendWithResult" class="headerlink" title="2.1.3 PendingIntentRecord.sendWithResult"></a>2.1.3 PendingIntentRecord.sendWithResult</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">int</span> <span class="title">sendWithResult</span><span class="params">(<span class="keyword">int</span> code, Intent intent, String resolvedType,</span></span></span><br><span class="line"><span class="function"><span class="params">        IIntentReceiver finishedReceiver, String requiredPermission, Bundle options)</span> </span>&#123;</span><br><span class="line">    <span class="comment">// 继续调用 sendInner 方法！</span></span><br><span class="line">    <span class="keyword">return</span> sendInner(code, intent, resolvedType, finishedReceiver,</span><br><span class="line">            requiredPermission, <span class="keyword">null</span>, <span class="keyword">null</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>, options, <span class="keyword">null</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h3 id="2-1-4-PendingIntentRecord-sendInner"><a href="#2-1-4-PendingIntentRecord-sendInner" class="headerlink" title="2.1.4 PendingIntentRecord.sendInner"></a>2.1.4 PendingIntentRecord.sendInner</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">sendInner</span><span class="params">(<span class="keyword">int</span> code, Intent intent, String resolvedType, IIntentReceiver finishedReceiver,</span></span></span><br><span class="line"><span class="function"><span class="params">        String requiredPermission, IBinder resultTo, String resultWho, <span class="keyword">int</span> requestCode,</span></span></span><br><span class="line"><span class="function"><span class="params">        <span class="keyword">int</span> flagsMask, <span class="keyword">int</span> flagsValues, Bundle options, IActivityContainer container)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">if</span> (intent != <span class="keyword">null</span>) intent.setDefusable(<span class="keyword">true</span>);</span><br><span class="line">    <span class="keyword">if</span> (options != <span class="keyword">null</span>) options.setDefusable(<span class="keyword">true</span>);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (whitelistDuration &gt; <span class="number">0</span> &amp;&amp; !canceled) &#123;</span><br><span class="line">        <span class="comment">// Must call before acquiring the lock. It's possible the method return before sending</span></span><br><span class="line">        <span class="comment">// the intent due to some validations inside the lock, in which case the UID shouldn't</span></span><br><span class="line">        <span class="comment">// be whitelisted, but since the whitelist is temporary, that would be ok.</span></span><br><span class="line">        owner.tempWhitelistAppForPowerSave(Binder.getCallingPid(), Binder.getCallingUid(), uid,</span><br><span class="line">                whitelistDuration);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">synchronized</span> (owner) &#123;</span><br><span class="line">        <span class="keyword">final</span> ActivityContainer activityContainer = (ActivityContainer)container;</span><br><span class="line">        <span class="keyword">if</span> (activityContainer != <span class="keyword">null</span> &amp;&amp; activityContainer.mParentActivity != <span class="keyword">null</span> &amp;&amp;</span><br><span class="line">                activityContainer.mParentActivity.state</span><br><span class="line">                        != ActivityStack.ActivityState.RESUMED) &#123;</span><br><span class="line">            <span class="comment">// Cannot start a child activity if the parent is not resumed.</span></span><br><span class="line">            <span class="keyword">return</span> ActivityManager.START_CANCELED;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">if</span> (!canceled) &#123;</span><br><span class="line">            sent = <span class="keyword">true</span>;</span><br><span class="line">            <span class="keyword">if</span> ((key.flags&amp;PendingIntent.FLAG_ONE_SHOT) != <span class="number">0</span>) &#123;</span><br><span class="line">                owner.cancelIntentSenderLocked(<span class="keyword">this</span>, <span class="keyword">true</span>);</span><br><span class="line">                canceled = <span class="keyword">true</span>;</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            Intent finalIntent = key.requestIntent != <span class="keyword">null</span></span><br><span class="line">                    ? <span class="keyword">new</span> Intent(key.requestIntent) : <span class="keyword">new</span> Intent();</span><br><span class="line"></span><br><span class="line">            <span class="keyword">final</span> <span class="keyword">boolean</span> immutable = (key.flags &amp; PendingIntent.FLAG_IMMUTABLE) != <span class="number">0</span>;</span><br><span class="line">            <span class="keyword">if</span> (!immutable) &#123;</span><br><span class="line">                <span class="keyword">if</span> (intent != <span class="keyword">null</span>) &#123;</span><br><span class="line">                    <span class="keyword">int</span> changes = finalIntent.fillIn(intent, key.flags);</span><br><span class="line">                    <span class="keyword">if</span> ((changes &amp; Intent.FILL_IN_DATA) == <span class="number">0</span>) &#123;</span><br><span class="line">                        resolvedType = key.requestResolvedType;</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                    resolvedType = key.requestResolvedType;</span><br><span class="line">                &#125;</span><br><span class="line">                flagsMask &amp;= ~Intent.IMMUTABLE_FLAGS;</span><br><span class="line">                flagsValues &amp;= flagsMask;</span><br><span class="line">                finalIntent.setFlags((finalIntent.getFlags() &amp; ~flagsMask) | flagsValues);</span><br><span class="line">            &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                resolvedType = key.requestResolvedType;</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            <span class="keyword">final</span> <span class="keyword">long</span> origId = Binder.clearCallingIdentity();</span><br><span class="line"></span><br><span class="line">            <span class="keyword">boolean</span> sendFinish = finishedReceiver != <span class="keyword">null</span>;</span><br><span class="line">            <span class="keyword">int</span> userId = key.userId;</span><br><span class="line">            <span class="keyword">if</span> (userId == UserHandle.USER_CURRENT) &#123;</span><br><span class="line">                userId = owner.mUserController.getCurrentOrTargetUserIdLocked();</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">int</span> res = <span class="number">0</span>;</span><br><span class="line">            <span class="comment">// 根据 alarm 的类型，做不同的处理！</span></span><br><span class="line">            <span class="keyword">switch</span> (key.type) &#123;</span><br><span class="line">                <span class="keyword">case</span> ActivityManager.INTENT_SENDER_ACTIVITY:</span><br><span class="line">                    <span class="keyword">if</span> (options == <span class="keyword">null</span>) &#123;</span><br><span class="line">                        options = key.options;</span><br><span class="line">                    &#125; <span class="keyword">else</span> <span class="keyword">if</span> (key.options != <span class="keyword">null</span>) &#123;</span><br><span class="line">                        Bundle opts = <span class="keyword">new</span> Bundle(key.options);</span><br><span class="line">                        opts.putAll(options);</span><br><span class="line">                        options = opts;</span><br><span class="line">                    &#125;</span><br><span class="line">                    <span class="keyword">try</span> &#123;</span><br><span class="line">                        <span class="keyword">if</span> (key.allIntents != <span class="keyword">null</span> &amp;&amp; key.allIntents.length &gt; <span class="number">1</span>) &#123;</span><br><span class="line">                            Intent[] allIntents = <span class="keyword">new</span> Intent[key.allIntents.length];</span><br><span class="line">                            String[] allResolvedTypes = <span class="keyword">new</span> String[key.allIntents.length];</span><br><span class="line">                            System.arraycopy(key.allIntents, <span class="number">0</span>, allIntents, <span class="number">0</span>,</span><br><span class="line">                                    key.allIntents.length);</span><br><span class="line">                            <span class="keyword">if</span> (key.allResolvedTypes != <span class="keyword">null</span>) &#123;</span><br><span class="line">                                System.arraycopy(key.allResolvedTypes, <span class="number">0</span>, allResolvedTypes, <span class="number">0</span>,</span><br><span class="line">                                        key.allResolvedTypes.length);</span><br><span class="line">                            &#125;</span><br><span class="line">                            allIntents[allIntents.length-<span class="number">1</span>] = finalIntent;</span><br><span class="line">                            allResolvedTypes[allResolvedTypes.length-<span class="number">1</span>] = resolvedType;</span><br><span class="line">                            owner.startActivitiesInPackage(uid, key.packageName, allIntents,</span><br><span class="line">                                    allResolvedTypes, resultTo, options, userId);</span><br><span class="line">                        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                            owner.startActivityInPackage(uid, key.packageName, finalIntent,</span><br><span class="line">                                    resolvedType, resultTo, resultWho, requestCode, <span class="number">0</span>,</span><br><span class="line">                                    options, userId, container, <span class="keyword">null</span>);</span><br><span class="line">                        &#125;</span><br><span class="line">                    &#125; <span class="keyword">catch</span> (RuntimeException e) &#123;</span><br><span class="line">                        Slog.w(TAG, <span class="string">"Unable to send startActivity intent"</span>, e);</span><br><span class="line">                    &#125;</span><br><span class="line">                    <span class="keyword">break</span>;</span><br><span class="line">                <span class="keyword">case</span> ActivityManager.INTENT_SENDER_ACTIVITY_RESULT:</span><br><span class="line">                    <span class="keyword">if</span> (key.activity.task.stack != <span class="keyword">null</span>) &#123;</span><br><span class="line">                        key.activity.task.stack.sendActivityResultLocked(-<span class="number">1</span>, key.activity,</span><br><span class="line">                                key.who, key.requestCode, code, finalIntent);</span><br><span class="line">                    &#125;</span><br><span class="line">                    <span class="keyword">break</span>;</span><br><span class="line">                <span class="keyword">case</span> ActivityManager.INTENT_SENDER_BROADCAST:</span><br><span class="line">                    <span class="keyword">try</span> &#123;</span><br><span class="line">                        <span class="comment">// If a completion callback has been requested, require</span></span><br><span class="line">                        <span class="comment">// that the broadcast be delivered synchronously</span></span><br><span class="line">                        <span class="keyword">int</span> sent = owner.broadcastIntentInPackage(key.packageName, uid,</span><br><span class="line">                                finalIntent, resolvedType, finishedReceiver, code, <span class="keyword">null</span>, <span class="keyword">null</span>,</span><br><span class="line">                                requiredPermission, options, (finishedReceiver != <span class="keyword">null</span>),</span><br><span class="line">                                <span class="keyword">false</span>, userId);</span><br><span class="line">                        <span class="keyword">if</span> (sent == ActivityManager.BROADCAST_SUCCESS) &#123;</span><br><span class="line">                            sendFinish = <span class="keyword">false</span>;</span><br><span class="line">                        &#125;</span><br><span class="line">                    &#125; <span class="keyword">catch</span> (RuntimeException e) &#123;</span><br><span class="line">                        Slog.w(TAG, <span class="string">"Unable to send startActivity intent"</span>, e);</span><br><span class="line">                    &#125;</span><br><span class="line">                    <span class="keyword">break</span>;</span><br><span class="line">                <span class="keyword">case</span> ActivityManager.INTENT_SENDER_SERVICE:</span><br><span class="line">                    <span class="keyword">try</span> &#123;</span><br><span class="line">                        owner.startServiceInPackage(uid, finalIntent,</span><br><span class="line">                                resolvedType, key.packageName, userId);</span><br><span class="line">                    &#125; <span class="keyword">catch</span> (RuntimeException e) &#123;</span><br><span class="line">                        Slog.w(TAG, <span class="string">"Unable to send startService intent"</span>, e);</span><br><span class="line">                    &#125; <span class="keyword">catch</span> (TransactionTooLargeException e) &#123;</span><br><span class="line">                        res = ActivityManager.START_CANCELED;</span><br><span class="line">                    &#125;</span><br><span class="line">                    <span class="keyword">break</span>;</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            <span class="comment">// 处理分发结果！</span></span><br><span class="line">            <span class="keyword">if</span> (sendFinish &amp;&amp; res != ActivityManager.START_CANCELED) &#123;</span><br><span class="line">                <span class="keyword">try</span> &#123;</span><br><span class="line">                    finishedReceiver.performReceive(<span class="keyword">new</span> Intent(finalIntent), <span class="number">0</span>,</span><br><span class="line">                            <span class="keyword">null</span>, <span class="keyword">null</span>, <span class="keyword">false</span>, <span class="keyword">false</span>, key.userId);</span><br><span class="line">                &#125; <span class="keyword">catch</span> (RemoteException e) &#123;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            Binder.restoreCallingIdentity(origId);</span><br><span class="line"></span><br><span class="line">            <span class="keyword">return</span> res;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> ActivityManager.START_CANCELED;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h2 id="2-2-Alarm-Listener-doAlarm"><a href="#2-2-Alarm-Listener-doAlarm" class="headerlink" title="2.2 Alarm.Listener.doAlarm"></a>2.2 Alarm.Listener.doAlarm</h2><p>Alarm.Listener 是一个 Binder 对象，其服务端是应用进程的 ListenerWrapper 对象，之前我们知道 ListenerWrapper 实现了 IAlarmListener.Stub：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line"></span><br></pre></td></tr></table></figure>
<h1 id="3-特殊的触发路径"><a href="#3-特殊的触发路径" class="headerlink" title="3 特殊的触发路径"></a>3 特殊的触发路径</h1><p>如果没有 Alarm 驱动，那么我们知道 Alarm 的触发是通过内部的一个 AlarmHandler 实现的：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">setLocked</span><span class="params">(<span class="keyword">int</span> type, <span class="keyword">long</span> when)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">if</span> (mNativeData != <span class="number">0</span>) &#123;</span><br><span class="line">        ... ... ...</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        Message msg = Message.obtain();</span><br><span class="line">        msg.what = ALARM_EVENT;</span><br><span class="line">        mHandler.removeMessages(ALARM_EVENT);</span><br><span class="line">        mHandler.sendMessageAtTime(msg, when);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>可以看到，最后发送的是 ALARM_EVENT 给 AlarmHandler：</p>
<h2 id="3-1-AlarmHandler-handleMessage-ALARM-EVENT"><a href="#3-1-AlarmHandler-handleMessage-ALARM-EVENT" class="headerlink" title="3.1 AlarmHandler.handleMessage[ALARM_EVENT]"></a>3.1 AlarmHandler.handleMessage[ALARM_EVENT]</h2><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">handleMessage</span><span class="params">(Message msg)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">switch</span> (msg.what) &#123;</span><br><span class="line">        <span class="keyword">case</span> ALARM_EVENT: &#123;</span><br><span class="line">            <span class="comment">// 同样的 triggerList！</span></span><br><span class="line">            ArrayList&lt;Alarm&gt; triggerList = <span class="keyword">new</span> ArrayList&lt;Alarm&gt;();</span><br><span class="line">            <span class="keyword">synchronized</span> (mLock) &#123;</span><br><span class="line">                <span class="keyword">final</span> <span class="keyword">long</span> nowRTC = System.currentTimeMillis();</span><br><span class="line">                <span class="keyword">final</span> <span class="keyword">long</span> nowELAPSED = SystemClock.elapsedRealtime();</span><br><span class="line">                <span class="comment">// 调用 triggerAlarmsLocked 收集触发的 alarm！</span></span><br><span class="line">                triggerAlarmsLocked(triggerList, nowELAPSED, nowRTC);</span><br><span class="line">                updateNextAlarmClockLocked(); <span class="comment">// 更新下一个 AlarmClock</span></span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            <span class="comment">// 分发 Alarm！</span></span><br><span class="line">            <span class="keyword">for</span> (<span class="keyword">int</span> i=<span class="number">0</span>; i&lt;triggerList.size(); i++) &#123;</span><br><span class="line">                Alarm alarm = triggerList.get(i);</span><br><span class="line">                <span class="keyword">try</span> &#123;</span><br><span class="line">                    alarm.operation.send(); <span class="comment">// 这里再次调用了 PendingIntent 的 send 方法！</span></span><br><span class="line">                &#125; <span class="keyword">catch</span> (PendingIntent.CanceledException e) &#123;</span><br><span class="line">                    <span class="keyword">if</span> (alarm.repeatInterval &gt; <span class="number">0</span>) &#123; <span class="comment">// 发送出问题，如果是重复性 Alarm，那就移除该 Alarm！</span></span><br><span class="line">                        removeImpl(alarm.operation);</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>这个方法逻辑很简单，不多说了！</p>
</div><hr></div><nav id="pagination"><div class="pagination"><a class="extend prev" rel="prev" href="/"><i class="fa fa-chevron-left"></i></a><a class="page-number" href="/">1</a><span class="page-number current">2</span><a class="page-number" href="/page/3/">3</a><span class="space">&hellip;</span><a class="page-number" href="/page/7/">7</a><a class="extend next" rel="next" href="/page/3/"><i class="fa fa-chevron-right"></i></a></div></nav></div></div><footer><div class="layout" id="footer"><div class="copyright">&copy;2013 - 2019 By Coolqi.Li</div><div class="framework-info"><span>驱动 - </span><a href="http://hexo.io"><span>Hexo</span></a><span class="footer-separator">|</span><span>主题 - </span><a href="https://github.com/Molunerfinn/hexo-theme-melody"><span>Melody</span></a></div><div class="busuanzi"><script async src="https://busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script><span id="busuanzi_container_site_uv"><i class="fa fa-user"></i><span id="busuanzi_value_site_uv"></span><span></span></span><span class="footer-separator">|</span><span id="busuanzi_container_site_pv"><i class="fa fa-eye"></i><span id="busuanzi_value_site_pv"></span><span></span></span></div></div></footer><i class="fa fa-arrow-up" id="go-up" aria-hidden="true"></i><script src="https://cdn.jsdelivr.net/npm/animejs@latest/anime.min.js"></script><script src="https://cdn.jsdelivr.net/npm/jquery@latest/dist/jquery.min.js"></script><script src="https://cdn.jsdelivr.net/npm/@fancyapps/fancybox@latest/dist/jquery.fancybox.min.js"></script><script src="https://cdn.jsdelivr.net/npm/velocity-animate@latest/velocity.min.js"></script><script src="https://cdn.jsdelivr.net/npm/velocity-ui-pack@latest/velocity.ui.min.js"></script><script src="/js/utils.js?version=1.5.6"></script><script src="/js/fancybox.js?version=1.5.6"></script><script src="/js/sidebar.js?version=1.5.6"></script><script src="/js/copy.js?version=1.5.6"></script><script src="/js/fireworks.js?version=1.5.6"></script><script src="/js/transition.js?version=1.5.6"></script><script src="/js/scroll.js?version=1.5.6"></script><script src="/js/head.js?version=1.5.6"></script><script src="/live2dw/lib/L2Dwidget.min.js?0c58a1486de42ac6cc1c59c7d98ae887"></script><script>L2Dwidget.init({"pluginRootPath":"live2dw/","pluginJsPath":"lib/","pluginModelPath":"assets/","tagMode":false,"debug":false,"model":{"jsonPath":"live2d-widget-model-hijiki"},"display":{"position":"right","width":110,"height":220},"mobile":{"show":false},"log":false});</script></body></html>